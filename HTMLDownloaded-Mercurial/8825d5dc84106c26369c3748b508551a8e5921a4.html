<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19218:8825d5dc84106c26369c3748b508551a8e5921a4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8825d5dc84106c26369c3748b508551a8e5921a4" />
<meta property="og:url" content="/comm-central/rev/8825d5dc84106c26369c3748b508551a8e5921a4" />
<meta property="og:description" content="Fix bug 1115667 - Pull latest version of ical.js from GitHub - Part1: pull in latest version. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8825d5dc84106c26369c3748b508551a8e5921a4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8825d5dc84106c26369c3748b508551a8e5921a4">shortlog</a> |
<a href="/comm-central/log/8825d5dc84106c26369c3748b508551a8e5921a4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8825d5dc84106c26369c3748b508551a8e5921a4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8825d5dc84106c26369c3748b508551a8e5921a4">files</a> |
changeset |
<a href="/comm-central/raw-rev/8825d5dc84106c26369c3748b508551a8e5921a4">raw</a>  | <a href="/comm-central/archive/8825d5dc84106c26369c3748b508551a8e5921a4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1115667">bug 1115667</a> - Pull latest version of ical.js from GitHub - Part1: pull in latest version. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 13 Apr 2016 21:50:17 +0200</td></tr>

<tr>
 <td>changeset 19218</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8825d5dc84106c26369c3748b508551a8e5921a4">8825d5dc84106c26369c3748b508551a8e5921a4</a></td>
</tr>



<tr>
<td>parent 19217</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fa8bc44ffbb8136426fbe814c5794b435fad8a5e">fa8bc44ffbb8136426fbe814c5794b435fad8a5e</a>
</td>
</tr>

<tr>
<td>child 19219</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/441f2364e9dbed732b08150e1d858ab72cf1e7ab">441f2364e9dbed732b08150e1d858ab72cf1e7ab</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8825d5dc84106c26369c3748b508551a8e5921a4">11800</a></td></tr>
<tr><td>push user</td><td>acelists@atlas.sk</td></tr>
<tr><td>push date</td><td class="date age">Thu, 14 Apr 2016 17:49:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@69b4c4164312 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=69b4c4164312c107137efa4fae17c63608fa30d1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=69b4c4164312c107137efa4fae17c63608fa30d1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=69b4c4164312c107137efa4fae17c63608fa30d1&newProject=comm-central&newRevision=8825d5dc84106c26369c3748b508551a8e5921a4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=69b4c4164312c107137efa4fae17c63608fa30d1&newProject=comm-central&newRevision=8825d5dc84106c26369c3748b508551a8e5921a4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=69b4c4164312c107137efa4fae17c63608fa30d1&newProject=comm-central&newRevision=8825d5dc84106c26369c3748b508551a8e5921a4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1115667">1115667</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1115667">bug 1115667</a> - Pull latest version of ical.js from GitHub - Part1: pull in latest version. r=MakeMyDay</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8825d5dc84106c26369c3748b508551a8e5921a4/calendar/base/modules/ical.js">calendar/base/modules/ical.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8825d5dc84106c26369c3748b508551a8e5921a4/calendar/base/modules/ical.js">file</a> |
<a href="/comm-central/annotate/8825d5dc84106c26369c3748b508551a8e5921a4/calendar/base/modules/ical.js">annotate</a> |
<a href="/comm-central/diff/8825d5dc84106c26369c3748b508551a8e5921a4/calendar/base/modules/ical.js">diff</a> |
<a href="/comm-central/comparison/8825d5dc84106c26369c3748b508551a8e5921a4/calendar/base/modules/ical.js">comparison</a> |
<a href="/comm-central/log/8825d5dc84106c26369c3748b508551a8e5921a4/calendar/base/modules/ical.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/ical.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/ical.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,20 +1,19 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> /**</span>
<a href="#l1.11"></a><span id="l1.11">  * This is ical.js from &lt;https://github.com/mozilla-comm/ical.js&gt;.</span>
<a href="#l1.12"></a><span id="l1.12">  *</span>
<a href="#l1.13"></a><span id="l1.13">  * If you would like to change anything in ical.js, it is required to do so</span>
<a href="#l1.14"></a><span id="l1.14">  * upstream first.</span>
<a href="#l1.15"></a><span id="l1.15">  *</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">- * Current ical.js git revision: 9d3ee67d1ce9e0bb960e73a45e2dd434360cbd8d</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ * Current ical.js git revision: f4fb1b9564f990f7b718253f2251bb30f58c9a5a (v1.2.0)</span>
<a href="#l1.18"></a><span id="l1.18">  */</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> var EXPORTED_SYMBOLS = [&quot;ICAL&quot;, &quot;unwrap&quot;, &quot;unwrapSetter&quot;, &quot;unwrapSingle&quot;, &quot;wrapGetter&quot;];</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> function wrapGetter(type, val) {</span>
<a href="#l1.23"></a><span id="l1.23">     return val ? new type(val) : null;</span>
<a href="#l1.24"></a><span id="l1.24"> }</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -35,125 +34,145 @@ function unwrapSingle(type, val) {</span>
<a href="#l1.27"></a><span id="l1.27">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l1.28"></a><span id="l1.28">         Components.utils.reportError(&quot;Unknown &quot; + (type.icalclass || type) + &quot; passed at &quot; + cal.STACK(10));</span>
<a href="#l1.29"></a><span id="l1.29">         return null;</span>
<a href="#l1.30"></a><span id="l1.30">     }</span>
<a href="#l1.31"></a><span id="l1.31"> }</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> // -- start ical.js --</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-if (typeof(ICAL) === 'undefined')</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-  (typeof(window) !== 'undefined') ? this.ICAL = {} : ICAL = {};</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+/* istanbul ignore next */</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+/* jshint ignore:start */</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+if (typeof module === 'object') {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  // CommonJS, where exports may be different each time.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  ICAL = module.exports;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+} else if (typeof ICAL !== 'object') {/* istanbul ignore next */</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  /** @ignore */</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  this.ICAL = {};</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+}</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+/* jshint ignore:end */</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+/**</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+ * The number of characters before iCalendar line folding should occur</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+ * @type {Number}</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+ * @default 75</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+ */</span>
<a href="#l1.61"></a><span id="l1.61"> ICAL.foldLength = 75;</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+/**</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+ * The character(s) to be used for a newline. The default value is provided by</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+ * rfc5545.</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+ * @type {String}</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+ * @default &quot;\r\n&quot;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+ */</span>
<a href="#l1.70"></a><span id="l1.70"> ICAL.newLineChar = '\r\n';</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-ICAL.debug = false;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74"> /**</span>
<a href="#l1.75"></a><span id="l1.75">  * Helper functions used in various places within ical.js</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+ * @namespace</span>
<a href="#l1.77"></a><span id="l1.77">  */</span>
<a href="#l1.78"></a><span id="l1.78"> ICAL.helpers = {</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  initState: function initState(aLine, aLineNr) {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    return {</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-      buffer: aLine,</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-      line: aLine,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-      lineNr: aLineNr,</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-      character: 0,</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-      currentData: null,</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-      parentData: []</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    };</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-  },</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  initComponentData: function initComponentData(aName) {</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-    return {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-      name: aName,</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-      type: &quot;COMPONENT&quot;,</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-      value: []</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    };</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-  },</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-</span>
<a href="#l1.98"></a><span id="l1.98">   /**</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-   * Checks if the given number is NaN</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+   * Checks if the given type is of the number type and also NaN.</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+   *</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+   * @param {Number} number     The number to check</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+   * @return {Boolean}          True, if the number is strictly NaN</span>
<a href="#l1.104"></a><span id="l1.104">    */</span>
<a href="#l1.105"></a><span id="l1.105">   isStrictlyNaN: function(number) {</span>
<a href="#l1.106"></a><span id="l1.106">     return typeof(number) === 'number' &amp;&amp; isNaN(number);</span>
<a href="#l1.107"></a><span id="l1.107">   },</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">   /**</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-   * Parses a string value that is expected to be an</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-   * integer, when the valid is not an integer throws</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-   * a decoration error.</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-   *</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-   * @param {String} string raw input.</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-   * @return {Number} integer.</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+   * Parses a string value that is expected to be an integer, when the valid is</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+   * not an integer throws a decoration error.</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+   *</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+   * @param {String} string     Raw string input</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+   * @return {Number}           Parsed integer</span>
<a href="#l1.121"></a><span id="l1.121">    */</span>
<a href="#l1.122"></a><span id="l1.122">   strictParseInt: function(string) {</span>
<a href="#l1.123"></a><span id="l1.123">     var result = parseInt(string, 10);</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">     if (ICAL.helpers.isStrictlyNaN(result)) {</span>
<a href="#l1.126"></a><span id="l1.126">       throw new Error(</span>
<a href="#l1.127"></a><span id="l1.127">         'Could not extract integer from &quot;' + string + '&quot;'</span>
<a href="#l1.128"></a><span id="l1.128">       );</span>
<a href="#l1.129"></a><span id="l1.129">     }</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">     return result;</span>
<a href="#l1.132"></a><span id="l1.132">   },</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">   /**</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-   * Creates or returns a class instance</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-   * of a given type with the initialization</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-   * data if the data is not already an instance</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-   * of the given type.</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-   *</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-   *</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-   * Example:</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-   *</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-   *    var time = new ICAL.Time(...);</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-   *    var result = ICAL.helpers.formatClassType(time, ICAL.Time);</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-   *</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-   *    (result instanceof ICAL.Time)</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-   *    // =&gt; true</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-   *</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-   *    result = ICAL.helpers.formatClassType({}, ICAL.Time);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-   *    (result isntanceof ICAL.Time)</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-   *    // =&gt; true</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-   *</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-   *</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-   * @param {Object} data object initialization data.</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-   * @param {Object} type object type (like ICAL.Time).</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+   * Creates or returns a class instance of a given type with the initialization</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+   * data if the data is not already an instance of the given type.</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+   *</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+   * @example</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+   * var time = new ICAL.Time(...);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+   * var result = ICAL.helpers.formatClassType(time, ICAL.Time);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+   *</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+   * (result instanceof ICAL.Time)</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+   * // =&gt; true</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+   *</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+   * result = ICAL.helpers.formatClassType({}, ICAL.Time);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+   * (result isntanceof ICAL.Time)</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+   * // =&gt; true</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+   *</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+   *</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+   * @param {Object} data       object initialization data</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+   * @param {Object} type       object type (like ICAL.Time)</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+   * @return {?}                An instance of the found type.</span>
<a href="#l1.174"></a><span id="l1.174">    */</span>
<a href="#l1.175"></a><span id="l1.175">   formatClassType: function formatClassType(data, type) {</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-    if (typeof(data) === 'undefined')</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+    if (typeof(data) === 'undefined') {</span>
<a href="#l1.178"></a><span id="l1.178">       return undefined;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+    }</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181">     if (data instanceof type) {</span>
<a href="#l1.182"></a><span id="l1.182">       return data;</span>
<a href="#l1.183"></a><span id="l1.183">     }</span>
<a href="#l1.184"></a><span id="l1.184">     return new type(data);</span>
<a href="#l1.185"></a><span id="l1.185">   },</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187">   /**</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-   * Identical to index of but will only match values</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-   * when they are not preceded by a backslash char \\\</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-   *</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-   * @param {String} buffer string value.</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-   * @param {String} search value.</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-   * @param {Numeric} pos start position.</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+   * Identical to indexOf but will only match values when they are not preceded</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+   * by a backslash character.</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+   *</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+   * @param {String} buffer         String to search</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+   * @param {String} search         Value to look for</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+   * @param {Number} pos            Start position</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+   * @return {Number}               The position, or -1 if not found</span>
<a href="#l1.201"></a><span id="l1.201">    */</span>
<a href="#l1.202"></a><span id="l1.202">   unescapedIndexOf: function(buffer, search, pos) {</span>
<a href="#l1.203"></a><span id="l1.203">     while ((pos = buffer.indexOf(search, pos)) !== -1) {</span>
<a href="#l1.204"></a><span id="l1.204">       if (pos &gt; 0 &amp;&amp; buffer[pos - 1] === '\\') {</span>
<a href="#l1.205"></a><span id="l1.205">         pos += 1;</span>
<a href="#l1.206"></a><span id="l1.206">       } else {</span>
<a href="#l1.207"></a><span id="l1.207">         return pos;</span>
<a href="#l1.208"></a><span id="l1.208">       }</span>
<a href="#l1.209"></a><span id="l1.209">     }</span>
<a href="#l1.210"></a><span id="l1.210">     return -1;</span>
<a href="#l1.211"></a><span id="l1.211">   },</span>
<a href="#l1.212"></a><span id="l1.212"> </span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+  /**</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+   * Find the index for insertion using binary search.</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+   *</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+   * @param {Array} list            The list to search</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+   * @param {?} seekVal             The value to insert</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+   * @param {function(?,?)} cmpfunc The comparison func, that can</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+   *                                  compare two seekVals</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+   * @return {Number}               The insert position</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+   */</span>
<a href="#l1.222"></a><span id="l1.222">   binsearchInsert: function(list, seekVal, cmpfunc) {</span>
<a href="#l1.223"></a><span id="l1.223">     if (!list.length)</span>
<a href="#l1.224"></a><span id="l1.224">       return 0;</span>
<a href="#l1.225"></a><span id="l1.225"> </span>
<a href="#l1.226"></a><span id="l1.226">     var low = 0, high = list.length - 1,</span>
<a href="#l1.227"></a><span id="l1.227">         mid, cmpval;</span>
<a href="#l1.228"></a><span id="l1.228"> </span>
<a href="#l1.229"></a><span id="l1.229">     while (low &lt;= high) {</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineat">@@ -171,129 +190,105 @@ ICAL.helpers = {</span>
<a href="#l1.231"></a><span id="l1.231">     if (cmpval &lt; 0)</span>
<a href="#l1.232"></a><span id="l1.232">       return mid; // insertion is displacing, so use mid outright.</span>
<a href="#l1.233"></a><span id="l1.233">     else if (cmpval &gt; 0)</span>
<a href="#l1.234"></a><span id="l1.234">       return mid + 1;</span>
<a href="#l1.235"></a><span id="l1.235">     else</span>
<a href="#l1.236"></a><span id="l1.236">       return mid;</span>
<a href="#l1.237"></a><span id="l1.237">   },</span>
<a href="#l1.238"></a><span id="l1.238"> </span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-  dumpn: function() {</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+  /**</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+   * Convenience function for debug output</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+   * @private</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+   */</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+  dumpn: /* istanbul ignore next */ function() {</span>
<a href="#l1.245"></a><span id="l1.245">     if (!ICAL.debug) {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-      return null;</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+      return;</span>
<a href="#l1.248"></a><span id="l1.248">     }</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250">     if (typeof (console) !== 'undefined' &amp;&amp; 'log' in console) {</span>
<a href="#l1.251"></a><span id="l1.251">       ICAL.helpers.dumpn = function consoleDumpn(input) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-        return console.log(input);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-      }</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        console.log(input);</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+      };</span>
<a href="#l1.256"></a><span id="l1.256">     } else {</span>
<a href="#l1.257"></a><span id="l1.257">       ICAL.helpers.dumpn = function geckoDumpn(input) {</span>
<a href="#l1.258"></a><span id="l1.258">         dump(input + '\n');</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-      }</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-    }</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-    return ICAL.helpers.dumpn(arguments[0]);</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+      };</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+    }</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+    ICAL.helpers.dumpn(arguments[0]);</span>
<a href="#l1.267"></a><span id="l1.267">   },</span>
<a href="#l1.268"></a><span id="l1.268"> </span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-  mixin: function(obj, data) {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-    if (data) {</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-      for (var k in data) {</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-        obj[k] = data[k];</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-      }</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-    }</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-    return obj;</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-  },</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-  isArray: function(o) {</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-    return o &amp;&amp; (o instanceof Array || typeof o == &quot;array&quot;);</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-  },</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+  /**</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+   * Clone the passed object or primitive. By default a shallow clone will be</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+   * executed.</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+   *</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+   * @param {*} aSrc            The thing to clone</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+   * @param {Boolean=} aDeep    If true, a deep clone will be performed</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+   * @return {*}                The copy of the thing</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+   */</span>
<a href="#l1.290"></a><span id="l1.290">   clone: function(aSrc, aDeep) {</span>
<a href="#l1.291"></a><span id="l1.291">     if (!aSrc || typeof aSrc != &quot;object&quot;) {</span>
<a href="#l1.292"></a><span id="l1.292">       return aSrc;</span>
<a href="#l1.293"></a><span id="l1.293">     } else if (aSrc instanceof Date) {</span>
<a href="#l1.294"></a><span id="l1.294">       return new Date(aSrc.getTime());</span>
<a href="#l1.295"></a><span id="l1.295">     } else if (&quot;clone&quot; in aSrc) {</span>
<a href="#l1.296"></a><span id="l1.296">       return aSrc.clone();</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-    } else if (ICAL.helpers.isArray(aSrc)) {</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-      var result = [];</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    } else if (Array.isArray(aSrc)) {</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+      var arr = [];</span>
<a href="#l1.301"></a><span id="l1.301">       for (var i = 0; i &lt; aSrc.length; i++) {</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-        result.push(aDeep ? ICAL.helpers.clone(aSrc[i], true) : aSrc[i]);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-      }</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-      return result;</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+        arr.push(aDeep ? ICAL.helpers.clone(aSrc[i], true) : aSrc[i]);</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+      }</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+      return arr;</span>
<a href="#l1.308"></a><span id="l1.308">     } else {</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-      var result = {};</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+      var obj = {};</span>
<a href="#l1.311"></a><span id="l1.311">       for (var name in aSrc) {</span>
<a href="#l1.312"></a><span id="l1.312">         // uses prototype method to allow use of Object.create(null);</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+        /* istanbul ignore else */</span>
<a href="#l1.314"></a><span id="l1.314">         if (Object.prototype.hasOwnProperty.call(aSrc, name)) {</span>
<a href="#l1.315"></a><span id="l1.315">           if (aDeep) {</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-            result[name] = ICAL.helpers.clone(aSrc[name], true);</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+            obj[name] = ICAL.helpers.clone(aSrc[name], true);</span>
<a href="#l1.318"></a><span id="l1.318">           } else {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-            result[name] = aSrc[name];</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+            obj[name] = aSrc[name];</span>
<a href="#l1.321"></a><span id="l1.321">           }</span>
<a href="#l1.322"></a><span id="l1.322">         }</span>
<a href="#l1.323"></a><span id="l1.323">       }</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-      return result;</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+      return obj;</span>
<a href="#l1.326"></a><span id="l1.326">     }</span>
<a href="#l1.327"></a><span id="l1.327">   },</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-  unfoldline: function unfoldline(aState) {</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-    // Section 3.1</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-    // if the line ends with a CRLF</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-    // and the next line starts with a LINEAR WHITESPACE (space, htab, ...)</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-    // then remove the CRLF and the whitespace to unsplit the line</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-    var moreLines = true;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-    var line = &quot;&quot;;</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-    while (moreLines) {</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-      moreLines = false;</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-      var pos = aState.buffer.search(/\r?\n/);</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-      if (pos &gt; -1) {</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-        var len = (aState.buffer[pos] == &quot;\r&quot; ? 2 : 1);</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-        var nextChar = aState.buffer.substr(pos + len, 1);</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-        if (nextChar.match(/^[ \t]$/)) {</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-          moreLines = true;</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-          line += aState.buffer.substr(0, pos);</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-          aState.buffer = aState.buffer.substr(pos + len + 1);</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-        } else {</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-          // We're at the end of the line, copy the found chunk</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-          line += aState.buffer.substr(0, pos);</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-          aState.buffer = aState.buffer.substr(pos + len);</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-        }</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-      } else {</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-        line += aState.buffer;</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-        aState.buffer = &quot;&quot;;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-      }</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-    }</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-    return line;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-  },</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+  /**</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+   * Performs iCalendar line folding. A line ending character is inserted and</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+   * the next line begins with a whitespace.</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+   *</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+   * @example</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+   * SUMMARY:This line will be fold</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+   *  ed right in the middle of a word.</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+   *</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+   * @param {String} aLine      The line to fold</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+   * @return {String}           The folded line</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+   */</span>
<a href="#l1.372"></a><span id="l1.372">   foldline: function foldline(aLine) {</span>
<a href="#l1.373"></a><span id="l1.373">     var result = &quot;&quot;;</span>
<a href="#l1.374"></a><span id="l1.374">     var line = aLine || &quot;&quot;;</span>
<a href="#l1.375"></a><span id="l1.375"> </span>
<a href="#l1.376"></a><span id="l1.376">     while (line.length) {</span>
<a href="#l1.377"></a><span id="l1.377">       result += ICAL.newLineChar + &quot; &quot; + line.substr(0, ICAL.foldLength);</span>
<a href="#l1.378"></a><span id="l1.378">       line = line.substr(ICAL.foldLength);</span>
<a href="#l1.379"></a><span id="l1.379">     }</span>
<a href="#l1.380"></a><span id="l1.380">     return result.substr(ICAL.newLineChar.length + 1);</span>
<a href="#l1.381"></a><span id="l1.381">   },</span>
<a href="#l1.382"></a><span id="l1.382"> </span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-  ensureKeyExists: function(obj, key, defvalue) {</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-    if (!(key in obj)) {</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-      obj[key] = defvalue;</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-    }</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-  },</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-  hasKey: function(obj, key) {</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-    return (obj &amp;&amp; key in obj &amp;&amp; obj[key]);</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-  },</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+  /**</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+   * Pads the given string or number with zeros so it will have at least two</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+   * characters.</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+   *</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+   * @param {String|Number} data    The string or number to pad</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineplus">+   * @return {String}               The number padded as a string</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineplus">+   */</span>
<a href="#l1.400"></a><span id="l1.400">   pad2: function pad(data) {</span>
<a href="#l1.401"></a><span id="l1.401">     if (typeof(data) !== 'string') {</span>
<a href="#l1.402"></a><span id="l1.402">       // handle fractions.</span>
<a href="#l1.403"></a><span id="l1.403">       if (typeof(data) === 'number') {</span>
<a href="#l1.404"></a><span id="l1.404">         data = parseInt(data);</span>
<a href="#l1.405"></a><span id="l1.405">       }</span>
<a href="#l1.406"></a><span id="l1.406">       data = String(data);</span>
<a href="#l1.407"></a><span id="l1.407">     }</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineat">@@ -305,683 +300,1091 @@ ICAL.helpers = {</span>
<a href="#l1.409"></a><span id="l1.409">         return '00';</span>
<a href="#l1.410"></a><span id="l1.410">       case 1:</span>
<a href="#l1.411"></a><span id="l1.411">         return '0' + data;</span>
<a href="#l1.412"></a><span id="l1.412">       default:</span>
<a href="#l1.413"></a><span id="l1.413">         return data;</span>
<a href="#l1.414"></a><span id="l1.414">     }</span>
<a href="#l1.415"></a><span id="l1.415">   },</span>
<a href="#l1.416"></a><span id="l1.416"> </span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+  /**</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+   * Truncates the given number, correctly handling negative numbers.</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+   *</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+   * @param {Number} number     The number to truncate</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineplus">+   * @return {Number}           The truncated number</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineplus">+   */</span>
<a href="#l1.423"></a><span id="l1.423">   trunc: function trunc(number) {</span>
<a href="#l1.424"></a><span id="l1.424">     return (number &lt; 0 ? Math.ceil(number) : Math.floor(number));</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+  },</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+  /**</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+   * Poor-man's cross-browser inheritance for JavaScript. Doesn't support all</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineplus">+   * the features, but enough for our usage.</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineplus">+   *</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineplus">+   * @param {Function} base     The base class constructor function.</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineplus">+   * @param {Function} child    The child class constructor function.</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineplus">+   * @param {Object} extra      Extends the prototype with extra properties</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+   *                              and methods</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineplus">+   */</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineplus">+  inherits: function(base, child, extra) {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+    function F() {}</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+    F.prototype = base.prototype;</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+    child.prototype = new F();</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+    if (extra) {</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+      ICAL.helpers.extend(extra, child.prototype);</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineplus">+    }</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+  },</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+  /**</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineplus">+   * Poor-man's cross-browser object extension. Doesn't support all the</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+   * features, but enough for our usage. Note that the target's properties are</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+   * not overwritten with the source properties.</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+   *</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+   * @example</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+   * var child = ICAL.helpers.extend(parent, {</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+   *   &quot;bar&quot;: 123</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+   * });</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+   *</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+   * @param {Object} source     The object to extend</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+   * @param {Object} target     The object to extend with</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+   * @return {Object}           Returns the target.</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+   */</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+  extend: function(source, target) {</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+    for (var key in source) {</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+      var descr = Object.getOwnPropertyDescriptor(source, key);</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+      if (descr &amp;&amp; !Object.getOwnPropertyDescriptor(target, key)) {</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+        Object.defineProperty(target, key, descr);</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+      }</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+    }</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+    return target;</span>
<a href="#l1.468"></a><span id="l1.468">   }</span>
<a href="#l1.469"></a><span id="l1.469"> };</span>
<a href="#l1.470"></a><span id="l1.470"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.471"></a><span id="l1.471">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.472"></a><span id="l1.472">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">- * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+/** @namespace ICAL */</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+/**</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+ * @ignore</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+ */</span>
<a href="#l1.486"></a><span id="l1.486"> ICAL.design = (function() {</span>
<a href="#l1.487"></a><span id="l1.487">   'use strict';</span>
<a href="#l1.488"></a><span id="l1.488"> </span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-  var ICAL_NEWLINE = /\\\\|\\;|\\,|\\[Nn]/g;</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-  function DecorationError() {</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-    Error.apply(this, arguments);</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+  var FROM_ICAL_NEWLINE = /\\\\|\\;|\\,|\\[Nn]/g;</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+  var TO_ICAL_NEWLINE = /\\|;|,|\n/g;</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+  var FROM_VCARD_NEWLINE = /\\\\|\\,|\\[Nn]/g;</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+  var TO_VCARD_NEWLINE = /\\|,|\n/g;</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+  function createTextType(fromNewline, toNewline) {</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+    var result = {</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+      matches: /.*/,</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+      fromICAL: function(aValue, structuredEscape) {</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+        return replaceNewline(aValue, fromNewline, structuredEscape);</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+      },</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineplus">+</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineplus">+      toICAL: function(aValue, structuredEscape) {</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineplus">+        var regEx = toNewline;</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+        if (structuredEscape)</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+          regEx = new RegExp(regEx.source + '|' + structuredEscape);</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+        return aValue.replace(regEx, function(str) {</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+          switch (str) {</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+          case &quot;\\&quot;:</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+            return &quot;\\\\&quot;;</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+          case &quot;;&quot;:</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+            return &quot;\\;&quot;;</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+          case &quot;,&quot;:</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+            return &quot;\\,&quot;;</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+          case &quot;\n&quot;:</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+            return &quot;\\n&quot;;</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+          /* istanbul ignore next */</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+          default:</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+            return str;</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+          }</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+        });</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+      }</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+    };</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+    return result;</span>
<a href="#l1.528"></a><span id="l1.528">   }</span>
<a href="#l1.529"></a><span id="l1.529"> </span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-  DecorationError.prototype = {</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-    __proto__: Error.prototype</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-  };</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineplus">+  // default types used multiple times</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+  var DEFAULT_TYPE_TEXT = { defaultType: &quot;text&quot; };</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+  var DEFAULT_TYPE_TEXT_MULTI = { defaultType: &quot;text&quot;, multiValue: &quot;,&quot; };</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+  var DEFAULT_TYPE_TEXT_STRUCTURED = { defaultType: &quot;text&quot;, structuredValue: &quot;;&quot; };</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+  var DEFAULT_TYPE_INTEGER = { defaultType: &quot;integer&quot; };</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineplus">+  var DEFAULT_TYPE_DATETIME_DATE = { defaultType: &quot;date-time&quot;, allowedTypes: [&quot;date-time&quot;, &quot;date&quot;] };</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+  var DEFAULT_TYPE_DATETIME = { defaultType: &quot;date-time&quot; };</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+  var DEFAULT_TYPE_URI = { defaultType: &quot;uri&quot; };</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+  var DEFAULT_TYPE_UTCOFFSET = { defaultType: &quot;utc-offset&quot; };</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+  var DEFAULT_TYPE_RECUR = { defaultType: &quot;recur&quot; };</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+  var DEFAULT_TYPE_DATE_ANDOR_TIME = { defaultType: &quot;date-and-or-time&quot;, allowedTypes: [&quot;date-time&quot;, &quot;date&quot;, &quot;text&quot;] };</span>
<a href="#l1.544"></a><span id="l1.544"> </span>
<a href="#l1.545"></a><span id="l1.545">   function replaceNewlineReplace(string) {</span>
<a href="#l1.546"></a><span id="l1.546">     switch (string) {</span>
<a href="#l1.547"></a><span id="l1.547">       case &quot;\\\\&quot;:</span>
<a href="#l1.548"></a><span id="l1.548">         return &quot;\\&quot;;</span>
<a href="#l1.549"></a><span id="l1.549">       case &quot;\\;&quot;:</span>
<a href="#l1.550"></a><span id="l1.550">         return &quot;;&quot;;</span>
<a href="#l1.551"></a><span id="l1.551">       case &quot;\\,&quot;:</span>
<a href="#l1.552"></a><span id="l1.552">         return &quot;,&quot;;</span>
<a href="#l1.553"></a><span id="l1.553">       case &quot;\\n&quot;:</span>
<a href="#l1.554"></a><span id="l1.554">       case &quot;\\N&quot;:</span>
<a href="#l1.555"></a><span id="l1.555">         return &quot;\n&quot;;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+      /* istanbul ignore next */</span>
<a href="#l1.557"></a><span id="l1.557">       default:</span>
<a href="#l1.558"></a><span id="l1.558">         return string;</span>
<a href="#l1.559"></a><span id="l1.559">     }</span>
<a href="#l1.560"></a><span id="l1.560">   }</span>
<a href="#l1.561"></a><span id="l1.561"> </span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-  function replaceNewline(value) {</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+  function replaceNewline(value, newline, structuredEscape) {</span>
<a href="#l1.564"></a><span id="l1.564">     // avoid regex when possible.</span>
<a href="#l1.565"></a><span id="l1.565">     if (value.indexOf('\\') === -1) {</span>
<a href="#l1.566"></a><span id="l1.566">       return value;</span>
<a href="#l1.567"></a><span id="l1.567">     }</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-    return value.replace(ICAL_NEWLINE, replaceNewlineReplace);</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-  }</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-  /**</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-   * Changes the format of the UNTIl part in the RECUR</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-   * value type. When no UNTIL part is found the original</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-   * is returned untouched.</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-   *</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-   * @param {String} type toICAL or fromICAL.</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-   * @param {String} aValue the value to check.</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-   * @return {String} upgraded/original value.</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-   */</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-  function recurReplaceUntil(aType, aValue) {</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-    var idx = aValue.indexOf('UNTIL=');</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-    if (idx === -1) {</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-      return aValue;</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-    }</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-    idx += 6;</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-    // everything before the value</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-    var begin = aValue.substr(0, idx);</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-    // everything after the value</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-    var end;</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-    // current until value</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-    var until;</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-    // end of value could be -1 meaning this is the last param.</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-    var endValueIdx = aValue.indexOf(';', idx);</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-    if (endValueIdx === -1) {</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-      end = '';</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-      until = aValue.substr(idx);</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-    } else {</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-      end = aValue.substr(endValueIdx);</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-      until = aValue.substr(idx, endValueIdx - idx);</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineminus">-    }</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-    if (until.length &gt; 10) {</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-      until = design.value['date-time'][aType](until);</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-    } else {</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-      until = design.value.date[aType](until);</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-    }</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-    return begin + until + end;</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineplus">+    if (structuredEscape)</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineplus">+      newline = new RegExp(newline.source + '|\\\\' + structuredEscape);</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineplus">+    return value.replace(newline, replaceNewlineReplace);</span>
<a href="#l1.619"></a><span id="l1.619">   }</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-  /**</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-   * Design data used by the parser to decide if data is semantically correct</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-   */</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-  var design = {</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-    DecorationError: DecorationError,</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-    defaultType: 'text',</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-    param: {</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-      // Although the syntax is DQUOTE uri DQUOTE, I don't think we should</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-      // enfoce anything aside from it being a valid content line.</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-      // &quot;ALTREP&quot;: { ... },</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-      // CN just wants a param-value</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-      // &quot;CN&quot;: { ... }</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-      &quot;cutype&quot;: {</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-        values: [&quot;INDIVIDUAL&quot;, &quot;GROUP&quot;, &quot;RESOURCE&quot;, &quot;ROOM&quot;, &quot;UNKNOWN&quot;],</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-        allowXName: true,</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-        allowIanaToken: true</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-      },</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-      &quot;delegated-from&quot;: {</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-        valueType: &quot;cal-address&quot;,</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-        multiValue: &quot;,&quot;</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-      },</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-      &quot;delegated-to&quot;: {</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-        valueType: &quot;cal-address&quot;,</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-        multiValue: &quot;,&quot;</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-      },</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-      // &quot;DIR&quot;: { ... }, // See ALTREP</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-      &quot;encoding&quot;: {</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-        values: [&quot;8BIT&quot;, &quot;BASE64&quot;]</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-      },</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-      // &quot;FMTTYPE&quot;: { ... }, // See ALTREP</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-      &quot;fbtype&quot;: {</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-        values: [&quot;FREE&quot;, &quot;BUSY&quot;, &quot;BUSY-UNAVAILABLE&quot;, &quot;BUSY-TENTATIVE&quot;],</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-        allowXName: true,</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-        allowIanaToken: true</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-      },</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-      // &quot;LANGUAGE&quot;: { ... }, // See ALTREP</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-      &quot;member&quot;: {</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-        valueType: &quot;cal-address&quot;,</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-        multiValue: &quot;,&quot;</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-      },</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-      &quot;partstat&quot;: {</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-        // TODO These values are actually different per-component</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-        values: [&quot;NEEDS-ACTION&quot;, &quot;ACCEPTED&quot;, &quot;DECLINED&quot;, &quot;TENTATIVE&quot;,</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-                 &quot;DELEGATED&quot;, &quot;COMPLETED&quot;, &quot;IN-PROCESS&quot;],</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-        allowXName: true,</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-        allowIanaToken: true</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-      },</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-      &quot;range&quot;: {</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-        values: [&quot;THISLANDFUTURE&quot;]</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-      },</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-      &quot;related&quot;: {</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-        values: [&quot;START&quot;, &quot;END&quot;]</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-      },</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-      &quot;reltype&quot;: {</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-        values: [&quot;PARENT&quot;, &quot;CHILD&quot;, &quot;SIBLING&quot;],</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-        allowXName: true,</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-        allowIanaToken: true</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-      },</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-      &quot;role&quot;: {</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-        values: [&quot;REQ-PARTICIPANT&quot;, &quot;CHAIR&quot;,</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-                 &quot;OPT-PARTICIPANT&quot;, &quot;NON-PARTICIPANT&quot;],</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-        allowXName: true,</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-        allowIanaToken: true</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-      },</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-      &quot;rsvp&quot;: {</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-        valueType: &quot;boolean&quot;</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-      },</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-      &quot;sent-by&quot;: {</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-        valueType: &quot;cal-address&quot;</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-      },</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-      &quot;tzid&quot;: {</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-        matches: /^\//</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-      },</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-      &quot;value&quot;: {</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineminus">-        // since the value here is a 'type' lowercase is used.</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-        values: [&quot;binary&quot;, &quot;boolean&quot;, &quot;cal-address&quot;, &quot;date&quot;, &quot;date-time&quot;,</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-                 &quot;duration&quot;, &quot;float&quot;, &quot;integer&quot;, &quot;period&quot;, &quot;recur&quot;, &quot;text&quot;,</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-                 &quot;time&quot;, &quot;uri&quot;, &quot;utc-offset&quot;],</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-        allowXName: true,</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-        allowIanaToken: true</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-      }</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-    },</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-    // When adding a value here, be sure to add it to the parameter types!</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-    value: {</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-      &quot;binary&quot;: {</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-        decorate: function(aString) {</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-          return ICAL.Binary.fromString(aString);</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-        },</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-        undecorate: function(aBinary) {</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-          return aBinary.toString();</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineplus">+</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+  var commonProperties = {</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineplus">+    &quot;categories&quot;: DEFAULT_TYPE_TEXT_MULTI,</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+    &quot;url&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineplus">+    &quot;version&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineplus">+    &quot;uid&quot;: DEFAULT_TYPE_TEXT</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineplus">+  };</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineplus">+</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineplus">+  var commonValues = {</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineplus">+    &quot;boolean&quot;: {</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+      values: [&quot;TRUE&quot;, &quot;FALSE&quot;],</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineplus">+</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineplus">+        switch (aValue) {</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineplus">+          case 'TRUE':</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineplus">+            return true;</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+          case 'FALSE':</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineplus">+            return false;</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+          default:</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineplus">+            //TODO: parser warning</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+            return false;</span>
<a href="#l1.739"></a><span id="l1.739">         }</span>
<a href="#l1.740"></a><span id="l1.740">       },</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-      &quot;boolean&quot;: {</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-        values: [&quot;TRUE&quot;, &quot;FALSE&quot;],</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineminus">-          switch(aValue) {</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-            case 'TRUE':</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineminus">-              return true;</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineminus">-            case 'FALSE':</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineminus">-              return false;</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineminus">-            default:</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineminus">-              //TODO: parser warning</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-              return false;</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-          }</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-        },</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-          if (aValue) {</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-            return 'TRUE';</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineminus">-          }</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-          return 'FALSE';</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-        }</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-      },</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-      &quot;cal-address&quot;: {</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-        // needs to be an uri</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineplus">+</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineplus">+        if (aValue) {</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineplus">+          return 'TRUE';</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineplus">+        }</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineplus">+        return 'FALSE';</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineplus">+      }</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineplus">+</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineplus">+    },</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineplus">+    float: {</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineplus">+      matches: /^[+-]?\d+\.\d+$/,</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineplus">+</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineplus">+        var parsed = parseFloat(aValue);</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineplus">+        if (ICAL.helpers.isStrictlyNaN(parsed)) {</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineplus">+          // TODO: parser warning</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineplus">+          return 0.0;</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+        }</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineplus">+        return parsed;</span>
<a href="#l1.785"></a><span id="l1.785">       },</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-      &quot;date&quot;: {</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-        decorate: function(aValue, aProp) {</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-          return ICAL.Time.fromDateString(aValue, aProp);</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-        },</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-        /**</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">-         * undecorates a time object.</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">-         */</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-        undecorate: function(aValue) {</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-          return aValue.toString();</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-        },</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-          // from: 20120901</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-          // to: 2012-09-01</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-          var result = aValue.substr(0, 4) + '-' +</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-                       aValue.substr(4, 2) + '-' +</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-                       aValue.substr(6, 2);</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-          if (aValue[8] === 'Z') {</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-            result += 'Z';</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-          }</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-          return result;</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-        },</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-          // from: 2012-09-01</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-          // to: 20120901</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-          if (aValue.length &gt; 11) {</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-            //TODO: serialize warning?</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-            return aValue;</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-          }</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-          var result = aValue.substr(0, 4) +</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-                       aValue.substr(5, 2) +</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-                       aValue.substr(8, 2);</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-          if (aValue[10] === 'Z') {</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-            result += 'Z';</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-          }</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-          return result;</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineplus">+</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineplus">+        return String(aValue);</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineplus">+      }</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineplus">+    },</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineplus">+    integer: {</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineplus">+        var parsed = parseInt(aValue);</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineplus">+        if (ICAL.helpers.isStrictlyNaN(parsed)) {</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineplus">+          return 0;</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineplus">+        }</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineplus">+        return parsed;</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineplus">+      },</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineplus">+</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineplus">+        return String(aValue);</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineplus">+      }</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineplus">+    },</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineplus">+    &quot;utc-offset&quot;: {</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineplus">+        if (aValue.length &lt; 7) {</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineplus">+          // no seconds</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineplus">+          // -0500</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineplus">+          return aValue.substr(0, 3) +</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineplus">+                 aValue.substr(4, 2);</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineplus">+        } else {</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineplus">+          // seconds</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineplus">+          // -050000</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineplus">+          return aValue.substr(0, 3) +</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineplus">+                 aValue.substr(4, 2) +</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineplus">+                 aValue.substr(7, 2);</span>
<a href="#l1.861"></a><span id="l1.861">         }</span>
<a href="#l1.862"></a><span id="l1.862">       },</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-      &quot;date-time&quot;: {</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-          // from: 20120901T130000</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-          // to: 2012-09-01T13:00:00</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-          var result = aValue.substr(0, 4) + '-' +</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-                       aValue.substr(4, 2) + '-' +</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-                       aValue.substr(6, 2) + 'T' +</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-                       aValue.substr(9, 2) + ':' +</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-                       aValue.substr(11, 2) + ':' +</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-                       aValue.substr(13, 2);</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-          if (aValue[15] === 'Z') {</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-            result += 'Z'</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-          }</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-          return result;</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-        },</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-          // from: 2012-09-01T13:00:00</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-          // to: 20120901T130000</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-          if (aValue.length &lt; 19) {</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineminus">-            // TODO: error</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineminus">-            return aValue;</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineminus">-          }</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineminus">-</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-          var result = aValue.substr(0, 4) +</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-                       aValue.substr(5, 2) +</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-                       // grab the (DDTHH) segment</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-                       aValue.substr(8, 5) +</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineminus">-                       // MM</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineminus">-                       aValue.substr(14, 2) +</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineminus">-                       // SS</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineminus">-                       aValue.substr(17, 2);</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineminus">-</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineminus">-          if (aValue[19] === 'Z') {</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-            result += 'Z';</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-          }</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-          return result;</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-        },</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineminus">-        decorate: function(aValue, aProp) {</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-          return ICAL.Time.fromDateTimeString(aValue, aProp);</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-        },</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineminus">-</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-        undecorate: function(aValue) {</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-          return aValue.toString();</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-        }</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-      },</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-      duration: {</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineminus">-        decorate: function(aValue) {</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-          return ICAL.Duration.fromString(aValue);</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-        },</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-        undecorate: function(aValue) {</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-          return aValue.toString();</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineplus">+</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+        if (aValue.length &lt; 6) {</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineplus">+          // no seconds</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineplus">+          // -05:00</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineplus">+          return aValue.substr(0, 3) + ':' +</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineplus">+                 aValue.substr(3, 2);</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineplus">+        } else {</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineplus">+          // seconds</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineplus">+          // -05:00:00</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineplus">+          return aValue.substr(0, 3) + ':' +</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineplus">+                 aValue.substr(3, 2) + ':' +</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineplus">+                 aValue.substr(5, 2);</span>
<a href="#l1.933"></a><span id="l1.933">         }</span>
<a href="#l1.934"></a><span id="l1.934">       },</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-      float: {</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-        matches: /^[+-]?\d+\.\d+$/,</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-        decorate: function(aValue) {</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-          return ICAL.Value.fromString(aValue, &quot;float&quot;);</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-        },</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineminus">-          var parsed = parseFloat(aValue);</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineminus">-          if (ICAL.helpers.isStrictlyNaN(parsed)) {</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-            // TODO: parser warning</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-            return 0.0;</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-          }</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-          return parsed;</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineminus">-        },</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineminus">-</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-          return String(aValue);</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-        }</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-      },</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-      integer: {</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-          var parsed = parseInt(aValue);</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-          if (ICAL.helpers.isStrictlyNaN(parsed)) {</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-            return 0;</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-          }</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineminus">-          return parsed;</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-        },</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-          return String(aValue);</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-        }</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineplus">+</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineplus">+        return ICAL.UtcOffset.fromString(aValue);</span>
<a href="#l1.969"></a><span id="l1.969">       },</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-      period: {</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-        fromICAL: function(string) {</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineminus">-          var parts = string.split('/');</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineminus">-          var result = design.value['date-time'].fromICAL(parts[0]) + '/';</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineminus">-</span>
<a href="#l1.976"></a><span id="l1.976" class="difflineminus">-          if (ICAL.Duration.isValueString(parts[1])) {</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineminus">-            result += parts[1];</span>
<a href="#l1.978"></a><span id="l1.978" class="difflineminus">-          } else {</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineminus">-            result += design.value['date-time'].fromICAL(parts[1]);</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineminus">-          }</span>
<a href="#l1.981"></a><span id="l1.981" class="difflineminus">-</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineminus">-          return result;</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineminus">-        },</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineminus">-        toICAL: function(string) {</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineminus">-          var parts = string.split('/');</span>
<a href="#l1.987"></a><span id="l1.987" class="difflineminus">-          var result = design.value['date-time'].toICAL(parts[0]) + '/';</span>
<a href="#l1.988"></a><span id="l1.988" class="difflineminus">-</span>
<a href="#l1.989"></a><span id="l1.989" class="difflineminus">-          if (ICAL.Duration.isValueString(parts[1])) {</span>
<a href="#l1.990"></a><span id="l1.990" class="difflineminus">-            result += parts[1];</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-          } else {</span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-            result += design.value['date-time'].toICAL(parts[1]);</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-          }</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineminus">-          return result;</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-        },</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineminus">-        decorate: function(aValue, aProp) {</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-          return ICAL.Period.fromString(aValue, aProp);</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-        },</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineminus">-        undecorate: function(aValue) {</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineminus">-          return aValue.toString();</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineminus">-        }</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineplus">+</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineplus">+      }</span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineplus">+    }</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineplus">+  };</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineplus">+</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineplus">+  var icalParams = {</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineplus">+    // Although the syntax is DQUOTE uri DQUOTE, I don't think we should</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineplus">+    // enfoce anything aside from it being a valid content line.</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineplus">+    //</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineplus">+    // At least some params require - if multi values are used - DQUOTEs</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineplus">+    // for each of its values - e.g. delegated-from=&quot;uri1&quot;,&quot;uri2&quot;</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineplus">+    // To indicate this, I introduced the new k/v pair</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineplus">+    // multiValueSeparateDQuote: true</span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineplus">+    //</span>
<a href="#l1.1021"></a><span id="l1.1021" class="difflineplus">+    // &quot;ALTREP&quot;: { ... },</span>
<a href="#l1.1022"></a><span id="l1.1022" class="difflineplus">+</span>
<a href="#l1.1023"></a><span id="l1.1023" class="difflineplus">+    // CN just wants a param-value</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineplus">+    // &quot;CN&quot;: { ... }</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineplus">+</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineplus">+    &quot;cutype&quot;: {</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineplus">+      values: [&quot;INDIVIDUAL&quot;, &quot;GROUP&quot;, &quot;RESOURCE&quot;, &quot;ROOM&quot;, &quot;UNKNOWN&quot;],</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineplus">+    },</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineplus">+</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineplus">+    &quot;delegated-from&quot;: {</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineplus">+      valueType: &quot;cal-address&quot;,</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineplus">+      multiValue: &quot;,&quot;,</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineplus">+      multiValueSeparateDQuote: true</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineplus">+    },</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineplus">+    &quot;delegated-to&quot;: {</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineplus">+      valueType: &quot;cal-address&quot;,</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineplus">+      multiValue: &quot;,&quot;,</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineplus">+      multiValueSeparateDQuote: true</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineplus">+    },</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineplus">+    // &quot;DIR&quot;: { ... }, // See ALTREP</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineplus">+    &quot;encoding&quot;: {</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineplus">+      values: [&quot;8BIT&quot;, &quot;BASE64&quot;]</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineplus">+    },</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineplus">+    // &quot;FMTTYPE&quot;: { ... }, // See ALTREP</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineplus">+    &quot;fbtype&quot;: {</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineplus">+      values: [&quot;FREE&quot;, &quot;BUSY&quot;, &quot;BUSY-UNAVAILABLE&quot;, &quot;BUSY-TENTATIVE&quot;],</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineplus">+    },</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineplus">+    // &quot;LANGUAGE&quot;: { ... }, // See ALTREP</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineplus">+    &quot;member&quot;: {</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineplus">+      valueType: &quot;cal-address&quot;,</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineplus">+      multiValue: &quot;,&quot;,</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineplus">+      multiValueSeparateDQuote: true</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineplus">+    },</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineplus">+    &quot;partstat&quot;: {</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineplus">+      // TODO These values are actually different per-component</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineplus">+      values: [&quot;NEEDS-ACTION&quot;, &quot;ACCEPTED&quot;, &quot;DECLINED&quot;, &quot;TENTATIVE&quot;,</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineplus">+               &quot;DELEGATED&quot;, &quot;COMPLETED&quot;, &quot;IN-PROCESS&quot;],</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineplus">+    },</span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineplus">+    &quot;range&quot;: {</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineplus">+      values: [&quot;THISLANDFUTURE&quot;]</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineplus">+    },</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineplus">+    &quot;related&quot;: {</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineplus">+      values: [&quot;START&quot;, &quot;END&quot;]</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineplus">+    },</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineplus">+    &quot;reltype&quot;: {</span>
<a href="#l1.1072"></a><span id="l1.1072" class="difflineplus">+      values: [&quot;PARENT&quot;, &quot;CHILD&quot;, &quot;SIBLING&quot;],</span>
<a href="#l1.1073"></a><span id="l1.1073" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineplus">+    },</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineplus">+    &quot;role&quot;: {</span>
<a href="#l1.1077"></a><span id="l1.1077" class="difflineplus">+      values: [&quot;REQ-PARTICIPANT&quot;, &quot;CHAIR&quot;,</span>
<a href="#l1.1078"></a><span id="l1.1078" class="difflineplus">+               &quot;OPT-PARTICIPANT&quot;, &quot;NON-PARTICIPANT&quot;],</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineplus">+    },</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineplus">+    &quot;rsvp&quot;: {</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineplus">+      values: [&quot;TRUE&quot;, &quot;FALSE&quot;]</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineplus">+    },</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineplus">+    &quot;sent-by&quot;: {</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineplus">+      valueType: &quot;cal-address&quot;</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineplus">+    },</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineplus">+    &quot;tzid&quot;: {</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineplus">+      matches: /^\//</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineplus">+    },</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineplus">+    &quot;value&quot;: {</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineplus">+      // since the value here is a 'type' lowercase is used.</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineplus">+      values: [&quot;binary&quot;, &quot;boolean&quot;, &quot;cal-address&quot;, &quot;date&quot;, &quot;date-time&quot;,</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineplus">+               &quot;duration&quot;, &quot;float&quot;, &quot;integer&quot;, &quot;period&quot;, &quot;recur&quot;, &quot;text&quot;,</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineplus">+               &quot;time&quot;, &quot;uri&quot;, &quot;utc-offset&quot;],</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineplus">+    }</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineplus">+  };</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineplus">+</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineplus">+  // When adding a value here, be sure to add it to the parameter types!</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineplus">+  var icalValues = ICAL.helpers.extend(commonValues, {</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineplus">+    text: createTextType(FROM_ICAL_NEWLINE, TO_ICAL_NEWLINE),</span>
<a href="#l1.1104"></a><span id="l1.1104" class="difflineplus">+</span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineplus">+    uri: {</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineplus">+      // TODO</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineplus">+      /* ... */</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineplus">+    },</span>
<a href="#l1.1109"></a><span id="l1.1109" class="difflineplus">+</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineplus">+    &quot;binary&quot;: {</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineplus">+      decorate: function(aString) {</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineplus">+        return ICAL.Binary.fromString(aString);</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineplus">+      },</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineplus">+</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineplus">+      undecorate: function(aBinary) {</span>
<a href="#l1.1116"></a><span id="l1.1116" class="difflineplus">+        return aBinary.toString();</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineplus">+      }</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineplus">+    },</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineplus">+    &quot;cal-address&quot;: {</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineplus">+      // needs to be an uri</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineplus">+    },</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineplus">+    &quot;date&quot;: {</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineplus">+      decorate: function(aValue, aProp) {</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineplus">+        return ICAL.Time.fromDateString(aValue, aProp);</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineplus">+      },</span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineplus">+</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineplus">+      /**</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineplus">+       * undecorates a time object.</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineplus">+       */</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineplus">+      },</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineplus">+</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineplus">+        // from: 20120901</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineplus">+        // to: 2012-09-01</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineplus">+        return aValue.substr(0, 4) + '-' +</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineplus">+               aValue.substr(4, 2) + '-' +</span>
<a href="#l1.1139"></a><span id="l1.1139" class="difflineplus">+               aValue.substr(6, 2);</span>
<a href="#l1.1140"></a><span id="l1.1140" class="difflineplus">+      },</span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineplus">+</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineplus">+        // from: 2012-09-01</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineplus">+        // to: 20120901</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineplus">+</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineplus">+        if (aValue.length &gt; 11) {</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineplus">+          //TODO: serialize warning?</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineplus">+          return aValue;</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineplus">+        }</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineplus">+</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineplus">+        return aValue.substr(0, 4) +</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineplus">+               aValue.substr(5, 2) +</span>
<a href="#l1.1153"></a><span id="l1.1153" class="difflineplus">+               aValue.substr(8, 2);</span>
<a href="#l1.1154"></a><span id="l1.1154" class="difflineplus">+      }</span>
<a href="#l1.1155"></a><span id="l1.1155" class="difflineplus">+    },</span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineplus">+    &quot;date-time&quot;: {</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineplus">+        // from: 20120901T130000</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineplus">+        // to: 2012-09-01T13:00:00</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineplus">+        var result = aValue.substr(0, 4) + '-' +</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineplus">+                     aValue.substr(4, 2) + '-' +</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineplus">+                     aValue.substr(6, 2) + 'T' +</span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineplus">+                     aValue.substr(9, 2) + ':' +</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineplus">+                     aValue.substr(11, 2) + ':' +</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineplus">+                     aValue.substr(13, 2);</span>
<a href="#l1.1166"></a><span id="l1.1166" class="difflineplus">+</span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineplus">+        if (aValue[15] &amp;&amp; aValue[15] === 'Z') {</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineplus">+          result += 'Z';</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineplus">+        }</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineplus">+</span>
<a href="#l1.1171"></a><span id="l1.1171" class="difflineplus">+        return result;</span>
<a href="#l1.1172"></a><span id="l1.1172" class="difflineplus">+      },</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineplus">+</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineplus">+        // from: 2012-09-01T13:00:00</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineplus">+        // to: 20120901T130000</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineplus">+</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineplus">+        if (aValue.length &lt; 19) {</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineplus">+          // TODO: error</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineplus">+          return aValue;</span>
<a href="#l1.1181"></a><span id="l1.1181" class="difflineplus">+        }</span>
<a href="#l1.1182"></a><span id="l1.1182" class="difflineplus">+</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineplus">+        var result = aValue.substr(0, 4) +</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineplus">+                     aValue.substr(5, 2) +</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineplus">+                     // grab the (DDTHH) segment</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineplus">+                     aValue.substr(8, 5) +</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineplus">+                     // MM</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineplus">+                     aValue.substr(14, 2) +</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineplus">+                     // SS</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineplus">+                     aValue.substr(17, 2);</span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineplus">+</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineplus">+        if (aValue[19] &amp;&amp; aValue[19] === 'Z') {</span>
<a href="#l1.1193"></a><span id="l1.1193" class="difflineplus">+          result += 'Z';</span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineplus">+        }</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineplus">+</span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineplus">+        return result;</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineplus">+      },</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineplus">+</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineplus">+      decorate: function(aValue, aProp) {</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineplus">+        return ICAL.Time.fromDateTimeString(aValue, aProp);</span>
<a href="#l1.1201"></a><span id="l1.1201">       },</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-      recur: {</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineminus">-        fromICAL: recurReplaceUntil.bind(this, 'fromICAL'),</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineminus">-        toICAL: recurReplaceUntil.bind(this, 'toICAL'),</span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineminus">-</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineminus">-        decorate: function decorate(aValue) {</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineminus">-          return ICAL.Recur.fromString(aValue);</span>
<a href="#l1.1208"></a><span id="l1.1208" class="difflineminus">-        },</span>
<a href="#l1.1209"></a><span id="l1.1209" class="difflineminus">-</span>
<a href="#l1.1210"></a><span id="l1.1210" class="difflineminus">-        undecorate: function(aRecur) {</span>
<a href="#l1.1211"></a><span id="l1.1211" class="difflineminus">-          return aRecur.toString();</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineminus">-        }</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineplus">+</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineplus">+      }</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineplus">+    },</span>
<a href="#l1.1218"></a><span id="l1.1218" class="difflineplus">+    duration: {</span>
<a href="#l1.1219"></a><span id="l1.1219" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.1220"></a><span id="l1.1220" class="difflineplus">+        return ICAL.Duration.fromString(aValue);</span>
<a href="#l1.1221"></a><span id="l1.1221" class="difflineplus">+      },</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineplus">+      }</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineplus">+    },</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineplus">+    period: {</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineplus">+</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineplus">+      fromICAL: function(string) {</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineplus">+        var parts = string.split('/');</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineplus">+        parts[0] = icalValues['date-time'].fromICAL(parts[0]);</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineplus">+</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineplus">+        if (!ICAL.Duration.isValueString(parts[1])) {</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineplus">+          parts[1] = icalValues['date-time'].fromICAL(parts[1]);</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineplus">+        }</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineplus">+</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineplus">+        return parts;</span>
<a href="#l1.1237"></a><span id="l1.1237" class="difflineplus">+      },</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineplus">+</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineplus">+      toICAL: function(parts) {</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineplus">+        parts[0] = icalValues['date-time'].toICAL(parts[0]);</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineplus">+</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineplus">+        if (!ICAL.Duration.isValueString(parts[1])) {</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineplus">+          parts[1] = icalValues['date-time'].toICAL(parts[1]);</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineplus">+        }</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineplus">+</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineplus">+        return parts.join(&quot;/&quot;);</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineplus">+      },</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineplus">+</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineplus">+      decorate: function(aValue, aProp) {</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineplus">+        return ICAL.Period.fromJSON(aValue, aProp);</span>
<a href="#l1.1251"></a><span id="l1.1251">       },</span>
<a href="#l1.1252"></a><span id="l1.1252"> </span>
<a href="#l1.1253"></a><span id="l1.1253" class="difflineminus">-      text: {</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineminus">-        matches: /.*/,</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineminus">-</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineminus">-        fromICAL: function(aValue, aName) {</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineminus">-          return replaceNewline(aValue);</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineminus">-        },</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineminus">-</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineminus">-        toICAL: function escape(aValue, aName) {</span>
<a href="#l1.1261"></a><span id="l1.1261" class="difflineminus">-          return aValue.replace(/\\|;|,|\n/g, function(str) {</span>
<a href="#l1.1262"></a><span id="l1.1262" class="difflineminus">-            switch (str) {</span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-            case &quot;\\&quot;:</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineminus">-              return &quot;\\\\&quot;;</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineminus">-            case &quot;;&quot;:</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineminus">-              return &quot;\\;&quot;;</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineminus">-            case &quot;,&quot;:</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineminus">-              return &quot;\\,&quot;;</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineminus">-            case &quot;\n&quot;:</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineminus">-              return &quot;\\n&quot;;</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineminus">-            default:</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineminus">-              return str;</span>
<a href="#l1.1273"></a><span id="l1.1273" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1274"></a><span id="l1.1274" class="difflineplus">+        return aValue.toJSON();</span>
<a href="#l1.1275"></a><span id="l1.1275" class="difflineplus">+      }</span>
<a href="#l1.1276"></a><span id="l1.1276" class="difflineplus">+    },</span>
<a href="#l1.1277"></a><span id="l1.1277" class="difflineplus">+    recur: {</span>
<a href="#l1.1278"></a><span id="l1.1278" class="difflineplus">+      fromICAL: function(string) {</span>
<a href="#l1.1279"></a><span id="l1.1279" class="difflineplus">+        return ICAL.Recur._stringToData(string, true);</span>
<a href="#l1.1280"></a><span id="l1.1280" class="difflineplus">+      },</span>
<a href="#l1.1281"></a><span id="l1.1281" class="difflineplus">+</span>
<a href="#l1.1282"></a><span id="l1.1282" class="difflineplus">+      toICAL: function(data) {</span>
<a href="#l1.1283"></a><span id="l1.1283" class="difflineplus">+        var str = &quot;&quot;;</span>
<a href="#l1.1284"></a><span id="l1.1284" class="difflineplus">+        for (var k in data) {</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineplus">+          if (!Object.prototype.hasOwnProperty.call(data, k)) {</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineplus">+            continue;</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineplus">+          }</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineplus">+          var val = data[k];</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineplus">+          if (k == &quot;until&quot;) {</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineplus">+            if (val.length &gt; 10) {</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineplus">+              val = icalValues['date-time'].toICAL(val);</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineplus">+            } else {</span>
<a href="#l1.1294"></a><span id="l1.1294" class="difflineplus">+              val = icalValues.date.toICAL(val);</span>
<a href="#l1.1295"></a><span id="l1.1295">             }</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineminus">-          });</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineminus">-        }</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineplus">+          } else if (k == &quot;wkst&quot;) {</span>
<a href="#l1.1299"></a><span id="l1.1299" class="difflineplus">+            if (typeof val === 'number') {</span>
<a href="#l1.1300"></a><span id="l1.1300" class="difflineplus">+              val = ICAL.Recur.numericDayToIcalDay(val);</span>
<a href="#l1.1301"></a><span id="l1.1301" class="difflineplus">+            }</span>
<a href="#l1.1302"></a><span id="l1.1302" class="difflineplus">+          } else if (Array.isArray(val)) {</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineplus">+            val = val.join(&quot;,&quot;);</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineplus">+          }</span>
<a href="#l1.1305"></a><span id="l1.1305" class="difflineplus">+          str += k.toUpperCase() + &quot;=&quot; + val + &quot;;&quot;;</span>
<a href="#l1.1306"></a><span id="l1.1306" class="difflineplus">+        }</span>
<a href="#l1.1307"></a><span id="l1.1307" class="difflineplus">+        return str.substr(0, str.length - 1);</span>
<a href="#l1.1308"></a><span id="l1.1308" class="difflineplus">+      },</span>
<a href="#l1.1309"></a><span id="l1.1309" class="difflineplus">+</span>
<a href="#l1.1310"></a><span id="l1.1310" class="difflineplus">+      decorate: function decorate(aValue) {</span>
<a href="#l1.1311"></a><span id="l1.1311" class="difflineplus">+        return ICAL.Recur.fromData(aValue);</span>
<a href="#l1.1312"></a><span id="l1.1312">       },</span>
<a href="#l1.1313"></a><span id="l1.1313"> </span>
<a href="#l1.1314"></a><span id="l1.1314" class="difflineminus">-      time: {</span>
<a href="#l1.1315"></a><span id="l1.1315" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineminus">-          // from: MMHHSS(Z)?</span>
<a href="#l1.1317"></a><span id="l1.1317" class="difflineminus">-          // to: HH:MM:SS(Z)?</span>
<a href="#l1.1318"></a><span id="l1.1318" class="difflineminus">-          if (aValue.length &lt; 6) {</span>
<a href="#l1.1319"></a><span id="l1.1319" class="difflineminus">-            // TODO: parser exception?</span>
<a href="#l1.1320"></a><span id="l1.1320" class="difflineminus">-            return aValue;</span>
<a href="#l1.1321"></a><span id="l1.1321" class="difflineminus">-          }</span>
<a href="#l1.1322"></a><span id="l1.1322" class="difflineminus">-</span>
<a href="#l1.1323"></a><span id="l1.1323" class="difflineminus">-          // HH::MM::SSZ?</span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineminus">-          var result = aValue.substr(0, 2) + ':' +</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineminus">-                       aValue.substr(2, 2) + ':' +</span>
<a href="#l1.1326"></a><span id="l1.1326" class="difflineminus">-                       aValue.substr(4, 2);</span>
<a href="#l1.1327"></a><span id="l1.1327" class="difflineminus">-</span>
<a href="#l1.1328"></a><span id="l1.1328" class="difflineminus">-          if (aValue[6] === 'Z') {</span>
<a href="#l1.1329"></a><span id="l1.1329" class="difflineminus">-            result += 'Z';</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineminus">-          }</span>
<a href="#l1.1331"></a><span id="l1.1331" class="difflineminus">-</span>
<a href="#l1.1332"></a><span id="l1.1332" class="difflineminus">-          return result;</span>
<a href="#l1.1333"></a><span id="l1.1333" class="difflineminus">-        },</span>
<a href="#l1.1334"></a><span id="l1.1334" class="difflineminus">-</span>
<a href="#l1.1335"></a><span id="l1.1335" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.1336"></a><span id="l1.1336" class="difflineminus">-          // from: HH:MM:SS(Z)?</span>
<a href="#l1.1337"></a><span id="l1.1337" class="difflineminus">-          // to: MMHHSS(Z)?</span>
<a href="#l1.1338"></a><span id="l1.1338" class="difflineminus">-          if (aValue.length &lt; 8) {</span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineminus">-            //TODO: error</span>
<a href="#l1.1340"></a><span id="l1.1340" class="difflineminus">-            return aValue;</span>
<a href="#l1.1341"></a><span id="l1.1341" class="difflineminus">-          }</span>
<a href="#l1.1342"></a><span id="l1.1342" class="difflineminus">-</span>
<a href="#l1.1343"></a><span id="l1.1343" class="difflineminus">-          var result = aValue.substr(0, 2) +</span>
<a href="#l1.1344"></a><span id="l1.1344" class="difflineminus">-                       aValue.substr(3, 2) +</span>
<a href="#l1.1345"></a><span id="l1.1345" class="difflineminus">-                       aValue.substr(6, 2);</span>
<a href="#l1.1346"></a><span id="l1.1346" class="difflineminus">-</span>
<a href="#l1.1347"></a><span id="l1.1347" class="difflineminus">-          if (aValue[8] === 'Z') {</span>
<a href="#l1.1348"></a><span id="l1.1348" class="difflineminus">-            result += 'Z';</span>
<a href="#l1.1349"></a><span id="l1.1349" class="difflineminus">-          }</span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineminus">-</span>
<a href="#l1.1351"></a><span id="l1.1351" class="difflineminus">-          return result;</span>
<a href="#l1.1352"></a><span id="l1.1352" class="difflineplus">+      undecorate: function(aRecur) {</span>
<a href="#l1.1353"></a><span id="l1.1353" class="difflineplus">+        return aRecur.toJSON();</span>
<a href="#l1.1354"></a><span id="l1.1354" class="difflineplus">+      }</span>
<a href="#l1.1355"></a><span id="l1.1355" class="difflineplus">+    },</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineplus">+</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineplus">+    time: {</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1359"></a><span id="l1.1359" class="difflineplus">+        // from: MMHHSS(Z)?</span>
<a href="#l1.1360"></a><span id="l1.1360" class="difflineplus">+        // to: HH:MM:SS(Z)?</span>
<a href="#l1.1361"></a><span id="l1.1361" class="difflineplus">+        if (aValue.length &lt; 6) {</span>
<a href="#l1.1362"></a><span id="l1.1362" class="difflineplus">+          // TODO: parser exception?</span>
<a href="#l1.1363"></a><span id="l1.1363" class="difflineplus">+          return aValue;</span>
<a href="#l1.1364"></a><span id="l1.1364" class="difflineplus">+        }</span>
<a href="#l1.1365"></a><span id="l1.1365" class="difflineplus">+</span>
<a href="#l1.1366"></a><span id="l1.1366" class="difflineplus">+        // HH::MM::SSZ?</span>
<a href="#l1.1367"></a><span id="l1.1367" class="difflineplus">+        var result = aValue.substr(0, 2) + ':' +</span>
<a href="#l1.1368"></a><span id="l1.1368" class="difflineplus">+                     aValue.substr(2, 2) + ':' +</span>
<a href="#l1.1369"></a><span id="l1.1369" class="difflineplus">+                     aValue.substr(4, 2);</span>
<a href="#l1.1370"></a><span id="l1.1370" class="difflineplus">+</span>
<a href="#l1.1371"></a><span id="l1.1371" class="difflineplus">+        if (aValue[6] === 'Z') {</span>
<a href="#l1.1372"></a><span id="l1.1372" class="difflineplus">+          result += 'Z';</span>
<a href="#l1.1373"></a><span id="l1.1373" class="difflineplus">+        }</span>
<a href="#l1.1374"></a><span id="l1.1374" class="difflineplus">+</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineplus">+        return result;</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineplus">+      },</span>
<a href="#l1.1377"></a><span id="l1.1377" class="difflineplus">+</span>
<a href="#l1.1378"></a><span id="l1.1378" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineplus">+        // from: HH:MM:SS(Z)?</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineplus">+        // to: MMHHSS(Z)?</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineplus">+        if (aValue.length &lt; 8) {</span>
<a href="#l1.1382"></a><span id="l1.1382" class="difflineplus">+          //TODO: error</span>
<a href="#l1.1383"></a><span id="l1.1383" class="difflineplus">+          return aValue;</span>
<a href="#l1.1384"></a><span id="l1.1384" class="difflineplus">+        }</span>
<a href="#l1.1385"></a><span id="l1.1385" class="difflineplus">+</span>
<a href="#l1.1386"></a><span id="l1.1386" class="difflineplus">+        var result = aValue.substr(0, 2) +</span>
<a href="#l1.1387"></a><span id="l1.1387" class="difflineplus">+                     aValue.substr(3, 2) +</span>
<a href="#l1.1388"></a><span id="l1.1388" class="difflineplus">+                     aValue.substr(6, 2);</span>
<a href="#l1.1389"></a><span id="l1.1389" class="difflineplus">+</span>
<a href="#l1.1390"></a><span id="l1.1390" class="difflineplus">+        if (aValue[8] === 'Z') {</span>
<a href="#l1.1391"></a><span id="l1.1391" class="difflineplus">+          result += 'Z';</span>
<a href="#l1.1392"></a><span id="l1.1392" class="difflineplus">+        }</span>
<a href="#l1.1393"></a><span id="l1.1393" class="difflineplus">+</span>
<a href="#l1.1394"></a><span id="l1.1394" class="difflineplus">+        return result;</span>
<a href="#l1.1395"></a><span id="l1.1395" class="difflineplus">+      }</span>
<a href="#l1.1396"></a><span id="l1.1396" class="difflineplus">+    }</span>
<a href="#l1.1397"></a><span id="l1.1397" class="difflineplus">+  });</span>
<a href="#l1.1398"></a><span id="l1.1398" class="difflineplus">+</span>
<a href="#l1.1399"></a><span id="l1.1399" class="difflineplus">+  var icalProperties = ICAL.helpers.extend(commonProperties, {</span>
<a href="#l1.1400"></a><span id="l1.1400" class="difflineplus">+</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineplus">+    &quot;action&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineplus">+    &quot;attach&quot;: { defaultType: &quot;uri&quot; },</span>
<a href="#l1.1403"></a><span id="l1.1403" class="difflineplus">+    &quot;attendee&quot;: { defaultType: &quot;cal-address&quot; },</span>
<a href="#l1.1404"></a><span id="l1.1404" class="difflineplus">+    &quot;calscale&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1405"></a><span id="l1.1405" class="difflineplus">+    &quot;class&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1406"></a><span id="l1.1406" class="difflineplus">+    &quot;comment&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1407"></a><span id="l1.1407" class="difflineplus">+    &quot;completed&quot;: DEFAULT_TYPE_DATETIME,</span>
<a href="#l1.1408"></a><span id="l1.1408" class="difflineplus">+    &quot;contact&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1409"></a><span id="l1.1409" class="difflineplus">+    &quot;created&quot;: DEFAULT_TYPE_DATETIME,</span>
<a href="#l1.1410"></a><span id="l1.1410" class="difflineplus">+    &quot;description&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1411"></a><span id="l1.1411" class="difflineplus">+    &quot;dtend&quot;: DEFAULT_TYPE_DATETIME_DATE,</span>
<a href="#l1.1412"></a><span id="l1.1412" class="difflineplus">+    &quot;dtstamp&quot;: DEFAULT_TYPE_DATETIME,</span>
<a href="#l1.1413"></a><span id="l1.1413" class="difflineplus">+    &quot;dtstart&quot;: DEFAULT_TYPE_DATETIME_DATE,</span>
<a href="#l1.1414"></a><span id="l1.1414" class="difflineplus">+    &quot;due&quot;: DEFAULT_TYPE_DATETIME_DATE,</span>
<a href="#l1.1415"></a><span id="l1.1415" class="difflineplus">+    &quot;duration&quot;: { defaultType: &quot;duration&quot; },</span>
<a href="#l1.1416"></a><span id="l1.1416" class="difflineplus">+    &quot;exdate&quot;: {</span>
<a href="#l1.1417"></a><span id="l1.1417" class="difflineplus">+      defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineplus">+      allowedTypes: [&quot;date-time&quot;, &quot;date&quot;],</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineplus">+      multiValue: ','</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineplus">+    },</span>
<a href="#l1.1421"></a><span id="l1.1421" class="difflineplus">+    &quot;exrule&quot;: DEFAULT_TYPE_RECUR,</span>
<a href="#l1.1422"></a><span id="l1.1422" class="difflineplus">+    &quot;freebusy&quot;: { defaultType: &quot;period&quot;, multiValue: &quot;,&quot; },</span>
<a href="#l1.1423"></a><span id="l1.1423" class="difflineplus">+    &quot;geo&quot;: { defaultType: &quot;float&quot;, structuredValue: &quot;;&quot; },</span>
<a href="#l1.1424"></a><span id="l1.1424" class="difflineplus">+    &quot;last-modified&quot;: DEFAULT_TYPE_DATETIME,</span>
<a href="#l1.1425"></a><span id="l1.1425" class="difflineplus">+    &quot;location&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1426"></a><span id="l1.1426" class="difflineplus">+    &quot;method&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1427"></a><span id="l1.1427" class="difflineplus">+    &quot;organizer&quot;: { defaultType: &quot;cal-address&quot; },</span>
<a href="#l1.1428"></a><span id="l1.1428" class="difflineplus">+    &quot;percent-complete&quot;: DEFAULT_TYPE_INTEGER,</span>
<a href="#l1.1429"></a><span id="l1.1429" class="difflineplus">+    &quot;priority&quot;: DEFAULT_TYPE_INTEGER,</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineplus">+    &quot;prodid&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineplus">+    &quot;related-to&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1432"></a><span id="l1.1432" class="difflineplus">+    &quot;repeat&quot;: DEFAULT_TYPE_INTEGER,</span>
<a href="#l1.1433"></a><span id="l1.1433" class="difflineplus">+    &quot;rdate&quot;: {</span>
<a href="#l1.1434"></a><span id="l1.1434" class="difflineplus">+      defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1435"></a><span id="l1.1435" class="difflineplus">+      allowedTypes: [&quot;date-time&quot;, &quot;date&quot;, &quot;period&quot;],</span>
<a href="#l1.1436"></a><span id="l1.1436" class="difflineplus">+      multiValue: ',',</span>
<a href="#l1.1437"></a><span id="l1.1437" class="difflineplus">+      detectType: function(string) {</span>
<a href="#l1.1438"></a><span id="l1.1438" class="difflineplus">+        if (string.indexOf('/') !== -1) {</span>
<a href="#l1.1439"></a><span id="l1.1439" class="difflineplus">+          return 'period';</span>
<a href="#l1.1440"></a><span id="l1.1440" class="difflineplus">+        }</span>
<a href="#l1.1441"></a><span id="l1.1441" class="difflineplus">+        return (string.indexOf('T') === -1) ? 'date' : 'date-time';</span>
<a href="#l1.1442"></a><span id="l1.1442" class="difflineplus">+      }</span>
<a href="#l1.1443"></a><span id="l1.1443" class="difflineplus">+    },</span>
<a href="#l1.1444"></a><span id="l1.1444" class="difflineplus">+    &quot;recurrence-id&quot;: DEFAULT_TYPE_DATETIME_DATE,</span>
<a href="#l1.1445"></a><span id="l1.1445" class="difflineplus">+    &quot;resources&quot;: DEFAULT_TYPE_TEXT_MULTI,</span>
<a href="#l1.1446"></a><span id="l1.1446" class="difflineplus">+    &quot;request-status&quot;: DEFAULT_TYPE_TEXT_STRUCTURED,</span>
<a href="#l1.1447"></a><span id="l1.1447" class="difflineplus">+    &quot;rrule&quot;: DEFAULT_TYPE_RECUR,</span>
<a href="#l1.1448"></a><span id="l1.1448" class="difflineplus">+    &quot;sequence&quot;: DEFAULT_TYPE_INTEGER,</span>
<a href="#l1.1449"></a><span id="l1.1449" class="difflineplus">+    &quot;status&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1450"></a><span id="l1.1450" class="difflineplus">+    &quot;summary&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1451"></a><span id="l1.1451" class="difflineplus">+    &quot;transp&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1452"></a><span id="l1.1452" class="difflineplus">+    &quot;trigger&quot;: { defaultType: &quot;duration&quot;, allowedTypes: [&quot;duration&quot;, &quot;date-time&quot;] },</span>
<a href="#l1.1453"></a><span id="l1.1453" class="difflineplus">+    &quot;tzoffsetfrom&quot;: DEFAULT_TYPE_UTCOFFSET,</span>
<a href="#l1.1454"></a><span id="l1.1454" class="difflineplus">+    &quot;tzoffsetto&quot;: DEFAULT_TYPE_UTCOFFSET,</span>
<a href="#l1.1455"></a><span id="l1.1455" class="difflineplus">+    &quot;tzurl&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1456"></a><span id="l1.1456" class="difflineplus">+    &quot;tzid&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1457"></a><span id="l1.1457" class="difflineplus">+    &quot;tzname&quot;: DEFAULT_TYPE_TEXT</span>
<a href="#l1.1458"></a><span id="l1.1458" class="difflineplus">+  });</span>
<a href="#l1.1459"></a><span id="l1.1459" class="difflineplus">+</span>
<a href="#l1.1460"></a><span id="l1.1460" class="difflineplus">+  // When adding a value here, be sure to add it to the parameter types!</span>
<a href="#l1.1461"></a><span id="l1.1461" class="difflineplus">+  var vcardValues = ICAL.helpers.extend(commonValues, {</span>
<a href="#l1.1462"></a><span id="l1.1462" class="difflineplus">+    text: createTextType(FROM_VCARD_NEWLINE, TO_VCARD_NEWLINE),</span>
<a href="#l1.1463"></a><span id="l1.1463" class="difflineplus">+    uri: createTextType(FROM_VCARD_NEWLINE, TO_VCARD_NEWLINE),</span>
<a href="#l1.1464"></a><span id="l1.1464" class="difflineplus">+</span>
<a href="#l1.1465"></a><span id="l1.1465" class="difflineplus">+    date: {</span>
<a href="#l1.1466"></a><span id="l1.1466" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.1467"></a><span id="l1.1467" class="difflineplus">+        return ICAL.VCardTime.fromDateAndOrTimeString(aValue, &quot;date&quot;);</span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineplus">+      },</span>
<a href="#l1.1469"></a><span id="l1.1469" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1470"></a><span id="l1.1470" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1471"></a><span id="l1.1471" class="difflineplus">+      },</span>
<a href="#l1.1472"></a><span id="l1.1472" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1473"></a><span id="l1.1473" class="difflineplus">+        if (aValue.length == 8) {</span>
<a href="#l1.1474"></a><span id="l1.1474" class="difflineplus">+          return icalValues.date.fromICAL(aValue);</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineplus">+        } else if (aValue[0] == '-' &amp;&amp; aValue.length == 6) {</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineplus">+          return aValue.substr(0, 4) + '-' + aValue.substr(4);</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineplus">+        } else {</span>
<a href="#l1.1478"></a><span id="l1.1478" class="difflineplus">+          return aValue;</span>
<a href="#l1.1479"></a><span id="l1.1479">         }</span>
<a href="#l1.1480"></a><span id="l1.1480">       },</span>
<a href="#l1.1481"></a><span id="l1.1481" class="difflineminus">-</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineminus">-      uri: {</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineminus">-        // TODO</span>
<a href="#l1.1484"></a><span id="l1.1484" class="difflineminus">-        /* ... */</span>
<a href="#l1.1485"></a><span id="l1.1485" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1486"></a><span id="l1.1486" class="difflineplus">+        if (aValue.length == 10) {</span>
<a href="#l1.1487"></a><span id="l1.1487" class="difflineplus">+          return icalValues.date.toICAL(aValue);</span>
<a href="#l1.1488"></a><span id="l1.1488" class="difflineplus">+        } else if (aValue[0] == '-' &amp;&amp; aValue.length == 7) {</span>
<a href="#l1.1489"></a><span id="l1.1489" class="difflineplus">+          return aValue.substr(0, 4) + aValue.substr(5);</span>
<a href="#l1.1490"></a><span id="l1.1490" class="difflineplus">+        } else {</span>
<a href="#l1.1491"></a><span id="l1.1491" class="difflineplus">+          return aValue;</span>
<a href="#l1.1492"></a><span id="l1.1492" class="difflineplus">+        }</span>
<a href="#l1.1493"></a><span id="l1.1493" class="difflineplus">+      }</span>
<a href="#l1.1494"></a><span id="l1.1494" class="difflineplus">+    },</span>
<a href="#l1.1495"></a><span id="l1.1495" class="difflineplus">+</span>
<a href="#l1.1496"></a><span id="l1.1496" class="difflineplus">+    time: {</span>
<a href="#l1.1497"></a><span id="l1.1497" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.1498"></a><span id="l1.1498" class="difflineplus">+        return ICAL.VCardTime.fromDateAndOrTimeString(&quot;T&quot; + aValue, &quot;time&quot;);</span>
<a href="#l1.1499"></a><span id="l1.1499" class="difflineplus">+      },</span>
<a href="#l1.1500"></a><span id="l1.1500" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1501"></a><span id="l1.1501" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1502"></a><span id="l1.1502" class="difflineplus">+      },</span>
<a href="#l1.1503"></a><span id="l1.1503" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1504"></a><span id="l1.1504" class="difflineplus">+        var splitzone = vcardValues.time._splitZone(aValue, true);</span>
<a href="#l1.1505"></a><span id="l1.1505" class="difflineplus">+        var zone = splitzone[0], value = splitzone[1];</span>
<a href="#l1.1506"></a><span id="l1.1506" class="difflineplus">+</span>
<a href="#l1.1507"></a><span id="l1.1507" class="difflineplus">+        //console.log(&quot;SPLIT: &quot;,splitzone);</span>
<a href="#l1.1508"></a><span id="l1.1508" class="difflineplus">+</span>
<a href="#l1.1509"></a><span id="l1.1509" class="difflineplus">+        if (value.length == 6) {</span>
<a href="#l1.1510"></a><span id="l1.1510" class="difflineplus">+          value = value.substr(0, 2) + ':' +</span>
<a href="#l1.1511"></a><span id="l1.1511" class="difflineplus">+                  value.substr(2, 2) + ':' +</span>
<a href="#l1.1512"></a><span id="l1.1512" class="difflineplus">+                  value.substr(4, 2);</span>
<a href="#l1.1513"></a><span id="l1.1513" class="difflineplus">+        } else if (value.length == 4 &amp;&amp; value[0] != '-') {</span>
<a href="#l1.1514"></a><span id="l1.1514" class="difflineplus">+          value = value.substr(0, 2) + ':' + value.substr(2, 2);</span>
<a href="#l1.1515"></a><span id="l1.1515" class="difflineplus">+        } else if (value.length == 5) {</span>
<a href="#l1.1516"></a><span id="l1.1516" class="difflineplus">+          value = value.substr(0, 3) + ':' + value.substr(3, 2);</span>
<a href="#l1.1517"></a><span id="l1.1517" class="difflineplus">+        }</span>
<a href="#l1.1518"></a><span id="l1.1518" class="difflineplus">+</span>
<a href="#l1.1519"></a><span id="l1.1519" class="difflineplus">+        if (zone.length == 5 &amp;&amp; (zone[0] == '-' || zone[0] == '+')) {</span>
<a href="#l1.1520"></a><span id="l1.1520" class="difflineplus">+          zone = zone.substr(0, 3) + ':' + zone.substr(3);</span>
<a href="#l1.1521"></a><span id="l1.1521" class="difflineplus">+        }</span>
<a href="#l1.1522"></a><span id="l1.1522" class="difflineplus">+</span>
<a href="#l1.1523"></a><span id="l1.1523" class="difflineplus">+        return value + zone;</span>
<a href="#l1.1524"></a><span id="l1.1524" class="difflineplus">+      },</span>
<a href="#l1.1525"></a><span id="l1.1525" class="difflineplus">+</span>
<a href="#l1.1526"></a><span id="l1.1526" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1527"></a><span id="l1.1527" class="difflineplus">+        var splitzone = vcardValues.time._splitZone(aValue);</span>
<a href="#l1.1528"></a><span id="l1.1528" class="difflineplus">+        var zone = splitzone[0], value = splitzone[1];</span>
<a href="#l1.1529"></a><span id="l1.1529" class="difflineplus">+</span>
<a href="#l1.1530"></a><span id="l1.1530" class="difflineplus">+        if (value.length == 8) {</span>
<a href="#l1.1531"></a><span id="l1.1531" class="difflineplus">+          value = value.substr(0, 2) +</span>
<a href="#l1.1532"></a><span id="l1.1532" class="difflineplus">+                  value.substr(3, 2) +</span>
<a href="#l1.1533"></a><span id="l1.1533" class="difflineplus">+                  value.substr(6, 2);</span>
<a href="#l1.1534"></a><span id="l1.1534" class="difflineplus">+        } else if (value.length == 5 &amp;&amp; value[0] != '-') {</span>
<a href="#l1.1535"></a><span id="l1.1535" class="difflineplus">+          value = value.substr(0, 2) + value.substr(3, 2);</span>
<a href="#l1.1536"></a><span id="l1.1536" class="difflineplus">+        } else if (value.length == 6) {</span>
<a href="#l1.1537"></a><span id="l1.1537" class="difflineplus">+          value = value.substr(0, 3) + value.substr(4, 2);</span>
<a href="#l1.1538"></a><span id="l1.1538" class="difflineplus">+        }</span>
<a href="#l1.1539"></a><span id="l1.1539" class="difflineplus">+</span>
<a href="#l1.1540"></a><span id="l1.1540" class="difflineplus">+        if (zone.length == 6 &amp;&amp; (zone[0] == '-' || zone[0] == '+')) {</span>
<a href="#l1.1541"></a><span id="l1.1541" class="difflineplus">+          zone = zone.substr(0, 3) + zone.substr(4);</span>
<a href="#l1.1542"></a><span id="l1.1542" class="difflineplus">+        }</span>
<a href="#l1.1543"></a><span id="l1.1543" class="difflineplus">+</span>
<a href="#l1.1544"></a><span id="l1.1544" class="difflineplus">+        return value + zone;</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineplus">+      },</span>
<a href="#l1.1546"></a><span id="l1.1546" class="difflineplus">+</span>
<a href="#l1.1547"></a><span id="l1.1547" class="difflineplus">+      _splitZone: function(aValue, isFromIcal) {</span>
<a href="#l1.1548"></a><span id="l1.1548" class="difflineplus">+        var lastChar = aValue.length - 1;</span>
<a href="#l1.1549"></a><span id="l1.1549" class="difflineplus">+        var signChar = aValue.length - (isFromIcal ? 5 : 6);</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineplus">+        var sign = aValue[signChar];</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineplus">+        var zone, value;</span>
<a href="#l1.1552"></a><span id="l1.1552" class="difflineplus">+</span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineplus">+        if (aValue[lastChar] == 'Z') {</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineplus">+          zone = aValue[lastChar];</span>
<a href="#l1.1555"></a><span id="l1.1555" class="difflineplus">+          value = aValue.substr(0, lastChar);</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineplus">+        } else if (aValue.length &gt; 6 &amp;&amp; (sign == '-' || sign == '+')) {</span>
<a href="#l1.1557"></a><span id="l1.1557" class="difflineplus">+          zone = aValue.substr(signChar);</span>
<a href="#l1.1558"></a><span id="l1.1558" class="difflineplus">+          value = aValue.substr(0, signChar);</span>
<a href="#l1.1559"></a><span id="l1.1559" class="difflineplus">+        } else {</span>
<a href="#l1.1560"></a><span id="l1.1560" class="difflineplus">+          zone = &quot;&quot;;</span>
<a href="#l1.1561"></a><span id="l1.1561" class="difflineplus">+          value = aValue;</span>
<a href="#l1.1562"></a><span id="l1.1562" class="difflineplus">+        }</span>
<a href="#l1.1563"></a><span id="l1.1563" class="difflineplus">+</span>
<a href="#l1.1564"></a><span id="l1.1564" class="difflineplus">+        return [zone, value];</span>
<a href="#l1.1565"></a><span id="l1.1565" class="difflineplus">+      }</span>
<a href="#l1.1566"></a><span id="l1.1566" class="difflineplus">+    },</span>
<a href="#l1.1567"></a><span id="l1.1567" class="difflineplus">+</span>
<a href="#l1.1568"></a><span id="l1.1568" class="difflineplus">+    &quot;date-time&quot;: {</span>
<a href="#l1.1569"></a><span id="l1.1569" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.1570"></a><span id="l1.1570" class="difflineplus">+        return ICAL.VCardTime.fromDateAndOrTimeString(aValue, &quot;date-time&quot;);</span>
<a href="#l1.1571"></a><span id="l1.1571" class="difflineplus">+      },</span>
<a href="#l1.1572"></a><span id="l1.1572" class="difflineplus">+</span>
<a href="#l1.1573"></a><span id="l1.1573" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1574"></a><span id="l1.1574" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1575"></a><span id="l1.1575" class="difflineplus">+      },</span>
<a href="#l1.1576"></a><span id="l1.1576" class="difflineplus">+</span>
<a href="#l1.1577"></a><span id="l1.1577" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1578"></a><span id="l1.1578" class="difflineplus">+        return vcardValues['date-and-or-time'].fromICAL(aValue);</span>
<a href="#l1.1579"></a><span id="l1.1579">       },</span>
<a href="#l1.1580"></a><span id="l1.1580"> </span>
<a href="#l1.1581"></a><span id="l1.1581" class="difflineminus">-      &quot;utc-offset&quot;: {</span>
<a href="#l1.1582"></a><span id="l1.1582" class="difflineminus">-        toICAL: function(aValue) {</span>
<a href="#l1.1583"></a><span id="l1.1583" class="difflineminus">-          if (aValue.length &lt; 7) {</span>
<a href="#l1.1584"></a><span id="l1.1584" class="difflineminus">-            // no seconds</span>
<a href="#l1.1585"></a><span id="l1.1585" class="difflineminus">-            // -0500</span>
<a href="#l1.1586"></a><span id="l1.1586" class="difflineminus">-            return aValue.substr(0, 3) +</span>
<a href="#l1.1587"></a><span id="l1.1587" class="difflineminus">-                   aValue.substr(4, 2);</span>
<a href="#l1.1588"></a><span id="l1.1588" class="difflineminus">-          } else {</span>
<a href="#l1.1589"></a><span id="l1.1589" class="difflineminus">-            // seconds</span>
<a href="#l1.1590"></a><span id="l1.1590" class="difflineminus">-            // -050000</span>
<a href="#l1.1591"></a><span id="l1.1591" class="difflineminus">-            return aValue.substr(0, 3) +</span>
<a href="#l1.1592"></a><span id="l1.1592" class="difflineminus">-                   aValue.substr(4, 2) +</span>
<a href="#l1.1593"></a><span id="l1.1593" class="difflineminus">-                   aValue.substr(7, 2);</span>
<a href="#l1.1594"></a><span id="l1.1594" class="difflineminus">-          }</span>
<a href="#l1.1595"></a><span id="l1.1595" class="difflineminus">-        },</span>
<a href="#l1.1596"></a><span id="l1.1596" class="difflineminus">-</span>
<a href="#l1.1597"></a><span id="l1.1597" class="difflineminus">-        fromICAL: function(aValue) {</span>
<a href="#l1.1598"></a><span id="l1.1598" class="difflineminus">-          if (aValue.length &lt; 6) {</span>
<a href="#l1.1599"></a><span id="l1.1599" class="difflineminus">-            // no seconds</span>
<a href="#l1.1600"></a><span id="l1.1600" class="difflineminus">-            // -05:00</span>
<a href="#l1.1601"></a><span id="l1.1601" class="difflineminus">-            return aValue.substr(0, 3) + ':' +</span>
<a href="#l1.1602"></a><span id="l1.1602" class="difflineminus">-                   aValue.substr(3, 2);</span>
<a href="#l1.1603"></a><span id="l1.1603" class="difflineminus">-          } else {</span>
<a href="#l1.1604"></a><span id="l1.1604" class="difflineminus">-            // seconds</span>
<a href="#l1.1605"></a><span id="l1.1605" class="difflineminus">-            // -05:00:00</span>
<a href="#l1.1606"></a><span id="l1.1606" class="difflineminus">-            return aValue.substr(0, 3) + ':' +</span>
<a href="#l1.1607"></a><span id="l1.1607" class="difflineminus">-                   aValue.substr(3, 2) + ':' +</span>
<a href="#l1.1608"></a><span id="l1.1608" class="difflineminus">-                   aValue.substr(5, 2);</span>
<a href="#l1.1609"></a><span id="l1.1609" class="difflineminus">-          }</span>
<a href="#l1.1610"></a><span id="l1.1610" class="difflineminus">-        },</span>
<a href="#l1.1611"></a><span id="l1.1611" class="difflineminus">-</span>
<a href="#l1.1612"></a><span id="l1.1612" class="difflineminus">-        decorate: function(aValue) {</span>
<a href="#l1.1613"></a><span id="l1.1613" class="difflineminus">-          return ICAL.UtcOffset.fromString(aValue);</span>
<a href="#l1.1614"></a><span id="l1.1614" class="difflineminus">-        },</span>
<a href="#l1.1615"></a><span id="l1.1615" class="difflineminus">-</span>
<a href="#l1.1616"></a><span id="l1.1616" class="difflineminus">-        undecorate: function(aValue) {</span>
<a href="#l1.1617"></a><span id="l1.1617" class="difflineminus">-          return aValue.toString();</span>
<a href="#l1.1618"></a><span id="l1.1618" class="difflineminus">-        }</span>
<a href="#l1.1619"></a><span id="l1.1619" class="difflineminus">-      }</span>
<a href="#l1.1620"></a><span id="l1.1620" class="difflineminus">-    },</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineminus">-</span>
<a href="#l1.1622"></a><span id="l1.1622" class="difflineminus">-    property: {</span>
<a href="#l1.1623"></a><span id="l1.1623" class="difflineminus">-      decorate: function decorate(aData, aParent) {</span>
<a href="#l1.1624"></a><span id="l1.1624" class="difflineminus">-        return new ICAL.Property(aData, aParent);</span>
<a href="#l1.1625"></a><span id="l1.1625" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1626"></a><span id="l1.1626" class="difflineplus">+        return vcardValues['date-and-or-time'].toICAL(aValue);</span>
<a href="#l1.1627"></a><span id="l1.1627" class="difflineplus">+      }</span>
<a href="#l1.1628"></a><span id="l1.1628" class="difflineplus">+    },</span>
<a href="#l1.1629"></a><span id="l1.1629" class="difflineplus">+</span>
<a href="#l1.1630"></a><span id="l1.1630" class="difflineplus">+    &quot;date-and-or-time&quot;: {</span>
<a href="#l1.1631"></a><span id="l1.1631" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.1632"></a><span id="l1.1632" class="difflineplus">+        return ICAL.VCardTime.fromDateAndOrTimeString(aValue, &quot;date-and-or-time&quot;);</span>
<a href="#l1.1633"></a><span id="l1.1633" class="difflineplus">+      },</span>
<a href="#l1.1634"></a><span id="l1.1634" class="difflineplus">+</span>
<a href="#l1.1635"></a><span id="l1.1635" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1636"></a><span id="l1.1636" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1637"></a><span id="l1.1637" class="difflineplus">+      },</span>
<a href="#l1.1638"></a><span id="l1.1638" class="difflineplus">+</span>
<a href="#l1.1639"></a><span id="l1.1639" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1640"></a><span id="l1.1640" class="difflineplus">+        var parts = aValue.split('T');</span>
<a href="#l1.1641"></a><span id="l1.1641" class="difflineplus">+        return (parts[0] ? vcardValues.date.fromICAL(parts[0]) : '') +</span>
<a href="#l1.1642"></a><span id="l1.1642" class="difflineplus">+               (parts[1] ? 'T' + vcardValues.time.fromICAL(parts[1]) : '');</span>
<a href="#l1.1643"></a><span id="l1.1643">       },</span>
<a href="#l1.1644"></a><span id="l1.1644" class="difflineminus">-      &quot;attach&quot;: {</span>
<a href="#l1.1645"></a><span id="l1.1645" class="difflineminus">-        defaultType: &quot;uri&quot;</span>
<a href="#l1.1646"></a><span id="l1.1646" class="difflineminus">-      },</span>
<a href="#l1.1647"></a><span id="l1.1647" class="difflineminus">-      &quot;attendee&quot;: {</span>
<a href="#l1.1648"></a><span id="l1.1648" class="difflineminus">-        defaultType: &quot;cal-address&quot;</span>
<a href="#l1.1649"></a><span id="l1.1649" class="difflineminus">-      },</span>
<a href="#l1.1650"></a><span id="l1.1650" class="difflineminus">-      &quot;categories&quot;: {</span>
<a href="#l1.1651"></a><span id="l1.1651" class="difflineminus">-        defaultType: &quot;text&quot;,</span>
<a href="#l1.1652"></a><span id="l1.1652" class="difflineminus">-        multiValue: &quot;,&quot;</span>
<a href="#l1.1653"></a><span id="l1.1653" class="difflineminus">-      },</span>
<a href="#l1.1654"></a><span id="l1.1654" class="difflineminus">-      &quot;completed&quot;: {</span>
<a href="#l1.1655"></a><span id="l1.1655" class="difflineminus">-        defaultType: &quot;date-time&quot;</span>
<a href="#l1.1656"></a><span id="l1.1656" class="difflineminus">-      },</span>
<a href="#l1.1657"></a><span id="l1.1657" class="difflineminus">-      &quot;created&quot;: {</span>
<a href="#l1.1658"></a><span id="l1.1658" class="difflineminus">-        defaultType: &quot;date-time&quot;</span>
<a href="#l1.1659"></a><span id="l1.1659" class="difflineminus">-      },</span>
<a href="#l1.1660"></a><span id="l1.1660" class="difflineminus">-      &quot;dtend&quot;: {</span>
<a href="#l1.1661"></a><span id="l1.1661" class="difflineminus">-        defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1662"></a><span id="l1.1662" class="difflineminus">-        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l1.1663"></a><span id="l1.1663" class="difflineminus">-      },</span>
<a href="#l1.1664"></a><span id="l1.1664" class="difflineminus">-      &quot;dtstamp&quot;: {</span>
<a href="#l1.1665"></a><span id="l1.1665" class="difflineminus">-        defaultType: &quot;date-time&quot;</span>
<a href="#l1.1666"></a><span id="l1.1666" class="difflineminus">-      },</span>
<a href="#l1.1667"></a><span id="l1.1667" class="difflineminus">-      &quot;dtstart&quot;: {</span>
<a href="#l1.1668"></a><span id="l1.1668" class="difflineminus">-        defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1669"></a><span id="l1.1669" class="difflineminus">-        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l1.1670"></a><span id="l1.1670" class="difflineminus">-      },</span>
<a href="#l1.1671"></a><span id="l1.1671" class="difflineminus">-      &quot;due&quot;: {</span>
<a href="#l1.1672"></a><span id="l1.1672" class="difflineminus">-        defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1673"></a><span id="l1.1673" class="difflineminus">-        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l1.1674"></a><span id="l1.1674" class="difflineminus">-      },</span>
<a href="#l1.1675"></a><span id="l1.1675" class="difflineminus">-      &quot;duration&quot;: {</span>
<a href="#l1.1676"></a><span id="l1.1676" class="difflineminus">-        defaultType: &quot;duration&quot;</span>
<a href="#l1.1677"></a><span id="l1.1677" class="difflineplus">+</span>
<a href="#l1.1678"></a><span id="l1.1678" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1679"></a><span id="l1.1679" class="difflineplus">+        var parts = aValue.split('T');</span>
<a href="#l1.1680"></a><span id="l1.1680" class="difflineplus">+        return vcardValues.date.toICAL(parts[0]) +</span>
<a href="#l1.1681"></a><span id="l1.1681" class="difflineplus">+               (parts[1] ? 'T' + vcardValues.time.toICAL(parts[1]) : '');</span>
<a href="#l1.1682"></a><span id="l1.1682" class="difflineplus">+</span>
<a href="#l1.1683"></a><span id="l1.1683" class="difflineplus">+      }</span>
<a href="#l1.1684"></a><span id="l1.1684" class="difflineplus">+    },</span>
<a href="#l1.1685"></a><span id="l1.1685" class="difflineplus">+    timestamp: icalValues['date-time'],</span>
<a href="#l1.1686"></a><span id="l1.1686" class="difflineplus">+    &quot;language-tag&quot;: {</span>
<a href="#l1.1687"></a><span id="l1.1687" class="difflineplus">+      matches: /^[a-zA-Z0-9\-]+$/ // Could go with a more strict regex here</span>
<a href="#l1.1688"></a><span id="l1.1688" class="difflineplus">+    }</span>
<a href="#l1.1689"></a><span id="l1.1689" class="difflineplus">+  });</span>
<a href="#l1.1690"></a><span id="l1.1690" class="difflineplus">+</span>
<a href="#l1.1691"></a><span id="l1.1691" class="difflineplus">+  var vcardParams = {</span>
<a href="#l1.1692"></a><span id="l1.1692" class="difflineplus">+    &quot;type&quot;: {</span>
<a href="#l1.1693"></a><span id="l1.1693" class="difflineplus">+      valueType: &quot;text&quot;,</span>
<a href="#l1.1694"></a><span id="l1.1694" class="difflineplus">+      multiValue: &quot;,&quot;</span>
<a href="#l1.1695"></a><span id="l1.1695" class="difflineplus">+    },</span>
<a href="#l1.1696"></a><span id="l1.1696" class="difflineplus">+    &quot;value&quot;: {</span>
<a href="#l1.1697"></a><span id="l1.1697" class="difflineplus">+      // since the value here is a 'type' lowercase is used.</span>
<a href="#l1.1698"></a><span id="l1.1698" class="difflineplus">+      values: [&quot;text&quot;, &quot;uri&quot;, &quot;date&quot;, &quot;time&quot;, &quot;date-time&quot;, &quot;date-and-or-time&quot;,</span>
<a href="#l1.1699"></a><span id="l1.1699" class="difflineplus">+               &quot;timestamp&quot;, &quot;boolean&quot;, &quot;integer&quot;, &quot;float&quot;, &quot;utc-offset&quot;,</span>
<a href="#l1.1700"></a><span id="l1.1700" class="difflineplus">+               &quot;language-tag&quot;],</span>
<a href="#l1.1701"></a><span id="l1.1701" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1702"></a><span id="l1.1702" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1703"></a><span id="l1.1703" class="difflineplus">+    }</span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineplus">+  };</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineplus">+</span>
<a href="#l1.1706"></a><span id="l1.1706" class="difflineplus">+  var vcardProperties = ICAL.helpers.extend(commonProperties, {</span>
<a href="#l1.1707"></a><span id="l1.1707" class="difflineplus">+    &quot;adr&quot;: { defaultType: &quot;text&quot;, structuredValue: &quot;;&quot;, multiValue: &quot;,&quot; },</span>
<a href="#l1.1708"></a><span id="l1.1708" class="difflineplus">+    &quot;anniversary&quot;: DEFAULT_TYPE_DATE_ANDOR_TIME,</span>
<a href="#l1.1709"></a><span id="l1.1709" class="difflineplus">+    &quot;bday&quot;: DEFAULT_TYPE_DATE_ANDOR_TIME,</span>
<a href="#l1.1710"></a><span id="l1.1710" class="difflineplus">+    &quot;caladruri&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1711"></a><span id="l1.1711" class="difflineplus">+    &quot;caluri&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1712"></a><span id="l1.1712" class="difflineplus">+    &quot;clientpidmap&quot;: DEFAULT_TYPE_TEXT_STRUCTURED,</span>
<a href="#l1.1713"></a><span id="l1.1713" class="difflineplus">+    &quot;email&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1714"></a><span id="l1.1714" class="difflineplus">+    &quot;fburl&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1715"></a><span id="l1.1715" class="difflineplus">+    &quot;fn&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1716"></a><span id="l1.1716" class="difflineplus">+    &quot;gender&quot;: DEFAULT_TYPE_TEXT_STRUCTURED,</span>
<a href="#l1.1717"></a><span id="l1.1717" class="difflineplus">+    &quot;geo&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1718"></a><span id="l1.1718" class="difflineplus">+    &quot;impp&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1719"></a><span id="l1.1719" class="difflineplus">+    &quot;key&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1720"></a><span id="l1.1720" class="difflineplus">+    &quot;kind&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1721"></a><span id="l1.1721" class="difflineplus">+    &quot;lang&quot;: { defaultType: &quot;language-tag&quot; },</span>
<a href="#l1.1722"></a><span id="l1.1722" class="difflineplus">+    &quot;logo&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineplus">+    &quot;member&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineplus">+    &quot;n&quot;: { defaultType: &quot;text&quot;, structuredValue: &quot;;&quot;, multiValue: &quot;,&quot; },</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineplus">+    &quot;nickname&quot;: DEFAULT_TYPE_TEXT_MULTI,</span>
<a href="#l1.1726"></a><span id="l1.1726" class="difflineplus">+    &quot;note&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1727"></a><span id="l1.1727" class="difflineplus">+    &quot;org&quot;: { defaultType: &quot;text&quot;, structuredValue: &quot;;&quot; },</span>
<a href="#l1.1728"></a><span id="l1.1728" class="difflineplus">+    &quot;photo&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1729"></a><span id="l1.1729" class="difflineplus">+    &quot;related&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1730"></a><span id="l1.1730" class="difflineplus">+    &quot;rev&quot;: { defaultType: &quot;timestamp&quot; },</span>
<a href="#l1.1731"></a><span id="l1.1731" class="difflineplus">+    &quot;role&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1732"></a><span id="l1.1732" class="difflineplus">+    &quot;sound&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1733"></a><span id="l1.1733" class="difflineplus">+    &quot;source&quot;: DEFAULT_TYPE_URI,</span>
<a href="#l1.1734"></a><span id="l1.1734" class="difflineplus">+    &quot;tel&quot;: { defaultType: &quot;uri&quot;, allowedTypes: [&quot;uri&quot;, &quot;text&quot;] },</span>
<a href="#l1.1735"></a><span id="l1.1735" class="difflineplus">+    &quot;title&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1736"></a><span id="l1.1736" class="difflineplus">+    &quot;tz&quot;: { defaultType: &quot;text&quot;, allowedTypes: [&quot;text&quot;, &quot;utc-offset&quot;, &quot;uri&quot;] },</span>
<a href="#l1.1737"></a><span id="l1.1737" class="difflineplus">+    &quot;xml&quot;: DEFAULT_TYPE_TEXT</span>
<a href="#l1.1738"></a><span id="l1.1738" class="difflineplus">+  });</span>
<a href="#l1.1739"></a><span id="l1.1739" class="difflineplus">+</span>
<a href="#l1.1740"></a><span id="l1.1740" class="difflineplus">+  var vcard3Values = ICAL.helpers.extend(commonValues, {</span>
<a href="#l1.1741"></a><span id="l1.1741" class="difflineplus">+    binary: icalValues.binary,</span>
<a href="#l1.1742"></a><span id="l1.1742" class="difflineplus">+    date: vcardValues.date,</span>
<a href="#l1.1743"></a><span id="l1.1743" class="difflineplus">+    &quot;date-time&quot;: vcardValues[&quot;date-time&quot;],</span>
<a href="#l1.1744"></a><span id="l1.1744" class="difflineplus">+    &quot;phone-number&quot;: {</span>
<a href="#l1.1745"></a><span id="l1.1745" class="difflineplus">+      // TODO</span>
<a href="#l1.1746"></a><span id="l1.1746" class="difflineplus">+      /* ... */</span>
<a href="#l1.1747"></a><span id="l1.1747" class="difflineplus">+    },</span>
<a href="#l1.1748"></a><span id="l1.1748" class="difflineplus">+    uri: icalValues.uri,</span>
<a href="#l1.1749"></a><span id="l1.1749" class="difflineplus">+    text: icalValues.text,</span>
<a href="#l1.1750"></a><span id="l1.1750" class="difflineplus">+    time: icalValues.time,</span>
<a href="#l1.1751"></a><span id="l1.1751" class="difflineplus">+    vcard: icalValues.text,</span>
<a href="#l1.1752"></a><span id="l1.1752" class="difflineplus">+    &quot;utc-offset&quot;: {</span>
<a href="#l1.1753"></a><span id="l1.1753" class="difflineplus">+      toICAL: function(aValue) {</span>
<a href="#l1.1754"></a><span id="l1.1754" class="difflineplus">+        return aValue.substr(0, 7);</span>
<a href="#l1.1755"></a><span id="l1.1755">       },</span>
<a href="#l1.1756"></a><span id="l1.1756" class="difflineminus">-      &quot;exdate&quot;: {</span>
<a href="#l1.1757"></a><span id="l1.1757" class="difflineminus">-        defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1758"></a><span id="l1.1758" class="difflineminus">-        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;],</span>
<a href="#l1.1759"></a><span id="l1.1759" class="difflineminus">-        multiValue: ','</span>
<a href="#l1.1760"></a><span id="l1.1760" class="difflineminus">-      },</span>
<a href="#l1.1761"></a><span id="l1.1761" class="difflineminus">-      &quot;exrule&quot;: {</span>
<a href="#l1.1762"></a><span id="l1.1762" class="difflineminus">-        defaultType: &quot;recur&quot;</span>
<a href="#l1.1763"></a><span id="l1.1763" class="difflineminus">-      },</span>
<a href="#l1.1764"></a><span id="l1.1764" class="difflineminus">-      &quot;freebusy&quot;: {</span>
<a href="#l1.1765"></a><span id="l1.1765" class="difflineminus">-        defaultType: &quot;period&quot;,</span>
<a href="#l1.1766"></a><span id="l1.1766" class="difflineminus">-        multiValue: &quot;,&quot;</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineminus">-      },</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineminus">-      &quot;geo&quot;: {</span>
<a href="#l1.1769"></a><span id="l1.1769" class="difflineminus">-        defaultType: &quot;float&quot;,</span>
<a href="#l1.1770"></a><span id="l1.1770" class="difflineminus">-        multiValue: &quot;;&quot;</span>
<a href="#l1.1771"></a><span id="l1.1771" class="difflineminus">-      },</span>
<a href="#l1.1772"></a><span id="l1.1772" class="difflineminus">-      /* TODO exactly 2 values */&quot;last-modified&quot;: {</span>
<a href="#l1.1773"></a><span id="l1.1773" class="difflineminus">-        defaultType: &quot;date-time&quot;</span>
<a href="#l1.1774"></a><span id="l1.1774" class="difflineplus">+</span>
<a href="#l1.1775"></a><span id="l1.1775" class="difflineplus">+      fromICAL: function(aValue) {</span>
<a href="#l1.1776"></a><span id="l1.1776" class="difflineplus">+        return aValue.substr(0, 7);</span>
<a href="#l1.1777"></a><span id="l1.1777">       },</span>
<a href="#l1.1778"></a><span id="l1.1778" class="difflineminus">-      &quot;organizer&quot;: {</span>
<a href="#l1.1779"></a><span id="l1.1779" class="difflineminus">-        defaultType: &quot;cal-address&quot;</span>
<a href="#l1.1780"></a><span id="l1.1780" class="difflineminus">-      },</span>
<a href="#l1.1781"></a><span id="l1.1781" class="difflineminus">-      &quot;percent-complete&quot;: {</span>
<a href="#l1.1782"></a><span id="l1.1782" class="difflineminus">-        defaultType: &quot;integer&quot;</span>
<a href="#l1.1783"></a><span id="l1.1783" class="difflineminus">-      },</span>
<a href="#l1.1784"></a><span id="l1.1784" class="difflineminus">-      &quot;repeat&quot;: {</span>
<a href="#l1.1785"></a><span id="l1.1785" class="difflineminus">-        defaultType: &quot;integer&quot;</span>
<a href="#l1.1786"></a><span id="l1.1786" class="difflineminus">-      },</span>
<a href="#l1.1787"></a><span id="l1.1787" class="difflineminus">-      &quot;rdate&quot;: {</span>
<a href="#l1.1788"></a><span id="l1.1788" class="difflineminus">-        defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1789"></a><span id="l1.1789" class="difflineminus">-        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;, &quot;period&quot;],</span>
<a href="#l1.1790"></a><span id="l1.1790" class="difflineminus">-        multiValue: ',',</span>
<a href="#l1.1791"></a><span id="l1.1791" class="difflineminus">-        detectType: function(string) {</span>
<a href="#l1.1792"></a><span id="l1.1792" class="difflineminus">-          if (string.indexOf('/') !== -1) {</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineminus">-            return 'period';</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineminus">-          }</span>
<a href="#l1.1795"></a><span id="l1.1795" class="difflineminus">-          return (string.indexOf('T') === -1) ? 'date' : 'date-time';</span>
<a href="#l1.1796"></a><span id="l1.1796" class="difflineminus">-        }</span>
<a href="#l1.1797"></a><span id="l1.1797" class="difflineminus">-      },</span>
<a href="#l1.1798"></a><span id="l1.1798" class="difflineminus">-      &quot;recurrence-id&quot;: {</span>
<a href="#l1.1799"></a><span id="l1.1799" class="difflineminus">-        defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1800"></a><span id="l1.1800" class="difflineminus">-        allowedTypes: [&quot;date-time&quot;, &quot;date&quot;]</span>
<a href="#l1.1801"></a><span id="l1.1801" class="difflineplus">+</span>
<a href="#l1.1802"></a><span id="l1.1802" class="difflineplus">+      decorate: function(aValue) {</span>
<a href="#l1.1803"></a><span id="l1.1803" class="difflineplus">+        return ICAL.UtcOffset.fromString(aValue);</span>
<a href="#l1.1804"></a><span id="l1.1804">       },</span>
<a href="#l1.1805"></a><span id="l1.1805" class="difflineminus">-      &quot;resources&quot;: {</span>
<a href="#l1.1806"></a><span id="l1.1806" class="difflineminus">-        defaultType: &quot;text&quot;,</span>
<a href="#l1.1807"></a><span id="l1.1807" class="difflineminus">-        multiValue: &quot;,&quot;</span>
<a href="#l1.1808"></a><span id="l1.1808" class="difflineminus">-      },</span>
<a href="#l1.1809"></a><span id="l1.1809" class="difflineminus">-      &quot;request-status&quot;: {</span>
<a href="#l1.1810"></a><span id="l1.1810" class="difflineminus">-        defaultType: &quot;text&quot;,</span>
<a href="#l1.1811"></a><span id="l1.1811" class="difflineminus">-        multiValue: &quot;;&quot;</span>
<a href="#l1.1812"></a><span id="l1.1812" class="difflineminus">-      },</span>
<a href="#l1.1813"></a><span id="l1.1813" class="difflineminus">-      &quot;priority&quot;: {</span>
<a href="#l1.1814"></a><span id="l1.1814" class="difflineminus">-        defaultType: &quot;integer&quot;</span>
<a href="#l1.1815"></a><span id="l1.1815" class="difflineminus">-      },</span>
<a href="#l1.1816"></a><span id="l1.1816" class="difflineminus">-      &quot;rrule&quot;: {</span>
<a href="#l1.1817"></a><span id="l1.1817" class="difflineminus">-        defaultType: &quot;recur&quot;</span>
<a href="#l1.1818"></a><span id="l1.1818" class="difflineminus">-      },</span>
<a href="#l1.1819"></a><span id="l1.1819" class="difflineminus">-      &quot;sequence&quot;: {</span>
<a href="#l1.1820"></a><span id="l1.1820" class="difflineminus">-        defaultType: &quot;integer&quot;</span>
<a href="#l1.1821"></a><span id="l1.1821" class="difflineminus">-      },</span>
<a href="#l1.1822"></a><span id="l1.1822" class="difflineminus">-      &quot;trigger&quot;: {</span>
<a href="#l1.1823"></a><span id="l1.1823" class="difflineminus">-        defaultType: &quot;duration&quot;,</span>
<a href="#l1.1824"></a><span id="l1.1824" class="difflineminus">-        allowedTypes: [&quot;duration&quot;, &quot;date-time&quot;]</span>
<a href="#l1.1825"></a><span id="l1.1825" class="difflineminus">-      },</span>
<a href="#l1.1826"></a><span id="l1.1826" class="difflineminus">-      &quot;tzoffsetfrom&quot;: {</span>
<a href="#l1.1827"></a><span id="l1.1827" class="difflineminus">-        defaultType: &quot;utc-offset&quot;</span>
<a href="#l1.1828"></a><span id="l1.1828" class="difflineminus">-      },</span>
<a href="#l1.1829"></a><span id="l1.1829" class="difflineminus">-      &quot;tzoffsetto&quot;: {</span>
<a href="#l1.1830"></a><span id="l1.1830" class="difflineminus">-        defaultType: &quot;utc-offset&quot;</span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineminus">-      },</span>
<a href="#l1.1832"></a><span id="l1.1832" class="difflineminus">-      &quot;tzurl&quot;: {</span>
<a href="#l1.1833"></a><span id="l1.1833" class="difflineminus">-        defaultType: &quot;uri&quot;</span>
<a href="#l1.1834"></a><span id="l1.1834" class="difflineminus">-      },</span>
<a href="#l1.1835"></a><span id="l1.1835" class="difflineminus">-      &quot;url&quot;: {</span>
<a href="#l1.1836"></a><span id="l1.1836" class="difflineminus">-        defaultType: &quot;uri&quot;</span>
<a href="#l1.1837"></a><span id="l1.1837" class="difflineminus">-      }</span>
<a href="#l1.1838"></a><span id="l1.1838" class="difflineminus">-    },</span>
<a href="#l1.1839"></a><span id="l1.1839" class="difflineminus">-</span>
<a href="#l1.1840"></a><span id="l1.1840" class="difflineminus">-    component: {</span>
<a href="#l1.1841"></a><span id="l1.1841" class="difflineminus">-      decorate: function decorate(aData, aParent) {</span>
<a href="#l1.1842"></a><span id="l1.1842" class="difflineminus">-        return new ICAL.Component(aData, aParent);</span>
<a href="#l1.1843"></a><span id="l1.1843" class="difflineminus">-      },</span>
<a href="#l1.1844"></a><span id="l1.1844" class="difflineminus">-      &quot;vevent&quot;: {}</span>
<a href="#l1.1845"></a><span id="l1.1845" class="difflineminus">-    }</span>
<a href="#l1.1846"></a><span id="l1.1846" class="difflineminus">-</span>
<a href="#l1.1847"></a><span id="l1.1847" class="difflineplus">+</span>
<a href="#l1.1848"></a><span id="l1.1848" class="difflineplus">+      undecorate: function(aValue) {</span>
<a href="#l1.1849"></a><span id="l1.1849" class="difflineplus">+        return aValue.toString();</span>
<a href="#l1.1850"></a><span id="l1.1850" class="difflineplus">+      }</span>
<a href="#l1.1851"></a><span id="l1.1851" class="difflineplus">+    }</span>
<a href="#l1.1852"></a><span id="l1.1852" class="difflineplus">+  });</span>
<a href="#l1.1853"></a><span id="l1.1853" class="difflineplus">+</span>
<a href="#l1.1854"></a><span id="l1.1854" class="difflineplus">+  var vcard3Params = {</span>
<a href="#l1.1855"></a><span id="l1.1855" class="difflineplus">+    &quot;type&quot;: {</span>
<a href="#l1.1856"></a><span id="l1.1856" class="difflineplus">+      valueType: &quot;text&quot;,</span>
<a href="#l1.1857"></a><span id="l1.1857" class="difflineplus">+      multiValue: &quot;,&quot;</span>
<a href="#l1.1858"></a><span id="l1.1858" class="difflineplus">+    },</span>
<a href="#l1.1859"></a><span id="l1.1859" class="difflineplus">+    &quot;value&quot;: {</span>
<a href="#l1.1860"></a><span id="l1.1860" class="difflineplus">+      // since the value here is a 'type' lowercase is used.</span>
<a href="#l1.1861"></a><span id="l1.1861" class="difflineplus">+      values: [&quot;text&quot;, &quot;uri&quot;, &quot;date&quot;, &quot;date-time&quot;, &quot;phone-number&quot;, &quot;time&quot;,</span>
<a href="#l1.1862"></a><span id="l1.1862" class="difflineplus">+               &quot;boolean&quot;, &quot;integer&quot;, &quot;float&quot;, &quot;utc-offset&quot;, &quot;vcard&quot;, &quot;binary&quot;],</span>
<a href="#l1.1863"></a><span id="l1.1863" class="difflineplus">+      allowXName: true,</span>
<a href="#l1.1864"></a><span id="l1.1864" class="difflineplus">+      allowIanaToken: true</span>
<a href="#l1.1865"></a><span id="l1.1865" class="difflineplus">+    }</span>
<a href="#l1.1866"></a><span id="l1.1866" class="difflineplus">+  };</span>
<a href="#l1.1867"></a><span id="l1.1867" class="difflineplus">+</span>
<a href="#l1.1868"></a><span id="l1.1868" class="difflineplus">+  var vcard3Properties = ICAL.helpers.extend(commonProperties, {</span>
<a href="#l1.1869"></a><span id="l1.1869" class="difflineplus">+    fn: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1870"></a><span id="l1.1870" class="difflineplus">+    n: { defaultType: &quot;text&quot;, structuredValue: &quot;;&quot;, multiValue: &quot;,&quot; },</span>
<a href="#l1.1871"></a><span id="l1.1871" class="difflineplus">+    nickname: DEFAULT_TYPE_TEXT_MULTI,</span>
<a href="#l1.1872"></a><span id="l1.1872" class="difflineplus">+    photo: { defaultType: &quot;binary&quot;, allowedTypes: [&quot;binary&quot;, &quot;uri&quot;] },</span>
<a href="#l1.1873"></a><span id="l1.1873" class="difflineplus">+    bday: {</span>
<a href="#l1.1874"></a><span id="l1.1874" class="difflineplus">+      defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1875"></a><span id="l1.1875" class="difflineplus">+      allowedTypes: [&quot;date-time&quot;, &quot;date&quot;],</span>
<a href="#l1.1876"></a><span id="l1.1876" class="difflineplus">+      detectType: function(string) {</span>
<a href="#l1.1877"></a><span id="l1.1877" class="difflineplus">+        return (string.indexOf('T') === -1) ? 'date' : 'date-time';</span>
<a href="#l1.1878"></a><span id="l1.1878" class="difflineplus">+      }</span>
<a href="#l1.1879"></a><span id="l1.1879" class="difflineplus">+    },</span>
<a href="#l1.1880"></a><span id="l1.1880" class="difflineplus">+</span>
<a href="#l1.1881"></a><span id="l1.1881" class="difflineplus">+    adr: { defaultType: &quot;text&quot;, structuredValue: &quot;;&quot;, multiValue: &quot;,&quot; },</span>
<a href="#l1.1882"></a><span id="l1.1882" class="difflineplus">+    label: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1883"></a><span id="l1.1883" class="difflineplus">+</span>
<a href="#l1.1884"></a><span id="l1.1884" class="difflineplus">+    tel: { defaultType: &quot;phone-number&quot; },</span>
<a href="#l1.1885"></a><span id="l1.1885" class="difflineplus">+    email: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1886"></a><span id="l1.1886" class="difflineplus">+    mailer: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1887"></a><span id="l1.1887" class="difflineplus">+</span>
<a href="#l1.1888"></a><span id="l1.1888" class="difflineplus">+    tz: { defaultType: &quot;utc-offset&quot;, allowedTypes: [&quot;utc-offset&quot;, &quot;text&quot;] },</span>
<a href="#l1.1889"></a><span id="l1.1889" class="difflineplus">+    geo: { defaultType: &quot;float&quot;, structuredValue: &quot;;&quot; },</span>
<a href="#l1.1890"></a><span id="l1.1890" class="difflineplus">+</span>
<a href="#l1.1891"></a><span id="l1.1891" class="difflineplus">+    title: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1892"></a><span id="l1.1892" class="difflineplus">+    role: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1893"></a><span id="l1.1893" class="difflineplus">+    logo: { defaultType: &quot;binary&quot;, allowedTypes: [&quot;binary&quot;, &quot;uri&quot;] },</span>
<a href="#l1.1894"></a><span id="l1.1894" class="difflineplus">+    agent: { defaultType: &quot;vcard&quot;, allowedTypes: [&quot;vcard&quot;, &quot;text&quot;, &quot;uri&quot;] },</span>
<a href="#l1.1895"></a><span id="l1.1895" class="difflineplus">+    org: DEFAULT_TYPE_TEXT_STRUCTURED,</span>
<a href="#l1.1896"></a><span id="l1.1896" class="difflineplus">+</span>
<a href="#l1.1897"></a><span id="l1.1897" class="difflineplus">+    note: DEFAULT_TYPE_TEXT_MULTI,</span>
<a href="#l1.1898"></a><span id="l1.1898" class="difflineplus">+    prodid: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1899"></a><span id="l1.1899" class="difflineplus">+    rev: {</span>
<a href="#l1.1900"></a><span id="l1.1900" class="difflineplus">+      defaultType: &quot;date-time&quot;,</span>
<a href="#l1.1901"></a><span id="l1.1901" class="difflineplus">+      allowedTypes: [&quot;date-time&quot;, &quot;date&quot;],</span>
<a href="#l1.1902"></a><span id="l1.1902" class="difflineplus">+      detectType: function(string) {</span>
<a href="#l1.1903"></a><span id="l1.1903" class="difflineplus">+        return (string.indexOf('T') === -1) ? 'date' : 'date-time';</span>
<a href="#l1.1904"></a><span id="l1.1904" class="difflineplus">+      }</span>
<a href="#l1.1905"></a><span id="l1.1905" class="difflineplus">+    },</span>
<a href="#l1.1906"></a><span id="l1.1906" class="difflineplus">+    &quot;sort-string&quot;: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1907"></a><span id="l1.1907" class="difflineplus">+    sound: { defaultType: &quot;binary&quot;, allowedTypes: [&quot;binary&quot;, &quot;uri&quot;] },</span>
<a href="#l1.1908"></a><span id="l1.1908" class="difflineplus">+</span>
<a href="#l1.1909"></a><span id="l1.1909" class="difflineplus">+    class: DEFAULT_TYPE_TEXT,</span>
<a href="#l1.1910"></a><span id="l1.1910" class="difflineplus">+    key: { defaultType: &quot;binary&quot;, allowedTypes: [&quot;binary&quot;, &quot;text&quot;] }</span>
<a href="#l1.1911"></a><span id="l1.1911" class="difflineplus">+  });</span>
<a href="#l1.1912"></a><span id="l1.1912" class="difflineplus">+</span>
<a href="#l1.1913"></a><span id="l1.1913" class="difflineplus">+  /**</span>
<a href="#l1.1914"></a><span id="l1.1914" class="difflineplus">+   * iCalendar design set</span>
<a href="#l1.1915"></a><span id="l1.1915" class="difflineplus">+   * @type {ICAL.design.designSet}</span>
<a href="#l1.1916"></a><span id="l1.1916" class="difflineplus">+   */</span>
<a href="#l1.1917"></a><span id="l1.1917" class="difflineplus">+  var icalSet = {</span>
<a href="#l1.1918"></a><span id="l1.1918" class="difflineplus">+    value: icalValues,</span>
<a href="#l1.1919"></a><span id="l1.1919" class="difflineplus">+    param: icalParams,</span>
<a href="#l1.1920"></a><span id="l1.1920" class="difflineplus">+    property: icalProperties</span>
<a href="#l1.1921"></a><span id="l1.1921" class="difflineplus">+  };</span>
<a href="#l1.1922"></a><span id="l1.1922" class="difflineplus">+</span>
<a href="#l1.1923"></a><span id="l1.1923" class="difflineplus">+  /**</span>
<a href="#l1.1924"></a><span id="l1.1924" class="difflineplus">+   * vCard 4.0 design set</span>
<a href="#l1.1925"></a><span id="l1.1925" class="difflineplus">+   * @type {ICAL.design.designSet}</span>
<a href="#l1.1926"></a><span id="l1.1926" class="difflineplus">+   */</span>
<a href="#l1.1927"></a><span id="l1.1927" class="difflineplus">+  var vcardSet = {</span>
<a href="#l1.1928"></a><span id="l1.1928" class="difflineplus">+    value: vcardValues,</span>
<a href="#l1.1929"></a><span id="l1.1929" class="difflineplus">+    param: vcardParams,</span>
<a href="#l1.1930"></a><span id="l1.1930" class="difflineplus">+    property: vcardProperties</span>
<a href="#l1.1931"></a><span id="l1.1931" class="difflineplus">+  };</span>
<a href="#l1.1932"></a><span id="l1.1932" class="difflineplus">+</span>
<a href="#l1.1933"></a><span id="l1.1933" class="difflineplus">+  /**</span>
<a href="#l1.1934"></a><span id="l1.1934" class="difflineplus">+   * vCard 3.0 design set</span>
<a href="#l1.1935"></a><span id="l1.1935" class="difflineplus">+   * @type {ICAL.design.designSet}</span>
<a href="#l1.1936"></a><span id="l1.1936" class="difflineplus">+   */</span>
<a href="#l1.1937"></a><span id="l1.1937" class="difflineplus">+  var vcard3Set = {</span>
<a href="#l1.1938"></a><span id="l1.1938" class="difflineplus">+    value: vcard3Values,</span>
<a href="#l1.1939"></a><span id="l1.1939" class="difflineplus">+    param: vcard3Params,</span>
<a href="#l1.1940"></a><span id="l1.1940" class="difflineplus">+    property: vcard3Properties</span>
<a href="#l1.1941"></a><span id="l1.1941" class="difflineplus">+  };</span>
<a href="#l1.1942"></a><span id="l1.1942" class="difflineplus">+</span>
<a href="#l1.1943"></a><span id="l1.1943" class="difflineplus">+  /**</span>
<a href="#l1.1944"></a><span id="l1.1944" class="difflineplus">+   * The design data, used by the parser to determine types for properties and</span>
<a href="#l1.1945"></a><span id="l1.1945" class="difflineplus">+   * other metadata needed to produce correct jCard/jCal data.</span>
<a href="#l1.1946"></a><span id="l1.1946" class="difflineplus">+   *</span>
<a href="#l1.1947"></a><span id="l1.1947" class="difflineplus">+   * @alias ICAL.design</span>
<a href="#l1.1948"></a><span id="l1.1948" class="difflineplus">+   * @namespace</span>
<a href="#l1.1949"></a><span id="l1.1949" class="difflineplus">+   */</span>
<a href="#l1.1950"></a><span id="l1.1950" class="difflineplus">+  var design = {</span>
<a href="#l1.1951"></a><span id="l1.1951" class="difflineplus">+    /**</span>
<a href="#l1.1952"></a><span id="l1.1952" class="difflineplus">+     * A designSet describes value, parameter and property data. It is used by</span>
<a href="#l1.1953"></a><span id="l1.1953" class="difflineplus">+     * ther parser and stringifier in components and properties to determine they</span>
<a href="#l1.1954"></a><span id="l1.1954" class="difflineplus">+     * should be represented.</span>
<a href="#l1.1955"></a><span id="l1.1955" class="difflineplus">+     *</span>
<a href="#l1.1956"></a><span id="l1.1956" class="difflineplus">+     * @typedef {Object} designSet</span>
<a href="#l1.1957"></a><span id="l1.1957" class="difflineplus">+     * @memberOf ICAL.design</span>
<a href="#l1.1958"></a><span id="l1.1958" class="difflineplus">+     * @property {Object} value       Definitions for value types, keys are type names</span>
<a href="#l1.1959"></a><span id="l1.1959" class="difflineplus">+     * @property {Object} param       Definitions for params, keys are param names</span>
<a href="#l1.1960"></a><span id="l1.1960" class="difflineplus">+     * @property {Object} property    Defintions for properties, keys are property names</span>
<a href="#l1.1961"></a><span id="l1.1961" class="difflineplus">+     */</span>
<a href="#l1.1962"></a><span id="l1.1962" class="difflineplus">+</span>
<a href="#l1.1963"></a><span id="l1.1963" class="difflineplus">+</span>
<a href="#l1.1964"></a><span id="l1.1964" class="difflineplus">+    /**</span>
<a href="#l1.1965"></a><span id="l1.1965" class="difflineplus">+     * The default set for new properties and components if none is specified.</span>
<a href="#l1.1966"></a><span id="l1.1966" class="difflineplus">+     * @type {ICAL.design.designSet}</span>
<a href="#l1.1967"></a><span id="l1.1967" class="difflineplus">+     */</span>
<a href="#l1.1968"></a><span id="l1.1968" class="difflineplus">+    defaultSet: icalSet,</span>
<a href="#l1.1969"></a><span id="l1.1969" class="difflineplus">+</span>
<a href="#l1.1970"></a><span id="l1.1970" class="difflineplus">+    /**</span>
<a href="#l1.1971"></a><span id="l1.1971" class="difflineplus">+     * The default type for unknown properties</span>
<a href="#l1.1972"></a><span id="l1.1972" class="difflineplus">+     * @type {String}</span>
<a href="#l1.1973"></a><span id="l1.1973" class="difflineplus">+     */</span>
<a href="#l1.1974"></a><span id="l1.1974" class="difflineplus">+    defaultType: 'unknown',</span>
<a href="#l1.1975"></a><span id="l1.1975" class="difflineplus">+</span>
<a href="#l1.1976"></a><span id="l1.1976" class="difflineplus">+    /**</span>
<a href="#l1.1977"></a><span id="l1.1977" class="difflineplus">+     * Holds the design set for known top-level components</span>
<a href="#l1.1978"></a><span id="l1.1978" class="difflineplus">+     *</span>
<a href="#l1.1979"></a><span id="l1.1979" class="difflineplus">+     * @type {Object}</span>
<a href="#l1.1980"></a><span id="l1.1980" class="difflineplus">+     * @property {ICAL.design.designSet} vcard       vCard VCARD</span>
<a href="#l1.1981"></a><span id="l1.1981" class="difflineplus">+     * @property {ICAL.design.designSet} vevent      iCalendar VEVENT</span>
<a href="#l1.1982"></a><span id="l1.1982" class="difflineplus">+     * @property {ICAL.design.designSet} vtodo       iCalendar VTODO</span>
<a href="#l1.1983"></a><span id="l1.1983" class="difflineplus">+     * @property {ICAL.design.designSet} vjournal    iCalendar VJOURNAL</span>
<a href="#l1.1984"></a><span id="l1.1984" class="difflineplus">+     * @property {ICAL.design.designSet} valarm      iCalendar VALARM</span>
<a href="#l1.1985"></a><span id="l1.1985" class="difflineplus">+     * @property {ICAL.design.designSet} vtimezone   iCalendar VTIMEZONE</span>
<a href="#l1.1986"></a><span id="l1.1986" class="difflineplus">+     * @property {ICAL.design.designSet} daylight    iCalendar DAYLIGHT</span>
<a href="#l1.1987"></a><span id="l1.1987" class="difflineplus">+     * @property {ICAL.design.designSet} standard    iCalendar STANDARD</span>
<a href="#l1.1988"></a><span id="l1.1988" class="difflineplus">+     *</span>
<a href="#l1.1989"></a><span id="l1.1989" class="difflineplus">+     * @example</span>
<a href="#l1.1990"></a><span id="l1.1990" class="difflineplus">+     * var propertyName = 'fn';</span>
<a href="#l1.1991"></a><span id="l1.1991" class="difflineplus">+     * var componentDesign = ICAL.design.components.vcard;</span>
<a href="#l1.1992"></a><span id="l1.1992" class="difflineplus">+     * var propertyDetails = componentDesign.property[propertyName];</span>
<a href="#l1.1993"></a><span id="l1.1993" class="difflineplus">+     * if (propertyDetails.defaultType == 'text') {</span>
<a href="#l1.1994"></a><span id="l1.1994" class="difflineplus">+     *   // Yep, sure is...</span>
<a href="#l1.1995"></a><span id="l1.1995" class="difflineplus">+     * }</span>
<a href="#l1.1996"></a><span id="l1.1996" class="difflineplus">+     */</span>
<a href="#l1.1997"></a><span id="l1.1997" class="difflineplus">+    components: {</span>
<a href="#l1.1998"></a><span id="l1.1998" class="difflineplus">+      vcard: vcardSet,</span>
<a href="#l1.1999"></a><span id="l1.1999" class="difflineplus">+      vcard3: vcard3Set,</span>
<a href="#l1.2000"></a><span id="l1.2000" class="difflineplus">+      vevent: icalSet,</span>
<a href="#l1.2001"></a><span id="l1.2001" class="difflineplus">+      vtodo: icalSet,</span>
<a href="#l1.2002"></a><span id="l1.2002" class="difflineplus">+      vjournal: icalSet,</span>
<a href="#l1.2003"></a><span id="l1.2003" class="difflineplus">+      valarm: icalSet,</span>
<a href="#l1.2004"></a><span id="l1.2004" class="difflineplus">+      vtimezone: icalSet,</span>
<a href="#l1.2005"></a><span id="l1.2005" class="difflineplus">+      daylight: icalSet,</span>
<a href="#l1.2006"></a><span id="l1.2006" class="difflineplus">+      standard: icalSet</span>
<a href="#l1.2007"></a><span id="l1.2007" class="difflineplus">+    },</span>
<a href="#l1.2008"></a><span id="l1.2008" class="difflineplus">+</span>
<a href="#l1.2009"></a><span id="l1.2009" class="difflineplus">+</span>
<a href="#l1.2010"></a><span id="l1.2010" class="difflineplus">+    /**</span>
<a href="#l1.2011"></a><span id="l1.2011" class="difflineplus">+     * The design set for iCalendar (rfc5545/rfc7265) components.</span>
<a href="#l1.2012"></a><span id="l1.2012" class="difflineplus">+     * @type {ICAL.design.designSet}</span>
<a href="#l1.2013"></a><span id="l1.2013" class="difflineplus">+     */</span>
<a href="#l1.2014"></a><span id="l1.2014" class="difflineplus">+    icalendar: icalSet,</span>
<a href="#l1.2015"></a><span id="l1.2015" class="difflineplus">+</span>
<a href="#l1.2016"></a><span id="l1.2016" class="difflineplus">+    /**</span>
<a href="#l1.2017"></a><span id="l1.2017" class="difflineplus">+     * The design set for vCard (rfc6350/rfc7095) components.</span>
<a href="#l1.2018"></a><span id="l1.2018" class="difflineplus">+     * @type {ICAL.design.designSet}</span>
<a href="#l1.2019"></a><span id="l1.2019" class="difflineplus">+     */</span>
<a href="#l1.2020"></a><span id="l1.2020" class="difflineplus">+    vcard: vcardSet,</span>
<a href="#l1.2021"></a><span id="l1.2021" class="difflineplus">+</span>
<a href="#l1.2022"></a><span id="l1.2022" class="difflineplus">+    /**</span>
<a href="#l1.2023"></a><span id="l1.2023" class="difflineplus">+     * The design set for vCard (rfc2425/rfc2426/rfc7095) components.</span>
<a href="#l1.2024"></a><span id="l1.2024" class="difflineplus">+     * @type {ICAL.design.designSet}</span>
<a href="#l1.2025"></a><span id="l1.2025" class="difflineplus">+     */</span>
<a href="#l1.2026"></a><span id="l1.2026" class="difflineplus">+    vcard3: vcard3Set,</span>
<a href="#l1.2027"></a><span id="l1.2027" class="difflineplus">+</span>
<a href="#l1.2028"></a><span id="l1.2028" class="difflineplus">+    /**</span>
<a href="#l1.2029"></a><span id="l1.2029" class="difflineplus">+     * Gets the design set for the given component name.</span>
<a href="#l1.2030"></a><span id="l1.2030" class="difflineplus">+     *</span>
<a href="#l1.2031"></a><span id="l1.2031" class="difflineplus">+     * @param {String} componentName        The name of the component</span>
<a href="#l1.2032"></a><span id="l1.2032" class="difflineplus">+     * @return {ICAL.design.designSet}      The design set for the component</span>
<a href="#l1.2033"></a><span id="l1.2033" class="difflineplus">+     */</span>
<a href="#l1.2034"></a><span id="l1.2034" class="difflineplus">+    getDesignSet: function(componentName) {</span>
<a href="#l1.2035"></a><span id="l1.2035" class="difflineplus">+      var isInDesign = componentName &amp;&amp; componentName in design.components;</span>
<a href="#l1.2036"></a><span id="l1.2036" class="difflineplus">+      return isInDesign ? design.components[componentName] : design.defaultSet;</span>
<a href="#l1.2037"></a><span id="l1.2037" class="difflineplus">+    }</span>
<a href="#l1.2038"></a><span id="l1.2038">   };</span>
<a href="#l1.2039"></a><span id="l1.2039"> </span>
<a href="#l1.2040"></a><span id="l1.2040">   return design;</span>
<a href="#l1.2041"></a><span id="l1.2041"> }());</span>
<a href="#l1.2042"></a><span id="l1.2042" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.2043"></a><span id="l1.2043" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.2044"></a><span id="l1.2044" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.2045"></a><span id="l1.2045" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.2046"></a><span id="l1.2046" class="difflineplus">+</span>
<a href="#l1.2047"></a><span id="l1.2047" class="difflineplus">+</span>
<a href="#l1.2048"></a><span id="l1.2048" class="difflineplus">+/**</span>
<a href="#l1.2049"></a><span id="l1.2049" class="difflineplus">+ * Contains various functions to convert jCal and jCard data back into</span>
<a href="#l1.2050"></a><span id="l1.2050" class="difflineplus">+ * iCalendar and vCard.</span>
<a href="#l1.2051"></a><span id="l1.2051" class="difflineplus">+ * @namespace</span>
<a href="#l1.2052"></a><span id="l1.2052" class="difflineplus">+ */</span>
<a href="#l1.2053"></a><span id="l1.2053"> ICAL.stringify = (function() {</span>
<a href="#l1.2054"></a><span id="l1.2054">   'use strict';</span>
<a href="#l1.2055"></a><span id="l1.2055"> </span>
<a href="#l1.2056"></a><span id="l1.2056">   var LINE_ENDING = '\r\n';</span>
<a href="#l1.2057"></a><span id="l1.2057" class="difflineminus">-  var DEFAULT_TYPE = 'text';</span>
<a href="#l1.2058"></a><span id="l1.2058" class="difflineplus">+  var DEFAULT_VALUE_TYPE = 'unknown';</span>
<a href="#l1.2059"></a><span id="l1.2059"> </span>
<a href="#l1.2060"></a><span id="l1.2060">   var design = ICAL.design;</span>
<a href="#l1.2061"></a><span id="l1.2061">   var helpers = ICAL.helpers;</span>
<a href="#l1.2062"></a><span id="l1.2062"> </span>
<a href="#l1.2063"></a><span id="l1.2063">   /**</span>
<a href="#l1.2064"></a><span id="l1.2064" class="difflineminus">-   * Convert a full jCal Array into a ical document.</span>
<a href="#l1.2065"></a><span id="l1.2065" class="difflineminus">-   *</span>
<a href="#l1.2066"></a><span id="l1.2066" class="difflineminus">-   * @param {Array} jCal document.</span>
<a href="#l1.2067"></a><span id="l1.2067" class="difflineminus">-   * @return {String} ical document.</span>
<a href="#l1.2068"></a><span id="l1.2068" class="difflineplus">+   * Convert a full jCal/jCard array into a iCalendar/vCard string.</span>
<a href="#l1.2069"></a><span id="l1.2069" class="difflineplus">+   *</span>
<a href="#l1.2070"></a><span id="l1.2070" class="difflineplus">+   * @function ICAL.stringify</span>
<a href="#l1.2071"></a><span id="l1.2071" class="difflineplus">+   * @variation function</span>
<a href="#l1.2072"></a><span id="l1.2072" class="difflineplus">+   * @param {Array} jCal    The jCal/jCard document</span>
<a href="#l1.2073"></a><span id="l1.2073" class="difflineplus">+   * @return {String}       The stringified iCalendar/vCard document</span>
<a href="#l1.2074"></a><span id="l1.2074">    */</span>
<a href="#l1.2075"></a><span id="l1.2075">   function stringify(jCal) {</span>
<a href="#l1.2076"></a><span id="l1.2076" class="difflineminus">-    if (!jCal[0] || jCal[0] !== 'icalendar') {</span>
<a href="#l1.2077"></a><span id="l1.2077" class="difflineminus">-      throw new Error('must provide full jCal document');</span>
<a href="#l1.2078"></a><span id="l1.2078" class="difflineminus">-    }</span>
<a href="#l1.2079"></a><span id="l1.2079" class="difflineminus">-</span>
<a href="#l1.2080"></a><span id="l1.2080" class="difflineminus">-    // 1 because we skip the initial element.</span>
<a href="#l1.2081"></a><span id="l1.2081" class="difflineminus">-    var i = 1;</span>
<a href="#l1.2082"></a><span id="l1.2082" class="difflineplus">+    if (typeof jCal[0] == &quot;string&quot;) {</span>
<a href="#l1.2083"></a><span id="l1.2083" class="difflineplus">+      // This is a single component</span>
<a href="#l1.2084"></a><span id="l1.2084" class="difflineplus">+      jCal = [jCal];</span>
<a href="#l1.2085"></a><span id="l1.2085" class="difflineplus">+    }</span>
<a href="#l1.2086"></a><span id="l1.2086" class="difflineplus">+</span>
<a href="#l1.2087"></a><span id="l1.2087" class="difflineplus">+    var i = 0;</span>
<a href="#l1.2088"></a><span id="l1.2088">     var len = jCal.length;</span>
<a href="#l1.2089"></a><span id="l1.2089">     var result = '';</span>
<a href="#l1.2090"></a><span id="l1.2090"> </span>
<a href="#l1.2091"></a><span id="l1.2091">     for (; i &lt; len; i++) {</span>
<a href="#l1.2092"></a><span id="l1.2092">       result += stringify.component(jCal[i]) + LINE_ENDING;</span>
<a href="#l1.2093"></a><span id="l1.2093">     }</span>
<a href="#l1.2094"></a><span id="l1.2094"> </span>
<a href="#l1.2095"></a><span id="l1.2095">     return result;</span>
<a href="#l1.2096"></a><span id="l1.2096" class="difflineat">@@ -989,224 +1392,324 @@ ICAL.stringify = (function() {</span>
<a href="#l1.2097"></a><span id="l1.2097"> </span>
<a href="#l1.2098"></a><span id="l1.2098">   /**</span>
<a href="#l1.2099"></a><span id="l1.2099">    * Converts an jCal component array into a ICAL string.</span>
<a href="#l1.2100"></a><span id="l1.2100">    * Recursive will resolve sub-components.</span>
<a href="#l1.2101"></a><span id="l1.2101">    *</span>
<a href="#l1.2102"></a><span id="l1.2102">    * Exact component/property order is not saved all</span>
<a href="#l1.2103"></a><span id="l1.2103">    * properties will come before subcomponents.</span>
<a href="#l1.2104"></a><span id="l1.2104">    *</span>
<a href="#l1.2105"></a><span id="l1.2105" class="difflineminus">-   * @param {Array} component jCal fragment of a component.</span>
<a href="#l1.2106"></a><span id="l1.2106" class="difflineplus">+   * @function ICAL.stringify.component</span>
<a href="#l1.2107"></a><span id="l1.2107" class="difflineplus">+   * @param {Array} component</span>
<a href="#l1.2108"></a><span id="l1.2108" class="difflineplus">+   *        jCal/jCard fragment of a component</span>
<a href="#l1.2109"></a><span id="l1.2109" class="difflineplus">+   * @param {ICAL.design.designSet} designSet</span>
<a href="#l1.2110"></a><span id="l1.2110" class="difflineplus">+   *        The design data to use for this component</span>
<a href="#l1.2111"></a><span id="l1.2111" class="difflineplus">+   * @return {String}       The iCalendar/vCard string</span>
<a href="#l1.2112"></a><span id="l1.2112">    */</span>
<a href="#l1.2113"></a><span id="l1.2113" class="difflineminus">-  stringify.component = function(component) {</span>
<a href="#l1.2114"></a><span id="l1.2114" class="difflineplus">+  stringify.component = function(component, designSet) {</span>
<a href="#l1.2115"></a><span id="l1.2115">     var name = component[0].toUpperCase();</span>
<a href="#l1.2116"></a><span id="l1.2116">     var result = 'BEGIN:' + name + LINE_ENDING;</span>
<a href="#l1.2117"></a><span id="l1.2117"> </span>
<a href="#l1.2118"></a><span id="l1.2118">     var props = component[1];</span>
<a href="#l1.2119"></a><span id="l1.2119">     var propIdx = 0;</span>
<a href="#l1.2120"></a><span id="l1.2120">     var propLen = props.length;</span>
<a href="#l1.2121"></a><span id="l1.2121"> </span>
<a href="#l1.2122"></a><span id="l1.2122" class="difflineplus">+    var designSetName = component[0];</span>
<a href="#l1.2123"></a><span id="l1.2123" class="difflineplus">+    // rfc6350 requires that in vCard 4.0 the first component is the VERSION</span>
<a href="#l1.2124"></a><span id="l1.2124" class="difflineplus">+    // component with as value 4.0, note that 3.0 does not have this requirement.</span>
<a href="#l1.2125"></a><span id="l1.2125" class="difflineplus">+    if (designSetName === 'vcard' &amp;&amp; component[1].length &gt; 0 &amp;&amp;</span>
<a href="#l1.2126"></a><span id="l1.2126" class="difflineplus">+            !(component[1][0][0] === &quot;version&quot; &amp;&amp; component[1][0][3] === &quot;4.0&quot;)) {</span>
<a href="#l1.2127"></a><span id="l1.2127" class="difflineplus">+      designSetName = &quot;vcard3&quot;;</span>
<a href="#l1.2128"></a><span id="l1.2128" class="difflineplus">+    }</span>
<a href="#l1.2129"></a><span id="l1.2129" class="difflineplus">+    designSet = designSet || design.getDesignSet(designSetName);</span>
<a href="#l1.2130"></a><span id="l1.2130" class="difflineplus">+</span>
<a href="#l1.2131"></a><span id="l1.2131">     for (; propIdx &lt; propLen; propIdx++) {</span>
<a href="#l1.2132"></a><span id="l1.2132" class="difflineminus">-      result += stringify.property(props[propIdx]) + LINE_ENDING;</span>
<a href="#l1.2133"></a><span id="l1.2133" class="difflineplus">+      result += stringify.property(props[propIdx], designSet) + LINE_ENDING;</span>
<a href="#l1.2134"></a><span id="l1.2134">     }</span>
<a href="#l1.2135"></a><span id="l1.2135"> </span>
<a href="#l1.2136"></a><span id="l1.2136">     var comps = component[2];</span>
<a href="#l1.2137"></a><span id="l1.2137">     var compIdx = 0;</span>
<a href="#l1.2138"></a><span id="l1.2138">     var compLen = comps.length;</span>
<a href="#l1.2139"></a><span id="l1.2139"> </span>
<a href="#l1.2140"></a><span id="l1.2140">     for (; compIdx &lt; compLen; compIdx++) {</span>
<a href="#l1.2141"></a><span id="l1.2141" class="difflineminus">-      result += stringify.component(comps[compIdx]) + LINE_ENDING;</span>
<a href="#l1.2142"></a><span id="l1.2142" class="difflineplus">+      result += stringify.component(comps[compIdx], designSet) + LINE_ENDING;</span>
<a href="#l1.2143"></a><span id="l1.2143">     }</span>
<a href="#l1.2144"></a><span id="l1.2144"> </span>
<a href="#l1.2145"></a><span id="l1.2145">     result += 'END:' + name;</span>
<a href="#l1.2146"></a><span id="l1.2146">     return result;</span>
<a href="#l1.2147"></a><span id="l1.2147" class="difflineminus">-  }</span>
<a href="#l1.2148"></a><span id="l1.2148" class="difflineplus">+  };</span>
<a href="#l1.2149"></a><span id="l1.2149"> </span>
<a href="#l1.2150"></a><span id="l1.2150">   /**</span>
<a href="#l1.2151"></a><span id="l1.2151" class="difflineminus">-   * Converts a single property to a ICAL string.</span>
<a href="#l1.2152"></a><span id="l1.2152" class="difflineminus">-   *</span>
<a href="#l1.2153"></a><span id="l1.2153" class="difflineminus">-   * @param {Array} property jCal property.</span>
<a href="#l1.2154"></a><span id="l1.2154" class="difflineplus">+   * Converts a single jCal/jCard property to a iCalendar/vCard string.</span>
<a href="#l1.2155"></a><span id="l1.2155" class="difflineplus">+   *</span>
<a href="#l1.2156"></a><span id="l1.2156" class="difflineplus">+   * @function ICAL.stringify.property</span>
<a href="#l1.2157"></a><span id="l1.2157" class="difflineplus">+   * @param {Array} property</span>
<a href="#l1.2158"></a><span id="l1.2158" class="difflineplus">+   *        jCal/jCard property array</span>
<a href="#l1.2159"></a><span id="l1.2159" class="difflineplus">+   * @param {ICAL.design.designSet} designSet</span>
<a href="#l1.2160"></a><span id="l1.2160" class="difflineplus">+   *        The design data to use for this property</span>
<a href="#l1.2161"></a><span id="l1.2161" class="difflineplus">+   * @param {Boolean} noFold</span>
<a href="#l1.2162"></a><span id="l1.2162" class="difflineplus">+   *        If true, the line is not folded</span>
<a href="#l1.2163"></a><span id="l1.2163" class="difflineplus">+   * @return {String}       The iCalendar/vCard string</span>
<a href="#l1.2164"></a><span id="l1.2164">    */</span>
<a href="#l1.2165"></a><span id="l1.2165" class="difflineminus">-  stringify.property = function(property) {</span>
<a href="#l1.2166"></a><span id="l1.2166" class="difflineplus">+  stringify.property = function(property, designSet, noFold) {</span>
<a href="#l1.2167"></a><span id="l1.2167">     var name = property[0].toUpperCase();</span>
<a href="#l1.2168"></a><span id="l1.2168">     var jsName = property[0];</span>
<a href="#l1.2169"></a><span id="l1.2169">     var params = property[1];</span>
<a href="#l1.2170"></a><span id="l1.2170"> </span>
<a href="#l1.2171"></a><span id="l1.2171">     var line = name;</span>
<a href="#l1.2172"></a><span id="l1.2172"> </span>
<a href="#l1.2173"></a><span id="l1.2173">     var paramName;</span>
<a href="#l1.2174"></a><span id="l1.2174">     for (paramName in params) {</span>
<a href="#l1.2175"></a><span id="l1.2175" class="difflineplus">+      var value = params[paramName];</span>
<a href="#l1.2176"></a><span id="l1.2176" class="difflineplus">+</span>
<a href="#l1.2177"></a><span id="l1.2177" class="difflineplus">+      /* istanbul ignore else */</span>
<a href="#l1.2178"></a><span id="l1.2178">       if (params.hasOwnProperty(paramName)) {</span>
<a href="#l1.2179"></a><span id="l1.2179" class="difflineplus">+        var multiValue = (paramName in designSet.param) &amp;&amp; designSet.param[paramName].multiValue;</span>
<a href="#l1.2180"></a><span id="l1.2180" class="difflineplus">+        if (multiValue &amp;&amp; Array.isArray(value)) {</span>
<a href="#l1.2181"></a><span id="l1.2181" class="difflineplus">+          if (designSet.param[paramName].multiValueSeparateDQuote) {</span>
<a href="#l1.2182"></a><span id="l1.2182" class="difflineplus">+            multiValue = '&quot;' + multiValue + '&quot;';</span>
<a href="#l1.2183"></a><span id="l1.2183" class="difflineplus">+          }</span>
<a href="#l1.2184"></a><span id="l1.2184" class="difflineplus">+          value = value.map(stringify._rfc6868Unescape);</span>
<a href="#l1.2185"></a><span id="l1.2185" class="difflineplus">+          value = stringify.multiValue(value, multiValue, &quot;unknown&quot;, null, designSet);</span>
<a href="#l1.2186"></a><span id="l1.2186" class="difflineplus">+        } else {</span>
<a href="#l1.2187"></a><span id="l1.2187" class="difflineplus">+          value = stringify._rfc6868Unescape(value);</span>
<a href="#l1.2188"></a><span id="l1.2188" class="difflineplus">+        }</span>
<a href="#l1.2189"></a><span id="l1.2189" class="difflineplus">+</span>
<a href="#l1.2190"></a><span id="l1.2190" class="difflineplus">+</span>
<a href="#l1.2191"></a><span id="l1.2191">         line += ';' + paramName.toUpperCase();</span>
<a href="#l1.2192"></a><span id="l1.2192" class="difflineminus">-        line += '=' + stringify.propertyValue(params[paramName]);</span>
<a href="#l1.2193"></a><span id="l1.2193" class="difflineminus">-      }</span>
<a href="#l1.2194"></a><span id="l1.2194" class="difflineminus">-    }</span>
<a href="#l1.2195"></a><span id="l1.2195" class="difflineminus">-</span>
<a href="#l1.2196"></a><span id="l1.2196" class="difflineminus">-    // there is no value so return.</span>
<a href="#l1.2197"></a><span id="l1.2197" class="difflineplus">+        line += '=' + stringify.propertyValue(value);</span>
<a href="#l1.2198"></a><span id="l1.2198" class="difflineplus">+      }</span>
<a href="#l1.2199"></a><span id="l1.2199" class="difflineplus">+    }</span>
<a href="#l1.2200"></a><span id="l1.2200" class="difflineplus">+</span>
<a href="#l1.2201"></a><span id="l1.2201">     if (property.length === 3) {</span>
<a href="#l1.2202"></a><span id="l1.2202" class="difflineminus">-      // if no params where inserted and no value</span>
<a href="#l1.2203"></a><span id="l1.2203" class="difflineminus">-      // we given we must add a blank value.</span>
<a href="#l1.2204"></a><span id="l1.2204" class="difflineminus">-      if (!paramName) {</span>
<a href="#l1.2205"></a><span id="l1.2205" class="difflineminus">-        line += ':';</span>
<a href="#l1.2206"></a><span id="l1.2206" class="difflineminus">-      }</span>
<a href="#l1.2207"></a><span id="l1.2207" class="difflineminus">-      return line;</span>
<a href="#l1.2208"></a><span id="l1.2208" class="difflineplus">+      // If there are no values, we must assume a blank value</span>
<a href="#l1.2209"></a><span id="l1.2209" class="difflineplus">+      return line + ':';</span>
<a href="#l1.2210"></a><span id="l1.2210">     }</span>
<a href="#l1.2211"></a><span id="l1.2211"> </span>
<a href="#l1.2212"></a><span id="l1.2212">     var valueType = property[2];</span>
<a href="#l1.2213"></a><span id="l1.2213"> </span>
<a href="#l1.2214"></a><span id="l1.2214" class="difflineplus">+    if (!designSet) {</span>
<a href="#l1.2215"></a><span id="l1.2215" class="difflineplus">+      designSet = design.defaultSet;</span>
<a href="#l1.2216"></a><span id="l1.2216" class="difflineplus">+    }</span>
<a href="#l1.2217"></a><span id="l1.2217" class="difflineplus">+</span>
<a href="#l1.2218"></a><span id="l1.2218">     var propDetails;</span>
<a href="#l1.2219"></a><span id="l1.2219">     var multiValue = false;</span>
<a href="#l1.2220"></a><span id="l1.2220" class="difflineplus">+    var structuredValue = false;</span>
<a href="#l1.2221"></a><span id="l1.2221">     var isDefault = false;</span>
<a href="#l1.2222"></a><span id="l1.2222"> </span>
<a href="#l1.2223"></a><span id="l1.2223" class="difflineminus">-    if (jsName in design.property) {</span>
<a href="#l1.2224"></a><span id="l1.2224" class="difflineminus">-      propDetails = design.property[jsName];</span>
<a href="#l1.2225"></a><span id="l1.2225" class="difflineplus">+    if (jsName in designSet.property) {</span>
<a href="#l1.2226"></a><span id="l1.2226" class="difflineplus">+      propDetails = designSet.property[jsName];</span>
<a href="#l1.2227"></a><span id="l1.2227"> </span>
<a href="#l1.2228"></a><span id="l1.2228">       if ('multiValue' in propDetails) {</span>
<a href="#l1.2229"></a><span id="l1.2229">         multiValue = propDetails.multiValue;</span>
<a href="#l1.2230"></a><span id="l1.2230">       }</span>
<a href="#l1.2231"></a><span id="l1.2231"> </span>
<a href="#l1.2232"></a><span id="l1.2232" class="difflineplus">+      if (('structuredValue' in propDetails) &amp;&amp; Array.isArray(property[3])) {</span>
<a href="#l1.2233"></a><span id="l1.2233" class="difflineplus">+        structuredValue = propDetails.structuredValue;</span>
<a href="#l1.2234"></a><span id="l1.2234" class="difflineplus">+      }</span>
<a href="#l1.2235"></a><span id="l1.2235" class="difflineplus">+</span>
<a href="#l1.2236"></a><span id="l1.2236">       if ('defaultType' in propDetails) {</span>
<a href="#l1.2237"></a><span id="l1.2237">         if (valueType === propDetails.defaultType) {</span>
<a href="#l1.2238"></a><span id="l1.2238">           isDefault = true;</span>
<a href="#l1.2239"></a><span id="l1.2239">         }</span>
<a href="#l1.2240"></a><span id="l1.2240">       } else {</span>
<a href="#l1.2241"></a><span id="l1.2241" class="difflineminus">-        if (valueType === DEFAULT_TYPE) {</span>
<a href="#l1.2242"></a><span id="l1.2242" class="difflineplus">+        if (valueType === DEFAULT_VALUE_TYPE) {</span>
<a href="#l1.2243"></a><span id="l1.2243">           isDefault = true;</span>
<a href="#l1.2244"></a><span id="l1.2244">         }</span>
<a href="#l1.2245"></a><span id="l1.2245">       }</span>
<a href="#l1.2246"></a><span id="l1.2246">     } else {</span>
<a href="#l1.2247"></a><span id="l1.2247" class="difflineminus">-      if (valueType === DEFAULT_TYPE) {</span>
<a href="#l1.2248"></a><span id="l1.2248" class="difflineplus">+      if (valueType === DEFAULT_VALUE_TYPE) {</span>
<a href="#l1.2249"></a><span id="l1.2249">         isDefault = true;</span>
<a href="#l1.2250"></a><span id="l1.2250">       }</span>
<a href="#l1.2251"></a><span id="l1.2251">     }</span>
<a href="#l1.2252"></a><span id="l1.2252"> </span>
<a href="#l1.2253"></a><span id="l1.2253">     // push the VALUE property if type is not the default</span>
<a href="#l1.2254"></a><span id="l1.2254">     // for the current property.</span>
<a href="#l1.2255"></a><span id="l1.2255">     if (!isDefault) {</span>
<a href="#l1.2256"></a><span id="l1.2256">       // value will never contain ;/:/, so we don't escape it here.</span>
<a href="#l1.2257"></a><span id="l1.2257">       line += ';VALUE=' + valueType.toUpperCase();</span>
<a href="#l1.2258"></a><span id="l1.2258">     }</span>
<a href="#l1.2259"></a><span id="l1.2259"> </span>
<a href="#l1.2260"></a><span id="l1.2260">     line += ':';</span>
<a href="#l1.2261"></a><span id="l1.2261"> </span>
<a href="#l1.2262"></a><span id="l1.2262" class="difflineminus">-    if (multiValue) {</span>
<a href="#l1.2263"></a><span id="l1.2263" class="difflineplus">+    if (multiValue &amp;&amp; structuredValue) {</span>
<a href="#l1.2264"></a><span id="l1.2264" class="difflineplus">+      line += stringify.multiValue(</span>
<a href="#l1.2265"></a><span id="l1.2265" class="difflineplus">+        property[3], structuredValue, valueType, multiValue, designSet, structuredValue</span>
<a href="#l1.2266"></a><span id="l1.2266" class="difflineplus">+      );</span>
<a href="#l1.2267"></a><span id="l1.2267" class="difflineplus">+    } else if (multiValue) {</span>
<a href="#l1.2268"></a><span id="l1.2268">       line += stringify.multiValue(</span>
<a href="#l1.2269"></a><span id="l1.2269" class="difflineminus">-        property.slice(3), multiValue, valueType</span>
<a href="#l1.2270"></a><span id="l1.2270" class="difflineplus">+        property.slice(3), multiValue, valueType, null, designSet, false</span>
<a href="#l1.2271"></a><span id="l1.2271" class="difflineplus">+      );</span>
<a href="#l1.2272"></a><span id="l1.2272" class="difflineplus">+    } else if (structuredValue) {</span>
<a href="#l1.2273"></a><span id="l1.2273" class="difflineplus">+      line += stringify.multiValue(</span>
<a href="#l1.2274"></a><span id="l1.2274" class="difflineplus">+        property[3], structuredValue, valueType, null, designSet, structuredValue</span>
<a href="#l1.2275"></a><span id="l1.2275">       );</span>
<a href="#l1.2276"></a><span id="l1.2276">     } else {</span>
<a href="#l1.2277"></a><span id="l1.2277" class="difflineminus">-      line += stringify.value(property[3], valueType);</span>
<a href="#l1.2278"></a><span id="l1.2278" class="difflineminus">-    }</span>
<a href="#l1.2279"></a><span id="l1.2279" class="difflineminus">-</span>
<a href="#l1.2280"></a><span id="l1.2280" class="difflineminus">-    return ICAL.helpers.foldline(line);</span>
<a href="#l1.2281"></a><span id="l1.2281" class="difflineminus">-  }</span>
<a href="#l1.2282"></a><span id="l1.2282" class="difflineplus">+      line += stringify.value(property[3], valueType, designSet, false);</span>
<a href="#l1.2283"></a><span id="l1.2283" class="difflineplus">+    }</span>
<a href="#l1.2284"></a><span id="l1.2284" class="difflineplus">+</span>
<a href="#l1.2285"></a><span id="l1.2285" class="difflineplus">+    return noFold ? line : ICAL.helpers.foldline(line);</span>
<a href="#l1.2286"></a><span id="l1.2286" class="difflineplus">+  };</span>
<a href="#l1.2287"></a><span id="l1.2287"> </span>
<a href="#l1.2288"></a><span id="l1.2288">   /**</span>
<a href="#l1.2289"></a><span id="l1.2289">    * Handles escaping of property values that may contain:</span>
<a href="#l1.2290"></a><span id="l1.2290">    *</span>
<a href="#l1.2291"></a><span id="l1.2291">    *    COLON (:), SEMICOLON (;), or COMMA (,)</span>
<a href="#l1.2292"></a><span id="l1.2292">    *</span>
<a href="#l1.2293"></a><span id="l1.2293">    * If any of the above are present the result is wrapped</span>
<a href="#l1.2294"></a><span id="l1.2294">    * in double quotes.</span>
<a href="#l1.2295"></a><span id="l1.2295">    *</span>
<a href="#l1.2296"></a><span id="l1.2296" class="difflineminus">-   * @param {String} value raw value.</span>
<a href="#l1.2297"></a><span id="l1.2297" class="difflineminus">-   * @return {String} given or escaped value when needed.</span>
<a href="#l1.2298"></a><span id="l1.2298" class="difflineplus">+   * @function ICAL.stringify.propertyValue</span>
<a href="#l1.2299"></a><span id="l1.2299" class="difflineplus">+   * @param {String} value      Raw property value</span>
<a href="#l1.2300"></a><span id="l1.2300" class="difflineplus">+   * @return {String}           Given or escaped value when needed</span>
<a href="#l1.2301"></a><span id="l1.2301">    */</span>
<a href="#l1.2302"></a><span id="l1.2302">   stringify.propertyValue = function(value) {</span>
<a href="#l1.2303"></a><span id="l1.2303"> </span>
<a href="#l1.2304"></a><span id="l1.2304">     if ((helpers.unescapedIndexOf(value, ',') === -1) &amp;&amp;</span>
<a href="#l1.2305"></a><span id="l1.2305">         (helpers.unescapedIndexOf(value, ':') === -1) &amp;&amp;</span>
<a href="#l1.2306"></a><span id="l1.2306">         (helpers.unescapedIndexOf(value, ';') === -1)) {</span>
<a href="#l1.2307"></a><span id="l1.2307"> </span>
<a href="#l1.2308"></a><span id="l1.2308">       return value;</span>
<a href="#l1.2309"></a><span id="l1.2309">     }</span>
<a href="#l1.2310"></a><span id="l1.2310"> </span>
<a href="#l1.2311"></a><span id="l1.2311">     return '&quot;' + value + '&quot;';</span>
<a href="#l1.2312"></a><span id="l1.2312" class="difflineminus">-  }</span>
<a href="#l1.2313"></a><span id="l1.2313" class="difflineplus">+  };</span>
<a href="#l1.2314"></a><span id="l1.2314"> </span>
<a href="#l1.2315"></a><span id="l1.2315">   /**</span>
<a href="#l1.2316"></a><span id="l1.2316">    * Converts an array of ical values into a single</span>
<a href="#l1.2317"></a><span id="l1.2317">    * string based on a type and a delimiter value (like &quot;,&quot;).</span>
<a href="#l1.2318"></a><span id="l1.2318">    *</span>
<a href="#l1.2319"></a><span id="l1.2319" class="difflineminus">-   * @param {Array} values list of values to convert.</span>
<a href="#l1.2320"></a><span id="l1.2320" class="difflineminus">-   * @param {String} delim used to join the values usually (&quot;,&quot;, &quot;;&quot;, &quot;:&quot;).</span>
<a href="#l1.2321"></a><span id="l1.2321" class="difflineminus">-   * @param {String} type lowecase ical value type</span>
<a href="#l1.2322"></a><span id="l1.2322" class="difflineminus">-   *  (like boolean, date-time, etc..).</span>
<a href="#l1.2323"></a><span id="l1.2323" class="difflineminus">-   *</span>
<a href="#l1.2324"></a><span id="l1.2324" class="difflineminus">-   * @return {String} ical string for value.</span>
<a href="#l1.2325"></a><span id="l1.2325" class="difflineplus">+   * @function ICAL.stringify.multiValue</span>
<a href="#l1.2326"></a><span id="l1.2326" class="difflineplus">+   * @param {Array} values      List of values to convert</span>
<a href="#l1.2327"></a><span id="l1.2327" class="difflineplus">+   * @param {String} delim      Used to join the values (&quot;,&quot;, &quot;;&quot;, &quot;:&quot;)</span>
<a href="#l1.2328"></a><span id="l1.2328" class="difflineplus">+   * @param {String} type       Lowecase ical value type</span>
<a href="#l1.2329"></a><span id="l1.2329" class="difflineplus">+   *        (like boolean, date-time, etc..)</span>
<a href="#l1.2330"></a><span id="l1.2330" class="difflineplus">+   * @param {?String} innerMulti If set, each value will again be processed</span>
<a href="#l1.2331"></a><span id="l1.2331" class="difflineplus">+   *        Used for structured values</span>
<a href="#l1.2332"></a><span id="l1.2332" class="difflineplus">+   * @param {ICAL.design.designSet} designSet</span>
<a href="#l1.2333"></a><span id="l1.2333" class="difflineplus">+   *        The design data to use for this property</span>
<a href="#l1.2334"></a><span id="l1.2334" class="difflineplus">+   *</span>
<a href="#l1.2335"></a><span id="l1.2335" class="difflineplus">+   * @return {String}           iCalendar/vCard string for value</span>
<a href="#l1.2336"></a><span id="l1.2336">    */</span>
<a href="#l1.2337"></a><span id="l1.2337" class="difflineminus">-  stringify.multiValue = function(values, delim, type) {</span>
<a href="#l1.2338"></a><span id="l1.2338" class="difflineplus">+  stringify.multiValue = function(values, delim, type, innerMulti, designSet, structuredValue) {</span>
<a href="#l1.2339"></a><span id="l1.2339">     var result = '';</span>
<a href="#l1.2340"></a><span id="l1.2340">     var len = values.length;</span>
<a href="#l1.2341"></a><span id="l1.2341">     var i = 0;</span>
<a href="#l1.2342"></a><span id="l1.2342"> </span>
<a href="#l1.2343"></a><span id="l1.2343">     for (; i &lt; len; i++) {</span>
<a href="#l1.2344"></a><span id="l1.2344" class="difflineminus">-      result += stringify.value(values[i], type);</span>
<a href="#l1.2345"></a><span id="l1.2345" class="difflineplus">+      if (innerMulti &amp;&amp; Array.isArray(values[i])) {</span>
<a href="#l1.2346"></a><span id="l1.2346" class="difflineplus">+        result += stringify.multiValue(values[i], innerMulti, type, null, designSet, structuredValue);</span>
<a href="#l1.2347"></a><span id="l1.2347" class="difflineplus">+      } else {</span>
<a href="#l1.2348"></a><span id="l1.2348" class="difflineplus">+        result += stringify.value(values[i], type, designSet, structuredValue);</span>
<a href="#l1.2349"></a><span id="l1.2349" class="difflineplus">+      }</span>
<a href="#l1.2350"></a><span id="l1.2350" class="difflineplus">+</span>
<a href="#l1.2351"></a><span id="l1.2351">       if (i !== (len - 1)) {</span>
<a href="#l1.2352"></a><span id="l1.2352">         result += delim;</span>
<a href="#l1.2353"></a><span id="l1.2353">       }</span>
<a href="#l1.2354"></a><span id="l1.2354">     }</span>
<a href="#l1.2355"></a><span id="l1.2355"> </span>
<a href="#l1.2356"></a><span id="l1.2356">     return result;</span>
<a href="#l1.2357"></a><span id="l1.2357" class="difflineminus">-  }</span>
<a href="#l1.2358"></a><span id="l1.2358" class="difflineplus">+  };</span>
<a href="#l1.2359"></a><span id="l1.2359" class="difflineplus">+</span>
<a href="#l1.2360"></a><span id="l1.2360" class="difflineplus">+  /**</span>
<a href="#l1.2361"></a><span id="l1.2361" class="difflineplus">+   * Processes a single ical value runs the associated &quot;toICAL&quot; method from the</span>
<a href="#l1.2362"></a><span id="l1.2362" class="difflineplus">+   * design value type if available to convert the value.</span>
<a href="#l1.2363"></a><span id="l1.2363" class="difflineplus">+   *</span>
<a href="#l1.2364"></a><span id="l1.2364" class="difflineplus">+   * @function ICAL.stringify.value</span>
<a href="#l1.2365"></a><span id="l1.2365" class="difflineplus">+   * @param {String|Number} value       A formatted value</span>
<a href="#l1.2366"></a><span id="l1.2366" class="difflineplus">+   * @param {String} type               Lowercase iCalendar/vCard value type</span>
<a href="#l1.2367"></a><span id="l1.2367" class="difflineplus">+   *  (like boolean, date-time, etc..)</span>
<a href="#l1.2368"></a><span id="l1.2368" class="difflineplus">+   * @return {String}                   iCalendar/vCard value for single value</span>
<a href="#l1.2369"></a><span id="l1.2369" class="difflineplus">+   */</span>
<a href="#l1.2370"></a><span id="l1.2370" class="difflineplus">+  stringify.value = function(value, type, designSet, structuredValue) {</span>
<a href="#l1.2371"></a><span id="l1.2371" class="difflineplus">+    if (type in designSet.value &amp;&amp; 'toICAL' in designSet.value[type]) {</span>
<a href="#l1.2372"></a><span id="l1.2372" class="difflineplus">+      return designSet.value[type].toICAL(value, structuredValue);</span>
<a href="#l1.2373"></a><span id="l1.2373" class="difflineplus">+    }</span>
<a href="#l1.2374"></a><span id="l1.2374" class="difflineplus">+    return value;</span>
<a href="#l1.2375"></a><span id="l1.2375" class="difflineplus">+  };</span>
<a href="#l1.2376"></a><span id="l1.2376"> </span>
<a href="#l1.2377"></a><span id="l1.2377">   /**</span>
<a href="#l1.2378"></a><span id="l1.2378" class="difflineminus">-   * Processes a single ical value runs the associated &quot;toICAL&quot;</span>
<a href="#l1.2379"></a><span id="l1.2379" class="difflineminus">-   * method from the design value type if available to convert</span>
<a href="#l1.2380"></a><span id="l1.2380" class="difflineminus">-   * the value.</span>
<a href="#l1.2381"></a><span id="l1.2381" class="difflineminus">-   *</span>
<a href="#l1.2382"></a><span id="l1.2382" class="difflineminus">-   * @param {String|Numeric} value some formatted value.</span>
<a href="#l1.2383"></a><span id="l1.2383" class="difflineminus">-   * @param {String} type lowecase ical value type</span>
<a href="#l1.2384"></a><span id="l1.2384" class="difflineminus">-   *  (like boolean, date-time, etc..).</span>
<a href="#l1.2385"></a><span id="l1.2385" class="difflineminus">-   * @return {String} ical value for single value.</span>
<a href="#l1.2386"></a><span id="l1.2386" class="difflineplus">+   * Internal helper for rfc6868. Exposing this on ICAL.stringify so that</span>
<a href="#l1.2387"></a><span id="l1.2387" class="difflineplus">+   * hackers can disable the rfc6868 parsing if the really need to.</span>
<a href="#l1.2388"></a><span id="l1.2388" class="difflineplus">+   *</span>
<a href="#l1.2389"></a><span id="l1.2389" class="difflineplus">+   * @param {String} val        The value to unescape</span>
<a href="#l1.2390"></a><span id="l1.2390" class="difflineplus">+   * @return {String}           The escaped value</span>
<a href="#l1.2391"></a><span id="l1.2391">    */</span>
<a href="#l1.2392"></a><span id="l1.2392" class="difflineminus">-  stringify.value = function(value, type) {</span>
<a href="#l1.2393"></a><span id="l1.2393" class="difflineminus">-    if (type in design.value &amp;&amp; 'toICAL' in design.value[type]) {</span>
<a href="#l1.2394"></a><span id="l1.2394" class="difflineminus">-      return design.value[type].toICAL(value);</span>
<a href="#l1.2395"></a><span id="l1.2395" class="difflineminus">-    }</span>
<a href="#l1.2396"></a><span id="l1.2396" class="difflineminus">-    return value;</span>
<a href="#l1.2397"></a><span id="l1.2397" class="difflineminus">-  }</span>
<a href="#l1.2398"></a><span id="l1.2398" class="difflineplus">+  stringify._rfc6868Unescape = function(val) {</span>
<a href="#l1.2399"></a><span id="l1.2399" class="difflineplus">+    return val.replace(/[\n^&quot;]/g, function(x) {</span>
<a href="#l1.2400"></a><span id="l1.2400" class="difflineplus">+      return RFC6868_REPLACE_MAP[x];</span>
<a href="#l1.2401"></a><span id="l1.2401" class="difflineplus">+    });</span>
<a href="#l1.2402"></a><span id="l1.2402" class="difflineplus">+  };</span>
<a href="#l1.2403"></a><span id="l1.2403" class="difflineplus">+  var RFC6868_REPLACE_MAP = { '&quot;': &quot;^'&quot;, &quot;\n&quot;: &quot;^n&quot;, &quot;^&quot;: &quot;^^&quot; };</span>
<a href="#l1.2404"></a><span id="l1.2404"> </span>
<a href="#l1.2405"></a><span id="l1.2405">   return stringify;</span>
<a href="#l1.2406"></a><span id="l1.2406" class="difflineminus">-</span>
<a href="#l1.2407"></a><span id="l1.2407"> }());</span>
<a href="#l1.2408"></a><span id="l1.2408" class="difflineminus">-</span>
<a href="#l1.2409"></a><span id="l1.2409" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.2410"></a><span id="l1.2410" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.2411"></a><span id="l1.2411" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.2412"></a><span id="l1.2412" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.2413"></a><span id="l1.2413" class="difflineplus">+</span>
<a href="#l1.2414"></a><span id="l1.2414" class="difflineplus">+</span>
<a href="#l1.2415"></a><span id="l1.2415" class="difflineplus">+/**</span>
<a href="#l1.2416"></a><span id="l1.2416" class="difflineplus">+ * Contains various functions to parse iCalendar and vCard data.</span>
<a href="#l1.2417"></a><span id="l1.2417" class="difflineplus">+ * @namespace</span>
<a href="#l1.2418"></a><span id="l1.2418" class="difflineplus">+ */</span>
<a href="#l1.2419"></a><span id="l1.2419"> ICAL.parse = (function() {</span>
<a href="#l1.2420"></a><span id="l1.2420">   'use strict';</span>
<a href="#l1.2421"></a><span id="l1.2421"> </span>
<a href="#l1.2422"></a><span id="l1.2422">   var CHAR = /[^ \t]/;</span>
<a href="#l1.2423"></a><span id="l1.2423">   var MULTIVALUE_DELIMITER = ',';</span>
<a href="#l1.2424"></a><span id="l1.2424">   var VALUE_DELIMITER = ':';</span>
<a href="#l1.2425"></a><span id="l1.2425">   var PARAM_DELIMITER = ';';</span>
<a href="#l1.2426"></a><span id="l1.2426">   var PARAM_NAME_DELIMITER = '=';</span>
<a href="#l1.2427"></a><span id="l1.2427" class="difflineminus">-  var DEFAULT_TYPE = 'text';</span>
<a href="#l1.2428"></a><span id="l1.2428" class="difflineplus">+  var DEFAULT_VALUE_TYPE = 'unknown';</span>
<a href="#l1.2429"></a><span id="l1.2429" class="difflineplus">+  var DEFAULT_PARAM_TYPE = 'text';</span>
<a href="#l1.2430"></a><span id="l1.2430"> </span>
<a href="#l1.2431"></a><span id="l1.2431">   var design = ICAL.design;</span>
<a href="#l1.2432"></a><span id="l1.2432">   var helpers = ICAL.helpers;</span>
<a href="#l1.2433"></a><span id="l1.2433"> </span>
<a href="#l1.2434"></a><span id="l1.2434" class="difflineplus">+  /**</span>
<a href="#l1.2435"></a><span id="l1.2435" class="difflineplus">+   * An error that occurred during parsing.</span>
<a href="#l1.2436"></a><span id="l1.2436" class="difflineplus">+   *</span>
<a href="#l1.2437"></a><span id="l1.2437" class="difflineplus">+   * @param {String} message        The error message</span>
<a href="#l1.2438"></a><span id="l1.2438" class="difflineplus">+   * @memberof ICAL.parse</span>
<a href="#l1.2439"></a><span id="l1.2439" class="difflineplus">+   * @extends {Error}</span>
<a href="#l1.2440"></a><span id="l1.2440" class="difflineplus">+   * @class</span>
<a href="#l1.2441"></a><span id="l1.2441" class="difflineplus">+   */</span>
<a href="#l1.2442"></a><span id="l1.2442">   function ParserError(message) {</span>
<a href="#l1.2443"></a><span id="l1.2443">     this.message = message;</span>
<a href="#l1.2444"></a><span id="l1.2444" class="difflineplus">+    this.name = 'ParserError';</span>
<a href="#l1.2445"></a><span id="l1.2445"> </span>
<a href="#l1.2446"></a><span id="l1.2446">     try {</span>
<a href="#l1.2447"></a><span id="l1.2447">       throw new Error();</span>
<a href="#l1.2448"></a><span id="l1.2448">     } catch (e) {</span>
<a href="#l1.2449"></a><span id="l1.2449" class="difflineminus">-      var split = e.stack.split('\n');</span>
<a href="#l1.2450"></a><span id="l1.2450" class="difflineminus">-      split.shift();</span>
<a href="#l1.2451"></a><span id="l1.2451" class="difflineminus">-      this.stack = split.join('\n');</span>
<a href="#l1.2452"></a><span id="l1.2452" class="difflineplus">+      if (e.stack) {</span>
<a href="#l1.2453"></a><span id="l1.2453" class="difflineplus">+        var split = e.stack.split('\n');</span>
<a href="#l1.2454"></a><span id="l1.2454" class="difflineplus">+        split.shift();</span>
<a href="#l1.2455"></a><span id="l1.2455" class="difflineplus">+        this.stack = split.join('\n');</span>
<a href="#l1.2456"></a><span id="l1.2456" class="difflineplus">+      }</span>
<a href="#l1.2457"></a><span id="l1.2457">     }</span>
<a href="#l1.2458"></a><span id="l1.2458">   }</span>
<a href="#l1.2459"></a><span id="l1.2459"> </span>
<a href="#l1.2460"></a><span id="l1.2460" class="difflineminus">-  ParserError.prototype = {</span>
<a href="#l1.2461"></a><span id="l1.2461" class="difflineminus">-    __proto__: Error.prototype</span>
<a href="#l1.2462"></a><span id="l1.2462" class="difflineminus">-  };</span>
<a href="#l1.2463"></a><span id="l1.2463" class="difflineminus">-</span>
<a href="#l1.2464"></a><span id="l1.2464" class="difflineplus">+  ParserError.prototype = Error.prototype;</span>
<a href="#l1.2465"></a><span id="l1.2465" class="difflineplus">+</span>
<a href="#l1.2466"></a><span id="l1.2466" class="difflineplus">+  /**</span>
<a href="#l1.2467"></a><span id="l1.2467" class="difflineplus">+   * Parses iCalendar or vCard data into a raw jCal object. Consult</span>
<a href="#l1.2468"></a><span id="l1.2468" class="difflineplus">+   * documentation on the {@tutorial layers|layers of parsing} for more</span>
<a href="#l1.2469"></a><span id="l1.2469" class="difflineplus">+   * details.</span>
<a href="#l1.2470"></a><span id="l1.2470" class="difflineplus">+   *</span>
<a href="#l1.2471"></a><span id="l1.2471" class="difflineplus">+   * @function ICAL.parse</span>
<a href="#l1.2472"></a><span id="l1.2472" class="difflineplus">+   * @variation function</span>
<a href="#l1.2473"></a><span id="l1.2473" class="difflineplus">+   * @todo Fix the API to be more clear on the return type</span>
<a href="#l1.2474"></a><span id="l1.2474" class="difflineplus">+   * @param {String} input      The string data to parse</span>
<a href="#l1.2475"></a><span id="l1.2475" class="difflineplus">+   * @return {Object|Object[]}  A single jCal object, or an array thereof</span>
<a href="#l1.2476"></a><span id="l1.2476" class="difflineplus">+   */</span>
<a href="#l1.2477"></a><span id="l1.2477">   function parser(input) {</span>
<a href="#l1.2478"></a><span id="l1.2478">     var state = {};</span>
<a href="#l1.2479"></a><span id="l1.2479" class="difflineminus">-    var root = state.component = [</span>
<a href="#l1.2480"></a><span id="l1.2480" class="difflineminus">-      'icalendar'</span>
<a href="#l1.2481"></a><span id="l1.2481" class="difflineminus">-    ];</span>
<a href="#l1.2482"></a><span id="l1.2482" class="difflineplus">+    var root = state.component = [];</span>
<a href="#l1.2483"></a><span id="l1.2483"> </span>
<a href="#l1.2484"></a><span id="l1.2484">     state.stack = [root];</span>
<a href="#l1.2485"></a><span id="l1.2485"> </span>
<a href="#l1.2486"></a><span id="l1.2486">     parser._eachLine(input, function(err, line) {</span>
<a href="#l1.2487"></a><span id="l1.2487">       parser._handleContentLine(line, state);</span>
<a href="#l1.2488"></a><span id="l1.2488">     });</span>
<a href="#l1.2489"></a><span id="l1.2489"> </span>
<a href="#l1.2490"></a><span id="l1.2490"> </span>
<a href="#l1.2491"></a><span id="l1.2491" class="difflineat">@@ -1216,26 +1719,75 @@ ICAL.parse = (function() {</span>
<a href="#l1.2492"></a><span id="l1.2492">     if (state.stack.length &gt; 1) {</span>
<a href="#l1.2493"></a><span id="l1.2493">       throw new ParserError(</span>
<a href="#l1.2494"></a><span id="l1.2494">         'invalid ical body. component began but did not end'</span>
<a href="#l1.2495"></a><span id="l1.2495">       );</span>
<a href="#l1.2496"></a><span id="l1.2496">     }</span>
<a href="#l1.2497"></a><span id="l1.2497"> </span>
<a href="#l1.2498"></a><span id="l1.2498">     state = null;</span>
<a href="#l1.2499"></a><span id="l1.2499"> </span>
<a href="#l1.2500"></a><span id="l1.2500" class="difflineminus">-    return root;</span>
<a href="#l1.2501"></a><span id="l1.2501" class="difflineplus">+    return (root.length == 1 ? root[0] : root);</span>
<a href="#l1.2502"></a><span id="l1.2502">   }</span>
<a href="#l1.2503"></a><span id="l1.2503"> </span>
<a href="#l1.2504"></a><span id="l1.2504" class="difflineplus">+  /**</span>
<a href="#l1.2505"></a><span id="l1.2505" class="difflineplus">+   * Parse an iCalendar property value into the jCal for a single property</span>
<a href="#l1.2506"></a><span id="l1.2506" class="difflineplus">+   *</span>
<a href="#l1.2507"></a><span id="l1.2507" class="difflineplus">+   * @function ICAL.parse.property</span>
<a href="#l1.2508"></a><span id="l1.2508" class="difflineplus">+   * @param {String} str</span>
<a href="#l1.2509"></a><span id="l1.2509" class="difflineplus">+   *   The iCalendar property string to parse</span>
<a href="#l1.2510"></a><span id="l1.2510" class="difflineplus">+   * @param {ICAL.design.designSet=} designSet</span>
<a href="#l1.2511"></a><span id="l1.2511" class="difflineplus">+   *   The design data to use for this property</span>
<a href="#l1.2512"></a><span id="l1.2512" class="difflineplus">+   * @return {Object}</span>
<a href="#l1.2513"></a><span id="l1.2513" class="difflineplus">+   *   The jCal Object containing the property</span>
<a href="#l1.2514"></a><span id="l1.2514" class="difflineplus">+   */</span>
<a href="#l1.2515"></a><span id="l1.2515" class="difflineplus">+  parser.property = function(str, designSet) {</span>
<a href="#l1.2516"></a><span id="l1.2516" class="difflineplus">+    var state = {</span>
<a href="#l1.2517"></a><span id="l1.2517" class="difflineplus">+      component: [[], []],</span>
<a href="#l1.2518"></a><span id="l1.2518" class="difflineplus">+      designSet: designSet || design.defaultSet</span>
<a href="#l1.2519"></a><span id="l1.2519" class="difflineplus">+    };</span>
<a href="#l1.2520"></a><span id="l1.2520" class="difflineplus">+    parser._handleContentLine(str, state);</span>
<a href="#l1.2521"></a><span id="l1.2521" class="difflineplus">+    return state.component[1][0];</span>
<a href="#l1.2522"></a><span id="l1.2522" class="difflineplus">+  };</span>
<a href="#l1.2523"></a><span id="l1.2523" class="difflineplus">+</span>
<a href="#l1.2524"></a><span id="l1.2524" class="difflineplus">+  /**</span>
<a href="#l1.2525"></a><span id="l1.2525" class="difflineplus">+   * Convenience method to parse a component. You can use ICAL.parse() directly</span>
<a href="#l1.2526"></a><span id="l1.2526" class="difflineplus">+   * instead.</span>
<a href="#l1.2527"></a><span id="l1.2527" class="difflineplus">+   *</span>
<a href="#l1.2528"></a><span id="l1.2528" class="difflineplus">+   * @function ICAL.parse.component</span>
<a href="#l1.2529"></a><span id="l1.2529" class="difflineplus">+   * @see ICAL.parse(function)</span>
<a href="#l1.2530"></a><span id="l1.2530" class="difflineplus">+   * @param {String} str    The iCalendar component string to parse</span>
<a href="#l1.2531"></a><span id="l1.2531" class="difflineplus">+   * @return {Object}       The jCal Object containing the component</span>
<a href="#l1.2532"></a><span id="l1.2532" class="difflineplus">+   */</span>
<a href="#l1.2533"></a><span id="l1.2533" class="difflineplus">+  parser.component = function(str) {</span>
<a href="#l1.2534"></a><span id="l1.2534" class="difflineplus">+    return parser(str);</span>
<a href="#l1.2535"></a><span id="l1.2535" class="difflineplus">+  };</span>
<a href="#l1.2536"></a><span id="l1.2536" class="difflineplus">+</span>
<a href="#l1.2537"></a><span id="l1.2537">   // classes &amp; constants</span>
<a href="#l1.2538"></a><span id="l1.2538">   parser.ParserError = ParserError;</span>
<a href="#l1.2539"></a><span id="l1.2539"> </span>
<a href="#l1.2540"></a><span id="l1.2540" class="difflineminus">-  parser._formatName = function(name) {</span>
<a href="#l1.2541"></a><span id="l1.2541" class="difflineminus">-    return name.toLowerCase();</span>
<a href="#l1.2542"></a><span id="l1.2542" class="difflineminus">-  }</span>
<a href="#l1.2543"></a><span id="l1.2543" class="difflineminus">-</span>
<a href="#l1.2544"></a><span id="l1.2544" class="difflineplus">+  /**</span>
<a href="#l1.2545"></a><span id="l1.2545" class="difflineplus">+   * The state for parsing content lines from an iCalendar/vCard string.</span>
<a href="#l1.2546"></a><span id="l1.2546" class="difflineplus">+   *</span>
<a href="#l1.2547"></a><span id="l1.2547" class="difflineplus">+   * @private</span>
<a href="#l1.2548"></a><span id="l1.2548" class="difflineplus">+   * @memberof ICAL.parse</span>
<a href="#l1.2549"></a><span id="l1.2549" class="difflineplus">+   * @typedef {Object} parserState</span>
<a href="#l1.2550"></a><span id="l1.2550" class="difflineplus">+   * @property {ICAL.design.designSet} designSet    The design set to use for parsing</span>
<a href="#l1.2551"></a><span id="l1.2551" class="difflineplus">+   * @property {ICAL.Component[]} stack             The stack of components being processed</span>
<a href="#l1.2552"></a><span id="l1.2552" class="difflineplus">+   * @property {ICAL.Component} component           The currently active component</span>
<a href="#l1.2553"></a><span id="l1.2553" class="difflineplus">+   */</span>
<a href="#l1.2554"></a><span id="l1.2554" class="difflineplus">+</span>
<a href="#l1.2555"></a><span id="l1.2555" class="difflineplus">+</span>
<a href="#l1.2556"></a><span id="l1.2556" class="difflineplus">+  /**</span>
<a href="#l1.2557"></a><span id="l1.2557" class="difflineplus">+   * Handles a single line of iCalendar/vCard, updating the state.</span>
<a href="#l1.2558"></a><span id="l1.2558" class="difflineplus">+   *</span>
<a href="#l1.2559"></a><span id="l1.2559" class="difflineplus">+   * @private</span>
<a href="#l1.2560"></a><span id="l1.2560" class="difflineplus">+   * @function ICAL.parse._handleContentLine</span>
<a href="#l1.2561"></a><span id="l1.2561" class="difflineplus">+   * @param {String} line               The content line to process</span>
<a href="#l1.2562"></a><span id="l1.2562" class="difflineplus">+   * @param {ICAL.parse.parserState}    The current state of the line parsing</span>
<a href="#l1.2563"></a><span id="l1.2563" class="difflineplus">+   */</span>
<a href="#l1.2564"></a><span id="l1.2564">   parser._handleContentLine = function(line, state) {</span>
<a href="#l1.2565"></a><span id="l1.2565">     // break up the parts of the line</span>
<a href="#l1.2566"></a><span id="l1.2566">     var valuePos = line.indexOf(VALUE_DELIMITER);</span>
<a href="#l1.2567"></a><span id="l1.2567">     var paramPos = line.indexOf(PARAM_DELIMITER);</span>
<a href="#l1.2568"></a><span id="l1.2568"> </span>
<a href="#l1.2569"></a><span id="l1.2569">     var lastParamIndex;</span>
<a href="#l1.2570"></a><span id="l1.2570">     var lastValuePos;</span>
<a href="#l1.2571"></a><span id="l1.2571"> </span>
<a href="#l1.2572"></a><span id="l1.2572" class="difflineat">@@ -1266,78 +1818,93 @@ ICAL.parse = (function() {</span>
<a href="#l1.2573"></a><span id="l1.2573">       if (paramPos &gt; valuePos) {</span>
<a href="#l1.2574"></a><span id="l1.2574">         paramPos = -1;</span>
<a href="#l1.2575"></a><span id="l1.2575">       }</span>
<a href="#l1.2576"></a><span id="l1.2576">     }</span>
<a href="#l1.2577"></a><span id="l1.2577"> </span>
<a href="#l1.2578"></a><span id="l1.2578">     var parsedParams;</span>
<a href="#l1.2579"></a><span id="l1.2579">     if (paramPos !== -1) {</span>
<a href="#l1.2580"></a><span id="l1.2580">       name = line.substring(0, paramPos).toLowerCase();</span>
<a href="#l1.2581"></a><span id="l1.2581" class="difflineminus">-      parsedParams = parser._parseParameters(line.substring(paramPos), 0);</span>
<a href="#l1.2582"></a><span id="l1.2582" class="difflineplus">+      parsedParams = parser._parseParameters(line.substring(paramPos), 0, state.designSet);</span>
<a href="#l1.2583"></a><span id="l1.2583" class="difflineplus">+      if (parsedParams[2] == -1) {</span>
<a href="#l1.2584"></a><span id="l1.2584" class="difflineplus">+        throw new ParserError(&quot;Invalid parameters in '&quot; + line + &quot;'&quot;);</span>
<a href="#l1.2585"></a><span id="l1.2585" class="difflineplus">+      }</span>
<a href="#l1.2586"></a><span id="l1.2586">       params = parsedParams[0];</span>
<a href="#l1.2587"></a><span id="l1.2587">       lastParamIndex = parsedParams[1].length + parsedParams[2] + paramPos;</span>
<a href="#l1.2588"></a><span id="l1.2588">       if ((lastValuePos =</span>
<a href="#l1.2589"></a><span id="l1.2589">         line.substring(lastParamIndex).indexOf(VALUE_DELIMITER)) !== -1) {</span>
<a href="#l1.2590"></a><span id="l1.2590">         value = line.substring(lastParamIndex + lastValuePos + 1);</span>
<a href="#l1.2591"></a><span id="l1.2591" class="difflineplus">+      } else {</span>
<a href="#l1.2592"></a><span id="l1.2592" class="difflineplus">+        throw new ParserError(&quot;Missing parameter value in '&quot; + line + &quot;'&quot;);</span>
<a href="#l1.2593"></a><span id="l1.2593">       }</span>
<a href="#l1.2594"></a><span id="l1.2594">     } else if (valuePos !== -1) {</span>
<a href="#l1.2595"></a><span id="l1.2595">       // without parmeters (BEGIN:VCAENDAR, CLASS:PUBLIC)</span>
<a href="#l1.2596"></a><span id="l1.2596">       name = line.substring(0, valuePos).toLowerCase();</span>
<a href="#l1.2597"></a><span id="l1.2597">       value = line.substring(valuePos + 1);</span>
<a href="#l1.2598"></a><span id="l1.2598"> </span>
<a href="#l1.2599"></a><span id="l1.2599">       if (name === 'begin') {</span>
<a href="#l1.2600"></a><span id="l1.2600">         var newComponent = [value.toLowerCase(), [], []];</span>
<a href="#l1.2601"></a><span id="l1.2601">         if (state.stack.length === 1) {</span>
<a href="#l1.2602"></a><span id="l1.2602">           state.component.push(newComponent);</span>
<a href="#l1.2603"></a><span id="l1.2603">         } else {</span>
<a href="#l1.2604"></a><span id="l1.2604">           state.component[2].push(newComponent);</span>
<a href="#l1.2605"></a><span id="l1.2605">         }</span>
<a href="#l1.2606"></a><span id="l1.2606">         state.stack.push(state.component);</span>
<a href="#l1.2607"></a><span id="l1.2607">         state.component = newComponent;</span>
<a href="#l1.2608"></a><span id="l1.2608" class="difflineplus">+        if (!state.designSet) {</span>
<a href="#l1.2609"></a><span id="l1.2609" class="difflineplus">+          state.designSet = design.getDesignSet(state.component[0]);</span>
<a href="#l1.2610"></a><span id="l1.2610" class="difflineplus">+        }</span>
<a href="#l1.2611"></a><span id="l1.2611">         return;</span>
<a href="#l1.2612"></a><span id="l1.2612">       } else if (name === 'end') {</span>
<a href="#l1.2613"></a><span id="l1.2613">         state.component = state.stack.pop();</span>
<a href="#l1.2614"></a><span id="l1.2614">         return;</span>
<a href="#l1.2615"></a><span id="l1.2615">       }</span>
<a href="#l1.2616"></a><span id="l1.2616" class="difflineplus">+      // If its not begin/end, then this is a property with an empty value,</span>
<a href="#l1.2617"></a><span id="l1.2617" class="difflineplus">+      // which should be considered valid.</span>
<a href="#l1.2618"></a><span id="l1.2618">     } else {</span>
<a href="#l1.2619"></a><span id="l1.2619">       /**</span>
<a href="#l1.2620"></a><span id="l1.2620">        * Invalid line.</span>
<a href="#l1.2621"></a><span id="l1.2621">        * The rational to throw an error is we will</span>
<a href="#l1.2622"></a><span id="l1.2622">        * never be certain that the rest of the file</span>
<a href="#l1.2623"></a><span id="l1.2623">        * is sane and its unlikely that we can serialize</span>
<a href="#l1.2624"></a><span id="l1.2624">        * the result correctly either.</span>
<a href="#l1.2625"></a><span id="l1.2625">        */</span>
<a href="#l1.2626"></a><span id="l1.2626">       throw new ParserError(</span>
<a href="#l1.2627"></a><span id="l1.2627">         'invalid line (no token &quot;;&quot; or &quot;:&quot;) &quot;' + line + '&quot;'</span>
<a href="#l1.2628"></a><span id="l1.2628">       );</span>
<a href="#l1.2629"></a><span id="l1.2629">     }</span>
<a href="#l1.2630"></a><span id="l1.2630"> </span>
<a href="#l1.2631"></a><span id="l1.2631">     var valueType;</span>
<a href="#l1.2632"></a><span id="l1.2632">     var multiValue = false;</span>
<a href="#l1.2633"></a><span id="l1.2633" class="difflineplus">+    var structuredValue = false;</span>
<a href="#l1.2634"></a><span id="l1.2634">     var propertyDetails;</span>
<a href="#l1.2635"></a><span id="l1.2635"> </span>
<a href="#l1.2636"></a><span id="l1.2636" class="difflineminus">-    if (name in design.property) {</span>
<a href="#l1.2637"></a><span id="l1.2637" class="difflineminus">-      propertyDetails = design.property[name];</span>
<a href="#l1.2638"></a><span id="l1.2638" class="difflineplus">+    if (name in state.designSet.property) {</span>
<a href="#l1.2639"></a><span id="l1.2639" class="difflineplus">+      propertyDetails = state.designSet.property[name];</span>
<a href="#l1.2640"></a><span id="l1.2640"> </span>
<a href="#l1.2641"></a><span id="l1.2641">       if ('multiValue' in propertyDetails) {</span>
<a href="#l1.2642"></a><span id="l1.2642">         multiValue = propertyDetails.multiValue;</span>
<a href="#l1.2643"></a><span id="l1.2643">       }</span>
<a href="#l1.2644"></a><span id="l1.2644"> </span>
<a href="#l1.2645"></a><span id="l1.2645" class="difflineplus">+      if ('structuredValue' in propertyDetails) {</span>
<a href="#l1.2646"></a><span id="l1.2646" class="difflineplus">+        structuredValue = propertyDetails.structuredValue;</span>
<a href="#l1.2647"></a><span id="l1.2647" class="difflineplus">+      }</span>
<a href="#l1.2648"></a><span id="l1.2648" class="difflineplus">+</span>
<a href="#l1.2649"></a><span id="l1.2649">       if (value &amp;&amp; 'detectType' in propertyDetails) {</span>
<a href="#l1.2650"></a><span id="l1.2650">         valueType = propertyDetails.detectType(value);</span>
<a href="#l1.2651"></a><span id="l1.2651">       }</span>
<a href="#l1.2652"></a><span id="l1.2652">     }</span>
<a href="#l1.2653"></a><span id="l1.2653"> </span>
<a href="#l1.2654"></a><span id="l1.2654">     // attempt to determine value</span>
<a href="#l1.2655"></a><span id="l1.2655">     if (!valueType) {</span>
<a href="#l1.2656"></a><span id="l1.2656">       if (!('value' in params)) {</span>
<a href="#l1.2657"></a><span id="l1.2657">         if (propertyDetails) {</span>
<a href="#l1.2658"></a><span id="l1.2658">           valueType = propertyDetails.defaultType;</span>
<a href="#l1.2659"></a><span id="l1.2659">         } else {</span>
<a href="#l1.2660"></a><span id="l1.2660" class="difflineminus">-          valueType = DEFAULT_TYPE;</span>
<a href="#l1.2661"></a><span id="l1.2661" class="difflineplus">+          valueType = DEFAULT_VALUE_TYPE;</span>
<a href="#l1.2662"></a><span id="l1.2662">         }</span>
<a href="#l1.2663"></a><span id="l1.2663">       } else {</span>
<a href="#l1.2664"></a><span id="l1.2664">         // possible to avoid this?</span>
<a href="#l1.2665"></a><span id="l1.2665">         valueType = params.value.toLowerCase();</span>
<a href="#l1.2666"></a><span id="l1.2666">       }</span>
<a href="#l1.2667"></a><span id="l1.2667">     }</span>
<a href="#l1.2668"></a><span id="l1.2668"> </span>
<a href="#l1.2669"></a><span id="l1.2669">     delete params.value;</span>
<a href="#l1.2670"></a><span id="l1.2670" class="difflineat">@@ -1345,142 +1912,247 @@ ICAL.parse = (function() {</span>
<a href="#l1.2671"></a><span id="l1.2671">     /**</span>
<a href="#l1.2672"></a><span id="l1.2672">      * Note on `var result` juggling:</span>
<a href="#l1.2673"></a><span id="l1.2673">      *</span>
<a href="#l1.2674"></a><span id="l1.2674">      * I observed that building the array in pieces has adverse</span>
<a href="#l1.2675"></a><span id="l1.2675">      * effects on performance, so where possible we inline the creation.</span>
<a href="#l1.2676"></a><span id="l1.2676">      * Its a little ugly but resulted in ~2000 additional ops/sec.</span>
<a href="#l1.2677"></a><span id="l1.2677">      */</span>
<a href="#l1.2678"></a><span id="l1.2678"> </span>
<a href="#l1.2679"></a><span id="l1.2679" class="difflineminus">-    if (value) {</span>
<a href="#l1.2680"></a><span id="l1.2680" class="difflineminus">-      if (multiValue) {</span>
<a href="#l1.2681"></a><span id="l1.2681" class="difflineminus">-        var result = [name, params, valueType];</span>
<a href="#l1.2682"></a><span id="l1.2682" class="difflineminus">-        parser._parseMultiValue(value, multiValue, valueType, result);</span>
<a href="#l1.2683"></a><span id="l1.2683" class="difflineminus">-      } else {</span>
<a href="#l1.2684"></a><span id="l1.2684" class="difflineminus">-        value = parser._parseValue(value, valueType);</span>
<a href="#l1.2685"></a><span id="l1.2685" class="difflineminus">-        var result = [name, params, valueType, value];</span>
<a href="#l1.2686"></a><span id="l1.2686" class="difflineminus">-      }</span>
<a href="#l1.2687"></a><span id="l1.2687" class="difflineplus">+    var result;</span>
<a href="#l1.2688"></a><span id="l1.2688" class="difflineplus">+    if (multiValue &amp;&amp; structuredValue) {</span>
<a href="#l1.2689"></a><span id="l1.2689" class="difflineplus">+      value = parser._parseMultiValue(value, structuredValue, valueType, [], multiValue, state.designSet, structuredValue);</span>
<a href="#l1.2690"></a><span id="l1.2690" class="difflineplus">+      result = [name, params, valueType, value];</span>
<a href="#l1.2691"></a><span id="l1.2691" class="difflineplus">+    } else if (multiValue) {</span>
<a href="#l1.2692"></a><span id="l1.2692" class="difflineplus">+      result = [name, params, valueType];</span>
<a href="#l1.2693"></a><span id="l1.2693" class="difflineplus">+      parser._parseMultiValue(value, multiValue, valueType, result, null, state.designSet, false);</span>
<a href="#l1.2694"></a><span id="l1.2694" class="difflineplus">+    } else if (structuredValue) {</span>
<a href="#l1.2695"></a><span id="l1.2695" class="difflineplus">+      value = parser._parseMultiValue(value, structuredValue, valueType, [], null, state.designSet, structuredValue);</span>
<a href="#l1.2696"></a><span id="l1.2696" class="difflineplus">+      result = [name, params, valueType, value];</span>
<a href="#l1.2697"></a><span id="l1.2697">     } else {</span>
<a href="#l1.2698"></a><span id="l1.2698" class="difflineminus">-      var result = [name, params, valueType];</span>
<a href="#l1.2699"></a><span id="l1.2699" class="difflineminus">-    }</span>
<a href="#l1.2700"></a><span id="l1.2700" class="difflineminus">-</span>
<a href="#l1.2701"></a><span id="l1.2701" class="difflineplus">+      value = parser._parseValue(value, valueType, state.designSet, false);</span>
<a href="#l1.2702"></a><span id="l1.2702" class="difflineplus">+      result = [name, params, valueType, value];</span>
<a href="#l1.2703"></a><span id="l1.2703" class="difflineplus">+    }</span>
<a href="#l1.2704"></a><span id="l1.2704" class="difflineplus">+    // rfc6350 requires that in vCard 4.0 the first component is the VERSION</span>
<a href="#l1.2705"></a><span id="l1.2705" class="difflineplus">+    // component with as value 4.0, note that 3.0 does not have this requirement.</span>
<a href="#l1.2706"></a><span id="l1.2706" class="difflineplus">+    if (state.component[0] === 'vcard' &amp;&amp; state.component[1].length === 0 &amp;&amp;</span>
<a href="#l1.2707"></a><span id="l1.2707" class="difflineplus">+            !(name === 'version' &amp;&amp; value === '4.0')) {</span>
<a href="#l1.2708"></a><span id="l1.2708" class="difflineplus">+      state.designSet = design.getDesignSet(&quot;vcard3&quot;);</span>
<a href="#l1.2709"></a><span id="l1.2709" class="difflineplus">+    }</span>
<a href="#l1.2710"></a><span id="l1.2710">     state.component[1].push(result);</span>
<a href="#l1.2711"></a><span id="l1.2711">   };</span>
<a href="#l1.2712"></a><span id="l1.2712"> </span>
<a href="#l1.2713"></a><span id="l1.2713">   /**</span>
<a href="#l1.2714"></a><span id="l1.2714" class="difflineminus">-   * @param {String} value original value.</span>
<a href="#l1.2715"></a><span id="l1.2715" class="difflineminus">-   * @param {String} type type of value.</span>
<a href="#l1.2716"></a><span id="l1.2716" class="difflineminus">-   * @return {Object} varies on type.</span>
<a href="#l1.2717"></a><span id="l1.2717" class="difflineplus">+   * Parse a value from the raw value into the jCard/jCal value.</span>
<a href="#l1.2718"></a><span id="l1.2718" class="difflineplus">+   *</span>
<a href="#l1.2719"></a><span id="l1.2719" class="difflineplus">+   * @private</span>
<a href="#l1.2720"></a><span id="l1.2720" class="difflineplus">+   * @function ICAL.parse._parseValue</span>
<a href="#l1.2721"></a><span id="l1.2721" class="difflineplus">+   * @param {String} value          Original value</span>
<a href="#l1.2722"></a><span id="l1.2722" class="difflineplus">+   * @param {String} type           Type of value</span>
<a href="#l1.2723"></a><span id="l1.2723" class="difflineplus">+   * @param {Object} designSet      The design data to use for this value</span>
<a href="#l1.2724"></a><span id="l1.2724" class="difflineplus">+   * @return {Object} varies on type</span>
<a href="#l1.2725"></a><span id="l1.2725">    */</span>
<a href="#l1.2726"></a><span id="l1.2726" class="difflineminus">-  parser._parseValue = function(value, type) {</span>
<a href="#l1.2727"></a><span id="l1.2727" class="difflineminus">-    if (type in design.value &amp;&amp; 'fromICAL' in design.value[type]) {</span>
<a href="#l1.2728"></a><span id="l1.2728" class="difflineminus">-      return design.value[type].fromICAL(value);</span>
<a href="#l1.2729"></a><span id="l1.2729" class="difflineplus">+  parser._parseValue = function(value, type, designSet, structuredValue) {</span>
<a href="#l1.2730"></a><span id="l1.2730" class="difflineplus">+    if (type in designSet.value &amp;&amp; 'fromICAL' in designSet.value[type]) {</span>
<a href="#l1.2731"></a><span id="l1.2731" class="difflineplus">+      return designSet.value[type].fromICAL(value, structuredValue);</span>
<a href="#l1.2732"></a><span id="l1.2732">     }</span>
<a href="#l1.2733"></a><span id="l1.2733">     return value;</span>
<a href="#l1.2734"></a><span id="l1.2734">   };</span>
<a href="#l1.2735"></a><span id="l1.2735"> </span>
<a href="#l1.2736"></a><span id="l1.2736">   /**</span>
<a href="#l1.2737"></a><span id="l1.2737">    * Parse parameters from a string to object.</span>
<a href="#l1.2738"></a><span id="l1.2738">    *</span>
<a href="#l1.2739"></a><span id="l1.2739" class="difflineminus">-   * @param {String} line a single unfolded line.</span>
<a href="#l1.2740"></a><span id="l1.2740" class="difflineminus">-   * @param {Numeric} start position to start looking for properties.</span>
<a href="#l1.2741"></a><span id="l1.2741" class="difflineminus">-   * @param {Numeric} maxPos position at which values start.</span>
<a href="#l1.2742"></a><span id="l1.2742" class="difflineminus">-   * @return {Object} key/value pairs.</span>
<a href="#l1.2743"></a><span id="l1.2743" class="difflineplus">+   * @function ICAL.parse._parseParameters</span>
<a href="#l1.2744"></a><span id="l1.2744" class="difflineplus">+   * @private</span>
<a href="#l1.2745"></a><span id="l1.2745" class="difflineplus">+   * @param {String} line           A single unfolded line</span>
<a href="#l1.2746"></a><span id="l1.2746" class="difflineplus">+   * @param {Numeric} start         Position to start looking for properties</span>
<a href="#l1.2747"></a><span id="l1.2747" class="difflineplus">+   * @param {Object} designSet      The design data to use for this property</span>
<a href="#l1.2748"></a><span id="l1.2748" class="difflineplus">+   * @return {Object} key/value pairs</span>
<a href="#l1.2749"></a><span id="l1.2749">    */</span>
<a href="#l1.2750"></a><span id="l1.2750" class="difflineminus">-  parser._parseParameters = function(line, start) {</span>
<a href="#l1.2751"></a><span id="l1.2751" class="difflineplus">+  parser._parseParameters = function(line, start, designSet) {</span>
<a href="#l1.2752"></a><span id="l1.2752">     var lastParam = start;</span>
<a href="#l1.2753"></a><span id="l1.2753">     var pos = 0;</span>
<a href="#l1.2754"></a><span id="l1.2754">     var delim = PARAM_NAME_DELIMITER;</span>
<a href="#l1.2755"></a><span id="l1.2755">     var result = {};</span>
<a href="#l1.2756"></a><span id="l1.2756" class="difflineminus">-    var name;</span>
<a href="#l1.2757"></a><span id="l1.2757" class="difflineminus">-    var value;</span>
<a href="#l1.2758"></a><span id="l1.2758" class="difflineminus">-    var type;</span>
<a href="#l1.2759"></a><span id="l1.2759" class="difflineplus">+    var name, lcname;</span>
<a href="#l1.2760"></a><span id="l1.2760" class="difflineplus">+    var value, valuePos = -1;</span>
<a href="#l1.2761"></a><span id="l1.2761" class="difflineplus">+    var type, multiValue, mvdelim;</span>
<a href="#l1.2762"></a><span id="l1.2762"> </span>
<a href="#l1.2763"></a><span id="l1.2763">     // find the next '=' sign</span>
<a href="#l1.2764"></a><span id="l1.2764">     // use lastParam and pos to find name</span>
<a href="#l1.2765"></a><span id="l1.2765">     // check if &quot; is used if so get value from &quot;-&gt;&quot;</span>
<a href="#l1.2766"></a><span id="l1.2766">     // then increment pos to find next ;</span>
<a href="#l1.2767"></a><span id="l1.2767"> </span>
<a href="#l1.2768"></a><span id="l1.2768">     while ((pos !== false) &amp;&amp;</span>
<a href="#l1.2769"></a><span id="l1.2769">            (pos = helpers.unescapedIndexOf(line, delim, pos + 1)) !== -1) {</span>
<a href="#l1.2770"></a><span id="l1.2770"> </span>
<a href="#l1.2771"></a><span id="l1.2771">       name = line.substr(lastParam + 1, pos - lastParam - 1);</span>
<a href="#l1.2772"></a><span id="l1.2772" class="difflineplus">+      if (name.length == 0) {</span>
<a href="#l1.2773"></a><span id="l1.2773" class="difflineplus">+        throw new ParserError(&quot;Empty parameter name in '&quot; + line + &quot;'&quot;);</span>
<a href="#l1.2774"></a><span id="l1.2774" class="difflineplus">+      }</span>
<a href="#l1.2775"></a><span id="l1.2775" class="difflineplus">+      lcname = name.toLowerCase();</span>
<a href="#l1.2776"></a><span id="l1.2776" class="difflineplus">+</span>
<a href="#l1.2777"></a><span id="l1.2777" class="difflineplus">+      if (lcname in designSet.param &amp;&amp; designSet.param[lcname].valueType) {</span>
<a href="#l1.2778"></a><span id="l1.2778" class="difflineplus">+        type = designSet.param[lcname].valueType;</span>
<a href="#l1.2779"></a><span id="l1.2779" class="difflineplus">+      } else {</span>
<a href="#l1.2780"></a><span id="l1.2780" class="difflineplus">+        type = DEFAULT_PARAM_TYPE;</span>
<a href="#l1.2781"></a><span id="l1.2781" class="difflineplus">+      }</span>
<a href="#l1.2782"></a><span id="l1.2782" class="difflineplus">+</span>
<a href="#l1.2783"></a><span id="l1.2783" class="difflineplus">+      if (lcname in designSet.param) {</span>
<a href="#l1.2784"></a><span id="l1.2784" class="difflineplus">+        multiValue = designSet.param[lcname].multiValue;</span>
<a href="#l1.2785"></a><span id="l1.2785" class="difflineplus">+        if (designSet.param[lcname].multiValueSeparateDQuote) {</span>
<a href="#l1.2786"></a><span id="l1.2786" class="difflineplus">+          mvdelim = parser._rfc6868Escape('&quot;' + multiValue + '&quot;');</span>
<a href="#l1.2787"></a><span id="l1.2787" class="difflineplus">+        }</span>
<a href="#l1.2788"></a><span id="l1.2788" class="difflineplus">+      }</span>
<a href="#l1.2789"></a><span id="l1.2789"> </span>
<a href="#l1.2790"></a><span id="l1.2790">       var nextChar = line[pos + 1];</span>
<a href="#l1.2791"></a><span id="l1.2791">       if (nextChar === '&quot;') {</span>
<a href="#l1.2792"></a><span id="l1.2792" class="difflineminus">-        var valuePos = pos + 2;</span>
<a href="#l1.2793"></a><span id="l1.2793" class="difflineplus">+        valuePos = pos + 2;</span>
<a href="#l1.2794"></a><span id="l1.2794">         pos = helpers.unescapedIndexOf(line, '&quot;', valuePos);</span>
<a href="#l1.2795"></a><span id="l1.2795" class="difflineplus">+        if (multiValue &amp;&amp; pos != -1) {</span>
<a href="#l1.2796"></a><span id="l1.2796" class="difflineplus">+            var extendedValue = true;</span>
<a href="#l1.2797"></a><span id="l1.2797" class="difflineplus">+            while (extendedValue) {</span>
<a href="#l1.2798"></a><span id="l1.2798" class="difflineplus">+              if (line[pos + 1] == multiValue &amp;&amp; line[pos + 2] == '&quot;') {</span>
<a href="#l1.2799"></a><span id="l1.2799" class="difflineplus">+                pos = helpers.unescapedIndexOf(line, '&quot;', pos + 3);</span>
<a href="#l1.2800"></a><span id="l1.2800" class="difflineplus">+              } else {</span>
<a href="#l1.2801"></a><span id="l1.2801" class="difflineplus">+                extendedValue = false;</span>
<a href="#l1.2802"></a><span id="l1.2802" class="difflineplus">+              }</span>
<a href="#l1.2803"></a><span id="l1.2803" class="difflineplus">+            }</span>
<a href="#l1.2804"></a><span id="l1.2804" class="difflineplus">+          }</span>
<a href="#l1.2805"></a><span id="l1.2805" class="difflineplus">+        if (pos === -1) {</span>
<a href="#l1.2806"></a><span id="l1.2806" class="difflineplus">+          throw new ParserError(</span>
<a href="#l1.2807"></a><span id="l1.2807" class="difflineplus">+            'invalid line (no matching double quote) &quot;' + line + '&quot;'</span>
<a href="#l1.2808"></a><span id="l1.2808" class="difflineplus">+          );</span>
<a href="#l1.2809"></a><span id="l1.2809" class="difflineplus">+        }</span>
<a href="#l1.2810"></a><span id="l1.2810">         value = line.substr(valuePos, pos - valuePos);</span>
<a href="#l1.2811"></a><span id="l1.2811">         lastParam = helpers.unescapedIndexOf(line, PARAM_DELIMITER, pos);</span>
<a href="#l1.2812"></a><span id="l1.2812" class="difflineplus">+        if (lastParam === -1) {</span>
<a href="#l1.2813"></a><span id="l1.2813" class="difflineplus">+          pos = false;</span>
<a href="#l1.2814"></a><span id="l1.2814" class="difflineplus">+        }</span>
<a href="#l1.2815"></a><span id="l1.2815">       } else {</span>
<a href="#l1.2816"></a><span id="l1.2816" class="difflineminus">-        var valuePos = pos + 1;</span>
<a href="#l1.2817"></a><span id="l1.2817" class="difflineplus">+        valuePos = pos + 1;</span>
<a href="#l1.2818"></a><span id="l1.2818"> </span>
<a href="#l1.2819"></a><span id="l1.2819">         // move to next &quot;;&quot;</span>
<a href="#l1.2820"></a><span id="l1.2820">         var nextPos = helpers.unescapedIndexOf(line, PARAM_DELIMITER, valuePos);</span>
<a href="#l1.2821"></a><span id="l1.2821" class="difflineminus">-        if (nextPos === -1) {</span>
<a href="#l1.2822"></a><span id="l1.2822" class="difflineminus">-          // when there is no &quot;;&quot; attempt to locate &quot;:&quot;</span>
<a href="#l1.2823"></a><span id="l1.2823" class="difflineminus">-          nextPos = helpers.unescapedIndexOf(line, VALUE_DELIMITER, valuePos);</span>
<a href="#l1.2824"></a><span id="l1.2824" class="difflineminus">-</span>
<a href="#l1.2825"></a><span id="l1.2825" class="difflineminus">-          if (nextPos === -1) {</span>
<a href="#l1.2826"></a><span id="l1.2826" class="difflineplus">+        var propValuePos = helpers.unescapedIndexOf(line, VALUE_DELIMITER, valuePos);</span>
<a href="#l1.2827"></a><span id="l1.2827" class="difflineplus">+        if (propValuePos !== -1 &amp;&amp; nextPos &gt; propValuePos) {</span>
<a href="#l1.2828"></a><span id="l1.2828" class="difflineplus">+          // this is a delimiter in the property value, let's stop here</span>
<a href="#l1.2829"></a><span id="l1.2829" class="difflineplus">+          nextPos = propValuePos;</span>
<a href="#l1.2830"></a><span id="l1.2830" class="difflineplus">+          pos = false;</span>
<a href="#l1.2831"></a><span id="l1.2831" class="difflineplus">+        } else if (nextPos === -1) {</span>
<a href="#l1.2832"></a><span id="l1.2832" class="difflineplus">+          // no &quot;;&quot;</span>
<a href="#l1.2833"></a><span id="l1.2833" class="difflineplus">+          if (propValuePos === -1) {</span>
<a href="#l1.2834"></a><span id="l1.2834">             nextPos = line.length;</span>
<a href="#l1.2835"></a><span id="l1.2835" class="difflineplus">+          } else {</span>
<a href="#l1.2836"></a><span id="l1.2836" class="difflineplus">+            nextPos = propValuePos;</span>
<a href="#l1.2837"></a><span id="l1.2837">           }</span>
<a href="#l1.2838"></a><span id="l1.2838">           pos = false;</span>
<a href="#l1.2839"></a><span id="l1.2839">         } else {</span>
<a href="#l1.2840"></a><span id="l1.2840">           lastParam = nextPos;</span>
<a href="#l1.2841"></a><span id="l1.2841" class="difflineplus">+          pos = nextPos;</span>
<a href="#l1.2842"></a><span id="l1.2842">         }</span>
<a href="#l1.2843"></a><span id="l1.2843"> </span>
<a href="#l1.2844"></a><span id="l1.2844">         value = line.substr(valuePos, nextPos - valuePos);</span>
<a href="#l1.2845"></a><span id="l1.2845">       }</span>
<a href="#l1.2846"></a><span id="l1.2846"> </span>
<a href="#l1.2847"></a><span id="l1.2847" class="difflineminus">-      if (name in design.param &amp;&amp; design.param[name].valueType) {</span>
<a href="#l1.2848"></a><span id="l1.2848" class="difflineminus">-        type = design.param[name].valueType;</span>
<a href="#l1.2849"></a><span id="l1.2849" class="difflineplus">+      value = parser._rfc6868Escape(value);</span>
<a href="#l1.2850"></a><span id="l1.2850" class="difflineplus">+      if (multiValue) {</span>
<a href="#l1.2851"></a><span id="l1.2851" class="difflineplus">+        var delimiter = mvdelim || multiValue;</span>
<a href="#l1.2852"></a><span id="l1.2852" class="difflineplus">+        result[lcname] = parser._parseMultiValue(value, delimiter, type, [], null, designSet);</span>
<a href="#l1.2853"></a><span id="l1.2853">       } else {</span>
<a href="#l1.2854"></a><span id="l1.2854" class="difflineminus">-        type = DEFAULT_TYPE;</span>
<a href="#l1.2855"></a><span id="l1.2855" class="difflineminus">-      }</span>
<a href="#l1.2856"></a><span id="l1.2856" class="difflineminus">-</span>
<a href="#l1.2857"></a><span id="l1.2857" class="difflineminus">-      result[name.toLowerCase()] = parser._parseValue(value, type);</span>
<a href="#l1.2858"></a><span id="l1.2858" class="difflineplus">+        result[lcname] = parser._parseValue(value, type, designSet);</span>
<a href="#l1.2859"></a><span id="l1.2859" class="difflineplus">+      }</span>
<a href="#l1.2860"></a><span id="l1.2860">     }</span>
<a href="#l1.2861"></a><span id="l1.2861">     return [result, value, valuePos];</span>
<a href="#l1.2862"></a><span id="l1.2862" class="difflineminus">-  }</span>
<a href="#l1.2863"></a><span id="l1.2863" class="difflineplus">+  };</span>
<a href="#l1.2864"></a><span id="l1.2864" class="difflineplus">+</span>
<a href="#l1.2865"></a><span id="l1.2865" class="difflineplus">+  /**</span>
<a href="#l1.2866"></a><span id="l1.2866" class="difflineplus">+   * Internal helper for rfc6868. Exposing this on ICAL.parse so that</span>
<a href="#l1.2867"></a><span id="l1.2867" class="difflineplus">+   * hackers can disable the rfc6868 parsing if the really need to.</span>
<a href="#l1.2868"></a><span id="l1.2868" class="difflineplus">+   *</span>
<a href="#l1.2869"></a><span id="l1.2869" class="difflineplus">+   * @function ICAL.parse._rfc6868Escape</span>
<a href="#l1.2870"></a><span id="l1.2870" class="difflineplus">+   * @param {String} val        The value to escape</span>
<a href="#l1.2871"></a><span id="l1.2871" class="difflineplus">+   * @return {String}           The escaped value</span>
<a href="#l1.2872"></a><span id="l1.2872" class="difflineplus">+   */</span>
<a href="#l1.2873"></a><span id="l1.2873" class="difflineplus">+  parser._rfc6868Escape = function(val) {</span>
<a href="#l1.2874"></a><span id="l1.2874" class="difflineplus">+    return val.replace(/\^['n^]/g, function(x) {</span>
<a href="#l1.2875"></a><span id="l1.2875" class="difflineplus">+      return RFC6868_REPLACE_MAP[x];</span>
<a href="#l1.2876"></a><span id="l1.2876" class="difflineplus">+    });</span>
<a href="#l1.2877"></a><span id="l1.2877" class="difflineplus">+  };</span>
<a href="#l1.2878"></a><span id="l1.2878" class="difflineplus">+  var RFC6868_REPLACE_MAP = { &quot;^'&quot;: '&quot;', &quot;^n&quot;: &quot;\n&quot;, &quot;^^&quot;: &quot;^&quot; };</span>
<a href="#l1.2879"></a><span id="l1.2879"> </span>
<a href="#l1.2880"></a><span id="l1.2880">   /**</span>
<a href="#l1.2881"></a><span id="l1.2881" class="difflineminus">-   * Parse a multi value string</span>
<a href="#l1.2882"></a><span id="l1.2882" class="difflineplus">+   * Parse a multi value string. This function is used either for parsing</span>
<a href="#l1.2883"></a><span id="l1.2883" class="difflineplus">+   * actual multi-value property's values, or for handling parameter values. It</span>
<a href="#l1.2884"></a><span id="l1.2884" class="difflineplus">+   * can be used for both multi-value properties and structured value properties.</span>
<a href="#l1.2885"></a><span id="l1.2885" class="difflineplus">+   *</span>
<a href="#l1.2886"></a><span id="l1.2886" class="difflineplus">+   * @private</span>
<a href="#l1.2887"></a><span id="l1.2887" class="difflineplus">+   * @function ICAL.parse._parseMultiValue</span>
<a href="#l1.2888"></a><span id="l1.2888" class="difflineplus">+   * @param {String} buffer     The buffer containing the full value</span>
<a href="#l1.2889"></a><span id="l1.2889" class="difflineplus">+   * @param {String} delim      The multi-value delimiter</span>
<a href="#l1.2890"></a><span id="l1.2890" class="difflineplus">+   * @param {String} type       The value type to be parsed</span>
<a href="#l1.2891"></a><span id="l1.2891" class="difflineplus">+   * @param {Array.&lt;?&gt;} result        The array to append results to, varies on value type</span>
<a href="#l1.2892"></a><span id="l1.2892" class="difflineplus">+   * @param {String} innerMulti The inner delimiter to split each value with</span>
<a href="#l1.2893"></a><span id="l1.2893" class="difflineplus">+   * @param {ICAL.design.designSet} designSet   The design data for this value</span>
<a href="#l1.2894"></a><span id="l1.2894" class="difflineplus">+   * @return {?|Array.&lt;?&gt;}            Either an array of results, or the first result</span>
<a href="#l1.2895"></a><span id="l1.2895">    */</span>
<a href="#l1.2896"></a><span id="l1.2896" class="difflineminus">-  parser._parseMultiValue = function(buffer, delim, type, result) {</span>
<a href="#l1.2897"></a><span id="l1.2897" class="difflineplus">+  parser._parseMultiValue = function(buffer, delim, type, result, innerMulti, designSet, structuredValue) {</span>
<a href="#l1.2898"></a><span id="l1.2898">     var pos = 0;</span>
<a href="#l1.2899"></a><span id="l1.2899">     var lastPos = 0;</span>
<a href="#l1.2900"></a><span id="l1.2900" class="difflineplus">+    var value;</span>
<a href="#l1.2901"></a><span id="l1.2901" class="difflineplus">+    if (delim.length === 0) {</span>
<a href="#l1.2902"></a><span id="l1.2902" class="difflineplus">+      return buffer;</span>
<a href="#l1.2903"></a><span id="l1.2903" class="difflineplus">+    }</span>
<a href="#l1.2904"></a><span id="l1.2904"> </span>
<a href="#l1.2905"></a><span id="l1.2905">     // split each piece</span>
<a href="#l1.2906"></a><span id="l1.2906">     while ((pos = helpers.unescapedIndexOf(buffer, delim, lastPos)) !== -1) {</span>
<a href="#l1.2907"></a><span id="l1.2907" class="difflineminus">-      var value = buffer.substr(lastPos, pos - lastPos);</span>
<a href="#l1.2908"></a><span id="l1.2908" class="difflineminus">-      result.push(parser._parseValue(value, type));</span>
<a href="#l1.2909"></a><span id="l1.2909" class="difflineminus">-      lastPos = pos + 1;</span>
<a href="#l1.2910"></a><span id="l1.2910" class="difflineplus">+      value = buffer.substr(lastPos, pos - lastPos);</span>
<a href="#l1.2911"></a><span id="l1.2911" class="difflineplus">+      if (innerMulti) {</span>
<a href="#l1.2912"></a><span id="l1.2912" class="difflineplus">+        value = parser._parseMultiValue(value, innerMulti, type, [], null, designSet, structuredValue);</span>
<a href="#l1.2913"></a><span id="l1.2913" class="difflineplus">+      } else {</span>
<a href="#l1.2914"></a><span id="l1.2914" class="difflineplus">+        value = parser._parseValue(value, type, designSet, structuredValue);</span>
<a href="#l1.2915"></a><span id="l1.2915" class="difflineplus">+      }</span>
<a href="#l1.2916"></a><span id="l1.2916" class="difflineplus">+      result.push(value);</span>
<a href="#l1.2917"></a><span id="l1.2917" class="difflineplus">+      lastPos = pos + delim.length;</span>
<a href="#l1.2918"></a><span id="l1.2918">     }</span>
<a href="#l1.2919"></a><span id="l1.2919"> </span>
<a href="#l1.2920"></a><span id="l1.2920">     // on the last piece take the rest of string</span>
<a href="#l1.2921"></a><span id="l1.2921" class="difflineminus">-    result.push(</span>
<a href="#l1.2922"></a><span id="l1.2922" class="difflineminus">-      parser._parseValue(buffer.substr(lastPos), type)</span>
<a href="#l1.2923"></a><span id="l1.2923" class="difflineminus">-    );</span>
<a href="#l1.2924"></a><span id="l1.2924" class="difflineminus">-</span>
<a href="#l1.2925"></a><span id="l1.2925" class="difflineminus">-    return result;</span>
<a href="#l1.2926"></a><span id="l1.2926" class="difflineminus">-  }</span>
<a href="#l1.2927"></a><span id="l1.2927" class="difflineminus">-</span>
<a href="#l1.2928"></a><span id="l1.2928" class="difflineplus">+    value = buffer.substr(lastPos);</span>
<a href="#l1.2929"></a><span id="l1.2929" class="difflineplus">+    if (innerMulti) {</span>
<a href="#l1.2930"></a><span id="l1.2930" class="difflineplus">+      value = parser._parseMultiValue(value, innerMulti, type, [], null, designSet, structuredValue);</span>
<a href="#l1.2931"></a><span id="l1.2931" class="difflineplus">+    } else {</span>
<a href="#l1.2932"></a><span id="l1.2932" class="difflineplus">+      value = parser._parseValue(value, type, designSet, structuredValue);</span>
<a href="#l1.2933"></a><span id="l1.2933" class="difflineplus">+    }</span>
<a href="#l1.2934"></a><span id="l1.2934" class="difflineplus">+    result.push(value);</span>
<a href="#l1.2935"></a><span id="l1.2935" class="difflineplus">+</span>
<a href="#l1.2936"></a><span id="l1.2936" class="difflineplus">+    return result.length == 1 ? result[0] : result;</span>
<a href="#l1.2937"></a><span id="l1.2937" class="difflineplus">+  };</span>
<a href="#l1.2938"></a><span id="l1.2938" class="difflineplus">+</span>
<a href="#l1.2939"></a><span id="l1.2939" class="difflineplus">+  /**</span>
<a href="#l1.2940"></a><span id="l1.2940" class="difflineplus">+   * Process a complete buffer of iCalendar/vCard data line by line, correctly</span>
<a href="#l1.2941"></a><span id="l1.2941" class="difflineplus">+   * unfolding content. Each line will be processed with the given callback</span>
<a href="#l1.2942"></a><span id="l1.2942" class="difflineplus">+   *</span>
<a href="#l1.2943"></a><span id="l1.2943" class="difflineplus">+   * @private</span>
<a href="#l1.2944"></a><span id="l1.2944" class="difflineplus">+   * @function ICAL.parse._eachLine</span>
<a href="#l1.2945"></a><span id="l1.2945" class="difflineplus">+   * @param {String} buffer                         The buffer to process</span>
<a href="#l1.2946"></a><span id="l1.2946" class="difflineplus">+   * @param {function(?String, String)} callback    The callback for each line</span>
<a href="#l1.2947"></a><span id="l1.2947" class="difflineplus">+   */</span>
<a href="#l1.2948"></a><span id="l1.2948">   parser._eachLine = function(buffer, callback) {</span>
<a href="#l1.2949"></a><span id="l1.2949">     var len = buffer.length;</span>
<a href="#l1.2950"></a><span id="l1.2950">     var lastPos = buffer.search(CHAR);</span>
<a href="#l1.2951"></a><span id="l1.2951">     var pos = lastPos;</span>
<a href="#l1.2952"></a><span id="l1.2952">     var line;</span>
<a href="#l1.2953"></a><span id="l1.2953">     var firstChar;</span>
<a href="#l1.2954"></a><span id="l1.2954"> </span>
<a href="#l1.2955"></a><span id="l1.2955">     var newlineOffset;</span>
<a href="#l1.2956"></a><span id="l1.2956"> </span>
<a href="#l1.2957"></a><span id="l1.2957">     do {</span>
<a href="#l1.2958"></a><span id="l1.2958">       pos = buffer.indexOf('\n', lastPos) + 1;</span>
<a href="#l1.2959"></a><span id="l1.2959"> </span>
<a href="#l1.2960"></a><span id="l1.2960" class="difflineminus">-      if (buffer[pos - 2] === '\r') {</span>
<a href="#l1.2961"></a><span id="l1.2961" class="difflineplus">+      if (pos &gt; 1 &amp;&amp; buffer[pos - 2] === '\r') {</span>
<a href="#l1.2962"></a><span id="l1.2962">         newlineOffset = 2;</span>
<a href="#l1.2963"></a><span id="l1.2963">       } else {</span>
<a href="#l1.2964"></a><span id="l1.2964">         newlineOffset = 1;</span>
<a href="#l1.2965"></a><span id="l1.2965">       }</span>
<a href="#l1.2966"></a><span id="l1.2966"> </span>
<a href="#l1.2967"></a><span id="l1.2967">       if (pos === 0) {</span>
<a href="#l1.2968"></a><span id="l1.2968">         pos = len;</span>
<a href="#l1.2969"></a><span id="l1.2969">         newlineOffset = 0;</span>
<a href="#l1.2970"></a><span id="l1.2970" class="difflineat">@@ -1507,34 +2179,48 @@ ICAL.parse = (function() {</span>
<a href="#l1.2971"></a><span id="l1.2971">       lastPos = pos;</span>
<a href="#l1.2972"></a><span id="l1.2972">     } while (pos !== len);</span>
<a href="#l1.2973"></a><span id="l1.2973"> </span>
<a href="#l1.2974"></a><span id="l1.2974">     // extra ending line</span>
<a href="#l1.2975"></a><span id="l1.2975">     line = line.trim();</span>
<a href="#l1.2976"></a><span id="l1.2976"> </span>
<a href="#l1.2977"></a><span id="l1.2977">     if (line.length)</span>
<a href="#l1.2978"></a><span id="l1.2978">       callback(null, line);</span>
<a href="#l1.2979"></a><span id="l1.2979" class="difflineminus">-  }</span>
<a href="#l1.2980"></a><span id="l1.2980" class="difflineplus">+  };</span>
<a href="#l1.2981"></a><span id="l1.2981"> </span>
<a href="#l1.2982"></a><span id="l1.2982">   return parser;</span>
<a href="#l1.2983"></a><span id="l1.2983"> </span>
<a href="#l1.2984"></a><span id="l1.2984"> }());</span>
<a href="#l1.2985"></a><span id="l1.2985" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.2986"></a><span id="l1.2986" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.2987"></a><span id="l1.2987" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.2988"></a><span id="l1.2988" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.2989"></a><span id="l1.2989" class="difflineplus">+</span>
<a href="#l1.2990"></a><span id="l1.2990" class="difflineplus">+</span>
<a href="#l1.2991"></a><span id="l1.2991" class="difflineplus">+/**</span>
<a href="#l1.2992"></a><span id="l1.2992" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.2993"></a><span id="l1.2993" class="difflineplus">+ * @ignore</span>
<a href="#l1.2994"></a><span id="l1.2994" class="difflineplus">+ */</span>
<a href="#l1.2995"></a><span id="l1.2995"> ICAL.Component = (function() {</span>
<a href="#l1.2996"></a><span id="l1.2996">   'use strict';</span>
<a href="#l1.2997"></a><span id="l1.2997"> </span>
<a href="#l1.2998"></a><span id="l1.2998">   var PROPERTY_INDEX = 1;</span>
<a href="#l1.2999"></a><span id="l1.2999">   var COMPONENT_INDEX = 2;</span>
<a href="#l1.3000"></a><span id="l1.3000">   var NAME_INDEX = 0;</span>
<a href="#l1.3001"></a><span id="l1.3001"> </span>
<a href="#l1.3002"></a><span id="l1.3002">   /**</span>
<a href="#l1.3003"></a><span id="l1.3003" class="difflineminus">-   * Create a wrapper for a jCal component.</span>
<a href="#l1.3004"></a><span id="l1.3004" class="difflineminus">-   *</span>
<a href="#l1.3005"></a><span id="l1.3005" class="difflineminus">-   * @param {Array|String} jCal</span>
<a href="#l1.3006"></a><span id="l1.3006" class="difflineminus">-   *  raw jCal component data OR name of new component.</span>
<a href="#l1.3007"></a><span id="l1.3007" class="difflineminus">-   * @param {ICAL.Component} parent parent component to associate.</span>
<a href="#l1.3008"></a><span id="l1.3008" class="difflineplus">+   * @classdesc</span>
<a href="#l1.3009"></a><span id="l1.3009" class="difflineplus">+   * Wraps a jCal component, adding convenience methods to add, remove and</span>
<a href="#l1.3010"></a><span id="l1.3010" class="difflineplus">+   * update subcomponents and properties.</span>
<a href="#l1.3011"></a><span id="l1.3011" class="difflineplus">+   *</span>
<a href="#l1.3012"></a><span id="l1.3012" class="difflineplus">+   * @class</span>
<a href="#l1.3013"></a><span id="l1.3013" class="difflineplus">+   * @alias ICAL.Component</span>
<a href="#l1.3014"></a><span id="l1.3014" class="difflineplus">+   * @param {Array|String} jCal         Raw jCal component data OR name of new</span>
<a href="#l1.3015"></a><span id="l1.3015" class="difflineplus">+   *                                      component</span>
<a href="#l1.3016"></a><span id="l1.3016" class="difflineplus">+   * @param {ICAL.Component} parent     Parent component to associate</span>
<a href="#l1.3017"></a><span id="l1.3017">    */</span>
<a href="#l1.3018"></a><span id="l1.3018">   function Component(jCal, parent) {</span>
<a href="#l1.3019"></a><span id="l1.3019">     if (typeof(jCal) === 'string') {</span>
<a href="#l1.3020"></a><span id="l1.3020">       // jCal spec (name, properties, components)</span>
<a href="#l1.3021"></a><span id="l1.3021">       jCal = [jCal, [], []];</span>
<a href="#l1.3022"></a><span id="l1.3022">     }</span>
<a href="#l1.3023"></a><span id="l1.3023"> </span>
<a href="#l1.3024"></a><span id="l1.3024">     // mostly for legacy reasons.</span>
<a href="#l1.3025"></a><span id="l1.3025" class="difflineat">@@ -1545,45 +2231,66 @@ ICAL.Component = (function() {</span>
<a href="#l1.3026"></a><span id="l1.3026"> </span>
<a href="#l1.3027"></a><span id="l1.3027">   Component.prototype = {</span>
<a href="#l1.3028"></a><span id="l1.3028">     /**</span>
<a href="#l1.3029"></a><span id="l1.3029">      * Hydrated properties are inserted into the _properties array at the same</span>
<a href="#l1.3030"></a><span id="l1.3030">      * position as in the jCal array, so its possible the array contains</span>
<a href="#l1.3031"></a><span id="l1.3031">      * undefined values for unhydrdated properties. To avoid iterating the</span>
<a href="#l1.3032"></a><span id="l1.3032">      * array when checking if all properties have been hydrated, we save the</span>
<a href="#l1.3033"></a><span id="l1.3033">      * count here.</span>
<a href="#l1.3034"></a><span id="l1.3034" class="difflineplus">+     *</span>
<a href="#l1.3035"></a><span id="l1.3035" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.3036"></a><span id="l1.3036" class="difflineplus">+     * @private</span>
<a href="#l1.3037"></a><span id="l1.3037">      */</span>
<a href="#l1.3038"></a><span id="l1.3038">     _hydratedPropertyCount: 0,</span>
<a href="#l1.3039"></a><span id="l1.3039"> </span>
<a href="#l1.3040"></a><span id="l1.3040">     /**</span>
<a href="#l1.3041"></a><span id="l1.3041">      * The same count as for _hydratedPropertyCount, but for subcomponents</span>
<a href="#l1.3042"></a><span id="l1.3042" class="difflineplus">+     *</span>
<a href="#l1.3043"></a><span id="l1.3043" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.3044"></a><span id="l1.3044" class="difflineplus">+     * @private</span>
<a href="#l1.3045"></a><span id="l1.3045">      */</span>
<a href="#l1.3046"></a><span id="l1.3046">     _hydratedComponentCount: 0,</span>
<a href="#l1.3047"></a><span id="l1.3047"> </span>
<a href="#l1.3048"></a><span id="l1.3048" class="difflineplus">+    /**</span>
<a href="#l1.3049"></a><span id="l1.3049" class="difflineplus">+     * The name of this component</span>
<a href="#l1.3050"></a><span id="l1.3050" class="difflineplus">+     * @readonly</span>
<a href="#l1.3051"></a><span id="l1.3051" class="difflineplus">+     */</span>
<a href="#l1.3052"></a><span id="l1.3052">     get name() {</span>
<a href="#l1.3053"></a><span id="l1.3053">       return this.jCal[NAME_INDEX];</span>
<a href="#l1.3054"></a><span id="l1.3054">     },</span>
<a href="#l1.3055"></a><span id="l1.3055"> </span>
<a href="#l1.3056"></a><span id="l1.3056" class="difflineplus">+    /**</span>
<a href="#l1.3057"></a><span id="l1.3057" class="difflineplus">+     * The design set for this component, e.g. icalendar vs vcard</span>
<a href="#l1.3058"></a><span id="l1.3058" class="difflineplus">+     *</span>
<a href="#l1.3059"></a><span id="l1.3059" class="difflineplus">+     * @type {ICAL.design.designSet}</span>
<a href="#l1.3060"></a><span id="l1.3060" class="difflineplus">+     * @private</span>
<a href="#l1.3061"></a><span id="l1.3061" class="difflineplus">+     */</span>
<a href="#l1.3062"></a><span id="l1.3062" class="difflineplus">+    get _designSet() {</span>
<a href="#l1.3063"></a><span id="l1.3063" class="difflineplus">+      var parentDesign = this.parent &amp;&amp; this.parent._designSet;</span>
<a href="#l1.3064"></a><span id="l1.3064" class="difflineplus">+      return parentDesign || ICAL.design.getDesignSet(this.name);</span>
<a href="#l1.3065"></a><span id="l1.3065" class="difflineplus">+    },</span>
<a href="#l1.3066"></a><span id="l1.3066" class="difflineplus">+</span>
<a href="#l1.3067"></a><span id="l1.3067">     _hydrateComponent: function(index) {</span>
<a href="#l1.3068"></a><span id="l1.3068">       if (!this._components) {</span>
<a href="#l1.3069"></a><span id="l1.3069">         this._components = [];</span>
<a href="#l1.3070"></a><span id="l1.3070">         this._hydratedComponentCount = 0;</span>
<a href="#l1.3071"></a><span id="l1.3071">       }</span>
<a href="#l1.3072"></a><span id="l1.3072"> </span>
<a href="#l1.3073"></a><span id="l1.3073">       if (this._components[index]) {</span>
<a href="#l1.3074"></a><span id="l1.3074">         return this._components[index];</span>
<a href="#l1.3075"></a><span id="l1.3075">       }</span>
<a href="#l1.3076"></a><span id="l1.3076"> </span>
<a href="#l1.3077"></a><span id="l1.3077">       var comp = new Component(</span>
<a href="#l1.3078"></a><span id="l1.3078">         this.jCal[COMPONENT_INDEX][index],</span>
<a href="#l1.3079"></a><span id="l1.3079">         this</span>
<a href="#l1.3080"></a><span id="l1.3080">       );</span>
<a href="#l1.3081"></a><span id="l1.3081"> </span>
<a href="#l1.3082"></a><span id="l1.3082">       this._hydratedComponentCount++;</span>
<a href="#l1.3083"></a><span id="l1.3083" class="difflineminus">-      return this._components[index] = comp;</span>
<a href="#l1.3084"></a><span id="l1.3084" class="difflineplus">+      return (this._components[index] = comp);</span>
<a href="#l1.3085"></a><span id="l1.3085">     },</span>
<a href="#l1.3086"></a><span id="l1.3086"> </span>
<a href="#l1.3087"></a><span id="l1.3087">     _hydrateProperty: function(index) {</span>
<a href="#l1.3088"></a><span id="l1.3088">       if (!this._properties) {</span>
<a href="#l1.3089"></a><span id="l1.3089">         this._properties = [];</span>
<a href="#l1.3090"></a><span id="l1.3090">         this._hydratedPropertyCount = 0;</span>
<a href="#l1.3091"></a><span id="l1.3091">       }</span>
<a href="#l1.3092"></a><span id="l1.3092"> </span>
<a href="#l1.3093"></a><span id="l1.3093" class="difflineat">@@ -1592,24 +2299,24 @@ ICAL.Component = (function() {</span>
<a href="#l1.3094"></a><span id="l1.3094">       }</span>
<a href="#l1.3095"></a><span id="l1.3095"> </span>
<a href="#l1.3096"></a><span id="l1.3096">       var prop = new ICAL.Property(</span>
<a href="#l1.3097"></a><span id="l1.3097">         this.jCal[PROPERTY_INDEX][index],</span>
<a href="#l1.3098"></a><span id="l1.3098">         this</span>
<a href="#l1.3099"></a><span id="l1.3099">       );</span>
<a href="#l1.3100"></a><span id="l1.3100"> </span>
<a href="#l1.3101"></a><span id="l1.3101">       this._hydratedPropertyCount++;</span>
<a href="#l1.3102"></a><span id="l1.3102" class="difflineminus">-      return this._properties[index] = prop;</span>
<a href="#l1.3103"></a><span id="l1.3103" class="difflineplus">+      return (this._properties[index] = prop);</span>
<a href="#l1.3104"></a><span id="l1.3104">     },</span>
<a href="#l1.3105"></a><span id="l1.3105"> </span>
<a href="#l1.3106"></a><span id="l1.3106">     /**</span>
<a href="#l1.3107"></a><span id="l1.3107">      * Finds first sub component, optionally filtered by name.</span>
<a href="#l1.3108"></a><span id="l1.3108">      *</span>
<a href="#l1.3109"></a><span id="l1.3109" class="difflineminus">-     * @method getFirstSubcomponent</span>
<a href="#l1.3110"></a><span id="l1.3110" class="difflineminus">-     * @param {String} [name] optional name to filter by.</span>
<a href="#l1.3111"></a><span id="l1.3111" class="difflineplus">+     * @param {String=} name        Optional name to filter by</span>
<a href="#l1.3112"></a><span id="l1.3112" class="difflineplus">+     * @return {?ICAL.Component}     The found subcomponent</span>
<a href="#l1.3113"></a><span id="l1.3113">      */</span>
<a href="#l1.3114"></a><span id="l1.3114">     getFirstSubcomponent: function(name) {</span>
<a href="#l1.3115"></a><span id="l1.3115">       if (name) {</span>
<a href="#l1.3116"></a><span id="l1.3116">         var i = 0;</span>
<a href="#l1.3117"></a><span id="l1.3117">         var comps = this.jCal[COMPONENT_INDEX];</span>
<a href="#l1.3118"></a><span id="l1.3118">         var len = comps.length;</span>
<a href="#l1.3119"></a><span id="l1.3119"> </span>
<a href="#l1.3120"></a><span id="l1.3120">         for (; i &lt; len; i++) {</span>
<a href="#l1.3121"></a><span id="l1.3121" class="difflineat">@@ -1626,53 +2333,52 @@ ICAL.Component = (function() {</span>
<a href="#l1.3122"></a><span id="l1.3122"> </span>
<a href="#l1.3123"></a><span id="l1.3123">       // ensure we return a value (strict mode)</span>
<a href="#l1.3124"></a><span id="l1.3124">       return null;</span>
<a href="#l1.3125"></a><span id="l1.3125">     },</span>
<a href="#l1.3126"></a><span id="l1.3126"> </span>
<a href="#l1.3127"></a><span id="l1.3127">     /**</span>
<a href="#l1.3128"></a><span id="l1.3128">      * Finds all sub components, optionally filtering by name.</span>
<a href="#l1.3129"></a><span id="l1.3129">      *</span>
<a href="#l1.3130"></a><span id="l1.3130" class="difflineminus">-     * @method getAllSubcomponents</span>
<a href="#l1.3131"></a><span id="l1.3131" class="difflineminus">-     * @param {String} [name] optional name to filter by.</span>
<a href="#l1.3132"></a><span id="l1.3132" class="difflineplus">+     * @param {String=} name            Optional name to filter by</span>
<a href="#l1.3133"></a><span id="l1.3133" class="difflineplus">+     * @return {ICAL.Component[]}       The found sub components</span>
<a href="#l1.3134"></a><span id="l1.3134">      */</span>
<a href="#l1.3135"></a><span id="l1.3135">     getAllSubcomponents: function(name) {</span>
<a href="#l1.3136"></a><span id="l1.3136">       var jCalLen = this.jCal[COMPONENT_INDEX].length;</span>
<a href="#l1.3137"></a><span id="l1.3137" class="difflineplus">+      var i = 0;</span>
<a href="#l1.3138"></a><span id="l1.3138"> </span>
<a href="#l1.3139"></a><span id="l1.3139">       if (name) {</span>
<a href="#l1.3140"></a><span id="l1.3140">         var comps = this.jCal[COMPONENT_INDEX];</span>
<a href="#l1.3141"></a><span id="l1.3141">         var result = [];</span>
<a href="#l1.3142"></a><span id="l1.3142" class="difflineminus">-        var i = 0;</span>
<a href="#l1.3143"></a><span id="l1.3143"> </span>
<a href="#l1.3144"></a><span id="l1.3144">         for (; i &lt; jCalLen; i++) {</span>
<a href="#l1.3145"></a><span id="l1.3145">           if (name === comps[i][NAME_INDEX]) {</span>
<a href="#l1.3146"></a><span id="l1.3146">             result.push(</span>
<a href="#l1.3147"></a><span id="l1.3147">               this._hydrateComponent(i)</span>
<a href="#l1.3148"></a><span id="l1.3148">             );</span>
<a href="#l1.3149"></a><span id="l1.3149">           }</span>
<a href="#l1.3150"></a><span id="l1.3150">         }</span>
<a href="#l1.3151"></a><span id="l1.3151">         return result;</span>
<a href="#l1.3152"></a><span id="l1.3152">       } else {</span>
<a href="#l1.3153"></a><span id="l1.3153">         if (!this._components ||</span>
<a href="#l1.3154"></a><span id="l1.3154">             (this._hydratedComponentCount !== jCalLen)) {</span>
<a href="#l1.3155"></a><span id="l1.3155" class="difflineminus">-          var i = 0;</span>
<a href="#l1.3156"></a><span id="l1.3156">           for (; i &lt; jCalLen; i++) {</span>
<a href="#l1.3157"></a><span id="l1.3157">             this._hydrateComponent(i);</span>
<a href="#l1.3158"></a><span id="l1.3158">           }</span>
<a href="#l1.3159"></a><span id="l1.3159">         }</span>
<a href="#l1.3160"></a><span id="l1.3160"> </span>
<a href="#l1.3161"></a><span id="l1.3161" class="difflineminus">-        return this._components;</span>
<a href="#l1.3162"></a><span id="l1.3162" class="difflineplus">+        return this._components || [];</span>
<a href="#l1.3163"></a><span id="l1.3163">       }</span>
<a href="#l1.3164"></a><span id="l1.3164">     },</span>
<a href="#l1.3165"></a><span id="l1.3165"> </span>
<a href="#l1.3166"></a><span id="l1.3166">     /**</span>
<a href="#l1.3167"></a><span id="l1.3167">      * Returns true when a named property exists.</span>
<a href="#l1.3168"></a><span id="l1.3168">      *</span>
<a href="#l1.3169"></a><span id="l1.3169" class="difflineminus">-     * @param {String} name property name.</span>
<a href="#l1.3170"></a><span id="l1.3170" class="difflineminus">-     * @return {Boolean} true when property is found.</span>
<a href="#l1.3171"></a><span id="l1.3171" class="difflineplus">+     * @param {String} name     The property name</span>
<a href="#l1.3172"></a><span id="l1.3172" class="difflineplus">+     * @return {Boolean}        True, when property is found</span>
<a href="#l1.3173"></a><span id="l1.3173">      */</span>
<a href="#l1.3174"></a><span id="l1.3174">     hasProperty: function(name) {</span>
<a href="#l1.3175"></a><span id="l1.3175">       var props = this.jCal[PROPERTY_INDEX];</span>
<a href="#l1.3176"></a><span id="l1.3176">       var len = props.length;</span>
<a href="#l1.3177"></a><span id="l1.3177"> </span>
<a href="#l1.3178"></a><span id="l1.3178">       var i = 0;</span>
<a href="#l1.3179"></a><span id="l1.3179">       for (; i &lt; len; i++) {</span>
<a href="#l1.3180"></a><span id="l1.3180">         // 0 is property name</span>
<a href="#l1.3181"></a><span id="l1.3181" class="difflineat">@@ -1680,20 +2386,20 @@ ICAL.Component = (function() {</span>
<a href="#l1.3182"></a><span id="l1.3182">           return true;</span>
<a href="#l1.3183"></a><span id="l1.3183">         }</span>
<a href="#l1.3184"></a><span id="l1.3184">       }</span>
<a href="#l1.3185"></a><span id="l1.3185"> </span>
<a href="#l1.3186"></a><span id="l1.3186">       return false;</span>
<a href="#l1.3187"></a><span id="l1.3187">     },</span>
<a href="#l1.3188"></a><span id="l1.3188"> </span>
<a href="#l1.3189"></a><span id="l1.3189">     /**</span>
<a href="#l1.3190"></a><span id="l1.3190" class="difflineminus">-     * Finds first property.</span>
<a href="#l1.3191"></a><span id="l1.3191" class="difflineminus">-     *</span>
<a href="#l1.3192"></a><span id="l1.3192" class="difflineminus">-     * @param {String} [name] lowercase name of property.</span>
<a href="#l1.3193"></a><span id="l1.3193" class="difflineminus">-     * @return {ICAL.Property} found property.</span>
<a href="#l1.3194"></a><span id="l1.3194" class="difflineplus">+     * Finds the first property, optionally with the given name.</span>
<a href="#l1.3195"></a><span id="l1.3195" class="difflineplus">+     *</span>
<a href="#l1.3196"></a><span id="l1.3196" class="difflineplus">+     * @param {String=} name        Lowercase property name</span>
<a href="#l1.3197"></a><span id="l1.3197" class="difflineplus">+     * @return {?ICAL.Property}     The found property</span>
<a href="#l1.3198"></a><span id="l1.3198">      */</span>
<a href="#l1.3199"></a><span id="l1.3199">     getFirstProperty: function(name) {</span>
<a href="#l1.3200"></a><span id="l1.3200">       if (name) {</span>
<a href="#l1.3201"></a><span id="l1.3201">         var i = 0;</span>
<a href="#l1.3202"></a><span id="l1.3202">         var props = this.jCal[PROPERTY_INDEX];</span>
<a href="#l1.3203"></a><span id="l1.3203">         var len = props.length;</span>
<a href="#l1.3204"></a><span id="l1.3204"> </span>
<a href="#l1.3205"></a><span id="l1.3205">         for (; i &lt; len; i++) {</span>
<a href="#l1.3206"></a><span id="l1.3206" class="difflineat">@@ -1707,76 +2413,75 @@ ICAL.Component = (function() {</span>
<a href="#l1.3207"></a><span id="l1.3207">           return this._hydrateProperty(0);</span>
<a href="#l1.3208"></a><span id="l1.3208">         }</span>
<a href="#l1.3209"></a><span id="l1.3209">       }</span>
<a href="#l1.3210"></a><span id="l1.3210"> </span>
<a href="#l1.3211"></a><span id="l1.3211">       return null;</span>
<a href="#l1.3212"></a><span id="l1.3212">     },</span>
<a href="#l1.3213"></a><span id="l1.3213"> </span>
<a href="#l1.3214"></a><span id="l1.3214">     /**</span>
<a href="#l1.3215"></a><span id="l1.3215" class="difflineminus">-     * Returns first properties value if available.</span>
<a href="#l1.3216"></a><span id="l1.3216" class="difflineminus">-     *</span>
<a href="#l1.3217"></a><span id="l1.3217" class="difflineminus">-     * @param {String} [name] (lowecase) property name.</span>
<a href="#l1.3218"></a><span id="l1.3218" class="difflineminus">-     * @return {String} property value.</span>
<a href="#l1.3219"></a><span id="l1.3219" class="difflineplus">+     * Returns first property's value, if available.</span>
<a href="#l1.3220"></a><span id="l1.3220" class="difflineplus">+     *</span>
<a href="#l1.3221"></a><span id="l1.3221" class="difflineplus">+     * @param {String=} name    Lowercase property name</span>
<a href="#l1.3222"></a><span id="l1.3222" class="difflineplus">+     * @return {?String}        The found property value.</span>
<a href="#l1.3223"></a><span id="l1.3223">      */</span>
<a href="#l1.3224"></a><span id="l1.3224">     getFirstPropertyValue: function(name) {</span>
<a href="#l1.3225"></a><span id="l1.3225">       var prop = this.getFirstProperty(name);</span>
<a href="#l1.3226"></a><span id="l1.3226">       if (prop) {</span>
<a href="#l1.3227"></a><span id="l1.3227">         return prop.getFirstValue();</span>
<a href="#l1.3228"></a><span id="l1.3228">       }</span>
<a href="#l1.3229"></a><span id="l1.3229"> </span>
<a href="#l1.3230"></a><span id="l1.3230">       return null;</span>
<a href="#l1.3231"></a><span id="l1.3231">     },</span>
<a href="#l1.3232"></a><span id="l1.3232"> </span>
<a href="#l1.3233"></a><span id="l1.3233">     /**</span>
<a href="#l1.3234"></a><span id="l1.3234" class="difflineminus">-     * get all properties in the component.</span>
<a href="#l1.3235"></a><span id="l1.3235" class="difflineminus">-     *</span>
<a href="#l1.3236"></a><span id="l1.3236" class="difflineminus">-     * @param {String} [name] (lowercase) property name.</span>
<a href="#l1.3237"></a><span id="l1.3237" class="difflineminus">-     * @return {Array[ICAL.Property]} list of properties.</span>
<a href="#l1.3238"></a><span id="l1.3238" class="difflineplus">+     * Get all properties in the component, optionally filtered by name.</span>
<a href="#l1.3239"></a><span id="l1.3239" class="difflineplus">+     *</span>
<a href="#l1.3240"></a><span id="l1.3240" class="difflineplus">+     * @param {String=} name        Lowercase property name</span>
<a href="#l1.3241"></a><span id="l1.3241" class="difflineplus">+     * @return {ICAL.Property[]}    List of properties</span>
<a href="#l1.3242"></a><span id="l1.3242">      */</span>
<a href="#l1.3243"></a><span id="l1.3243">     getAllProperties: function(name) {</span>
<a href="#l1.3244"></a><span id="l1.3244">       var jCalLen = this.jCal[PROPERTY_INDEX].length;</span>
<a href="#l1.3245"></a><span id="l1.3245" class="difflineplus">+      var i = 0;</span>
<a href="#l1.3246"></a><span id="l1.3246"> </span>
<a href="#l1.3247"></a><span id="l1.3247">       if (name) {</span>
<a href="#l1.3248"></a><span id="l1.3248">         var props = this.jCal[PROPERTY_INDEX];</span>
<a href="#l1.3249"></a><span id="l1.3249">         var result = [];</span>
<a href="#l1.3250"></a><span id="l1.3250" class="difflineminus">-        var i = 0;</span>
<a href="#l1.3251"></a><span id="l1.3251"> </span>
<a href="#l1.3252"></a><span id="l1.3252">         for (; i &lt; jCalLen; i++) {</span>
<a href="#l1.3253"></a><span id="l1.3253">           if (name === props[i][NAME_INDEX]) {</span>
<a href="#l1.3254"></a><span id="l1.3254">             result.push(</span>
<a href="#l1.3255"></a><span id="l1.3255">               this._hydrateProperty(i)</span>
<a href="#l1.3256"></a><span id="l1.3256">             );</span>
<a href="#l1.3257"></a><span id="l1.3257">           }</span>
<a href="#l1.3258"></a><span id="l1.3258">         }</span>
<a href="#l1.3259"></a><span id="l1.3259">         return result;</span>
<a href="#l1.3260"></a><span id="l1.3260">       } else {</span>
<a href="#l1.3261"></a><span id="l1.3261">         if (!this._properties ||</span>
<a href="#l1.3262"></a><span id="l1.3262">             (this._hydratedPropertyCount !== jCalLen)) {</span>
<a href="#l1.3263"></a><span id="l1.3263" class="difflineminus">-          var i = 0;</span>
<a href="#l1.3264"></a><span id="l1.3264">           for (; i &lt; jCalLen; i++) {</span>
<a href="#l1.3265"></a><span id="l1.3265">             this._hydrateProperty(i);</span>
<a href="#l1.3266"></a><span id="l1.3266">           }</span>
<a href="#l1.3267"></a><span id="l1.3267">         }</span>
<a href="#l1.3268"></a><span id="l1.3268"> </span>
<a href="#l1.3269"></a><span id="l1.3269" class="difflineminus">-        return this._properties;</span>
<a href="#l1.3270"></a><span id="l1.3270" class="difflineminus">-      }</span>
<a href="#l1.3271"></a><span id="l1.3271" class="difflineminus">-</span>
<a href="#l1.3272"></a><span id="l1.3272" class="difflineminus">-      return null;</span>
<a href="#l1.3273"></a><span id="l1.3273" class="difflineplus">+        return this._properties || [];</span>
<a href="#l1.3274"></a><span id="l1.3274" class="difflineplus">+      }</span>
<a href="#l1.3275"></a><span id="l1.3275">     },</span>
<a href="#l1.3276"></a><span id="l1.3276"> </span>
<a href="#l1.3277"></a><span id="l1.3277">     _removeObjectByIndex: function(jCalIndex, cache, index) {</span>
<a href="#l1.3278"></a><span id="l1.3278" class="difflineplus">+      cache = cache || [];</span>
<a href="#l1.3279"></a><span id="l1.3279">       // remove cached version</span>
<a href="#l1.3280"></a><span id="l1.3280" class="difflineminus">-      if (cache &amp;&amp; cache[index]) {</span>
<a href="#l1.3281"></a><span id="l1.3281" class="difflineplus">+      if (cache[index]) {</span>
<a href="#l1.3282"></a><span id="l1.3282">         var obj = cache[index];</span>
<a href="#l1.3283"></a><span id="l1.3283">         if (&quot;parent&quot; in obj) {</span>
<a href="#l1.3284"></a><span id="l1.3284">             obj.parent = null;</span>
<a href="#l1.3285"></a><span id="l1.3285">         }</span>
<a href="#l1.3286"></a><span id="l1.3286" class="difflineminus">-        cache.splice(index, 1);</span>
<a href="#l1.3287"></a><span id="l1.3287" class="difflineminus">-      }</span>
<a href="#l1.3288"></a><span id="l1.3288" class="difflineplus">+      }</span>
<a href="#l1.3289"></a><span id="l1.3289" class="difflineplus">+</span>
<a href="#l1.3290"></a><span id="l1.3290" class="difflineplus">+      cache.splice(index, 1);</span>
<a href="#l1.3291"></a><span id="l1.3291"> </span>
<a href="#l1.3292"></a><span id="l1.3292">       // remove it from the jCal</span>
<a href="#l1.3293"></a><span id="l1.3293">       this.jCal[jCalIndex].splice(index, 1);</span>
<a href="#l1.3294"></a><span id="l1.3294">     },</span>
<a href="#l1.3295"></a><span id="l1.3295"> </span>
<a href="#l1.3296"></a><span id="l1.3296">     _removeObject: function(jCalIndex, cache, nameOrObject) {</span>
<a href="#l1.3297"></a><span id="l1.3297">       var i = 0;</span>
<a href="#l1.3298"></a><span id="l1.3298">       var objects = this.jCal[jCalIndex];</span>
<a href="#l1.3299"></a><span id="l1.3299" class="difflineat">@@ -1817,274 +2522,376 @@ ICAL.Component = (function() {</span>
<a href="#l1.3300"></a><span id="l1.3300">           this._removeObjectByIndex(jCalIndex, cached, i);</span>
<a href="#l1.3301"></a><span id="l1.3301">         }</span>
<a href="#l1.3302"></a><span id="l1.3302">       }</span>
<a href="#l1.3303"></a><span id="l1.3303">     },</span>
<a href="#l1.3304"></a><span id="l1.3304"> </span>
<a href="#l1.3305"></a><span id="l1.3305">     /**</span>
<a href="#l1.3306"></a><span id="l1.3306">      * Adds a single sub component.</span>
<a href="#l1.3307"></a><span id="l1.3307">      *</span>
<a href="#l1.3308"></a><span id="l1.3308" class="difflineminus">-     * @param {ICAL.Component} component to add.</span>
<a href="#l1.3309"></a><span id="l1.3309" class="difflineplus">+     * @param {ICAL.Component} component        The component to add</span>
<a href="#l1.3310"></a><span id="l1.3310" class="difflineplus">+     * @return {ICAL.Component}                 The passed in component</span>
<a href="#l1.3311"></a><span id="l1.3311">      */</span>
<a href="#l1.3312"></a><span id="l1.3312">     addSubcomponent: function(component) {</span>
<a href="#l1.3313"></a><span id="l1.3313">       if (!this._components) {</span>
<a href="#l1.3314"></a><span id="l1.3314">         this._components = [];</span>
<a href="#l1.3315"></a><span id="l1.3315">         this._hydratedComponentCount = 0;</span>
<a href="#l1.3316"></a><span id="l1.3316">       }</span>
<a href="#l1.3317"></a><span id="l1.3317"> </span>
<a href="#l1.3318"></a><span id="l1.3318">       if (component.parent) {</span>
<a href="#l1.3319"></a><span id="l1.3319">         component.parent.removeSubcomponent(component);</span>
<a href="#l1.3320"></a><span id="l1.3320">       }</span>
<a href="#l1.3321"></a><span id="l1.3321"> </span>
<a href="#l1.3322"></a><span id="l1.3322">       var idx = this.jCal[COMPONENT_INDEX].push(component.jCal);</span>
<a href="#l1.3323"></a><span id="l1.3323">       this._components[idx - 1] = component;</span>
<a href="#l1.3324"></a><span id="l1.3324">       this._hydratedComponentCount++;</span>
<a href="#l1.3325"></a><span id="l1.3325">       component.parent = this;</span>
<a href="#l1.3326"></a><span id="l1.3326" class="difflineminus">-    },</span>
<a href="#l1.3327"></a><span id="l1.3327" class="difflineminus">-</span>
<a href="#l1.3328"></a><span id="l1.3328" class="difflineminus">-    /**</span>
<a href="#l1.3329"></a><span id="l1.3329" class="difflineminus">-     * Removes a single component by name or</span>
<a href="#l1.3330"></a><span id="l1.3330" class="difflineminus">-     * the instance of a specific component.</span>
<a href="#l1.3331"></a><span id="l1.3331" class="difflineminus">-     *</span>
<a href="#l1.3332"></a><span id="l1.3332" class="difflineminus">-     * @param {ICAL.Component|String} nameOrComp comp type.</span>
<a href="#l1.3333"></a><span id="l1.3333" class="difflineminus">-     * @return {Boolean} true when comp is removed.</span>
<a href="#l1.3334"></a><span id="l1.3334" class="difflineplus">+      return component;</span>
<a href="#l1.3335"></a><span id="l1.3335" class="difflineplus">+    },</span>
<a href="#l1.3336"></a><span id="l1.3336" class="difflineplus">+</span>
<a href="#l1.3337"></a><span id="l1.3337" class="difflineplus">+    /**</span>
<a href="#l1.3338"></a><span id="l1.3338" class="difflineplus">+     * Removes a single component by name or the instance of a specific</span>
<a href="#l1.3339"></a><span id="l1.3339" class="difflineplus">+     * component.</span>
<a href="#l1.3340"></a><span id="l1.3340" class="difflineplus">+     *</span>
<a href="#l1.3341"></a><span id="l1.3341" class="difflineplus">+     * @param {ICAL.Component|String} nameOrComp    Name of component, or component</span>
<a href="#l1.3342"></a><span id="l1.3342" class="difflineplus">+     * @return {Boolean}                            True when comp is removed</span>
<a href="#l1.3343"></a><span id="l1.3343">      */</span>
<a href="#l1.3344"></a><span id="l1.3344">     removeSubcomponent: function(nameOrComp) {</span>
<a href="#l1.3345"></a><span id="l1.3345">       var removed = this._removeObject(COMPONENT_INDEX, '_components', nameOrComp);</span>
<a href="#l1.3346"></a><span id="l1.3346">       if (removed) {</span>
<a href="#l1.3347"></a><span id="l1.3347">         this._hydratedComponentCount--;</span>
<a href="#l1.3348"></a><span id="l1.3348">       }</span>
<a href="#l1.3349"></a><span id="l1.3349">       return removed;</span>
<a href="#l1.3350"></a><span id="l1.3350">     },</span>
<a href="#l1.3351"></a><span id="l1.3351"> </span>
<a href="#l1.3352"></a><span id="l1.3352">     /**</span>
<a href="#l1.3353"></a><span id="l1.3353" class="difflineminus">-     * Removes all components or (if given) all</span>
<a href="#l1.3354"></a><span id="l1.3354" class="difflineminus">-     * components by a particular name.</span>
<a href="#l1.3355"></a><span id="l1.3355" class="difflineminus">-     *</span>
<a href="#l1.3356"></a><span id="l1.3356" class="difflineminus">-     * @param {String} [name] (lowercase) component name.</span>
<a href="#l1.3357"></a><span id="l1.3357" class="difflineplus">+     * Removes all components or (if given) all components by a particular</span>
<a href="#l1.3358"></a><span id="l1.3358" class="difflineplus">+     * name.</span>
<a href="#l1.3359"></a><span id="l1.3359" class="difflineplus">+     *</span>
<a href="#l1.3360"></a><span id="l1.3360" class="difflineplus">+     * @param {String=} name            Lowercase component name</span>
<a href="#l1.3361"></a><span id="l1.3361">      */</span>
<a href="#l1.3362"></a><span id="l1.3362">     removeAllSubcomponents: function(name) {</span>
<a href="#l1.3363"></a><span id="l1.3363">       var removed = this._removeAllObjects(COMPONENT_INDEX, '_components', name);</span>
<a href="#l1.3364"></a><span id="l1.3364">       this._hydratedComponentCount = 0;</span>
<a href="#l1.3365"></a><span id="l1.3365">       return removed;</span>
<a href="#l1.3366"></a><span id="l1.3366">     },</span>
<a href="#l1.3367"></a><span id="l1.3367"> </span>
<a href="#l1.3368"></a><span id="l1.3368">     /**</span>
<a href="#l1.3369"></a><span id="l1.3369" class="difflineminus">-     * Adds a property to the component.</span>
<a href="#l1.3370"></a><span id="l1.3370" class="difflineminus">-     *</span>
<a href="#l1.3371"></a><span id="l1.3371" class="difflineminus">-     * @param {ICAL.Property} property object.</span>
<a href="#l1.3372"></a><span id="l1.3372" class="difflineplus">+     * Adds an {@link ICAL.Property} to the component.</span>
<a href="#l1.3373"></a><span id="l1.3373" class="difflineplus">+     *</span>
<a href="#l1.3374"></a><span id="l1.3374" class="difflineplus">+     * @param {ICAL.Property} property      The property to add</span>
<a href="#l1.3375"></a><span id="l1.3375" class="difflineplus">+     * @return {ICAL.Property}              The passed in property</span>
<a href="#l1.3376"></a><span id="l1.3376">      */</span>
<a href="#l1.3377"></a><span id="l1.3377">     addProperty: function(property) {</span>
<a href="#l1.3378"></a><span id="l1.3378">       if (!(property instanceof ICAL.Property)) {</span>
<a href="#l1.3379"></a><span id="l1.3379">         throw new TypeError('must instance of ICAL.Property');</span>
<a href="#l1.3380"></a><span id="l1.3380">       }</span>
<a href="#l1.3381"></a><span id="l1.3381"> </span>
<a href="#l1.3382"></a><span id="l1.3382">       if (!this._properties) {</span>
<a href="#l1.3383"></a><span id="l1.3383">         this._properties = [];</span>
<a href="#l1.3384"></a><span id="l1.3384">         this._hydratedPropertyCount = 0;</span>
<a href="#l1.3385"></a><span id="l1.3385">       }</span>
<a href="#l1.3386"></a><span id="l1.3386"> </span>
<a href="#l1.3387"></a><span id="l1.3387" class="difflineminus">-</span>
<a href="#l1.3388"></a><span id="l1.3388">       if (property.parent) {</span>
<a href="#l1.3389"></a><span id="l1.3389">         property.parent.removeProperty(property);</span>
<a href="#l1.3390"></a><span id="l1.3390">       }</span>
<a href="#l1.3391"></a><span id="l1.3391"> </span>
<a href="#l1.3392"></a><span id="l1.3392">       var idx = this.jCal[PROPERTY_INDEX].push(property.jCal);</span>
<a href="#l1.3393"></a><span id="l1.3393">       this._properties[idx - 1] = property;</span>
<a href="#l1.3394"></a><span id="l1.3394">       this._hydratedPropertyCount++;</span>
<a href="#l1.3395"></a><span id="l1.3395">       property.parent = this;</span>
<a href="#l1.3396"></a><span id="l1.3396" class="difflineplus">+      return property;</span>
<a href="#l1.3397"></a><span id="l1.3397">     },</span>
<a href="#l1.3398"></a><span id="l1.3398"> </span>
<a href="#l1.3399"></a><span id="l1.3399">     /**</span>
<a href="#l1.3400"></a><span id="l1.3400">      * Helper method to add a property with a value to the component.</span>
<a href="#l1.3401"></a><span id="l1.3401">      *</span>
<a href="#l1.3402"></a><span id="l1.3402" class="difflineminus">-     * @param {String} name property name to add.</span>
<a href="#l1.3403"></a><span id="l1.3403" class="difflineminus">-     * @param {Object} value property value.</span>
<a href="#l1.3404"></a><span id="l1.3404" class="difflineplus">+     * @param {String}               name         Property name to add</span>
<a href="#l1.3405"></a><span id="l1.3405" class="difflineplus">+     * @param {String|Number|Object} value        Property value</span>
<a href="#l1.3406"></a><span id="l1.3406" class="difflineplus">+     * @return {ICAL.Property}                    The created property</span>
<a href="#l1.3407"></a><span id="l1.3407">      */</span>
<a href="#l1.3408"></a><span id="l1.3408">     addPropertyWithValue: function(name, value) {</span>
<a href="#l1.3409"></a><span id="l1.3409">       var prop = new ICAL.Property(name);</span>
<a href="#l1.3410"></a><span id="l1.3410">       prop.setValue(value);</span>
<a href="#l1.3411"></a><span id="l1.3411"> </span>
<a href="#l1.3412"></a><span id="l1.3412">       this.addProperty(prop);</span>
<a href="#l1.3413"></a><span id="l1.3413"> </span>
<a href="#l1.3414"></a><span id="l1.3414">       return prop;</span>
<a href="#l1.3415"></a><span id="l1.3415">     },</span>
<a href="#l1.3416"></a><span id="l1.3416"> </span>
<a href="#l1.3417"></a><span id="l1.3417">     /**</span>
<a href="#l1.3418"></a><span id="l1.3418" class="difflineminus">-     * Helper method that will update or create a property</span>
<a href="#l1.3419"></a><span id="l1.3419" class="difflineminus">-     * of the given name and sets its value.</span>
<a href="#l1.3420"></a><span id="l1.3420" class="difflineminus">-     *</span>
<a href="#l1.3421"></a><span id="l1.3421" class="difflineminus">-     * @param {String} name property name.</span>
<a href="#l1.3422"></a><span id="l1.3422" class="difflineminus">-     * @param {Object} value property value.</span>
<a href="#l1.3423"></a><span id="l1.3423" class="difflineminus">-     * @return {ICAL.Property} property.</span>
<a href="#l1.3424"></a><span id="l1.3424" class="difflineplus">+     * Helper method that will update or create a property of the given name</span>
<a href="#l1.3425"></a><span id="l1.3425" class="difflineplus">+     * and sets its value. If multiple properties with the given name exist,</span>
<a href="#l1.3426"></a><span id="l1.3426" class="difflineplus">+     * only the first is updated.</span>
<a href="#l1.3427"></a><span id="l1.3427" class="difflineplus">+     *</span>
<a href="#l1.3428"></a><span id="l1.3428" class="difflineplus">+     * @param {String}               name         Property name to update</span>
<a href="#l1.3429"></a><span id="l1.3429" class="difflineplus">+     * @param {String|Number|Object} value        Property value</span>
<a href="#l1.3430"></a><span id="l1.3430" class="difflineplus">+     * @return {ICAL.Property}                    The created property</span>
<a href="#l1.3431"></a><span id="l1.3431">      */</span>
<a href="#l1.3432"></a><span id="l1.3432">     updatePropertyWithValue: function(name, value) {</span>
<a href="#l1.3433"></a><span id="l1.3433">       var prop = this.getFirstProperty(name);</span>
<a href="#l1.3434"></a><span id="l1.3434"> </span>
<a href="#l1.3435"></a><span id="l1.3435">       if (prop) {</span>
<a href="#l1.3436"></a><span id="l1.3436">         prop.setValue(value);</span>
<a href="#l1.3437"></a><span id="l1.3437">       } else {</span>
<a href="#l1.3438"></a><span id="l1.3438">         prop = this.addPropertyWithValue(name, value);</span>
<a href="#l1.3439"></a><span id="l1.3439">       }</span>
<a href="#l1.3440"></a><span id="l1.3440"> </span>
<a href="#l1.3441"></a><span id="l1.3441">       return prop;</span>
<a href="#l1.3442"></a><span id="l1.3442">     },</span>
<a href="#l1.3443"></a><span id="l1.3443"> </span>
<a href="#l1.3444"></a><span id="l1.3444">     /**</span>
<a href="#l1.3445"></a><span id="l1.3445" class="difflineminus">-     * Removes a single property by name or</span>
<a href="#l1.3446"></a><span id="l1.3446" class="difflineminus">-     * the instance of the specific property.</span>
<a href="#l1.3447"></a><span id="l1.3447" class="difflineminus">-     *</span>
<a href="#l1.3448"></a><span id="l1.3448" class="difflineminus">-     * @param {String|ICAL.Property} nameOrProp to remove.</span>
<a href="#l1.3449"></a><span id="l1.3449" class="difflineminus">-     * @return {Boolean} true when deleted.</span>
<a href="#l1.3450"></a><span id="l1.3450" class="difflineplus">+     * Removes a single property by name or the instance of the specific</span>
<a href="#l1.3451"></a><span id="l1.3451" class="difflineplus">+     * property.</span>
<a href="#l1.3452"></a><span id="l1.3452" class="difflineplus">+     *</span>
<a href="#l1.3453"></a><span id="l1.3453" class="difflineplus">+     * @param {String|ICAL.Property} nameOrProp     Property name or instance to remove</span>
<a href="#l1.3454"></a><span id="l1.3454" class="difflineplus">+     * @return {Boolean}                            True, when deleted</span>
<a href="#l1.3455"></a><span id="l1.3455">      */</span>
<a href="#l1.3456"></a><span id="l1.3456">     removeProperty: function(nameOrProp) {</span>
<a href="#l1.3457"></a><span id="l1.3457">       var removed = this._removeObject(PROPERTY_INDEX, '_properties', nameOrProp);</span>
<a href="#l1.3458"></a><span id="l1.3458">       if (removed) {</span>
<a href="#l1.3459"></a><span id="l1.3459">         this._hydratedPropertyCount--;</span>
<a href="#l1.3460"></a><span id="l1.3460">       }</span>
<a href="#l1.3461"></a><span id="l1.3461">       return removed;</span>
<a href="#l1.3462"></a><span id="l1.3462">     },</span>
<a href="#l1.3463"></a><span id="l1.3463"> </span>
<a href="#l1.3464"></a><span id="l1.3464">     /**</span>
<a href="#l1.3465"></a><span id="l1.3465" class="difflineminus">-     * Removes all properties associated with this component.</span>
<a href="#l1.3466"></a><span id="l1.3466" class="difflineminus">-     *</span>
<a href="#l1.3467"></a><span id="l1.3467" class="difflineminus">-     * @param {String} [name] (lowecase) optional property name.</span>
<a href="#l1.3468"></a><span id="l1.3468" class="difflineplus">+     * Removes all properties associated with this component, optionally</span>
<a href="#l1.3469"></a><span id="l1.3469" class="difflineplus">+     * filtered by name.</span>
<a href="#l1.3470"></a><span id="l1.3470" class="difflineplus">+     *</span>
<a href="#l1.3471"></a><span id="l1.3471" class="difflineplus">+     * @param {String=} name        Lowercase property name</span>
<a href="#l1.3472"></a><span id="l1.3472" class="difflineplus">+     * @return {Boolean}            True, when deleted</span>
<a href="#l1.3473"></a><span id="l1.3473">      */</span>
<a href="#l1.3474"></a><span id="l1.3474">     removeAllProperties: function(name) {</span>
<a href="#l1.3475"></a><span id="l1.3475">       var removed = this._removeAllObjects(PROPERTY_INDEX, '_properties', name);</span>
<a href="#l1.3476"></a><span id="l1.3476">       this._hydratedPropertyCount = 0;</span>
<a href="#l1.3477"></a><span id="l1.3477">       return removed;</span>
<a href="#l1.3478"></a><span id="l1.3478">     },</span>
<a href="#l1.3479"></a><span id="l1.3479"> </span>
<a href="#l1.3480"></a><span id="l1.3480" class="difflineplus">+    /**</span>
<a href="#l1.3481"></a><span id="l1.3481" class="difflineplus">+     * Returns the Object representation of this component. The returned object</span>
<a href="#l1.3482"></a><span id="l1.3482" class="difflineplus">+     * is a live jCal object and should be cloned if modified.</span>
<a href="#l1.3483"></a><span id="l1.3483" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.3484"></a><span id="l1.3484" class="difflineplus">+     */</span>
<a href="#l1.3485"></a><span id="l1.3485">     toJSON: function() {</span>
<a href="#l1.3486"></a><span id="l1.3486">       return this.jCal;</span>
<a href="#l1.3487"></a><span id="l1.3487">     },</span>
<a href="#l1.3488"></a><span id="l1.3488"> </span>
<a href="#l1.3489"></a><span id="l1.3489" class="difflineplus">+    /**</span>
<a href="#l1.3490"></a><span id="l1.3490" class="difflineplus">+     * The string representation of this component.</span>
<a href="#l1.3491"></a><span id="l1.3491" class="difflineplus">+     * @return {String}</span>
<a href="#l1.3492"></a><span id="l1.3492" class="difflineplus">+     */</span>
<a href="#l1.3493"></a><span id="l1.3493">     toString: function() {</span>
<a href="#l1.3494"></a><span id="l1.3494">       return ICAL.stringify.component(</span>
<a href="#l1.3495"></a><span id="l1.3495" class="difflineminus">-        this.jCal</span>
<a href="#l1.3496"></a><span id="l1.3496" class="difflineplus">+        this.jCal, this._designSet</span>
<a href="#l1.3497"></a><span id="l1.3497">       );</span>
<a href="#l1.3498"></a><span id="l1.3498">     }</span>
<a href="#l1.3499"></a><span id="l1.3499" class="difflineminus">-</span>
<a href="#l1.3500"></a><span id="l1.3500" class="difflineplus">+  };</span>
<a href="#l1.3501"></a><span id="l1.3501" class="difflineplus">+</span>
<a href="#l1.3502"></a><span id="l1.3502" class="difflineplus">+  /**</span>
<a href="#l1.3503"></a><span id="l1.3503" class="difflineplus">+   * Create an {@link ICAL.Component} by parsing the passed iCalendar string.</span>
<a href="#l1.3504"></a><span id="l1.3504" class="difflineplus">+   *</span>
<a href="#l1.3505"></a><span id="l1.3505" class="difflineplus">+   * @param {String} str        The iCalendar string to parse</span>
<a href="#l1.3506"></a><span id="l1.3506" class="difflineplus">+   */</span>
<a href="#l1.3507"></a><span id="l1.3507" class="difflineplus">+  Component.fromString = function(str) {</span>
<a href="#l1.3508"></a><span id="l1.3508" class="difflineplus">+    return new Component(ICAL.parse.component(str));</span>
<a href="#l1.3509"></a><span id="l1.3509">   };</span>
<a href="#l1.3510"></a><span id="l1.3510"> </span>
<a href="#l1.3511"></a><span id="l1.3511">   return Component;</span>
<a href="#l1.3512"></a><span id="l1.3512" class="difflineminus">-</span>
<a href="#l1.3513"></a><span id="l1.3513"> }());</span>
<a href="#l1.3514"></a><span id="l1.3514" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.3515"></a><span id="l1.3515" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.3516"></a><span id="l1.3516" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.3517"></a><span id="l1.3517" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.3518"></a><span id="l1.3518" class="difflineplus">+</span>
<a href="#l1.3519"></a><span id="l1.3519" class="difflineplus">+</span>
<a href="#l1.3520"></a><span id="l1.3520" class="difflineplus">+/**</span>
<a href="#l1.3521"></a><span id="l1.3521" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.3522"></a><span id="l1.3522" class="difflineplus">+ * @ignore</span>
<a href="#l1.3523"></a><span id="l1.3523" class="difflineplus">+ */</span>
<a href="#l1.3524"></a><span id="l1.3524"> ICAL.Property = (function() {</span>
<a href="#l1.3525"></a><span id="l1.3525">   'use strict';</span>
<a href="#l1.3526"></a><span id="l1.3526"> </span>
<a href="#l1.3527"></a><span id="l1.3527">   var NAME_INDEX = 0;</span>
<a href="#l1.3528"></a><span id="l1.3528">   var PROP_INDEX = 1;</span>
<a href="#l1.3529"></a><span id="l1.3529">   var TYPE_INDEX = 2;</span>
<a href="#l1.3530"></a><span id="l1.3530">   var VALUE_INDEX = 3;</span>
<a href="#l1.3531"></a><span id="l1.3531"> </span>
<a href="#l1.3532"></a><span id="l1.3532">   var design = ICAL.design;</span>
<a href="#l1.3533"></a><span id="l1.3533"> </span>
<a href="#l1.3534"></a><span id="l1.3534">   /**</span>
<a href="#l1.3535"></a><span id="l1.3535" class="difflineminus">-   * Provides a nicer interface to any kind of property.</span>
<a href="#l1.3536"></a><span id="l1.3536" class="difflineplus">+   * @classdesc</span>
<a href="#l1.3537"></a><span id="l1.3537" class="difflineplus">+   * Provides a layer on top of the raw jCal object for manipulating a single</span>
<a href="#l1.3538"></a><span id="l1.3538" class="difflineplus">+   * property, with its parameters and value.</span>
<a href="#l1.3539"></a><span id="l1.3539" class="difflineplus">+   *</span>
<a href="#l1.3540"></a><span id="l1.3540" class="difflineplus">+   * @description</span>
<a href="#l1.3541"></a><span id="l1.3541">    * Its important to note that mutations done in the wrapper</span>
<a href="#l1.3542"></a><span id="l1.3542" class="difflineminus">-   * directly effect (mutate) the jCal object used to initialize.</span>
<a href="#l1.3543"></a><span id="l1.3543" class="difflineplus">+   * directly mutate the jCal object used to initialize.</span>
<a href="#l1.3544"></a><span id="l1.3544">    *</span>
<a href="#l1.3545"></a><span id="l1.3545">    * Can also be used to create new properties by passing</span>
<a href="#l1.3546"></a><span id="l1.3546">    * the name of the property (as a String).</span>
<a href="#l1.3547"></a><span id="l1.3547">    *</span>
<a href="#l1.3548"></a><span id="l1.3548" class="difflineminus">-   *</span>
<a href="#l1.3549"></a><span id="l1.3549" class="difflineminus">-   * @param {Array|String} jCal raw jCal representation OR</span>
<a href="#l1.3550"></a><span id="l1.3550" class="difflineminus">-   *  the new name of the property (when creating).</span>
<a href="#l1.3551"></a><span id="l1.3551" class="difflineminus">-   *</span>
<a href="#l1.3552"></a><span id="l1.3552" class="difflineminus">-   * @param {ICAL.Component} [parent] parent component.</span>
<a href="#l1.3553"></a><span id="l1.3553" class="difflineplus">+   * @class</span>
<a href="#l1.3554"></a><span id="l1.3554" class="difflineplus">+   * @alias ICAL.Property</span>
<a href="#l1.3555"></a><span id="l1.3555" class="difflineplus">+   * @param {Array|String} jCal         Raw jCal representation OR</span>
<a href="#l1.3556"></a><span id="l1.3556" class="difflineplus">+   *  the new name of the property</span>
<a href="#l1.3557"></a><span id="l1.3557" class="difflineplus">+   *</span>
<a href="#l1.3558"></a><span id="l1.3558" class="difflineplus">+   * @param {ICAL.Component=} parent    Parent component</span>
<a href="#l1.3559"></a><span id="l1.3559">    */</span>
<a href="#l1.3560"></a><span id="l1.3560">   function Property(jCal, parent) {</span>
<a href="#l1.3561"></a><span id="l1.3561" class="difflineplus">+    this._parent = parent || null;</span>
<a href="#l1.3562"></a><span id="l1.3562" class="difflineplus">+</span>
<a href="#l1.3563"></a><span id="l1.3563">     if (typeof(jCal) === 'string') {</span>
<a href="#l1.3564"></a><span id="l1.3564" class="difflineminus">-      // because we a creating by name we need</span>
<a href="#l1.3565"></a><span id="l1.3565" class="difflineminus">-      // to find the type when creating the property.</span>
<a href="#l1.3566"></a><span id="l1.3566" class="difflineminus">-      var name = jCal;</span>
<a href="#l1.3567"></a><span id="l1.3567" class="difflineminus">-</span>
<a href="#l1.3568"></a><span id="l1.3568" class="difflineminus">-      if (name in design.property) {</span>
<a href="#l1.3569"></a><span id="l1.3569" class="difflineminus">-        var prop = design.property[name];</span>
<a href="#l1.3570"></a><span id="l1.3570" class="difflineminus">-        if ('defaultType' in prop) {</span>
<a href="#l1.3571"></a><span id="l1.3571" class="difflineminus">-          var type = prop.defaultType;</span>
<a href="#l1.3572"></a><span id="l1.3572" class="difflineminus">-        } else {</span>
<a href="#l1.3573"></a><span id="l1.3573" class="difflineminus">-          var type = design.defaultType;</span>
<a href="#l1.3574"></a><span id="l1.3574" class="difflineminus">-        }</span>
<a href="#l1.3575"></a><span id="l1.3575" class="difflineminus">-      } else {</span>
<a href="#l1.3576"></a><span id="l1.3576" class="difflineminus">-        var type = design.defaultType;</span>
<a href="#l1.3577"></a><span id="l1.3577" class="difflineminus">-      }</span>
<a href="#l1.3578"></a><span id="l1.3578" class="difflineminus">-</span>
<a href="#l1.3579"></a><span id="l1.3579" class="difflineminus">-      jCal = [name, {}, type];</span>
<a href="#l1.3580"></a><span id="l1.3580" class="difflineminus">-    }</span>
<a href="#l1.3581"></a><span id="l1.3581" class="difflineminus">-</span>
<a href="#l1.3582"></a><span id="l1.3582" class="difflineminus">-    this.jCal = jCal;</span>
<a href="#l1.3583"></a><span id="l1.3583" class="difflineminus">-    this.parent = parent || null;</span>
<a href="#l1.3584"></a><span id="l1.3584" class="difflineplus">+      // We are creating the property by name and need to detect the type</span>
<a href="#l1.3585"></a><span id="l1.3585" class="difflineplus">+      this.jCal = [jCal, {}, design.defaultType];</span>
<a href="#l1.3586"></a><span id="l1.3586" class="difflineplus">+      this.jCal[TYPE_INDEX] = this.getDefaultType();</span>
<a href="#l1.3587"></a><span id="l1.3587" class="difflineplus">+    } else {</span>
<a href="#l1.3588"></a><span id="l1.3588" class="difflineplus">+      this.jCal = jCal;</span>
<a href="#l1.3589"></a><span id="l1.3589" class="difflineplus">+    }</span>
<a href="#l1.3590"></a><span id="l1.3590">     this._updateType();</span>
<a href="#l1.3591"></a><span id="l1.3591">   }</span>
<a href="#l1.3592"></a><span id="l1.3592"> </span>
<a href="#l1.3593"></a><span id="l1.3593">   Property.prototype = {</span>
<a href="#l1.3594"></a><span id="l1.3594" class="difflineplus">+</span>
<a href="#l1.3595"></a><span id="l1.3595" class="difflineplus">+    /**</span>
<a href="#l1.3596"></a><span id="l1.3596" class="difflineplus">+     * The value type for this property</span>
<a href="#l1.3597"></a><span id="l1.3597" class="difflineplus">+     * @readonly</span>
<a href="#l1.3598"></a><span id="l1.3598" class="difflineplus">+     * @type {String}</span>
<a href="#l1.3599"></a><span id="l1.3599" class="difflineplus">+     */</span>
<a href="#l1.3600"></a><span id="l1.3600">     get type() {</span>
<a href="#l1.3601"></a><span id="l1.3601">       return this.jCal[TYPE_INDEX];</span>
<a href="#l1.3602"></a><span id="l1.3602">     },</span>
<a href="#l1.3603"></a><span id="l1.3603"> </span>
<a href="#l1.3604"></a><span id="l1.3604" class="difflineplus">+    /**</span>
<a href="#l1.3605"></a><span id="l1.3605" class="difflineplus">+     * The name of this property, in lowercase.</span>
<a href="#l1.3606"></a><span id="l1.3606" class="difflineplus">+     * @readonly</span>
<a href="#l1.3607"></a><span id="l1.3607" class="difflineplus">+     * @type {String}</span>
<a href="#l1.3608"></a><span id="l1.3608" class="difflineplus">+     */</span>
<a href="#l1.3609"></a><span id="l1.3609">     get name() {</span>
<a href="#l1.3610"></a><span id="l1.3610">       return this.jCal[NAME_INDEX];</span>
<a href="#l1.3611"></a><span id="l1.3611">     },</span>
<a href="#l1.3612"></a><span id="l1.3612"> </span>
<a href="#l1.3613"></a><span id="l1.3613" class="difflineplus">+    /**</span>
<a href="#l1.3614"></a><span id="l1.3614" class="difflineplus">+     * The parent component for this property.</span>
<a href="#l1.3615"></a><span id="l1.3615" class="difflineplus">+     * @type {ICAL.Component}</span>
<a href="#l1.3616"></a><span id="l1.3616" class="difflineplus">+     */</span>
<a href="#l1.3617"></a><span id="l1.3617" class="difflineplus">+    get parent() {</span>
<a href="#l1.3618"></a><span id="l1.3618" class="difflineplus">+      return this._parent;</span>
<a href="#l1.3619"></a><span id="l1.3619" class="difflineplus">+    },</span>
<a href="#l1.3620"></a><span id="l1.3620" class="difflineplus">+</span>
<a href="#l1.3621"></a><span id="l1.3621" class="difflineplus">+    set parent(p) {</span>
<a href="#l1.3622"></a><span id="l1.3622" class="difflineplus">+      // Before setting the parent, check if the design set has changed. If it</span>
<a href="#l1.3623"></a><span id="l1.3623" class="difflineplus">+      // has, we later need to update the type if it was unknown before.</span>
<a href="#l1.3624"></a><span id="l1.3624" class="difflineplus">+      var designSetChanged = !this._parent || (p &amp;&amp; p._designSet != this._parent._designSet);</span>
<a href="#l1.3625"></a><span id="l1.3625" class="difflineplus">+</span>
<a href="#l1.3626"></a><span id="l1.3626" class="difflineplus">+      this._parent = p;</span>
<a href="#l1.3627"></a><span id="l1.3627" class="difflineplus">+</span>
<a href="#l1.3628"></a><span id="l1.3628" class="difflineplus">+      if (this.type == design.defaultType &amp;&amp; designSetChanged) {</span>
<a href="#l1.3629"></a><span id="l1.3629" class="difflineplus">+        this.jCal[TYPE_INDEX] = this.getDefaultType();</span>
<a href="#l1.3630"></a><span id="l1.3630" class="difflineplus">+        this._updateType();</span>
<a href="#l1.3631"></a><span id="l1.3631" class="difflineplus">+      }</span>
<a href="#l1.3632"></a><span id="l1.3632" class="difflineplus">+</span>
<a href="#l1.3633"></a><span id="l1.3633" class="difflineplus">+      return p;</span>
<a href="#l1.3634"></a><span id="l1.3634" class="difflineplus">+    },</span>
<a href="#l1.3635"></a><span id="l1.3635" class="difflineplus">+</span>
<a href="#l1.3636"></a><span id="l1.3636" class="difflineplus">+    /**</span>
<a href="#l1.3637"></a><span id="l1.3637" class="difflineplus">+     * The design set for this property, e.g. icalendar vs vcard</span>
<a href="#l1.3638"></a><span id="l1.3638" class="difflineplus">+     *</span>
<a href="#l1.3639"></a><span id="l1.3639" class="difflineplus">+     * @type {ICAL.design.designSet}</span>
<a href="#l1.3640"></a><span id="l1.3640" class="difflineplus">+     * @private</span>
<a href="#l1.3641"></a><span id="l1.3641" class="difflineplus">+     */</span>
<a href="#l1.3642"></a><span id="l1.3642" class="difflineplus">+    get _designSet() {</span>
<a href="#l1.3643"></a><span id="l1.3643" class="difflineplus">+      return this.parent ? this.parent._designSet : design.defaultSet;</span>
<a href="#l1.3644"></a><span id="l1.3644" class="difflineplus">+    },</span>
<a href="#l1.3645"></a><span id="l1.3645" class="difflineplus">+</span>
<a href="#l1.3646"></a><span id="l1.3646" class="difflineplus">+    /**</span>
<a href="#l1.3647"></a><span id="l1.3647" class="difflineplus">+     * Updates the type metadata from the current jCal type and design set.</span>
<a href="#l1.3648"></a><span id="l1.3648" class="difflineplus">+     *</span>
<a href="#l1.3649"></a><span id="l1.3649" class="difflineplus">+     * @private</span>
<a href="#l1.3650"></a><span id="l1.3650" class="difflineplus">+     */</span>
<a href="#l1.3651"></a><span id="l1.3651">     _updateType: function() {</span>
<a href="#l1.3652"></a><span id="l1.3652" class="difflineminus">-      if (this.type in design.value) {</span>
<a href="#l1.3653"></a><span id="l1.3653" class="difflineminus">-        var designType = design.value[this.type];</span>
<a href="#l1.3654"></a><span id="l1.3654" class="difflineminus">-</span>
<a href="#l1.3655"></a><span id="l1.3655" class="difflineminus">-        if ('decorate' in design.value[this.type]) {</span>
<a href="#l1.3656"></a><span id="l1.3656" class="difflineplus">+      var designSet = this._designSet;</span>
<a href="#l1.3657"></a><span id="l1.3657" class="difflineplus">+</span>
<a href="#l1.3658"></a><span id="l1.3658" class="difflineplus">+      if (this.type in designSet.value) {</span>
<a href="#l1.3659"></a><span id="l1.3659" class="difflineplus">+        var designType = designSet.value[this.type];</span>
<a href="#l1.3660"></a><span id="l1.3660" class="difflineplus">+</span>
<a href="#l1.3661"></a><span id="l1.3661" class="difflineplus">+        if ('decorate' in designSet.value[this.type]) {</span>
<a href="#l1.3662"></a><span id="l1.3662">           this.isDecorated = true;</span>
<a href="#l1.3663"></a><span id="l1.3663">         } else {</span>
<a href="#l1.3664"></a><span id="l1.3664">           this.isDecorated = false;</span>
<a href="#l1.3665"></a><span id="l1.3665">         }</span>
<a href="#l1.3666"></a><span id="l1.3666"> </span>
<a href="#l1.3667"></a><span id="l1.3667" class="difflineminus">-        if (this.name in design.property) {</span>
<a href="#l1.3668"></a><span id="l1.3668" class="difflineminus">-          if ('multiValue' in design.property[this.name]) {</span>
<a href="#l1.3669"></a><span id="l1.3669" class="difflineminus">-            this.isMultiValue = true;</span>
<a href="#l1.3670"></a><span id="l1.3670" class="difflineminus">-          } else {</span>
<a href="#l1.3671"></a><span id="l1.3671" class="difflineminus">-            this.isMultiValue = false;</span>
<a href="#l1.3672"></a><span id="l1.3672" class="difflineminus">-          }</span>
<a href="#l1.3673"></a><span id="l1.3673" class="difflineminus">-        }</span>
<a href="#l1.3674"></a><span id="l1.3674" class="difflineminus">-      }</span>
<a href="#l1.3675"></a><span id="l1.3675" class="difflineminus">-    },</span>
<a href="#l1.3676"></a><span id="l1.3676" class="difflineminus">-</span>
<a href="#l1.3677"></a><span id="l1.3677" class="difflineminus">-    /**</span>
<a href="#l1.3678"></a><span id="l1.3678" class="difflineminus">-     * Hydrate a single value.</span>
<a href="#l1.3679"></a><span id="l1.3679" class="difflineplus">+        if (this.name in designSet.property) {</span>
<a href="#l1.3680"></a><span id="l1.3680" class="difflineplus">+          this.isMultiValue = ('multiValue' in designSet.property[this.name]);</span>
<a href="#l1.3681"></a><span id="l1.3681" class="difflineplus">+          this.isStructuredValue = ('structuredValue' in designSet.property[this.name]);</span>
<a href="#l1.3682"></a><span id="l1.3682" class="difflineplus">+        }</span>
<a href="#l1.3683"></a><span id="l1.3683" class="difflineplus">+      }</span>
<a href="#l1.3684"></a><span id="l1.3684" class="difflineplus">+    },</span>
<a href="#l1.3685"></a><span id="l1.3685" class="difflineplus">+</span>
<a href="#l1.3686"></a><span id="l1.3686" class="difflineplus">+    /**</span>
<a href="#l1.3687"></a><span id="l1.3687" class="difflineplus">+     * Hydrate a single value. The act of hydrating means turning the raw jCal</span>
<a href="#l1.3688"></a><span id="l1.3688" class="difflineplus">+     * value into a potentially wrapped object, for example {@link ICAL.Time}.</span>
<a href="#l1.3689"></a><span id="l1.3689" class="difflineplus">+     *</span>
<a href="#l1.3690"></a><span id="l1.3690" class="difflineplus">+     * @private</span>
<a href="#l1.3691"></a><span id="l1.3691" class="difflineplus">+     * @param {Number} index        The index of the value to hydrate</span>
<a href="#l1.3692"></a><span id="l1.3692" class="difflineplus">+     * @return {Object}             The decorated value.</span>
<a href="#l1.3693"></a><span id="l1.3693">      */</span>
<a href="#l1.3694"></a><span id="l1.3694">     _hydrateValue: function(index) {</span>
<a href="#l1.3695"></a><span id="l1.3695">       if (this._values &amp;&amp; this._values[index]) {</span>
<a href="#l1.3696"></a><span id="l1.3696">         return this._values[index];</span>
<a href="#l1.3697"></a><span id="l1.3697">       }</span>
<a href="#l1.3698"></a><span id="l1.3698"> </span>
<a href="#l1.3699"></a><span id="l1.3699">       // for the case where there is no value.</span>
<a href="#l1.3700"></a><span id="l1.3700">       if (this.jCal.length &lt;= (VALUE_INDEX + index)) {</span>
<a href="#l1.3701"></a><span id="l1.3701">         return null;</span>
<a href="#l1.3702"></a><span id="l1.3702">       }</span>
<a href="#l1.3703"></a><span id="l1.3703"> </span>
<a href="#l1.3704"></a><span id="l1.3704">       if (this.isDecorated) {</span>
<a href="#l1.3705"></a><span id="l1.3705">         if (!this._values) {</span>
<a href="#l1.3706"></a><span id="l1.3706">           this._values = [];</span>
<a href="#l1.3707"></a><span id="l1.3707">         }</span>
<a href="#l1.3708"></a><span id="l1.3708" class="difflineminus">-        return this._values[index] = this._decorate(</span>
<a href="#l1.3709"></a><span id="l1.3709" class="difflineplus">+        return (this._values[index] = this._decorate(</span>
<a href="#l1.3710"></a><span id="l1.3710">           this.jCal[VALUE_INDEX + index]</span>
<a href="#l1.3711"></a><span id="l1.3711" class="difflineminus">-        );</span>
<a href="#l1.3712"></a><span id="l1.3712" class="difflineplus">+        ));</span>
<a href="#l1.3713"></a><span id="l1.3713">       } else {</span>
<a href="#l1.3714"></a><span id="l1.3714">         return this.jCal[VALUE_INDEX + index];</span>
<a href="#l1.3715"></a><span id="l1.3715">       }</span>
<a href="#l1.3716"></a><span id="l1.3716">     },</span>
<a href="#l1.3717"></a><span id="l1.3717"> </span>
<a href="#l1.3718"></a><span id="l1.3718" class="difflineplus">+    /**</span>
<a href="#l1.3719"></a><span id="l1.3719" class="difflineplus">+     * Decorate a single value, returning its wrapped object. This is used by</span>
<a href="#l1.3720"></a><span id="l1.3720" class="difflineplus">+     * the hydrate function to actually wrap the value.</span>
<a href="#l1.3721"></a><span id="l1.3721" class="difflineplus">+     *</span>
<a href="#l1.3722"></a><span id="l1.3722" class="difflineplus">+     * @private</span>
<a href="#l1.3723"></a><span id="l1.3723" class="difflineplus">+     * @param {?} value         The value to decorate</span>
<a href="#l1.3724"></a><span id="l1.3724" class="difflineplus">+     * @return {Object}         The decorated value</span>
<a href="#l1.3725"></a><span id="l1.3725" class="difflineplus">+     */</span>
<a href="#l1.3726"></a><span id="l1.3726">     _decorate: function(value) {</span>
<a href="#l1.3727"></a><span id="l1.3727" class="difflineminus">-      return design.value[this.type].decorate(value, this);</span>
<a href="#l1.3728"></a><span id="l1.3728" class="difflineminus">-    },</span>
<a href="#l1.3729"></a><span id="l1.3729" class="difflineminus">-</span>
<a href="#l1.3730"></a><span id="l1.3730" class="difflineplus">+      return this._designSet.value[this.type].decorate(value, this);</span>
<a href="#l1.3731"></a><span id="l1.3731" class="difflineplus">+    },</span>
<a href="#l1.3732"></a><span id="l1.3732" class="difflineplus">+</span>
<a href="#l1.3733"></a><span id="l1.3733" class="difflineplus">+    /**</span>
<a href="#l1.3734"></a><span id="l1.3734" class="difflineplus">+     * Undecorate a single value, returning its raw jCal data.</span>
<a href="#l1.3735"></a><span id="l1.3735" class="difflineplus">+     *</span>
<a href="#l1.3736"></a><span id="l1.3736" class="difflineplus">+     * @private</span>
<a href="#l1.3737"></a><span id="l1.3737" class="difflineplus">+     * @param {Object} value         The value to undecorate</span>
<a href="#l1.3738"></a><span id="l1.3738" class="difflineplus">+     * @return {?}                   The undecorated value</span>
<a href="#l1.3739"></a><span id="l1.3739" class="difflineplus">+     */</span>
<a href="#l1.3740"></a><span id="l1.3740">     _undecorate: function(value) {</span>
<a href="#l1.3741"></a><span id="l1.3741" class="difflineminus">-      return design.value[this.type].undecorate(value, this);</span>
<a href="#l1.3742"></a><span id="l1.3742" class="difflineminus">-    },</span>
<a href="#l1.3743"></a><span id="l1.3743" class="difflineminus">-</span>
<a href="#l1.3744"></a><span id="l1.3744" class="difflineplus">+      return this._designSet.value[this.type].undecorate(value, this);</span>
<a href="#l1.3745"></a><span id="l1.3745" class="difflineplus">+    },</span>
<a href="#l1.3746"></a><span id="l1.3746" class="difflineplus">+</span>
<a href="#l1.3747"></a><span id="l1.3747" class="difflineplus">+    /**</span>
<a href="#l1.3748"></a><span id="l1.3748" class="difflineplus">+     * Sets the value at the given index while also hydrating it. The passed</span>
<a href="#l1.3749"></a><span id="l1.3749" class="difflineplus">+     * value can either be a decorated or undecorated value.</span>
<a href="#l1.3750"></a><span id="l1.3750" class="difflineplus">+     *</span>
<a href="#l1.3751"></a><span id="l1.3751" class="difflineplus">+     * @private</span>
<a href="#l1.3752"></a><span id="l1.3752" class="difflineplus">+     * @param {?} value             The value to set</span>
<a href="#l1.3753"></a><span id="l1.3753" class="difflineplus">+     * @param {Number} index        The index to set it at</span>
<a href="#l1.3754"></a><span id="l1.3754" class="difflineplus">+     */</span>
<a href="#l1.3755"></a><span id="l1.3755">     _setDecoratedValue: function(value, index) {</span>
<a href="#l1.3756"></a><span id="l1.3756">       if (!this._values) {</span>
<a href="#l1.3757"></a><span id="l1.3757">         this._values = [];</span>
<a href="#l1.3758"></a><span id="l1.3758">       }</span>
<a href="#l1.3759"></a><span id="l1.3759"> </span>
<a href="#l1.3760"></a><span id="l1.3760">       if (typeof(value) === 'object' &amp;&amp; 'icaltype' in value) {</span>
<a href="#l1.3761"></a><span id="l1.3761">         // decorated value</span>
<a href="#l1.3762"></a><span id="l1.3762">         this.jCal[VALUE_INDEX + index] = this._undecorate(value);</span>
<a href="#l1.3763"></a><span id="l1.3763" class="difflineat">@@ -2092,86 +2899,99 @@ ICAL.Property = (function() {</span>
<a href="#l1.3764"></a><span id="l1.3764">       } else {</span>
<a href="#l1.3765"></a><span id="l1.3765">         // undecorated value</span>
<a href="#l1.3766"></a><span id="l1.3766">         this.jCal[VALUE_INDEX + index] = value;</span>
<a href="#l1.3767"></a><span id="l1.3767">         this._values[index] = this._decorate(value);</span>
<a href="#l1.3768"></a><span id="l1.3768">       }</span>
<a href="#l1.3769"></a><span id="l1.3769">     },</span>
<a href="#l1.3770"></a><span id="l1.3770"> </span>
<a href="#l1.3771"></a><span id="l1.3771">     /**</span>
<a href="#l1.3772"></a><span id="l1.3772" class="difflineminus">-     * Gets a param on the property.</span>
<a href="#l1.3773"></a><span id="l1.3773" class="difflineminus">-     *</span>
<a href="#l1.3774"></a><span id="l1.3774" class="difflineminus">-     * @param {String} name prop name (lowercase).</span>
<a href="#l1.3775"></a><span id="l1.3775" class="difflineminus">-     * @return {String} prop value.</span>
<a href="#l1.3776"></a><span id="l1.3776" class="difflineplus">+     * Gets a parameter on the property.</span>
<a href="#l1.3777"></a><span id="l1.3777" class="difflineplus">+     *</span>
<a href="#l1.3778"></a><span id="l1.3778" class="difflineplus">+     * @param {String}        name   Property name (lowercase)</span>
<a href="#l1.3779"></a><span id="l1.3779" class="difflineplus">+     * @return {Array|String}        Property value</span>
<a href="#l1.3780"></a><span id="l1.3780">      */</span>
<a href="#l1.3781"></a><span id="l1.3781">     getParameter: function(name) {</span>
<a href="#l1.3782"></a><span id="l1.3782" class="difflineminus">-      return this.jCal[PROP_INDEX][name];</span>
<a href="#l1.3783"></a><span id="l1.3783" class="difflineminus">-    },</span>
<a href="#l1.3784"></a><span id="l1.3784" class="difflineminus">-</span>
<a href="#l1.3785"></a><span id="l1.3785" class="difflineminus">-    /**</span>
<a href="#l1.3786"></a><span id="l1.3786" class="difflineminus">-     * Sets a param on the property.</span>
<a href="#l1.3787"></a><span id="l1.3787" class="difflineminus">-     *</span>
<a href="#l1.3788"></a><span id="l1.3788" class="difflineminus">-     * @param {String} value property value.</span>
<a href="#l1.3789"></a><span id="l1.3789" class="difflineplus">+      if (name in this.jCal[PROP_INDEX]) {</span>
<a href="#l1.3790"></a><span id="l1.3790" class="difflineplus">+        return this.jCal[PROP_INDEX][name];</span>
<a href="#l1.3791"></a><span id="l1.3791" class="difflineplus">+      } else {</span>
<a href="#l1.3792"></a><span id="l1.3792" class="difflineplus">+        return undefined;</span>
<a href="#l1.3793"></a><span id="l1.3793" class="difflineplus">+      }</span>
<a href="#l1.3794"></a><span id="l1.3794" class="difflineplus">+    },</span>
<a href="#l1.3795"></a><span id="l1.3795" class="difflineplus">+</span>
<a href="#l1.3796"></a><span id="l1.3796" class="difflineplus">+    /**</span>
<a href="#l1.3797"></a><span id="l1.3797" class="difflineplus">+     * Sets a parameter on the property.</span>
<a href="#l1.3798"></a><span id="l1.3798" class="difflineplus">+     *</span>
<a href="#l1.3799"></a><span id="l1.3799" class="difflineplus">+     * @param {String}       name     The parameter name</span>
<a href="#l1.3800"></a><span id="l1.3800" class="difflineplus">+     * @param {Array|String} value    The parameter value</span>
<a href="#l1.3801"></a><span id="l1.3801">      */</span>
<a href="#l1.3802"></a><span id="l1.3802">     setParameter: function(name, value) {</span>
<a href="#l1.3803"></a><span id="l1.3803" class="difflineplus">+      var lcname = name.toLowerCase();</span>
<a href="#l1.3804"></a><span id="l1.3804" class="difflineplus">+      if (typeof value === &quot;string&quot; &amp;&amp;</span>
<a href="#l1.3805"></a><span id="l1.3805" class="difflineplus">+          lcname in this._designSet.param &amp;&amp;</span>
<a href="#l1.3806"></a><span id="l1.3806" class="difflineplus">+          'multiValue' in this._designSet.param[lcname]) {</span>
<a href="#l1.3807"></a><span id="l1.3807" class="difflineplus">+          value = [value];</span>
<a href="#l1.3808"></a><span id="l1.3808" class="difflineplus">+      }</span>
<a href="#l1.3809"></a><span id="l1.3809">       this.jCal[PROP_INDEX][name] = value;</span>
<a href="#l1.3810"></a><span id="l1.3810">     },</span>
<a href="#l1.3811"></a><span id="l1.3811"> </span>
<a href="#l1.3812"></a><span id="l1.3812">     /**</span>
<a href="#l1.3813"></a><span id="l1.3813">      * Removes a parameter</span>
<a href="#l1.3814"></a><span id="l1.3814">      *</span>
<a href="#l1.3815"></a><span id="l1.3815" class="difflineminus">-     * @param {String} name prop name (lowercase).</span>
<a href="#l1.3816"></a><span id="l1.3816" class="difflineplus">+     * @param {String} name     The parameter name</span>
<a href="#l1.3817"></a><span id="l1.3817">      */</span>
<a href="#l1.3818"></a><span id="l1.3818">     removeParameter: function(name) {</span>
<a href="#l1.3819"></a><span id="l1.3819" class="difflineminus">-      return delete this.jCal[PROP_INDEX][name];</span>
<a href="#l1.3820"></a><span id="l1.3820" class="difflineplus">+      delete this.jCal[PROP_INDEX][name];</span>
<a href="#l1.3821"></a><span id="l1.3821">     },</span>
<a href="#l1.3822"></a><span id="l1.3822"> </span>
<a href="#l1.3823"></a><span id="l1.3823">     /**</span>
<a href="#l1.3824"></a><span id="l1.3824">      * Get the default type based on this property's name.</span>
<a href="#l1.3825"></a><span id="l1.3825">      *</span>
<a href="#l1.3826"></a><span id="l1.3826" class="difflineminus">-     * @return {String} the default type for this property.</span>
<a href="#l1.3827"></a><span id="l1.3827" class="difflineplus">+     * @return {String}     The default type for this property</span>
<a href="#l1.3828"></a><span id="l1.3828">      */</span>
<a href="#l1.3829"></a><span id="l1.3829">     getDefaultType: function() {</span>
<a href="#l1.3830"></a><span id="l1.3830" class="difflineminus">-      var name = this.name</span>
<a href="#l1.3831"></a><span id="l1.3831" class="difflineminus">-      if (name in design.property) {</span>
<a href="#l1.3832"></a><span id="l1.3832" class="difflineminus">-        var details = design.property[name];</span>
<a href="#l1.3833"></a><span id="l1.3833" class="difflineplus">+      var name = this.jCal[NAME_INDEX];</span>
<a href="#l1.3834"></a><span id="l1.3834" class="difflineplus">+      var designSet = this._designSet;</span>
<a href="#l1.3835"></a><span id="l1.3835" class="difflineplus">+</span>
<a href="#l1.3836"></a><span id="l1.3836" class="difflineplus">+      if (name in designSet.property) {</span>
<a href="#l1.3837"></a><span id="l1.3837" class="difflineplus">+        var details = designSet.property[name];</span>
<a href="#l1.3838"></a><span id="l1.3838">         if ('defaultType' in details) {</span>
<a href="#l1.3839"></a><span id="l1.3839">           return details.defaultType;</span>
<a href="#l1.3840"></a><span id="l1.3840">         }</span>
<a href="#l1.3841"></a><span id="l1.3841">       }</span>
<a href="#l1.3842"></a><span id="l1.3842" class="difflineminus">-      return null;</span>
<a href="#l1.3843"></a><span id="l1.3843" class="difflineminus">-    },</span>
<a href="#l1.3844"></a><span id="l1.3844" class="difflineminus">-</span>
<a href="#l1.3845"></a><span id="l1.3845" class="difflineminus">-    /**</span>
<a href="#l1.3846"></a><span id="l1.3846" class="difflineminus">-     * Sets type of property and clears out any</span>
<a href="#l1.3847"></a><span id="l1.3847" class="difflineminus">-     * existing values of the current type.</span>
<a href="#l1.3848"></a><span id="l1.3848" class="difflineminus">-     *</span>
<a href="#l1.3849"></a><span id="l1.3849" class="difflineminus">-     * @param {String} type new iCAL type (see design.values).</span>
<a href="#l1.3850"></a><span id="l1.3850" class="difflineplus">+      return design.defaultType;</span>
<a href="#l1.3851"></a><span id="l1.3851" class="difflineplus">+    },</span>
<a href="#l1.3852"></a><span id="l1.3852" class="difflineplus">+</span>
<a href="#l1.3853"></a><span id="l1.3853" class="difflineplus">+    /**</span>
<a href="#l1.3854"></a><span id="l1.3854" class="difflineplus">+     * Sets type of property and clears out any existing values of the current</span>
<a href="#l1.3855"></a><span id="l1.3855" class="difflineplus">+     * type.</span>
<a href="#l1.3856"></a><span id="l1.3856" class="difflineplus">+     *</span>
<a href="#l1.3857"></a><span id="l1.3857" class="difflineplus">+     * @param {String} type     New iCAL type (see design.*.values)</span>
<a href="#l1.3858"></a><span id="l1.3858">      */</span>
<a href="#l1.3859"></a><span id="l1.3859">     resetType: function(type) {</span>
<a href="#l1.3860"></a><span id="l1.3860">       this.removeAllValues();</span>
<a href="#l1.3861"></a><span id="l1.3861">       this.jCal[TYPE_INDEX] = type;</span>
<a href="#l1.3862"></a><span id="l1.3862">       this._updateType();</span>
<a href="#l1.3863"></a><span id="l1.3863">     },</span>
<a href="#l1.3864"></a><span id="l1.3864"> </span>
<a href="#l1.3865"></a><span id="l1.3865">     /**</span>
<a href="#l1.3866"></a><span id="l1.3866" class="difflineminus">-     * Finds first property value.</span>
<a href="#l1.3867"></a><span id="l1.3867" class="difflineminus">-     *</span>
<a href="#l1.3868"></a><span id="l1.3868" class="difflineminus">-     * @return {String} first property value.</span>
<a href="#l1.3869"></a><span id="l1.3869" class="difflineplus">+     * Finds the first property value.</span>
<a href="#l1.3870"></a><span id="l1.3870" class="difflineplus">+     *</span>
<a href="#l1.3871"></a><span id="l1.3871" class="difflineplus">+     * @return {String}         First property value</span>
<a href="#l1.3872"></a><span id="l1.3872">      */</span>
<a href="#l1.3873"></a><span id="l1.3873">     getFirstValue: function() {</span>
<a href="#l1.3874"></a><span id="l1.3874">       return this._hydrateValue(0);</span>
<a href="#l1.3875"></a><span id="l1.3875">     },</span>
<a href="#l1.3876"></a><span id="l1.3876"> </span>
<a href="#l1.3877"></a><span id="l1.3877">     /**</span>
<a href="#l1.3878"></a><span id="l1.3878">      * Gets all values on the property.</span>
<a href="#l1.3879"></a><span id="l1.3879">      *</span>
<a href="#l1.3880"></a><span id="l1.3880">      * NOTE: this creates an array during each call.</span>
<a href="#l1.3881"></a><span id="l1.3881">      *</span>
<a href="#l1.3882"></a><span id="l1.3882" class="difflineminus">-     * @return {Array} list of values.</span>
<a href="#l1.3883"></a><span id="l1.3883" class="difflineplus">+     * @return {Array}          List of values</span>
<a href="#l1.3884"></a><span id="l1.3884">      */</span>
<a href="#l1.3885"></a><span id="l1.3885">     getValues: function() {</span>
<a href="#l1.3886"></a><span id="l1.3886">       var len = this.jCal.length - VALUE_INDEX;</span>
<a href="#l1.3887"></a><span id="l1.3887"> </span>
<a href="#l1.3888"></a><span id="l1.3888">       if (len &lt; 1) {</span>
<a href="#l1.3889"></a><span id="l1.3889">         // its possible for a property to have no value.</span>
<a href="#l1.3890"></a><span id="l1.3890">         return [];</span>
<a href="#l1.3891"></a><span id="l1.3891">       }</span>
<a href="#l1.3892"></a><span id="l1.3892" class="difflineat">@@ -2181,28 +3001,31 @@ ICAL.Property = (function() {</span>
<a href="#l1.3893"></a><span id="l1.3893"> </span>
<a href="#l1.3894"></a><span id="l1.3894">       for (; i &lt; len; i++) {</span>
<a href="#l1.3895"></a><span id="l1.3895">         result[i] = this._hydrateValue(i);</span>
<a href="#l1.3896"></a><span id="l1.3896">       }</span>
<a href="#l1.3897"></a><span id="l1.3897"> </span>
<a href="#l1.3898"></a><span id="l1.3898">       return result;</span>
<a href="#l1.3899"></a><span id="l1.3899">     },</span>
<a href="#l1.3900"></a><span id="l1.3900"> </span>
<a href="#l1.3901"></a><span id="l1.3901" class="difflineplus">+    /**</span>
<a href="#l1.3902"></a><span id="l1.3902" class="difflineplus">+     * Removes all values from this property</span>
<a href="#l1.3903"></a><span id="l1.3903" class="difflineplus">+     */</span>
<a href="#l1.3904"></a><span id="l1.3904">     removeAllValues: function() {</span>
<a href="#l1.3905"></a><span id="l1.3905">       if (this._values) {</span>
<a href="#l1.3906"></a><span id="l1.3906">         this._values.length = 0;</span>
<a href="#l1.3907"></a><span id="l1.3907">       }</span>
<a href="#l1.3908"></a><span id="l1.3908">       this.jCal.length = 3;</span>
<a href="#l1.3909"></a><span id="l1.3909">     },</span>
<a href="#l1.3910"></a><span id="l1.3910"> </span>
<a href="#l1.3911"></a><span id="l1.3911">     /**</span>
<a href="#l1.3912"></a><span id="l1.3912" class="difflineminus">-     * Sets the values of the property.</span>
<a href="#l1.3913"></a><span id="l1.3913" class="difflineminus">-     * Will overwrite the existing values.</span>
<a href="#l1.3914"></a><span id="l1.3914" class="difflineminus">-     *</span>
<a href="#l1.3915"></a><span id="l1.3915" class="difflineminus">-     * @param {Array} values an array of values.</span>
<a href="#l1.3916"></a><span id="l1.3916" class="difflineplus">+     * Sets the values of the property.  Will overwrite the existing values.</span>
<a href="#l1.3917"></a><span id="l1.3917" class="difflineplus">+     * This can only be used for multi-value properties.</span>
<a href="#l1.3918"></a><span id="l1.3918" class="difflineplus">+     *</span>
<a href="#l1.3919"></a><span id="l1.3919" class="difflineplus">+     * @param {Array} values    An array of values</span>
<a href="#l1.3920"></a><span id="l1.3920">      */</span>
<a href="#l1.3921"></a><span id="l1.3921">     setValues: function(values) {</span>
<a href="#l1.3922"></a><span id="l1.3922">       if (!this.isMultiValue) {</span>
<a href="#l1.3923"></a><span id="l1.3923">         throw new Error(</span>
<a href="#l1.3924"></a><span id="l1.3924">           this.name + ': does not not support mulitValue.\n' +</span>
<a href="#l1.3925"></a><span id="l1.3925">           'override isMultiValue'</span>
<a href="#l1.3926"></a><span id="l1.3926">         );</span>
<a href="#l1.3927"></a><span id="l1.3927">       }</span>
<a href="#l1.3928"></a><span id="l1.3928" class="difflineat">@@ -2227,104 +3050,308 @@ ICAL.Property = (function() {</span>
<a href="#l1.3929"></a><span id="l1.3929">         }</span>
<a href="#l1.3930"></a><span id="l1.3930">       }</span>
<a href="#l1.3931"></a><span id="l1.3931">     },</span>
<a href="#l1.3932"></a><span id="l1.3932"> </span>
<a href="#l1.3933"></a><span id="l1.3933">     /**</span>
<a href="#l1.3934"></a><span id="l1.3934">      * Sets the current value of the property. If this is a multi-value</span>
<a href="#l1.3935"></a><span id="l1.3935">      * property, all other values will be removed.</span>
<a href="#l1.3936"></a><span id="l1.3936">      *</span>
<a href="#l1.3937"></a><span id="l1.3937" class="difflineminus">-     * @param {String|Object} value new prop value.</span>
<a href="#l1.3938"></a><span id="l1.3938" class="difflineplus">+     * @param {String|Object} value     New property value.</span>
<a href="#l1.3939"></a><span id="l1.3939">      */</span>
<a href="#l1.3940"></a><span id="l1.3940">     setValue: function(value) {</span>
<a href="#l1.3941"></a><span id="l1.3941">       this.removeAllValues();</span>
<a href="#l1.3942"></a><span id="l1.3942">       if (typeof(value) === 'object' &amp;&amp; 'icaltype' in value) {</span>
<a href="#l1.3943"></a><span id="l1.3943">         this.resetType(value.icaltype);</span>
<a href="#l1.3944"></a><span id="l1.3944">       }</span>
<a href="#l1.3945"></a><span id="l1.3945"> </span>
<a href="#l1.3946"></a><span id="l1.3946">       if (this.isDecorated) {</span>
<a href="#l1.3947"></a><span id="l1.3947">         this._setDecoratedValue(value, 0);</span>
<a href="#l1.3948"></a><span id="l1.3948">       } else {</span>
<a href="#l1.3949"></a><span id="l1.3949">         this.jCal[VALUE_INDEX] = value;</span>
<a href="#l1.3950"></a><span id="l1.3950">       }</span>
<a href="#l1.3951"></a><span id="l1.3951">     },</span>
<a href="#l1.3952"></a><span id="l1.3952"> </span>
<a href="#l1.3953"></a><span id="l1.3953">     /**</span>
<a href="#l1.3954"></a><span id="l1.3954" class="difflineminus">-     * Returns the jCal representation of this property.</span>
<a href="#l1.3955"></a><span id="l1.3955" class="difflineminus">-     *</span>
<a href="#l1.3956"></a><span id="l1.3956" class="difflineminus">-     * @return {Object} jCal.</span>
<a href="#l1.3957"></a><span id="l1.3957" class="difflineplus">+     * Returns the Object representation of this component. The returned object</span>
<a href="#l1.3958"></a><span id="l1.3958" class="difflineplus">+     * is a live jCal object and should be cloned if modified.</span>
<a href="#l1.3959"></a><span id="l1.3959" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.3960"></a><span id="l1.3960">      */</span>
<a href="#l1.3961"></a><span id="l1.3961">     toJSON: function() {</span>
<a href="#l1.3962"></a><span id="l1.3962">       return this.jCal;</span>
<a href="#l1.3963"></a><span id="l1.3963">     },</span>
<a href="#l1.3964"></a><span id="l1.3964"> </span>
<a href="#l1.3965"></a><span id="l1.3965" class="difflineminus">-    toICAL: function() {</span>
<a href="#l1.3966"></a><span id="l1.3966" class="difflineplus">+    /**</span>
<a href="#l1.3967"></a><span id="l1.3967" class="difflineplus">+     * The string representation of this component.</span>
<a href="#l1.3968"></a><span id="l1.3968" class="difflineplus">+     * @return {String}</span>
<a href="#l1.3969"></a><span id="l1.3969" class="difflineplus">+     */</span>
<a href="#l1.3970"></a><span id="l1.3970" class="difflineplus">+    toICALString: function() {</span>
<a href="#l1.3971"></a><span id="l1.3971">       return ICAL.stringify.property(</span>
<a href="#l1.3972"></a><span id="l1.3972" class="difflineminus">-        this.jCal</span>
<a href="#l1.3973"></a><span id="l1.3973" class="difflineplus">+        this.jCal, this._designSet, true</span>
<a href="#l1.3974"></a><span id="l1.3974">       );</span>
<a href="#l1.3975"></a><span id="l1.3975">     }</span>
<a href="#l1.3976"></a><span id="l1.3976" class="difflineminus">-</span>
<a href="#l1.3977"></a><span id="l1.3977" class="difflineplus">+  };</span>
<a href="#l1.3978"></a><span id="l1.3978" class="difflineplus">+</span>
<a href="#l1.3979"></a><span id="l1.3979" class="difflineplus">+  /**</span>
<a href="#l1.3980"></a><span id="l1.3980" class="difflineplus">+   * Create an {@link ICAL.Property} by parsing the passed iCalendar string.</span>
<a href="#l1.3981"></a><span id="l1.3981" class="difflineplus">+   *</span>
<a href="#l1.3982"></a><span id="l1.3982" class="difflineplus">+   * @param {String} str                        The iCalendar string to parse</span>
<a href="#l1.3983"></a><span id="l1.3983" class="difflineplus">+   * @param {ICAL.design.designSet=} designSet  The design data to use for this property</span>
<a href="#l1.3984"></a><span id="l1.3984" class="difflineplus">+   * @return {ICAL.Property}                    The created iCalendar property</span>
<a href="#l1.3985"></a><span id="l1.3985" class="difflineplus">+   */</span>
<a href="#l1.3986"></a><span id="l1.3986" class="difflineplus">+  Property.fromString = function(str, designSet) {</span>
<a href="#l1.3987"></a><span id="l1.3987" class="difflineplus">+    return new Property(ICAL.parse.property(str, designSet));</span>
<a href="#l1.3988"></a><span id="l1.3988">   };</span>
<a href="#l1.3989"></a><span id="l1.3989"> </span>
<a href="#l1.3990"></a><span id="l1.3990">   return Property;</span>
<a href="#l1.3991"></a><span id="l1.3991" class="difflineminus">-</span>
<a href="#l1.3992"></a><span id="l1.3992"> }());</span>
<a href="#l1.3993"></a><span id="l1.3993" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.3994"></a><span id="l1.3994" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.3995"></a><span id="l1.3995" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.3996"></a><span id="l1.3996" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.3997"></a><span id="l1.3997" class="difflineplus">+</span>
<a href="#l1.3998"></a><span id="l1.3998" class="difflineplus">+</span>
<a href="#l1.3999"></a><span id="l1.3999" class="difflineplus">+/**</span>
<a href="#l1.4000"></a><span id="l1.4000" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.4001"></a><span id="l1.4001" class="difflineplus">+ * @ignore</span>
<a href="#l1.4002"></a><span id="l1.4002" class="difflineplus">+ */</span>
<a href="#l1.4003"></a><span id="l1.4003"> ICAL.UtcOffset = (function() {</span>
<a href="#l1.4004"></a><span id="l1.4004"> </span>
<a href="#l1.4005"></a><span id="l1.4005" class="difflineplus">+  /**</span>
<a href="#l1.4006"></a><span id="l1.4006" class="difflineplus">+   * @classdesc</span>
<a href="#l1.4007"></a><span id="l1.4007" class="difflineplus">+   * This class represents the &quot;duration&quot; value type, with various calculation</span>
<a href="#l1.4008"></a><span id="l1.4008" class="difflineplus">+   * and manipulation methods.</span>
<a href="#l1.4009"></a><span id="l1.4009" class="difflineplus">+   *</span>
<a href="#l1.4010"></a><span id="l1.4010" class="difflineplus">+   * @class</span>
<a href="#l1.4011"></a><span id="l1.4011" class="difflineplus">+   * @alias ICAL.UtcOffset</span>
<a href="#l1.4012"></a><span id="l1.4012" class="difflineplus">+   * @param {Object} aData          An object with members of the utc offset</span>
<a href="#l1.4013"></a><span id="l1.4013" class="difflineplus">+   * @param {Number=} aData.hours   The hours for the utc offset</span>
<a href="#l1.4014"></a><span id="l1.4014" class="difflineplus">+   * @param {Number=} aData.minutes The minutes in the utc offset</span>
<a href="#l1.4015"></a><span id="l1.4015" class="difflineplus">+   * @param {Number=} aData.factor  The factor for the utc-offset, either -1 or 1</span>
<a href="#l1.4016"></a><span id="l1.4016" class="difflineplus">+   */</span>
<a href="#l1.4017"></a><span id="l1.4017">   function UtcOffset(aData) {</span>
<a href="#l1.4018"></a><span id="l1.4018" class="difflineminus">-    this.hours = aData.hours;</span>
<a href="#l1.4019"></a><span id="l1.4019" class="difflineminus">-    this.minutes = aData.minutes;</span>
<a href="#l1.4020"></a><span id="l1.4020" class="difflineminus">-    this.factor = aData.factor;</span>
<a href="#l1.4021"></a><span id="l1.4021" class="difflineminus">-  };</span>
<a href="#l1.4022"></a><span id="l1.4022" class="difflineplus">+    this.fromData(aData);</span>
<a href="#l1.4023"></a><span id="l1.4023" class="difflineplus">+  }</span>
<a href="#l1.4024"></a><span id="l1.4024"> </span>
<a href="#l1.4025"></a><span id="l1.4025">   UtcOffset.prototype = {</span>
<a href="#l1.4026"></a><span id="l1.4026"> </span>
<a href="#l1.4027"></a><span id="l1.4027" class="difflineminus">-    hours: null,</span>
<a href="#l1.4028"></a><span id="l1.4028" class="difflineminus">-    minutes: null,</span>
<a href="#l1.4029"></a><span id="l1.4029" class="difflineminus">-    factor: null,</span>
<a href="#l1.4030"></a><span id="l1.4030" class="difflineminus">-</span>
<a href="#l1.4031"></a><span id="l1.4031" class="difflineplus">+    /**</span>
<a href="#l1.4032"></a><span id="l1.4032" class="difflineplus">+     * The hours in the utc-offset</span>
<a href="#l1.4033"></a><span id="l1.4033" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4034"></a><span id="l1.4034" class="difflineplus">+     */</span>
<a href="#l1.4035"></a><span id="l1.4035" class="difflineplus">+    hours: 0,</span>
<a href="#l1.4036"></a><span id="l1.4036" class="difflineplus">+</span>
<a href="#l1.4037"></a><span id="l1.4037" class="difflineplus">+    /**</span>
<a href="#l1.4038"></a><span id="l1.4038" class="difflineplus">+     * The minutes in the utc-offset</span>
<a href="#l1.4039"></a><span id="l1.4039" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4040"></a><span id="l1.4040" class="difflineplus">+     */</span>
<a href="#l1.4041"></a><span id="l1.4041" class="difflineplus">+    minutes: 0,</span>
<a href="#l1.4042"></a><span id="l1.4042" class="difflineplus">+</span>
<a href="#l1.4043"></a><span id="l1.4043" class="difflineplus">+    /**</span>
<a href="#l1.4044"></a><span id="l1.4044" class="difflineplus">+     * The sign of the utc offset, 1 for positive offset, -1 for negative</span>
<a href="#l1.4045"></a><span id="l1.4045" class="difflineplus">+     * offsets.</span>
<a href="#l1.4046"></a><span id="l1.4046" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4047"></a><span id="l1.4047" class="difflineplus">+     */</span>
<a href="#l1.4048"></a><span id="l1.4048" class="difflineplus">+    factor: 1,</span>
<a href="#l1.4049"></a><span id="l1.4049" class="difflineplus">+</span>
<a href="#l1.4050"></a><span id="l1.4050" class="difflineplus">+    /**</span>
<a href="#l1.4051"></a><span id="l1.4051" class="difflineplus">+     * The type name, to be used in the jCal object.</span>
<a href="#l1.4052"></a><span id="l1.4052" class="difflineplus">+     * @constant</span>
<a href="#l1.4053"></a><span id="l1.4053" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4054"></a><span id="l1.4054" class="difflineplus">+     * @default &quot;utc-offset&quot;</span>
<a href="#l1.4055"></a><span id="l1.4055" class="difflineplus">+     */</span>
<a href="#l1.4056"></a><span id="l1.4056">     icaltype: &quot;utc-offset&quot;,</span>
<a href="#l1.4057"></a><span id="l1.4057"> </span>
<a href="#l1.4058"></a><span id="l1.4058" class="difflineplus">+    /**</span>
<a href="#l1.4059"></a><span id="l1.4059" class="difflineplus">+     * Returns a clone of the utc offset object.</span>
<a href="#l1.4060"></a><span id="l1.4060" class="difflineplus">+     *</span>
<a href="#l1.4061"></a><span id="l1.4061" class="difflineplus">+     * @return {ICAL.UtcOffset}     The cloned object</span>
<a href="#l1.4062"></a><span id="l1.4062" class="difflineplus">+     */</span>
<a href="#l1.4063"></a><span id="l1.4063" class="difflineplus">+    clone: function() {</span>
<a href="#l1.4064"></a><span id="l1.4064" class="difflineplus">+      return ICAL.UtcOffset.fromSeconds(this.toSeconds());</span>
<a href="#l1.4065"></a><span id="l1.4065" class="difflineplus">+    },</span>
<a href="#l1.4066"></a><span id="l1.4066" class="difflineplus">+</span>
<a href="#l1.4067"></a><span id="l1.4067" class="difflineplus">+    /**</span>
<a href="#l1.4068"></a><span id="l1.4068" class="difflineplus">+     * Sets up the current instance using members from the passed data object.</span>
<a href="#l1.4069"></a><span id="l1.4069" class="difflineplus">+     *</span>
<a href="#l1.4070"></a><span id="l1.4070" class="difflineplus">+     * @param {Object} aData          An object with members of the utc offset</span>
<a href="#l1.4071"></a><span id="l1.4071" class="difflineplus">+     * @param {Number=} aData.hours   The hours for the utc offset</span>
<a href="#l1.4072"></a><span id="l1.4072" class="difflineplus">+     * @param {Number=} aData.minutes The minutes in the utc offset</span>
<a href="#l1.4073"></a><span id="l1.4073" class="difflineplus">+     * @param {Number=} aData.factor  The factor for the utc-offset, either -1 or 1</span>
<a href="#l1.4074"></a><span id="l1.4074" class="difflineplus">+     */</span>
<a href="#l1.4075"></a><span id="l1.4075" class="difflineplus">+    fromData: function(aData) {</span>
<a href="#l1.4076"></a><span id="l1.4076" class="difflineplus">+      if (aData) {</span>
<a href="#l1.4077"></a><span id="l1.4077" class="difflineplus">+        for (var key in aData) {</span>
<a href="#l1.4078"></a><span id="l1.4078" class="difflineplus">+          /* istanbul ignore else */</span>
<a href="#l1.4079"></a><span id="l1.4079" class="difflineplus">+          if (aData.hasOwnProperty(key)) {</span>
<a href="#l1.4080"></a><span id="l1.4080" class="difflineplus">+            this[key] = aData[key];</span>
<a href="#l1.4081"></a><span id="l1.4081" class="difflineplus">+          }</span>
<a href="#l1.4082"></a><span id="l1.4082" class="difflineplus">+        }</span>
<a href="#l1.4083"></a><span id="l1.4083" class="difflineplus">+      }</span>
<a href="#l1.4084"></a><span id="l1.4084" class="difflineplus">+      this._normalize();</span>
<a href="#l1.4085"></a><span id="l1.4085" class="difflineplus">+    },</span>
<a href="#l1.4086"></a><span id="l1.4086" class="difflineplus">+</span>
<a href="#l1.4087"></a><span id="l1.4087" class="difflineplus">+    /**</span>
<a href="#l1.4088"></a><span id="l1.4088" class="difflineplus">+     * Sets up the current instance from the given seconds value. The seconds</span>
<a href="#l1.4089"></a><span id="l1.4089" class="difflineplus">+     * value is truncated to the minute. Offsets are wrapped when the world</span>
<a href="#l1.4090"></a><span id="l1.4090" class="difflineplus">+     * ends, the hour after UTC+14:00 is UTC-12:00.</span>
<a href="#l1.4091"></a><span id="l1.4091" class="difflineplus">+     *</span>
<a href="#l1.4092"></a><span id="l1.4092" class="difflineplus">+     * @param {Number} aSeconds         The seconds to convert into an offset</span>
<a href="#l1.4093"></a><span id="l1.4093" class="difflineplus">+     */</span>
<a href="#l1.4094"></a><span id="l1.4094" class="difflineplus">+    fromSeconds: function(aSeconds) {</span>
<a href="#l1.4095"></a><span id="l1.4095" class="difflineplus">+      var secs = Math.abs(aSeconds);</span>
<a href="#l1.4096"></a><span id="l1.4096" class="difflineplus">+</span>
<a href="#l1.4097"></a><span id="l1.4097" class="difflineplus">+      this.factor = aSeconds &lt; 0 ? -1 : 1;</span>
<a href="#l1.4098"></a><span id="l1.4098" class="difflineplus">+      this.hours = ICAL.helpers.trunc(secs / 3600);</span>
<a href="#l1.4099"></a><span id="l1.4099" class="difflineplus">+</span>
<a href="#l1.4100"></a><span id="l1.4100" class="difflineplus">+      secs -= (this.hours * 3600);</span>
<a href="#l1.4101"></a><span id="l1.4101" class="difflineplus">+      this.minutes = ICAL.helpers.trunc(secs / 60);</span>
<a href="#l1.4102"></a><span id="l1.4102" class="difflineplus">+      return this;</span>
<a href="#l1.4103"></a><span id="l1.4103" class="difflineplus">+    },</span>
<a href="#l1.4104"></a><span id="l1.4104" class="difflineplus">+</span>
<a href="#l1.4105"></a><span id="l1.4105" class="difflineplus">+    /**</span>
<a href="#l1.4106"></a><span id="l1.4106" class="difflineplus">+     * Convert the current offset to a value in seconds</span>
<a href="#l1.4107"></a><span id="l1.4107" class="difflineplus">+     *</span>
<a href="#l1.4108"></a><span id="l1.4108" class="difflineplus">+     * @return {Number}                 The offset in seconds</span>
<a href="#l1.4109"></a><span id="l1.4109" class="difflineplus">+     */</span>
<a href="#l1.4110"></a><span id="l1.4110" class="difflineplus">+    toSeconds: function() {</span>
<a href="#l1.4111"></a><span id="l1.4111" class="difflineplus">+      return this.factor * (60 * this.minutes + 3600 * this.hours);</span>
<a href="#l1.4112"></a><span id="l1.4112" class="difflineplus">+    },</span>
<a href="#l1.4113"></a><span id="l1.4113" class="difflineplus">+</span>
<a href="#l1.4114"></a><span id="l1.4114" class="difflineplus">+    /**</span>
<a href="#l1.4115"></a><span id="l1.4115" class="difflineplus">+     * Compare this utc offset with another one.</span>
<a href="#l1.4116"></a><span id="l1.4116" class="difflineplus">+     *</span>
<a href="#l1.4117"></a><span id="l1.4117" class="difflineplus">+     * @param {ICAL.UtcOffset} other        The other offset to compare with</span>
<a href="#l1.4118"></a><span id="l1.4118" class="difflineplus">+     * @return {Number}                     -1, 0 or 1 for less/equal/greater</span>
<a href="#l1.4119"></a><span id="l1.4119" class="difflineplus">+     */</span>
<a href="#l1.4120"></a><span id="l1.4120" class="difflineplus">+    compare: function icaltime_compare(other) {</span>
<a href="#l1.4121"></a><span id="l1.4121" class="difflineplus">+      var a = this.toSeconds();</span>
<a href="#l1.4122"></a><span id="l1.4122" class="difflineplus">+      var b = other.toSeconds();</span>
<a href="#l1.4123"></a><span id="l1.4123" class="difflineplus">+      return (a &gt; b) - (b &gt; a);</span>
<a href="#l1.4124"></a><span id="l1.4124" class="difflineplus">+    },</span>
<a href="#l1.4125"></a><span id="l1.4125" class="difflineplus">+</span>
<a href="#l1.4126"></a><span id="l1.4126" class="difflineplus">+    _normalize: function() {</span>
<a href="#l1.4127"></a><span id="l1.4127" class="difflineplus">+      // Range: 97200 seconds (with 1 hour inbetween)</span>
<a href="#l1.4128"></a><span id="l1.4128" class="difflineplus">+      var secs = this.toSeconds();</span>
<a href="#l1.4129"></a><span id="l1.4129" class="difflineplus">+      var factor = this.factor;</span>
<a href="#l1.4130"></a><span id="l1.4130" class="difflineplus">+      while (secs &lt; -43200) { // = UTC-12:00</span>
<a href="#l1.4131"></a><span id="l1.4131" class="difflineplus">+        secs += 97200;</span>
<a href="#l1.4132"></a><span id="l1.4132" class="difflineplus">+      }</span>
<a href="#l1.4133"></a><span id="l1.4133" class="difflineplus">+      while (secs &gt; 50400) { // = UTC+14:00</span>
<a href="#l1.4134"></a><span id="l1.4134" class="difflineplus">+        secs -= 97200;</span>
<a href="#l1.4135"></a><span id="l1.4135" class="difflineplus">+      }</span>
<a href="#l1.4136"></a><span id="l1.4136" class="difflineplus">+</span>
<a href="#l1.4137"></a><span id="l1.4137" class="difflineplus">+      this.fromSeconds(secs);</span>
<a href="#l1.4138"></a><span id="l1.4138" class="difflineplus">+</span>
<a href="#l1.4139"></a><span id="l1.4139" class="difflineplus">+      // Avoid changing the factor when on zero seconds</span>
<a href="#l1.4140"></a><span id="l1.4140" class="difflineplus">+      if (secs == 0) {</span>
<a href="#l1.4141"></a><span id="l1.4141" class="difflineplus">+        this.factor = factor;</span>
<a href="#l1.4142"></a><span id="l1.4142" class="difflineplus">+      }</span>
<a href="#l1.4143"></a><span id="l1.4143" class="difflineplus">+    },</span>
<a href="#l1.4144"></a><span id="l1.4144" class="difflineplus">+</span>
<a href="#l1.4145"></a><span id="l1.4145" class="difflineplus">+    /**</span>
<a href="#l1.4146"></a><span id="l1.4146" class="difflineplus">+     * The iCalendar string representation of this utc-offset.</span>
<a href="#l1.4147"></a><span id="l1.4147" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4148"></a><span id="l1.4148" class="difflineplus">+     */</span>
<a href="#l1.4149"></a><span id="l1.4149" class="difflineplus">+    toICALString: function() {</span>
<a href="#l1.4150"></a><span id="l1.4150" class="difflineplus">+      return ICAL.design.icalendar.value['utc-offset'].toICAL(this.toString());</span>
<a href="#l1.4151"></a><span id="l1.4151" class="difflineplus">+    },</span>
<a href="#l1.4152"></a><span id="l1.4152" class="difflineplus">+</span>
<a href="#l1.4153"></a><span id="l1.4153" class="difflineplus">+    /**</span>
<a href="#l1.4154"></a><span id="l1.4154" class="difflineplus">+     * The string representation of this utc-offset.</span>
<a href="#l1.4155"></a><span id="l1.4155" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4156"></a><span id="l1.4156" class="difflineplus">+     */</span>
<a href="#l1.4157"></a><span id="l1.4157">     toString: function toString() {</span>
<a href="#l1.4158"></a><span id="l1.4158">       return (this.factor == 1 ? &quot;+&quot; : &quot;-&quot;) +</span>
<a href="#l1.4159"></a><span id="l1.4159">               ICAL.helpers.pad2(this.hours) + ':' +</span>
<a href="#l1.4160"></a><span id="l1.4160">               ICAL.helpers.pad2(this.minutes);</span>
<a href="#l1.4161"></a><span id="l1.4161">     }</span>
<a href="#l1.4162"></a><span id="l1.4162">   };</span>
<a href="#l1.4163"></a><span id="l1.4163"> </span>
<a href="#l1.4164"></a><span id="l1.4164" class="difflineplus">+  /**</span>
<a href="#l1.4165"></a><span id="l1.4165" class="difflineplus">+   * Creates a new {@link ICAL.UtcOffset} instance from the passed string.</span>
<a href="#l1.4166"></a><span id="l1.4166" class="difflineplus">+   *</span>
<a href="#l1.4167"></a><span id="l1.4167" class="difflineplus">+   * @param {String} aString    The string to parse</span>
<a href="#l1.4168"></a><span id="l1.4168" class="difflineplus">+   * @return {ICAL.Duration}    The created utc-offset instance</span>
<a href="#l1.4169"></a><span id="l1.4169" class="difflineplus">+   */</span>
<a href="#l1.4170"></a><span id="l1.4170">   UtcOffset.fromString = function(aString) {</span>
<a href="#l1.4171"></a><span id="l1.4171">     // -05:00</span>
<a href="#l1.4172"></a><span id="l1.4172">     var options = {};</span>
<a href="#l1.4173"></a><span id="l1.4173">     //TODO: support seconds per rfc5545 ?</span>
<a href="#l1.4174"></a><span id="l1.4174">     options.factor = (aString[0] === '+') ? 1 : -1;</span>
<a href="#l1.4175"></a><span id="l1.4175">     options.hours = ICAL.helpers.strictParseInt(aString.substr(1, 2));</span>
<a href="#l1.4176"></a><span id="l1.4176">     options.minutes = ICAL.helpers.strictParseInt(aString.substr(4, 2));</span>
<a href="#l1.4177"></a><span id="l1.4177"> </span>
<a href="#l1.4178"></a><span id="l1.4178">     return new ICAL.UtcOffset(options);</span>
<a href="#l1.4179"></a><span id="l1.4179">   };</span>
<a href="#l1.4180"></a><span id="l1.4180"> </span>
<a href="#l1.4181"></a><span id="l1.4181" class="difflineplus">+  /**</span>
<a href="#l1.4182"></a><span id="l1.4182" class="difflineplus">+   * Creates a new {@link ICAL.UtcOffset} instance from the passed seconds</span>
<a href="#l1.4183"></a><span id="l1.4183" class="difflineplus">+   * value.</span>
<a href="#l1.4184"></a><span id="l1.4184" class="difflineplus">+   *</span>
<a href="#l1.4185"></a><span id="l1.4185" class="difflineplus">+   * @param {Number} aSeconds       The number of seconds to convert</span>
<a href="#l1.4186"></a><span id="l1.4186" class="difflineplus">+   */</span>
<a href="#l1.4187"></a><span id="l1.4187" class="difflineplus">+  UtcOffset.fromSeconds = function(aSeconds) {</span>
<a href="#l1.4188"></a><span id="l1.4188" class="difflineplus">+    var instance = new UtcOffset();</span>
<a href="#l1.4189"></a><span id="l1.4189" class="difflineplus">+    instance.fromSeconds(aSeconds);</span>
<a href="#l1.4190"></a><span id="l1.4190" class="difflineplus">+    return instance;</span>
<a href="#l1.4191"></a><span id="l1.4191" class="difflineplus">+  };</span>
<a href="#l1.4192"></a><span id="l1.4192"> </span>
<a href="#l1.4193"></a><span id="l1.4193">   return UtcOffset;</span>
<a href="#l1.4194"></a><span id="l1.4194" class="difflineminus">-</span>
<a href="#l1.4195"></a><span id="l1.4195"> }());</span>
<a href="#l1.4196"></a><span id="l1.4196" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.4197"></a><span id="l1.4197" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.4198"></a><span id="l1.4198" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.4199"></a><span id="l1.4199" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.4200"></a><span id="l1.4200" class="difflineplus">+</span>
<a href="#l1.4201"></a><span id="l1.4201" class="difflineplus">+</span>
<a href="#l1.4202"></a><span id="l1.4202" class="difflineplus">+/**</span>
<a href="#l1.4203"></a><span id="l1.4203" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.4204"></a><span id="l1.4204" class="difflineplus">+ * @ignore</span>
<a href="#l1.4205"></a><span id="l1.4205" class="difflineplus">+ */</span>
<a href="#l1.4206"></a><span id="l1.4206"> ICAL.Binary = (function() {</span>
<a href="#l1.4207"></a><span id="l1.4207"> </span>
<a href="#l1.4208"></a><span id="l1.4208" class="difflineplus">+  /**</span>
<a href="#l1.4209"></a><span id="l1.4209" class="difflineplus">+   * @classdesc</span>
<a href="#l1.4210"></a><span id="l1.4210" class="difflineplus">+   * Represents the BINARY value type, which contains extra methods for</span>
<a href="#l1.4211"></a><span id="l1.4211" class="difflineplus">+   * encoding and decoding.</span>
<a href="#l1.4212"></a><span id="l1.4212" class="difflineplus">+   *</span>
<a href="#l1.4213"></a><span id="l1.4213" class="difflineplus">+   * @class</span>
<a href="#l1.4214"></a><span id="l1.4214" class="difflineplus">+   * @alias ICAL.Binary</span>
<a href="#l1.4215"></a><span id="l1.4215" class="difflineplus">+   * @param {String} aValue     The binary data for this value</span>
<a href="#l1.4216"></a><span id="l1.4216" class="difflineplus">+   */</span>
<a href="#l1.4217"></a><span id="l1.4217">   function Binary(aValue) {</span>
<a href="#l1.4218"></a><span id="l1.4218">     this.value = aValue;</span>
<a href="#l1.4219"></a><span id="l1.4219" class="difflineminus">-  };</span>
<a href="#l1.4220"></a><span id="l1.4220" class="difflineplus">+  }</span>
<a href="#l1.4221"></a><span id="l1.4221"> </span>
<a href="#l1.4222"></a><span id="l1.4222">   Binary.prototype = {</span>
<a href="#l1.4223"></a><span id="l1.4223" class="difflineplus">+    /**</span>
<a href="#l1.4224"></a><span id="l1.4224" class="difflineplus">+     * The type name, to be used in the jCal object.</span>
<a href="#l1.4225"></a><span id="l1.4225" class="difflineplus">+     * @default &quot;binary&quot;</span>
<a href="#l1.4226"></a><span id="l1.4226" class="difflineplus">+     * @constant</span>
<a href="#l1.4227"></a><span id="l1.4227" class="difflineplus">+     */</span>
<a href="#l1.4228"></a><span id="l1.4228">     icaltype: &quot;binary&quot;,</span>
<a href="#l1.4229"></a><span id="l1.4229"> </span>
<a href="#l1.4230"></a><span id="l1.4230" class="difflineplus">+    /**</span>
<a href="#l1.4231"></a><span id="l1.4231" class="difflineplus">+     * Base64 decode the current value</span>
<a href="#l1.4232"></a><span id="l1.4232" class="difflineplus">+     *</span>
<a href="#l1.4233"></a><span id="l1.4233" class="difflineplus">+     * @return {String}         The base64-decoded value</span>
<a href="#l1.4234"></a><span id="l1.4234" class="difflineplus">+     */</span>
<a href="#l1.4235"></a><span id="l1.4235">     decodeValue: function decodeValue() {</span>
<a href="#l1.4236"></a><span id="l1.4236">       return this._b64_decode(this.value);</span>
<a href="#l1.4237"></a><span id="l1.4237">     },</span>
<a href="#l1.4238"></a><span id="l1.4238"> </span>
<a href="#l1.4239"></a><span id="l1.4239" class="difflineminus">-    setEncodedValue: function setEncodedValue(val) {</span>
<a href="#l1.4240"></a><span id="l1.4240" class="difflineminus">-      this.value = this._b64_encode(val);</span>
<a href="#l1.4241"></a><span id="l1.4241" class="difflineplus">+    /**</span>
<a href="#l1.4242"></a><span id="l1.4242" class="difflineplus">+     * Encodes the passed parameter with base64 and sets the internal</span>
<a href="#l1.4243"></a><span id="l1.4243" class="difflineplus">+     * value to the result.</span>
<a href="#l1.4244"></a><span id="l1.4244" class="difflineplus">+     *</span>
<a href="#l1.4245"></a><span id="l1.4245" class="difflineplus">+     * @param {String} aValue      The raw binary value to encode</span>
<a href="#l1.4246"></a><span id="l1.4246" class="difflineplus">+     */</span>
<a href="#l1.4247"></a><span id="l1.4247" class="difflineplus">+    setEncodedValue: function setEncodedValue(aValue) {</span>
<a href="#l1.4248"></a><span id="l1.4248" class="difflineplus">+      this.value = this._b64_encode(aValue);</span>
<a href="#l1.4249"></a><span id="l1.4249">     },</span>
<a href="#l1.4250"></a><span id="l1.4250"> </span>
<a href="#l1.4251"></a><span id="l1.4251">     _b64_encode: function base64_encode(data) {</span>
<a href="#l1.4252"></a><span id="l1.4252">       // http://kevin.vanzonneveld.net</span>
<a href="#l1.4253"></a><span id="l1.4253">       // +   original by: Tyler Akins (http://rumkin.com)</span>
<a href="#l1.4254"></a><span id="l1.4254">       // +   improved by: Bayron Guevara</span>
<a href="#l1.4255"></a><span id="l1.4255">       // +   improved by: Thunder.m</span>
<a href="#l1.4256"></a><span id="l1.4256">       // +   improved by: Kevin van Zonneveld (http://kevin.vanzonneveld.net)</span>
<a href="#l1.4257"></a><span id="l1.4257" class="difflineat">@@ -2425,37 +3452,59 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4258"></a><span id="l1.4258">         }</span>
<a href="#l1.4259"></a><span id="l1.4259">       } while (i &lt; data.length);</span>
<a href="#l1.4260"></a><span id="l1.4260"> </span>
<a href="#l1.4261"></a><span id="l1.4261">       dec = tmp_arr.join('');</span>
<a href="#l1.4262"></a><span id="l1.4262"> </span>
<a href="#l1.4263"></a><span id="l1.4263">       return dec;</span>
<a href="#l1.4264"></a><span id="l1.4264">     },</span>
<a href="#l1.4265"></a><span id="l1.4265"> </span>
<a href="#l1.4266"></a><span id="l1.4266" class="difflineplus">+    /**</span>
<a href="#l1.4267"></a><span id="l1.4267" class="difflineplus">+     * The string representation of this value</span>
<a href="#l1.4268"></a><span id="l1.4268" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4269"></a><span id="l1.4269" class="difflineplus">+     */</span>
<a href="#l1.4270"></a><span id="l1.4270">     toString: function() {</span>
<a href="#l1.4271"></a><span id="l1.4271">       return this.value;</span>
<a href="#l1.4272"></a><span id="l1.4272">     }</span>
<a href="#l1.4273"></a><span id="l1.4273">   };</span>
<a href="#l1.4274"></a><span id="l1.4274"> </span>
<a href="#l1.4275"></a><span id="l1.4275" class="difflineplus">+  /**</span>
<a href="#l1.4276"></a><span id="l1.4276" class="difflineplus">+   * Creates a binary value from the given string.</span>
<a href="#l1.4277"></a><span id="l1.4277" class="difflineplus">+   *</span>
<a href="#l1.4278"></a><span id="l1.4278" class="difflineplus">+   * @param {String} aString        The binary value string</span>
<a href="#l1.4279"></a><span id="l1.4279" class="difflineplus">+   * @return {ICAL.Binary}          The binary value instance</span>
<a href="#l1.4280"></a><span id="l1.4280" class="difflineplus">+   */</span>
<a href="#l1.4281"></a><span id="l1.4281">   Binary.fromString = function(aString) {</span>
<a href="#l1.4282"></a><span id="l1.4282">     return new Binary(aString);</span>
<a href="#l1.4283"></a><span id="l1.4283" class="difflineminus">-  }</span>
<a href="#l1.4284"></a><span id="l1.4284" class="difflineplus">+  };</span>
<a href="#l1.4285"></a><span id="l1.4285"> </span>
<a href="#l1.4286"></a><span id="l1.4286">   return Binary;</span>
<a href="#l1.4287"></a><span id="l1.4287" class="difflineminus">-</span>
<a href="#l1.4288"></a><span id="l1.4288"> }());</span>
<a href="#l1.4289"></a><span id="l1.4289"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.4290"></a><span id="l1.4290">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.4291"></a><span id="l1.4291">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.4292"></a><span id="l1.4292" class="difflineminus">- * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.4293"></a><span id="l1.4293" class="difflineminus">-</span>
<a href="#l1.4294"></a><span id="l1.4294" class="difflineminus">-</span>
<a href="#l1.4295"></a><span id="l1.4295" class="difflineminus">-</span>
<a href="#l1.4296"></a><span id="l1.4296" class="difflineminus">-(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l1.4297"></a><span id="l1.4297" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.4298"></a><span id="l1.4298" class="difflineplus">+</span>
<a href="#l1.4299"></a><span id="l1.4299" class="difflineplus">+</span>
<a href="#l1.4300"></a><span id="l1.4300" class="difflineplus">+</span>
<a href="#l1.4301"></a><span id="l1.4301"> (function() {</span>
<a href="#l1.4302"></a><span id="l1.4302" class="difflineplus">+  /**</span>
<a href="#l1.4303"></a><span id="l1.4303" class="difflineplus">+   * @classdesc</span>
<a href="#l1.4304"></a><span id="l1.4304" class="difflineplus">+   * This class represents the &quot;period&quot; value type, with various calculation</span>
<a href="#l1.4305"></a><span id="l1.4305" class="difflineplus">+   * and manipulation methods.</span>
<a href="#l1.4306"></a><span id="l1.4306" class="difflineplus">+   *</span>
<a href="#l1.4307"></a><span id="l1.4307" class="difflineplus">+   * @description</span>
<a href="#l1.4308"></a><span id="l1.4308" class="difflineplus">+   * The passed data object cannot contain both and end date and a duration.</span>
<a href="#l1.4309"></a><span id="l1.4309" class="difflineplus">+   *</span>
<a href="#l1.4310"></a><span id="l1.4310" class="difflineplus">+   * @class</span>
<a href="#l1.4311"></a><span id="l1.4311" class="difflineplus">+   * @param {Object} aData                  An object with members of the period</span>
<a href="#l1.4312"></a><span id="l1.4312" class="difflineplus">+   * @param {ICAL.Time=} aData.start        The start of the period</span>
<a href="#l1.4313"></a><span id="l1.4313" class="difflineplus">+   * @param {ICAL.Time=} aData.end          The end of the period</span>
<a href="#l1.4314"></a><span id="l1.4314" class="difflineplus">+   * @param {ICAL.Duration=} aData.duration The duration of the period</span>
<a href="#l1.4315"></a><span id="l1.4315" class="difflineplus">+   */</span>
<a href="#l1.4316"></a><span id="l1.4316">   ICAL.Period = function icalperiod(aData) {</span>
<a href="#l1.4317"></a><span id="l1.4317">     this.wrappedJSObject = this;</span>
<a href="#l1.4318"></a><span id="l1.4318"> </span>
<a href="#l1.4319"></a><span id="l1.4319">     if (aData &amp;&amp; 'start' in aData) {</span>
<a href="#l1.4320"></a><span id="l1.4320">       if (aData.start &amp;&amp; !(aData.start instanceof ICAL.Time)) {</span>
<a href="#l1.4321"></a><span id="l1.4321">         throw new TypeError('.start must be an instance of ICAL.Time');</span>
<a href="#l1.4322"></a><span id="l1.4322">       }</span>
<a href="#l1.4323"></a><span id="l1.4323">       this.start = aData.start;</span>
<a href="#l1.4324"></a><span id="l1.4324" class="difflineat">@@ -2477,58 +3526,126 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4325"></a><span id="l1.4325">         throw new TypeError('.duration must be an instance of ICAL.Duration');</span>
<a href="#l1.4326"></a><span id="l1.4326">       }</span>
<a href="#l1.4327"></a><span id="l1.4327">       this.duration = aData.duration;</span>
<a href="#l1.4328"></a><span id="l1.4328">     }</span>
<a href="#l1.4329"></a><span id="l1.4329">   };</span>
<a href="#l1.4330"></a><span id="l1.4330"> </span>
<a href="#l1.4331"></a><span id="l1.4331">   ICAL.Period.prototype = {</span>
<a href="#l1.4332"></a><span id="l1.4332"> </span>
<a href="#l1.4333"></a><span id="l1.4333" class="difflineplus">+    /**</span>
<a href="#l1.4334"></a><span id="l1.4334" class="difflineplus">+     * The start of the period</span>
<a href="#l1.4335"></a><span id="l1.4335" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.4336"></a><span id="l1.4336" class="difflineplus">+     */</span>
<a href="#l1.4337"></a><span id="l1.4337">     start: null,</span>
<a href="#l1.4338"></a><span id="l1.4338" class="difflineplus">+</span>
<a href="#l1.4339"></a><span id="l1.4339" class="difflineplus">+    /**</span>
<a href="#l1.4340"></a><span id="l1.4340" class="difflineplus">+     * The end of the period</span>
<a href="#l1.4341"></a><span id="l1.4341" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.4342"></a><span id="l1.4342" class="difflineplus">+     */</span>
<a href="#l1.4343"></a><span id="l1.4343">     end: null,</span>
<a href="#l1.4344"></a><span id="l1.4344" class="difflineplus">+</span>
<a href="#l1.4345"></a><span id="l1.4345" class="difflineplus">+    /**</span>
<a href="#l1.4346"></a><span id="l1.4346" class="difflineplus">+     * The duration of the period</span>
<a href="#l1.4347"></a><span id="l1.4347" class="difflineplus">+     * @type {ICAL.Duration}</span>
<a href="#l1.4348"></a><span id="l1.4348" class="difflineplus">+     */</span>
<a href="#l1.4349"></a><span id="l1.4349">     duration: null,</span>
<a href="#l1.4350"></a><span id="l1.4350" class="difflineplus">+</span>
<a href="#l1.4351"></a><span id="l1.4351" class="difflineplus">+    /**</span>
<a href="#l1.4352"></a><span id="l1.4352" class="difflineplus">+     * The class identifier.</span>
<a href="#l1.4353"></a><span id="l1.4353" class="difflineplus">+     * @constant</span>
<a href="#l1.4354"></a><span id="l1.4354" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4355"></a><span id="l1.4355" class="difflineplus">+     * @default &quot;icalperiod&quot;</span>
<a href="#l1.4356"></a><span id="l1.4356" class="difflineplus">+     */</span>
<a href="#l1.4357"></a><span id="l1.4357">     icalclass: &quot;icalperiod&quot;,</span>
<a href="#l1.4358"></a><span id="l1.4358" class="difflineplus">+</span>
<a href="#l1.4359"></a><span id="l1.4359" class="difflineplus">+    /**</span>
<a href="#l1.4360"></a><span id="l1.4360" class="difflineplus">+     * The type name, to be used in the jCal object.</span>
<a href="#l1.4361"></a><span id="l1.4361" class="difflineplus">+     * @constant</span>
<a href="#l1.4362"></a><span id="l1.4362" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4363"></a><span id="l1.4363" class="difflineplus">+     * @default &quot;period&quot;</span>
<a href="#l1.4364"></a><span id="l1.4364" class="difflineplus">+     */</span>
<a href="#l1.4365"></a><span id="l1.4365">     icaltype: &quot;period&quot;,</span>
<a href="#l1.4366"></a><span id="l1.4366"> </span>
<a href="#l1.4367"></a><span id="l1.4367" class="difflineplus">+    /**</span>
<a href="#l1.4368"></a><span id="l1.4368" class="difflineplus">+     * Returns a clone of the duration object.</span>
<a href="#l1.4369"></a><span id="l1.4369" class="difflineplus">+     *</span>
<a href="#l1.4370"></a><span id="l1.4370" class="difflineplus">+     * @return {ICAL.Period}      The cloned object</span>
<a href="#l1.4371"></a><span id="l1.4371" class="difflineplus">+     */</span>
<a href="#l1.4372"></a><span id="l1.4372">     clone: function() {</span>
<a href="#l1.4373"></a><span id="l1.4373">       return ICAL.Period.fromData({</span>
<a href="#l1.4374"></a><span id="l1.4374">         start: this.start ? this.start.clone() : null,</span>
<a href="#l1.4375"></a><span id="l1.4375">         end: this.end ? this.end.clone() : null,</span>
<a href="#l1.4376"></a><span id="l1.4376">         duration: this.duration ? this.duration.clone() : null</span>
<a href="#l1.4377"></a><span id="l1.4377">       });</span>
<a href="#l1.4378"></a><span id="l1.4378">     },</span>
<a href="#l1.4379"></a><span id="l1.4379"> </span>
<a href="#l1.4380"></a><span id="l1.4380" class="difflineplus">+    /**</span>
<a href="#l1.4381"></a><span id="l1.4381" class="difflineplus">+     * Calculates the duration of the period, either directly or by subtracting</span>
<a href="#l1.4382"></a><span id="l1.4382" class="difflineplus">+     * start from end date.</span>
<a href="#l1.4383"></a><span id="l1.4383" class="difflineplus">+     *</span>
<a href="#l1.4384"></a><span id="l1.4384" class="difflineplus">+     * @return {ICAL.Duration}      The calculated duration</span>
<a href="#l1.4385"></a><span id="l1.4385" class="difflineplus">+     */</span>
<a href="#l1.4386"></a><span id="l1.4386">     getDuration: function duration() {</span>
<a href="#l1.4387"></a><span id="l1.4387">       if (this.duration) {</span>
<a href="#l1.4388"></a><span id="l1.4388">         return this.duration;</span>
<a href="#l1.4389"></a><span id="l1.4389">       } else {</span>
<a href="#l1.4390"></a><span id="l1.4390">         return this.end.subtractDate(this.start);</span>
<a href="#l1.4391"></a><span id="l1.4391">       }</span>
<a href="#l1.4392"></a><span id="l1.4392">     },</span>
<a href="#l1.4393"></a><span id="l1.4393"> </span>
<a href="#l1.4394"></a><span id="l1.4394" class="difflineplus">+    /**</span>
<a href="#l1.4395"></a><span id="l1.4395" class="difflineplus">+     * Calculates the end date of the period, either directly or by adding</span>
<a href="#l1.4396"></a><span id="l1.4396" class="difflineplus">+     * duration to start date.</span>
<a href="#l1.4397"></a><span id="l1.4397" class="difflineplus">+     *</span>
<a href="#l1.4398"></a><span id="l1.4398" class="difflineplus">+     * @return {ICAL.Time}          The calculated end date</span>
<a href="#l1.4399"></a><span id="l1.4399" class="difflineplus">+     */</span>
<a href="#l1.4400"></a><span id="l1.4400">     getEnd: function() {</span>
<a href="#l1.4401"></a><span id="l1.4401">       if (this.end) {</span>
<a href="#l1.4402"></a><span id="l1.4402">         return this.end;</span>
<a href="#l1.4403"></a><span id="l1.4403">       } else {</span>
<a href="#l1.4404"></a><span id="l1.4404">         var end = this.start.clone();</span>
<a href="#l1.4405"></a><span id="l1.4405">         end.addDuration(this.duration);</span>
<a href="#l1.4406"></a><span id="l1.4406">         return end;</span>
<a href="#l1.4407"></a><span id="l1.4407">       }</span>
<a href="#l1.4408"></a><span id="l1.4408">     },</span>
<a href="#l1.4409"></a><span id="l1.4409"> </span>
<a href="#l1.4410"></a><span id="l1.4410" class="difflineplus">+    /**</span>
<a href="#l1.4411"></a><span id="l1.4411" class="difflineplus">+     * The string representation of this period.</span>
<a href="#l1.4412"></a><span id="l1.4412" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4413"></a><span id="l1.4413" class="difflineplus">+     */</span>
<a href="#l1.4414"></a><span id="l1.4414">     toString: function toString() {</span>
<a href="#l1.4415"></a><span id="l1.4415">       return this.start + &quot;/&quot; + (this.end || this.duration);</span>
<a href="#l1.4416"></a><span id="l1.4416">     },</span>
<a href="#l1.4417"></a><span id="l1.4417"> </span>
<a href="#l1.4418"></a><span id="l1.4418" class="difflineplus">+    /**</span>
<a href="#l1.4419"></a><span id="l1.4419" class="difflineplus">+     * The jCal representation of this period type.</span>
<a href="#l1.4420"></a><span id="l1.4420" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.4421"></a><span id="l1.4421" class="difflineplus">+     */</span>
<a href="#l1.4422"></a><span id="l1.4422" class="difflineplus">+    toJSON: function() {</span>
<a href="#l1.4423"></a><span id="l1.4423" class="difflineplus">+      return [this.start.toString(), (this.end || this.duration).toString()];</span>
<a href="#l1.4424"></a><span id="l1.4424" class="difflineplus">+    },</span>
<a href="#l1.4425"></a><span id="l1.4425" class="difflineplus">+</span>
<a href="#l1.4426"></a><span id="l1.4426" class="difflineplus">+    /**</span>
<a href="#l1.4427"></a><span id="l1.4427" class="difflineplus">+     * The iCalendar string representation of this period.</span>
<a href="#l1.4428"></a><span id="l1.4428" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4429"></a><span id="l1.4429" class="difflineplus">+     */</span>
<a href="#l1.4430"></a><span id="l1.4430">     toICALString: function() {</span>
<a href="#l1.4431"></a><span id="l1.4431">       return this.start.toICALString() + &quot;/&quot; +</span>
<a href="#l1.4432"></a><span id="l1.4432">              (this.end || this.duration).toICALString();</span>
<a href="#l1.4433"></a><span id="l1.4433">     }</span>
<a href="#l1.4434"></a><span id="l1.4434">   };</span>
<a href="#l1.4435"></a><span id="l1.4435"> </span>
<a href="#l1.4436"></a><span id="l1.4436" class="difflineplus">+  /**</span>
<a href="#l1.4437"></a><span id="l1.4437" class="difflineplus">+   * Creates a new {@link ICAL.Period} instance from the passed string.</span>
<a href="#l1.4438"></a><span id="l1.4438" class="difflineplus">+   *</span>
<a href="#l1.4439"></a><span id="l1.4439" class="difflineplus">+   * @param {String} str            The string to parse</span>
<a href="#l1.4440"></a><span id="l1.4440" class="difflineplus">+   * @param {ICAL.Property} prop    The property this period will be on</span>
<a href="#l1.4441"></a><span id="l1.4441" class="difflineplus">+   * @return {ICAL.Period}          The created period instance</span>
<a href="#l1.4442"></a><span id="l1.4442" class="difflineplus">+   */</span>
<a href="#l1.4443"></a><span id="l1.4443">   ICAL.Period.fromString = function fromString(str, prop) {</span>
<a href="#l1.4444"></a><span id="l1.4444">     var parts = str.split('/');</span>
<a href="#l1.4445"></a><span id="l1.4445"> </span>
<a href="#l1.4446"></a><span id="l1.4446">     if (parts.length !== 2) {</span>
<a href="#l1.4447"></a><span id="l1.4447">       throw new Error(</span>
<a href="#l1.4448"></a><span id="l1.4448">         'Invalid string value: &quot;' + str + '&quot; must contain a &quot;/&quot; char.'</span>
<a href="#l1.4449"></a><span id="l1.4449">       );</span>
<a href="#l1.4450"></a><span id="l1.4450">     }</span>
<a href="#l1.4451"></a><span id="l1.4451" class="difflineat">@@ -2543,58 +3660,170 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4452"></a><span id="l1.4452">       options.duration = ICAL.Duration.fromString(end);</span>
<a href="#l1.4453"></a><span id="l1.4453">     } else {</span>
<a href="#l1.4454"></a><span id="l1.4454">       options.end = ICAL.Time.fromDateTimeString(end, prop);</span>
<a href="#l1.4455"></a><span id="l1.4455">     }</span>
<a href="#l1.4456"></a><span id="l1.4456"> </span>
<a href="#l1.4457"></a><span id="l1.4457">     return new ICAL.Period(options);</span>
<a href="#l1.4458"></a><span id="l1.4458">   };</span>
<a href="#l1.4459"></a><span id="l1.4459"> </span>
<a href="#l1.4460"></a><span id="l1.4460" class="difflineplus">+  /**</span>
<a href="#l1.4461"></a><span id="l1.4461" class="difflineplus">+   * Creates a new {@link ICAL.Period} instance from the given data object.</span>
<a href="#l1.4462"></a><span id="l1.4462" class="difflineplus">+   * The passed data object cannot contain both and end date and a duration.</span>
<a href="#l1.4463"></a><span id="l1.4463" class="difflineplus">+   *</span>
<a href="#l1.4464"></a><span id="l1.4464" class="difflineplus">+   * @param {Object} aData                  An object with members of the period</span>
<a href="#l1.4465"></a><span id="l1.4465" class="difflineplus">+   * @param {ICAL.Time=} aData.start        The start of the period</span>
<a href="#l1.4466"></a><span id="l1.4466" class="difflineplus">+   * @param {ICAL.Time=} aData.end          The end of the period</span>
<a href="#l1.4467"></a><span id="l1.4467" class="difflineplus">+   * @param {ICAL.Duration=} aData.duration The duration of the period</span>
<a href="#l1.4468"></a><span id="l1.4468" class="difflineplus">+   * @return {ICAL.Period}                  The period instance</span>
<a href="#l1.4469"></a><span id="l1.4469" class="difflineplus">+   */</span>
<a href="#l1.4470"></a><span id="l1.4470">   ICAL.Period.fromData = function fromData(aData) {</span>
<a href="#l1.4471"></a><span id="l1.4471">     return new ICAL.Period(aData);</span>
<a href="#l1.4472"></a><span id="l1.4472">   };</span>
<a href="#l1.4473"></a><span id="l1.4473"> </span>
<a href="#l1.4474"></a><span id="l1.4474" class="difflineplus">+  /**</span>
<a href="#l1.4475"></a><span id="l1.4475" class="difflineplus">+   * Returns a new period instance from the given jCal data array. The first</span>
<a href="#l1.4476"></a><span id="l1.4476" class="difflineplus">+   * member is always the start date string, the second member is either a</span>
<a href="#l1.4477"></a><span id="l1.4477" class="difflineplus">+   * duration or end date string.</span>
<a href="#l1.4478"></a><span id="l1.4478" class="difflineplus">+   *</span>
<a href="#l1.4479"></a><span id="l1.4479" class="difflineplus">+   * @param {Array&lt;String,String&gt;} aData    The jCal data array</span>
<a href="#l1.4480"></a><span id="l1.4480" class="difflineplus">+   * @param {ICAL.Property} aProp           The property this jCal data is on</span>
<a href="#l1.4481"></a><span id="l1.4481" class="difflineplus">+   * @return {ICAL.Period}                  The period instance</span>
<a href="#l1.4482"></a><span id="l1.4482" class="difflineplus">+   */</span>
<a href="#l1.4483"></a><span id="l1.4483" class="difflineplus">+  ICAL.Period.fromJSON = function(aData, aProp) {</span>
<a href="#l1.4484"></a><span id="l1.4484" class="difflineplus">+    if (ICAL.Duration.isValueString(aData[1])) {</span>
<a href="#l1.4485"></a><span id="l1.4485" class="difflineplus">+      return ICAL.Period.fromData({</span>
<a href="#l1.4486"></a><span id="l1.4486" class="difflineplus">+        start: ICAL.Time.fromDateTimeString(aData[0], aProp),</span>
<a href="#l1.4487"></a><span id="l1.4487" class="difflineplus">+        duration: ICAL.Duration.fromString(aData[1])</span>
<a href="#l1.4488"></a><span id="l1.4488" class="difflineplus">+      });</span>
<a href="#l1.4489"></a><span id="l1.4489" class="difflineplus">+    } else {</span>
<a href="#l1.4490"></a><span id="l1.4490" class="difflineplus">+      return ICAL.Period.fromData({</span>
<a href="#l1.4491"></a><span id="l1.4491" class="difflineplus">+        start: ICAL.Time.fromDateTimeString(aData[0], aProp),</span>
<a href="#l1.4492"></a><span id="l1.4492" class="difflineplus">+        end: ICAL.Time.fromDateTimeString(aData[1], aProp)</span>
<a href="#l1.4493"></a><span id="l1.4493" class="difflineplus">+      });</span>
<a href="#l1.4494"></a><span id="l1.4494" class="difflineplus">+    }</span>
<a href="#l1.4495"></a><span id="l1.4495" class="difflineplus">+  };</span>
<a href="#l1.4496"></a><span id="l1.4496"> })();</span>
<a href="#l1.4497"></a><span id="l1.4497"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.4498"></a><span id="l1.4498">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.4499"></a><span id="l1.4499">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.4500"></a><span id="l1.4500" class="difflineminus">- * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.4501"></a><span id="l1.4501" class="difflineminus">-</span>
<a href="#l1.4502"></a><span id="l1.4502" class="difflineminus">-</span>
<a href="#l1.4503"></a><span id="l1.4503" class="difflineminus">-</span>
<a href="#l1.4504"></a><span id="l1.4504" class="difflineminus">-(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l1.4505"></a><span id="l1.4505" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.4506"></a><span id="l1.4506" class="difflineplus">+</span>
<a href="#l1.4507"></a><span id="l1.4507" class="difflineplus">+</span>
<a href="#l1.4508"></a><span id="l1.4508" class="difflineplus">+</span>
<a href="#l1.4509"></a><span id="l1.4509"> (function() {</span>
<a href="#l1.4510"></a><span id="l1.4510">   var DURATION_LETTERS = /([PDWHMTS]{1,1})/;</span>
<a href="#l1.4511"></a><span id="l1.4511"> </span>
<a href="#l1.4512"></a><span id="l1.4512" class="difflineplus">+  /**</span>
<a href="#l1.4513"></a><span id="l1.4513" class="difflineplus">+   * @classdesc</span>
<a href="#l1.4514"></a><span id="l1.4514" class="difflineplus">+   * This class represents the &quot;duration&quot; value type, with various calculation</span>
<a href="#l1.4515"></a><span id="l1.4515" class="difflineplus">+   * and manipulation methods.</span>
<a href="#l1.4516"></a><span id="l1.4516" class="difflineplus">+   *</span>
<a href="#l1.4517"></a><span id="l1.4517" class="difflineplus">+   * @class</span>
<a href="#l1.4518"></a><span id="l1.4518" class="difflineplus">+   * @alias ICAL.Duration</span>
<a href="#l1.4519"></a><span id="l1.4519" class="difflineplus">+   * @param {Object} data               An object with members of the duration</span>
<a href="#l1.4520"></a><span id="l1.4520" class="difflineplus">+   * @param {Number} data.weeks         Duration in weeks</span>
<a href="#l1.4521"></a><span id="l1.4521" class="difflineplus">+   * @param {Number} data.days          Duration in days</span>
<a href="#l1.4522"></a><span id="l1.4522" class="difflineplus">+   * @param {Number} data.hours         Duration in hours</span>
<a href="#l1.4523"></a><span id="l1.4523" class="difflineplus">+   * @param {Number} data.minutes       Duration in minutes</span>
<a href="#l1.4524"></a><span id="l1.4524" class="difflineplus">+   * @param {Number} data.seconds       Duration in seconds</span>
<a href="#l1.4525"></a><span id="l1.4525" class="difflineplus">+   * @param {Boolean} data.isNegative   If true, the duration is negative</span>
<a href="#l1.4526"></a><span id="l1.4526" class="difflineplus">+   */</span>
<a href="#l1.4527"></a><span id="l1.4527">   ICAL.Duration = function icalduration(data) {</span>
<a href="#l1.4528"></a><span id="l1.4528">     this.wrappedJSObject = this;</span>
<a href="#l1.4529"></a><span id="l1.4529">     this.fromData(data);</span>
<a href="#l1.4530"></a><span id="l1.4530">   };</span>
<a href="#l1.4531"></a><span id="l1.4531"> </span>
<a href="#l1.4532"></a><span id="l1.4532">   ICAL.Duration.prototype = {</span>
<a href="#l1.4533"></a><span id="l1.4533" class="difflineminus">-</span>
<a href="#l1.4534"></a><span id="l1.4534" class="difflineplus">+    /**</span>
<a href="#l1.4535"></a><span id="l1.4535" class="difflineplus">+     * The weeks in this duration</span>
<a href="#l1.4536"></a><span id="l1.4536" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4537"></a><span id="l1.4537" class="difflineplus">+     * @default 0</span>
<a href="#l1.4538"></a><span id="l1.4538" class="difflineplus">+     */</span>
<a href="#l1.4539"></a><span id="l1.4539">     weeks: 0,</span>
<a href="#l1.4540"></a><span id="l1.4540" class="difflineplus">+</span>
<a href="#l1.4541"></a><span id="l1.4541" class="difflineplus">+    /**</span>
<a href="#l1.4542"></a><span id="l1.4542" class="difflineplus">+     * The days in this duration</span>
<a href="#l1.4543"></a><span id="l1.4543" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4544"></a><span id="l1.4544" class="difflineplus">+     * @default 0</span>
<a href="#l1.4545"></a><span id="l1.4545" class="difflineplus">+     */</span>
<a href="#l1.4546"></a><span id="l1.4546">     days: 0,</span>
<a href="#l1.4547"></a><span id="l1.4547" class="difflineplus">+</span>
<a href="#l1.4548"></a><span id="l1.4548" class="difflineplus">+    /**</span>
<a href="#l1.4549"></a><span id="l1.4549" class="difflineplus">+     * The days in this duration</span>
<a href="#l1.4550"></a><span id="l1.4550" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4551"></a><span id="l1.4551" class="difflineplus">+     * @default 0</span>
<a href="#l1.4552"></a><span id="l1.4552" class="difflineplus">+     */</span>
<a href="#l1.4553"></a><span id="l1.4553">     hours: 0,</span>
<a href="#l1.4554"></a><span id="l1.4554" class="difflineplus">+</span>
<a href="#l1.4555"></a><span id="l1.4555" class="difflineplus">+    /**</span>
<a href="#l1.4556"></a><span id="l1.4556" class="difflineplus">+     * The minutes in this duration</span>
<a href="#l1.4557"></a><span id="l1.4557" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4558"></a><span id="l1.4558" class="difflineplus">+     * @default 0</span>
<a href="#l1.4559"></a><span id="l1.4559" class="difflineplus">+     */</span>
<a href="#l1.4560"></a><span id="l1.4560">     minutes: 0,</span>
<a href="#l1.4561"></a><span id="l1.4561" class="difflineplus">+</span>
<a href="#l1.4562"></a><span id="l1.4562" class="difflineplus">+    /**</span>
<a href="#l1.4563"></a><span id="l1.4563" class="difflineplus">+     * The seconds in this duration</span>
<a href="#l1.4564"></a><span id="l1.4564" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4565"></a><span id="l1.4565" class="difflineplus">+     * @default 0</span>
<a href="#l1.4566"></a><span id="l1.4566" class="difflineplus">+     */</span>
<a href="#l1.4567"></a><span id="l1.4567">     seconds: 0,</span>
<a href="#l1.4568"></a><span id="l1.4568" class="difflineplus">+</span>
<a href="#l1.4569"></a><span id="l1.4569" class="difflineplus">+    /**</span>
<a href="#l1.4570"></a><span id="l1.4570" class="difflineplus">+     * The seconds in this duration</span>
<a href="#l1.4571"></a><span id="l1.4571" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.4572"></a><span id="l1.4572" class="difflineplus">+     * @default false</span>
<a href="#l1.4573"></a><span id="l1.4573" class="difflineplus">+     */</span>
<a href="#l1.4574"></a><span id="l1.4574">     isNegative: false,</span>
<a href="#l1.4575"></a><span id="l1.4575" class="difflineplus">+</span>
<a href="#l1.4576"></a><span id="l1.4576" class="difflineplus">+    /**</span>
<a href="#l1.4577"></a><span id="l1.4577" class="difflineplus">+     * The class identifier.</span>
<a href="#l1.4578"></a><span id="l1.4578" class="difflineplus">+     * @constant</span>
<a href="#l1.4579"></a><span id="l1.4579" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4580"></a><span id="l1.4580" class="difflineplus">+     * @default &quot;icalduration&quot;</span>
<a href="#l1.4581"></a><span id="l1.4581" class="difflineplus">+     */</span>
<a href="#l1.4582"></a><span id="l1.4582">     icalclass: &quot;icalduration&quot;,</span>
<a href="#l1.4583"></a><span id="l1.4583" class="difflineplus">+</span>
<a href="#l1.4584"></a><span id="l1.4584" class="difflineplus">+    /**</span>
<a href="#l1.4585"></a><span id="l1.4585" class="difflineplus">+     * The type name, to be used in the jCal object.</span>
<a href="#l1.4586"></a><span id="l1.4586" class="difflineplus">+     * @constant</span>
<a href="#l1.4587"></a><span id="l1.4587" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4588"></a><span id="l1.4588" class="difflineplus">+     * @default &quot;duration&quot;</span>
<a href="#l1.4589"></a><span id="l1.4589" class="difflineplus">+     */</span>
<a href="#l1.4590"></a><span id="l1.4590">     icaltype: &quot;duration&quot;,</span>
<a href="#l1.4591"></a><span id="l1.4591"> </span>
<a href="#l1.4592"></a><span id="l1.4592" class="difflineplus">+    /**</span>
<a href="#l1.4593"></a><span id="l1.4593" class="difflineplus">+     * Returns a clone of the duration object.</span>
<a href="#l1.4594"></a><span id="l1.4594" class="difflineplus">+     *</span>
<a href="#l1.4595"></a><span id="l1.4595" class="difflineplus">+     * @return {ICAL.Duration}      The cloned object</span>
<a href="#l1.4596"></a><span id="l1.4596" class="difflineplus">+     */</span>
<a href="#l1.4597"></a><span id="l1.4597">     clone: function clone() {</span>
<a href="#l1.4598"></a><span id="l1.4598">       return ICAL.Duration.fromData(this);</span>
<a href="#l1.4599"></a><span id="l1.4599">     },</span>
<a href="#l1.4600"></a><span id="l1.4600"> </span>
<a href="#l1.4601"></a><span id="l1.4601" class="difflineplus">+    /**</span>
<a href="#l1.4602"></a><span id="l1.4602" class="difflineplus">+     * The duration value expressed as a number of seconds.</span>
<a href="#l1.4603"></a><span id="l1.4603" class="difflineplus">+     *</span>
<a href="#l1.4604"></a><span id="l1.4604" class="difflineplus">+     * @return {Number}             The duration value in seconds</span>
<a href="#l1.4605"></a><span id="l1.4605" class="difflineplus">+     */</span>
<a href="#l1.4606"></a><span id="l1.4606">     toSeconds: function toSeconds() {</span>
<a href="#l1.4607"></a><span id="l1.4607">       var seconds = this.seconds + 60 * this.minutes + 3600 * this.hours +</span>
<a href="#l1.4608"></a><span id="l1.4608">                     86400 * this.days + 7 * 86400 * this.weeks;</span>
<a href="#l1.4609"></a><span id="l1.4609">       return (this.isNegative ? -seconds : seconds);</span>
<a href="#l1.4610"></a><span id="l1.4610">     },</span>
<a href="#l1.4611"></a><span id="l1.4611"> </span>
<a href="#l1.4612"></a><span id="l1.4612" class="difflineplus">+    /**</span>
<a href="#l1.4613"></a><span id="l1.4613" class="difflineplus">+     * Reads the passed seconds value into this duration object. Afterwards,</span>
<a href="#l1.4614"></a><span id="l1.4614" class="difflineplus">+     * members like {@link ICAL.Duration#days days} and {@link ICAL.Duration#weeks weeks} will be set up</span>
<a href="#l1.4615"></a><span id="l1.4615" class="difflineplus">+     * accordingly.</span>
<a href="#l1.4616"></a><span id="l1.4616" class="difflineplus">+     *</span>
<a href="#l1.4617"></a><span id="l1.4617" class="difflineplus">+     * @param {Number} aSeconds     The duration value in seconds</span>
<a href="#l1.4618"></a><span id="l1.4618" class="difflineplus">+     * @return {ICAL.Duration}      Returns this instance</span>
<a href="#l1.4619"></a><span id="l1.4619" class="difflineplus">+     */</span>
<a href="#l1.4620"></a><span id="l1.4620">     fromSeconds: function fromSeconds(aSeconds) {</span>
<a href="#l1.4621"></a><span id="l1.4621">       var secs = Math.abs(aSeconds);</span>
<a href="#l1.4622"></a><span id="l1.4622"> </span>
<a href="#l1.4623"></a><span id="l1.4623">       this.isNegative = (aSeconds &lt; 0);</span>
<a href="#l1.4624"></a><span id="l1.4624">       this.days = ICAL.helpers.trunc(secs / 86400);</span>
<a href="#l1.4625"></a><span id="l1.4625"> </span>
<a href="#l1.4626"></a><span id="l1.4626">       // If we have a flat number of weeks, use them.</span>
<a href="#l1.4627"></a><span id="l1.4627">       if (this.days % 7 == 0) {</span>
<a href="#l1.4628"></a><span id="l1.4628" class="difflineat">@@ -2611,49 +3840,80 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4629"></a><span id="l1.4629"> </span>
<a href="#l1.4630"></a><span id="l1.4630">       this.minutes = ICAL.helpers.trunc(secs / 60);</span>
<a href="#l1.4631"></a><span id="l1.4631">       secs -= this.minutes * 60;</span>
<a href="#l1.4632"></a><span id="l1.4632"> </span>
<a href="#l1.4633"></a><span id="l1.4633">       this.seconds = secs;</span>
<a href="#l1.4634"></a><span id="l1.4634">       return this;</span>
<a href="#l1.4635"></a><span id="l1.4635">     },</span>
<a href="#l1.4636"></a><span id="l1.4636"> </span>
<a href="#l1.4637"></a><span id="l1.4637" class="difflineplus">+    /**</span>
<a href="#l1.4638"></a><span id="l1.4638" class="difflineplus">+     * Sets up the current instance using members from the passed data object.</span>
<a href="#l1.4639"></a><span id="l1.4639" class="difflineplus">+     *</span>
<a href="#l1.4640"></a><span id="l1.4640" class="difflineplus">+     * @param {Object} aData               An object with members of the duration</span>
<a href="#l1.4641"></a><span id="l1.4641" class="difflineplus">+     * @param {Number} aData.weeks         Duration in weeks</span>
<a href="#l1.4642"></a><span id="l1.4642" class="difflineplus">+     * @param {Number} aData.days          Duration in days</span>
<a href="#l1.4643"></a><span id="l1.4643" class="difflineplus">+     * @param {Number} aData.hours         Duration in hours</span>
<a href="#l1.4644"></a><span id="l1.4644" class="difflineplus">+     * @param {Number} aData.minutes       Duration in minutes</span>
<a href="#l1.4645"></a><span id="l1.4645" class="difflineplus">+     * @param {Number} aData.seconds       Duration in seconds</span>
<a href="#l1.4646"></a><span id="l1.4646" class="difflineplus">+     * @param {Boolean} aData.isNegative   If true, the duration is negative</span>
<a href="#l1.4647"></a><span id="l1.4647" class="difflineplus">+     */</span>
<a href="#l1.4648"></a><span id="l1.4648">     fromData: function fromData(aData) {</span>
<a href="#l1.4649"></a><span id="l1.4649">       var propsToCopy = [&quot;weeks&quot;, &quot;days&quot;, &quot;hours&quot;,</span>
<a href="#l1.4650"></a><span id="l1.4650">                          &quot;minutes&quot;, &quot;seconds&quot;, &quot;isNegative&quot;];</span>
<a href="#l1.4651"></a><span id="l1.4651">       for (var key in propsToCopy) {</span>
<a href="#l1.4652"></a><span id="l1.4652" class="difflineplus">+        /* istanbul ignore if */</span>
<a href="#l1.4653"></a><span id="l1.4653" class="difflineplus">+        if (!propsToCopy.hasOwnProperty(key)) {</span>
<a href="#l1.4654"></a><span id="l1.4654" class="difflineplus">+          continue;</span>
<a href="#l1.4655"></a><span id="l1.4655" class="difflineplus">+        }</span>
<a href="#l1.4656"></a><span id="l1.4656">         var prop = propsToCopy[key];</span>
<a href="#l1.4657"></a><span id="l1.4657">         if (aData &amp;&amp; prop in aData) {</span>
<a href="#l1.4658"></a><span id="l1.4658">           this[prop] = aData[prop];</span>
<a href="#l1.4659"></a><span id="l1.4659">         } else {</span>
<a href="#l1.4660"></a><span id="l1.4660">           this[prop] = 0;</span>
<a href="#l1.4661"></a><span id="l1.4661">         }</span>
<a href="#l1.4662"></a><span id="l1.4662">       }</span>
<a href="#l1.4663"></a><span id="l1.4663">     },</span>
<a href="#l1.4664"></a><span id="l1.4664"> </span>
<a href="#l1.4665"></a><span id="l1.4665" class="difflineplus">+    /**</span>
<a href="#l1.4666"></a><span id="l1.4666" class="difflineplus">+     * Resets the duration instance to the default values, i.e. PT0S</span>
<a href="#l1.4667"></a><span id="l1.4667" class="difflineplus">+     */</span>
<a href="#l1.4668"></a><span id="l1.4668">     reset: function reset() {</span>
<a href="#l1.4669"></a><span id="l1.4669">       this.isNegative = false;</span>
<a href="#l1.4670"></a><span id="l1.4670">       this.weeks = 0;</span>
<a href="#l1.4671"></a><span id="l1.4671">       this.days = 0;</span>
<a href="#l1.4672"></a><span id="l1.4672">       this.hours = 0;</span>
<a href="#l1.4673"></a><span id="l1.4673">       this.minutes = 0;</span>
<a href="#l1.4674"></a><span id="l1.4674">       this.seconds = 0;</span>
<a href="#l1.4675"></a><span id="l1.4675">     },</span>
<a href="#l1.4676"></a><span id="l1.4676"> </span>
<a href="#l1.4677"></a><span id="l1.4677" class="difflineplus">+    /**</span>
<a href="#l1.4678"></a><span id="l1.4678" class="difflineplus">+     * Compares the duration instance with another one.</span>
<a href="#l1.4679"></a><span id="l1.4679" class="difflineplus">+     *</span>
<a href="#l1.4680"></a><span id="l1.4680" class="difflineplus">+     * @param {ICAL.Duration} aOther        The instance to compare with</span>
<a href="#l1.4681"></a><span id="l1.4681" class="difflineplus">+     * @return {Number}                     -1, 0 or 1 for less/equal/greater</span>
<a href="#l1.4682"></a><span id="l1.4682" class="difflineplus">+     */</span>
<a href="#l1.4683"></a><span id="l1.4683">     compare: function compare(aOther) {</span>
<a href="#l1.4684"></a><span id="l1.4684">       var thisSeconds = this.toSeconds();</span>
<a href="#l1.4685"></a><span id="l1.4685">       var otherSeconds = aOther.toSeconds();</span>
<a href="#l1.4686"></a><span id="l1.4686">       return (thisSeconds &gt; otherSeconds) - (thisSeconds &lt; otherSeconds);</span>
<a href="#l1.4687"></a><span id="l1.4687">     },</span>
<a href="#l1.4688"></a><span id="l1.4688"> </span>
<a href="#l1.4689"></a><span id="l1.4689" class="difflineplus">+    /**</span>
<a href="#l1.4690"></a><span id="l1.4690" class="difflineplus">+     * Normalizes the duration instance. For example, a duration with a value</span>
<a href="#l1.4691"></a><span id="l1.4691" class="difflineplus">+     * of 61 seconds will be normalized to 1 minute and 1 second.</span>
<a href="#l1.4692"></a><span id="l1.4692" class="difflineplus">+     */</span>
<a href="#l1.4693"></a><span id="l1.4693">     normalize: function normalize() {</span>
<a href="#l1.4694"></a><span id="l1.4694">       this.fromSeconds(this.toSeconds());</span>
<a href="#l1.4695"></a><span id="l1.4695" class="difflineminus">-      return this;</span>
<a href="#l1.4696"></a><span id="l1.4696" class="difflineminus">-    },</span>
<a href="#l1.4697"></a><span id="l1.4697" class="difflineminus">-</span>
<a href="#l1.4698"></a><span id="l1.4698" class="difflineplus">+    },</span>
<a href="#l1.4699"></a><span id="l1.4699" class="difflineplus">+</span>
<a href="#l1.4700"></a><span id="l1.4700" class="difflineplus">+    /**</span>
<a href="#l1.4701"></a><span id="l1.4701" class="difflineplus">+     * The string representation of this duration.</span>
<a href="#l1.4702"></a><span id="l1.4702" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4703"></a><span id="l1.4703" class="difflineplus">+     */</span>
<a href="#l1.4704"></a><span id="l1.4704">     toString: function toString() {</span>
<a href="#l1.4705"></a><span id="l1.4705">       if (this.toSeconds() == 0) {</span>
<a href="#l1.4706"></a><span id="l1.4706">         return &quot;PT0S&quot;;</span>
<a href="#l1.4707"></a><span id="l1.4707">       } else {</span>
<a href="#l1.4708"></a><span id="l1.4708">         var str = &quot;&quot;;</span>
<a href="#l1.4709"></a><span id="l1.4709">         if (this.isNegative) str += &quot;-&quot;;</span>
<a href="#l1.4710"></a><span id="l1.4710">         str += &quot;P&quot;;</span>
<a href="#l1.4711"></a><span id="l1.4711">         if (this.weeks) str += this.weeks + &quot;W&quot;;</span>
<a href="#l1.4712"></a><span id="l1.4712" class="difflineat">@@ -2664,31 +3924,41 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4713"></a><span id="l1.4713">           if (this.hours) str += this.hours + &quot;H&quot;;</span>
<a href="#l1.4714"></a><span id="l1.4714">           if (this.minutes) str += this.minutes + &quot;M&quot;;</span>
<a href="#l1.4715"></a><span id="l1.4715">           if (this.seconds) str += this.seconds + &quot;S&quot;;</span>
<a href="#l1.4716"></a><span id="l1.4716">         }</span>
<a href="#l1.4717"></a><span id="l1.4717">         return str;</span>
<a href="#l1.4718"></a><span id="l1.4718">       }</span>
<a href="#l1.4719"></a><span id="l1.4719">     },</span>
<a href="#l1.4720"></a><span id="l1.4720"> </span>
<a href="#l1.4721"></a><span id="l1.4721" class="difflineplus">+    /**</span>
<a href="#l1.4722"></a><span id="l1.4722" class="difflineplus">+     * The iCalendar string representation of this duration.</span>
<a href="#l1.4723"></a><span id="l1.4723" class="difflineplus">+     * @return {String}</span>
<a href="#l1.4724"></a><span id="l1.4724" class="difflineplus">+     */</span>
<a href="#l1.4725"></a><span id="l1.4725">     toICALString: function() {</span>
<a href="#l1.4726"></a><span id="l1.4726">       return this.toString();</span>
<a href="#l1.4727"></a><span id="l1.4727">     }</span>
<a href="#l1.4728"></a><span id="l1.4728">   };</span>
<a href="#l1.4729"></a><span id="l1.4729"> </span>
<a href="#l1.4730"></a><span id="l1.4730" class="difflineplus">+  /**</span>
<a href="#l1.4731"></a><span id="l1.4731" class="difflineplus">+   * Returns a new ICAL.Duration instance from the passed seconds value.</span>
<a href="#l1.4732"></a><span id="l1.4732" class="difflineplus">+   *</span>
<a href="#l1.4733"></a><span id="l1.4733" class="difflineplus">+   * @param {Number} aSeconds       The seconds to create the instance from</span>
<a href="#l1.4734"></a><span id="l1.4734" class="difflineplus">+   * @return {ICAL.Duration}        The newly created duration instance</span>
<a href="#l1.4735"></a><span id="l1.4735" class="difflineplus">+   */</span>
<a href="#l1.4736"></a><span id="l1.4736">   ICAL.Duration.fromSeconds = function icalduration_from_seconds(aSeconds) {</span>
<a href="#l1.4737"></a><span id="l1.4737">     return (new ICAL.Duration()).fromSeconds(aSeconds);</span>
<a href="#l1.4738"></a><span id="l1.4738">   };</span>
<a href="#l1.4739"></a><span id="l1.4739"> </span>
<a href="#l1.4740"></a><span id="l1.4740">   /**</span>
<a href="#l1.4741"></a><span id="l1.4741">    * Internal helper function to handle a chunk of a duration.</span>
<a href="#l1.4742"></a><span id="l1.4742">    *</span>
<a href="#l1.4743"></a><span id="l1.4743" class="difflineminus">-   * @param {String} letter type of duration chunk.</span>
<a href="#l1.4744"></a><span id="l1.4744" class="difflineminus">-   * @param {String} number numeric value or -/+.</span>
<a href="#l1.4745"></a><span id="l1.4745" class="difflineminus">-   * @param {Object} dict target to assign values to.</span>
<a href="#l1.4746"></a><span id="l1.4746" class="difflineplus">+   * @param {String} letter type of duration chunk</span>
<a href="#l1.4747"></a><span id="l1.4747" class="difflineplus">+   * @param {String} number numeric value or -/+</span>
<a href="#l1.4748"></a><span id="l1.4748" class="difflineplus">+   * @param {Object} dict target to assign values to</span>
<a href="#l1.4749"></a><span id="l1.4749">    */</span>
<a href="#l1.4750"></a><span id="l1.4750">   function parseDurationChunk(letter, number, object) {</span>
<a href="#l1.4751"></a><span id="l1.4751">     var type;</span>
<a href="#l1.4752"></a><span id="l1.4752">     switch (letter) {</span>
<a href="#l1.4753"></a><span id="l1.4753">       case 'P':</span>
<a href="#l1.4754"></a><span id="l1.4754">         if (number &amp;&amp; number === '-') {</span>
<a href="#l1.4755"></a><span id="l1.4755">           object.isNegative = true;</span>
<a href="#l1.4756"></a><span id="l1.4756">         } else {</span>
<a href="#l1.4757"></a><span id="l1.4757" class="difflineat">@@ -2730,24 +4000,32 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4758"></a><span id="l1.4758">       }</span>
<a href="#l1.4759"></a><span id="l1.4759">       object[type] = num;</span>
<a href="#l1.4760"></a><span id="l1.4760">     }</span>
<a href="#l1.4761"></a><span id="l1.4761"> </span>
<a href="#l1.4762"></a><span id="l1.4762">     return 1;</span>
<a href="#l1.4763"></a><span id="l1.4763">   }</span>
<a href="#l1.4764"></a><span id="l1.4764"> </span>
<a href="#l1.4765"></a><span id="l1.4765">   /**</span>
<a href="#l1.4766"></a><span id="l1.4766" class="difflineminus">-   * @param {String} value raw ical value.</span>
<a href="#l1.4767"></a><span id="l1.4767" class="difflineminus">-   * @return {Boolean}</span>
<a href="#l1.4768"></a><span id="l1.4768" class="difflineminus">-   *  true when the given value is of the duration ical type.</span>
<a href="#l1.4769"></a><span id="l1.4769" class="difflineplus">+   * Checks if the given string is an iCalendar duration value.</span>
<a href="#l1.4770"></a><span id="l1.4770" class="difflineplus">+   *</span>
<a href="#l1.4771"></a><span id="l1.4771" class="difflineplus">+   * @param {String} value      The raw ical value</span>
<a href="#l1.4772"></a><span id="l1.4772" class="difflineplus">+   * @return {Boolean}          True, if the given value is of the</span>
<a href="#l1.4773"></a><span id="l1.4773" class="difflineplus">+   *                              duration ical type</span>
<a href="#l1.4774"></a><span id="l1.4774">    */</span>
<a href="#l1.4775"></a><span id="l1.4775">   ICAL.Duration.isValueString = function(string) {</span>
<a href="#l1.4776"></a><span id="l1.4776">     return (string[0] === 'P' || string[1] === 'P');</span>
<a href="#l1.4777"></a><span id="l1.4777" class="difflineminus">-  },</span>
<a href="#l1.4778"></a><span id="l1.4778" class="difflineminus">-</span>
<a href="#l1.4779"></a><span id="l1.4779" class="difflineplus">+  };</span>
<a href="#l1.4780"></a><span id="l1.4780" class="difflineplus">+</span>
<a href="#l1.4781"></a><span id="l1.4781" class="difflineplus">+  /**</span>
<a href="#l1.4782"></a><span id="l1.4782" class="difflineplus">+   * Creates a new {@link ICAL.Duration} instance from the passed string.</span>
<a href="#l1.4783"></a><span id="l1.4783" class="difflineplus">+   *</span>
<a href="#l1.4784"></a><span id="l1.4784" class="difflineplus">+   * @param {String} aStr       The string to parse</span>
<a href="#l1.4785"></a><span id="l1.4785" class="difflineplus">+   * @return {ICAL.Duration}    The created duration instance</span>
<a href="#l1.4786"></a><span id="l1.4786" class="difflineplus">+   */</span>
<a href="#l1.4787"></a><span id="l1.4787">   ICAL.Duration.fromString = function icalduration_from_string(aStr) {</span>
<a href="#l1.4788"></a><span id="l1.4788">     var pos = 0;</span>
<a href="#l1.4789"></a><span id="l1.4789">     var dict = Object.create(null);</span>
<a href="#l1.4790"></a><span id="l1.4790">     var chunks = 0;</span>
<a href="#l1.4791"></a><span id="l1.4791"> </span>
<a href="#l1.4792"></a><span id="l1.4792">     while ((pos = aStr.search(DURATION_LETTERS)) !== -1) {</span>
<a href="#l1.4793"></a><span id="l1.4793">       var type = aStr[pos];</span>
<a href="#l1.4794"></a><span id="l1.4794">       var numeric = aStr.substr(0, pos);</span>
<a href="#l1.4795"></a><span id="l1.4795" class="difflineat">@@ -2761,112 +4039,194 @@ ICAL.Binary = (function() {</span>
<a href="#l1.4796"></a><span id="l1.4796">       throw new Error(</span>
<a href="#l1.4797"></a><span id="l1.4797">         'invalid duration value: Not enough duration components in &quot;' + aStr + '&quot;'</span>
<a href="#l1.4798"></a><span id="l1.4798">       );</span>
<a href="#l1.4799"></a><span id="l1.4799">     }</span>
<a href="#l1.4800"></a><span id="l1.4800"> </span>
<a href="#l1.4801"></a><span id="l1.4801">     return new ICAL.Duration(dict);</span>
<a href="#l1.4802"></a><span id="l1.4802">   };</span>
<a href="#l1.4803"></a><span id="l1.4803"> </span>
<a href="#l1.4804"></a><span id="l1.4804" class="difflineplus">+  /**</span>
<a href="#l1.4805"></a><span id="l1.4805" class="difflineplus">+   * Creates a new ICAL.Duration instance from the given data object.</span>
<a href="#l1.4806"></a><span id="l1.4806" class="difflineplus">+   *</span>
<a href="#l1.4807"></a><span id="l1.4807" class="difflineplus">+   * @param {Object} aData               An object with members of the duration</span>
<a href="#l1.4808"></a><span id="l1.4808" class="difflineplus">+   * @param {Number} aData.weeks         Duration in weeks</span>
<a href="#l1.4809"></a><span id="l1.4809" class="difflineplus">+   * @param {Number} aData.days          Duration in days</span>
<a href="#l1.4810"></a><span id="l1.4810" class="difflineplus">+   * @param {Number} aData.hours         Duration in hours</span>
<a href="#l1.4811"></a><span id="l1.4811" class="difflineplus">+   * @param {Number} aData.minutes       Duration in minutes</span>
<a href="#l1.4812"></a><span id="l1.4812" class="difflineplus">+   * @param {Number} aData.seconds       Duration in seconds</span>
<a href="#l1.4813"></a><span id="l1.4813" class="difflineplus">+   * @param {Boolean} aData.isNegative   If true, the duration is negative</span>
<a href="#l1.4814"></a><span id="l1.4814" class="difflineplus">+   * @return {ICAL.Duration}             The createad duration instance</span>
<a href="#l1.4815"></a><span id="l1.4815" class="difflineplus">+   */</span>
<a href="#l1.4816"></a><span id="l1.4816">   ICAL.Duration.fromData = function icalduration_from_data(aData) {</span>
<a href="#l1.4817"></a><span id="l1.4817">     return new ICAL.Duration(aData);</span>
<a href="#l1.4818"></a><span id="l1.4818">   };</span>
<a href="#l1.4819"></a><span id="l1.4819"> })();</span>
<a href="#l1.4820"></a><span id="l1.4820"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.4821"></a><span id="l1.4821">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.4822"></a><span id="l1.4822">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.4823"></a><span id="l1.4823">  * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.4824"></a><span id="l1.4824"> </span>
<a href="#l1.4825"></a><span id="l1.4825"> </span>
<a href="#l1.4826"></a><span id="l1.4826"> </span>
<a href="#l1.4827"></a><span id="l1.4827" class="difflineminus">-(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l1.4828"></a><span id="l1.4828"> (function() {</span>
<a href="#l1.4829"></a><span id="l1.4829">   var OPTIONS = [&quot;tzid&quot;, &quot;location&quot;, &quot;tznames&quot;,</span>
<a href="#l1.4830"></a><span id="l1.4830">                  &quot;latitude&quot;, &quot;longitude&quot;];</span>
<a href="#l1.4831"></a><span id="l1.4831"> </span>
<a href="#l1.4832"></a><span id="l1.4832">   /**</span>
<a href="#l1.4833"></a><span id="l1.4833" class="difflineplus">+   * @classdesc</span>
<a href="#l1.4834"></a><span id="l1.4834">    * Timezone representation, created by passing in a tzid and component.</span>
<a href="#l1.4835"></a><span id="l1.4835">    *</span>
<a href="#l1.4836"></a><span id="l1.4836" class="difflineminus">-   *    var vcalendar;</span>
<a href="#l1.4837"></a><span id="l1.4837" class="difflineminus">-   *    var timezoneComp = vcalendar.getFirstSubcomponent('vtimezone');</span>
<a href="#l1.4838"></a><span id="l1.4838" class="difflineminus">-   *    var tzid = timezoneComp.getFirstPropertyValue('tzid');</span>
<a href="#l1.4839"></a><span id="l1.4839" class="difflineminus">-   *</span>
<a href="#l1.4840"></a><span id="l1.4840" class="difflineminus">-   *    var timezone = new ICAL.Timezone({</span>
<a href="#l1.4841"></a><span id="l1.4841" class="difflineminus">-   *      component: timezoneComp,</span>
<a href="#l1.4842"></a><span id="l1.4842" class="difflineminus">-   *      tzid</span>
<a href="#l1.4843"></a><span id="l1.4843" class="difflineminus">-   *    });</span>
<a href="#l1.4844"></a><span id="l1.4844" class="difflineminus">-   *</span>
<a href="#l1.4845"></a><span id="l1.4845" class="difflineminus">-   *</span>
<a href="#l1.4846"></a><span id="l1.4846" class="difflineminus">-   * @param {Object} data options for class (see above).</span>
<a href="#l1.4847"></a><span id="l1.4847" class="difflineplus">+   * @example</span>
<a href="#l1.4848"></a><span id="l1.4848" class="difflineplus">+   * var vcalendar;</span>
<a href="#l1.4849"></a><span id="l1.4849" class="difflineplus">+   * var timezoneComp = vcalendar.getFirstSubcomponent('vtimezone');</span>
<a href="#l1.4850"></a><span id="l1.4850" class="difflineplus">+   * var tzid = timezoneComp.getFirstPropertyValue('tzid');</span>
<a href="#l1.4851"></a><span id="l1.4851" class="difflineplus">+   *</span>
<a href="#l1.4852"></a><span id="l1.4852" class="difflineplus">+   * var timezone = new ICAL.Timezone({</span>
<a href="#l1.4853"></a><span id="l1.4853" class="difflineplus">+   *   component: timezoneComp,</span>
<a href="#l1.4854"></a><span id="l1.4854" class="difflineplus">+   *   tzid</span>
<a href="#l1.4855"></a><span id="l1.4855" class="difflineplus">+   * });</span>
<a href="#l1.4856"></a><span id="l1.4856" class="difflineplus">+   *</span>
<a href="#l1.4857"></a><span id="l1.4857" class="difflineplus">+   * @class</span>
<a href="#l1.4858"></a><span id="l1.4858" class="difflineplus">+   * @param {ICAL.Component|Object} data options for class</span>
<a href="#l1.4859"></a><span id="l1.4859" class="difflineplus">+   * @param {String|ICAL.Component} data.component</span>
<a href="#l1.4860"></a><span id="l1.4860" class="difflineplus">+   *        If data is a simple object, then this member can be set to either a</span>
<a href="#l1.4861"></a><span id="l1.4861" class="difflineplus">+   *        string containing the component data, or an already parsed</span>
<a href="#l1.4862"></a><span id="l1.4862" class="difflineplus">+   *        ICAL.Component</span>
<a href="#l1.4863"></a><span id="l1.4863" class="difflineplus">+   * @param {String} data.tzid      The timezone identifier</span>
<a href="#l1.4864"></a><span id="l1.4864" class="difflineplus">+   * @param {String} data.location  The timezone locationw</span>
<a href="#l1.4865"></a><span id="l1.4865" class="difflineplus">+   * @param {String} data.tznames   An alternative string representation of the</span>
<a href="#l1.4866"></a><span id="l1.4866" class="difflineplus">+   *                                  timezone</span>
<a href="#l1.4867"></a><span id="l1.4867" class="difflineplus">+   * @param {Number} data.latitude  The latitude of the timezone</span>
<a href="#l1.4868"></a><span id="l1.4868" class="difflineplus">+   * @param {Number} data.longitude The longitude of the timezone</span>
<a href="#l1.4869"></a><span id="l1.4869">    */</span>
<a href="#l1.4870"></a><span id="l1.4870">   ICAL.Timezone = function icaltimezone(data) {</span>
<a href="#l1.4871"></a><span id="l1.4871">     this.wrappedJSObject = this;</span>
<a href="#l1.4872"></a><span id="l1.4872">     this.fromData(data);</span>
<a href="#l1.4873"></a><span id="l1.4873">   };</span>
<a href="#l1.4874"></a><span id="l1.4874"> </span>
<a href="#l1.4875"></a><span id="l1.4875">   ICAL.Timezone.prototype = {</span>
<a href="#l1.4876"></a><span id="l1.4876"> </span>
<a href="#l1.4877"></a><span id="l1.4877" class="difflineplus">+    /**</span>
<a href="#l1.4878"></a><span id="l1.4878" class="difflineplus">+     * Timezone identifier</span>
<a href="#l1.4879"></a><span id="l1.4879" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4880"></a><span id="l1.4880" class="difflineplus">+     */</span>
<a href="#l1.4881"></a><span id="l1.4881">     tzid: &quot;&quot;,</span>
<a href="#l1.4882"></a><span id="l1.4882" class="difflineplus">+</span>
<a href="#l1.4883"></a><span id="l1.4883" class="difflineplus">+    /**</span>
<a href="#l1.4884"></a><span id="l1.4884" class="difflineplus">+     * Timezone location</span>
<a href="#l1.4885"></a><span id="l1.4885" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4886"></a><span id="l1.4886" class="difflineplus">+     */</span>
<a href="#l1.4887"></a><span id="l1.4887">     location: &quot;&quot;,</span>
<a href="#l1.4888"></a><span id="l1.4888" class="difflineplus">+</span>
<a href="#l1.4889"></a><span id="l1.4889" class="difflineplus">+    /**</span>
<a href="#l1.4890"></a><span id="l1.4890" class="difflineplus">+     * Alternative timezone name, for the string representation</span>
<a href="#l1.4891"></a><span id="l1.4891" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4892"></a><span id="l1.4892" class="difflineplus">+     */</span>
<a href="#l1.4893"></a><span id="l1.4893">     tznames: &quot;&quot;,</span>
<a href="#l1.4894"></a><span id="l1.4894"> </span>
<a href="#l1.4895"></a><span id="l1.4895" class="difflineplus">+    /**</span>
<a href="#l1.4896"></a><span id="l1.4896" class="difflineplus">+     * The primary latitude for the timezone.</span>
<a href="#l1.4897"></a><span id="l1.4897" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4898"></a><span id="l1.4898" class="difflineplus">+     */</span>
<a href="#l1.4899"></a><span id="l1.4899">     latitude: 0.0,</span>
<a href="#l1.4900"></a><span id="l1.4900" class="difflineplus">+</span>
<a href="#l1.4901"></a><span id="l1.4901" class="difflineplus">+    /**</span>
<a href="#l1.4902"></a><span id="l1.4902" class="difflineplus">+     * The primary longitude for the timezone.</span>
<a href="#l1.4903"></a><span id="l1.4903" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4904"></a><span id="l1.4904" class="difflineplus">+     */</span>
<a href="#l1.4905"></a><span id="l1.4905">     longitude: 0.0,</span>
<a href="#l1.4906"></a><span id="l1.4906"> </span>
<a href="#l1.4907"></a><span id="l1.4907" class="difflineplus">+    /**</span>
<a href="#l1.4908"></a><span id="l1.4908" class="difflineplus">+     * The vtimezone component for this timezone.</span>
<a href="#l1.4909"></a><span id="l1.4909" class="difflineplus">+     * @type {ICAL.Component}</span>
<a href="#l1.4910"></a><span id="l1.4910" class="difflineplus">+     */</span>
<a href="#l1.4911"></a><span id="l1.4911">     component: null,</span>
<a href="#l1.4912"></a><span id="l1.4912"> </span>
<a href="#l1.4913"></a><span id="l1.4913" class="difflineplus">+    /**</span>
<a href="#l1.4914"></a><span id="l1.4914" class="difflineplus">+     * The year this timezone has been expanded to. All timezone transition</span>
<a href="#l1.4915"></a><span id="l1.4915" class="difflineplus">+     * dates until this year are known and can be used for calculation</span>
<a href="#l1.4916"></a><span id="l1.4916" class="difflineplus">+     *</span>
<a href="#l1.4917"></a><span id="l1.4917" class="difflineplus">+     * @private</span>
<a href="#l1.4918"></a><span id="l1.4918" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.4919"></a><span id="l1.4919" class="difflineplus">+     */</span>
<a href="#l1.4920"></a><span id="l1.4920">     expandedUntilYear: 0,</span>
<a href="#l1.4921"></a><span id="l1.4921"> </span>
<a href="#l1.4922"></a><span id="l1.4922" class="difflineplus">+    /**</span>
<a href="#l1.4923"></a><span id="l1.4923" class="difflineplus">+     * The class identifier.</span>
<a href="#l1.4924"></a><span id="l1.4924" class="difflineplus">+     * @constant</span>
<a href="#l1.4925"></a><span id="l1.4925" class="difflineplus">+     * @type {String}</span>
<a href="#l1.4926"></a><span id="l1.4926" class="difflineplus">+     * @default &quot;icaltimezone&quot;</span>
<a href="#l1.4927"></a><span id="l1.4927" class="difflineplus">+     */</span>
<a href="#l1.4928"></a><span id="l1.4928">     icalclass: &quot;icaltimezone&quot;,</span>
<a href="#l1.4929"></a><span id="l1.4929"> </span>
<a href="#l1.4930"></a><span id="l1.4930" class="difflineplus">+    /**</span>
<a href="#l1.4931"></a><span id="l1.4931" class="difflineplus">+     * Sets up the current instance using members from the passed data object.</span>
<a href="#l1.4932"></a><span id="l1.4932" class="difflineplus">+     *</span>
<a href="#l1.4933"></a><span id="l1.4933" class="difflineplus">+     * @param {ICAL.Component|Object} aData options for class</span>
<a href="#l1.4934"></a><span id="l1.4934" class="difflineplus">+     * @param {String|ICAL.Component} aData.component</span>
<a href="#l1.4935"></a><span id="l1.4935" class="difflineplus">+     *        If aData is a simple object, then this member can be set to either a</span>
<a href="#l1.4936"></a><span id="l1.4936" class="difflineplus">+     *        string containing the component data, or an already parsed</span>
<a href="#l1.4937"></a><span id="l1.4937" class="difflineplus">+     *        ICAL.Component</span>
<a href="#l1.4938"></a><span id="l1.4938" class="difflineplus">+     * @param {String} aData.tzid      The timezone identifier</span>
<a href="#l1.4939"></a><span id="l1.4939" class="difflineplus">+     * @param {String} aData.location  The timezone locationw</span>
<a href="#l1.4940"></a><span id="l1.4940" class="difflineplus">+     * @param {String} aData.tznames   An alternative string representation of the</span>
<a href="#l1.4941"></a><span id="l1.4941" class="difflineplus">+     *                                  timezone</span>
<a href="#l1.4942"></a><span id="l1.4942" class="difflineplus">+     * @param {Number} aData.latitude  The latitude of the timezone</span>
<a href="#l1.4943"></a><span id="l1.4943" class="difflineplus">+     * @param {Number} aData.longitude The longitude of the timezone</span>
<a href="#l1.4944"></a><span id="l1.4944" class="difflineplus">+     */</span>
<a href="#l1.4945"></a><span id="l1.4945">     fromData: function fromData(aData) {</span>
<a href="#l1.4946"></a><span id="l1.4946">       this.expandedUntilYear = 0;</span>
<a href="#l1.4947"></a><span id="l1.4947">       this.changes = [];</span>
<a href="#l1.4948"></a><span id="l1.4948"> </span>
<a href="#l1.4949"></a><span id="l1.4949">       if (aData instanceof ICAL.Component) {</span>
<a href="#l1.4950"></a><span id="l1.4950">         // Either a component is passed directly</span>
<a href="#l1.4951"></a><span id="l1.4951">         this.component = aData;</span>
<a href="#l1.4952"></a><span id="l1.4952">       } else {</span>
<a href="#l1.4953"></a><span id="l1.4953">         // Otherwise the component may be in the data object</span>
<a href="#l1.4954"></a><span id="l1.4954">         if (aData &amp;&amp; &quot;component&quot; in aData) {</span>
<a href="#l1.4955"></a><span id="l1.4955">           if (typeof aData.component == &quot;string&quot;) {</span>
<a href="#l1.4956"></a><span id="l1.4956">             // If a string was passed, parse it as a component</span>
<a href="#l1.4957"></a><span id="l1.4957" class="difflineminus">-            var icalendar = ICAL.parse(aData.component);</span>
<a href="#l1.4958"></a><span id="l1.4958" class="difflineminus">-            this.component = new ICAL.Component(icalendar[1]);</span>
<a href="#l1.4959"></a><span id="l1.4959" class="difflineplus">+            var jCal = ICAL.parse(aData.component);</span>
<a href="#l1.4960"></a><span id="l1.4960" class="difflineplus">+            this.component = new ICAL.Component(jCal);</span>
<a href="#l1.4961"></a><span id="l1.4961">           } else if (aData.component instanceof ICAL.Component) {</span>
<a href="#l1.4962"></a><span id="l1.4962">             // If it was a component already, then just set it</span>
<a href="#l1.4963"></a><span id="l1.4963">             this.component = aData.component;</span>
<a href="#l1.4964"></a><span id="l1.4964">           } else {</span>
<a href="#l1.4965"></a><span id="l1.4965">             // Otherwise just null out the component</span>
<a href="#l1.4966"></a><span id="l1.4966">             this.component = null;</span>
<a href="#l1.4967"></a><span id="l1.4967">           }</span>
<a href="#l1.4968"></a><span id="l1.4968">         }</span>
<a href="#l1.4969"></a><span id="l1.4969"> </span>
<a href="#l1.4970"></a><span id="l1.4970">         // Copy remaining passed properties</span>
<a href="#l1.4971"></a><span id="l1.4971">         for (var key in OPTIONS) {</span>
<a href="#l1.4972"></a><span id="l1.4972" class="difflineminus">-          var prop = OPTIONS[key];</span>
<a href="#l1.4973"></a><span id="l1.4973" class="difflineminus">-          if (aData &amp;&amp; prop in aData) {</span>
<a href="#l1.4974"></a><span id="l1.4974" class="difflineminus">-            this[prop] = aData[prop];</span>
<a href="#l1.4975"></a><span id="l1.4975" class="difflineplus">+          /* istanbul ignore else */</span>
<a href="#l1.4976"></a><span id="l1.4976" class="difflineplus">+          if (OPTIONS.hasOwnProperty(key)) {</span>
<a href="#l1.4977"></a><span id="l1.4977" class="difflineplus">+            var prop = OPTIONS[key];</span>
<a href="#l1.4978"></a><span id="l1.4978" class="difflineplus">+            if (aData &amp;&amp; prop in aData) {</span>
<a href="#l1.4979"></a><span id="l1.4979" class="difflineplus">+              this[prop] = aData[prop];</span>
<a href="#l1.4980"></a><span id="l1.4980" class="difflineplus">+            }</span>
<a href="#l1.4981"></a><span id="l1.4981">           }</span>
<a href="#l1.4982"></a><span id="l1.4982">         }</span>
<a href="#l1.4983"></a><span id="l1.4983">       }</span>
<a href="#l1.4984"></a><span id="l1.4984"> </span>
<a href="#l1.4985"></a><span id="l1.4985">       // If we have a component but no TZID, attempt to get it from the</span>
<a href="#l1.4986"></a><span id="l1.4986">       // component's properties.</span>
<a href="#l1.4987"></a><span id="l1.4987">       if (this.component instanceof ICAL.Component &amp;&amp; !this.tzid) {</span>
<a href="#l1.4988"></a><span id="l1.4988">         this.tzid = this.component.getFirstPropertyValue('tzid');</span>
<a href="#l1.4989"></a><span id="l1.4989">       }</span>
<a href="#l1.4990"></a><span id="l1.4990"> </span>
<a href="#l1.4991"></a><span id="l1.4991">       return this;</span>
<a href="#l1.4992"></a><span id="l1.4992">     },</span>
<a href="#l1.4993"></a><span id="l1.4993"> </span>
<a href="#l1.4994"></a><span id="l1.4994">     /**</span>
<a href="#l1.4995"></a><span id="l1.4995">      * Finds the utcOffset the given time would occur in this timezone.</span>
<a href="#l1.4996"></a><span id="l1.4996">      *</span>
<a href="#l1.4997"></a><span id="l1.4997" class="difflineminus">-     * @return {Number} utc offset in seconds.</span>
<a href="#l1.4998"></a><span id="l1.4998" class="difflineplus">+     * @param {ICAL.Time} tt        The time to check for</span>
<a href="#l1.4999"></a><span id="l1.4999" class="difflineplus">+     * @return {Number} utc offset in seconds</span>
<a href="#l1.5000"></a><span id="l1.5000">      */</span>
<a href="#l1.5001"></a><span id="l1.5001">     utcOffset: function utcOffset(tt) {</span>
<a href="#l1.5002"></a><span id="l1.5002">       if (this == ICAL.Timezone.utcTimezone || this == ICAL.Timezone.localTimezone) {</span>
<a href="#l1.5003"></a><span id="l1.5003">         return 0;</span>
<a href="#l1.5004"></a><span id="l1.5004">       }</span>
<a href="#l1.5005"></a><span id="l1.5005"> </span>
<a href="#l1.5006"></a><span id="l1.5006">       this._ensureCoverage(tt.year);</span>
<a href="#l1.5007"></a><span id="l1.5007"> </span>
<a href="#l1.5008"></a><span id="l1.5008" class="difflineat">@@ -2995,16 +4355,17 @@ ICAL.Binary = (function() {</span>
<a href="#l1.5009"></a><span id="l1.5009">     _expandComponent: function(aComponent, aYear, changes) {</span>
<a href="#l1.5010"></a><span id="l1.5010">       if (!aComponent.hasProperty(&quot;dtstart&quot;) ||</span>
<a href="#l1.5011"></a><span id="l1.5011">           !aComponent.hasProperty(&quot;tzoffsetto&quot;) ||</span>
<a href="#l1.5012"></a><span id="l1.5012">           !aComponent.hasProperty(&quot;tzoffsetfrom&quot;)) {</span>
<a href="#l1.5013"></a><span id="l1.5013">         return null;</span>
<a href="#l1.5014"></a><span id="l1.5014">       }</span>
<a href="#l1.5015"></a><span id="l1.5015"> </span>
<a href="#l1.5016"></a><span id="l1.5016">       var dtstart = aComponent.getFirstProperty(&quot;dtstart&quot;).getFirstValue();</span>
<a href="#l1.5017"></a><span id="l1.5017" class="difflineplus">+      var change;</span>
<a href="#l1.5018"></a><span id="l1.5018"> </span>
<a href="#l1.5019"></a><span id="l1.5019">       function convert_tzoffset(offset) {</span>
<a href="#l1.5020"></a><span id="l1.5020">         return offset.factor * (offset.hours * 3600 + offset.minutes * 60);</span>
<a href="#l1.5021"></a><span id="l1.5021">       }</span>
<a href="#l1.5022"></a><span id="l1.5022"> </span>
<a href="#l1.5023"></a><span id="l1.5023">       function init_changes() {</span>
<a href="#l1.5024"></a><span id="l1.5024">         var changebase = {};</span>
<a href="#l1.5025"></a><span id="l1.5025">         changebase.is_daylight = (aComponent.name == &quot;daylight&quot;);</span>
<a href="#l1.5026"></a><span id="l1.5026" class="difflineat">@@ -3015,33 +4376,37 @@ ICAL.Binary = (function() {</span>
<a href="#l1.5027"></a><span id="l1.5027">         changebase.prevUtcOffset = convert_tzoffset(</span>
<a href="#l1.5028"></a><span id="l1.5028">           aComponent.getFirstProperty(&quot;tzoffsetfrom&quot;).getFirstValue()</span>
<a href="#l1.5029"></a><span id="l1.5029">         );</span>
<a href="#l1.5030"></a><span id="l1.5030"> </span>
<a href="#l1.5031"></a><span id="l1.5031">         return changebase;</span>
<a href="#l1.5032"></a><span id="l1.5032">       }</span>
<a href="#l1.5033"></a><span id="l1.5033"> </span>
<a href="#l1.5034"></a><span id="l1.5034">       if (!aComponent.hasProperty(&quot;rrule&quot;) &amp;&amp; !aComponent.hasProperty(&quot;rdate&quot;)) {</span>
<a href="#l1.5035"></a><span id="l1.5035" class="difflineminus">-        var change = init_changes();</span>
<a href="#l1.5036"></a><span id="l1.5036" class="difflineplus">+        change = init_changes();</span>
<a href="#l1.5037"></a><span id="l1.5037">         change.year = dtstart.year;</span>
<a href="#l1.5038"></a><span id="l1.5038">         change.month = dtstart.month;</span>
<a href="#l1.5039"></a><span id="l1.5039">         change.day = dtstart.day;</span>
<a href="#l1.5040"></a><span id="l1.5040">         change.hour = dtstart.hour;</span>
<a href="#l1.5041"></a><span id="l1.5041">         change.minute = dtstart.minute;</span>
<a href="#l1.5042"></a><span id="l1.5042">         change.second = dtstart.second;</span>
<a href="#l1.5043"></a><span id="l1.5043"> </span>
<a href="#l1.5044"></a><span id="l1.5044">         ICAL.Timezone.adjust_change(change, 0, 0, 0,</span>
<a href="#l1.5045"></a><span id="l1.5045">                                         -change.prevUtcOffset);</span>
<a href="#l1.5046"></a><span id="l1.5046">         changes.push(change);</span>
<a href="#l1.5047"></a><span id="l1.5047">       } else {</span>
<a href="#l1.5048"></a><span id="l1.5048">         var props = aComponent.getAllProperties(&quot;rdate&quot;);</span>
<a href="#l1.5049"></a><span id="l1.5049">         for (var rdatekey in props) {</span>
<a href="#l1.5050"></a><span id="l1.5050" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.5051"></a><span id="l1.5051" class="difflineplus">+          if (!props.hasOwnProperty(rdatekey)) {</span>
<a href="#l1.5052"></a><span id="l1.5052" class="difflineplus">+            continue;</span>
<a href="#l1.5053"></a><span id="l1.5053" class="difflineplus">+          }</span>
<a href="#l1.5054"></a><span id="l1.5054">           var rdate = props[rdatekey];</span>
<a href="#l1.5055"></a><span id="l1.5055">           var time = rdate.getFirstValue();</span>
<a href="#l1.5056"></a><span id="l1.5056" class="difflineminus">-          var change = init_changes();</span>
<a href="#l1.5057"></a><span id="l1.5057" class="difflineplus">+          change = init_changes();</span>
<a href="#l1.5058"></a><span id="l1.5058"> </span>
<a href="#l1.5059"></a><span id="l1.5059">           change.year = time.year;</span>
<a href="#l1.5060"></a><span id="l1.5060">           change.month = time.month;</span>
<a href="#l1.5061"></a><span id="l1.5061">           change.day = time.day;</span>
<a href="#l1.5062"></a><span id="l1.5062"> </span>
<a href="#l1.5063"></a><span id="l1.5063">           if (time.isDate) {</span>
<a href="#l1.5064"></a><span id="l1.5064">             change.hour = dtstart.hour;</span>
<a href="#l1.5065"></a><span id="l1.5065">             change.minute = dtstart.minute;</span>
<a href="#l1.5066"></a><span id="l1.5066" class="difflineat">@@ -3064,28 +4429,28 @@ ICAL.Binary = (function() {</span>
<a href="#l1.5067"></a><span id="l1.5067"> </span>
<a href="#l1.5068"></a><span id="l1.5068">           changes.push(change);</span>
<a href="#l1.5069"></a><span id="l1.5069">         }</span>
<a href="#l1.5070"></a><span id="l1.5070"> </span>
<a href="#l1.5071"></a><span id="l1.5071">         var rrule = aComponent.getFirstProperty(&quot;rrule&quot;);</span>
<a href="#l1.5072"></a><span id="l1.5072"> </span>
<a href="#l1.5073"></a><span id="l1.5073">         if (rrule) {</span>
<a href="#l1.5074"></a><span id="l1.5074">           rrule = rrule.getFirstValue();</span>
<a href="#l1.5075"></a><span id="l1.5075" class="difflineminus">-          var change = init_changes();</span>
<a href="#l1.5076"></a><span id="l1.5076" class="difflineplus">+          change = init_changes();</span>
<a href="#l1.5077"></a><span id="l1.5077"> </span>
<a href="#l1.5078"></a><span id="l1.5078">           if (rrule.until &amp;&amp; rrule.until.zone == ICAL.Timezone.utcTimezone) {</span>
<a href="#l1.5079"></a><span id="l1.5079">             rrule.until.adjust(0, 0, 0, change.prevUtcOffset);</span>
<a href="#l1.5080"></a><span id="l1.5080">             rrule.until.zone = ICAL.Timezone.localTimezone;</span>
<a href="#l1.5081"></a><span id="l1.5081">           }</span>
<a href="#l1.5082"></a><span id="l1.5082"> </span>
<a href="#l1.5083"></a><span id="l1.5083">           var iterator = rrule.iterator(dtstart);</span>
<a href="#l1.5084"></a><span id="l1.5084"> </span>
<a href="#l1.5085"></a><span id="l1.5085">           var occ;</span>
<a href="#l1.5086"></a><span id="l1.5086">           while ((occ = iterator.next())) {</span>
<a href="#l1.5087"></a><span id="l1.5087" class="difflineminus">-            var change = init_changes();</span>
<a href="#l1.5088"></a><span id="l1.5088" class="difflineplus">+            change = init_changes();</span>
<a href="#l1.5089"></a><span id="l1.5089">             if (occ.year &gt; aYear || !occ) {</span>
<a href="#l1.5090"></a><span id="l1.5090">               break;</span>
<a href="#l1.5091"></a><span id="l1.5091">             }</span>
<a href="#l1.5092"></a><span id="l1.5092"> </span>
<a href="#l1.5093"></a><span id="l1.5093">             change.year = occ.year;</span>
<a href="#l1.5094"></a><span id="l1.5094">             change.month = occ.month;</span>
<a href="#l1.5095"></a><span id="l1.5095">             change.day = occ.day;</span>
<a href="#l1.5096"></a><span id="l1.5096">             change.hour = occ.hour;</span>
<a href="#l1.5097"></a><span id="l1.5097" class="difflineat">@@ -3098,20 +4463,23 @@ ICAL.Binary = (function() {</span>
<a href="#l1.5098"></a><span id="l1.5098">             changes.push(change);</span>
<a href="#l1.5099"></a><span id="l1.5099">           }</span>
<a href="#l1.5100"></a><span id="l1.5100">         }</span>
<a href="#l1.5101"></a><span id="l1.5101">       }</span>
<a href="#l1.5102"></a><span id="l1.5102"> </span>
<a href="#l1.5103"></a><span id="l1.5103">       return changes;</span>
<a href="#l1.5104"></a><span id="l1.5104">     },</span>
<a href="#l1.5105"></a><span id="l1.5105"> </span>
<a href="#l1.5106"></a><span id="l1.5106" class="difflineplus">+    /**</span>
<a href="#l1.5107"></a><span id="l1.5107" class="difflineplus">+     * The string representation of this timezone.</span>
<a href="#l1.5108"></a><span id="l1.5108" class="difflineplus">+     * @return {String}</span>
<a href="#l1.5109"></a><span id="l1.5109" class="difflineplus">+     */</span>
<a href="#l1.5110"></a><span id="l1.5110">     toString: function toString() {</span>
<a href="#l1.5111"></a><span id="l1.5111">       return (this.tznames ? this.tznames : this.tzid);</span>
<a href="#l1.5112"></a><span id="l1.5112">     }</span>
<a href="#l1.5113"></a><span id="l1.5113" class="difflineminus">-</span>
<a href="#l1.5114"></a><span id="l1.5114">   };</span>
<a href="#l1.5115"></a><span id="l1.5115"> </span>
<a href="#l1.5116"></a><span id="l1.5116">   ICAL.Timezone._compare_change_fn = function icaltimezone_compare_change_fn(a, b) {</span>
<a href="#l1.5117"></a><span id="l1.5117">     if (a.year &lt; b.year) return -1;</span>
<a href="#l1.5118"></a><span id="l1.5118">     else if (a.year &gt; b.year) return 1;</span>
<a href="#l1.5119"></a><span id="l1.5119"> </span>
<a href="#l1.5120"></a><span id="l1.5120">     if (a.month &lt; b.month) return -1;</span>
<a href="#l1.5121"></a><span id="l1.5121">     else if (a.month &gt; b.month) return 1;</span>
<a href="#l1.5122"></a><span id="l1.5122" class="difflineat">@@ -3126,16 +4494,24 @@ ICAL.Binary = (function() {</span>
<a href="#l1.5123"></a><span id="l1.5123">     else if (a.minute &gt; b.minute) return 1;</span>
<a href="#l1.5124"></a><span id="l1.5124"> </span>
<a href="#l1.5125"></a><span id="l1.5125">     if (a.second &lt; b.second) return -1;</span>
<a href="#l1.5126"></a><span id="l1.5126">     else if (a.second &gt; b.second) return 1;</span>
<a href="#l1.5127"></a><span id="l1.5127"> </span>
<a href="#l1.5128"></a><span id="l1.5128">     return 0;</span>
<a href="#l1.5129"></a><span id="l1.5129">   };</span>
<a href="#l1.5130"></a><span id="l1.5130"> </span>
<a href="#l1.5131"></a><span id="l1.5131" class="difflineplus">+  /**</span>
<a href="#l1.5132"></a><span id="l1.5132" class="difflineplus">+   * Convert the date/time from one zone to the next.</span>
<a href="#l1.5133"></a><span id="l1.5133" class="difflineplus">+   *</span>
<a href="#l1.5134"></a><span id="l1.5134" class="difflineplus">+   * @param {ICAL.Time} tt                  The time to convert</span>
<a href="#l1.5135"></a><span id="l1.5135" class="difflineplus">+   * @param {ICAL.Timezone} from_zone       The source zone to convert from</span>
<a href="#l1.5136"></a><span id="l1.5136" class="difflineplus">+   * @param {ICAL.Timezone} to_zone         The target zone to conver to</span>
<a href="#l1.5137"></a><span id="l1.5137" class="difflineplus">+   * @return {ICAL.Time}                    The converted date/time object</span>
<a href="#l1.5138"></a><span id="l1.5138" class="difflineplus">+   */</span>
<a href="#l1.5139"></a><span id="l1.5139">   ICAL.Timezone.convert_time = function icaltimezone_convert_time(tt, from_zone, to_zone) {</span>
<a href="#l1.5140"></a><span id="l1.5140">     if (tt.isDate ||</span>
<a href="#l1.5141"></a><span id="l1.5141">         from_zone.tzid == to_zone.tzid ||</span>
<a href="#l1.5142"></a><span id="l1.5142">         from_zone == ICAL.Timezone.localTimezone ||</span>
<a href="#l1.5143"></a><span id="l1.5143">         to_zone == ICAL.Timezone.localTimezone) {</span>
<a href="#l1.5144"></a><span id="l1.5144">       tt.zone = to_zone;</span>
<a href="#l1.5145"></a><span id="l1.5145">       return tt;</span>
<a href="#l1.5146"></a><span id="l1.5146">     }</span>
<a href="#l1.5147"></a><span id="l1.5147" class="difflineat">@@ -3144,88 +4520,140 @@ ICAL.Binary = (function() {</span>
<a href="#l1.5148"></a><span id="l1.5148">     tt.adjust(0, 0, 0, - utcOffset);</span>
<a href="#l1.5149"></a><span id="l1.5149"> </span>
<a href="#l1.5150"></a><span id="l1.5150">     utcOffset = to_zone.utcOffset(tt);</span>
<a href="#l1.5151"></a><span id="l1.5151">     tt.adjust(0, 0, 0, utcOffset);</span>
<a href="#l1.5152"></a><span id="l1.5152"> </span>
<a href="#l1.5153"></a><span id="l1.5153">     return null;</span>
<a href="#l1.5154"></a><span id="l1.5154">   };</span>
<a href="#l1.5155"></a><span id="l1.5155"> </span>
<a href="#l1.5156"></a><span id="l1.5156" class="difflineplus">+  /**</span>
<a href="#l1.5157"></a><span id="l1.5157" class="difflineplus">+   * Creates a new ICAL.Timezone instance from the passed data object.</span>
<a href="#l1.5158"></a><span id="l1.5158" class="difflineplus">+   *</span>
<a href="#l1.5159"></a><span id="l1.5159" class="difflineplus">+   * @param {ICAL.Component|Object} aData options for class</span>
<a href="#l1.5160"></a><span id="l1.5160" class="difflineplus">+   * @param {String|ICAL.Component} aData.component</span>
<a href="#l1.5161"></a><span id="l1.5161" class="difflineplus">+   *        If aData is a simple object, then this member can be set to either a</span>
<a href="#l1.5162"></a><span id="l1.5162" class="difflineplus">+   *        string containing the component data, or an already parsed</span>
<a href="#l1.5163"></a><span id="l1.5163" class="difflineplus">+   *        ICAL.Component</span>
<a href="#l1.5164"></a><span id="l1.5164" class="difflineplus">+   * @param {String} aData.tzid      The timezone identifier</span>
<a href="#l1.5165"></a><span id="l1.5165" class="difflineplus">+   * @param {String} aData.location  The timezone locationw</span>
<a href="#l1.5166"></a><span id="l1.5166" class="difflineplus">+   * @param {String} aData.tznames   An alternative string representation of the</span>
<a href="#l1.5167"></a><span id="l1.5167" class="difflineplus">+   *                                  timezone</span>
<a href="#l1.5168"></a><span id="l1.5168" class="difflineplus">+   * @param {Number} aData.latitude  The latitude of the timezone</span>
<a href="#l1.5169"></a><span id="l1.5169" class="difflineplus">+   * @param {Number} aData.longitude The longitude of the timezone</span>
<a href="#l1.5170"></a><span id="l1.5170" class="difflineplus">+   */</span>
<a href="#l1.5171"></a><span id="l1.5171">   ICAL.Timezone.fromData = function icaltimezone_fromData(aData) {</span>
<a href="#l1.5172"></a><span id="l1.5172">     var tt = new ICAL.Timezone();</span>
<a href="#l1.5173"></a><span id="l1.5173">     return tt.fromData(aData);</span>
<a href="#l1.5174"></a><span id="l1.5174">   };</span>
<a href="#l1.5175"></a><span id="l1.5175"> </span>
<a href="#l1.5176"></a><span id="l1.5176" class="difflineplus">+  /**</span>
<a href="#l1.5177"></a><span id="l1.5177" class="difflineplus">+   * The instance describing the UTC timezone</span>
<a href="#l1.5178"></a><span id="l1.5178" class="difflineplus">+   * @type {ICAL.Timezone}</span>
<a href="#l1.5179"></a><span id="l1.5179" class="difflineplus">+   * @constant</span>
<a href="#l1.5180"></a><span id="l1.5180" class="difflineplus">+   * @instance</span>
<a href="#l1.5181"></a><span id="l1.5181" class="difflineplus">+   */</span>
<a href="#l1.5182"></a><span id="l1.5182">   ICAL.Timezone.utcTimezone = ICAL.Timezone.fromData({</span>
<a href="#l1.5183"></a><span id="l1.5183">     tzid: &quot;UTC&quot;</span>
<a href="#l1.5184"></a><span id="l1.5184">   });</span>
<a href="#l1.5185"></a><span id="l1.5185"> </span>
<a href="#l1.5186"></a><span id="l1.5186" class="difflineplus">+  /**</span>
<a href="#l1.5187"></a><span id="l1.5187" class="difflineplus">+   * The instance describing the local timezone</span>
<a href="#l1.5188"></a><span id="l1.5188" class="difflineplus">+   * @type {ICAL.Timezone}</span>
<a href="#l1.5189"></a><span id="l1.5189" class="difflineplus">+   * @constant</span>
<a href="#l1.5190"></a><span id="l1.5190" class="difflineplus">+   * @instance</span>
<a href="#l1.5191"></a><span id="l1.5191" class="difflineplus">+   */</span>
<a href="#l1.5192"></a><span id="l1.5192">   ICAL.Timezone.localTimezone = ICAL.Timezone.fromData({</span>
<a href="#l1.5193"></a><span id="l1.5193">     tzid: &quot;floating&quot;</span>
<a href="#l1.5194"></a><span id="l1.5194">   });</span>
<a href="#l1.5195"></a><span id="l1.5195"> </span>
<a href="#l1.5196"></a><span id="l1.5196" class="difflineplus">+  /**</span>
<a href="#l1.5197"></a><span id="l1.5197" class="difflineplus">+   * Adjust a timezone change object.</span>
<a href="#l1.5198"></a><span id="l1.5198" class="difflineplus">+   * @private</span>
<a href="#l1.5199"></a><span id="l1.5199" class="difflineplus">+   * @param {Object} change     The timezone change object</span>
<a href="#l1.5200"></a><span id="l1.5200" class="difflineplus">+   * @param {Number} days       The extra amount of days</span>
<a href="#l1.5201"></a><span id="l1.5201" class="difflineplus">+   * @param {Number} hours      The extra amount of hours</span>
<a href="#l1.5202"></a><span id="l1.5202" class="difflineplus">+   * @param {Number} minutes    The extra amount of minutes</span>
<a href="#l1.5203"></a><span id="l1.5203" class="difflineplus">+   * @param {Number} seconds    The extra amount of seconds</span>
<a href="#l1.5204"></a><span id="l1.5204" class="difflineplus">+   */</span>
<a href="#l1.5205"></a><span id="l1.5205">   ICAL.Timezone.adjust_change = function icaltimezone_adjust_change(change, days, hours, minutes, seconds) {</span>
<a href="#l1.5206"></a><span id="l1.5206">     return ICAL.Time.prototype.adjust.call(</span>
<a href="#l1.5207"></a><span id="l1.5207">       change,</span>
<a href="#l1.5208"></a><span id="l1.5208">       days,</span>
<a href="#l1.5209"></a><span id="l1.5209">       hours,</span>
<a href="#l1.5210"></a><span id="l1.5210">       minutes,</span>
<a href="#l1.5211"></a><span id="l1.5211">       seconds,</span>
<a href="#l1.5212"></a><span id="l1.5212">       change</span>
<a href="#l1.5213"></a><span id="l1.5213">     );</span>
<a href="#l1.5214"></a><span id="l1.5214">   };</span>
<a href="#l1.5215"></a><span id="l1.5215"> </span>
<a href="#l1.5216"></a><span id="l1.5216">   ICAL.Timezone._minimumExpansionYear = -1;</span>
<a href="#l1.5217"></a><span id="l1.5217">   ICAL.Timezone.MAX_YEAR = 2035; // TODO this is because of time_t, which we don't need. Still usefull?</span>
<a href="#l1.5218"></a><span id="l1.5218">   ICAL.Timezone.EXTRA_COVERAGE = 5;</span>
<a href="#l1.5219"></a><span id="l1.5219"> })();</span>
<a href="#l1.5220"></a><span id="l1.5220" class="difflineminus">-// singleton class to contain timezones.</span>
<a href="#l1.5221"></a><span id="l1.5221" class="difflineminus">-// Right now its all manual registry in the</span>
<a href="#l1.5222"></a><span id="l1.5222" class="difflineminus">-// future we may use this class to download timezone</span>
<a href="#l1.5223"></a><span id="l1.5223" class="difflineminus">-// information or handle loading pre-expanded timezones.</span>
<a href="#l1.5224"></a><span id="l1.5224" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5225"></a><span id="l1.5225" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5226"></a><span id="l1.5226" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.5227"></a><span id="l1.5227" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.5228"></a><span id="l1.5228" class="difflineplus">+</span>
<a href="#l1.5229"></a><span id="l1.5229" class="difflineplus">+</span>
<a href="#l1.5230"></a><span id="l1.5230" class="difflineplus">+/**</span>
<a href="#l1.5231"></a><span id="l1.5231" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.5232"></a><span id="l1.5232" class="difflineplus">+ * @ignore</span>
<a href="#l1.5233"></a><span id="l1.5233" class="difflineplus">+ */</span>
<a href="#l1.5234"></a><span id="l1.5234"> ICAL.TimezoneService = (function() {</span>
<a href="#l1.5235"></a><span id="l1.5235">   var zones;</span>
<a href="#l1.5236"></a><span id="l1.5236"> </span>
<a href="#l1.5237"></a><span id="l1.5237" class="difflineminus">-  // Using var rather then return so we don't need to name the functions twice.</span>
<a href="#l1.5238"></a><span id="l1.5238" class="difflineminus">-  // TimezoneService#get will appear in profiler, etc...</span>
<a href="#l1.5239"></a><span id="l1.5239" class="difflineplus">+  /**</span>
<a href="#l1.5240"></a><span id="l1.5240" class="difflineplus">+   * @classdesc</span>
<a href="#l1.5241"></a><span id="l1.5241" class="difflineplus">+   * Singleton class to contain timezones.  Right now its all manual registry in</span>
<a href="#l1.5242"></a><span id="l1.5242" class="difflineplus">+   * the future we may use this class to download timezone information or handle</span>
<a href="#l1.5243"></a><span id="l1.5243" class="difflineplus">+   * loading pre-expanded timezones.</span>
<a href="#l1.5244"></a><span id="l1.5244" class="difflineplus">+   *</span>
<a href="#l1.5245"></a><span id="l1.5245" class="difflineplus">+   * @namespace</span>
<a href="#l1.5246"></a><span id="l1.5246" class="difflineplus">+   * @alias ICAL.TimezoneService</span>
<a href="#l1.5247"></a><span id="l1.5247" class="difflineplus">+   */</span>
<a href="#l1.5248"></a><span id="l1.5248">   var TimezoneService = {</span>
<a href="#l1.5249"></a><span id="l1.5249">     reset: function() {</span>
<a href="#l1.5250"></a><span id="l1.5250">       zones = Object.create(null);</span>
<a href="#l1.5251"></a><span id="l1.5251">       var utc = ICAL.Timezone.utcTimezone;</span>
<a href="#l1.5252"></a><span id="l1.5252"> </span>
<a href="#l1.5253"></a><span id="l1.5253">       zones.Z = utc;</span>
<a href="#l1.5254"></a><span id="l1.5254">       zones.UTC = utc;</span>
<a href="#l1.5255"></a><span id="l1.5255">       zones.GMT = utc;</span>
<a href="#l1.5256"></a><span id="l1.5256">     },</span>
<a href="#l1.5257"></a><span id="l1.5257"> </span>
<a href="#l1.5258"></a><span id="l1.5258">     /**</span>
<a href="#l1.5259"></a><span id="l1.5259">      * Checks if timezone id has been registered.</span>
<a href="#l1.5260"></a><span id="l1.5260">      *</span>
<a href="#l1.5261"></a><span id="l1.5261" class="difflineminus">-     * @param {String} tzid (e.g. America/Los_Angeles).</span>
<a href="#l1.5262"></a><span id="l1.5262" class="difflineminus">-     * @return {Boolean} false when not present.</span>
<a href="#l1.5263"></a><span id="l1.5263" class="difflineplus">+     * @param {String} tzid     Timezone identifier (e.g. America/Los_Angeles)</span>
<a href="#l1.5264"></a><span id="l1.5264" class="difflineplus">+     * @return {Boolean}        False, when not present</span>
<a href="#l1.5265"></a><span id="l1.5265">      */</span>
<a href="#l1.5266"></a><span id="l1.5266">     has: function(tzid) {</span>
<a href="#l1.5267"></a><span id="l1.5267">       return !!zones[tzid];</span>
<a href="#l1.5268"></a><span id="l1.5268">     },</span>
<a href="#l1.5269"></a><span id="l1.5269"> </span>
<a href="#l1.5270"></a><span id="l1.5270">     /**</span>
<a href="#l1.5271"></a><span id="l1.5271">      * Returns a timezone by its tzid if present.</span>
<a href="#l1.5272"></a><span id="l1.5272">      *</span>
<a href="#l1.5273"></a><span id="l1.5273" class="difflineminus">-     * @param {String} tzid name of timezone (e.g. America/Los_Angeles).</span>
<a href="#l1.5274"></a><span id="l1.5274" class="difflineminus">-     * @return {ICAL.Timezone|Null} zone or null.</span>
<a href="#l1.5275"></a><span id="l1.5275" class="difflineplus">+     * @param {String} tzid     Timezone identifier (e.g. America/Los_Angeles)</span>
<a href="#l1.5276"></a><span id="l1.5276" class="difflineplus">+     * @return {?ICAL.Timezone} The timezone, or null if not found</span>
<a href="#l1.5277"></a><span id="l1.5277">      */</span>
<a href="#l1.5278"></a><span id="l1.5278">     get: function(tzid) {</span>
<a href="#l1.5279"></a><span id="l1.5279">       return zones[tzid];</span>
<a href="#l1.5280"></a><span id="l1.5280">     },</span>
<a href="#l1.5281"></a><span id="l1.5281"> </span>
<a href="#l1.5282"></a><span id="l1.5282">     /**</span>
<a href="#l1.5283"></a><span id="l1.5283">      * Registers a timezone object or component.</span>
<a href="#l1.5284"></a><span id="l1.5284">      *</span>
<a href="#l1.5285"></a><span id="l1.5285" class="difflineminus">-     * @param {String} [name] optional uses timezone.tzid by default.</span>
<a href="#l1.5286"></a><span id="l1.5286" class="difflineminus">-     * @param {ICAL.Component|ICAL.Timezone} zone initialized zone or vtimezone.</span>
<a href="#l1.5287"></a><span id="l1.5287" class="difflineplus">+     * @param {String=} name</span>
<a href="#l1.5288"></a><span id="l1.5288" class="difflineplus">+     *        The name of the timezone. Defaults to the component's TZID if not</span>
<a href="#l1.5289"></a><span id="l1.5289" class="difflineplus">+     *        passed.</span>
<a href="#l1.5290"></a><span id="l1.5290" class="difflineplus">+     * @param {ICAL.Component|ICAL.Timezone} zone</span>
<a href="#l1.5291"></a><span id="l1.5291" class="difflineplus">+     *        The initialized zone or vtimezone.</span>
<a href="#l1.5292"></a><span id="l1.5292">      */</span>
<a href="#l1.5293"></a><span id="l1.5293">     register: function(name, timezone) {</span>
<a href="#l1.5294"></a><span id="l1.5294">       if (name instanceof ICAL.Component) {</span>
<a href="#l1.5295"></a><span id="l1.5295">         if (name.name === 'vtimezone') {</span>
<a href="#l1.5296"></a><span id="l1.5296">           timezone = new ICAL.Timezone(name);</span>
<a href="#l1.5297"></a><span id="l1.5297">           name = timezone.tzid;</span>
<a href="#l1.5298"></a><span id="l1.5298">         }</span>
<a href="#l1.5299"></a><span id="l1.5299">       }</span>
<a href="#l1.5300"></a><span id="l1.5300" class="difflineat">@@ -3235,56 +4663,67 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5301"></a><span id="l1.5301">       } else {</span>
<a href="#l1.5302"></a><span id="l1.5302">         throw new TypeError('timezone must be ICAL.Timezone or ICAL.Component');</span>
<a href="#l1.5303"></a><span id="l1.5303">       }</span>
<a href="#l1.5304"></a><span id="l1.5304">     },</span>
<a href="#l1.5305"></a><span id="l1.5305"> </span>
<a href="#l1.5306"></a><span id="l1.5306">     /**</span>
<a href="#l1.5307"></a><span id="l1.5307">      * Removes a timezone by its tzid from the list.</span>
<a href="#l1.5308"></a><span id="l1.5308">      *</span>
<a href="#l1.5309"></a><span id="l1.5309" class="difflineminus">-     * @param {String} tzid (e.g. America/Los_Angeles).</span>
<a href="#l1.5310"></a><span id="l1.5310" class="difflineplus">+     * @param {String} tzid     Timezone identifier (e.g. America/Los_Angeles)</span>
<a href="#l1.5311"></a><span id="l1.5311" class="difflineplus">+     * @return {?ICAL.Timezone} The removed timezone, or null if not registered</span>
<a href="#l1.5312"></a><span id="l1.5312">      */</span>
<a href="#l1.5313"></a><span id="l1.5313">     remove: function(tzid) {</span>
<a href="#l1.5314"></a><span id="l1.5314">       return (delete zones[tzid]);</span>
<a href="#l1.5315"></a><span id="l1.5315">     }</span>
<a href="#l1.5316"></a><span id="l1.5316">   };</span>
<a href="#l1.5317"></a><span id="l1.5317"> </span>
<a href="#l1.5318"></a><span id="l1.5318">   // initialize defaults</span>
<a href="#l1.5319"></a><span id="l1.5319">   TimezoneService.reset();</span>
<a href="#l1.5320"></a><span id="l1.5320"> </span>
<a href="#l1.5321"></a><span id="l1.5321">   return TimezoneService;</span>
<a href="#l1.5322"></a><span id="l1.5322"> }());</span>
<a href="#l1.5323"></a><span id="l1.5323"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5324"></a><span id="l1.5324">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5325"></a><span id="l1.5325">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.5326"></a><span id="l1.5326" class="difflineminus">- * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.5327"></a><span id="l1.5327" class="difflineminus">-</span>
<a href="#l1.5328"></a><span id="l1.5328" class="difflineminus">-</span>
<a href="#l1.5329"></a><span id="l1.5329" class="difflineminus">-</span>
<a href="#l1.5330"></a><span id="l1.5330" class="difflineminus">-(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l1.5331"></a><span id="l1.5331" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.5332"></a><span id="l1.5332" class="difflineplus">+</span>
<a href="#l1.5333"></a><span id="l1.5333" class="difflineplus">+</span>
<a href="#l1.5334"></a><span id="l1.5334" class="difflineplus">+</span>
<a href="#l1.5335"></a><span id="l1.5335"> (function() {</span>
<a href="#l1.5336"></a><span id="l1.5336"> </span>
<a href="#l1.5337"></a><span id="l1.5337">   /**</span>
<a href="#l1.5338"></a><span id="l1.5338" class="difflineminus">-   * Time representation (similar to JS Date object).</span>
<a href="#l1.5339"></a><span id="l1.5339" class="difflineminus">-   * Fully independent of system (OS) timezone / time.</span>
<a href="#l1.5340"></a><span id="l1.5340" class="difflineminus">-   * Unlike JS Date month start at 1 (Jan) not zero.</span>
<a href="#l1.5341"></a><span id="l1.5341" class="difflineminus">-   *</span>
<a href="#l1.5342"></a><span id="l1.5342" class="difflineminus">-   *</span>
<a href="#l1.5343"></a><span id="l1.5343" class="difflineminus">-   *    var time = new ICAL.Time({</span>
<a href="#l1.5344"></a><span id="l1.5344" class="difflineminus">-   *      year: 2012,</span>
<a href="#l1.5345"></a><span id="l1.5345" class="difflineminus">-   *      month: 10,</span>
<a href="#l1.5346"></a><span id="l1.5346" class="difflineminus">-   *      day: 11</span>
<a href="#l1.5347"></a><span id="l1.5347" class="difflineminus">-   *      minute: 0,</span>
<a href="#l1.5348"></a><span id="l1.5348" class="difflineminus">-   *      second: 0,</span>
<a href="#l1.5349"></a><span id="l1.5349" class="difflineminus">-   *      isDate: false</span>
<a href="#l1.5350"></a><span id="l1.5350" class="difflineminus">-   *    });</span>
<a href="#l1.5351"></a><span id="l1.5351" class="difflineminus">-   *</span>
<a href="#l1.5352"></a><span id="l1.5352" class="difflineminus">-   *</span>
<a href="#l1.5353"></a><span id="l1.5353" class="difflineminus">-   * @param {Object} data initialization time.</span>
<a href="#l1.5354"></a><span id="l1.5354" class="difflineminus">-   * @param {ICAL.Timezone} zone timezone this position occurs in.</span>
<a href="#l1.5355"></a><span id="l1.5355" class="difflineplus">+   * @classdesc</span>
<a href="#l1.5356"></a><span id="l1.5356" class="difflineplus">+   * iCalendar Time representation (similar to JS Date object).  Fully</span>
<a href="#l1.5357"></a><span id="l1.5357" class="difflineplus">+   * independent of system (OS) timezone / time.  Unlike JS Date, the month</span>
<a href="#l1.5358"></a><span id="l1.5358" class="difflineplus">+   * January is 1, not zero.</span>
<a href="#l1.5359"></a><span id="l1.5359" class="difflineplus">+   *</span>
<a href="#l1.5360"></a><span id="l1.5360" class="difflineplus">+   * @example</span>
<a href="#l1.5361"></a><span id="l1.5361" class="difflineplus">+   * var time = new ICAL.Time({</span>
<a href="#l1.5362"></a><span id="l1.5362" class="difflineplus">+   *   year: 2012,</span>
<a href="#l1.5363"></a><span id="l1.5363" class="difflineplus">+   *   month: 10,</span>
<a href="#l1.5364"></a><span id="l1.5364" class="difflineplus">+   *   day: 11</span>
<a href="#l1.5365"></a><span id="l1.5365" class="difflineplus">+   *   minute: 0,</span>
<a href="#l1.5366"></a><span id="l1.5366" class="difflineplus">+   *   second: 0,</span>
<a href="#l1.5367"></a><span id="l1.5367" class="difflineplus">+   *   isDate: false</span>
<a href="#l1.5368"></a><span id="l1.5368" class="difflineplus">+   * });</span>
<a href="#l1.5369"></a><span id="l1.5369" class="difflineplus">+   *</span>
<a href="#l1.5370"></a><span id="l1.5370" class="difflineplus">+   *</span>
<a href="#l1.5371"></a><span id="l1.5371" class="difflineplus">+   * @alias ICAL.Time</span>
<a href="#l1.5372"></a><span id="l1.5372" class="difflineplus">+   * @class</span>
<a href="#l1.5373"></a><span id="l1.5373" class="difflineplus">+   * @param {Object} data           Time initialization</span>
<a href="#l1.5374"></a><span id="l1.5374" class="difflineplus">+   * @param {Number=} data.year     The year for this date</span>
<a href="#l1.5375"></a><span id="l1.5375" class="difflineplus">+   * @param {Number=} data.month    The month for this date</span>
<a href="#l1.5376"></a><span id="l1.5376" class="difflineplus">+   * @param {Number=} data.day      The day for this date</span>
<a href="#l1.5377"></a><span id="l1.5377" class="difflineplus">+   * @param {Number=} data.hour     The hour for this date</span>
<a href="#l1.5378"></a><span id="l1.5378" class="difflineplus">+   * @param {Number=} data.minute   The minute for this date</span>
<a href="#l1.5379"></a><span id="l1.5379" class="difflineplus">+   * @param {Number=} data.second   The second for this date</span>
<a href="#l1.5380"></a><span id="l1.5380" class="difflineplus">+   * @param {Boolean=} data.isDate  If true, the instance represents a date (as</span>
<a href="#l1.5381"></a><span id="l1.5381" class="difflineplus">+   *                                  opposed to a date-time)</span>
<a href="#l1.5382"></a><span id="l1.5382" class="difflineplus">+   * @param {ICAL.Timezone} zone timezone this position occurs in</span>
<a href="#l1.5383"></a><span id="l1.5383">    */</span>
<a href="#l1.5384"></a><span id="l1.5384">   ICAL.Time = function icaltime(data, zone) {</span>
<a href="#l1.5385"></a><span id="l1.5385">     this.wrappedJSObject = this;</span>
<a href="#l1.5386"></a><span id="l1.5386">     var time = this._time = Object.create(null);</span>
<a href="#l1.5387"></a><span id="l1.5387"> </span>
<a href="#l1.5388"></a><span id="l1.5388">     /* time defaults */</span>
<a href="#l1.5389"></a><span id="l1.5389">     time.year = 0;</span>
<a href="#l1.5390"></a><span id="l1.5390">     time.month = 1;</span>
<a href="#l1.5391"></a><span id="l1.5391" class="difflineat">@@ -3292,74 +4731,104 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5392"></a><span id="l1.5392">     time.hour = 0;</span>
<a href="#l1.5393"></a><span id="l1.5393">     time.minute = 0;</span>
<a href="#l1.5394"></a><span id="l1.5394">     time.second = 0;</span>
<a href="#l1.5395"></a><span id="l1.5395">     time.isDate = false;</span>
<a href="#l1.5396"></a><span id="l1.5396"> </span>
<a href="#l1.5397"></a><span id="l1.5397">     this.fromData(data, zone);</span>
<a href="#l1.5398"></a><span id="l1.5398">   };</span>
<a href="#l1.5399"></a><span id="l1.5399"> </span>
<a href="#l1.5400"></a><span id="l1.5400" class="difflineplus">+  ICAL.Time._dowCache = {};</span>
<a href="#l1.5401"></a><span id="l1.5401" class="difflineplus">+  ICAL.Time._wnCache = {};</span>
<a href="#l1.5402"></a><span id="l1.5402" class="difflineplus">+</span>
<a href="#l1.5403"></a><span id="l1.5403">   ICAL.Time.prototype = {</span>
<a href="#l1.5404"></a><span id="l1.5404"> </span>
<a href="#l1.5405"></a><span id="l1.5405" class="difflineplus">+    /**</span>
<a href="#l1.5406"></a><span id="l1.5406" class="difflineplus">+     * The class identifier.</span>
<a href="#l1.5407"></a><span id="l1.5407" class="difflineplus">+     * @constant</span>
<a href="#l1.5408"></a><span id="l1.5408" class="difflineplus">+     * @type {String}</span>
<a href="#l1.5409"></a><span id="l1.5409" class="difflineplus">+     * @default &quot;icaltime&quot;</span>
<a href="#l1.5410"></a><span id="l1.5410" class="difflineplus">+     */</span>
<a href="#l1.5411"></a><span id="l1.5411">     icalclass: &quot;icaltime&quot;,</span>
<a href="#l1.5412"></a><span id="l1.5412" class="difflineminus">-</span>
<a href="#l1.5413"></a><span id="l1.5413" class="difflineminus">-    // is read only strictly defined by isDate</span>
<a href="#l1.5414"></a><span id="l1.5414" class="difflineplus">+    _cachedUnixTime: null,</span>
<a href="#l1.5415"></a><span id="l1.5415" class="difflineplus">+</span>
<a href="#l1.5416"></a><span id="l1.5416" class="difflineplus">+    /**</span>
<a href="#l1.5417"></a><span id="l1.5417" class="difflineplus">+     * The type name, to be used in the jCal object. This value may change and</span>
<a href="#l1.5418"></a><span id="l1.5418" class="difflineplus">+     * is strictly defined by the {@link ICAL.Time#isDate isDate} member.</span>
<a href="#l1.5419"></a><span id="l1.5419" class="difflineplus">+     * @readonly</span>
<a href="#l1.5420"></a><span id="l1.5420" class="difflineplus">+     * @type {String}</span>
<a href="#l1.5421"></a><span id="l1.5421" class="difflineplus">+     * @default &quot;date-time&quot;</span>
<a href="#l1.5422"></a><span id="l1.5422" class="difflineplus">+     */</span>
<a href="#l1.5423"></a><span id="l1.5423">     get icaltype() {</span>
<a href="#l1.5424"></a><span id="l1.5424">       return this.isDate ? 'date' : 'date-time';</span>
<a href="#l1.5425"></a><span id="l1.5425">     },</span>
<a href="#l1.5426"></a><span id="l1.5426"> </span>
<a href="#l1.5427"></a><span id="l1.5427">     /**</span>
<a href="#l1.5428"></a><span id="l1.5428" class="difflineminus">-     * @type ICAL.Timezone</span>
<a href="#l1.5429"></a><span id="l1.5429" class="difflineplus">+     * The timezone for this time.</span>
<a href="#l1.5430"></a><span id="l1.5430" class="difflineplus">+     * @type {ICAL.Timezone}</span>
<a href="#l1.5431"></a><span id="l1.5431">      */</span>
<a href="#l1.5432"></a><span id="l1.5432">     zone: null,</span>
<a href="#l1.5433"></a><span id="l1.5433"> </span>
<a href="#l1.5434"></a><span id="l1.5434">     /**</span>
<a href="#l1.5435"></a><span id="l1.5435" class="difflineminus">-     * Internal uses to indicate that a change has been</span>
<a href="#l1.5436"></a><span id="l1.5436" class="difflineminus">-     * made and the next read operation must attempt to</span>
<a href="#l1.5437"></a><span id="l1.5437" class="difflineminus">-     * normalize the value (for example changing the day to 33).</span>
<a href="#l1.5438"></a><span id="l1.5438" class="difflineminus">-     *</span>
<a href="#l1.5439"></a><span id="l1.5439" class="difflineminus">-     * @type Boolean</span>
<a href="#l1.5440"></a><span id="l1.5440" class="difflineplus">+     * Internal uses to indicate that a change has been made and the next read</span>
<a href="#l1.5441"></a><span id="l1.5441" class="difflineplus">+     * operation must attempt to normalize the value (for example changing the</span>
<a href="#l1.5442"></a><span id="l1.5442" class="difflineplus">+     * day to 33).</span>
<a href="#l1.5443"></a><span id="l1.5443" class="difflineplus">+     *</span>
<a href="#l1.5444"></a><span id="l1.5444" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.5445"></a><span id="l1.5445">      * @private</span>
<a href="#l1.5446"></a><span id="l1.5446">      */</span>
<a href="#l1.5447"></a><span id="l1.5447">     _pendingNormalization: false,</span>
<a href="#l1.5448"></a><span id="l1.5448"> </span>
<a href="#l1.5449"></a><span id="l1.5449" class="difflineminus">-    clone: function icaltime_clone() {</span>
<a href="#l1.5450"></a><span id="l1.5450" class="difflineplus">+    /**</span>
<a href="#l1.5451"></a><span id="l1.5451" class="difflineplus">+     * Returns a clone of the time object.</span>
<a href="#l1.5452"></a><span id="l1.5452" class="difflineplus">+     *</span>
<a href="#l1.5453"></a><span id="l1.5453" class="difflineplus">+     * @return {ICAL.Time}              The cloned object</span>
<a href="#l1.5454"></a><span id="l1.5454" class="difflineplus">+     */</span>
<a href="#l1.5455"></a><span id="l1.5455" class="difflineplus">+    clone: function() {</span>
<a href="#l1.5456"></a><span id="l1.5456">       return new ICAL.Time(this._time, this.zone);</span>
<a href="#l1.5457"></a><span id="l1.5457">     },</span>
<a href="#l1.5458"></a><span id="l1.5458"> </span>
<a href="#l1.5459"></a><span id="l1.5459" class="difflineplus">+    /**</span>
<a href="#l1.5460"></a><span id="l1.5460" class="difflineplus">+     * Reset the time instance to epoch time</span>
<a href="#l1.5461"></a><span id="l1.5461" class="difflineplus">+     */</span>
<a href="#l1.5462"></a><span id="l1.5462">     reset: function icaltime_reset() {</span>
<a href="#l1.5463"></a><span id="l1.5463">       this.fromData(ICAL.Time.epochTime);</span>
<a href="#l1.5464"></a><span id="l1.5464">       this.zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l1.5465"></a><span id="l1.5465">     },</span>
<a href="#l1.5466"></a><span id="l1.5466"> </span>
<a href="#l1.5467"></a><span id="l1.5467" class="difflineplus">+    /**</span>
<a href="#l1.5468"></a><span id="l1.5468" class="difflineplus">+     * Reset the time instance to the given date/time values.</span>
<a href="#l1.5469"></a><span id="l1.5469" class="difflineplus">+     *</span>
<a href="#l1.5470"></a><span id="l1.5470" class="difflineplus">+     * @param {Number} year             The year to set</span>
<a href="#l1.5471"></a><span id="l1.5471" class="difflineplus">+     * @param {Number} month            The month to set</span>
<a href="#l1.5472"></a><span id="l1.5472" class="difflineplus">+     * @param {Number} day              The day to set</span>
<a href="#l1.5473"></a><span id="l1.5473" class="difflineplus">+     * @param {Number} hour             The hour to set</span>
<a href="#l1.5474"></a><span id="l1.5474" class="difflineplus">+     * @param {Number} minute           The minute to set</span>
<a href="#l1.5475"></a><span id="l1.5475" class="difflineplus">+     * @param {Number} second           The second to set</span>
<a href="#l1.5476"></a><span id="l1.5476" class="difflineplus">+     * @param {ICAL.Timezone} timezone  The timezone to set</span>
<a href="#l1.5477"></a><span id="l1.5477" class="difflineplus">+     */</span>
<a href="#l1.5478"></a><span id="l1.5478">     resetTo: function icaltime_resetTo(year, month, day,</span>
<a href="#l1.5479"></a><span id="l1.5479">                                        hour, minute, second, timezone) {</span>
<a href="#l1.5480"></a><span id="l1.5480">       this.fromData({</span>
<a href="#l1.5481"></a><span id="l1.5481">         year: year,</span>
<a href="#l1.5482"></a><span id="l1.5482">         month: month,</span>
<a href="#l1.5483"></a><span id="l1.5483">         day: day,</span>
<a href="#l1.5484"></a><span id="l1.5484">         hour: hour,</span>
<a href="#l1.5485"></a><span id="l1.5485">         minute: minute,</span>
<a href="#l1.5486"></a><span id="l1.5486">         second: second,</span>
<a href="#l1.5487"></a><span id="l1.5487">         zone: timezone</span>
<a href="#l1.5488"></a><span id="l1.5488">       });</span>
<a href="#l1.5489"></a><span id="l1.5489">     },</span>
<a href="#l1.5490"></a><span id="l1.5490"> </span>
<a href="#l1.5491"></a><span id="l1.5491" class="difflineminus">-    fromString: function icaltime_fromString(str) {</span>
<a href="#l1.5492"></a><span id="l1.5492" class="difflineminus">-      var data;</span>
<a href="#l1.5493"></a><span id="l1.5493" class="difflineminus">-      try {</span>
<a href="#l1.5494"></a><span id="l1.5494" class="difflineminus">-        data = ICAL.DecorationParser.parseValue(str, &quot;date&quot;);</span>
<a href="#l1.5495"></a><span id="l1.5495" class="difflineminus">-        data.isDate = true;</span>
<a href="#l1.5496"></a><span id="l1.5496" class="difflineminus">-      } catch (e) {</span>
<a href="#l1.5497"></a><span id="l1.5497" class="difflineminus">-        data = ICAL.DecorationParser.parseValue(str, &quot;date-time&quot;);</span>
<a href="#l1.5498"></a><span id="l1.5498" class="difflineminus">-        data.isDate = false;</span>
<a href="#l1.5499"></a><span id="l1.5499" class="difflineminus">-      }</span>
<a href="#l1.5500"></a><span id="l1.5500" class="difflineminus">-      return this.fromData(data);</span>
<a href="#l1.5501"></a><span id="l1.5501" class="difflineminus">-    },</span>
<a href="#l1.5502"></a><span id="l1.5502" class="difflineminus">-</span>
<a href="#l1.5503"></a><span id="l1.5503" class="difflineplus">+    /**</span>
<a href="#l1.5504"></a><span id="l1.5504" class="difflineplus">+     * Set up the current instance from the Javascript date value.</span>
<a href="#l1.5505"></a><span id="l1.5505" class="difflineplus">+     *</span>
<a href="#l1.5506"></a><span id="l1.5506" class="difflineplus">+     * @param {?Date} aDate     The Javascript Date to read, or null to reset</span>
<a href="#l1.5507"></a><span id="l1.5507" class="difflineplus">+     * @param {Boolean} useUTC  If true, the UTC values of the date will be used</span>
<a href="#l1.5508"></a><span id="l1.5508" class="difflineplus">+     */</span>
<a href="#l1.5509"></a><span id="l1.5509">     fromJSDate: function icaltime_fromJSDate(aDate, useUTC) {</span>
<a href="#l1.5510"></a><span id="l1.5510">       if (!aDate) {</span>
<a href="#l1.5511"></a><span id="l1.5511">         this.reset();</span>
<a href="#l1.5512"></a><span id="l1.5512">       } else {</span>
<a href="#l1.5513"></a><span id="l1.5513">         if (useUTC) {</span>
<a href="#l1.5514"></a><span id="l1.5514">           this.zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l1.5515"></a><span id="l1.5515">           this.year = aDate.getUTCFullYear();</span>
<a href="#l1.5516"></a><span id="l1.5516">           this.month = aDate.getUTCMonth() + 1;</span>
<a href="#l1.5517"></a><span id="l1.5517" class="difflineat">@@ -3372,24 +4841,44 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5518"></a><span id="l1.5518">           this.year = aDate.getFullYear();</span>
<a href="#l1.5519"></a><span id="l1.5519">           this.month = aDate.getMonth() + 1;</span>
<a href="#l1.5520"></a><span id="l1.5520">           this.day = aDate.getDate();</span>
<a href="#l1.5521"></a><span id="l1.5521">           this.hour = aDate.getHours();</span>
<a href="#l1.5522"></a><span id="l1.5522">           this.minute = aDate.getMinutes();</span>
<a href="#l1.5523"></a><span id="l1.5523">           this.second = aDate.getSeconds();</span>
<a href="#l1.5524"></a><span id="l1.5524">         }</span>
<a href="#l1.5525"></a><span id="l1.5525">       }</span>
<a href="#l1.5526"></a><span id="l1.5526" class="difflineplus">+      this._cachedUnixTime = null;</span>
<a href="#l1.5527"></a><span id="l1.5527">       return this;</span>
<a href="#l1.5528"></a><span id="l1.5528">     },</span>
<a href="#l1.5529"></a><span id="l1.5529"> </span>
<a href="#l1.5530"></a><span id="l1.5530" class="difflineplus">+    /**</span>
<a href="#l1.5531"></a><span id="l1.5531" class="difflineplus">+     * Sets up the current instance using members from the passed data object.</span>
<a href="#l1.5532"></a><span id="l1.5532" class="difflineplus">+     *</span>
<a href="#l1.5533"></a><span id="l1.5533" class="difflineplus">+     * @param {Object} aData            Time initialization</span>
<a href="#l1.5534"></a><span id="l1.5534" class="difflineplus">+     * @param {Number=} aData.year      The year for this date</span>
<a href="#l1.5535"></a><span id="l1.5535" class="difflineplus">+     * @param {Number=} aData.month     The month for this date</span>
<a href="#l1.5536"></a><span id="l1.5536" class="difflineplus">+     * @param {Number=} aData.day       The day for this date</span>
<a href="#l1.5537"></a><span id="l1.5537" class="difflineplus">+     * @param {Number=} aData.hour      The hour for this date</span>
<a href="#l1.5538"></a><span id="l1.5538" class="difflineplus">+     * @param {Number=} aData.minute    The minute for this date</span>
<a href="#l1.5539"></a><span id="l1.5539" class="difflineplus">+     * @param {Number=} aData.second    The second for this date</span>
<a href="#l1.5540"></a><span id="l1.5540" class="difflineplus">+     * @param {Boolean=} aData.isDate   If true, the instance represents a date</span>
<a href="#l1.5541"></a><span id="l1.5541" class="difflineplus">+     *                                    (as opposed to a date-time)</span>
<a href="#l1.5542"></a><span id="l1.5542" class="difflineplus">+     * @param {ICAL.Timezone=} aZone    Timezone this position occurs in</span>
<a href="#l1.5543"></a><span id="l1.5543" class="difflineplus">+     */</span>
<a href="#l1.5544"></a><span id="l1.5544">     fromData: function fromData(aData, aZone) {</span>
<a href="#l1.5545"></a><span id="l1.5545" class="difflineminus">-      for (var key in aData) {</span>
<a href="#l1.5546"></a><span id="l1.5546" class="difflineminus">-        // ical type cannot be set</span>
<a href="#l1.5547"></a><span id="l1.5547" class="difflineminus">-        if (key === 'icaltype') continue;</span>
<a href="#l1.5548"></a><span id="l1.5548" class="difflineminus">-        this[key] = aData[key];</span>
<a href="#l1.5549"></a><span id="l1.5549" class="difflineplus">+      if (aData) {</span>
<a href="#l1.5550"></a><span id="l1.5550" class="difflineplus">+        for (var key in aData) {</span>
<a href="#l1.5551"></a><span id="l1.5551" class="difflineplus">+          /* istanbul ignore else */</span>
<a href="#l1.5552"></a><span id="l1.5552" class="difflineplus">+          if (Object.prototype.hasOwnProperty.call(aData, key)) {</span>
<a href="#l1.5553"></a><span id="l1.5553" class="difflineplus">+            // ical type cannot be set</span>
<a href="#l1.5554"></a><span id="l1.5554" class="difflineplus">+            if (key === 'icaltype') continue;</span>
<a href="#l1.5555"></a><span id="l1.5555" class="difflineplus">+            this[key] = aData[key];</span>
<a href="#l1.5556"></a><span id="l1.5556" class="difflineplus">+          }</span>
<a href="#l1.5557"></a><span id="l1.5557" class="difflineplus">+        }</span>
<a href="#l1.5558"></a><span id="l1.5558">       }</span>
<a href="#l1.5559"></a><span id="l1.5559"> </span>
<a href="#l1.5560"></a><span id="l1.5560">       if (aZone) {</span>
<a href="#l1.5561"></a><span id="l1.5561">         this.zone = aZone;</span>
<a href="#l1.5562"></a><span id="l1.5562">       }</span>
<a href="#l1.5563"></a><span id="l1.5563"> </span>
<a href="#l1.5564"></a><span id="l1.5564">       if (aData &amp;&amp; !(&quot;isDate&quot; in aData)) {</span>
<a href="#l1.5565"></a><span id="l1.5565">         this.isDate = !(&quot;hour&quot; in aData);</span>
<a href="#l1.5566"></a><span id="l1.5566" class="difflineat">@@ -3408,118 +4897,208 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5567"></a><span id="l1.5567">       if (aData &amp;&amp; &quot;zone&quot; in aData) {</span>
<a href="#l1.5568"></a><span id="l1.5568">         this.zone = aData.zone;</span>
<a href="#l1.5569"></a><span id="l1.5569">       }</span>
<a href="#l1.5570"></a><span id="l1.5570"> </span>
<a href="#l1.5571"></a><span id="l1.5571">       if (!this.zone) {</span>
<a href="#l1.5572"></a><span id="l1.5572">         this.zone = ICAL.Timezone.localTimezone;</span>
<a href="#l1.5573"></a><span id="l1.5573">       }</span>
<a href="#l1.5574"></a><span id="l1.5574"> </span>
<a href="#l1.5575"></a><span id="l1.5575" class="difflineplus">+      this._cachedUnixTime = null;</span>
<a href="#l1.5576"></a><span id="l1.5576">       return this;</span>
<a href="#l1.5577"></a><span id="l1.5577">     },</span>
<a href="#l1.5578"></a><span id="l1.5578"> </span>
<a href="#l1.5579"></a><span id="l1.5579" class="difflineplus">+    /**</span>
<a href="#l1.5580"></a><span id="l1.5580" class="difflineplus">+     * Calculate the day of week.</span>
<a href="#l1.5581"></a><span id="l1.5581" class="difflineplus">+     * @return {ICAL.Time.weekDay}</span>
<a href="#l1.5582"></a><span id="l1.5582" class="difflineplus">+     */</span>
<a href="#l1.5583"></a><span id="l1.5583">     dayOfWeek: function icaltime_dayOfWeek() {</span>
<a href="#l1.5584"></a><span id="l1.5584" class="difflineplus">+      var dowCacheKey = (this.year &lt;&lt; 9) + (this.month &lt;&lt; 5) + this.day;</span>
<a href="#l1.5585"></a><span id="l1.5585" class="difflineplus">+      if (dowCacheKey in ICAL.Time._dowCache) {</span>
<a href="#l1.5586"></a><span id="l1.5586" class="difflineplus">+        return ICAL.Time._dowCache[dowCacheKey];</span>
<a href="#l1.5587"></a><span id="l1.5587" class="difflineplus">+      }</span>
<a href="#l1.5588"></a><span id="l1.5588" class="difflineplus">+</span>
<a href="#l1.5589"></a><span id="l1.5589">       // Using Zeller's algorithm</span>
<a href="#l1.5590"></a><span id="l1.5590">       var q = this.day;</span>
<a href="#l1.5591"></a><span id="l1.5591">       var m = this.month + (this.month &lt; 3 ? 12 : 0);</span>
<a href="#l1.5592"></a><span id="l1.5592">       var Y = this.year - (this.month &lt; 3 ? 1 : 0);</span>
<a href="#l1.5593"></a><span id="l1.5593"> </span>
<a href="#l1.5594"></a><span id="l1.5594">       var h = (q + Y + ICAL.helpers.trunc(((m + 1) * 26) / 10) + ICAL.helpers.trunc(Y / 4));</span>
<a href="#l1.5595"></a><span id="l1.5595" class="difflineplus">+      /* istanbul ignore else */</span>
<a href="#l1.5596"></a><span id="l1.5596">       if (true /* gregorian */) {</span>
<a href="#l1.5597"></a><span id="l1.5597">         h += ICAL.helpers.trunc(Y / 100) * 6 + ICAL.helpers.trunc(Y / 400);</span>
<a href="#l1.5598"></a><span id="l1.5598">       } else {</span>
<a href="#l1.5599"></a><span id="l1.5599">         h += 5;</span>
<a href="#l1.5600"></a><span id="l1.5600">       }</span>
<a href="#l1.5601"></a><span id="l1.5601"> </span>
<a href="#l1.5602"></a><span id="l1.5602">       // Normalize to 1 = sunday</span>
<a href="#l1.5603"></a><span id="l1.5603">       h = ((h + 6) % 7) + 1;</span>
<a href="#l1.5604"></a><span id="l1.5604" class="difflineplus">+      ICAL.Time._dowCache[dowCacheKey] = h;</span>
<a href="#l1.5605"></a><span id="l1.5605">       return h;</span>
<a href="#l1.5606"></a><span id="l1.5606">     },</span>
<a href="#l1.5607"></a><span id="l1.5607"> </span>
<a href="#l1.5608"></a><span id="l1.5608" class="difflineminus">-    dayOfYear: function icaltime_dayOfYear() {</span>
<a href="#l1.5609"></a><span id="l1.5609" class="difflineminus">-      var is_leap = (ICAL.Time.is_leap_year(this.year) ? 1 : 0);</span>
<a href="#l1.5610"></a><span id="l1.5610" class="difflineminus">-      var diypm = ICAL.Time._days_in_year_passed_month;</span>
<a href="#l1.5611"></a><span id="l1.5611" class="difflineplus">+    /**</span>
<a href="#l1.5612"></a><span id="l1.5612" class="difflineplus">+     * Calculate the day of year.</span>
<a href="#l1.5613"></a><span id="l1.5613" class="difflineplus">+     * @return {Number}</span>
<a href="#l1.5614"></a><span id="l1.5614" class="difflineplus">+     */</span>
<a href="#l1.5615"></a><span id="l1.5615" class="difflineplus">+    dayOfYear: function dayOfYear() {</span>
<a href="#l1.5616"></a><span id="l1.5616" class="difflineplus">+      var is_leap = (ICAL.Time.isLeapYear(this.year) ? 1 : 0);</span>
<a href="#l1.5617"></a><span id="l1.5617" class="difflineplus">+      var diypm = ICAL.Time.daysInYearPassedMonth;</span>
<a href="#l1.5618"></a><span id="l1.5618">       return diypm[is_leap][this.month - 1] + this.day;</span>
<a href="#l1.5619"></a><span id="l1.5619">     },</span>
<a href="#l1.5620"></a><span id="l1.5620"> </span>
<a href="#l1.5621"></a><span id="l1.5621" class="difflineminus">-    startOfWeek: function startOfWeek() {</span>
<a href="#l1.5622"></a><span id="l1.5622" class="difflineplus">+    /**</span>
<a href="#l1.5623"></a><span id="l1.5623" class="difflineplus">+     * Returns a copy of the current date/time, rewound to the start of the</span>
<a href="#l1.5624"></a><span id="l1.5624" class="difflineplus">+     * week. The resulting ICAL.Time instance is of icaltype date, even if this</span>
<a href="#l1.5625"></a><span id="l1.5625" class="difflineplus">+     * is a date-time.</span>
<a href="#l1.5626"></a><span id="l1.5626" class="difflineplus">+     *</span>
<a href="#l1.5627"></a><span id="l1.5627" class="difflineplus">+     * @param {ICAL.Time.weekDay=} aWeekStart</span>
<a href="#l1.5628"></a><span id="l1.5628" class="difflineplus">+     *        The week start weekday, defaults to SUNDAY</span>
<a href="#l1.5629"></a><span id="l1.5629" class="difflineplus">+     * @return {ICAL.Time}      The start of the week (cloned)</span>
<a href="#l1.5630"></a><span id="l1.5630" class="difflineplus">+     */</span>
<a href="#l1.5631"></a><span id="l1.5631" class="difflineplus">+    startOfWeek: function startOfWeek(aWeekStart) {</span>
<a href="#l1.5632"></a><span id="l1.5632" class="difflineplus">+      var firstDow = aWeekStart || ICAL.Time.SUNDAY;</span>
<a href="#l1.5633"></a><span id="l1.5633">       var result = this.clone();</span>
<a href="#l1.5634"></a><span id="l1.5634" class="difflineminus">-      result.day -= this.dayOfWeek() - 1;</span>
<a href="#l1.5635"></a><span id="l1.5635" class="difflineplus">+      result.day -= ((this.dayOfWeek() + 7 - firstDow) % 7);</span>
<a href="#l1.5636"></a><span id="l1.5636" class="difflineplus">+      result.isDate = true;</span>
<a href="#l1.5637"></a><span id="l1.5637" class="difflineplus">+      result.hour = 0;</span>
<a href="#l1.5638"></a><span id="l1.5638" class="difflineplus">+      result.minute = 0;</span>
<a href="#l1.5639"></a><span id="l1.5639" class="difflineplus">+      result.second = 0;</span>
<a href="#l1.5640"></a><span id="l1.5640">       return result;</span>
<a href="#l1.5641"></a><span id="l1.5641">     },</span>
<a href="#l1.5642"></a><span id="l1.5642"> </span>
<a href="#l1.5643"></a><span id="l1.5643" class="difflineminus">-    endOfWeek: function endOfWeek() {</span>
<a href="#l1.5644"></a><span id="l1.5644" class="difflineplus">+    /**</span>
<a href="#l1.5645"></a><span id="l1.5645" class="difflineplus">+     * Returns a copy of the current date/time, shifted to the end of the week.</span>
<a href="#l1.5646"></a><span id="l1.5646" class="difflineplus">+     * The resulting ICAL.Time instance is of icaltype date, even if this is a</span>
<a href="#l1.5647"></a><span id="l1.5647" class="difflineplus">+     * date-time.</span>
<a href="#l1.5648"></a><span id="l1.5648" class="difflineplus">+     *</span>
<a href="#l1.5649"></a><span id="l1.5649" class="difflineplus">+     * @param {ICAL.Time.weekDay=} aWeekStart</span>
<a href="#l1.5650"></a><span id="l1.5650" class="difflineplus">+     *        The week start weekday, defaults to SUNDAY</span>
<a href="#l1.5651"></a><span id="l1.5651" class="difflineplus">+     * @return {ICAL.Time}      The end of the week (cloned)</span>
<a href="#l1.5652"></a><span id="l1.5652" class="difflineplus">+     */</span>
<a href="#l1.5653"></a><span id="l1.5653" class="difflineplus">+    endOfWeek: function endOfWeek(aWeekStart) {</span>
<a href="#l1.5654"></a><span id="l1.5654" class="difflineplus">+      var firstDow = aWeekStart || ICAL.Time.SUNDAY;</span>
<a href="#l1.5655"></a><span id="l1.5655">       var result = this.clone();</span>
<a href="#l1.5656"></a><span id="l1.5656" class="difflineminus">-      result.day += 7 - this.dayOfWeek();</span>
<a href="#l1.5657"></a><span id="l1.5657" class="difflineplus">+      result.day += (7 - this.dayOfWeek() + firstDow - ICAL.Time.SUNDAY) % 7;</span>
<a href="#l1.5658"></a><span id="l1.5658" class="difflineplus">+      result.isDate = true;</span>
<a href="#l1.5659"></a><span id="l1.5659" class="difflineplus">+      result.hour = 0;</span>
<a href="#l1.5660"></a><span id="l1.5660" class="difflineplus">+      result.minute = 0;</span>
<a href="#l1.5661"></a><span id="l1.5661" class="difflineplus">+      result.second = 0;</span>
<a href="#l1.5662"></a><span id="l1.5662">       return result;</span>
<a href="#l1.5663"></a><span id="l1.5663">     },</span>
<a href="#l1.5664"></a><span id="l1.5664"> </span>
<a href="#l1.5665"></a><span id="l1.5665" class="difflineplus">+    /**</span>
<a href="#l1.5666"></a><span id="l1.5666" class="difflineplus">+     * Returns a copy of the current date/time, rewound to the start of the</span>
<a href="#l1.5667"></a><span id="l1.5667" class="difflineplus">+     * month. The resulting ICAL.Time instance is of icaltype date, even if</span>
<a href="#l1.5668"></a><span id="l1.5668" class="difflineplus">+     * this is a date-time.</span>
<a href="#l1.5669"></a><span id="l1.5669" class="difflineplus">+     *</span>
<a href="#l1.5670"></a><span id="l1.5670" class="difflineplus">+     * @return {ICAL.Time}      The start of the month (cloned)</span>
<a href="#l1.5671"></a><span id="l1.5671" class="difflineplus">+     */</span>
<a href="#l1.5672"></a><span id="l1.5672">     startOfMonth: function startOfMonth() {</span>
<a href="#l1.5673"></a><span id="l1.5673">       var result = this.clone();</span>
<a href="#l1.5674"></a><span id="l1.5674">       result.day = 1;</span>
<a href="#l1.5675"></a><span id="l1.5675">       result.isDate = true;</span>
<a href="#l1.5676"></a><span id="l1.5676">       result.hour = 0;</span>
<a href="#l1.5677"></a><span id="l1.5677">       result.minute = 0;</span>
<a href="#l1.5678"></a><span id="l1.5678">       result.second = 0;</span>
<a href="#l1.5679"></a><span id="l1.5679">       return result;</span>
<a href="#l1.5680"></a><span id="l1.5680">     },</span>
<a href="#l1.5681"></a><span id="l1.5681"> </span>
<a href="#l1.5682"></a><span id="l1.5682" class="difflineplus">+    /**</span>
<a href="#l1.5683"></a><span id="l1.5683" class="difflineplus">+     * Returns a copy of the current date/time, shifted to the end of the</span>
<a href="#l1.5684"></a><span id="l1.5684" class="difflineplus">+     * month.  The resulting ICAL.Time instance is of icaltype date, even if</span>
<a href="#l1.5685"></a><span id="l1.5685" class="difflineplus">+     * this is a date-time.</span>
<a href="#l1.5686"></a><span id="l1.5686" class="difflineplus">+     *</span>
<a href="#l1.5687"></a><span id="l1.5687" class="difflineplus">+     * @return {ICAL.Time}      The end of the month (cloned)</span>
<a href="#l1.5688"></a><span id="l1.5688" class="difflineplus">+     */</span>
<a href="#l1.5689"></a><span id="l1.5689">     endOfMonth: function endOfMonth() {</span>
<a href="#l1.5690"></a><span id="l1.5690">       var result = this.clone();</span>
<a href="#l1.5691"></a><span id="l1.5691">       result.day = ICAL.Time.daysInMonth(result.month, result.year);</span>
<a href="#l1.5692"></a><span id="l1.5692">       result.isDate = true;</span>
<a href="#l1.5693"></a><span id="l1.5693">       result.hour = 0;</span>
<a href="#l1.5694"></a><span id="l1.5694">       result.minute = 0;</span>
<a href="#l1.5695"></a><span id="l1.5695">       result.second = 0;</span>
<a href="#l1.5696"></a><span id="l1.5696">       return result;</span>
<a href="#l1.5697"></a><span id="l1.5697">     },</span>
<a href="#l1.5698"></a><span id="l1.5698"> </span>
<a href="#l1.5699"></a><span id="l1.5699" class="difflineplus">+    /**</span>
<a href="#l1.5700"></a><span id="l1.5700" class="difflineplus">+     * Returns a copy of the current date/time, rewound to the start of the</span>
<a href="#l1.5701"></a><span id="l1.5701" class="difflineplus">+     * year. The resulting ICAL.Time instance is of icaltype date, even if</span>
<a href="#l1.5702"></a><span id="l1.5702" class="difflineplus">+     * this is a date-time.</span>
<a href="#l1.5703"></a><span id="l1.5703" class="difflineplus">+     *</span>
<a href="#l1.5704"></a><span id="l1.5704" class="difflineplus">+     * @return {ICAL.Time}      The start of the year (cloned)</span>
<a href="#l1.5705"></a><span id="l1.5705" class="difflineplus">+     */</span>
<a href="#l1.5706"></a><span id="l1.5706">     startOfYear: function startOfYear() {</span>
<a href="#l1.5707"></a><span id="l1.5707">       var result = this.clone();</span>
<a href="#l1.5708"></a><span id="l1.5708">       result.day = 1;</span>
<a href="#l1.5709"></a><span id="l1.5709">       result.month = 1;</span>
<a href="#l1.5710"></a><span id="l1.5710">       result.isDate = true;</span>
<a href="#l1.5711"></a><span id="l1.5711">       result.hour = 0;</span>
<a href="#l1.5712"></a><span id="l1.5712">       result.minute = 0;</span>
<a href="#l1.5713"></a><span id="l1.5713">       result.second = 0;</span>
<a href="#l1.5714"></a><span id="l1.5714">       return result;</span>
<a href="#l1.5715"></a><span id="l1.5715">     },</span>
<a href="#l1.5716"></a><span id="l1.5716"> </span>
<a href="#l1.5717"></a><span id="l1.5717" class="difflineplus">+    /**</span>
<a href="#l1.5718"></a><span id="l1.5718" class="difflineplus">+     * Returns a copy of the current date/time, shifted to the end of the</span>
<a href="#l1.5719"></a><span id="l1.5719" class="difflineplus">+     * year.  The resulting ICAL.Time instance is of icaltype date, even if</span>
<a href="#l1.5720"></a><span id="l1.5720" class="difflineplus">+     * this is a date-time.</span>
<a href="#l1.5721"></a><span id="l1.5721" class="difflineplus">+     *</span>
<a href="#l1.5722"></a><span id="l1.5722" class="difflineplus">+     * @return {ICAL.Time}      The end of the year (cloned)</span>
<a href="#l1.5723"></a><span id="l1.5723" class="difflineplus">+     */</span>
<a href="#l1.5724"></a><span id="l1.5724">     endOfYear: function endOfYear() {</span>
<a href="#l1.5725"></a><span id="l1.5725">       var result = this.clone();</span>
<a href="#l1.5726"></a><span id="l1.5726">       result.day = 31;</span>
<a href="#l1.5727"></a><span id="l1.5727">       result.month = 12;</span>
<a href="#l1.5728"></a><span id="l1.5728">       result.isDate = true;</span>
<a href="#l1.5729"></a><span id="l1.5729">       result.hour = 0;</span>
<a href="#l1.5730"></a><span id="l1.5730">       result.minute = 0;</span>
<a href="#l1.5731"></a><span id="l1.5731">       result.second = 0;</span>
<a href="#l1.5732"></a><span id="l1.5732">       return result;</span>
<a href="#l1.5733"></a><span id="l1.5733">     },</span>
<a href="#l1.5734"></a><span id="l1.5734"> </span>
<a href="#l1.5735"></a><span id="l1.5735" class="difflineplus">+    /**</span>
<a href="#l1.5736"></a><span id="l1.5736" class="difflineplus">+     * First calculates the start of the week, then returns the day of year for</span>
<a href="#l1.5737"></a><span id="l1.5737" class="difflineplus">+     * this date. If the day falls into the previous year, the day is zero or negative.</span>
<a href="#l1.5738"></a><span id="l1.5738" class="difflineplus">+     *</span>
<a href="#l1.5739"></a><span id="l1.5739" class="difflineplus">+     * @param {ICAL.Time.weekDay=} aFirstDayOfWeek</span>
<a href="#l1.5740"></a><span id="l1.5740" class="difflineplus">+     *        The week start weekday, defaults to SUNDAY</span>
<a href="#l1.5741"></a><span id="l1.5741" class="difflineplus">+     * @return {Number}     The calculated day of year</span>
<a href="#l1.5742"></a><span id="l1.5742" class="difflineplus">+     */</span>
<a href="#l1.5743"></a><span id="l1.5743">     startDoyWeek: function startDoyWeek(aFirstDayOfWeek) {</span>
<a href="#l1.5744"></a><span id="l1.5744">       var firstDow = aFirstDayOfWeek || ICAL.Time.SUNDAY;</span>
<a href="#l1.5745"></a><span id="l1.5745">       var delta = this.dayOfWeek() - firstDow;</span>
<a href="#l1.5746"></a><span id="l1.5746">       if (delta &lt; 0) delta += 7;</span>
<a href="#l1.5747"></a><span id="l1.5747">       return this.dayOfYear() - delta;</span>
<a href="#l1.5748"></a><span id="l1.5748">     },</span>
<a href="#l1.5749"></a><span id="l1.5749"> </span>
<a href="#l1.5750"></a><span id="l1.5750">     /**</span>
<a href="#l1.5751"></a><span id="l1.5751" class="difflineminus">-     * Finds the nthWeekDay relative to the current month (not day).</span>
<a href="#l1.5752"></a><span id="l1.5752" class="difflineminus">-     * The returned value is a day relative the month that this</span>
<a href="#l1.5753"></a><span id="l1.5753" class="difflineminus">-     * month belongs to so 1 would indicate the first of the month</span>
<a href="#l1.5754"></a><span id="l1.5754" class="difflineminus">-     * and 40 would indicate a day in the following month.</span>
<a href="#l1.5755"></a><span id="l1.5755" class="difflineminus">-     *</span>
<a href="#l1.5756"></a><span id="l1.5756" class="difflineminus">-     * @param {Numeric} aDayOfWeek day of the week see the day name constants.</span>
<a href="#l1.5757"></a><span id="l1.5757" class="difflineminus">-     * @param {Numeric} aPos nth occurrence of a given week day</span>
<a href="#l1.5758"></a><span id="l1.5758" class="difflineminus">-     *                       values of 1 and 0 both indicate the first</span>
<a href="#l1.5759"></a><span id="l1.5759" class="difflineminus">-     *                       weekday of that type. aPos may be either positive</span>
<a href="#l1.5760"></a><span id="l1.5760" class="difflineminus">-     *                       or negative.</span>
<a href="#l1.5761"></a><span id="l1.5761" class="difflineminus">-     *</span>
<a href="#l1.5762"></a><span id="l1.5762" class="difflineminus">-     * @return {Numeric} numeric value indicating a day relative</span>
<a href="#l1.5763"></a><span id="l1.5763" class="difflineminus">-     *                   to the current month of this time object.</span>
<a href="#l1.5764"></a><span id="l1.5764" class="difflineplus">+     * Get the dominical letter for the current year. Letters range from A - G</span>
<a href="#l1.5765"></a><span id="l1.5765" class="difflineplus">+     * for common years, and AG to GF for leap years.</span>
<a href="#l1.5766"></a><span id="l1.5766" class="difflineplus">+     *</span>
<a href="#l1.5767"></a><span id="l1.5767" class="difflineplus">+     * @param {Number} yr           The year to retrieve the letter for</span>
<a href="#l1.5768"></a><span id="l1.5768" class="difflineplus">+     * @return {String}             The dominical letter.</span>
<a href="#l1.5769"></a><span id="l1.5769" class="difflineplus">+     */</span>
<a href="#l1.5770"></a><span id="l1.5770" class="difflineplus">+    getDominicalLetter: function() {</span>
<a href="#l1.5771"></a><span id="l1.5771" class="difflineplus">+      return ICAL.Time.getDominicalLetter(this.year);</span>
<a href="#l1.5772"></a><span id="l1.5772" class="difflineplus">+    },</span>
<a href="#l1.5773"></a><span id="l1.5773" class="difflineplus">+</span>
<a href="#l1.5774"></a><span id="l1.5774" class="difflineplus">+    /**</span>
<a href="#l1.5775"></a><span id="l1.5775" class="difflineplus">+     * Finds the nthWeekDay relative to the current month (not day).  The</span>
<a href="#l1.5776"></a><span id="l1.5776" class="difflineplus">+     * returned value is a day relative the month that this month belongs to so</span>
<a href="#l1.5777"></a><span id="l1.5777" class="difflineplus">+     * 1 would indicate the first of the month and 40 would indicate a day in</span>
<a href="#l1.5778"></a><span id="l1.5778" class="difflineplus">+     * the following month.</span>
<a href="#l1.5779"></a><span id="l1.5779" class="difflineplus">+     *</span>
<a href="#l1.5780"></a><span id="l1.5780" class="difflineplus">+     * @param {Number} aDayOfWeek   Day of the week see the day name constants</span>
<a href="#l1.5781"></a><span id="l1.5781" class="difflineplus">+     * @param {Number} aPos         Nth occurrence of a given week day values</span>
<a href="#l1.5782"></a><span id="l1.5782" class="difflineplus">+     *        of 1 and 0 both indicate the first weekday of that type. aPos may</span>
<a href="#l1.5783"></a><span id="l1.5783" class="difflineplus">+     *        be either positive or negative</span>
<a href="#l1.5784"></a><span id="l1.5784" class="difflineplus">+     *</span>
<a href="#l1.5785"></a><span id="l1.5785" class="difflineplus">+     * @return {Number} numeric value indicating a day relative</span>
<a href="#l1.5786"></a><span id="l1.5786" class="difflineplus">+     *                   to the current month of this time object</span>
<a href="#l1.5787"></a><span id="l1.5787">      */</span>
<a href="#l1.5788"></a><span id="l1.5788">     nthWeekDay: function icaltime_nthWeekDay(aDayOfWeek, aPos) {</span>
<a href="#l1.5789"></a><span id="l1.5789">       var daysInMonth = ICAL.Time.daysInMonth(this.month, this.year);</span>
<a href="#l1.5790"></a><span id="l1.5790">       var weekday;</span>
<a href="#l1.5791"></a><span id="l1.5791">       var pos = aPos;</span>
<a href="#l1.5792"></a><span id="l1.5792"> </span>
<a href="#l1.5793"></a><span id="l1.5793">       var start = 0;</span>
<a href="#l1.5794"></a><span id="l1.5794"> </span>
<a href="#l1.5795"></a><span id="l1.5795" class="difflineat">@@ -3585,25 +5164,23 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5796"></a><span id="l1.5796">       }</span>
<a href="#l1.5797"></a><span id="l1.5797"> </span>
<a href="#l1.5798"></a><span id="l1.5798">       weekday += pos * 7;</span>
<a href="#l1.5799"></a><span id="l1.5799"> </span>
<a href="#l1.5800"></a><span id="l1.5800">       return start + weekday;</span>
<a href="#l1.5801"></a><span id="l1.5801">     },</span>
<a href="#l1.5802"></a><span id="l1.5802"> </span>
<a href="#l1.5803"></a><span id="l1.5803">     /**</span>
<a href="#l1.5804"></a><span id="l1.5804" class="difflineminus">-     * Checks if current time is the nthWeekDay.</span>
<a href="#l1.5805"></a><span id="l1.5805" class="difflineminus">-     * Relative to the current month.</span>
<a href="#l1.5806"></a><span id="l1.5806" class="difflineminus">-     *</span>
<a href="#l1.5807"></a><span id="l1.5807" class="difflineminus">-     * Will always return false when rule resolves</span>
<a href="#l1.5808"></a><span id="l1.5808" class="difflineminus">-     * outside of current month.</span>
<a href="#l1.5809"></a><span id="l1.5809" class="difflineminus">-     *</span>
<a href="#l1.5810"></a><span id="l1.5810" class="difflineminus">-     * @param {Numeric} aDayOfWeek day of week.</span>
<a href="#l1.5811"></a><span id="l1.5811" class="difflineminus">-     * @param {Numeric} aPos position.</span>
<a href="#l1.5812"></a><span id="l1.5812" class="difflineminus">-     * @param {Numeric} aMax maximum valid day.</span>
<a href="#l1.5813"></a><span id="l1.5813" class="difflineplus">+     * Checks if current time is the nth weekday, relative to the current</span>
<a href="#l1.5814"></a><span id="l1.5814" class="difflineplus">+     * month.  Will always return false when rule resolves outside of current</span>
<a href="#l1.5815"></a><span id="l1.5815" class="difflineplus">+     * month.</span>
<a href="#l1.5816"></a><span id="l1.5816" class="difflineplus">+     *</span>
<a href="#l1.5817"></a><span id="l1.5817" class="difflineplus">+     * @param {ICAL.Time.weekDay} aDayOfWeek       Day of week to check</span>
<a href="#l1.5818"></a><span id="l1.5818" class="difflineplus">+     * @param {Number} aPos                        Relative position</span>
<a href="#l1.5819"></a><span id="l1.5819" class="difflineplus">+     * @return {Boolean}                           True, if its the nth weekday</span>
<a href="#l1.5820"></a><span id="l1.5820">      */</span>
<a href="#l1.5821"></a><span id="l1.5821">     isNthWeekDay: function(aDayOfWeek, aPos) {</span>
<a href="#l1.5822"></a><span id="l1.5822">       var dow = this.dayOfWeek();</span>
<a href="#l1.5823"></a><span id="l1.5823"> </span>
<a href="#l1.5824"></a><span id="l1.5824">       if (aPos === 0 &amp;&amp; dow === aDayOfWeek) {</span>
<a href="#l1.5825"></a><span id="l1.5825">         return true;</span>
<a href="#l1.5826"></a><span id="l1.5826">       }</span>
<a href="#l1.5827"></a><span id="l1.5827"> </span>
<a href="#l1.5828"></a><span id="l1.5828" class="difflineat">@@ -3612,47 +5189,70 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5829"></a><span id="l1.5829"> </span>
<a href="#l1.5830"></a><span id="l1.5830">       if (day === this.day) {</span>
<a href="#l1.5831"></a><span id="l1.5831">         return true;</span>
<a href="#l1.5832"></a><span id="l1.5832">       }</span>
<a href="#l1.5833"></a><span id="l1.5833"> </span>
<a href="#l1.5834"></a><span id="l1.5834">       return false;</span>
<a href="#l1.5835"></a><span id="l1.5835">     },</span>
<a href="#l1.5836"></a><span id="l1.5836"> </span>
<a href="#l1.5837"></a><span id="l1.5837" class="difflineplus">+    /**</span>
<a href="#l1.5838"></a><span id="l1.5838" class="difflineplus">+     * Calculates the ISO 8601 week number. The first week of a year is the</span>
<a href="#l1.5839"></a><span id="l1.5839" class="difflineplus">+     * week that contains the first Thursday. The year can have 53 weeks, if</span>
<a href="#l1.5840"></a><span id="l1.5840" class="difflineplus">+     * January 1st is a Friday.</span>
<a href="#l1.5841"></a><span id="l1.5841" class="difflineplus">+     *</span>
<a href="#l1.5842"></a><span id="l1.5842" class="difflineplus">+     * Note there are regions where the first week of the year is the one that</span>
<a href="#l1.5843"></a><span id="l1.5843" class="difflineplus">+     * starts on January 1st, which may offset the week number. Also, if a</span>
<a href="#l1.5844"></a><span id="l1.5844" class="difflineplus">+     * different week start is specified, this will also affect the week</span>
<a href="#l1.5845"></a><span id="l1.5845" class="difflineplus">+     * number.</span>
<a href="#l1.5846"></a><span id="l1.5846" class="difflineplus">+     *</span>
<a href="#l1.5847"></a><span id="l1.5847" class="difflineplus">+     * @see ICAL.Time.weekOneStarts</span>
<a href="#l1.5848"></a><span id="l1.5848" class="difflineplus">+     * @param {ICAL.Time.weekDay} aWeekStart        The weekday the week starts with</span>
<a href="#l1.5849"></a><span id="l1.5849" class="difflineplus">+     * @return {Number}                             The ISO week number</span>
<a href="#l1.5850"></a><span id="l1.5850" class="difflineplus">+     */</span>
<a href="#l1.5851"></a><span id="l1.5851">     weekNumber: function weekNumber(aWeekStart) {</span>
<a href="#l1.5852"></a><span id="l1.5852" class="difflineplus">+      var wnCacheKey = (this.year &lt;&lt; 12) + (this.month &lt;&lt; 8) + (this.day &lt;&lt; 3) + aWeekStart;</span>
<a href="#l1.5853"></a><span id="l1.5853" class="difflineplus">+      if (wnCacheKey in ICAL.Time._wnCache) {</span>
<a href="#l1.5854"></a><span id="l1.5854" class="difflineplus">+        return ICAL.Time._wnCache[wnCacheKey];</span>
<a href="#l1.5855"></a><span id="l1.5855" class="difflineplus">+      }</span>
<a href="#l1.5856"></a><span id="l1.5856">       // This function courtesty of Julian Bucknall, published under the MIT license</span>
<a href="#l1.5857"></a><span id="l1.5857">       // http://www.boyet.com/articles/publishedarticles/calculatingtheisoweeknumb.html</span>
<a href="#l1.5858"></a><span id="l1.5858" class="difflineminus">-      var doy = this.dayOfYear();</span>
<a href="#l1.5859"></a><span id="l1.5859" class="difflineminus">-      var dow = this.dayOfWeek();</span>
<a href="#l1.5860"></a><span id="l1.5860" class="difflineminus">-      var year = this.year;</span>
<a href="#l1.5861"></a><span id="l1.5861" class="difflineplus">+      // plus some fixes to be able to use different week starts.</span>
<a href="#l1.5862"></a><span id="l1.5862">       var week1;</span>
<a href="#l1.5863"></a><span id="l1.5863"> </span>
<a href="#l1.5864"></a><span id="l1.5864">       var dt = this.clone();</span>
<a href="#l1.5865"></a><span id="l1.5865">       dt.isDate = true;</span>
<a href="#l1.5866"></a><span id="l1.5866" class="difflineminus">-      var first_dow = dt.dayOfWeek();</span>
<a href="#l1.5867"></a><span id="l1.5867">       var isoyear = this.year;</span>
<a href="#l1.5868"></a><span id="l1.5868"> </span>
<a href="#l1.5869"></a><span id="l1.5869" class="difflineminus">-      if (dt.month == 12 &amp;&amp; dt.day &gt; 28) {</span>
<a href="#l1.5870"></a><span id="l1.5870" class="difflineplus">+      if (dt.month == 12 &amp;&amp; dt.day &gt; 25) {</span>
<a href="#l1.5871"></a><span id="l1.5871">         week1 = ICAL.Time.weekOneStarts(isoyear + 1, aWeekStart);</span>
<a href="#l1.5872"></a><span id="l1.5872">         if (dt.compare(week1) &lt; 0) {</span>
<a href="#l1.5873"></a><span id="l1.5873">           week1 = ICAL.Time.weekOneStarts(isoyear, aWeekStart);</span>
<a href="#l1.5874"></a><span id="l1.5874">         } else {</span>
<a href="#l1.5875"></a><span id="l1.5875">           isoyear++;</span>
<a href="#l1.5876"></a><span id="l1.5876">         }</span>
<a href="#l1.5877"></a><span id="l1.5877">       } else {</span>
<a href="#l1.5878"></a><span id="l1.5878">         week1 = ICAL.Time.weekOneStarts(isoyear, aWeekStart);</span>
<a href="#l1.5879"></a><span id="l1.5879">         if (dt.compare(week1) &lt; 0) {</span>
<a href="#l1.5880"></a><span id="l1.5880">           week1 = ICAL.Time.weekOneStarts(--isoyear, aWeekStart);</span>
<a href="#l1.5881"></a><span id="l1.5881">         }</span>
<a href="#l1.5882"></a><span id="l1.5882">       }</span>
<a href="#l1.5883"></a><span id="l1.5883"> </span>
<a href="#l1.5884"></a><span id="l1.5884">       var daysBetween = (dt.subtractDate(week1).toSeconds() / 86400);</span>
<a href="#l1.5885"></a><span id="l1.5885" class="difflineminus">-      return ICAL.helpers.trunc(daysBetween / 7) + 1;</span>
<a href="#l1.5886"></a><span id="l1.5886" class="difflineminus">-    },</span>
<a href="#l1.5887"></a><span id="l1.5887" class="difflineminus">-</span>
<a href="#l1.5888"></a><span id="l1.5888" class="difflineplus">+      var answer = ICAL.helpers.trunc(daysBetween / 7) + 1;</span>
<a href="#l1.5889"></a><span id="l1.5889" class="difflineplus">+      ICAL.Time._wnCache[wnCacheKey] = answer;</span>
<a href="#l1.5890"></a><span id="l1.5890" class="difflineplus">+      return answer;</span>
<a href="#l1.5891"></a><span id="l1.5891" class="difflineplus">+    },</span>
<a href="#l1.5892"></a><span id="l1.5892" class="difflineplus">+</span>
<a href="#l1.5893"></a><span id="l1.5893" class="difflineplus">+    /**</span>
<a href="#l1.5894"></a><span id="l1.5894" class="difflineplus">+     * Adds the duration to the current time. The instance is modified in</span>
<a href="#l1.5895"></a><span id="l1.5895" class="difflineplus">+     * place.</span>
<a href="#l1.5896"></a><span id="l1.5896" class="difflineplus">+     *</span>
<a href="#l1.5897"></a><span id="l1.5897" class="difflineplus">+     * @param {ICAL.Duration} aDuration         The duration to add</span>
<a href="#l1.5898"></a><span id="l1.5898" class="difflineplus">+     */</span>
<a href="#l1.5899"></a><span id="l1.5899">     addDuration: function icaltime_add(aDuration) {</span>
<a href="#l1.5900"></a><span id="l1.5900">       var mult = (aDuration.isNegative ? -1 : 1);</span>
<a href="#l1.5901"></a><span id="l1.5901"> </span>
<a href="#l1.5902"></a><span id="l1.5902">       // because of the duration optimizations it is much</span>
<a href="#l1.5903"></a><span id="l1.5903">       // more efficient to grab all the values up front</span>
<a href="#l1.5904"></a><span id="l1.5904">       // then set them directly (which will avoid a normalization call).</span>
<a href="#l1.5905"></a><span id="l1.5905">       // So we don't actually normalize until we need it.</span>
<a href="#l1.5906"></a><span id="l1.5906">       var second = this.second;</span>
<a href="#l1.5907"></a><span id="l1.5907" class="difflineat">@@ -3665,103 +5265,137 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.5908"></a><span id="l1.5908">       hour += mult * aDuration.hours;</span>
<a href="#l1.5909"></a><span id="l1.5909">       day += mult * aDuration.days;</span>
<a href="#l1.5910"></a><span id="l1.5910">       day += mult * 7 * aDuration.weeks;</span>
<a href="#l1.5911"></a><span id="l1.5911"> </span>
<a href="#l1.5912"></a><span id="l1.5912">       this.second = second;</span>
<a href="#l1.5913"></a><span id="l1.5913">       this.minute = minute;</span>
<a href="#l1.5914"></a><span id="l1.5914">       this.hour = hour;</span>
<a href="#l1.5915"></a><span id="l1.5915">       this.day = day;</span>
<a href="#l1.5916"></a><span id="l1.5916" class="difflineminus">-    },</span>
<a href="#l1.5917"></a><span id="l1.5917" class="difflineminus">-</span>
<a href="#l1.5918"></a><span id="l1.5918" class="difflineminus">-    /**</span>
<a href="#l1.5919"></a><span id="l1.5919" class="difflineminus">-     * Subtract the date details (_excluding_ timezone).</span>
<a href="#l1.5920"></a><span id="l1.5920" class="difflineminus">-     * Useful for finding the relative difference between</span>
<a href="#l1.5921"></a><span id="l1.5921" class="difflineminus">-     * two time objects excluding their timezone differences.</span>
<a href="#l1.5922"></a><span id="l1.5922" class="difflineminus">-     *</span>
<a href="#l1.5923"></a><span id="l1.5923" class="difflineminus">-     * @return {ICAL.Duration} difference in duration.</span>
<a href="#l1.5924"></a><span id="l1.5924" class="difflineplus">+</span>
<a href="#l1.5925"></a><span id="l1.5925" class="difflineplus">+      this._cachedUnixTime = null;</span>
<a href="#l1.5926"></a><span id="l1.5926" class="difflineplus">+    },</span>
<a href="#l1.5927"></a><span id="l1.5927" class="difflineplus">+</span>
<a href="#l1.5928"></a><span id="l1.5928" class="difflineplus">+    /**</span>
<a href="#l1.5929"></a><span id="l1.5929" class="difflineplus">+     * Subtract the date details (_excluding_ timezone).  Useful for finding</span>
<a href="#l1.5930"></a><span id="l1.5930" class="difflineplus">+     * the relative difference between two time objects excluding their</span>
<a href="#l1.5931"></a><span id="l1.5931" class="difflineplus">+     * timezone differences.</span>
<a href="#l1.5932"></a><span id="l1.5932" class="difflineplus">+     *</span>
<a href="#l1.5933"></a><span id="l1.5933" class="difflineplus">+     * @param {ICAL.Time} aDate     The date to substract</span>
<a href="#l1.5934"></a><span id="l1.5934" class="difflineplus">+     * @return {ICAL.Duration}      The difference as a duration</span>
<a href="#l1.5935"></a><span id="l1.5935">      */</span>
<a href="#l1.5936"></a><span id="l1.5936">     subtractDate: function icaltime_subtract(aDate) {</span>
<a href="#l1.5937"></a><span id="l1.5937">       var unixTime = this.toUnixTime() + this.utcOffset();</span>
<a href="#l1.5938"></a><span id="l1.5938">       var other = aDate.toUnixTime() + aDate.utcOffset();</span>
<a href="#l1.5939"></a><span id="l1.5939">       return ICAL.Duration.fromSeconds(unixTime - other);</span>
<a href="#l1.5940"></a><span id="l1.5940">     },</span>
<a href="#l1.5941"></a><span id="l1.5941"> </span>
<a href="#l1.5942"></a><span id="l1.5942">     /**</span>
<a href="#l1.5943"></a><span id="l1.5943">      * Subtract the date details, taking timezones into account.</span>
<a href="#l1.5944"></a><span id="l1.5944">      *</span>
<a href="#l1.5945"></a><span id="l1.5945" class="difflineminus">-     * @param {ICAL.Time}  The date to subtract.</span>
<a href="#l1.5946"></a><span id="l1.5946" class="difflineminus">-     * @return {ICAL.Duration}  The difference in duration.</span>
<a href="#l1.5947"></a><span id="l1.5947" class="difflineplus">+     * @param {ICAL.Time} aDate  The date to subtract</span>
<a href="#l1.5948"></a><span id="l1.5948" class="difflineplus">+     * @return {ICAL.Duration}  The difference in duration</span>
<a href="#l1.5949"></a><span id="l1.5949">      */</span>
<a href="#l1.5950"></a><span id="l1.5950">     subtractDateTz: function icaltime_subtract_abs(aDate) {</span>
<a href="#l1.5951"></a><span id="l1.5951">       var unixTime = this.toUnixTime();</span>
<a href="#l1.5952"></a><span id="l1.5952">       var other = aDate.toUnixTime();</span>
<a href="#l1.5953"></a><span id="l1.5953">       return ICAL.Duration.fromSeconds(unixTime - other);</span>
<a href="#l1.5954"></a><span id="l1.5954">     },</span>
<a href="#l1.5955"></a><span id="l1.5955"> </span>
<a href="#l1.5956"></a><span id="l1.5956" class="difflineplus">+    /**</span>
<a href="#l1.5957"></a><span id="l1.5957" class="difflineplus">+     * Compares the ICAL.Time instance with another one.</span>
<a href="#l1.5958"></a><span id="l1.5958" class="difflineplus">+     *</span>
<a href="#l1.5959"></a><span id="l1.5959" class="difflineplus">+     * @param {ICAL.Duration} aOther        The instance to compare with</span>
<a href="#l1.5960"></a><span id="l1.5960" class="difflineplus">+     * @return {Number}                     -1, 0 or 1 for less/equal/greater</span>
<a href="#l1.5961"></a><span id="l1.5961" class="difflineplus">+     */</span>
<a href="#l1.5962"></a><span id="l1.5962">     compare: function icaltime_compare(other) {</span>
<a href="#l1.5963"></a><span id="l1.5963">       var a = this.toUnixTime();</span>
<a href="#l1.5964"></a><span id="l1.5964">       var b = other.toUnixTime();</span>
<a href="#l1.5965"></a><span id="l1.5965"> </span>
<a href="#l1.5966"></a><span id="l1.5966">       if (a &gt; b) return 1;</span>
<a href="#l1.5967"></a><span id="l1.5967">       if (b &gt; a) return -1;</span>
<a href="#l1.5968"></a><span id="l1.5968">       return 0;</span>
<a href="#l1.5969"></a><span id="l1.5969">     },</span>
<a href="#l1.5970"></a><span id="l1.5970"> </span>
<a href="#l1.5971"></a><span id="l1.5971" class="difflineplus">+    /**</span>
<a href="#l1.5972"></a><span id="l1.5972" class="difflineplus">+     * Compares only the date part of this instance with another one.</span>
<a href="#l1.5973"></a><span id="l1.5973" class="difflineplus">+     *</span>
<a href="#l1.5974"></a><span id="l1.5974" class="difflineplus">+     * @param {ICAL.Duration} other         The instance to compare with</span>
<a href="#l1.5975"></a><span id="l1.5975" class="difflineplus">+     * @param {ICAL.Timezone} tz            The timezone to compare in</span>
<a href="#l1.5976"></a><span id="l1.5976" class="difflineplus">+     * @return {Number}                     -1, 0 or 1 for less/equal/greater</span>
<a href="#l1.5977"></a><span id="l1.5977" class="difflineplus">+     */</span>
<a href="#l1.5978"></a><span id="l1.5978">     compareDateOnlyTz: function icaltime_compareDateOnlyTz(other, tz) {</span>
<a href="#l1.5979"></a><span id="l1.5979">       function cmp(attr) {</span>
<a href="#l1.5980"></a><span id="l1.5980">         return ICAL.Time._cmp_attr(a, b, attr);</span>
<a href="#l1.5981"></a><span id="l1.5981">       }</span>
<a href="#l1.5982"></a><span id="l1.5982">       var a = this.convertToZone(tz);</span>
<a href="#l1.5983"></a><span id="l1.5983">       var b = other.convertToZone(tz);</span>
<a href="#l1.5984"></a><span id="l1.5984">       var rc = 0;</span>
<a href="#l1.5985"></a><span id="l1.5985"> </span>
<a href="#l1.5986"></a><span id="l1.5986">       if ((rc = cmp(&quot;year&quot;)) != 0) return rc;</span>
<a href="#l1.5987"></a><span id="l1.5987">       if ((rc = cmp(&quot;month&quot;)) != 0) return rc;</span>
<a href="#l1.5988"></a><span id="l1.5988">       if ((rc = cmp(&quot;day&quot;)) != 0) return rc;</span>
<a href="#l1.5989"></a><span id="l1.5989"> </span>
<a href="#l1.5990"></a><span id="l1.5990">       return rc;</span>
<a href="#l1.5991"></a><span id="l1.5991">     },</span>
<a href="#l1.5992"></a><span id="l1.5992"> </span>
<a href="#l1.5993"></a><span id="l1.5993" class="difflineplus">+    /**</span>
<a href="#l1.5994"></a><span id="l1.5994" class="difflineplus">+     * Convert the instance into another timzone. The returned ICAL.Time</span>
<a href="#l1.5995"></a><span id="l1.5995" class="difflineplus">+     * instance is always a copy.</span>
<a href="#l1.5996"></a><span id="l1.5996" class="difflineplus">+     *</span>
<a href="#l1.5997"></a><span id="l1.5997" class="difflineplus">+     * @param {ICAL.Timezone} zone      The zone to convert to</span>
<a href="#l1.5998"></a><span id="l1.5998" class="difflineplus">+     * @return {ICAL.Time}              The copy, converted to the zone</span>
<a href="#l1.5999"></a><span id="l1.5999" class="difflineplus">+     */</span>
<a href="#l1.6000"></a><span id="l1.6000">     convertToZone: function convertToZone(zone) {</span>
<a href="#l1.6001"></a><span id="l1.6001">       var copy = this.clone();</span>
<a href="#l1.6002"></a><span id="l1.6002">       var zone_equals = (this.zone.tzid == zone.tzid);</span>
<a href="#l1.6003"></a><span id="l1.6003"> </span>
<a href="#l1.6004"></a><span id="l1.6004">       if (!this.isDate &amp;&amp; !zone_equals) {</span>
<a href="#l1.6005"></a><span id="l1.6005">         ICAL.Timezone.convert_time(copy, this.zone, zone);</span>
<a href="#l1.6006"></a><span id="l1.6006">       }</span>
<a href="#l1.6007"></a><span id="l1.6007"> </span>
<a href="#l1.6008"></a><span id="l1.6008">       copy.zone = zone;</span>
<a href="#l1.6009"></a><span id="l1.6009">       return copy;</span>
<a href="#l1.6010"></a><span id="l1.6010">     },</span>
<a href="#l1.6011"></a><span id="l1.6011"> </span>
<a href="#l1.6012"></a><span id="l1.6012" class="difflineplus">+    /**</span>
<a href="#l1.6013"></a><span id="l1.6013" class="difflineplus">+     * Calculates the UTC offset of the current date/time in the timezone it is</span>
<a href="#l1.6014"></a><span id="l1.6014" class="difflineplus">+     * in.</span>
<a href="#l1.6015"></a><span id="l1.6015" class="difflineplus">+     *</span>
<a href="#l1.6016"></a><span id="l1.6016" class="difflineplus">+     * @return {Number}     UTC offset in seconds</span>
<a href="#l1.6017"></a><span id="l1.6017" class="difflineplus">+     */</span>
<a href="#l1.6018"></a><span id="l1.6018">     utcOffset: function utc_offset() {</span>
<a href="#l1.6019"></a><span id="l1.6019">       if (this.zone == ICAL.Timezone.localTimezone ||</span>
<a href="#l1.6020"></a><span id="l1.6020">           this.zone == ICAL.Timezone.utcTimezone) {</span>
<a href="#l1.6021"></a><span id="l1.6021">         return 0;</span>
<a href="#l1.6022"></a><span id="l1.6022">       } else {</span>
<a href="#l1.6023"></a><span id="l1.6023">         return this.zone.utcOffset(this);</span>
<a href="#l1.6024"></a><span id="l1.6024">       }</span>
<a href="#l1.6025"></a><span id="l1.6025">     },</span>
<a href="#l1.6026"></a><span id="l1.6026"> </span>
<a href="#l1.6027"></a><span id="l1.6027">     /**</span>
<a href="#l1.6028"></a><span id="l1.6028" class="difflineminus">-     * Returns an RFC 5455 compliant ical representation of this object.</span>
<a href="#l1.6029"></a><span id="l1.6029" class="difflineminus">-     *</span>
<a href="#l1.6030"></a><span id="l1.6030" class="difflineminus">-     * @return {String} ical date/date-time.</span>
<a href="#l1.6031"></a><span id="l1.6031" class="difflineplus">+     * Returns an RFC 5545 compliant ical representation of this object.</span>
<a href="#l1.6032"></a><span id="l1.6032" class="difflineplus">+     *</span>
<a href="#l1.6033"></a><span id="l1.6033" class="difflineplus">+     * @return {String} ical date/date-time</span>
<a href="#l1.6034"></a><span id="l1.6034">      */</span>
<a href="#l1.6035"></a><span id="l1.6035">     toICALString: function() {</span>
<a href="#l1.6036"></a><span id="l1.6036">       var string = this.toString();</span>
<a href="#l1.6037"></a><span id="l1.6037"> </span>
<a href="#l1.6038"></a><span id="l1.6038">       if (string.length &gt; 10) {</span>
<a href="#l1.6039"></a><span id="l1.6039" class="difflineminus">-        return ICAL.design.value['date-time'].toICAL(string);</span>
<a href="#l1.6040"></a><span id="l1.6040" class="difflineplus">+        return ICAL.design.icalendar.value['date-time'].toICAL(string);</span>
<a href="#l1.6041"></a><span id="l1.6041">       } else {</span>
<a href="#l1.6042"></a><span id="l1.6042" class="difflineminus">-        return ICAL.design.value.date.toICAL(string);</span>
<a href="#l1.6043"></a><span id="l1.6043" class="difflineminus">-      }</span>
<a href="#l1.6044"></a><span id="l1.6044" class="difflineminus">-    },</span>
<a href="#l1.6045"></a><span id="l1.6045" class="difflineminus">-</span>
<a href="#l1.6046"></a><span id="l1.6046" class="difflineplus">+        return ICAL.design.icalendar.value.date.toICAL(string);</span>
<a href="#l1.6047"></a><span id="l1.6047" class="difflineplus">+      }</span>
<a href="#l1.6048"></a><span id="l1.6048" class="difflineplus">+    },</span>
<a href="#l1.6049"></a><span id="l1.6049" class="difflineplus">+</span>
<a href="#l1.6050"></a><span id="l1.6050" class="difflineplus">+    /**</span>
<a href="#l1.6051"></a><span id="l1.6051" class="difflineplus">+     * The string representation of this date/time, in jCal form</span>
<a href="#l1.6052"></a><span id="l1.6052" class="difflineplus">+     * (including : and - separators).</span>
<a href="#l1.6053"></a><span id="l1.6053" class="difflineplus">+     * @return {String}</span>
<a href="#l1.6054"></a><span id="l1.6054" class="difflineplus">+     */</span>
<a href="#l1.6055"></a><span id="l1.6055">     toString: function toString() {</span>
<a href="#l1.6056"></a><span id="l1.6056">       var result = this.year + '-' +</span>
<a href="#l1.6057"></a><span id="l1.6057">                    ICAL.helpers.pad2(this.month) + '-' +</span>
<a href="#l1.6058"></a><span id="l1.6058">                    ICAL.helpers.pad2(this.day);</span>
<a href="#l1.6059"></a><span id="l1.6059"> </span>
<a href="#l1.6060"></a><span id="l1.6060">       if (!this.isDate) {</span>
<a href="#l1.6061"></a><span id="l1.6061">           result += 'T' + ICAL.helpers.pad2(this.hour) + ':' +</span>
<a href="#l1.6062"></a><span id="l1.6062">                     ICAL.helpers.pad2(this.minute) + ':' +</span>
<a href="#l1.6063"></a><span id="l1.6063" class="difflineat">@@ -3770,16 +5404,20 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6064"></a><span id="l1.6064">         if (this.zone === ICAL.Timezone.utcTimezone) {</span>
<a href="#l1.6065"></a><span id="l1.6065">           result += 'Z';</span>
<a href="#l1.6066"></a><span id="l1.6066">         }</span>
<a href="#l1.6067"></a><span id="l1.6067">       }</span>
<a href="#l1.6068"></a><span id="l1.6068"> </span>
<a href="#l1.6069"></a><span id="l1.6069">       return result;</span>
<a href="#l1.6070"></a><span id="l1.6070">     },</span>
<a href="#l1.6071"></a><span id="l1.6071"> </span>
<a href="#l1.6072"></a><span id="l1.6072" class="difflineplus">+    /**</span>
<a href="#l1.6073"></a><span id="l1.6073" class="difflineplus">+     * Converts the current instance to a Javascript date</span>
<a href="#l1.6074"></a><span id="l1.6074" class="difflineplus">+     * @return {Date}</span>
<a href="#l1.6075"></a><span id="l1.6075" class="difflineplus">+     */</span>
<a href="#l1.6076"></a><span id="l1.6076">     toJSDate: function toJSDate() {</span>
<a href="#l1.6077"></a><span id="l1.6077">       if (this.zone == ICAL.Timezone.localTimezone) {</span>
<a href="#l1.6078"></a><span id="l1.6078">         if (this.isDate) {</span>
<a href="#l1.6079"></a><span id="l1.6079">           return new Date(this.year, this.month - 1, this.day);</span>
<a href="#l1.6080"></a><span id="l1.6080">         } else {</span>
<a href="#l1.6081"></a><span id="l1.6081">           return new Date(this.year, this.month - 1, this.day,</span>
<a href="#l1.6082"></a><span id="l1.6082">                           this.hour, this.minute, this.second, 0);</span>
<a href="#l1.6083"></a><span id="l1.6083">         }</span>
<a href="#l1.6084"></a><span id="l1.6084" class="difflineat">@@ -3795,16 +5433,26 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6085"></a><span id="l1.6085">         this._time.minute = 0;</span>
<a href="#l1.6086"></a><span id="l1.6086">         this._time.second = 0;</span>
<a href="#l1.6087"></a><span id="l1.6087">       }</span>
<a href="#l1.6088"></a><span id="l1.6088">       this.adjust(0, 0, 0, 0);</span>
<a href="#l1.6089"></a><span id="l1.6089"> </span>
<a href="#l1.6090"></a><span id="l1.6090">       return this;</span>
<a href="#l1.6091"></a><span id="l1.6091">     },</span>
<a href="#l1.6092"></a><span id="l1.6092"> </span>
<a href="#l1.6093"></a><span id="l1.6093" class="difflineplus">+    /**</span>
<a href="#l1.6094"></a><span id="l1.6094" class="difflineplus">+     * Adjust the date/time by the given offset</span>
<a href="#l1.6095"></a><span id="l1.6095" class="difflineplus">+     *</span>
<a href="#l1.6096"></a><span id="l1.6096" class="difflineplus">+     * @param {Number} aExtraDays       The extra amount of days</span>
<a href="#l1.6097"></a><span id="l1.6097" class="difflineplus">+     * @param {Number} aExtraHours      The extra amount of hours</span>
<a href="#l1.6098"></a><span id="l1.6098" class="difflineplus">+     * @param {Number} aExtraMinutes    The extra amount of minutes</span>
<a href="#l1.6099"></a><span id="l1.6099" class="difflineplus">+     * @param {Number} aExtraSeconds    The extra amount of seconds</span>
<a href="#l1.6100"></a><span id="l1.6100" class="difflineplus">+     * @param {Number=} aTime           The time to adjust, defaults to the</span>
<a href="#l1.6101"></a><span id="l1.6101" class="difflineplus">+     *                                    current instance.</span>
<a href="#l1.6102"></a><span id="l1.6102" class="difflineplus">+     */</span>
<a href="#l1.6103"></a><span id="l1.6103">     adjust: function icaltime_adjust(aExtraDays, aExtraHours,</span>
<a href="#l1.6104"></a><span id="l1.6104">                                      aExtraMinutes, aExtraSeconds, aTime) {</span>
<a href="#l1.6105"></a><span id="l1.6105"> </span>
<a href="#l1.6106"></a><span id="l1.6106">       var minutesOverflow, hoursOverflow,</span>
<a href="#l1.6107"></a><span id="l1.6107">           daysOverflow = 0, yearsOverflow = 0;</span>
<a href="#l1.6108"></a><span id="l1.6108"> </span>
<a href="#l1.6109"></a><span id="l1.6109">       var second, minute, hour, day;</span>
<a href="#l1.6110"></a><span id="l1.6110">       var daysInMonth;</span>
<a href="#l1.6111"></a><span id="l1.6111" class="difflineat">@@ -3850,17 +5498,17 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6112"></a><span id="l1.6112">       time.year += yearsOverflow;</span>
<a href="#l1.6113"></a><span id="l1.6113">       time.month -= 12 * yearsOverflow;</span>
<a href="#l1.6114"></a><span id="l1.6114"> </span>
<a href="#l1.6115"></a><span id="l1.6115">       // Now take care of the days (and adjust month if needed)</span>
<a href="#l1.6116"></a><span id="l1.6116">       day = time.day + aExtraDays + daysOverflow;</span>
<a href="#l1.6117"></a><span id="l1.6117"> </span>
<a href="#l1.6118"></a><span id="l1.6118">       if (day &gt; 0) {</span>
<a href="#l1.6119"></a><span id="l1.6119">         for (;;) {</span>
<a href="#l1.6120"></a><span id="l1.6120" class="difflineminus">-          var daysInMonth = ICAL.Time.daysInMonth(time.month, time.year);</span>
<a href="#l1.6121"></a><span id="l1.6121" class="difflineplus">+          daysInMonth = ICAL.Time.daysInMonth(time.month, time.year);</span>
<a href="#l1.6122"></a><span id="l1.6122">           if (day &lt;= daysInMonth) {</span>
<a href="#l1.6123"></a><span id="l1.6123">             break;</span>
<a href="#l1.6124"></a><span id="l1.6124">           }</span>
<a href="#l1.6125"></a><span id="l1.6125"> </span>
<a href="#l1.6126"></a><span id="l1.6126">           time.month++;</span>
<a href="#l1.6127"></a><span id="l1.6127">           if (time.month &gt; 12) {</span>
<a href="#l1.6128"></a><span id="l1.6128">             time.year++;</span>
<a href="#l1.6129"></a><span id="l1.6129">             time.month = 1;</span>
<a href="#l1.6130"></a><span id="l1.6130" class="difflineat">@@ -3877,64 +5525,82 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6131"></a><span id="l1.6131">             time.month--;</span>
<a href="#l1.6132"></a><span id="l1.6132">           }</span>
<a href="#l1.6133"></a><span id="l1.6133"> </span>
<a href="#l1.6134"></a><span id="l1.6134">           day += ICAL.Time.daysInMonth(time.month, time.year);</span>
<a href="#l1.6135"></a><span id="l1.6135">         }</span>
<a href="#l1.6136"></a><span id="l1.6136">       }</span>
<a href="#l1.6137"></a><span id="l1.6137"> </span>
<a href="#l1.6138"></a><span id="l1.6138">       time.day = day;</span>
<a href="#l1.6139"></a><span id="l1.6139" class="difflineplus">+</span>
<a href="#l1.6140"></a><span id="l1.6140" class="difflineplus">+      this._cachedUnixTime = null;</span>
<a href="#l1.6141"></a><span id="l1.6141">       return this;</span>
<a href="#l1.6142"></a><span id="l1.6142">     },</span>
<a href="#l1.6143"></a><span id="l1.6143"> </span>
<a href="#l1.6144"></a><span id="l1.6144" class="difflineplus">+    /**</span>
<a href="#l1.6145"></a><span id="l1.6145" class="difflineplus">+     * Sets up the current instance from unix time, the number of seconds since</span>
<a href="#l1.6146"></a><span id="l1.6146" class="difflineplus">+     * January 1st, 1970.</span>
<a href="#l1.6147"></a><span id="l1.6147" class="difflineplus">+     *</span>
<a href="#l1.6148"></a><span id="l1.6148" class="difflineplus">+     * @param {Number} seconds      The seconds to set up with</span>
<a href="#l1.6149"></a><span id="l1.6149" class="difflineplus">+     */</span>
<a href="#l1.6150"></a><span id="l1.6150">     fromUnixTime: function fromUnixTime(seconds) {</span>
<a href="#l1.6151"></a><span id="l1.6151">       this.zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l1.6152"></a><span id="l1.6152">       var epoch = ICAL.Time.epochTime.clone();</span>
<a href="#l1.6153"></a><span id="l1.6153">       epoch.adjust(0, 0, 0, seconds);</span>
<a href="#l1.6154"></a><span id="l1.6154"> </span>
<a href="#l1.6155"></a><span id="l1.6155">       this.year = epoch.year;</span>
<a href="#l1.6156"></a><span id="l1.6156">       this.month = epoch.month;</span>
<a href="#l1.6157"></a><span id="l1.6157">       this.day = epoch.day;</span>
<a href="#l1.6158"></a><span id="l1.6158">       this.hour = epoch.hour;</span>
<a href="#l1.6159"></a><span id="l1.6159">       this.minute = epoch.minute;</span>
<a href="#l1.6160"></a><span id="l1.6160">       this.second = Math.floor(epoch.second);</span>
<a href="#l1.6161"></a><span id="l1.6161" class="difflineminus">-    },</span>
<a href="#l1.6162"></a><span id="l1.6162" class="difflineminus">-</span>
<a href="#l1.6163"></a><span id="l1.6163" class="difflineplus">+</span>
<a href="#l1.6164"></a><span id="l1.6164" class="difflineplus">+      this._cachedUnixTime = null;</span>
<a href="#l1.6165"></a><span id="l1.6165" class="difflineplus">+    },</span>
<a href="#l1.6166"></a><span id="l1.6166" class="difflineplus">+</span>
<a href="#l1.6167"></a><span id="l1.6167" class="difflineplus">+    /**</span>
<a href="#l1.6168"></a><span id="l1.6168" class="difflineplus">+     * Converts the current instance to seconds since January 1st 1970.</span>
<a href="#l1.6169"></a><span id="l1.6169" class="difflineplus">+     *</span>
<a href="#l1.6170"></a><span id="l1.6170" class="difflineplus">+     * @return {Number}         Seconds since 1970</span>
<a href="#l1.6171"></a><span id="l1.6171" class="difflineplus">+     */</span>
<a href="#l1.6172"></a><span id="l1.6172">     toUnixTime: function toUnixTime() {</span>
<a href="#l1.6173"></a><span id="l1.6173" class="difflineplus">+      if (this._cachedUnixTime !== null) {</span>
<a href="#l1.6174"></a><span id="l1.6174" class="difflineplus">+        return this._cachedUnixTime;</span>
<a href="#l1.6175"></a><span id="l1.6175" class="difflineplus">+      }</span>
<a href="#l1.6176"></a><span id="l1.6176">       var offset = this.utcOffset();</span>
<a href="#l1.6177"></a><span id="l1.6177"> </span>
<a href="#l1.6178"></a><span id="l1.6178">       // we use the offset trick to ensure</span>
<a href="#l1.6179"></a><span id="l1.6179">       // that we are getting the actual UTC time</span>
<a href="#l1.6180"></a><span id="l1.6180">       var ms = Date.UTC(</span>
<a href="#l1.6181"></a><span id="l1.6181">         this.year,</span>
<a href="#l1.6182"></a><span id="l1.6182">         this.month - 1,</span>
<a href="#l1.6183"></a><span id="l1.6183">         this.day,</span>
<a href="#l1.6184"></a><span id="l1.6184">         this.hour,</span>
<a href="#l1.6185"></a><span id="l1.6185">         this.minute,</span>
<a href="#l1.6186"></a><span id="l1.6186">         this.second - offset</span>
<a href="#l1.6187"></a><span id="l1.6187">       );</span>
<a href="#l1.6188"></a><span id="l1.6188"> </span>
<a href="#l1.6189"></a><span id="l1.6189">       // seconds</span>
<a href="#l1.6190"></a><span id="l1.6190" class="difflineminus">-      return ms / 1000;</span>
<a href="#l1.6191"></a><span id="l1.6191" class="difflineminus">-    },</span>
<a href="#l1.6192"></a><span id="l1.6192" class="difflineminus">-</span>
<a href="#l1.6193"></a><span id="l1.6193" class="difflineminus">-    /**</span>
<a href="#l1.6194"></a><span id="l1.6194" class="difflineminus">-     * Converts time to into Object</span>
<a href="#l1.6195"></a><span id="l1.6195" class="difflineminus">-     * which can be serialized then re-created</span>
<a href="#l1.6196"></a><span id="l1.6196" class="difflineplus">+      this._cachedUnixTime = ms / 1000;</span>
<a href="#l1.6197"></a><span id="l1.6197" class="difflineplus">+      return this._cachedUnixTime;</span>
<a href="#l1.6198"></a><span id="l1.6198" class="difflineplus">+    },</span>
<a href="#l1.6199"></a><span id="l1.6199" class="difflineplus">+</span>
<a href="#l1.6200"></a><span id="l1.6200" class="difflineplus">+    /**</span>
<a href="#l1.6201"></a><span id="l1.6201" class="difflineplus">+     * Converts time to into Object which can be serialized then re-created</span>
<a href="#l1.6202"></a><span id="l1.6202">      * using the constructor.</span>
<a href="#l1.6203"></a><span id="l1.6203">      *</span>
<a href="#l1.6204"></a><span id="l1.6204" class="difflineminus">-     * Example:</span>
<a href="#l1.6205"></a><span id="l1.6205" class="difflineminus">-     *</span>
<a href="#l1.6206"></a><span id="l1.6206" class="difflineminus">-     *    // toJSON will automatically be called</span>
<a href="#l1.6207"></a><span id="l1.6207" class="difflineminus">-     *    var json = JSON.stringify(mytime);</span>
<a href="#l1.6208"></a><span id="l1.6208" class="difflineminus">-     *</span>
<a href="#l1.6209"></a><span id="l1.6209" class="difflineminus">-     *    var deserialized = JSON.parse(json);</span>
<a href="#l1.6210"></a><span id="l1.6210" class="difflineminus">-     *</span>
<a href="#l1.6211"></a><span id="l1.6211" class="difflineminus">-     *    var time = new ICAL.Time(deserialized);</span>
<a href="#l1.6212"></a><span id="l1.6212" class="difflineminus">-     *</span>
<a href="#l1.6213"></a><span id="l1.6213" class="difflineplus">+     * @example</span>
<a href="#l1.6214"></a><span id="l1.6214" class="difflineplus">+     * // toJSON will automatically be called</span>
<a href="#l1.6215"></a><span id="l1.6215" class="difflineplus">+     * var json = JSON.stringify(mytime);</span>
<a href="#l1.6216"></a><span id="l1.6216" class="difflineplus">+     *</span>
<a href="#l1.6217"></a><span id="l1.6217" class="difflineplus">+     * var deserialized = JSON.parse(json);</span>
<a href="#l1.6218"></a><span id="l1.6218" class="difflineplus">+     *</span>
<a href="#l1.6219"></a><span id="l1.6219" class="difflineplus">+     * var time = new ICAL.Time(deserialized);</span>
<a href="#l1.6220"></a><span id="l1.6220" class="difflineplus">+     *</span>
<a href="#l1.6221"></a><span id="l1.6221" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.6222"></a><span id="l1.6222">      */</span>
<a href="#l1.6223"></a><span id="l1.6223">     toJSON: function() {</span>
<a href="#l1.6224"></a><span id="l1.6224">       var copy = [</span>
<a href="#l1.6225"></a><span id="l1.6225">         'year',</span>
<a href="#l1.6226"></a><span id="l1.6226">         'month',</span>
<a href="#l1.6227"></a><span id="l1.6227">         'day',</span>
<a href="#l1.6228"></a><span id="l1.6228">         'hour',</span>
<a href="#l1.6229"></a><span id="l1.6229">         'minute',</span>
<a href="#l1.6230"></a><span id="l1.6230" class="difflineat">@@ -3970,125 +5636,172 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6231"></a><span id="l1.6231">           if (this._pendingNormalization) {</span>
<a href="#l1.6232"></a><span id="l1.6232">             this._normalize();</span>
<a href="#l1.6233"></a><span id="l1.6233">             this._pendingNormalization = false;</span>
<a href="#l1.6234"></a><span id="l1.6234">           }</span>
<a href="#l1.6235"></a><span id="l1.6235"> </span>
<a href="#l1.6236"></a><span id="l1.6236">           return this._time[attr];</span>
<a href="#l1.6237"></a><span id="l1.6237">         },</span>
<a href="#l1.6238"></a><span id="l1.6238">         set: function setTimeAttr(val) {</span>
<a href="#l1.6239"></a><span id="l1.6239" class="difflineplus">+          this._cachedUnixTime = null;</span>
<a href="#l1.6240"></a><span id="l1.6240">           this._pendingNormalization = true;</span>
<a href="#l1.6241"></a><span id="l1.6241">           this._time[attr] = val;</span>
<a href="#l1.6242"></a><span id="l1.6242"> </span>
<a href="#l1.6243"></a><span id="l1.6243">           return val;</span>
<a href="#l1.6244"></a><span id="l1.6244">         }</span>
<a href="#l1.6245"></a><span id="l1.6245">       });</span>
<a href="#l1.6246"></a><span id="l1.6246"> </span>
<a href="#l1.6247"></a><span id="l1.6247">     }</span>
<a href="#l1.6248"></a><span id="l1.6248"> </span>
<a href="#l1.6249"></a><span id="l1.6249" class="difflineplus">+    /* istanbul ignore else */</span>
<a href="#l1.6250"></a><span id="l1.6250">     if (&quot;defineProperty&quot; in Object) {</span>
<a href="#l1.6251"></a><span id="l1.6251">       defineAttr(&quot;year&quot;);</span>
<a href="#l1.6252"></a><span id="l1.6252">       defineAttr(&quot;month&quot;);</span>
<a href="#l1.6253"></a><span id="l1.6253">       defineAttr(&quot;day&quot;);</span>
<a href="#l1.6254"></a><span id="l1.6254">       defineAttr(&quot;hour&quot;);</span>
<a href="#l1.6255"></a><span id="l1.6255">       defineAttr(&quot;minute&quot;);</span>
<a href="#l1.6256"></a><span id="l1.6256">       defineAttr(&quot;second&quot;);</span>
<a href="#l1.6257"></a><span id="l1.6257">       defineAttr(&quot;isDate&quot;);</span>
<a href="#l1.6258"></a><span id="l1.6258">     }</span>
<a href="#l1.6259"></a><span id="l1.6259">   })();</span>
<a href="#l1.6260"></a><span id="l1.6260"> </span>
<a href="#l1.6261"></a><span id="l1.6261" class="difflineplus">+  /**</span>
<a href="#l1.6262"></a><span id="l1.6262" class="difflineplus">+   * Returns the days in the given month</span>
<a href="#l1.6263"></a><span id="l1.6263" class="difflineplus">+   *</span>
<a href="#l1.6264"></a><span id="l1.6264" class="difflineplus">+   * @param {Number} month      The month to check</span>
<a href="#l1.6265"></a><span id="l1.6265" class="difflineplus">+   * @param {Number} year       The year to check</span>
<a href="#l1.6266"></a><span id="l1.6266" class="difflineplus">+   * @return {Number}           The number of days in the month</span>
<a href="#l1.6267"></a><span id="l1.6267" class="difflineplus">+   */</span>
<a href="#l1.6268"></a><span id="l1.6268">   ICAL.Time.daysInMonth = function icaltime_daysInMonth(month, year) {</span>
<a href="#l1.6269"></a><span id="l1.6269">     var _daysInMonth = [0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];</span>
<a href="#l1.6270"></a><span id="l1.6270">     var days = 30;</span>
<a href="#l1.6271"></a><span id="l1.6271"> </span>
<a href="#l1.6272"></a><span id="l1.6272">     if (month &lt; 1 || month &gt; 12) return days;</span>
<a href="#l1.6273"></a><span id="l1.6273"> </span>
<a href="#l1.6274"></a><span id="l1.6274">     days = _daysInMonth[month];</span>
<a href="#l1.6275"></a><span id="l1.6275"> </span>
<a href="#l1.6276"></a><span id="l1.6276">     if (month == 2) {</span>
<a href="#l1.6277"></a><span id="l1.6277" class="difflineminus">-      days += ICAL.Time.is_leap_year(year);</span>
<a href="#l1.6278"></a><span id="l1.6278" class="difflineplus">+      days += ICAL.Time.isLeapYear(year);</span>
<a href="#l1.6279"></a><span id="l1.6279">     }</span>
<a href="#l1.6280"></a><span id="l1.6280"> </span>
<a href="#l1.6281"></a><span id="l1.6281">     return days;</span>
<a href="#l1.6282"></a><span id="l1.6282">   };</span>
<a href="#l1.6283"></a><span id="l1.6283"> </span>
<a href="#l1.6284"></a><span id="l1.6284" class="difflineminus">-  ICAL.Time.is_leap_year = function icaltime_is_leap_year(year) {</span>
<a href="#l1.6285"></a><span id="l1.6285" class="difflineplus">+  /**</span>
<a href="#l1.6286"></a><span id="l1.6286" class="difflineplus">+   * Checks if the year is a leap year</span>
<a href="#l1.6287"></a><span id="l1.6287" class="difflineplus">+   *</span>
<a href="#l1.6288"></a><span id="l1.6288" class="difflineplus">+   * @param {Number} year       The year to check</span>
<a href="#l1.6289"></a><span id="l1.6289" class="difflineplus">+   * @return {Boolean}          True, if the year is a leap year</span>
<a href="#l1.6290"></a><span id="l1.6290" class="difflineplus">+   */</span>
<a href="#l1.6291"></a><span id="l1.6291" class="difflineplus">+  ICAL.Time.isLeapYear = function isLeapYear(year) {</span>
<a href="#l1.6292"></a><span id="l1.6292">     if (year &lt;= 1752) {</span>
<a href="#l1.6293"></a><span id="l1.6293">       return ((year % 4) == 0);</span>
<a href="#l1.6294"></a><span id="l1.6294">     } else {</span>
<a href="#l1.6295"></a><span id="l1.6295">       return (((year % 4 == 0) &amp;&amp; (year % 100 != 0)) || (year % 400 == 0));</span>
<a href="#l1.6296"></a><span id="l1.6296">     }</span>
<a href="#l1.6297"></a><span id="l1.6297">   };</span>
<a href="#l1.6298"></a><span id="l1.6298"> </span>
<a href="#l1.6299"></a><span id="l1.6299" class="difflineplus">+  /**</span>
<a href="#l1.6300"></a><span id="l1.6300" class="difflineplus">+   * Create a new ICAL.Time from the day of year and year. The date is returned</span>
<a href="#l1.6301"></a><span id="l1.6301" class="difflineplus">+   * in floating timezone.</span>
<a href="#l1.6302"></a><span id="l1.6302" class="difflineplus">+   *</span>
<a href="#l1.6303"></a><span id="l1.6303" class="difflineplus">+   * @param {Number} aDayOfYear     The day of year</span>
<a href="#l1.6304"></a><span id="l1.6304" class="difflineplus">+   * @param {Number} aYear          The year to create the instance in</span>
<a href="#l1.6305"></a><span id="l1.6305" class="difflineplus">+   * @return {ICAL.Time}            The created instance with the calculated date</span>
<a href="#l1.6306"></a><span id="l1.6306" class="difflineplus">+   */</span>
<a href="#l1.6307"></a><span id="l1.6307">   ICAL.Time.fromDayOfYear = function icaltime_fromDayOfYear(aDayOfYear, aYear) {</span>
<a href="#l1.6308"></a><span id="l1.6308">     var year = aYear;</span>
<a href="#l1.6309"></a><span id="l1.6309">     var doy = aDayOfYear;</span>
<a href="#l1.6310"></a><span id="l1.6310">     var tt = new ICAL.Time();</span>
<a href="#l1.6311"></a><span id="l1.6311">     tt.auto_normalize = false;</span>
<a href="#l1.6312"></a><span id="l1.6312" class="difflineminus">-    var is_leap = (ICAL.Time.is_leap_year(year) ? 1 : 0);</span>
<a href="#l1.6313"></a><span id="l1.6313" class="difflineplus">+    var is_leap = (ICAL.Time.isLeapYear(year) ? 1 : 0);</span>
<a href="#l1.6314"></a><span id="l1.6314"> </span>
<a href="#l1.6315"></a><span id="l1.6315">     if (doy &lt; 1) {</span>
<a href="#l1.6316"></a><span id="l1.6316">       year--;</span>
<a href="#l1.6317"></a><span id="l1.6317" class="difflineminus">-      is_leap = (ICAL.Time.is_leap_year(year) ? 1 : 0);</span>
<a href="#l1.6318"></a><span id="l1.6318" class="difflineminus">-      doy += ICAL.Time._days_in_year_passed_month[is_leap][12];</span>
<a href="#l1.6319"></a><span id="l1.6319" class="difflineminus">-    } else if (doy &gt; ICAL.Time._days_in_year_passed_month[is_leap][12]) {</span>
<a href="#l1.6320"></a><span id="l1.6320" class="difflineminus">-      is_leap = (ICAL.Time.is_leap_year(year) ? 1 : 0);</span>
<a href="#l1.6321"></a><span id="l1.6321" class="difflineminus">-      doy -= ICAL.Time._days_in_year_passed_month[is_leap][12];</span>
<a href="#l1.6322"></a><span id="l1.6322" class="difflineplus">+      is_leap = (ICAL.Time.isLeapYear(year) ? 1 : 0);</span>
<a href="#l1.6323"></a><span id="l1.6323" class="difflineplus">+      doy += ICAL.Time.daysInYearPassedMonth[is_leap][12];</span>
<a href="#l1.6324"></a><span id="l1.6324" class="difflineplus">+      return ICAL.Time.fromDayOfYear(doy, year);</span>
<a href="#l1.6325"></a><span id="l1.6325" class="difflineplus">+    } else if (doy &gt; ICAL.Time.daysInYearPassedMonth[is_leap][12]) {</span>
<a href="#l1.6326"></a><span id="l1.6326" class="difflineplus">+      is_leap = (ICAL.Time.isLeapYear(year) ? 1 : 0);</span>
<a href="#l1.6327"></a><span id="l1.6327" class="difflineplus">+      doy -= ICAL.Time.daysInYearPassedMonth[is_leap][12];</span>
<a href="#l1.6328"></a><span id="l1.6328">       year++;</span>
<a href="#l1.6329"></a><span id="l1.6329" class="difflineplus">+      return ICAL.Time.fromDayOfYear(doy, year);</span>
<a href="#l1.6330"></a><span id="l1.6330">     }</span>
<a href="#l1.6331"></a><span id="l1.6331"> </span>
<a href="#l1.6332"></a><span id="l1.6332">     tt.year = year;</span>
<a href="#l1.6333"></a><span id="l1.6333">     tt.isDate = true;</span>
<a href="#l1.6334"></a><span id="l1.6334"> </span>
<a href="#l1.6335"></a><span id="l1.6335">     for (var month = 11; month &gt;= 0; month--) {</span>
<a href="#l1.6336"></a><span id="l1.6336" class="difflineminus">-      if (doy &gt; ICAL.Time._days_in_year_passed_month[is_leap][month]) {</span>
<a href="#l1.6337"></a><span id="l1.6337" class="difflineplus">+      if (doy &gt; ICAL.Time.daysInYearPassedMonth[is_leap][month]) {</span>
<a href="#l1.6338"></a><span id="l1.6338">         tt.month = month + 1;</span>
<a href="#l1.6339"></a><span id="l1.6339" class="difflineminus">-        tt.day = doy - ICAL.Time._days_in_year_passed_month[is_leap][month];</span>
<a href="#l1.6340"></a><span id="l1.6340" class="difflineplus">+        tt.day = doy - ICAL.Time.daysInYearPassedMonth[is_leap][month];</span>
<a href="#l1.6341"></a><span id="l1.6341">         break;</span>
<a href="#l1.6342"></a><span id="l1.6342">       }</span>
<a href="#l1.6343"></a><span id="l1.6343">     }</span>
<a href="#l1.6344"></a><span id="l1.6344"> </span>
<a href="#l1.6345"></a><span id="l1.6345">     tt.auto_normalize = true;</span>
<a href="#l1.6346"></a><span id="l1.6346">     return tt;</span>
<a href="#l1.6347"></a><span id="l1.6347">   };</span>
<a href="#l1.6348"></a><span id="l1.6348"> </span>
<a href="#l1.6349"></a><span id="l1.6349" class="difflineplus">+  /**</span>
<a href="#l1.6350"></a><span id="l1.6350" class="difflineplus">+   * Returns a new ICAL.Time instance from a date string, e.g 2015-01-02.</span>
<a href="#l1.6351"></a><span id="l1.6351" class="difflineplus">+   *</span>
<a href="#l1.6352"></a><span id="l1.6352" class="difflineplus">+   * @deprecated                Use {@link ICAL.Time.fromDateString} instead</span>
<a href="#l1.6353"></a><span id="l1.6353" class="difflineplus">+   * @param {String} str        The string to create from</span>
<a href="#l1.6354"></a><span id="l1.6354" class="difflineplus">+   * @return {ICAL.Time}        The date/time instance</span>
<a href="#l1.6355"></a><span id="l1.6355" class="difflineplus">+   */</span>
<a href="#l1.6356"></a><span id="l1.6356">   ICAL.Time.fromStringv2 = function fromString(str) {</span>
<a href="#l1.6357"></a><span id="l1.6357">     return new ICAL.Time({</span>
<a href="#l1.6358"></a><span id="l1.6358">       year: parseInt(str.substr(0, 4), 10),</span>
<a href="#l1.6359"></a><span id="l1.6359">       month: parseInt(str.substr(5, 2), 10),</span>
<a href="#l1.6360"></a><span id="l1.6360">       day: parseInt(str.substr(8, 2), 10),</span>
<a href="#l1.6361"></a><span id="l1.6361">       isDate: true</span>
<a href="#l1.6362"></a><span id="l1.6362">     });</span>
<a href="#l1.6363"></a><span id="l1.6363">   };</span>
<a href="#l1.6364"></a><span id="l1.6364"> </span>
<a href="#l1.6365"></a><span id="l1.6365" class="difflineminus">-  ICAL.Time.fromDateString = function(aValue, aProp) {</span>
<a href="#l1.6366"></a><span id="l1.6366" class="difflineplus">+  /**</span>
<a href="#l1.6367"></a><span id="l1.6367" class="difflineplus">+   * Returns a new ICAL.Time instance from a date string, e.g 2015-01-02.</span>
<a href="#l1.6368"></a><span id="l1.6368" class="difflineplus">+   *</span>
<a href="#l1.6369"></a><span id="l1.6369" class="difflineplus">+   * @param {String} aValue     The string to create from</span>
<a href="#l1.6370"></a><span id="l1.6370" class="difflineplus">+   * @return {ICAL.Time}        The date/time instance</span>
<a href="#l1.6371"></a><span id="l1.6371" class="difflineplus">+   */</span>
<a href="#l1.6372"></a><span id="l1.6372" class="difflineplus">+  ICAL.Time.fromDateString = function(aValue) {</span>
<a href="#l1.6373"></a><span id="l1.6373">     // Dates should have no timezone.</span>
<a href="#l1.6374"></a><span id="l1.6374">     // Google likes to sometimes specify Z on dates</span>
<a href="#l1.6375"></a><span id="l1.6375">     // we specifically ignore that to avoid issues.</span>
<a href="#l1.6376"></a><span id="l1.6376"> </span>
<a href="#l1.6377"></a><span id="l1.6377">     // YYYY-MM-DD</span>
<a href="#l1.6378"></a><span id="l1.6378">     // 2012-10-10</span>
<a href="#l1.6379"></a><span id="l1.6379">     return new ICAL.Time({</span>
<a href="#l1.6380"></a><span id="l1.6380">       year: ICAL.helpers.strictParseInt(aValue.substr(0, 4)),</span>
<a href="#l1.6381"></a><span id="l1.6381">       month: ICAL.helpers.strictParseInt(aValue.substr(5, 2)),</span>
<a href="#l1.6382"></a><span id="l1.6382">       day: ICAL.helpers.strictParseInt(aValue.substr(8, 2)),</span>
<a href="#l1.6383"></a><span id="l1.6383">       isDate: true</span>
<a href="#l1.6384"></a><span id="l1.6384">     });</span>
<a href="#l1.6385"></a><span id="l1.6385">   };</span>
<a href="#l1.6386"></a><span id="l1.6386"> </span>
<a href="#l1.6387"></a><span id="l1.6387" class="difflineplus">+  /**</span>
<a href="#l1.6388"></a><span id="l1.6388" class="difflineplus">+   * Returns a new ICAL.Time instance from a date-time string, e.g</span>
<a href="#l1.6389"></a><span id="l1.6389" class="difflineplus">+   * 2015-01-02T03:04:05. If a property is specified, the timezone is set up</span>
<a href="#l1.6390"></a><span id="l1.6390" class="difflineplus">+   * from the property's TZID parameter.</span>
<a href="#l1.6391"></a><span id="l1.6391" class="difflineplus">+   *</span>
<a href="#l1.6392"></a><span id="l1.6392" class="difflineplus">+   * @param {String} aValue         The string to create from</span>
<a href="#l1.6393"></a><span id="l1.6393" class="difflineplus">+   * @param {ICAL.Property=} prop   The property the date belongs to</span>
<a href="#l1.6394"></a><span id="l1.6394" class="difflineplus">+   * @return {ICAL.Time}            The date/time instance</span>
<a href="#l1.6395"></a><span id="l1.6395" class="difflineplus">+   */</span>
<a href="#l1.6396"></a><span id="l1.6396">   ICAL.Time.fromDateTimeString = function(aValue, prop) {</span>
<a href="#l1.6397"></a><span id="l1.6397">     if (aValue.length &lt; 19) {</span>
<a href="#l1.6398"></a><span id="l1.6398">       throw new Error(</span>
<a href="#l1.6399"></a><span id="l1.6399">         'invalid date-time value: &quot;' + aValue + '&quot;'</span>
<a href="#l1.6400"></a><span id="l1.6400">       );</span>
<a href="#l1.6401"></a><span id="l1.6401">     }</span>
<a href="#l1.6402"></a><span id="l1.6402"> </span>
<a href="#l1.6403"></a><span id="l1.6403">     var zone;</span>
<a href="#l1.6404"></a><span id="l1.6404"> </span>
<a href="#l1.6405"></a><span id="l1.6405" class="difflineminus">-    if (aValue[19] === 'Z') {</span>
<a href="#l1.6406"></a><span id="l1.6406" class="difflineplus">+    if (aValue[19] &amp;&amp; aValue[19] === 'Z') {</span>
<a href="#l1.6407"></a><span id="l1.6407">       zone = 'Z';</span>
<a href="#l1.6408"></a><span id="l1.6408">     } else if (prop) {</span>
<a href="#l1.6409"></a><span id="l1.6409">       zone = prop.getParameter('tzid');</span>
<a href="#l1.6410"></a><span id="l1.6410">     }</span>
<a href="#l1.6411"></a><span id="l1.6411"> </span>
<a href="#l1.6412"></a><span id="l1.6412">     // 2012-10-10T10:10:10(Z)?</span>
<a href="#l1.6413"></a><span id="l1.6413">     var time = new ICAL.Time({</span>
<a href="#l1.6414"></a><span id="l1.6414">       year: ICAL.helpers.strictParseInt(aValue.substr(0, 4)),</span>
<a href="#l1.6415"></a><span id="l1.6415" class="difflineat">@@ -4098,51 +5811,122 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6416"></a><span id="l1.6416">       minute: ICAL.helpers.strictParseInt(aValue.substr(14, 2)),</span>
<a href="#l1.6417"></a><span id="l1.6417">       second: ICAL.helpers.strictParseInt(aValue.substr(17, 2)),</span>
<a href="#l1.6418"></a><span id="l1.6418">       timezone: zone</span>
<a href="#l1.6419"></a><span id="l1.6419">     });</span>
<a href="#l1.6420"></a><span id="l1.6420"> </span>
<a href="#l1.6421"></a><span id="l1.6421">     return time;</span>
<a href="#l1.6422"></a><span id="l1.6422">   };</span>
<a href="#l1.6423"></a><span id="l1.6423"> </span>
<a href="#l1.6424"></a><span id="l1.6424" class="difflineplus">+  /**</span>
<a href="#l1.6425"></a><span id="l1.6425" class="difflineplus">+   * Returns a new ICAL.Time instance from a date or date-time string,</span>
<a href="#l1.6426"></a><span id="l1.6426" class="difflineplus">+   *</span>
<a href="#l1.6427"></a><span id="l1.6427" class="difflineplus">+   * @param {String} aValue         The string to create from</span>
<a href="#l1.6428"></a><span id="l1.6428" class="difflineplus">+   * @return {ICAL.Time}            The date/time instance</span>
<a href="#l1.6429"></a><span id="l1.6429" class="difflineplus">+   */</span>
<a href="#l1.6430"></a><span id="l1.6430">   ICAL.Time.fromString = function fromString(aValue) {</span>
<a href="#l1.6431"></a><span id="l1.6431">     if (aValue.length &gt; 10) {</span>
<a href="#l1.6432"></a><span id="l1.6432">       return ICAL.Time.fromDateTimeString(aValue);</span>
<a href="#l1.6433"></a><span id="l1.6433">     } else {</span>
<a href="#l1.6434"></a><span id="l1.6434">       return ICAL.Time.fromDateString(aValue);</span>
<a href="#l1.6435"></a><span id="l1.6435">     }</span>
<a href="#l1.6436"></a><span id="l1.6436">   };</span>
<a href="#l1.6437"></a><span id="l1.6437"> </span>
<a href="#l1.6438"></a><span id="l1.6438" class="difflineplus">+  /**</span>
<a href="#l1.6439"></a><span id="l1.6439" class="difflineplus">+   * Creates a new ICAL.Time instance from the given Javascript Date.</span>
<a href="#l1.6440"></a><span id="l1.6440" class="difflineplus">+   *</span>
<a href="#l1.6441"></a><span id="l1.6441" class="difflineplus">+   * @param {?Date} aDate     The Javascript Date to read, or null to reset</span>
<a href="#l1.6442"></a><span id="l1.6442" class="difflineplus">+   * @param {Boolean} useUTC  If true, the UTC values of the date will be used</span>
<a href="#l1.6443"></a><span id="l1.6443" class="difflineplus">+   */</span>
<a href="#l1.6444"></a><span id="l1.6444">   ICAL.Time.fromJSDate = function fromJSDate(aDate, useUTC) {</span>
<a href="#l1.6445"></a><span id="l1.6445">     var tt = new ICAL.Time();</span>
<a href="#l1.6446"></a><span id="l1.6446">     return tt.fromJSDate(aDate, useUTC);</span>
<a href="#l1.6447"></a><span id="l1.6447">   };</span>
<a href="#l1.6448"></a><span id="l1.6448"> </span>
<a href="#l1.6449"></a><span id="l1.6449" class="difflineminus">-  ICAL.Time.fromData = function fromData(aData) {</span>
<a href="#l1.6450"></a><span id="l1.6450" class="difflineplus">+  /**</span>
<a href="#l1.6451"></a><span id="l1.6451" class="difflineplus">+   * Creates a new ICAL.Time instance from the the passed data object.</span>
<a href="#l1.6452"></a><span id="l1.6452" class="difflineplus">+   *</span>
<a href="#l1.6453"></a><span id="l1.6453" class="difflineplus">+   * @param {Object} aData            Time initialization</span>
<a href="#l1.6454"></a><span id="l1.6454" class="difflineplus">+   * @param {Number=} aData.year      The year for this date</span>
<a href="#l1.6455"></a><span id="l1.6455" class="difflineplus">+   * @param {Number=} aData.month     The month for this date</span>
<a href="#l1.6456"></a><span id="l1.6456" class="difflineplus">+   * @param {Number=} aData.day       The day for this date</span>
<a href="#l1.6457"></a><span id="l1.6457" class="difflineplus">+   * @param {Number=} aData.hour      The hour for this date</span>
<a href="#l1.6458"></a><span id="l1.6458" class="difflineplus">+   * @param {Number=} aData.minute    The minute for this date</span>
<a href="#l1.6459"></a><span id="l1.6459" class="difflineplus">+   * @param {Number=} aData.second    The second for this date</span>
<a href="#l1.6460"></a><span id="l1.6460" class="difflineplus">+   * @param {Boolean=} aData.isDate   If true, the instance represents a date</span>
<a href="#l1.6461"></a><span id="l1.6461" class="difflineplus">+   *                                    (as opposed to a date-time)</span>
<a href="#l1.6462"></a><span id="l1.6462" class="difflineplus">+   * @param {ICAL.Timezone=} aZone    Timezone this position occurs in</span>
<a href="#l1.6463"></a><span id="l1.6463" class="difflineplus">+   */</span>
<a href="#l1.6464"></a><span id="l1.6464" class="difflineplus">+  ICAL.Time.fromData = function fromData(aData, aZone) {</span>
<a href="#l1.6465"></a><span id="l1.6465">     var t = new ICAL.Time();</span>
<a href="#l1.6466"></a><span id="l1.6466" class="difflineminus">-    return t.fromData(aData);</span>
<a href="#l1.6467"></a><span id="l1.6467" class="difflineplus">+    return t.fromData(aData, aZone);</span>
<a href="#l1.6468"></a><span id="l1.6468">   };</span>
<a href="#l1.6469"></a><span id="l1.6469"> </span>
<a href="#l1.6470"></a><span id="l1.6470" class="difflineplus">+  /**</span>
<a href="#l1.6471"></a><span id="l1.6471" class="difflineplus">+   * Creates a new ICAL.Time instance from the current moment.</span>
<a href="#l1.6472"></a><span id="l1.6472" class="difflineplus">+   * @return {ICAL.Time}</span>
<a href="#l1.6473"></a><span id="l1.6473" class="difflineplus">+   */</span>
<a href="#l1.6474"></a><span id="l1.6474">   ICAL.Time.now = function icaltime_now() {</span>
<a href="#l1.6475"></a><span id="l1.6475">     return ICAL.Time.fromJSDate(new Date(), false);</span>
<a href="#l1.6476"></a><span id="l1.6476">   };</span>
<a href="#l1.6477"></a><span id="l1.6477"> </span>
<a href="#l1.6478"></a><span id="l1.6478" class="difflineplus">+  /**</span>
<a href="#l1.6479"></a><span id="l1.6479" class="difflineplus">+   * Returns the date on which ISO week number 1 starts.</span>
<a href="#l1.6480"></a><span id="l1.6480" class="difflineplus">+   *</span>
<a href="#l1.6481"></a><span id="l1.6481" class="difflineplus">+   * @see ICAL.Time#weekNumber</span>
<a href="#l1.6482"></a><span id="l1.6482" class="difflineplus">+   * @param {Number} aYear                  The year to search in</span>
<a href="#l1.6483"></a><span id="l1.6483" class="difflineplus">+   * @param {ICAL.Time.weekDay=} aWeekStart The week start weekday, used for calculation.</span>
<a href="#l1.6484"></a><span id="l1.6484" class="difflineplus">+   * @return {ICAL.Time}                    The date on which week number 1 starts</span>
<a href="#l1.6485"></a><span id="l1.6485" class="difflineplus">+   */</span>
<a href="#l1.6486"></a><span id="l1.6486">   ICAL.Time.weekOneStarts = function weekOneStarts(aYear, aWeekStart) {</span>
<a href="#l1.6487"></a><span id="l1.6487">     var t = ICAL.Time.fromData({</span>
<a href="#l1.6488"></a><span id="l1.6488">       year: aYear,</span>
<a href="#l1.6489"></a><span id="l1.6489">       month: 1,</span>
<a href="#l1.6490"></a><span id="l1.6490" class="difflineminus">-      day: 4,</span>
<a href="#l1.6491"></a><span id="l1.6491" class="difflineplus">+      day: 1,</span>
<a href="#l1.6492"></a><span id="l1.6492">       isDate: true</span>
<a href="#l1.6493"></a><span id="l1.6493">     });</span>
<a href="#l1.6494"></a><span id="l1.6494"> </span>
<a href="#l1.6495"></a><span id="l1.6495" class="difflineminus">-    var fourth_dow = t.dayOfWeek();</span>
<a href="#l1.6496"></a><span id="l1.6496" class="difflineminus">-    t.day += (1 - fourth_dow) + ((aWeekStart || ICAL.Time.SUNDAY) - 1);</span>
<a href="#l1.6497"></a><span id="l1.6497" class="difflineplus">+    var dow = t.dayOfWeek();</span>
<a href="#l1.6498"></a><span id="l1.6498" class="difflineplus">+    var wkst = aWeekStart || ICAL.Time.DEFAULT_WEEK_START;</span>
<a href="#l1.6499"></a><span id="l1.6499" class="difflineplus">+    if (dow &gt; ICAL.Time.THURSDAY) {</span>
<a href="#l1.6500"></a><span id="l1.6500" class="difflineplus">+      t.day += 7;</span>
<a href="#l1.6501"></a><span id="l1.6501" class="difflineplus">+    }</span>
<a href="#l1.6502"></a><span id="l1.6502" class="difflineplus">+    if (wkst &gt; ICAL.Time.THURSDAY) {</span>
<a href="#l1.6503"></a><span id="l1.6503" class="difflineplus">+      t.day -= 7;</span>
<a href="#l1.6504"></a><span id="l1.6504" class="difflineplus">+    }</span>
<a href="#l1.6505"></a><span id="l1.6505" class="difflineplus">+</span>
<a href="#l1.6506"></a><span id="l1.6506" class="difflineplus">+    t.day -= dow - wkst;</span>
<a href="#l1.6507"></a><span id="l1.6507" class="difflineplus">+</span>
<a href="#l1.6508"></a><span id="l1.6508">     return t;</span>
<a href="#l1.6509"></a><span id="l1.6509">   };</span>
<a href="#l1.6510"></a><span id="l1.6510"> </span>
<a href="#l1.6511"></a><span id="l1.6511" class="difflineplus">+  /**</span>
<a href="#l1.6512"></a><span id="l1.6512" class="difflineplus">+   * Get the dominical letter for the given year. Letters range from A - G for</span>
<a href="#l1.6513"></a><span id="l1.6513" class="difflineplus">+   * common years, and AG to GF for leap years.</span>
<a href="#l1.6514"></a><span id="l1.6514" class="difflineplus">+   *</span>
<a href="#l1.6515"></a><span id="l1.6515" class="difflineplus">+   * @param {Number} yr           The year to retrieve the letter for</span>
<a href="#l1.6516"></a><span id="l1.6516" class="difflineplus">+   * @return {String}             The dominical letter.</span>
<a href="#l1.6517"></a><span id="l1.6517" class="difflineplus">+   */</span>
<a href="#l1.6518"></a><span id="l1.6518" class="difflineplus">+  ICAL.Time.getDominicalLetter = function(yr) {</span>
<a href="#l1.6519"></a><span id="l1.6519" class="difflineplus">+    var LTRS = &quot;GFEDCBA&quot;;</span>
<a href="#l1.6520"></a><span id="l1.6520" class="difflineplus">+    var dom = (yr + (yr / 4 | 0) + (yr / 400 | 0) - (yr / 100 | 0) - 1) % 7;</span>
<a href="#l1.6521"></a><span id="l1.6521" class="difflineplus">+    var isLeap = ICAL.Time.isLeapYear(yr);</span>
<a href="#l1.6522"></a><span id="l1.6522" class="difflineplus">+    if (isLeap) {</span>
<a href="#l1.6523"></a><span id="l1.6523" class="difflineplus">+      return LTRS[(dom + 6) % 7] + LTRS[dom];</span>
<a href="#l1.6524"></a><span id="l1.6524" class="difflineplus">+    } else {</span>
<a href="#l1.6525"></a><span id="l1.6525" class="difflineplus">+      return LTRS[dom];</span>
<a href="#l1.6526"></a><span id="l1.6526" class="difflineplus">+    }</span>
<a href="#l1.6527"></a><span id="l1.6527" class="difflineplus">+  };</span>
<a href="#l1.6528"></a><span id="l1.6528" class="difflineplus">+</span>
<a href="#l1.6529"></a><span id="l1.6529" class="difflineplus">+  /**</span>
<a href="#l1.6530"></a><span id="l1.6530" class="difflineplus">+   * January 1st, 1970 as an ICAL.Time.</span>
<a href="#l1.6531"></a><span id="l1.6531" class="difflineplus">+   * @type {ICAL.Time}</span>
<a href="#l1.6532"></a><span id="l1.6532" class="difflineplus">+   * @constant</span>
<a href="#l1.6533"></a><span id="l1.6533" class="difflineplus">+   * @instance</span>
<a href="#l1.6534"></a><span id="l1.6534" class="difflineplus">+   */</span>
<a href="#l1.6535"></a><span id="l1.6535">   ICAL.Time.epochTime = ICAL.Time.fromData({</span>
<a href="#l1.6536"></a><span id="l1.6536">     year: 1970,</span>
<a href="#l1.6537"></a><span id="l1.6537">     month: 1,</span>
<a href="#l1.6538"></a><span id="l1.6538">     day: 1,</span>
<a href="#l1.6539"></a><span id="l1.6539">     hour: 0,</span>
<a href="#l1.6540"></a><span id="l1.6540">     minute: 0,</span>
<a href="#l1.6541"></a><span id="l1.6541">     second: 0,</span>
<a href="#l1.6542"></a><span id="l1.6542">     isDate: false,</span>
<a href="#l1.6543"></a><span id="l1.6543" class="difflineat">@@ -4150,188 +5934,589 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.6544"></a><span id="l1.6544">   });</span>
<a href="#l1.6545"></a><span id="l1.6545"> </span>
<a href="#l1.6546"></a><span id="l1.6546">   ICAL.Time._cmp_attr = function _cmp_attr(a, b, attr) {</span>
<a href="#l1.6547"></a><span id="l1.6547">     if (a[attr] &gt; b[attr]) return 1;</span>
<a href="#l1.6548"></a><span id="l1.6548">     if (a[attr] &lt; b[attr]) return -1;</span>
<a href="#l1.6549"></a><span id="l1.6549">     return 0;</span>
<a href="#l1.6550"></a><span id="l1.6550">   };</span>
<a href="#l1.6551"></a><span id="l1.6551"> </span>
<a href="#l1.6552"></a><span id="l1.6552" class="difflineminus">-  ICAL.Time._days_in_year_passed_month = [</span>
<a href="#l1.6553"></a><span id="l1.6553" class="difflineplus">+  /**</span>
<a href="#l1.6554"></a><span id="l1.6554" class="difflineplus">+   * The days that have passed in the year after a given month. The array has</span>
<a href="#l1.6555"></a><span id="l1.6555" class="difflineplus">+   * two members, one being an array of passed days for non-leap years, the</span>
<a href="#l1.6556"></a><span id="l1.6556" class="difflineplus">+   * other analog for leap years.</span>
<a href="#l1.6557"></a><span id="l1.6557" class="difflineplus">+   * @example</span>
<a href="#l1.6558"></a><span id="l1.6558" class="difflineplus">+   * var isLeapYear = ICAL.Time.isLeapYear(year);</span>
<a href="#l1.6559"></a><span id="l1.6559" class="difflineplus">+   * var passedDays = ICAL.Time.daysInYearPassedMonth[isLeapYear][month];</span>
<a href="#l1.6560"></a><span id="l1.6560" class="difflineplus">+   * @type {Array.&lt;Array.&lt;Number&gt;&gt;}</span>
<a href="#l1.6561"></a><span id="l1.6561" class="difflineplus">+   */</span>
<a href="#l1.6562"></a><span id="l1.6562" class="difflineplus">+  ICAL.Time.daysInYearPassedMonth = [</span>
<a href="#l1.6563"></a><span id="l1.6563">     [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365],</span>
<a href="#l1.6564"></a><span id="l1.6564">     [0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366]</span>
<a href="#l1.6565"></a><span id="l1.6565">   ];</span>
<a href="#l1.6566"></a><span id="l1.6566"> </span>
<a href="#l1.6567"></a><span id="l1.6567" class="difflineplus">+  /**</span>
<a href="#l1.6568"></a><span id="l1.6568" class="difflineplus">+   * The weekday, 1 = SUNDAY, 7 = SATURDAY. Access via</span>
<a href="#l1.6569"></a><span id="l1.6569" class="difflineplus">+   * ICAL.Time.MONDAY, ICAL.Time.TUESDAY, ...</span>
<a href="#l1.6570"></a><span id="l1.6570" class="difflineplus">+   *</span>
<a href="#l1.6571"></a><span id="l1.6571" class="difflineplus">+   * @typedef {Number} weekDay</span>
<a href="#l1.6572"></a><span id="l1.6572" class="difflineplus">+   * @memberof ICAL.Time</span>
<a href="#l1.6573"></a><span id="l1.6573" class="difflineplus">+   */</span>
<a href="#l1.6574"></a><span id="l1.6574"> </span>
<a href="#l1.6575"></a><span id="l1.6575">   ICAL.Time.SUNDAY = 1;</span>
<a href="#l1.6576"></a><span id="l1.6576">   ICAL.Time.MONDAY = 2;</span>
<a href="#l1.6577"></a><span id="l1.6577">   ICAL.Time.TUESDAY = 3;</span>
<a href="#l1.6578"></a><span id="l1.6578">   ICAL.Time.WEDNESDAY = 4;</span>
<a href="#l1.6579"></a><span id="l1.6579">   ICAL.Time.THURSDAY = 5;</span>
<a href="#l1.6580"></a><span id="l1.6580">   ICAL.Time.FRIDAY = 6;</span>
<a href="#l1.6581"></a><span id="l1.6581">   ICAL.Time.SATURDAY = 7;</span>
<a href="#l1.6582"></a><span id="l1.6582"> </span>
<a href="#l1.6583"></a><span id="l1.6583" class="difflineplus">+  /**</span>
<a href="#l1.6584"></a><span id="l1.6584" class="difflineplus">+   * The default weekday for the WKST part.</span>
<a href="#l1.6585"></a><span id="l1.6585" class="difflineplus">+   * @constant</span>
<a href="#l1.6586"></a><span id="l1.6586" class="difflineplus">+   * @default ICAL.Time.MONDAY</span>
<a href="#l1.6587"></a><span id="l1.6587" class="difflineplus">+   */</span>
<a href="#l1.6588"></a><span id="l1.6588">   ICAL.Time.DEFAULT_WEEK_START = ICAL.Time.MONDAY;</span>
<a href="#l1.6589"></a><span id="l1.6589"> })();</span>
<a href="#l1.6590"></a><span id="l1.6590"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6591"></a><span id="l1.6591">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6592"></a><span id="l1.6592">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.6593"></a><span id="l1.6593" class="difflineminus">- * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.6594"></a><span id="l1.6594" class="difflineminus">-</span>
<a href="#l1.6595"></a><span id="l1.6595" class="difflineminus">-</span>
<a href="#l1.6596"></a><span id="l1.6596" class="difflineminus">-</span>
<a href="#l1.6597"></a><span id="l1.6597" class="difflineminus">-(typeof(ICAL) === 'undefined')? ICAL = {} : '';</span>
<a href="#l1.6598"></a><span id="l1.6598" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2015 */</span>
<a href="#l1.6599"></a><span id="l1.6599" class="difflineplus">+</span>
<a href="#l1.6600"></a><span id="l1.6600" class="difflineplus">+</span>
<a href="#l1.6601"></a><span id="l1.6601" class="difflineplus">+</span>
<a href="#l1.6602"></a><span id="l1.6602"> (function() {</span>
<a href="#l1.6603"></a><span id="l1.6603"> </span>
<a href="#l1.6604"></a><span id="l1.6604" class="difflineplus">+  /**</span>
<a href="#l1.6605"></a><span id="l1.6605" class="difflineplus">+   * Describes a vCard time, which has slight differences to the ICAL.Time.</span>
<a href="#l1.6606"></a><span id="l1.6606" class="difflineplus">+   * Properties can be null if not specified, for example for dates with</span>
<a href="#l1.6607"></a><span id="l1.6607" class="difflineplus">+   * reduced accuracy or truncation.</span>
<a href="#l1.6608"></a><span id="l1.6608" class="difflineplus">+   *</span>
<a href="#l1.6609"></a><span id="l1.6609" class="difflineplus">+   * Note that currently not all methods are correctly re-implemented for</span>
<a href="#l1.6610"></a><span id="l1.6610" class="difflineplus">+   * VCardTime. For example, comparison will have undefined results when some</span>
<a href="#l1.6611"></a><span id="l1.6611" class="difflineplus">+   * members are null.</span>
<a href="#l1.6612"></a><span id="l1.6612" class="difflineplus">+   *</span>
<a href="#l1.6613"></a><span id="l1.6613" class="difflineplus">+   * Also, normalization is not yet implemented for this class!</span>
<a href="#l1.6614"></a><span id="l1.6614" class="difflineplus">+   *</span>
<a href="#l1.6615"></a><span id="l1.6615" class="difflineplus">+   * @alias ICAL.VCardTime</span>
<a href="#l1.6616"></a><span id="l1.6616" class="difflineplus">+   * @class</span>
<a href="#l1.6617"></a><span id="l1.6617" class="difflineplus">+   * @extends {ICAL.Time}</span>
<a href="#l1.6618"></a><span id="l1.6618" class="difflineplus">+   * @param {Object} data                           The data for the time instance</span>
<a href="#l1.6619"></a><span id="l1.6619" class="difflineplus">+   * @param {Number=} data.year                     The year for this date</span>
<a href="#l1.6620"></a><span id="l1.6620" class="difflineplus">+   * @param {Number=} data.month                    The month for this date</span>
<a href="#l1.6621"></a><span id="l1.6621" class="difflineplus">+   * @param {Number=} data.day                      The day for this date</span>
<a href="#l1.6622"></a><span id="l1.6622" class="difflineplus">+   * @param {Number=} data.hour                     The hour for this date</span>
<a href="#l1.6623"></a><span id="l1.6623" class="difflineplus">+   * @param {Number=} data.minute                   The minute for this date</span>
<a href="#l1.6624"></a><span id="l1.6624" class="difflineplus">+   * @param {Number=} data.second                   The second for this date</span>
<a href="#l1.6625"></a><span id="l1.6625" class="difflineplus">+   * @param {ICAL.Timezone|ICAL.UtcOffset} zone     The timezone to use</span>
<a href="#l1.6626"></a><span id="l1.6626" class="difflineplus">+   * @param {String} icaltype                       The type for this date/time object</span>
<a href="#l1.6627"></a><span id="l1.6627" class="difflineplus">+   */</span>
<a href="#l1.6628"></a><span id="l1.6628" class="difflineplus">+  ICAL.VCardTime = function(data, zone, icaltype) {</span>
<a href="#l1.6629"></a><span id="l1.6629" class="difflineplus">+    this.wrappedJSObject = this;</span>
<a href="#l1.6630"></a><span id="l1.6630" class="difflineplus">+    var time = this._time = Object.create(null);</span>
<a href="#l1.6631"></a><span id="l1.6631" class="difflineplus">+</span>
<a href="#l1.6632"></a><span id="l1.6632" class="difflineplus">+    time.year = null;</span>
<a href="#l1.6633"></a><span id="l1.6633" class="difflineplus">+    time.month = null;</span>
<a href="#l1.6634"></a><span id="l1.6634" class="difflineplus">+    time.day = null;</span>
<a href="#l1.6635"></a><span id="l1.6635" class="difflineplus">+    time.hour = null;</span>
<a href="#l1.6636"></a><span id="l1.6636" class="difflineplus">+    time.minute = null;</span>
<a href="#l1.6637"></a><span id="l1.6637" class="difflineplus">+    time.second = null;</span>
<a href="#l1.6638"></a><span id="l1.6638" class="difflineplus">+</span>
<a href="#l1.6639"></a><span id="l1.6639" class="difflineplus">+    this.icaltype = icaltype || &quot;date-and-or-time&quot;;</span>
<a href="#l1.6640"></a><span id="l1.6640" class="difflineplus">+</span>
<a href="#l1.6641"></a><span id="l1.6641" class="difflineplus">+    this.fromData(data, zone);</span>
<a href="#l1.6642"></a><span id="l1.6642" class="difflineplus">+  };</span>
<a href="#l1.6643"></a><span id="l1.6643" class="difflineplus">+  ICAL.helpers.inherits(ICAL.Time, ICAL.VCardTime, /** @lends ICAL.VCardTime */ {</span>
<a href="#l1.6644"></a><span id="l1.6644" class="difflineplus">+</span>
<a href="#l1.6645"></a><span id="l1.6645" class="difflineplus">+    /**</span>
<a href="#l1.6646"></a><span id="l1.6646" class="difflineplus">+     * The class identifier.</span>
<a href="#l1.6647"></a><span id="l1.6647" class="difflineplus">+     * @constant</span>
<a href="#l1.6648"></a><span id="l1.6648" class="difflineplus">+     * @type {String}</span>
<a href="#l1.6649"></a><span id="l1.6649" class="difflineplus">+     * @default &quot;vcardtime&quot;</span>
<a href="#l1.6650"></a><span id="l1.6650" class="difflineplus">+     */</span>
<a href="#l1.6651"></a><span id="l1.6651" class="difflineplus">+    icalclass: &quot;vcardtime&quot;,</span>
<a href="#l1.6652"></a><span id="l1.6652" class="difflineplus">+</span>
<a href="#l1.6653"></a><span id="l1.6653" class="difflineplus">+    /**</span>
<a href="#l1.6654"></a><span id="l1.6654" class="difflineplus">+     * The type name, to be used in the jCal object.</span>
<a href="#l1.6655"></a><span id="l1.6655" class="difflineplus">+     * @type {String}</span>
<a href="#l1.6656"></a><span id="l1.6656" class="difflineplus">+     * @default &quot;date-and-or-time&quot;</span>
<a href="#l1.6657"></a><span id="l1.6657" class="difflineplus">+     */</span>
<a href="#l1.6658"></a><span id="l1.6658" class="difflineplus">+    icaltype: &quot;date-and-or-time&quot;,</span>
<a href="#l1.6659"></a><span id="l1.6659" class="difflineplus">+</span>
<a href="#l1.6660"></a><span id="l1.6660" class="difflineplus">+    /**</span>
<a href="#l1.6661"></a><span id="l1.6661" class="difflineplus">+     * The timezone. This can either be floating, UTC, or an instance of</span>
<a href="#l1.6662"></a><span id="l1.6662" class="difflineplus">+     * ICAL.UtcOffset.</span>
<a href="#l1.6663"></a><span id="l1.6663" class="difflineplus">+     * @type {ICAL.Timezone|ICAL.UtcOFfset}</span>
<a href="#l1.6664"></a><span id="l1.6664" class="difflineplus">+     */</span>
<a href="#l1.6665"></a><span id="l1.6665" class="difflineplus">+    zone: null,</span>
<a href="#l1.6666"></a><span id="l1.6666" class="difflineplus">+</span>
<a href="#l1.6667"></a><span id="l1.6667" class="difflineplus">+    /**</span>
<a href="#l1.6668"></a><span id="l1.6668" class="difflineplus">+     * Returns a clone of the vcard date/time object.</span>
<a href="#l1.6669"></a><span id="l1.6669" class="difflineplus">+     *</span>
<a href="#l1.6670"></a><span id="l1.6670" class="difflineplus">+     * @return {ICAL.VCardTime}     The cloned object</span>
<a href="#l1.6671"></a><span id="l1.6671" class="difflineplus">+     */</span>
<a href="#l1.6672"></a><span id="l1.6672" class="difflineplus">+    clone: function() {</span>
<a href="#l1.6673"></a><span id="l1.6673" class="difflineplus">+      return new ICAL.VCardTime(this._time, this.zone, this.icaltype);</span>
<a href="#l1.6674"></a><span id="l1.6674" class="difflineplus">+    },</span>
<a href="#l1.6675"></a><span id="l1.6675" class="difflineplus">+</span>
<a href="#l1.6676"></a><span id="l1.6676" class="difflineplus">+    _normalize: function() {</span>
<a href="#l1.6677"></a><span id="l1.6677" class="difflineplus">+      return this;</span>
<a href="#l1.6678"></a><span id="l1.6678" class="difflineplus">+    },</span>
<a href="#l1.6679"></a><span id="l1.6679" class="difflineplus">+</span>
<a href="#l1.6680"></a><span id="l1.6680" class="difflineplus">+    /**</span>
<a href="#l1.6681"></a><span id="l1.6681" class="difflineplus">+     * @inheritdoc</span>
<a href="#l1.6682"></a><span id="l1.6682" class="difflineplus">+     */</span>
<a href="#l1.6683"></a><span id="l1.6683" class="difflineplus">+    utcOffset: function() {</span>
<a href="#l1.6684"></a><span id="l1.6684" class="difflineplus">+      if (this.zone instanceof ICAL.UtcOffset) {</span>
<a href="#l1.6685"></a><span id="l1.6685" class="difflineplus">+        return this.zone.toSeconds();</span>
<a href="#l1.6686"></a><span id="l1.6686" class="difflineplus">+      } else {</span>
<a href="#l1.6687"></a><span id="l1.6687" class="difflineplus">+        return ICAL.Time.prototype.utcOffset.apply(this, arguments);</span>
<a href="#l1.6688"></a><span id="l1.6688" class="difflineplus">+      }</span>
<a href="#l1.6689"></a><span id="l1.6689" class="difflineplus">+    },</span>
<a href="#l1.6690"></a><span id="l1.6690" class="difflineplus">+</span>
<a href="#l1.6691"></a><span id="l1.6691" class="difflineplus">+    /**</span>
<a href="#l1.6692"></a><span id="l1.6692" class="difflineplus">+     * Returns an RFC 6350 compliant representation of this object.</span>
<a href="#l1.6693"></a><span id="l1.6693" class="difflineplus">+     *</span>
<a href="#l1.6694"></a><span id="l1.6694" class="difflineplus">+     * @return {String}         vcard date/time string</span>
<a href="#l1.6695"></a><span id="l1.6695" class="difflineplus">+     */</span>
<a href="#l1.6696"></a><span id="l1.6696" class="difflineplus">+    toICALString: function() {</span>
<a href="#l1.6697"></a><span id="l1.6697" class="difflineplus">+      return ICAL.design.vcard.value[this.icaltype].toICAL(this.toString());</span>
<a href="#l1.6698"></a><span id="l1.6698" class="difflineplus">+    },</span>
<a href="#l1.6699"></a><span id="l1.6699" class="difflineplus">+</span>
<a href="#l1.6700"></a><span id="l1.6700" class="difflineplus">+    /**</span>
<a href="#l1.6701"></a><span id="l1.6701" class="difflineplus">+     * The string representation of this date/time, in jCard form</span>
<a href="#l1.6702"></a><span id="l1.6702" class="difflineplus">+     * (including : and - separators).</span>
<a href="#l1.6703"></a><span id="l1.6703" class="difflineplus">+     * @return {String}</span>
<a href="#l1.6704"></a><span id="l1.6704" class="difflineplus">+     */</span>
<a href="#l1.6705"></a><span id="l1.6705" class="difflineplus">+    toString: function toString() {</span>
<a href="#l1.6706"></a><span id="l1.6706" class="difflineplus">+      var p2 = ICAL.helpers.pad2;</span>
<a href="#l1.6707"></a><span id="l1.6707" class="difflineplus">+      var y = this.year, m = this.month, d = this.day;</span>
<a href="#l1.6708"></a><span id="l1.6708" class="difflineplus">+      var h = this.hour, mm = this.minute, s = this.second;</span>
<a href="#l1.6709"></a><span id="l1.6709" class="difflineplus">+</span>
<a href="#l1.6710"></a><span id="l1.6710" class="difflineplus">+      var hasYear = y !== null, hasMonth = m !== null, hasDay = d !== null;</span>
<a href="#l1.6711"></a><span id="l1.6711" class="difflineplus">+      var hasHour = h !== null, hasMinute = mm !== null, hasSecond = s !== null;</span>
<a href="#l1.6712"></a><span id="l1.6712" class="difflineplus">+</span>
<a href="#l1.6713"></a><span id="l1.6713" class="difflineplus">+      var datepart = (hasYear ? p2(y) + (hasMonth || hasDay ? '-' : '') : (hasMonth || hasDay ? '--' : '')) +</span>
<a href="#l1.6714"></a><span id="l1.6714" class="difflineplus">+                     (hasMonth ? p2(m) : '') +</span>
<a href="#l1.6715"></a><span id="l1.6715" class="difflineplus">+                     (hasDay ? '-' + p2(d) : '');</span>
<a href="#l1.6716"></a><span id="l1.6716" class="difflineplus">+      var timepart = (hasHour ? p2(h) : '-') + (hasHour &amp;&amp; hasMinute ? ':' : '') +</span>
<a href="#l1.6717"></a><span id="l1.6717" class="difflineplus">+                     (hasMinute ? p2(mm) : '') + (!hasHour &amp;&amp; !hasMinute ? '-' : '') +</span>
<a href="#l1.6718"></a><span id="l1.6718" class="difflineplus">+                     (hasMinute &amp;&amp; hasSecond ? ':' : '') +</span>
<a href="#l1.6719"></a><span id="l1.6719" class="difflineplus">+                     (hasSecond ? p2(s) : '');</span>
<a href="#l1.6720"></a><span id="l1.6720" class="difflineplus">+</span>
<a href="#l1.6721"></a><span id="l1.6721" class="difflineplus">+      var zone;</span>
<a href="#l1.6722"></a><span id="l1.6722" class="difflineplus">+      if (this.zone === ICAL.Timezone.utcTimezone) {</span>
<a href="#l1.6723"></a><span id="l1.6723" class="difflineplus">+        zone = 'Z';</span>
<a href="#l1.6724"></a><span id="l1.6724" class="difflineplus">+      } else if (this.zone instanceof ICAL.UtcOffset) {</span>
<a href="#l1.6725"></a><span id="l1.6725" class="difflineplus">+        zone = this.zone.toString();</span>
<a href="#l1.6726"></a><span id="l1.6726" class="difflineplus">+      } else if (this.zone === ICAL.Timezone.localTimezone) {</span>
<a href="#l1.6727"></a><span id="l1.6727" class="difflineplus">+        zone = '';</span>
<a href="#l1.6728"></a><span id="l1.6728" class="difflineplus">+      } else if (this.zone instanceof ICAL.Timezone) {</span>
<a href="#l1.6729"></a><span id="l1.6729" class="difflineplus">+        var offset = ICAL.UtcOffset.fromSeconds(this.zone.utcOffset(this));</span>
<a href="#l1.6730"></a><span id="l1.6730" class="difflineplus">+        zone = offset.toString();</span>
<a href="#l1.6731"></a><span id="l1.6731" class="difflineplus">+      } else {</span>
<a href="#l1.6732"></a><span id="l1.6732" class="difflineplus">+        zone = '';</span>
<a href="#l1.6733"></a><span id="l1.6733" class="difflineplus">+      }</span>
<a href="#l1.6734"></a><span id="l1.6734" class="difflineplus">+</span>
<a href="#l1.6735"></a><span id="l1.6735" class="difflineplus">+      switch (this.icaltype) {</span>
<a href="#l1.6736"></a><span id="l1.6736" class="difflineplus">+        case &quot;time&quot;:</span>
<a href="#l1.6737"></a><span id="l1.6737" class="difflineplus">+          return timepart + zone;</span>
<a href="#l1.6738"></a><span id="l1.6738" class="difflineplus">+        case &quot;date-and-or-time&quot;:</span>
<a href="#l1.6739"></a><span id="l1.6739" class="difflineplus">+        case &quot;date-time&quot;:</span>
<a href="#l1.6740"></a><span id="l1.6740" class="difflineplus">+          return datepart + (timepart == '--' ? '' : 'T' + timepart + zone);</span>
<a href="#l1.6741"></a><span id="l1.6741" class="difflineplus">+        case &quot;date&quot;:</span>
<a href="#l1.6742"></a><span id="l1.6742" class="difflineplus">+          return datepart;</span>
<a href="#l1.6743"></a><span id="l1.6743" class="difflineplus">+      }</span>
<a href="#l1.6744"></a><span id="l1.6744" class="difflineplus">+      return null;</span>
<a href="#l1.6745"></a><span id="l1.6745" class="difflineplus">+    }</span>
<a href="#l1.6746"></a><span id="l1.6746" class="difflineplus">+  });</span>
<a href="#l1.6747"></a><span id="l1.6747" class="difflineplus">+</span>
<a href="#l1.6748"></a><span id="l1.6748" class="difflineplus">+  /**</span>
<a href="#l1.6749"></a><span id="l1.6749" class="difflineplus">+   * Returns a new ICAL.VCardTime instance from a date and/or time string.</span>
<a href="#l1.6750"></a><span id="l1.6750" class="difflineplus">+   *</span>
<a href="#l1.6751"></a><span id="l1.6751" class="difflineplus">+   * @param {String} aValue     The string to create from</span>
<a href="#l1.6752"></a><span id="l1.6752" class="difflineplus">+   * @param {String} aIcalType  The type for this instance, e.g. date-and-or-time</span>
<a href="#l1.6753"></a><span id="l1.6753" class="difflineplus">+   * @return {ICAL.VCardTime}   The date/time instance</span>
<a href="#l1.6754"></a><span id="l1.6754" class="difflineplus">+   */</span>
<a href="#l1.6755"></a><span id="l1.6755" class="difflineplus">+  ICAL.VCardTime.fromDateAndOrTimeString = function(aValue, aIcalType) {</span>
<a href="#l1.6756"></a><span id="l1.6756" class="difflineplus">+    function part(v, s, e) {</span>
<a href="#l1.6757"></a><span id="l1.6757" class="difflineplus">+      return v ? ICAL.helpers.strictParseInt(v.substr(s, e)) : null;</span>
<a href="#l1.6758"></a><span id="l1.6758" class="difflineplus">+    }</span>
<a href="#l1.6759"></a><span id="l1.6759" class="difflineplus">+    var parts = aValue.split('T');</span>
<a href="#l1.6760"></a><span id="l1.6760" class="difflineplus">+    var dt = parts[0], tmz = parts[1];</span>
<a href="#l1.6761"></a><span id="l1.6761" class="difflineplus">+    var splitzone = tmz ? ICAL.design.vcard.value.time._splitZone(tmz) : [];</span>
<a href="#l1.6762"></a><span id="l1.6762" class="difflineplus">+    var zone = splitzone[0], tm = splitzone[1];</span>
<a href="#l1.6763"></a><span id="l1.6763" class="difflineplus">+</span>
<a href="#l1.6764"></a><span id="l1.6764" class="difflineplus">+    var stoi = ICAL.helpers.strictParseInt;</span>
<a href="#l1.6765"></a><span id="l1.6765" class="difflineplus">+    var dtlen = dt ? dt.length : 0;</span>
<a href="#l1.6766"></a><span id="l1.6766" class="difflineplus">+    var tmlen = tm ? tm.length : 0;</span>
<a href="#l1.6767"></a><span id="l1.6767" class="difflineplus">+</span>
<a href="#l1.6768"></a><span id="l1.6768" class="difflineplus">+    var hasDashDate = dt &amp;&amp; dt[0] == '-' &amp;&amp; dt[1] == '-';</span>
<a href="#l1.6769"></a><span id="l1.6769" class="difflineplus">+    var hasDashTime = tm &amp;&amp; tm[0] == '-';</span>
<a href="#l1.6770"></a><span id="l1.6770" class="difflineplus">+</span>
<a href="#l1.6771"></a><span id="l1.6771" class="difflineplus">+    var o = {</span>
<a href="#l1.6772"></a><span id="l1.6772" class="difflineplus">+      year: hasDashDate ? null : part(dt, 0, 4),</span>
<a href="#l1.6773"></a><span id="l1.6773" class="difflineplus">+      month: hasDashDate &amp;&amp; (dtlen == 4 || dtlen == 7) ? part(dt, 2, 2) : dtlen == 7 ? part(dt, 5, 2) : dtlen == 10 ? part(dt, 5, 2) : null,</span>
<a href="#l1.6774"></a><span id="l1.6774" class="difflineplus">+      day: dtlen == 5 ? part(dt, 3, 2) : dtlen == 7 &amp;&amp; hasDashDate ? part(dt, 5, 2) : dtlen == 10 ? part(dt, 8, 2) : null,</span>
<a href="#l1.6775"></a><span id="l1.6775" class="difflineplus">+</span>
<a href="#l1.6776"></a><span id="l1.6776" class="difflineplus">+      hour: hasDashTime ? null : part(tm, 0, 2),</span>
<a href="#l1.6777"></a><span id="l1.6777" class="difflineplus">+      minute: hasDashTime &amp;&amp; tmlen == 3 ? part(tm, 1, 2) : tmlen &gt; 4 ? hasDashTime ? part(tm, 1, 2) : part(tm, 3, 2) : null,</span>
<a href="#l1.6778"></a><span id="l1.6778" class="difflineplus">+      second: tmlen == 4 ? part(tm, 2, 2) : tmlen == 6 ? part(tm, 4, 2) : tmlen == 8 ? part(tm, 6, 2) : null</span>
<a href="#l1.6779"></a><span id="l1.6779" class="difflineplus">+    };</span>
<a href="#l1.6780"></a><span id="l1.6780" class="difflineplus">+</span>
<a href="#l1.6781"></a><span id="l1.6781" class="difflineplus">+    if (zone == 'Z') {</span>
<a href="#l1.6782"></a><span id="l1.6782" class="difflineplus">+      zone = ICAL.Timezone.utcTimezone;</span>
<a href="#l1.6783"></a><span id="l1.6783" class="difflineplus">+    } else if (zone &amp;&amp; zone[3] == ':') {</span>
<a href="#l1.6784"></a><span id="l1.6784" class="difflineplus">+      zone = ICAL.UtcOffset.fromString(zone);</span>
<a href="#l1.6785"></a><span id="l1.6785" class="difflineplus">+    } else {</span>
<a href="#l1.6786"></a><span id="l1.6786" class="difflineplus">+      zone = null;</span>
<a href="#l1.6787"></a><span id="l1.6787" class="difflineplus">+    }</span>
<a href="#l1.6788"></a><span id="l1.6788" class="difflineplus">+</span>
<a href="#l1.6789"></a><span id="l1.6789" class="difflineplus">+    return new ICAL.VCardTime(o, zone, aIcalType);</span>
<a href="#l1.6790"></a><span id="l1.6790" class="difflineplus">+  };</span>
<a href="#l1.6791"></a><span id="l1.6791" class="difflineplus">+})();</span>
<a href="#l1.6792"></a><span id="l1.6792" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6793"></a><span id="l1.6793" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6794"></a><span id="l1.6794" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.6795"></a><span id="l1.6795" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.6796"></a><span id="l1.6796" class="difflineplus">+</span>
<a href="#l1.6797"></a><span id="l1.6797" class="difflineplus">+</span>
<a href="#l1.6798"></a><span id="l1.6798" class="difflineplus">+</span>
<a href="#l1.6799"></a><span id="l1.6799" class="difflineplus">+(function() {</span>
<a href="#l1.6800"></a><span id="l1.6800">   var DOW_MAP = {</span>
<a href="#l1.6801"></a><span id="l1.6801">     SU: ICAL.Time.SUNDAY,</span>
<a href="#l1.6802"></a><span id="l1.6802">     MO: ICAL.Time.MONDAY,</span>
<a href="#l1.6803"></a><span id="l1.6803">     TU: ICAL.Time.TUESDAY,</span>
<a href="#l1.6804"></a><span id="l1.6804">     WE: ICAL.Time.WEDNESDAY,</span>
<a href="#l1.6805"></a><span id="l1.6805">     TH: ICAL.Time.THURSDAY,</span>
<a href="#l1.6806"></a><span id="l1.6806">     FR: ICAL.Time.FRIDAY,</span>
<a href="#l1.6807"></a><span id="l1.6807">     SA: ICAL.Time.SATURDAY</span>
<a href="#l1.6808"></a><span id="l1.6808">   };</span>
<a href="#l1.6809"></a><span id="l1.6809"> </span>
<a href="#l1.6810"></a><span id="l1.6810">   var REVERSE_DOW_MAP = {};</span>
<a href="#l1.6811"></a><span id="l1.6811">   for (var key in DOW_MAP) {</span>
<a href="#l1.6812"></a><span id="l1.6812" class="difflineminus">-    REVERSE_DOW_MAP[DOW_MAP[key]] = key;</span>
<a href="#l1.6813"></a><span id="l1.6813" class="difflineplus">+    /* istanbul ignore else */</span>
<a href="#l1.6814"></a><span id="l1.6814" class="difflineplus">+    if (DOW_MAP.hasOwnProperty(key)) {</span>
<a href="#l1.6815"></a><span id="l1.6815" class="difflineplus">+      REVERSE_DOW_MAP[DOW_MAP[key]] = key;</span>
<a href="#l1.6816"></a><span id="l1.6816" class="difflineplus">+    }</span>
<a href="#l1.6817"></a><span id="l1.6817">   }</span>
<a href="#l1.6818"></a><span id="l1.6818"> </span>
<a href="#l1.6819"></a><span id="l1.6819">   var COPY_PARTS = [&quot;BYSECOND&quot;, &quot;BYMINUTE&quot;, &quot;BYHOUR&quot;, &quot;BYDAY&quot;,</span>
<a href="#l1.6820"></a><span id="l1.6820">                     &quot;BYMONTHDAY&quot;, &quot;BYYEARDAY&quot;, &quot;BYWEEKNO&quot;,</span>
<a href="#l1.6821"></a><span id="l1.6821">                     &quot;BYMONTH&quot;, &quot;BYSETPOS&quot;];</span>
<a href="#l1.6822"></a><span id="l1.6822"> </span>
<a href="#l1.6823"></a><span id="l1.6823" class="difflineplus">+  /**</span>
<a href="#l1.6824"></a><span id="l1.6824" class="difflineplus">+   * @classdesc</span>
<a href="#l1.6825"></a><span id="l1.6825" class="difflineplus">+   * This class represents the &quot;recur&quot; value type, with various calculation</span>
<a href="#l1.6826"></a><span id="l1.6826" class="difflineplus">+   * and manipulation methods.</span>
<a href="#l1.6827"></a><span id="l1.6827" class="difflineplus">+   *</span>
<a href="#l1.6828"></a><span id="l1.6828" class="difflineplus">+   * @class</span>
<a href="#l1.6829"></a><span id="l1.6829" class="difflineplus">+   * @alias ICAL.Recur</span>
<a href="#l1.6830"></a><span id="l1.6830" class="difflineplus">+   * @param {Object} data                       An object with members of the recurrence</span>
<a href="#l1.6831"></a><span id="l1.6831" class="difflineplus">+   * @param {ICAL.Recur.frequencyValues} freq   The frequency value</span>
<a href="#l1.6832"></a><span id="l1.6832" class="difflineplus">+   * @param {Number=} data.interval             The INTERVAL value</span>
<a href="#l1.6833"></a><span id="l1.6833" class="difflineplus">+   * @param {ICAL.Time.weekDay=} data.wkst      The week start value</span>
<a href="#l1.6834"></a><span id="l1.6834" class="difflineplus">+   * @param {ICAL.Time=} data.until             The end of the recurrence set</span>
<a href="#l1.6835"></a><span id="l1.6835" class="difflineplus">+   * @param {Number=} data.count                The number of occurrences</span>
<a href="#l1.6836"></a><span id="l1.6836" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.bysecond     The seconds for the BYSECOND part</span>
<a href="#l1.6837"></a><span id="l1.6837" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.byminute     The minutes for the BYMINUTE part</span>
<a href="#l1.6838"></a><span id="l1.6838" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.byhour       The hours for the BYHOUR part</span>
<a href="#l1.6839"></a><span id="l1.6839" class="difflineplus">+   * @param {Array.&lt;String&gt;=} data.byday        The BYDAY values</span>
<a href="#l1.6840"></a><span id="l1.6840" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.bymonthday   The days for the BYMONTHDAY part</span>
<a href="#l1.6841"></a><span id="l1.6841" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.byyearday    The days for the BYYEARDAY part</span>
<a href="#l1.6842"></a><span id="l1.6842" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.byweekno     The weeks for the BYWEEKNO part</span>
<a href="#l1.6843"></a><span id="l1.6843" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.bymonth      The month for the BYMONTH part</span>
<a href="#l1.6844"></a><span id="l1.6844" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} data.bysetpos     The positionals for the BYSETPOS part</span>
<a href="#l1.6845"></a><span id="l1.6845" class="difflineplus">+   */</span>
<a href="#l1.6846"></a><span id="l1.6846">   ICAL.Recur = function icalrecur(data) {</span>
<a href="#l1.6847"></a><span id="l1.6847">     this.wrappedJSObject = this;</span>
<a href="#l1.6848"></a><span id="l1.6848">     this.parts = {};</span>
<a href="#l1.6849"></a><span id="l1.6849"> </span>
<a href="#l1.6850"></a><span id="l1.6850" class="difflineminus">-    if (typeof(data) === 'object') {</span>
<a href="#l1.6851"></a><span id="l1.6851" class="difflineminus">-      for (var key in data) {</span>
<a href="#l1.6852"></a><span id="l1.6852" class="difflineminus">-        this[key] = data[key];</span>
<a href="#l1.6853"></a><span id="l1.6853" class="difflineminus">-      }</span>
<a href="#l1.6854"></a><span id="l1.6854" class="difflineminus">-</span>
<a href="#l1.6855"></a><span id="l1.6855" class="difflineminus">-      if (this.until &amp;&amp; !(this.until instanceof ICAL.Time)) {</span>
<a href="#l1.6856"></a><span id="l1.6856" class="difflineminus">-        this.until = new ICAL.Time(this.until);</span>
<a href="#l1.6857"></a><span id="l1.6857" class="difflineminus">-      }</span>
<a href="#l1.6858"></a><span id="l1.6858" class="difflineminus">-    }</span>
<a href="#l1.6859"></a><span id="l1.6859" class="difflineminus">-</span>
<a href="#l1.6860"></a><span id="l1.6860" class="difflineminus">-    if (!this.parts) {</span>
<a href="#l1.6861"></a><span id="l1.6861" class="difflineminus">-      this.parts = {};</span>
<a href="#l1.6862"></a><span id="l1.6862" class="difflineplus">+    if (data &amp;&amp; typeof(data) === 'object') {</span>
<a href="#l1.6863"></a><span id="l1.6863" class="difflineplus">+      this.fromData(data);</span>
<a href="#l1.6864"></a><span id="l1.6864">     }</span>
<a href="#l1.6865"></a><span id="l1.6865">   };</span>
<a href="#l1.6866"></a><span id="l1.6866"> </span>
<a href="#l1.6867"></a><span id="l1.6867">   ICAL.Recur.prototype = {</span>
<a href="#l1.6868"></a><span id="l1.6868" class="difflineminus">-</span>
<a href="#l1.6869"></a><span id="l1.6869" class="difflineplus">+    /**</span>
<a href="#l1.6870"></a><span id="l1.6870" class="difflineplus">+     * An object holding the BY-parts of the recurrence rule</span>
<a href="#l1.6871"></a><span id="l1.6871" class="difflineplus">+     * @type {Object}</span>
<a href="#l1.6872"></a><span id="l1.6872" class="difflineplus">+     */</span>
<a href="#l1.6873"></a><span id="l1.6873">     parts: null,</span>
<a href="#l1.6874"></a><span id="l1.6874"> </span>
<a href="#l1.6875"></a><span id="l1.6875" class="difflineplus">+    /**</span>
<a href="#l1.6876"></a><span id="l1.6876" class="difflineplus">+     * The interval value for the recurrence rule.</span>
<a href="#l1.6877"></a><span id="l1.6877" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.6878"></a><span id="l1.6878" class="difflineplus">+     */</span>
<a href="#l1.6879"></a><span id="l1.6879">     interval: 1,</span>
<a href="#l1.6880"></a><span id="l1.6880" class="difflineplus">+</span>
<a href="#l1.6881"></a><span id="l1.6881" class="difflineplus">+    /**</span>
<a href="#l1.6882"></a><span id="l1.6882" class="difflineplus">+     * The week start day</span>
<a href="#l1.6883"></a><span id="l1.6883" class="difflineplus">+     *</span>
<a href="#l1.6884"></a><span id="l1.6884" class="difflineplus">+     * @type {ICAL.Time.weekDay}</span>
<a href="#l1.6885"></a><span id="l1.6885" class="difflineplus">+     * @default ICAL.Time.MONDAY</span>
<a href="#l1.6886"></a><span id="l1.6886" class="difflineplus">+     */</span>
<a href="#l1.6887"></a><span id="l1.6887">     wkst: ICAL.Time.MONDAY,</span>
<a href="#l1.6888"></a><span id="l1.6888" class="difflineplus">+</span>
<a href="#l1.6889"></a><span id="l1.6889" class="difflineplus">+    /**</span>
<a href="#l1.6890"></a><span id="l1.6890" class="difflineplus">+     * The end of the recurrence</span>
<a href="#l1.6891"></a><span id="l1.6891" class="difflineplus">+     * @type {?ICAL.Time}</span>
<a href="#l1.6892"></a><span id="l1.6892" class="difflineplus">+     */</span>
<a href="#l1.6893"></a><span id="l1.6893">     until: null,</span>
<a href="#l1.6894"></a><span id="l1.6894" class="difflineplus">+</span>
<a href="#l1.6895"></a><span id="l1.6895" class="difflineplus">+    /**</span>
<a href="#l1.6896"></a><span id="l1.6896" class="difflineplus">+     * The maximum number of occurrences</span>
<a href="#l1.6897"></a><span id="l1.6897" class="difflineplus">+     * @type {?Number}</span>
<a href="#l1.6898"></a><span id="l1.6898" class="difflineplus">+     */</span>
<a href="#l1.6899"></a><span id="l1.6899">     count: null,</span>
<a href="#l1.6900"></a><span id="l1.6900" class="difflineplus">+</span>
<a href="#l1.6901"></a><span id="l1.6901" class="difflineplus">+    /**</span>
<a href="#l1.6902"></a><span id="l1.6902" class="difflineplus">+     * The frequency value.</span>
<a href="#l1.6903"></a><span id="l1.6903" class="difflineplus">+     * @type {ICAL.Recur.frequencyValues}</span>
<a href="#l1.6904"></a><span id="l1.6904" class="difflineplus">+     */</span>
<a href="#l1.6905"></a><span id="l1.6905">     freq: null,</span>
<a href="#l1.6906"></a><span id="l1.6906" class="difflineplus">+</span>
<a href="#l1.6907"></a><span id="l1.6907" class="difflineplus">+    /**</span>
<a href="#l1.6908"></a><span id="l1.6908" class="difflineplus">+     * The class identifier.</span>
<a href="#l1.6909"></a><span id="l1.6909" class="difflineplus">+     * @constant</span>
<a href="#l1.6910"></a><span id="l1.6910" class="difflineplus">+     * @type {String}</span>
<a href="#l1.6911"></a><span id="l1.6911" class="difflineplus">+     * @default &quot;icalrecur&quot;</span>
<a href="#l1.6912"></a><span id="l1.6912" class="difflineplus">+     */</span>
<a href="#l1.6913"></a><span id="l1.6913">     icalclass: &quot;icalrecur&quot;,</span>
<a href="#l1.6914"></a><span id="l1.6914" class="difflineplus">+</span>
<a href="#l1.6915"></a><span id="l1.6915" class="difflineplus">+    /**</span>
<a href="#l1.6916"></a><span id="l1.6916" class="difflineplus">+     * The type name, to be used in the jCal object.</span>
<a href="#l1.6917"></a><span id="l1.6917" class="difflineplus">+     * @constant</span>
<a href="#l1.6918"></a><span id="l1.6918" class="difflineplus">+     * @type {String}</span>
<a href="#l1.6919"></a><span id="l1.6919" class="difflineplus">+     * @default &quot;recur&quot;</span>
<a href="#l1.6920"></a><span id="l1.6920" class="difflineplus">+     */</span>
<a href="#l1.6921"></a><span id="l1.6921">     icaltype: &quot;recur&quot;,</span>
<a href="#l1.6922"></a><span id="l1.6922"> </span>
<a href="#l1.6923"></a><span id="l1.6923" class="difflineplus">+    /**</span>
<a href="#l1.6924"></a><span id="l1.6924" class="difflineplus">+     * Create a new iterator for this recurrence rule. The passed start date</span>
<a href="#l1.6925"></a><span id="l1.6925" class="difflineplus">+     * must be the start date of the event, not the start of the range to</span>
<a href="#l1.6926"></a><span id="l1.6926" class="difflineplus">+     * search in.</span>
<a href="#l1.6927"></a><span id="l1.6927" class="difflineplus">+     *</span>
<a href="#l1.6928"></a><span id="l1.6928" class="difflineplus">+     * @example</span>
<a href="#l1.6929"></a><span id="l1.6929" class="difflineplus">+     * var recur = comp.getFirstPropertyValue('rrule');</span>
<a href="#l1.6930"></a><span id="l1.6930" class="difflineplus">+     * var dtstart = comp.getFirstPropertyValue('dtstart');</span>
<a href="#l1.6931"></a><span id="l1.6931" class="difflineplus">+     * var iter = recur.iterator(dtstart);</span>
<a href="#l1.6932"></a><span id="l1.6932" class="difflineplus">+     * for (var next = iter.next(); next; next = iter.next()) {</span>
<a href="#l1.6933"></a><span id="l1.6933" class="difflineplus">+     *   if (next.compare(rangeStart) &lt; 0) {</span>
<a href="#l1.6934"></a><span id="l1.6934" class="difflineplus">+     *     continue;</span>
<a href="#l1.6935"></a><span id="l1.6935" class="difflineplus">+     *   }</span>
<a href="#l1.6936"></a><span id="l1.6936" class="difflineplus">+     *   console.log(next.toString());</span>
<a href="#l1.6937"></a><span id="l1.6937" class="difflineplus">+     * }</span>
<a href="#l1.6938"></a><span id="l1.6938" class="difflineplus">+     *</span>
<a href="#l1.6939"></a><span id="l1.6939" class="difflineplus">+     * @param {ICAL.Time} aStart        The item's start date</span>
<a href="#l1.6940"></a><span id="l1.6940" class="difflineplus">+     * @return {ICAL.RecurIterator}     The recurrence iterator</span>
<a href="#l1.6941"></a><span id="l1.6941" class="difflineplus">+     */</span>
<a href="#l1.6942"></a><span id="l1.6942">     iterator: function(aStart) {</span>
<a href="#l1.6943"></a><span id="l1.6943">       return new ICAL.RecurIterator({</span>
<a href="#l1.6944"></a><span id="l1.6944">         rule: this,</span>
<a href="#l1.6945"></a><span id="l1.6945">         dtstart: aStart</span>
<a href="#l1.6946"></a><span id="l1.6946">       });</span>
<a href="#l1.6947"></a><span id="l1.6947">     },</span>
<a href="#l1.6948"></a><span id="l1.6948"> </span>
<a href="#l1.6949"></a><span id="l1.6949" class="difflineplus">+    /**</span>
<a href="#l1.6950"></a><span id="l1.6950" class="difflineplus">+     * Returns a clone of the recurrence object.</span>
<a href="#l1.6951"></a><span id="l1.6951" class="difflineplus">+     *</span>
<a href="#l1.6952"></a><span id="l1.6952" class="difflineplus">+     * @return {ICAL.Recur}      The cloned object</span>
<a href="#l1.6953"></a><span id="l1.6953" class="difflineplus">+     */</span>
<a href="#l1.6954"></a><span id="l1.6954">     clone: function clone() {</span>
<a href="#l1.6955"></a><span id="l1.6955">       return new ICAL.Recur(this.toJSON());</span>
<a href="#l1.6956"></a><span id="l1.6956">     },</span>
<a href="#l1.6957"></a><span id="l1.6957"> </span>
<a href="#l1.6958"></a><span id="l1.6958" class="difflineplus">+    /**</span>
<a href="#l1.6959"></a><span id="l1.6959" class="difflineplus">+     * Checks if the current rule is finite, i.e. has a count or until part.</span>
<a href="#l1.6960"></a><span id="l1.6960" class="difflineplus">+     *</span>
<a href="#l1.6961"></a><span id="l1.6961" class="difflineplus">+     * @return {Boolean}        True, if the rule is finite</span>
<a href="#l1.6962"></a><span id="l1.6962" class="difflineplus">+     */</span>
<a href="#l1.6963"></a><span id="l1.6963">     isFinite: function isfinite() {</span>
<a href="#l1.6964"></a><span id="l1.6964">       return !!(this.count || this.until);</span>
<a href="#l1.6965"></a><span id="l1.6965">     },</span>
<a href="#l1.6966"></a><span id="l1.6966"> </span>
<a href="#l1.6967"></a><span id="l1.6967" class="difflineplus">+    /**</span>
<a href="#l1.6968"></a><span id="l1.6968" class="difflineplus">+     * Checks if the current rule has a count part, and not limited by an until</span>
<a href="#l1.6969"></a><span id="l1.6969" class="difflineplus">+     * part.</span>
<a href="#l1.6970"></a><span id="l1.6970" class="difflineplus">+     *</span>
<a href="#l1.6971"></a><span id="l1.6971" class="difflineplus">+     * @return {Boolean}        True, if the rule is by count</span>
<a href="#l1.6972"></a><span id="l1.6972" class="difflineplus">+     */</span>
<a href="#l1.6973"></a><span id="l1.6973">     isByCount: function isbycount() {</span>
<a href="#l1.6974"></a><span id="l1.6974">       return !!(this.count &amp;&amp; !this.until);</span>
<a href="#l1.6975"></a><span id="l1.6975">     },</span>
<a href="#l1.6976"></a><span id="l1.6976"> </span>
<a href="#l1.6977"></a><span id="l1.6977" class="difflineplus">+    /**</span>
<a href="#l1.6978"></a><span id="l1.6978" class="difflineplus">+     * Adds a component (part) to the recurrence rule. This is not a component</span>
<a href="#l1.6979"></a><span id="l1.6979" class="difflineplus">+     * in the sense of {@link ICAL.Component}, but a part of the recurrence</span>
<a href="#l1.6980"></a><span id="l1.6980" class="difflineplus">+     * rule, i.e. BYMONTH.</span>
<a href="#l1.6981"></a><span id="l1.6981" class="difflineplus">+     *</span>
<a href="#l1.6982"></a><span id="l1.6982" class="difflineplus">+     * @param {String} aType            The name of the component part</span>
<a href="#l1.6983"></a><span id="l1.6983" class="difflineplus">+     * @param {Array|String} aValue     The component value</span>
<a href="#l1.6984"></a><span id="l1.6984" class="difflineplus">+     */</span>
<a href="#l1.6985"></a><span id="l1.6985">     addComponent: function addPart(aType, aValue) {</span>
<a href="#l1.6986"></a><span id="l1.6986" class="difflineminus">-      if (!(aType in this.parts)) {</span>
<a href="#l1.6987"></a><span id="l1.6987" class="difflineminus">-        this.parts[aType] = [aValue];</span>
<a href="#l1.6988"></a><span id="l1.6988" class="difflineplus">+      var ucname = aType.toUpperCase();</span>
<a href="#l1.6989"></a><span id="l1.6989" class="difflineplus">+      if (ucname in this.parts) {</span>
<a href="#l1.6990"></a><span id="l1.6990" class="difflineplus">+        this.parts[ucname].push(aValue);</span>
<a href="#l1.6991"></a><span id="l1.6991">       } else {</span>
<a href="#l1.6992"></a><span id="l1.6992" class="difflineminus">-        this.parts[aType].push(aValue);</span>
<a href="#l1.6993"></a><span id="l1.6993" class="difflineminus">-      }</span>
<a href="#l1.6994"></a><span id="l1.6994" class="difflineminus">-    },</span>
<a href="#l1.6995"></a><span id="l1.6995" class="difflineminus">-</span>
<a href="#l1.6996"></a><span id="l1.6996" class="difflineplus">+        this.parts[ucname] = [aValue];</span>
<a href="#l1.6997"></a><span id="l1.6997" class="difflineplus">+      }</span>
<a href="#l1.6998"></a><span id="l1.6998" class="difflineplus">+    },</span>
<a href="#l1.6999"></a><span id="l1.6999" class="difflineplus">+</span>
<a href="#l1.7000"></a><span id="l1.7000" class="difflineplus">+    /**</span>
<a href="#l1.7001"></a><span id="l1.7001" class="difflineplus">+     * Sets the component value for the given by-part.</span>
<a href="#l1.7002"></a><span id="l1.7002" class="difflineplus">+     *</span>
<a href="#l1.7003"></a><span id="l1.7003" class="difflineplus">+     * @param {String} aType        The component part name</span>
<a href="#l1.7004"></a><span id="l1.7004" class="difflineplus">+     * @param {Array} aValues       The component values</span>
<a href="#l1.7005"></a><span id="l1.7005" class="difflineplus">+     */</span>
<a href="#l1.7006"></a><span id="l1.7006">     setComponent: function setComponent(aType, aValues) {</span>
<a href="#l1.7007"></a><span id="l1.7007" class="difflineminus">-      this.parts[aType] = aValues.slice();</span>
<a href="#l1.7008"></a><span id="l1.7008" class="difflineminus">-    },</span>
<a href="#l1.7009"></a><span id="l1.7009" class="difflineminus">-</span>
<a href="#l1.7010"></a><span id="l1.7010" class="difflineminus">-    getComponent: function getComponent(aType, aCount) {</span>
<a href="#l1.7011"></a><span id="l1.7011" class="difflineminus">-      var ucName = aType.toUpperCase();</span>
<a href="#l1.7012"></a><span id="l1.7012" class="difflineminus">-      var components = (ucName in this.parts ? this.parts[ucName] : []);</span>
<a href="#l1.7013"></a><span id="l1.7013" class="difflineminus">-</span>
<a href="#l1.7014"></a><span id="l1.7014" class="difflineminus">-      if (aCount) aCount.value = components.length;</span>
<a href="#l1.7015"></a><span id="l1.7015" class="difflineminus">-      return components.slice();</span>
<a href="#l1.7016"></a><span id="l1.7016" class="difflineminus">-    },</span>
<a href="#l1.7017"></a><span id="l1.7017" class="difflineminus">-</span>
<a href="#l1.7018"></a><span id="l1.7018" class="difflineplus">+      this.parts[aType.toUpperCase()] = aValues.slice();</span>
<a href="#l1.7019"></a><span id="l1.7019" class="difflineplus">+    },</span>
<a href="#l1.7020"></a><span id="l1.7020" class="difflineplus">+</span>
<a href="#l1.7021"></a><span id="l1.7021" class="difflineplus">+    /**</span>
<a href="#l1.7022"></a><span id="l1.7022" class="difflineplus">+     * Gets (a copy) of the requested component value.</span>
<a href="#l1.7023"></a><span id="l1.7023" class="difflineplus">+     *</span>
<a href="#l1.7024"></a><span id="l1.7024" class="difflineplus">+     * @param {String} aType        The component part name</span>
<a href="#l1.7025"></a><span id="l1.7025" class="difflineplus">+     * @return {Array}              The component part value</span>
<a href="#l1.7026"></a><span id="l1.7026" class="difflineplus">+     */</span>
<a href="#l1.7027"></a><span id="l1.7027" class="difflineplus">+    getComponent: function getComponent(aType) {</span>
<a href="#l1.7028"></a><span id="l1.7028" class="difflineplus">+      var ucname = aType.toUpperCase();</span>
<a href="#l1.7029"></a><span id="l1.7029" class="difflineplus">+      return (ucname in this.parts ? this.parts[ucname].slice() : []);</span>
<a href="#l1.7030"></a><span id="l1.7030" class="difflineplus">+    },</span>
<a href="#l1.7031"></a><span id="l1.7031" class="difflineplus">+</span>
<a href="#l1.7032"></a><span id="l1.7032" class="difflineplus">+    /**</span>
<a href="#l1.7033"></a><span id="l1.7033" class="difflineplus">+     * Retrieves the next occurrence after the given recurrence id. See the</span>
<a href="#l1.7034"></a><span id="l1.7034" class="difflineplus">+     * guide on {@tutorial terminology} for more details.</span>
<a href="#l1.7035"></a><span id="l1.7035" class="difflineplus">+     *</span>
<a href="#l1.7036"></a><span id="l1.7036" class="difflineplus">+     * NOTE: Currently, this method iterates all occurrences from the start</span>
<a href="#l1.7037"></a><span id="l1.7037" class="difflineplus">+     * date. It should not be called in a loop for performance reasons. If you</span>
<a href="#l1.7038"></a><span id="l1.7038" class="difflineplus">+     * would like to get more than one occurrence, you can iterate the</span>
<a href="#l1.7039"></a><span id="l1.7039" class="difflineplus">+     * occurrences manually, see the example on the</span>
<a href="#l1.7040"></a><span id="l1.7040" class="difflineplus">+     * {@link ICAL.Recur#iterator iterator} method.</span>
<a href="#l1.7041"></a><span id="l1.7041" class="difflineplus">+     *</span>
<a href="#l1.7042"></a><span id="l1.7042" class="difflineplus">+     * @param {ICAL.Time} aStartTime        The start of the event series</span>
<a href="#l1.7043"></a><span id="l1.7043" class="difflineplus">+     * @param {ICAL.Time} aRecurrenceId     The date of the last occurrence</span>
<a href="#l1.7044"></a><span id="l1.7044" class="difflineplus">+     * @return {ICAL.Time}                  The next occurrence after</span>
<a href="#l1.7045"></a><span id="l1.7045" class="difflineplus">+     */</span>
<a href="#l1.7046"></a><span id="l1.7046">     getNextOccurrence: function getNextOccurrence(aStartTime, aRecurrenceId) {</span>
<a href="#l1.7047"></a><span id="l1.7047">       var iter = this.iterator(aStartTime);</span>
<a href="#l1.7048"></a><span id="l1.7048">       var next, cdt;</span>
<a href="#l1.7049"></a><span id="l1.7049"> </span>
<a href="#l1.7050"></a><span id="l1.7050">       do {</span>
<a href="#l1.7051"></a><span id="l1.7051">         next = iter.next();</span>
<a href="#l1.7052"></a><span id="l1.7052">       } while (next &amp;&amp; next.compare(aRecurrenceId) &lt;= 0);</span>
<a href="#l1.7053"></a><span id="l1.7053"> </span>
<a href="#l1.7054"></a><span id="l1.7054">       if (next &amp;&amp; aRecurrenceId.zone) {</span>
<a href="#l1.7055"></a><span id="l1.7055">         next.zone = aRecurrenceId.zone;</span>
<a href="#l1.7056"></a><span id="l1.7056">       }</span>
<a href="#l1.7057"></a><span id="l1.7057"> </span>
<a href="#l1.7058"></a><span id="l1.7058">       return next;</span>
<a href="#l1.7059"></a><span id="l1.7059">     },</span>
<a href="#l1.7060"></a><span id="l1.7060"> </span>
<a href="#l1.7061"></a><span id="l1.7061" class="difflineplus">+    /**</span>
<a href="#l1.7062"></a><span id="l1.7062" class="difflineplus">+     * Sets up the current instance using members from the passed data object.</span>
<a href="#l1.7063"></a><span id="l1.7063" class="difflineplus">+     *</span>
<a href="#l1.7064"></a><span id="l1.7064" class="difflineplus">+     * @param {Object} data                       An object with members of the recurrence</span>
<a href="#l1.7065"></a><span id="l1.7065" class="difflineplus">+     * @param {ICAL.Recur.frequencyValues} freq   The frequency value</span>
<a href="#l1.7066"></a><span id="l1.7066" class="difflineplus">+     * @param {Number=} data.interval             The INTERVAL value</span>
<a href="#l1.7067"></a><span id="l1.7067" class="difflineplus">+     * @param {ICAL.Time.weekDay=} data.wkst      The week start value</span>
<a href="#l1.7068"></a><span id="l1.7068" class="difflineplus">+     * @param {ICAL.Time=} data.until             The end of the recurrence set</span>
<a href="#l1.7069"></a><span id="l1.7069" class="difflineplus">+     * @param {Number=} data.count                The number of occurrences</span>
<a href="#l1.7070"></a><span id="l1.7070" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.bysecond     The seconds for the BYSECOND part</span>
<a href="#l1.7071"></a><span id="l1.7071" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.byminute     The minutes for the BYMINUTE part</span>
<a href="#l1.7072"></a><span id="l1.7072" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.byhour       The hours for the BYHOUR part</span>
<a href="#l1.7073"></a><span id="l1.7073" class="difflineplus">+     * @param {Array.&lt;String&gt;=} data.byday        The BYDAY values</span>
<a href="#l1.7074"></a><span id="l1.7074" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.bymonthday   The days for the BYMONTHDAY part</span>
<a href="#l1.7075"></a><span id="l1.7075" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.byyearday    The days for the BYYEARDAY part</span>
<a href="#l1.7076"></a><span id="l1.7076" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.byweekno     The weeks for the BYWEEKNO part</span>
<a href="#l1.7077"></a><span id="l1.7077" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.bymonth      The month for the BYMONTH part</span>
<a href="#l1.7078"></a><span id="l1.7078" class="difflineplus">+     * @param {Array.&lt;Number&gt;=} data.bysetpos     The positionals for the BYSETPOS part</span>
<a href="#l1.7079"></a><span id="l1.7079" class="difflineplus">+     */</span>
<a href="#l1.7080"></a><span id="l1.7080" class="difflineplus">+    fromData: function(data) {</span>
<a href="#l1.7081"></a><span id="l1.7081" class="difflineplus">+      for (var key in data) {</span>
<a href="#l1.7082"></a><span id="l1.7082" class="difflineplus">+        var uckey = key.toUpperCase();</span>
<a href="#l1.7083"></a><span id="l1.7083" class="difflineplus">+</span>
<a href="#l1.7084"></a><span id="l1.7084" class="difflineplus">+        if (uckey in partDesign) {</span>
<a href="#l1.7085"></a><span id="l1.7085" class="difflineplus">+          if (Array.isArray(data[key])) {</span>
<a href="#l1.7086"></a><span id="l1.7086" class="difflineplus">+            this.parts[uckey] = data[key];</span>
<a href="#l1.7087"></a><span id="l1.7087" class="difflineplus">+          } else {</span>
<a href="#l1.7088"></a><span id="l1.7088" class="difflineplus">+            this.parts[uckey] = [data[key]];</span>
<a href="#l1.7089"></a><span id="l1.7089" class="difflineplus">+          }</span>
<a href="#l1.7090"></a><span id="l1.7090" class="difflineplus">+        } else {</span>
<a href="#l1.7091"></a><span id="l1.7091" class="difflineplus">+          this[key] = data[key];</span>
<a href="#l1.7092"></a><span id="l1.7092" class="difflineplus">+        }</span>
<a href="#l1.7093"></a><span id="l1.7093" class="difflineplus">+      }</span>
<a href="#l1.7094"></a><span id="l1.7094" class="difflineplus">+</span>
<a href="#l1.7095"></a><span id="l1.7095" class="difflineplus">+      if (this.wkst &amp;&amp; typeof this.wkst != &quot;number&quot;) {</span>
<a href="#l1.7096"></a><span id="l1.7096" class="difflineplus">+        this.wkst = ICAL.Recur.icalDayToNumericDay(this.wkst);</span>
<a href="#l1.7097"></a><span id="l1.7097" class="difflineplus">+      }</span>
<a href="#l1.7098"></a><span id="l1.7098" class="difflineplus">+</span>
<a href="#l1.7099"></a><span id="l1.7099" class="difflineplus">+      if (this.until &amp;&amp; !(this.until instanceof ICAL.Time)) {</span>
<a href="#l1.7100"></a><span id="l1.7100" class="difflineplus">+        this.until = ICAL.Time.fromString(this.until);</span>
<a href="#l1.7101"></a><span id="l1.7101" class="difflineplus">+      }</span>
<a href="#l1.7102"></a><span id="l1.7102" class="difflineplus">+    },</span>
<a href="#l1.7103"></a><span id="l1.7103" class="difflineplus">+</span>
<a href="#l1.7104"></a><span id="l1.7104" class="difflineplus">+    /**</span>
<a href="#l1.7105"></a><span id="l1.7105" class="difflineplus">+     * The jCal representation of this recurrence type.</span>
<a href="#l1.7106"></a><span id="l1.7106" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.7107"></a><span id="l1.7107" class="difflineplus">+     */</span>
<a href="#l1.7108"></a><span id="l1.7108">     toJSON: function() {</span>
<a href="#l1.7109"></a><span id="l1.7109" class="difflineminus">-      //XXX: extract this list up to proto?</span>
<a href="#l1.7110"></a><span id="l1.7110" class="difflineminus">-      var propsToCopy = [</span>
<a href="#l1.7111"></a><span id="l1.7111" class="difflineminus">-        &quot;freq&quot;,</span>
<a href="#l1.7112"></a><span id="l1.7112" class="difflineminus">-        &quot;count&quot;,</span>
<a href="#l1.7113"></a><span id="l1.7113" class="difflineminus">-        &quot;until&quot;,</span>
<a href="#l1.7114"></a><span id="l1.7114" class="difflineminus">-        &quot;wkst&quot;,</span>
<a href="#l1.7115"></a><span id="l1.7115" class="difflineminus">-        &quot;interval&quot;,</span>
<a href="#l1.7116"></a><span id="l1.7116" class="difflineminus">-        &quot;parts&quot;</span>
<a href="#l1.7117"></a><span id="l1.7117" class="difflineminus">-      ];</span>
<a href="#l1.7118"></a><span id="l1.7118" class="difflineminus">-</span>
<a href="#l1.7119"></a><span id="l1.7119" class="difflineminus">-      var result = Object.create(null);</span>
<a href="#l1.7120"></a><span id="l1.7120" class="difflineminus">-</span>
<a href="#l1.7121"></a><span id="l1.7121" class="difflineminus">-      var i = 0;</span>
<a href="#l1.7122"></a><span id="l1.7122" class="difflineminus">-      var len = propsToCopy.length;</span>
<a href="#l1.7123"></a><span id="l1.7123" class="difflineminus">-      var prop;</span>
<a href="#l1.7124"></a><span id="l1.7124" class="difflineminus">-</span>
<a href="#l1.7125"></a><span id="l1.7125" class="difflineminus">-      for (; i &lt; len; i++) {</span>
<a href="#l1.7126"></a><span id="l1.7126" class="difflineminus">-        var prop = propsToCopy[i];</span>
<a href="#l1.7127"></a><span id="l1.7127" class="difflineminus">-        result[prop] = this[prop];</span>
<a href="#l1.7128"></a><span id="l1.7128" class="difflineminus">-      }</span>
<a href="#l1.7129"></a><span id="l1.7129" class="difflineminus">-</span>
<a href="#l1.7130"></a><span id="l1.7130" class="difflineminus">-      if (result.until instanceof ICAL.Time) {</span>
<a href="#l1.7131"></a><span id="l1.7131" class="difflineminus">-        result.until = result.until.toJSON();</span>
<a href="#l1.7132"></a><span id="l1.7132" class="difflineminus">-      }</span>
<a href="#l1.7133"></a><span id="l1.7133" class="difflineminus">-</span>
<a href="#l1.7134"></a><span id="l1.7134" class="difflineminus">-      return result;</span>
<a href="#l1.7135"></a><span id="l1.7135" class="difflineminus">-    },</span>
<a href="#l1.7136"></a><span id="l1.7136" class="difflineminus">-</span>
<a href="#l1.7137"></a><span id="l1.7137" class="difflineplus">+      var res = Object.create(null);</span>
<a href="#l1.7138"></a><span id="l1.7138" class="difflineplus">+      res.freq = this.freq;</span>
<a href="#l1.7139"></a><span id="l1.7139" class="difflineplus">+</span>
<a href="#l1.7140"></a><span id="l1.7140" class="difflineplus">+      if (this.count) {</span>
<a href="#l1.7141"></a><span id="l1.7141" class="difflineplus">+        res.count = this.count;</span>
<a href="#l1.7142"></a><span id="l1.7142" class="difflineplus">+      }</span>
<a href="#l1.7143"></a><span id="l1.7143" class="difflineplus">+</span>
<a href="#l1.7144"></a><span id="l1.7144" class="difflineplus">+      if (this.interval &gt; 1) {</span>
<a href="#l1.7145"></a><span id="l1.7145" class="difflineplus">+        res.interval = this.interval;</span>
<a href="#l1.7146"></a><span id="l1.7146" class="difflineplus">+      }</span>
<a href="#l1.7147"></a><span id="l1.7147" class="difflineplus">+</span>
<a href="#l1.7148"></a><span id="l1.7148" class="difflineplus">+      for (var k in this.parts) {</span>
<a href="#l1.7149"></a><span id="l1.7149" class="difflineplus">+        /* istanbul ignore if */</span>
<a href="#l1.7150"></a><span id="l1.7150" class="difflineplus">+        if (!this.parts.hasOwnProperty(k)) {</span>
<a href="#l1.7151"></a><span id="l1.7151" class="difflineplus">+          continue;</span>
<a href="#l1.7152"></a><span id="l1.7152" class="difflineplus">+        }</span>
<a href="#l1.7153"></a><span id="l1.7153" class="difflineplus">+        var kparts = this.parts[k];</span>
<a href="#l1.7154"></a><span id="l1.7154" class="difflineplus">+        if (Array.isArray(kparts) &amp;&amp; kparts.length == 1) {</span>
<a href="#l1.7155"></a><span id="l1.7155" class="difflineplus">+          res[k.toLowerCase()] = kparts[0];</span>
<a href="#l1.7156"></a><span id="l1.7156" class="difflineplus">+        } else {</span>
<a href="#l1.7157"></a><span id="l1.7157" class="difflineplus">+          res[k.toLowerCase()] = ICAL.helpers.clone(this.parts[k]);</span>
<a href="#l1.7158"></a><span id="l1.7158" class="difflineplus">+        }</span>
<a href="#l1.7159"></a><span id="l1.7159" class="difflineplus">+      }</span>
<a href="#l1.7160"></a><span id="l1.7160" class="difflineplus">+</span>
<a href="#l1.7161"></a><span id="l1.7161" class="difflineplus">+      if (this.until) {</span>
<a href="#l1.7162"></a><span id="l1.7162" class="difflineplus">+        res.until = this.until.toString();</span>
<a href="#l1.7163"></a><span id="l1.7163" class="difflineplus">+      }</span>
<a href="#l1.7164"></a><span id="l1.7164" class="difflineplus">+      if ('wkst' in this &amp;&amp; this.wkst !== ICAL.Time.DEFAULT_WEEK_START) {</span>
<a href="#l1.7165"></a><span id="l1.7165" class="difflineplus">+        res.wkst = ICAL.Recur.numericDayToIcalDay(this.wkst);</span>
<a href="#l1.7166"></a><span id="l1.7166" class="difflineplus">+      }</span>
<a href="#l1.7167"></a><span id="l1.7167" class="difflineplus">+      return res;</span>
<a href="#l1.7168"></a><span id="l1.7168" class="difflineplus">+    },</span>
<a href="#l1.7169"></a><span id="l1.7169" class="difflineplus">+</span>
<a href="#l1.7170"></a><span id="l1.7170" class="difflineplus">+    /**</span>
<a href="#l1.7171"></a><span id="l1.7171" class="difflineplus">+     * The string representation of this recurrence rule.</span>
<a href="#l1.7172"></a><span id="l1.7172" class="difflineplus">+     * @return {String}</span>
<a href="#l1.7173"></a><span id="l1.7173" class="difflineplus">+     */</span>
<a href="#l1.7174"></a><span id="l1.7174">     toString: function icalrecur_toString() {</span>
<a href="#l1.7175"></a><span id="l1.7175">       // TODO retain order</span>
<a href="#l1.7176"></a><span id="l1.7176">       var str = &quot;FREQ=&quot; + this.freq;</span>
<a href="#l1.7177"></a><span id="l1.7177">       if (this.count) {</span>
<a href="#l1.7178"></a><span id="l1.7178">         str += &quot;;COUNT=&quot; + this.count;</span>
<a href="#l1.7179"></a><span id="l1.7179">       }</span>
<a href="#l1.7180"></a><span id="l1.7180">       if (this.interval &gt; 1) {</span>
<a href="#l1.7181"></a><span id="l1.7181">         str += &quot;;INTERVAL=&quot; + this.interval;</span>
<a href="#l1.7182"></a><span id="l1.7182">       }</span>
<a href="#l1.7183"></a><span id="l1.7183">       for (var k in this.parts) {</span>
<a href="#l1.7184"></a><span id="l1.7184" class="difflineminus">-        str += &quot;;&quot; + k + &quot;=&quot; + this.parts[k];</span>
<a href="#l1.7185"></a><span id="l1.7185" class="difflineminus">-      }</span>
<a href="#l1.7186"></a><span id="l1.7186" class="difflineminus">-      if (this.until ){</span>
<a href="#l1.7187"></a><span id="l1.7187" class="difflineplus">+        /* istanbul ignore else */</span>
<a href="#l1.7188"></a><span id="l1.7188" class="difflineplus">+        if (this.parts.hasOwnProperty(k)) {</span>
<a href="#l1.7189"></a><span id="l1.7189" class="difflineplus">+          str += &quot;;&quot; + k + &quot;=&quot; + this.parts[k];</span>
<a href="#l1.7190"></a><span id="l1.7190" class="difflineplus">+        }</span>
<a href="#l1.7191"></a><span id="l1.7191" class="difflineplus">+      }</span>
<a href="#l1.7192"></a><span id="l1.7192" class="difflineplus">+      if (this.until) {</span>
<a href="#l1.7193"></a><span id="l1.7193">         str += ';UNTIL=' + this.until.toString();</span>
<a href="#l1.7194"></a><span id="l1.7194">       }</span>
<a href="#l1.7195"></a><span id="l1.7195">       if ('wkst' in this &amp;&amp; this.wkst !== ICAL.Time.DEFAULT_WEEK_START) {</span>
<a href="#l1.7196"></a><span id="l1.7196">         str += ';WKST=' + ICAL.Recur.numericDayToIcalDay(this.wkst);</span>
<a href="#l1.7197"></a><span id="l1.7197">       }</span>
<a href="#l1.7198"></a><span id="l1.7198">       return str;</span>
<a href="#l1.7199"></a><span id="l1.7199">     }</span>
<a href="#l1.7200"></a><span id="l1.7200">   };</span>
<a href="#l1.7201"></a><span id="l1.7201" class="difflineat">@@ -4359,76 +6544,93 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.7202"></a><span id="l1.7202"> </span>
<a href="#l1.7203"></a><span id="l1.7203">     return result;</span>
<a href="#l1.7204"></a><span id="l1.7204">   }</span>
<a href="#l1.7205"></a><span id="l1.7205"> </span>
<a href="#l1.7206"></a><span id="l1.7206">   /**</span>
<a href="#l1.7207"></a><span id="l1.7207">    * Convert an ical representation of a day (SU, MO, etc..)</span>
<a href="#l1.7208"></a><span id="l1.7208">    * into a numeric value of that day.</span>
<a href="#l1.7209"></a><span id="l1.7209">    *</span>
<a href="#l1.7210"></a><span id="l1.7210" class="difflineminus">-   * @param {String} day ical day.</span>
<a href="#l1.7211"></a><span id="l1.7211" class="difflineminus">-   * @return {Numeric} numeric value of given day.</span>
<a href="#l1.7212"></a><span id="l1.7212" class="difflineplus">+   * @param {String} string     The iCalendar day name</span>
<a href="#l1.7213"></a><span id="l1.7213" class="difflineplus">+   * @return {Number}           Numeric value of given day</span>
<a href="#l1.7214"></a><span id="l1.7214">    */</span>
<a href="#l1.7215"></a><span id="l1.7215">   ICAL.Recur.icalDayToNumericDay = function toNumericDay(string) {</span>
<a href="#l1.7216"></a><span id="l1.7216">     //XXX: this is here so we can deal</span>
<a href="#l1.7217"></a><span id="l1.7217">     //     with possibly invalid string values.</span>
<a href="#l1.7218"></a><span id="l1.7218"> </span>
<a href="#l1.7219"></a><span id="l1.7219">     return DOW_MAP[string];</span>
<a href="#l1.7220"></a><span id="l1.7220">   };</span>
<a href="#l1.7221"></a><span id="l1.7221"> </span>
<a href="#l1.7222"></a><span id="l1.7222">   /**</span>
<a href="#l1.7223"></a><span id="l1.7223">    * Convert a numeric day value into its ical representation (SU, MO, etc..)</span>
<a href="#l1.7224"></a><span id="l1.7224">    *</span>
<a href="#l1.7225"></a><span id="l1.7225" class="difflineminus">-   * @param {Numeric} numeric value of given day.</span>
<a href="#l1.7226"></a><span id="l1.7226" class="difflineminus">-   * @return {String} day ical day.</span>
<a href="#l1.7227"></a><span id="l1.7227" class="difflineplus">+   * @param {Number} num        Numeric value of given day</span>
<a href="#l1.7228"></a><span id="l1.7228" class="difflineplus">+   * @return {String}           The ICAL day value, e.g SU,MO,...</span>
<a href="#l1.7229"></a><span id="l1.7229">    */</span>
<a href="#l1.7230"></a><span id="l1.7230">   ICAL.Recur.numericDayToIcalDay = function toIcalDay(num) {</span>
<a href="#l1.7231"></a><span id="l1.7231">     //XXX: this is here so we can deal with possibly invalid number values.</span>
<a href="#l1.7232"></a><span id="l1.7232">     //     Also, this allows consistent mapping between day numbers and day</span>
<a href="#l1.7233"></a><span id="l1.7233">     //     names for external users.</span>
<a href="#l1.7234"></a><span id="l1.7234">     return REVERSE_DOW_MAP[num];</span>
<a href="#l1.7235"></a><span id="l1.7235">   };</span>
<a href="#l1.7236"></a><span id="l1.7236"> </span>
<a href="#l1.7237"></a><span id="l1.7237">   var VALID_DAY_NAMES = /^(SU|MO|TU|WE|TH|FR|SA)$/;</span>
<a href="#l1.7238"></a><span id="l1.7238" class="difflineminus">-  var VALID_BYDAY_PART = /^([+-])?(5[0-3]|[1-4][0-9]|[1-9])?(SU|MO|TU|WE|TH|FR|SA)$/</span>
<a href="#l1.7239"></a><span id="l1.7239" class="difflineplus">+  var VALID_BYDAY_PART = /^([+-])?(5[0-3]|[1-4][0-9]|[1-9])?(SU|MO|TU|WE|TH|FR|SA)$/;</span>
<a href="#l1.7240"></a><span id="l1.7240" class="difflineplus">+</span>
<a href="#l1.7241"></a><span id="l1.7241" class="difflineplus">+  /**</span>
<a href="#l1.7242"></a><span id="l1.7242" class="difflineplus">+   * Possible frequency values for the FREQ part</span>
<a href="#l1.7243"></a><span id="l1.7243" class="difflineplus">+   * (YEARLY, MONTHLY, WEEKLY, DAILY, HOURLY, MINUTELY, SECONDLY)</span>
<a href="#l1.7244"></a><span id="l1.7244" class="difflineplus">+   *</span>
<a href="#l1.7245"></a><span id="l1.7245" class="difflineplus">+   * @typedef {String} frequencyValues</span>
<a href="#l1.7246"></a><span id="l1.7246" class="difflineplus">+   * @memberof ICAL.Recur</span>
<a href="#l1.7247"></a><span id="l1.7247" class="difflineplus">+   */</span>
<a href="#l1.7248"></a><span id="l1.7248" class="difflineplus">+</span>
<a href="#l1.7249"></a><span id="l1.7249">   var ALLOWED_FREQ = ['SECONDLY', 'MINUTELY', 'HOURLY',</span>
<a href="#l1.7250"></a><span id="l1.7250">                       'DAILY', 'WEEKLY', 'MONTHLY', 'YEARLY'];</span>
<a href="#l1.7251"></a><span id="l1.7251"> </span>
<a href="#l1.7252"></a><span id="l1.7252">   var optionDesign = {</span>
<a href="#l1.7253"></a><span id="l1.7253" class="difflineminus">-    FREQ: function(value, dict) {</span>
<a href="#l1.7254"></a><span id="l1.7254" class="difflineplus">+    FREQ: function(value, dict, fmtIcal) {</span>
<a href="#l1.7255"></a><span id="l1.7255">       // yes this is actually equal or faster then regex.</span>
<a href="#l1.7256"></a><span id="l1.7256">       // upside here is we can enumerate the valid values.</span>
<a href="#l1.7257"></a><span id="l1.7257">       if (ALLOWED_FREQ.indexOf(value) !== -1) {</span>
<a href="#l1.7258"></a><span id="l1.7258">         dict.freq = value;</span>
<a href="#l1.7259"></a><span id="l1.7259">       } else {</span>
<a href="#l1.7260"></a><span id="l1.7260">         throw new Error(</span>
<a href="#l1.7261"></a><span id="l1.7261">           'invalid frequency &quot;' + value + '&quot; expected: &quot;' +</span>
<a href="#l1.7262"></a><span id="l1.7262">           ALLOWED_FREQ.join(', ') + '&quot;'</span>
<a href="#l1.7263"></a><span id="l1.7263">         );</span>
<a href="#l1.7264"></a><span id="l1.7264">       }</span>
<a href="#l1.7265"></a><span id="l1.7265">     },</span>
<a href="#l1.7266"></a><span id="l1.7266"> </span>
<a href="#l1.7267"></a><span id="l1.7267" class="difflineminus">-    COUNT: function(value, dict) {</span>
<a href="#l1.7268"></a><span id="l1.7268" class="difflineplus">+    COUNT: function(value, dict, fmtIcal) {</span>
<a href="#l1.7269"></a><span id="l1.7269">       dict.count = ICAL.helpers.strictParseInt(value);</span>
<a href="#l1.7270"></a><span id="l1.7270">     },</span>
<a href="#l1.7271"></a><span id="l1.7271"> </span>
<a href="#l1.7272"></a><span id="l1.7272" class="difflineminus">-    INTERVAL: function(value, dict) {</span>
<a href="#l1.7273"></a><span id="l1.7273" class="difflineplus">+    INTERVAL: function(value, dict, fmtIcal) {</span>
<a href="#l1.7274"></a><span id="l1.7274">       dict.interval = ICAL.helpers.strictParseInt(value);</span>
<a href="#l1.7275"></a><span id="l1.7275">       if (dict.interval &lt; 1) {</span>
<a href="#l1.7276"></a><span id="l1.7276">         // 0 or negative values are not allowed, some engines seem to generate</span>
<a href="#l1.7277"></a><span id="l1.7277">         // it though. Assume 1 instead.</span>
<a href="#l1.7278"></a><span id="l1.7278">         dict.interval = 1;</span>
<a href="#l1.7279"></a><span id="l1.7279">       }</span>
<a href="#l1.7280"></a><span id="l1.7280">     },</span>
<a href="#l1.7281"></a><span id="l1.7281"> </span>
<a href="#l1.7282"></a><span id="l1.7282" class="difflineminus">-    UNTIL: function(value, dict) {</span>
<a href="#l1.7283"></a><span id="l1.7283" class="difflineminus">-      dict.until = ICAL.Time.fromString(value);</span>
<a href="#l1.7284"></a><span id="l1.7284" class="difflineminus">-    },</span>
<a href="#l1.7285"></a><span id="l1.7285" class="difflineminus">-</span>
<a href="#l1.7286"></a><span id="l1.7286" class="difflineminus">-    WKST: function(value, dict) {</span>
<a href="#l1.7287"></a><span id="l1.7287" class="difflineplus">+    UNTIL: function(value, dict, fmtIcal) {</span>
<a href="#l1.7288"></a><span id="l1.7288" class="difflineplus">+      if (fmtIcal) {</span>
<a href="#l1.7289"></a><span id="l1.7289" class="difflineplus">+        if (value.length &gt; 10) {</span>
<a href="#l1.7290"></a><span id="l1.7290" class="difflineplus">+          dict.until = ICAL.design.icalendar.value['date-time'].fromICAL(value);</span>
<a href="#l1.7291"></a><span id="l1.7291" class="difflineplus">+        } else {</span>
<a href="#l1.7292"></a><span id="l1.7292" class="difflineplus">+          dict.until = ICAL.design.icalendar.value.date.fromICAL(value);</span>
<a href="#l1.7293"></a><span id="l1.7293" class="difflineplus">+        }</span>
<a href="#l1.7294"></a><span id="l1.7294" class="difflineplus">+      } else {</span>
<a href="#l1.7295"></a><span id="l1.7295" class="difflineplus">+        dict.until = ICAL.Time.fromString(value);</span>
<a href="#l1.7296"></a><span id="l1.7296" class="difflineplus">+      }</span>
<a href="#l1.7297"></a><span id="l1.7297" class="difflineplus">+    },</span>
<a href="#l1.7298"></a><span id="l1.7298" class="difflineplus">+</span>
<a href="#l1.7299"></a><span id="l1.7299" class="difflineplus">+    WKST: function(value, dict, fmtIcal) {</span>
<a href="#l1.7300"></a><span id="l1.7300">       if (VALID_DAY_NAMES.test(value)) {</span>
<a href="#l1.7301"></a><span id="l1.7301">         dict.wkst = ICAL.Recur.icalDayToNumericDay(value);</span>
<a href="#l1.7302"></a><span id="l1.7302">       } else {</span>
<a href="#l1.7303"></a><span id="l1.7303">         throw new Error('invalid WKST value &quot;' + value + '&quot;');</span>
<a href="#l1.7304"></a><span id="l1.7304">       }</span>
<a href="#l1.7305"></a><span id="l1.7305">     }</span>
<a href="#l1.7306"></a><span id="l1.7306">   };</span>
<a href="#l1.7307"></a><span id="l1.7307"> </span>
<a href="#l1.7308"></a><span id="l1.7308" class="difflineat">@@ -4445,86 +6647,214 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.7309"></a><span id="l1.7309">     },</span>
<a href="#l1.7310"></a><span id="l1.7310">     BYMONTHDAY: parseNumericValue.bind(this, 'BYMONTHDAY', -31, 31),</span>
<a href="#l1.7311"></a><span id="l1.7311">     BYYEARDAY: parseNumericValue.bind(this, 'BYYEARDAY', -366, 366),</span>
<a href="#l1.7312"></a><span id="l1.7312">     BYWEEKNO: parseNumericValue.bind(this, 'BYWEEKNO', -53, 53),</span>
<a href="#l1.7313"></a><span id="l1.7313">     BYMONTH: parseNumericValue.bind(this, 'BYMONTH', 0, 12),</span>
<a href="#l1.7314"></a><span id="l1.7314">     BYSETPOS: parseNumericValue.bind(this, 'BYSETPOS', -366, 366)</span>
<a href="#l1.7315"></a><span id="l1.7315">   };</span>
<a href="#l1.7316"></a><span id="l1.7316"> </span>
<a href="#l1.7317"></a><span id="l1.7317" class="difflineplus">+</span>
<a href="#l1.7318"></a><span id="l1.7318" class="difflineplus">+  /**</span>
<a href="#l1.7319"></a><span id="l1.7319" class="difflineplus">+   * Creates a new {@link ICAL.Recur} instance from the passed string.</span>
<a href="#l1.7320"></a><span id="l1.7320" class="difflineplus">+   *</span>
<a href="#l1.7321"></a><span id="l1.7321" class="difflineplus">+   * @param {String} string         The string to parse</span>
<a href="#l1.7322"></a><span id="l1.7322" class="difflineplus">+   * @return {ICAL.Recur}           The created recurrence instance</span>
<a href="#l1.7323"></a><span id="l1.7323" class="difflineplus">+   */</span>
<a href="#l1.7324"></a><span id="l1.7324">   ICAL.Recur.fromString = function(string) {</span>
<a href="#l1.7325"></a><span id="l1.7325" class="difflineplus">+    var data = ICAL.Recur._stringToData(string, false);</span>
<a href="#l1.7326"></a><span id="l1.7326" class="difflineplus">+    return new ICAL.Recur(data);</span>
<a href="#l1.7327"></a><span id="l1.7327" class="difflineplus">+  };</span>
<a href="#l1.7328"></a><span id="l1.7328" class="difflineplus">+</span>
<a href="#l1.7329"></a><span id="l1.7329" class="difflineplus">+  /**</span>
<a href="#l1.7330"></a><span id="l1.7330" class="difflineplus">+   * Creates a new {@link ICAL.Recur} instance using members from the passed</span>
<a href="#l1.7331"></a><span id="l1.7331" class="difflineplus">+   * data object.</span>
<a href="#l1.7332"></a><span id="l1.7332" class="difflineplus">+   *</span>
<a href="#l1.7333"></a><span id="l1.7333" class="difflineplus">+   * @param {Object} aData                      An object with members of the recurrence</span>
<a href="#l1.7334"></a><span id="l1.7334" class="difflineplus">+   * @param {ICAL.Recur.frequencyValues} freq   The frequency value</span>
<a href="#l1.7335"></a><span id="l1.7335" class="difflineplus">+   * @param {Number=} aData.interval            The INTERVAL value</span>
<a href="#l1.7336"></a><span id="l1.7336" class="difflineplus">+   * @param {ICAL.Time.weekDay=} aData.wkst     The week start value</span>
<a href="#l1.7337"></a><span id="l1.7337" class="difflineplus">+   * @param {ICAL.Time=} aData.until            The end of the recurrence set</span>
<a href="#l1.7338"></a><span id="l1.7338" class="difflineplus">+   * @param {Number=} aData.count               The number of occurrences</span>
<a href="#l1.7339"></a><span id="l1.7339" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.bysecond    The seconds for the BYSECOND part</span>
<a href="#l1.7340"></a><span id="l1.7340" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.byminute    The minutes for the BYMINUTE part</span>
<a href="#l1.7341"></a><span id="l1.7341" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.byhour      The hours for the BYHOUR part</span>
<a href="#l1.7342"></a><span id="l1.7342" class="difflineplus">+   * @param {Array.&lt;String&gt;=} aData.byday       The BYDAY values</span>
<a href="#l1.7343"></a><span id="l1.7343" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.bymonthday  The days for the BYMONTHDAY part</span>
<a href="#l1.7344"></a><span id="l1.7344" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.byyearday   The days for the BYYEARDAY part</span>
<a href="#l1.7345"></a><span id="l1.7345" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.byweekno    The weeks for the BYWEEKNO part</span>
<a href="#l1.7346"></a><span id="l1.7346" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.bymonth     The month for the BYMONTH part</span>
<a href="#l1.7347"></a><span id="l1.7347" class="difflineplus">+   * @param {Array.&lt;Number&gt;=} aData.bysetpos    The positionals for the BYSETPOS part</span>
<a href="#l1.7348"></a><span id="l1.7348" class="difflineplus">+   */</span>
<a href="#l1.7349"></a><span id="l1.7349" class="difflineplus">+  ICAL.Recur.fromData = function(aData) {</span>
<a href="#l1.7350"></a><span id="l1.7350" class="difflineplus">+    return new ICAL.Recur(aData);</span>
<a href="#l1.7351"></a><span id="l1.7351" class="difflineplus">+  };</span>
<a href="#l1.7352"></a><span id="l1.7352" class="difflineplus">+</span>
<a href="#l1.7353"></a><span id="l1.7353" class="difflineplus">+  /**</span>
<a href="#l1.7354"></a><span id="l1.7354" class="difflineplus">+   * Converts a recurrence string to a data object, suitable for the fromData</span>
<a href="#l1.7355"></a><span id="l1.7355" class="difflineplus">+   * method.</span>
<a href="#l1.7356"></a><span id="l1.7356" class="difflineplus">+   *</span>
<a href="#l1.7357"></a><span id="l1.7357" class="difflineplus">+   * @param {String} string     The string to parse</span>
<a href="#l1.7358"></a><span id="l1.7358" class="difflineplus">+   * @param {Boolean} fmtIcal   If true, the string is considered to be an</span>
<a href="#l1.7359"></a><span id="l1.7359" class="difflineplus">+   *                              iCalendar string</span>
<a href="#l1.7360"></a><span id="l1.7360" class="difflineplus">+   * @return {ICAL.Recur}       The recurrence instance</span>
<a href="#l1.7361"></a><span id="l1.7361" class="difflineplus">+   */</span>
<a href="#l1.7362"></a><span id="l1.7362" class="difflineplus">+  ICAL.Recur._stringToData = function(string, fmtIcal) {</span>
<a href="#l1.7363"></a><span id="l1.7363">     var dict = Object.create(null);</span>
<a href="#l1.7364"></a><span id="l1.7364" class="difflineminus">-    var dictParts = dict.parts = Object.create(null);</span>
<a href="#l1.7365"></a><span id="l1.7365"> </span>
<a href="#l1.7366"></a><span id="l1.7366">     // split is slower in FF but fast enough.</span>
<a href="#l1.7367"></a><span id="l1.7367">     // v8 however this is faster then manual split?</span>
<a href="#l1.7368"></a><span id="l1.7368">     var values = string.split(';');</span>
<a href="#l1.7369"></a><span id="l1.7369">     var len = values.length;</span>
<a href="#l1.7370"></a><span id="l1.7370"> </span>
<a href="#l1.7371"></a><span id="l1.7371">     for (var i = 0; i &lt; len; i++) {</span>
<a href="#l1.7372"></a><span id="l1.7372">       var parts = values[i].split('=');</span>
<a href="#l1.7373"></a><span id="l1.7373" class="difflineminus">-      var name = parts[0];</span>
<a href="#l1.7374"></a><span id="l1.7374" class="difflineplus">+      var ucname = parts[0].toUpperCase();</span>
<a href="#l1.7375"></a><span id="l1.7375" class="difflineplus">+      var lcname = parts[0].toLowerCase();</span>
<a href="#l1.7376"></a><span id="l1.7376" class="difflineplus">+      var name = (fmtIcal ? lcname : ucname);</span>
<a href="#l1.7377"></a><span id="l1.7377">       var value = parts[1];</span>
<a href="#l1.7378"></a><span id="l1.7378"> </span>
<a href="#l1.7379"></a><span id="l1.7379" class="difflineminus">-      if (name in partDesign) {</span>
<a href="#l1.7380"></a><span id="l1.7380" class="difflineplus">+      if (ucname in partDesign) {</span>
<a href="#l1.7381"></a><span id="l1.7381">         var partArr = value.split(',');</span>
<a href="#l1.7382"></a><span id="l1.7382">         var partArrIdx = 0;</span>
<a href="#l1.7383"></a><span id="l1.7383">         var partArrLen = partArr.length;</span>
<a href="#l1.7384"></a><span id="l1.7384"> </span>
<a href="#l1.7385"></a><span id="l1.7385">         for (; partArrIdx &lt; partArrLen; partArrIdx++) {</span>
<a href="#l1.7386"></a><span id="l1.7386" class="difflineminus">-          partArr[partArrIdx] = partDesign[name](partArr[partArrIdx]);</span>
<a href="#l1.7387"></a><span id="l1.7387" class="difflineminus">-        }</span>
<a href="#l1.7388"></a><span id="l1.7388" class="difflineminus">-        dictParts[name] = partArr;</span>
<a href="#l1.7389"></a><span id="l1.7389" class="difflineminus">-      } else if (name in optionDesign) {</span>
<a href="#l1.7390"></a><span id="l1.7390" class="difflineminus">-        optionDesign[name](value, dict);</span>
<a href="#l1.7391"></a><span id="l1.7391" class="difflineminus">-      }</span>
<a href="#l1.7392"></a><span id="l1.7392" class="difflineminus">-    }</span>
<a href="#l1.7393"></a><span id="l1.7393" class="difflineminus">-</span>
<a href="#l1.7394"></a><span id="l1.7394" class="difflineminus">-    return new ICAL.Recur(dict);</span>
<a href="#l1.7395"></a><span id="l1.7395" class="difflineplus">+          partArr[partArrIdx] = partDesign[ucname](partArr[partArrIdx]);</span>
<a href="#l1.7396"></a><span id="l1.7396" class="difflineplus">+        }</span>
<a href="#l1.7397"></a><span id="l1.7397" class="difflineplus">+        dict[name] = (partArr.length == 1 ? partArr[0] : partArr);</span>
<a href="#l1.7398"></a><span id="l1.7398" class="difflineplus">+      } else if (ucname in optionDesign) {</span>
<a href="#l1.7399"></a><span id="l1.7399" class="difflineplus">+        optionDesign[ucname](value, dict, fmtIcal);</span>
<a href="#l1.7400"></a><span id="l1.7400" class="difflineplus">+      } else {</span>
<a href="#l1.7401"></a><span id="l1.7401" class="difflineplus">+        // Don't swallow unknown values. Just set them as they are.</span>
<a href="#l1.7402"></a><span id="l1.7402" class="difflineplus">+        dict[lcname] = value;</span>
<a href="#l1.7403"></a><span id="l1.7403" class="difflineplus">+      }</span>
<a href="#l1.7404"></a><span id="l1.7404" class="difflineplus">+    }</span>
<a href="#l1.7405"></a><span id="l1.7405" class="difflineplus">+</span>
<a href="#l1.7406"></a><span id="l1.7406" class="difflineplus">+    return dict;</span>
<a href="#l1.7407"></a><span id="l1.7407">   };</span>
<a href="#l1.7408"></a><span id="l1.7408" class="difflineminus">-</span>
<a href="#l1.7409"></a><span id="l1.7409"> })();</span>
<a href="#l1.7410"></a><span id="l1.7410" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7411"></a><span id="l1.7411" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7412"></a><span id="l1.7412" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.7413"></a><span id="l1.7413" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.7414"></a><span id="l1.7414" class="difflineplus">+</span>
<a href="#l1.7415"></a><span id="l1.7415" class="difflineplus">+</span>
<a href="#l1.7416"></a><span id="l1.7416" class="difflineplus">+/**</span>
<a href="#l1.7417"></a><span id="l1.7417" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.7418"></a><span id="l1.7418" class="difflineplus">+ * @ignore</span>
<a href="#l1.7419"></a><span id="l1.7419" class="difflineplus">+ */</span>
<a href="#l1.7420"></a><span id="l1.7420"> ICAL.RecurIterator = (function() {</span>
<a href="#l1.7421"></a><span id="l1.7421"> </span>
<a href="#l1.7422"></a><span id="l1.7422">   /**</span>
<a href="#l1.7423"></a><span id="l1.7423" class="difflineminus">-   * Options:</span>
<a href="#l1.7424"></a><span id="l1.7424" class="difflineminus">-   *  - rule: (ICAL.Recur) instance</span>
<a href="#l1.7425"></a><span id="l1.7425" class="difflineminus">-   *  - dtstart: (ICAL.Time) start date of recurrence rule</span>
<a href="#l1.7426"></a><span id="l1.7426" class="difflineminus">-   *  - initialized: (Boolean) when true will assume options</span>
<a href="#l1.7427"></a><span id="l1.7427" class="difflineminus">-   *                           are from previously constructed</span>
<a href="#l1.7428"></a><span id="l1.7428" class="difflineminus">-   *                           iterator and will not re-initialize</span>
<a href="#l1.7429"></a><span id="l1.7429" class="difflineminus">-   *                           iterator but resume its state from given data.</span>
<a href="#l1.7430"></a><span id="l1.7430" class="difflineminus">-   *</span>
<a href="#l1.7431"></a><span id="l1.7431" class="difflineminus">-   *  - by_data: (for iterator de-serialization)</span>
<a href="#l1.7432"></a><span id="l1.7432" class="difflineminus">-   *  - days: &quot;</span>
<a href="#l1.7433"></a><span id="l1.7433" class="difflineminus">-   *  - last: &quot;</span>
<a href="#l1.7434"></a><span id="l1.7434" class="difflineminus">-   *  - by_indices: &quot;</span>
<a href="#l1.7435"></a><span id="l1.7435" class="difflineplus">+   * @classdesc</span>
<a href="#l1.7436"></a><span id="l1.7436" class="difflineplus">+   * An iterator for a single recurrence rule. This class usually doesn't have</span>
<a href="#l1.7437"></a><span id="l1.7437" class="difflineplus">+   * to be instanciated directly, the convenience method</span>
<a href="#l1.7438"></a><span id="l1.7438" class="difflineplus">+   * {@link ICAL.Recur#iterator} can be used.</span>
<a href="#l1.7439"></a><span id="l1.7439" class="difflineplus">+   *</span>
<a href="#l1.7440"></a><span id="l1.7440" class="difflineplus">+   * @description</span>
<a href="#l1.7441"></a><span id="l1.7441" class="difflineplus">+   * The options object may contain additional members when resuming iteration from a previous run</span>
<a href="#l1.7442"></a><span id="l1.7442" class="difflineplus">+   *</span>
<a href="#l1.7443"></a><span id="l1.7443" class="difflineplus">+   * @description</span>
<a href="#l1.7444"></a><span id="l1.7444" class="difflineplus">+   * The options object may contain additional members when resuming iteration</span>
<a href="#l1.7445"></a><span id="l1.7445" class="difflineplus">+   * from a previous run.</span>
<a href="#l1.7446"></a><span id="l1.7446" class="difflineplus">+   *</span>
<a href="#l1.7447"></a><span id="l1.7447" class="difflineplus">+   * @class</span>
<a href="#l1.7448"></a><span id="l1.7448" class="difflineplus">+   * @alias ICAL.RecurIterator</span>
<a href="#l1.7449"></a><span id="l1.7449" class="difflineplus">+   * @param {Object} options                The iterator options</span>
<a href="#l1.7450"></a><span id="l1.7450" class="difflineplus">+   * @param {ICAL.Recur} options.rule       The rule to iterate.</span>
<a href="#l1.7451"></a><span id="l1.7451" class="difflineplus">+   * @param {ICAL.Time} options.dtstart     The start date of the event.</span>
<a href="#l1.7452"></a><span id="l1.7452" class="difflineplus">+   * @param {Boolean=} options.initialized  When true, assume that options are</span>
<a href="#l1.7453"></a><span id="l1.7453" class="difflineplus">+   *        from a previously constructed iterator. Initialization will not be</span>
<a href="#l1.7454"></a><span id="l1.7454" class="difflineplus">+   *        repeated.</span>
<a href="#l1.7455"></a><span id="l1.7455">    */</span>
<a href="#l1.7456"></a><span id="l1.7456">   function icalrecur_iterator(options) {</span>
<a href="#l1.7457"></a><span id="l1.7457">     this.fromData(options);</span>
<a href="#l1.7458"></a><span id="l1.7458">   }</span>
<a href="#l1.7459"></a><span id="l1.7459"> </span>
<a href="#l1.7460"></a><span id="l1.7460">   icalrecur_iterator.prototype = {</span>
<a href="#l1.7461"></a><span id="l1.7461"> </span>
<a href="#l1.7462"></a><span id="l1.7462">     /**</span>
<a href="#l1.7463"></a><span id="l1.7463">      * True when iteration is finished.</span>
<a href="#l1.7464"></a><span id="l1.7464" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.7465"></a><span id="l1.7465">      */</span>
<a href="#l1.7466"></a><span id="l1.7466">     completed: false,</span>
<a href="#l1.7467"></a><span id="l1.7467"> </span>
<a href="#l1.7468"></a><span id="l1.7468" class="difflineplus">+    /**</span>
<a href="#l1.7469"></a><span id="l1.7469" class="difflineplus">+     * The rule that is being iterated</span>
<a href="#l1.7470"></a><span id="l1.7470" class="difflineplus">+     * @type {ICAL.Recur}</span>
<a href="#l1.7471"></a><span id="l1.7471" class="difflineplus">+     */</span>
<a href="#l1.7472"></a><span id="l1.7472">     rule: null,</span>
<a href="#l1.7473"></a><span id="l1.7473" class="difflineplus">+</span>
<a href="#l1.7474"></a><span id="l1.7474" class="difflineplus">+    /**</span>
<a href="#l1.7475"></a><span id="l1.7475" class="difflineplus">+     * The start date of the event being iterated.</span>
<a href="#l1.7476"></a><span id="l1.7476" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.7477"></a><span id="l1.7477" class="difflineplus">+     */</span>
<a href="#l1.7478"></a><span id="l1.7478">     dtstart: null,</span>
<a href="#l1.7479"></a><span id="l1.7479" class="difflineplus">+</span>
<a href="#l1.7480"></a><span id="l1.7480" class="difflineplus">+    /**</span>
<a href="#l1.7481"></a><span id="l1.7481" class="difflineplus">+     * The last occurrence that was returned from the</span>
<a href="#l1.7482"></a><span id="l1.7482" class="difflineplus">+     * {@link ICAL.RecurIterator#next} method.</span>
<a href="#l1.7483"></a><span id="l1.7483" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.7484"></a><span id="l1.7484" class="difflineplus">+     */</span>
<a href="#l1.7485"></a><span id="l1.7485">     last: null,</span>
<a href="#l1.7486"></a><span id="l1.7486" class="difflineplus">+</span>
<a href="#l1.7487"></a><span id="l1.7487" class="difflineplus">+    /**</span>
<a href="#l1.7488"></a><span id="l1.7488" class="difflineplus">+     * The sequence number from the occurrence</span>
<a href="#l1.7489"></a><span id="l1.7489" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.7490"></a><span id="l1.7490" class="difflineplus">+     */</span>
<a href="#l1.7491"></a><span id="l1.7491">     occurrence_number: 0,</span>
<a href="#l1.7492"></a><span id="l1.7492" class="difflineplus">+</span>
<a href="#l1.7493"></a><span id="l1.7493" class="difflineplus">+    /**</span>
<a href="#l1.7494"></a><span id="l1.7494" class="difflineplus">+     * The indices used for the {@link ICAL.RecurIterator#by_data} object.</span>
<a href="#l1.7495"></a><span id="l1.7495" class="difflineplus">+     * @type {Object}</span>
<a href="#l1.7496"></a><span id="l1.7496" class="difflineplus">+     * @private</span>
<a href="#l1.7497"></a><span id="l1.7497" class="difflineplus">+     */</span>
<a href="#l1.7498"></a><span id="l1.7498">     by_indices: null,</span>
<a href="#l1.7499"></a><span id="l1.7499" class="difflineplus">+</span>
<a href="#l1.7500"></a><span id="l1.7500" class="difflineplus">+    /**</span>
<a href="#l1.7501"></a><span id="l1.7501" class="difflineplus">+     * If true, the iterator has already been initialized</span>
<a href="#l1.7502"></a><span id="l1.7502" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.7503"></a><span id="l1.7503" class="difflineplus">+     * @private</span>
<a href="#l1.7504"></a><span id="l1.7504" class="difflineplus">+     */</span>
<a href="#l1.7505"></a><span id="l1.7505">     initialized: false,</span>
<a href="#l1.7506"></a><span id="l1.7506" class="difflineplus">+</span>
<a href="#l1.7507"></a><span id="l1.7507" class="difflineplus">+    /**</span>
<a href="#l1.7508"></a><span id="l1.7508" class="difflineplus">+     * The initializd by-data.</span>
<a href="#l1.7509"></a><span id="l1.7509" class="difflineplus">+     * @type {Object}</span>
<a href="#l1.7510"></a><span id="l1.7510" class="difflineplus">+     * @private</span>
<a href="#l1.7511"></a><span id="l1.7511" class="difflineplus">+     */</span>
<a href="#l1.7512"></a><span id="l1.7512">     by_data: null,</span>
<a href="#l1.7513"></a><span id="l1.7513"> </span>
<a href="#l1.7514"></a><span id="l1.7514" class="difflineplus">+    /**</span>
<a href="#l1.7515"></a><span id="l1.7515" class="difflineplus">+     * The expanded yeardays</span>
<a href="#l1.7516"></a><span id="l1.7516" class="difflineplus">+     * @type {Array}</span>
<a href="#l1.7517"></a><span id="l1.7517" class="difflineplus">+     * @private</span>
<a href="#l1.7518"></a><span id="l1.7518" class="difflineplus">+     */</span>
<a href="#l1.7519"></a><span id="l1.7519">     days: null,</span>
<a href="#l1.7520"></a><span id="l1.7520" class="difflineplus">+</span>
<a href="#l1.7521"></a><span id="l1.7521" class="difflineplus">+    /**</span>
<a href="#l1.7522"></a><span id="l1.7522" class="difflineplus">+     * The index in the {@link ICAL.RecurIterator#days} array.</span>
<a href="#l1.7523"></a><span id="l1.7523" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.7524"></a><span id="l1.7524" class="difflineplus">+     * @private</span>
<a href="#l1.7525"></a><span id="l1.7525" class="difflineplus">+     */</span>
<a href="#l1.7526"></a><span id="l1.7526">     days_index: 0,</span>
<a href="#l1.7527"></a><span id="l1.7527"> </span>
<a href="#l1.7528"></a><span id="l1.7528" class="difflineplus">+    /**</span>
<a href="#l1.7529"></a><span id="l1.7529" class="difflineplus">+     * Initialize the recurrence iterator from the passed data object. This</span>
<a href="#l1.7530"></a><span id="l1.7530" class="difflineplus">+     * method is usually not called directly, you can initialize the iterator</span>
<a href="#l1.7531"></a><span id="l1.7531" class="difflineplus">+     * through the constructor.</span>
<a href="#l1.7532"></a><span id="l1.7532" class="difflineplus">+     *</span>
<a href="#l1.7533"></a><span id="l1.7533" class="difflineplus">+     * @param {Object} options                The iterator options</span>
<a href="#l1.7534"></a><span id="l1.7534" class="difflineplus">+     * @param {ICAL.Recur} options.rule       The rule to iterate.</span>
<a href="#l1.7535"></a><span id="l1.7535" class="difflineplus">+     * @param {ICAL.Time} options.dtstart     The start date of the event.</span>
<a href="#l1.7536"></a><span id="l1.7536" class="difflineplus">+     * @param {Boolean=} options.initialized  When true, assume that options are</span>
<a href="#l1.7537"></a><span id="l1.7537" class="difflineplus">+     *        from a previously constructed iterator. Initialization will not be</span>
<a href="#l1.7538"></a><span id="l1.7538" class="difflineplus">+     *        repeated.</span>
<a href="#l1.7539"></a><span id="l1.7539" class="difflineplus">+     */</span>
<a href="#l1.7540"></a><span id="l1.7540">     fromData: function(options) {</span>
<a href="#l1.7541"></a><span id="l1.7541">       this.rule = ICAL.helpers.formatClassType(options.rule, ICAL.Recur);</span>
<a href="#l1.7542"></a><span id="l1.7542"> </span>
<a href="#l1.7543"></a><span id="l1.7543">       if (!this.rule) {</span>
<a href="#l1.7544"></a><span id="l1.7544">         throw new Error('iterator requires a (ICAL.Recur) rule');</span>
<a href="#l1.7545"></a><span id="l1.7545">       }</span>
<a href="#l1.7546"></a><span id="l1.7546"> </span>
<a href="#l1.7547"></a><span id="l1.7547">       this.dtstart = ICAL.helpers.formatClassType(options.dtstart, ICAL.Time);</span>
<a href="#l1.7548"></a><span id="l1.7548" class="difflineat">@@ -4538,17 +6868,19 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7549"></a><span id="l1.7549">       } else {</span>
<a href="#l1.7550"></a><span id="l1.7550">         this.by_data = ICAL.helpers.clone(this.rule.parts, true);</span>
<a href="#l1.7551"></a><span id="l1.7551">       }</span>
<a href="#l1.7552"></a><span id="l1.7552"> </span>
<a href="#l1.7553"></a><span id="l1.7553">       if (options.occurrence_number)</span>
<a href="#l1.7554"></a><span id="l1.7554">         this.occurrence_number = options.occurrence_number;</span>
<a href="#l1.7555"></a><span id="l1.7555"> </span>
<a href="#l1.7556"></a><span id="l1.7556">       this.days = options.days || [];</span>
<a href="#l1.7557"></a><span id="l1.7557" class="difflineminus">-      this.last = ICAL.helpers.formatClassType(options.last, ICAL.Time);</span>
<a href="#l1.7558"></a><span id="l1.7558" class="difflineplus">+      if (options.last) {</span>
<a href="#l1.7559"></a><span id="l1.7559" class="difflineplus">+        this.last = ICAL.helpers.formatClassType(options.last, ICAL.Time);</span>
<a href="#l1.7560"></a><span id="l1.7560" class="difflineplus">+      }</span>
<a href="#l1.7561"></a><span id="l1.7561"> </span>
<a href="#l1.7562"></a><span id="l1.7562">       this.by_indices = options.by_indices;</span>
<a href="#l1.7563"></a><span id="l1.7563"> </span>
<a href="#l1.7564"></a><span id="l1.7564">       if (!this.by_indices) {</span>
<a href="#l1.7565"></a><span id="l1.7565">         this.by_indices = {</span>
<a href="#l1.7566"></a><span id="l1.7566">           &quot;BYSECOND&quot;: 0,</span>
<a href="#l1.7567"></a><span id="l1.7567">           &quot;BYMINUTE&quot;: 0,</span>
<a href="#l1.7568"></a><span id="l1.7568">           &quot;BYHOUR&quot;: 0,</span>
<a href="#l1.7569"></a><span id="l1.7569" class="difflineat">@@ -4561,16 +6893,20 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7570"></a><span id="l1.7570"> </span>
<a href="#l1.7571"></a><span id="l1.7571">       this.initialized = options.initialized || false;</span>
<a href="#l1.7572"></a><span id="l1.7572"> </span>
<a href="#l1.7573"></a><span id="l1.7573">       if (!this.initialized) {</span>
<a href="#l1.7574"></a><span id="l1.7574">         this.init();</span>
<a href="#l1.7575"></a><span id="l1.7575">       }</span>
<a href="#l1.7576"></a><span id="l1.7576">     },</span>
<a href="#l1.7577"></a><span id="l1.7577"> </span>
<a href="#l1.7578"></a><span id="l1.7578" class="difflineplus">+    /**</span>
<a href="#l1.7579"></a><span id="l1.7579" class="difflineplus">+     * Intialize the iterator</span>
<a href="#l1.7580"></a><span id="l1.7580" class="difflineplus">+     * @private</span>
<a href="#l1.7581"></a><span id="l1.7581" class="difflineplus">+     */</span>
<a href="#l1.7582"></a><span id="l1.7582">     init: function icalrecur_iterator_init() {</span>
<a href="#l1.7583"></a><span id="l1.7583">       this.initialized = true;</span>
<a href="#l1.7584"></a><span id="l1.7584">       this.last = this.dtstart.clone();</span>
<a href="#l1.7585"></a><span id="l1.7585">       var parts = this.by_data;</span>
<a href="#l1.7586"></a><span id="l1.7586"> </span>
<a href="#l1.7587"></a><span id="l1.7587">       if (&quot;BYDAY&quot; in parts) {</span>
<a href="#l1.7588"></a><span id="l1.7588">         // libical does this earlier when the rule is loaded, but we postpone to</span>
<a href="#l1.7589"></a><span id="l1.7589">         // now so we can preserve the original order.</span>
<a href="#l1.7590"></a><span id="l1.7590" class="difflineat">@@ -4612,56 +6948,57 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7591"></a><span id="l1.7591">       this.last.second = this.setup_defaults(&quot;BYSECOND&quot;, &quot;SECONDLY&quot;, this.dtstart.second);</span>
<a href="#l1.7592"></a><span id="l1.7592">       this.last.minute = this.setup_defaults(&quot;BYMINUTE&quot;, &quot;MINUTELY&quot;, this.dtstart.minute);</span>
<a href="#l1.7593"></a><span id="l1.7593">       this.last.hour = this.setup_defaults(&quot;BYHOUR&quot;, &quot;HOURLY&quot;, this.dtstart.hour);</span>
<a href="#l1.7594"></a><span id="l1.7594">       this.last.day = this.setup_defaults(&quot;BYMONTHDAY&quot;, &quot;DAILY&quot;, this.dtstart.day);</span>
<a href="#l1.7595"></a><span id="l1.7595">       this.last.month = this.setup_defaults(&quot;BYMONTH&quot;, &quot;MONTHLY&quot;, this.dtstart.month);</span>
<a href="#l1.7596"></a><span id="l1.7596"> </span>
<a href="#l1.7597"></a><span id="l1.7597">       if (this.rule.freq == &quot;WEEKLY&quot;) {</span>
<a href="#l1.7598"></a><span id="l1.7598">         if (&quot;BYDAY&quot; in parts) {</span>
<a href="#l1.7599"></a><span id="l1.7599" class="difflineminus">-          var parts = this.ruleDayOfWeek(parts.BYDAY[0]);</span>
<a href="#l1.7600"></a><span id="l1.7600" class="difflineminus">-          var pos = parts[0];</span>
<a href="#l1.7601"></a><span id="l1.7601" class="difflineminus">-          var rule_dow = parts[1];</span>
<a href="#l1.7602"></a><span id="l1.7602" class="difflineminus">-          var dow = rule_dow - this.last.dayOfWeek();</span>
<a href="#l1.7603"></a><span id="l1.7603" class="difflineminus">-          if ((this.last.dayOfWeek() &lt; rule_dow &amp;&amp; dow &gt;= 0) || dow &lt; 0) {</span>
<a href="#l1.7604"></a><span id="l1.7604" class="difflineplus">+          var bydayParts = this.ruleDayOfWeek(parts.BYDAY[0]);</span>
<a href="#l1.7605"></a><span id="l1.7605" class="difflineplus">+          var pos = bydayParts[0];</span>
<a href="#l1.7606"></a><span id="l1.7606" class="difflineplus">+          var dow = bydayParts[1];</span>
<a href="#l1.7607"></a><span id="l1.7607" class="difflineplus">+          var wkdy = dow - this.last.dayOfWeek();</span>
<a href="#l1.7608"></a><span id="l1.7608" class="difflineplus">+          if ((this.last.dayOfWeek() &lt; dow &amp;&amp; wkdy &gt;= 0) || wkdy &lt; 0) {</span>
<a href="#l1.7609"></a><span id="l1.7609">             // Initial time is after first day of BYDAY data</span>
<a href="#l1.7610"></a><span id="l1.7610" class="difflineminus">-            this.last.day += dow;</span>
<a href="#l1.7611"></a><span id="l1.7611" class="difflineplus">+            this.last.day += wkdy;</span>
<a href="#l1.7612"></a><span id="l1.7612">           }</span>
<a href="#l1.7613"></a><span id="l1.7613">         } else {</span>
<a href="#l1.7614"></a><span id="l1.7614">           var dayName = ICAL.Recur.numericDayToIcalDay(this.dtstart.dayOfWeek());</span>
<a href="#l1.7615"></a><span id="l1.7615">           parts.BYDAY = [dayName];</span>
<a href="#l1.7616"></a><span id="l1.7616">         }</span>
<a href="#l1.7617"></a><span id="l1.7617">       }</span>
<a href="#l1.7618"></a><span id="l1.7618"> </span>
<a href="#l1.7619"></a><span id="l1.7619">       if (this.rule.freq == &quot;YEARLY&quot;) {</span>
<a href="#l1.7620"></a><span id="l1.7620">         for (;;) {</span>
<a href="#l1.7621"></a><span id="l1.7621">           this.expand_year_days(this.last.year);</span>
<a href="#l1.7622"></a><span id="l1.7622">           if (this.days.length &gt; 0) {</span>
<a href="#l1.7623"></a><span id="l1.7623">             break;</span>
<a href="#l1.7624"></a><span id="l1.7624">           }</span>
<a href="#l1.7625"></a><span id="l1.7625">           this.increment_year(this.rule.interval);</span>
<a href="#l1.7626"></a><span id="l1.7626">         }</span>
<a href="#l1.7627"></a><span id="l1.7627"> </span>
<a href="#l1.7628"></a><span id="l1.7628" class="difflineminus">-        var next = ICAL.Time.fromDayOfYear(this.days[0], this.last.year);</span>
<a href="#l1.7629"></a><span id="l1.7629" class="difflineminus">-</span>
<a href="#l1.7630"></a><span id="l1.7630" class="difflineminus">-        this.last.day = next.day;</span>
<a href="#l1.7631"></a><span id="l1.7631" class="difflineminus">-        this.last.month = next.month;</span>
<a href="#l1.7632"></a><span id="l1.7632" class="difflineplus">+        this._nextByYearDay();</span>
<a href="#l1.7633"></a><span id="l1.7633">       }</span>
<a href="#l1.7634"></a><span id="l1.7634"> </span>
<a href="#l1.7635"></a><span id="l1.7635">       if (this.rule.freq == &quot;MONTHLY&quot; &amp;&amp; this.has_by_data(&quot;BYDAY&quot;)) {</span>
<a href="#l1.7636"></a><span id="l1.7636">         var tempLast = null;</span>
<a href="#l1.7637"></a><span id="l1.7637">         var initLast = this.last.clone();</span>
<a href="#l1.7638"></a><span id="l1.7638">         var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l1.7639"></a><span id="l1.7639"> </span>
<a href="#l1.7640"></a><span id="l1.7640">         // Check every weekday in BYDAY with relative dow and pos.</span>
<a href="#l1.7641"></a><span id="l1.7641">         for (var i in this.by_data.BYDAY) {</span>
<a href="#l1.7642"></a><span id="l1.7642" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.7643"></a><span id="l1.7643" class="difflineplus">+          if (!this.by_data.BYDAY.hasOwnProperty(i)) {</span>
<a href="#l1.7644"></a><span id="l1.7644" class="difflineplus">+            continue;</span>
<a href="#l1.7645"></a><span id="l1.7645" class="difflineplus">+          }</span>
<a href="#l1.7646"></a><span id="l1.7646">           this.last = initLast.clone();</span>
<a href="#l1.7647"></a><span id="l1.7647" class="difflineminus">-          var parts = this.ruleDayOfWeek(this.by_data.BYDAY[i]);</span>
<a href="#l1.7648"></a><span id="l1.7648" class="difflineminus">-          var pos = parts[0];</span>
<a href="#l1.7649"></a><span id="l1.7649" class="difflineminus">-          var dow = parts[1];</span>
<a href="#l1.7650"></a><span id="l1.7650" class="difflineplus">+          var bydayParts = this.ruleDayOfWeek(this.by_data.BYDAY[i]);</span>
<a href="#l1.7651"></a><span id="l1.7651" class="difflineplus">+          var pos = bydayParts[0];</span>
<a href="#l1.7652"></a><span id="l1.7652" class="difflineplus">+          var dow = bydayParts[1];</span>
<a href="#l1.7653"></a><span id="l1.7653">           var dayOfMonth = this.last.nthWeekDay(dow, pos);</span>
<a href="#l1.7654"></a><span id="l1.7654"> </span>
<a href="#l1.7655"></a><span id="l1.7655">           // If |pos| &gt;= 6, the byday is invalid for a monthly rule.</span>
<a href="#l1.7656"></a><span id="l1.7656">           if (pos &gt;= 6 || pos &lt;= -6) {</span>
<a href="#l1.7657"></a><span id="l1.7657">             throw new Error(&quot;Malformed values in BYDAY part&quot;);</span>
<a href="#l1.7658"></a><span id="l1.7658">           }</span>
<a href="#l1.7659"></a><span id="l1.7659"> </span>
<a href="#l1.7660"></a><span id="l1.7660">           // If a Byday with pos=+/-5 is not in the current month it</span>
<a href="#l1.7661"></a><span id="l1.7661" class="difflineat">@@ -4702,16 +7039,20 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7662"></a><span id="l1.7662">         if (this.last.day &lt; 0) {</span>
<a href="#l1.7663"></a><span id="l1.7663">           var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l1.7664"></a><span id="l1.7664">           this.last.day = daysInMonth + this.last.day + 1;</span>
<a href="#l1.7665"></a><span id="l1.7665">         }</span>
<a href="#l1.7666"></a><span id="l1.7666">       }</span>
<a href="#l1.7667"></a><span id="l1.7667"> </span>
<a href="#l1.7668"></a><span id="l1.7668">     },</span>
<a href="#l1.7669"></a><span id="l1.7669"> </span>
<a href="#l1.7670"></a><span id="l1.7670" class="difflineplus">+    /**</span>
<a href="#l1.7671"></a><span id="l1.7671" class="difflineplus">+     * Retrieve the next occurrence from the iterator.</span>
<a href="#l1.7672"></a><span id="l1.7672" class="difflineplus">+     * @return {ICAL.Time}</span>
<a href="#l1.7673"></a><span id="l1.7673" class="difflineplus">+     */</span>
<a href="#l1.7674"></a><span id="l1.7674">     next: function icalrecur_iterator_next() {</span>
<a href="#l1.7675"></a><span id="l1.7675">       var before = (this.last ? this.last.clone() : null);</span>
<a href="#l1.7676"></a><span id="l1.7676"> </span>
<a href="#l1.7677"></a><span id="l1.7677">       if ((this.rule.count &amp;&amp; this.occurrence_number &gt;= this.rule.count) ||</span>
<a href="#l1.7678"></a><span id="l1.7678">           (this.rule.until &amp;&amp; this.last.compare(this.rule.until) &gt; 0)) {</span>
<a href="#l1.7679"></a><span id="l1.7679"> </span>
<a href="#l1.7680"></a><span id="l1.7680">         //XXX: right now this is just a flag and has no impact</span>
<a href="#l1.7681"></a><span id="l1.7681">         //     we can simplify the above case to check for completed later.</span>
<a href="#l1.7682"></a><span id="l1.7682" class="difflineat">@@ -4721,18 +7062,20 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7683"></a><span id="l1.7683">       }</span>
<a href="#l1.7684"></a><span id="l1.7684"> </span>
<a href="#l1.7685"></a><span id="l1.7685">       if (this.occurrence_number == 0 &amp;&amp; this.last.compare(this.dtstart) &gt;= 0) {</span>
<a href="#l1.7686"></a><span id="l1.7686">         // First of all, give the instance that was initialized</span>
<a href="#l1.7687"></a><span id="l1.7687">         this.occurrence_number++;</span>
<a href="#l1.7688"></a><span id="l1.7688">         return this.last;</span>
<a href="#l1.7689"></a><span id="l1.7689">       }</span>
<a href="#l1.7690"></a><span id="l1.7690"> </span>
<a href="#l1.7691"></a><span id="l1.7691" class="difflineplus">+</span>
<a href="#l1.7692"></a><span id="l1.7692" class="difflineplus">+      var valid;</span>
<a href="#l1.7693"></a><span id="l1.7693">       do {</span>
<a href="#l1.7694"></a><span id="l1.7694" class="difflineminus">-        var valid = 1;</span>
<a href="#l1.7695"></a><span id="l1.7695" class="difflineplus">+        valid = 1;</span>
<a href="#l1.7696"></a><span id="l1.7696"> </span>
<a href="#l1.7697"></a><span id="l1.7697">         switch (this.rule.freq) {</span>
<a href="#l1.7698"></a><span id="l1.7698">         case &quot;SECONDLY&quot;:</span>
<a href="#l1.7699"></a><span id="l1.7699">           this.next_second();</span>
<a href="#l1.7700"></a><span id="l1.7700">           break;</span>
<a href="#l1.7701"></a><span id="l1.7701">         case &quot;MINUTELY&quot;:</span>
<a href="#l1.7702"></a><span id="l1.7702">           this.next_minute();</span>
<a href="#l1.7703"></a><span id="l1.7703">           break;</span>
<a href="#l1.7704"></a><span id="l1.7704" class="difflineat">@@ -4847,22 +7190,23 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7705"></a><span id="l1.7705">         // Jump to the next week</span>
<a href="#l1.7706"></a><span id="l1.7706">         this.increment_monthday(7 * this.rule.interval);</span>
<a href="#l1.7707"></a><span id="l1.7707">       }</span>
<a href="#l1.7708"></a><span id="l1.7708"> </span>
<a href="#l1.7709"></a><span id="l1.7709">       return end_of_data;</span>
<a href="#l1.7710"></a><span id="l1.7710">     },</span>
<a href="#l1.7711"></a><span id="l1.7711"> </span>
<a href="#l1.7712"></a><span id="l1.7712">     /**</span>
<a href="#l1.7713"></a><span id="l1.7713" class="difflineminus">-     * normalize each by day rule for a given year/month.</span>
<a href="#l1.7714"></a><span id="l1.7714" class="difflineplus">+     * Normalize each by day rule for a given year/month.</span>
<a href="#l1.7715"></a><span id="l1.7715">      * Takes into account ordering and negative rules</span>
<a href="#l1.7716"></a><span id="l1.7716">      *</span>
<a href="#l1.7717"></a><span id="l1.7717" class="difflineminus">-     * @param {Numeric} year current year.</span>
<a href="#l1.7718"></a><span id="l1.7718" class="difflineminus">-     * @param {Numeric} month current month.</span>
<a href="#l1.7719"></a><span id="l1.7719" class="difflineminus">-     * @param {Array} rules array of rules.</span>
<a href="#l1.7720"></a><span id="l1.7720" class="difflineplus">+     * @private</span>
<a href="#l1.7721"></a><span id="l1.7721" class="difflineplus">+     * @param {Number} year         Current year.</span>
<a href="#l1.7722"></a><span id="l1.7722" class="difflineplus">+     * @param {Number} month        Current month.</span>
<a href="#l1.7723"></a><span id="l1.7723" class="difflineplus">+     * @param {Array}  rules        Array of rules.</span>
<a href="#l1.7724"></a><span id="l1.7724">      *</span>
<a href="#l1.7725"></a><span id="l1.7725">      * @return {Array} sorted and normalized rules.</span>
<a href="#l1.7726"></a><span id="l1.7726">      *                 Negative rules will be expanded to their</span>
<a href="#l1.7727"></a><span id="l1.7727">      *                 correct positive values for easier processing.</span>
<a href="#l1.7728"></a><span id="l1.7728">      */</span>
<a href="#l1.7729"></a><span id="l1.7729">     normalizeByMonthDayRules: function(year, month, rules) {</span>
<a href="#l1.7730"></a><span id="l1.7730">       var daysInMonth = ICAL.Time.daysInMonth(month, year);</span>
<a href="#l1.7731"></a><span id="l1.7731"> </span>
<a href="#l1.7732"></a><span id="l1.7732" class="difflineat">@@ -4897,44 +7241,45 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7733"></a><span id="l1.7733">         // only add unique items...</span>
<a href="#l1.7734"></a><span id="l1.7734">         if (newRules.indexOf(rule) === -1) {</span>
<a href="#l1.7735"></a><span id="l1.7735">           newRules.push(rule);</span>
<a href="#l1.7736"></a><span id="l1.7736">         }</span>
<a href="#l1.7737"></a><span id="l1.7737"> </span>
<a href="#l1.7738"></a><span id="l1.7738">       }</span>
<a href="#l1.7739"></a><span id="l1.7739"> </span>
<a href="#l1.7740"></a><span id="l1.7740">       // unique and sort</span>
<a href="#l1.7741"></a><span id="l1.7741" class="difflineminus">-      return newRules.sort(function(a,b){return a - b});</span>
<a href="#l1.7742"></a><span id="l1.7742" class="difflineplus">+      return newRules.sort(function(a, b) { return a - b; });</span>
<a href="#l1.7743"></a><span id="l1.7743">     },</span>
<a href="#l1.7744"></a><span id="l1.7744"> </span>
<a href="#l1.7745"></a><span id="l1.7745">     /**</span>
<a href="#l1.7746"></a><span id="l1.7746">      * NOTES:</span>
<a href="#l1.7747"></a><span id="l1.7747">      * We are given a list of dates in the month (BYMONTHDAY) (23, etc..)</span>
<a href="#l1.7748"></a><span id="l1.7748">      * Also we are given a list of days (BYDAY) (MO, 2SU, etc..) when</span>
<a href="#l1.7749"></a><span id="l1.7749">      * both conditions match a given date (this.last.day) iteration stops.</span>
<a href="#l1.7750"></a><span id="l1.7750">      *</span>
<a href="#l1.7751"></a><span id="l1.7751" class="difflineminus">-     * @param {Boolean} [isInit] when given true will not</span>
<a href="#l1.7752"></a><span id="l1.7752" class="difflineminus">-     *                           increment the current day (this.last).</span>
<a href="#l1.7753"></a><span id="l1.7753" class="difflineplus">+     * @private</span>
<a href="#l1.7754"></a><span id="l1.7754" class="difflineplus">+     * @param {Boolean=} isInit     When given true will not increment the</span>
<a href="#l1.7755"></a><span id="l1.7755" class="difflineplus">+     *                                current day (this.last).</span>
<a href="#l1.7756"></a><span id="l1.7756">      */</span>
<a href="#l1.7757"></a><span id="l1.7757">     _byDayAndMonthDay: function(isInit) {</span>
<a href="#l1.7758"></a><span id="l1.7758">       var byMonthDay; // setup in initMonth</span>
<a href="#l1.7759"></a><span id="l1.7759">       var byDay = this.by_data.BYDAY;</span>
<a href="#l1.7760"></a><span id="l1.7760"> </span>
<a href="#l1.7761"></a><span id="l1.7761">       var date;</span>
<a href="#l1.7762"></a><span id="l1.7762">       var dateIdx = 0;</span>
<a href="#l1.7763"></a><span id="l1.7763">       var dateLen; // setup in initMonth</span>
<a href="#l1.7764"></a><span id="l1.7764">       var dayLen = byDay.length;</span>
<a href="#l1.7765"></a><span id="l1.7765"> </span>
<a href="#l1.7766"></a><span id="l1.7766">       // we are not valid by default</span>
<a href="#l1.7767"></a><span id="l1.7767">       var dataIsValid = 0;</span>
<a href="#l1.7768"></a><span id="l1.7768"> </span>
<a href="#l1.7769"></a><span id="l1.7769">       var daysInMonth;</span>
<a href="#l1.7770"></a><span id="l1.7770">       var self = this;</span>
<a href="#l1.7771"></a><span id="l1.7771">       // we need a copy of this, because a DateTime gets normalized</span>
<a href="#l1.7772"></a><span id="l1.7772" class="difflineminus">-      // automatically if the day is out of range. At some points we </span>
<a href="#l1.7773"></a><span id="l1.7773" class="difflineplus">+      // automatically if the day is out of range. At some points we</span>
<a href="#l1.7774"></a><span id="l1.7774">       // set the last day to 0 to start counting.</span>
<a href="#l1.7775"></a><span id="l1.7775">       var lastDay = this.last.day;</span>
<a href="#l1.7776"></a><span id="l1.7776"> </span>
<a href="#l1.7777"></a><span id="l1.7777">       function initMonth() {</span>
<a href="#l1.7778"></a><span id="l1.7778">         daysInMonth = ICAL.Time.daysInMonth(</span>
<a href="#l1.7779"></a><span id="l1.7779">           self.last.month, self.last.year</span>
<a href="#l1.7780"></a><span id="l1.7780">         );</span>
<a href="#l1.7781"></a><span id="l1.7781"> </span>
<a href="#l1.7782"></a><span id="l1.7782" class="difflineat">@@ -5034,55 +7379,61 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7783"></a><span id="l1.7783">         if (!dataIsValid &amp;&amp; dateIdx === dateLen) {</span>
<a href="#l1.7784"></a><span id="l1.7784">           nextMonth();</span>
<a href="#l1.7785"></a><span id="l1.7785">           continue;</span>
<a href="#l1.7786"></a><span id="l1.7786">         }</span>
<a href="#l1.7787"></a><span id="l1.7787">       }</span>
<a href="#l1.7788"></a><span id="l1.7788"> </span>
<a href="#l1.7789"></a><span id="l1.7789">       if (monthsCounter &lt;= 0) {</span>
<a href="#l1.7790"></a><span id="l1.7790">         // Checked 4 years without finding a Byday that matches</span>
<a href="#l1.7791"></a><span id="l1.7791" class="difflineminus">-        // a Bymonthday. Maybe the rule is not correct. </span>
<a href="#l1.7792"></a><span id="l1.7792" class="difflineplus">+        // a Bymonthday. Maybe the rule is not correct.</span>
<a href="#l1.7793"></a><span id="l1.7793">         throw new Error(&quot;Malformed values in BYDAY combined with BYMONTHDAY parts&quot;);</span>
<a href="#l1.7794"></a><span id="l1.7794">       }</span>
<a href="#l1.7795"></a><span id="l1.7795"> </span>
<a href="#l1.7796"></a><span id="l1.7796" class="difflineplus">+</span>
<a href="#l1.7797"></a><span id="l1.7797">       return dataIsValid;</span>
<a href="#l1.7798"></a><span id="l1.7798">     },</span>
<a href="#l1.7799"></a><span id="l1.7799"> </span>
<a href="#l1.7800"></a><span id="l1.7800">     next_month: function next_month() {</span>
<a href="#l1.7801"></a><span id="l1.7801">       var this_freq = (this.rule.freq == &quot;MONTHLY&quot;);</span>
<a href="#l1.7802"></a><span id="l1.7802">       var data_valid = 1;</span>
<a href="#l1.7803"></a><span id="l1.7803"> </span>
<a href="#l1.7804"></a><span id="l1.7804">       if (this.next_hour() == 0) {</span>
<a href="#l1.7805"></a><span id="l1.7805">         return data_valid;</span>
<a href="#l1.7806"></a><span id="l1.7806">       }</span>
<a href="#l1.7807"></a><span id="l1.7807"> </span>
<a href="#l1.7808"></a><span id="l1.7808">       if (this.has_by_data(&quot;BYDAY&quot;) &amp;&amp; this.has_by_data(&quot;BYMONTHDAY&quot;)) {</span>
<a href="#l1.7809"></a><span id="l1.7809">         data_valid = this._byDayAndMonthDay();</span>
<a href="#l1.7810"></a><span id="l1.7810">       } else if (this.has_by_data(&quot;BYDAY&quot;)) {</span>
<a href="#l1.7811"></a><span id="l1.7811">         var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l1.7812"></a><span id="l1.7812">         var setpos = 0;</span>
<a href="#l1.7813"></a><span id="l1.7813" class="difflineplus">+        var setpos_total = 0;</span>
<a href="#l1.7814"></a><span id="l1.7814"> </span>
<a href="#l1.7815"></a><span id="l1.7815">         if (this.has_by_data(&quot;BYSETPOS&quot;)) {</span>
<a href="#l1.7816"></a><span id="l1.7816">           var last_day = this.last.day;</span>
<a href="#l1.7817"></a><span id="l1.7817">           for (var day = 1; day &lt;= daysInMonth; day++) {</span>
<a href="#l1.7818"></a><span id="l1.7818">             this.last.day = day;</span>
<a href="#l1.7819"></a><span id="l1.7819" class="difflineminus">-            if (this.is_day_in_byday(this.last) &amp;&amp; day &lt;= last_day) {</span>
<a href="#l1.7820"></a><span id="l1.7820" class="difflineminus">-              setpos++;</span>
<a href="#l1.7821"></a><span id="l1.7821" class="difflineplus">+            if (this.is_day_in_byday(this.last)) {</span>
<a href="#l1.7822"></a><span id="l1.7822" class="difflineplus">+              setpos_total++;</span>
<a href="#l1.7823"></a><span id="l1.7823" class="difflineplus">+              if (day &lt;= last_day) {</span>
<a href="#l1.7824"></a><span id="l1.7824" class="difflineplus">+                setpos++;</span>
<a href="#l1.7825"></a><span id="l1.7825" class="difflineplus">+              }</span>
<a href="#l1.7826"></a><span id="l1.7826">             }</span>
<a href="#l1.7827"></a><span id="l1.7827">           }</span>
<a href="#l1.7828"></a><span id="l1.7828">           this.last.day = last_day;</span>
<a href="#l1.7829"></a><span id="l1.7829">         }</span>
<a href="#l1.7830"></a><span id="l1.7830"> </span>
<a href="#l1.7831"></a><span id="l1.7831" class="difflineplus">+        data_valid = 0;</span>
<a href="#l1.7832"></a><span id="l1.7832">         for (var day = this.last.day + 1; day &lt;= daysInMonth; day++) {</span>
<a href="#l1.7833"></a><span id="l1.7833">           this.last.day = day;</span>
<a href="#l1.7834"></a><span id="l1.7834"> </span>
<a href="#l1.7835"></a><span id="l1.7835">           if (this.is_day_in_byday(this.last)) {</span>
<a href="#l1.7836"></a><span id="l1.7836">             if (!this.has_by_data(&quot;BYSETPOS&quot;) ||</span>
<a href="#l1.7837"></a><span id="l1.7837">                 this.check_set_position(++setpos) ||</span>
<a href="#l1.7838"></a><span id="l1.7838" class="difflineminus">-                this.check_set_position(setpos - this.by_data.BYSETPOS.length - 1)) {</span>
<a href="#l1.7839"></a><span id="l1.7839" class="difflineplus">+                this.check_set_position(setpos - setpos_total - 1)) {</span>
<a href="#l1.7840"></a><span id="l1.7840"> </span>
<a href="#l1.7841"></a><span id="l1.7841">               data_valid = 1;</span>
<a href="#l1.7842"></a><span id="l1.7842">               break;</span>
<a href="#l1.7843"></a><span id="l1.7843">             }</span>
<a href="#l1.7844"></a><span id="l1.7844">           }</span>
<a href="#l1.7845"></a><span id="l1.7845">         }</span>
<a href="#l1.7846"></a><span id="l1.7846"> </span>
<a href="#l1.7847"></a><span id="l1.7847">         if (day &gt; daysInMonth) {</span>
<a href="#l1.7848"></a><span id="l1.7848" class="difflineat">@@ -5101,35 +7452,37 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7849"></a><span id="l1.7849">         this.by_indices.BYMONTHDAY++;</span>
<a href="#l1.7850"></a><span id="l1.7850"> </span>
<a href="#l1.7851"></a><span id="l1.7851">         if (this.by_indices.BYMONTHDAY &gt;= this.by_data.BYMONTHDAY.length) {</span>
<a href="#l1.7852"></a><span id="l1.7852">           this.by_indices.BYMONTHDAY = 0;</span>
<a href="#l1.7853"></a><span id="l1.7853">           this.increment_month();</span>
<a href="#l1.7854"></a><span id="l1.7854">         }</span>
<a href="#l1.7855"></a><span id="l1.7855"> </span>
<a href="#l1.7856"></a><span id="l1.7856">         var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l1.7857"></a><span id="l1.7857" class="difflineminus">-</span>
<a href="#l1.7858"></a><span id="l1.7858">         var day = this.by_data.BYMONTHDAY[this.by_indices.BYMONTHDAY];</span>
<a href="#l1.7859"></a><span id="l1.7859"> </span>
<a href="#l1.7860"></a><span id="l1.7860">         if (day &lt; 0) {</span>
<a href="#l1.7861"></a><span id="l1.7861">           day = daysInMonth + day + 1;</span>
<a href="#l1.7862"></a><span id="l1.7862">         }</span>
<a href="#l1.7863"></a><span id="l1.7863"> </span>
<a href="#l1.7864"></a><span id="l1.7864">         if (day &gt; daysInMonth) {</span>
<a href="#l1.7865"></a><span id="l1.7865">           this.last.day = 1;</span>
<a href="#l1.7866"></a><span id="l1.7866">           data_valid = this.is_day_in_byday(this.last);</span>
<a href="#l1.7867"></a><span id="l1.7867">         } else {</span>
<a href="#l1.7868"></a><span id="l1.7868">           this.last.day = day;</span>
<a href="#l1.7869"></a><span id="l1.7869">         }</span>
<a href="#l1.7870"></a><span id="l1.7870"> </span>
<a href="#l1.7871"></a><span id="l1.7871">       } else {</span>
<a href="#l1.7872"></a><span id="l1.7872" class="difflineminus">-        this.last.day = this.by_data.BYMONTHDAY[0];</span>
<a href="#l1.7873"></a><span id="l1.7873">         this.increment_month();</span>
<a href="#l1.7874"></a><span id="l1.7874">         var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l1.7875"></a><span id="l1.7875" class="difflineminus">-        this.last.day = Math.min(this.last.day, daysInMonth);</span>
<a href="#l1.7876"></a><span id="l1.7876" class="difflineplus">+        if (this.by_data.BYMONTHDAY[0] &gt; daysInMonth) {</span>
<a href="#l1.7877"></a><span id="l1.7877" class="difflineplus">+          data_valid = 0;</span>
<a href="#l1.7878"></a><span id="l1.7878" class="difflineplus">+        } else {</span>
<a href="#l1.7879"></a><span id="l1.7879" class="difflineplus">+          this.last.day = this.by_data.BYMONTHDAY[0];</span>
<a href="#l1.7880"></a><span id="l1.7880" class="difflineplus">+        }</span>
<a href="#l1.7881"></a><span id="l1.7881">       }</span>
<a href="#l1.7882"></a><span id="l1.7882"> </span>
<a href="#l1.7883"></a><span id="l1.7883">       return data_valid;</span>
<a href="#l1.7884"></a><span id="l1.7884">     },</span>
<a href="#l1.7885"></a><span id="l1.7885"> </span>
<a href="#l1.7886"></a><span id="l1.7886">     next_weekday_by_week: function next_weekday_by_week() {</span>
<a href="#l1.7887"></a><span id="l1.7887">       var end_of_data = 0;</span>
<a href="#l1.7888"></a><span id="l1.7888"> </span>
<a href="#l1.7889"></a><span id="l1.7889" class="difflineat">@@ -5198,25 +7551,37 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7890"></a><span id="l1.7890">       if (++this.days_index == this.days.length) {</span>
<a href="#l1.7891"></a><span id="l1.7891">         this.days_index = 0;</span>
<a href="#l1.7892"></a><span id="l1.7892">         do {</span>
<a href="#l1.7893"></a><span id="l1.7893">           this.increment_year(this.rule.interval);</span>
<a href="#l1.7894"></a><span id="l1.7894">           this.expand_year_days(this.last.year);</span>
<a href="#l1.7895"></a><span id="l1.7895">         } while (this.days.length == 0);</span>
<a href="#l1.7896"></a><span id="l1.7896">       }</span>
<a href="#l1.7897"></a><span id="l1.7897"> </span>
<a href="#l1.7898"></a><span id="l1.7898" class="difflineminus">-      var next = ICAL.Time.fromDayOfYear(this.days[this.days_index],</span>
<a href="#l1.7899"></a><span id="l1.7899" class="difflineminus">-                                                this.last.year);</span>
<a href="#l1.7900"></a><span id="l1.7900" class="difflineminus">-</span>
<a href="#l1.7901"></a><span id="l1.7901" class="difflineminus">-      this.last.day = next.day;</span>
<a href="#l1.7902"></a><span id="l1.7902" class="difflineminus">-      this.last.month = next.month;</span>
<a href="#l1.7903"></a><span id="l1.7903" class="difflineplus">+      this._nextByYearDay();</span>
<a href="#l1.7904"></a><span id="l1.7904"> </span>
<a href="#l1.7905"></a><span id="l1.7905">       return 1;</span>
<a href="#l1.7906"></a><span id="l1.7906">     },</span>
<a href="#l1.7907"></a><span id="l1.7907"> </span>
<a href="#l1.7908"></a><span id="l1.7908" class="difflineplus">+    _nextByYearDay: function _nextByYearDay() {</span>
<a href="#l1.7909"></a><span id="l1.7909" class="difflineplus">+        var doy = this.days[this.days_index];</span>
<a href="#l1.7910"></a><span id="l1.7910" class="difflineplus">+        var year = this.last.year;</span>
<a href="#l1.7911"></a><span id="l1.7911" class="difflineplus">+        if (doy &lt; 1) {</span>
<a href="#l1.7912"></a><span id="l1.7912" class="difflineplus">+            // Time.fromDayOfYear(doy, year) indexes relative to the</span>
<a href="#l1.7913"></a><span id="l1.7913" class="difflineplus">+            // start of the given year. That is different from the</span>
<a href="#l1.7914"></a><span id="l1.7914" class="difflineplus">+            // semantics of BYYEARDAY where negative indexes are an</span>
<a href="#l1.7915"></a><span id="l1.7915" class="difflineplus">+            // offset from the end of the given year.</span>
<a href="#l1.7916"></a><span id="l1.7916" class="difflineplus">+            doy += 1;</span>
<a href="#l1.7917"></a><span id="l1.7917" class="difflineplus">+            year += 1;</span>
<a href="#l1.7918"></a><span id="l1.7918" class="difflineplus">+        }</span>
<a href="#l1.7919"></a><span id="l1.7919" class="difflineplus">+        var next = ICAL.Time.fromDayOfYear(doy, year);</span>
<a href="#l1.7920"></a><span id="l1.7920" class="difflineplus">+        this.last.day = next.day;</span>
<a href="#l1.7921"></a><span id="l1.7921" class="difflineplus">+        this.last.month = next.month;</span>
<a href="#l1.7922"></a><span id="l1.7922" class="difflineplus">+    },</span>
<a href="#l1.7923"></a><span id="l1.7923" class="difflineplus">+</span>
<a href="#l1.7924"></a><span id="l1.7924">     ruleDayOfWeek: function ruleDayOfWeek(dow) {</span>
<a href="#l1.7925"></a><span id="l1.7925">       var matches = dow.match(/([+-]?[0-9])?(MO|TU|WE|TH|FR|SA|SU)/);</span>
<a href="#l1.7926"></a><span id="l1.7926">       if (matches) {</span>
<a href="#l1.7927"></a><span id="l1.7927">         var pos = parseInt(matches[1] || 0, 10);</span>
<a href="#l1.7928"></a><span id="l1.7928">         dow = ICAL.Recur.icalDayToNumericDay(matches[2]);</span>
<a href="#l1.7929"></a><span id="l1.7929">         return [pos, dow];</span>
<a href="#l1.7930"></a><span id="l1.7930">       } else {</span>
<a href="#l1.7931"></a><span id="l1.7931">         return [0, 0];</span>
<a href="#l1.7932"></a><span id="l1.7932" class="difflineat">@@ -5316,19 +7681,22 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7933"></a><span id="l1.7933">     expand_year_days: function expand_year_days(aYear) {</span>
<a href="#l1.7934"></a><span id="l1.7934">       var t = new ICAL.Time();</span>
<a href="#l1.7935"></a><span id="l1.7935">       this.days = [];</span>
<a href="#l1.7936"></a><span id="l1.7936"> </span>
<a href="#l1.7937"></a><span id="l1.7937">       // We need our own copy with a few keys set</span>
<a href="#l1.7938"></a><span id="l1.7938">       var parts = {};</span>
<a href="#l1.7939"></a><span id="l1.7939">       var rules = [&quot;BYDAY&quot;, &quot;BYWEEKNO&quot;, &quot;BYMONTHDAY&quot;, &quot;BYMONTH&quot;, &quot;BYYEARDAY&quot;];</span>
<a href="#l1.7940"></a><span id="l1.7940">       for (var p in rules) {</span>
<a href="#l1.7941"></a><span id="l1.7941" class="difflineminus">-        var part = rules[p];</span>
<a href="#l1.7942"></a><span id="l1.7942" class="difflineminus">-        if (part in this.rule.parts) {</span>
<a href="#l1.7943"></a><span id="l1.7943" class="difflineminus">-          parts[part] = this.rule.parts[part];</span>
<a href="#l1.7944"></a><span id="l1.7944" class="difflineplus">+        /* istanbul ignore else */</span>
<a href="#l1.7945"></a><span id="l1.7945" class="difflineplus">+        if (rules.hasOwnProperty(p)) {</span>
<a href="#l1.7946"></a><span id="l1.7946" class="difflineplus">+          var part = rules[p];</span>
<a href="#l1.7947"></a><span id="l1.7947" class="difflineplus">+          if (part in this.rule.parts) {</span>
<a href="#l1.7948"></a><span id="l1.7948" class="difflineplus">+            parts[part] = this.rule.parts[part];</span>
<a href="#l1.7949"></a><span id="l1.7949" class="difflineplus">+          }</span>
<a href="#l1.7950"></a><span id="l1.7950">         }</span>
<a href="#l1.7951"></a><span id="l1.7951">       }</span>
<a href="#l1.7952"></a><span id="l1.7952"> </span>
<a href="#l1.7953"></a><span id="l1.7953">       if (&quot;BYMONTH&quot; in parts &amp;&amp; &quot;BYWEEKNO&quot; in parts) {</span>
<a href="#l1.7954"></a><span id="l1.7954">         var valid = 1;</span>
<a href="#l1.7955"></a><span id="l1.7955">         var validWeeks = {};</span>
<a href="#l1.7956"></a><span id="l1.7956">         t.year = aYear;</span>
<a href="#l1.7957"></a><span id="l1.7957">         t.isDate = true;</span>
<a href="#l1.7958"></a><span id="l1.7958" class="difflineat">@@ -5359,47 +7727,63 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.7959"></a><span id="l1.7959">         } else {</span>
<a href="#l1.7960"></a><span id="l1.7960">           delete parts.BYWEEKNO;</span>
<a href="#l1.7961"></a><span id="l1.7961">         }</span>
<a href="#l1.7962"></a><span id="l1.7962">       }</span>
<a href="#l1.7963"></a><span id="l1.7963"> </span>
<a href="#l1.7964"></a><span id="l1.7964">       var partCount = Object.keys(parts).length;</span>
<a href="#l1.7965"></a><span id="l1.7965"> </span>
<a href="#l1.7966"></a><span id="l1.7966">       if (partCount == 0) {</span>
<a href="#l1.7967"></a><span id="l1.7967" class="difflineminus">-        var t = this.dtstart.clone();</span>
<a href="#l1.7968"></a><span id="l1.7968" class="difflineminus">-        t.year = this.last.year;</span>
<a href="#l1.7969"></a><span id="l1.7969" class="difflineminus">-        this.days.push(t.dayOfYear());</span>
<a href="#l1.7970"></a><span id="l1.7970" class="difflineplus">+        var t1 = this.dtstart.clone();</span>
<a href="#l1.7971"></a><span id="l1.7971" class="difflineplus">+        t1.year = this.last.year;</span>
<a href="#l1.7972"></a><span id="l1.7972" class="difflineplus">+        this.days.push(t1.dayOfYear());</span>
<a href="#l1.7973"></a><span id="l1.7973">       } else if (partCount == 1 &amp;&amp; &quot;BYMONTH&quot; in parts) {</span>
<a href="#l1.7974"></a><span id="l1.7974">         for (var monthkey in this.by_data.BYMONTH) {</span>
<a href="#l1.7975"></a><span id="l1.7975" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.7976"></a><span id="l1.7976" class="difflineplus">+          if (!this.by_data.BYMONTH.hasOwnProperty(monthkey)) {</span>
<a href="#l1.7977"></a><span id="l1.7977" class="difflineplus">+            continue;</span>
<a href="#l1.7978"></a><span id="l1.7978" class="difflineplus">+          }</span>
<a href="#l1.7979"></a><span id="l1.7979">           var t2 = this.dtstart.clone();</span>
<a href="#l1.7980"></a><span id="l1.7980">           t2.year = aYear;</span>
<a href="#l1.7981"></a><span id="l1.7981">           t2.month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l1.7982"></a><span id="l1.7982">           t2.isDate = true;</span>
<a href="#l1.7983"></a><span id="l1.7983">           this.days.push(t2.dayOfYear());</span>
<a href="#l1.7984"></a><span id="l1.7984">         }</span>
<a href="#l1.7985"></a><span id="l1.7985">       } else if (partCount == 1 &amp;&amp; &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l1.7986"></a><span id="l1.7986">         for (var monthdaykey in this.by_data.BYMONTHDAY) {</span>
<a href="#l1.7987"></a><span id="l1.7987" class="difflineminus">-          var t2 = this.dtstart.clone();</span>
<a href="#l1.7988"></a><span id="l1.7988" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.7989"></a><span id="l1.7989" class="difflineplus">+          if (!this.by_data.BYMONTHDAY.hasOwnProperty(monthdaykey)) {</span>
<a href="#l1.7990"></a><span id="l1.7990" class="difflineplus">+            continue;</span>
<a href="#l1.7991"></a><span id="l1.7991" class="difflineplus">+          }</span>
<a href="#l1.7992"></a><span id="l1.7992" class="difflineplus">+          var t3 = this.dtstart.clone();</span>
<a href="#l1.7993"></a><span id="l1.7993">           var day_ = this.by_data.BYMONTHDAY[monthdaykey];</span>
<a href="#l1.7994"></a><span id="l1.7994">           if (day_ &lt; 0) {</span>
<a href="#l1.7995"></a><span id="l1.7995" class="difflineminus">-            var daysInMonth = ICAL.Time.daysInMonth(t2.month, aYear);</span>
<a href="#l1.7996"></a><span id="l1.7996" class="difflineplus">+            var daysInMonth = ICAL.Time.daysInMonth(t3.month, aYear);</span>
<a href="#l1.7997"></a><span id="l1.7997">             day_ = day_ + daysInMonth + 1;</span>
<a href="#l1.7998"></a><span id="l1.7998">           }</span>
<a href="#l1.7999"></a><span id="l1.7999" class="difflineminus">-          t2.day = day_;</span>
<a href="#l1.8000"></a><span id="l1.8000" class="difflineminus">-          t2.year = aYear;</span>
<a href="#l1.8001"></a><span id="l1.8001" class="difflineminus">-          t2.isDate = true;</span>
<a href="#l1.8002"></a><span id="l1.8002" class="difflineminus">-          this.days.push(t2.dayOfYear());</span>
<a href="#l1.8003"></a><span id="l1.8003" class="difflineplus">+          t3.day = day_;</span>
<a href="#l1.8004"></a><span id="l1.8004" class="difflineplus">+          t3.year = aYear;</span>
<a href="#l1.8005"></a><span id="l1.8005" class="difflineplus">+          t3.isDate = true;</span>
<a href="#l1.8006"></a><span id="l1.8006" class="difflineplus">+          this.days.push(t3.dayOfYear());</span>
<a href="#l1.8007"></a><span id="l1.8007">         }</span>
<a href="#l1.8008"></a><span id="l1.8008">       } else if (partCount == 2 &amp;&amp;</span>
<a href="#l1.8009"></a><span id="l1.8009">                  &quot;BYMONTHDAY&quot; in parts &amp;&amp;</span>
<a href="#l1.8010"></a><span id="l1.8010">                  &quot;BYMONTH&quot; in parts) {</span>
<a href="#l1.8011"></a><span id="l1.8011">         for (var monthkey in this.by_data.BYMONTH) {</span>
<a href="#l1.8012"></a><span id="l1.8012" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.8013"></a><span id="l1.8013" class="difflineplus">+          if (!this.by_data.BYMONTH.hasOwnProperty(monthkey)) {</span>
<a href="#l1.8014"></a><span id="l1.8014" class="difflineplus">+            continue;</span>
<a href="#l1.8015"></a><span id="l1.8015" class="difflineplus">+          }</span>
<a href="#l1.8016"></a><span id="l1.8016">           var month_ = this.by_data.BYMONTH[monthkey];</span>
<a href="#l1.8017"></a><span id="l1.8017">           var daysInMonth = ICAL.Time.daysInMonth(month_, aYear);</span>
<a href="#l1.8018"></a><span id="l1.8018">           for (var monthdaykey in this.by_data.BYMONTHDAY) {</span>
<a href="#l1.8019"></a><span id="l1.8019" class="difflineplus">+            /* istanbul ignore if */</span>
<a href="#l1.8020"></a><span id="l1.8020" class="difflineplus">+            if (!this.by_data.BYMONTHDAY.hasOwnProperty(monthdaykey)) {</span>
<a href="#l1.8021"></a><span id="l1.8021" class="difflineplus">+              continue;</span>
<a href="#l1.8022"></a><span id="l1.8022" class="difflineplus">+            }</span>
<a href="#l1.8023"></a><span id="l1.8023">             var day_ = this.by_data.BYMONTHDAY[monthdaykey];</span>
<a href="#l1.8024"></a><span id="l1.8024">             if (day_ &lt; 0) {</span>
<a href="#l1.8025"></a><span id="l1.8025">               day_ = day_ + daysInMonth + 1;</span>
<a href="#l1.8026"></a><span id="l1.8026">             }</span>
<a href="#l1.8027"></a><span id="l1.8027">             t.day = day_;</span>
<a href="#l1.8028"></a><span id="l1.8028">             t.month = month_;</span>
<a href="#l1.8029"></a><span id="l1.8029">             t.year = aYear;</span>
<a href="#l1.8030"></a><span id="l1.8030">             t.isDate = true;</span>
<a href="#l1.8031"></a><span id="l1.8031" class="difflineat">@@ -5412,17 +7796,21 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8032"></a><span id="l1.8032">       } else if (partCount == 2 &amp;&amp;</span>
<a href="#l1.8033"></a><span id="l1.8033">                  &quot;BYWEEKNO&quot; in parts &amp;&amp;</span>
<a href="#l1.8034"></a><span id="l1.8034">                  &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l1.8035"></a><span id="l1.8035">         // TODO unimplemented in libical</span>
<a href="#l1.8036"></a><span id="l1.8036">       } else if (partCount == 1 &amp;&amp; &quot;BYDAY&quot; in parts) {</span>
<a href="#l1.8037"></a><span id="l1.8037">         this.days = this.days.concat(this.expand_by_day(aYear));</span>
<a href="#l1.8038"></a><span id="l1.8038">       } else if (partCount == 2 &amp;&amp; &quot;BYDAY&quot; in parts &amp;&amp; &quot;BYMONTH&quot; in parts) {</span>
<a href="#l1.8039"></a><span id="l1.8039">         for (var monthkey in this.by_data.BYMONTH) {</span>
<a href="#l1.8040"></a><span id="l1.8040" class="difflineminus">-          month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l1.8041"></a><span id="l1.8041" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.8042"></a><span id="l1.8042" class="difflineplus">+          if (!this.by_data.BYMONTH.hasOwnProperty(monthkey)) {</span>
<a href="#l1.8043"></a><span id="l1.8043" class="difflineplus">+            continue;</span>
<a href="#l1.8044"></a><span id="l1.8044" class="difflineplus">+          }</span>
<a href="#l1.8045"></a><span id="l1.8045" class="difflineplus">+          var month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l1.8046"></a><span id="l1.8046">           var daysInMonth = ICAL.Time.daysInMonth(month, aYear);</span>
<a href="#l1.8047"></a><span id="l1.8047"> </span>
<a href="#l1.8048"></a><span id="l1.8048">           t.year = aYear;</span>
<a href="#l1.8049"></a><span id="l1.8049">           t.month = this.by_data.BYMONTH[monthkey];</span>
<a href="#l1.8050"></a><span id="l1.8050">           t.day = 1;</span>
<a href="#l1.8051"></a><span id="l1.8051">           t.isDate = true;</span>
<a href="#l1.8052"></a><span id="l1.8052"> </span>
<a href="#l1.8053"></a><span id="l1.8053">           var first_dow = t.dayOfWeek();</span>
<a href="#l1.8054"></a><span id="l1.8054" class="difflineat">@@ -5444,20 +7832,24 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8055"></a><span id="l1.8055">             for (var spIndex = 0; spIndex &lt; by_month_day.length; spIndex++) {</span>
<a href="#l1.8056"></a><span id="l1.8056">               if (this.check_set_position(spIndex + 1) ||</span>
<a href="#l1.8057"></a><span id="l1.8057">                   this.check_set_position(spIndex - by_month_day.length)) {</span>
<a href="#l1.8058"></a><span id="l1.8058">                 this.days.push(doy_offset + by_month_day[spIndex]);</span>
<a href="#l1.8059"></a><span id="l1.8059">               }</span>
<a href="#l1.8060"></a><span id="l1.8060">             }</span>
<a href="#l1.8061"></a><span id="l1.8061">           } else {</span>
<a href="#l1.8062"></a><span id="l1.8062">             for (var daycodedkey in this.by_data.BYDAY) {</span>
<a href="#l1.8063"></a><span id="l1.8063" class="difflineplus">+              /* istanbul ignore if */</span>
<a href="#l1.8064"></a><span id="l1.8064" class="difflineplus">+              if (!this.by_data.BYDAY.hasOwnProperty(daycodedkey)) {</span>
<a href="#l1.8065"></a><span id="l1.8065" class="difflineplus">+                continue;</span>
<a href="#l1.8066"></a><span id="l1.8066" class="difflineplus">+              }</span>
<a href="#l1.8067"></a><span id="l1.8067">               var coded_day = this.by_data.BYDAY[daycodedkey];</span>
<a href="#l1.8068"></a><span id="l1.8068" class="difflineminus">-              var parts = this.ruleDayOfWeek(coded_day);</span>
<a href="#l1.8069"></a><span id="l1.8069" class="difflineminus">-              var pos = parts[0];</span>
<a href="#l1.8070"></a><span id="l1.8070" class="difflineminus">-              var dow = parts[1];</span>
<a href="#l1.8071"></a><span id="l1.8071" class="difflineplus">+              var bydayParts = this.ruleDayOfWeek(coded_day);</span>
<a href="#l1.8072"></a><span id="l1.8072" class="difflineplus">+              var pos = bydayParts[0];</span>
<a href="#l1.8073"></a><span id="l1.8073" class="difflineplus">+              var dow = bydayParts[1];</span>
<a href="#l1.8074"></a><span id="l1.8074">               var month_day;</span>
<a href="#l1.8075"></a><span id="l1.8075"> </span>
<a href="#l1.8076"></a><span id="l1.8076">               var first_matching_day = ((dow + 7 - first_dow) % 7) + 1;</span>
<a href="#l1.8077"></a><span id="l1.8077">               var last_matching_day = daysInMonth - ((last_dow + 7 - dow) % 7);</span>
<a href="#l1.8078"></a><span id="l1.8078"> </span>
<a href="#l1.8079"></a><span id="l1.8079">               if (pos == 0) {</span>
<a href="#l1.8080"></a><span id="l1.8080">                 for (var day = first_matching_day; day &lt;= daysInMonth; day += 7) {</span>
<a href="#l1.8081"></a><span id="l1.8081">                   this.days.push(doy_offset + day);</span>
<a href="#l1.8082"></a><span id="l1.8082" class="difflineat">@@ -5471,50 +7863,62 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8083"></a><span id="l1.8083">               } else {</span>
<a href="#l1.8084"></a><span id="l1.8084">                 month_day = last_matching_day + (pos + 1) * 7;</span>
<a href="#l1.8085"></a><span id="l1.8085"> </span>
<a href="#l1.8086"></a><span id="l1.8086">                 if (month_day &gt; 0) {</span>
<a href="#l1.8087"></a><span id="l1.8087">                   this.days.push(doy_offset + month_day);</span>
<a href="#l1.8088"></a><span id="l1.8088">                 }</span>
<a href="#l1.8089"></a><span id="l1.8089">               }</span>
<a href="#l1.8090"></a><span id="l1.8090">             }</span>
<a href="#l1.8091"></a><span id="l1.8091" class="difflineminus">-            // Return dates in order of occurrence (1,2,3, etc...)</span>
<a href="#l1.8092"></a><span id="l1.8092" class="difflineminus">-            // instead of by weekday (su, mo, etc..).</span>
<a href="#l1.8093"></a><span id="l1.8093" class="difflineminus">-            this.days.sort(function(a,b){return a - b;});</span>
<a href="#l1.8094"></a><span id="l1.8094">           }</span>
<a href="#l1.8095"></a><span id="l1.8095">         }</span>
<a href="#l1.8096"></a><span id="l1.8096" class="difflineplus">+        // Return dates in order of occurrence (1,2,3,...) instead</span>
<a href="#l1.8097"></a><span id="l1.8097" class="difflineplus">+        // of by groups of weekdays (1,8,15,...,2,9,16,...).</span>
<a href="#l1.8098"></a><span id="l1.8098" class="difflineplus">+        this.days.sort(function(a, b) { return a - b; }); // Comparator function allows to sort numbers.</span>
<a href="#l1.8099"></a><span id="l1.8099">       } else if (partCount == 2 &amp;&amp; &quot;BYDAY&quot; in parts &amp;&amp; &quot;BYMONTHDAY&quot; in parts) {</span>
<a href="#l1.8100"></a><span id="l1.8100">         var expandedDays = this.expand_by_day(aYear);</span>
<a href="#l1.8101"></a><span id="l1.8101"> </span>
<a href="#l1.8102"></a><span id="l1.8102">         for (var daykey in expandedDays) {</span>
<a href="#l1.8103"></a><span id="l1.8103" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.8104"></a><span id="l1.8104" class="difflineplus">+          if (!expandedDays.hasOwnProperty(daykey)) {</span>
<a href="#l1.8105"></a><span id="l1.8105" class="difflineplus">+            continue;</span>
<a href="#l1.8106"></a><span id="l1.8106" class="difflineplus">+          }</span>
<a href="#l1.8107"></a><span id="l1.8107">           var day = expandedDays[daykey];</span>
<a href="#l1.8108"></a><span id="l1.8108">           var tt = ICAL.Time.fromDayOfYear(day, aYear);</span>
<a href="#l1.8109"></a><span id="l1.8109">           if (this.by_data.BYMONTHDAY.indexOf(tt.day) &gt;= 0) {</span>
<a href="#l1.8110"></a><span id="l1.8110">             this.days.push(day);</span>
<a href="#l1.8111"></a><span id="l1.8111">           }</span>
<a href="#l1.8112"></a><span id="l1.8112">         }</span>
<a href="#l1.8113"></a><span id="l1.8113">       } else if (partCount == 3 &amp;&amp;</span>
<a href="#l1.8114"></a><span id="l1.8114">                  &quot;BYDAY&quot; in parts &amp;&amp;</span>
<a href="#l1.8115"></a><span id="l1.8115">                  &quot;BYMONTHDAY&quot; in parts &amp;&amp;</span>
<a href="#l1.8116"></a><span id="l1.8116">                  &quot;BYMONTH&quot; in parts) {</span>
<a href="#l1.8117"></a><span id="l1.8117">         var expandedDays = this.expand_by_day(aYear);</span>
<a href="#l1.8118"></a><span id="l1.8118"> </span>
<a href="#l1.8119"></a><span id="l1.8119">         for (var daykey in expandedDays) {</span>
<a href="#l1.8120"></a><span id="l1.8120" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.8121"></a><span id="l1.8121" class="difflineplus">+          if (!expandedDays.hasOwnProperty(daykey)) {</span>
<a href="#l1.8122"></a><span id="l1.8122" class="difflineplus">+            continue;</span>
<a href="#l1.8123"></a><span id="l1.8123" class="difflineplus">+          }</span>
<a href="#l1.8124"></a><span id="l1.8124">           var day = expandedDays[daykey];</span>
<a href="#l1.8125"></a><span id="l1.8125">           var tt = ICAL.Time.fromDayOfYear(day, aYear);</span>
<a href="#l1.8126"></a><span id="l1.8126"> </span>
<a href="#l1.8127"></a><span id="l1.8127">           if (this.by_data.BYMONTH.indexOf(tt.month) &gt;= 0 &amp;&amp;</span>
<a href="#l1.8128"></a><span id="l1.8128">               this.by_data.BYMONTHDAY.indexOf(tt.day) &gt;= 0) {</span>
<a href="#l1.8129"></a><span id="l1.8129">             this.days.push(day);</span>
<a href="#l1.8130"></a><span id="l1.8130">           }</span>
<a href="#l1.8131"></a><span id="l1.8131">         }</span>
<a href="#l1.8132"></a><span id="l1.8132">       } else if (partCount == 2 &amp;&amp; &quot;BYDAY&quot; in parts &amp;&amp; &quot;BYWEEKNO&quot; in parts) {</span>
<a href="#l1.8133"></a><span id="l1.8133">         var expandedDays = this.expand_by_day(aYear);</span>
<a href="#l1.8134"></a><span id="l1.8134"> </span>
<a href="#l1.8135"></a><span id="l1.8135">         for (var daykey in expandedDays) {</span>
<a href="#l1.8136"></a><span id="l1.8136" class="difflineplus">+          /* istanbul ignore if */</span>
<a href="#l1.8137"></a><span id="l1.8137" class="difflineplus">+          if (!expandedDays.hasOwnProperty(daykey)) {</span>
<a href="#l1.8138"></a><span id="l1.8138" class="difflineplus">+            continue;</span>
<a href="#l1.8139"></a><span id="l1.8139" class="difflineplus">+          }</span>
<a href="#l1.8140"></a><span id="l1.8140">           var day = expandedDays[daykey];</span>
<a href="#l1.8141"></a><span id="l1.8141">           var tt = ICAL.Time.fromDayOfYear(day, aYear);</span>
<a href="#l1.8142"></a><span id="l1.8142">           var weekno = tt.weekNumber(this.rule.wkst);</span>
<a href="#l1.8143"></a><span id="l1.8143"> </span>
<a href="#l1.8144"></a><span id="l1.8144">           if (this.by_data.BYWEEKNO.indexOf(weekno)) {</span>
<a href="#l1.8145"></a><span id="l1.8145">             this.days.push(day);</span>
<a href="#l1.8146"></a><span id="l1.8146">           }</span>
<a href="#l1.8147"></a><span id="l1.8147">         }</span>
<a href="#l1.8148"></a><span id="l1.8148" class="difflineat">@@ -5546,16 +7950,20 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8149"></a><span id="l1.8149">       tmp.month = 12;</span>
<a href="#l1.8150"></a><span id="l1.8150">       tmp.day = 31;</span>
<a href="#l1.8151"></a><span id="l1.8151">       tmp.isDate = true;</span>
<a href="#l1.8152"></a><span id="l1.8152"> </span>
<a href="#l1.8153"></a><span id="l1.8153">       var end_dow = tmp.dayOfWeek();</span>
<a href="#l1.8154"></a><span id="l1.8154">       var end_year_day = tmp.dayOfYear();</span>
<a href="#l1.8155"></a><span id="l1.8155"> </span>
<a href="#l1.8156"></a><span id="l1.8156">       for (var daykey in this.by_data.BYDAY) {</span>
<a href="#l1.8157"></a><span id="l1.8157" class="difflineplus">+        /* istanbul ignore if */</span>
<a href="#l1.8158"></a><span id="l1.8158" class="difflineplus">+        if (!this.by_data.BYDAY.hasOwnProperty(daykey)) {</span>
<a href="#l1.8159"></a><span id="l1.8159" class="difflineplus">+          continue;</span>
<a href="#l1.8160"></a><span id="l1.8160" class="difflineplus">+        }</span>
<a href="#l1.8161"></a><span id="l1.8161">         var day = this.by_data.BYDAY[daykey];</span>
<a href="#l1.8162"></a><span id="l1.8162">         var parts = this.ruleDayOfWeek(day);</span>
<a href="#l1.8163"></a><span id="l1.8163">         var pos = parts[0];</span>
<a href="#l1.8164"></a><span id="l1.8164">         var dow = parts[1];</span>
<a href="#l1.8165"></a><span id="l1.8165"> </span>
<a href="#l1.8166"></a><span id="l1.8166">         if (pos == 0) {</span>
<a href="#l1.8167"></a><span id="l1.8167">           var tmp_start_doy = ((dow + 7 - start_dow) % 7) + 1;</span>
<a href="#l1.8168"></a><span id="l1.8168"> </span>
<a href="#l1.8169"></a><span id="l1.8169" class="difflineat">@@ -5585,16 +7993,20 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8170"></a><span id="l1.8170">           days_list.push(last - (pos - 1) * 7);</span>
<a href="#l1.8171"></a><span id="l1.8171">         }</span>
<a href="#l1.8172"></a><span id="l1.8172">       }</span>
<a href="#l1.8173"></a><span id="l1.8173">       return days_list;</span>
<a href="#l1.8174"></a><span id="l1.8174">     },</span>
<a href="#l1.8175"></a><span id="l1.8175"> </span>
<a href="#l1.8176"></a><span id="l1.8176">     is_day_in_byday: function is_day_in_byday(tt) {</span>
<a href="#l1.8177"></a><span id="l1.8177">       for (var daykey in this.by_data.BYDAY) {</span>
<a href="#l1.8178"></a><span id="l1.8178" class="difflineplus">+        /* istanbul ignore if */</span>
<a href="#l1.8179"></a><span id="l1.8179" class="difflineplus">+        if (!this.by_data.BYDAY.hasOwnProperty(daykey)) {</span>
<a href="#l1.8180"></a><span id="l1.8180" class="difflineplus">+          continue;</span>
<a href="#l1.8181"></a><span id="l1.8181" class="difflineplus">+        }</span>
<a href="#l1.8182"></a><span id="l1.8182">         var day = this.by_data.BYDAY[daykey];</span>
<a href="#l1.8183"></a><span id="l1.8183">         var parts = this.ruleDayOfWeek(day);</span>
<a href="#l1.8184"></a><span id="l1.8184">         var pos = parts[0];</span>
<a href="#l1.8185"></a><span id="l1.8185">         var dow = parts[1];</span>
<a href="#l1.8186"></a><span id="l1.8186">         var this_dow = tt.dayOfWeek();</span>
<a href="#l1.8187"></a><span id="l1.8187"> </span>
<a href="#l1.8188"></a><span id="l1.8188">         if ((pos == 0 &amp;&amp; dow == this_dow) ||</span>
<a href="#l1.8189"></a><span id="l1.8189">             (tt.nthWeekDay(dow, pos) == tt.day)) {</span>
<a href="#l1.8190"></a><span id="l1.8190" class="difflineat">@@ -5603,16 +8015,17 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8191"></a><span id="l1.8191">       }</span>
<a href="#l1.8192"></a><span id="l1.8192"> </span>
<a href="#l1.8193"></a><span id="l1.8193">       return 0;</span>
<a href="#l1.8194"></a><span id="l1.8194">     },</span>
<a href="#l1.8195"></a><span id="l1.8195"> </span>
<a href="#l1.8196"></a><span id="l1.8196">     /**</span>
<a href="#l1.8197"></a><span id="l1.8197">      * Checks if given value is in BYSETPOS.</span>
<a href="#l1.8198"></a><span id="l1.8198">      *</span>
<a href="#l1.8199"></a><span id="l1.8199" class="difflineplus">+     * @private</span>
<a href="#l1.8200"></a><span id="l1.8200">      * @param {Numeric} aPos position to check for.</span>
<a href="#l1.8201"></a><span id="l1.8201">      * @return {Boolean} false unless BYSETPOS rules exist</span>
<a href="#l1.8202"></a><span id="l1.8202">      *                   and the given value is present in rules.</span>
<a href="#l1.8203"></a><span id="l1.8203">      */</span>
<a href="#l1.8204"></a><span id="l1.8204">     check_set_position: function check_set_position(aPos) {</span>
<a href="#l1.8205"></a><span id="l1.8205">       if (this.has_by_data('BYSETPOS')) {</span>
<a href="#l1.8206"></a><span id="l1.8206">         var idx = this.by_data.BYSETPOS.indexOf(aPos);</span>
<a href="#l1.8207"></a><span id="l1.8207">         // negative numbers are not false-y</span>
<a href="#l1.8208"></a><span id="l1.8208" class="difflineat">@@ -5646,19 +8059,22 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8209"></a><span id="l1.8209">       var pass = false;</span>
<a href="#l1.8210"></a><span id="l1.8210"> </span>
<a href="#l1.8211"></a><span id="l1.8211">       if (aRuleType in this.by_data &amp;&amp;</span>
<a href="#l1.8212"></a><span id="l1.8212">           ruleMapValue == icalrecur_iterator.CONTRACT) {</span>
<a href="#l1.8213"></a><span id="l1.8213"> </span>
<a href="#l1.8214"></a><span id="l1.8214">         var ruleType = this.by_data[aRuleType];</span>
<a href="#l1.8215"></a><span id="l1.8215"> </span>
<a href="#l1.8216"></a><span id="l1.8216">         for (var bydatakey in ruleType) {</span>
<a href="#l1.8217"></a><span id="l1.8217" class="difflineminus">-          if (ruleType[bydatakey] == v) {</span>
<a href="#l1.8218"></a><span id="l1.8218" class="difflineminus">-            pass = true;</span>
<a href="#l1.8219"></a><span id="l1.8219" class="difflineminus">-            break;</span>
<a href="#l1.8220"></a><span id="l1.8220" class="difflineplus">+          /* istanbul ignore else */</span>
<a href="#l1.8221"></a><span id="l1.8221" class="difflineplus">+          if (ruleType.hasOwnProperty(bydatakey)) {</span>
<a href="#l1.8222"></a><span id="l1.8222" class="difflineplus">+            if (ruleType[bydatakey] == v) {</span>
<a href="#l1.8223"></a><span id="l1.8223" class="difflineplus">+              pass = true;</span>
<a href="#l1.8224"></a><span id="l1.8224" class="difflineplus">+              break;</span>
<a href="#l1.8225"></a><span id="l1.8225" class="difflineplus">+            }</span>
<a href="#l1.8226"></a><span id="l1.8226">           }</span>
<a href="#l1.8227"></a><span id="l1.8227">         }</span>
<a href="#l1.8228"></a><span id="l1.8228">       } else {</span>
<a href="#l1.8229"></a><span id="l1.8229">         // Not a contracting byrule or has no data, test passes</span>
<a href="#l1.8230"></a><span id="l1.8230">         pass = true;</span>
<a href="#l1.8231"></a><span id="l1.8231">       }</span>
<a href="#l1.8232"></a><span id="l1.8232">       return pass;</span>
<a href="#l1.8233"></a><span id="l1.8233">     },</span>
<a href="#l1.8234"></a><span id="l1.8234" class="difflineat">@@ -5689,35 +8105,35 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8235"></a><span id="l1.8235">         if (this.rule.freq != req) {</span>
<a href="#l1.8236"></a><span id="l1.8236">           return this.by_data[aRuleType][0];</span>
<a href="#l1.8237"></a><span id="l1.8237">         }</span>
<a href="#l1.8238"></a><span id="l1.8238">       }</span>
<a href="#l1.8239"></a><span id="l1.8239">       return deftime;</span>
<a href="#l1.8240"></a><span id="l1.8240">     },</span>
<a href="#l1.8241"></a><span id="l1.8241"> </span>
<a href="#l1.8242"></a><span id="l1.8242">     /**</span>
<a href="#l1.8243"></a><span id="l1.8243" class="difflineminus">-     * Convert iterator into a serialize-able object.</span>
<a href="#l1.8244"></a><span id="l1.8244" class="difflineminus">-     * Will preserve current iteration sequence to ensure</span>
<a href="#l1.8245"></a><span id="l1.8245" class="difflineminus">-     * the seamless continuation of the recurrence rule.</span>
<a href="#l1.8246"></a><span id="l1.8246" class="difflineplus">+     * Convert iterator into a serialize-able object.  Will preserve current</span>
<a href="#l1.8247"></a><span id="l1.8247" class="difflineplus">+     * iteration sequence to ensure the seamless continuation of the recurrence</span>
<a href="#l1.8248"></a><span id="l1.8248" class="difflineplus">+     * rule.</span>
<a href="#l1.8249"></a><span id="l1.8249" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.8250"></a><span id="l1.8250">      */</span>
<a href="#l1.8251"></a><span id="l1.8251">     toJSON: function() {</span>
<a href="#l1.8252"></a><span id="l1.8252">       var result = Object.create(null);</span>
<a href="#l1.8253"></a><span id="l1.8253"> </span>
<a href="#l1.8254"></a><span id="l1.8254">       result.initialized = this.initialized;</span>
<a href="#l1.8255"></a><span id="l1.8255">       result.rule = this.rule.toJSON();</span>
<a href="#l1.8256"></a><span id="l1.8256">       result.dtstart = this.dtstart.toJSON();</span>
<a href="#l1.8257"></a><span id="l1.8257">       result.by_data = this.by_data;</span>
<a href="#l1.8258"></a><span id="l1.8258">       result.days = this.days;</span>
<a href="#l1.8259"></a><span id="l1.8259">       result.last = this.last.toJSON();</span>
<a href="#l1.8260"></a><span id="l1.8260">       result.by_indices = this.by_indices;</span>
<a href="#l1.8261"></a><span id="l1.8261">       result.occurrence_number = this.occurrence_number;</span>
<a href="#l1.8262"></a><span id="l1.8262"> </span>
<a href="#l1.8263"></a><span id="l1.8263">       return result;</span>
<a href="#l1.8264"></a><span id="l1.8264">     }</span>
<a href="#l1.8265"></a><span id="l1.8265" class="difflineminus">-</span>
<a href="#l1.8266"></a><span id="l1.8266">   };</span>
<a href="#l1.8267"></a><span id="l1.8267"> </span>
<a href="#l1.8268"></a><span id="l1.8268">   icalrecur_iterator._indexMap = {</span>
<a href="#l1.8269"></a><span id="l1.8269">     &quot;BYSECOND&quot;: 0,</span>
<a href="#l1.8270"></a><span id="l1.8270">     &quot;BYMINUTE&quot;: 1,</span>
<a href="#l1.8271"></a><span id="l1.8271">     &quot;BYHOUR&quot;: 2,</span>
<a href="#l1.8272"></a><span id="l1.8272">     &quot;BYDAY&quot;: 3,</span>
<a href="#l1.8273"></a><span id="l1.8273">     &quot;BYMONTHDAY&quot;: 4,</span>
<a href="#l1.8274"></a><span id="l1.8274" class="difflineat">@@ -5739,175 +8155,207 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.8275"></a><span id="l1.8275">   icalrecur_iterator.UNKNOWN = 0;</span>
<a href="#l1.8276"></a><span id="l1.8276">   icalrecur_iterator.CONTRACT = 1;</span>
<a href="#l1.8277"></a><span id="l1.8277">   icalrecur_iterator.EXPAND = 2;</span>
<a href="#l1.8278"></a><span id="l1.8278">   icalrecur_iterator.ILLEGAL = 3;</span>
<a href="#l1.8279"></a><span id="l1.8279"> </span>
<a href="#l1.8280"></a><span id="l1.8280">   return icalrecur_iterator;</span>
<a href="#l1.8281"></a><span id="l1.8281"> </span>
<a href="#l1.8282"></a><span id="l1.8282"> }());</span>
<a href="#l1.8283"></a><span id="l1.8283" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.8284"></a><span id="l1.8284" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8285"></a><span id="l1.8285" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.8286"></a><span id="l1.8286" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.8287"></a><span id="l1.8287" class="difflineplus">+</span>
<a href="#l1.8288"></a><span id="l1.8288" class="difflineplus">+</span>
<a href="#l1.8289"></a><span id="l1.8289" class="difflineplus">+/**</span>
<a href="#l1.8290"></a><span id="l1.8290" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.8291"></a><span id="l1.8291" class="difflineplus">+ * @ignore</span>
<a href="#l1.8292"></a><span id="l1.8292" class="difflineplus">+ */</span>
<a href="#l1.8293"></a><span id="l1.8293"> ICAL.RecurExpansion = (function() {</span>
<a href="#l1.8294"></a><span id="l1.8294">   function formatTime(item) {</span>
<a href="#l1.8295"></a><span id="l1.8295">     return ICAL.helpers.formatClassType(item, ICAL.Time);</span>
<a href="#l1.8296"></a><span id="l1.8296">   }</span>
<a href="#l1.8297"></a><span id="l1.8297"> </span>
<a href="#l1.8298"></a><span id="l1.8298">   function compareTime(a, b) {</span>
<a href="#l1.8299"></a><span id="l1.8299">     return a.compare(b);</span>
<a href="#l1.8300"></a><span id="l1.8300">   }</span>
<a href="#l1.8301"></a><span id="l1.8301"> </span>
<a href="#l1.8302"></a><span id="l1.8302">   function isRecurringComponent(comp) {</span>
<a href="#l1.8303"></a><span id="l1.8303">     return comp.hasProperty('rdate') ||</span>
<a href="#l1.8304"></a><span id="l1.8304">            comp.hasProperty('rrule') ||</span>
<a href="#l1.8305"></a><span id="l1.8305">            comp.hasProperty('recurrence-id');</span>
<a href="#l1.8306"></a><span id="l1.8306">   }</span>
<a href="#l1.8307"></a><span id="l1.8307"> </span>
<a href="#l1.8308"></a><span id="l1.8308">   /**</span>
<a href="#l1.8309"></a><span id="l1.8309" class="difflineminus">-   * Primary class for expanding recurring rules.</span>
<a href="#l1.8310"></a><span id="l1.8310" class="difflineminus">-   * Can take multiple rrules, rdates, exdate(s)</span>
<a href="#l1.8311"></a><span id="l1.8311" class="difflineminus">-   * and iterate (in order) over each next occurrence.</span>
<a href="#l1.8312"></a><span id="l1.8312" class="difflineminus">-   *</span>
<a href="#l1.8313"></a><span id="l1.8313" class="difflineminus">-   * Once initialized this class can also be serialized</span>
<a href="#l1.8314"></a><span id="l1.8314" class="difflineminus">-   * saved and continue iteration from the last point.</span>
<a href="#l1.8315"></a><span id="l1.8315" class="difflineplus">+   * @classdesc</span>
<a href="#l1.8316"></a><span id="l1.8316" class="difflineplus">+   * Primary class for expanding recurring rules.  Can take multiple rrules,</span>
<a href="#l1.8317"></a><span id="l1.8317" class="difflineplus">+   * rdates, exdate(s) and iterate (in order) over each next occurrence.</span>
<a href="#l1.8318"></a><span id="l1.8318" class="difflineplus">+   *</span>
<a href="#l1.8319"></a><span id="l1.8319" class="difflineplus">+   * Once initialized this class can also be serialized saved and continue</span>
<a href="#l1.8320"></a><span id="l1.8320" class="difflineplus">+   * iteration from the last point.</span>
<a href="#l1.8321"></a><span id="l1.8321">    *</span>
<a href="#l1.8322"></a><span id="l1.8322">    * NOTE: it is intended that this class is to be used</span>
<a href="#l1.8323"></a><span id="l1.8323">    *       with ICAL.Event which handles recurrence exceptions.</span>
<a href="#l1.8324"></a><span id="l1.8324">    *</span>
<a href="#l1.8325"></a><span id="l1.8325" class="difflineminus">-   * Options:</span>
<a href="#l1.8326"></a><span id="l1.8326" class="difflineminus">-   *  - dtstart: (ICAL.Time) start time of event (required)</span>
<a href="#l1.8327"></a><span id="l1.8327" class="difflineminus">-   *  - component: (ICAL.Component) component (required unless resuming)</span>
<a href="#l1.8328"></a><span id="l1.8328" class="difflineminus">-   *</span>
<a href="#l1.8329"></a><span id="l1.8329" class="difflineminus">-   * Examples:</span>
<a href="#l1.8330"></a><span id="l1.8330" class="difflineminus">-   *</span>
<a href="#l1.8331"></a><span id="l1.8331" class="difflineminus">-   *    // assuming event is a parsed ical component</span>
<a href="#l1.8332"></a><span id="l1.8332" class="difflineminus">-   *    var event;</span>
<a href="#l1.8333"></a><span id="l1.8333" class="difflineminus">-   *</span>
<a href="#l1.8334"></a><span id="l1.8334" class="difflineminus">-   *    var expand = new ICAL.RecurExpansion({</span>
<a href="#l1.8335"></a><span id="l1.8335" class="difflineminus">-   *      component: event,</span>
<a href="#l1.8336"></a><span id="l1.8336" class="difflineminus">-   *      start: event.getFirstPropertyValue('DTSTART')</span>
<a href="#l1.8337"></a><span id="l1.8337" class="difflineminus">-   *    });</span>
<a href="#l1.8338"></a><span id="l1.8338" class="difflineminus">-   *</span>
<a href="#l1.8339"></a><span id="l1.8339" class="difflineminus">-   *    // remember there are infinite rules</span>
<a href="#l1.8340"></a><span id="l1.8340" class="difflineminus">-   *    // so its a good idea to limit the scope</span>
<a href="#l1.8341"></a><span id="l1.8341" class="difflineminus">-   *    // of the iterations then resume later on.</span>
<a href="#l1.8342"></a><span id="l1.8342" class="difflineminus">-   *</span>
<a href="#l1.8343"></a><span id="l1.8343" class="difflineminus">-   *    // next is always an ICAL.Time or null</span>
<a href="#l1.8344"></a><span id="l1.8344" class="difflineminus">-   *    var next;</span>
<a href="#l1.8345"></a><span id="l1.8345" class="difflineminus">-   *</span>
<a href="#l1.8346"></a><span id="l1.8346" class="difflineminus">-   *    while(someCondition &amp;&amp; (next = expand.next())) {</span>
<a href="#l1.8347"></a><span id="l1.8347" class="difflineminus">-   *      // do something with next</span>
<a href="#l1.8348"></a><span id="l1.8348" class="difflineminus">-   *    }</span>
<a href="#l1.8349"></a><span id="l1.8349" class="difflineminus">-   *</span>
<a href="#l1.8350"></a><span id="l1.8350" class="difflineminus">-   *    // save instance for later</span>
<a href="#l1.8351"></a><span id="l1.8351" class="difflineminus">-   *    var json = JSON.stringify(expand);</span>
<a href="#l1.8352"></a><span id="l1.8352" class="difflineminus">-   *</span>
<a href="#l1.8353"></a><span id="l1.8353" class="difflineminus">-   *    //...</span>
<a href="#l1.8354"></a><span id="l1.8354" class="difflineminus">-   *</span>
<a href="#l1.8355"></a><span id="l1.8355" class="difflineminus">-   *    // NOTE: if the component's properties have</span>
<a href="#l1.8356"></a><span id="l1.8356" class="difflineminus">-   *    //       changed you will need to rebuild the</span>
<a href="#l1.8357"></a><span id="l1.8357" class="difflineminus">-   *    //       class and start over. This only works</span>
<a href="#l1.8358"></a><span id="l1.8358" class="difflineminus">-   *    //       when the component's recurrence info is the same.</span>
<a href="#l1.8359"></a><span id="l1.8359" class="difflineminus">-   *    var expand = new ICAL.RecurExpansion(JSON.parse(json));</span>
<a href="#l1.8360"></a><span id="l1.8360" class="difflineminus">-   *</span>
<a href="#l1.8361"></a><span id="l1.8361" class="difflineminus">-   *</span>
<a href="#l1.8362"></a><span id="l1.8362" class="difflineminus">-   * @param {Object} options see options block.</span>
<a href="#l1.8363"></a><span id="l1.8363" class="difflineplus">+   * @example</span>
<a href="#l1.8364"></a><span id="l1.8364" class="difflineplus">+   * // assuming event is a parsed ical component</span>
<a href="#l1.8365"></a><span id="l1.8365" class="difflineplus">+   * var event;</span>
<a href="#l1.8366"></a><span id="l1.8366" class="difflineplus">+   *</span>
<a href="#l1.8367"></a><span id="l1.8367" class="difflineplus">+   * var expand = new ICAL.RecurExpansion({</span>
<a href="#l1.8368"></a><span id="l1.8368" class="difflineplus">+   *   component: event,</span>
<a href="#l1.8369"></a><span id="l1.8369" class="difflineplus">+   *   dtstart: event.getFirstPropertyValue('dtstart')</span>
<a href="#l1.8370"></a><span id="l1.8370" class="difflineplus">+   * });</span>
<a href="#l1.8371"></a><span id="l1.8371" class="difflineplus">+   *</span>
<a href="#l1.8372"></a><span id="l1.8372" class="difflineplus">+   * // remember there are infinite rules</span>
<a href="#l1.8373"></a><span id="l1.8373" class="difflineplus">+   * // so its a good idea to limit the scope</span>
<a href="#l1.8374"></a><span id="l1.8374" class="difflineplus">+   * // of the iterations then resume later on.</span>
<a href="#l1.8375"></a><span id="l1.8375" class="difflineplus">+   *</span>
<a href="#l1.8376"></a><span id="l1.8376" class="difflineplus">+   * // next is always an ICAL.Time or null</span>
<a href="#l1.8377"></a><span id="l1.8377" class="difflineplus">+   * var next;</span>
<a href="#l1.8378"></a><span id="l1.8378" class="difflineplus">+   *</span>
<a href="#l1.8379"></a><span id="l1.8379" class="difflineplus">+   * while (someCondition &amp;&amp; (next = expand.next())) {</span>
<a href="#l1.8380"></a><span id="l1.8380" class="difflineplus">+   *   // do something with next</span>
<a href="#l1.8381"></a><span id="l1.8381" class="difflineplus">+   * }</span>
<a href="#l1.8382"></a><span id="l1.8382" class="difflineplus">+   *</span>
<a href="#l1.8383"></a><span id="l1.8383" class="difflineplus">+   * // save instance for later</span>
<a href="#l1.8384"></a><span id="l1.8384" class="difflineplus">+   * var json = JSON.stringify(expand);</span>
<a href="#l1.8385"></a><span id="l1.8385" class="difflineplus">+   *</span>
<a href="#l1.8386"></a><span id="l1.8386" class="difflineplus">+   * //...</span>
<a href="#l1.8387"></a><span id="l1.8387" class="difflineplus">+   *</span>
<a href="#l1.8388"></a><span id="l1.8388" class="difflineplus">+   * // NOTE: if the component's properties have</span>
<a href="#l1.8389"></a><span id="l1.8389" class="difflineplus">+   * //       changed you will need to rebuild the</span>
<a href="#l1.8390"></a><span id="l1.8390" class="difflineplus">+   * //       class and start over. This only works</span>
<a href="#l1.8391"></a><span id="l1.8391" class="difflineplus">+   * //       when the component's recurrence info is the same.</span>
<a href="#l1.8392"></a><span id="l1.8392" class="difflineplus">+   * var expand = new ICAL.RecurExpansion(JSON.parse(json));</span>
<a href="#l1.8393"></a><span id="l1.8393" class="difflineplus">+   *</span>
<a href="#l1.8394"></a><span id="l1.8394" class="difflineplus">+   * @description</span>
<a href="#l1.8395"></a><span id="l1.8395" class="difflineplus">+   * The options object can be filled with the specified initial values. It can</span>
<a href="#l1.8396"></a><span id="l1.8396" class="difflineplus">+   * also contain additional members, as a result of serializing a previous</span>
<a href="#l1.8397"></a><span id="l1.8397" class="difflineplus">+   * expansion state, as shown in the example.</span>
<a href="#l1.8398"></a><span id="l1.8398" class="difflineplus">+   *</span>
<a href="#l1.8399"></a><span id="l1.8399" class="difflineplus">+   * @class</span>
<a href="#l1.8400"></a><span id="l1.8400" class="difflineplus">+   * @alias ICAL.RecurExpansion</span>
<a href="#l1.8401"></a><span id="l1.8401" class="difflineplus">+   * @param {Object} options</span>
<a href="#l1.8402"></a><span id="l1.8402" class="difflineplus">+   *        Recurrence expansion options</span>
<a href="#l1.8403"></a><span id="l1.8403" class="difflineplus">+   * @param {ICAL.Time} options.dtstart</span>
<a href="#l1.8404"></a><span id="l1.8404" class="difflineplus">+   *        Start time of the event</span>
<a href="#l1.8405"></a><span id="l1.8405" class="difflineplus">+   * @param {ICAL.Component=} options.component</span>
<a href="#l1.8406"></a><span id="l1.8406" class="difflineplus">+   *        Component for expansion, required if not resuming.</span>
<a href="#l1.8407"></a><span id="l1.8407">    */</span>
<a href="#l1.8408"></a><span id="l1.8408">   function RecurExpansion(options) {</span>
<a href="#l1.8409"></a><span id="l1.8409">     this.ruleDates = [];</span>
<a href="#l1.8410"></a><span id="l1.8410">     this.exDates = [];</span>
<a href="#l1.8411"></a><span id="l1.8411">     this.fromData(options);</span>
<a href="#l1.8412"></a><span id="l1.8412">   }</span>
<a href="#l1.8413"></a><span id="l1.8413"> </span>
<a href="#l1.8414"></a><span id="l1.8414">   RecurExpansion.prototype = {</span>
<a href="#l1.8415"></a><span id="l1.8415" class="difflineminus">-</span>
<a href="#l1.8416"></a><span id="l1.8416">     /**</span>
<a href="#l1.8417"></a><span id="l1.8417">      * True when iteration is fully completed.</span>
<a href="#l1.8418"></a><span id="l1.8418" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.8419"></a><span id="l1.8419">      */</span>
<a href="#l1.8420"></a><span id="l1.8420">     complete: false,</span>
<a href="#l1.8421"></a><span id="l1.8421"> </span>
<a href="#l1.8422"></a><span id="l1.8422">     /**</span>
<a href="#l1.8423"></a><span id="l1.8423">      * Array of rrule iterators.</span>
<a href="#l1.8424"></a><span id="l1.8424">      *</span>
<a href="#l1.8425"></a><span id="l1.8425" class="difflineminus">-     * @type Array[ICAL.RecurIterator]</span>
<a href="#l1.8426"></a><span id="l1.8426" class="difflineplus">+     * @type {ICAL.RecurIterator[]}</span>
<a href="#l1.8427"></a><span id="l1.8427">      * @private</span>
<a href="#l1.8428"></a><span id="l1.8428">      */</span>
<a href="#l1.8429"></a><span id="l1.8429">     ruleIterators: null,</span>
<a href="#l1.8430"></a><span id="l1.8430"> </span>
<a href="#l1.8431"></a><span id="l1.8431">     /**</span>
<a href="#l1.8432"></a><span id="l1.8432">      * Array of rdate instances.</span>
<a href="#l1.8433"></a><span id="l1.8433">      *</span>
<a href="#l1.8434"></a><span id="l1.8434" class="difflineminus">-     * @type Array[ICAL.Time]</span>
<a href="#l1.8435"></a><span id="l1.8435" class="difflineplus">+     * @type {ICAL.Time[]}</span>
<a href="#l1.8436"></a><span id="l1.8436">      * @private</span>
<a href="#l1.8437"></a><span id="l1.8437">      */</span>
<a href="#l1.8438"></a><span id="l1.8438">     ruleDates: null,</span>
<a href="#l1.8439"></a><span id="l1.8439"> </span>
<a href="#l1.8440"></a><span id="l1.8440">     /**</span>
<a href="#l1.8441"></a><span id="l1.8441">      * Array of exdate instances.</span>
<a href="#l1.8442"></a><span id="l1.8442">      *</span>
<a href="#l1.8443"></a><span id="l1.8443" class="difflineminus">-     * @type Array[ICAL.Time]</span>
<a href="#l1.8444"></a><span id="l1.8444" class="difflineplus">+     * @type {ICAL.Time[]}</span>
<a href="#l1.8445"></a><span id="l1.8445">      * @private</span>
<a href="#l1.8446"></a><span id="l1.8446">      */</span>
<a href="#l1.8447"></a><span id="l1.8447">     exDates: null,</span>
<a href="#l1.8448"></a><span id="l1.8448"> </span>
<a href="#l1.8449"></a><span id="l1.8449">     /**</span>
<a href="#l1.8450"></a><span id="l1.8450">      * Current position in ruleDates array.</span>
<a href="#l1.8451"></a><span id="l1.8451" class="difflineminus">-     * @type Numeric</span>
<a href="#l1.8452"></a><span id="l1.8452" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.8453"></a><span id="l1.8453">      * @private</span>
<a href="#l1.8454"></a><span id="l1.8454">      */</span>
<a href="#l1.8455"></a><span id="l1.8455">     ruleDateInc: 0,</span>
<a href="#l1.8456"></a><span id="l1.8456"> </span>
<a href="#l1.8457"></a><span id="l1.8457">     /**</span>
<a href="#l1.8458"></a><span id="l1.8458">      * Current position in exDates array</span>
<a href="#l1.8459"></a><span id="l1.8459" class="difflineminus">-     * @type Numeric</span>
<a href="#l1.8460"></a><span id="l1.8460" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.8461"></a><span id="l1.8461">      * @private</span>
<a href="#l1.8462"></a><span id="l1.8462">      */</span>
<a href="#l1.8463"></a><span id="l1.8463">     exDateInc: 0,</span>
<a href="#l1.8464"></a><span id="l1.8464"> </span>
<a href="#l1.8465"></a><span id="l1.8465">     /**</span>
<a href="#l1.8466"></a><span id="l1.8466">      * Current negative date.</span>
<a href="#l1.8467"></a><span id="l1.8467">      *</span>
<a href="#l1.8468"></a><span id="l1.8468" class="difflineminus">-     * @type ICAL.Time</span>
<a href="#l1.8469"></a><span id="l1.8469" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.8470"></a><span id="l1.8470">      * @private</span>
<a href="#l1.8471"></a><span id="l1.8471">      */</span>
<a href="#l1.8472"></a><span id="l1.8472">     exDate: null,</span>
<a href="#l1.8473"></a><span id="l1.8473"> </span>
<a href="#l1.8474"></a><span id="l1.8474">     /**</span>
<a href="#l1.8475"></a><span id="l1.8475">      * Current additional date.</span>
<a href="#l1.8476"></a><span id="l1.8476">      *</span>
<a href="#l1.8477"></a><span id="l1.8477" class="difflineminus">-     * @type ICAL.Time</span>
<a href="#l1.8478"></a><span id="l1.8478" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.8479"></a><span id="l1.8479">      * @private</span>
<a href="#l1.8480"></a><span id="l1.8480">      */</span>
<a href="#l1.8481"></a><span id="l1.8481">     ruleDate: null,</span>
<a href="#l1.8482"></a><span id="l1.8482"> </span>
<a href="#l1.8483"></a><span id="l1.8483">     /**</span>
<a href="#l1.8484"></a><span id="l1.8484">      * Start date of recurring rules.</span>
<a href="#l1.8485"></a><span id="l1.8485">      *</span>
<a href="#l1.8486"></a><span id="l1.8486" class="difflineminus">-     * @type ICAL.Time</span>
<a href="#l1.8487"></a><span id="l1.8487" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.8488"></a><span id="l1.8488">      */</span>
<a href="#l1.8489"></a><span id="l1.8489">     dtstart: null,</span>
<a href="#l1.8490"></a><span id="l1.8490"> </span>
<a href="#l1.8491"></a><span id="l1.8491">     /**</span>
<a href="#l1.8492"></a><span id="l1.8492">      * Last expanded time</span>
<a href="#l1.8493"></a><span id="l1.8493">      *</span>
<a href="#l1.8494"></a><span id="l1.8494" class="difflineminus">-     * @type ICAL.Time</span>
<a href="#l1.8495"></a><span id="l1.8495" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.8496"></a><span id="l1.8496">      */</span>
<a href="#l1.8497"></a><span id="l1.8497">     last: null,</span>
<a href="#l1.8498"></a><span id="l1.8498"> </span>
<a href="#l1.8499"></a><span id="l1.8499" class="difflineplus">+    /**</span>
<a href="#l1.8500"></a><span id="l1.8500" class="difflineplus">+     * Initialize the recurrence expansion from the data object. The options</span>
<a href="#l1.8501"></a><span id="l1.8501" class="difflineplus">+     * object may also contain additional members, see the</span>
<a href="#l1.8502"></a><span id="l1.8502" class="difflineplus">+     * {@link ICAL.RecurExpansion constructor} for more details.</span>
<a href="#l1.8503"></a><span id="l1.8503" class="difflineplus">+     *</span>
<a href="#l1.8504"></a><span id="l1.8504" class="difflineplus">+     * @param {Object} options</span>
<a href="#l1.8505"></a><span id="l1.8505" class="difflineplus">+     *        Recurrence expansion options</span>
<a href="#l1.8506"></a><span id="l1.8506" class="difflineplus">+     * @param {ICAL.Time} options.dtstart</span>
<a href="#l1.8507"></a><span id="l1.8507" class="difflineplus">+     *        Start time of the event</span>
<a href="#l1.8508"></a><span id="l1.8508" class="difflineplus">+     * @param {ICAL.Component=} options.component</span>
<a href="#l1.8509"></a><span id="l1.8509" class="difflineplus">+     *        Component for expansion, required if not resuming.</span>
<a href="#l1.8510"></a><span id="l1.8510" class="difflineplus">+     */</span>
<a href="#l1.8511"></a><span id="l1.8511">     fromData: function(options) {</span>
<a href="#l1.8512"></a><span id="l1.8512">       var start = ICAL.helpers.formatClassType(options.dtstart, ICAL.Time);</span>
<a href="#l1.8513"></a><span id="l1.8513"> </span>
<a href="#l1.8514"></a><span id="l1.8514">       if (!start) {</span>
<a href="#l1.8515"></a><span id="l1.8515">         throw new Error('.dtstart (ICAL.Time) must be given');</span>
<a href="#l1.8516"></a><span id="l1.8516">       } else {</span>
<a href="#l1.8517"></a><span id="l1.8517">         this.dtstart = start;</span>
<a href="#l1.8518"></a><span id="l1.8518">       }</span>
<a href="#l1.8519"></a><span id="l1.8519"> </span>
<a href="#l1.8520"></a><span id="l1.8520">       if (options.component) {</span>
<a href="#l1.8521"></a><span id="l1.8521">         this._init(options.component);</span>
<a href="#l1.8522"></a><span id="l1.8522">       } else {</span>
<a href="#l1.8523"></a><span id="l1.8523" class="difflineminus">-        this.last = formatTime(options.last);</span>
<a href="#l1.8524"></a><span id="l1.8524" class="difflineplus">+        this.last = formatTime(options.last) || start.clone();</span>
<a href="#l1.8525"></a><span id="l1.8525" class="difflineplus">+</span>
<a href="#l1.8526"></a><span id="l1.8526" class="difflineplus">+        if (!options.ruleIterators) {</span>
<a href="#l1.8527"></a><span id="l1.8527" class="difflineplus">+          throw new Error('.ruleIterators or .component must be given');</span>
<a href="#l1.8528"></a><span id="l1.8528" class="difflineplus">+        }</span>
<a href="#l1.8529"></a><span id="l1.8529"> </span>
<a href="#l1.8530"></a><span id="l1.8530">         this.ruleIterators = options.ruleIterators.map(function(item) {</span>
<a href="#l1.8531"></a><span id="l1.8531">           return ICAL.helpers.formatClassType(item, ICAL.RecurIterator);</span>
<a href="#l1.8532"></a><span id="l1.8532">         });</span>
<a href="#l1.8533"></a><span id="l1.8533"> </span>
<a href="#l1.8534"></a><span id="l1.8534">         this.ruleDateInc = options.ruleDateInc;</span>
<a href="#l1.8535"></a><span id="l1.8535">         this.exDateInc = options.exDateInc;</span>
<a href="#l1.8536"></a><span id="l1.8536"> </span>
<a href="#l1.8537"></a><span id="l1.8537" class="difflineat">@@ -5922,16 +8370,20 @@ ICAL.RecurExpansion = (function() {</span>
<a href="#l1.8538"></a><span id="l1.8538">         }</span>
<a href="#l1.8539"></a><span id="l1.8539"> </span>
<a href="#l1.8540"></a><span id="l1.8540">         if (typeof(options.complete) !== 'undefined') {</span>
<a href="#l1.8541"></a><span id="l1.8541">           this.complete = options.complete;</span>
<a href="#l1.8542"></a><span id="l1.8542">         }</span>
<a href="#l1.8543"></a><span id="l1.8543">       }</span>
<a href="#l1.8544"></a><span id="l1.8544">     },</span>
<a href="#l1.8545"></a><span id="l1.8545"> </span>
<a href="#l1.8546"></a><span id="l1.8546" class="difflineplus">+    /**</span>
<a href="#l1.8547"></a><span id="l1.8547" class="difflineplus">+     * Retrieve the next occurrence in the series.</span>
<a href="#l1.8548"></a><span id="l1.8548" class="difflineplus">+     * @return {ICAL.Time}</span>
<a href="#l1.8549"></a><span id="l1.8549" class="difflineplus">+     */</span>
<a href="#l1.8550"></a><span id="l1.8550">     next: function() {</span>
<a href="#l1.8551"></a><span id="l1.8551">       var iter;</span>
<a href="#l1.8552"></a><span id="l1.8552">       var ruleOfDay;</span>
<a href="#l1.8553"></a><span id="l1.8553">       var next;</span>
<a href="#l1.8554"></a><span id="l1.8554">       var compare;</span>
<a href="#l1.8555"></a><span id="l1.8555"> </span>
<a href="#l1.8556"></a><span id="l1.8556">       var maxTries = 500;</span>
<a href="#l1.8557"></a><span id="l1.8557">       var currentTry = 0;</span>
<a href="#l1.8558"></a><span id="l1.8558" class="difflineat">@@ -5992,17 +8444,19 @@ ICAL.RecurExpansion = (function() {</span>
<a href="#l1.8559"></a><span id="l1.8559">         //     intuitive to what I have seen most servers do so for now</span>
<a href="#l1.8560"></a><span id="l1.8560">         //     I exclude based on the original date not the one that may</span>
<a href="#l1.8561"></a><span id="l1.8561">         //     have been modified by the exception.</span>
<a href="#l1.8562"></a><span id="l1.8562">         return this.last;</span>
<a href="#l1.8563"></a><span id="l1.8563">       }</span>
<a href="#l1.8564"></a><span id="l1.8564">     },</span>
<a href="#l1.8565"></a><span id="l1.8565"> </span>
<a href="#l1.8566"></a><span id="l1.8566">     /**</span>
<a href="#l1.8567"></a><span id="l1.8567" class="difflineminus">-     * Converts object into a serialize-able format.</span>
<a href="#l1.8568"></a><span id="l1.8568" class="difflineplus">+     * Converts object into a serialize-able format. This format can be passed</span>
<a href="#l1.8569"></a><span id="l1.8569" class="difflineplus">+     * back into the expansion to resume iteration.</span>
<a href="#l1.8570"></a><span id="l1.8570" class="difflineplus">+     * @return {Object}</span>
<a href="#l1.8571"></a><span id="l1.8571">      */</span>
<a href="#l1.8572"></a><span id="l1.8572">     toJSON: function() {</span>
<a href="#l1.8573"></a><span id="l1.8573">       function toJSON(item) {</span>
<a href="#l1.8574"></a><span id="l1.8574">         return item.toJSON();</span>
<a href="#l1.8575"></a><span id="l1.8575">       }</span>
<a href="#l1.8576"></a><span id="l1.8576"> </span>
<a href="#l1.8577"></a><span id="l1.8577">       var result = Object.create(null);</span>
<a href="#l1.8578"></a><span id="l1.8578">       result.ruleIterators = this.ruleIterators.map(toJSON);</span>
<a href="#l1.8579"></a><span id="l1.8579" class="difflineat">@@ -6019,42 +8473,58 @@ ICAL.RecurExpansion = (function() {</span>
<a href="#l1.8580"></a><span id="l1.8580">       result.exDateInc = this.exDateInc;</span>
<a href="#l1.8581"></a><span id="l1.8581">       result.last = this.last.toJSON();</span>
<a href="#l1.8582"></a><span id="l1.8582">       result.dtstart = this.dtstart.toJSON();</span>
<a href="#l1.8583"></a><span id="l1.8583">       result.complete = this.complete;</span>
<a href="#l1.8584"></a><span id="l1.8584"> </span>
<a href="#l1.8585"></a><span id="l1.8585">       return result;</span>
<a href="#l1.8586"></a><span id="l1.8586">     },</span>
<a href="#l1.8587"></a><span id="l1.8587"> </span>
<a href="#l1.8588"></a><span id="l1.8588" class="difflineminus">-</span>
<a href="#l1.8589"></a><span id="l1.8589" class="difflineminus">-    _extractDates: function(component, property) {</span>
<a href="#l1.8590"></a><span id="l1.8590" class="difflineplus">+    /**</span>
<a href="#l1.8591"></a><span id="l1.8591" class="difflineplus">+     * Extract all dates from the properties in the given component. The</span>
<a href="#l1.8592"></a><span id="l1.8592" class="difflineplus">+     * properties will be filtered by the property name.</span>
<a href="#l1.8593"></a><span id="l1.8593" class="difflineplus">+     *</span>
<a href="#l1.8594"></a><span id="l1.8594" class="difflineplus">+     * @private</span>
<a href="#l1.8595"></a><span id="l1.8595" class="difflineplus">+     * @param {ICAL.Component} component        The component to search in</span>
<a href="#l1.8596"></a><span id="l1.8596" class="difflineplus">+     * @param {String} propertyName             The property name to search for</span>
<a href="#l1.8597"></a><span id="l1.8597" class="difflineplus">+     * @return {ICAL.Time[]}                    The extracted dates.</span>
<a href="#l1.8598"></a><span id="l1.8598" class="difflineplus">+     */</span>
<a href="#l1.8599"></a><span id="l1.8599" class="difflineplus">+    _extractDates: function(component, propertyName) {</span>
<a href="#l1.8600"></a><span id="l1.8600" class="difflineplus">+      function handleProp(prop) {</span>
<a href="#l1.8601"></a><span id="l1.8601" class="difflineplus">+        idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l1.8602"></a><span id="l1.8602" class="difflineplus">+          result,</span>
<a href="#l1.8603"></a><span id="l1.8603" class="difflineplus">+          prop,</span>
<a href="#l1.8604"></a><span id="l1.8604" class="difflineplus">+          compareTime</span>
<a href="#l1.8605"></a><span id="l1.8605" class="difflineplus">+        );</span>
<a href="#l1.8606"></a><span id="l1.8606" class="difflineplus">+</span>
<a href="#l1.8607"></a><span id="l1.8607" class="difflineplus">+        // ordered insert</span>
<a href="#l1.8608"></a><span id="l1.8608" class="difflineplus">+        result.splice(idx, 0, prop);</span>
<a href="#l1.8609"></a><span id="l1.8609" class="difflineplus">+      }</span>
<a href="#l1.8610"></a><span id="l1.8610" class="difflineplus">+</span>
<a href="#l1.8611"></a><span id="l1.8611">       var result = [];</span>
<a href="#l1.8612"></a><span id="l1.8612" class="difflineminus">-      var props = component.getAllProperties(property);</span>
<a href="#l1.8613"></a><span id="l1.8613" class="difflineplus">+      var props = component.getAllProperties(propertyName);</span>
<a href="#l1.8614"></a><span id="l1.8614">       var len = props.length;</span>
<a href="#l1.8615"></a><span id="l1.8615">       var i = 0;</span>
<a href="#l1.8616"></a><span id="l1.8616">       var prop;</span>
<a href="#l1.8617"></a><span id="l1.8617"> </span>
<a href="#l1.8618"></a><span id="l1.8618">       var idx;</span>
<a href="#l1.8619"></a><span id="l1.8619"> </span>
<a href="#l1.8620"></a><span id="l1.8620">       for (; i &lt; len; i++) {</span>
<a href="#l1.8621"></a><span id="l1.8621" class="difflineminus">-        props[i].getValues().forEach(function(prop) {</span>
<a href="#l1.8622"></a><span id="l1.8622" class="difflineminus">-          idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l1.8623"></a><span id="l1.8623" class="difflineminus">-            result,</span>
<a href="#l1.8624"></a><span id="l1.8624" class="difflineminus">-            prop,</span>
<a href="#l1.8625"></a><span id="l1.8625" class="difflineminus">-            compareTime</span>
<a href="#l1.8626"></a><span id="l1.8626" class="difflineminus">-          );</span>
<a href="#l1.8627"></a><span id="l1.8627" class="difflineminus">-</span>
<a href="#l1.8628"></a><span id="l1.8628" class="difflineminus">-          // ordered insert</span>
<a href="#l1.8629"></a><span id="l1.8629" class="difflineminus">-          result.splice(idx, 0, prop);</span>
<a href="#l1.8630"></a><span id="l1.8630" class="difflineminus">-        });</span>
<a href="#l1.8631"></a><span id="l1.8631" class="difflineplus">+        props[i].getValues().forEach(handleProp);</span>
<a href="#l1.8632"></a><span id="l1.8632">       }</span>
<a href="#l1.8633"></a><span id="l1.8633"> </span>
<a href="#l1.8634"></a><span id="l1.8634">       return result;</span>
<a href="#l1.8635"></a><span id="l1.8635">     },</span>
<a href="#l1.8636"></a><span id="l1.8636"> </span>
<a href="#l1.8637"></a><span id="l1.8637" class="difflineplus">+    /**</span>
<a href="#l1.8638"></a><span id="l1.8638" class="difflineplus">+     * Initialize the recurrence expansion.</span>
<a href="#l1.8639"></a><span id="l1.8639" class="difflineplus">+     *</span>
<a href="#l1.8640"></a><span id="l1.8640" class="difflineplus">+     * @private</span>
<a href="#l1.8641"></a><span id="l1.8641" class="difflineplus">+     * @param {ICAL.Component} component    The component to initialize from.</span>
<a href="#l1.8642"></a><span id="l1.8642" class="difflineplus">+     */</span>
<a href="#l1.8643"></a><span id="l1.8643">     _init: function(component) {</span>
<a href="#l1.8644"></a><span id="l1.8644">       this.ruleIterators = [];</span>
<a href="#l1.8645"></a><span id="l1.8645"> </span>
<a href="#l1.8646"></a><span id="l1.8646">       this.last = this.dtstart.clone();</span>
<a href="#l1.8647"></a><span id="l1.8647"> </span>
<a href="#l1.8648"></a><span id="l1.8648">       // to provide api consistency non-recurring</span>
<a href="#l1.8649"></a><span id="l1.8649">       // events can also use the iterator though it will</span>
<a href="#l1.8650"></a><span id="l1.8650">       // only return a single time.</span>
<a href="#l1.8651"></a><span id="l1.8651" class="difflineat">@@ -6115,29 +8585,38 @@ ICAL.RecurExpansion = (function() {</span>
<a href="#l1.8652"></a><span id="l1.8652">           this.last,</span>
<a href="#l1.8653"></a><span id="l1.8653">           compareTime</span>
<a href="#l1.8654"></a><span id="l1.8654">         );</span>
<a href="#l1.8655"></a><span id="l1.8655"> </span>
<a href="#l1.8656"></a><span id="l1.8656">         this.exDate = this.exDates[this.exDateInc];</span>
<a href="#l1.8657"></a><span id="l1.8657">       }</span>
<a href="#l1.8658"></a><span id="l1.8658">     },</span>
<a href="#l1.8659"></a><span id="l1.8659"> </span>
<a href="#l1.8660"></a><span id="l1.8660" class="difflineplus">+    /**</span>
<a href="#l1.8661"></a><span id="l1.8661" class="difflineplus">+     * Advance to the next exdate</span>
<a href="#l1.8662"></a><span id="l1.8662" class="difflineplus">+     * @private</span>
<a href="#l1.8663"></a><span id="l1.8663" class="difflineplus">+     */</span>
<a href="#l1.8664"></a><span id="l1.8664">     _nextExDay: function() {</span>
<a href="#l1.8665"></a><span id="l1.8665">       this.exDate = this.exDates[++this.exDateInc];</span>
<a href="#l1.8666"></a><span id="l1.8666">     },</span>
<a href="#l1.8667"></a><span id="l1.8667"> </span>
<a href="#l1.8668"></a><span id="l1.8668" class="difflineplus">+    /**</span>
<a href="#l1.8669"></a><span id="l1.8669" class="difflineplus">+     * Advance to the next rule date</span>
<a href="#l1.8670"></a><span id="l1.8670" class="difflineplus">+     * @private</span>
<a href="#l1.8671"></a><span id="l1.8671" class="difflineplus">+     */</span>
<a href="#l1.8672"></a><span id="l1.8672">     _nextRuleDay: function() {</span>
<a href="#l1.8673"></a><span id="l1.8673">       this.ruleDate = this.ruleDates[++this.ruleDateInc];</span>
<a href="#l1.8674"></a><span id="l1.8674">     },</span>
<a href="#l1.8675"></a><span id="l1.8675"> </span>
<a href="#l1.8676"></a><span id="l1.8676">     /**</span>
<a href="#l1.8677"></a><span id="l1.8677" class="difflineminus">-     * Find and return the recurrence rule with the most</span>
<a href="#l1.8678"></a><span id="l1.8678" class="difflineminus">-     * recent event and return it.</span>
<a href="#l1.8679"></a><span id="l1.8679" class="difflineminus">-     *</span>
<a href="#l1.8680"></a><span id="l1.8680" class="difflineminus">-     * @return {Object} iterator.</span>
<a href="#l1.8681"></a><span id="l1.8681" class="difflineplus">+     * Find and return the recurrence rule with the most recent event and</span>
<a href="#l1.8682"></a><span id="l1.8682" class="difflineplus">+     * return it.</span>
<a href="#l1.8683"></a><span id="l1.8683" class="difflineplus">+     *</span>
<a href="#l1.8684"></a><span id="l1.8684" class="difflineplus">+     * @private</span>
<a href="#l1.8685"></a><span id="l1.8685" class="difflineplus">+     * @return {?ICAL.RecurIterator}    Found iterator.</span>
<a href="#l1.8686"></a><span id="l1.8686">      */</span>
<a href="#l1.8687"></a><span id="l1.8687">     _nextRecurrenceIter: function() {</span>
<a href="#l1.8688"></a><span id="l1.8688">       var iters = this.ruleIterators;</span>
<a href="#l1.8689"></a><span id="l1.8689"> </span>
<a href="#l1.8690"></a><span id="l1.8690">       if (iters.length === 0) {</span>
<a href="#l1.8691"></a><span id="l1.8691">         return null;</span>
<a href="#l1.8692"></a><span id="l1.8692">       }</span>
<a href="#l1.8693"></a><span id="l1.8693"> </span>
<a href="#l1.8694"></a><span id="l1.8694" class="difflineat">@@ -6170,30 +8649,48 @@ ICAL.RecurExpansion = (function() {</span>
<a href="#l1.8695"></a><span id="l1.8695">           chosenIter = iter;</span>
<a href="#l1.8696"></a><span id="l1.8696">         }</span>
<a href="#l1.8697"></a><span id="l1.8697">       }</span>
<a href="#l1.8698"></a><span id="l1.8698"> </span>
<a href="#l1.8699"></a><span id="l1.8699">       // the chosen iterator is returned but not mutated</span>
<a href="#l1.8700"></a><span id="l1.8700">       // this iterator contains the most recent event.</span>
<a href="#l1.8701"></a><span id="l1.8701">       return chosenIter;</span>
<a href="#l1.8702"></a><span id="l1.8702">     }</span>
<a href="#l1.8703"></a><span id="l1.8703" class="difflineminus">-</span>
<a href="#l1.8704"></a><span id="l1.8704">   };</span>
<a href="#l1.8705"></a><span id="l1.8705"> </span>
<a href="#l1.8706"></a><span id="l1.8706">   return RecurExpansion;</span>
<a href="#l1.8707"></a><span id="l1.8707" class="difflineminus">-</span>
<a href="#l1.8708"></a><span id="l1.8708"> }());</span>
<a href="#l1.8709"></a><span id="l1.8709" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.8710"></a><span id="l1.8710" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8711"></a><span id="l1.8711" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.8712"></a><span id="l1.8712" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.8713"></a><span id="l1.8713" class="difflineplus">+</span>
<a href="#l1.8714"></a><span id="l1.8714" class="difflineplus">+</span>
<a href="#l1.8715"></a><span id="l1.8715" class="difflineplus">+/**</span>
<a href="#l1.8716"></a><span id="l1.8716" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.8717"></a><span id="l1.8717" class="difflineplus">+ * @ignore</span>
<a href="#l1.8718"></a><span id="l1.8718" class="difflineplus">+ */</span>
<a href="#l1.8719"></a><span id="l1.8719"> ICAL.Event = (function() {</span>
<a href="#l1.8720"></a><span id="l1.8720"> </span>
<a href="#l1.8721"></a><span id="l1.8721" class="difflineminus">-  function compareRangeException(a, b) {</span>
<a href="#l1.8722"></a><span id="l1.8722" class="difflineminus">-    if (a[0] &gt; b[0]) return 1;</span>
<a href="#l1.8723"></a><span id="l1.8723" class="difflineminus">-    if (b[0] &gt; a[0]) return -1;</span>
<a href="#l1.8724"></a><span id="l1.8724" class="difflineminus">-    return 0;</span>
<a href="#l1.8725"></a><span id="l1.8725" class="difflineminus">-  }</span>
<a href="#l1.8726"></a><span id="l1.8726" class="difflineminus">-</span>
<a href="#l1.8727"></a><span id="l1.8727" class="difflineplus">+  /**</span>
<a href="#l1.8728"></a><span id="l1.8728" class="difflineplus">+   * @classdesc</span>
<a href="#l1.8729"></a><span id="l1.8729" class="difflineplus">+   * ICAL.js is organized into multiple layers. The bottom layer is a raw jCal</span>
<a href="#l1.8730"></a><span id="l1.8730" class="difflineplus">+   * object, followed by the component/property layer. The highest level is the</span>
<a href="#l1.8731"></a><span id="l1.8731" class="difflineplus">+   * event representation, which this class is part of. See the</span>
<a href="#l1.8732"></a><span id="l1.8732" class="difflineplus">+   * {@tutorial layers} guide for more details.</span>
<a href="#l1.8733"></a><span id="l1.8733" class="difflineplus">+   *</span>
<a href="#l1.8734"></a><span id="l1.8734" class="difflineplus">+   * @class</span>
<a href="#l1.8735"></a><span id="l1.8735" class="difflineplus">+   * @alias ICAL.Event</span>
<a href="#l1.8736"></a><span id="l1.8736" class="difflineplus">+   * @param {ICAL.Component=} component         The ICAL.Component to base this event on</span>
<a href="#l1.8737"></a><span id="l1.8737" class="difflineplus">+   * @param {Object} options                    Options for this event</span>
<a href="#l1.8738"></a><span id="l1.8738" class="difflineplus">+   * @param {Boolean} options.strictExceptions</span>
<a href="#l1.8739"></a><span id="l1.8739" class="difflineplus">+   *          When true, will verify exceptions are related by their UUID</span>
<a href="#l1.8740"></a><span id="l1.8740" class="difflineplus">+   * @param {Array&lt;ICAL.Component|ICAL.Event&gt;} options.exceptions</span>
<a href="#l1.8741"></a><span id="l1.8741" class="difflineplus">+   *          Exceptions to this event, either as components or events</span>
<a href="#l1.8742"></a><span id="l1.8742" class="difflineplus">+   */</span>
<a href="#l1.8743"></a><span id="l1.8743">   function Event(component, options) {</span>
<a href="#l1.8744"></a><span id="l1.8744">     if (!(component instanceof ICAL.Component)) {</span>
<a href="#l1.8745"></a><span id="l1.8745">       options = component;</span>
<a href="#l1.8746"></a><span id="l1.8746">       component = null;</span>
<a href="#l1.8747"></a><span id="l1.8747">     }</span>
<a href="#l1.8748"></a><span id="l1.8748"> </span>
<a href="#l1.8749"></a><span id="l1.8749">     if (component) {</span>
<a href="#l1.8750"></a><span id="l1.8750">       this.component = component;</span>
<a href="#l1.8751"></a><span id="l1.8751" class="difflineat">@@ -6216,37 +8713,36 @@ ICAL.Event = (function() {</span>
<a href="#l1.8752"></a><span id="l1.8752"> </span>
<a href="#l1.8753"></a><span id="l1.8753">   Event.prototype = {</span>
<a href="#l1.8754"></a><span id="l1.8754"> </span>
<a href="#l1.8755"></a><span id="l1.8755">     THISANDFUTURE: 'THISANDFUTURE',</span>
<a href="#l1.8756"></a><span id="l1.8756"> </span>
<a href="#l1.8757"></a><span id="l1.8757">     /**</span>
<a href="#l1.8758"></a><span id="l1.8758">      * List of related event exceptions.</span>
<a href="#l1.8759"></a><span id="l1.8759">      *</span>
<a href="#l1.8760"></a><span id="l1.8760" class="difflineminus">-     * @type Array[ICAL.Event]</span>
<a href="#l1.8761"></a><span id="l1.8761" class="difflineplus">+     * @type {ICAL.Event[]}</span>
<a href="#l1.8762"></a><span id="l1.8762">      */</span>
<a href="#l1.8763"></a><span id="l1.8763">     exceptions: null,</span>
<a href="#l1.8764"></a><span id="l1.8764"> </span>
<a href="#l1.8765"></a><span id="l1.8765">     /**</span>
<a href="#l1.8766"></a><span id="l1.8766" class="difflineminus">-     * When true will verify exceptions are related by their UUID.</span>
<a href="#l1.8767"></a><span id="l1.8767" class="difflineplus">+     * When true, will verify exceptions are related by their UUID.</span>
<a href="#l1.8768"></a><span id="l1.8768">      *</span>
<a href="#l1.8769"></a><span id="l1.8769">      * @type {Boolean}</span>
<a href="#l1.8770"></a><span id="l1.8770">      */</span>
<a href="#l1.8771"></a><span id="l1.8771">     strictExceptions: false,</span>
<a href="#l1.8772"></a><span id="l1.8772"> </span>
<a href="#l1.8773"></a><span id="l1.8773">     /**</span>
<a href="#l1.8774"></a><span id="l1.8774" class="difflineminus">-     * Relates a given event exception to this object.</span>
<a href="#l1.8775"></a><span id="l1.8775" class="difflineminus">-     * If the given component does not share the UID of</span>
<a href="#l1.8776"></a><span id="l1.8776" class="difflineminus">-     * this event it cannot be related and will throw an</span>
<a href="#l1.8777"></a><span id="l1.8777" class="difflineminus">-     * exception.</span>
<a href="#l1.8778"></a><span id="l1.8778" class="difflineminus">-     *</span>
<a href="#l1.8779"></a><span id="l1.8779" class="difflineminus">-     * If this component is an exception it cannot have other</span>
<a href="#l1.8780"></a><span id="l1.8780" class="difflineminus">-     * exceptions related to it.</span>
<a href="#l1.8781"></a><span id="l1.8781" class="difflineminus">-     *</span>
<a href="#l1.8782"></a><span id="l1.8782" class="difflineminus">-     * @param {ICAL.Component|ICAL.Event} obj component or event.</span>
<a href="#l1.8783"></a><span id="l1.8783" class="difflineplus">+     * Relates a given event exception to this object.  If the given component</span>
<a href="#l1.8784"></a><span id="l1.8784" class="difflineplus">+     * does not share the UID of this event it cannot be related and will throw</span>
<a href="#l1.8785"></a><span id="l1.8785" class="difflineplus">+     * an exception.</span>
<a href="#l1.8786"></a><span id="l1.8786" class="difflineplus">+     *</span>
<a href="#l1.8787"></a><span id="l1.8787" class="difflineplus">+     * If this component is an exception it cannot have other exceptions</span>
<a href="#l1.8788"></a><span id="l1.8788" class="difflineplus">+     * related to it.</span>
<a href="#l1.8789"></a><span id="l1.8789" class="difflineplus">+     *</span>
<a href="#l1.8790"></a><span id="l1.8790" class="difflineplus">+     * @param {ICAL.Component|ICAL.Event} obj       Component or event</span>
<a href="#l1.8791"></a><span id="l1.8791">      */</span>
<a href="#l1.8792"></a><span id="l1.8792">     relateException: function(obj) {</span>
<a href="#l1.8793"></a><span id="l1.8793">       if (this.isRecurrenceException()) {</span>
<a href="#l1.8794"></a><span id="l1.8794">         throw new Error('cannot relate exception to exceptions');</span>
<a href="#l1.8795"></a><span id="l1.8795">       }</span>
<a href="#l1.8796"></a><span id="l1.8796"> </span>
<a href="#l1.8797"></a><span id="l1.8797">       if (obj instanceof ICAL.Component) {</span>
<a href="#l1.8798"></a><span id="l1.8798">         obj = new ICAL.Event(obj);</span>
<a href="#l1.8799"></a><span id="l1.8799" class="difflineat">@@ -6277,30 +8773,31 @@ ICAL.Event = (function() {</span>
<a href="#l1.8800"></a><span id="l1.8800">           compareRangeException</span>
<a href="#l1.8801"></a><span id="l1.8801">         );</span>
<a href="#l1.8802"></a><span id="l1.8802"> </span>
<a href="#l1.8803"></a><span id="l1.8803">         this.rangeExceptions.splice(idx, 0, item);</span>
<a href="#l1.8804"></a><span id="l1.8804">       }</span>
<a href="#l1.8805"></a><span id="l1.8805">     },</span>
<a href="#l1.8806"></a><span id="l1.8806"> </span>
<a href="#l1.8807"></a><span id="l1.8807">     /**</span>
<a href="#l1.8808"></a><span id="l1.8808" class="difflineminus">-     * If this record is an exception and has the RANGE=THISANDFUTURE value.</span>
<a href="#l1.8809"></a><span id="l1.8809" class="difflineminus">-     *</span>
<a href="#l1.8810"></a><span id="l1.8810" class="difflineminus">-     * @return {Boolean} true when is exception with range.</span>
<a href="#l1.8811"></a><span id="l1.8811" class="difflineplus">+     * Checks if this record is an exception and has the RANGE=THISANDFUTURE</span>
<a href="#l1.8812"></a><span id="l1.8812" class="difflineplus">+     * value.</span>
<a href="#l1.8813"></a><span id="l1.8813" class="difflineplus">+     *</span>
<a href="#l1.8814"></a><span id="l1.8814" class="difflineplus">+     * @return {Boolean}        True, when exception is within range</span>
<a href="#l1.8815"></a><span id="l1.8815">      */</span>
<a href="#l1.8816"></a><span id="l1.8816">     modifiesFuture: function() {</span>
<a href="#l1.8817"></a><span id="l1.8817">       var range = this.component.getFirstPropertyValue('range');</span>
<a href="#l1.8818"></a><span id="l1.8818">       return range === this.THISANDFUTURE;</span>
<a href="#l1.8819"></a><span id="l1.8819">     },</span>
<a href="#l1.8820"></a><span id="l1.8820"> </span>
<a href="#l1.8821"></a><span id="l1.8821">     /**</span>
<a href="#l1.8822"></a><span id="l1.8822">      * Finds the range exception nearest to the given date.</span>
<a href="#l1.8823"></a><span id="l1.8823">      *</span>
<a href="#l1.8824"></a><span id="l1.8824" class="difflineminus">-     * @param {ICAL.Time} time usually an occurrence time of an event.</span>
<a href="#l1.8825"></a><span id="l1.8825" class="difflineminus">-     * @return {ICAL.Event|Null} the related event/exception or null.</span>
<a href="#l1.8826"></a><span id="l1.8826" class="difflineplus">+     * @param {ICAL.Time} time usually an occurrence time of an event</span>
<a href="#l1.8827"></a><span id="l1.8827" class="difflineplus">+     * @return {?ICAL.Event} the related event/exception or null</span>
<a href="#l1.8828"></a><span id="l1.8828">      */</span>
<a href="#l1.8829"></a><span id="l1.8829">     findRangeException: function(time) {</span>
<a href="#l1.8830"></a><span id="l1.8830">       if (!this.rangeExceptions.length) {</span>
<a href="#l1.8831"></a><span id="l1.8831">         return null;</span>
<a href="#l1.8832"></a><span id="l1.8832">       }</span>
<a href="#l1.8833"></a><span id="l1.8833"> </span>
<a href="#l1.8834"></a><span id="l1.8834">       var utc = time.toUnixTime();</span>
<a href="#l1.8835"></a><span id="l1.8835">       var idx = ICAL.helpers.binsearchInsert(</span>
<a href="#l1.8836"></a><span id="l1.8836" class="difflineat">@@ -6313,247 +8810,341 @@ ICAL.Event = (function() {</span>
<a href="#l1.8837"></a><span id="l1.8837"> </span>
<a href="#l1.8838"></a><span id="l1.8838">       // occurs before</span>
<a href="#l1.8839"></a><span id="l1.8839">       if (idx &lt; 0) {</span>
<a href="#l1.8840"></a><span id="l1.8840">         return null;</span>
<a href="#l1.8841"></a><span id="l1.8841">       }</span>
<a href="#l1.8842"></a><span id="l1.8842"> </span>
<a href="#l1.8843"></a><span id="l1.8843">       var rangeItem = this.rangeExceptions[idx];</span>
<a href="#l1.8844"></a><span id="l1.8844"> </span>
<a href="#l1.8845"></a><span id="l1.8845" class="difflineminus">-      // sanity check</span>
<a href="#l1.8846"></a><span id="l1.8846" class="difflineplus">+      /* istanbul ignore next: sanity check only */</span>
<a href="#l1.8847"></a><span id="l1.8847">       if (utc &lt; rangeItem[0]) {</span>
<a href="#l1.8848"></a><span id="l1.8848">         return null;</span>
<a href="#l1.8849"></a><span id="l1.8849">       }</span>
<a href="#l1.8850"></a><span id="l1.8850"> </span>
<a href="#l1.8851"></a><span id="l1.8851">       return rangeItem[1];</span>
<a href="#l1.8852"></a><span id="l1.8852">     },</span>
<a href="#l1.8853"></a><span id="l1.8853"> </span>
<a href="#l1.8854"></a><span id="l1.8854">     /**</span>
<a href="#l1.8855"></a><span id="l1.8855" class="difflineminus">-     * Returns the occurrence details based on its start time.</span>
<a href="#l1.8856"></a><span id="l1.8856" class="difflineminus">-     * If the occurrence has an exception will return the details</span>
<a href="#l1.8857"></a><span id="l1.8857" class="difflineminus">-     * for that exception.</span>
<a href="#l1.8858"></a><span id="l1.8858" class="difflineplus">+     * This object is returned by {@link ICAL.Event#getOccurrenceDetails getOccurrenceDetails}</span>
<a href="#l1.8859"></a><span id="l1.8859" class="difflineplus">+     *</span>
<a href="#l1.8860"></a><span id="l1.8860" class="difflineplus">+     * @typedef {Object} occurrenceDetails</span>
<a href="#l1.8861"></a><span id="l1.8861" class="difflineplus">+     * @memberof ICAL.Event</span>
<a href="#l1.8862"></a><span id="l1.8862" class="difflineplus">+     * @property {ICAL.Time} recurrenceId       The passed in recurrence id</span>
<a href="#l1.8863"></a><span id="l1.8863" class="difflineplus">+     * @property {ICAL.Event} item              The occurrence</span>
<a href="#l1.8864"></a><span id="l1.8864" class="difflineplus">+     * @property {ICAL.Time} startDate          The start of the occurrence</span>
<a href="#l1.8865"></a><span id="l1.8865" class="difflineplus">+     * @property {ICAL.Time} endDate            The end of the occurrence</span>
<a href="#l1.8866"></a><span id="l1.8866" class="difflineplus">+     */</span>
<a href="#l1.8867"></a><span id="l1.8867" class="difflineplus">+</span>
<a href="#l1.8868"></a><span id="l1.8868" class="difflineplus">+    /**</span>
<a href="#l1.8869"></a><span id="l1.8869" class="difflineplus">+     * Returns the occurrence details based on its start time.  If the</span>
<a href="#l1.8870"></a><span id="l1.8870" class="difflineplus">+     * occurrence has an exception will return the details for that exception.</span>
<a href="#l1.8871"></a><span id="l1.8871">      *</span>
<a href="#l1.8872"></a><span id="l1.8872">      * NOTE: this method is intend to be used in conjunction</span>
<a href="#l1.8873"></a><span id="l1.8873" class="difflineminus">-     *       with the #iterator method.</span>
<a href="#l1.8874"></a><span id="l1.8874" class="difflineminus">-     *</span>
<a href="#l1.8875"></a><span id="l1.8875" class="difflineminus">-     * @param {ICAL.Time} occurrence time occurrence.</span>
<a href="#l1.8876"></a><span id="l1.8876" class="difflineplus">+     *       with the {@link ICAL.Event#iterator iterator} method.</span>
<a href="#l1.8877"></a><span id="l1.8877" class="difflineplus">+     *</span>
<a href="#l1.8878"></a><span id="l1.8878" class="difflineplus">+     * @param {ICAL.Time} occurrence time occurrence</span>
<a href="#l1.8879"></a><span id="l1.8879" class="difflineplus">+     * @return {ICAL.Event.occurrenceDetails} Information about the occurrence</span>
<a href="#l1.8880"></a><span id="l1.8880">      */</span>
<a href="#l1.8881"></a><span id="l1.8881">     getOccurrenceDetails: function(occurrence) {</span>
<a href="#l1.8882"></a><span id="l1.8882">       var id = occurrence.toString();</span>
<a href="#l1.8883"></a><span id="l1.8883">       var utcId = occurrence.convertToZone(ICAL.Timezone.utcTimezone).toString();</span>
<a href="#l1.8884"></a><span id="l1.8884" class="difflineplus">+      var item;</span>
<a href="#l1.8885"></a><span id="l1.8885">       var result = {</span>
<a href="#l1.8886"></a><span id="l1.8886">         //XXX: Clone?</span>
<a href="#l1.8887"></a><span id="l1.8887">         recurrenceId: occurrence</span>
<a href="#l1.8888"></a><span id="l1.8888">       };</span>
<a href="#l1.8889"></a><span id="l1.8889"> </span>
<a href="#l1.8890"></a><span id="l1.8890">       if (id in this.exceptions) {</span>
<a href="#l1.8891"></a><span id="l1.8891" class="difflineminus">-        var item = result.item = this.exceptions[id];</span>
<a href="#l1.8892"></a><span id="l1.8892" class="difflineplus">+        item = result.item = this.exceptions[id];</span>
<a href="#l1.8893"></a><span id="l1.8893">         result.startDate = item.startDate;</span>
<a href="#l1.8894"></a><span id="l1.8894">         result.endDate = item.endDate;</span>
<a href="#l1.8895"></a><span id="l1.8895">         result.item = item;</span>
<a href="#l1.8896"></a><span id="l1.8896">       } else if (utcId in this.exceptions) {</span>
<a href="#l1.8897"></a><span id="l1.8897" class="difflineminus">-        var item = this.exceptions[utcId];</span>
<a href="#l1.8898"></a><span id="l1.8898" class="difflineplus">+        item = this.exceptions[utcId];</span>
<a href="#l1.8899"></a><span id="l1.8899">         result.startDate = item.startDate;</span>
<a href="#l1.8900"></a><span id="l1.8900">         result.endDate = item.endDate;</span>
<a href="#l1.8901"></a><span id="l1.8901">         result.item = item;</span>
<a href="#l1.8902"></a><span id="l1.8902">       } else {</span>
<a href="#l1.8903"></a><span id="l1.8903">         // range exceptions (RANGE=THISANDFUTURE) have a</span>
<a href="#l1.8904"></a><span id="l1.8904">         // lower priority then direct exceptions but</span>
<a href="#l1.8905"></a><span id="l1.8905">         // must be accounted for first. Their item is</span>
<a href="#l1.8906"></a><span id="l1.8906">         // always the first exception with the range prop.</span>
<a href="#l1.8907"></a><span id="l1.8907">         var rangeExceptionId = this.findRangeException(</span>
<a href="#l1.8908"></a><span id="l1.8908">           occurrence</span>
<a href="#l1.8909"></a><span id="l1.8909">         );</span>
<a href="#l1.8910"></a><span id="l1.8910" class="difflineplus">+        var end;</span>
<a href="#l1.8911"></a><span id="l1.8911"> </span>
<a href="#l1.8912"></a><span id="l1.8912">         if (rangeExceptionId) {</span>
<a href="#l1.8913"></a><span id="l1.8913">           var exception = this.exceptions[rangeExceptionId];</span>
<a href="#l1.8914"></a><span id="l1.8914"> </span>
<a href="#l1.8915"></a><span id="l1.8915">           // range exception must modify standard time</span>
<a href="#l1.8916"></a><span id="l1.8916">           // by the difference (if any) in start/end times.</span>
<a href="#l1.8917"></a><span id="l1.8917">           result.item = exception;</span>
<a href="#l1.8918"></a><span id="l1.8918"> </span>
<a href="#l1.8919"></a><span id="l1.8919">           var startDiff = this._rangeExceptionCache[rangeExceptionId];</span>
<a href="#l1.8920"></a><span id="l1.8920"> </span>
<a href="#l1.8921"></a><span id="l1.8921">           if (!startDiff) {</span>
<a href="#l1.8922"></a><span id="l1.8922">             var original = exception.recurrenceId.clone();</span>
<a href="#l1.8923"></a><span id="l1.8923">             var newStart = exception.startDate.clone();</span>
<a href="#l1.8924"></a><span id="l1.8924"> </span>
<a href="#l1.8925"></a><span id="l1.8925">             // zones must be same otherwise subtract may be incorrect.</span>
<a href="#l1.8926"></a><span id="l1.8926">             original.zone = newStart.zone;</span>
<a href="#l1.8927"></a><span id="l1.8927" class="difflineminus">-            var startDiff = newStart.subtractDate(original);</span>
<a href="#l1.8928"></a><span id="l1.8928" class="difflineplus">+            startDiff = newStart.subtractDate(original);</span>
<a href="#l1.8929"></a><span id="l1.8929"> </span>
<a href="#l1.8930"></a><span id="l1.8930">             this._rangeExceptionCache[rangeExceptionId] = startDiff;</span>
<a href="#l1.8931"></a><span id="l1.8931">           }</span>
<a href="#l1.8932"></a><span id="l1.8932"> </span>
<a href="#l1.8933"></a><span id="l1.8933">           var start = occurrence.clone();</span>
<a href="#l1.8934"></a><span id="l1.8934">           start.zone = exception.startDate.zone;</span>
<a href="#l1.8935"></a><span id="l1.8935">           start.addDuration(startDiff);</span>
<a href="#l1.8936"></a><span id="l1.8936"> </span>
<a href="#l1.8937"></a><span id="l1.8937" class="difflineminus">-          var end = start.clone();</span>
<a href="#l1.8938"></a><span id="l1.8938" class="difflineplus">+          end = start.clone();</span>
<a href="#l1.8939"></a><span id="l1.8939">           end.addDuration(exception.duration);</span>
<a href="#l1.8940"></a><span id="l1.8940"> </span>
<a href="#l1.8941"></a><span id="l1.8941">           result.startDate = start;</span>
<a href="#l1.8942"></a><span id="l1.8942">           result.endDate = end;</span>
<a href="#l1.8943"></a><span id="l1.8943">         } else {</span>
<a href="#l1.8944"></a><span id="l1.8944">           // no range exception standard expansion</span>
<a href="#l1.8945"></a><span id="l1.8945" class="difflineminus">-          var end = occurrence.clone();</span>
<a href="#l1.8946"></a><span id="l1.8946" class="difflineplus">+          end = occurrence.clone();</span>
<a href="#l1.8947"></a><span id="l1.8947">           end.addDuration(this.duration);</span>
<a href="#l1.8948"></a><span id="l1.8948"> </span>
<a href="#l1.8949"></a><span id="l1.8949">           result.endDate = end;</span>
<a href="#l1.8950"></a><span id="l1.8950">           result.startDate = occurrence;</span>
<a href="#l1.8951"></a><span id="l1.8951">           result.item = this;</span>
<a href="#l1.8952"></a><span id="l1.8952">         }</span>
<a href="#l1.8953"></a><span id="l1.8953">       }</span>
<a href="#l1.8954"></a><span id="l1.8954"> </span>
<a href="#l1.8955"></a><span id="l1.8955">       return result;</span>
<a href="#l1.8956"></a><span id="l1.8956">     },</span>
<a href="#l1.8957"></a><span id="l1.8957"> </span>
<a href="#l1.8958"></a><span id="l1.8958">     /**</span>
<a href="#l1.8959"></a><span id="l1.8959" class="difflineminus">-     * Builds a recur expansion instance for a specific</span>
<a href="#l1.8960"></a><span id="l1.8960" class="difflineminus">-     * point in time (defaults to startDate).</span>
<a href="#l1.8961"></a><span id="l1.8961" class="difflineminus">-     *</span>
<a href="#l1.8962"></a><span id="l1.8962" class="difflineminus">-     * @return {ICAL.RecurExpansion} expander object.</span>
<a href="#l1.8963"></a><span id="l1.8963" class="difflineplus">+     * Builds a recur expansion instance for a specific point in time (defaults</span>
<a href="#l1.8964"></a><span id="l1.8964" class="difflineplus">+     * to startDate).</span>
<a href="#l1.8965"></a><span id="l1.8965" class="difflineplus">+     *</span>
<a href="#l1.8966"></a><span id="l1.8966" class="difflineplus">+     * @param {ICAL.Time} startTime     Starting point for expansion</span>
<a href="#l1.8967"></a><span id="l1.8967" class="difflineplus">+     * @return {ICAL.RecurExpansion}    Expansion object</span>
<a href="#l1.8968"></a><span id="l1.8968">      */</span>
<a href="#l1.8969"></a><span id="l1.8969">     iterator: function(startTime) {</span>
<a href="#l1.8970"></a><span id="l1.8970">       return new ICAL.RecurExpansion({</span>
<a href="#l1.8971"></a><span id="l1.8971">         component: this.component,</span>
<a href="#l1.8972"></a><span id="l1.8972">         dtstart: startTime || this.startDate</span>
<a href="#l1.8973"></a><span id="l1.8973">       });</span>
<a href="#l1.8974"></a><span id="l1.8974">     },</span>
<a href="#l1.8975"></a><span id="l1.8975"> </span>
<a href="#l1.8976"></a><span id="l1.8976" class="difflineplus">+    /**</span>
<a href="#l1.8977"></a><span id="l1.8977" class="difflineplus">+     * Checks if the event is recurring</span>
<a href="#l1.8978"></a><span id="l1.8978" class="difflineplus">+     *</span>
<a href="#l1.8979"></a><span id="l1.8979" class="difflineplus">+     * @return {Boolean}        True, if event is recurring</span>
<a href="#l1.8980"></a><span id="l1.8980" class="difflineplus">+     */</span>
<a href="#l1.8981"></a><span id="l1.8981">     isRecurring: function() {</span>
<a href="#l1.8982"></a><span id="l1.8982">       var comp = this.component;</span>
<a href="#l1.8983"></a><span id="l1.8983">       return comp.hasProperty('rrule') || comp.hasProperty('rdate');</span>
<a href="#l1.8984"></a><span id="l1.8984">     },</span>
<a href="#l1.8985"></a><span id="l1.8985"> </span>
<a href="#l1.8986"></a><span id="l1.8986" class="difflineplus">+    /**</span>
<a href="#l1.8987"></a><span id="l1.8987" class="difflineplus">+     * Checks if the event describes a recurrence exception. See</span>
<a href="#l1.8988"></a><span id="l1.8988" class="difflineplus">+     * {@tutorial terminology} for details.</span>
<a href="#l1.8989"></a><span id="l1.8989" class="difflineplus">+     *</span>
<a href="#l1.8990"></a><span id="l1.8990" class="difflineplus">+     * @return {Boolean}    True, if the even describes a recurrence exception</span>
<a href="#l1.8991"></a><span id="l1.8991" class="difflineplus">+     */</span>
<a href="#l1.8992"></a><span id="l1.8992">     isRecurrenceException: function() {</span>
<a href="#l1.8993"></a><span id="l1.8993">       return this.component.hasProperty('recurrence-id');</span>
<a href="#l1.8994"></a><span id="l1.8994">     },</span>
<a href="#l1.8995"></a><span id="l1.8995"> </span>
<a href="#l1.8996"></a><span id="l1.8996">     /**</span>
<a href="#l1.8997"></a><span id="l1.8997">      * Returns the types of recurrences this event may have.</span>
<a href="#l1.8998"></a><span id="l1.8998">      *</span>
<a href="#l1.8999"></a><span id="l1.8999">      * Returned as an object with the following possible keys:</span>
<a href="#l1.9000"></a><span id="l1.9000">      *</span>
<a href="#l1.9001"></a><span id="l1.9001">      *    - YEARLY</span>
<a href="#l1.9002"></a><span id="l1.9002">      *    - MONTHLY</span>
<a href="#l1.9003"></a><span id="l1.9003">      *    - WEEKLY</span>
<a href="#l1.9004"></a><span id="l1.9004">      *    - DAILY</span>
<a href="#l1.9005"></a><span id="l1.9005">      *    - MINUTELY</span>
<a href="#l1.9006"></a><span id="l1.9006">      *    - SECONDLY</span>
<a href="#l1.9007"></a><span id="l1.9007">      *</span>
<a href="#l1.9008"></a><span id="l1.9008" class="difflineminus">-     * @return {Object} object of recurrence flags.</span>
<a href="#l1.9009"></a><span id="l1.9009" class="difflineplus">+     * @return {Object.&lt;ICAL.Recur.frequencyValues, Boolean&gt;}</span>
<a href="#l1.9010"></a><span id="l1.9010" class="difflineplus">+     *          Object of recurrence flags</span>
<a href="#l1.9011"></a><span id="l1.9011">      */</span>
<a href="#l1.9012"></a><span id="l1.9012">     getRecurrenceTypes: function() {</span>
<a href="#l1.9013"></a><span id="l1.9013">       var rules = this.component.getAllProperties('rrule');</span>
<a href="#l1.9014"></a><span id="l1.9014">       var i = 0;</span>
<a href="#l1.9015"></a><span id="l1.9015">       var len = rules.length;</span>
<a href="#l1.9016"></a><span id="l1.9016">       var result = Object.create(null);</span>
<a href="#l1.9017"></a><span id="l1.9017"> </span>
<a href="#l1.9018"></a><span id="l1.9018">       for (; i &lt; len; i++) {</span>
<a href="#l1.9019"></a><span id="l1.9019">         var value = rules[i].getFirstValue();</span>
<a href="#l1.9020"></a><span id="l1.9020">         result[value.freq] = true;</span>
<a href="#l1.9021"></a><span id="l1.9021">       }</span>
<a href="#l1.9022"></a><span id="l1.9022"> </span>
<a href="#l1.9023"></a><span id="l1.9023">       return result;</span>
<a href="#l1.9024"></a><span id="l1.9024">     },</span>
<a href="#l1.9025"></a><span id="l1.9025"> </span>
<a href="#l1.9026"></a><span id="l1.9026" class="difflineplus">+    /**</span>
<a href="#l1.9027"></a><span id="l1.9027" class="difflineplus">+     * The uid of this event</span>
<a href="#l1.9028"></a><span id="l1.9028" class="difflineplus">+     * @type {String}</span>
<a href="#l1.9029"></a><span id="l1.9029" class="difflineplus">+     */</span>
<a href="#l1.9030"></a><span id="l1.9030">     get uid() {</span>
<a href="#l1.9031"></a><span id="l1.9031">       return this._firstProp('uid');</span>
<a href="#l1.9032"></a><span id="l1.9032">     },</span>
<a href="#l1.9033"></a><span id="l1.9033"> </span>
<a href="#l1.9034"></a><span id="l1.9034">     set uid(value) {</span>
<a href="#l1.9035"></a><span id="l1.9035">       this._setProp('uid', value);</span>
<a href="#l1.9036"></a><span id="l1.9036">     },</span>
<a href="#l1.9037"></a><span id="l1.9037"> </span>
<a href="#l1.9038"></a><span id="l1.9038" class="difflineplus">+    /**</span>
<a href="#l1.9039"></a><span id="l1.9039" class="difflineplus">+     * The start date</span>
<a href="#l1.9040"></a><span id="l1.9040" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.9041"></a><span id="l1.9041" class="difflineplus">+     */</span>
<a href="#l1.9042"></a><span id="l1.9042">     get startDate() {</span>
<a href="#l1.9043"></a><span id="l1.9043">       return this._firstProp('dtstart');</span>
<a href="#l1.9044"></a><span id="l1.9044">     },</span>
<a href="#l1.9045"></a><span id="l1.9045"> </span>
<a href="#l1.9046"></a><span id="l1.9046">     set startDate(value) {</span>
<a href="#l1.9047"></a><span id="l1.9047">       this._setTime('dtstart', value);</span>
<a href="#l1.9048"></a><span id="l1.9048">     },</span>
<a href="#l1.9049"></a><span id="l1.9049"> </span>
<a href="#l1.9050"></a><span id="l1.9050" class="difflineplus">+    /**</span>
<a href="#l1.9051"></a><span id="l1.9051" class="difflineplus">+     * The end date. This can be the result directly from the property, or the</span>
<a href="#l1.9052"></a><span id="l1.9052" class="difflineplus">+     * end date calculated from start date and duration.</span>
<a href="#l1.9053"></a><span id="l1.9053" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.9054"></a><span id="l1.9054" class="difflineplus">+     */</span>
<a href="#l1.9055"></a><span id="l1.9055">     get endDate() {</span>
<a href="#l1.9056"></a><span id="l1.9056" class="difflineminus">-      return this._firstProp('dtend');</span>
<a href="#l1.9057"></a><span id="l1.9057" class="difflineplus">+      var endDate = this._firstProp('dtend');</span>
<a href="#l1.9058"></a><span id="l1.9058" class="difflineplus">+      if (!endDate) {</span>
<a href="#l1.9059"></a><span id="l1.9059" class="difflineplus">+          var duration = this._firstProp('duration');</span>
<a href="#l1.9060"></a><span id="l1.9060" class="difflineplus">+          endDate = this.startDate.clone();</span>
<a href="#l1.9061"></a><span id="l1.9061" class="difflineplus">+          if (duration) {</span>
<a href="#l1.9062"></a><span id="l1.9062" class="difflineplus">+              endDate.addDuration(duration);</span>
<a href="#l1.9063"></a><span id="l1.9063" class="difflineplus">+          } else if (endDate.isDate) {</span>
<a href="#l1.9064"></a><span id="l1.9064" class="difflineplus">+              endDate.day += 1;</span>
<a href="#l1.9065"></a><span id="l1.9065" class="difflineplus">+          }</span>
<a href="#l1.9066"></a><span id="l1.9066" class="difflineplus">+      }</span>
<a href="#l1.9067"></a><span id="l1.9067" class="difflineplus">+      return endDate;</span>
<a href="#l1.9068"></a><span id="l1.9068">     },</span>
<a href="#l1.9069"></a><span id="l1.9069"> </span>
<a href="#l1.9070"></a><span id="l1.9070">     set endDate(value) {</span>
<a href="#l1.9071"></a><span id="l1.9071">       this._setTime('dtend', value);</span>
<a href="#l1.9072"></a><span id="l1.9072">     },</span>
<a href="#l1.9073"></a><span id="l1.9073"> </span>
<a href="#l1.9074"></a><span id="l1.9074" class="difflineplus">+    /**</span>
<a href="#l1.9075"></a><span id="l1.9075" class="difflineplus">+     * The duration. This can be the result directly from the property, or the</span>
<a href="#l1.9076"></a><span id="l1.9076" class="difflineplus">+     * duration calculated from start date and end date.</span>
<a href="#l1.9077"></a><span id="l1.9077" class="difflineplus">+     * @type {ICAL.Duration}</span>
<a href="#l1.9078"></a><span id="l1.9078" class="difflineplus">+     * @readonly</span>
<a href="#l1.9079"></a><span id="l1.9079" class="difflineplus">+     */</span>
<a href="#l1.9080"></a><span id="l1.9080">     get duration() {</span>
<a href="#l1.9081"></a><span id="l1.9081" class="difflineminus">-      return this.endDate.subtractDate(this.startDate);</span>
<a href="#l1.9082"></a><span id="l1.9082" class="difflineminus">-    },</span>
<a href="#l1.9083"></a><span id="l1.9083" class="difflineminus">-</span>
<a href="#l1.9084"></a><span id="l1.9084" class="difflineplus">+      var duration = this._firstProp('duration');</span>
<a href="#l1.9085"></a><span id="l1.9085" class="difflineplus">+      if (!duration) {</span>
<a href="#l1.9086"></a><span id="l1.9086" class="difflineplus">+        return this.endDate.subtractDate(this.startDate);</span>
<a href="#l1.9087"></a><span id="l1.9087" class="difflineplus">+      }</span>
<a href="#l1.9088"></a><span id="l1.9088" class="difflineplus">+      return duration;</span>
<a href="#l1.9089"></a><span id="l1.9089" class="difflineplus">+    },</span>
<a href="#l1.9090"></a><span id="l1.9090" class="difflineplus">+</span>
<a href="#l1.9091"></a><span id="l1.9091" class="difflineplus">+    /**</span>
<a href="#l1.9092"></a><span id="l1.9092" class="difflineplus">+     * The location of the event.</span>
<a href="#l1.9093"></a><span id="l1.9093" class="difflineplus">+     * @type {String}</span>
<a href="#l1.9094"></a><span id="l1.9094" class="difflineplus">+     */</span>
<a href="#l1.9095"></a><span id="l1.9095">     get location() {</span>
<a href="#l1.9096"></a><span id="l1.9096">       return this._firstProp('location');</span>
<a href="#l1.9097"></a><span id="l1.9097">     },</span>
<a href="#l1.9098"></a><span id="l1.9098"> </span>
<a href="#l1.9099"></a><span id="l1.9099">     set location(value) {</span>
<a href="#l1.9100"></a><span id="l1.9100">       return this._setProp('location', value);</span>
<a href="#l1.9101"></a><span id="l1.9101">     },</span>
<a href="#l1.9102"></a><span id="l1.9102"> </span>
<a href="#l1.9103"></a><span id="l1.9103" class="difflineplus">+    /**</span>
<a href="#l1.9104"></a><span id="l1.9104" class="difflineplus">+     * The attendees in the event</span>
<a href="#l1.9105"></a><span id="l1.9105" class="difflineplus">+     * @type {ICAL.Property[]}</span>
<a href="#l1.9106"></a><span id="l1.9106" class="difflineplus">+     * @readonly</span>
<a href="#l1.9107"></a><span id="l1.9107" class="difflineplus">+     */</span>
<a href="#l1.9108"></a><span id="l1.9108">     get attendees() {</span>
<a href="#l1.9109"></a><span id="l1.9109">       //XXX: This is way lame we should have a better</span>
<a href="#l1.9110"></a><span id="l1.9110">       //     data structure for this later.</span>
<a href="#l1.9111"></a><span id="l1.9111">       return this.component.getAllProperties('attendee');</span>
<a href="#l1.9112"></a><span id="l1.9112">     },</span>
<a href="#l1.9113"></a><span id="l1.9113"> </span>
<a href="#l1.9114"></a><span id="l1.9114" class="difflineplus">+</span>
<a href="#l1.9115"></a><span id="l1.9115" class="difflineplus">+    /**</span>
<a href="#l1.9116"></a><span id="l1.9116" class="difflineplus">+     * The event summary</span>
<a href="#l1.9117"></a><span id="l1.9117" class="difflineplus">+     * @type {String}</span>
<a href="#l1.9118"></a><span id="l1.9118" class="difflineplus">+     */</span>
<a href="#l1.9119"></a><span id="l1.9119">     get summary() {</span>
<a href="#l1.9120"></a><span id="l1.9120">       return this._firstProp('summary');</span>
<a href="#l1.9121"></a><span id="l1.9121">     },</span>
<a href="#l1.9122"></a><span id="l1.9122"> </span>
<a href="#l1.9123"></a><span id="l1.9123">     set summary(value) {</span>
<a href="#l1.9124"></a><span id="l1.9124">       this._setProp('summary', value);</span>
<a href="#l1.9125"></a><span id="l1.9125">     },</span>
<a href="#l1.9126"></a><span id="l1.9126"> </span>
<a href="#l1.9127"></a><span id="l1.9127" class="difflineplus">+    /**</span>
<a href="#l1.9128"></a><span id="l1.9128" class="difflineplus">+     * The event description.</span>
<a href="#l1.9129"></a><span id="l1.9129" class="difflineplus">+     * @type {String}</span>
<a href="#l1.9130"></a><span id="l1.9130" class="difflineplus">+     */</span>
<a href="#l1.9131"></a><span id="l1.9131">     get description() {</span>
<a href="#l1.9132"></a><span id="l1.9132">       return this._firstProp('description');</span>
<a href="#l1.9133"></a><span id="l1.9133">     },</span>
<a href="#l1.9134"></a><span id="l1.9134"> </span>
<a href="#l1.9135"></a><span id="l1.9135">     set description(value) {</span>
<a href="#l1.9136"></a><span id="l1.9136">       this._setProp('description', value);</span>
<a href="#l1.9137"></a><span id="l1.9137">     },</span>
<a href="#l1.9138"></a><span id="l1.9138"> </span>
<a href="#l1.9139"></a><span id="l1.9139" class="difflineplus">+    /**</span>
<a href="#l1.9140"></a><span id="l1.9140" class="difflineplus">+     * The organizer value as an uri. In most cases this is a mailto: uri, but</span>
<a href="#l1.9141"></a><span id="l1.9141" class="difflineplus">+     * it can also be something else, like urn:uuid:...</span>
<a href="#l1.9142"></a><span id="l1.9142" class="difflineplus">+     * @type {String}</span>
<a href="#l1.9143"></a><span id="l1.9143" class="difflineplus">+     */</span>
<a href="#l1.9144"></a><span id="l1.9144">     get organizer() {</span>
<a href="#l1.9145"></a><span id="l1.9145">       return this._firstProp('organizer');</span>
<a href="#l1.9146"></a><span id="l1.9146">     },</span>
<a href="#l1.9147"></a><span id="l1.9147"> </span>
<a href="#l1.9148"></a><span id="l1.9148">     set organizer(value) {</span>
<a href="#l1.9149"></a><span id="l1.9149">       this._setProp('organizer', value);</span>
<a href="#l1.9150"></a><span id="l1.9150">     },</span>
<a href="#l1.9151"></a><span id="l1.9151"> </span>
<a href="#l1.9152"></a><span id="l1.9152" class="difflineplus">+    /**</span>
<a href="#l1.9153"></a><span id="l1.9153" class="difflineplus">+     * The sequence value for this event. Used for scheduling</span>
<a href="#l1.9154"></a><span id="l1.9154" class="difflineplus">+     * see {@tutorial terminology}.</span>
<a href="#l1.9155"></a><span id="l1.9155" class="difflineplus">+     * @type {Number}</span>
<a href="#l1.9156"></a><span id="l1.9156" class="difflineplus">+     */</span>
<a href="#l1.9157"></a><span id="l1.9157">     get sequence() {</span>
<a href="#l1.9158"></a><span id="l1.9158">       return this._firstProp('sequence');</span>
<a href="#l1.9159"></a><span id="l1.9159">     },</span>
<a href="#l1.9160"></a><span id="l1.9160"> </span>
<a href="#l1.9161"></a><span id="l1.9161">     set sequence(value) {</span>
<a href="#l1.9162"></a><span id="l1.9162">       this._setProp('sequence', value);</span>
<a href="#l1.9163"></a><span id="l1.9163">     },</span>
<a href="#l1.9164"></a><span id="l1.9164"> </span>
<a href="#l1.9165"></a><span id="l1.9165" class="difflineplus">+    /**</span>
<a href="#l1.9166"></a><span id="l1.9166" class="difflineplus">+     * The recurrence id for this event. See {@tutorial terminology} for details.</span>
<a href="#l1.9167"></a><span id="l1.9167" class="difflineplus">+     * @type {ICAL.Time}</span>
<a href="#l1.9168"></a><span id="l1.9168" class="difflineplus">+     */</span>
<a href="#l1.9169"></a><span id="l1.9169">     get recurrenceId() {</span>
<a href="#l1.9170"></a><span id="l1.9170">       return this._firstProp('recurrence-id');</span>
<a href="#l1.9171"></a><span id="l1.9171">     },</span>
<a href="#l1.9172"></a><span id="l1.9172"> </span>
<a href="#l1.9173"></a><span id="l1.9173">     set recurrenceId(value) {</span>
<a href="#l1.9174"></a><span id="l1.9174">       this._setProp('recurrence-id', value);</span>
<a href="#l1.9175"></a><span id="l1.9175">     },</span>
<a href="#l1.9176"></a><span id="l1.9176"> </span>
<a href="#l1.9177"></a><span id="l1.9177">     /**</span>
<a href="#l1.9178"></a><span id="l1.9178" class="difflineminus">-     * set/update a time property's value.</span>
<a href="#l1.9179"></a><span id="l1.9179" class="difflineplus">+     * Set/update a time property's value.</span>
<a href="#l1.9180"></a><span id="l1.9180">      * This will also update the TZID of the property.</span>
<a href="#l1.9181"></a><span id="l1.9181">      *</span>
<a href="#l1.9182"></a><span id="l1.9182">      * TODO: this method handles the case where we are switching</span>
<a href="#l1.9183"></a><span id="l1.9183">      * from a known timezone to an implied timezone (one without TZID).</span>
<a href="#l1.9184"></a><span id="l1.9184">      * This does _not_ handle the case of moving between a known</span>
<a href="#l1.9185"></a><span id="l1.9185">      *  (by TimezoneService) timezone to an unknown timezone...</span>
<a href="#l1.9186"></a><span id="l1.9186">      *</span>
<a href="#l1.9187"></a><span id="l1.9187">      * We will not add/remove/update the VTIMEZONE subcomponents</span>
<a href="#l1.9188"></a><span id="l1.9188">      *  leading to invalid ICAL data...</span>
<a href="#l1.9189"></a><span id="l1.9189" class="difflineplus">+     * @private</span>
<a href="#l1.9190"></a><span id="l1.9190" class="difflineplus">+     * @param {String} propName     The property name</span>
<a href="#l1.9191"></a><span id="l1.9191" class="difflineplus">+     * @param {ICAL.Time} time      The time to set</span>
<a href="#l1.9192"></a><span id="l1.9192">      */</span>
<a href="#l1.9193"></a><span id="l1.9193">     _setTime: function(propName, time) {</span>
<a href="#l1.9194"></a><span id="l1.9194">       var prop = this.component.getFirstProperty(propName);</span>
<a href="#l1.9195"></a><span id="l1.9195"> </span>
<a href="#l1.9196"></a><span id="l1.9196">       if (!prop) {</span>
<a href="#l1.9197"></a><span id="l1.9197">         prop = new ICAL.Property(propName);</span>
<a href="#l1.9198"></a><span id="l1.9198">         this.component.addProperty(prop);</span>
<a href="#l1.9199"></a><span id="l1.9199">       }</span>
<a href="#l1.9200"></a><span id="l1.9200" class="difflineat">@@ -6575,125 +9166,153 @@ ICAL.Event = (function() {</span>
<a href="#l1.9201"></a><span id="l1.9201">     _setProp: function(name, value) {</span>
<a href="#l1.9202"></a><span id="l1.9202">       this.component.updatePropertyWithValue(name, value);</span>
<a href="#l1.9203"></a><span id="l1.9203">     },</span>
<a href="#l1.9204"></a><span id="l1.9204"> </span>
<a href="#l1.9205"></a><span id="l1.9205">     _firstProp: function(name) {</span>
<a href="#l1.9206"></a><span id="l1.9206">       return this.component.getFirstPropertyValue(name);</span>
<a href="#l1.9207"></a><span id="l1.9207">     },</span>
<a href="#l1.9208"></a><span id="l1.9208"> </span>
<a href="#l1.9209"></a><span id="l1.9209" class="difflineplus">+    /**</span>
<a href="#l1.9210"></a><span id="l1.9210" class="difflineplus">+     * The string representation of this event.</span>
<a href="#l1.9211"></a><span id="l1.9211" class="difflineplus">+     * @return {String}</span>
<a href="#l1.9212"></a><span id="l1.9212" class="difflineplus">+     */</span>
<a href="#l1.9213"></a><span id="l1.9213">     toString: function() {</span>
<a href="#l1.9214"></a><span id="l1.9214">       return this.component.toString();</span>
<a href="#l1.9215"></a><span id="l1.9215">     }</span>
<a href="#l1.9216"></a><span id="l1.9216"> </span>
<a href="#l1.9217"></a><span id="l1.9217">   };</span>
<a href="#l1.9218"></a><span id="l1.9218"> </span>
<a href="#l1.9219"></a><span id="l1.9219" class="difflineplus">+  function compareRangeException(a, b) {</span>
<a href="#l1.9220"></a><span id="l1.9220" class="difflineplus">+    if (a[0] &gt; b[0]) return 1;</span>
<a href="#l1.9221"></a><span id="l1.9221" class="difflineplus">+    if (b[0] &gt; a[0]) return -1;</span>
<a href="#l1.9222"></a><span id="l1.9222" class="difflineplus">+    return 0;</span>
<a href="#l1.9223"></a><span id="l1.9223" class="difflineplus">+  }</span>
<a href="#l1.9224"></a><span id="l1.9224" class="difflineplus">+</span>
<a href="#l1.9225"></a><span id="l1.9225">   return Event;</span>
<a href="#l1.9226"></a><span id="l1.9226" class="difflineminus">-</span>
<a href="#l1.9227"></a><span id="l1.9227"> }());</span>
<a href="#l1.9228"></a><span id="l1.9228" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.9229"></a><span id="l1.9229" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.9230"></a><span id="l1.9230" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.9231"></a><span id="l1.9231" class="difflineplus">+ * Portions Copyright (C) Philipp Kewisch, 2011-2015 */</span>
<a href="#l1.9232"></a><span id="l1.9232" class="difflineplus">+</span>
<a href="#l1.9233"></a><span id="l1.9233" class="difflineplus">+</span>
<a href="#l1.9234"></a><span id="l1.9234" class="difflineplus">+/**</span>
<a href="#l1.9235"></a><span id="l1.9235" class="difflineplus">+ * This symbol is further described later on</span>
<a href="#l1.9236"></a><span id="l1.9236" class="difflineplus">+ * @ignore</span>
<a href="#l1.9237"></a><span id="l1.9237" class="difflineplus">+ */</span>
<a href="#l1.9238"></a><span id="l1.9238"> ICAL.ComponentParser = (function() {</span>
<a href="#l1.9239"></a><span id="l1.9239" class="difflineminus">-</span>
<a href="#l1.9240"></a><span id="l1.9240">   /**</span>
<a href="#l1.9241"></a><span id="l1.9241" class="difflineminus">-   * Component parser initializer.</span>
<a href="#l1.9242"></a><span id="l1.9242" class="difflineminus">-   *</span>
<a href="#l1.9243"></a><span id="l1.9243" class="difflineminus">-   * Usage:</span>
<a href="#l1.9244"></a><span id="l1.9244" class="difflineminus">-   *</span>
<a href="#l1.9245"></a><span id="l1.9245" class="difflineminus">-   *    var options = {</span>
<a href="#l1.9246"></a><span id="l1.9246" class="difflineminus">-   *      // when false no events will be emitted for type</span>
<a href="#l1.9247"></a><span id="l1.9247" class="difflineminus">-   *      parseEvent: true,</span>
<a href="#l1.9248"></a><span id="l1.9248" class="difflineminus">-   *      parseTimezone: true</span>
<a href="#l1.9249"></a><span id="l1.9249" class="difflineminus">-   *    };</span>
<a href="#l1.9250"></a><span id="l1.9250" class="difflineminus">-   *</span>
<a href="#l1.9251"></a><span id="l1.9251" class="difflineminus">-   *    var parser = new ICAL.ComponentParser(options);</span>
<a href="#l1.9252"></a><span id="l1.9252" class="difflineminus">-   *</span>
<a href="#l1.9253"></a><span id="l1.9253" class="difflineminus">-   *    parser.onevent() {</span>
<a href="#l1.9254"></a><span id="l1.9254" class="difflineminus">-   *      //...</span>
<a href="#l1.9255"></a><span id="l1.9255" class="difflineminus">-   *    }</span>
<a href="#l1.9256"></a><span id="l1.9256" class="difflineminus">-   *</span>
<a href="#l1.9257"></a><span id="l1.9257" class="difflineminus">-   *    // ontimezone, etc...</span>
<a href="#l1.9258"></a><span id="l1.9258" class="difflineminus">-   *</span>
<a href="#l1.9259"></a><span id="l1.9259" class="difflineminus">-   *    parser.oncomplete = function() {</span>
<a href="#l1.9260"></a><span id="l1.9260" class="difflineminus">-   *</span>
<a href="#l1.9261"></a><span id="l1.9261" class="difflineminus">-   *    };</span>
<a href="#l1.9262"></a><span id="l1.9262" class="difflineminus">-   *</span>
<a href="#l1.9263"></a><span id="l1.9263" class="difflineminus">-   *    parser.process(string | component);</span>
<a href="#l1.9264"></a><span id="l1.9264" class="difflineminus">-   *</span>
<a href="#l1.9265"></a><span id="l1.9265" class="difflineminus">-   *</span>
<a href="#l1.9266"></a><span id="l1.9266" class="difflineminus">-   * @param {Object} options component parser options.</span>
<a href="#l1.9267"></a><span id="l1.9267" class="difflineplus">+   * @classdesc</span>
<a href="#l1.9268"></a><span id="l1.9268" class="difflineplus">+   * The ComponentParser is used to process a String or jCal Object,</span>
<a href="#l1.9269"></a><span id="l1.9269" class="difflineplus">+   * firing callbacks for various found components, as well as completion.</span>
<a href="#l1.9270"></a><span id="l1.9270" class="difflineplus">+   *</span>
<a href="#l1.9271"></a><span id="l1.9271" class="difflineplus">+   * @example</span>
<a href="#l1.9272"></a><span id="l1.9272" class="difflineplus">+   * var options = {</span>
<a href="#l1.9273"></a><span id="l1.9273" class="difflineplus">+   *   // when false no events will be emitted for type</span>
<a href="#l1.9274"></a><span id="l1.9274" class="difflineplus">+   *   parseEvent: true,</span>
<a href="#l1.9275"></a><span id="l1.9275" class="difflineplus">+   *   parseTimezone: true</span>
<a href="#l1.9276"></a><span id="l1.9276" class="difflineplus">+   * };</span>
<a href="#l1.9277"></a><span id="l1.9277" class="difflineplus">+   *</span>
<a href="#l1.9278"></a><span id="l1.9278" class="difflineplus">+   * var parser = new ICAL.ComponentParser(options);</span>
<a href="#l1.9279"></a><span id="l1.9279" class="difflineplus">+   *</span>
<a href="#l1.9280"></a><span id="l1.9280" class="difflineplus">+   * parser.onevent(eventComponent) {</span>
<a href="#l1.9281"></a><span id="l1.9281" class="difflineplus">+   *   //...</span>
<a href="#l1.9282"></a><span id="l1.9282" class="difflineplus">+   * }</span>
<a href="#l1.9283"></a><span id="l1.9283" class="difflineplus">+   *</span>
<a href="#l1.9284"></a><span id="l1.9284" class="difflineplus">+   * // ontimezone, etc...</span>
<a href="#l1.9285"></a><span id="l1.9285" class="difflineplus">+   *</span>
<a href="#l1.9286"></a><span id="l1.9286" class="difflineplus">+   * parser.oncomplete = function() {</span>
<a href="#l1.9287"></a><span id="l1.9287" class="difflineplus">+   *</span>
<a href="#l1.9288"></a><span id="l1.9288" class="difflineplus">+   * };</span>
<a href="#l1.9289"></a><span id="l1.9289" class="difflineplus">+   *</span>
<a href="#l1.9290"></a><span id="l1.9290" class="difflineplus">+   * parser.process(stringOrComponent);</span>
<a href="#l1.9291"></a><span id="l1.9291" class="difflineplus">+   *</span>
<a href="#l1.9292"></a><span id="l1.9292" class="difflineplus">+   * @class</span>
<a href="#l1.9293"></a><span id="l1.9293" class="difflineplus">+   * @alias ICAL.ComponentParser</span>
<a href="#l1.9294"></a><span id="l1.9294" class="difflineplus">+   * @param {Object=} options        Component parser options</span>
<a href="#l1.9295"></a><span id="l1.9295" class="difflineplus">+   * @param {Boolean} options.parseEvent        Whether events should be parsed</span>
<a href="#l1.9296"></a><span id="l1.9296" class="difflineplus">+   * @param {Boolean} options.parseTimezeone    Whether timezones should be parsed</span>
<a href="#l1.9297"></a><span id="l1.9297">    */</span>
<a href="#l1.9298"></a><span id="l1.9298">   function ComponentParser(options) {</span>
<a href="#l1.9299"></a><span id="l1.9299">     if (typeof(options) === 'undefined') {</span>
<a href="#l1.9300"></a><span id="l1.9300">       options = {};</span>
<a href="#l1.9301"></a><span id="l1.9301">     }</span>
<a href="#l1.9302"></a><span id="l1.9302"> </span>
<a href="#l1.9303"></a><span id="l1.9303">     var key;</span>
<a href="#l1.9304"></a><span id="l1.9304">     for (key in options) {</span>
<a href="#l1.9305"></a><span id="l1.9305" class="difflineplus">+      /* istanbul ignore else */</span>
<a href="#l1.9306"></a><span id="l1.9306">       if (options.hasOwnProperty(key)) {</span>
<a href="#l1.9307"></a><span id="l1.9307">         this[key] = options[key];</span>
<a href="#l1.9308"></a><span id="l1.9308">       }</span>
<a href="#l1.9309"></a><span id="l1.9309">     }</span>
<a href="#l1.9310"></a><span id="l1.9310">   }</span>
<a href="#l1.9311"></a><span id="l1.9311"> </span>
<a href="#l1.9312"></a><span id="l1.9312">   ComponentParser.prototype = {</span>
<a href="#l1.9313"></a><span id="l1.9313"> </span>
<a href="#l1.9314"></a><span id="l1.9314">     /**</span>
<a href="#l1.9315"></a><span id="l1.9315" class="difflineminus">-     * When true parse events</span>
<a href="#l1.9316"></a><span id="l1.9316" class="difflineminus">-     *</span>
<a href="#l1.9317"></a><span id="l1.9317" class="difflineminus">-     * @type Boolean</span>
<a href="#l1.9318"></a><span id="l1.9318" class="difflineplus">+     * When true, parse events</span>
<a href="#l1.9319"></a><span id="l1.9319" class="difflineplus">+     *</span>
<a href="#l1.9320"></a><span id="l1.9320" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.9321"></a><span id="l1.9321">      */</span>
<a href="#l1.9322"></a><span id="l1.9322">     parseEvent: true,</span>
<a href="#l1.9323"></a><span id="l1.9323"> </span>
<a href="#l1.9324"></a><span id="l1.9324">     /**</span>
<a href="#l1.9325"></a><span id="l1.9325" class="difflineminus">-     * when true parse timezones</span>
<a href="#l1.9326"></a><span id="l1.9326" class="difflineminus">-     *</span>
<a href="#l1.9327"></a><span id="l1.9327" class="difflineminus">-     * @type Boolean</span>
<a href="#l1.9328"></a><span id="l1.9328" class="difflineplus">+     * When true, parse timezones</span>
<a href="#l1.9329"></a><span id="l1.9329" class="difflineplus">+     *</span>
<a href="#l1.9330"></a><span id="l1.9330" class="difflineplus">+     * @type {Boolean}</span>
<a href="#l1.9331"></a><span id="l1.9331">      */</span>
<a href="#l1.9332"></a><span id="l1.9332">     parseTimezone: true,</span>
<a href="#l1.9333"></a><span id="l1.9333"> </span>
<a href="#l1.9334"></a><span id="l1.9334"> </span>
<a href="#l1.9335"></a><span id="l1.9335">     /* SAX like events here for reference */</span>
<a href="#l1.9336"></a><span id="l1.9336"> </span>
<a href="#l1.9337"></a><span id="l1.9337">     /**</span>
<a href="#l1.9338"></a><span id="l1.9338">      * Fired when parsing is complete</span>
<a href="#l1.9339"></a><span id="l1.9339" class="difflineminus">-     */</span>
<a href="#l1.9340"></a><span id="l1.9340" class="difflineminus">-    oncomplete: function() {},</span>
<a href="#l1.9341"></a><span id="l1.9341" class="difflineplus">+     * @callback</span>
<a href="#l1.9342"></a><span id="l1.9342" class="difflineplus">+     */</span>
<a href="#l1.9343"></a><span id="l1.9343" class="difflineplus">+    oncomplete: /* istanbul ignore next */ function() {},</span>
<a href="#l1.9344"></a><span id="l1.9344"> </span>
<a href="#l1.9345"></a><span id="l1.9345">     /**</span>
<a href="#l1.9346"></a><span id="l1.9346">      * Fired if an error occurs during parsing.</span>
<a href="#l1.9347"></a><span id="l1.9347">      *</span>
<a href="#l1.9348"></a><span id="l1.9348" class="difflineminus">-     * @param {Error} err details of error.</span>
<a href="#l1.9349"></a><span id="l1.9349" class="difflineminus">-     */</span>
<a href="#l1.9350"></a><span id="l1.9350" class="difflineminus">-    onerror: function(err) {},</span>
<a href="#l1.9351"></a><span id="l1.9351" class="difflineminus">-</span>
<a href="#l1.9352"></a><span id="l1.9352" class="difflineminus">-    /**</span>
<a href="#l1.9353"></a><span id="l1.9353" class="difflineminus">-     * Fired when a top level component (vtimezone) is found</span>
<a href="#l1.9354"></a><span id="l1.9354" class="difflineminus">-     *</span>
<a href="#l1.9355"></a><span id="l1.9355" class="difflineminus">-     * @param {ICAL.Timezone} timezone object.</span>
<a href="#l1.9356"></a><span id="l1.9356" class="difflineminus">-     */</span>
<a href="#l1.9357"></a><span id="l1.9357" class="difflineminus">-    ontimezone: function(component) {},</span>
<a href="#l1.9358"></a><span id="l1.9358" class="difflineminus">-</span>
<a href="#l1.9359"></a><span id="l1.9359" class="difflineminus">-    /*</span>
<a href="#l1.9360"></a><span id="l1.9360" class="difflineplus">+     * @callback</span>
<a href="#l1.9361"></a><span id="l1.9361" class="difflineplus">+     * @param {Error} err details of error</span>
<a href="#l1.9362"></a><span id="l1.9362" class="difflineplus">+     */</span>
<a href="#l1.9363"></a><span id="l1.9363" class="difflineplus">+    onerror: /* istanbul ignore next */ function(err) {},</span>
<a href="#l1.9364"></a><span id="l1.9364" class="difflineplus">+</span>
<a href="#l1.9365"></a><span id="l1.9365" class="difflineplus">+    /**</span>
<a href="#l1.9366"></a><span id="l1.9366" class="difflineplus">+     * Fired when a top level component (VTIMEZONE) is found</span>
<a href="#l1.9367"></a><span id="l1.9367" class="difflineplus">+     *</span>
<a href="#l1.9368"></a><span id="l1.9368" class="difflineplus">+     * @callback</span>
<a href="#l1.9369"></a><span id="l1.9369" class="difflineplus">+     * @param {ICAL.Timezone} component     Timezone object</span>
<a href="#l1.9370"></a><span id="l1.9370" class="difflineplus">+     */</span>
<a href="#l1.9371"></a><span id="l1.9371" class="difflineplus">+    ontimezone: /* istanbul ignore next */ function(component) {},</span>
<a href="#l1.9372"></a><span id="l1.9372" class="difflineplus">+</span>
<a href="#l1.9373"></a><span id="l1.9373" class="difflineplus">+    /**</span>
<a href="#l1.9374"></a><span id="l1.9374">      * Fired when a top level component (VEVENT) is found.</span>
<a href="#l1.9375"></a><span id="l1.9375" class="difflineminus">-     * @param {ICAL.Event} component top level component.</span>
<a href="#l1.9376"></a><span id="l1.9376" class="difflineminus">-     */</span>
<a href="#l1.9377"></a><span id="l1.9377" class="difflineminus">-    onevent: function(component) {},</span>
<a href="#l1.9378"></a><span id="l1.9378" class="difflineminus">-</span>
<a href="#l1.9379"></a><span id="l1.9379" class="difflineminus">-    /**</span>
<a href="#l1.9380"></a><span id="l1.9380" class="difflineminus">-     * Process a string or parse ical object.</span>
<a href="#l1.9381"></a><span id="l1.9381" class="difflineminus">-     * This function itself will return nothing but</span>
<a href="#l1.9382"></a><span id="l1.9382" class="difflineminus">-     * will start the parsing process.</span>
<a href="#l1.9383"></a><span id="l1.9383" class="difflineplus">+     *</span>
<a href="#l1.9384"></a><span id="l1.9384" class="difflineplus">+     * @callback</span>
<a href="#l1.9385"></a><span id="l1.9385" class="difflineplus">+     * @param {ICAL.Event} component    Top level component</span>
<a href="#l1.9386"></a><span id="l1.9386" class="difflineplus">+     */</span>
<a href="#l1.9387"></a><span id="l1.9387" class="difflineplus">+    onevent: /* istanbul ignore next */ function(component) {},</span>
<a href="#l1.9388"></a><span id="l1.9388" class="difflineplus">+</span>
<a href="#l1.9389"></a><span id="l1.9389" class="difflineplus">+    /**</span>
<a href="#l1.9390"></a><span id="l1.9390" class="difflineplus">+     * Process a string or parse ical object.  This function itself will return</span>
<a href="#l1.9391"></a><span id="l1.9391" class="difflineplus">+     * nothing but will start the parsing process.</span>
<a href="#l1.9392"></a><span id="l1.9392">      *</span>
<a href="#l1.9393"></a><span id="l1.9393">      * Events must be registered prior to calling this method.</span>
<a href="#l1.9394"></a><span id="l1.9394">      *</span>
<a href="#l1.9395"></a><span id="l1.9395" class="difflineminus">-     * @param {String|Object} ical string or parsed ical object.</span>
<a href="#l1.9396"></a><span id="l1.9396" class="difflineplus">+     * @param {ICAL.Component|String|Object} ical      The component to process,</span>
<a href="#l1.9397"></a><span id="l1.9397" class="difflineplus">+     *        either in its final form, as a jCal Object, or string representation</span>
<a href="#l1.9398"></a><span id="l1.9398">      */</span>
<a href="#l1.9399"></a><span id="l1.9399">     process: function(ical) {</span>
<a href="#l1.9400"></a><span id="l1.9400">       //TODO: this is sync now in the future we will have a incremental parser.</span>
<a href="#l1.9401"></a><span id="l1.9401">       if (typeof(ical) === 'string') {</span>
<a href="#l1.9402"></a><span id="l1.9402" class="difflineminus">-        ical = ICAL.parse(ical)[1];</span>
<a href="#l1.9403"></a><span id="l1.9403" class="difflineplus">+        ical = ICAL.parse(ical);</span>
<a href="#l1.9404"></a><span id="l1.9404">       }</span>
<a href="#l1.9405"></a><span id="l1.9405"> </span>
<a href="#l1.9406"></a><span id="l1.9406">       if (!(ical instanceof ICAL.Component)) {</span>
<a href="#l1.9407"></a><span id="l1.9407">         ical = new ICAL.Component(ical);</span>
<a href="#l1.9408"></a><span id="l1.9408">       }</span>
<a href="#l1.9409"></a><span id="l1.9409"> </span>
<a href="#l1.9410"></a><span id="l1.9410">       var components = ical.getAllSubcomponents();</span>
<a href="#l1.9411"></a><span id="l1.9411">       var i = 0;</span>
<a href="#l1.9412"></a><span id="l1.9412" class="difflineat">@@ -6727,10 +9346,9 @@ ICAL.ComponentParser = (function() {</span>
<a href="#l1.9413"></a><span id="l1.9413"> </span>
<a href="#l1.9414"></a><span id="l1.9414">       //XXX: ideally we should do a &quot;nextTick&quot; here</span>
<a href="#l1.9415"></a><span id="l1.9415">       //     so in all cases this is actually async.</span>
<a href="#l1.9416"></a><span id="l1.9416">       this.oncomplete();</span>
<a href="#l1.9417"></a><span id="l1.9417">     }</span>
<a href="#l1.9418"></a><span id="l1.9418">   };</span>
<a href="#l1.9419"></a><span id="l1.9419"> </span>
<a href="#l1.9420"></a><span id="l1.9420">   return ComponentParser;</span>
<a href="#l1.9421"></a><span id="l1.9421" class="difflineminus">-</span>
<a href="#l1.9422"></a><span id="l1.9422"> }());</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

