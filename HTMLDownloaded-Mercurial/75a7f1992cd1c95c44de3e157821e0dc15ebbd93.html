<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28806:75a7f1992cd1c95c44de3e157821e0dc15ebbd93</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 75a7f1992cd1c95c44de3e157821e0dc15ebbd93" />
<meta property="og:url" content="/comm-central/rev/75a7f1992cd1c95c44de3e157821e0dc15ebbd93" />
<meta property="og:description" content="Bug 1608626 - Fix browser.menus.overrideContext and add tests. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 75a7f1992cd1c95c44de3e157821e0dc15ebbd93 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/75a7f1992cd1c95c44de3e157821e0dc15ebbd93">shortlog</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/75a7f1992cd1c95c44de3e157821e0dc15ebbd93">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93">files</a> |
changeset |
<a href="/comm-central/raw-rev/75a7f1992cd1c95c44de3e157821e0dc15ebbd93">raw</a>  | <a href="/comm-central/archive/75a7f1992cd1c95c44de3e157821e0dc15ebbd93.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1608626">Bug 1608626</a> - Fix browser.menus.overrideContext and add tests. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 14 Feb 2020 14:25:37 +1300</td></tr>

<tr>
 <td>changeset 28806</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/75a7f1992cd1c95c44de3e157821e0dc15ebbd93">75a7f1992cd1c95c44de3e157821e0dc15ebbd93</a></td>
</tr>



<tr>
<td>parent 28805</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3d4077ea41a58b0e2a2a4308839ea7215865b5f0">3d4077ea41a58b0e2a2a4308839ea7215865b5f0</a>
</td>
</tr>

<tr>
<td>child 28807</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9fb8ea5699c1c8c1d97084a109b395df11a44d71">9fb8ea5699c1c8c1d97084a109b395df11a44d71</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=75a7f1992cd1c95c44de3e157821e0dc15ebbd93">17046</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Thu, 20 Feb 2020 09:46:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@231dc57f3704 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=231dc57f37045ab32c675e43a8058438d211129d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=231dc57f37045ab32c675e43a8058438d211129d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=231dc57f37045ab32c675e43a8058438d211129d&newProject=comm-central&newRevision=3d4077ea41a58b0e2a2a4308839ea7215865b5f0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=231dc57f37045ab32c675e43a8058438d211129d&newProject=comm-central&newRevision=3d4077ea41a58b0e2a2a4308839ea7215865b5f0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=231dc57f37045ab32c675e43a8058438d211129d&newProject=comm-central&newRevision=3d4077ea41a58b0e2a2a4308839ea7215865b5f0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1608626">1608626</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1608626">Bug 1608626</a> - Fix browser.menus.overrideContext and add tests. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/nsContextMenu.js">mail/base/content/nsContextMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/nsContextMenu.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/nsContextMenu.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/nsContextMenu.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/nsContextMenu.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/nsContextMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/specialTabs.js">mail/base/content/specialTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/specialTabs.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/specialTabs.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/specialTabs.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/specialTabs.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/base/content/specialTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/.eslintrc.js">mail/components/extensions/parent/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-mail.js">mail/components/extensions/parent/ext-mail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-mail.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-mail.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-mail.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-mail.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-mail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-menus.js">mail/components/extensions/parent/ext-menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-menus.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-menus.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-menus.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-menus.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-menus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-tabs.js">mail/components/extensions/parent/ext-tabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-tabs.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-tabs.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-tabs.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-tabs.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/parent/ext-tabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser.ini">mail/components/extensions/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js">mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js">mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/head.js">mail/components/extensions/test/browser/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/head.js">file</a> |
<a href="/comm-central/annotate/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/head.js">annotate</a> |
<a href="/comm-central/diff/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/head.js">diff</a> |
<a href="/comm-central/comparison/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/head.js">comparison</a> |
<a href="/comm-central/log/75a7f1992cd1c95c44de3e157821e0dc15ebbd93/mail/components/extensions/test/browser/head.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/nsContextMenu.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/nsContextMenu.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -101,39 +101,46 @@ nsContextMenu.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">       this.hasPageMenu = PageMenuParent.addToPopup(menuObject, null, aPopup);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">       let subject = {</span>
<a href="#l1.7"></a><span id="l1.7">         menu: aPopup,</span>
<a href="#l1.8"></a><span id="l1.8">         tab: document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l1.9"></a><span id="l1.9">           ? document.getElementById(&quot;tabmail&quot;).currentTabInfo</span>
<a href="#l1.10"></a><span id="l1.10">           : undefined,</span>
<a href="#l1.11"></a><span id="l1.11">         isContentSelected: this.isContentSelected,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        inFrame: this.inFrame,</span>
<a href="#l1.13"></a><span id="l1.13">         isTextSelected: this.isTextSelected,</span>
<a href="#l1.14"></a><span id="l1.14">         onTextInput: this.onTextInput,</span>
<a href="#l1.15"></a><span id="l1.15">         onLink: this.onLink,</span>
<a href="#l1.16"></a><span id="l1.16">         onImage: this.onImage,</span>
<a href="#l1.17"></a><span id="l1.17">         onVideo: this.onVideo,</span>
<a href="#l1.18"></a><span id="l1.18">         onAudio: this.onAudio,</span>
<a href="#l1.19"></a><span id="l1.19">         onCanvas: this.onCanvas,</span>
<a href="#l1.20"></a><span id="l1.20">         onEditable: this.onEditable,</span>
<a href="#l1.21"></a><span id="l1.21">         srcUrl: this.mediaURL,</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-        pageUrl: this.browser ? this.browser.currentURI.spec : undefined,</span>
<a href="#l1.23"></a><span id="l1.23">         linkText: this.onLink ? this.linkText() : undefined,</span>
<a href="#l1.24"></a><span id="l1.24">         linkUrl: this.linkURL,</span>
<a href="#l1.25"></a><span id="l1.25">         selectionText: this.isTextSelected</span>
<a href="#l1.26"></a><span id="l1.26">           ? this.selectionInfo.fullText</span>
<a href="#l1.27"></a><span id="l1.27">           : undefined,</span>
<a href="#l1.28"></a><span id="l1.28">       };</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+      if (this.target) {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+        subject.inFrame =</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+          this.target.ownerGlobal != this.target.ownerGlobal.top;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        subject.frameUrl = this.target.ownerGlobal.location.href;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+        subject.pageUrl = this.target.ownerGlobal.top.location.href;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+        subject.principal = this.target.ownerDocument.nodePrincipal;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+      }</span>
<a href="#l1.36"></a><span id="l1.36">       if (target.closest(&quot;tree&quot;) == gFolderDisplay.tree) {</span>
<a href="#l1.37"></a><span id="l1.37">         subject.displayedFolder = gFolderDisplay.view.displayedFolder;</span>
<a href="#l1.38"></a><span id="l1.38">         subject.selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l1.39"></a><span id="l1.39">       }</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+      subject.context = subject;</span>
<a href="#l1.41"></a><span id="l1.41">       subject.wrappedJSObject = subject;</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+      Services.obs.notifyObservers(subject, &quot;on-prepare-contextmenu&quot;);</span>
<a href="#l1.44"></a><span id="l1.44">       Services.obs.notifyObservers(subject, &quot;on-build-contextmenu&quot;);</span>
<a href="#l1.45"></a><span id="l1.45">     }</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">     this.initItems();</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49">     // If all items in the menu are hidden, set this.shouldDisplay to false</span>
<a href="#l1.50"></a><span id="l1.50">     // so that the callers know to not even display the empty menu.</span>
<a href="#l1.51"></a><span id="l1.51">     let contextPopup = document.getElementById(&quot;mailContext&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/specialTabs.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/specialTabs.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -882,17 +882,17 @@ var specialTabs = {</span>
<a href="#l2.4"></a><span id="l2.4">       if (aArgs.skipLoad) {</span>
<a href="#l2.5"></a><span id="l2.5">         clone.querySelector(&quot;browser&quot;).setAttribute(&quot;nodefaultsrc&quot;, &quot;true&quot;);</span>
<a href="#l2.6"></a><span id="l2.6">       }</span>
<a href="#l2.7"></a><span id="l2.7">       aTab.panel.setAttribute(&quot;id&quot;, &quot;contentTabWrapper&quot; + this.lastBrowserId);</span>
<a href="#l2.8"></a><span id="l2.8">       aTab.panel.appendChild(clone);</span>
<a href="#l2.9"></a><span id="l2.9">       aTab.root = clone;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">       // Start setting up the browser.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      aTab.browser = aTab.panel.querySelector(&quot;browser&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      aTab.linkedBrowser = aTab.browser = aTab.panel.querySelector(&quot;browser&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">       aTab.toolbar = aTab.panel.querySelector(&quot;.contentTabToolbar&quot;);</span>
<a href="#l2.15"></a><span id="l2.15">       aTab.backButton = aTab.toolbar.querySelector(&quot;.back-btn&quot;);</span>
<a href="#l2.16"></a><span id="l2.16">       aTab.backButton.addEventListener(&quot;command&quot;, () =&gt; aTab.browser.goBack());</span>
<a href="#l2.17"></a><span id="l2.17">       aTab.forwardButton = aTab.toolbar.querySelector(&quot;.forward-btn&quot;);</span>
<a href="#l2.18"></a><span id="l2.18">       aTab.forwardButton.addEventListener(&quot;command&quot;, () =&gt;</span>
<a href="#l2.19"></a><span id="l2.19">         aTab.browser.goForward()</span>
<a href="#l2.20"></a><span id="l2.20">       );</span>
<a href="#l2.21"></a><span id="l2.21">       aTab.security = aTab.toolbar.querySelector(&quot;.contentTabSecurity&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/extensions/parent/.eslintrc.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/extensions/parent/.eslintrc.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -33,16 +33,17 @@ module.exports = {</span>
<a href="#l3.4"></a><span id="l3.4">     isValidCookieStoreId: true,</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">     // These are defined in ext-mail.js.</span>
<a href="#l3.7"></a><span id="l3.7">     ExtensionError: true,</span>
<a href="#l3.8"></a><span id="l3.8">     Tab: true,</span>
<a href="#l3.9"></a><span id="l3.9">     TabmailTab: true,</span>
<a href="#l3.10"></a><span id="l3.10">     Window: true,</span>
<a href="#l3.11"></a><span id="l3.11">     TabmailWindow: true,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    clickModifiersFromEvent: true,</span>
<a href="#l3.13"></a><span id="l3.13">     convertFolder: true,</span>
<a href="#l3.14"></a><span id="l3.14">     convertMessage: true,</span>
<a href="#l3.15"></a><span id="l3.15">     folderPathToURI: true,</span>
<a href="#l3.16"></a><span id="l3.16">     folderURIToPath: true,</span>
<a href="#l3.17"></a><span id="l3.17">     getTabBrowser: true,</span>
<a href="#l3.18"></a><span id="l3.18">     makeWidgetId: true,</span>
<a href="#l3.19"></a><span id="l3.19">     messageListTracker: true,</span>
<a href="#l3.20"></a><span id="l3.20">     messageTracker: true,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-mail.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-mail.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -17,16 +17,17 @@ XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l4.4"></a><span id="l4.4">   &quot;nsIUUIDGenerator&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> );</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> var { ExtensionError, getInnerWindowID } = ExtensionUtils;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var { defineLazyGetter } = ExtensionCommon;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  AppConstants: &quot;resource://gre/modules/AppConstants.jsm&quot;,</span>
<a href="#l4.13"></a><span id="l4.13">   ExtensionPageChild: &quot;resource://gre/modules/ExtensionPageChild.jsm&quot;,</span>
<a href="#l4.14"></a><span id="l4.14">   ExtensionProcessScript: &quot;resource://gre/modules/ExtensionProcessScript.jsm&quot;,</span>
<a href="#l4.15"></a><span id="l4.15">   ExtensionContent: &quot;resource://gre/modules/ExtensionContent.jsm&quot;,</span>
<a href="#l4.16"></a><span id="l4.16">   Schemas: &quot;resource://gre/modules/Schemas.jsm&quot;,</span>
<a href="#l4.17"></a><span id="l4.17"> });</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> // Inject the |messenger| object as an alias to |browser| in all known contexts. This is a bit</span>
<a href="#l4.20"></a><span id="l4.20"> // fragile since it uses monkeypatching. If a test fails, the best way to debug is to search for</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -105,16 +106,34 @@ const getSender = (extension, target, se</span>
<a href="#l4.22"></a><span id="l4.22">       sender.tab = tab.convert();</span>
<a href="#l4.23"></a><span id="l4.23">     }</span>
<a href="#l4.24"></a><span id="l4.24">   }</span>
<a href="#l4.25"></a><span id="l4.25"> };</span>
<a href="#l4.26"></a><span id="l4.26"> </span>
<a href="#l4.27"></a><span id="l4.27"> // Used by Extension.jsm.</span>
<a href="#l4.28"></a><span id="l4.28"> global.tabGetSender = getSender;</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+global.clickModifiersFromEvent = event =&gt; {</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  const map = {</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    shiftKey: &quot;Shift&quot;,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    altKey: &quot;Alt&quot;,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+    metaKey: &quot;Command&quot;,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    ctrlKey: &quot;Ctrl&quot;,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  };</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  let modifiers = Object.keys(map)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    .filter(key =&gt; event[key])</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    .map(key =&gt; map[key]);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  if (event.ctrlKey &amp;&amp; AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+    modifiers.push(&quot;MacCtrl&quot;);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  }</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  return modifiers;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+};</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+</span>
<a href="#l4.48"></a><span id="l4.48"> global.makeWidgetId = id =&gt; {</span>
<a href="#l4.49"></a><span id="l4.49">   id = id.toLowerCase();</span>
<a href="#l4.50"></a><span id="l4.50">   // FIXME: This allows for collisions.</span>
<a href="#l4.51"></a><span id="l4.51">   return id.replace(/[^a-z0-9_-]/g, &quot;_&quot;);</span>
<a href="#l4.52"></a><span id="l4.52"> };</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54"> /**</span>
<a href="#l4.55"></a><span id="l4.55">  * Gets the tab browser for the tabmail tabInfo.</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineat">@@ -168,28 +187,32 @@ class WindowTracker extends WindowTracke</span>
<a href="#l4.57"></a><span id="l4.57">   /**</span>
<a href="#l4.58"></a><span id="l4.58">    * Adds a tab progress listener to the given mail window.</span>
<a href="#l4.59"></a><span id="l4.59">    *</span>
<a href="#l4.60"></a><span id="l4.60">    * @param {DOMWindow} window      The mail window to which to add the listener.</span>
<a href="#l4.61"></a><span id="l4.61">    * @param {Object} listener       The listener to add</span>
<a href="#l4.62"></a><span id="l4.62">    */</span>
<a href="#l4.63"></a><span id="l4.63">   addProgressListener(window, listener) {</span>
<a href="#l4.64"></a><span id="l4.64">     let tabmail = window.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    tabmail.addTabsProgressListener(listener);</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    if (tabmail) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      tabmail.addTabsProgressListener(listener);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    }</span>
<a href="#l4.69"></a><span id="l4.69">   }</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71">   /**</span>
<a href="#l4.72"></a><span id="l4.72">    * Removes a tab progress listener from the given mail window.</span>
<a href="#l4.73"></a><span id="l4.73">    *</span>
<a href="#l4.74"></a><span id="l4.74">    * @param {DOMWindow} window      The mail window from which to remove the listener.</span>
<a href="#l4.75"></a><span id="l4.75">    * @param {Object} listener       The listener to remove</span>
<a href="#l4.76"></a><span id="l4.76">    */</span>
<a href="#l4.77"></a><span id="l4.77">   removeProgressListener(window, listener) {</span>
<a href="#l4.78"></a><span id="l4.78">     let tabmail = window.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-    tabmail.removeTabsProgressListener(listener);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    if (tabmail) {</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+      tabmail.removeTabsProgressListener(listener);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+    }</span>
<a href="#l4.83"></a><span id="l4.83">   }</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85">   /**</span>
<a href="#l4.86"></a><span id="l4.86">    * Determines if the passed window object is a mail window. The function name is for base class</span>
<a href="#l4.87"></a><span id="l4.87">    * compatibility with gecko.</span>
<a href="#l4.88"></a><span id="l4.88">    *</span>
<a href="#l4.89"></a><span id="l4.89">    * @param {DOMWindow} window      The window to check</span>
<a href="#l4.90"></a><span id="l4.90">    * @return {Boolean}              True, if the window is a mail window</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-menus.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-menus.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -24,18 +24,20 @@ var gMenuMap = new Map();</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> // Map[Extension -&gt; MenuItem]</span>
<a href="#l5.6"></a><span id="l5.6"> var gRootItems = new Map();</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> // Map[Extension -&gt; ID[]]</span>
<a href="#l5.9"></a><span id="l5.9"> // Menu IDs that were eligible for being shown in the current menu.</span>
<a href="#l5.10"></a><span id="l5.10"> var gShownMenuItems = new DefaultMap(() =&gt; []);</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-// Set of extensions that are listening to onShown.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-var gOnShownSubscribers = new Set();</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+// Map[Extension -&gt; Set[Contexts]]</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+// A DefaultMap (keyed by extension) which keeps track of the</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+// contexts with a subscribed onShown event listener.</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+var gOnShownSubscribers = new DefaultMap(() =&gt; new Set());</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> // If id is not specified for an item we use an integer.</span>
<a href="#l5.20"></a><span id="l5.20"> var gNextMenuItemID = 0;</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22"> // Used to assign unique names to radio groups.</span>
<a href="#l5.23"></a><span id="l5.23"> var gNextRadioGroupID = 0;</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> // The max length of a menu item's label.</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -90,32 +92,32 @@ var gMenuBuilder = {</span>
<a href="#l5.27"></a><span id="l5.27">         onTab: true,</span>
<a href="#l5.28"></a><span id="l5.28">       };</span>
<a href="#l5.29"></a><span id="l5.29">     }</span>
<a href="#l5.30"></a><span id="l5.30">     throw new Error(</span>
<a href="#l5.31"></a><span id="l5.31">       `Unexpected overrideContext: ${webExtContextData.overrideContext}`</span>
<a href="#l5.32"></a><span id="l5.32">     );</span>
<a href="#l5.33"></a><span id="l5.33">   },</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  createAndInsertTopLevelElements(root, contextData, nextElementSibling) {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  createAndInsertTopLevelElements(root, contextData, nextSibling) {</span>
<a href="#l5.37"></a><span id="l5.37">     let rootElements;</span>
<a href="#l5.38"></a><span id="l5.38">     if (contextData.onBrowserAction || contextData.onPageAction) {</span>
<a href="#l5.39"></a><span id="l5.39">       if (contextData.extension.id !== root.extension.id) {</span>
<a href="#l5.40"></a><span id="l5.40">         return;</span>
<a href="#l5.41"></a><span id="l5.41">       }</span>
<a href="#l5.42"></a><span id="l5.42">       rootElements = this.buildTopLevelElements(</span>
<a href="#l5.43"></a><span id="l5.43">         root,</span>
<a href="#l5.44"></a><span id="l5.44">         contextData,</span>
<a href="#l5.45"></a><span id="l5.45">         ACTION_MENU_TOP_LEVEL_LIMIT,</span>
<a href="#l5.46"></a><span id="l5.46">         false</span>
<a href="#l5.47"></a><span id="l5.47">       );</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">       // Action menu items are prepended to the menu, followed by a separator.</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-      nextElementSibling = nextElementSibling || this.xulMenu.firstElementChild;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-      if (rootElements.length &amp;&amp; !this.itemsToCleanUp.has(nextElementSibling)) {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      nextSibling = nextSibling || this.xulMenu.firstElementChild;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      if (rootElements.length &amp;&amp; !this.itemsToCleanUp.has(nextSibling)) {</span>
<a href="#l5.54"></a><span id="l5.54">         rootElements.push(</span>
<a href="#l5.55"></a><span id="l5.55">           this.xulMenu.ownerDocument.createXULElement(&quot;menuseparator&quot;)</span>
<a href="#l5.56"></a><span id="l5.56">         );</span>
<a href="#l5.57"></a><span id="l5.57">       }</span>
<a href="#l5.58"></a><span id="l5.58">     } else if (contextData.webExtContextData) {</span>
<a href="#l5.59"></a><span id="l5.59">       let {</span>
<a href="#l5.60"></a><span id="l5.60">         extensionId,</span>
<a href="#l5.61"></a><span id="l5.61">         showDefaults,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineat">@@ -124,23 +126,22 @@ var gMenuBuilder = {</span>
<a href="#l5.63"></a><span id="l5.63">       if (extensionId === root.extension.id) {</span>
<a href="#l5.64"></a><span id="l5.64">         rootElements = this.buildTopLevelElements(</span>
<a href="#l5.65"></a><span id="l5.65">           root,</span>
<a href="#l5.66"></a><span id="l5.66">           contextData,</span>
<a href="#l5.67"></a><span id="l5.67">           Infinity,</span>
<a href="#l5.68"></a><span id="l5.68">           false</span>
<a href="#l5.69"></a><span id="l5.69">         );</span>
<a href="#l5.70"></a><span id="l5.70">         // The extension menu should be rendered at the top, but after the navigation buttons.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-        nextElementSibling =</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-          nextElementSibling ||</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-          this.xulMenu.querySelector(&quot;:scope &gt; #context-sep-navigation + *&quot;);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+        nextSibling =</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+          nextSibling || this.xulMenu.querySelector(&quot;:scope &gt; :first-child&quot;);</span>
<a href="#l5.76"></a><span id="l5.76">         if (</span>
<a href="#l5.77"></a><span id="l5.77">           rootElements.length &amp;&amp;</span>
<a href="#l5.78"></a><span id="l5.78">           showDefaults &amp;&amp;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-          !this.itemsToCleanUp.has(nextElementSibling)</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+          !this.itemsToCleanUp.has(nextSibling)</span>
<a href="#l5.81"></a><span id="l5.81">         ) {</span>
<a href="#l5.82"></a><span id="l5.82">           rootElements.push(</span>
<a href="#l5.83"></a><span id="l5.83">             this.xulMenu.ownerDocument.createXULElement(&quot;menuseparator&quot;)</span>
<a href="#l5.84"></a><span id="l5.84">           );</span>
<a href="#l5.85"></a><span id="l5.85">         }</span>
<a href="#l5.86"></a><span id="l5.86">       } else if (!showDefaults &amp;&amp; !overrideContext) {</span>
<a href="#l5.87"></a><span id="l5.87">         // When the default menu items should be hidden, menu items from other</span>
<a href="#l5.88"></a><span id="l5.88">         // extensions should be hidden too.</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineat">@@ -161,18 +162,18 @@ var gMenuBuilder = {</span>
<a href="#l5.90"></a><span id="l5.90">         );</span>
<a href="#l5.91"></a><span id="l5.91">       }</span>
<a href="#l5.92"></a><span id="l5.92">     }</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94">     if (!rootElements.length) {</span>
<a href="#l5.95"></a><span id="l5.95">       return;</span>
<a href="#l5.96"></a><span id="l5.96">     }</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    if (nextElementSibling) {</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-      nextElementSibling.before(...rootElements);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    if (nextSibling) {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+      nextSibling.before(...rootElements);</span>
<a href="#l5.102"></a><span id="l5.102">     } else {</span>
<a href="#l5.103"></a><span id="l5.103">       this.xulMenu.append(...rootElements);</span>
<a href="#l5.104"></a><span id="l5.104">     }</span>
<a href="#l5.105"></a><span id="l5.105">     for (let item of rootElements) {</span>
<a href="#l5.106"></a><span id="l5.106">       this.itemsToCleanUp.add(item);</span>
<a href="#l5.107"></a><span id="l5.107">     }</span>
<a href="#l5.108"></a><span id="l5.108">   },</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110" class="difflineat">@@ -268,17 +269,17 @@ var gMenuBuilder = {</span>
<a href="#l5.111"></a><span id="l5.111">         }</span>
<a href="#l5.112"></a><span id="l5.112">       }</span>
<a href="#l5.113"></a><span id="l5.113">     }</span>
<a href="#l5.114"></a><span id="l5.114">   },</span>
<a href="#l5.115"></a><span id="l5.115"> </span>
<a href="#l5.116"></a><span id="l5.116">   buildSingleElement(item, contextData) {</span>
<a href="#l5.117"></a><span id="l5.117">     let doc = contextData.menu.ownerDocument;</span>
<a href="#l5.118"></a><span id="l5.118">     let element;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-    if (item.children.length &gt; 0) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    if (item.children.length) {</span>
<a href="#l5.121"></a><span id="l5.121">       element = this.createMenuElement(doc, item);</span>
<a href="#l5.122"></a><span id="l5.122">     } else if (item.type == &quot;separator&quot;) {</span>
<a href="#l5.123"></a><span id="l5.123">       element = doc.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l5.124"></a><span id="l5.124">     } else {</span>
<a href="#l5.125"></a><span id="l5.125">       element = doc.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l5.126"></a><span id="l5.126">     }</span>
<a href="#l5.127"></a><span id="l5.127"> </span>
<a href="#l5.128"></a><span id="l5.128">     return this.customizeElement(element, item, contextData);</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineat">@@ -401,29 +402,17 @@ var gMenuBuilder = {</span>
<a href="#l5.130"></a><span id="l5.130">           // activeTab since the extension also controls the tabId.</span>
<a href="#l5.131"></a><span id="l5.131">           (!webExtContextData ||</span>
<a href="#l5.132"></a><span id="l5.132">             webExtContextData.extensionId !== item.extension.id)</span>
<a href="#l5.133"></a><span id="l5.133">         ) {</span>
<a href="#l5.134"></a><span id="l5.134">           item.tabManager.addActiveTabPermission(contextData.tab);</span>
<a href="#l5.135"></a><span id="l5.135">         }</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137">         let info = item.getClickInfo(contextData, wasChecked);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-        const map = {</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-          shiftKey: &quot;Shift&quot;,</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-          altKey: &quot;Alt&quot;,</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-          metaKey: &quot;Command&quot;,</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-          ctrlKey: &quot;Ctrl&quot;,</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-        };</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-        info.modifiers = Object.keys(map)</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-          .filter(key =&gt; event[key])</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-          .map(key =&gt; map[key]);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-        if (event.ctrlKey &amp;&amp; AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-          info.modifiers.push(&quot;MacCtrl&quot;);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-        }</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+        info.modifiers = clickModifiersFromEvent(event);</span>
<a href="#l5.152"></a><span id="l5.152"> </span>
<a href="#l5.153"></a><span id="l5.153">         info.button = button;</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155">         // Allow menus to open various actions supported in webext prior</span>
<a href="#l5.156"></a><span id="l5.156">         // to notifying onclicked.</span>
<a href="#l5.157"></a><span id="l5.157">         let actionFor = {</span>
<a href="#l5.158"></a><span id="l5.158">           _execute_browser_action: global.browserActionFor,</span>
<a href="#l5.159"></a><span id="l5.159">         }[item.command];</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineat">@@ -436,18 +425,18 @@ var gMenuBuilder = {</span>
<a href="#l5.161"></a><span id="l5.161">           &quot;webext-menu-menuitem-click&quot;,</span>
<a href="#l5.162"></a><span id="l5.162">           info,</span>
<a href="#l5.163"></a><span id="l5.163">           contextData.tab</span>
<a href="#l5.164"></a><span id="l5.164">         );</span>
<a href="#l5.165"></a><span id="l5.165">       },</span>
<a href="#l5.166"></a><span id="l5.166">       { once: true }</span>
<a href="#l5.167"></a><span id="l5.167">     );</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+    // eslint-disable-next-line mozilla/balanced-listeners</span>
<a href="#l5.170"></a><span id="l5.170">     element.addEventListener(&quot;click&quot;, event =&gt; {</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-      // eslint-disable-line mozilla/balanced-listeners</span>
<a href="#l5.172"></a><span id="l5.172">       if (</span>
<a href="#l5.173"></a><span id="l5.173">         event.target !== event.currentTarget ||</span>
<a href="#l5.174"></a><span id="l5.174">         // Ignore menu items that are usually not clickeable,</span>
<a href="#l5.175"></a><span id="l5.175">         // such as separators and parents of submenus and disabled items.</span>
<a href="#l5.176"></a><span id="l5.176">         element.localName !== &quot;menuitem&quot; ||</span>
<a href="#l5.177"></a><span id="l5.177">         element.disabled</span>
<a href="#l5.178"></a><span id="l5.178">       ) {</span>
<a href="#l5.179"></a><span id="l5.179">         return;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineat">@@ -503,32 +492,28 @@ var gMenuBuilder = {</span>
<a href="#l5.181"></a><span id="l5.181">     if (!contextData) {</span>
<a href="#l5.182"></a><span id="l5.182">       // This happens if the menu is not visible.</span>
<a href="#l5.183"></a><span id="l5.183">       return;</span>
<a href="#l5.184"></a><span id="l5.184">     }</span>
<a href="#l5.185"></a><span id="l5.185"> </span>
<a href="#l5.186"></a><span id="l5.186">     // Find the group of existing top-level items (usually 0 or 1 items)</span>
<a href="#l5.187"></a><span id="l5.187">     // and remember its position for when the new items are inserted.</span>
<a href="#l5.188"></a><span id="l5.188">     let elementIdPrefix = `${makeWidgetId(extension.id)}-menuitem-`;</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-    let nextElementSibling = null;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+    let nextSibling = null;</span>
<a href="#l5.191"></a><span id="l5.191">     for (let item of this.itemsToCleanUp) {</span>
<a href="#l5.192"></a><span id="l5.192">       if (item.id &amp;&amp; item.id.startsWith(elementIdPrefix)) {</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-        nextElementSibling = item.nextElementSibling;</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+        nextSibling = item.nextSibling;</span>
<a href="#l5.195"></a><span id="l5.195">         item.remove();</span>
<a href="#l5.196"></a><span id="l5.196">         this.itemsToCleanUp.delete(item);</span>
<a href="#l5.197"></a><span id="l5.197">       }</span>
<a href="#l5.198"></a><span id="l5.198">     }</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200">     let root = gRootItems.get(extension);</span>
<a href="#l5.201"></a><span id="l5.201">     if (root) {</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-      this.createAndInsertTopLevelElements(</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-        root,</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-        contextData,</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-        nextElementSibling</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-      );</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+      this.createAndInsertTopLevelElements(root, contextData, nextSibling);</span>
<a href="#l5.208"></a><span id="l5.208">     }</span>
<a href="#l5.209"></a><span id="l5.209">     this.removeSeparatorIfNoTopLevelItems();</span>
<a href="#l5.210"></a><span id="l5.210">   },</span>
<a href="#l5.211"></a><span id="l5.211"> </span>
<a href="#l5.212"></a><span id="l5.212">   // This should be called once, after constructing the top-level menus, if any.</span>
<a href="#l5.213"></a><span id="l5.213">   afterBuildingMenu(contextData) {</span>
<a href="#l5.214"></a><span id="l5.214">     function dispatchOnShownEvent(extension) {</span>
<a href="#l5.215"></a><span id="l5.215">       // Note: gShownMenuItems is a DefaultMap, so .get(extension) causes the</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineat">@@ -537,17 +522,19 @@ var gMenuBuilder = {</span>
<a href="#l5.217"></a><span id="l5.217">       // when the menu is closed.</span>
<a href="#l5.218"></a><span id="l5.218">       let menuIds = gShownMenuItems.get(extension);</span>
<a href="#l5.219"></a><span id="l5.219">       extension.emit(&quot;webext-menu-shown&quot;, menuIds, contextData);</span>
<a href="#l5.220"></a><span id="l5.220">     }</span>
<a href="#l5.221"></a><span id="l5.221"> </span>
<a href="#l5.222"></a><span id="l5.222">     if (contextData.onBrowserAction || contextData.onPageAction) {</span>
<a href="#l5.223"></a><span id="l5.223">       dispatchOnShownEvent(contextData.extension);</span>
<a href="#l5.224"></a><span id="l5.224">     } else {</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-      gOnShownSubscribers.forEach(dispatchOnShownEvent);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+      for (const extension of gOnShownSubscribers.keys()) {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+        dispatchOnShownEvent(extension);</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+      }</span>
<a href="#l5.229"></a><span id="l5.229">     }</span>
<a href="#l5.230"></a><span id="l5.230"> </span>
<a href="#l5.231"></a><span id="l5.231">     this.contextData = contextData;</span>
<a href="#l5.232"></a><span id="l5.232">   },</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234">   hideDefaultMenuItems() {</span>
<a href="#l5.235"></a><span id="l5.235">     for (let item of this.xulMenu.children) {</span>
<a href="#l5.236"></a><span id="l5.236">       if (!this.itemsToCleanUp.has(item)) {</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineat">@@ -629,17 +616,17 @@ function getContextViewType(contextData)</span>
<a href="#l5.238"></a><span id="l5.238">     return contextData.originalViewType;</span>
<a href="#l5.239"></a><span id="l5.239">   }</span>
<a href="#l5.240"></a><span id="l5.240">   if (</span>
<a href="#l5.241"></a><span id="l5.241">     contextData.webExtBrowserType === &quot;popup&quot; ||</span>
<a href="#l5.242"></a><span id="l5.242">     contextData.webExtBrowserType === &quot;sidebar&quot;</span>
<a href="#l5.243"></a><span id="l5.243">   ) {</span>
<a href="#l5.244"></a><span id="l5.244">     return contextData.webExtBrowserType;</span>
<a href="#l5.245"></a><span id="l5.245">   }</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-  if (contextData.tab &amp;&amp; contextData.menu.id === &quot;tabContextMenu&quot;) {</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+  if (contextData.tab &amp;&amp; contextData.menu.id === &quot;mailContext&quot;) {</span>
<a href="#l5.248"></a><span id="l5.248">     return &quot;tab&quot;;</span>
<a href="#l5.249"></a><span id="l5.249">   }</span>
<a href="#l5.250"></a><span id="l5.250">   return undefined;</span>
<a href="#l5.251"></a><span id="l5.251"> }</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253"> function addMenuEventInfo(info, contextData, extension, includeSensitiveData) {</span>
<a href="#l5.254"></a><span id="l5.254">   info.viewType = getContextViewType(contextData);</span>
<a href="#l5.255"></a><span id="l5.255">   if (contextData.onVideo) {</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineat">@@ -660,16 +647,17 @@ function addMenuEventInfo(info, contextD</span>
<a href="#l5.257"></a><span id="l5.257">     }</span>
<a href="#l5.258"></a><span id="l5.258">     if (contextData.onLink) {</span>
<a href="#l5.259"></a><span id="l5.259">       info.linkText = contextData.linkText;</span>
<a href="#l5.260"></a><span id="l5.260">       info.linkUrl = contextData.linkUrl;</span>
<a href="#l5.261"></a><span id="l5.261">     }</span>
<a href="#l5.262"></a><span id="l5.262">     if (contextData.onAudio || contextData.onImage || contextData.onVideo) {</span>
<a href="#l5.263"></a><span id="l5.263">       info.srcUrl = contextData.srcUrl;</span>
<a href="#l5.264"></a><span id="l5.264">     }</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+    info.pageUrl = contextData.pageUrl;</span>
<a href="#l5.266"></a><span id="l5.266">     if (contextData.inFrame) {</span>
<a href="#l5.267"></a><span id="l5.267">       info.frameUrl = contextData.frameUrl;</span>
<a href="#l5.268"></a><span id="l5.268">     }</span>
<a href="#l5.269"></a><span id="l5.269">     if (contextData.isTextSelected) {</span>
<a href="#l5.270"></a><span id="l5.270">       info.selectionText = contextData.selectionText;</span>
<a href="#l5.271"></a><span id="l5.271">     }</span>
<a href="#l5.272"></a><span id="l5.272">   }</span>
<a href="#l5.273"></a><span id="l5.273">   // If the context was overridden, then frameUrl should be the URL of the</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineat">@@ -962,22 +950,17 @@ const menuTracker = {</span>
<a href="#l5.275"></a><span id="l5.275">       this.onWindowOpen(window);</span>
<a href="#l5.276"></a><span id="l5.276">     }</span>
<a href="#l5.277"></a><span id="l5.277">     windowTracker.addOpenListener(this.onWindowOpen);</span>
<a href="#l5.278"></a><span id="l5.278">   },</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280">   unregister() {</span>
<a href="#l5.281"></a><span id="l5.281">     Services.obs.removeObserver(this, &quot;on-build-contextmenu&quot;);</span>
<a href="#l5.282"></a><span id="l5.282">     for (const window of windowTracker.browserWindows()) {</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-      for (const id of this.menuIds) {</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-        const menu = window.document.getElementById(id);</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-        if (menu) {</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-          menu.removeEventListener(&quot;popupshowing&quot;, this);</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-        }</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-      }</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+      this.cleanupWindow(window);</span>
<a href="#l5.290"></a><span id="l5.290">     }</span>
<a href="#l5.291"></a><span id="l5.291">     windowTracker.removeOpenListener(this.onWindowOpen);</span>
<a href="#l5.292"></a><span id="l5.292">   },</span>
<a href="#l5.293"></a><span id="l5.293"> </span>
<a href="#l5.294"></a><span id="l5.294">   observe(subject, topic, data) {</span>
<a href="#l5.295"></a><span id="l5.295">     subject = subject.wrappedJSObject;</span>
<a href="#l5.296"></a><span id="l5.296">     gMenuBuilder.build(subject);</span>
<a href="#l5.297"></a><span id="l5.297">   },</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineat">@@ -986,16 +969,25 @@ const menuTracker = {</span>
<a href="#l5.299"></a><span id="l5.299">     for (const id of menuTracker.menuIds) {</span>
<a href="#l5.300"></a><span id="l5.300">       const menu = window.document.getElementById(id);</span>
<a href="#l5.301"></a><span id="l5.301">       if (menu) {</span>
<a href="#l5.302"></a><span id="l5.302">         menu.addEventListener(&quot;popupshowing&quot;, menuTracker);</span>
<a href="#l5.303"></a><span id="l5.303">       }</span>
<a href="#l5.304"></a><span id="l5.304">     }</span>
<a href="#l5.305"></a><span id="l5.305">   },</span>
<a href="#l5.306"></a><span id="l5.306"> </span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+  cleanupWindow(window) {</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+    for (const id of this.menuIds) {</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+      const menu = window.document.getElementById(id);</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+      if (menu) {</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+        menu.removeEventListener(&quot;popupshowing&quot;, this);</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+      }</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+    }</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+  },</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+</span>
<a href="#l5.316"></a><span id="l5.316">   handleEvent(event) {</span>
<a href="#l5.317"></a><span id="l5.317">     const menu = event.target;</span>
<a href="#l5.318"></a><span id="l5.318">     if (menu.id === &quot;tabContextMenu&quot;) {</span>
<a href="#l5.319"></a><span id="l5.319">       let trigger = menu.triggerNode;</span>
<a href="#l5.320"></a><span id="l5.320">       while (trigger &amp;&amp; trigger.localName != &quot;tab&quot;) {</span>
<a href="#l5.321"></a><span id="l5.321">         trigger = trigger.parentNode;</span>
<a href="#l5.322"></a><span id="l5.322">       }</span>
<a href="#l5.323"></a><span id="l5.323">       const tab = trigger || tabTracker.activeTab;</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineat">@@ -1021,17 +1013,17 @@ this.menus = class extends ExtensionAPI </span>
<a href="#l5.325"></a><span id="l5.325">     super(extension);</span>
<a href="#l5.326"></a><span id="l5.326"> </span>
<a href="#l5.327"></a><span id="l5.327">     if (!gMenuMap.size) {</span>
<a href="#l5.328"></a><span id="l5.328">       menuTracker.register();</span>
<a href="#l5.329"></a><span id="l5.329">     }</span>
<a href="#l5.330"></a><span id="l5.330">     gMenuMap.set(extension, new Map());</span>
<a href="#l5.331"></a><span id="l5.331">   }</span>
<a href="#l5.332"></a><span id="l5.332"> </span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-  onShutdown(reason) {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+  onShutdown() {</span>
<a href="#l5.335"></a><span id="l5.335">     let { extension } = this;</span>
<a href="#l5.336"></a><span id="l5.336"> </span>
<a href="#l5.337"></a><span id="l5.337">     if (gMenuMap.has(extension)) {</span>
<a href="#l5.338"></a><span id="l5.338">       gMenuMap.delete(extension);</span>
<a href="#l5.339"></a><span id="l5.339">       gRootItems.delete(extension);</span>
<a href="#l5.340"></a><span id="l5.340">       gShownMenuItems.delete(extension);</span>
<a href="#l5.341"></a><span id="l5.341">       gOnShownSubscribers.delete(extension);</span>
<a href="#l5.342"></a><span id="l5.342">       if (!gMenuMap.size) {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineat">@@ -1077,20 +1069,24 @@ this.menus = class extends ExtensionAPI </span>
<a href="#l5.344"></a><span id="l5.344">                 contextData,</span>
<a href="#l5.345"></a><span id="l5.345">                 extension,</span>
<a href="#l5.346"></a><span id="l5.346">                 includeSensitiveData</span>
<a href="#l5.347"></a><span id="l5.347">               );</span>
<a href="#l5.348"></a><span id="l5.348"> </span>
<a href="#l5.349"></a><span id="l5.349">               let tab = nativeTab &amp;&amp; extension.tabManager.convert(nativeTab);</span>
<a href="#l5.350"></a><span id="l5.350">               fire.sync(info, tab);</span>
<a href="#l5.351"></a><span id="l5.351">             };</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-            gOnShownSubscribers.add(extension);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+            gOnShownSubscribers.get(extension).add(context);</span>
<a href="#l5.354"></a><span id="l5.354">             extension.on(&quot;webext-menu-shown&quot;, listener);</span>
<a href="#l5.355"></a><span id="l5.355">             return () =&gt; {</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-              gOnShownSubscribers.delete(extension);</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+              const contexts = gOnShownSubscribers.get(extension);</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+              contexts.delete(context);</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+              if (contexts.size === 0) {</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+                gOnShownSubscribers.delete(extension);</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+              }</span>
<a href="#l5.362"></a><span id="l5.362">               extension.off(&quot;webext-menu-shown&quot;, listener);</span>
<a href="#l5.363"></a><span id="l5.363">             };</span>
<a href="#l5.364"></a><span id="l5.364">           },</span>
<a href="#l5.365"></a><span id="l5.365">         }).api(),</span>
<a href="#l5.366"></a><span id="l5.366">         onHidden: new EventManager({</span>
<a href="#l5.367"></a><span id="l5.367">           context,</span>
<a href="#l5.368"></a><span id="l5.368">           name: &quot;menus.onHidden&quot;,</span>
<a href="#l5.369"></a><span id="l5.369">           register: fire =&gt; {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-tabs.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-tabs.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -33,17 +33,17 @@ let tabListener = {</span>
<a href="#l6.4"></a><span id="l6.4">    *</span>
<a href="#l6.5"></a><span id="l6.5">    * @param {Element} browser               The browser element that caused the change</span>
<a href="#l6.6"></a><span id="l6.6">    * @param {nsIWebProgress} webProgress    The web progress for the location change</span>
<a href="#l6.7"></a><span id="l6.7">    * @param {nsIRequest} request            The xpcom request for this change</span>
<a href="#l6.8"></a><span id="l6.8">    * @param {nsIURI} locationURI            The target uri</span>
<a href="#l6.9"></a><span id="l6.9">    * @param {Integer} flags                 The web progress flags for this change</span>
<a href="#l6.10"></a><span id="l6.10">    */</span>
<a href="#l6.11"></a><span id="l6.11">   onLocationChange(browser, webProgress, request, locationURI, flags) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    if (webProgress.isTopLevel) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    if (webProgress &amp;&amp; webProgress.isTopLevel) {</span>
<a href="#l6.14"></a><span id="l6.14">       let tabmail = browser.ownerDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.15"></a><span id="l6.15">       let nativeTabInfo = tabmail.getTabForBrowser(browser);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">       // Now we are certain that the first page in the tab was loaded.</span>
<a href="#l6.18"></a><span id="l6.18">       this.initializingTabs.delete(nativeTabInfo);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">       // browser.innerWindowID is now set, resolve the promises if any.</span>
<a href="#l6.21"></a><span id="l6.21">       let deferred = this.tabReadyPromises.get(nativeTabInfo);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser.ini</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -22,13 +22,15 @@ tags = webextensions</span>
<a href="#l7.4"></a><span id="l7.4"> [browser_ext_commands_update.js]</span>
<a href="#l7.5"></a><span id="l7.5"> [browser_ext_compose_begin.js]</span>
<a href="#l7.6"></a><span id="l7.6"> [browser_ext_compose_details.js]</span>
<a href="#l7.7"></a><span id="l7.7"> [browser_ext_compose_onBeforeSend.js]</span>
<a href="#l7.8"></a><span id="l7.8"> [browser_ext_composeAction.js]</span>
<a href="#l7.9"></a><span id="l7.9"> [browser_ext_mailTabs.js]</span>
<a href="#l7.10"></a><span id="l7.10"> [browser_ext_menus.js]</span>
<a href="#l7.11"></a><span id="l7.11"> support-files = data/content.html</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+[browser_ext_menus_replace_menu.js]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+[browser_ext_menus_replace_menu_context.js]</span>
<a href="#l7.14"></a><span id="l7.14"> [browser_ext_messageDisplay.js]</span>
<a href="#l7.15"></a><span id="l7.15"> [browser_ext_messageDisplayAction.js]</span>
<a href="#l7.16"></a><span id="l7.16"> [browser_ext_quickFilter.js]</span>
<a href="#l7.17"></a><span id="l7.17"> [browser_ext_windows.js]</span>
<a href="#l7.18"></a><span id="l7.18"> [browser_ext_windows_types.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_menus_replace_menu.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,276 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+function getVisibleChildrenIds(menuElem) {</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+  return Array.from(menuElem.children)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    .filter(elem =&gt; !elem.hidden)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    .map(elem =&gt; elem.id || elem.tagName);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+}</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+function checkIsDefaultMenuItemVisible(visibleMenuItemIds) {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  // In this whole test file, we open a menu on a link. Assume that all</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  // default menu items are shown if one link-specific menu item is shown.</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  ok(</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+    visibleMenuItemIds.includes(&quot;mailContext-copylink&quot;),</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    `The default 'Copy Link Location' menu item should be in ${visibleMenuItemIds}.`</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  );</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+}</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+// Tests the following:</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+// - Calling overrideContext({}) during oncontextmenu forces the menu to only</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+//   show an extension's own items.</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+// - These menu items all appear in the root menu.</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+// - The usual extension filtering behavior (e.g. documentUrlPatterns and</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+//   targetUrlPatterns) is still applied; some menu items are therefore hidden.</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+// - Calling overrideContext({showDefaults:true}) causes the default menu items</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+//   to be shown, but only after the extension's.</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+// - overrideContext expires after the menu is opened once.</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+// - overrideContext can be called from shadow DOM.</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+add_task(async function overrideContext_in_extension_tab() {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  await SpecialPowers.pushPrefEnv({</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+    set: [[&quot;security.allow_eval_with_system_principal&quot;, true]],</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+  });</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  function extensionTabScript() {</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    document.addEventListener(</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      &quot;contextmenu&quot;,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+      () =&gt; {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+        browser.menus.overrideContext({});</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+        browser.test.sendMessage(&quot;oncontextmenu_in_dom_part_1&quot;);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+      },</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+      { once: true }</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    );</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    let shadowRoot = document</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      .getElementById(&quot;shadowHost&quot;)</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+      .attachShadow({ mode: &quot;open&quot; });</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    shadowRoot.innerHTML = `&lt;a href=&quot;http://example.com/&quot;&gt;Link&lt;/a&gt;`;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    shadowRoot.firstChild.addEventListener(</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+      &quot;contextmenu&quot;,</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+      () =&gt; {</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+        browser.menus.overrideContext({});</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+        browser.test.sendMessage(&quot;oncontextmenu_in_shadow_dom&quot;);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+      },</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+      { once: true }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    );</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    browser.menus.create({</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+      id: &quot;tab_1&quot;,</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+      title: &quot;tab_1&quot;,</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+      documentUrlPatterns: [document.URL],</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+      onclick() {</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+        document.addEventListener(</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+          &quot;contextmenu&quot;,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+          () =&gt; {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+            // Verifies that last call takes precedence.</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+            browser.menus.overrideContext({ showDefaults: false });</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+            browser.menus.overrideContext({ showDefaults: true });</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+            browser.test.sendMessage(&quot;oncontextmenu_in_dom_part_2&quot;);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+          },</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+          { once: true }</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+        );</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+        browser.test.sendMessage(&quot;onClicked_tab_1&quot;);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+      },</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    });</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+    browser.menus.create(</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+      {</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        id: &quot;tab_2&quot;,</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+        title: &quot;tab_2&quot;,</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+        onclick() {</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+          browser.test.sendMessage(&quot;onClicked_tab_2&quot;);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+        },</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+      },</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+      () =&gt; {</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+        browser.test.sendMessage(&quot;menu-registered&quot;);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+      }</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+    );</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  }</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension({</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    manifest: {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+      permissions: [&quot;menus&quot;, &quot;menus.overrideContext&quot;],</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    },</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+    files: {</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+      &quot;tab.html&quot;: `</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+        &lt;!DOCTYPE html&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+        &lt;a href=&quot;http://example.com/&quot;&gt;Link&lt;/a&gt;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+        &lt;div id=&quot;shadowHost&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+        &lt;script src=&quot;tab.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+      `,</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+      &quot;tab.js&quot;: extensionTabScript,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+    },</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+    background() {</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+      // Expected to match and thus be visible.</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+      browser.menus.create({ id: &quot;bg_1&quot;, title: &quot;bg_1&quot; });</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+      browser.menus.create({</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+        id: &quot;bg_2&quot;,</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+        title: &quot;bg_2&quot;,</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+        targetUrlPatterns: [&quot;*://example.com/*&quot;],</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+      });</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+      // Expected to not match and be hidden.</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      browser.menus.create({</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+        id: &quot;bg_3&quot;,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+        title: &quot;bg_3&quot;,</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+        targetUrlPatterns: [&quot;*://nomatch/*&quot;],</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+      });</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+      browser.menus.create({</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+        id: &quot;bg_4&quot;,</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+        title: &quot;bg_4&quot;,</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+        documentUrlPatterns: [document.URL],</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+      });</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+      browser.menus.onShown.addListener(info =&gt; {</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+        browser.test.assertEq(&quot;tab&quot;, info.viewType, &quot;Expected viewType&quot;);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+        browser.test.assertEq(</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+          &quot;bg_1,bg_2,tab_1,tab_2&quot;,</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+          info.menuIds.join(&quot;,&quot;),</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+          &quot;Expected menu items.&quot;</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+        );</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+        browser.test.assertEq(</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+          &quot;all,link&quot;,</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+          info.contexts.sort().join(&quot;,&quot;),</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+          &quot;Expected menu contexts&quot;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+        );</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+        browser.test.sendMessage(&quot;onShown&quot;);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+      });</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+      browser.tabs.create({ url: &quot;tab.html&quot; });</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+    },</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+  });</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+  let otherExtension = ExtensionTestUtils.loadExtension({</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+    manifest: {</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+      permissions: [&quot;menus&quot;],</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    },</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+    background() {</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+      browser.menus.create(</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+        { id: &quot;other_extension_item&quot;, title: &quot;other_extension_item&quot; },</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+        () =&gt; {</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+          browser.test.sendMessage(&quot;other_extension_item_created&quot;);</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+        }</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+      );</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+    },</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  });</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  await otherExtension.startup();</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  await otherExtension.awaitMessage(&quot;other_extension_item_created&quot;);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+  await extension.startup();</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+  await extension.awaitMessage(&quot;menu-registered&quot;);</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+  const EXPECTED_EXTENSION_MENU_IDS = [</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    `${makeWidgetId(extension.id)}-menuitem-_bg_1`,</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+    `${makeWidgetId(extension.id)}-menuitem-_bg_2`,</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    `${makeWidgetId(extension.id)}-menuitem-_tab_1`,</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+    `${makeWidgetId(extension.id)}-menuitem-_tab_2`,</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+  ];</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+  const OTHER_EXTENSION_MENU_ID = `${makeWidgetId(</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    otherExtension.id</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  )}-menuitem-_other_extension_item`;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+  {</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    // Tests overrideContext({})</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+    info(&quot;Expecting the menu to be replaced by overrideContext.&quot;);</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+    let menu = await openContextMenu(&quot;a&quot;);</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+    await extension.awaitMessage(&quot;oncontextmenu_in_dom_part_1&quot;);</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+    await extension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+      getVisibleChildrenIds(menu),</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+      EXPECTED_EXTENSION_MENU_IDS,</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+      &quot;Expected only extension menu items&quot;</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+    );</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+    let menuItems = menu.getElementsByAttribute(&quot;label&quot;, &quot;tab_1&quot;);</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+    await closeExtensionContextMenu(menuItems[0]);</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+    await extension.awaitMessage(&quot;onClicked_tab_1&quot;);</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+  }</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineplus">+</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+  {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+    // Tests overrideContext({showDefaults:true}))</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+    info(</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+      &quot;Expecting the menu to be replaced by overrideContext, including default menu items.&quot;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+    );</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+    let menu = await openContextMenu(&quot;a&quot;);</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+    await extension.awaitMessage(&quot;oncontextmenu_in_dom_part_2&quot;);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+    await extension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+    let visibleMenuItemIds = getVisibleChildrenIds(menu);</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineplus">+      visibleMenuItemIds.slice(0, EXPECTED_EXTENSION_MENU_IDS.length),</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+      EXPECTED_EXTENSION_MENU_IDS,</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+      &quot;Expected extension menu items at the start.&quot;</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+    );</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+    checkIsDefaultMenuItemVisible(visibleMenuItemIds);</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+    is(</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+      visibleMenuItemIds[visibleMenuItemIds.length - 1],</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+      OTHER_EXTENSION_MENU_ID,</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+      &quot;Other extension menu item should be at the end.&quot;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+    );</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+    let menuItems = menu.getElementsByAttribute(&quot;label&quot;, &quot;tab_2&quot;);</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+    await closeExtensionContextMenu(menuItems[0]);</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    await extension.awaitMessage(&quot;onClicked_tab_2&quot;);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineplus">+  }</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+  {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+    // Tests that previous overrideContext call has been forgotten,</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+    // so the default behavior should occur (=move items into submenu).</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+    info(</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+      &quot;Expecting the default menu to be used when overrideContext is not called.&quot;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+    );</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+    let menu = await openContextMenu(&quot;a&quot;);</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+    await extension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+    checkIsDefaultMenuItemVisible(getVisibleChildrenIds(menu));</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+    let menuItems = menu.getElementsByAttribute(&quot;ext-type&quot;, &quot;top-level-menu&quot;);</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+    is(menuItems.length, 1, &quot;Expected top-level menu element for extension.&quot;);</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+    let topLevelExtensionMenuItem = menuItems[0];</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+    is(</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+      topLevelExtensionMenuItem.nextSibling,</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+      null,</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+      &quot;Extension menu should be the last element.&quot;</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    );</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+    const submenu = await openSubmenu(topLevelExtensionMenuItem);</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+    is(submenu, topLevelExtensionMenuItem.menupopup, &quot;Correct submenu opened&quot;);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineplus">+</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+      getVisibleChildrenIds(submenu),</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      EXPECTED_EXTENSION_MENU_IDS,</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+      &quot;Extension menu items should be in the submenu by default.&quot;</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+    );</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineplus">+</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineplus">+    await closeContextMenu();</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+  }</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+  {</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+    info(&quot;the other thing&quot;);</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+    // Tests that overrideContext({}) can be used from a listener inside shadow DOM.</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+    let menu = await openContextMenu(</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+      () =&gt; this.document.getElementById(&quot;shadowHost&quot;).shadowRoot.firstChild</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+    );</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    await extension.awaitMessage(&quot;oncontextmenu_in_shadow_dom&quot;);</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+    await extension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+      getVisibleChildrenIds(menu),</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+      EXPECTED_EXTENSION_MENU_IDS,</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+      &quot;Expected only extension menu items after overrideContext({}) in shadow DOM&quot;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+    );</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+    await closeContextMenu();</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+  }</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  // Unloading the extension will automatically close the extension's tab.html</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+  await extension.unload();</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+  await otherExtension.unload();</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+  tabmail.closeTab(tabmail.currentTabInfo);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/components/extensions/test/browser/browser_ext_menus_replace_menu_context.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,374 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+function getVisibleChildrenIds(menuElem) {</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+  return Array.from(menuElem.children)</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+    .filter(elem =&gt; !elem.hidden)</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    .map(elem =&gt; elem.id || elem.tagName);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+}</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+function checkIsDefaultMenuItemVisible(visibleMenuItemIds) {</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  // In this whole test file, we open a menu on a link. Assume that all</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  // default menu items are shown if one link-specific menu item is shown.</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+  ok(</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    visibleMenuItemIds.includes(&quot;mailContext-copylink&quot;),</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    `The default 'Copy Link Location' menu item should be in ${visibleMenuItemIds}.`</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  );</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+}</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+// Tests that the context of an extension menu can be changed to:</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+// - tab</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+add_task(async function overrideContext_with_context() {</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+  // Background script of the main test extension and the auxilary other extension.</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  function background() {</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    const HTTP_URL = &quot;http://example.com/?SomeTab&quot;;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    browser.test.onMessage.addListener(async (msg, tabId) =&gt; {</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+        &quot;testTabAccess&quot;,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+        msg,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+        `Expected message in ${browser.runtime.id}`</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+      );</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      let tab = await browser.tabs.get(tabId);</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+      if (!tab.url) {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+        // tabs or activeTab not active.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+        browser.test.sendMessage(&quot;testTabAccessDone&quot;, &quot;tab_no_url&quot;);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+        return;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      }</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+      try {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+        let [url] = await browser.tabs.executeScript(tabId, {</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+          code: &quot;document.URL&quot;,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+        });</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+        browser.test.assertEq(</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+          HTTP_URL,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+          url,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+          &quot;Expected successful executeScript&quot;</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+        );</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+        browser.test.sendMessage(&quot;testTabAccessDone&quot;, &quot;executeScript_ok&quot;);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+        return;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      } catch (e) {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+        browser.test.assertEq(</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+          &quot;Missing host permission for the tab&quot;,</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+          e.message,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+          &quot;Expected error message&quot;</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+        );</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+        browser.test.sendMessage(&quot;testTabAccessDone&quot;, &quot;executeScript_failed&quot;);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      }</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    });</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    browser.menus.onShown.addListener((info, tab) =&gt; {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+        &quot;tab&quot;,</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+        info.viewType,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+        &quot;Expected viewType at onShown&quot;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      );</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+        undefined,</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+        info.linkUrl,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+        &quot;Expected linkUrl at onShown&quot;</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+      );</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+        undefined,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+        info.srckUrl,</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+        &quot;Expected srcUrl at onShown&quot;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+      );</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+      browser.test.sendMessage(&quot;onShown&quot;, {</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+        menuIds: info.menuIds.sort(),</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+        contexts: info.contexts,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+        bookmarkId: info.bookmarkId,</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+        pageUrl: info.pageUrl,</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+        frameUrl: info.frameUrl,</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+        tabId: tab &amp;&amp; tab.id,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+      });</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+    });</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+    browser.menus.onClicked.addListener((info, tab) =&gt; {</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+        &quot;tab&quot;,</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+        info.viewType,</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+        &quot;Expected viewType at onClicked&quot;</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+      );</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+        undefined,</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+        info.linkUrl,</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+        &quot;Expected linkUrl at onClicked&quot;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+      );</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+      browser.test.assertEq(</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+        undefined,</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+        info.srckUrl,</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+        &quot;Expected srcUrl at onClicked&quot;</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+      );</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+      browser.test.sendMessage(&quot;onClicked&quot;, {</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+        menuItemId: info.menuItemId,</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+        bookmarkId: info.bookmarkId,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+        pageUrl: info.pageUrl,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+        frameUrl: info.frameUrl,</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+        tabId: tab &amp;&amp; tab.id,</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+      });</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+    });</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    // Minimal properties to define menu items for a specific context.</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+    browser.menus.create({</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+      id: &quot;tab_context&quot;,</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+      title: &quot;tab_context&quot;,</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+      contexts: [&quot;tab&quot;],</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    });</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+    // documentUrlPatterns in the tab context applies to the tab's URL.</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+    browser.menus.create({</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+      id: &quot;tab_context_http&quot;,</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+      title: &quot;tab_context_http&quot;,</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+      contexts: [&quot;tab&quot;],</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+      documentUrlPatterns: [HTTP_URL],</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    });</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+    browser.menus.create({</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+      id: &quot;tab_context_moz_unexpected&quot;,</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+      title: &quot;tab_context_moz&quot;,</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+      contexts: [&quot;tab&quot;],</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+      documentUrlPatterns: [&quot;moz-extension://*/tab.html&quot;],</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    });</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    // When viewTypes is present, the document's URL is matched instead.</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+    browser.menus.create({</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+      id: &quot;tab_context_viewType_http_unexpected&quot;,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+      title: &quot;tab_context_viewType_http&quot;,</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+      contexts: [&quot;tab&quot;],</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+      viewTypes: [&quot;tab&quot;],</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+      documentUrlPatterns: [HTTP_URL],</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+    });</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+    browser.menus.create({</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+      id: &quot;tab_context_viewType_moz&quot;,</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+      title: &quot;tab_context_viewType_moz&quot;,</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+      contexts: [&quot;tab&quot;],</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+      viewTypes: [&quot;tab&quot;],</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+      documentUrlPatterns: [&quot;moz-extension://*/tab.html&quot;],</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+    });</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+    browser.menus.create({ id: &quot;link_context&quot;, title: &quot;link_context&quot; }, () =&gt; {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+      browser.test.sendMessage(&quot;menu_items_registered&quot;);</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+    });</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+    if (browser.runtime.id === &quot;@menu-test-extension&quot;) {</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+      browser.tabs.create({ url: &quot;tab.html&quot; });</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+    }</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+  }</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+  let extension = ExtensionTestUtils.loadExtension({</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+    manifest: {</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+      applications: { gecko: { id: &quot;@menu-test-extension&quot; } },</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+      permissions: [&quot;menus&quot;, &quot;menus.overrideContext&quot;, &quot;tabs&quot;],</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+    },</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    files: {</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+      &quot;tab.html&quot;: `</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+        &lt;!DOCTYPE html&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+        &lt;a href=&quot;http://example.com/&quot;&gt;Link&lt;/a&gt;</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+        &lt;script src=&quot;tab.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+      `,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+      &quot;tab.js&quot;: async () =&gt; {</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+        let [tab] = await browser.tabs.query({</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+          url: &quot;http://example.com/?SomeTab&quot;,</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+        });</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+        let testCases = [</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+          {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+            context: &quot;tab&quot;,</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+            tabId: tab.id,</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+          },</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+          {</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+            context: &quot;tab&quot;,</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+            tabId: tab.id,</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+          },</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+          {</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+            context: &quot;tab&quot;,</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+            tabId: 123456789, // Some invalid tabId.</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+          },</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+        ];</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+        // eslint-disable-next-line mozilla/balanced-listeners</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+        document.addEventListener(&quot;contextmenu&quot;, () =&gt; {</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+          browser.menus.overrideContext(testCases.shift());</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+          setTimeout(() =&gt; browser.test.sendMessage(&quot;oncontextmenu_in_dom&quot;));</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+        });</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+        browser.test.sendMessage(&quot;setup_ready&quot;, {</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+          tabId: tab.id,</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+          httpUrl: tab.url,</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+          extensionUrl: document.URL,</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+        });</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+      },</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+    },</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+    background,</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+  });</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  window.openContentTab(&quot;http://example.com/?SomeTab&quot;);</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+  let otherExtension = ExtensionTestUtils.loadExtension({</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+    manifest: {</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+      applications: { gecko: { id: &quot;@other-test-extension&quot; } },</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+      permissions: [&quot;menus&quot;, &quot;activeTab&quot;],</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+    },</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+    background,</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+  });</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+  await otherExtension.startup();</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+  await otherExtension.awaitMessage(&quot;menu_items_registered&quot;);</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+  await extension.startup();</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+  await extension.awaitMessage(&quot;menu_items_registered&quot;);</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+  let { tabId, httpUrl, extensionUrl } = await extension.awaitMessage(</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+    &quot;setup_ready&quot;</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  );</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+  info(`Set up test with tabId=${tabId}.`);</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+  {</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+    // Test case 1: context=tab</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+    let menu = await openContextMenu(&quot;a&quot;);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+    await extension.awaitMessage(&quot;oncontextmenu_in_dom&quot;);</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+    for (let ext of [extension, otherExtension]) {</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+      info(`Testing menu from ${ext.id} after changing context to tab`);</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+      Assert.deepEqual(</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+        await ext.awaitMessage(&quot;onShown&quot;),</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+        {</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+          menuIds: [</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+            &quot;tab_context&quot;,</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+            &quot;tab_context_http&quot;,</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+            &quot;tab_context_viewType_moz&quot;,</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+          ],</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+          contexts: [&quot;tab&quot;],</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+          bookmarkId: undefined,</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+          pageUrl: undefined, // because extension has no host permissions.</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+          frameUrl: extensionUrl,</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+          tabId,</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+        },</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+        &quot;Expected onShown details after changing context to tab&quot;</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+      );</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+    }</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+    let topLevels = menu.getElementsByAttribute(&quot;ext-type&quot;, &quot;top-level-menu&quot;);</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+    is(topLevels.length, 1, &quot;Expected top-level menu for otherExtension&quot;);</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+      getVisibleChildrenIds(menu),</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+      [</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+        `${makeWidgetId(extension.id)}-menuitem-_tab_context`,</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+        `${makeWidgetId(extension.id)}-menuitem-_tab_context_http`,</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+        `${makeWidgetId(extension.id)}-menuitem-_tab_context_viewType_moz`,</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+        `menuseparator`,</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+        topLevels[0].id,</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+      ],</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+      &quot;Expected menu items after changing context to tab&quot;</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+    );</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+    let submenu = await openSubmenu(topLevels[0]);</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+    is(submenu, topLevels[0].menupopup, &quot;Correct submenu opened&quot;);</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+      getVisibleChildrenIds(submenu),</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+      [</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+        `${makeWidgetId(otherExtension.id)}-menuitem-_tab_context`,</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+        `${makeWidgetId(otherExtension.id)}-menuitem-_tab_context_http`,</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+        `${makeWidgetId(otherExtension.id)}-menuitem-_tab_context_viewType_moz`,</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+      ],</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+      &quot;Expected menu items in submenu after changing context to tab&quot;</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+    );</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+    extension.sendMessage(&quot;testTabAccess&quot;, tabId);</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+    is(</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+      await extension.awaitMessage(&quot;testTabAccessDone&quot;),</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+      &quot;executeScript_failed&quot;,</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+      &quot;executeScript should fail due to the lack of permissions.&quot;</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+    );</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+    otherExtension.sendMessage(&quot;testTabAccess&quot;, tabId);</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+    is(</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+      await otherExtension.awaitMessage(&quot;testTabAccessDone&quot;),</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+      &quot;tab_no_url&quot;,</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+      &quot;Other extension should not have activeTab permissions yet.&quot;</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+    );</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+    // Click on the menu item of the other extension to unlock host permissions.</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+    let menuItems = menu.getElementsByAttribute(&quot;label&quot;, &quot;tab_context&quot;);</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+    is(</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+      menuItems.length,</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+      2,</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineplus">+      &quot;There are two menu items with label 'tab_context'&quot;</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+    );</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+    await closeExtensionContextMenu(menuItems[1]);</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+      await otherExtension.awaitMessage(&quot;onClicked&quot;),</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineplus">+      {</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+        menuItemId: &quot;tab_context&quot;,</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+        bookmarkId: undefined,</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+        pageUrl: httpUrl,</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+        frameUrl: extensionUrl,</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+        tabId,</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+      },</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+      &quot;Expected onClicked details after changing context to tab&quot;</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+    );</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+    extension.sendMessage(&quot;testTabAccess&quot;, tabId);</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineplus">+    is(</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+      await extension.awaitMessage(&quot;testTabAccessDone&quot;),</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+      &quot;executeScript_failed&quot;,</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineplus">+      &quot;executeScript of extension that created the menu should still fail.&quot;</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+    );</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+    otherExtension.sendMessage(&quot;testTabAccess&quot;, tabId);</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+    is(</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+      await otherExtension.awaitMessage(&quot;testTabAccessDone&quot;),</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+      &quot;executeScript_ok&quot;,</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+      &quot;Other extension should have activeTab permissions.&quot;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+    );</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+  }</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineplus">+</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+  {</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+    // Test case 2: context=tab, click on menu item of extension..</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+    let menu = await openContextMenu(&quot;a&quot;);</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+    await extension.awaitMessage(&quot;oncontextmenu_in_dom&quot;);</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+    // The previous test has already verified the visible menu items,</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+    // so we skip checking the onShown result and only test clicking.</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+    await extension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+    await otherExtension.awaitMessage(&quot;onShown&quot;);</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+    let menuItems = menu.getElementsByAttribute(&quot;label&quot;, &quot;tab_context&quot;);</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+    is(</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+      menuItems.length,</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+      2,</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+      &quot;There are two menu items with label 'tab_context'&quot;</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+    );</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineplus">+    await closeExtensionContextMenu(menuItems[0]);</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineplus">+</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+    Assert.deepEqual(</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+      await extension.awaitMessage(&quot;onClicked&quot;),</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+      {</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+        menuItemId: &quot;tab_context&quot;,</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+        bookmarkId: undefined,</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+        pageUrl: httpUrl,</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+        frameUrl: extensionUrl,</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+        tabId,</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+      },</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+      &quot;Expected onClicked details after changing context to tab&quot;</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+    );</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+    extension.sendMessage(&quot;testTabAccess&quot;, tabId);</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+    is(</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+      await extension.awaitMessage(&quot;testTabAccessDone&quot;),</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+      &quot;executeScript_failed&quot;,</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+      &quot;activeTab permission should not be available to the extension that created the menu.&quot;</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+    );</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+  }</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+  {</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+    // Test case 4: context=tab, invalid tabId.</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+    let menu = await openContextMenu(&quot;a&quot;);</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+    await extension.awaitMessage(&quot;oncontextmenu_in_dom&quot;);</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+    // When an invalid tabId is used, all extension menu logic is skipped and</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+    // the default menu is shown.</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+    checkIsDefaultMenuItemVisible(getVisibleChildrenIds(menu));</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+    await closeContextMenu(menu);</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+  }</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  await extension.unload();</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+  await otherExtension.unload();</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+  tabmail.closeTab(tabmail.currentTabInfo);</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+  tabmail.closeTab(tabmail.currentTabInfo);</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/extensions/test/browser/head.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/extensions/test/browser/head.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -14,16 +14,25 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l10.4"></a><span id="l10.4"> //       should use &quot;expectUncaughtRejection&quot; to flag individual failures.</span>
<a href="#l10.5"></a><span id="l10.5"> const { PromiseTestUtils } = ChromeUtils.import(</span>
<a href="#l10.6"></a><span id="l10.6">   &quot;resource://testing-common/PromiseTestUtils.jsm&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> );</span>
<a href="#l10.8"></a><span id="l10.8"> PromiseTestUtils.whitelistRejectionsGlobally(/Message manager disconnected/);</span>
<a href="#l10.9"></a><span id="l10.9"> PromiseTestUtils.whitelistRejectionsGlobally(/No matching message handler/);</span>
<a href="#l10.10"></a><span id="l10.10"> PromiseTestUtils.whitelistRejectionsGlobally(/Receiving end does not exist/);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+registerCleanupFunction(() =&gt; {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  is(tabmail.tabInfo.length, 1);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+  while (tabmail.tabInfo.length &gt; 1) {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    tabmail.closeTab(tabmail.tabInfo[1]);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  }</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+});</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+</span>
<a href="#l10.21"></a><span id="l10.21"> function createAccount() {</span>
<a href="#l10.22"></a><span id="l10.22">   registerCleanupFunction(() =&gt; {</span>
<a href="#l10.23"></a><span id="l10.23">     [...MailServices.accounts.accounts.enumerate()].forEach(cleanUpAccount);</span>
<a href="#l10.24"></a><span id="l10.24">   });</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   MailServices.accounts.createLocalMailAccount();</span>
<a href="#l10.27"></a><span id="l10.27">   let account = MailServices.accounts.accounts.enumerate().getNext();</span>
<a href="#l10.28"></a><span id="l10.28">   info(`Created account ${account.toString()}`);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineat">@@ -218,8 +227,65 @@ async function checkComposeHeaders(expec</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">   let subject = composeDocument.getElementById(&quot;msgSubject&quot;).value;</span>
<a href="#l10.32"></a><span id="l10.32">   if (&quot;subject&quot; in expected) {</span>
<a href="#l10.33"></a><span id="l10.33">     is(subject, expected.subject, &quot;subject is correct&quot;);</span>
<a href="#l10.34"></a><span id="l10.34">   } else {</span>
<a href="#l10.35"></a><span id="l10.35">     is(subject, &quot;&quot;, &quot;subject is empty&quot;);</span>
<a href="#l10.36"></a><span id="l10.36">   }</span>
<a href="#l10.37"></a><span id="l10.37"> }</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+async function openContextMenu(selector = &quot;#img1&quot;, win = window) {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  let contentAreaContextMenu = win.document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  let popupShownPromise = BrowserTestUtils.waitForEvent(</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    contentAreaContextMenu,</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+    &quot;popupshown&quot;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  );</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  await BrowserTestUtils.synthesizeMouseAtCenter(</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+    selector,</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+    { type: &quot;mousedown&quot;, button: 2 },</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    tabmail.selectedBrowser</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  );</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  await BrowserTestUtils.synthesizeMouseAtCenter(</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    selector,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    { type: &quot;contextmenu&quot; },</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+    tabmail.selectedBrowser</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  );</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  await popupShownPromise;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  return contentAreaContextMenu;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+}</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+async function closeExtensionContextMenu(itemToSelect, modifiers = {}) {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  let contentAreaContextMenu = document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  let popupHiddenPromise = BrowserTestUtils.waitForEvent(</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    contentAreaContextMenu,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    &quot;popuphidden&quot;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  );</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  if (itemToSelect) {</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(itemToSelect, modifiers);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+  } else {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+    contentAreaContextMenu.hidePopup();</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+  }</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+  await popupHiddenPromise;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+  // Bug 1351638: parent menu fails to close intermittently, make sure it does.</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  contentAreaContextMenu.hidePopup();</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+}</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+async function openSubmenu(submenuItem, win = window) {</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  const submenu = submenuItem.menupopup;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  const shown = BrowserTestUtils.waitForEvent(submenu, &quot;popupshown&quot;);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(submenuItem, {}, win);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  await shown;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+  return submenu;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+}</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+async function closeContextMenu(contextMenu) {</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  let contentAreaContextMenu =</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+    contextMenu || document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  let popupHiddenPromise = BrowserTestUtils.waitForEvent(</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    contentAreaContextMenu,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    &quot;popuphidden&quot;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  );</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  contentAreaContextMenu.hidePopup();</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  await popupHiddenPromise;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

