<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26581:6bd11ad2949dc7454e6b98f9613064621ee319f3</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6bd11ad2949dc7454e6b98f9613064621ee319f3" />
<meta property="og:url" content="/comm-central/rev/6bd11ad2949dc7454e6b98f9613064621ee319f3" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/compose (part 2). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6bd11ad2949dc7454e6b98f9613064621ee319f3 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6bd11ad2949dc7454e6b98f9613064621ee319f3">shortlog</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6bd11ad2949dc7454e6b98f9613064621ee319f3">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3">files</a> |
changeset |
<a href="/comm-central/raw-rev/6bd11ad2949dc7454e6b98f9613064621ee319f3">raw</a>  | <a href="/comm-central/archive/6bd11ad2949dc7454e6b98f9613064621ee319f3.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/compose (part 2). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 11 May 2019 21:27:39 +0200</td></tr>

<tr>
 <td>changeset 26581</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6bd11ad2949dc7454e6b98f9613064621ee319f3">6bd11ad2949dc7454e6b98f9613064621ee319f3</a></td>
</tr>



<tr>
<td>parent 26580</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/28c5478ca164a254392f3f7db745758739b1a549">28c5478ca164a254392f3f7db745758739b1a549</a>
</td>
</tr>

<tr>
<td>child 26582</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9606c2de08183a9f9dcb6fba20528f6c963c101e">9606c2de08183a9f9dcb6fba20528f6c963c101e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6bd11ad2949dc7454e6b98f9613064621ee319f3">15900</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 11 May 2019 22:20:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6bd11ad2949d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6bd11ad2949dc7454e6b98f9613064621ee319f3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6bd11ad2949dc7454e6b98f9613064621ee319f3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6bd11ad2949dc7454e6b98f9613064621ee319f3&newProject=comm-central&newRevision=ee74021d18f556f854ad5366b5a2a435e3a02ae0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6bd11ad2949dc7454e6b98f9613064621ee319f3&newProject=comm-central&newRevision=ee74021d18f556f854ad5366b5a2a435e3a02ae0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6bd11ad2949dc7454e6b98f9613064621ee319f3&newProject=comm-central&newRevision=ee74021d18f556f854ad5366b5a2a435e3a02ae0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/compose (part 2). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.h">mailnews/compose/src/nsSmtpServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.h">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.h">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.h">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.h">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.h">mailnews/compose/src/nsSmtpService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.h">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.h">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.h">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.h">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.cpp">mailnews/compose/src/nsSmtpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.cpp">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.cpp">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.h">mailnews/compose/src/nsSmtpUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.h">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.h">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.h">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.h">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsSmtpUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.h">mailnews/compose/src/nsURLFetcher.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.h">file</a> |
<a href="/comm-central/annotate/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.h">annotate</a> |
<a href="/comm-central/diff/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.h">diff</a> |
<a href="/comm-central/comparison/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.h">comparison</a> |
<a href="/comm-central/log/6bd11ad2949dc7454e6b98f9613064621ee319f3/mailnews/compose/src/nsURLFetcher.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,80 +32,78 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#include &quot;MailNewsTypes2.h&quot; // for nsMsgSocketType and nsMsgAuthMethod</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#include &quot;MailNewsTypes2.h&quot;  // for nsMsgSocketType and nsMsgAuthMethod</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsIIDNService.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsICancelable.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l1.19"></a><span id="l1.19"> #include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> #include &quot;nsINetAddr.h&quot;</span>
<a href="#l1.21"></a><span id="l1.21"> #include &quot;nsIProxyInfo.h&quot;</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> #ifndef XP_UNIX</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-#include &lt;stdarg.h&gt;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+#  include &lt;stdarg.h&gt;</span>
<a href="#l1.26"></a><span id="l1.26"> #endif /* !XP_UNIX */</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-#undef PostMessage // avoid to collision with WinUser.h</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+#undef PostMessage  // avoid to collision with WinUser.h</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31"> static mozilla::LazyLogModule SMTPLogModule(&quot;SMTP&quot;);</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> using namespace mozilla::mailnews;</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> /* the output_buffer_size must be larger than the largest possible line</span>
<a href="#l1.36"></a><span id="l1.36">  * 2000 seems good for news</span>
<a href="#l1.37"></a><span id="l1.37">  *</span>
<a href="#l1.38"></a><span id="l1.38">  * jwz: I increased this to 4k since it must be big enough to hold the</span>
<a href="#l1.39"></a><span id="l1.39">  * entire button-bar HTML, and with the new &quot;mailto&quot; format, that can</span>
<a href="#l1.40"></a><span id="l1.40">  * contain arbitrarily long header fields like &quot;references&quot;.</span>
<a href="#l1.41"></a><span id="l1.41">  *</span>
<a href="#l1.42"></a><span id="l1.42">  * fortezza: proxy auth is huge, buffer increased to 8k (sigh).</span>
<a href="#l1.43"></a><span id="l1.43">  */</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-#define OUTPUT_BUFFER_SIZE (4096*2)</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+#define OUTPUT_BUFFER_SIZE (4096 * 2)</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.48"></a><span id="l1.48"> // TEMPORARY HARD CODED FUNCTIONS</span>
<a href="#l1.49"></a><span id="l1.49"> ///////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51"> /* based on in NET_ExplainErrorDetails in mkmessag.c */</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-nsresult nsExplainErrorDetails(nsISmtpUrl * aSmtpUrl, nsresult aCode,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-                               const char* arg1, const char* arg2)</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-{</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+nsresult nsExplainErrorDetails(nsISmtpUrl *aSmtpUrl, nsresult aCode,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                               const char *arg1, const char *arg2) {</span>
<a href="#l1.57"></a><span id="l1.57">   NS_ENSURE_ARG(aSmtpUrl);</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l1.60"></a><span id="l1.60">   aSmtpUrl-&gt;GetPrompt(getter_AddRefs(dialog));</span>
<a href="#l1.61"></a><span id="l1.61">   NS_ENSURE_TRUE(dialog, NS_ERROR_FAILURE);</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">   nsString msg;</span>
<a href="#l1.64"></a><span id="l1.64">   nsString eMsg;</span>
<a href="#l1.65"></a><span id="l1.65">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l1.68"></a><span id="l1.68">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.69"></a><span id="l1.69">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l1.70"></a><span id="l1.70">   nsresult rv = bundleService-&gt;CreateBundle(</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-    &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    getter_AddRefs(bundle));</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l1.75"></a><span id="l1.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.76"></a><span id="l1.76"> </span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  const char* exitString;</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+  const char *exitString;</span>
<a href="#l1.79"></a><span id="l1.79"> #ifdef __GNUC__</span>
<a href="#l1.80"></a><span id="l1.80"> // Temporary workaround until bug 783526 is fixed.</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-#pragma GCC diagnostic push</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-#pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+#  pragma GCC diagnostic push</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+#  pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l1.85"></a><span id="l1.85"> #endif</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-  switch (aCode)</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-  {</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+  switch (aCode) {</span>
<a href="#l1.89"></a><span id="l1.89">     case NS_ERROR_ILLEGAL_LOCALPART:</span>
<a href="#l1.90"></a><span id="l1.90">       bundle-&gt;GetStringFromName(&quot;errorIllegalLocalPart&quot;, eMsg);</span>
<a href="#l1.91"></a><span id="l1.91">       nsTextFormatter::ssprintf(msg, eMsg.get(), arg1, arg2);</span>
<a href="#l1.92"></a><span id="l1.92">       break;</span>
<a href="#l1.93"></a><span id="l1.93">     case NS_ERROR_SMTP_SERVER_ERROR:</span>
<a href="#l1.94"></a><span id="l1.94">     case NS_ERROR_SMTP_SEND_NOT_ALLOWED:</span>
<a href="#l1.95"></a><span id="l1.95">     case NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED:</span>
<a href="#l1.96"></a><span id="l1.96">     case NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_1:</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineat">@@ -131,502 +129,463 @@ nsresult nsExplainErrorDetails(nsISmtpUr</span>
<a href="#l1.98"></a><span id="l1.98">       break;</span>
<a href="#l1.99"></a><span id="l1.99">     default:</span>
<a href="#l1.100"></a><span id="l1.100">       NS_WARNING(&quot;falling to default error code&quot;);</span>
<a href="#l1.101"></a><span id="l1.101">       bundle-&gt;GetStringFromName(&quot;communicationsError&quot;, eMsg);</span>
<a href="#l1.102"></a><span id="l1.102">       nsTextFormatter::ssprintf(msg, eMsg.get(), static_cast&lt;uint32_t&gt;(aCode));</span>
<a href="#l1.103"></a><span id="l1.103">       break;</span>
<a href="#l1.104"></a><span id="l1.104">   }</span>
<a href="#l1.105"></a><span id="l1.105"> #ifdef __GNUC__</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-#pragma GCC diagnostic pop</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+#  pragma GCC diagnostic pop</span>
<a href="#l1.108"></a><span id="l1.108"> #endif</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110">   rv = dialog-&gt;Alert(nullptr, msg.get());</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">   return rv;</span>
<a href="#l1.113"></a><span id="l1.113"> }</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115"> /* RFC 1891 -- extended smtp value encoding scheme</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">   5. Additional parameters for RCPT and MAIL commands</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-     The extended RCPT and MAIL commands are issued by a client when it wishes to request a DSN from the</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-     server, under certain conditions, for a particular recipient. The extended RCPT and MAIL commands are</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-     identical to the RCPT and MAIL commands defined in [1], except that one or more of the following parameters</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-     appear after the sender or recipient address, respectively. The general syntax for extended SMTP commands is</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-     defined in [4].</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+  The extended RCPT and MAIL commands are issued by a client when it wishes</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+  to request a DSN from the server, under certain conditions, for a particular</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  recipient. The extended RCPT and MAIL commands are identical to the RCPT and</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+  MAIL commands defined in [1], except that one or more of the following</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+  parameters appear after the sender or recipient address, respectively. The</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  general syntax for extended SMTP commands is defined in [4].</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-     NOTE: Although RFC 822 ABNF is used to describe the syntax of these parameters, they are not, in the</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-     language of that document, &quot;structured field bodies&quot;. Therefore, while parentheses MAY appear within an</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-     emstp-value, they are not recognized as comment delimiters.</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-     The syntax for &quot;esmtp-value&quot; in [4] does not allow SP, &quot;=&quot;, control characters, or characters outside the</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-     traditional ASCII range of 1- 127 decimal to be transmitted in an esmtp-value. Because the ENVID and</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-     ORCPT parameters may need to convey values outside this range, the esmtp-values for these parameters are</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-     encoded as &quot;xtext&quot;. &quot;xtext&quot; is formally defined as follows:</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  NOTE: Although RFC 822 ABNF is used to describe the syntax of these</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+  parameters, they are not, in the language of that document, &quot;structured field</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+  bodies&quot;. Therefore, while parentheses MAY appear within an emstp-value, they</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  are not recognized as comment delimiters.</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-     xtext = *( xchar / hexchar )</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-     xchar = any ASCII CHAR between &quot;!&quot; (33) and &quot;~&quot; (126) inclusive, except for &quot;+&quot; and &quot;=&quot;.</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  The syntax for &quot;esmtp-value&quot; in [4] does not allow SP, &quot;=&quot;, control</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  characters, or characters outside the traditional ASCII range of 1- 127</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+  decimal to be transmitted in an esmtp-value. Because the ENVID and ORCPT</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  parameters may need to convey values outside this range, the esmtp-values for</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+  these parameters are encoded as &quot;xtext&quot;. &quot;xtext&quot; is formally defined as</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+  follows:</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-    ; &quot;hexchar&quot;s are intended to encode octets that cannot appear</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-    ; as ASCII characters within an esmtp-value.</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+  xtext = *( xchar / hexchar )</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-         hexchar = ASCII &quot;+&quot; immediately followed by two upper case hexadecimal digits</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  xchar = any ASCII CHAR between &quot;!&quot; (33) and &quot;~&quot; (126) inclusive, except for</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+          &quot;+&quot; and &quot;=&quot;.</span>
<a href="#l1.161"></a><span id="l1.161"> </span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-    When encoding an octet sequence as xtext:</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  ; &quot;hexchar&quot;s are intended to encode octets that cannot appear</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+  ; as ASCII characters within an esmtp-value.</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+  hexchar = ASCII &quot;+&quot; immediately followed by two upper case hexadecimal digits</span>
<a href="#l1.167"></a><span id="l1.167"> </span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-    + Any ASCII CHAR between &quot;!&quot; and &quot;~&quot; inclusive, except for &quot;+&quot; and &quot;=&quot;,</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-         MAY be encoded as itself. (A CHAR in this range MAY instead be encoded as a &quot;hexchar&quot;, at the</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-         implementor's discretion.)</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  When encoding an octet sequence as xtext:</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-    + ASCII CHARs that fall outside the range above must be encoded as</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-         &quot;hexchar&quot;.</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+  + Any ASCII CHAR between &quot;!&quot; and &quot;~&quot; inclusive, except for &quot;+&quot; and &quot;=&quot;,</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+    MAY be encoded as itself. (A CHAR in this range MAY instead be encoded</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+    as a &quot;hexchar&quot;, at the implementor's discretion.)</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+  + ASCII CHARs that fall outside the range above must be encoded as &quot;hexchar&quot;.</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181">  */</span>
<a href="#l1.182"></a><span id="l1.182"> /* caller must free the return buffer */</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-static char *</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-esmtp_value_encode(const char *addr)</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-{</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-  char *buffer = (char *) PR_Malloc(512); /* esmtp ORCPT allow up to 500 chars encoded addresses */</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-  char *bp = buffer, *bpEnd = buffer+500;</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+static char *esmtp_value_encode(const char *addr) {</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  char *buffer = (char *)PR_Malloc(</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+      512); /* esmtp ORCPT allow up to 500 chars encoded addresses */</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+  char *bp = buffer, *bpEnd = buffer + 500;</span>
<a href="#l1.192"></a><span id="l1.192">   int len, i;</span>
<a href="#l1.193"></a><span id="l1.193"> </span>
<a href="#l1.194"></a><span id="l1.194">   if (!buffer) return NULL;</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-  *bp=0;</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-  if (! addr || *addr == 0) /* this will never happen */</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+  *bp = 0;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+  if (!addr || *addr == 0) /* this will never happen */</span>
<a href="#l1.200"></a><span id="l1.200">     return buffer;</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  for (i=0, len=PL_strlen(addr); i &lt; len &amp;&amp; bp &lt; bpEnd; i++)</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-  {</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-    if (*addr &gt;= 0x21 &amp;&amp;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-      *addr &lt;= 0x7E &amp;&amp;</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-      *addr != '+' &amp;&amp;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-      *addr != '=')</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-    {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+  for (i = 0, len = PL_strlen(addr); i &lt; len &amp;&amp; bp &lt; bpEnd; i++) {</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+    if (*addr &gt;= 0x21 &amp;&amp; *addr &lt;= 0x7E &amp;&amp; *addr != '+' &amp;&amp; *addr != '=') {</span>
<a href="#l1.211"></a><span id="l1.211">       *bp++ = *addr++;</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-    }</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-    else</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-    {</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-      PR_snprintf(bp, bpEnd-bp, &quot;+%.2X&quot;, ((int)*addr++));</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+    } else {</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+      PR_snprintf(bp, bpEnd - bp, &quot;+%.2X&quot;, ((int)*addr++));</span>
<a href="#l1.218"></a><span id="l1.218">       bp += PL_strlen(bp);</span>
<a href="#l1.219"></a><span id="l1.219">     }</span>
<a href="#l1.220"></a><span id="l1.220">   }</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-  *bp=0;</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+  *bp = 0;</span>
<a href="#l1.223"></a><span id="l1.223">   return buffer;</span>
<a href="#l1.224"></a><span id="l1.224"> }</span>
<a href="#l1.225"></a><span id="l1.225"> </span>
<a href="#l1.226"></a><span id="l1.226"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.227"></a><span id="l1.227"> // END OF TEMPORARY HARD CODED FUNCTIONS</span>
<a href="#l1.228"></a><span id="l1.228"> ///////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.229"></a><span id="l1.229"> </span>
<a href="#l1.230"></a><span id="l1.230"> NS_IMPL_ISUPPORTS_INHERITED(nsSmtpProtocol, nsMsgAsyncWriteProtocol,</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-                            msgIOAuth2ModuleListener,</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-                            nsIProtocolProxyCallback)</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+                            msgIOAuth2ModuleListener, nsIProtocolProxyCallback)</span>
<a href="#l1.234"></a><span id="l1.234"> </span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-nsSmtpProtocol::nsSmtpProtocol(nsIURI * aURL)</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-    : nsMsgAsyncWriteProtocol(aURL)</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-    , m_dataBuf(nullptr)</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-{</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-}</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+nsSmtpProtocol::nsSmtpProtocol(nsIURI *aURL)</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+    : nsMsgAsyncWriteProtocol(aURL), m_dataBuf(nullptr) {}</span>
<a href="#l1.242"></a><span id="l1.242"> </span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-nsSmtpProtocol::~nsSmtpProtocol()</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-{</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+nsSmtpProtocol::~nsSmtpProtocol() {</span>
<a href="#l1.246"></a><span id="l1.246">   // free our local state</span>
<a href="#l1.247"></a><span id="l1.247">   PR_FREEIF(m_dataBuf);</span>
<a href="#l1.248"></a><span id="l1.248"> }</span>
<a href="#l1.249"></a><span id="l1.249"> </span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-nsresult nsSmtpProtocol::Initialize(nsIURI * aURL)</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-{</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-    NS_ASSERTION(aURL, &quot;invalid URL passed into Smtp Protocol&quot;);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+nsresult nsSmtpProtocol::Initialize(nsIURI *aURL) {</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  NS_ASSERTION(aURL, &quot;invalid URL passed into Smtp Protocol&quot;);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+  m_flags = 0;</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+  m_prefAuthMethods = 0;</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  m_failedAuthMethods = 0;</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+  m_currentAuthMethod = 0;</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+  m_usernamePrompted = false;</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+  m_prefSocketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+  m_tlsInitiated = false;</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+  m_clientIDInitialized = false;</span>
<a href="#l1.266"></a><span id="l1.266"> </span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-    m_flags = 0;</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-    m_prefAuthMethods = 0;</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-    m_failedAuthMethods = 0;</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-    m_currentAuthMethod = 0;</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    m_usernamePrompted = false;</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    m_prefSocketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-    m_tlsInitiated = false;</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-    m_clientIDInitialized = false;</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+  m_url = aURL;  // Needed in nsMsgAsyncWriteProtocol::UpdateProgress().</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+  m_urlErrorState = NS_ERROR_FAILURE;</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+  if (aURL) m_runningURL = do_QueryInterface(aURL);</span>
<a href="#l1.279"></a><span id="l1.279"> </span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-    m_url = aURL; // Needed in nsMsgAsyncWriteProtocol::UpdateProgress().</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-    m_urlErrorState = NS_ERROR_FAILURE;</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+  // extract out message feedback if there is any.</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aURL);</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+  if (mailnewsUrl)</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+    mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l1.286"></a><span id="l1.286"> </span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-    if (aURL)</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-        m_runningURL = do_QueryInterface(aURL);</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+  m_dataBuf = (char *)PR_Malloc(sizeof(char) * OUTPUT_BUFFER_SIZE);</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+  m_dataBufSize = OUTPUT_BUFFER_SIZE;</span>
<a href="#l1.291"></a><span id="l1.291"> </span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-    // extract out message feedback if there is any.</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aURL);</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-        mailnewsUrl-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+  m_nextState = SMTP_START_CONNECT;</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+  m_nextStateAfterResponse = SMTP_START_CONNECT;</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+  m_responseCode = 0;</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+  m_responseCodeEnhanced = 0;</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+  m_previousResponseCode = 0;</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+  m_continuationResponse = -1;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+  m_tlsEnabled = false;</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+  m_addressesLeft = 0;</span>
<a href="#l1.304"></a><span id="l1.304"> </span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-    m_dataBuf = (char *) PR_Malloc(sizeof(char) * OUTPUT_BUFFER_SIZE);</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-    m_dataBufSize = OUTPUT_BUFFER_SIZE;</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+  m_sendDone = false;</span>
<a href="#l1.308"></a><span id="l1.308"> </span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-    m_nextState = SMTP_START_CONNECT;</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-    m_nextStateAfterResponse = SMTP_START_CONNECT;</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-    m_responseCode = 0;</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-    m_responseCodeEnhanced = 0;</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-    m_previousResponseCode = 0;</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-    m_continuationResponse = -1;</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-    m_tlsEnabled = false;</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-    m_addressesLeft = 0;</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+  m_sizelimit = 0;</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+  m_totalMessageSize = 0;</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+  m_runningURL-&gt;GetPostMessageFile(getter_AddRefs(file));</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+  if (file) file-&gt;GetFileSize(&amp;m_totalMessageSize);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+  m_originalContentLength = 0;</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+  m_totalAmountRead = 0;</span>
<a href="#l1.325"></a><span id="l1.325"> </span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-    m_sendDone = false;</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-    m_sizelimit = 0;</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-    m_totalMessageSize = 0;</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-    m_runningURL-&gt;GetPostMessageFile(getter_AddRefs(file));</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-    if (file)</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-        file-&gt;GetFileSize(&amp;m_totalMessageSize);</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-    m_originalContentLength = 0;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-    m_totalAmountRead = 0;</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+  m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true);</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+  // ** may want to consider caching the server capability to save lots of</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+  // round trip communication between the client and server</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+  int32_t authMethod = 0;</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+  m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+  if (smtpServer) {</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+    smtpServer-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+    smtpServer-&gt;GetSocketType(&amp;m_prefSocketType);</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+    smtpServer-&gt;GetHelloArgument(m_helloArgument);</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+    smtpServer-&gt;GetClientid(m_clientId);</span>
<a href="#l1.348"></a><span id="l1.348"> </span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-    m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true);</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-    // ** may want to consider caching the server capability to save lots of</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-    // round trip communication between the client and server</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-    int32_t authMethod = 0;</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-    m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-    if (smtpServer) {</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-        smtpServer-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-        smtpServer-&gt;GetSocketType(&amp;m_prefSocketType);</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-        smtpServer-&gt;GetHelloArgument(m_helloArgument);</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-        smtpServer-&gt;GetClientid(m_clientId);</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+    // Query for OAuth2 support. If the SMTP server preferences don't allow</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+    // for OAuth2, then don't carry around the OAuth2 module any longer</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+    // since we won't need it.</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+    mOAuth2Support = do_CreateInstance(MSGIOAUTH2MODULE_CONTRACTID);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+    if (mOAuth2Support) {</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+      bool supportsOAuth = false;</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+      mOAuth2Support-&gt;InitFromSmtp(smtpServer, &amp;supportsOAuth);</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+      if (!supportsOAuth) mOAuth2Support = nullptr;</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+    }</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+  }</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+  InitPrefAuthMethods(authMethod);</span>
<a href="#l1.371"></a><span id="l1.371"> </span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-        // Query for OAuth2 support. If the SMTP server preferences don't allow</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-        // for OAuth2, then don't carry around the OAuth2 module any longer</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-        // since we won't need it.</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-        mOAuth2Support = do_CreateInstance(MSGIOAUTH2MODULE_CONTRACTID);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-        if (mOAuth2Support)</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-        {</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-          bool supportsOAuth = false;</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-          mOAuth2Support-&gt;InitFromSmtp(smtpServer, &amp;supportsOAuth);</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-          if (!supportsOAuth)</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-            mOAuth2Support = nullptr;</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-        }</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-    }</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-    InitPrefAuthMethods(authMethod);</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+  nsAutoCString hostName;</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+  int32_t port = 0;</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+  aURL-&gt;GetPort(&amp;port);</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+  aURL-&gt;GetAsciiHost(hostName);</span>
<a href="#l1.390"></a><span id="l1.390"> </span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-    nsAutoCString hostName;</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-    int32_t port = 0;</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+          (&quot;SMTP Connecting to: %s:%d&quot;, hostName.get(), port));</span>
<a href="#l1.395"></a><span id="l1.395"> </span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-    aURL-&gt;GetPort(&amp;port);</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-    aURL-&gt;GetAsciiHost(hostName);</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineplus">+  bool postMessage = false;</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineplus">+  m_runningURL-&gt;GetPostMessage(&amp;postMessage);</span>
<a href="#l1.400"></a><span id="l1.400"> </span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP Connecting to: %s:%d&quot;, hostName.get(), port));</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineplus">+  if (postMessage) {</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+    m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+    m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.405"></a><span id="l1.405"> </span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-    bool postMessage = false;</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-    m_runningURL-&gt;GetPostMessage(&amp;postMessage);</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-    if (postMessage)</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-    {</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-      m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-      m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+    // compile a minimal list of valid target addresses by</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+    // - looking only at mailboxes</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+    // - dropping addresses with invalid localparts (until we implement RFC</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+    // 6532)</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+    // - using ACE for IDN domainparts</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+    // - stripping duplicates</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+    nsCString addresses;</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+    m_runningURL-&gt;GetRecipients(getter_Copies(addresses));</span>
<a href="#l1.421"></a><span id="l1.421"> </span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-      // compile a minimal list of valid target addresses by</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-      // - looking only at mailboxes</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-      // - dropping addresses with invalid localparts (until we implement RFC 6532)</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-      // - using ACE for IDN domainparts</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-      // - stripping duplicates</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-      nsCString addresses;</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-      m_runningURL-&gt;GetRecipients(getter_Copies(addresses));</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-      ExtractEmails(EncodedHeader(addresses), UTF16ArrayAdapter&lt;&gt;(m_addresses));</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineplus">+    ExtractEmails(EncodedHeader(addresses), UTF16ArrayAdapter&lt;&gt;(m_addresses));</span>
<a href="#l1.432"></a><span id="l1.432"> </span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-      nsCOMPtr&lt;nsIIDNService&gt; converter = do_GetService(NS_IDNSERVICE_CONTRACTID);</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-      addresses.Truncate();</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-      uint32_t count = m_addresses.Length();</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-      for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-      {</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-        const char *start = m_addresses[i].get();</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-        // Location of the @ character</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-        const char *lastAt = nullptr;</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-        const char *ch = start;</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-        for (; *ch; ch++)</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-        {</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-          if (*ch == '@')</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-            lastAt = ch;</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-          // Check for first illegal character (outside 0x09,0x20-0x7e)</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-          else if ((*ch &lt; ' ' || *ch &gt; '~') &amp;&amp; (*ch != '\t'))</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-          {</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-            break;</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+    nsCOMPtr&lt;nsIIDNService&gt; converter = do_GetService(NS_IDNSERVICE_CONTRACTID);</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+    addresses.Truncate();</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+    uint32_t count = m_addresses.Length();</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+      const char *start = m_addresses[i].get();</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+      // Location of the @ character</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+      const char *lastAt = nullptr;</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+      const char *ch = start;</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+      for (; *ch; ch++) {</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+        if (*ch == '@') lastAt = ch;</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+        // Check for first illegal character (outside 0x09,0x20-0x7e)</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+        else if ((*ch &lt; ' ' || *ch &gt; '~') &amp;&amp; (*ch != '\t')) {</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+          break;</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+        }</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+      }</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+      // validate the just parsed address</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+      if (*ch || m_addresses[i].IsEmpty()) {</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+        // Fortunately, we will always have an @ in each mailbox address.</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+        // We try to fix illegal character in the domain part by converting</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+        // that to ACE. Illegal characters in the local part are not fixable</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+        // (which charset would it be anyway?), hence we error out in that</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineplus">+        // case as well.</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineplus">+        nsresult rv = NS_ERROR_FAILURE;  // anything but NS_OK</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+        if (lastAt) {</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineplus">+          // Illegal char in the domain part, hence use ACE</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineplus">+          nsAutoCString domain;</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineplus">+          domain.Assign(lastAt + 1);</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+          rv = converter-&gt;ConvertUTF8toACE(domain, domain);</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+            m_addresses[i].SetLength(lastAt - start + 1);</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+            m_addresses[i] += domain;</span>
<a href="#l1.481"></a><span id="l1.481">           }</span>
<a href="#l1.482"></a><span id="l1.482">         }</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-        // validate the just parsed address</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-        if (*ch || m_addresses[i].IsEmpty())</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-        {</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-          // Fortunately, we will always have an @ in each mailbox address.</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-          // We try to fix illegal character in the domain part by converting</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-          // that to ACE. Illegal characters in the local part are not fixable</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-          // (which charset would it be anyway?), hence we error out in that</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-          // case as well.</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-          nsresult rv = NS_ERROR_FAILURE; // anything but NS_OK</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-          if (lastAt)</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-          {</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-            // Illegal char in the domain part, hence use ACE</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-            nsAutoCString domain;</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-            domain.Assign(lastAt + 1);</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-            rv = converter-&gt;ConvertUTF8toACE(domain, domain);</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-            {</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-              m_addresses[i].SetLength(lastAt - start + 1);</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-              m_addresses[i] += domain;</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-            }</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-          }</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-          {</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-            // Throw an error, including the broken address</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-            m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-            ClearFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-            // Unfortunately, nsExplainErrorDetails will show the error above</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-            // the mailnews main window, because we don't necessarily get</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-            // passed down a compose window - we might be sending in the</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-            // background!</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-            rv = nsExplainErrorDetails(m_runningURL,</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-                                       NS_ERROR_ILLEGAL_LOCALPART, start, nullptr);</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain illegal localpart&quot;);</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-            m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-            return NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-          }</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+          // Throw an error, including the broken address</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+          m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+          ClearFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+          // Unfortunately, nsExplainErrorDetails will show the error above</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+          // the mailnews main window, because we don't necessarily get</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+          // passed down a compose window - we might be sending in the</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+          // background!</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+          rv = nsExplainErrorDetails(m_runningURL, NS_ERROR_ILLEGAL_LOCALPART,</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+                                     start, nullptr);</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+          NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain illegal localpart&quot;);</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineplus">+          m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+          return NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.532"></a><span id="l1.532">         }</span>
<a href="#l1.533"></a><span id="l1.533">       }</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-      // final cleanup</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-      m_addressesLeft = m_addresses.Length();</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-      // hmm no addresses to send message to...</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-      if (m_addressesLeft == 0)</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-      {</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-        m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-        ClearFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-        m_urlErrorState = NS_MSG_NO_RECIPIENTS;</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-        return NS_MSG_NO_RECIPIENTS;</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-      }</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-    } // if post message</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-    rv = MsgExamineForProxyAsync(this, this, getter_AddRefs(m_proxyRequest));</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-    {</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">-      rv = InitializeInternal(nullptr);</span>
<a href="#l1.552"></a><span id="l1.552">     }</span>
<a href="#l1.553"></a><span id="l1.553"> </span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-    return rv;</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+    // final cleanup</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+    m_addressesLeft = m_addresses.Length();</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+    // hmm no addresses to send message to...</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+    if (m_addressesLeft == 0) {</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+      m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+      ClearFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+      m_urlErrorState = NS_MSG_NO_RECIPIENTS;</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+      return NS_MSG_NO_RECIPIENTS;</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineplus">+    }</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+  }  // if post message</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineplus">+</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+  rv = MsgExamineForProxyAsync(this, this, getter_AddRefs(m_proxyRequest));</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+    rv = InitializeInternal(nullptr);</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+  }</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+  return rv;</span>
<a href="#l1.573"></a><span id="l1.573"> }</span>
<a href="#l1.574"></a><span id="l1.574"> </span>
<a href="#l1.575"></a><span id="l1.575"> // nsIProtocolProxyCallback</span>
<a href="#l1.576"></a><span id="l1.576"> NS_IMETHODIMP</span>
<a href="#l1.577"></a><span id="l1.577"> nsSmtpProtocol::OnProxyAvailable(nsICancelable *aRequest, nsIChannel *aChannel,</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-                                 nsIProxyInfo *aProxyInfo, nsresult aStatus)</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-{</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+                                 nsIProxyInfo *aProxyInfo, nsresult aStatus) {</span>
<a href="#l1.581"></a><span id="l1.581">   // No checking of 'aStatus' here, see nsHttpChannel::OnProxyAvailable().</span>
<a href="#l1.582"></a><span id="l1.582">   // Status is non-fatal and we just kick on.</span>
<a href="#l1.583"></a><span id="l1.583">   return InitializeInternal(aProxyInfo);</span>
<a href="#l1.584"></a><span id="l1.584"> }</span>
<a href="#l1.585"></a><span id="l1.585"> </span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-nsresult nsSmtpProtocol::InitializeInternal(nsIProxyInfo* proxyInfo)</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-{</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineplus">+nsresult nsSmtpProtocol::InitializeInternal(nsIProxyInfo *proxyInfo) {</span>
<a href="#l1.589"></a><span id="l1.589">   m_proxyRequest = nullptr;</span>
<a href="#l1.590"></a><span id="l1.590"> </span>
<a href="#l1.591"></a><span id="l1.591">   // When we are making a secure connection, we need to make sure that we</span>
<a href="#l1.592"></a><span id="l1.592">   // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l1.593"></a><span id="l1.593">   // retrieve a nsIPrompt instance if needed.</span>
<a href="#l1.594"></a><span id="l1.594">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;</span>
<a href="#l1.595"></a><span id="l1.595">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(m_url));</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-  if (smtpUrl)</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-    smtpUrl-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineplus">+  if (smtpUrl) smtpUrl-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l1.599"></a><span id="l1.599"> </span>
<a href="#l1.600"></a><span id="l1.600">   int32_t port = 0;</span>
<a href="#l1.601"></a><span id="l1.601">   m_url-&gt;GetPort(&amp;port);</span>
<a href="#l1.602"></a><span id="l1.602"> </span>
<a href="#l1.603"></a><span id="l1.603">   nsAutoCString hostName;</span>
<a href="#l1.604"></a><span id="l1.604">   m_url-&gt;GetAsciiHost(hostName);</span>
<a href="#l1.605"></a><span id="l1.605"> </span>
<a href="#l1.606"></a><span id="l1.606">   nsresult rv;</span>
<a href="#l1.607"></a><span id="l1.607">   if (m_prefSocketType == nsMsgSocketType::SSL)</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-    rv = OpenNetworkSocketWithInfo(hostName.get(), port, &quot;ssl&quot;, proxyInfo, callbacks);</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-  else if (m_prefSocketType != nsMsgSocketType::plain)</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-  {</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-    rv = OpenNetworkSocketWithInfo(hostName.get(), port, &quot;starttls&quot;,</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-      proxyInfo, callbacks);</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-    if (NS_FAILED(rv) &amp;&amp; m_prefSocketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-    {</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineplus">+    rv = OpenNetworkSocketWithInfo(hostName.get(), port, &quot;ssl&quot;, proxyInfo,</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineplus">+                                   callbacks);</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineplus">+  else if (m_prefSocketType != nsMsgSocketType::plain) {</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineplus">+    rv = OpenNetworkSocketWithInfo(hostName.get(), port, &quot;starttls&quot;, proxyInfo,</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+                                   callbacks);</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineplus">+    if (NS_FAILED(rv) &amp;&amp; m_prefSocketType == nsMsgSocketType::trySTARTTLS) {</span>
<a href="#l1.621"></a><span id="l1.621">       m_prefSocketType = nsMsgSocketType::plain;</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-      rv = OpenNetworkSocketWithInfo(hostName.get(), port, nullptr, proxyInfo, callbacks);</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineplus">+      rv = OpenNetworkSocketWithInfo(hostName.get(), port, nullptr, proxyInfo,</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineplus">+                                     callbacks);</span>
<a href="#l1.625"></a><span id="l1.625">     }</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-  }</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-  else</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-    rv = OpenNetworkSocketWithInfo(hostName.get(), port, nullptr, proxyInfo, callbacks);</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineplus">+  } else</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineplus">+    rv = OpenNetworkSocketWithInfo(hostName.get(), port, nullptr, proxyInfo,</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineplus">+                                   callbacks);</span>
<a href="#l1.632"></a><span id="l1.632"> </span>
<a href="#l1.633"></a><span id="l1.633">   return LoadUrlInternal(m_url, m_consumer);</span>
<a href="#l1.634"></a><span id="l1.634"> }</span>
<a href="#l1.635"></a><span id="l1.635"> </span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-void nsSmtpProtocol::AppendHelloArgument(nsACString&amp; aResult)</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-{</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineplus">+void nsSmtpProtocol::AppendHelloArgument(nsACString &amp;aResult) {</span>
<a href="#l1.639"></a><span id="l1.639">   nsresult rv;</span>
<a href="#l1.640"></a><span id="l1.640"> </span>
<a href="#l1.641"></a><span id="l1.641">   // is a custom EHLO/HELO argument configured for the transport to be used?</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-  if (!m_helloArgument.IsEmpty())</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-  {</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-      aResult += m_helloArgument;</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-  }</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-  else</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-  {</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-      // is a FQDN known for this system?</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-      char hostName[256];</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-      PR_GetSystemInfo(PR_SI_HOSTNAME_UNTRUNCATED, hostName, sizeof hostName);</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-      if ((hostName[0] != '\0') &amp;&amp; (strchr(hostName, '.') != NULL))</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-      {</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-          nsDependentCString cleanedHostName(hostName);</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-          // avoid problems with hostnames containing newlines/whitespace</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-          cleanedHostName.StripWhitespace();</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-          aResult += cleanedHostName;</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-      }</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-      else</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-      {</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-          nsCOMPtr&lt;nsINetAddr&gt; iaddr; // IP address for this connection</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-          // our transport is always a nsISocketTransport</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-          nsCOMPtr&lt;nsISocketTransport&gt; socketTransport = do_QueryInterface(m_transport);</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-          // should return the interface ip of the SMTP connection</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-          // minimum case - see bug 68877 and RFC 2821, chapter 4.1.1.1</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-          rv = socketTransport-&gt;GetScriptableSelfAddr(getter_AddRefs(iaddr));</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+  if (!m_helloArgument.IsEmpty()) {</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+    aResult += m_helloArgument;</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+  } else {</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineplus">+    // is a FQDN known for this system?</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+    char hostName[256];</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineplus">+    PR_GetSystemInfo(PR_SI_HOSTNAME_UNTRUNCATED, hostName, sizeof hostName);</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineplus">+    if ((hostName[0] != '\0') &amp;&amp; (strchr(hostName, '.') != NULL)) {</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineplus">+      nsDependentCString cleanedHostName(hostName);</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+      // avoid problems with hostnames containing newlines/whitespace</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+      cleanedHostName.StripWhitespace();</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+      aResult += cleanedHostName;</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+    } else {</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+      nsCOMPtr&lt;nsINetAddr&gt; iaddr;  // IP address for this connection</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+      // our transport is always a nsISocketTransport</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineplus">+      nsCOMPtr&lt;nsISocketTransport&gt; socketTransport =</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineplus">+          do_QueryInterface(m_transport);</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineplus">+      // should return the interface ip of the SMTP connection</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineplus">+      // minimum case - see bug 68877 and RFC 2821, chapter 4.1.1.1</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineplus">+      rv = socketTransport-&gt;GetScriptableSelfAddr(getter_AddRefs(iaddr));</span>
<a href="#l1.685"></a><span id="l1.685"> </span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-          {</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-              // turn it into a string</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-              nsCString ipAddressString;</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-              rv = iaddr-&gt;GetAddress(ipAddressString);</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-              {</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineplus">+        // turn it into a string</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+        nsCString ipAddressString;</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+        rv = iaddr-&gt;GetAddress(ipAddressString);</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.698"></a><span id="l1.698"> #ifdef DEBUG</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineminus">-                  bool v4mapped = false;</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-                  iaddr-&gt;GetIsV4Mapped(&amp;v4mapped);</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-                  NS_ASSERTION(!v4mapped,</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-                               &quot;unexpected IPv4-mapped IPv6 address&quot;);</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+          bool v4mapped = false;</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineplus">+          iaddr-&gt;GetIsV4Mapped(&amp;v4mapped);</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineplus">+          NS_ASSERTION(!v4mapped, &quot;unexpected IPv4-mapped IPv6 address&quot;);</span>
<a href="#l1.706"></a><span id="l1.706"> #endif</span>
<a href="#l1.707"></a><span id="l1.707"> </span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-                  uint16_t family = nsINetAddr::FAMILY_INET;</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-                  iaddr-&gt;GetFamily(&amp;family);</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineplus">+          uint16_t family = nsINetAddr::FAMILY_INET;</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineplus">+          iaddr-&gt;GetFamily(&amp;family);</span>
<a href="#l1.712"></a><span id="l1.712"> </span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-                  if (family == nsINetAddr::FAMILY_INET6) // IPv6 style address?</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-                      aResult.AppendLiteral(&quot;[IPv6:&quot;);</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-                  else</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-                      aResult.Append('[');</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineplus">+          if (family == nsINetAddr::FAMILY_INET6)  // IPv6 style address?</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineplus">+            aResult.AppendLiteral(&quot;[IPv6:&quot;);</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+          else</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineplus">+            aResult.Append('[');</span>
<a href="#l1.721"></a><span id="l1.721"> </span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-                  aResult.Append(ipAddressString);</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-                  aResult.Append(']');</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-              }</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-          }</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineplus">+          aResult.Append(ipAddressString);</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineplus">+          aResult.Append(']');</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+        }</span>
<a href="#l1.729"></a><span id="l1.729">       }</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+    }</span>
<a href="#l1.731"></a><span id="l1.731">   }</span>
<a href="#l1.732"></a><span id="l1.732"> }</span>
<a href="#l1.733"></a><span id="l1.733"> </span>
<a href="#l1.734"></a><span id="l1.734"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.735"></a><span id="l1.735"> // we support the nsIStreamListener interface</span>
<a href="#l1.736"></a><span id="l1.736"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.737"></a><span id="l1.737"> </span>
<a href="#l1.738"></a><span id="l1.738"> // stop binding is a &quot;notification&quot; informing us that the stream</span>
<a href="#l1.739"></a><span id="l1.739"> // associated with aURL is going away.</span>
<a href="#l1.740"></a><span id="l1.740"> NS_IMETHODIMP nsSmtpProtocol::OnStopRequest(nsIRequest *request,</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-                                            nsresult aStatus)</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-{</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-  bool connDroppedDuringAuth = NS_SUCCEEDED(aStatus) &amp;&amp; !m_sendDone &amp;&amp;</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineplus">+                                            nsresult aStatus) {</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineplus">+  bool connDroppedDuringAuth =</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineplus">+      NS_SUCCEEDED(aStatus) &amp;&amp; !m_sendDone &amp;&amp;</span>
<a href="#l1.747"></a><span id="l1.747">       (m_nextStateAfterResponse == SMTP_AUTH_LOGIN_STEP0_RESPONSE ||</span>
<a href="#l1.748"></a><span id="l1.748">        m_nextStateAfterResponse == SMTP_AUTH_LOGIN_RESPONSE);</span>
<a href="#l1.749"></a><span id="l1.749">   // ignore errors handling the QUIT command so fcc can continue.</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineminus">-  if (m_sendDone &amp;&amp; NS_FAILED(aStatus))</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineminus">-  {</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineplus">+  if (m_sendDone &amp;&amp; NS_FAILED(aStatus)) {</span>
<a href="#l1.753"></a><span id="l1.753">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-     (&quot;SMTP connection error quitting %&quot; PRIx32 &quot;, ignoring &quot;, static_cast&lt;uint32_t&gt;(aStatus)));</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineplus">+            (&quot;SMTP connection error quitting %&quot; PRIx32 &quot;, ignoring &quot;,</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineplus">+             static_cast&lt;uint32_t&gt;(aStatus)));</span>
<a href="#l1.757"></a><span id="l1.757">     aStatus = NS_OK;</span>
<a href="#l1.758"></a><span id="l1.758">   }</span>
<a href="#l1.759"></a><span id="l1.759">   if (NS_SUCCEEDED(aStatus) &amp;&amp; !m_sendDone) {</span>
<a href="#l1.760"></a><span id="l1.760">     // if we are getting OnStopRequest() with NS_OK,</span>
<a href="#l1.761"></a><span id="l1.761">     // but we haven't finished clean, that's spells trouble.</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-    // it means that the server has dropped us before we could send the whole mail</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-    // for example, see bug #200647</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineplus">+    // it means that the server has dropped us before we could send the whole</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineplus">+    // mail for example, see bug #200647</span>
<a href="#l1.766"></a><span id="l1.766">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">- (&quot;SMTP connection dropped after %d total bytes read&quot;, m_totalAmountRead));</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineplus">+            (&quot;SMTP connection dropped after %d total bytes read&quot;,</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineplus">+             m_totalAmountRead));</span>
<a href="#l1.770"></a><span id="l1.770">     if (!connDroppedDuringAuth)</span>
<a href="#l1.771"></a><span id="l1.771">       nsMsgAsyncWriteProtocol::OnStopRequest(nullptr, NS_ERROR_NET_INTERRUPT);</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-  }</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-  else</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineplus">+  } else</span>
<a href="#l1.775"></a><span id="l1.775">     nsMsgAsyncWriteProtocol::OnStopRequest(nullptr, aStatus);</span>
<a href="#l1.776"></a><span id="l1.776"> </span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-  // okay, we've been told that the send is done and the connection is going away. So</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-  // we need to release all of our state</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineplus">+  // okay, we've been told that the send is done and the connection is going</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineplus">+  // away. So we need to release all of our state</span>
<a href="#l1.781"></a><span id="l1.781">   nsresult rv = nsMsgAsyncWriteProtocol::CloseSocket();</span>
<a href="#l1.782"></a><span id="l1.782">   // If the server dropped the connection when we were expecting</span>
<a href="#l1.783"></a><span id="l1.783">   // a login response, reprompt for password, and if the user asks,</span>
<a href="#l1.784"></a><span id="l1.784">   // retry the url.</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-  if (connDroppedDuringAuth)</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-  {</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineplus">+  if (connDroppedDuringAuth) {</span>
<a href="#l1.788"></a><span id="l1.788">     nsCOMPtr&lt;nsIURI&gt; runningURI = do_QueryInterface(m_runningURL);</span>
<a href="#l1.789"></a><span id="l1.789">     nsresult rv = AuthLoginResponse(nullptr, 0);</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-      return rv;</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.793"></a><span id="l1.793">     return LoadUrl(runningURI, nullptr);</span>
<a href="#l1.794"></a><span id="l1.794">   }</span>
<a href="#l1.795"></a><span id="l1.795"> </span>
<a href="#l1.796"></a><span id="l1.796">   return rv;</span>
<a href="#l1.797"></a><span id="l1.797"> }</span>
<a href="#l1.798"></a><span id="l1.798"> </span>
<a href="#l1.799"></a><span id="l1.799"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.800"></a><span id="l1.800"> // End of nsIStreamListenerSupport</span>
<a href="#l1.801"></a><span id="l1.801"> //////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.802"></a><span id="l1.802"> </span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-void nsSmtpProtocol::UpdateStatus(const char* aStatusName)</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-{</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-  if (m_statusFeedback)</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-  {</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineplus">+void nsSmtpProtocol::UpdateStatus(const char *aStatusName) {</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineplus">+  if (m_statusFeedback) {</span>
<a href="#l1.809"></a><span id="l1.809">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l1.812"></a><span id="l1.812">     if (!bundleService) return;</span>
<a href="#l1.813"></a><span id="l1.813">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-    nsresult rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineplus">+    nsresult rv = bundleService-&gt;CreateBundle(</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineplus">+        &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineplus">+        getter_AddRefs(bundle));</span>
<a href="#l1.818"></a><span id="l1.818">     if (NS_FAILED(rv)) return;</span>
<a href="#l1.819"></a><span id="l1.819">     nsString msg;</span>
<a href="#l1.820"></a><span id="l1.820">     bundle-&gt;GetStringFromName(aStatusName, msg);</span>
<a href="#l1.821"></a><span id="l1.821">     UpdateStatusWithString(msg.get());</span>
<a href="#l1.822"></a><span id="l1.822">   }</span>
<a href="#l1.823"></a><span id="l1.823"> }</span>
<a href="#l1.824"></a><span id="l1.824"> </span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-void nsSmtpProtocol::UpdateStatusWithString(const char16_t * aStatusString)</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-{</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+void nsSmtpProtocol::UpdateStatusWithString(const char16_t *aStatusString) {</span>
<a href="#l1.828"></a><span id="l1.828">   if (m_statusFeedback &amp;&amp; aStatusString)</span>
<a href="#l1.829"></a><span id="l1.829">     m_statusFeedback-&gt;ShowStatusString(nsDependentString(aStatusString));</span>
<a href="#l1.830"></a><span id="l1.830"> }</span>
<a href="#l1.831"></a><span id="l1.831"> </span>
<a href="#l1.832"></a><span id="l1.832"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.833"></a><span id="l1.833"> // Begin protocol state machine functions...</span>
<a href="#l1.834"></a><span id="l1.834"> //////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.835"></a><span id="l1.835"> </span>
<a href="#l1.836"></a><span id="l1.836"> /*</span>
<a href="#l1.837"></a><span id="l1.837">  * gets the response code from the SMTP server and the</span>
<a href="#l1.838"></a><span id="l1.838">  * response line</span>
<a href="#l1.839"></a><span id="l1.839">  */</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-nsresult nsSmtpProtocol::SmtpResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-{</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-  char * line = nullptr;</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineplus">+nsresult nsSmtpProtocol::SmtpResponse(nsIInputStream *inputStream,</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineplus">+                                      uint32_t length) {</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineplus">+  char *line = nullptr;</span>
<a href="#l1.846"></a><span id="l1.846">   char cont_char;</span>
<a href="#l1.847"></a><span id="l1.847">   uint32_t ln = 0;</span>
<a href="#l1.848"></a><span id="l1.848">   bool pauseForMoreData = false;</span>
<a href="#l1.849"></a><span id="l1.849"> </span>
<a href="#l1.850"></a><span id="l1.850">   if (!m_lineStreamBuffer)</span>
<a href="#l1.851"></a><span id="l1.851">     // this will force an error and at least we won't crash</span>
<a href="#l1.852"></a><span id="l1.852">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l1.853"></a><span id="l1.853"> </span>
<a href="#l1.854"></a><span id="l1.854">   line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData);</span>
<a href="#l1.855"></a><span id="l1.855"> </span>
<a href="#l1.856"></a><span id="l1.856" class="difflineminus">-  if (pauseForMoreData || !line)</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-  {</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l1.859"></a><span id="l1.859">     SetFlag(SMTP_PAUSE_FOR_READ); /* pause */</span>
<a href="#l1.860"></a><span id="l1.860">     PR_Free(line);</span>
<a href="#l1.861"></a><span id="l1.861">     return NS_OK;</span>
<a href="#l1.862"></a><span id="l1.862">   }</span>
<a href="#l1.863"></a><span id="l1.863"> </span>
<a href="#l1.864"></a><span id="l1.864">   m_totalAmountRead += ln;</span>
<a href="#l1.865"></a><span id="l1.865"> </span>
<a href="#l1.866"></a><span id="l1.866">   // The expected response is in the format:</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineat">@@ -635,517 +594,476 @@ nsresult nsSmtpProtocol::SmtpResponse(ns</span>
<a href="#l1.868"></a><span id="l1.868">   MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP Response: %s&quot;, line));</span>
<a href="#l1.869"></a><span id="l1.869">   cont_char = ' '; /* default */</span>
<a href="#l1.870"></a><span id="l1.870">   int chars_read = 0;</span>
<a href="#l1.871"></a><span id="l1.871">   // sscanf() doesn't update m_responseCode if line doesn't start</span>
<a href="#l1.872"></a><span id="l1.872">   // with a number. That can be dangerous. So be sure to set</span>
<a href="#l1.873"></a><span id="l1.873">   // m_responseCode to 0 if no items read.</span>
<a href="#l1.874"></a><span id="l1.874">   if (PR_sscanf(line, &quot;%d%c%n&quot;, &amp;m_responseCode, &amp;cont_char, &amp;chars_read) &lt;= 0)</span>
<a href="#l1.875"></a><span id="l1.875">     m_responseCode = 0;</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-  else if (cont_char != '-' )</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-  {</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineplus">+  else if (cont_char != '-') {</span>
<a href="#l1.879"></a><span id="l1.879">     m_responseCodeEnhanced = 0;</span>
<a href="#l1.880"></a><span id="l1.880">     char codeClass, codeSubject, codeDetail;</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-    if (PR_sscanf(line + chars_read, &quot;%1u.%1u.%1u &quot;, &amp;codeClass, &amp;codeSubject, &amp;codeDetail) == 3)</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineplus">+    if (PR_sscanf(line + chars_read, &quot;%1u.%1u.%1u &quot;, &amp;codeClass, &amp;codeSubject,</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineplus">+                  &amp;codeDetail) == 3)</span>
<a href="#l1.884"></a><span id="l1.884">       m_responseCodeEnhanced = codeClass * 100 + codeSubject * 10 + codeDetail;</span>
<a href="#l1.885"></a><span id="l1.885">   }</span>
<a href="#l1.886"></a><span id="l1.886"> </span>
<a href="#l1.887"></a><span id="l1.887" class="difflineminus">-  if (m_continuationResponse == -1)</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineminus">-  {</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineminus">-    if (cont_char == '-')  /* begin continuation */</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineplus">+  if (m_continuationResponse == -1) {</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineplus">+    if (cont_char == '-') /* begin continuation */</span>
<a href="#l1.892"></a><span id="l1.892">       m_continuationResponse = m_responseCode;</span>
<a href="#l1.893"></a><span id="l1.893"> </span>
<a href="#l1.894"></a><span id="l1.894">     // display the whole message if no valid response code or</span>
<a href="#l1.895"></a><span id="l1.895">     // message shorter than 4 chars (chars_read)</span>
<a href="#l1.896"></a><span id="l1.896">     // For now we intentionally leave the ESMTP code in the message text</span>
<a href="#l1.897"></a><span id="l1.897">     // as we do not handle that code so let it for the user to get some clue.</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineminus">-    m_responseText = (m_responseCode &gt;= 100 &amp;&amp; PL_strlen(line) &gt; 3) ? line + chars_read : line;</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineminus">-  }</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-  else</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-  { /* have to continue */</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineplus">+    m_responseText = (m_responseCode &gt;= 100 &amp;&amp; PL_strlen(line) &gt; 3)</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineplus">+                         ? line + chars_read</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineplus">+                         : line;</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineplus">+  } else { /* have to continue */</span>
<a href="#l1.906"></a><span id="l1.906">     if (m_continuationResponse == m_responseCode &amp;&amp; cont_char == ' ')</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-      m_continuationResponse = -1;    /* ended */</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineplus">+      m_continuationResponse = -1; /* ended */</span>
<a href="#l1.909"></a><span id="l1.909"> </span>
<a href="#l1.910"></a><span id="l1.910">     if (m_responseText.IsEmpty() || m_responseText.Last() != '\n')</span>
<a href="#l1.911"></a><span id="l1.911">       m_responseText += &quot;\n&quot;;</span>
<a href="#l1.912"></a><span id="l1.912"> </span>
<a href="#l1.913"></a><span id="l1.913">     m_responseText += (PL_strlen(line) &gt; 3) ? line + chars_read : line;</span>
<a href="#l1.914"></a><span id="l1.914">   }</span>
<a href="#l1.915"></a><span id="l1.915"> </span>
<a href="#l1.916"></a><span id="l1.916">   if (m_responseCode == 220 &amp;&amp; m_responseText.Length() &amp;&amp; !m_tlsInitiated &amp;&amp;</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-     !m_sendDone)</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineplus">+      !m_sendDone)</span>
<a href="#l1.919"></a><span id="l1.919">     m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.920"></a><span id="l1.920"> </span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-  if (m_continuationResponse == -1)  /* all done with this response? */</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+  if (m_continuationResponse == -1) /* all done with this response? */</span>
<a href="#l1.923"></a><span id="l1.923">   {</span>
<a href="#l1.924"></a><span id="l1.924">     m_nextState = m_nextStateAfterResponse;</span>
<a href="#l1.925"></a><span id="l1.925">     ClearFlag(SMTP_PAUSE_FOR_READ); /* don't pause */</span>
<a href="#l1.926"></a><span id="l1.926">   }</span>
<a href="#l1.927"></a><span id="l1.927"> </span>
<a href="#l1.928"></a><span id="l1.928">   PR_Free(line);</span>
<a href="#l1.929"></a><span id="l1.929">   return NS_OK;</span>
<a href="#l1.930"></a><span id="l1.930"> }</span>
<a href="#l1.931"></a><span id="l1.931"> </span>
<a href="#l1.932"></a><span id="l1.932" class="difflineminus">-nsresult nsSmtpProtocol::ExtensionLoginResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineminus">-{</span>
<a href="#l1.934"></a><span id="l1.934" class="difflineplus">+nsresult nsSmtpProtocol::ExtensionLoginResponse(nsIInputStream *inputStream,</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineplus">+                                                uint32_t length) {</span>
<a href="#l1.936"></a><span id="l1.936">   nsresult status = NS_OK;</span>
<a href="#l1.937"></a><span id="l1.937"> </span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-  if (m_responseCode != 220)</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-  {</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineplus">+  if (m_responseCode != 220) {</span>
<a href="#l1.941"></a><span id="l1.941"> #ifdef DEBUG</span>
<a href="#l1.942"></a><span id="l1.942">     nsresult rv =</span>
<a href="#l1.943"></a><span id="l1.943"> #endif</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-    nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_GREETING,</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-                          m_responseText.get(), nullptr);</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineplus">+        nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_GREETING,</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineplus">+                              m_responseText.get(), nullptr);</span>
<a href="#l1.948"></a><span id="l1.948">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.949"></a><span id="l1.949"> </span>
<a href="#l1.950"></a><span id="l1.950">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.951"></a><span id="l1.951">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.952"></a><span id="l1.952">   }</span>
<a href="#l1.953"></a><span id="l1.953"> </span>
<a href="#l1.954"></a><span id="l1.954">   nsAutoCString buffer(&quot;EHLO &quot;);</span>
<a href="#l1.955"></a><span id="l1.955">   AppendHelloArgument(buffer);</span>
<a href="#l1.956"></a><span id="l1.956">   buffer += CRLF;</span>
<a href="#l1.957"></a><span id="l1.957"> </span>
<a href="#l1.958"></a><span id="l1.958">   status = SendData(buffer.get());</span>
<a href="#l1.959"></a><span id="l1.959"> </span>
<a href="#l1.960"></a><span id="l1.960">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.961"></a><span id="l1.961">   m_nextStateAfterResponse = SMTP_SEND_EHLO_RESPONSE;</span>
<a href="#l1.962"></a><span id="l1.962">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.963"></a><span id="l1.963"> </span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-  return(status);</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineplus">+  return (status);</span>
<a href="#l1.966"></a><span id="l1.966"> }</span>
<a href="#l1.967"></a><span id="l1.967"> </span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-nsresult nsSmtpProtocol::SendHeloResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-{</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineplus">+nsresult nsSmtpProtocol::SendHeloResponse(nsIInputStream *inputStream,</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineplus">+                                          uint32_t length) {</span>
<a href="#l1.972"></a><span id="l1.972">   nsresult status = NS_OK;</span>
<a href="#l1.973"></a><span id="l1.973">   nsAutoCString buffer;</span>
<a href="#l1.974"></a><span id="l1.974">   nsresult rv;</span>
<a href="#l1.975"></a><span id="l1.975"> </span>
<a href="#l1.976"></a><span id="l1.976" class="difflineminus">-  if (m_responseCode != 250)</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineminus">-  {</span>
<a href="#l1.978"></a><span id="l1.978" class="difflineplus">+  if (m_responseCode != 250) {</span>
<a href="#l1.979"></a><span id="l1.979"> #ifdef DEBUG</span>
<a href="#l1.980"></a><span id="l1.980">     rv =</span>
<a href="#l1.981"></a><span id="l1.981"> #endif</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineminus">-    nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineminus">-                          m_responseText.get(), nullptr);</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineplus">+        nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineplus">+                              m_responseText.get(), nullptr);</span>
<a href="#l1.986"></a><span id="l1.986">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.987"></a><span id="l1.987"> </span>
<a href="#l1.988"></a><span id="l1.988">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.989"></a><span id="l1.989">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.990"></a><span id="l1.990">   }</span>
<a href="#l1.991"></a><span id="l1.991"> </span>
<a href="#l1.992"></a><span id="l1.992">   // check if we're just verifying the ability to logon</span>
<a href="#l1.993"></a><span id="l1.993">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l1.994"></a><span id="l1.994">   bool verifyingLogon = false;</span>
<a href="#l1.995"></a><span id="l1.995">   smtpUrl-&gt;GetVerifyLogon(&amp;verifyingLogon);</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-  if (verifyingLogon)</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-    return SendQuit();</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineplus">+  if (verifyingLogon) return SendQuit();</span>
<a href="#l1.999"></a><span id="l1.999"> </span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.1003"></a><span id="l1.1003">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1004"></a><span id="l1.1004">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l1.1005"></a><span id="l1.1005">   rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l1.1006"></a><span id="l1.1006">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1007"></a><span id="l1.1007"> </span>
<a href="#l1.1008"></a><span id="l1.1008">   bool useSenderForSmtpMailFrom = false;</span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineminus">-  prefBranch-&gt;GetBoolPref(&quot;mail.smtp.useSenderForSmtpMailFrom&quot;, &amp;useSenderForSmtpMailFrom);</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineplus">+  prefBranch-&gt;GetBoolPref(&quot;mail.smtp.useSenderForSmtpMailFrom&quot;,</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineplus">+                          &amp;useSenderForSmtpMailFrom);</span>
<a href="#l1.1012"></a><span id="l1.1012">   nsCString fullAddress;</span>
<a href="#l1.1013"></a><span id="l1.1013"> </span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineminus">-  if (useSenderForSmtpMailFrom)</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineminus">-  {</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineplus">+  if (useSenderForSmtpMailFrom) {</span>
<a href="#l1.1017"></a><span id="l1.1017">     // Extract the email address from the mail headers.</span>
<a href="#l1.1018"></a><span id="l1.1018">     nsCString from;</span>
<a href="#l1.1019"></a><span id="l1.1019">     m_runningURL-&gt;GetSender(getter_Copies(from));</span>
<a href="#l1.1020"></a><span id="l1.1020"> </span>
<a href="#l1.1021"></a><span id="l1.1021">     ExtractEmail(EncodedHeader(from), fullAddress);</span>
<a href="#l1.1022"></a><span id="l1.1022">     if (fullAddress.IsEmpty()) {</span>
<a href="#l1.1023"></a><span id="l1.1023">       m_urlErrorState = NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS;</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineminus">-      return(NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS);</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineplus">+      return (NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS);</span>
<a href="#l1.1026"></a><span id="l1.1026">     }</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-  }</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-  else</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-  {</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineplus">+  } else {</span>
<a href="#l1.1031"></a><span id="l1.1031">     // Extract the email address from the identity.</span>
<a href="#l1.1032"></a><span id="l1.1032">     nsCString emailAddress;</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIdentity&gt; senderIdentity;</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; senderIdentity;</span>
<a href="#l1.1035"></a><span id="l1.1035">     rv = m_runningURL-&gt;GetSenderIdentity(getter_AddRefs(senderIdentity));</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-    if (NS_FAILED(rv) || !senderIdentity)</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-    {</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineplus">+    if (NS_FAILED(rv) || !senderIdentity) {</span>
<a href="#l1.1039"></a><span id="l1.1039">       m_urlErrorState = NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY;</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineminus">-      return(NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY);</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineplus">+      return (NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY);</span>
<a href="#l1.1042"></a><span id="l1.1042">     }</span>
<a href="#l1.1043"></a><span id="l1.1043">     senderIdentity-&gt;GetEmail(emailAddress);</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-    if (emailAddress.IsEmpty())</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-    {</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineplus">+    if (emailAddress.IsEmpty()) {</span>
<a href="#l1.1047"></a><span id="l1.1047">       m_urlErrorState = NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS;</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-      return(NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS);</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+      return (NS_ERROR_COULD_NOT_GET_USERS_MAIL_ADDRESS);</span>
<a href="#l1.1050"></a><span id="l1.1050">     }</span>
<a href="#l1.1051"></a><span id="l1.1051"> </span>
<a href="#l1.1052"></a><span id="l1.1052">     // Quote the email address before passing it to the SMTP server.</span>
<a href="#l1.1053"></a><span id="l1.1053">     MakeMimeAddress(EmptyCString(), emailAddress, fullAddress);</span>
<a href="#l1.1054"></a><span id="l1.1054">   }</span>
<a href="#l1.1055"></a><span id="l1.1055">   buffer = &quot;MAIL FROM:&lt;&quot;;</span>
<a href="#l1.1056"></a><span id="l1.1056">   buffer += fullAddress;</span>
<a href="#l1.1057"></a><span id="l1.1057">   buffer += &quot;&gt;&quot;;</span>
<a href="#l1.1058"></a><span id="l1.1058"> </span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-  if (TestFlag(SMTP_EHLO_DSN_ENABLED))</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-  {</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineplus">+  if (TestFlag(SMTP_EHLO_DSN_ENABLED)) {</span>
<a href="#l1.1062"></a><span id="l1.1062">     bool requestDSN = false;</span>
<a href="#l1.1063"></a><span id="l1.1063">     rv = m_runningURL-&gt;GetRequestDSN(&amp;requestDSN);</span>
<a href="#l1.1064"></a><span id="l1.1064"> </span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineminus">-    if (requestDSN)</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineminus">-    {</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineplus">+    if (requestDSN) {</span>
<a href="#l1.1068"></a><span id="l1.1068">       bool requestRetFull = false;</span>
<a href="#l1.1069"></a><span id="l1.1069">       rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.ret_full_on&quot;, &amp;requestRetFull);</span>
<a href="#l1.1070"></a><span id="l1.1070"> </span>
<a href="#l1.1071"></a><span id="l1.1071">       buffer += requestRetFull ? &quot; RET=FULL&quot; : &quot; RET=HDRS&quot;;</span>
<a href="#l1.1072"></a><span id="l1.1072"> </span>
<a href="#l1.1073"></a><span id="l1.1073">       nsCString dsnEnvid;</span>
<a href="#l1.1074"></a><span id="l1.1074"> </span>
<a href="#l1.1075"></a><span id="l1.1075">       // get the envid from the smtpUrl</span>
<a href="#l1.1076"></a><span id="l1.1076">       rv = m_runningURL-&gt;GetDsnEnvid(dsnEnvid);</span>
<a href="#l1.1077"></a><span id="l1.1077"> </span>
<a href="#l1.1078"></a><span id="l1.1078">       if (dsnEnvid.IsEmpty()) {</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineminus">-          nsCOMPtr &lt;nsIMsgIdentity&gt; senderIdentity;</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineminus">-          rv = m_runningURL-&gt;GetSenderIdentity(getter_AddRefs(senderIdentity));</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineminus">-          if (NS_FAILED(rv) || !senderIdentity) {</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineminus">-              m_urlErrorState = NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY;</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineminus">-              return(NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY);</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineminus">-          }</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineminus">-          dsnEnvid.Adopt(msg_generate_message_id(senderIdentity));</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; senderIdentity;</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineplus">+        rv = m_runningURL-&gt;GetSenderIdentity(getter_AddRefs(senderIdentity));</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineplus">+        if (NS_FAILED(rv) || !senderIdentity) {</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineplus">+          m_urlErrorState = NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY;</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineplus">+          return (NS_ERROR_COULD_NOT_GET_SENDERS_IDENTITY);</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineplus">+        }</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineplus">+        dsnEnvid.Adopt(msg_generate_message_id(senderIdentity));</span>
<a href="#l1.1093"></a><span id="l1.1093">       }</span>
<a href="#l1.1094"></a><span id="l1.1094">       buffer += &quot; ENVID=&quot;;</span>
<a href="#l1.1095"></a><span id="l1.1095">       buffer += dsnEnvid;</span>
<a href="#l1.1096"></a><span id="l1.1096">     }</span>
<a href="#l1.1097"></a><span id="l1.1097">   }</span>
<a href="#l1.1098"></a><span id="l1.1098"> </span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineminus">-  if (TestFlag(SMTP_EHLO_8BIT_ENABLED))</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineminus">-  {</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineplus">+  if (TestFlag(SMTP_EHLO_8BIT_ENABLED)) {</span>
<a href="#l1.1102"></a><span id="l1.1102">     bool strictlyMime = false;</span>
<a href="#l1.1103"></a><span id="l1.1103">     rv = prefBranch-&gt;GetBoolPref(&quot;mail.strictly_mime&quot;, &amp;strictlyMime);</span>
<a href="#l1.1104"></a><span id="l1.1104"> </span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineminus">-    if (!strictlyMime)</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineminus">-      buffer.AppendLiteral(&quot; BODY=8BITMIME&quot;);</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineplus">+    if (!strictlyMime) buffer.AppendLiteral(&quot; BODY=8BITMIME&quot;);</span>
<a href="#l1.1108"></a><span id="l1.1108">   }</span>
<a href="#l1.1109"></a><span id="l1.1109"> </span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineminus">-  if (TestFlag(SMTP_EHLO_SIZE_ENABLED))</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineminus">-  {</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineplus">+  if (TestFlag(SMTP_EHLO_SIZE_ENABLED)) {</span>
<a href="#l1.1113"></a><span id="l1.1113">     buffer.AppendLiteral(&quot; SIZE=&quot;);</span>
<a href="#l1.1114"></a><span id="l1.1114">     buffer.AppendInt(m_totalMessageSize);</span>
<a href="#l1.1115"></a><span id="l1.1115">   }</span>
<a href="#l1.1116"></a><span id="l1.1116">   buffer += CRLF;</span>
<a href="#l1.1117"></a><span id="l1.1117"> </span>
<a href="#l1.1118"></a><span id="l1.1118">   status = SendData(buffer.get());</span>
<a href="#l1.1119"></a><span id="l1.1119"> </span>
<a href="#l1.1120"></a><span id="l1.1120">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1121"></a><span id="l1.1121"> </span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineminus">-</span>
<a href="#l1.1123"></a><span id="l1.1123">   m_nextStateAfterResponse = SMTP_SEND_MAIL_RESPONSE;</span>
<a href="#l1.1124"></a><span id="l1.1124">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1125"></a><span id="l1.1125"> </span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineminus">-  return(status);</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineplus">+  return (status);</span>
<a href="#l1.1128"></a><span id="l1.1128"> }</span>
<a href="#l1.1129"></a><span id="l1.1129"> </span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineminus">-nsresult nsSmtpProtocol::SendEhloResponse(nsIInputStream * inputStream, uint32_t length)</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineminus">-{</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineminus">-    nsresult status = NS_OK;</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineplus">+nsresult nsSmtpProtocol::SendEhloResponse(nsIInputStream *inputStream,</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineplus">+                                          uint32_t length) {</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineplus">+</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineplus">+  if (m_responseCode != 250) {</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineplus">+    /* EHLO must not be implemented by the server, so fall back to the HELO case</span>
<a href="#l1.1139"></a><span id="l1.1139" class="difflineplus">+     * if command is unrecognized or unimplemented.</span>
<a href="#l1.1140"></a><span id="l1.1140" class="difflineplus">+     */</span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineplus">+    if (m_responseCode == 500 || m_responseCode == 502) {</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineplus">+      /* If STARTTLS is requested by the user, EHLO is required to advertise it.</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineplus">+       * But only if TLS handshake is not already accomplished.</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineplus">+       */</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineplus">+      if (m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS &amp;&amp;</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineplus">+          !m_tlsEnabled) {</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineplus">+        m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineplus">+        m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineplus">+        return (NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS);</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineplus">+      }</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineplus">+</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineplus">+      nsAutoCString buffer(&quot;HELO &quot;);</span>
<a href="#l1.1153"></a><span id="l1.1153" class="difflineplus">+      AppendHelloArgument(buffer);</span>
<a href="#l1.1154"></a><span id="l1.1154" class="difflineplus">+      buffer += CRLF;</span>
<a href="#l1.1155"></a><span id="l1.1155"> </span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineminus">-    if (m_responseCode != 250)</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-    {</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineminus">-        /* EHLO must not be implemented by the server, so fall back to the HELO case</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineminus">-         * if command is unrecognized or unimplemented.</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineminus">-         */</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineminus">-        if (m_responseCode == 500 || m_responseCode == 502)</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineminus">-        {</span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineminus">-            /* If STARTTLS is requested by the user, EHLO is required to advertise it.</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineminus">-             * But only if TLS handshake is not already accomplished.</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineminus">-             */</span>
<a href="#l1.1166"></a><span id="l1.1166" class="difflineminus">-            if (m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS &amp;&amp;</span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineminus">-                !m_tlsEnabled)</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineminus">-            {</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineminus">-                m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineminus">-                m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l1.1171"></a><span id="l1.1171" class="difflineminus">-                return(NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS);</span>
<a href="#l1.1172"></a><span id="l1.1172" class="difflineminus">-            }</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineplus">+      status = SendData(buffer.get());</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineplus">+</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineplus">+      m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineplus">+      m_nextStateAfterResponse = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineplus">+      SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineplus">+      return (status);</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineplus">+    }</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineplus">+    /* e.g. getting 421 &quot;Server says unauthorized, bye&quot; or</span>
<a href="#l1.1181"></a><span id="l1.1181" class="difflineplus">+     * 501 &quot;Syntax error in EHLOs parameters or arguments&quot;</span>
<a href="#l1.1182"></a><span id="l1.1182" class="difflineplus">+     */</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineplus">+    else {</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineplus">+      nsresult rv =</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineplus">+#endif</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineplus">+          nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineplus">+                                m_responseText.get(), nullptr);</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineplus">+</span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineplus">+      m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineplus">+      return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.1193"></a><span id="l1.1193" class="difflineplus">+    }</span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineplus">+  }</span>
<a href="#l1.1195"></a><span id="l1.1195"> </span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineminus">-            nsAutoCString buffer(&quot;HELO &quot;);</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineminus">-            AppendHelloArgument(buffer);</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineminus">-            buffer += CRLF;</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineplus">+  int32_t responseLength = m_responseText.Length();</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineplus">+  int32_t startPos = 0;</span>
<a href="#l1.1201"></a><span id="l1.1201" class="difflineplus">+  int32_t endPos;</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineplus">+  do {</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineplus">+    endPos = m_responseText.FindChar('\n', startPos + 1);</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineplus">+    nsAutoCString responseLine;</span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineplus">+    responseLine.Assign(</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineplus">+        Substring(m_responseText, startPos,</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineplus">+                  (endPos &gt;= 0 ? endPos : responseLength) - startPos));</span>
<a href="#l1.1208"></a><span id="l1.1208"> </span>
<a href="#l1.1209"></a><span id="l1.1209" class="difflineminus">-            status = SendData(buffer.get());</span>
<a href="#l1.1210"></a><span id="l1.1210" class="difflineplus">+    MsgCompressWhitespace(responseLine);</span>
<a href="#l1.1211"></a><span id="l1.1211" class="difflineplus">+    if (responseLine.LowerCaseEqualsLiteral(&quot;starttls&quot;)) {</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineplus">+      SetFlag(SMTP_EHLO_STARTTLS_ENABLED);</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineplus">+    } else if (responseLine.LowerCaseEqualsLiteral(&quot;dsn&quot;)) {</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineplus">+      SetFlag(SMTP_EHLO_DSN_ENABLED);</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineplus">+    } else if (responseLine.LowerCaseEqualsLiteral(&quot;clientid&quot;)) {</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineplus">+      SetFlag(SMTP_EHLO_CLIENTID_ENABLED);</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineplus">+      // If we have &quot;clientid&quot; in the ehlo response, then TLS must be present.</span>
<a href="#l1.1218"></a><span id="l1.1218" class="difflineplus">+      if (m_prefSocketType == nsMsgSocketType::SSL) m_tlsEnabled = true;</span>
<a href="#l1.1219"></a><span id="l1.1219" class="difflineplus">+    } else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;AUTH&quot;),</span>
<a href="#l1.1220"></a><span id="l1.1220" class="difflineplus">+                                nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l1.1221"></a><span id="l1.1221" class="difflineplus">+      SetFlag(SMTP_AUTH);</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineplus">+</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;GSSAPI&quot;),</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineplus">+        SetFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineplus">+</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;CRAM-MD5&quot;),</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineplus">+        SetFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l1.1230"></a><span id="l1.1230"> </span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineminus">-            m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineminus">-            m_nextStateAfterResponse = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineminus">-            SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineminus">-            return (status);</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineminus">-        }</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineminus">-        /* e.g. getting 421 &quot;Server says unauthorized, bye&quot; or</span>
<a href="#l1.1237"></a><span id="l1.1237" class="difflineminus">-         * 501 &quot;Syntax error in EHLOs parameters or arguments&quot;</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-         */</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-        else</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineminus">-        {</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineminus">-            nsresult rv =</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineminus">-#endif</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineminus">-            nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_SERVER_ERROR,</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineminus">-                                  m_responseText.get(), nullptr);</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineminus">-            NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;NTLM&quot;),</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineplus">+        SetFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineplus">+</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;MSN&quot;),</span>
<a href="#l1.1252"></a><span id="l1.1252" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1253"></a><span id="l1.1253" class="difflineplus">+        SetFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineplus">+</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;PLAIN&quot;),</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineplus">+        SetFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineplus">+</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;LOGIN&quot;),</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1261"></a><span id="l1.1261" class="difflineplus">+        SetFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l1.1262"></a><span id="l1.1262"> </span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-            m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineminus">-            return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineminus">-        }</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;EXTERNAL&quot;),</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineplus">+        SetFlag(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineplus">+</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineplus">+      if (responseLine.Find(NS_LITERAL_CSTRING(&quot;XOAUTH2&quot;),</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineplus">+                            /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineplus">+        SetFlag(SMTP_AUTH_OAUTH2_ENABLED);</span>
<a href="#l1.1273"></a><span id="l1.1273" class="difflineplus">+    } else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;SIZE&quot;),</span>
<a href="#l1.1274"></a><span id="l1.1274" class="difflineplus">+                                nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l1.1275"></a><span id="l1.1275" class="difflineplus">+      SetFlag(SMTP_EHLO_SIZE_ENABLED);</span>
<a href="#l1.1276"></a><span id="l1.1276" class="difflineplus">+</span>
<a href="#l1.1277"></a><span id="l1.1277" class="difflineplus">+      m_sizelimit = atol((responseLine.get()) + 4);</span>
<a href="#l1.1278"></a><span id="l1.1278" class="difflineplus">+    } else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;8BITMIME&quot;),</span>
<a href="#l1.1279"></a><span id="l1.1279" class="difflineplus">+                                nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l1.1280"></a><span id="l1.1280" class="difflineplus">+      SetFlag(SMTP_EHLO_8BIT_ENABLED);</span>
<a href="#l1.1281"></a><span id="l1.1281">     }</span>
<a href="#l1.1282"></a><span id="l1.1282"> </span>
<a href="#l1.1283"></a><span id="l1.1283" class="difflineminus">-    int32_t responseLength = m_responseText.Length();</span>
<a href="#l1.1284"></a><span id="l1.1284" class="difflineminus">-    int32_t startPos = 0;</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineminus">-    int32_t endPos;</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineminus">-    do</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineminus">-    {</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineminus">-        endPos = m_responseText.FindChar('\n', startPos + 1);</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineminus">-        nsAutoCString responseLine;</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineminus">-        responseLine.Assign(Substring(m_responseText, startPos,</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineminus">-            (endPos &gt;= 0 ? endPos : responseLength) - startPos));</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineplus">+    startPos = endPos + 1;</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineplus">+  } while (endPos &gt;= 0);</span>
<a href="#l1.1294"></a><span id="l1.1294"> </span>
<a href="#l1.1295"></a><span id="l1.1295" class="difflineminus">-        MsgCompressWhitespace(responseLine);</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineminus">-        if (responseLine.LowerCaseEqualsLiteral(&quot;starttls&quot;))</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineminus">-        {</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineminus">-            SetFlag(SMTP_EHLO_STARTTLS_ENABLED);</span>
<a href="#l1.1299"></a><span id="l1.1299" class="difflineminus">-        }</span>
<a href="#l1.1300"></a><span id="l1.1300" class="difflineminus">-        else if (responseLine.LowerCaseEqualsLiteral(&quot;dsn&quot;))</span>
<a href="#l1.1301"></a><span id="l1.1301" class="difflineminus">-        {</span>
<a href="#l1.1302"></a><span id="l1.1302" class="difflineminus">-            SetFlag(SMTP_EHLO_DSN_ENABLED);</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineminus">-        }</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineminus">-        else if (responseLine.LowerCaseEqualsLiteral(&quot;clientid&quot;))</span>
<a href="#l1.1305"></a><span id="l1.1305" class="difflineminus">-        {</span>
<a href="#l1.1306"></a><span id="l1.1306" class="difflineminus">-            SetFlag(SMTP_EHLO_CLIENTID_ENABLED);</span>
<a href="#l1.1307"></a><span id="l1.1307" class="difflineminus">-            // If we have &quot;clientid&quot; in the ehlo response, then TLS must be present.</span>
<a href="#l1.1308"></a><span id="l1.1308" class="difflineminus">-            if (m_prefSocketType == nsMsgSocketType::SSL)</span>
<a href="#l1.1309"></a><span id="l1.1309" class="difflineminus">-                m_tlsEnabled = true;</span>
<a href="#l1.1310"></a><span id="l1.1310" class="difflineminus">-        }</span>
<a href="#l1.1311"></a><span id="l1.1311" class="difflineminus">-        else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;AUTH&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.1312"></a><span id="l1.1312" class="difflineminus">-        {</span>
<a href="#l1.1313"></a><span id="l1.1313" class="difflineminus">-          SetFlag(SMTP_AUTH);</span>
<a href="#l1.1314"></a><span id="l1.1314" class="difflineplus">+  if (TestFlag(SMTP_EHLO_SIZE_ENABLED) &amp;&amp; m_sizelimit &gt; 0 &amp;&amp;</span>
<a href="#l1.1315"></a><span id="l1.1315" class="difflineplus">+      (int32_t)m_totalMessageSize &gt; m_sizelimit) {</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l1.1317"></a><span id="l1.1317" class="difflineplus">+    nsresult rv =</span>
<a href="#l1.1318"></a><span id="l1.1318" class="difflineplus">+#endif</span>
<a href="#l1.1319"></a><span id="l1.1319" class="difflineplus">+        nsExplainErrorDetails(m_runningURL, NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_1,</span>
<a href="#l1.1320"></a><span id="l1.1320" class="difflineplus">+                              nsPrintfCString(&quot;%&quot; PRId32, m_sizelimit).get(),</span>
<a href="#l1.1321"></a><span id="l1.1321" class="difflineplus">+                              nullptr);</span>
<a href="#l1.1322"></a><span id="l1.1322" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.1323"></a><span id="l1.1323"> </span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;GSSAPI&quot;),</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1326"></a><span id="l1.1326" class="difflineminus">-            SetFlag(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l1.1327"></a><span id="l1.1327" class="difflineminus">-</span>
<a href="#l1.1328"></a><span id="l1.1328" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;CRAM-MD5&quot;),</span>
<a href="#l1.1329"></a><span id="l1.1329" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineminus">-            SetFlag(SMTP_AUTH_CRAM_MD5_ENABLED);</span>
<a href="#l1.1331"></a><span id="l1.1331" class="difflineminus">-</span>
<a href="#l1.1332"></a><span id="l1.1332" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;NTLM&quot;),</span>
<a href="#l1.1333"></a><span id="l1.1333" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1334"></a><span id="l1.1334" class="difflineminus">-            SetFlag(SMTP_AUTH_NTLM_ENABLED);</span>
<a href="#l1.1335"></a><span id="l1.1335" class="difflineplus">+    m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.1336"></a><span id="l1.1336" class="difflineplus">+    return (NS_ERROR_SENDING_FROM_COMMAND);</span>
<a href="#l1.1337"></a><span id="l1.1337" class="difflineplus">+  }</span>
<a href="#l1.1338"></a><span id="l1.1338"> </span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;MSN&quot;),</span>
<a href="#l1.1340"></a><span id="l1.1340" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1341"></a><span id="l1.1341" class="difflineminus">-            SetFlag(SMTP_AUTH_MSN_ENABLED);</span>
<a href="#l1.1342"></a><span id="l1.1342" class="difflineminus">-</span>
<a href="#l1.1343"></a><span id="l1.1343" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;PLAIN&quot;),</span>
<a href="#l1.1344"></a><span id="l1.1344" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1345"></a><span id="l1.1345" class="difflineminus">-            SetFlag(SMTP_AUTH_PLAIN_ENABLED);</span>
<a href="#l1.1346"></a><span id="l1.1346" class="difflineminus">-</span>
<a href="#l1.1347"></a><span id="l1.1347" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;LOGIN&quot;),</span>
<a href="#l1.1348"></a><span id="l1.1348" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1349"></a><span id="l1.1349" class="difflineminus">-            SetFlag(SMTP_AUTH_LOGIN_ENABLED);</span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineminus">-</span>
<a href="#l1.1351"></a><span id="l1.1351" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;EXTERNAL&quot;),</span>
<a href="#l1.1352"></a><span id="l1.1352" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1353"></a><span id="l1.1353" class="difflineminus">-            SetFlag(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l1.1354"></a><span id="l1.1354" class="difflineminus">-</span>
<a href="#l1.1355"></a><span id="l1.1355" class="difflineminus">-          if (responseLine.Find(NS_LITERAL_CSTRING(&quot;XOAUTH2&quot;),</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineminus">-                                /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineminus">-            SetFlag(SMTP_AUTH_OAUTH2_ENABLED);</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineminus">-        }</span>
<a href="#l1.1359"></a><span id="l1.1359" class="difflineminus">-        else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;SIZE&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.1360"></a><span id="l1.1360" class="difflineminus">-        {</span>
<a href="#l1.1361"></a><span id="l1.1361" class="difflineminus">-            SetFlag(SMTP_EHLO_SIZE_ENABLED);</span>
<a href="#l1.1362"></a><span id="l1.1362" class="difflineplus">+  m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l1.1363"></a><span id="l1.1363" class="difflineplus">+  return status;</span>
<a href="#l1.1364"></a><span id="l1.1364" class="difflineplus">+}</span>
<a href="#l1.1365"></a><span id="l1.1365"> </span>
<a href="#l1.1366"></a><span id="l1.1366" class="difflineminus">-            m_sizelimit = atol((responseLine.get()) + 4);</span>
<a href="#l1.1367"></a><span id="l1.1367" class="difflineminus">-        }</span>
<a href="#l1.1368"></a><span id="l1.1368" class="difflineminus">-        else if (StringBeginsWith(responseLine, NS_LITERAL_CSTRING(&quot;8BITMIME&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l1.1369"></a><span id="l1.1369" class="difflineminus">-        {</span>
<a href="#l1.1370"></a><span id="l1.1370" class="difflineminus">-            SetFlag(SMTP_EHLO_8BIT_ENABLED);</span>
<a href="#l1.1371"></a><span id="l1.1371" class="difflineminus">-        }</span>
<a href="#l1.1372"></a><span id="l1.1372" class="difflineminus">-</span>
<a href="#l1.1373"></a><span id="l1.1373" class="difflineminus">-        startPos = endPos + 1;</span>
<a href="#l1.1374"></a><span id="l1.1374" class="difflineminus">-    } while (endPos &gt;= 0);</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineplus">+nsresult nsSmtpProtocol::SendTLSResponse() {</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineplus">+  // only tear down our existing connection and open a new one if we received a</span>
<a href="#l1.1377"></a><span id="l1.1377" class="difflineplus">+  // 220 response from the smtp server after we issued the STARTTLS</span>
<a href="#l1.1378"></a><span id="l1.1378" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineplus">+  if (m_responseCode == 220) {</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; secInfo;</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineplus">+    nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport, &amp;rv);</span>
<a href="#l1.1382"></a><span id="l1.1382" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.1383"></a><span id="l1.1383"> </span>
<a href="#l1.1384"></a><span id="l1.1384" class="difflineminus">-    if (TestFlag(SMTP_EHLO_SIZE_ENABLED) &amp;&amp;</span>
<a href="#l1.1385"></a><span id="l1.1385" class="difflineminus">-       m_sizelimit &gt; 0 &amp;&amp; (int32_t)m_totalMessageSize &gt; m_sizelimit)</span>
<a href="#l1.1386"></a><span id="l1.1386" class="difflineminus">-    {</span>
<a href="#l1.1387"></a><span id="l1.1387" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l1.1388"></a><span id="l1.1388" class="difflineminus">-        nsresult rv =</span>
<a href="#l1.1389"></a><span id="l1.1389" class="difflineminus">-#endif</span>
<a href="#l1.1390"></a><span id="l1.1390" class="difflineminus">-        nsExplainErrorDetails(m_runningURL,</span>
<a href="#l1.1391"></a><span id="l1.1391" class="difflineminus">-                              NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_1,</span>
<a href="#l1.1392"></a><span id="l1.1392" class="difflineminus">-                              nsPrintfCString(&quot;%&quot; PRId32, m_sizelimit).get(), nullptr);</span>
<a href="#l1.1393"></a><span id="l1.1393" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.1394"></a><span id="l1.1394" class="difflineplus">+    rv = strans-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<a href="#l1.1395"></a><span id="l1.1395"> </span>
<a href="#l1.1396"></a><span id="l1.1396" class="difflineminus">-        m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.1397"></a><span id="l1.1397" class="difflineminus">-        return(NS_ERROR_SENDING_FROM_COMMAND);</span>
<a href="#l1.1398"></a><span id="l1.1398" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; secInfo) {</span>
<a href="#l1.1399"></a><span id="l1.1399" class="difflineplus">+      nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl =</span>
<a href="#l1.1400"></a><span id="l1.1400" class="difflineplus">+          do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineplus">+</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; sslControl) rv = sslControl-&gt;StartTLS();</span>
<a href="#l1.1403"></a><span id="l1.1403">     }</span>
<a href="#l1.1404"></a><span id="l1.1404"> </span>
<a href="#l1.1405"></a><span id="l1.1405" class="difflineminus">-    m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l1.1406"></a><span id="l1.1406" class="difflineminus">-    return status;</span>
<a href="#l1.1407"></a><span id="l1.1407" class="difflineminus">-}</span>
<a href="#l1.1408"></a><span id="l1.1408" class="difflineminus">-</span>
<a href="#l1.1409"></a><span id="l1.1409" class="difflineminus">-</span>
<a href="#l1.1410"></a><span id="l1.1410" class="difflineminus">-nsresult nsSmtpProtocol::SendTLSResponse()</span>
<a href="#l1.1411"></a><span id="l1.1411" class="difflineminus">-{</span>
<a href="#l1.1412"></a><span id="l1.1412" class="difflineminus">-  // only tear down our existing connection and open a new one if we received a 220 response</span>
<a href="#l1.1413"></a><span id="l1.1413" class="difflineminus">-  // from the smtp server after we issued the STARTTLS</span>
<a href="#l1.1414"></a><span id="l1.1414" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l1.1415"></a><span id="l1.1415" class="difflineminus">-  if (m_responseCode == 220)</span>
<a href="#l1.1416"></a><span id="l1.1416" class="difflineminus">-  {</span>
<a href="#l1.1417"></a><span id="l1.1417" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; secInfo;</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineminus">-      nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport, &amp;rv);</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineminus">-</span>
<a href="#l1.1421"></a><span id="l1.1421" class="difflineminus">-      rv = strans-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<a href="#l1.1422"></a><span id="l1.1422" class="difflineminus">-</span>
<a href="#l1.1423"></a><span id="l1.1423" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; secInfo) {</span>
<a href="#l1.1424"></a><span id="l1.1424" class="difflineminus">-          nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl = do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l1.1425"></a><span id="l1.1425" class="difflineminus">-</span>
<a href="#l1.1426"></a><span id="l1.1426" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; sslControl)</span>
<a href="#l1.1427"></a><span id="l1.1427" class="difflineminus">-              rv = sslControl-&gt;StartTLS();</span>
<a href="#l1.1428"></a><span id="l1.1428" class="difflineminus">-      }</span>
<a href="#l1.1429"></a><span id="l1.1429" class="difflineminus">-</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineminus">-      {</span>
<a href="#l1.1432"></a><span id="l1.1432" class="difflineminus">-          m_nextState = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.1433"></a><span id="l1.1433" class="difflineminus">-          m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.1434"></a><span id="l1.1434" class="difflineminus">-          m_tlsEnabled = true;</span>
<a href="#l1.1435"></a><span id="l1.1435" class="difflineminus">-          m_flags = 0; // resetting the flags</span>
<a href="#l1.1436"></a><span id="l1.1436" class="difflineminus">-          return rv;</span>
<a href="#l1.1437"></a><span id="l1.1437" class="difflineminus">-      }</span>
<a href="#l1.1438"></a><span id="l1.1438" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.1439"></a><span id="l1.1439" class="difflineplus">+      m_nextState = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.1440"></a><span id="l1.1440" class="difflineplus">+      m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.1441"></a><span id="l1.1441" class="difflineplus">+      m_tlsEnabled = true;</span>
<a href="#l1.1442"></a><span id="l1.1442" class="difflineplus">+      m_flags = 0;  // resetting the flags</span>
<a href="#l1.1443"></a><span id="l1.1443" class="difflineplus">+      return rv;</span>
<a href="#l1.1444"></a><span id="l1.1444" class="difflineplus">+    }</span>
<a href="#l1.1445"></a><span id="l1.1445">   }</span>
<a href="#l1.1446"></a><span id="l1.1446"> </span>
<a href="#l1.1447"></a><span id="l1.1447">   ClearFlag(SMTP_EHLO_STARTTLS_ENABLED);</span>
<a href="#l1.1448"></a><span id="l1.1448">   m_tlsInitiated = false;</span>
<a href="#l1.1449"></a><span id="l1.1449">   m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l1.1450"></a><span id="l1.1450"> </span>
<a href="#l1.1451"></a><span id="l1.1451">   return rv;</span>
<a href="#l1.1452"></a><span id="l1.1452"> }</span>
<a href="#l1.1453"></a><span id="l1.1453"> </span>
<a href="#l1.1454"></a><span id="l1.1454" class="difflineminus">-nsresult nsSmtpProtocol::SendClientIDResponse()</span>
<a href="#l1.1455"></a><span id="l1.1455" class="difflineminus">-{</span>
<a href="#l1.1456"></a><span id="l1.1456" class="difflineminus">-  if (m_responseCode/10 == 25)</span>
<a href="#l1.1457"></a><span id="l1.1457" class="difflineminus">-  {</span>
<a href="#l1.1458"></a><span id="l1.1458" class="difflineplus">+nsresult nsSmtpProtocol::SendClientIDResponse() {</span>
<a href="#l1.1459"></a><span id="l1.1459" class="difflineplus">+  if (m_responseCode / 10 == 25) {</span>
<a href="#l1.1460"></a><span id="l1.1460">     // ClientID success!</span>
<a href="#l1.1461"></a><span id="l1.1461">     m_clientIDInitialized = true;</span>
<a href="#l1.1462"></a><span id="l1.1462">     ClearFlag(SMTP_EHLO_CLIENTID_ENABLED);</span>
<a href="#l1.1463"></a><span id="l1.1463">     m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l1.1464"></a><span id="l1.1464">     return NS_OK;</span>
<a href="#l1.1465"></a><span id="l1.1465">   }</span>
<a href="#l1.1466"></a><span id="l1.1466">   // ClientID failed</span>
<a href="#l1.1467"></a><span id="l1.1467">   nsresult errorCode;</span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineminus">-  if (m_responseCode == 550)</span>
<a href="#l1.1469"></a><span id="l1.1469" class="difflineminus">-  {</span>
<a href="#l1.1470"></a><span id="l1.1470" class="difflineplus">+  if (m_responseCode == 550) {</span>
<a href="#l1.1471"></a><span id="l1.1471">     // 'You are not permitted to access this'</span>
<a href="#l1.1472"></a><span id="l1.1472">     // 'Access Denied' + server response</span>
<a href="#l1.1473"></a><span id="l1.1473">     errorCode = NS_ERROR_CLIENTID_PERMISSION;</span>
<a href="#l1.1474"></a><span id="l1.1474" class="difflineminus">-  }</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineminus">-  else</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineminus">-  {</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineminus">-    if (MOZ_LOG_TEST(SMTPLogModule, mozilla::LogLevel::Error))</span>
<a href="#l1.1478"></a><span id="l1.1478" class="difflineminus">-    {</span>
<a href="#l1.1479"></a><span id="l1.1479" class="difflineplus">+  } else {</span>
<a href="#l1.1480"></a><span id="l1.1480" class="difflineplus">+    if (MOZ_LOG_TEST(SMTPLogModule, mozilla::LogLevel::Error)) {</span>
<a href="#l1.1481"></a><span id="l1.1481">       if (m_responseCode != 501 &amp;&amp; m_responseCode != 503 &amp;&amp;</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineminus">-          m_responseCode != 504 &amp;&amp; m_responseCode/100 != 4)</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineminus">-      {</span>
<a href="#l1.1484"></a><span id="l1.1484" class="difflineplus">+          m_responseCode != 504 &amp;&amp; m_responseCode / 100 != 4) {</span>
<a href="#l1.1485"></a><span id="l1.1485">         // If not 501, 503, 504 or 4xx, log an error.</span>
<a href="#l1.1486"></a><span id="l1.1486">         MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1487"></a><span id="l1.1487" class="difflineminus">-                (&quot;SendClientIDResponse: Unexpected error occurred, server responded: %s\n&quot;,</span>
<a href="#l1.1488"></a><span id="l1.1488" class="difflineminus">-                m_responseText.get()));</span>
<a href="#l1.1489"></a><span id="l1.1489" class="difflineplus">+                (&quot;SendClientIDResponse: Unexpected error occurred, server &quot;</span>
<a href="#l1.1490"></a><span id="l1.1490" class="difflineplus">+                 &quot;responded: %s\n&quot;,</span>
<a href="#l1.1491"></a><span id="l1.1491" class="difflineplus">+                 m_responseText.get()));</span>
<a href="#l1.1492"></a><span id="l1.1492">       }</span>
<a href="#l1.1493"></a><span id="l1.1493">     }</span>
<a href="#l1.1494"></a><span id="l1.1494">     errorCode = NS_ERROR_CLIENTID;</span>
<a href="#l1.1495"></a><span id="l1.1495">   }</span>
<a href="#l1.1496"></a><span id="l1.1496">   nsExplainErrorDetails(m_runningURL, errorCode, m_responseText.get(), nullptr);</span>
<a href="#l1.1497"></a><span id="l1.1497">   m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.1498"></a><span id="l1.1498">   return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.1499"></a><span id="l1.1499"> }</span>
<a href="#l1.1500"></a><span id="l1.1500"> </span>
<a href="#l1.1501"></a><span id="l1.1501" class="difflineminus">-void nsSmtpProtocol::InitPrefAuthMethods(int32_t authMethodPrefValue)</span>
<a href="#l1.1502"></a><span id="l1.1502" class="difflineminus">-{</span>
<a href="#l1.1503"></a><span id="l1.1503" class="difflineplus">+void nsSmtpProtocol::InitPrefAuthMethods(int32_t authMethodPrefValue) {</span>
<a href="#l1.1504"></a><span id="l1.1504">   // for m_prefAuthMethods, using the same flags as server capabilities.</span>
<a href="#l1.1505"></a><span id="l1.1505" class="difflineminus">-  switch (authMethodPrefValue)</span>
<a href="#l1.1506"></a><span id="l1.1506" class="difflineminus">-  {</span>
<a href="#l1.1507"></a><span id="l1.1507" class="difflineplus">+  switch (authMethodPrefValue) {</span>
<a href="#l1.1508"></a><span id="l1.1508">     case nsMsgAuthMethod::none:</span>
<a href="#l1.1509"></a><span id="l1.1509">       m_prefAuthMethods = SMTP_AUTH_NONE_ENABLED;</span>
<a href="#l1.1510"></a><span id="l1.1510">       break;</span>
<a href="#l1.1511"></a><span id="l1.1511" class="difflineminus">-    //case nsMsgAuthMethod::old -- no such thing for SMTP</span>
<a href="#l1.1512"></a><span id="l1.1512" class="difflineplus">+    // case nsMsgAuthMethod::old -- no such thing for SMTP</span>
<a href="#l1.1513"></a><span id="l1.1513">     case nsMsgAuthMethod::passwordCleartext:</span>
<a href="#l1.1514"></a><span id="l1.1514" class="difflineminus">-      m_prefAuthMethods = SMTP_AUTH_LOGIN_ENABLED |</span>
<a href="#l1.1515"></a><span id="l1.1515" class="difflineminus">-        SMTP_AUTH_PLAIN_ENABLED;</span>
<a href="#l1.1516"></a><span id="l1.1516" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED;</span>
<a href="#l1.1517"></a><span id="l1.1517">       break;</span>
<a href="#l1.1518"></a><span id="l1.1518">     case nsMsgAuthMethod::passwordEncrypted:</span>
<a href="#l1.1519"></a><span id="l1.1519">       m_prefAuthMethods = SMTP_AUTH_CRAM_MD5_ENABLED;</span>
<a href="#l1.1520"></a><span id="l1.1520">       break;</span>
<a href="#l1.1521"></a><span id="l1.1521">     case nsMsgAuthMethod::NTLM:</span>
<a href="#l1.1522"></a><span id="l1.1522" class="difflineminus">-      m_prefAuthMethods = SMTP_AUTH_NTLM_ENABLED |</span>
<a href="#l1.1523"></a><span id="l1.1523" class="difflineminus">-          SMTP_AUTH_MSN_ENABLED;</span>
<a href="#l1.1524"></a><span id="l1.1524" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED;</span>
<a href="#l1.1525"></a><span id="l1.1525">       break;</span>
<a href="#l1.1526"></a><span id="l1.1526">     case nsMsgAuthMethod::GSSAPI:</span>
<a href="#l1.1527"></a><span id="l1.1527">       m_prefAuthMethods = SMTP_AUTH_GSSAPI_ENABLED;</span>
<a href="#l1.1528"></a><span id="l1.1528">       break;</span>
<a href="#l1.1529"></a><span id="l1.1529">     case nsMsgAuthMethod::OAuth2:</span>
<a href="#l1.1530"></a><span id="l1.1530">       m_prefAuthMethods = SMTP_AUTH_OAUTH2_ENABLED;</span>
<a href="#l1.1531"></a><span id="l1.1531">       break;</span>
<a href="#l1.1532"></a><span id="l1.1532">     case nsMsgAuthMethod::secure:</span>
<a href="#l1.1533"></a><span id="l1.1533" class="difflineminus">-      m_prefAuthMethods = SMTP_AUTH_CRAM_MD5_ENABLED |</span>
<a href="#l1.1534"></a><span id="l1.1534" class="difflineminus">-          SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l1.1535"></a><span id="l1.1535" class="difflineplus">+      m_prefAuthMethods =</span>
<a href="#l1.1536"></a><span id="l1.1536" class="difflineplus">+          SMTP_AUTH_CRAM_MD5_ENABLED | SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l1.1537"></a><span id="l1.1537">           SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED |</span>
<a href="#l1.1538"></a><span id="l1.1538" class="difflineminus">-          SMTP_AUTH_EXTERNAL_ENABLED; // TODO: Expose EXTERNAL? How?</span>
<a href="#l1.1539"></a><span id="l1.1539" class="difflineplus">+          SMTP_AUTH_EXTERNAL_ENABLED;  // TODO: Expose EXTERNAL? How?</span>
<a href="#l1.1540"></a><span id="l1.1540">       break;</span>
<a href="#l1.1541"></a><span id="l1.1541">     default:</span>
<a href="#l1.1542"></a><span id="l1.1542">       NS_ASSERTION(false, &quot;SMTP: authMethod pref invalid&quot;);</span>
<a href="#l1.1543"></a><span id="l1.1543">       // TODO log to error console</span>
<a href="#l1.1544"></a><span id="l1.1544">       MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineminus">-          (&quot;SMTP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l1.1546"></a><span id="l1.1546" class="difflineplus">+              (&quot;SMTP: bad pref authMethod = %d\n&quot;, authMethodPrefValue));</span>
<a href="#l1.1547"></a><span id="l1.1547">       // fall to any</span>
<a href="#l1.1548"></a><span id="l1.1548">       MOZ_FALLTHROUGH;</span>
<a href="#l1.1549"></a><span id="l1.1549">     case nsMsgAuthMethod::anything:</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineminus">-      m_prefAuthMethods =</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineminus">-          SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED |</span>
<a href="#l1.1552"></a><span id="l1.1552" class="difflineminus">-          SMTP_AUTH_CRAM_MD5_ENABLED | SMTP_AUTH_GSSAPI_ENABLED |</span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineminus">-          SMTP_AUTH_NTLM_ENABLED | SMTP_AUTH_MSN_ENABLED |</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineminus">-          SMTP_AUTH_OAUTH2_ENABLED |</span>
<a href="#l1.1555"></a><span id="l1.1555" class="difflineminus">-          SMTP_AUTH_EXTERNAL_ENABLED;</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineplus">+      m_prefAuthMethods = SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED |</span>
<a href="#l1.1557"></a><span id="l1.1557" class="difflineplus">+                          SMTP_AUTH_CRAM_MD5_ENABLED |</span>
<a href="#l1.1558"></a><span id="l1.1558" class="difflineplus">+                          SMTP_AUTH_GSSAPI_ENABLED | SMTP_AUTH_NTLM_ENABLED |</span>
<a href="#l1.1559"></a><span id="l1.1559" class="difflineplus">+                          SMTP_AUTH_MSN_ENABLED | SMTP_AUTH_OAUTH2_ENABLED |</span>
<a href="#l1.1560"></a><span id="l1.1560" class="difflineplus">+                          SMTP_AUTH_EXTERNAL_ENABLED;</span>
<a href="#l1.1561"></a><span id="l1.1561">       break;</span>
<a href="#l1.1562"></a><span id="l1.1562">   }</span>
<a href="#l1.1563"></a><span id="l1.1563"> </span>
<a href="#l1.1564"></a><span id="l1.1564">   // Only enable OAuth2 support if we can do the lookup.</span>
<a href="#l1.1565"></a><span id="l1.1565">   if ((m_prefAuthMethods &amp; SMTP_AUTH_OAUTH2_ENABLED) &amp;&amp; !mOAuth2Support)</span>
<a href="#l1.1566"></a><span id="l1.1566">     m_prefAuthMethods &amp;= ~SMTP_AUTH_OAUTH2_ENABLED;</span>
<a href="#l1.1567"></a><span id="l1.1567"> </span>
<a href="#l1.1568"></a><span id="l1.1568">   NS_ASSERTION(m_prefAuthMethods != 0, &quot;SMTP:InitPrefAuthMethods() failed&quot;);</span>
<a href="#l1.1569"></a><span id="l1.1569"> }</span>
<a href="#l1.1570"></a><span id="l1.1570"> </span>
<a href="#l1.1571"></a><span id="l1.1571"> /**</span>
<a href="#l1.1572"></a><span id="l1.1572">  * Changes m_currentAuthMethod to pick the next-best one</span>
<a href="#l1.1573"></a><span id="l1.1573">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l1.1574"></a><span id="l1.1574">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l1.1575"></a><span id="l1.1575">  */</span>
<a href="#l1.1576"></a><span id="l1.1576" class="difflineminus">-nsresult nsSmtpProtocol::ChooseAuthMethod()</span>
<a href="#l1.1577"></a><span id="l1.1577" class="difflineminus">-{</span>
<a href="#l1.1578"></a><span id="l1.1578" class="difflineminus">-  int32_t serverCaps = m_flags; // from nsMsgProtocol::TestFlag()</span>
<a href="#l1.1579"></a><span id="l1.1579" class="difflineplus">+nsresult nsSmtpProtocol::ChooseAuthMethod() {</span>
<a href="#l1.1580"></a><span id="l1.1580" class="difflineplus">+  int32_t serverCaps = m_flags;  // from nsMsgProtocol::TestFlag()</span>
<a href="#l1.1581"></a><span id="l1.1581">   int32_t availCaps = serverCaps &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l1.1582"></a><span id="l1.1582"> </span>
<a href="#l1.1583"></a><span id="l1.1583" class="difflineplus">+  // clang-format off</span>
<a href="#l1.1584"></a><span id="l1.1584">   MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.1585"></a><span id="l1.1585" class="difflineminus">-        (&quot;SMTP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l1.1586"></a><span id="l1.1586" class="difflineminus">-        serverCaps, m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l1.1587"></a><span id="l1.1587" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel:: Debug,</span>
<a href="#l1.1588"></a><span id="l1.1588" class="difflineminus">-        (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l1.1589"></a><span id="l1.1589" class="difflineminus">-        &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, EXTERNAL = 0x%X)&quot;,</span>
<a href="#l1.1590"></a><span id="l1.1590" class="difflineminus">-        SMTP_AUTH_GSSAPI_ENABLED, SMTP_AUTH_CRAM_MD5_ENABLED,</span>
<a href="#l1.1591"></a><span id="l1.1591" class="difflineminus">-        SMTP_AUTH_NTLM_ENABLED, SMTP_AUTH_MSN_ENABLED, SMTP_AUTH_PLAIN_ENABLED,</span>
<a href="#l1.1592"></a><span id="l1.1592" class="difflineminus">-        SMTP_AUTH_LOGIN_ENABLED, SMTP_AUTH_EXTERNAL_ENABLED));</span>
<a href="#l1.1593"></a><span id="l1.1593" class="difflineplus">+          (&quot;SMTP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;,</span>
<a href="#l1.1594"></a><span id="l1.1594" class="difflineplus">+           serverCaps, m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l1.1595"></a><span id="l1.1595" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.1596"></a><span id="l1.1596" class="difflineplus">+          (&quot;(GSSAPI = 0x%X, CRAM = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l1.1597"></a><span id="l1.1597" class="difflineplus">+           &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, EXTERNAL = 0x%X)&quot;,</span>
<a href="#l1.1598"></a><span id="l1.1598" class="difflineplus">+           SMTP_AUTH_GSSAPI_ENABLED, SMTP_AUTH_CRAM_MD5_ENABLED,</span>
<a href="#l1.1599"></a><span id="l1.1599" class="difflineplus">+           SMTP_AUTH_NTLM_ENABLED, SMTP_AUTH_MSN_ENABLED, SMTP_AUTH_PLAIN_ENABLED,</span>
<a href="#l1.1600"></a><span id="l1.1600" class="difflineplus">+           SMTP_AUTH_LOGIN_ENABLED, SMTP_AUTH_EXTERNAL_ENABLED));</span>
<a href="#l1.1601"></a><span id="l1.1601" class="difflineplus">+  // clang-format on</span>
<a href="#l1.1602"></a><span id="l1.1602"> </span>
<a href="#l1.1603"></a><span id="l1.1603">   if (SMTP_AUTH_GSSAPI_ENABLED &amp; availCaps)</span>
<a href="#l1.1604"></a><span id="l1.1604">     m_currentAuthMethod = SMTP_AUTH_GSSAPI_ENABLED;</span>
<a href="#l1.1605"></a><span id="l1.1605">   else if (SMTP_AUTH_CRAM_MD5_ENABLED &amp; availCaps)</span>
<a href="#l1.1606"></a><span id="l1.1606">     m_currentAuthMethod = SMTP_AUTH_CRAM_MD5_ENABLED;</span>
<a href="#l1.1607"></a><span id="l1.1607">   else if (SMTP_AUTH_NTLM_ENABLED &amp; availCaps)</span>
<a href="#l1.1608"></a><span id="l1.1608">     m_currentAuthMethod = SMTP_AUTH_NTLM_ENABLED;</span>
<a href="#l1.1609"></a><span id="l1.1609">   else if (SMTP_AUTH_MSN_ENABLED &amp; availCaps)</span>
<a href="#l1.1610"></a><span id="l1.1610" class="difflineat">@@ -1153,227 +1071,198 @@ nsresult nsSmtpProtocol::ChooseAuthMetho</span>
<a href="#l1.1611"></a><span id="l1.1611">   else if (SMTP_AUTH_OAUTH2_ENABLED &amp; availCaps)</span>
<a href="#l1.1612"></a><span id="l1.1612">     m_currentAuthMethod = SMTP_AUTH_OAUTH2_ENABLED;</span>
<a href="#l1.1613"></a><span id="l1.1613">   else if (SMTP_AUTH_PLAIN_ENABLED &amp; availCaps)</span>
<a href="#l1.1614"></a><span id="l1.1614">     m_currentAuthMethod = SMTP_AUTH_PLAIN_ENABLED;</span>
<a href="#l1.1615"></a><span id="l1.1615">   else if (SMTP_AUTH_LOGIN_ENABLED &amp; availCaps)</span>
<a href="#l1.1616"></a><span id="l1.1616">     m_currentAuthMethod = SMTP_AUTH_LOGIN_ENABLED;</span>
<a href="#l1.1617"></a><span id="l1.1617">   else if (SMTP_AUTH_EXTERNAL_ENABLED &amp; availCaps)</span>
<a href="#l1.1618"></a><span id="l1.1618">     m_currentAuthMethod = SMTP_AUTH_EXTERNAL_ENABLED;</span>
<a href="#l1.1619"></a><span id="l1.1619" class="difflineminus">-  else</span>
<a href="#l1.1620"></a><span id="l1.1620" class="difflineminus">-  {</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineminus">-    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;no auth method remaining&quot;));</span>
<a href="#l1.1622"></a><span id="l1.1622" class="difflineplus">+  else {</span>
<a href="#l1.1623"></a><span id="l1.1623" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1624"></a><span id="l1.1624" class="difflineplus">+            (&quot;no auth method remaining&quot;));</span>
<a href="#l1.1625"></a><span id="l1.1625">     m_currentAuthMethod = 0;</span>
<a href="#l1.1626"></a><span id="l1.1626">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.1627"></a><span id="l1.1627">   }</span>
<a href="#l1.1628"></a><span id="l1.1628" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l1.1629"></a><span id="l1.1629" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.1630"></a><span id="l1.1630" class="difflineplus">+          (&quot;trying auth method 0x%X&quot;, m_currentAuthMethod));</span>
<a href="#l1.1631"></a><span id="l1.1631">   return NS_OK;</span>
<a href="#l1.1632"></a><span id="l1.1632"> }</span>
<a href="#l1.1633"></a><span id="l1.1633"> </span>
<a href="#l1.1634"></a><span id="l1.1634" class="difflineminus">-void nsSmtpProtocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod)</span>
<a href="#l1.1635"></a><span id="l1.1635" class="difflineminus">-{</span>
<a href="#l1.1636"></a><span id="l1.1636" class="difflineplus">+void nsSmtpProtocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod) {</span>
<a href="#l1.1637"></a><span id="l1.1637">   MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.1638"></a><span id="l1.1638" class="difflineminus">-      (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l1.1639"></a><span id="l1.1639" class="difflineplus">+          (&quot;marking auth method 0x%X failed&quot;, failedAuthMethod));</span>
<a href="#l1.1640"></a><span id="l1.1640">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l1.1641"></a><span id="l1.1641"> }</span>
<a href="#l1.1642"></a><span id="l1.1642"> </span>
<a href="#l1.1643"></a><span id="l1.1643"> /**</span>
<a href="#l1.1644"></a><span id="l1.1644">  * Start over, trying all auth methods again</span>
<a href="#l1.1645"></a><span id="l1.1645">  */</span>
<a href="#l1.1646"></a><span id="l1.1646" class="difflineminus">-void nsSmtpProtocol::ResetAuthMethods()</span>
<a href="#l1.1647"></a><span id="l1.1647" class="difflineminus">-{</span>
<a href="#l1.1648"></a><span id="l1.1648" class="difflineplus">+void nsSmtpProtocol::ResetAuthMethods() {</span>
<a href="#l1.1649"></a><span id="l1.1649">   m_currentAuthMethod = 0;</span>
<a href="#l1.1650"></a><span id="l1.1650">   m_failedAuthMethods = 0;</span>
<a href="#l1.1651"></a><span id="l1.1651"> }</span>
<a href="#l1.1652"></a><span id="l1.1652"> </span>
<a href="#l1.1653"></a><span id="l1.1653" class="difflineminus">-nsresult nsSmtpProtocol::ProcessAuth()</span>
<a href="#l1.1654"></a><span id="l1.1654" class="difflineminus">-{</span>
<a href="#l1.1655"></a><span id="l1.1655" class="difflineminus">-    nsresult status = NS_OK;</span>
<a href="#l1.1656"></a><span id="l1.1656" class="difflineminus">-    nsAutoCString buffer;</span>
<a href="#l1.1657"></a><span id="l1.1657" class="difflineplus">+nsresult nsSmtpProtocol::ProcessAuth() {</span>
<a href="#l1.1658"></a><span id="l1.1658" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l1.1659"></a><span id="l1.1659" class="difflineplus">+  nsAutoCString buffer;</span>
<a href="#l1.1660"></a><span id="l1.1660" class="difflineplus">+</span>
<a href="#l1.1661"></a><span id="l1.1661" class="difflineplus">+  if (!m_tlsEnabled) {</span>
<a href="#l1.1662"></a><span id="l1.1662" class="difflineplus">+    if (TestFlag(SMTP_EHLO_STARTTLS_ENABLED)) {</span>
<a href="#l1.1663"></a><span id="l1.1663" class="difflineplus">+      // Do not try to combine SMTPS with STARTTLS.</span>
<a href="#l1.1664"></a><span id="l1.1664" class="difflineplus">+      // If nsMsgSocketType::SSL is set,</span>
<a href="#l1.1665"></a><span id="l1.1665" class="difflineplus">+      // we are already using a secure connection.</span>
<a href="#l1.1666"></a><span id="l1.1666" class="difflineplus">+      // Do not attempt to do STARTTLS,</span>
<a href="#l1.1667"></a><span id="l1.1667" class="difflineplus">+      // even if server offers it.</span>
<a href="#l1.1668"></a><span id="l1.1668" class="difflineplus">+      if (m_prefSocketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l1.1669"></a><span id="l1.1669" class="difflineplus">+          m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS) {</span>
<a href="#l1.1670"></a><span id="l1.1670" class="difflineplus">+        buffer = &quot;STARTTLS&quot;;</span>
<a href="#l1.1671"></a><span id="l1.1671" class="difflineplus">+        buffer += CRLF;</span>
<a href="#l1.1672"></a><span id="l1.1672"> </span>
<a href="#l1.1673"></a><span id="l1.1673" class="difflineminus">-    if (!m_tlsEnabled)</span>
<a href="#l1.1674"></a><span id="l1.1674" class="difflineminus">-    {</span>
<a href="#l1.1675"></a><span id="l1.1675" class="difflineminus">-        if (TestFlag(SMTP_EHLO_STARTTLS_ENABLED))</span>
<a href="#l1.1676"></a><span id="l1.1676" class="difflineminus">-        {</span>
<a href="#l1.1677"></a><span id="l1.1677" class="difflineminus">-            // Do not try to combine SMTPS with STARTTLS.</span>
<a href="#l1.1678"></a><span id="l1.1678" class="difflineminus">-            // If nsMsgSocketType::SSL is set,</span>
<a href="#l1.1679"></a><span id="l1.1679" class="difflineminus">-            // we are already using a secure connection.</span>
<a href="#l1.1680"></a><span id="l1.1680" class="difflineminus">-            // Do not attempt to do STARTTLS,</span>
<a href="#l1.1681"></a><span id="l1.1681" class="difflineminus">-            // even if server offers it.</span>
<a href="#l1.1682"></a><span id="l1.1682" class="difflineminus">-            if (m_prefSocketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l1.1683"></a><span id="l1.1683" class="difflineminus">-                m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l1.1684"></a><span id="l1.1684" class="difflineminus">-            {</span>
<a href="#l1.1685"></a><span id="l1.1685" class="difflineminus">-                buffer = &quot;STARTTLS&quot;;</span>
<a href="#l1.1686"></a><span id="l1.1686" class="difflineminus">-                buffer += CRLF;</span>
<a href="#l1.1687"></a><span id="l1.1687" class="difflineplus">+        status = SendData(buffer.get());</span>
<a href="#l1.1688"></a><span id="l1.1688" class="difflineplus">+</span>
<a href="#l1.1689"></a><span id="l1.1689" class="difflineplus">+        m_tlsInitiated = true;</span>
<a href="#l1.1690"></a><span id="l1.1690"> </span>
<a href="#l1.1691"></a><span id="l1.1691" class="difflineminus">-                status = SendData(buffer.get());</span>
<a href="#l1.1692"></a><span id="l1.1692" class="difflineminus">-</span>
<a href="#l1.1693"></a><span id="l1.1693" class="difflineminus">-                m_tlsInitiated = true;</span>
<a href="#l1.1694"></a><span id="l1.1694" class="difflineminus">-</span>
<a href="#l1.1695"></a><span id="l1.1695" class="difflineminus">-                m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1696"></a><span id="l1.1696" class="difflineminus">-                m_nextStateAfterResponse = SMTP_TLS_RESPONSE;</span>
<a href="#l1.1697"></a><span id="l1.1697" class="difflineminus">-                SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1698"></a><span id="l1.1698" class="difflineminus">-                return status;</span>
<a href="#l1.1699"></a><span id="l1.1699" class="difflineminus">-            }</span>
<a href="#l1.1700"></a><span id="l1.1700" class="difflineminus">-        }</span>
<a href="#l1.1701"></a><span id="l1.1701" class="difflineminus">-        else if (m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l1.1702"></a><span id="l1.1702" class="difflineminus">-        {</span>
<a href="#l1.1703"></a><span id="l1.1703" class="difflineminus">-            m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineminus">-            m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineminus">-            return NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l1.1706"></a><span id="l1.1706" class="difflineminus">-        }</span>
<a href="#l1.1707"></a><span id="l1.1707" class="difflineplus">+        m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1708"></a><span id="l1.1708" class="difflineplus">+        m_nextStateAfterResponse = SMTP_TLS_RESPONSE;</span>
<a href="#l1.1709"></a><span id="l1.1709" class="difflineplus">+        SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1710"></a><span id="l1.1710" class="difflineplus">+        return status;</span>
<a href="#l1.1711"></a><span id="l1.1711" class="difflineplus">+      }</span>
<a href="#l1.1712"></a><span id="l1.1712" class="difflineplus">+    } else if (m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS) {</span>
<a href="#l1.1713"></a><span id="l1.1713" class="difflineplus">+      m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.1714"></a><span id="l1.1714" class="difflineplus">+      m_urlErrorState = NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l1.1715"></a><span id="l1.1715" class="difflineplus">+      return NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS;</span>
<a href="#l1.1716"></a><span id="l1.1716">     }</span>
<a href="#l1.1717"></a><span id="l1.1717" class="difflineplus">+  }</span>
<a href="#l1.1718"></a><span id="l1.1718">   // (wrong indentation until here)</span>
<a href="#l1.1719"></a><span id="l1.1719"> </span>
<a href="#l1.1720"></a><span id="l1.1720" class="difflineminus">-  if (!m_clientIDInitialized &amp;&amp; m_tlsEnabled &amp;&amp; !m_clientId.IsEmpty())</span>
<a href="#l1.1721"></a><span id="l1.1721" class="difflineminus">-  {</span>
<a href="#l1.1722"></a><span id="l1.1722" class="difflineminus">-    if (TestFlag(SMTP_EHLO_CLIENTID_ENABLED))</span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineminus">-    {</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineplus">+  if (!m_clientIDInitialized &amp;&amp; m_tlsEnabled &amp;&amp; !m_clientId.IsEmpty()) {</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineplus">+    if (TestFlag(SMTP_EHLO_CLIENTID_ENABLED)) {</span>
<a href="#l1.1726"></a><span id="l1.1726">       buffer = &quot;CLIENTID TB-UUID &quot;;</span>
<a href="#l1.1727"></a><span id="l1.1727">       buffer += m_clientId;</span>
<a href="#l1.1728"></a><span id="l1.1728">       buffer += CRLF;</span>
<a href="#l1.1729"></a><span id="l1.1729"> </span>
<a href="#l1.1730"></a><span id="l1.1730">       status = SendData(buffer.get());</span>
<a href="#l1.1731"></a><span id="l1.1731"> </span>
<a href="#l1.1732"></a><span id="l1.1732">       m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1733"></a><span id="l1.1733">       m_nextStateAfterResponse = SMTP_CLIENTID_RESPONSE;</span>
<a href="#l1.1734"></a><span id="l1.1734">       SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1735"></a><span id="l1.1735">       return status;</span>
<a href="#l1.1736"></a><span id="l1.1736">     }</span>
<a href="#l1.1737"></a><span id="l1.1737">   }</span>
<a href="#l1.1738"></a><span id="l1.1738"> </span>
<a href="#l1.1739"></a><span id="l1.1739" class="difflineminus">-  (void) ChooseAuthMethod(); // advance m_currentAuthMethod</span>
<a href="#l1.1740"></a><span id="l1.1740" class="difflineplus">+  (void)ChooseAuthMethod();  // advance m_currentAuthMethod</span>
<a href="#l1.1741"></a><span id="l1.1741"> </span>
<a href="#l1.1742"></a><span id="l1.1742" class="difflineminus">-   // We don't need to auth, per pref, or the server doesn't advertise AUTH,</span>
<a href="#l1.1743"></a><span id="l1.1743" class="difflineplus">+  // We don't need to auth, per pref, or the server doesn't advertise AUTH,</span>
<a href="#l1.1744"></a><span id="l1.1744">   // so skip auth and try to send message.</span>
<a href="#l1.1745"></a><span id="l1.1745" class="difflineminus">-  if (m_prefAuthMethods == SMTP_AUTH_NONE_ENABLED || !TestFlag(SMTP_AUTH))</span>
<a href="#l1.1746"></a><span id="l1.1746" class="difflineminus">-  {</span>
<a href="#l1.1747"></a><span id="l1.1747" class="difflineplus">+  if (m_prefAuthMethods == SMTP_AUTH_NONE_ENABLED || !TestFlag(SMTP_AUTH)) {</span>
<a href="#l1.1748"></a><span id="l1.1748">     m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l1.1749"></a><span id="l1.1749">     // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l1.1750"></a><span id="l1.1750">     m_responseCode = 250;</span>
<a href="#l1.1751"></a><span id="l1.1751" class="difflineminus">-  }</span>
<a href="#l1.1752"></a><span id="l1.1752" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_EXTERNAL_ENABLED)</span>
<a href="#l1.1753"></a><span id="l1.1753" class="difflineminus">-  {</span>
<a href="#l1.1754"></a><span id="l1.1754" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_EXTERNAL_ENABLED) {</span>
<a href="#l1.1755"></a><span id="l1.1755">     buffer = &quot;AUTH EXTERNAL =&quot;;</span>
<a href="#l1.1756"></a><span id="l1.1756">     buffer += CRLF;</span>
<a href="#l1.1757"></a><span id="l1.1757">     SendData(buffer.get());</span>
<a href="#l1.1758"></a><span id="l1.1758">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.1759"></a><span id="l1.1759">     m_nextStateAfterResponse = SMTP_AUTH_EXTERNAL_RESPONSE;</span>
<a href="#l1.1760"></a><span id="l1.1760">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.1761"></a><span id="l1.1761">     return NS_OK;</span>
<a href="#l1.1762"></a><span id="l1.1762" class="difflineminus">-  }</span>
<a href="#l1.1763"></a><span id="l1.1763" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED)</span>
<a href="#l1.1764"></a><span id="l1.1764" class="difflineminus">-  {</span>
<a href="#l1.1765"></a><span id="l1.1765" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED) {</span>
<a href="#l1.1766"></a><span id="l1.1766">     m_nextState = SMTP_SEND_AUTH_GSSAPI_FIRST;</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineminus">-  }</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED ||</span>
<a href="#l1.1769"></a><span id="l1.1769" class="difflineminus">-           m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED ||</span>
<a href="#l1.1770"></a><span id="l1.1770" class="difflineminus">-           m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED)</span>
<a href="#l1.1771"></a><span id="l1.1771" class="difflineminus">-  {</span>
<a href="#l1.1772"></a><span id="l1.1772" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED ||</span>
<a href="#l1.1773"></a><span id="l1.1773" class="difflineplus">+             m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED ||</span>
<a href="#l1.1774"></a><span id="l1.1774" class="difflineplus">+             m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED) {</span>
<a href="#l1.1775"></a><span id="l1.1775">     m_nextState = SMTP_SEND_AUTH_LOGIN_STEP1;</span>
<a href="#l1.1776"></a><span id="l1.1776" class="difflineminus">-  }</span>
<a href="#l1.1777"></a><span id="l1.1777" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED ||</span>
<a href="#l1.1778"></a><span id="l1.1778" class="difflineminus">-           m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l1.1779"></a><span id="l1.1779" class="difflineminus">-  {</span>
<a href="#l1.1780"></a><span id="l1.1780" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED ||</span>
<a href="#l1.1781"></a><span id="l1.1781" class="difflineplus">+             m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED) {</span>
<a href="#l1.1782"></a><span id="l1.1782">     m_nextState = SMTP_SEND_AUTH_LOGIN_STEP0;</span>
<a href="#l1.1783"></a><span id="l1.1783" class="difflineminus">-  }</span>
<a href="#l1.1784"></a><span id="l1.1784" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_OAUTH2_ENABLED)</span>
<a href="#l1.1785"></a><span id="l1.1785" class="difflineminus">-  {</span>
<a href="#l1.1786"></a><span id="l1.1786" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_OAUTH2_ENABLED) {</span>
<a href="#l1.1787"></a><span id="l1.1787">     m_nextState = SMTP_AUTH_OAUTH2_STEP;</span>
<a href="#l1.1788"></a><span id="l1.1788" class="difflineminus">-  }</span>
<a href="#l1.1789"></a><span id="l1.1789" class="difflineminus">-  else // All auth methods failed</span>
<a href="#l1.1790"></a><span id="l1.1790" class="difflineplus">+  } else  // All auth methods failed</span>
<a href="#l1.1791"></a><span id="l1.1791">   {</span>
<a href="#l1.1792"></a><span id="l1.1792">     // show an appropriate error msg</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineminus">-    if (m_failedAuthMethods == 0)</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineminus">-    {</span>
<a href="#l1.1795"></a><span id="l1.1795" class="difflineplus">+    if (m_failedAuthMethods == 0) {</span>
<a href="#l1.1796"></a><span id="l1.1796">       // we didn't even try anything, so we had a non-working config:</span>
<a href="#l1.1797"></a><span id="l1.1797">       // pref doesn't match server</span>
<a href="#l1.1798"></a><span id="l1.1798">       MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1799"></a><span id="l1.1799" class="difflineminus">-          (&quot;no working auth mech - pref doesn't match server capas&quot;));</span>
<a href="#l1.1800"></a><span id="l1.1800" class="difflineplus">+              (&quot;no working auth mech - pref doesn't match server capas&quot;));</span>
<a href="#l1.1801"></a><span id="l1.1801"> </span>
<a href="#l1.1802"></a><span id="l1.1802">       // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l1.1803"></a><span id="l1.1803">       if (m_prefAuthMethods == SMTP_AUTH_CRAM_MD5_ENABLED &amp;&amp;</span>
<a href="#l1.1804"></a><span id="l1.1804" class="difflineminus">-          m_flags &amp; (SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED))</span>
<a href="#l1.1805"></a><span id="l1.1805" class="difflineminus">-      {</span>
<a href="#l1.1806"></a><span id="l1.1806" class="difflineplus">+          m_flags &amp; (SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED)) {</span>
<a href="#l1.1807"></a><span id="l1.1807">         // have SSL</span>
<a href="#l1.1808"></a><span id="l1.1808">         if (m_prefSocketType == nsMsgSocketType::SSL ||</span>
<a href="#l1.1809"></a><span id="l1.1809">             m_prefSocketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l1.1810"></a><span id="l1.1810">           // tell user to change to plaintext pw</span>
<a href="#l1.1811"></a><span id="l1.1811">           m_urlErrorState = NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL;</span>
<a href="#l1.1812"></a><span id="l1.1812">         else</span>
<a href="#l1.1813"></a><span id="l1.1813">           // tell user to change to plaintext pw, with big warning</span>
<a href="#l1.1814"></a><span id="l1.1814">           m_urlErrorState = NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL;</span>
<a href="#l1.1815"></a><span id="l1.1815">       }</span>
<a href="#l1.1816"></a><span id="l1.1816">       // pref has plaintext pw &amp; server claims to support encrypted pw</span>
<a href="#l1.1817"></a><span id="l1.1817" class="difflineminus">-      else if (m_prefAuthMethods == (SMTP_AUTH_LOGIN_ENABLED |</span>
<a href="#l1.1818"></a><span id="l1.1818" class="difflineminus">-                   SMTP_AUTH_PLAIN_ENABLED) &amp;&amp;</span>
<a href="#l1.1819"></a><span id="l1.1819" class="difflineplus">+      else if (m_prefAuthMethods ==</span>
<a href="#l1.1820"></a><span id="l1.1820" class="difflineplus">+                   (SMTP_AUTH_LOGIN_ENABLED | SMTP_AUTH_PLAIN_ENABLED) &amp;&amp;</span>
<a href="#l1.1821"></a><span id="l1.1821">                m_flags &amp; SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l1.1822"></a><span id="l1.1822">         // tell user to change to encrypted pw</span>
<a href="#l1.1823"></a><span id="l1.1823">         m_urlErrorState = NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT;</span>
<a href="#l1.1824"></a><span id="l1.1824" class="difflineminus">-      else</span>
<a href="#l1.1825"></a><span id="l1.1825" class="difflineminus">-      {</span>
<a href="#l1.1826"></a><span id="l1.1826" class="difflineplus">+      else {</span>
<a href="#l1.1827"></a><span id="l1.1827">         // just &quot;change auth method&quot;</span>
<a href="#l1.1828"></a><span id="l1.1828">         m_urlErrorState = NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED;</span>
<a href="#l1.1829"></a><span id="l1.1829">       }</span>
<a href="#l1.1830"></a><span id="l1.1830" class="difflineminus">-    }</span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineminus">-    else if (m_failedAuthMethods == SMTP_AUTH_GSSAPI_ENABLED)</span>
<a href="#l1.1832"></a><span id="l1.1832" class="difflineminus">-    {</span>
<a href="#l1.1833"></a><span id="l1.1833" class="difflineplus">+    } else if (m_failedAuthMethods == SMTP_AUTH_GSSAPI_ENABLED) {</span>
<a href="#l1.1834"></a><span id="l1.1834">       // We have only GSSAPI, and it failed, so nothing left to do.</span>
<a href="#l1.1835"></a><span id="l1.1835" class="difflineminus">-      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;GSSAPI only and it failed&quot;));</span>
<a href="#l1.1836"></a><span id="l1.1836" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1837"></a><span id="l1.1837" class="difflineplus">+              (&quot;GSSAPI only and it failed&quot;));</span>
<a href="#l1.1838"></a><span id="l1.1838">       m_urlErrorState = NS_ERROR_SMTP_AUTH_GSSAPI;</span>
<a href="#l1.1839"></a><span id="l1.1839" class="difflineminus">-    }</span>
<a href="#l1.1840"></a><span id="l1.1840" class="difflineminus">-    else</span>
<a href="#l1.1841"></a><span id="l1.1841" class="difflineminus">-    {</span>
<a href="#l1.1842"></a><span id="l1.1842" class="difflineplus">+    } else {</span>
<a href="#l1.1843"></a><span id="l1.1843">       // we tried to login, but it all failed</span>
<a href="#l1.1844"></a><span id="l1.1844" class="difflineminus">-      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;All auth attempts failed&quot;));</span>
<a href="#l1.1845"></a><span id="l1.1845" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1846"></a><span id="l1.1846" class="difflineplus">+              (&quot;All auth attempts failed&quot;));</span>
<a href="#l1.1847"></a><span id="l1.1847">       m_urlErrorState = NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.1848"></a><span id="l1.1848">     }</span>
<a href="#l1.1849"></a><span id="l1.1849">     m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.1850"></a><span id="l1.1850">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l1.1851"></a><span id="l1.1851">   }</span>
<a href="#l1.1852"></a><span id="l1.1852"> </span>
<a href="#l1.1853"></a><span id="l1.1853">   return NS_OK;</span>
<a href="#l1.1854"></a><span id="l1.1854"> }</span>
<a href="#l1.1855"></a><span id="l1.1855"> </span>
<a href="#l1.1856"></a><span id="l1.1856" class="difflineminus">-</span>
<a href="#l1.1857"></a><span id="l1.1857" class="difflineminus">-</span>
<a href="#l1.1858"></a><span id="l1.1858" class="difflineminus">-nsresult nsSmtpProtocol::AuthLoginResponse(nsIInputStream * stream, uint32_t length)</span>
<a href="#l1.1859"></a><span id="l1.1859" class="difflineminus">-{</span>
<a href="#l1.1860"></a><span id="l1.1860" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP Login response, code %d&quot;, m_responseCode));</span>
<a href="#l1.1861"></a><span id="l1.1861" class="difflineplus">+nsresult nsSmtpProtocol::AuthLoginResponse(nsIInputStream *stream,</span>
<a href="#l1.1862"></a><span id="l1.1862" class="difflineplus">+                                           uint32_t length) {</span>
<a href="#l1.1863"></a><span id="l1.1863" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.1864"></a><span id="l1.1864" class="difflineplus">+          (&quot;SMTP Login response, code %d&quot;, m_responseCode));</span>
<a href="#l1.1865"></a><span id="l1.1865">   nsresult status = NS_OK;</span>
<a href="#l1.1866"></a><span id="l1.1866"> </span>
<a href="#l1.1867"></a><span id="l1.1867" class="difflineminus">-  switch (m_responseCode/100)</span>
<a href="#l1.1868"></a><span id="l1.1868" class="difflineminus">-  {</span>
<a href="#l1.1869"></a><span id="l1.1869" class="difflineplus">+  switch (m_responseCode / 100) {</span>
<a href="#l1.1870"></a><span id="l1.1870">     case 2:</span>
<a href="#l1.1871"></a><span id="l1.1871">       m_nextState = SMTP_SEND_HELO_RESPONSE;</span>
<a href="#l1.1872"></a><span id="l1.1872">       // fake to 250 because SendHeloResponse() tests for this</span>
<a href="#l1.1873"></a><span id="l1.1873">       m_responseCode = 250;</span>
<a href="#l1.1874"></a><span id="l1.1874">       break;</span>
<a href="#l1.1875"></a><span id="l1.1875">     case 3:</span>
<a href="#l1.1876"></a><span id="l1.1876">       m_nextState = SMTP_SEND_AUTH_LOGIN_STEP2;</span>
<a href="#l1.1877"></a><span id="l1.1877">       break;</span>
<a href="#l1.1878"></a><span id="l1.1878">     case 5:</span>
<a href="#l1.1879"></a><span id="l1.1879">     default:</span>
<a href="#l1.1880"></a><span id="l1.1880">       nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.1881"></a><span id="l1.1881">       m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.1882"></a><span id="l1.1882" class="difflineminus">-      if (smtpServer)</span>
<a href="#l1.1883"></a><span id="l1.1883" class="difflineminus">-      {</span>
<a href="#l1.1884"></a><span id="l1.1884" class="difflineplus">+      if (smtpServer) {</span>
<a href="#l1.1885"></a><span id="l1.1885">         // If one authentication failed, mark it failed, so that we're going to</span>
<a href="#l1.1886"></a><span id="l1.1886">         // fall back on a less secure login method.</span>
<a href="#l1.1887"></a><span id="l1.1887">         MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l1.1888"></a><span id="l1.1888"> </span>
<a href="#l1.1889"></a><span id="l1.1889">         bool allFailed = NS_FAILED(ChooseAuthMethod());</span>
<a href="#l1.1890"></a><span id="l1.1890">         if (allFailed &amp;&amp; m_failedAuthMethods &gt; 0 &amp;&amp;</span>
<a href="#l1.1891"></a><span id="l1.1891">             m_failedAuthMethods != SMTP_AUTH_GSSAPI_ENABLED &amp;&amp;</span>
<a href="#l1.1892"></a><span id="l1.1892" class="difflineminus">-            m_failedAuthMethods != SMTP_AUTH_EXTERNAL_ENABLED)</span>
<a href="#l1.1893"></a><span id="l1.1893" class="difflineminus">-        {</span>
<a href="#l1.1894"></a><span id="l1.1894" class="difflineminus">-          // We've tried all avail. methods, and they all failed, and we have no mechanism left.</span>
<a href="#l1.1895"></a><span id="l1.1895" class="difflineminus">-          // Ask user to try with a new password.</span>
<a href="#l1.1896"></a><span id="l1.1896" class="difflineplus">+            m_failedAuthMethods != SMTP_AUTH_EXTERNAL_ENABLED) {</span>
<a href="#l1.1897"></a><span id="l1.1897" class="difflineplus">+          // We've tried all avail. methods, and they all failed, and we have no</span>
<a href="#l1.1898"></a><span id="l1.1898" class="difflineplus">+          // mechanism left. Ask user to try with a new password.</span>
<a href="#l1.1899"></a><span id="l1.1899">           MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l1.1900"></a><span id="l1.1900" class="difflineminus">-              (&quot;SMTP: ask user what to do (after login failed): new password, retry or cancel&quot;));</span>
<a href="#l1.1901"></a><span id="l1.1901" class="difflineplus">+                  (&quot;SMTP: ask user what to do (after login failed): new &quot;</span>
<a href="#l1.1902"></a><span id="l1.1902" class="difflineplus">+                   &quot;password, retry or cancel&quot;));</span>
<a href="#l1.1903"></a><span id="l1.1903"> </span>
<a href="#l1.1904"></a><span id="l1.1904">           nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.1905"></a><span id="l1.1905">           nsresult rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.1906"></a><span id="l1.1906">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1907"></a><span id="l1.1907"> </span>
<a href="#l1.1908"></a><span id="l1.1908">           nsCString hostname;</span>
<a href="#l1.1909"></a><span id="l1.1909">           rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l1.1910"></a><span id="l1.1910">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1911"></a><span id="l1.1911" class="difflineat">@@ -1383,219 +1272,213 @@ nsresult nsSmtpProtocol::AuthLoginRespon</span>
<a href="#l1.1912"></a><span id="l1.1912">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1913"></a><span id="l1.1913"> </span>
<a href="#l1.1914"></a><span id="l1.1914">           nsCString accountname;</span>
<a href="#l1.1915"></a><span id="l1.1915">           rv = smtpServer-&gt;GetDescription(accountname);</span>
<a href="#l1.1916"></a><span id="l1.1916">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1917"></a><span id="l1.1917">           NS_ConvertUTF8toUTF16 accountNameUTF16(accountname);</span>
<a href="#l1.1918"></a><span id="l1.1918"> </span>
<a href="#l1.1919"></a><span id="l1.1919">           int32_t buttonPressed = 1;</span>
<a href="#l1.1920"></a><span id="l1.1920" class="difflineminus">-          if (NS_SUCCEEDED(MsgPromptLoginFailed(nullptr, hostname, username, accountNameUTF16,</span>
<a href="#l1.1921"></a><span id="l1.1921" class="difflineminus">-                                                &amp;buttonPressed)))</span>
<a href="#l1.1922"></a><span id="l1.1922" class="difflineminus">-          {</span>
<a href="#l1.1923"></a><span id="l1.1923" class="difflineminus">-            if (buttonPressed == 1) // Cancel button</span>
<a href="#l1.1924"></a><span id="l1.1924" class="difflineplus">+          if (NS_SUCCEEDED(MsgPromptLoginFailed(nullptr, hostname, username,</span>
<a href="#l1.1925"></a><span id="l1.1925" class="difflineplus">+                                                accountNameUTF16,</span>
<a href="#l1.1926"></a><span id="l1.1926" class="difflineplus">+                                                &amp;buttonPressed))) {</span>
<a href="#l1.1927"></a><span id="l1.1927" class="difflineplus">+            if (buttonPressed == 1)  // Cancel button</span>
<a href="#l1.1928"></a><span id="l1.1928">             {</span>
<a href="#l1.1929"></a><span id="l1.1929" class="difflineminus">-              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning, (&quot;cancel button pressed&quot;));</span>
<a href="#l1.1930"></a><span id="l1.1930" class="difflineplus">+              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l1.1931"></a><span id="l1.1931" class="difflineplus">+                      (&quot;cancel button pressed&quot;));</span>
<a href="#l1.1932"></a><span id="l1.1932">               // abort and get out of here</span>
<a href="#l1.1933"></a><span id="l1.1933">               status = NS_ERROR_ABORT;</span>
<a href="#l1.1934"></a><span id="l1.1934">               break;</span>
<a href="#l1.1935"></a><span id="l1.1935" class="difflineminus">-            }</span>
<a href="#l1.1936"></a><span id="l1.1936" class="difflineminus">-            else if (buttonPressed == 2) // 'New password' button</span>
<a href="#l1.1937"></a><span id="l1.1937" class="difflineplus">+            } else if (buttonPressed == 2)  // 'New password' button</span>
<a href="#l1.1938"></a><span id="l1.1938">             {</span>
<a href="#l1.1939"></a><span id="l1.1939" class="difflineminus">-              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning, (&quot;new password button pressed&quot;));</span>
<a href="#l1.1940"></a><span id="l1.1940" class="difflineplus">+              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l1.1941"></a><span id="l1.1941" class="difflineplus">+                      (&quot;new password button pressed&quot;));</span>
<a href="#l1.1942"></a><span id="l1.1942">               // Change password was pressed. For now, forget the stored</span>
<a href="#l1.1943"></a><span id="l1.1943">               // password and we'll prompt for a new one next time around.</span>
<a href="#l1.1944"></a><span id="l1.1944">               smtpServer-&gt;ForgetPassword();</span>
<a href="#l1.1945"></a><span id="l1.1945" class="difflineminus">-              if (m_usernamePrompted)</span>
<a href="#l1.1946"></a><span id="l1.1946" class="difflineminus">-                smtpServer-&gt;SetUsername(EmptyCString());</span>
<a href="#l1.1947"></a><span id="l1.1947" class="difflineplus">+              if (m_usernamePrompted) smtpServer-&gt;SetUsername(EmptyCString());</span>
<a href="#l1.1948"></a><span id="l1.1948"> </span>
<a href="#l1.1949"></a><span id="l1.1949">               // Let's restore the original auth flags from SendEhloResponse</span>
<a href="#l1.1950"></a><span id="l1.1950">               // so we can try them again with new password and username</span>
<a href="#l1.1951"></a><span id="l1.1951">               ResetAuthMethods();</span>
<a href="#l1.1952"></a><span id="l1.1952" class="difflineminus">-              // except for GSSAPI and EXTERNAL, which don't care about passwords.</span>
<a href="#l1.1953"></a><span id="l1.1953" class="difflineplus">+              // except for GSSAPI and EXTERNAL, which don't care about</span>
<a href="#l1.1954"></a><span id="l1.1954" class="difflineplus">+              // passwords.</span>
<a href="#l1.1955"></a><span id="l1.1955">               MarkAuthMethodAsFailed(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l1.1956"></a><span id="l1.1956">               MarkAuthMethodAsFailed(SMTP_AUTH_EXTERNAL_ENABLED);</span>
<a href="#l1.1957"></a><span id="l1.1957" class="difflineminus">-            }</span>
<a href="#l1.1958"></a><span id="l1.1958" class="difflineminus">-            else if (buttonPressed == 0) // Retry button</span>
<a href="#l1.1959"></a><span id="l1.1959" class="difflineplus">+            } else if (buttonPressed == 0)  // Retry button</span>
<a href="#l1.1960"></a><span id="l1.1960">             {</span>
<a href="#l1.1961"></a><span id="l1.1961" class="difflineminus">-              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning, (&quot;retry button pressed&quot;));</span>
<a href="#l1.1962"></a><span id="l1.1962" class="difflineplus">+              MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l1.1963"></a><span id="l1.1963" class="difflineplus">+                      (&quot;retry button pressed&quot;));</span>
<a href="#l1.1964"></a><span id="l1.1964">               // try all again, including GSSAPI</span>
<a href="#l1.1965"></a><span id="l1.1965">               ResetAuthMethods();</span>
<a href="#l1.1966"></a><span id="l1.1966">             }</span>
<a href="#l1.1967"></a><span id="l1.1967">           }</span>
<a href="#l1.1968"></a><span id="l1.1968">         }</span>
<a href="#l1.1969"></a><span id="l1.1969">         MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.1970"></a><span id="l1.1970" class="difflineminus">-            (&quot;SMTP: login failed: failed %X, current %X&quot;, m_failedAuthMethods, m_currentAuthMethod));</span>
<a href="#l1.1971"></a><span id="l1.1971" class="difflineplus">+                (&quot;SMTP: login failed: failed %X, current %X&quot;,</span>
<a href="#l1.1972"></a><span id="l1.1972" class="difflineplus">+                 m_failedAuthMethods, m_currentAuthMethod));</span>
<a href="#l1.1973"></a><span id="l1.1973"> </span>
<a href="#l1.1974"></a><span id="l1.1974" class="difflineminus">-        m_nextState = SMTP_AUTH_PROCESS_STATE; // try auth (ProcessAuth()) again, with other method</span>
<a href="#l1.1975"></a><span id="l1.1975" class="difflineminus">-      }</span>
<a href="#l1.1976"></a><span id="l1.1976" class="difflineminus">-      else</span>
<a href="#l1.1977"></a><span id="l1.1977" class="difflineminus">-          status = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.1978"></a><span id="l1.1978" class="difflineplus">+        m_nextState = SMTP_AUTH_PROCESS_STATE;  // try auth (ProcessAuth())</span>
<a href="#l1.1979"></a><span id="l1.1979" class="difflineplus">+                                                // again, with other method</span>
<a href="#l1.1980"></a><span id="l1.1980" class="difflineplus">+      } else</span>
<a href="#l1.1981"></a><span id="l1.1981" class="difflineplus">+        status = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.1982"></a><span id="l1.1982">       break;</span>
<a href="#l1.1983"></a><span id="l1.1983">   }</span>
<a href="#l1.1984"></a><span id="l1.1984"> </span>
<a href="#l1.1985"></a><span id="l1.1985">   return (status);</span>
<a href="#l1.1986"></a><span id="l1.1986"> }</span>
<a href="#l1.1987"></a><span id="l1.1987"> </span>
<a href="#l1.1988"></a><span id="l1.1988" class="difflineminus">-nsresult nsSmtpProtocol::AuthGSSAPIFirst()</span>
<a href="#l1.1989"></a><span id="l1.1989" class="difflineminus">-{</span>
<a href="#l1.1990"></a><span id="l1.1990" class="difflineminus">-  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED, &quot;called in invalid state&quot;);</span>
<a href="#l1.1991"></a><span id="l1.1991" class="difflineplus">+nsresult nsSmtpProtocol::AuthGSSAPIFirst() {</span>
<a href="#l1.1992"></a><span id="l1.1992" class="difflineplus">+  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED,</span>
<a href="#l1.1993"></a><span id="l1.1993" class="difflineplus">+               &quot;called in invalid state&quot;);</span>
<a href="#l1.1994"></a><span id="l1.1994">   nsAutoCString command(&quot;AUTH GSSAPI &quot;);</span>
<a href="#l1.1995"></a><span id="l1.1995">   nsAutoCString resp;</span>
<a href="#l1.1996"></a><span id="l1.1996">   nsAutoCString service(&quot;smtp@&quot;);</span>
<a href="#l1.1997"></a><span id="l1.1997">   nsCString hostName;</span>
<a href="#l1.1998"></a><span id="l1.1998">   nsCString userName;</span>
<a href="#l1.1999"></a><span id="l1.1999">   nsresult rv;</span>
<a href="#l1.2000"></a><span id="l1.2000">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.2001"></a><span id="l1.2001">   rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.2002"></a><span id="l1.2002" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.2003"></a><span id="l1.2003" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.2004"></a><span id="l1.2004" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l1.2005"></a><span id="l1.2005"> </span>
<a href="#l1.2006"></a><span id="l1.2006">   rv = smtpServer-&gt;GetUsername(userName);</span>
<a href="#l1.2007"></a><span id="l1.2007" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.2008"></a><span id="l1.2008" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.2009"></a><span id="l1.2009" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l1.2010"></a><span id="l1.2010"> </span>
<a href="#l1.2011"></a><span id="l1.2011">   rv = smtpServer-&gt;GetHostname(hostName);</span>
<a href="#l1.2012"></a><span id="l1.2012" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.2013"></a><span id="l1.2013" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.2014"></a><span id="l1.2014" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l1.2015"></a><span id="l1.2015">   service.Append(hostName);</span>
<a href="#l1.2016"></a><span id="l1.2016" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP: GSSAPI step 1 for user %s at server %s, service %s&quot;,</span>
<a href="#l1.2017"></a><span id="l1.2017" class="difflineminus">-      userName.get(), hostName.get(), service.get()));</span>
<a href="#l1.2018"></a><span id="l1.2018" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.2019"></a><span id="l1.2019" class="difflineplus">+          (&quot;SMTP: GSSAPI step 1 for user %s at server %s, service %s&quot;,</span>
<a href="#l1.2020"></a><span id="l1.2020" class="difflineplus">+           userName.get(), hostName.get(), service.get()));</span>
<a href="#l1.2021"></a><span id="l1.2021"> </span>
<a href="#l1.2022"></a><span id="l1.2022">   rv = DoGSSAPIStep1(service.get(), userName.get(), resp);</span>
<a href="#l1.2023"></a><span id="l1.2023" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.2024"></a><span id="l1.2024" class="difflineminus">-  {</span>
<a href="#l1.2025"></a><span id="l1.2025" class="difflineminus">-    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;SMTP: GSSAPI step 1 failed early&quot;));</span>
<a href="#l1.2026"></a><span id="l1.2026" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l1.2027"></a><span id="l1.2027" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.2028"></a><span id="l1.2028" class="difflineplus">+            (&quot;SMTP: GSSAPI step 1 failed early&quot;));</span>
<a href="#l1.2029"></a><span id="l1.2029">     MarkAuthMethodAsFailed(SMTP_AUTH_GSSAPI_ENABLED);</span>
<a href="#l1.2030"></a><span id="l1.2030">     m_nextState = SMTP_AUTH_PROCESS_STATE;</span>
<a href="#l1.2031"></a><span id="l1.2031">     return NS_OK;</span>
<a href="#l1.2032"></a><span id="l1.2032" class="difflineminus">-  }</span>
<a href="#l1.2033"></a><span id="l1.2033" class="difflineminus">-  else</span>
<a href="#l1.2034"></a><span id="l1.2034" class="difflineplus">+  } else</span>
<a href="#l1.2035"></a><span id="l1.2035">     command.Append(resp);</span>
<a href="#l1.2036"></a><span id="l1.2036">   command.Append(CRLF);</span>
<a href="#l1.2037"></a><span id="l1.2037">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2038"></a><span id="l1.2038">   m_nextStateAfterResponse = SMTP_SEND_AUTH_GSSAPI_STEP;</span>
<a href="#l1.2039"></a><span id="l1.2039">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2040"></a><span id="l1.2040">   return SendData(command.get());</span>
<a href="#l1.2041"></a><span id="l1.2041"> }</span>
<a href="#l1.2042"></a><span id="l1.2042"> </span>
<a href="#l1.2043"></a><span id="l1.2043"> // GSSAPI may consist of multiple round trips</span>
<a href="#l1.2044"></a><span id="l1.2044"> </span>
<a href="#l1.2045"></a><span id="l1.2045" class="difflineminus">-nsresult nsSmtpProtocol::AuthGSSAPIStep()</span>
<a href="#l1.2046"></a><span id="l1.2046" class="difflineminus">-{</span>
<a href="#l1.2047"></a><span id="l1.2047" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP: GSSAPI auth step 2&quot;));</span>
<a href="#l1.2048"></a><span id="l1.2048" class="difflineminus">-  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED, &quot;called in invalid state&quot;);</span>
<a href="#l1.2049"></a><span id="l1.2049" class="difflineplus">+nsresult nsSmtpProtocol::AuthGSSAPIStep() {</span>
<a href="#l1.2050"></a><span id="l1.2050" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.2051"></a><span id="l1.2051" class="difflineplus">+          (&quot;SMTP: GSSAPI auth step 2&quot;));</span>
<a href="#l1.2052"></a><span id="l1.2052" class="difflineplus">+  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_GSSAPI_ENABLED,</span>
<a href="#l1.2053"></a><span id="l1.2053" class="difflineplus">+               &quot;called in invalid state&quot;);</span>
<a href="#l1.2054"></a><span id="l1.2054">   nsresult rv;</span>
<a href="#l1.2055"></a><span id="l1.2055">   nsAutoCString cmd;</span>
<a href="#l1.2056"></a><span id="l1.2056"> </span>
<a href="#l1.2057"></a><span id="l1.2057">   // Check to see what the server said</span>
<a href="#l1.2058"></a><span id="l1.2058">   if (m_responseCode / 100 != 3) {</span>
<a href="#l1.2059"></a><span id="l1.2059">     m_nextState = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l1.2060"></a><span id="l1.2060">     return NS_OK;</span>
<a href="#l1.2061"></a><span id="l1.2061">   }</span>
<a href="#l1.2062"></a><span id="l1.2062"> </span>
<a href="#l1.2063"></a><span id="l1.2063">   rv = DoGSSAPIStep2(m_responseText, cmd);</span>
<a href="#l1.2064"></a><span id="l1.2064" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.2065"></a><span id="l1.2065" class="difflineminus">-    cmd = &quot;*&quot;;</span>
<a href="#l1.2066"></a><span id="l1.2066" class="difflineplus">+  if (NS_FAILED(rv)) cmd = &quot;*&quot;;</span>
<a href="#l1.2067"></a><span id="l1.2067">   cmd += CRLF;</span>
<a href="#l1.2068"></a><span id="l1.2068"> </span>
<a href="#l1.2069"></a><span id="l1.2069" class="difflineminus">-  m_nextStateAfterResponse = (rv == NS_SUCCESS_AUTH_FINISHED)?SMTP_AUTH_LOGIN_RESPONSE:SMTP_SEND_AUTH_GSSAPI_STEP;</span>
<a href="#l1.2070"></a><span id="l1.2070" class="difflineplus">+  m_nextStateAfterResponse = (rv == NS_SUCCESS_AUTH_FINISHED)</span>
<a href="#l1.2071"></a><span id="l1.2071" class="difflineplus">+                                 ? SMTP_AUTH_LOGIN_RESPONSE</span>
<a href="#l1.2072"></a><span id="l1.2072" class="difflineplus">+                                 : SMTP_SEND_AUTH_GSSAPI_STEP;</span>
<a href="#l1.2073"></a><span id="l1.2073">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2074"></a><span id="l1.2074">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2075"></a><span id="l1.2075"> </span>
<a href="#l1.2076"></a><span id="l1.2076">   return SendData(cmd.get());</span>
<a href="#l1.2077"></a><span id="l1.2077"> }</span>
<a href="#l1.2078"></a><span id="l1.2078"> </span>
<a href="#l1.2079"></a><span id="l1.2079" class="difflineminus">-</span>
<a href="#l1.2080"></a><span id="l1.2080"> // LOGIN and MSN consist of three steps (MSN not through the mechanism</span>
<a href="#l1.2081"></a><span id="l1.2081"> // but by non-RFC2821 compliant implementation in MS servers) not two as</span>
<a href="#l1.2082"></a><span id="l1.2082"> // PLAIN or CRAM-MD5, so we've to start here and continue with AuthStep1</span>
<a href="#l1.2083"></a><span id="l1.2083"> // if the server responds with with a 3xx code to &quot;AUTH LOGIN&quot; or &quot;AUTH MSN&quot;</span>
<a href="#l1.2084"></a><span id="l1.2084" class="difflineminus">-nsresult nsSmtpProtocol::AuthLoginStep0()</span>
<a href="#l1.2085"></a><span id="l1.2085" class="difflineminus">-{</span>
<a href="#l1.2086"></a><span id="l1.2086" class="difflineminus">-    NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l1.2087"></a><span id="l1.2087" class="difflineminus">-        m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l1.2088"></a><span id="l1.2088" class="difflineminus">-        &quot;called in invalid state&quot;);</span>
<a href="#l1.2089"></a><span id="l1.2089" class="difflineminus">-    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP: MSN or LOGIN auth, step 0&quot;));</span>
<a href="#l1.2090"></a><span id="l1.2090" class="difflineminus">-    nsAutoCString command(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED</span>
<a href="#l1.2091"></a><span id="l1.2091" class="difflineminus">-        ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l1.2092"></a><span id="l1.2092" class="difflineminus">-    m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2093"></a><span id="l1.2093" class="difflineminus">-    m_nextStateAfterResponse = SMTP_AUTH_LOGIN_STEP0_RESPONSE;</span>
<a href="#l1.2094"></a><span id="l1.2094" class="difflineminus">-    SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2095"></a><span id="l1.2095" class="difflineplus">+nsresult nsSmtpProtocol::AuthLoginStep0() {</span>
<a href="#l1.2096"></a><span id="l1.2096" class="difflineplus">+  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l1.2097"></a><span id="l1.2097" class="difflineplus">+                   m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l1.2098"></a><span id="l1.2098" class="difflineplus">+               &quot;called in invalid state&quot;);</span>
<a href="#l1.2099"></a><span id="l1.2099" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.2100"></a><span id="l1.2100" class="difflineplus">+          (&quot;SMTP: MSN or LOGIN auth, step 0&quot;));</span>
<a href="#l1.2101"></a><span id="l1.2101" class="difflineplus">+  nsAutoCString command(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED</span>
<a href="#l1.2102"></a><span id="l1.2102" class="difflineplus">+                            ? &quot;AUTH MSN&quot; CRLF</span>
<a href="#l1.2103"></a><span id="l1.2103" class="difflineplus">+                            : &quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l1.2104"></a><span id="l1.2104" class="difflineplus">+  m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2105"></a><span id="l1.2105" class="difflineplus">+  m_nextStateAfterResponse = SMTP_AUTH_LOGIN_STEP0_RESPONSE;</span>
<a href="#l1.2106"></a><span id="l1.2106" class="difflineplus">+  SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2107"></a><span id="l1.2107"> </span>
<a href="#l1.2108"></a><span id="l1.2108" class="difflineminus">-    return SendData(command.get());</span>
<a href="#l1.2109"></a><span id="l1.2109" class="difflineplus">+  return SendData(command.get());</span>
<a href="#l1.2110"></a><span id="l1.2110"> }</span>
<a href="#l1.2111"></a><span id="l1.2111"> </span>
<a href="#l1.2112"></a><span id="l1.2112" class="difflineminus">-void nsSmtpProtocol::AuthLoginStep0Response()</span>
<a href="#l1.2113"></a><span id="l1.2113" class="difflineminus">-{</span>
<a href="#l1.2114"></a><span id="l1.2114" class="difflineminus">-    NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l1.2115"></a><span id="l1.2115" class="difflineminus">-        m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l1.2116"></a><span id="l1.2116" class="difflineminus">-        &quot;called in invalid state&quot;);</span>
<a href="#l1.2117"></a><span id="l1.2117" class="difflineminus">-    // need the test to be here instead in AuthLoginResponse() to</span>
<a href="#l1.2118"></a><span id="l1.2118" class="difflineminus">-    // continue with step 1 instead of 2 in case of a code 3xx</span>
<a href="#l1.2119"></a><span id="l1.2119" class="difflineminus">-    m_nextState = (m_responseCode/100 == 3) ?</span>
<a href="#l1.2120"></a><span id="l1.2120" class="difflineminus">-                  SMTP_SEND_AUTH_LOGIN_STEP1 : SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l1.2121"></a><span id="l1.2121" class="difflineplus">+void nsSmtpProtocol::AuthLoginStep0Response() {</span>
<a href="#l1.2122"></a><span id="l1.2122" class="difflineplus">+  NS_ASSERTION(m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED ||</span>
<a href="#l1.2123"></a><span id="l1.2123" class="difflineplus">+                   m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED,</span>
<a href="#l1.2124"></a><span id="l1.2124" class="difflineplus">+               &quot;called in invalid state&quot;);</span>
<a href="#l1.2125"></a><span id="l1.2125" class="difflineplus">+  // need the test to be here instead in AuthLoginResponse() to</span>
<a href="#l1.2126"></a><span id="l1.2126" class="difflineplus">+  // continue with step 1 instead of 2 in case of a code 3xx</span>
<a href="#l1.2127"></a><span id="l1.2127" class="difflineplus">+  m_nextState = (m_responseCode / 100 == 3) ? SMTP_SEND_AUTH_LOGIN_STEP1</span>
<a href="#l1.2128"></a><span id="l1.2128" class="difflineplus">+                                            : SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l1.2129"></a><span id="l1.2129"> }</span>
<a href="#l1.2130"></a><span id="l1.2130"> </span>
<a href="#l1.2131"></a><span id="l1.2131" class="difflineminus">-nsresult nsSmtpProtocol::AuthLoginStep1()</span>
<a href="#l1.2132"></a><span id="l1.2132" class="difflineminus">-{</span>
<a href="#l1.2133"></a><span id="l1.2133" class="difflineplus">+nsresult nsSmtpProtocol::AuthLoginStep1() {</span>
<a href="#l1.2134"></a><span id="l1.2134">   // The longest message we are going to send is:</span>
<a href="#l1.2135"></a><span id="l1.2135">   // &quot;AUTH PLAIN &quot; followed by 684 bytes (base64 encoding of 512 bytes of</span>
<a href="#l1.2136"></a><span id="l1.2136">   // username/password) followed by CRLF: 11 + 684 + 2 + 1 = 698.</span>
<a href="#l1.2137"></a><span id="l1.2137">   char buffer[698];</span>
<a href="#l1.2138"></a><span id="l1.2138">   nsresult rv;</span>
<a href="#l1.2139"></a><span id="l1.2139">   nsresult status = NS_OK;</span>
<a href="#l1.2140"></a><span id="l1.2140">   nsCString username;</span>
<a href="#l1.2141"></a><span id="l1.2141">   char *base64Str = nullptr;</span>
<a href="#l1.2142"></a><span id="l1.2142">   nsAutoString password;</span>
<a href="#l1.2143"></a><span id="l1.2143">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.2144"></a><span id="l1.2144">   rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.2145"></a><span id="l1.2145">   if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l1.2146"></a><span id="l1.2146"> </span>
<a href="#l1.2147"></a><span id="l1.2147">   rv = smtpServer-&gt;GetUsername(username);</span>
<a href="#l1.2148"></a><span id="l1.2148" class="difflineminus">-  if (username.IsEmpty())</span>
<a href="#l1.2149"></a><span id="l1.2149" class="difflineminus">-  {</span>
<a href="#l1.2150"></a><span id="l1.2150" class="difflineplus">+  if (username.IsEmpty()) {</span>
<a href="#l1.2151"></a><span id="l1.2151">     rv = GetUsernamePassword(username, password);</span>
<a href="#l1.2152"></a><span id="l1.2152">     m_usernamePrompted = true;</span>
<a href="#l1.2153"></a><span id="l1.2153">     if (username.IsEmpty() || password.IsEmpty())</span>
<a href="#l1.2154"></a><span id="l1.2154">       return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.2155"></a><span id="l1.2155">   }</span>
<a href="#l1.2156"></a><span id="l1.2156"> </span>
<a href="#l1.2157"></a><span id="l1.2157">   nsCString hostname;</span>
<a href="#l1.2158"></a><span id="l1.2158">   smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l1.2159"></a><span id="l1.2159"> </span>
<a href="#l1.2160"></a><span id="l1.2160" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP AuthLoginStep1() for %s@%s&quot;,</span>
<a href="#l1.2161"></a><span id="l1.2161" class="difflineminus">-          username.get(), hostname.get()));</span>
<a href="#l1.2162"></a><span id="l1.2162" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.2163"></a><span id="l1.2163" class="difflineplus">+          (&quot;SMTP AuthLoginStep1() for %s@%s&quot;, username.get(), hostname.get()));</span>
<a href="#l1.2164"></a><span id="l1.2164"> </span>
<a href="#l1.2165"></a><span id="l1.2165">   GetPassword(password);</span>
<a href="#l1.2166"></a><span id="l1.2166" class="difflineminus">-  if (password.IsEmpty())</span>
<a href="#l1.2167"></a><span id="l1.2167" class="difflineminus">-  {</span>
<a href="#l1.2168"></a><span id="l1.2168" class="difflineminus">-    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;SMTP: password undefined&quot;));</span>
<a href="#l1.2169"></a><span id="l1.2169" class="difflineplus">+  if (password.IsEmpty()) {</span>
<a href="#l1.2170"></a><span id="l1.2170" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error,</span>
<a href="#l1.2171"></a><span id="l1.2171" class="difflineplus">+            (&quot;SMTP: password undefined&quot;));</span>
<a href="#l1.2172"></a><span id="l1.2172">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.2173"></a><span id="l1.2173">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.2174"></a><span id="l1.2174">   }</span>
<a href="#l1.2175"></a><span id="l1.2175">   NS_ConvertUTF16toUTF8 passwordUTF8(password);</span>
<a href="#l1.2176"></a><span id="l1.2176"> </span>
<a href="#l1.2177"></a><span id="l1.2177" class="difflineminus">-  if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l1.2178"></a><span id="l1.2178" class="difflineminus">-  {</span>
<a href="#l1.2179"></a><span id="l1.2179" class="difflineplus">+  if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED) {</span>
<a href="#l1.2180"></a><span id="l1.2180">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;CRAM auth, step 1&quot;));</span>
<a href="#l1.2181"></a><span id="l1.2181">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH CRAM-MD5&quot; CRLF);</span>
<a href="#l1.2182"></a><span id="l1.2182" class="difflineminus">-  }</span>
<a href="#l1.2183"></a><span id="l1.2183" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l1.2184"></a><span id="l1.2184" class="difflineminus">-           m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l1.2185"></a><span id="l1.2185" class="difflineminus">-  {</span>
<a href="#l1.2186"></a><span id="l1.2186" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l1.2187"></a><span id="l1.2187" class="difflineplus">+             m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED) {</span>
<a href="#l1.2188"></a><span id="l1.2188">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;NTLM/MSN auth, step 1&quot;));</span>
<a href="#l1.2189"></a><span id="l1.2189">     nsAutoCString response;</span>
<a href="#l1.2190"></a><span id="l1.2190">     rv = DoNtlmStep1(username, password, response);</span>
<a href="#l1.2191"></a><span id="l1.2191" class="difflineminus">-    PR_snprintf(buffer, sizeof(buffer), TestFlag(SMTP_AUTH_NTLM_ENABLED) ?</span>
<a href="#l1.2192"></a><span id="l1.2192" class="difflineminus">-                                        &quot;AUTH NTLM %.512s&quot; CRLF :</span>
<a href="#l1.2193"></a><span id="l1.2193" class="difflineminus">-                                        &quot;%.512s&quot; CRLF, response.get());</span>
<a href="#l1.2194"></a><span id="l1.2194" class="difflineminus">-  }</span>
<a href="#l1.2195"></a><span id="l1.2195" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED)</span>
<a href="#l1.2196"></a><span id="l1.2196" class="difflineminus">-  {</span>
<a href="#l1.2197"></a><span id="l1.2197" class="difflineplus">+    PR_snprintf(buffer, sizeof(buffer),</span>
<a href="#l1.2198"></a><span id="l1.2198" class="difflineplus">+                TestFlag(SMTP_AUTH_NTLM_ENABLED) ? &quot;AUTH NTLM %.512s&quot; CRLF</span>
<a href="#l1.2199"></a><span id="l1.2199" class="difflineplus">+                                                 : &quot;%.512s&quot; CRLF,</span>
<a href="#l1.2200"></a><span id="l1.2200" class="difflineplus">+                response.get());</span>
<a href="#l1.2201"></a><span id="l1.2201" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED) {</span>
<a href="#l1.2202"></a><span id="l1.2202">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;PLAIN auth&quot;));</span>
<a href="#l1.2203"></a><span id="l1.2203">     // Up to 255 octets.</span>
<a href="#l1.2204"></a><span id="l1.2204">     if (username.Length() &gt; 255)  // RFC 4616: authcid; up to 255 octets</span>
<a href="#l1.2205"></a><span id="l1.2205">       username.Truncate(255);</span>
<a href="#l1.2206"></a><span id="l1.2206">     if (passwordUTF8.Length() &gt; 255)  // RFC 4616: passwd; up to 255 octets</span>
<a href="#l1.2207"></a><span id="l1.2207">       passwordUTF8.Truncate(255);</span>
<a href="#l1.2208"></a><span id="l1.2208"> </span>
<a href="#l1.2209"></a><span id="l1.2209">     // RFC 4616: UTF8NUL authcid UTF8NUL passwd</span>
<a href="#l1.2210"></a><span id="l1.2210" class="difflineat">@@ -1603,397 +1486,364 @@ nsresult nsSmtpProtocol::AuthLoginStep1(</span>
<a href="#l1.2211"></a><span id="l1.2211">     memset(plain_string, 0, 513);</span>
<a href="#l1.2212"></a><span id="l1.2212">     PR_snprintf(&amp;plain_string[1], 256, &quot;%s&quot;, username.get());</span>
<a href="#l1.2213"></a><span id="l1.2213">     int len = username.Length() + 2;  // We include two &lt;NUL&gt; characters.</span>
<a href="#l1.2214"></a><span id="l1.2214">     PR_snprintf(&amp;plain_string[len], 256, &quot;%s&quot;, passwordUTF8.get());</span>
<a href="#l1.2215"></a><span id="l1.2215">     len += passwordUTF8.Length();</span>
<a href="#l1.2216"></a><span id="l1.2216"> </span>
<a href="#l1.2217"></a><span id="l1.2217">     base64Str = PL_Base64Encode(plain_string, len, nullptr);</span>
<a href="#l1.2218"></a><span id="l1.2218">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH PLAIN %s&quot; CRLF, base64Str);</span>
<a href="#l1.2219"></a><span id="l1.2219" class="difflineminus">-  }</span>
<a href="#l1.2220"></a><span id="l1.2220" class="difflineminus">-  else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l1.2221"></a><span id="l1.2221" class="difflineminus">-  {</span>
<a href="#l1.2222"></a><span id="l1.2222" class="difflineplus">+  } else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED) {</span>
<a href="#l1.2223"></a><span id="l1.2223">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;LOGIN auth&quot;));</span>
<a href="#l1.2224"></a><span id="l1.2224" class="difflineminus">-    if (username.Length() &gt; 255)</span>
<a href="#l1.2225"></a><span id="l1.2225" class="difflineminus">-      username.Truncate(255);</span>
<a href="#l1.2226"></a><span id="l1.2226" class="difflineplus">+    if (username.Length() &gt; 255) username.Truncate(255);</span>
<a href="#l1.2227"></a><span id="l1.2227">     base64Str = PL_Base64Encode(username.get(), username.Length(), nullptr);</span>
<a href="#l1.2228"></a><span id="l1.2228">     // Base64 encoding of 255 bytes gives 340 bytes.</span>
<a href="#l1.2229"></a><span id="l1.2229">     PR_snprintf(buffer, sizeof(buffer), &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l1.2230"></a><span id="l1.2230" class="difflineminus">-  }</span>
<a href="#l1.2231"></a><span id="l1.2231" class="difflineminus">-  else</span>
<a href="#l1.2232"></a><span id="l1.2232" class="difflineplus">+  } else</span>
<a href="#l1.2233"></a><span id="l1.2233">     return (NS_ERROR_COMMUNICATIONS_ERROR);</span>
<a href="#l1.2234"></a><span id="l1.2234"> </span>
<a href="#l1.2235"></a><span id="l1.2235">   status = SendData(buffer, true);</span>
<a href="#l1.2236"></a><span id="l1.2236">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2237"></a><span id="l1.2237">   m_nextStateAfterResponse = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l1.2238"></a><span id="l1.2238">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2239"></a><span id="l1.2239">   free(base64Str);</span>
<a href="#l1.2240"></a><span id="l1.2240"> </span>
<a href="#l1.2241"></a><span id="l1.2241">   return (status);</span>
<a href="#l1.2242"></a><span id="l1.2242"> }</span>
<a href="#l1.2243"></a><span id="l1.2243"> </span>
<a href="#l1.2244"></a><span id="l1.2244" class="difflineminus">-nsresult nsSmtpProtocol::AuthLoginStep2()</span>
<a href="#l1.2245"></a><span id="l1.2245" class="difflineminus">-{</span>
<a href="#l1.2246"></a><span id="l1.2246" class="difflineplus">+nsresult nsSmtpProtocol::AuthLoginStep2() {</span>
<a href="#l1.2247"></a><span id="l1.2247">   /* use cached smtp password first</span>
<a href="#l1.2248"></a><span id="l1.2248" class="difflineminus">-  * if not then use cached pop password</span>
<a href="#l1.2249"></a><span id="l1.2249" class="difflineminus">-  * if pop password undefined</span>
<a href="#l1.2250"></a><span id="l1.2250" class="difflineminus">-  * sync with smtp password</span>
<a href="#l1.2251"></a><span id="l1.2251" class="difflineminus">-  */</span>
<a href="#l1.2252"></a><span id="l1.2252" class="difflineplus">+   * if not then use cached pop password</span>
<a href="#l1.2253"></a><span id="l1.2253" class="difflineplus">+   * if pop password undefined</span>
<a href="#l1.2254"></a><span id="l1.2254" class="difflineplus">+   * sync with smtp password</span>
<a href="#l1.2255"></a><span id="l1.2255" class="difflineplus">+   */</span>
<a href="#l1.2256"></a><span id="l1.2256">   nsresult status = NS_OK;</span>
<a href="#l1.2257"></a><span id="l1.2257">   nsresult rv;</span>
<a href="#l1.2258"></a><span id="l1.2258">   nsAutoString password;</span>
<a href="#l1.2259"></a><span id="l1.2259"> </span>
<a href="#l1.2260"></a><span id="l1.2260">   GetPassword(password);</span>
<a href="#l1.2261"></a><span id="l1.2261" class="difflineminus">-  if (password.IsEmpty())</span>
<a href="#l1.2262"></a><span id="l1.2262" class="difflineminus">-  {</span>
<a href="#l1.2263"></a><span id="l1.2263" class="difflineplus">+  if (password.IsEmpty()) {</span>
<a href="#l1.2264"></a><span id="l1.2264">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.2265"></a><span id="l1.2265">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l1.2266"></a><span id="l1.2266">   }</span>
<a href="#l1.2267"></a><span id="l1.2267">   nsAutoCString passwordUTF8 = NS_ConvertUTF16toUTF8(password);</span>
<a href="#l1.2268"></a><span id="l1.2268">   MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP AuthLoginStep2&quot;));</span>
<a href="#l1.2269"></a><span id="l1.2269"> </span>
<a href="#l1.2270"></a><span id="l1.2270" class="difflineminus">-  if (!passwordUTF8.IsEmpty())</span>
<a href="#l1.2271"></a><span id="l1.2271" class="difflineminus">-  {</span>
<a href="#l1.2272"></a><span id="l1.2272" class="difflineminus">-    // We use 515 characters here so we can transmit a 512 byte response followed by CRLF.</span>
<a href="#l1.2273"></a><span id="l1.2273" class="difflineminus">-    // User name and encoded digest, currently 255 + 1 + 2*16 bytes, will need</span>
<a href="#l1.2274"></a><span id="l1.2274" class="difflineminus">-    // 4 * (255 + 1 + 32) / 3 = 384 bytes when base64 encoded.</span>
<a href="#l1.2275"></a><span id="l1.2275" class="difflineplus">+  if (!passwordUTF8.IsEmpty()) {</span>
<a href="#l1.2276"></a><span id="l1.2276" class="difflineplus">+    // We use 515 characters here so we can transmit a 512 byte response</span>
<a href="#l1.2277"></a><span id="l1.2277" class="difflineplus">+    // followed by CRLF. User name and encoded digest, currently 255 + 1 + 2*16</span>
<a href="#l1.2278"></a><span id="l1.2278" class="difflineplus">+    // bytes, will need 4 * (255 + 1 + 32) / 3 = 384 bytes when base64 encoded.</span>
<a href="#l1.2279"></a><span id="l1.2279">     char buffer[515];</span>
<a href="#l1.2280"></a><span id="l1.2280" class="difflineminus">-    if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l1.2281"></a><span id="l1.2281" class="difflineminus">-    {</span>
<a href="#l1.2282"></a><span id="l1.2282" class="difflineplus">+    if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED) {</span>
<a href="#l1.2283"></a><span id="l1.2283">       MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;CRAM auth, step 2&quot;));</span>
<a href="#l1.2284"></a><span id="l1.2284">       unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l1.2285"></a><span id="l1.2285" class="difflineminus">-      char * decodedChallenge = PL_Base64Decode(m_responseText.get(),</span>
<a href="#l1.2286"></a><span id="l1.2286" class="difflineminus">-        m_responseText.Length(), nullptr);</span>
<a href="#l1.2287"></a><span id="l1.2287" class="difflineplus">+      char *decodedChallenge = PL_Base64Decode(</span>
<a href="#l1.2288"></a><span id="l1.2288" class="difflineplus">+          m_responseText.get(), m_responseText.Length(), nullptr);</span>
<a href="#l1.2289"></a><span id="l1.2289"> </span>
<a href="#l1.2290"></a><span id="l1.2290">       if (decodedChallenge)</span>
<a href="#l1.2291"></a><span id="l1.2291">         rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge),</span>
<a href="#l1.2292"></a><span id="l1.2292">                         passwordUTF8.get(), passwordUTF8.Length(), digest);</span>
<a href="#l1.2293"></a><span id="l1.2293">       else</span>
<a href="#l1.2294"></a><span id="l1.2294">         rv = NS_ERROR_FAILURE;</span>
<a href="#l1.2295"></a><span id="l1.2295"> </span>
<a href="#l1.2296"></a><span id="l1.2296">       PR_Free(decodedChallenge);</span>
<a href="#l1.2297"></a><span id="l1.2297" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.2298"></a><span id="l1.2298" class="difflineminus">-      {</span>
<a href="#l1.2299"></a><span id="l1.2299" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.2300"></a><span id="l1.2300">         // The encoded digest is the hexadecimal representation of</span>
<a href="#l1.2301"></a><span id="l1.2301">         // DIGEST_LENGTH characters, so it will be twice that length.</span>
<a href="#l1.2302"></a><span id="l1.2302">         nsAutoCStringN&lt;2 * DIGEST_LENGTH&gt; encodedDigest;</span>
<a href="#l1.2303"></a><span id="l1.2303"> </span>
<a href="#l1.2304"></a><span id="l1.2304" class="difflineminus">-        for (uint32_t j = 0; j &lt; DIGEST_LENGTH; j++)</span>
<a href="#l1.2305"></a><span id="l1.2305" class="difflineminus">-        {</span>
<a href="#l1.2306"></a><span id="l1.2306" class="difflineplus">+        for (uint32_t j = 0; j &lt; DIGEST_LENGTH; j++) {</span>
<a href="#l1.2307"></a><span id="l1.2307">           char hexVal[3];</span>
<a href="#l1.2308"></a><span id="l1.2308" class="difflineminus">-          PR_snprintf (hexVal, 3, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l1.2309"></a><span id="l1.2309" class="difflineplus">+          PR_snprintf(hexVal, 3, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l1.2310"></a><span id="l1.2310">           encodedDigest.Append(hexVal);</span>
<a href="#l1.2311"></a><span id="l1.2311">         }</span>
<a href="#l1.2312"></a><span id="l1.2312"> </span>
<a href="#l1.2313"></a><span id="l1.2313">         nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.2314"></a><span id="l1.2314">         rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.2315"></a><span id="l1.2315">         if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l1.2316"></a><span id="l1.2316"> </span>
<a href="#l1.2317"></a><span id="l1.2317">         nsCString userName;</span>
<a href="#l1.2318"></a><span id="l1.2318">         rv = smtpServer-&gt;GetUsername(userName);</span>
<a href="#l1.2319"></a><span id="l1.2319"> </span>
<a href="#l1.2320"></a><span id="l1.2320" class="difflineminus">-        if (userName.Length() &gt; 255)</span>
<a href="#l1.2321"></a><span id="l1.2321" class="difflineminus">-          userName.Truncate(255);</span>
<a href="#l1.2322"></a><span id="l1.2322" class="difflineminus">-        PR_snprintf(buffer, sizeof(buffer), &quot;%s %s&quot;, userName.get(), encodedDigest.get());</span>
<a href="#l1.2323"></a><span id="l1.2323" class="difflineplus">+        if (userName.Length() &gt; 255) userName.Truncate(255);</span>
<a href="#l1.2324"></a><span id="l1.2324" class="difflineplus">+        PR_snprintf(buffer, sizeof(buffer), &quot;%s %s&quot;, userName.get(),</span>
<a href="#l1.2325"></a><span id="l1.2325" class="difflineplus">+                    encodedDigest.get());</span>
<a href="#l1.2326"></a><span id="l1.2326">         char *base64Str = PL_Base64Encode(buffer, strlen(buffer), nullptr);</span>
<a href="#l1.2327"></a><span id="l1.2327">         PR_snprintf(buffer, sizeof(buffer), &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l1.2328"></a><span id="l1.2328">         free(base64Str);</span>
<a href="#l1.2329"></a><span id="l1.2329">       }</span>
<a href="#l1.2330"></a><span id="l1.2330" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l1.2331"></a><span id="l1.2331" class="difflineminus">-        PR_snprintf(buffer, sizeof(buffer), &quot;*&quot; CRLF);</span>
<a href="#l1.2332"></a><span id="l1.2332" class="difflineminus">-    }</span>
<a href="#l1.2333"></a><span id="l1.2333" class="difflineminus">-    else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l1.2334"></a><span id="l1.2334" class="difflineminus">-             m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l1.2335"></a><span id="l1.2335" class="difflineminus">-    {</span>
<a href="#l1.2336"></a><span id="l1.2336" class="difflineminus">-      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;NTLM/MSN auth, step 2&quot;));</span>
<a href="#l1.2337"></a><span id="l1.2337" class="difflineplus">+      if (NS_FAILED(rv)) PR_snprintf(buffer, sizeof(buffer), &quot;*&quot; CRLF);</span>
<a href="#l1.2338"></a><span id="l1.2338" class="difflineplus">+    } else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l1.2339"></a><span id="l1.2339" class="difflineplus">+               m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED) {</span>
<a href="#l1.2340"></a><span id="l1.2340" class="difflineplus">+      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.2341"></a><span id="l1.2341" class="difflineplus">+              (&quot;NTLM/MSN auth, step 2&quot;));</span>
<a href="#l1.2342"></a><span id="l1.2342">       nsAutoCString response;</span>
<a href="#l1.2343"></a><span id="l1.2343">       rv = DoNtlmStep2(m_responseText, response);</span>
<a href="#l1.2344"></a><span id="l1.2344">       PR_snprintf(buffer, sizeof(buffer), &quot;%.512s&quot; CRLF, response.get());</span>
<a href="#l1.2345"></a><span id="l1.2345" class="difflineminus">-    }</span>
<a href="#l1.2346"></a><span id="l1.2346" class="difflineminus">-    else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED)</span>
<a href="#l1.2347"></a><span id="l1.2347" class="difflineminus">-    {</span>
<a href="#l1.2348"></a><span id="l1.2348" class="difflineplus">+    } else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED) {</span>
<a href="#l1.2349"></a><span id="l1.2349">       MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;PLAIN auth, step 2&quot;));</span>
<a href="#l1.2350"></a><span id="l1.2350" class="difflineminus">-      if (passwordUTF8.Length() &gt; 255)</span>
<a href="#l1.2351"></a><span id="l1.2351" class="difflineminus">-        passwordUTF8.Truncate(255);</span>
<a href="#l1.2352"></a><span id="l1.2352" class="difflineminus">-      char *base64Str = PL_Base64Encode(passwordUTF8.get(), passwordUTF8.Length(), nullptr);</span>
<a href="#l1.2353"></a><span id="l1.2353" class="difflineplus">+      if (passwordUTF8.Length() &gt; 255) passwordUTF8.Truncate(255);</span>
<a href="#l1.2354"></a><span id="l1.2354" class="difflineplus">+      char *base64Str =</span>
<a href="#l1.2355"></a><span id="l1.2355" class="difflineplus">+          PL_Base64Encode(passwordUTF8.get(), passwordUTF8.Length(), nullptr);</span>
<a href="#l1.2356"></a><span id="l1.2356">       // Base64 encoding of 255 bytes gives 340 bytes.</span>
<a href="#l1.2357"></a><span id="l1.2357">       PR_snprintf(buffer, sizeof(buffer), &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l1.2358"></a><span id="l1.2358">       free(base64Str);</span>
<a href="#l1.2359"></a><span id="l1.2359" class="difflineminus">-    }</span>
<a href="#l1.2360"></a><span id="l1.2360" class="difflineminus">-    else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l1.2361"></a><span id="l1.2361" class="difflineminus">-    {</span>
<a href="#l1.2362"></a><span id="l1.2362" class="difflineplus">+    } else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED) {</span>
<a href="#l1.2363"></a><span id="l1.2363">       MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;LOGIN auth, step 2&quot;));</span>
<a href="#l1.2364"></a><span id="l1.2364" class="difflineminus">-      bool useLatin1 =</span>
<a href="#l1.2365"></a><span id="l1.2365" class="difflineminus">-        mozilla::Preferences::GetBool(&quot;mail.smtp_login_pop3_user_pass_auth_is_latin1&quot;, true);</span>
<a href="#l1.2366"></a><span id="l1.2366" class="difflineplus">+      bool useLatin1 = mozilla::Preferences::GetBool(</span>
<a href="#l1.2367"></a><span id="l1.2367" class="difflineplus">+          &quot;mail.smtp_login_pop3_user_pass_auth_is_latin1&quot;, true);</span>
<a href="#l1.2368"></a><span id="l1.2368">       if (useLatin1)</span>
<a href="#l1.2369"></a><span id="l1.2369" class="difflineminus">-        passwordUTF8 = NS_LossyConvertUTF16toASCII(password);  // Don't use UTF-8 after all.</span>
<a href="#l1.2370"></a><span id="l1.2370" class="difflineminus">-      if (passwordUTF8.Length() &gt; 255)</span>
<a href="#l1.2371"></a><span id="l1.2371" class="difflineminus">-        passwordUTF8.Truncate(255);</span>
<a href="#l1.2372"></a><span id="l1.2372" class="difflineminus">-      char *base64Str = PL_Base64Encode(passwordUTF8.get(), passwordUTF8.Length(), nullptr);</span>
<a href="#l1.2373"></a><span id="l1.2373" class="difflineplus">+        passwordUTF8 = NS_LossyConvertUTF16toASCII(</span>
<a href="#l1.2374"></a><span id="l1.2374" class="difflineplus">+            password);  // Don't use UTF-8 after all.</span>
<a href="#l1.2375"></a><span id="l1.2375" class="difflineplus">+      if (passwordUTF8.Length() &gt; 255) passwordUTF8.Truncate(255);</span>
<a href="#l1.2376"></a><span id="l1.2376" class="difflineplus">+      char *base64Str =</span>
<a href="#l1.2377"></a><span id="l1.2377" class="difflineplus">+          PL_Base64Encode(passwordUTF8.get(), passwordUTF8.Length(), nullptr);</span>
<a href="#l1.2378"></a><span id="l1.2378">       // Base64 encoding of 255 bytes gives 340 bytes.</span>
<a href="#l1.2379"></a><span id="l1.2379">       PR_snprintf(buffer, sizeof(buffer), &quot;%s&quot; CRLF, base64Str);</span>
<a href="#l1.2380"></a><span id="l1.2380">       free(base64Str);</span>
<a href="#l1.2381"></a><span id="l1.2381" class="difflineminus">-    }</span>
<a href="#l1.2382"></a><span id="l1.2382" class="difflineminus">-    else</span>
<a href="#l1.2383"></a><span id="l1.2383" class="difflineplus">+    } else</span>
<a href="#l1.2384"></a><span id="l1.2384">       return NS_ERROR_COMMUNICATIONS_ERROR;</span>
<a href="#l1.2385"></a><span id="l1.2385"> </span>
<a href="#l1.2386"></a><span id="l1.2386">     status = SendData(buffer, true);</span>
<a href="#l1.2387"></a><span id="l1.2387">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2388"></a><span id="l1.2388">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l1.2389"></a><span id="l1.2389">     SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2390"></a><span id="l1.2390">     return (status);</span>
<a href="#l1.2391"></a><span id="l1.2391">   }</span>
<a href="#l1.2392"></a><span id="l1.2392"> </span>
<a href="#l1.2393"></a><span id="l1.2393">   // XXX -1 is not a valid nsresult</span>
<a href="#l1.2394"></a><span id="l1.2394">   return static_cast&lt;nsresult&gt;(-1);</span>
<a href="#l1.2395"></a><span id="l1.2395"> }</span>
<a href="#l1.2396"></a><span id="l1.2396"> </span>
<a href="#l1.2397"></a><span id="l1.2397" class="difflineminus">-nsresult nsSmtpProtocol::AuthOAuth2Step1()</span>
<a href="#l1.2398"></a><span id="l1.2398" class="difflineminus">-{</span>
<a href="#l1.2399"></a><span id="l1.2399" class="difflineplus">+nsresult nsSmtpProtocol::AuthOAuth2Step1() {</span>
<a href="#l1.2400"></a><span id="l1.2400">   MOZ_ASSERT(mOAuth2Support, &quot;Can't do anything without OAuth2 support&quot;);</span>
<a href="#l1.2401"></a><span id="l1.2401"> </span>
<a href="#l1.2402"></a><span id="l1.2402">   nsresult rv = mOAuth2Support-&gt;Connect(true, this);</span>
<a href="#l1.2403"></a><span id="l1.2403">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2404"></a><span id="l1.2404"> </span>
<a href="#l1.2405"></a><span id="l1.2405">   m_nextState = SMTP_SUSPENDED;</span>
<a href="#l1.2406"></a><span id="l1.2406">   return NS_OK;</span>
<a href="#l1.2407"></a><span id="l1.2407"> }</span>
<a href="#l1.2408"></a><span id="l1.2408"> </span>
<a href="#l1.2409"></a><span id="l1.2409" class="difflineminus">-nsresult nsSmtpProtocol::OnSuccess(const nsACString &amp;aOAuth2String)</span>
<a href="#l1.2410"></a><span id="l1.2410" class="difflineminus">-{</span>
<a href="#l1.2411"></a><span id="l1.2411" class="difflineplus">+nsresult nsSmtpProtocol::OnSuccess(const nsACString &amp;aOAuth2String) {</span>
<a href="#l1.2412"></a><span id="l1.2412">   MOZ_ASSERT(mOAuth2Support, &quot;Can't do anything without OAuth2 support&quot;);</span>
<a href="#l1.2413"></a><span id="l1.2413"> </span>
<a href="#l1.2414"></a><span id="l1.2414">   // Send the AUTH XOAUTH2 command, and then siphon us back to the regular</span>
<a href="#l1.2415"></a><span id="l1.2415">   // authentication login stream.</span>
<a href="#l1.2416"></a><span id="l1.2416">   nsAutoCString buffer;</span>
<a href="#l1.2417"></a><span id="l1.2417">   buffer.AppendLiteral(&quot;AUTH XOAUTH2 &quot;);</span>
<a href="#l1.2418"></a><span id="l1.2418">   buffer += aOAuth2String;</span>
<a href="#l1.2419"></a><span id="l1.2419">   buffer += CRLF;</span>
<a href="#l1.2420"></a><span id="l1.2420">   nsresult rv = SendData(buffer.get(), true);</span>
<a href="#l1.2421"></a><span id="l1.2421" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.2422"></a><span id="l1.2422" class="difflineminus">-  {</span>
<a href="#l1.2423"></a><span id="l1.2423" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l1.2424"></a><span id="l1.2424">     m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.2425"></a><span id="l1.2425" class="difflineminus">-  }</span>
<a href="#l1.2426"></a><span id="l1.2426" class="difflineminus">-  else</span>
<a href="#l1.2427"></a><span id="l1.2427" class="difflineminus">-  {</span>
<a href="#l1.2428"></a><span id="l1.2428" class="difflineplus">+  } else {</span>
<a href="#l1.2429"></a><span id="l1.2429">     m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2430"></a><span id="l1.2430">     m_nextStateAfterResponse = SMTP_AUTH_LOGIN_RESPONSE;</span>
<a href="#l1.2431"></a><span id="l1.2431">   }</span>
<a href="#l1.2432"></a><span id="l1.2432"> </span>
<a href="#l1.2433"></a><span id="l1.2433">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2434"></a><span id="l1.2434"> </span>
<a href="#l1.2435"></a><span id="l1.2435">   ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l1.2436"></a><span id="l1.2436">   return NS_OK;</span>
<a href="#l1.2437"></a><span id="l1.2437"> }</span>
<a href="#l1.2438"></a><span id="l1.2438"> </span>
<a href="#l1.2439"></a><span id="l1.2439" class="difflineminus">-nsresult nsSmtpProtocol::OnFailure(nsresult aError)</span>
<a href="#l1.2440"></a><span id="l1.2440" class="difflineminus">-{</span>
<a href="#l1.2441"></a><span id="l1.2441" class="difflineminus">-  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;OAuth2 login error %08x&quot;,</span>
<a href="#l1.2442"></a><span id="l1.2442" class="difflineminus">-    (uint32_t)aError));</span>
<a href="#l1.2443"></a><span id="l1.2443" class="difflineplus">+nsresult nsSmtpProtocol::OnFailure(nsresult aError) {</span>
<a href="#l1.2444"></a><span id="l1.2444" class="difflineplus">+  MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.2445"></a><span id="l1.2445" class="difflineplus">+          (&quot;OAuth2 login error %08x&quot;, (uint32_t)aError));</span>
<a href="#l1.2446"></a><span id="l1.2446">   m_urlErrorState = aError;</span>
<a href="#l1.2447"></a><span id="l1.2447">   m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.2448"></a><span id="l1.2448">   return ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l1.2449"></a><span id="l1.2449"> }</span>
<a href="#l1.2450"></a><span id="l1.2450"> </span>
<a href="#l1.2451"></a><span id="l1.2451" class="difflineminus">-</span>
<a href="#l1.2452"></a><span id="l1.2452" class="difflineminus">-nsresult nsSmtpProtocol::SendMailResponse()</span>
<a href="#l1.2453"></a><span id="l1.2453" class="difflineminus">-{</span>
<a href="#l1.2454"></a><span id="l1.2454" class="difflineplus">+nsresult nsSmtpProtocol::SendMailResponse() {</span>
<a href="#l1.2455"></a><span id="l1.2455">   nsresult status = NS_OK;</span>
<a href="#l1.2456"></a><span id="l1.2456">   nsAutoCString buffer;</span>
<a href="#l1.2457"></a><span id="l1.2457">   nsresult rv;</span>
<a href="#l1.2458"></a><span id="l1.2458"> </span>
<a href="#l1.2459"></a><span id="l1.2459" class="difflineminus">-  if (m_responseCode/10 != 25)</span>
<a href="#l1.2460"></a><span id="l1.2460" class="difflineminus">-  {</span>
<a href="#l1.2461"></a><span id="l1.2461" class="difflineplus">+  if (m_responseCode / 10 != 25) {</span>
<a href="#l1.2462"></a><span id="l1.2462">     nsresult errorcode;</span>
<a href="#l1.2463"></a><span id="l1.2463">     if ((m_responseCodeEnhanced == 570) || (m_responseCodeEnhanced == 571))</span>
<a href="#l1.2464"></a><span id="l1.2464">       errorcode = NS_ERROR_SMTP_SEND_NOT_ALLOWED;</span>
<a href="#l1.2465"></a><span id="l1.2465">     else if (TestFlag(SMTP_EHLO_SIZE_ENABLED))</span>
<a href="#l1.2466"></a><span id="l1.2466" class="difflineminus">-      errorcode = (m_responseCode == 452) ? NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED :</span>
<a href="#l1.2467"></a><span id="l1.2467" class="difflineminus">-                  (m_responseCode == 552) ? NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_2 :</span>
<a href="#l1.2468"></a><span id="l1.2468" class="difflineminus">-                  NS_ERROR_SENDING_FROM_COMMAND;</span>
<a href="#l1.2469"></a><span id="l1.2469" class="difflineplus">+      errorcode = (m_responseCode == 452)</span>
<a href="#l1.2470"></a><span id="l1.2470" class="difflineplus">+                      ? NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED</span>
<a href="#l1.2471"></a><span id="l1.2471" class="difflineplus">+                      : (m_responseCode == 552)</span>
<a href="#l1.2472"></a><span id="l1.2472" class="difflineplus">+                            ? NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_2</span>
<a href="#l1.2473"></a><span id="l1.2473" class="difflineplus">+                            : NS_ERROR_SENDING_FROM_COMMAND;</span>
<a href="#l1.2474"></a><span id="l1.2474">     else</span>
<a href="#l1.2475"></a><span id="l1.2475">       errorcode = NS_ERROR_SENDING_FROM_COMMAND;</span>
<a href="#l1.2476"></a><span id="l1.2476"> </span>
<a href="#l1.2477"></a><span id="l1.2477" class="difflineminus">-    rv = nsExplainErrorDetails(m_runningURL, errorcode, m_responseText.get(), nullptr);</span>
<a href="#l1.2478"></a><span id="l1.2478" class="difflineplus">+    rv = nsExplainErrorDetails(m_runningURL, errorcode, m_responseText.get(),</span>
<a href="#l1.2479"></a><span id="l1.2479" class="difflineplus">+                               nullptr);</span>
<a href="#l1.2480"></a><span id="l1.2480">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.2481"></a><span id="l1.2481"> </span>
<a href="#l1.2482"></a><span id="l1.2482">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.2483"></a><span id="l1.2483" class="difflineminus">-    return(NS_ERROR_SENDING_FROM_COMMAND);</span>
<a href="#l1.2484"></a><span id="l1.2484" class="difflineplus">+    return (NS_ERROR_SENDING_FROM_COMMAND);</span>
<a href="#l1.2485"></a><span id="l1.2485">   }</span>
<a href="#l1.2486"></a><span id="l1.2486"> </span>
<a href="#l1.2487"></a><span id="l1.2487">   /* Send the RCPT TO: command */</span>
<a href="#l1.2488"></a><span id="l1.2488">   bool requestDSN = false;</span>
<a href="#l1.2489"></a><span id="l1.2489">   rv = m_runningURL-&gt;GetRequestDSN(&amp;requestDSN);</span>
<a href="#l1.2490"></a><span id="l1.2490"> </span>
<a href="#l1.2491"></a><span id="l1.2491" class="difflineminus">-  nsCOMPtr &lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2492"></a><span id="l1.2492" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2493"></a><span id="l1.2493" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l1.2494"></a><span id="l1.2494" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2495"></a><span id="l1.2495" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2496"></a><span id="l1.2496"> </span>
<a href="#l1.2497"></a><span id="l1.2497">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l1.2498"></a><span id="l1.2498">   rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l1.2499"></a><span id="l1.2499" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2500"></a><span id="l1.2500" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2501"></a><span id="l1.2501"> </span>
<a href="#l1.2502"></a><span id="l1.2502">   bool requestOnSuccess = false;</span>
<a href="#l1.2503"></a><span id="l1.2503" class="difflineminus">-  rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.request_on_success_on&quot;, &amp;requestOnSuccess);</span>
<a href="#l1.2504"></a><span id="l1.2504" class="difflineplus">+  rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.request_on_success_on&quot;,</span>
<a href="#l1.2505"></a><span id="l1.2505" class="difflineplus">+                               &amp;requestOnSuccess);</span>
<a href="#l1.2506"></a><span id="l1.2506"> </span>
<a href="#l1.2507"></a><span id="l1.2507">   bool requestOnFailure = false;</span>
<a href="#l1.2508"></a><span id="l1.2508" class="difflineminus">-  rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.request_on_failure_on&quot;, &amp;requestOnFailure);</span>
<a href="#l1.2509"></a><span id="l1.2509" class="difflineplus">+  rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.request_on_failure_on&quot;,</span>
<a href="#l1.2510"></a><span id="l1.2510" class="difflineplus">+                               &amp;requestOnFailure);</span>
<a href="#l1.2511"></a><span id="l1.2511"> </span>
<a href="#l1.2512"></a><span id="l1.2512">   bool requestOnDelay = false;</span>
<a href="#l1.2513"></a><span id="l1.2513">   rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.request_on_delay_on&quot;, &amp;requestOnDelay);</span>
<a href="#l1.2514"></a><span id="l1.2514"> </span>
<a href="#l1.2515"></a><span id="l1.2515">   bool requestOnNever = false;</span>
<a href="#l1.2516"></a><span id="l1.2516">   rv = prefBranch-&gt;GetBoolPref(&quot;mail.dsn.request_never_on&quot;, &amp;requestOnNever);</span>
<a href="#l1.2517"></a><span id="l1.2517"> </span>
<a href="#l1.2518"></a><span id="l1.2518">   nsCString &amp;address = m_addresses[m_addressesLeft - 1];</span>
<a href="#l1.2519"></a><span id="l1.2519" class="difflineminus">-  if (TestFlag(SMTP_EHLO_DSN_ENABLED) &amp;&amp; requestDSN &amp;&amp; (requestOnSuccess || requestOnFailure || requestOnDelay || requestOnNever))</span>
<a href="#l1.2520"></a><span id="l1.2520" class="difflineminus">-    {</span>
<a href="#l1.2521"></a><span id="l1.2521" class="difflineminus">-      char *encodedAddress = esmtp_value_encode(address.get());</span>
<a href="#l1.2522"></a><span id="l1.2522" class="difflineminus">-      nsAutoCString dsnBuffer;</span>
<a href="#l1.2523"></a><span id="l1.2523" class="difflineminus">-</span>
<a href="#l1.2524"></a><span id="l1.2524" class="difflineminus">-      if (encodedAddress)</span>
<a href="#l1.2525"></a><span id="l1.2525" class="difflineminus">-      {</span>
<a href="#l1.2526"></a><span id="l1.2526" class="difflineminus">-        buffer = &quot;RCPT TO:&lt;&quot;;</span>
<a href="#l1.2527"></a><span id="l1.2527" class="difflineminus">-        buffer += address;</span>
<a href="#l1.2528"></a><span id="l1.2528" class="difflineminus">-        buffer += &quot;&gt; NOTIFY=&quot;;</span>
<a href="#l1.2529"></a><span id="l1.2529" class="difflineminus">-</span>
<a href="#l1.2530"></a><span id="l1.2530" class="difflineminus">-        if (requestOnNever)</span>
<a href="#l1.2531"></a><span id="l1.2531" class="difflineminus">-          dsnBuffer += &quot;NEVER&quot;;</span>
<a href="#l1.2532"></a><span id="l1.2532" class="difflineminus">-        else</span>
<a href="#l1.2533"></a><span id="l1.2533" class="difflineminus">-        {</span>
<a href="#l1.2534"></a><span id="l1.2534" class="difflineminus">-          if (requestOnSuccess)</span>
<a href="#l1.2535"></a><span id="l1.2535" class="difflineminus">-            dsnBuffer += &quot;SUCCESS&quot;;</span>
<a href="#l1.2536"></a><span id="l1.2536" class="difflineplus">+  if (TestFlag(SMTP_EHLO_DSN_ENABLED) &amp;&amp; requestDSN &amp;&amp;</span>
<a href="#l1.2537"></a><span id="l1.2537" class="difflineplus">+      (requestOnSuccess || requestOnFailure || requestOnDelay ||</span>
<a href="#l1.2538"></a><span id="l1.2538" class="difflineplus">+       requestOnNever)) {</span>
<a href="#l1.2539"></a><span id="l1.2539" class="difflineplus">+    char *encodedAddress = esmtp_value_encode(address.get());</span>
<a href="#l1.2540"></a><span id="l1.2540" class="difflineplus">+    nsAutoCString dsnBuffer;</span>
<a href="#l1.2541"></a><span id="l1.2541"> </span>
<a href="#l1.2542"></a><span id="l1.2542" class="difflineminus">-          if (requestOnFailure)</span>
<a href="#l1.2543"></a><span id="l1.2543" class="difflineminus">-            dsnBuffer += dsnBuffer.IsEmpty() ? &quot;FAILURE&quot; : &quot;,FAILURE&quot;;</span>
<a href="#l1.2544"></a><span id="l1.2544" class="difflineminus">-</span>
<a href="#l1.2545"></a><span id="l1.2545" class="difflineminus">-          if (requestOnDelay)</span>
<a href="#l1.2546"></a><span id="l1.2546" class="difflineminus">-            dsnBuffer += dsnBuffer.IsEmpty() ? &quot;DELAY&quot; : &quot;,DELAY&quot;;</span>
<a href="#l1.2547"></a><span id="l1.2547" class="difflineminus">-        }</span>
<a href="#l1.2548"></a><span id="l1.2548" class="difflineminus">-</span>
<a href="#l1.2549"></a><span id="l1.2549" class="difflineminus">-        buffer += dsnBuffer;</span>
<a href="#l1.2550"></a><span id="l1.2550" class="difflineminus">-        buffer += &quot; ORCPT=rfc822;&quot;;</span>
<a href="#l1.2551"></a><span id="l1.2551" class="difflineminus">-        buffer += encodedAddress;</span>
<a href="#l1.2552"></a><span id="l1.2552" class="difflineminus">-        buffer += CRLF;</span>
<a href="#l1.2553"></a><span id="l1.2553" class="difflineminus">-        PR_FREEIF(encodedAddress);</span>
<a href="#l1.2554"></a><span id="l1.2554" class="difflineminus">-      }</span>
<a href="#l1.2555"></a><span id="l1.2555" class="difflineminus">-      else</span>
<a href="#l1.2556"></a><span id="l1.2556" class="difflineminus">-      {</span>
<a href="#l1.2557"></a><span id="l1.2557" class="difflineminus">-        m_urlErrorState = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.2558"></a><span id="l1.2558" class="difflineminus">-        return (NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l1.2559"></a><span id="l1.2559" class="difflineminus">-      }</span>
<a href="#l1.2560"></a><span id="l1.2560" class="difflineminus">-    }</span>
<a href="#l1.2561"></a><span id="l1.2561" class="difflineminus">-    else</span>
<a href="#l1.2562"></a><span id="l1.2562" class="difflineminus">-    {</span>
<a href="#l1.2563"></a><span id="l1.2563" class="difflineplus">+    if (encodedAddress) {</span>
<a href="#l1.2564"></a><span id="l1.2564">       buffer = &quot;RCPT TO:&lt;&quot;;</span>
<a href="#l1.2565"></a><span id="l1.2565">       buffer += address;</span>
<a href="#l1.2566"></a><span id="l1.2566" class="difflineminus">-      buffer += &quot;&gt;&quot;;</span>
<a href="#l1.2567"></a><span id="l1.2567" class="difflineminus">-      buffer += CRLF;</span>
<a href="#l1.2568"></a><span id="l1.2568" class="difflineminus">-    }</span>
<a href="#l1.2569"></a><span id="l1.2569" class="difflineminus">-    status = SendData(buffer.get());</span>
<a href="#l1.2570"></a><span id="l1.2570" class="difflineplus">+      buffer += &quot;&gt; NOTIFY=&quot;;</span>
<a href="#l1.2571"></a><span id="l1.2571" class="difflineplus">+</span>
<a href="#l1.2572"></a><span id="l1.2572" class="difflineplus">+      if (requestOnNever)</span>
<a href="#l1.2573"></a><span id="l1.2573" class="difflineplus">+        dsnBuffer += &quot;NEVER&quot;;</span>
<a href="#l1.2574"></a><span id="l1.2574" class="difflineplus">+      else {</span>
<a href="#l1.2575"></a><span id="l1.2575" class="difflineplus">+        if (requestOnSuccess) dsnBuffer += &quot;SUCCESS&quot;;</span>
<a href="#l1.2576"></a><span id="l1.2576" class="difflineplus">+</span>
<a href="#l1.2577"></a><span id="l1.2577" class="difflineplus">+        if (requestOnFailure)</span>
<a href="#l1.2578"></a><span id="l1.2578" class="difflineplus">+          dsnBuffer += dsnBuffer.IsEmpty() ? &quot;FAILURE&quot; : &quot;,FAILURE&quot;;</span>
<a href="#l1.2579"></a><span id="l1.2579" class="difflineplus">+</span>
<a href="#l1.2580"></a><span id="l1.2580" class="difflineplus">+        if (requestOnDelay)</span>
<a href="#l1.2581"></a><span id="l1.2581" class="difflineplus">+          dsnBuffer += dsnBuffer.IsEmpty() ? &quot;DELAY&quot; : &quot;,DELAY&quot;;</span>
<a href="#l1.2582"></a><span id="l1.2582" class="difflineplus">+      }</span>
<a href="#l1.2583"></a><span id="l1.2583"> </span>
<a href="#l1.2584"></a><span id="l1.2584" class="difflineminus">-    m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2585"></a><span id="l1.2585" class="difflineminus">-    m_nextStateAfterResponse = SMTP_SEND_RCPT_RESPONSE;</span>
<a href="#l1.2586"></a><span id="l1.2586" class="difflineminus">-    SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2587"></a><span id="l1.2587" class="difflineplus">+      buffer += dsnBuffer;</span>
<a href="#l1.2588"></a><span id="l1.2588" class="difflineplus">+      buffer += &quot; ORCPT=rfc822;&quot;;</span>
<a href="#l1.2589"></a><span id="l1.2589" class="difflineplus">+      buffer += encodedAddress;</span>
<a href="#l1.2590"></a><span id="l1.2590" class="difflineplus">+      buffer += CRLF;</span>
<a href="#l1.2591"></a><span id="l1.2591" class="difflineplus">+      PR_FREEIF(encodedAddress);</span>
<a href="#l1.2592"></a><span id="l1.2592" class="difflineplus">+    } else {</span>
<a href="#l1.2593"></a><span id="l1.2593" class="difflineplus">+      m_urlErrorState = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.2594"></a><span id="l1.2594" class="difflineplus">+      return (NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l1.2595"></a><span id="l1.2595" class="difflineplus">+    }</span>
<a href="#l1.2596"></a><span id="l1.2596" class="difflineplus">+  } else {</span>
<a href="#l1.2597"></a><span id="l1.2597" class="difflineplus">+    buffer = &quot;RCPT TO:&lt;&quot;;</span>
<a href="#l1.2598"></a><span id="l1.2598" class="difflineplus">+    buffer += address;</span>
<a href="#l1.2599"></a><span id="l1.2599" class="difflineplus">+    buffer += &quot;&gt;&quot;;</span>
<a href="#l1.2600"></a><span id="l1.2600" class="difflineplus">+    buffer += CRLF;</span>
<a href="#l1.2601"></a><span id="l1.2601" class="difflineplus">+  }</span>
<a href="#l1.2602"></a><span id="l1.2602" class="difflineplus">+  status = SendData(buffer.get());</span>
<a href="#l1.2603"></a><span id="l1.2603"> </span>
<a href="#l1.2604"></a><span id="l1.2604" class="difflineminus">-    return(status);</span>
<a href="#l1.2605"></a><span id="l1.2605" class="difflineplus">+  m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2606"></a><span id="l1.2606" class="difflineplus">+  m_nextStateAfterResponse = SMTP_SEND_RCPT_RESPONSE;</span>
<a href="#l1.2607"></a><span id="l1.2607" class="difflineplus">+  SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2608"></a><span id="l1.2608" class="difflineplus">+</span>
<a href="#l1.2609"></a><span id="l1.2609" class="difflineplus">+  return (status);</span>
<a href="#l1.2610"></a><span id="l1.2610"> }</span>
<a href="#l1.2611"></a><span id="l1.2611"> </span>
<a href="#l1.2612"></a><span id="l1.2612" class="difflineminus">-nsresult nsSmtpProtocol::SendRecipientResponse()</span>
<a href="#l1.2613"></a><span id="l1.2613" class="difflineminus">-{</span>
<a href="#l1.2614"></a><span id="l1.2614" class="difflineplus">+nsresult nsSmtpProtocol::SendRecipientResponse() {</span>
<a href="#l1.2615"></a><span id="l1.2615">   nsresult status = NS_OK;</span>
<a href="#l1.2616"></a><span id="l1.2616">   nsAutoCString buffer;</span>
<a href="#l1.2617"></a><span id="l1.2617">   nsresult rv;</span>
<a href="#l1.2618"></a><span id="l1.2618"> </span>
<a href="#l1.2619"></a><span id="l1.2619" class="difflineminus">-  if (m_responseCode / 10 != 25)</span>
<a href="#l1.2620"></a><span id="l1.2620" class="difflineminus">-  {</span>
<a href="#l1.2621"></a><span id="l1.2621" class="difflineplus">+  if (m_responseCode / 10 != 25) {</span>
<a href="#l1.2622"></a><span id="l1.2622">     nsresult errorcode;</span>
<a href="#l1.2623"></a><span id="l1.2623">     if ((m_responseCodeEnhanced == 570) || (m_responseCodeEnhanced == 571))</span>
<a href="#l1.2624"></a><span id="l1.2624">       errorcode = NS_ERROR_SMTP_SEND_NOT_ALLOWED;</span>
<a href="#l1.2625"></a><span id="l1.2625">     else if (TestFlag(SMTP_EHLO_SIZE_ENABLED))</span>
<a href="#l1.2626"></a><span id="l1.2626" class="difflineminus">-      errorcode = (m_responseCode == 452) ? NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED :</span>
<a href="#l1.2627"></a><span id="l1.2627" class="difflineminus">-                  (m_responseCode == 552) ? NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_2 :</span>
<a href="#l1.2628"></a><span id="l1.2628" class="difflineminus">-                  NS_ERROR_SENDING_RCPT_COMMAND;</span>
<a href="#l1.2629"></a><span id="l1.2629" class="difflineplus">+      errorcode = (m_responseCode == 452)</span>
<a href="#l1.2630"></a><span id="l1.2630" class="difflineplus">+                      ? NS_ERROR_SMTP_TEMP_SIZE_EXCEEDED</span>
<a href="#l1.2631"></a><span id="l1.2631" class="difflineplus">+                      : (m_responseCode == 552)</span>
<a href="#l1.2632"></a><span id="l1.2632" class="difflineplus">+                            ? NS_ERROR_SMTP_PERM_SIZE_EXCEEDED_2</span>
<a href="#l1.2633"></a><span id="l1.2633" class="difflineplus">+                            : NS_ERROR_SENDING_RCPT_COMMAND;</span>
<a href="#l1.2634"></a><span id="l1.2634">     else</span>
<a href="#l1.2635"></a><span id="l1.2635">       errorcode = NS_ERROR_SENDING_RCPT_COMMAND;</span>
<a href="#l1.2636"></a><span id="l1.2636"> </span>
<a href="#l1.2637"></a><span id="l1.2637" class="difflineminus">-    rv = nsExplainErrorDetails(m_runningURL, errorcode,</span>
<a href="#l1.2638"></a><span id="l1.2638" class="difflineminus">-                               m_responseText.get(),</span>
<a href="#l1.2639"></a><span id="l1.2639" class="difflineplus">+    rv = nsExplainErrorDetails(m_runningURL, errorcode, m_responseText.get(),</span>
<a href="#l1.2640"></a><span id="l1.2640">                                m_addresses[m_addressesLeft - 1].get());</span>
<a href="#l1.2641"></a><span id="l1.2641"> </span>
<a href="#l1.2642"></a><span id="l1.2642" class="difflineminus">-    if (!NS_SUCCEEDED(rv))</span>
<a href="#l1.2643"></a><span id="l1.2643" class="difflineminus">-      NS_ASSERTION(false, &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.2644"></a><span id="l1.2644" class="difflineplus">+    if (!NS_SUCCEEDED(rv)) NS_ASSERTION(false, &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.2645"></a><span id="l1.2645"> </span>
<a href="#l1.2646"></a><span id="l1.2646">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.2647"></a><span id="l1.2647" class="difflineminus">-    return(NS_ERROR_SENDING_RCPT_COMMAND);</span>
<a href="#l1.2648"></a><span id="l1.2648" class="difflineplus">+    return (NS_ERROR_SENDING_RCPT_COMMAND);</span>
<a href="#l1.2649"></a><span id="l1.2649">   }</span>
<a href="#l1.2650"></a><span id="l1.2650"> </span>
<a href="#l1.2651"></a><span id="l1.2651" class="difflineminus">-  if (--m_addressesLeft &gt; 0)</span>
<a href="#l1.2652"></a><span id="l1.2652" class="difflineminus">-  {</span>
<a href="#l1.2653"></a><span id="l1.2653" class="difflineplus">+  if (--m_addressesLeft &gt; 0) {</span>
<a href="#l1.2654"></a><span id="l1.2654">     // more senders to RCPT to</span>
<a href="#l1.2655"></a><span id="l1.2655">     // fake to 250 because SendMailResponse() can't handle 251</span>
<a href="#l1.2656"></a><span id="l1.2656">     m_responseCode = 250;</span>
<a href="#l1.2657"></a><span id="l1.2657">     m_nextState = SMTP_SEND_MAIL_RESPONSE;</span>
<a href="#l1.2658"></a><span id="l1.2658">     return NS_OK;</span>
<a href="#l1.2659"></a><span id="l1.2659">   }</span>
<a href="#l1.2660"></a><span id="l1.2660"> </span>
<a href="#l1.2661"></a><span id="l1.2661">   /* else send the DATA command */</span>
<a href="#l1.2662"></a><span id="l1.2662">   buffer = &quot;DATA&quot;;</span>
<a href="#l1.2663"></a><span id="l1.2663">   buffer += CRLF;</span>
<a href="#l1.2664"></a><span id="l1.2664">   status = SendData(buffer.get());</span>
<a href="#l1.2665"></a><span id="l1.2665"> </span>
<a href="#l1.2666"></a><span id="l1.2666">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2667"></a><span id="l1.2667">   m_nextStateAfterResponse = SMTP_SEND_DATA_RESPONSE;</span>
<a href="#l1.2668"></a><span id="l1.2668">   SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2669"></a><span id="l1.2669"> </span>
<a href="#l1.2670"></a><span id="l1.2670" class="difflineminus">-  return(status);</span>
<a href="#l1.2671"></a><span id="l1.2671" class="difflineplus">+  return (status);</span>
<a href="#l1.2672"></a><span id="l1.2672"> }</span>
<a href="#l1.2673"></a><span id="l1.2673"> </span>
<a href="#l1.2674"></a><span id="l1.2674" class="difflineminus">-</span>
<a href="#l1.2675"></a><span id="l1.2675" class="difflineminus">-nsresult nsSmtpProtocol::SendData(const char *dataBuffer, bool aSuppressLogging)</span>
<a href="#l1.2676"></a><span id="l1.2676" class="difflineminus">-{</span>
<a href="#l1.2677"></a><span id="l1.2677" class="difflineplus">+nsresult nsSmtpProtocol::SendData(const char *dataBuffer,</span>
<a href="#l1.2678"></a><span id="l1.2678" class="difflineplus">+                                  bool aSuppressLogging) {</span>
<a href="#l1.2679"></a><span id="l1.2679">   // XXX -1 is not a valid nsresult</span>
<a href="#l1.2680"></a><span id="l1.2680">   if (!dataBuffer) return static_cast&lt;nsresult&gt;(-1);</span>
<a href="#l1.2681"></a><span id="l1.2681"> </span>
<a href="#l1.2682"></a><span id="l1.2682">   if (!aSuppressLogging) {</span>
<a href="#l1.2683"></a><span id="l1.2683" class="difflineminus">-      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP Send: %s&quot;, dataBuffer));</span>
<a href="#l1.2684"></a><span id="l1.2684" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l1.2685"></a><span id="l1.2685" class="difflineplus">+            (&quot;SMTP Send: %s&quot;, dataBuffer));</span>
<a href="#l1.2686"></a><span id="l1.2686">   } else {</span>
<a href="#l1.2687"></a><span id="l1.2687" class="difflineminus">-      MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;Logging suppressed for this command (it probably contained authentication information)&quot;));</span>
<a href="#l1.2688"></a><span id="l1.2688" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l1.2689"></a><span id="l1.2689" class="difflineplus">+            (&quot;Logging suppressed for this command (it probably contained &quot;</span>
<a href="#l1.2690"></a><span id="l1.2690" class="difflineplus">+             &quot;authentication information)&quot;));</span>
<a href="#l1.2691"></a><span id="l1.2691">   }</span>
<a href="#l1.2692"></a><span id="l1.2692">   return nsMsgAsyncWriteProtocol::SendData(dataBuffer);</span>
<a href="#l1.2693"></a><span id="l1.2693"> }</span>
<a href="#l1.2694"></a><span id="l1.2694"> </span>
<a href="#l1.2695"></a><span id="l1.2695" class="difflineminus">-</span>
<a href="#l1.2696"></a><span id="l1.2696" class="difflineminus">-nsresult nsSmtpProtocol::SendDataResponse()</span>
<a href="#l1.2697"></a><span id="l1.2697" class="difflineminus">-{</span>
<a href="#l1.2698"></a><span id="l1.2698" class="difflineplus">+nsresult nsSmtpProtocol::SendDataResponse() {</span>
<a href="#l1.2699"></a><span id="l1.2699">   nsresult status = NS_OK;</span>
<a href="#l1.2700"></a><span id="l1.2700"> </span>
<a href="#l1.2701"></a><span id="l1.2701" class="difflineminus">-  if (m_responseCode != 354)</span>
<a href="#l1.2702"></a><span id="l1.2702" class="difflineminus">-  {</span>
<a href="#l1.2703"></a><span id="l1.2703" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv = nsExplainErrorDetails(m_runningURL,</span>
<a href="#l1.2704"></a><span id="l1.2704" class="difflineminus">-                                                            NS_ERROR_SENDING_DATA_COMMAND,</span>
<a href="#l1.2705"></a><span id="l1.2705" class="difflineminus">-                                                            m_responseText.get(), nullptr);</span>
<a href="#l1.2706"></a><span id="l1.2706" class="difflineplus">+  if (m_responseCode != 354) {</span>
<a href="#l1.2707"></a><span id="l1.2707" class="difflineplus">+    mozilla::DebugOnly&lt;nsresult&gt; rv =</span>
<a href="#l1.2708"></a><span id="l1.2708" class="difflineplus">+        nsExplainErrorDetails(m_runningURL, NS_ERROR_SENDING_DATA_COMMAND,</span>
<a href="#l1.2709"></a><span id="l1.2709" class="difflineplus">+                              m_responseText.get(), nullptr);</span>
<a href="#l1.2710"></a><span id="l1.2710">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.2711"></a><span id="l1.2711"> </span>
<a href="#l1.2712"></a><span id="l1.2712">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.2713"></a><span id="l1.2713" class="difflineminus">-    return(NS_ERROR_SENDING_DATA_COMMAND);</span>
<a href="#l1.2714"></a><span id="l1.2714" class="difflineplus">+    return (NS_ERROR_SENDING_DATA_COMMAND);</span>
<a href="#l1.2715"></a><span id="l1.2715">   }</span>
<a href="#l1.2716"></a><span id="l1.2716"> </span>
<a href="#l1.2717"></a><span id="l1.2717">   m_nextState = SMTP_SEND_POST_DATA;</span>
<a href="#l1.2718"></a><span id="l1.2718" class="difflineminus">-  ClearFlag(SMTP_PAUSE_FOR_READ);   /* send data directly */</span>
<a href="#l1.2719"></a><span id="l1.2719" class="difflineplus">+  ClearFlag(SMTP_PAUSE_FOR_READ); /* send data directly */</span>
<a href="#l1.2720"></a><span id="l1.2720"> </span>
<a href="#l1.2721"></a><span id="l1.2721">   UpdateStatus(&quot;smtpDeliveringMail&quot;);</span>
<a href="#l1.2722"></a><span id="l1.2722" class="difflineminus">-</span>
<a href="#l1.2723"></a><span id="l1.2723" class="difflineminus">-  {</span>
<a href="#l1.2724"></a><span id="l1.2724" class="difflineminus">-//      m_runningURL-&gt;GetBodySize(&amp;m_totalMessageSize);</span>
<a href="#l1.2725"></a><span id="l1.2725" class="difflineminus">-  }</span>
<a href="#l1.2726"></a><span id="l1.2726" class="difflineminus">-  return(status);</span>
<a href="#l1.2727"></a><span id="l1.2727" class="difflineplus">+  //  m_runningURL-&gt;GetBodySize(&amp;m_totalMessageSize);</span>
<a href="#l1.2728"></a><span id="l1.2728" class="difflineplus">+  return (status);</span>
<a href="#l1.2729"></a><span id="l1.2729"> }</span>
<a href="#l1.2730"></a><span id="l1.2730"> </span>
<a href="#l1.2731"></a><span id="l1.2731" class="difflineminus">-void nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l1.2732"></a><span id="l1.2732" class="difflineminus">-{</span>
<a href="#l1.2733"></a><span id="l1.2733" class="difflineplus">+void nsSmtpProtocol::SendMessageInFile() {</span>
<a href="#l1.2734"></a><span id="l1.2734">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l1.2735"></a><span id="l1.2735">   nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_runningURL);</span>
<a href="#l1.2736"></a><span id="l1.2736">   m_runningURL-&gt;GetPostMessageFile(getter_AddRefs(file));</span>
<a href="#l1.2737"></a><span id="l1.2737">   if (url &amp;&amp; file)</span>
<a href="#l1.2738"></a><span id="l1.2738">     // need to fully qualify to avoid getting overwritten by a #define</span>
<a href="#l1.2739"></a><span id="l1.2739">     // in some windows header file</span>
<a href="#l1.2740"></a><span id="l1.2740">     nsMsgAsyncWriteProtocol::PostMessage(url, file);</span>
<a href="#l1.2741"></a><span id="l1.2741"> </span>
<a href="#l1.2742"></a><span id="l1.2742" class="difflineat">@@ -2002,173 +1852,161 @@ void nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l1.2743"></a><span id="l1.2743">   // for now, we are always done at this point..we aren't making multiple calls</span>
<a href="#l1.2744"></a><span id="l1.2744">   // to post data...</span>
<a href="#l1.2745"></a><span id="l1.2745"> </span>
<a href="#l1.2746"></a><span id="l1.2746">   UpdateStatus(&quot;smtpDeliveringMail&quot;);</span>
<a href="#l1.2747"></a><span id="l1.2747">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2748"></a><span id="l1.2748">   m_nextStateAfterResponse = SMTP_SEND_MESSAGE_RESPONSE;</span>
<a href="#l1.2749"></a><span id="l1.2749"> }</span>
<a href="#l1.2750"></a><span id="l1.2750"> </span>
<a href="#l1.2751"></a><span id="l1.2751" class="difflineminus">-void nsSmtpProtocol::SendPostData()</span>
<a href="#l1.2752"></a><span id="l1.2752" class="difflineminus">-{</span>
<a href="#l1.2753"></a><span id="l1.2753" class="difflineplus">+void nsSmtpProtocol::SendPostData() {</span>
<a href="#l1.2754"></a><span id="l1.2754">   // mscott: as a first pass, I'm writing everything at once and am not</span>
<a href="#l1.2755"></a><span id="l1.2755">   // doing it in chunks...</span>
<a href="#l1.2756"></a><span id="l1.2756"> </span>
<a href="#l1.2757"></a><span id="l1.2757">   /* returns 0 on done and negative on error</span>
<a href="#l1.2758"></a><span id="l1.2758">    * positive if it needs to continue.</span>
<a href="#l1.2759"></a><span id="l1.2759">    */</span>
<a href="#l1.2760"></a><span id="l1.2760"> </span>
<a href="#l1.2761"></a><span id="l1.2761">   // check to see if url is a file..if it is...call our file handler...</span>
<a href="#l1.2762"></a><span id="l1.2762">   bool postMessageInFile = true;</span>
<a href="#l1.2763"></a><span id="l1.2763">   m_runningURL-&gt;GetPostMessage(&amp;postMessageInFile);</span>
<a href="#l1.2764"></a><span id="l1.2764" class="difflineminus">-  if (postMessageInFile)</span>
<a href="#l1.2765"></a><span id="l1.2765" class="difflineminus">-  {</span>
<a href="#l1.2766"></a><span id="l1.2766" class="difflineplus">+  if (postMessageInFile) {</span>
<a href="#l1.2767"></a><span id="l1.2767">     SendMessageInFile();</span>
<a href="#l1.2768"></a><span id="l1.2768">   }</span>
<a href="#l1.2769"></a><span id="l1.2769"> </span>
<a href="#l1.2770"></a><span id="l1.2770">   /* Update the thermo and the status bar.  This is done by hand, rather</span>
<a href="#l1.2771"></a><span id="l1.2771">      than using the FE_GraphProgress* functions, because there seems to be</span>
<a href="#l1.2772"></a><span id="l1.2772">      no way to make FE_GraphProgress shut up and not display anything more</span>
<a href="#l1.2773"></a><span id="l1.2773">      when all the data has arrived.  At the end, we want to show the</span>
<a href="#l1.2774"></a><span id="l1.2774">      &quot;message sent; waiting for reply&quot; status; FE_GraphProgress gets in</span>
<a href="#l1.2775"></a><span id="l1.2775">      the way of that.  See bug #23414. */</span>
<a href="#l1.2776"></a><span id="l1.2776"> }</span>
<a href="#l1.2777"></a><span id="l1.2777"> </span>
<a href="#l1.2778"></a><span id="l1.2778" class="difflineminus">-nsresult nsSmtpProtocol::SendMessageResponse()</span>
<a href="#l1.2779"></a><span id="l1.2779" class="difflineminus">-{</span>
<a href="#l1.2780"></a><span id="l1.2780" class="difflineminus">-  if((m_responseCode/10 != 25))</span>
<a href="#l1.2781"></a><span id="l1.2781" class="difflineminus">-  {</span>
<a href="#l1.2782"></a><span id="l1.2782" class="difflineminus">-    mozilla::DebugOnly&lt;nsresult&gt; rv = nsExplainErrorDetails(m_runningURL,</span>
<a href="#l1.2783"></a><span id="l1.2783" class="difflineminus">-                                                            NS_ERROR_SENDING_MESSAGE,</span>
<a href="#l1.2784"></a><span id="l1.2784" class="difflineminus">-                                                            m_responseText.get(), nullptr);</span>
<a href="#l1.2785"></a><span id="l1.2785" class="difflineplus">+nsresult nsSmtpProtocol::SendMessageResponse() {</span>
<a href="#l1.2786"></a><span id="l1.2786" class="difflineplus">+  if ((m_responseCode / 10 != 25)) {</span>
<a href="#l1.2787"></a><span id="l1.2787" class="difflineplus">+    mozilla::DebugOnly&lt;nsresult&gt; rv = nsExplainErrorDetails(</span>
<a href="#l1.2788"></a><span id="l1.2788" class="difflineplus">+        m_runningURL, NS_ERROR_SENDING_MESSAGE, m_responseText.get(), nullptr);</span>
<a href="#l1.2789"></a><span id="l1.2789">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l1.2790"></a><span id="l1.2790"> </span>
<a href="#l1.2791"></a><span id="l1.2791">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.2792"></a><span id="l1.2792" class="difflineminus">-    return(NS_ERROR_SENDING_MESSAGE);</span>
<a href="#l1.2793"></a><span id="l1.2793" class="difflineplus">+    return (NS_ERROR_SENDING_MESSAGE);</span>
<a href="#l1.2794"></a><span id="l1.2794">   }</span>
<a href="#l1.2795"></a><span id="l1.2795"> </span>
<a href="#l1.2796"></a><span id="l1.2796">   UpdateStatus(&quot;smtpMailSent&quot;);</span>
<a href="#l1.2797"></a><span id="l1.2797"> </span>
<a href="#l1.2798"></a><span id="l1.2798">   /* else */</span>
<a href="#l1.2799"></a><span id="l1.2799">   return SendQuit();</span>
<a href="#l1.2800"></a><span id="l1.2800"> }</span>
<a href="#l1.2801"></a><span id="l1.2801"> </span>
<a href="#l1.2802"></a><span id="l1.2802" class="difflineminus">-nsresult nsSmtpProtocol::SendQuit(SmtpState aNextStateAfterResponse)</span>
<a href="#l1.2803"></a><span id="l1.2803" class="difflineminus">-{</span>
<a href="#l1.2804"></a><span id="l1.2804" class="difflineplus">+nsresult nsSmtpProtocol::SendQuit(SmtpState aNextStateAfterResponse) {</span>
<a href="#l1.2805"></a><span id="l1.2805">   m_sendDone = true;</span>
<a href="#l1.2806"></a><span id="l1.2806">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2807"></a><span id="l1.2807">   m_nextStateAfterResponse = aNextStateAfterResponse;</span>
<a href="#l1.2808"></a><span id="l1.2808"> </span>
<a href="#l1.2809"></a><span id="l1.2809" class="difflineminus">-  return SendData(&quot;QUIT&quot; CRLF); // send a quit command to close the connection with the server.</span>
<a href="#l1.2810"></a><span id="l1.2810" class="difflineplus">+  return SendData(&quot;QUIT&quot; CRLF);  // send a quit command to close the connection</span>
<a href="#l1.2811"></a><span id="l1.2811" class="difflineplus">+                                 // with the server.</span>
<a href="#l1.2812"></a><span id="l1.2812"> }</span>
<a href="#l1.2813"></a><span id="l1.2813"> </span>
<a href="#l1.2814"></a><span id="l1.2814" class="difflineminus">-nsresult nsSmtpProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer)</span>
<a href="#l1.2815"></a><span id="l1.2815" class="difflineminus">-{</span>
<a href="#l1.2816"></a><span id="l1.2816" class="difflineminus">-  if (!aURL)</span>
<a href="#l1.2817"></a><span id="l1.2817" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.2818"></a><span id="l1.2818" class="difflineplus">+nsresult nsSmtpProtocol::LoadUrl(nsIURI *aURL, nsISupports *aConsumer) {</span>
<a href="#l1.2819"></a><span id="l1.2819" class="difflineplus">+  if (!aURL) return NS_OK;</span>
<a href="#l1.2820"></a><span id="l1.2820"> </span>
<a href="#l1.2821"></a><span id="l1.2821">   m_consumer = aConsumer;</span>
<a href="#l1.2822"></a><span id="l1.2822">   return Initialize(aURL);</span>
<a href="#l1.2823"></a><span id="l1.2823"> }</span>
<a href="#l1.2824"></a><span id="l1.2824"> </span>
<a href="#l1.2825"></a><span id="l1.2825" class="difflineminus">-nsresult nsSmtpProtocol::LoadUrlInternal(nsIURI *aURL, nsISupports *aConsumer)</span>
<a href="#l1.2826"></a><span id="l1.2826" class="difflineminus">-{</span>
<a href="#l1.2827"></a><span id="l1.2827" class="difflineminus">-  m_continuationResponse = -1;  /* init */</span>
<a href="#l1.2828"></a><span id="l1.2828" class="difflineplus">+nsresult nsSmtpProtocol::LoadUrlInternal(nsIURI *aURL, nsISupports *aConsumer) {</span>
<a href="#l1.2829"></a><span id="l1.2829" class="difflineplus">+  m_continuationResponse = -1; /* init */</span>
<a href="#l1.2830"></a><span id="l1.2830">   m_runningURL = do_QueryInterface(aURL);</span>
<a href="#l1.2831"></a><span id="l1.2831" class="difflineminus">-  if (!m_runningURL)</span>
<a href="#l1.2832"></a><span id="l1.2832" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.2833"></a><span id="l1.2833" class="difflineplus">+  if (!m_runningURL) return NS_ERROR_FAILURE;</span>
<a href="#l1.2834"></a><span id="l1.2834"> </span>
<a href="#l1.2835"></a><span id="l1.2835">   // we had a bug where we failed to bring up an alert if the host</span>
<a href="#l1.2836"></a><span id="l1.2836">   // name was empty....so throw up an alert saying we don't have</span>
<a href="#l1.2837"></a><span id="l1.2837">   // a host name and inform the caller that we are not going to</span>
<a href="#l1.2838"></a><span id="l1.2838">   // run the url...</span>
<a href="#l1.2839"></a><span id="l1.2839">   nsAutoCString hostName;</span>
<a href="#l1.2840"></a><span id="l1.2840">   aURL-&gt;GetHost(hostName);</span>
<a href="#l1.2841"></a><span id="l1.2841" class="difflineminus">-  if (hostName.IsEmpty())</span>
<a href="#l1.2842"></a><span id="l1.2842" class="difflineminus">-  {</span>
<a href="#l1.2843"></a><span id="l1.2843" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; aMsgUrl = do_QueryInterface(aURL);</span>
<a href="#l1.2844"></a><span id="l1.2844" class="difflineminus">-    if (aMsgUrl)</span>
<a href="#l1.2845"></a><span id="l1.2845" class="difflineminus">-    {</span>
<a href="#l1.2846"></a><span id="l1.2846" class="difflineplus">+  if (hostName.IsEmpty()) {</span>
<a href="#l1.2847"></a><span id="l1.2847" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; aMsgUrl = do_QueryInterface(aURL);</span>
<a href="#l1.2848"></a><span id="l1.2848" class="difflineplus">+    if (aMsgUrl) {</span>
<a href="#l1.2849"></a><span id="l1.2849">       aMsgUrl-&gt;SetUrlState(true, NS_OK);</span>
<a href="#l1.2850"></a><span id="l1.2850">       // set the url as a url currently being run...</span>
<a href="#l1.2851"></a><span id="l1.2851">       aMsgUrl-&gt;SetUrlState(false /* we aren't running the url */,</span>
<a href="#l1.2852"></a><span id="l1.2852">                            NS_ERROR_SMTP_AUTH_FAILURE);</span>
<a href="#l1.2853"></a><span id="l1.2853">     }</span>
<a href="#l1.2854"></a><span id="l1.2854">     return NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l1.2855"></a><span id="l1.2855">   }</span>
<a href="#l1.2856"></a><span id="l1.2856"> </span>
<a href="#l1.2857"></a><span id="l1.2857">   return nsMsgProtocol::LoadUrl(aURL, aConsumer);</span>
<a href="#l1.2858"></a><span id="l1.2858"> }</span>
<a href="#l1.2859"></a><span id="l1.2859"> </span>
<a href="#l1.2860"></a><span id="l1.2860"> /*</span>
<a href="#l1.2861"></a><span id="l1.2861">  * returns negative if the transfer is finished or error'd out</span>
<a href="#l1.2862"></a><span id="l1.2862">  *</span>
<a href="#l1.2863"></a><span id="l1.2863">  * returns zero or more if the transfer needs to be continued.</span>
<a href="#l1.2864"></a><span id="l1.2864">  */</span>
<a href="#l1.2865"></a><span id="l1.2865" class="difflineminus">-nsresult nsSmtpProtocol::ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l1.2866"></a><span id="l1.2866" class="difflineminus">-                                              uint64_t sourceOffset, uint32_t length)</span>
<a href="#l1.2867"></a><span id="l1.2867" class="difflineminus">- {</span>
<a href="#l1.2868"></a><span id="l1.2868" class="difflineminus">-   nsresult status = NS_OK;</span>
<a href="#l1.2869"></a><span id="l1.2869" class="difflineminus">-   ClearFlag(SMTP_PAUSE_FOR_READ); /* already paused; reset */</span>
<a href="#l1.2870"></a><span id="l1.2870" class="difflineplus">+nsresult nsSmtpProtocol::ProcessProtocolState(nsIURI *url,</span>
<a href="#l1.2871"></a><span id="l1.2871" class="difflineplus">+                                              nsIInputStream *inputStream,</span>
<a href="#l1.2872"></a><span id="l1.2872" class="difflineplus">+                                              uint64_t sourceOffset,</span>
<a href="#l1.2873"></a><span id="l1.2873" class="difflineplus">+                                              uint32_t length) {</span>
<a href="#l1.2874"></a><span id="l1.2874" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l1.2875"></a><span id="l1.2875" class="difflineplus">+  ClearFlag(SMTP_PAUSE_FOR_READ); /* already paused; reset */</span>
<a href="#l1.2876"></a><span id="l1.2876"> </span>
<a href="#l1.2877"></a><span id="l1.2877" class="difflineminus">-   while(!TestFlag(SMTP_PAUSE_FOR_READ))</span>
<a href="#l1.2878"></a><span id="l1.2878" class="difflineminus">-   {</span>
<a href="#l1.2879"></a><span id="l1.2879" class="difflineminus">-     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info, (&quot;SMTP entering state: %d&quot;,</span>
<a href="#l1.2880"></a><span id="l1.2880" class="difflineminus">-       m_nextState));</span>
<a href="#l1.2881"></a><span id="l1.2881" class="difflineminus">-     switch(m_nextState)</span>
<a href="#l1.2882"></a><span id="l1.2882" class="difflineminus">-     {</span>
<a href="#l1.2883"></a><span id="l1.2883" class="difflineminus">-     case SMTP_RESPONSE:</span>
<a href="#l1.2884"></a><span id="l1.2884" class="difflineminus">-       if (inputStream == nullptr)</span>
<a href="#l1.2885"></a><span id="l1.2885" class="difflineminus">-         SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2886"></a><span id="l1.2886" class="difflineminus">-       else</span>
<a href="#l1.2887"></a><span id="l1.2887" class="difflineminus">-         status = SmtpResponse(inputStream, length);</span>
<a href="#l1.2888"></a><span id="l1.2888" class="difflineminus">-       break;</span>
<a href="#l1.2889"></a><span id="l1.2889" class="difflineplus">+  while (!TestFlag(SMTP_PAUSE_FOR_READ)) {</span>
<a href="#l1.2890"></a><span id="l1.2890" class="difflineplus">+    MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Info,</span>
<a href="#l1.2891"></a><span id="l1.2891" class="difflineplus">+            (&quot;SMTP entering state: %d&quot;, m_nextState));</span>
<a href="#l1.2892"></a><span id="l1.2892" class="difflineplus">+    switch (m_nextState) {</span>
<a href="#l1.2893"></a><span id="l1.2893" class="difflineplus">+      case SMTP_RESPONSE:</span>
<a href="#l1.2894"></a><span id="l1.2894" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l1.2895"></a><span id="l1.2895" class="difflineplus">+          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2896"></a><span id="l1.2896" class="difflineplus">+        else</span>
<a href="#l1.2897"></a><span id="l1.2897" class="difflineplus">+          status = SmtpResponse(inputStream, length);</span>
<a href="#l1.2898"></a><span id="l1.2898" class="difflineplus">+        break;</span>
<a href="#l1.2899"></a><span id="l1.2899"> </span>
<a href="#l1.2900"></a><span id="l1.2900" class="difflineminus">-     case SMTP_START_CONNECT:</span>
<a href="#l1.2901"></a><span id="l1.2901" class="difflineminus">-       SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2902"></a><span id="l1.2902" class="difflineminus">-       m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2903"></a><span id="l1.2903" class="difflineminus">-       m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.2904"></a><span id="l1.2904" class="difflineminus">-       break;</span>
<a href="#l1.2905"></a><span id="l1.2905" class="difflineminus">-     case SMTP_FINISH_CONNECT:</span>
<a href="#l1.2906"></a><span id="l1.2906" class="difflineminus">-       SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2907"></a><span id="l1.2907" class="difflineminus">-       break;</span>
<a href="#l1.2908"></a><span id="l1.2908" class="difflineminus">-     case SMTP_TLS_RESPONSE:</span>
<a href="#l1.2909"></a><span id="l1.2909" class="difflineminus">-       if (inputStream == nullptr)</span>
<a href="#l1.2910"></a><span id="l1.2910" class="difflineminus">-         SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2911"></a><span id="l1.2911" class="difflineminus">-       else</span>
<a href="#l1.2912"></a><span id="l1.2912" class="difflineminus">-         status = SendTLSResponse();</span>
<a href="#l1.2913"></a><span id="l1.2913" class="difflineminus">-       break;</span>
<a href="#l1.2914"></a><span id="l1.2914" class="difflineminus">-     case SMTP_EXTN_LOGIN_RESPONSE:</span>
<a href="#l1.2915"></a><span id="l1.2915" class="difflineminus">-       if (inputStream == nullptr)</span>
<a href="#l1.2916"></a><span id="l1.2916" class="difflineminus">-         SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2917"></a><span id="l1.2917" class="difflineminus">-       else</span>
<a href="#l1.2918"></a><span id="l1.2918" class="difflineminus">-         status = ExtensionLoginResponse(inputStream, length);</span>
<a href="#l1.2919"></a><span id="l1.2919" class="difflineminus">-       break;</span>
<a href="#l1.2920"></a><span id="l1.2920" class="difflineplus">+      case SMTP_START_CONNECT:</span>
<a href="#l1.2921"></a><span id="l1.2921" class="difflineplus">+        SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2922"></a><span id="l1.2922" class="difflineplus">+        m_nextState = SMTP_RESPONSE;</span>
<a href="#l1.2923"></a><span id="l1.2923" class="difflineplus">+        m_nextStateAfterResponse = SMTP_EXTN_LOGIN_RESPONSE;</span>
<a href="#l1.2924"></a><span id="l1.2924" class="difflineplus">+        break;</span>
<a href="#l1.2925"></a><span id="l1.2925" class="difflineplus">+      case SMTP_FINISH_CONNECT:</span>
<a href="#l1.2926"></a><span id="l1.2926" class="difflineplus">+        SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2927"></a><span id="l1.2927" class="difflineplus">+        break;</span>
<a href="#l1.2928"></a><span id="l1.2928" class="difflineplus">+      case SMTP_TLS_RESPONSE:</span>
<a href="#l1.2929"></a><span id="l1.2929" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l1.2930"></a><span id="l1.2930" class="difflineplus">+          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2931"></a><span id="l1.2931" class="difflineplus">+        else</span>
<a href="#l1.2932"></a><span id="l1.2932" class="difflineplus">+          status = SendTLSResponse();</span>
<a href="#l1.2933"></a><span id="l1.2933" class="difflineplus">+        break;</span>
<a href="#l1.2934"></a><span id="l1.2934" class="difflineplus">+      case SMTP_EXTN_LOGIN_RESPONSE:</span>
<a href="#l1.2935"></a><span id="l1.2935" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l1.2936"></a><span id="l1.2936" class="difflineplus">+          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2937"></a><span id="l1.2937" class="difflineplus">+        else</span>
<a href="#l1.2938"></a><span id="l1.2938" class="difflineplus">+          status = ExtensionLoginResponse(inputStream, length);</span>
<a href="#l1.2939"></a><span id="l1.2939" class="difflineplus">+        break;</span>
<a href="#l1.2940"></a><span id="l1.2940"> </span>
<a href="#l1.2941"></a><span id="l1.2941" class="difflineminus">-     case SMTP_SEND_HELO_RESPONSE:</span>
<a href="#l1.2942"></a><span id="l1.2942" class="difflineminus">-       if (inputStream == nullptr)</span>
<a href="#l1.2943"></a><span id="l1.2943" class="difflineminus">-         SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2944"></a><span id="l1.2944" class="difflineminus">-       else</span>
<a href="#l1.2945"></a><span id="l1.2945" class="difflineminus">-         status = SendHeloResponse(inputStream, length);</span>
<a href="#l1.2946"></a><span id="l1.2946" class="difflineminus">-       break;</span>
<a href="#l1.2947"></a><span id="l1.2947" class="difflineminus">-     case SMTP_SEND_EHLO_RESPONSE:</span>
<a href="#l1.2948"></a><span id="l1.2948" class="difflineminus">-       if (inputStream == nullptr)</span>
<a href="#l1.2949"></a><span id="l1.2949" class="difflineminus">-         SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2950"></a><span id="l1.2950" class="difflineminus">-       else</span>
<a href="#l1.2951"></a><span id="l1.2951" class="difflineminus">-         status = SendEhloResponse(inputStream, length);</span>
<a href="#l1.2952"></a><span id="l1.2952" class="difflineminus">-       break;</span>
<a href="#l1.2953"></a><span id="l1.2953" class="difflineminus">-     case SMTP_CLIENTID_RESPONSE:</span>
<a href="#l1.2954"></a><span id="l1.2954" class="difflineminus">-       if (inputStream == nullptr)</span>
<a href="#l1.2955"></a><span id="l1.2955" class="difflineminus">-         SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2956"></a><span id="l1.2956" class="difflineminus">-       else</span>
<a href="#l1.2957"></a><span id="l1.2957" class="difflineminus">-         status = SendClientIDResponse();</span>
<a href="#l1.2958"></a><span id="l1.2958" class="difflineminus">-       break;</span>
<a href="#l1.2959"></a><span id="l1.2959" class="difflineminus">-     case SMTP_AUTH_PROCESS_STATE:</span>
<a href="#l1.2960"></a><span id="l1.2960" class="difflineminus">-       status = ProcessAuth();</span>
<a href="#l1.2961"></a><span id="l1.2961" class="difflineminus">-       break;</span>
<a href="#l1.2962"></a><span id="l1.2962" class="difflineplus">+      case SMTP_SEND_HELO_RESPONSE:</span>
<a href="#l1.2963"></a><span id="l1.2963" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l1.2964"></a><span id="l1.2964" class="difflineplus">+          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2965"></a><span id="l1.2965" class="difflineplus">+        else</span>
<a href="#l1.2966"></a><span id="l1.2966" class="difflineplus">+          status = SendHeloResponse(inputStream, length);</span>
<a href="#l1.2967"></a><span id="l1.2967" class="difflineplus">+        break;</span>
<a href="#l1.2968"></a><span id="l1.2968" class="difflineplus">+      case SMTP_SEND_EHLO_RESPONSE:</span>
<a href="#l1.2969"></a><span id="l1.2969" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l1.2970"></a><span id="l1.2970" class="difflineplus">+          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2971"></a><span id="l1.2971" class="difflineplus">+        else</span>
<a href="#l1.2972"></a><span id="l1.2972" class="difflineplus">+          status = SendEhloResponse(inputStream, length);</span>
<a href="#l1.2973"></a><span id="l1.2973" class="difflineplus">+        break;</span>
<a href="#l1.2974"></a><span id="l1.2974" class="difflineplus">+      case SMTP_CLIENTID_RESPONSE:</span>
<a href="#l1.2975"></a><span id="l1.2975" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l1.2976"></a><span id="l1.2976" class="difflineplus">+          SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.2977"></a><span id="l1.2977" class="difflineplus">+        else</span>
<a href="#l1.2978"></a><span id="l1.2978" class="difflineplus">+          status = SendClientIDResponse();</span>
<a href="#l1.2979"></a><span id="l1.2979" class="difflineplus">+        break;</span>
<a href="#l1.2980"></a><span id="l1.2980" class="difflineplus">+      case SMTP_AUTH_PROCESS_STATE:</span>
<a href="#l1.2981"></a><span id="l1.2981" class="difflineplus">+        status = ProcessAuth();</span>
<a href="#l1.2982"></a><span id="l1.2982" class="difflineplus">+        break;</span>
<a href="#l1.2983"></a><span id="l1.2983"> </span>
<a href="#l1.2984"></a><span id="l1.2984">       case SMTP_SEND_AUTH_GSSAPI_FIRST:</span>
<a href="#l1.2985"></a><span id="l1.2985">         status = AuthGSSAPIFirst();</span>
<a href="#l1.2986"></a><span id="l1.2986">         break;</span>
<a href="#l1.2987"></a><span id="l1.2987"> </span>
<a href="#l1.2988"></a><span id="l1.2988">       case SMTP_SEND_AUTH_GSSAPI_STEP:</span>
<a href="#l1.2989"></a><span id="l1.2989">         status = AuthGSSAPIStep();</span>
<a href="#l1.2990"></a><span id="l1.2990">         break;</span>
<a href="#l1.2991"></a><span id="l1.2991" class="difflineat">@@ -2197,17 +2035,16 @@ nsresult nsSmtpProtocol::ProcessProtocol</span>
<a href="#l1.2992"></a><span id="l1.2992">       case SMTP_SEND_AUTH_LOGIN_STEP2:</span>
<a href="#l1.2993"></a><span id="l1.2993">         status = AuthLoginStep2();</span>
<a href="#l1.2994"></a><span id="l1.2994">         break;</span>
<a href="#l1.2995"></a><span id="l1.2995"> </span>
<a href="#l1.2996"></a><span id="l1.2996">       case SMTP_AUTH_OAUTH2_STEP:</span>
<a href="#l1.2997"></a><span id="l1.2997">         status = AuthOAuth2Step1();</span>
<a href="#l1.2998"></a><span id="l1.2998">         break;</span>
<a href="#l1.2999"></a><span id="l1.2999"> </span>
<a href="#l1.3000"></a><span id="l1.3000" class="difflineminus">-</span>
<a href="#l1.3001"></a><span id="l1.3001">       case SMTP_SEND_MAIL_RESPONSE:</span>
<a href="#l1.3002"></a><span id="l1.3002">         if (inputStream == nullptr)</span>
<a href="#l1.3003"></a><span id="l1.3003">           SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.3004"></a><span id="l1.3004">         else</span>
<a href="#l1.3005"></a><span id="l1.3005">           status = SendMailResponse();</span>
<a href="#l1.3006"></a><span id="l1.3006">         break;</span>
<a href="#l1.3007"></a><span id="l1.3007"> </span>
<a href="#l1.3008"></a><span id="l1.3008">       case SMTP_SEND_RCPT_RESPONSE:</span>
<a href="#l1.3009"></a><span id="l1.3009" class="difflineat">@@ -2230,31 +2067,31 @@ nsresult nsSmtpProtocol::ProcessProtocol</span>
<a href="#l1.3010"></a><span id="l1.3010">         break;</span>
<a href="#l1.3011"></a><span id="l1.3011"> </span>
<a href="#l1.3012"></a><span id="l1.3012">       case SMTP_SEND_MESSAGE_RESPONSE:</span>
<a href="#l1.3013"></a><span id="l1.3013">         if (inputStream == nullptr)</span>
<a href="#l1.3014"></a><span id="l1.3014">           SetFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.3015"></a><span id="l1.3015">         else</span>
<a href="#l1.3016"></a><span id="l1.3016">           status = SendMessageResponse();</span>
<a href="#l1.3017"></a><span id="l1.3017">         break;</span>
<a href="#l1.3018"></a><span id="l1.3018" class="difflineminus">-      case SMTP_DONE:</span>
<a href="#l1.3019"></a><span id="l1.3019" class="difflineminus">-        {</span>
<a href="#l1.3020"></a><span id="l1.3020" class="difflineminus">-          nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l1.3021"></a><span id="l1.3021" class="difflineminus">-          mailNewsUrl-&gt;SetUrlState(false, NS_OK);</span>
<a href="#l1.3022"></a><span id="l1.3022" class="difflineminus">-        }</span>
<a href="#l1.3023"></a><span id="l1.3023" class="difflineplus">+      case SMTP_DONE: {</span>
<a href="#l1.3024"></a><span id="l1.3024" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl =</span>
<a href="#l1.3025"></a><span id="l1.3025" class="difflineplus">+            do_QueryInterface(m_runningURL);</span>
<a href="#l1.3026"></a><span id="l1.3026" class="difflineplus">+        mailNewsUrl-&gt;SetUrlState(false, NS_OK);</span>
<a href="#l1.3027"></a><span id="l1.3027" class="difflineplus">+      }</span>
<a href="#l1.3028"></a><span id="l1.3028"> </span>
<a href="#l1.3029"></a><span id="l1.3029">         m_nextState = SMTP_FREE;</span>
<a href="#l1.3030"></a><span id="l1.3030">         break;</span>
<a href="#l1.3031"></a><span id="l1.3031"> </span>
<a href="#l1.3032"></a><span id="l1.3032" class="difflineminus">-      case SMTP_ERROR_DONE:</span>
<a href="#l1.3033"></a><span id="l1.3033" class="difflineminus">-        {</span>
<a href="#l1.3034"></a><span id="l1.3034" class="difflineminus">-          nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(m_runningURL);</span>
<a href="#l1.3035"></a><span id="l1.3035" class="difflineminus">-          // propagate the right error code</span>
<a href="#l1.3036"></a><span id="l1.3036" class="difflineminus">-          mailNewsUrl-&gt;SetUrlState(false, m_urlErrorState);</span>
<a href="#l1.3037"></a><span id="l1.3037" class="difflineminus">-        }</span>
<a href="#l1.3038"></a><span id="l1.3038" class="difflineplus">+      case SMTP_ERROR_DONE: {</span>
<a href="#l1.3039"></a><span id="l1.3039" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl =</span>
<a href="#l1.3040"></a><span id="l1.3040" class="difflineplus">+            do_QueryInterface(m_runningURL);</span>
<a href="#l1.3041"></a><span id="l1.3041" class="difflineplus">+        // propagate the right error code</span>
<a href="#l1.3042"></a><span id="l1.3042" class="difflineplus">+        mailNewsUrl-&gt;SetUrlState(false, m_urlErrorState);</span>
<a href="#l1.3043"></a><span id="l1.3043" class="difflineplus">+      }</span>
<a href="#l1.3044"></a><span id="l1.3044"> </span>
<a href="#l1.3045"></a><span id="l1.3045">         m_nextState = SMTP_FREE;</span>
<a href="#l1.3046"></a><span id="l1.3046">         break;</span>
<a href="#l1.3047"></a><span id="l1.3047"> </span>
<a href="#l1.3048"></a><span id="l1.3048">       case SMTP_FREE:</span>
<a href="#l1.3049"></a><span id="l1.3049">         // smtp is a one time use connection so kill it if we get here...</span>
<a href="#l1.3050"></a><span id="l1.3050">         nsMsgAsyncWriteProtocol::CloseSocket();</span>
<a href="#l1.3051"></a><span id="l1.3051">         return NS_OK; /* final end */</span>
<a href="#l1.3052"></a><span id="l1.3052" class="difflineat">@@ -2266,158 +2103,142 @@ nsresult nsSmtpProtocol::ProcessProtocol</span>
<a href="#l1.3053"></a><span id="l1.3053">         return NS_OK;</span>
<a href="#l1.3054"></a><span id="l1.3054"> </span>
<a href="#l1.3055"></a><span id="l1.3055">       default: /* should never happen !!! */</span>
<a href="#l1.3056"></a><span id="l1.3056">         m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.3057"></a><span id="l1.3057">         break;</span>
<a href="#l1.3058"></a><span id="l1.3058">     }</span>
<a href="#l1.3059"></a><span id="l1.3059"> </span>
<a href="#l1.3060"></a><span id="l1.3060">     /* check for errors during load and call error</span>
<a href="#l1.3061"></a><span id="l1.3061" class="difflineminus">-    * state if found</span>
<a href="#l1.3062"></a><span id="l1.3062" class="difflineminus">-    */</span>
<a href="#l1.3063"></a><span id="l1.3063" class="difflineplus">+     * state if found</span>
<a href="#l1.3064"></a><span id="l1.3064" class="difflineplus">+     */</span>
<a href="#l1.3065"></a><span id="l1.3065">     if (NS_FAILED(status) &amp;&amp; m_nextState != SMTP_FREE) {</span>
<a href="#l1.3066"></a><span id="l1.3066">       // send a quit command to close the connection with the server.</span>
<a href="#l1.3067"></a><span id="l1.3067" class="difflineminus">-      if (NS_FAILED(SendQuit(SMTP_ERROR_DONE)))</span>
<a href="#l1.3068"></a><span id="l1.3068" class="difflineminus">-      {</span>
<a href="#l1.3069"></a><span id="l1.3069" class="difflineplus">+      if (NS_FAILED(SendQuit(SMTP_ERROR_DONE))) {</span>
<a href="#l1.3070"></a><span id="l1.3070">         m_nextState = SMTP_ERROR_DONE;</span>
<a href="#l1.3071"></a><span id="l1.3071">         // Don't exit - loop around again and do the free case</span>
<a href="#l1.3072"></a><span id="l1.3072">         ClearFlag(SMTP_PAUSE_FOR_READ);</span>
<a href="#l1.3073"></a><span id="l1.3073">       }</span>
<a href="#l1.3074"></a><span id="l1.3074">     }</span>
<a href="#l1.3075"></a><span id="l1.3075">   } /* while(!SMTP_PAUSE_FOR_READ) */</span>
<a href="#l1.3076"></a><span id="l1.3076"> </span>
<a href="#l1.3077"></a><span id="l1.3077">   return NS_OK;</span>
<a href="#l1.3078"></a><span id="l1.3078"> }</span>
<a href="#l1.3079"></a><span id="l1.3079"> </span>
<a href="#l1.3080"></a><span id="l1.3080" class="difflineminus">-nsresult</span>
<a href="#l1.3081"></a><span id="l1.3081" class="difflineminus">-nsSmtpProtocol::GetPassword(nsString &amp;aPassword)</span>
<a href="#l1.3082"></a><span id="l1.3082" class="difflineminus">-{</span>
<a href="#l1.3083"></a><span id="l1.3083" class="difflineminus">-    nsresult rv;</span>
<a href="#l1.3084"></a><span id="l1.3084" class="difflineminus">-    nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l1.3085"></a><span id="l1.3085" class="difflineplus">+nsresult nsSmtpProtocol::GetPassword(nsString &amp;aPassword) {</span>
<a href="#l1.3086"></a><span id="l1.3086" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.3087"></a><span id="l1.3087" class="difflineplus">+  nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l1.3088"></a><span id="l1.3088"> </span>
<a href="#l1.3089"></a><span id="l1.3089" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.3090"></a><span id="l1.3090" class="difflineminus">-    rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.3091"></a><span id="l1.3091" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3092"></a><span id="l1.3092" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.3093"></a><span id="l1.3093" class="difflineplus">+  rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.3094"></a><span id="l1.3094" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3095"></a><span id="l1.3095"> </span>
<a href="#l1.3096"></a><span id="l1.3096" class="difflineminus">-    rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l1.3097"></a><span id="l1.3097" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3098"></a><span id="l1.3098" class="difflineplus">+  rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l1.3099"></a><span id="l1.3099" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3100"></a><span id="l1.3100"> </span>
<a href="#l1.3101"></a><span id="l1.3101" class="difflineminus">-    if (!aPassword.IsEmpty())</span>
<a href="#l1.3102"></a><span id="l1.3102" class="difflineminus">-        return rv;</span>
<a href="#l1.3103"></a><span id="l1.3103" class="difflineminus">-    // empty password</span>
<a href="#l1.3104"></a><span id="l1.3104" class="difflineplus">+  if (!aPassword.IsEmpty()) return rv;</span>
<a href="#l1.3105"></a><span id="l1.3105" class="difflineplus">+  // empty password</span>
<a href="#l1.3106"></a><span id="l1.3106"> </span>
<a href="#l1.3107"></a><span id="l1.3107" class="difflineminus">-    nsCOMPtr &lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.3108"></a><span id="l1.3108" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3109"></a><span id="l1.3109" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l1.3110"></a><span id="l1.3110" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.3111"></a><span id="l1.3111" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3112"></a><span id="l1.3112"> </span>
<a href="#l1.3113"></a><span id="l1.3113" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l1.3114"></a><span id="l1.3114" class="difflineminus">-    rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l1.3115"></a><span id="l1.3115" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3116"></a><span id="l1.3116" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l1.3117"></a><span id="l1.3117" class="difflineplus">+  rv = prefs-&gt;GetBranch(nullptr, getter_AddRefs(prefBranch));</span>
<a href="#l1.3118"></a><span id="l1.3118" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3119"></a><span id="l1.3119"> </span>
<a href="#l1.3120"></a><span id="l1.3120" class="difflineminus">-    nsCString username;</span>
<a href="#l1.3121"></a><span id="l1.3121" class="difflineminus">-    rv = smtpServer-&gt;GetUsername(username);</span>
<a href="#l1.3122"></a><span id="l1.3122" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3123"></a><span id="l1.3123" class="difflineplus">+  nsCString username;</span>
<a href="#l1.3124"></a><span id="l1.3124" class="difflineplus">+  rv = smtpServer-&gt;GetUsername(username);</span>
<a href="#l1.3125"></a><span id="l1.3125" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3126"></a><span id="l1.3126"> </span>
<a href="#l1.3127"></a><span id="l1.3127" class="difflineminus">-    NS_ConvertASCIItoUTF16 usernameUTF16(username);</span>
<a href="#l1.3128"></a><span id="l1.3128" class="difflineplus">+  NS_ConvertASCIItoUTF16 usernameUTF16(username);</span>
<a href="#l1.3129"></a><span id="l1.3129"> </span>
<a href="#l1.3130"></a><span id="l1.3130" class="difflineminus">-    nsCString hostname;</span>
<a href="#l1.3131"></a><span id="l1.3131" class="difflineminus">-    rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l1.3132"></a><span id="l1.3132" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3133"></a><span id="l1.3133" class="difflineminus">-</span>
<a href="#l1.3134"></a><span id="l1.3134" class="difflineminus">-    nsAutoString hostnameUTF16;</span>
<a href="#l1.3135"></a><span id="l1.3135" class="difflineminus">-    CopyASCIItoUTF16(hostname, hostnameUTF16);</span>
<a href="#l1.3136"></a><span id="l1.3136" class="difflineplus">+  nsCString hostname;</span>
<a href="#l1.3137"></a><span id="l1.3137" class="difflineplus">+  rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l1.3138"></a><span id="l1.3138" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3139"></a><span id="l1.3139"> </span>
<a href="#l1.3140"></a><span id="l1.3140" class="difflineminus">-    const char16_t *formatStrings[] =</span>
<a href="#l1.3141"></a><span id="l1.3141" class="difflineminus">-    {</span>
<a href="#l1.3142"></a><span id="l1.3142" class="difflineminus">-      hostnameUTF16.get(),</span>
<a href="#l1.3143"></a><span id="l1.3143" class="difflineminus">-      usernameUTF16.get()</span>
<a href="#l1.3144"></a><span id="l1.3144" class="difflineminus">-    };</span>
<a href="#l1.3145"></a><span id="l1.3145" class="difflineplus">+  nsAutoString hostnameUTF16;</span>
<a href="#l1.3146"></a><span id="l1.3146" class="difflineplus">+  CopyASCIItoUTF16(hostname, hostnameUTF16);</span>
<a href="#l1.3147"></a><span id="l1.3147"> </span>
<a href="#l1.3148"></a><span id="l1.3148" class="difflineminus">-    rv = PromptForPassword(smtpServer, smtpUrl, formatStrings, aPassword);</span>
<a href="#l1.3149"></a><span id="l1.3149" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3150"></a><span id="l1.3150" class="difflineminus">-    return rv;</span>
<a href="#l1.3151"></a><span id="l1.3151" class="difflineplus">+  const char16_t *formatStrings[] = {hostnameUTF16.get(), usernameUTF16.get()};</span>
<a href="#l1.3152"></a><span id="l1.3152" class="difflineplus">+</span>
<a href="#l1.3153"></a><span id="l1.3153" class="difflineplus">+  rv = PromptForPassword(smtpServer, smtpUrl, formatStrings, aPassword);</span>
<a href="#l1.3154"></a><span id="l1.3154" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3155"></a><span id="l1.3155" class="difflineplus">+  return rv;</span>
<a href="#l1.3156"></a><span id="l1.3156"> }</span>
<a href="#l1.3157"></a><span id="l1.3157"> </span>
<a href="#l1.3158"></a><span id="l1.3158"> /**</span>
<a href="#l1.3159"></a><span id="l1.3159">  * formatStrings is an array for the prompts, item 0 is the hostname, item 1</span>
<a href="#l1.3160"></a><span id="l1.3160">  * is the username.</span>
<a href="#l1.3161"></a><span id="l1.3161">  */</span>
<a href="#l1.3162"></a><span id="l1.3162" class="difflineminus">-nsresult</span>
<a href="#l1.3163"></a><span id="l1.3163" class="difflineminus">-nsSmtpProtocol::PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl,</span>
<a href="#l1.3164"></a><span id="l1.3164" class="difflineminus">-                                  const char16_t **formatStrings, nsAString &amp;aPassword)</span>
<a href="#l1.3165"></a><span id="l1.3165" class="difflineminus">-{</span>
<a href="#l1.3166"></a><span id="l1.3166" class="difflineplus">+nsresult nsSmtpProtocol::PromptForPassword(nsISmtpServer *aSmtpServer,</span>
<a href="#l1.3167"></a><span id="l1.3167" class="difflineplus">+                                           nsISmtpUrl *aSmtpUrl,</span>
<a href="#l1.3168"></a><span id="l1.3168" class="difflineplus">+                                           const char16_t **formatStrings,</span>
<a href="#l1.3169"></a><span id="l1.3169" class="difflineplus">+                                           nsAString &amp;aPassword) {</span>
<a href="#l1.3170"></a><span id="l1.3170">   nsCOMPtr&lt;nsIStringBundleService&gt; stringService =</span>
<a href="#l1.3171"></a><span id="l1.3171" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l1.3172"></a><span id="l1.3172" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l1.3173"></a><span id="l1.3173">   NS_ENSURE_TRUE(stringService, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.3174"></a><span id="l1.3174"> </span>
<a href="#l1.3175"></a><span id="l1.3175">   nsCOMPtr&lt;nsIStringBundle&gt; composeStringBundle;</span>
<a href="#l1.3176"></a><span id="l1.3176" class="difflineminus">-  nsresult rv = stringService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(composeStringBundle));</span>
<a href="#l1.3177"></a><span id="l1.3177" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3178"></a><span id="l1.3178" class="difflineplus">+  nsresult rv = stringService-&gt;CreateBundle(</span>
<a href="#l1.3179"></a><span id="l1.3179" class="difflineplus">+      &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l1.3180"></a><span id="l1.3180" class="difflineplus">+      getter_AddRefs(composeStringBundle));</span>
<a href="#l1.3181"></a><span id="l1.3181" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3182"></a><span id="l1.3182"> </span>
<a href="#l1.3183"></a><span id="l1.3183">   nsString passwordPromptString;</span>
<a href="#l1.3184"></a><span id="l1.3184" class="difflineminus">-  if(formatStrings[1])</span>
<a href="#l1.3185"></a><span id="l1.3185" class="difflineplus">+  if (formatStrings[1])</span>
<a href="#l1.3186"></a><span id="l1.3186">     rv = composeStringBundle-&gt;FormatStringFromName(</span>
<a href="#l1.3187"></a><span id="l1.3187" class="difflineminus">-      &quot;smtpEnterPasswordPromptWithUsername&quot;,</span>
<a href="#l1.3188"></a><span id="l1.3188" class="difflineminus">-      formatStrings, 2, passwordPromptString);</span>
<a href="#l1.3189"></a><span id="l1.3189" class="difflineplus">+        &quot;smtpEnterPasswordPromptWithUsername&quot;, formatStrings, 2,</span>
<a href="#l1.3190"></a><span id="l1.3190" class="difflineplus">+        passwordPromptString);</span>
<a href="#l1.3191"></a><span id="l1.3191">   else</span>
<a href="#l1.3192"></a><span id="l1.3192">     rv = composeStringBundle-&gt;FormatStringFromName(</span>
<a href="#l1.3193"></a><span id="l1.3193" class="difflineminus">-      &quot;smtpEnterPasswordPrompt&quot;,</span>
<a href="#l1.3194"></a><span id="l1.3194" class="difflineminus">-      formatStrings, 1, passwordPromptString);</span>
<a href="#l1.3195"></a><span id="l1.3195" class="difflineplus">+        &quot;smtpEnterPasswordPrompt&quot;, formatStrings, 1, passwordPromptString);</span>
<a href="#l1.3196"></a><span id="l1.3196">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3197"></a><span id="l1.3197"> </span>
<a href="#l1.3198"></a><span id="l1.3198">   nsCOMPtr&lt;nsIAuthPrompt&gt; netPrompt;</span>
<a href="#l1.3199"></a><span id="l1.3199">   rv = aSmtpUrl-&gt;GetAuthPrompt(getter_AddRefs(netPrompt));</span>
<a href="#l1.3200"></a><span id="l1.3200">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3201"></a><span id="l1.3201"> </span>
<a href="#l1.3202"></a><span id="l1.3202">   nsString passwordTitle;</span>
<a href="#l1.3203"></a><span id="l1.3203" class="difflineminus">-  rv = composeStringBundle-&gt;GetStringFromName(</span>
<a href="#l1.3204"></a><span id="l1.3204" class="difflineminus">-    &quot;smtpEnterPasswordPromptTitle&quot;,</span>
<a href="#l1.3205"></a><span id="l1.3205" class="difflineminus">-    passwordTitle);</span>
<a href="#l1.3206"></a><span id="l1.3206" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3207"></a><span id="l1.3207" class="difflineplus">+  rv = composeStringBundle-&gt;GetStringFromName(&quot;smtpEnterPasswordPromptTitle&quot;,</span>
<a href="#l1.3208"></a><span id="l1.3208" class="difflineplus">+                                              passwordTitle);</span>
<a href="#l1.3209"></a><span id="l1.3209" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3210"></a><span id="l1.3210"> </span>
<a href="#l1.3211"></a><span id="l1.3211" class="difflineminus">-  rv = aSmtpServer-&gt;GetPasswordWithUI(passwordPromptString.get(), passwordTitle.get(),</span>
<a href="#l1.3212"></a><span id="l1.3212" class="difflineminus">-    netPrompt, aPassword);</span>
<a href="#l1.3213"></a><span id="l1.3213" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3214"></a><span id="l1.3214" class="difflineplus">+  rv = aSmtpServer-&gt;GetPasswordWithUI(</span>
<a href="#l1.3215"></a><span id="l1.3215" class="difflineplus">+      passwordPromptString.get(), passwordTitle.get(), netPrompt, aPassword);</span>
<a href="#l1.3216"></a><span id="l1.3216" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3217"></a><span id="l1.3217">   return rv;</span>
<a href="#l1.3218"></a><span id="l1.3218"> }</span>
<a href="#l1.3219"></a><span id="l1.3219"> </span>
<a href="#l1.3220"></a><span id="l1.3220" class="difflineminus">-nsresult</span>
<a href="#l1.3221"></a><span id="l1.3221" class="difflineminus">-nsSmtpProtocol::GetUsernamePassword(nsACString &amp;aUsername,</span>
<a href="#l1.3222"></a><span id="l1.3222" class="difflineminus">-                                    nsAString &amp;aPassword)</span>
<a href="#l1.3223"></a><span id="l1.3223" class="difflineminus">-{</span>
<a href="#l1.3224"></a><span id="l1.3224" class="difflineminus">-    nsresult rv;</span>
<a href="#l1.3225"></a><span id="l1.3225" class="difflineminus">-    nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l1.3226"></a><span id="l1.3226" class="difflineplus">+nsresult nsSmtpProtocol::GetUsernamePassword(nsACString &amp;aUsername,</span>
<a href="#l1.3227"></a><span id="l1.3227" class="difflineplus">+                                             nsAString &amp;aPassword) {</span>
<a href="#l1.3228"></a><span id="l1.3228" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.3229"></a><span id="l1.3229" class="difflineplus">+  nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l1.3230"></a><span id="l1.3230"> </span>
<a href="#l1.3231"></a><span id="l1.3231" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.3232"></a><span id="l1.3232" class="difflineminus">-    rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.3233"></a><span id="l1.3233" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3234"></a><span id="l1.3234" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l1.3235"></a><span id="l1.3235" class="difflineplus">+  rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l1.3236"></a><span id="l1.3236" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3237"></a><span id="l1.3237"> </span>
<a href="#l1.3238"></a><span id="l1.3238" class="difflineminus">-    rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l1.3239"></a><span id="l1.3239" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3240"></a><span id="l1.3240" class="difflineplus">+  rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l1.3241"></a><span id="l1.3241" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3242"></a><span id="l1.3242"> </span>
<a href="#l1.3243"></a><span id="l1.3243" class="difflineminus">-    if (!aPassword.IsEmpty())</span>
<a href="#l1.3244"></a><span id="l1.3244" class="difflineminus">-    {</span>
<a href="#l1.3245"></a><span id="l1.3245" class="difflineminus">-        rv = smtpServer-&gt;GetUsername(aUsername);</span>
<a href="#l1.3246"></a><span id="l1.3246" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3247"></a><span id="l1.3247" class="difflineplus">+  if (!aPassword.IsEmpty()) {</span>
<a href="#l1.3248"></a><span id="l1.3248" class="difflineplus">+    rv = smtpServer-&gt;GetUsername(aUsername);</span>
<a href="#l1.3249"></a><span id="l1.3249" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3250"></a><span id="l1.3250"> </span>
<a href="#l1.3251"></a><span id="l1.3251" class="difflineminus">-        if (!aUsername.IsEmpty())</span>
<a href="#l1.3252"></a><span id="l1.3252" class="difflineminus">-          return rv;</span>
<a href="#l1.3253"></a><span id="l1.3253" class="difflineminus">-    }</span>
<a href="#l1.3254"></a><span id="l1.3254" class="difflineminus">-    // empty password</span>
<a href="#l1.3255"></a><span id="l1.3255" class="difflineplus">+    if (!aUsername.IsEmpty()) return rv;</span>
<a href="#l1.3256"></a><span id="l1.3256" class="difflineplus">+  }</span>
<a href="#l1.3257"></a><span id="l1.3257" class="difflineplus">+  // empty password</span>
<a href="#l1.3258"></a><span id="l1.3258"> </span>
<a href="#l1.3259"></a><span id="l1.3259" class="difflineminus">-    aPassword.Truncate();</span>
<a href="#l1.3260"></a><span id="l1.3260" class="difflineplus">+  aPassword.Truncate();</span>
<a href="#l1.3261"></a><span id="l1.3261"> </span>
<a href="#l1.3262"></a><span id="l1.3262" class="difflineminus">-    nsCString hostname;</span>
<a href="#l1.3263"></a><span id="l1.3263" class="difflineminus">-    rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l1.3264"></a><span id="l1.3264" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3265"></a><span id="l1.3265" class="difflineminus">-    nsAutoString hostnameUTF16;</span>
<a href="#l1.3266"></a><span id="l1.3266" class="difflineminus">-    CopyASCIItoUTF16(hostname, hostnameUTF16);</span>
<a href="#l1.3267"></a><span id="l1.3267" class="difflineplus">+  nsCString hostname;</span>
<a href="#l1.3268"></a><span id="l1.3268" class="difflineplus">+  rv = smtpServer-&gt;GetHostname(hostname);</span>
<a href="#l1.3269"></a><span id="l1.3269" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3270"></a><span id="l1.3270" class="difflineplus">+  nsAutoString hostnameUTF16;</span>
<a href="#l1.3271"></a><span id="l1.3271" class="difflineplus">+  CopyASCIItoUTF16(hostname, hostnameUTF16);</span>
<a href="#l1.3272"></a><span id="l1.3272"> </span>
<a href="#l1.3273"></a><span id="l1.3273" class="difflineminus">-    const char16_t *formatStrings[] =</span>
<a href="#l1.3274"></a><span id="l1.3274" class="difflineminus">-    {</span>
<a href="#l1.3275"></a><span id="l1.3275" class="difflineminus">-      hostnameUTF16.get(),</span>
<a href="#l1.3276"></a><span id="l1.3276" class="difflineminus">-      nullptr</span>
<a href="#l1.3277"></a><span id="l1.3277" class="difflineminus">-    };</span>
<a href="#l1.3278"></a><span id="l1.3278" class="difflineplus">+  const char16_t *formatStrings[] = {hostnameUTF16.get(), nullptr};</span>
<a href="#l1.3279"></a><span id="l1.3279"> </span>
<a href="#l1.3280"></a><span id="l1.3280" class="difflineminus">-    rv = PromptForPassword(smtpServer, smtpUrl, formatStrings, aPassword);</span>
<a href="#l1.3281"></a><span id="l1.3281" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3282"></a><span id="l1.3282" class="difflineminus">-    return rv;</span>
<a href="#l1.3283"></a><span id="l1.3283" class="difflineplus">+  rv = PromptForPassword(smtpServer, smtpUrl, formatStrings, aPassword);</span>
<a href="#l1.3284"></a><span id="l1.3284" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3285"></a><span id="l1.3285" class="difflineplus">+  return rv;</span>
<a href="#l1.3286"></a><span id="l1.3286"> }</span>
<a href="#l1.3287"></a><span id="l1.3287" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -9,228 +9,235 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;msgIOAuth2Module.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsISmtpUrl.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIProtocolProxyCallback.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;MailNewsTypes2.h&quot; // for nsMsgSocketType</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;MailNewsTypes2.h&quot;  // for nsMsgSocketType</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> class nsIVariant;</span>
<a href="#l2.19"></a><span id="l2.19"> class nsIWritableVariant;</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">- /* states of the machine</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+/* states of the machine</span>
<a href="#l2.23"></a><span id="l2.23">  */</span>
<a href="#l2.24"></a><span id="l2.24"> typedef enum _SmtpState {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-SMTP_RESPONSE = 0,                                  // 0</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-SMTP_START_CONNECT,                                 // 1</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-SMTP_FINISH_CONNECT,                                // 2</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-SMTP_SEND_HELO_RESPONSE,                            // 3</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-SMTP_SEND_EHLO_RESPONSE,                            // 4</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-SMTP_SEND_MAIL_RESPONSE,                            // 5</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-SMTP_SEND_RCPT_RESPONSE,                            // 6</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-SMTP_SEND_DATA_RESPONSE,                            // 7</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-SMTP_SEND_POST_DATA,                                // 8</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-SMTP_SEND_MESSAGE_RESPONSE,                         // 9</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-SMTP_DONE,                                          // 10</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-SMTP_ERROR_DONE,                                    // 11</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-SMTP_FREE,                                          // 12</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-SMTP_AUTH_LOGIN_STEP0_RESPONSE,                     // 13</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-SMTP_EXTN_LOGIN_RESPONSE,                           // 14</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-SMTP_SEND_AUTH_LOGIN_STEP0,                         // 15</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-SMTP_SEND_AUTH_LOGIN_STEP1,                         // 16</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-SMTP_SEND_AUTH_LOGIN_STEP2,                         // 17</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-SMTP_AUTH_LOGIN_RESPONSE,                           // 18</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-SMTP_TLS_RESPONSE,                                  // 19</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-SMTP_AUTH_EXTERNAL_RESPONSE,                        // 20</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-SMTP_AUTH_PROCESS_STATE,                            // 21</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-SMTP_AUTH_CRAM_MD5_CHALLENGE_RESPONSE,              // 22</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-SMTP_SEND_AUTH_GSSAPI_FIRST,                        // 23</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-SMTP_SEND_AUTH_GSSAPI_STEP,                         // 24</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-SMTP_SUSPENDED,                                     // 25</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-SMTP_AUTH_OAUTH2_STEP,                              // 26</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-SMTP_AUTH_OAUTH2_RESPONSE,                          // 27</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-SMTP_CLIENTID_RESPONSE,                             // 28</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  SMTP_RESPONSE = 0,                      // 0</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  SMTP_START_CONNECT,                     // 1</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  SMTP_FINISH_CONNECT,                    // 2</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  SMTP_SEND_HELO_RESPONSE,                // 3</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  SMTP_SEND_EHLO_RESPONSE,                // 4</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  SMTP_SEND_MAIL_RESPONSE,                // 5</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  SMTP_SEND_RCPT_RESPONSE,                // 6</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  SMTP_SEND_DATA_RESPONSE,                // 7</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  SMTP_SEND_POST_DATA,                    // 8</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  SMTP_SEND_MESSAGE_RESPONSE,             // 9</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  SMTP_DONE,                              // 10</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  SMTP_ERROR_DONE,                        // 11</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  SMTP_FREE,                              // 12</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  SMTP_AUTH_LOGIN_STEP0_RESPONSE,         // 13</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  SMTP_EXTN_LOGIN_RESPONSE,               // 14</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  SMTP_SEND_AUTH_LOGIN_STEP0,             // 15</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  SMTP_SEND_AUTH_LOGIN_STEP1,             // 16</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  SMTP_SEND_AUTH_LOGIN_STEP2,             // 17</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  SMTP_AUTH_LOGIN_RESPONSE,               // 18</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  SMTP_TLS_RESPONSE,                      // 19</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  SMTP_AUTH_EXTERNAL_RESPONSE,            // 20</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  SMTP_AUTH_PROCESS_STATE,                // 21</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  SMTP_AUTH_CRAM_MD5_CHALLENGE_RESPONSE,  // 22</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  SMTP_SEND_AUTH_GSSAPI_FIRST,            // 23</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  SMTP_SEND_AUTH_GSSAPI_STEP,             // 24</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  SMTP_SUSPENDED,                         // 25</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  SMTP_AUTH_OAUTH2_STEP,                  // 26</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  SMTP_AUTH_OAUTH2_RESPONSE,              // 27</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  SMTP_CLIENTID_RESPONSE,                 // 28</span>
<a href="#l2.83"></a><span id="l2.83"> } SmtpState;</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85"> // State Flags (Note, I use the word state in terms of storing</span>
<a href="#l2.86"></a><span id="l2.86"> // state information about the connection (authentication, have we sent</span>
<a href="#l2.87"></a><span id="l2.87"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-#define SMTP_PAUSE_FOR_READ             0x00000001  /* should we pause for the next read */</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-#define SMTP_ESMTP_SERVER               0x00000002</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-#define SMTP_EHLO_DSN_ENABLED           0x00000004</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-#define SMTP_EHLO_STARTTLS_ENABLED      0x00000008</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-#define SMTP_EHLO_SIZE_ENABLED          0x00000010</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-#define SMTP_EHLO_8BIT_ENABLED          0x00000020</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-#define SMTP_EHLO_CLIENTID_ENABLED      0x00000040</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+#define SMTP_PAUSE_FOR_READ 0x00000001 /* should we pause for the next read */</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+#define SMTP_ESMTP_SERVER 0x00000002</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+#define SMTP_EHLO_DSN_ENABLED 0x00000004</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+#define SMTP_EHLO_STARTTLS_ENABLED 0x00000008</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+#define SMTP_EHLO_SIZE_ENABLED 0x00000010</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+#define SMTP_EHLO_8BIT_ENABLED 0x00000020</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+#define SMTP_EHLO_CLIENTID_ENABLED 0x00000040</span>
<a href="#l2.102"></a><span id="l2.102"> </span>
<a href="#l2.103"></a><span id="l2.103"> // insecure mechanisms follow</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-#define SMTP_AUTH_LOGIN_ENABLED         0x00000100</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-#define SMTP_AUTH_PLAIN_ENABLED         0x00000200</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-#define SMTP_AUTH_EXTERNAL_ENABLED      0x00000400</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+#define SMTP_AUTH_LOGIN_ENABLED 0x00000100</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+#define SMTP_AUTH_PLAIN_ENABLED 0x00000200</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+#define SMTP_AUTH_EXTERNAL_ENABLED 0x00000400</span>
<a href="#l2.110"></a><span id="l2.110"> // secure mechanisms follow</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-#define SMTP_AUTH_GSSAPI_ENABLED        0x00000800</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-#define SMTP_AUTH_DIGEST_MD5_ENABLED    0x00001000</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-#define SMTP_AUTH_CRAM_MD5_ENABLED      0x00002000</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-#define SMTP_AUTH_NTLM_ENABLED          0x00004000</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-#define SMTP_AUTH_MSN_ENABLED           0x00008000</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-#define SMTP_AUTH_OAUTH2_ENABLED        0x00010000</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+#define SMTP_AUTH_GSSAPI_ENABLED 0x00000800</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+#define SMTP_AUTH_DIGEST_MD5_ENABLED 0x00001000</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+#define SMTP_AUTH_CRAM_MD5_ENABLED 0x00002000</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+#define SMTP_AUTH_NTLM_ENABLED 0x00004000</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+#define SMTP_AUTH_MSN_ENABLED 0x00008000</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+#define SMTP_AUTH_OAUTH2_ENABLED 0x00010000</span>
<a href="#l2.123"></a><span id="l2.123"> // sum of all above auth mechanisms</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-#define SMTP_AUTH_ANY                   0x0001FF00</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+#define SMTP_AUTH_ANY 0x0001FF00</span>
<a href="#l2.126"></a><span id="l2.126"> // indicates that AUTH has been advertised</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-#define SMTP_AUTH                       0x00020000</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+#define SMTP_AUTH 0x00020000</span>
<a href="#l2.129"></a><span id="l2.129"> // No login necessary (pref)</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-#define SMTP_AUTH_NONE_ENABLED          0x00040000</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+#define SMTP_AUTH_NONE_ENABLED 0x00040000</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133"> class nsSmtpProtocol : public nsMsgAsyncWriteProtocol,</span>
<a href="#l2.134"></a><span id="l2.134">                        public msgIOAuth2ModuleListener,</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-                       public nsIProtocolProxyCallback</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-{</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-public:</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    NS_DECL_MSGIOAUTH2MODULELISTENER</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    NS_DECL_NSIPROTOCOLPROXYCALLBACK</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+                       public nsIProtocolProxyCallback {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+ public:</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  NS_DECL_MSGIOAUTH2MODULELISTENER</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  NS_DECL_NSIPROTOCOLPROXYCALLBACK</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+  // Creating a protocol instance requires the URL which needs to be run.</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  explicit nsSmtpProtocol(nsIURI *aURL);</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-    // Creating a protocol instance requires the URL which needs to be run.</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-    explicit nsSmtpProtocol(nsIURI * aURL);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  virtual nsresult LoadUrl(nsIURI *aURL,</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+                           nsISupports *aConsumer = nullptr) override;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  virtual nsresult SendData(const char *dataBuffer,</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+                            bool aSuppressLogging = false) override;</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-    virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer = nullptr) override;</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-    virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false) override;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-    // we support the nsIStreamListener interface</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  // we support the nsIStreamListener interface</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.166"></a><span id="l2.166"> </span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-    // stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-    NS_IMETHOD OnStopRequest(nsIRequest *request, nsresult status) override;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  // stop binding is a &quot;notification&quot; informing us that the stream associated</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  // with aURL is going away.</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  NS_IMETHOD OnStopRequest(nsIRequest *request, nsresult status) override;</span>
<a href="#l2.172"></a><span id="l2.172"> </span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-private:</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    virtual ~nsSmtpProtocol();</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    // if we are asked to load a url while we are blocked waiting for redirection information,</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-    // then we'll store the url consumer in mPendingConsumer until we can actually load</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    // the url.</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; mPendingConsumer;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+ private:</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  virtual ~nsSmtpProtocol();</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+  // if we are asked to load a url while we are blocked waiting for redirection</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+  // information, then we'll store the url consumer in mPendingConsumer until we</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+  // can actually load the url.</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; mPendingConsumer;</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    // the nsISmtpURL that is currently running</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    nsCOMPtr&lt;nsISmtpUrl&gt; m_runningURL;</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  // the nsISmtpURL that is currently running</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+  nsCOMPtr&lt;nsISmtpUrl&gt; m_runningURL;</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-    // the error state we want to set on the url</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-    nsresult m_urlErrorState;</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+  // the error state we want to set on the url</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+  nsresult m_urlErrorState;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l2.197"></a><span id="l2.197"> </span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-    // Generic state information -- What state are we in? What state do we want to go to</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-    // after the next response? What was the last response code? etc.</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-    SmtpState m_nextState;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-    SmtpState m_nextStateAfterResponse;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    int32_t m_responseCode;    /* code returned from Smtp server */</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    int32_t m_responseCodeEnhanced;    /* ESMTP code returned from SMTP server (RFC1893) */</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    int32_t m_previousResponseCode;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-    int32_t m_continuationResponse;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    nsCString m_responseText;   /* text returned from Smtp server */</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-    RefPtr&lt;nsMsgLineStreamBuffer&gt; m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-    nsTArray&lt;nsCString&gt; m_addresses;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    uint32_t       m_addressesLeft;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-    nsCString m_mailAddr;</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-    nsCString m_helloArgument;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    nsCString m_clientId;</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-    int32_t        m_sizelimit;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+  // Generic state information -- What state are we in? What state do we want to</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+  // go to after the next response? What was the last response code? etc.</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+  SmtpState m_nextState;</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  SmtpState m_nextStateAfterResponse;</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+  int32_t m_responseCode;         /* code returned from Smtp server */</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  int32_t m_responseCodeEnhanced; /* ESMTP code returned from SMTP server</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+                                     (RFC1893) */</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+  int32_t m_previousResponseCode;</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+  int32_t m_continuationResponse;</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  nsCString m_responseText; /* text returned from Smtp server */</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+  RefPtr&lt;nsMsgLineStreamBuffer&gt;</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+      m_lineStreamBuffer;  // used to efficiently extract lines from the</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+                           // incoming data stream</span>
<a href="#l2.228"></a><span id="l2.228"> </span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    // *** the following should move to the smtp server when we support</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-    // multiple smtp servers</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-    bool m_usernamePrompted;</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-    int32_t m_prefSocketType;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-    bool m_tlsEnabled;</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-    bool m_tlsInitiated;</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    bool m_clientIDInitialized;</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_addresses;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+  uint32_t m_addressesLeft;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+  nsCString m_mailAddr;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+  nsCString m_helloArgument;</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  nsCString m_clientId;</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+  int32_t m_sizelimit;</span>
<a href="#l2.244"></a><span id="l2.244"> </span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    bool m_sendDone;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+  // *** the following should move to the smtp server when we support</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+  // multiple smtp servers</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+  bool m_usernamePrompted;</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+  int32_t m_prefSocketType;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+  bool m_tlsEnabled;</span>
<a href="#l2.251"></a><span id="l2.251"> </span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-    int32_t m_totalAmountRead;</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-    int64_t m_totalMessageSize;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+  bool m_tlsInitiated;</span>
<a href="#l2.255"></a><span id="l2.255"> </span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-    char *m_dataBuf;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-    uint32_t m_dataBufSize;</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+  bool m_clientIDInitialized;</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+  bool m_sendDone;</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-    int32_t   m_originalContentLength; /* the content length at the time of calling graph progress */</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+  int32_t m_totalAmountRead;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+  int64_t m_totalMessageSize;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+  char *m_dataBuf;</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+  uint32_t m_dataBufSize;</span>
<a href="#l2.268"></a><span id="l2.268"> </span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    // initialization function given a new url and transport layer</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-    nsresult Initialize(nsIURI * aURL);</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-    nsresult InitializeInternal(nsIProxyInfo* proxyInfo);</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    nsresult LoadUrlInternal(nsIURI *aURL, nsISupports *aConsumer);</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-                                          uint64_t sourceOffset, uint32_t length) override;</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+  int32_t m_originalContentLength; /* the content length at the time of calling</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+                                      graph progress */</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-    // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-    void UpdateStatus(const char* aStatusName);</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-    void UpdateStatusWithString(const char16_t * aStatusString);</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+  // initialization function given a new url and transport layer</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+  nsresult Initialize(nsIURI *aURL);</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+  nsresult InitializeInternal(nsIProxyInfo *proxyInfo);</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+  nsresult LoadUrlInternal(nsIURI *aURL, nsISupports *aConsumer);</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+  virtual nsresult ProcessProtocolState(nsIURI *url,</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+                                        nsIInputStream *inputStream,</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+                                        uint64_t sourceOffset,</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+                                        uint32_t length) override;</span>
<a href="#l2.292"></a><span id="l2.292"> </span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-    // Protocol Methods --&gt; This protocol is state driven so each protocol method is</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-    //                      designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-    //                      group them together based on functionality.</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+  // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+  void UpdateStatus(const char *aStatusName);</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+  void UpdateStatusWithString(const char16_t *aStatusString);</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-    nsresult SmtpResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-    nsresult ExtensionLoginResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-    nsresult SendHeloResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-    nsresult SendEhloResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-    nsresult SendQuit(SmtpState aNextStateAfterResponse = SMTP_DONE);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+  // Protocol Methods --&gt; This protocol is state driven so each protocol method</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+  //            is designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+  //            group them together based on functionality.</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.315"></a><span id="l2.315"> </span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-    nsresult AuthGSSAPIFirst();</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-    nsresult AuthGSSAPIStep();</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-    nsresult AuthLoginStep0();</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-    void     AuthLoginStep0Response();</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-    nsresult AuthLoginStep1();</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-    nsresult AuthLoginStep2();</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-    nsresult AuthLoginResponse(nsIInputStream * stream, uint32_t length);</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-    nsresult AuthOAuth2Step1();</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+  nsresult SmtpResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+  nsresult ExtensionLoginResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+  nsresult SendHeloResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+  nsresult SendEhloResponse(nsIInputStream *inputStream, uint32_t length);</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+  nsresult SendQuit(SmtpState aNextStateAfterResponse = SMTP_DONE);</span>
<a href="#l2.329"></a><span id="l2.329"> </span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-    nsresult SendTLSResponse();</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    nsresult SendClientIDResponse();</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-    nsresult SendMailResponse();</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-    nsresult SendRecipientResponse();</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    nsresult SendDataResponse();</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-    void     SendPostData();</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-    nsresult SendMessageResponse();</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-    nsresult ProcessAuth();</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+  nsresult AuthGSSAPIFirst();</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+  nsresult AuthGSSAPIStep();</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+  nsresult AuthLoginStep0();</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+  void AuthLoginStep0Response();</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+  nsresult AuthLoginStep1();</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+  nsresult AuthLoginStep2();</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+  nsresult AuthLoginResponse(nsIInputStream *stream, uint32_t length);</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+  nsresult AuthOAuth2Step1();</span>
<a href="#l2.346"></a><span id="l2.346"> </span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+  nsresult SendTLSResponse();</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+  nsresult SendClientIDResponse();</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+  nsresult SendMailResponse();</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+  nsresult SendRecipientResponse();</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+  nsresult SendDataResponse();</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+  void SendPostData();</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+  nsresult SendMessageResponse();</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+  nsresult ProcessAuth();</span>
<a href="#l2.355"></a><span id="l2.355"> </span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-    // End of Protocol Methods</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-    void SendMessageInFile();</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+  // End of Protocol Methods</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.364"></a><span id="l2.364"> </span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-    void AppendHelloArgument(nsACString&amp; aResult);</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-    nsresult GetPassword(nsString &amp;aPassword);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-    nsresult GetUsernamePassword(nsACString &amp;aUsername, nsAString &amp;aPassword);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-    nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl,</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-                               const char16_t **formatStrings,</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-                               nsAString &amp;aPassword);</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+  void SendMessageInFile();</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+  void AppendHelloArgument(nsACString &amp;aResult);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+  nsresult GetPassword(nsString &amp;aPassword);</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+  nsresult GetUsernamePassword(nsACString &amp;aUsername, nsAString &amp;aPassword);</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+  nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl,</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+                             const char16_t **formatStrings,</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+                             nsAString &amp;aPassword);</span>
<a href="#l2.379"></a><span id="l2.379"> </span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-    void    InitPrefAuthMethods(int32_t authMethodPrefValue);</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-    nsresult ChooseAuthMethod();</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-    void    MarkAuthMethodAsFailed(int32_t failedAuthMethod);</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-    void    ResetAuthMethods();</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+  void InitPrefAuthMethods(int32_t authMethodPrefValue);</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+  nsresult ChooseAuthMethod();</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+  void MarkAuthMethodAsFailed(int32_t failedAuthMethod);</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+  void ResetAuthMethods();</span>
<a href="#l2.388"></a><span id="l2.388"> </span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-    virtual const char* GetType() override {return &quot;smtp&quot;;}</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+  virtual const char *GetType() override { return &quot;smtp&quot;; }</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-    int32_t m_prefAuthMethods; // set of capability flags for auth methods</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-    int32_t m_failedAuthMethods; // ditto</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-    int32_t m_currentAuthMethod; // exactly one capability flag, or 0</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+  int32_t m_prefAuthMethods;    // set of capability flags for auth methods</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+  int32_t m_failedAuthMethods;  // ditto</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+  int32_t m_currentAuthMethod;  // exactly one capability flag, or 0</span>
<a href="#l2.398"></a><span id="l2.398"> </span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-    // The support module for OAuth2 logon, only present if OAuth2 is enabled</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-    // and working.</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-    nsCOMPtr&lt;msgIOAuth2Module&gt; mOAuth2Support;</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+  // The support module for OAuth2 logon, only present if OAuth2 is enabled</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+  // and working.</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+  nsCOMPtr&lt;msgIOAuth2Module&gt; mOAuth2Support;</span>
<a href="#l2.405"></a><span id="l2.405"> };</span>
<a href="#l2.406"></a><span id="l2.406"> </span>
<a href="#l2.407"></a><span id="l2.407"> #endif  // nsSmtpProtocol_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -18,493 +18,432 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIArray.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsMemory.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> NS_IMPL_ADDREF(nsSmtpServer)</span>
<a href="#l3.10"></a><span id="l3.10"> NS_IMPL_RELEASE(nsSmtpServer)</span>
<a href="#l3.11"></a><span id="l3.11"> NS_INTERFACE_MAP_BEGIN(nsSmtpServer)</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsISmtpServer)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsISmtpServer)</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsISmtpServer)</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsISmtpServer)</span>
<a href="#l3.20"></a><span id="l3.20"> NS_INTERFACE_MAP_END</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-nsSmtpServer::nsSmtpServer():</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    mKey(&quot;&quot;)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-{</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    m_logonFailed = false;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    getPrefs();</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+nsSmtpServer::nsSmtpServer() : mKey(&quot;&quot;) {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  m_logonFailed = false;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  getPrefs();</span>
<a href="#l3.30"></a><span id="l3.30"> }</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-nsSmtpServer::~nsSmtpServer()</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-{</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-}</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+nsSmtpServer::~nsSmtpServer() {}</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-nsresult nsSmtpServer::Init()</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-{</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+nsresult nsSmtpServer::Init() {</span>
<a href="#l3.40"></a><span id="l3.40">   // We need to know when the password manager changes.</span>
<a href="#l3.41"></a><span id="l3.41">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-           mozilla::services::GetObserverService();</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l3.44"></a><span id="l3.44">   NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   observerService-&gt;AddObserver(this, &quot;passwordmgr-storage-changed&quot;, false);</span>
<a href="#l3.47"></a><span id="l3.47">   observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">   return NS_OK;</span>
<a href="#l3.50"></a><span id="l3.50"> }</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52"> NS_IMETHODIMP</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-nsSmtpServer::Observe(nsISupports *aSubject, const char* aTopic,</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-                             const char16_t *aData)</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-{</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+nsSmtpServer::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+                      const char16_t *aData) {</span>
<a href="#l3.58"></a><span id="l3.58">   // When the state of the password manager changes we need to clear the</span>
<a href="#l3.59"></a><span id="l3.59">   // password from the cache in case the user just removed it.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  if (strcmp(aTopic, &quot;passwordmgr-storage-changed&quot;) == 0)</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+  if (strcmp(aTopic, &quot;passwordmgr-storage-changed&quot;) == 0) {</span>
<a href="#l3.63"></a><span id="l3.63">     m_password.Truncate();</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  }</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  else if (strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0)</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  {</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  } else if (strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID) == 0) {</span>
<a href="#l3.68"></a><span id="l3.68">     // Now remove ourselves from the observer service as well.</span>
<a href="#l3.69"></a><span id="l3.69">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l3.72"></a><span id="l3.72">     NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">     observerService-&gt;RemoveObserver(this, &quot;passwordmgr-storage-changed&quot;);</span>
<a href="#l3.75"></a><span id="l3.75">     observerService-&gt;RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<a href="#l3.76"></a><span id="l3.76">   }</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">   return NS_OK;</span>
<a href="#l3.79"></a><span id="l3.79"> }</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-</span>
<a href="#l3.82"></a><span id="l3.82"> NS_IMETHODIMP</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-nsSmtpServer::GetKey(char * *aKey)</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-{</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    if (!aKey) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    if (mKey.IsEmpty())</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-        *aKey = nullptr;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    else</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-        *aKey = ToNewCString(mKey);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+nsSmtpServer::GetKey(char **aKey) {</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  if (!aKey) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  if (mKey.IsEmpty())</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    *aKey = nullptr;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  else</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    *aKey = ToNewCString(mKey);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.98"></a><span id="l3.98"> }</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100"> NS_IMETHODIMP</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-nsSmtpServer::SetKey(const char * aKey)</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-{</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-    NS_ASSERTION(aKey, &quot;Bad key pointer&quot;);</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-    mKey = aKey;</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-    return getPrefs();</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+nsSmtpServer::SetKey(const char *aKey) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  NS_ASSERTION(aKey, &quot;Bad key pointer&quot;);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  mKey = aKey;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  return getPrefs();</span>
<a href="#l3.110"></a><span id="l3.110"> }</span>
<a href="#l3.111"></a><span id="l3.111"> </span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-nsresult nsSmtpServer::getPrefs()</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-{</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    nsresult rv;</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    nsCOMPtr&lt;nsIPrefService&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-        return rv;</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+nsresult nsSmtpServer::getPrefs() {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-    nsAutoCString branchName;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-    branchName.AssignLiteral(&quot;mail.smtpserver.&quot;);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-    branchName += mKey;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-    branchName.Append('.');</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    rv = prefs-&gt;GetBranch(branchName.get(), getter_AddRefs(mPrefBranch));</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-        return rv;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  nsAutoCString branchName;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  branchName.AssignLiteral(&quot;mail.smtpserver.&quot;);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  branchName += mKey;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+  branchName.Append('.');</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  rv = prefs-&gt;GetBranch(branchName.get(), getter_AddRefs(mPrefBranch));</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    if(!mDefPrefBranch) {</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-        branchName.AssignLiteral(&quot;mail.smtpserver.default.&quot;);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-        rv = prefs-&gt;GetBranch(branchName.get(), getter_AddRefs(mDefPrefBranch));</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-            return rv;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    }</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  if (!mDefPrefBranch) {</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    branchName.AssignLiteral(&quot;mail.smtpserver.default.&quot;);</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+    rv = prefs-&gt;GetBranch(branchName.get(), getter_AddRefs(mDefPrefBranch));</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  }</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.151"></a><span id="l3.151"> }</span>
<a href="#l3.152"></a><span id="l3.152"> </span>
<a href="#l3.153"></a><span id="l3.153"> NS_IMETHODIMP</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-nsSmtpServer::GetHostname(nsACString &amp;aHostname)</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-{</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+nsSmtpServer::GetHostname(nsACString &amp;aHostname) {</span>
<a href="#l3.157"></a><span id="l3.157">   nsCString result;</span>
<a href="#l3.158"></a><span id="l3.158">   nsresult rv = mPrefBranch-&gt;GetCharPref(&quot;hostname&quot;, result);</span>
<a href="#l3.159"></a><span id="l3.159">   if (NS_FAILED(rv))</span>
<a href="#l3.160"></a><span id="l3.160">     aHostname.Truncate();</span>
<a href="#l3.161"></a><span id="l3.161">   else</span>
<a href="#l3.162"></a><span id="l3.162">     aHostname = result;</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164">   return NS_OK;</span>
<a href="#l3.165"></a><span id="l3.165"> }</span>
<a href="#l3.166"></a><span id="l3.166"> </span>
<a href="#l3.167"></a><span id="l3.167"> NS_IMETHODIMP</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-nsSmtpServer::SetHostname(const nsACString &amp;aHostname)</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-{</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+nsSmtpServer::SetHostname(const nsACString &amp;aHostname) {</span>
<a href="#l3.171"></a><span id="l3.171">   if (!aHostname.IsEmpty())</span>
<a href="#l3.172"></a><span id="l3.172">     return mPrefBranch-&gt;SetCharPref(&quot;hostname&quot;, aHostname);</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174">   // If the pref value is already empty, ClearUserPref will return</span>
<a href="#l3.175"></a><span id="l3.175">   // NS_ERROR_UNEXPECTED, so don't check the rv here.</span>
<a href="#l3.176"></a><span id="l3.176">   mPrefBranch-&gt;ClearUserPref(&quot;hostname&quot;);</span>
<a href="#l3.177"></a><span id="l3.177">   return NS_OK;</span>
<a href="#l3.178"></a><span id="l3.178"> }</span>
<a href="#l3.179"></a><span id="l3.179"> </span>
<a href="#l3.180"></a><span id="l3.180"> NS_IMETHODIMP</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-nsSmtpServer::GetDescription(nsACString &amp;aDescription)</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-{</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-    nsCString temp;</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-    mPrefBranch-&gt;GetCharPref(&quot;description&quot;, temp);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    aDescription.Assign(temp);</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+nsSmtpServer::GetDescription(nsACString &amp;aDescription) {</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+  nsCString temp;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+  mPrefBranch-&gt;GetCharPref(&quot;description&quot;, temp);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  aDescription.Assign(temp);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.192"></a><span id="l3.192"> }</span>
<a href="#l3.193"></a><span id="l3.193"> </span>
<a href="#l3.194"></a><span id="l3.194"> NS_IMETHODIMP</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-nsSmtpServer::SetDescription(const nsACString &amp;aDescription)</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-{</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-    if (!aDescription.IsEmpty())</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-        return mPrefBranch-&gt;SetCharPref(&quot;description&quot;, aDescription);</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-    else</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-        mPrefBranch-&gt;ClearUserPref(&quot;description&quot;);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+nsSmtpServer::SetDescription(const nsACString &amp;aDescription) {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+  if (!aDescription.IsEmpty())</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+    return mPrefBranch-&gt;SetCharPref(&quot;description&quot;, aDescription);</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  else</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+    mPrefBranch-&gt;ClearUserPref(&quot;description&quot;);</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.208"></a><span id="l3.208"> }</span>
<a href="#l3.209"></a><span id="l3.209"> </span>
<a href="#l3.210"></a><span id="l3.210"> // if GetPort returns 0, it means default port</span>
<a href="#l3.211"></a><span id="l3.211"> NS_IMETHODIMP</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-nsSmtpServer::GetPort(int32_t *aPort)</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-{</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+nsSmtpServer::GetPort(int32_t *aPort) {</span>
<a href="#l3.215"></a><span id="l3.215">   NS_ENSURE_ARG_POINTER(aPort);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-  if (NS_FAILED(mPrefBranch-&gt;GetIntPref(&quot;port&quot;, aPort)))</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-    *aPort = 0;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+  if (NS_FAILED(mPrefBranch-&gt;GetIntPref(&quot;port&quot;, aPort))) *aPort = 0;</span>
<a href="#l3.219"></a><span id="l3.219">   return NS_OK;</span>
<a href="#l3.220"></a><span id="l3.220"> }</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222"> NS_IMETHODIMP</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-nsSmtpServer::SetPort(int32_t aPort)</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-{</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-  if (aPort)</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    return mPrefBranch-&gt;SetIntPref(&quot;port&quot;, aPort);</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+nsSmtpServer::SetPort(int32_t aPort) {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  if (aPort) return mPrefBranch-&gt;SetIntPref(&quot;port&quot;, aPort);</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230">   mPrefBranch-&gt;ClearUserPref(&quot;port&quot;);</span>
<a href="#l3.231"></a><span id="l3.231">   return NS_OK;</span>
<a href="#l3.232"></a><span id="l3.232"> }</span>
<a href="#l3.233"></a><span id="l3.233"> </span>
<a href="#l3.234"></a><span id="l3.234"> NS_IMETHODIMP</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-nsSmtpServer::GetDisplayname(char * *aDisplayname)</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-{</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    nsresult rv;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDisplayname);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+nsSmtpServer::GetDisplayname(char **aDisplayname) {</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDisplayname);</span>
<a href="#l3.242"></a><span id="l3.242"> </span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-    nsCString hostname;</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-    rv = mPrefBranch-&gt;GetCharPref(&quot;hostname&quot;, hostname);</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-        *aDisplayname=nullptr;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-        return NS_OK;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-    }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-    int32_t port;</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    rv = mPrefBranch-&gt;GetIntPref(&quot;port&quot;, &amp;port);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-        port = 0;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+  nsCString hostname;</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+  rv = mPrefBranch-&gt;GetCharPref(&quot;hostname&quot;, hostname);</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+    *aDisplayname = nullptr;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  }</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+  int32_t port;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  rv = mPrefBranch-&gt;GetIntPref(&quot;port&quot;, &amp;port);</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  if (NS_FAILED(rv)) port = 0;</span>
<a href="#l3.262"></a><span id="l3.262"> </span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-    if (port) {</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-        hostname.Append(':');</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-        hostname.AppendInt(port);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    }</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  if (port) {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    hostname.Append(':');</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+    hostname.AppendInt(port);</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+  }</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    *aDisplayname = ToNewCString(hostname);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+  *aDisplayname = ToNewCString(hostname);</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.276"></a><span id="l3.276"> }</span>
<a href="#l3.277"></a><span id="l3.277"> </span>
<a href="#l3.278"></a><span id="l3.278"> NS_IMETHODIMP</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-nsSmtpServer::GetSocketType(int32_t *socketType)</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-{</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+nsSmtpServer::GetSocketType(int32_t *socketType) {</span>
<a href="#l3.282"></a><span id="l3.282">   NS_ENSURE_ARG_POINTER(socketType);</span>
<a href="#l3.283"></a><span id="l3.283">   getIntPrefWithDefault(&quot;try_ssl&quot;, socketType, 0);</span>
<a href="#l3.284"></a><span id="l3.284">   return NS_OK;</span>
<a href="#l3.285"></a><span id="l3.285"> }</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287"> NS_IMETHODIMP</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-nsSmtpServer::SetSocketType(int32_t socketType)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-{</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-    return mPrefBranch-&gt;SetIntPref(&quot;try_ssl&quot;, socketType);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+nsSmtpServer::SetSocketType(int32_t socketType) {</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+  return mPrefBranch-&gt;SetIntPref(&quot;try_ssl&quot;, socketType);</span>
<a href="#l3.293"></a><span id="l3.293"> }</span>
<a href="#l3.294"></a><span id="l3.294"> </span>
<a href="#l3.295"></a><span id="l3.295"> NS_IMETHODIMP</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-nsSmtpServer::GetHelloArgument(nsACString&amp; aHelloArgument)</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-{</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-    nsresult rv;</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    rv = mPrefBranch-&gt;GetCharPref(&quot;hello_argument&quot;, aHelloArgument);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-    {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-        rv = mDefPrefBranch-&gt;GetCharPref(&quot;hello_argument&quot;, aHelloArgument);</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-            aHelloArgument.Truncate();</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-    }</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+nsSmtpServer::GetHelloArgument(nsACString &amp;aHelloArgument) {</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+  rv = mPrefBranch-&gt;GetCharPref(&quot;hello_argument&quot;, aHelloArgument);</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+    rv = mDefPrefBranch-&gt;GetCharPref(&quot;hello_argument&quot;, aHelloArgument);</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+    if (NS_FAILED(rv)) aHelloArgument.Truncate();</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+  }</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.315"></a><span id="l3.315"> }</span>
<a href="#l3.316"></a><span id="l3.316"> </span>
<a href="#l3.317"></a><span id="l3.317"> NS_IMETHODIMP</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-nsSmtpServer::GetAuthMethod(int32_t *authMethod)</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-{</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+nsSmtpServer::GetAuthMethod(int32_t *authMethod) {</span>
<a href="#l3.321"></a><span id="l3.321">   NS_ENSURE_ARG_POINTER(authMethod);</span>
<a href="#l3.322"></a><span id="l3.322">   getIntPrefWithDefault(&quot;authMethod&quot;, authMethod, 3);</span>
<a href="#l3.323"></a><span id="l3.323">   return NS_OK;</span>
<a href="#l3.324"></a><span id="l3.324"> }</span>
<a href="#l3.325"></a><span id="l3.325"> </span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-void</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-nsSmtpServer::getIntPrefWithDefault(const char *prefName,</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-                                    int32_t *val,</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-                                    int32_t defVal)</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-{</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+void nsSmtpServer::getIntPrefWithDefault(const char *prefName, int32_t *val,</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+                                         int32_t defVal) {</span>
<a href="#l3.333"></a><span id="l3.333">   nsresult rv = mPrefBranch-&gt;GetIntPref(prefName, val);</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-    return;</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return;</span>
<a href="#l3.337"></a><span id="l3.337"> </span>
<a href="#l3.338"></a><span id="l3.338">   rv = mDefPrefBranch-&gt;GetIntPref(prefName, val);</span>
<a href="#l3.339"></a><span id="l3.339">   if (NS_FAILED(rv))</span>
<a href="#l3.340"></a><span id="l3.340">     // last resort</span>
<a href="#l3.341"></a><span id="l3.341">     *val = defVal;</span>
<a href="#l3.342"></a><span id="l3.342"> }</span>
<a href="#l3.343"></a><span id="l3.343"> </span>
<a href="#l3.344"></a><span id="l3.344"> NS_IMETHODIMP</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-nsSmtpServer::SetAuthMethod(int32_t authMethod)</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-{</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-    return mPrefBranch-&gt;SetIntPref(&quot;authMethod&quot;, authMethod);</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+nsSmtpServer::SetAuthMethod(int32_t authMethod) {</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+  return mPrefBranch-&gt;SetIntPref(&quot;authMethod&quot;, authMethod);</span>
<a href="#l3.350"></a><span id="l3.350"> }</span>
<a href="#l3.351"></a><span id="l3.351"> </span>
<a href="#l3.352"></a><span id="l3.352"> NS_IMETHODIMP</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-nsSmtpServer::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-{</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+nsSmtpServer::GetUsername(nsACString &amp;aUsername) {</span>
<a href="#l3.356"></a><span id="l3.356">   nsCString result;</span>
<a href="#l3.357"></a><span id="l3.357">   nsresult rv = mPrefBranch-&gt;GetCharPref(&quot;username&quot;, result);</span>
<a href="#l3.358"></a><span id="l3.358">   if (NS_FAILED(rv))</span>
<a href="#l3.359"></a><span id="l3.359">     aUsername.Truncate();</span>
<a href="#l3.360"></a><span id="l3.360">   else</span>
<a href="#l3.361"></a><span id="l3.361">     aUsername = result;</span>
<a href="#l3.362"></a><span id="l3.362">   return NS_OK;</span>
<a href="#l3.363"></a><span id="l3.363"> }</span>
<a href="#l3.364"></a><span id="l3.364"> </span>
<a href="#l3.365"></a><span id="l3.365"> NS_IMETHODIMP</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-nsSmtpServer::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-{</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+nsSmtpServer::SetUsername(const nsACString &amp;aUsername) {</span>
<a href="#l3.369"></a><span id="l3.369">   if (!aUsername.IsEmpty())</span>
<a href="#l3.370"></a><span id="l3.370">     return mPrefBranch-&gt;SetCharPref(&quot;username&quot;, aUsername);</span>
<a href="#l3.371"></a><span id="l3.371"> </span>
<a href="#l3.372"></a><span id="l3.372">   // If the pref value is already empty, ClearUserPref will return</span>
<a href="#l3.373"></a><span id="l3.373">   // NS_ERROR_UNEXPECTED, so don't check the rv here.</span>
<a href="#l3.374"></a><span id="l3.374">   mPrefBranch-&gt;ClearUserPref(&quot;username&quot;);</span>
<a href="#l3.375"></a><span id="l3.375">   return NS_OK;</span>
<a href="#l3.376"></a><span id="l3.376"> }</span>
<a href="#l3.377"></a><span id="l3.377"> </span>
<a href="#l3.378"></a><span id="l3.378"> NS_IMETHODIMP</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-nsSmtpServer::GetClientid(nsACString &amp;aClientid)</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-{</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+nsSmtpServer::GetClientid(nsACString &amp;aClientid) {</span>
<a href="#l3.382"></a><span id="l3.382">   nsresult rv;</span>
<a href="#l3.383"></a><span id="l3.383">   rv = mPrefBranch-&gt;GetCharPref(&quot;clientid&quot;, aClientid);</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  {</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l3.387"></a><span id="l3.387">     rv = mDefPrefBranch-&gt;GetCharPref(&quot;clientid&quot;, aClientid);</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-      aClientid.Truncate();</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+    if (NS_FAILED(rv)) aClientid.Truncate();</span>
<a href="#l3.391"></a><span id="l3.391">   }</span>
<a href="#l3.392"></a><span id="l3.392">   return NS_OK;</span>
<a href="#l3.393"></a><span id="l3.393"> }</span>
<a href="#l3.394"></a><span id="l3.394"> </span>
<a href="#l3.395"></a><span id="l3.395"> NS_IMETHODIMP</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-nsSmtpServer::SetClientid(const nsACString &amp;aClientid)</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-{</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+nsSmtpServer::SetClientid(const nsACString &amp;aClientid) {</span>
<a href="#l3.399"></a><span id="l3.399">   if (!aClientid.IsEmpty())</span>
<a href="#l3.400"></a><span id="l3.400">     return mPrefBranch-&gt;SetCharPref(&quot;clientid&quot;, aClientid);</span>
<a href="#l3.401"></a><span id="l3.401"> </span>
<a href="#l3.402"></a><span id="l3.402">   // If the pref value is already empty, ClearUserPref will return</span>
<a href="#l3.403"></a><span id="l3.403">   // NS_ERROR_UNEXPECTED, so don't check the rv here.</span>
<a href="#l3.404"></a><span id="l3.404">   mPrefBranch-&gt;ClearUserPref(&quot;clientid&quot;);</span>
<a href="#l3.405"></a><span id="l3.405">   return NS_OK;</span>
<a href="#l3.406"></a><span id="l3.406"> }</span>
<a href="#l3.407"></a><span id="l3.407"> </span>
<a href="#l3.408"></a><span id="l3.408"> NS_IMETHODIMP</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-nsSmtpServer::GetPassword(nsAString&amp; aPassword)</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-{</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-    if (m_password.IsEmpty() &amp;&amp; !m_logonFailed)</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-    {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-      // try to avoid prompting the user for another password. If the user has set</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-      // the appropriate pref, we'll use the password from an incoming server, if</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-      // the user has already logged onto that server.</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+nsSmtpServer::GetPassword(nsAString &amp;aPassword) {</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  if (m_password.IsEmpty() &amp;&amp; !m_logonFailed) {</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+    // try to avoid prompting the user for another password. If the user has set</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+    // the appropriate pref, we'll use the password from an incoming server, if</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+    // the user has already logged onto that server.</span>
<a href="#l3.421"></a><span id="l3.421"> </span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-      // if this is set, we'll only use this, and not the other prefs</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-      // user_pref(&quot;mail.smtpserver.smtp1.incomingAccount&quot;, &quot;server1&quot;);</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+    // if this is set, we'll only use this, and not the other prefs</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+    // user_pref(&quot;mail.smtpserver.smtp1.incomingAccount&quot;, &quot;server1&quot;);</span>
<a href="#l3.426"></a><span id="l3.426"> </span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-      // if this is set, we'll accept an exact match of user name and server</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-      // user_pref(&quot;mail.smtp.useMatchingHostNameServer&quot;, true);</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+    // if this is set, we'll accept an exact match of user name and server</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+    // user_pref(&quot;mail.smtp.useMatchingHostNameServer&quot;, true);</span>
<a href="#l3.431"></a><span id="l3.431"> </span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-      // if this is set, and we don't find an exact match of user and host name,</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-      // we'll accept a match of username and domain, where domain</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-      // is everything after the first '.'</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-      // user_pref(&quot;mail.smtp.useMatchingDomainServer&quot;, true);</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+    // if this is set, and we don't find an exact match of user and host name,</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+    // we'll accept a match of username and domain, where domain</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+    // is everything after the first '.'</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+    // user_pref(&quot;mail.smtp.useMatchingDomainServer&quot;, true);</span>
<a href="#l3.440"></a><span id="l3.440"> </span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-      nsCString accountKey;</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-      bool useMatchingHostNameServer = false;</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-      bool useMatchingDomainServer = false;</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-      mPrefBranch-&gt;GetCharPref(&quot;incomingAccount&quot;, accountKey);</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+    nsCString accountKey;</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+    bool useMatchingHostNameServer = false;</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+    bool useMatchingDomainServer = false;</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+    mPrefBranch-&gt;GetCharPref(&quot;incomingAccount&quot;, accountKey);</span>
<a href="#l3.449"></a><span id="l3.449"> </span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServerToUse;</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-      if (accountManager)</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-      {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-        if (!accountKey.IsEmpty())</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-          accountManager-&gt;GetIncomingServer(accountKey, getter_AddRefs(incomingServerToUse));</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-        else</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-        {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-          nsresult rv;</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-          nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-          prefBranch-&gt;GetBoolPref(&quot;mail.smtp.useMatchingHostNameServer&quot;, &amp;useMatchingHostNameServer);</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-          prefBranch-&gt;GetBoolPref(&quot;mail.smtp.useMatchingDomainServer&quot;, &amp;useMatchingDomainServer);</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-          if (useMatchingHostNameServer || useMatchingDomainServer)</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-          {</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-            nsCString userName;</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-            nsCString hostName;</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-            GetHostname(hostName);</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-            GetUsername(userName);</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-            if (useMatchingHostNameServer)</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-              // pass in empty type and port=0, to match imap and pop3.</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-              accountManager-&gt;FindRealServer(userName, hostName, EmptyCString(), 0, getter_AddRefs(incomingServerToUse));</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-            int32_t dotPos = -1;</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-            if (!incomingServerToUse &amp;&amp; useMatchingDomainServer</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-              &amp;&amp; (dotPos = hostName.FindChar('.')) != kNotFound)</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-            {</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-              hostName.Cut(0, dotPos);</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-              nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-              accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-              if (allServers)</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-              {</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-                uint32_t count = 0;</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-                allServers-&gt;GetLength(&amp;count);</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-                uint32_t i;</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-                for (i = 0; i &lt; count; i++)</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-                {</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-                  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(allServers, i);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-                  if (server)</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-                  {</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-                    nsCString serverUserName;</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-                    nsCString serverHostName;</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-                    server-&gt;GetRealUsername(serverUserName);</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-                    server-&gt;GetRealHostName(serverHostName);</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-                    if (serverUserName.Equals(userName))</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-                    {</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-                      int32_t serverDotPos = serverHostName.FindChar('.');</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-                      if (serverDotPos != kNotFound)</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-                      {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-                        serverHostName.Cut(0, serverDotPos);</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-                        if (serverHostName.Equals(hostName))</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-                        {</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-                          incomingServerToUse = server;</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-                          break;</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-                        }</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServerToUse;</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+    if (accountManager) {</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+      if (!accountKey.IsEmpty())</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+        accountManager-&gt;GetIncomingServer(accountKey,</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+                                          getter_AddRefs(incomingServerToUse));</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+      else {</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+        nsresult rv;</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+        prefBranch-&gt;GetBoolPref(&quot;mail.smtp.useMatchingHostNameServer&quot;,</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+                                &amp;useMatchingHostNameServer);</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+        prefBranch-&gt;GetBoolPref(&quot;mail.smtp.useMatchingDomainServer&quot;,</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+                                &amp;useMatchingDomainServer);</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+        if (useMatchingHostNameServer || useMatchingDomainServer) {</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+          nsCString userName;</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+          nsCString hostName;</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+          GetHostname(hostName);</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+          GetUsername(userName);</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+          if (useMatchingHostNameServer)</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+            // pass in empty type and port=0, to match imap and pop3.</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+            accountManager-&gt;FindRealServer(userName, hostName, EmptyCString(),</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+                                           0,</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+                                           getter_AddRefs(incomingServerToUse));</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+          int32_t dotPos = -1;</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+          if (!incomingServerToUse &amp;&amp; useMatchingDomainServer &amp;&amp;</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+              (dotPos = hostName.FindChar('.')) != kNotFound) {</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+            hostName.Cut(0, dotPos);</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+            nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+            accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+            if (allServers) {</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+              uint32_t count = 0;</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+              allServers-&gt;GetLength(&amp;count);</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+              uint32_t i;</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+              for (i = 0; i &lt; count; i++) {</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+                nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+                    do_QueryElementAt(allServers, i);</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+                if (server) {</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+                  nsCString serverUserName;</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+                  nsCString serverHostName;</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+                  server-&gt;GetRealUsername(serverUserName);</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+                  server-&gt;GetRealHostName(serverHostName);</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+                  if (serverUserName.Equals(userName)) {</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+                    int32_t serverDotPos = serverHostName.FindChar('.');</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+                    if (serverDotPos != kNotFound) {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+                      serverHostName.Cut(0, serverDotPos);</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+                      if (serverHostName.Equals(hostName)) {</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+                        incomingServerToUse = server;</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+                        break;</span>
<a href="#l3.555"></a><span id="l3.555">                       }</span>
<a href="#l3.556"></a><span id="l3.556">                     }</span>
<a href="#l3.557"></a><span id="l3.557">                   }</span>
<a href="#l3.558"></a><span id="l3.558">                 }</span>
<a href="#l3.559"></a><span id="l3.559">               }</span>
<a href="#l3.560"></a><span id="l3.560">             }</span>
<a href="#l3.561"></a><span id="l3.561">           }</span>
<a href="#l3.562"></a><span id="l3.562">         }</span>
<a href="#l3.563"></a><span id="l3.563">       }</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-      if (incomingServerToUse)</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-        return incomingServerToUse-&gt;GetPassword(aPassword);</span>
<a href="#l3.566"></a><span id="l3.566">     }</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-    aPassword = m_password;</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+    if (incomingServerToUse) return incomingServerToUse-&gt;GetPassword(aPassword);</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+  }</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+  aPassword = m_password;</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.573"></a><span id="l3.573"> }</span>
<a href="#l3.574"></a><span id="l3.574"> </span>
<a href="#l3.575"></a><span id="l3.575"> NS_IMETHODIMP</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-nsSmtpServer::VerifyLogon(nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-                          nsIURI **aURL)</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-{</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+nsSmtpServer::VerifyLogon(nsIUrlListener *aUrlListener,</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+                          nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l3.581"></a><span id="l3.581">   nsresult rv;</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.585"></a><span id="l3.585">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.586"></a><span id="l3.586">   return smtpService-&gt;VerifyLogon(this, aUrlListener, aMsgWindow, aURL);</span>
<a href="#l3.587"></a><span id="l3.587"> }</span>
<a href="#l3.588"></a><span id="l3.588"> </span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-</span>
<a href="#l3.590"></a><span id="l3.590"> NS_IMETHODIMP</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-nsSmtpServer::SetPassword(const nsAString&amp; aPassword)</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-{</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+nsSmtpServer::SetPassword(const nsAString &amp;aPassword) {</span>
<a href="#l3.594"></a><span id="l3.594">   m_password = aPassword;</span>
<a href="#l3.595"></a><span id="l3.595">   return NS_OK;</span>
<a href="#l3.596"></a><span id="l3.596"> }</span>
<a href="#l3.597"></a><span id="l3.597"> </span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-nsresult</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-nsSmtpServer::GetPasswordWithoutUI()</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-{</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+nsresult nsSmtpServer::GetPasswordWithoutUI() {</span>
<a href="#l3.602"></a><span id="l3.602">   nsresult rv;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-  nsCOMPtr&lt;nsILoginManager&gt; loginMgr(do_GetService(NS_LOGINMANAGER_CONTRACTID,</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-                                                   &amp;rv));</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+  nsCOMPtr&lt;nsILoginManager&gt; loginMgr(</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+      do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l3.607"></a><span id="l3.607">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.608"></a><span id="l3.608"> </span>
<a href="#l3.609"></a><span id="l3.609">   NS_ConvertASCIItoUTF16 serverUri(GetServerURIInternal(false));</span>
<a href="#l3.610"></a><span id="l3.610"> </span>
<a href="#l3.611"></a><span id="l3.611">   uint32_t numLogins = 0;</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-  nsILoginInfo** logins = nullptr;</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-  rv = loginMgr-&gt;FindLogins(&amp;numLogins, serverUri, EmptyString(),</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-                            serverUri, &amp;logins);</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+  nsILoginInfo **logins = nullptr;</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+  rv = loginMgr-&gt;FindLogins(&amp;numLogins, serverUri, EmptyString(), serverUri,</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+                            &amp;logins);</span>
<a href="#l3.618"></a><span id="l3.618">   // Login manager can produce valid fails, e.g. NS_ERROR_ABORT when a user</span>
<a href="#l3.619"></a><span id="l3.619">   // cancels the master password dialog. Therefore handle that here, but don't</span>
<a href="#l3.620"></a><span id="l3.620">   // warn about it.</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-    return rv;</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.624"></a><span id="l3.624"> </span>
<a href="#l3.625"></a><span id="l3.625">   // Don't abort here, if we didn't find any or failed, then we'll just have</span>
<a href="#l3.626"></a><span id="l3.626">   // to prompt.</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-  if (numLogins &gt; 0)</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-  {</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+  if (numLogins &gt; 0) {</span>
<a href="#l3.630"></a><span id="l3.630">     nsCString serverCUsername;</span>
<a href="#l3.631"></a><span id="l3.631">     rv = GetUsername(serverCUsername);</span>
<a href="#l3.632"></a><span id="l3.632">     NS_ConvertASCIItoUTF16 serverUsername(serverCUsername);</span>
<a href="#l3.633"></a><span id="l3.633"> </span>
<a href="#l3.634"></a><span id="l3.634">     nsString username;</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-    for (uint32_t i = 0; i &lt; numLogins; ++i)</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-    {</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+    for (uint32_t i = 0; i &lt; numLogins; ++i) {</span>
<a href="#l3.638"></a><span id="l3.638">       rv = logins[i]-&gt;GetUsername(username);</span>
<a href="#l3.639"></a><span id="l3.639">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.640"></a><span id="l3.640"> </span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-      if (username.Equals(serverUsername))</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-      {</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+      if (username.Equals(serverUsername)) {</span>
<a href="#l3.644"></a><span id="l3.644">         nsString password;</span>
<a href="#l3.645"></a><span id="l3.645">         rv = logins[i]-&gt;GetPassword(password);</span>
<a href="#l3.646"></a><span id="l3.646">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.647"></a><span id="l3.647"> </span>
<a href="#l3.648"></a><span id="l3.648">         m_password = password;</span>
<a href="#l3.649"></a><span id="l3.649">         break;</span>
<a href="#l3.650"></a><span id="l3.650">       }</span>
<a href="#l3.651"></a><span id="l3.651">     }</span>
<a href="#l3.652"></a><span id="l3.652">   }</span>
<a href="#l3.653"></a><span id="l3.653">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numLogins, logins);</span>
<a href="#l3.654"></a><span id="l3.654">   return NS_OK;</span>
<a href="#l3.655"></a><span id="l3.655"> }</span>
<a href="#l3.656"></a><span id="l3.656"> </span>
<a href="#l3.657"></a><span id="l3.657"> NS_IMETHODIMP</span>
<a href="#l3.658"></a><span id="l3.658"> nsSmtpServer::GetPasswordWithUI(const char16_t *aPromptMessage,</span>
<a href="#l3.659"></a><span id="l3.659">                                 const char16_t *aPromptTitle,</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-                                nsIAuthPrompt* aDialog,</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-                                nsAString &amp;aPassword)</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-{</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  if (!m_password.IsEmpty())</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-    return GetPassword(aPassword);</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+                                nsIAuthPrompt *aDialog, nsAString &amp;aPassword) {</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+  if (!m_password.IsEmpty()) return GetPassword(aPassword);</span>
<a href="#l3.667"></a><span id="l3.667"> </span>
<a href="#l3.668"></a><span id="l3.668">   // We need to get a password, but see if we can get it from the password</span>
<a href="#l3.669"></a><span id="l3.669">   // manager without requiring a prompt.</span>
<a href="#l3.670"></a><span id="l3.670">   nsresult rv = GetPasswordWithoutUI();</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-  if (rv == NS_ERROR_ABORT)</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-    return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+  if (rv == NS_ERROR_ABORT) return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l3.674"></a><span id="l3.674"> </span>
<a href="#l3.675"></a><span id="l3.675">   // Now re-check if we've got a password or not, if we have, then we</span>
<a href="#l3.676"></a><span id="l3.676">   // don't need to prompt the user.</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-  if (!m_password.IsEmpty())</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-  {</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+  if (!m_password.IsEmpty()) {</span>
<a href="#l3.680"></a><span id="l3.680">     aPassword = m_password;</span>
<a href="#l3.681"></a><span id="l3.681">     return NS_OK;</span>
<a href="#l3.682"></a><span id="l3.682">   }</span>
<a href="#l3.683"></a><span id="l3.683"> </span>
<a href="#l3.684"></a><span id="l3.684">   NS_ENSURE_ARG_POINTER(aDialog);</span>
<a href="#l3.685"></a><span id="l3.685"> </span>
<a href="#l3.686"></a><span id="l3.686">   // PromptPassword needs the username as well.</span>
<a href="#l3.687"></a><span id="l3.687">   nsCString serverUri(GetServerURIInternal(true));</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineat">@@ -513,63 +452,57 @@ nsSmtpServer::GetPasswordWithUI(const ch</span>
<a href="#l3.689"></a><span id="l3.689"> </span>
<a href="#l3.690"></a><span id="l3.690">   rv = aDialog-&gt;PromptPassword(aPromptTitle, aPromptMessage,</span>
<a href="#l3.691"></a><span id="l3.691">                                NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l3.692"></a><span id="l3.692">                                nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l3.693"></a><span id="l3.693">                                getter_Copies(aPassword), &amp;okayValue);</span>
<a href="#l3.694"></a><span id="l3.694">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.695"></a><span id="l3.695"> </span>
<a href="#l3.696"></a><span id="l3.696">   // If the user pressed cancel, just return an empty string.</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-  if (!okayValue)</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-  {</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+  if (!okayValue) {</span>
<a href="#l3.700"></a><span id="l3.700">     aPassword.Truncate();</span>
<a href="#l3.701"></a><span id="l3.701">     return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l3.702"></a><span id="l3.702">   }</span>
<a href="#l3.703"></a><span id="l3.703">   rv = SetPassword(aPassword);</span>
<a href="#l3.704"></a><span id="l3.704">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.705"></a><span id="l3.705"> </span>
<a href="#l3.706"></a><span id="l3.706">   return NS_OK;</span>
<a href="#l3.707"></a><span id="l3.707"> }</span>
<a href="#l3.708"></a><span id="l3.708"> </span>
<a href="#l3.709"></a><span id="l3.709"> NS_IMETHODIMP</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-nsSmtpServer::GetUsernamePasswordWithUI(const char16_t * aPromptMessage, const</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-                                char16_t *aPromptTitle,</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-                                nsIAuthPrompt* aDialog,</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-                                nsACString &amp;aUsername,</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-                                nsAString &amp;aPassword)</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-{</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+nsSmtpServer::GetUsernamePasswordWithUI(const char16_t *aPromptMessage,</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+                                        const char16_t *aPromptTitle,</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+                                        nsIAuthPrompt *aDialog,</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+                                        nsACString &amp;aUsername,</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+                                        nsAString &amp;aPassword) {</span>
<a href="#l3.721"></a><span id="l3.721">   nsresult rv;</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-  if (!m_password.IsEmpty())</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-  {</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+  if (!m_password.IsEmpty()) {</span>
<a href="#l3.725"></a><span id="l3.725">     rv = GetUsername(aUsername);</span>
<a href="#l3.726"></a><span id="l3.726">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.727"></a><span id="l3.727"> </span>
<a href="#l3.728"></a><span id="l3.728">     return GetPassword(aPassword);</span>
<a href="#l3.729"></a><span id="l3.729">   }</span>
<a href="#l3.730"></a><span id="l3.730"> </span>
<a href="#l3.731"></a><span id="l3.731">   NS_ENSURE_ARG_POINTER(aDialog);</span>
<a href="#l3.732"></a><span id="l3.732"> </span>
<a href="#l3.733"></a><span id="l3.733">   nsCString serverUri;</span>
<a href="#l3.734"></a><span id="l3.734">   rv = GetServerURI(serverUri);</span>
<a href="#l3.735"></a><span id="l3.735">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.736"></a><span id="l3.736"> </span>
<a href="#l3.737"></a><span id="l3.737">   nsString uniUsername;</span>
<a href="#l3.738"></a><span id="l3.738">   bool okayValue = true;</span>
<a href="#l3.739"></a><span id="l3.739"> </span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-  rv = aDialog-&gt;PromptUsernameAndPassword(aPromptTitle, aPromptMessage,</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-                                          NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-                                          nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-                                          getter_Copies(uniUsername),</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-                                          getter_Copies(aPassword),</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-                                          &amp;okayValue);</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+  rv = aDialog-&gt;PromptUsernameAndPassword(</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+      aPromptTitle, aPromptMessage, NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+      nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY, getter_Copies(uniUsername),</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+      getter_Copies(aPassword), &amp;okayValue);</span>
<a href="#l3.750"></a><span id="l3.750">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.751"></a><span id="l3.751"> </span>
<a href="#l3.752"></a><span id="l3.752">   // If the user pressed cancel, just return empty strings.</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-  if (!okayValue)</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-  {</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+  if (!okayValue) {</span>
<a href="#l3.756"></a><span id="l3.756">     aUsername.Truncate();</span>
<a href="#l3.757"></a><span id="l3.757">     aPassword.Truncate();</span>
<a href="#l3.758"></a><span id="l3.758">     return rv;</span>
<a href="#l3.759"></a><span id="l3.759">   }</span>
<a href="#l3.760"></a><span id="l3.760"> </span>
<a href="#l3.761"></a><span id="l3.761">   // We got a username and password back...so remember them.</span>
<a href="#l3.762"></a><span id="l3.762">   NS_LossyConvertUTF16toASCII username(uniUsername);</span>
<a href="#l3.763"></a><span id="l3.763"> </span>
<a href="#l3.764"></a><span id="l3.764" class="difflineat">@@ -579,86 +512,79 @@ nsSmtpServer::GetUsernamePasswordWithUI(</span>
<a href="#l3.765"></a><span id="l3.765">   rv = SetPassword(aPassword);</span>
<a href="#l3.766"></a><span id="l3.766">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.767"></a><span id="l3.767"> </span>
<a href="#l3.768"></a><span id="l3.768">   aUsername = username;</span>
<a href="#l3.769"></a><span id="l3.769">   return NS_OK;</span>
<a href="#l3.770"></a><span id="l3.770"> }</span>
<a href="#l3.771"></a><span id="l3.771"> </span>
<a href="#l3.772"></a><span id="l3.772"> NS_IMETHODIMP</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-nsSmtpServer::ForgetPassword()</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-{</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+nsSmtpServer::ForgetPassword() {</span>
<a href="#l3.776"></a><span id="l3.776">   nsresult rv;</span>
<a href="#l3.777"></a><span id="l3.777">   nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-    do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+      do_GetService(NS_LOGINMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.780"></a><span id="l3.780">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.781"></a><span id="l3.781"> </span>
<a href="#l3.782"></a><span id="l3.782">   // Get the current server URI without the username</span>
<a href="#l3.783"></a><span id="l3.783">   nsAutoCString serverUri(NS_LITERAL_CSTRING(&quot;smtp://&quot;));</span>
<a href="#l3.784"></a><span id="l3.784"> </span>
<a href="#l3.785"></a><span id="l3.785">   nsCString hostname;</span>
<a href="#l3.786"></a><span id="l3.786">   rv = GetHostname(hostname);</span>
<a href="#l3.787"></a><span id="l3.787"> </span>
<a href="#l3.788"></a><span id="l3.788">   if (NS_SUCCEEDED(rv) &amp;&amp; !hostname.IsEmpty()) {</span>
<a href="#l3.789"></a><span id="l3.789">     nsCString escapedHostname;</span>
<a href="#l3.790"></a><span id="l3.790">     MsgEscapeString(hostname, nsINetUtil::ESCAPE_URL_PATH, escapedHostname);</span>
<a href="#l3.791"></a><span id="l3.791">     // not all servers have a hostname</span>
<a href="#l3.792"></a><span id="l3.792">     serverUri.Append(escapedHostname);</span>
<a href="#l3.793"></a><span id="l3.793">   }</span>
<a href="#l3.794"></a><span id="l3.794"> </span>
<a href="#l3.795"></a><span id="l3.795">   uint32_t count;</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-  nsILoginInfo** logins;</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+  nsILoginInfo **logins;</span>
<a href="#l3.798"></a><span id="l3.798"> </span>
<a href="#l3.799"></a><span id="l3.799">   NS_ConvertUTF8toUTF16 currServer(serverUri);</span>
<a href="#l3.800"></a><span id="l3.800"> </span>
<a href="#l3.801"></a><span id="l3.801">   nsCString serverCUsername;</span>
<a href="#l3.802"></a><span id="l3.802">   rv = GetUsername(serverCUsername);</span>
<a href="#l3.803"></a><span id="l3.803">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.804"></a><span id="l3.804"> </span>
<a href="#l3.805"></a><span id="l3.805">   NS_ConvertUTF8toUTF16 serverUsername(serverCUsername);</span>
<a href="#l3.806"></a><span id="l3.806"> </span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-  rv = loginMgr-&gt;FindLogins(&amp;count, currServer, EmptyString(),</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-                            currServer, &amp;logins);</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+  rv = loginMgr-&gt;FindLogins(&amp;count, currServer, EmptyString(), currServer,</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+                            &amp;logins);</span>
<a href="#l3.811"></a><span id="l3.811">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.812"></a><span id="l3.812"> </span>
<a href="#l3.813"></a><span id="l3.813">   // There should only be one-login stored for this url, however just in case</span>
<a href="#l3.814"></a><span id="l3.814">   // there isn't.</span>
<a href="#l3.815"></a><span id="l3.815">   nsString username;</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-  {</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.819"></a><span id="l3.819">     if (NS_SUCCEEDED(logins[i]-&gt;GetUsername(username)) &amp;&amp;</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-        username.Equals(serverUsername))</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-    {</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+        username.Equals(serverUsername)) {</span>
<a href="#l3.823"></a><span id="l3.823">       // If this fails, just continue, we'll still want to remove the password</span>
<a href="#l3.824"></a><span id="l3.824">       // from our local cache.</span>
<a href="#l3.825"></a><span id="l3.825">       loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l3.826"></a><span id="l3.826">     }</span>
<a href="#l3.827"></a><span id="l3.827">   }</span>
<a href="#l3.828"></a><span id="l3.828">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l3.829"></a><span id="l3.829"> </span>
<a href="#l3.830"></a><span id="l3.830">   rv = SetPassword(EmptyString());</span>
<a href="#l3.831"></a><span id="l3.831">   m_logonFailed = true;</span>
<a href="#l3.832"></a><span id="l3.832">   return rv;</span>
<a href="#l3.833"></a><span id="l3.833"> }</span>
<a href="#l3.834"></a><span id="l3.834"> </span>
<a href="#l3.835"></a><span id="l3.835"> NS_IMETHODIMP</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-nsSmtpServer::GetServerURI(nsACString &amp;aResult)</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-{</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+nsSmtpServer::GetServerURI(nsACString &amp;aResult) {</span>
<a href="#l3.839"></a><span id="l3.839">   aResult = GetServerURIInternal(true);</span>
<a href="#l3.840"></a><span id="l3.840">   return NS_OK;</span>
<a href="#l3.841"></a><span id="l3.841"> }</span>
<a href="#l3.842"></a><span id="l3.842"> </span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-nsCString</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-nsSmtpServer::GetServerURIInternal(const bool aIncludeUsername)</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-{</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+nsCString nsSmtpServer::GetServerURIInternal(const bool aIncludeUsername) {</span>
<a href="#l3.847"></a><span id="l3.847">   nsCString uri(NS_LITERAL_CSTRING(&quot;smtp://&quot;));</span>
<a href="#l3.848"></a><span id="l3.848">   nsresult rv;</span>
<a href="#l3.849"></a><span id="l3.849"> </span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-  if (aIncludeUsername)</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-  {</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+  if (aIncludeUsername) {</span>
<a href="#l3.853"></a><span id="l3.853">     nsCString username;</span>
<a href="#l3.854"></a><span id="l3.854">     rv = GetUsername(username);</span>
<a href="#l3.855"></a><span id="l3.855"> </span>
<a href="#l3.856"></a><span id="l3.856">     if (NS_SUCCEEDED(rv) &amp;&amp; !username.IsEmpty()) {</span>
<a href="#l3.857"></a><span id="l3.857">       nsCString escapedUsername;</span>
<a href="#l3.858"></a><span id="l3.858">       MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l3.859"></a><span id="l3.859">       // not all servers have a username</span>
<a href="#l3.860"></a><span id="l3.860">       uri.Append(escapedUsername);</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineat">@@ -675,12 +601,9 @@ nsSmtpServer::GetServerURIInternal(const</span>
<a href="#l3.862"></a><span id="l3.862">     // not all servers have a hostname</span>
<a href="#l3.863"></a><span id="l3.863">     uri.Append(escapedHostname);</span>
<a href="#l3.864"></a><span id="l3.864">   }</span>
<a href="#l3.865"></a><span id="l3.865"> </span>
<a href="#l3.866"></a><span id="l3.866">   return uri;</span>
<a href="#l3.867"></a><span id="l3.867"> }</span>
<a href="#l3.868"></a><span id="l3.868"> </span>
<a href="#l3.869"></a><span id="l3.869"> NS_IMETHODIMP</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-nsSmtpServer::ClearAllValues()</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-{</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-  return mPrefBranch-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-}</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+nsSmtpServer::ClearAllValues() { return mPrefBranch-&gt;DeleteBranch(&quot;&quot;); }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,44 +1,42 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> #ifndef __nsSmtpServer_h_</span>
<a href="#l4.10"></a><span id="l4.10"> #define __nsSmtpServer_h_</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13"> #include &quot;nsString.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> class nsSmtpServer : public nsISmtpServer,</span>
<a href="#l4.20"></a><span id="l4.20">                      public nsSupportsWeakReference,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-                     public nsIObserver</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-{</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-public:</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-    nsSmtpServer();</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    nsresult Init();</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+                     public nsIObserver {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+ public:</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  nsSmtpServer();</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  nsresult Init();</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    NS_DECL_NSISMTPSERVER</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    NS_DECL_NSIOBSERVER</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  NS_DECL_NSISMTPSERVER</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-private:</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-    virtual ~nsSmtpServer();</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    nsCString mKey;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; mPrefBranch;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+ private:</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  virtual ~nsSmtpServer();</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  nsCString mKey;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; mPrefBranch;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    nsresult getPrefs();</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    void getIntPrefWithDefault(const char *prefName, int32_t *val,</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-                               int32_t defval);</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    nsresult GetPasswordWithoutUI();</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    nsCString GetServerURIInternal(const bool aIncludeUsername);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  nsresult getPrefs();</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  void getIntPrefWithDefault(const char *prefName, int32_t *val,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+                             int32_t defval);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  nsresult GetPasswordWithoutUI();</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  nsCString GetServerURIInternal(const bool aIncludeUsername);</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    nsString m_password;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-    bool m_logonFailed;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  nsString m_password;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  bool m_logonFailed;</span>
<a href="#l4.64"></a><span id="l4.64"> };</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsSmtpService.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineat">@@ -25,152 +25,131 @@</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24"> #define SERVER_DELIMITER ','</span>
<a href="#l5.25"></a><span id="l5.25"> #define APPEND_SERVERS_VERSION_PREF_NAME &quot;append_preconfig_smtpservers.version&quot;</span>
<a href="#l5.26"></a><span id="l5.26"> #define MAIL_ROOT_PREF &quot;mail.&quot;</span>
<a href="#l5.27"></a><span id="l5.27"> #define PREF_MAIL_SMTPSERVERS &quot;mail.smtpservers&quot;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#define PREF_MAIL_SMTPSERVERS_APPEND_SERVERS &quot;mail.smtpservers.appendsmtpservers&quot;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+#define PREF_MAIL_SMTPSERVERS_APPEND_SERVERS \</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  &quot;mail.smtpservers.appendsmtpservers&quot;</span>
<a href="#l5.31"></a><span id="l5.31"> #define PREF_MAIL_SMTP_DEFAULTSERVER &quot;mail.smtp.defaultserver&quot;</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33"> typedef struct _findServerByKeyEntry {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    const char *key;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    nsISmtpServer *server;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  const char *key;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  nsISmtpServer *server;</span>
<a href="#l5.38"></a><span id="l5.38"> } findServerByKeyEntry;</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40"> typedef struct _findServerByHostnameEntry {</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    nsCString hostname;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    nsCString username;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    nsISmtpServer *server;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  nsCString hostname;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  nsCString username;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  nsISmtpServer *server;</span>
<a href="#l5.47"></a><span id="l5.47"> } findServerByHostnameEntry;</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49"> static NS_DEFINE_CID(kCSmtpUrlCID, NS_SMTPURL_CID);</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51"> // forward declarations...</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-nsresult</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-                   nsISmtpServer *aServer,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-                   const char* aRecipients,</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-                   nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-                   const char * aSender,</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-                   nsIUrlListener * aUrlListener,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-                   nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-                   nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-                   nsIURI ** aUrl,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-                   bool aRequestDSN);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+nsresult NS_MsgBuildSmtpUrl(nsIFile *aFilePath, nsISmtpServer *aServer,</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+                            const char *aRecipients,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+                            nsIMsgIdentity *aSenderIdentity,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+                            const char *aSender, nsIUrlListener *aUrlListener,</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+                            nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+                            nsIInterfaceRequestor *aNotificationCallbacks,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+                            nsIURI **aUrl, bool aRequestDSN);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-nsresult NS_MsgLoadSmtpUrl(nsIURI * aUrl, nsISupports * aConsumer, nsIRequest ** aRequest);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+nsresult NS_MsgLoadSmtpUrl(nsIURI *aUrl, nsISupports *aConsumer,</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+                           nsIRequest **aRequest);</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-nsSmtpService::nsSmtpService() :</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    mSmtpServersLoaded(false)</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-{</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-}</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+nsSmtpService::nsSmtpService() : mSmtpServersLoaded(false) {}</span>
<a href="#l5.80"></a><span id="l5.80"> </span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-nsSmtpService::~nsSmtpService()</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-{</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    // save the SMTP servers to disk</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+nsSmtpService::~nsSmtpService() {</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  // save the SMTP servers to disk</span>
<a href="#l5.87"></a><span id="l5.87"> }</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89"> NS_IMPL_ISUPPORTS(nsSmtpService, nsISmtpService, nsIProtocolHandler)</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-NS_IMETHODIMP nsSmtpService::SendMailMessage(nsIFile * aFilePath,</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-                                        const char * aRecipients,</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-                                        nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-                                        const char * aSender,</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-                                        const nsAString &amp; aPassword,</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-                                        nsIUrlListener * aUrlListener,</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-                                        nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-                                        nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-                                        bool aRequestDSN,</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-                                        nsIURI ** aURL,</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-                                        nsIRequest ** aRequest)</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-{</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-  nsIURI * urlToRun = nullptr;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+NS_IMETHODIMP nsSmtpService::SendMailMessage(</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    nsIFile *aFilePath, const char *aRecipients,</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+    nsIMsgIdentity *aSenderIdentity, const char *aSender,</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+    const nsAString &amp;aPassword, nsIUrlListener *aUrlListener,</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+    nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+    nsIInterfaceRequestor *aNotificationCallbacks, bool aRequestDSN,</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    nsIURI **aURL, nsIRequest **aRequest) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  nsIURI *urlToRun = nullptr;</span>
<a href="#l5.113"></a><span id="l5.113">   nsresult rv = NS_OK;</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l5.116"></a><span id="l5.116">   rv = GetServerByIdentity(aSenderIdentity, getter_AddRefs(smtpServer));</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-    if (!aPassword.IsEmpty())</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-      smtpServer-&gt;SetPassword(aPassword);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer) {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+    if (!aPassword.IsEmpty()) smtpServer-&gt;SetPassword(aPassword);</span>
<a href="#l5.124"></a><span id="l5.124"> </span>
<a href="#l5.125"></a><span id="l5.125">     // this ref counts urlToRun</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-    rv = NS_MsgBuildSmtpUrl(aFilePath, smtpServer, aRecipients, aSenderIdentity, aSender,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-                            aUrlListener, aStatusFeedback,</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+    rv = NS_MsgBuildSmtpUrl(aFilePath, smtpServer, aRecipients, aSenderIdentity,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+                            aSender, aUrlListener, aStatusFeedback,</span>
<a href="#l5.130"></a><span id="l5.130">                             aNotificationCallbacks, &amp;urlToRun, aRequestDSN);</span>
<a href="#l5.131"></a><span id="l5.131">     if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)</span>
<a href="#l5.132"></a><span id="l5.132">       rv = NS_MsgLoadSmtpUrl(urlToRun, nullptr, aRequest);</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    if (aURL) // does the caller want a handle on the url?</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-      *aURL = urlToRun; // transfer our ref count to the caller....</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    if (aURL)            // does the caller want a handle on the url?</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+      *aURL = urlToRun;  // transfer our ref count to the caller....</span>
<a href="#l5.138"></a><span id="l5.138">     else</span>
<a href="#l5.139"></a><span id="l5.139">       NS_IF_RELEASE(urlToRun);</span>
<a href="#l5.140"></a><span id="l5.140">   }</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142">   return rv;</span>
<a href="#l5.143"></a><span id="l5.143"> }</span>
<a href="#l5.144"></a><span id="l5.144"> </span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-// The following are two convenience functions I'm using to help expedite building and running a mail to url...</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+// The following are two convenience functions I'm using to help expedite</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+// building and running a mail to url...</span>
<a href="#l5.149"></a><span id="l5.149"> </span>
<a href="#l5.150"></a><span id="l5.150"> // short cut function for creating a mailto url...</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-nsresult NS_MsgBuildSmtpUrl(nsIFile * aFilePath,</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-                            nsISmtpServer *aSmtpServer,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-                            const char * aRecipients,</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-                            nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-                            const char * aSender,</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-                            nsIUrlListener * aUrlListener,</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+nsresult NS_MsgBuildSmtpUrl(nsIFile *aFilePath, nsISmtpServer *aSmtpServer,</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+                            const char *aRecipients,</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+                            nsIMsgIdentity *aSenderIdentity,</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                            const char *aSender, nsIUrlListener *aUrlListener,</span>
<a href="#l5.161"></a><span id="l5.161">                             nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-                            nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-                            nsIURI ** aUrl,</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-                            bool aRequestDSN)</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-{</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-  // mscott: this function is a convenience hack until netlib actually dispatches</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-  // smtp urls. in addition until we have a session to get a password, host and</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  // other stuff from, we need to use default values....</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+                            nsIInterfaceRequestor *aNotificationCallbacks,</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+                            nsIURI **aUrl, bool aRequestDSN) {</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+  // mscott: this function is a convenience hack until netlib actually</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  // dispatches smtp urls. in addition until we have a session to get a</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+  // password, host and other stuff from, we need to use default values....</span>
<a href="#l5.174"></a><span id="l5.174">   // ..for testing purposes....</span>
<a href="#l5.175"></a><span id="l5.175"> </span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-    nsCString smtpHostName;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-    nsCString smtpUserName;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-    int32_t smtpPort;</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-    int32_t socketType;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  nsCString smtpHostName;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  nsCString smtpUserName;</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  int32_t smtpPort;</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+  int32_t socketType;</span>
<a href="#l5.184"></a><span id="l5.184"> </span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-    aSmtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-    aSmtpServer-&gt;GetUsername(smtpUserName);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-    aSmtpServer-&gt;GetPort(&amp;smtpPort);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-    aSmtpServer-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  aSmtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  aSmtpServer-&gt;GetUsername(smtpUserName);</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+  aSmtpServer-&gt;GetPort(&amp;smtpPort);</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+  aSmtpServer-&gt;GetSocketType(&amp;socketType);</span>
<a href="#l5.193"></a><span id="l5.193"> </span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    if (!smtpPort)</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-      smtpPort = (socketType == nsMsgSocketType::SSL) ?</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-        nsISmtpUrl::DEFAULT_SMTPS_PORT :  nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+  if (!smtpPort)</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+    smtpPort = (socketType == nsMsgSocketType::SSL)</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+                   ? nsISmtpUrl::DEFAULT_SMTPS_PORT</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+                   : nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l5.201"></a><span id="l5.201"> </span>
<a href="#l5.202"></a><span id="l5.202">   nsresult rv;</span>
<a href="#l5.203"></a><span id="l5.203">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_CreateInstance(kCSmtpUrlCID, &amp;rv));</span>
<a href="#l5.204"></a><span id="l5.204">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.205"></a><span id="l5.205"> </span>
<a href="#l5.206"></a><span id="l5.206">   nsAutoCString urlSpec(&quot;smtp://&quot;);</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  if (!smtpUserName.IsEmpty())</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-  {</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  if (!smtpUserName.IsEmpty()) {</span>
<a href="#l5.211"></a><span id="l5.211">     nsCString escapedUsername;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-    MsgEscapeString(smtpUserName, nsINetUtil::ESCAPE_XALPHAS,</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-                    escapedUsername);</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+    MsgEscapeString(smtpUserName, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l5.215"></a><span id="l5.215">     urlSpec.Append(escapedUsername);</span>
<a href="#l5.216"></a><span id="l5.216">     urlSpec.Append('@');</span>
<a href="#l5.217"></a><span id="l5.217">   }</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219">   urlSpec.Append(smtpHostName);</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-  if (smtpHostName.FindChar(':') == -1)</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-  {</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+  if (smtpHostName.FindChar(':') == -1) {</span>
<a href="#l5.223"></a><span id="l5.223">     urlSpec.Append(':');</span>
<a href="#l5.224"></a><span id="l5.224">     urlSpec.AppendInt(smtpPort);</span>
<a href="#l5.225"></a><span id="l5.225">   }</span>
<a href="#l5.226"></a><span id="l5.226"> </span>
<a href="#l5.227"></a><span id="l5.227">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(smtpUrl, &amp;rv));</span>
<a href="#l5.228"></a><span id="l5.228">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.229"></a><span id="l5.229"> </span>
<a href="#l5.230"></a><span id="l5.230">   rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineat">@@ -181,258 +160,241 @@ nsresult NS_MsgBuildSmtpUrl(nsIFile * aF</span>
<a href="#l5.232"></a><span id="l5.232">   smtpUrl-&gt;SetRequestDSN(aRequestDSN);</span>
<a href="#l5.233"></a><span id="l5.233">   smtpUrl-&gt;SetPostMessageFile(aFilePath);</span>
<a href="#l5.234"></a><span id="l5.234">   smtpUrl-&gt;SetSenderIdentity(aSenderIdentity);</span>
<a href="#l5.235"></a><span id="l5.235">   if (aNotificationCallbacks)</span>
<a href="#l5.236"></a><span id="l5.236">     smtpUrl-&gt;SetNotificationCallbacks(aNotificationCallbacks);</span>
<a href="#l5.237"></a><span id="l5.237">   smtpUrl-&gt;SetSmtpServer(aSmtpServer);</span>
<a href="#l5.238"></a><span id="l5.238"> </span>
<a href="#l5.239"></a><span id="l5.239">   nsCOMPtr&lt;nsIPrompt&gt; smtpPrompt(do_GetInterface(aNotificationCallbacks));</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-  nsCOMPtr&lt;nsIAuthPrompt&gt; smtpAuthPrompt(do_GetInterface(aNotificationCallbacks));</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-  if (!smtpPrompt || !smtpAuthPrompt)</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-  {</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+  nsCOMPtr&lt;nsIAuthPrompt&gt; smtpAuthPrompt(</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+      do_GetInterface(aNotificationCallbacks));</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+  if (!smtpPrompt || !smtpAuthPrompt) {</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l5.249"></a><span id="l5.249">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-    if (!smtpPrompt)</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-      wwatch-&gt;GetNewPrompter(0, getter_AddRefs(smtpPrompt));</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+    if (!smtpPrompt) wwatch-&gt;GetNewPrompter(0, getter_AddRefs(smtpPrompt));</span>
<a href="#l5.254"></a><span id="l5.254">     if (!smtpAuthPrompt)</span>
<a href="#l5.255"></a><span id="l5.255">       wwatch-&gt;GetNewAuthPrompter(0, getter_AddRefs(smtpAuthPrompt));</span>
<a href="#l5.256"></a><span id="l5.256">   }</span>
<a href="#l5.257"></a><span id="l5.257"> </span>
<a href="#l5.258"></a><span id="l5.258">   smtpUrl-&gt;SetPrompt(smtpPrompt);</span>
<a href="#l5.259"></a><span id="l5.259">   smtpUrl-&gt;SetAuthPrompt(smtpAuthPrompt);</span>
<a href="#l5.260"></a><span id="l5.260"> </span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-  if (aUrlListener)</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-    mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-  if (aStatusFeedback)</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-    mailnewsurl-&gt;SetStatusFeedback(aStatusFeedback);</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+  if (aUrlListener) mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+  if (aStatusFeedback) mailnewsurl-&gt;SetStatusFeedback(aStatusFeedback);</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268">   return CallQueryInterface(smtpUrl, aUrl);</span>
<a href="#l5.269"></a><span id="l5.269"> }</span>
<a href="#l5.270"></a><span id="l5.270"> </span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-nsresult NS_MsgLoadSmtpUrl(nsIURI * aUrl, nsISupports * aConsumer, nsIRequest ** aRequest)</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-{</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+nsresult NS_MsgLoadSmtpUrl(nsIURI *aUrl, nsISupports *aConsumer,</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+                           nsIRequest **aRequest) {</span>
<a href="#l5.275"></a><span id="l5.275">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277">   // For now, assume the url is an smtp url and load it.</span>
<a href="#l5.278"></a><span id="l5.278">   nsresult rv;</span>
<a href="#l5.279"></a><span id="l5.279">   nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(aUrl, &amp;rv));</span>
<a href="#l5.280"></a><span id="l5.280">   mozilla::Unused &lt;&lt; smtpUrl;</span>
<a href="#l5.281"></a><span id="l5.281">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.282"></a><span id="l5.282"> </span>
<a href="#l5.283"></a><span id="l5.283">   // Create a smtp protocol instance to run the url in.</span>
<a href="#l5.284"></a><span id="l5.284">   RefPtr&lt;nsSmtpProtocol&gt; smtpProtocol = new nsSmtpProtocol(aUrl);</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-  if (!smtpProtocol)</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+  if (!smtpProtocol) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.288"></a><span id="l5.288"> </span>
<a href="#l5.289"></a><span id="l5.289">   // Protocol will get destroyed when url is completed.</span>
<a href="#l5.290"></a><span id="l5.290">   rv = smtpProtocol-&gt;LoadUrl(aUrl, aConsumer);</span>
<a href="#l5.291"></a><span id="l5.291">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293">   smtpProtocol.forget(aRequest);</span>
<a href="#l5.294"></a><span id="l5.294">   return NS_OK;</span>
<a href="#l5.295"></a><span id="l5.295"> }</span>
<a href="#l5.296"></a><span id="l5.296"> </span>
<a href="#l5.297"></a><span id="l5.297"> NS_IMETHODIMP nsSmtpService::VerifyLogon(nsISmtpServer *aServer,</span>
<a href="#l5.298"></a><span id="l5.298">                                          nsIUrlListener *aUrlListener,</span>
<a href="#l5.299"></a><span id="l5.299">                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-                                         nsIURI **aURL)</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-{</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+                                         nsIURI **aURL) {</span>
<a href="#l5.303"></a><span id="l5.303">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l5.304"></a><span id="l5.304">   nsCString popHost;</span>
<a href="#l5.305"></a><span id="l5.305">   nsCString popUser;</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; urlToRun;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; urlToRun;</span>
<a href="#l5.308"></a><span id="l5.308"> </span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-  nsresult rv = NS_MsgBuildSmtpUrl(nullptr, aServer,</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-                          nullptr, nullptr, nullptr, aUrlListener, nullptr,</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-                          nullptr , getter_AddRefs(urlToRun), false);</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-  {</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+  nsresult rv = NS_MsgBuildSmtpUrl(nullptr, aServer, nullptr, nullptr, nullptr,</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+                                   aUrlListener, nullptr, nullptr,</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+                                   getter_AddRefs(urlToRun), false);</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun) {</span>
<a href="#l5.318"></a><span id="l5.318">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url(do_QueryInterface(urlToRun, &amp;rv));</span>
<a href="#l5.319"></a><span id="l5.319">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.320"></a><span id="l5.320">     url-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.321"></a><span id="l5.321">     rv = NS_MsgLoadSmtpUrl(urlToRun, nullptr, nullptr /* aRequest */);</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-    if (aURL)</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-      urlToRun.forget(aURL);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+    if (aURL) urlToRun.forget(aURL);</span>
<a href="#l5.325"></a><span id="l5.325">   }</span>
<a href="#l5.326"></a><span id="l5.326">   return rv;</span>
<a href="#l5.327"></a><span id="l5.327"> }</span>
<a href="#l5.328"></a><span id="l5.328"> </span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-NS_IMETHODIMP nsSmtpService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-{</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-    aScheme = &quot;mailto&quot;;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+NS_IMETHODIMP nsSmtpService::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+  aScheme = &quot;mailto&quot;;</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.336"></a><span id="l5.336"> }</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-NS_IMETHODIMP nsSmtpService::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-{</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-    if (aDefaultPort)</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-        *aDefaultPort = nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-    else</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-        rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-    return rv;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+NS_IMETHODIMP nsSmtpService::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+  if (aDefaultPort)</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+    *aDefaultPort = nsISmtpUrl::DEFAULT_SMTP_PORT;</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+  else</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+    rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+  return rv;</span>
<a href="#l5.353"></a><span id="l5.353"> }</span>
<a href="#l5.354"></a><span id="l5.354"> </span>
<a href="#l5.355"></a><span id="l5.355"> NS_IMETHODIMP</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-nsSmtpService::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-{</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-    // allow smtp to run on any port</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-    *_retval = true;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+nsSmtpService::AllowPort(int32_t port, const char *scheme, bool *_retval) {</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+  // allow smtp to run on any port</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+  *_retval = true;</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.365"></a><span id="l5.365"> }</span>
<a href="#l5.366"></a><span id="l5.366"> </span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-NS_IMETHODIMP nsSmtpService::GetProtocolFlags(uint32_t *result)</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-{</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-    *result = URI_NORELATIVE | ALLOWS_PROXY | URI_LOADABLE_BY_ANYONE |</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-      URI_NON_PERSISTABLE | URI_DOES_NOT_RETURN_DATA |</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-      URI_FORBIDS_COOKIE_ACCESS;</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+NS_IMETHODIMP nsSmtpService::GetProtocolFlags(uint32_t *result) {</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+  *result = URI_NORELATIVE | ALLOWS_PROXY | URI_LOADABLE_BY_ANYONE |</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+            URI_NON_PERSISTABLE | URI_DOES_NOT_RETURN_DATA |</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+            URI_FORBIDS_COOKIE_ACCESS;</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.378"></a><span id="l5.378"> }</span>
<a href="#l5.379"></a><span id="l5.379"> </span>
<a href="#l5.380"></a><span id="l5.380"> // the smtp service is also the protocol handler for mailto urls....</span>
<a href="#l5.381"></a><span id="l5.381"> </span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-NS_IMETHODIMP nsSmtpService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-                                    const char *aOriginCharset,  // ignored, always UTF-8.</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-                                    nsIURI *aBaseURI,</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-                                    nsIURI **_retval)</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-{</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+NS_IMETHODIMP nsSmtpService::NewURI(</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+    const nsACString &amp;aSpec,</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+    const char *aOriginCharset,  // ignored, always UTF-8.</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+    nsIURI *aBaseURI, nsIURI **_retval) {</span>
<a href="#l5.391"></a><span id="l5.391">   // get a new smtp url</span>
<a href="#l5.392"></a><span id="l5.392">   nsresult rv;</span>
<a href="#l5.393"></a><span id="l5.393"> </span>
<a href="#l5.394"></a><span id="l5.394">   nsCOMPtr&lt;nsIURI&gt; mailtoUrl;</span>
<a href="#l5.395"></a><span id="l5.395">   rv = NS_MutateURI(new nsMailtoUrl::Mutator())</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-         .SetSpec(aSpec)</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-         .Finalize(mailtoUrl);</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+           .SetSpec(aSpec)</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+           .Finalize(mailtoUrl);</span>
<a href="#l5.400"></a><span id="l5.400">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.401"></a><span id="l5.401"> </span>
<a href="#l5.402"></a><span id="l5.402">   mailtoUrl.forget(_retval);</span>
<a href="#l5.403"></a><span id="l5.403">   return NS_OK;</span>
<a href="#l5.404"></a><span id="l5.404"> }</span>
<a href="#l5.405"></a><span id="l5.405"> </span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-NS_IMETHODIMP nsSmtpService::NewChannel(nsIURI *aURI,</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-                                        nsILoadInfo* aLoadInfo,</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-                                        nsIChannel **_retval)</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-{</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+NS_IMETHODIMP nsSmtpService::NewChannel(nsIURI *aURI, nsILoadInfo *aLoadInfo,</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+                                        nsIChannel **_retval) {</span>
<a href="#l5.412"></a><span id="l5.412">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l5.413"></a><span id="l5.413">   // create an empty pipe for use with the input stream channel.</span>
<a href="#l5.414"></a><span id="l5.414">   nsCOMPtr&lt;nsIAsyncInputStream&gt; pipeIn;</span>
<a href="#l5.415"></a><span id="l5.415">   nsCOMPtr&lt;nsIAsyncOutputStream&gt; pipeOut;</span>
<a href="#l5.416"></a><span id="l5.416">   nsCOMPtr&lt;nsIPipe&gt; pipe = do_CreateInstance(&quot;@mozilla.org/pipe;1&quot;);</span>
<a href="#l5.417"></a><span id="l5.417">   nsresult rv = pipe-&gt;Init(false, false, 0, 0);</span>
<a href="#l5.418"></a><span id="l5.418">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.419"></a><span id="l5.419"> </span>
<a href="#l5.420"></a><span id="l5.420">   // These always succeed because the pipe is initialized above.</span>
<a href="#l5.421"></a><span id="l5.421">   MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetInputStream(getter_AddRefs(pipeIn)));</span>
<a href="#l5.422"></a><span id="l5.422">   MOZ_ALWAYS_SUCCEEDS(pipe-&gt;GetOutputStream(getter_AddRefs(pipeOut)));</span>
<a href="#l5.423"></a><span id="l5.423"> </span>
<a href="#l5.424"></a><span id="l5.424">   pipeOut-&gt;Close();</span>
<a href="#l5.425"></a><span id="l5.425"> </span>
<a href="#l5.426"></a><span id="l5.426">   if (aLoadInfo) {</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineminus">-    return NS_NewInputStreamChannelInternal(_retval,</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineminus">-                                            aURI,</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineminus">-                                            pipeIn.forget(),</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-                                            NS_LITERAL_CSTRING(&quot;application/x-mailto&quot;),</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-                                            EmptyCString(),</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-                                            aLoadInfo);</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+    return NS_NewInputStreamChannelInternal(</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+        _retval, aURI, pipeIn.forget(),</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+        NS_LITERAL_CSTRING(&quot;application/x-mailto&quot;), EmptyCString(), aLoadInfo);</span>
<a href="#l5.436"></a><span id="l5.436">   }</span>
<a href="#l5.437"></a><span id="l5.437"> </span>
<a href="#l5.438"></a><span id="l5.438">   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l5.441"></a><span id="l5.441">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed.&quot;);</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-    return rv;</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-  return NS_NewInputStreamChannel(_retval,</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-                                  aURI,</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-                                  pipeIn.forget(),</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-                                  nullPrincipal,</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-                                  nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-                                  nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;application/x-mailto&quot;));</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+  return NS_NewInputStreamChannel(</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+      _retval, aURI, pipeIn.forget(), nullPrincipal,</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+      nsIContentPolicy::TYPE_OTHER, NS_LITERAL_CSTRING(&quot;application/x-mailto&quot;));</span>
<a href="#l5.457"></a><span id="l5.457"> }</span>
<a href="#l5.458"></a><span id="l5.458"> </span>
<a href="#l5.459"></a><span id="l5.459"> NS_IMETHODIMP</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-nsSmtpService::GetServers(nsISimpleEnumerator **aResult)</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-{</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+nsSmtpService::GetServers(nsISimpleEnumerator **aResult) {</span>
<a href="#l5.463"></a><span id="l5.463">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.464"></a><span id="l5.464"> </span>
<a href="#l5.465"></a><span id="l5.465">   // now read in the servers from prefs if necessary</span>
<a href="#l5.466"></a><span id="l5.466">   uint32_t serverCount = mSmtpServers.Count();</span>
<a href="#l5.467"></a><span id="l5.467"> </span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-  if (serverCount &lt;= 0)</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-    loadSmtpServers();</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+  if (serverCount &lt;= 0) loadSmtpServers();</span>
<a href="#l5.471"></a><span id="l5.471"> </span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mSmtpServers, NS_GET_IID(nsISmtpServer));</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+  return NS_NewArrayEnumerator(aResult, mSmtpServers,</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+                               NS_GET_IID(nsISmtpServer));</span>
<a href="#l5.475"></a><span id="l5.475"> }</span>
<a href="#l5.476"></a><span id="l5.476"> </span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-nsresult</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-nsSmtpService::loadSmtpServers()</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-{</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-  if (mSmtpServersLoaded)</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+nsresult nsSmtpService::loadSmtpServers() {</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+  if (mSmtpServersLoaded) return NS_OK;</span>
<a href="#l5.484"></a><span id="l5.484"> </span>
<a href="#l5.485"></a><span id="l5.485">   nsresult rv;</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-    return rv;</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.492"></a><span id="l5.492">   nsCOMPtr&lt;nsIPrefBranch&gt; prefRootBranch;</span>
<a href="#l5.493"></a><span id="l5.493">   prefService-&gt;GetBranch(nullptr, getter_AddRefs(prefRootBranch));</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-    return rv;</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.497"></a><span id="l5.497"> </span>
<a href="#l5.498"></a><span id="l5.498">   nsCString serverList;</span>
<a href="#l5.499"></a><span id="l5.499">   rv = prefRootBranch-&gt;GetCharPref(PREF_MAIL_SMTPSERVERS, serverList);</span>
<a href="#l5.500"></a><span id="l5.500">   serverList.StripWhitespace();</span>
<a href="#l5.501"></a><span id="l5.501"> </span>
<a href="#l5.502"></a><span id="l5.502">   nsTArray&lt;nsCString&gt; servers;</span>
<a href="#l5.503"></a><span id="l5.503">   ParseString(serverList, SERVER_DELIMITER, servers);</span>
<a href="#l5.504"></a><span id="l5.504"> </span>
<a href="#l5.505"></a><span id="l5.505">   /**</span>
<a href="#l5.506"></a><span id="l5.506">    * Check to see if we need to add pre-configured smtp servers.</span>
<a href="#l5.507"></a><span id="l5.507">    * Following prefs are important to note in understanding the procedure here.</span>
<a href="#l5.508"></a><span id="l5.508">    *</span>
<a href="#l5.509"></a><span id="l5.509">    * 1. pref(&quot;mailnews.append_preconfig_smtpservers.version&quot;, version number);</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-   * This pref registers the current version in the user prefs file. A default value</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-   * is stored in mailnews.js file. If a given vendor needs to add more preconfigured</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-   * smtp servers, the default version number can be increased. Comparing version</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-   * number from user's prefs file and the default one from mailnews.js, we</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-   * can add new smtp servers and any other version level changes that need to be done.</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+   * This pref registers the current version in the user prefs file. A default</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+   * value is stored in mailnews.js file. If a given vendor needs to add more</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+   * preconfigured smtp servers, the default version number can be increased.</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+   * Comparing version number from user's prefs file and the default one from</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+   * mailnews.js, we can add new smtp servers and any other version level</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+   * changes that need to be done.</span>
<a href="#l5.521"></a><span id="l5.521">    *</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-   * 2. pref(&quot;mail.smtpservers.appendsmtpservers&quot;, &lt;comma separated servers list&gt;);</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-   * This pref contains the list of pre-configured smp servers that ISP/Vendor wants to</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-   * to add to the existing servers list.</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+   * 2. pref(&quot;mail.smtpservers.appendsmtpservers&quot;,</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+   *         &lt;comma separated servers list&gt;);</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+   * This pref contains the list of pre-configured smp servers that</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+   * ISP/Vendor wants to to add to the existing servers list.</span>
<a href="#l5.529"></a><span id="l5.529">    */</span>
<a href="#l5.530"></a><span id="l5.530">   nsCOMPtr&lt;nsIPrefBranch&gt; defaultsPrefBranch;</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-  rv = prefService-&gt;GetDefaultBranch(MAIL_ROOT_PREF, getter_AddRefs(defaultsPrefBranch));</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+  rv = prefService-&gt;GetDefaultBranch(MAIL_ROOT_PREF,</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+                                     getter_AddRefs(defaultsPrefBranch));</span>
<a href="#l5.534"></a><span id="l5.534">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.535"></a><span id="l5.535"> </span>
<a href="#l5.536"></a><span id="l5.536">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l5.537"></a><span id="l5.537">   rv = prefService-&gt;GetBranch(MAIL_ROOT_PREF, getter_AddRefs(prefBranch));</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.540"></a><span id="l5.540"> </span>
<a href="#l5.541"></a><span id="l5.541">   int32_t appendSmtpServersCurrentVersion = 0;</span>
<a href="#l5.542"></a><span id="l5.542">   int32_t appendSmtpServersDefaultVersion = 0;</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-  rv = prefBranch-&gt;GetIntPref(APPEND_SERVERS_VERSION_PREF_NAME, &amp;appendSmtpServersCurrentVersion);</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+  rv = prefBranch-&gt;GetIntPref(APPEND_SERVERS_VERSION_PREF_NAME,</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+                              &amp;appendSmtpServersCurrentVersion);</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.548"></a><span id="l5.548"> </span>
<a href="#l5.549"></a><span id="l5.549" class="difflineminus">-  rv = defaultsPrefBranch-&gt;GetIntPref(APPEND_SERVERS_VERSION_PREF_NAME, &amp;appendSmtpServersDefaultVersion);</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+  rv = defaultsPrefBranch-&gt;GetIntPref(APPEND_SERVERS_VERSION_PREF_NAME,</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+                                      &amp;appendSmtpServersDefaultVersion);</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.554"></a><span id="l5.554"> </span>
<a href="#l5.555"></a><span id="l5.555">   // Update the smtp server list if needed</span>
<a href="#l5.556"></a><span id="l5.556">   if (appendSmtpServersCurrentVersion &lt;= appendSmtpServersDefaultVersion) {</span>
<a href="#l5.557"></a><span id="l5.557">     // If there are pre-configured servers, add them to the existing server list</span>
<a href="#l5.558"></a><span id="l5.558">     nsCString appendServerList;</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineminus">-    rv = prefRootBranch-&gt;GetCharPref(PREF_MAIL_SMTPSERVERS_APPEND_SERVERS, appendServerList);</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+    rv = prefRootBranch-&gt;GetCharPref(PREF_MAIL_SMTPSERVERS_APPEND_SERVERS,</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+                                     appendServerList);</span>
<a href="#l5.562"></a><span id="l5.562">     appendServerList.StripWhitespace();</span>
<a href="#l5.563"></a><span id="l5.563">     ParseString(appendServerList, SERVER_DELIMITER, servers);</span>
<a href="#l5.564"></a><span id="l5.564"> </span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-    // Increase the version number so that updates will happen as and when needed</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineminus">-    prefBranch-&gt;SetIntPref(APPEND_SERVERS_VERSION_PREF_NAME, appendSmtpServersCurrentVersion + 1);</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+    // Increase the version number so that updates will happen as and when</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+    // needed</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+    prefBranch-&gt;SetIntPref(APPEND_SERVERS_VERSION_PREF_NAME,</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+                           appendSmtpServersCurrentVersion + 1);</span>
<a href="#l5.571"></a><span id="l5.571">   }</span>
<a href="#l5.572"></a><span id="l5.572"> </span>
<a href="#l5.573"></a><span id="l5.573">   // use GetServerByKey to check if the key (pref) is already in</span>
<a href="#l5.574"></a><span id="l5.574">   // in the list. If not it calls createKeyedServer directly.</span>
<a href="#l5.575"></a><span id="l5.575"> </span>
<a href="#l5.576"></a><span id="l5.576">   for (uint32_t i = 0; i &lt; servers.Length(); i++) {</span>
<a href="#l5.577"></a><span id="l5.577">     nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l5.578"></a><span id="l5.578">     GetServerByKey(servers[i].get(), getter_AddRefs(server));</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineat">@@ -440,324 +402,295 @@ nsSmtpService::loadSmtpServers()</span>
<a href="#l5.580"></a><span id="l5.580"> </span>
<a href="#l5.581"></a><span id="l5.581">   saveKeyList();</span>
<a href="#l5.582"></a><span id="l5.582"> </span>
<a href="#l5.583"></a><span id="l5.583">   mSmtpServersLoaded = true;</span>
<a href="#l5.584"></a><span id="l5.584">   return NS_OK;</span>
<a href="#l5.585"></a><span id="l5.585"> }</span>
<a href="#l5.586"></a><span id="l5.586"> </span>
<a href="#l5.587"></a><span id="l5.587"> // save the list of keys</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineminus">-nsresult</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineminus">-nsSmtpService::saveKeyList()</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineminus">-{</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+nsresult nsSmtpService::saveKeyList() {</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+  nsresult rv;</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.599"></a><span id="l5.599"> </span>
<a href="#l5.600"></a><span id="l5.600" class="difflineminus">-    return prefBranch-&gt;SetCharPref(PREF_MAIL_SMTPSERVERS, mServerKeyList);</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+  return prefBranch-&gt;SetCharPref(PREF_MAIL_SMTPSERVERS, mServerKeyList);</span>
<a href="#l5.602"></a><span id="l5.602"> }</span>
<a href="#l5.603"></a><span id="l5.603"> </span>
<a href="#l5.604"></a><span id="l5.604" class="difflineminus">-nsresult</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineminus">-nsSmtpService::createKeyedServer(const char *key, nsISmtpServer** aResult)</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineminus">-{</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineminus">-    if (!key) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+nsresult nsSmtpService::createKeyedServer(const char *key,</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+                                          nsISmtpServer **aResult) {</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+  if (!key) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.611"></a><span id="l5.611"> </span>
<a href="#l5.612"></a><span id="l5.612" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; server = do_CreateInstance(NS_SMTPSERVER_CONTRACTID, &amp;rv);</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-    server-&gt;SetKey(key);</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-    mSmtpServers.AppendObject(server);</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+  nsresult rv;</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; server =</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+      do_CreateInstance(NS_SMTPSERVER_CONTRACTID, &amp;rv);</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.622"></a><span id="l5.622"> </span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-    if (mServerKeyList.IsEmpty())</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-        mServerKeyList = key;</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-    else {</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-        mServerKeyList.Append(',');</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-        mServerKeyList += key;</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-    }</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+  server-&gt;SetKey(key);</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+  mSmtpServers.AppendObject(server);</span>
<a href="#l5.631"></a><span id="l5.631"> </span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-    if (aResult)</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineminus">-       server.forget(aResult);</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+  if (mServerKeyList.IsEmpty())</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+    mServerKeyList = key;</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+  else {</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+    mServerKeyList.Append(',');</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+    mServerKeyList += key;</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+  }</span>
<a href="#l5.640"></a><span id="l5.640"> </span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+  if (aResult) server.forget(aResult);</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.645"></a><span id="l5.645"> }</span>
<a href="#l5.646"></a><span id="l5.646"> </span>
<a href="#l5.647"></a><span id="l5.647"> NS_IMETHODIMP</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineminus">-nsSmtpService::GetSessionDefaultServer(nsISmtpServer **aServer)</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineminus">-{</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+nsSmtpService::GetSessionDefaultServer(nsISmtpServer **aServer) {</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l5.653"></a><span id="l5.653"> </span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-    if (!mSessionDefaultServer)</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-        return GetDefaultServer(aServer);</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+  if (!mSessionDefaultServer) return GetDefaultServer(aServer);</span>
<a href="#l5.657"></a><span id="l5.657"> </span>
<a href="#l5.658"></a><span id="l5.658" class="difflineminus">-    NS_ADDREF(*aServer = mSessionDefaultServer);</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+  NS_ADDREF(*aServer = mSessionDefaultServer);</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.662"></a><span id="l5.662"> }</span>
<a href="#l5.663"></a><span id="l5.663"> </span>
<a href="#l5.664"></a><span id="l5.664"> NS_IMETHODIMP</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-nsSmtpService::SetSessionDefaultServer(nsISmtpServer *aServer)</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineminus">-{</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineminus">-    mSessionDefaultServer = aServer;</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+nsSmtpService::SetSessionDefaultServer(nsISmtpServer *aServer) {</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+  mSessionDefaultServer = aServer;</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.672"></a><span id="l5.672"> }</span>
<a href="#l5.673"></a><span id="l5.673"> </span>
<a href="#l5.674"></a><span id="l5.674"> NS_IMETHODIMP</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineminus">-nsSmtpService::GetDefaultServer(nsISmtpServer **aServer)</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineminus">-{</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+nsSmtpService::GetDefaultServer(nsISmtpServer **aServer) {</span>
<a href="#l5.678"></a><span id="l5.678">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l5.679"></a><span id="l5.679"> </span>
<a href="#l5.680"></a><span id="l5.680">   loadSmtpServers();</span>
<a href="#l5.681"></a><span id="l5.681"> </span>
<a href="#l5.682"></a><span id="l5.682">   *aServer = nullptr;</span>
<a href="#l5.683"></a><span id="l5.683">   // always returns NS_OK, just leaving *aServer at nullptr</span>
<a href="#l5.684"></a><span id="l5.684">   if (!mDefaultSmtpServer) {</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineminus">-      nsresult rv;</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+    nsresult rv;</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l5.692"></a><span id="l5.692"> </span>
<a href="#l5.693"></a><span id="l5.693" class="difflineminus">-      // try to get it from the prefs</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineminus">-      nsCString defaultServerKey;</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineminus">-      rv = prefBranch-&gt;GetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, defaultServerKey);</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineminus">-          !defaultServerKey.IsEmpty()) {</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineminus">-</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineminus">-          nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineminus">-          rv = GetServerByKey(defaultServerKey.get(),</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineminus">-                              getter_AddRefs(mDefaultSmtpServer));</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineminus">-      } else {</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineminus">-        // no pref set, so just return the first one, and set the pref</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+    // try to get it from the prefs</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+    nsCString defaultServerKey;</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+    rv =</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+        prefBranch-&gt;GetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, defaultServerKey);</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !defaultServerKey.IsEmpty()) {</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+      nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+      rv = GetServerByKey(defaultServerKey.get(),</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+                          getter_AddRefs(mDefaultSmtpServer));</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+    } else {</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+      // no pref set, so just return the first one, and set the pref</span>
<a href="#l5.714"></a><span id="l5.714"> </span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-        // Ensure the list of servers is loaded</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineminus">-        loadSmtpServers();</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+      // Ensure the list of servers is loaded</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+      loadSmtpServers();</span>
<a href="#l5.719"></a><span id="l5.719"> </span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-        // nothing in the array, we had better create a new server</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineminus">-        // (which will add it to the array &amp; prefs anyway)</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineminus">-        if (mSmtpServers.Count() == 0)</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineminus">-          // if there are no smtp servers then don't create one for the default.</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-          return NS_OK;</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+      // nothing in the array, we had better create a new server</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+      // (which will add it to the array &amp; prefs anyway)</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+      if (mSmtpServers.Count() == 0)</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+        // if there are no smtp servers then don't create one for the default.</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+        return NS_OK;</span>
<a href="#l5.730"></a><span id="l5.730"> </span>
<a href="#l5.731"></a><span id="l5.731" class="difflineminus">-        mDefaultSmtpServer = mSmtpServers[0];</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineminus">-        NS_ENSURE_TRUE(mDefaultSmtpServer, NS_ERROR_NULL_POINTER);</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+      mDefaultSmtpServer = mSmtpServers[0];</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+      NS_ENSURE_TRUE(mDefaultSmtpServer, NS_ERROR_NULL_POINTER);</span>
<a href="#l5.735"></a><span id="l5.735"> </span>
<a href="#l5.736"></a><span id="l5.736" class="difflineminus">-        // now we have a default server, set the prefs correctly</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineminus">-        nsCString serverKey;</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineminus">-        mDefaultSmtpServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineminus">-          prefBranch-&gt;SetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, serverKey);</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineminus">-      }</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+      // now we have a default server, set the prefs correctly</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+      nsCString serverKey;</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+      mDefaultSmtpServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+        prefBranch-&gt;SetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, serverKey);</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+    }</span>
<a href="#l5.748"></a><span id="l5.748">   }</span>
<a href="#l5.749"></a><span id="l5.749"> </span>
<a href="#l5.750"></a><span id="l5.750">   // at this point:</span>
<a href="#l5.751"></a><span id="l5.751">   // * mDefaultSmtpServer has a valid server</span>
<a href="#l5.752"></a><span id="l5.752">   // * the key has been set in the prefs</span>
<a href="#l5.753"></a><span id="l5.753"> </span>
<a href="#l5.754"></a><span id="l5.754">   NS_IF_ADDREF(*aServer = mDefaultSmtpServer);</span>
<a href="#l5.755"></a><span id="l5.755"> </span>
<a href="#l5.756"></a><span id="l5.756">   return NS_OK;</span>
<a href="#l5.757"></a><span id="l5.757"> }</span>
<a href="#l5.758"></a><span id="l5.758"> </span>
<a href="#l5.759"></a><span id="l5.759"> NS_IMETHODIMP</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineminus">-nsSmtpService::SetDefaultServer(nsISmtpServer *aServer)</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineminus">-{</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+nsSmtpService::SetDefaultServer(nsISmtpServer *aServer) {</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l5.765"></a><span id="l5.765"> </span>
<a href="#l5.766"></a><span id="l5.766" class="difflineminus">-    mDefaultSmtpServer = aServer;</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+  mDefaultSmtpServer = aServer;</span>
<a href="#l5.768"></a><span id="l5.768"> </span>
<a href="#l5.769"></a><span id="l5.769" class="difflineminus">-    nsCString serverKey;</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineminus">-    nsresult rv = aServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+  nsCString serverKey;</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+  nsresult rv = aServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.775"></a><span id="l5.775"> </span>
<a href="#l5.776"></a><span id="l5.776" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineminus">-    prefBranch-&gt;SetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, serverKey);</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+  prefBranch-&gt;SetCharPref(PREF_MAIL_SMTP_DEFAULTSERVER, serverKey);</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.785"></a><span id="l5.785"> }</span>
<a href="#l5.786"></a><span id="l5.786"> </span>
<a href="#l5.787"></a><span id="l5.787" class="difflineminus">-bool</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineminus">-nsSmtpService::findServerByKey(nsISmtpServer *aServer, void *aData)</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineminus">-{</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineminus">-  findServerByKeyEntry *entry = (findServerByKeyEntry*) aData;</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+bool nsSmtpService::findServerByKey(nsISmtpServer *aServer, void *aData) {</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+  findServerByKeyEntry *entry = (findServerByKeyEntry *)aData;</span>
<a href="#l5.793"></a><span id="l5.793"> </span>
<a href="#l5.794"></a><span id="l5.794">   nsCString key;</span>
<a href="#l5.795"></a><span id="l5.795">   nsresult rv = aServer-&gt;GetKey(getter_Copies(key));</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineminus">-    return true;</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+  if (NS_FAILED(rv)) return true;</span>
<a href="#l5.799"></a><span id="l5.799"> </span>
<a href="#l5.800"></a><span id="l5.800" class="difflineminus">-  if (key.Equals(entry-&gt;key))</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineminus">-  {</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+  if (key.Equals(entry-&gt;key)) {</span>
<a href="#l5.803"></a><span id="l5.803">     entry-&gt;server = aServer;</span>
<a href="#l5.804"></a><span id="l5.804">     return false;</span>
<a href="#l5.805"></a><span id="l5.805">   }</span>
<a href="#l5.806"></a><span id="l5.806"> </span>
<a href="#l5.807"></a><span id="l5.807">   return true;</span>
<a href="#l5.808"></a><span id="l5.808"> }</span>
<a href="#l5.809"></a><span id="l5.809"> </span>
<a href="#l5.810"></a><span id="l5.810"> NS_IMETHODIMP</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineminus">-nsSmtpService::CreateServer(nsISmtpServer **aResult)</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineminus">-{</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineminus">-    if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+nsSmtpService::CreateServer(nsISmtpServer **aResult) {</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+  if (!aResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.816"></a><span id="l5.816"> </span>
<a href="#l5.817"></a><span id="l5.817" class="difflineminus">-    loadSmtpServers();</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineminus">-    int32_t i = 0;</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineminus">-    bool unique = false;</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+  loadSmtpServers();</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+  nsresult rv;</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+  int32_t i = 0;</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineplus">+  bool unique = false;</span>
<a href="#l5.825"></a><span id="l5.825"> </span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-    findServerByKeyEntry entry;</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-    nsAutoCString key;</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+  findServerByKeyEntry entry;</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+  nsAutoCString key;</span>
<a href="#l5.830"></a><span id="l5.830"> </span>
<a href="#l5.831"></a><span id="l5.831" class="difflineminus">-    do {</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineminus">-        key = &quot;smtp&quot;;</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineminus">-        key.AppendInt(++i);</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-        entry.key = key.get();</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineminus">-        entry.server = nullptr;</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+  do {</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+    key = &quot;smtp&quot;;</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+    key.AppendInt(++i);</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+    entry.key = key.get();</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+    entry.server = nullptr;</span>
<a href="#l5.841"></a><span id="l5.841"> </span>
<a href="#l5.842"></a><span id="l5.842" class="difflineminus">-        for (nsISmtpServer* s : mSmtpServers)</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-          findServerByKey(s, (void *)&amp;entry);</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineminus">-        if (!entry.server) unique=true;</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+    for (nsISmtpServer *s : mSmtpServers) findServerByKey(s, (void *)&amp;entry);</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+    if (!entry.server) unique = true;</span>
<a href="#l5.847"></a><span id="l5.847"> </span>
<a href="#l5.848"></a><span id="l5.848" class="difflineminus">-    } while (!unique);</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+  } while (!unique);</span>
<a href="#l5.850"></a><span id="l5.850"> </span>
<a href="#l5.851"></a><span id="l5.851" class="difflineminus">-    rv = createKeyedServer(key.get(), aResult);</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-    return saveKeyList();</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+  rv = createKeyedServer(key.get(), aResult);</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineplus">+  return saveKeyList();</span>
<a href="#l5.857"></a><span id="l5.857"> }</span>
<a href="#l5.858"></a><span id="l5.858"> </span>
<a href="#l5.859"></a><span id="l5.859" class="difflineminus">-</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-nsresult</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineminus">-nsSmtpService::GetServerByKey(const char* aKey, nsISmtpServer **aResult)</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineminus">-{</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+nsresult nsSmtpService::GetServerByKey(const char *aKey,</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineplus">+                                       nsISmtpServer **aResult) {</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.867"></a><span id="l5.867"> </span>
<a href="#l5.868"></a><span id="l5.868" class="difflineminus">-    if (!aKey || !*aKey)</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineminus">-    {</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineminus">-      NS_ASSERTION(false, &quot;bad key&quot;);</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineminus">-    }</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineminus">-    findServerByKeyEntry entry;</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineminus">-    entry.key = aKey;</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineminus">-    entry.server = nullptr;</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineminus">-    for (nsISmtpServer* s : mSmtpServers)</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineminus">-      findServerByKey(s, (void *)&amp;entry);</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+  if (!aKey || !*aKey) {</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineplus">+    NS_ASSERTION(false, &quot;bad key&quot;);</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineplus">+  }</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineplus">+  findServerByKeyEntry entry;</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+  entry.key = aKey;</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineplus">+  entry.server = nullptr;</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineplus">+  for (nsISmtpServer *s : mSmtpServers) findServerByKey(s, (void *)&amp;entry);</span>
<a href="#l5.886"></a><span id="l5.886"> </span>
<a href="#l5.887"></a><span id="l5.887" class="difflineminus">-    if (entry.server) {</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineminus">-        NS_ADDREF(*aResult = entry.server);</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineminus">-        return NS_OK;</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineminus">-    }</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+  if (entry.server) {</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+    NS_ADDREF(*aResult = entry.server);</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineplus">+  }</span>
<a href="#l5.895"></a><span id="l5.895"> </span>
<a href="#l5.896"></a><span id="l5.896" class="difflineminus">-    // not found in array, I guess we load it</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineminus">-    return createKeyedServer(aKey, aResult);</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+  // not found in array, I guess we load it</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+  return createKeyedServer(aKey, aResult);</span>
<a href="#l5.900"></a><span id="l5.900"> }</span>
<a href="#l5.901"></a><span id="l5.901"> </span>
<a href="#l5.902"></a><span id="l5.902"> NS_IMETHODIMP</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineminus">-nsSmtpService::DeleteServer(nsISmtpServer *aServer)</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineminus">-{</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineminus">-    if (!aServer) return NS_OK;</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+nsSmtpService::DeleteServer(nsISmtpServer *aServer) {</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+  if (!aServer) return NS_OK;</span>
<a href="#l5.908"></a><span id="l5.908"> </span>
<a href="#l5.909"></a><span id="l5.909" class="difflineminus">-    int32_t idx = mSmtpServers.IndexOf(aServer);</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineminus">-    if (idx == -1)</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineminus">-      return NS_OK;</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+  int32_t idx = mSmtpServers.IndexOf(aServer);</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+  if (idx == -1) return NS_OK;</span>
<a href="#l5.914"></a><span id="l5.914"> </span>
<a href="#l5.915"></a><span id="l5.915" class="difflineminus">-    nsCString serverKey;</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineminus">-    aServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-    mSmtpServers.RemoveObjectAt(idx);</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineplus">+  nsCString serverKey;</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+  aServer-&gt;GetKey(getter_Copies(serverKey));</span>
<a href="#l5.921"></a><span id="l5.921"> </span>
<a href="#l5.922"></a><span id="l5.922" class="difflineminus">-    if (mDefaultSmtpServer.get() == aServer)</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineminus">-        mDefaultSmtpServer = nullptr;</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineminus">-    if (mSessionDefaultServer.get() == aServer)</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineminus">-        mSessionDefaultServer = nullptr;</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineplus">+  mSmtpServers.RemoveObjectAt(idx);</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineplus">+  if (mDefaultSmtpServer.get() == aServer) mDefaultSmtpServer = nullptr;</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineplus">+  if (mSessionDefaultServer.get() == aServer) mSessionDefaultServer = nullptr;</span>
<a href="#l5.930"></a><span id="l5.930"> </span>
<a href="#l5.931"></a><span id="l5.931" class="difflineminus">-    nsAutoCString newServerList;</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineminus">-    nsCString tmpStr = mServerKeyList;</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineminus">-    char *newStr = tmpStr.BeginWriting();</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineminus">-    char *token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineminus">-    while (token) {</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineminus">-      // only re-add the string if it's not the key</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineminus">-      if (strcmp(token, serverKey.get()) != 0) {</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineminus">-          if (newServerList.IsEmpty())</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineminus">-              newServerList = token;</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineminus">-          else {</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineminus">-            newServerList += ',';</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineminus">-            newServerList += token;</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineminus">-          }</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+  nsAutoCString newServerList;</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineplus">+  nsCString tmpStr = mServerKeyList;</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+  char *newStr = tmpStr.BeginWriting();</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineplus">+  char *token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineplus">+  while (token) {</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+    // only re-add the string if it's not the key</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+    if (strcmp(token, serverKey.get()) != 0) {</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineplus">+      if (newServerList.IsEmpty())</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+        newServerList = token;</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineplus">+      else {</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineplus">+        newServerList += ',';</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineplus">+        newServerList += token;</span>
<a href="#l5.956"></a><span id="l5.956">       }</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-      token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l5.958"></a><span id="l5.958">     }</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+    token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+  }</span>
<a href="#l5.961"></a><span id="l5.961"> </span>
<a href="#l5.962"></a><span id="l5.962" class="difflineminus">-    // make sure the server clears out it's values....</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineminus">-    aServer-&gt;ClearAllValues();</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineplus">+  // make sure the server clears out it's values....</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineplus">+  aServer-&gt;ClearAllValues();</span>
<a href="#l5.966"></a><span id="l5.966"> </span>
<a href="#l5.967"></a><span id="l5.967" class="difflineminus">-    mServerKeyList = newServerList;</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineminus">-    saveKeyList();</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineplus">+  mServerKeyList = newServerList;</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+  saveKeyList();</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.973"></a><span id="l5.973"> }</span>
<a href="#l5.974"></a><span id="l5.974"> </span>
<a href="#l5.975"></a><span id="l5.975" class="difflineminus">-bool</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-nsSmtpService::findServerByHostname(nsISmtpServer *aServer, void *aData)</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineminus">-{</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineminus">-  findServerByHostnameEntry *entry = (findServerByHostnameEntry*)aData;</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+bool nsSmtpService::findServerByHostname(nsISmtpServer *aServer, void *aData) {</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineplus">+  findServerByHostnameEntry *entry = (findServerByHostnameEntry *)aData;</span>
<a href="#l5.981"></a><span id="l5.981"> </span>
<a href="#l5.982"></a><span id="l5.982">   nsCString hostname;</span>
<a href="#l5.983"></a><span id="l5.983">   nsresult rv = aServer-&gt;GetHostname(hostname);</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineminus">-    return true;</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineplus">+  if (NS_FAILED(rv)) return true;</span>
<a href="#l5.987"></a><span id="l5.987"> </span>
<a href="#l5.988"></a><span id="l5.988">   nsCString username;</span>
<a href="#l5.989"></a><span id="l5.989">   rv = aServer-&gt;GetUsername(username);</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineminus">-    return true;</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineplus">+  if (NS_FAILED(rv)) return true;</span>
<a href="#l5.993"></a><span id="l5.993"> </span>
<a href="#l5.994"></a><span id="l5.994">   bool checkHostname = !entry-&gt;hostname.IsEmpty();</span>
<a href="#l5.995"></a><span id="l5.995">   bool checkUsername = !entry-&gt;username.IsEmpty();</span>
<a href="#l5.996"></a><span id="l5.996"> </span>
<a href="#l5.997"></a><span id="l5.997">   if ((!checkHostname ||</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineminus">-       (entry-&gt;hostname.Equals(hostname, nsCaseInsensitiveCStringComparator()))) &amp;&amp;</span>
<a href="#l5.999"></a><span id="l5.999" class="difflineminus">-       (!checkUsername ||</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineminus">-        entry-&gt;username.Equals(username, nsCaseInsensitiveCStringComparator())))</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineminus">-  {</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineplus">+       (entry-&gt;hostname.Equals(hostname,</span>
<a href="#l5.1003"></a><span id="l5.1003" class="difflineplus">+                               nsCaseInsensitiveCStringComparator()))) &amp;&amp;</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineplus">+      (!checkUsername || entry-&gt;username.Equals(</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineplus">+                             username, nsCaseInsensitiveCStringComparator()))) {</span>
<a href="#l5.1006"></a><span id="l5.1006">     entry-&gt;server = aServer;</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineminus">-    return false;        // stop when found</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineplus">+    return false;  // stop when found</span>
<a href="#l5.1009"></a><span id="l5.1009">   }</span>
<a href="#l5.1010"></a><span id="l5.1010">   return true;</span>
<a href="#l5.1011"></a><span id="l5.1011"> }</span>
<a href="#l5.1012"></a><span id="l5.1012"> </span>
<a href="#l5.1013"></a><span id="l5.1013"> NS_IMETHODIMP</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineminus">-nsSmtpService::FindServer(const char *aUsername,</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineminus">-                          const char *aHostname, nsISmtpServer ** aResult)</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineminus">-{</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineplus">+nsSmtpService::FindServer(const char *aUsername, const char *aHostname,</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+                          nsISmtpServer **aResult) {</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.1021"></a><span id="l5.1021"> </span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineminus">-    findServerByHostnameEntry entry;</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineminus">-    entry.server = nullptr;</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineminus">-    entry.hostname = aHostname;</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineminus">-    entry.username = aUsername;</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineplus">+  findServerByHostnameEntry entry;</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineplus">+  entry.server = nullptr;</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineplus">+  entry.hostname = aHostname;</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineplus">+  entry.username = aUsername;</span>
<a href="#l5.1030"></a><span id="l5.1030"> </span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineminus">-    for (nsISmtpServer* s : mSmtpServers)</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineminus">-      findServerByHostname(s, (void *)&amp;entry);</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineplus">+  for (nsISmtpServer *s : mSmtpServers) findServerByHostname(s, (void *)&amp;entry);</span>
<a href="#l5.1034"></a><span id="l5.1034"> </span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineminus">-    // entry.server may be null, but that's ok.</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineminus">-    // just return null if no server is found</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineminus">-    NS_IF_ADDREF(*aResult = entry.server);</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineplus">+  // entry.server may be null, but that's ok.</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+  // just return null if no server is found</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+  NS_IF_ADDREF(*aResult = entry.server);</span>
<a href="#l5.1041"></a><span id="l5.1041"> </span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.1044"></a><span id="l5.1044"> }</span>
<a href="#l5.1045"></a><span id="l5.1045"> </span>
<a href="#l5.1046"></a><span id="l5.1046"> NS_IMETHODIMP</span>
<a href="#l5.1047"></a><span id="l5.1047"> nsSmtpService::GetServerByIdentity(nsIMsgIdentity *aSenderIdentity,</span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineminus">-                                   nsISmtpServer **aSmtpServer)</span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineminus">-{</span>
<a href="#l5.1050"></a><span id="l5.1050" class="difflineplus">+                                   nsISmtpServer **aSmtpServer) {</span>
<a href="#l5.1051"></a><span id="l5.1051">   NS_ENSURE_ARG_POINTER(aSmtpServer);</span>
<a href="#l5.1052"></a><span id="l5.1052">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l5.1053"></a><span id="l5.1053"> </span>
<a href="#l5.1054"></a><span id="l5.1054">   // First try the identity's preferred server</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineminus">-  if (aSenderIdentity)</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineminus">-  {</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineminus">-      nsCString smtpServerKey;</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineminus">-      rv = aSenderIdentity-&gt;GetSmtpServerKey(smtpServerKey);</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !(smtpServerKey.IsEmpty()))</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineminus">-          rv = GetServerByKey(smtpServerKey.get(), aSmtpServer);</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineplus">+  if (aSenderIdentity) {</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineplus">+    nsCString smtpServerKey;</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineplus">+    rv = aSenderIdentity-&gt;GetSmtpServerKey(smtpServerKey);</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !(smtpServerKey.IsEmpty()))</span>
<a href="#l5.1065"></a><span id="l5.1065" class="difflineplus">+      rv = GetServerByKey(smtpServerKey.get(), aSmtpServer);</span>
<a href="#l5.1066"></a><span id="l5.1066">   }</span>
<a href="#l5.1067"></a><span id="l5.1067"> </span>
<a href="#l5.1068"></a><span id="l5.1068">   // Fallback to the default</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineminus">-  if (NS_FAILED(rv) || !(*aSmtpServer))</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineminus">-      rv = GetDefaultServer(aSmtpServer);</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineplus">+  if (NS_FAILED(rv) || !(*aSmtpServer)) rv = GetDefaultServer(aSmtpServer);</span>
<a href="#l5.1072"></a><span id="l5.1072">   return rv;</span>
<a href="#l5.1073"></a><span id="l5.1073"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -9,55 +9,52 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nscore.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsISmtpService.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-// The Smtp Service is an interfaced designed to make building and running mail to urls</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-// easier. I'm not sure if this service will go away when the new networking model comes</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-// on line (as part of the N2 project). So I reserve the right to change my mind and take</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-// this service away =).</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+// The Smtp Service is an interfaced designed to make building and running mail</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+// to urls easier. I'm not sure if this service will go away when the new</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+// networking model comes on line (as part of the N2 project). So I reserve the</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+// right to change my mind and take this service away =).</span>
<a href="#l6.20"></a><span id="l6.20"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-class nsSmtpService : public nsISmtpService, public nsIProtocolHandler</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-{</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-public:</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+class nsSmtpService : public nsISmtpService, public nsIProtocolHandler {</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+ public:</span>
<a href="#l6.28"></a><span id="l6.28">   nsSmtpService();</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">   NS_DECL_ISUPPORTS</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   ////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.33"></a><span id="l6.33">   // we support the nsISmtpService interface</span>
<a href="#l6.34"></a><span id="l6.34">   ////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.35"></a><span id="l6.35">   NS_DECL_NSISMTPSERVICE</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">   //////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.38"></a><span id="l6.38">   // we support the nsIProtocolHandler interface</span>
<a href="#l6.39"></a><span id="l6.39">   //////////////////////////////////////////////////////////////////////////</span>
<a href="#l6.40"></a><span id="l6.40">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-protected:</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    nsresult loadSmtpServers();</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+ protected:</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+  nsresult loadSmtpServers();</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-private:</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+ private:</span>
<a href="#l6.50"></a><span id="l6.50">   virtual ~nsSmtpService();</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    static bool findServerByKey(nsISmtpServer *aServer, void *aData);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    static bool findServerByHostname(nsISmtpServer *aServer, void *aData);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  static bool findServerByKey(nsISmtpServer *aServer, void *aData);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+  static bool findServerByHostname(nsISmtpServer *aServer, void *aData);</span>
<a href="#l6.55"></a><span id="l6.55"> </span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    nsresult createKeyedServer(const char* key,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-                               nsISmtpServer **aResult = nullptr);</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    nsresult saveKeyList();</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+  nsresult createKeyedServer(const char *key,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+                             nsISmtpServer **aResult = nullptr);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+  nsresult saveKeyList();</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-    nsCOMArray&lt;nsISmtpServer&gt; mSmtpServers;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; mDefaultSmtpServer;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    nsCOMPtr&lt;nsISmtpServer&gt; mSessionDefaultServer;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  nsCOMArray&lt;nsISmtpServer&gt; mSmtpServers;</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; mDefaultSmtpServer;</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  nsCOMPtr&lt;nsISmtpServer&gt; mSessionDefaultServer;</span>
<a href="#l6.69"></a><span id="l6.69"> </span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-    nsCString mServerKeyList;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  nsCString mServerKeyList;</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-    bool mSmtpServersLoaded;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  bool mSmtpServersLoaded;</span>
<a href="#l6.75"></a><span id="l6.75"> };</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77"> #endif /* nsSmtpService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -16,45 +16,36 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsCRT.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.10"></a><span id="l7.10"> // mailto url definition</span>
<a href="#l7.11"></a><span id="l7.11"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-nsMailtoUrl::nsMailtoUrl()</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  mFormat = nsIMsgCompFormat::Default;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-}</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+nsMailtoUrl::nsMailtoUrl() { mFormat = nsIMsgCompFormat::Default; }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-nsMailtoUrl::~nsMailtoUrl()</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-{</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-}</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+nsMailtoUrl::~nsMailtoUrl() {}</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> NS_IMPL_ISUPPORTS(nsMailtoUrl, nsIMailtoUrl, nsIURI)</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> static void UnescapeAndConvert(nsIMimeConverter *mimeConverter,</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-                               const nsACString &amp;escaped, nsACString &amp;out)</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-{</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+                               const nsACString &amp;escaped, nsACString &amp;out) {</span>
<a href="#l7.29"></a><span id="l7.29">   NS_ASSERTION(mimeConverter, &quot;Set mimeConverter before calling!&quot;);</span>
<a href="#l7.30"></a><span id="l7.30">   // If the string is empty, do absolutely nothing.</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  if (escaped.IsEmpty())</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    return;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  if (escaped.IsEmpty()) return;</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   MsgUnescapeString(escaped, 0, out);</span>
<a href="#l7.36"></a><span id="l7.36">   nsAutoCString decodedString;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  nsresult rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(out, &quot;UTF_8&quot;, false,</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-    true, decodedString);</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !decodedString.IsEmpty())</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    out = decodedString;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+  nsresult rv = mimeConverter-&gt;DecodeMimeHeaderToUTF8(out, &quot;UTF_8&quot;, false, true,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+                                                      decodedString);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !decodedString.IsEmpty()) out = decodedString;</span>
<a href="#l7.44"></a><span id="l7.44"> }</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-nsresult nsMailtoUrl::ParseMailtoUrl(char * searchPart)</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-{</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+nsresult nsMailtoUrl::ParseMailtoUrl(char *searchPart) {</span>
<a href="#l7.49"></a><span id="l7.49">   char *rest = searchPart;</span>
<a href="#l7.50"></a><span id="l7.50">   nsCString escapedInReplyToPart;</span>
<a href="#l7.51"></a><span id="l7.51">   nsCString escapedToPart;</span>
<a href="#l7.52"></a><span id="l7.52">   nsCString escapedCcPart;</span>
<a href="#l7.53"></a><span id="l7.53">   nsCString escapedSubjectPart;</span>
<a href="#l7.54"></a><span id="l7.54">   nsCString escapedNewsgroupPart;</span>
<a href="#l7.55"></a><span id="l7.55">   nsCString escapedNewsHostPart;</span>
<a href="#l7.56"></a><span id="l7.56">   nsCString escapedReferencePart;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineat">@@ -68,773 +59,669 @@ nsresult nsMailtoUrl::ParseMailtoUrl(cha</span>
<a href="#l7.58"></a><span id="l7.58">   nsCString escapedPriorityPart;</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">   // okay, first, free up all of our old search part state.....</span>
<a href="#l7.61"></a><span id="l7.61">   CleanupMailtoState();</span>
<a href="#l7.62"></a><span id="l7.62">   // m_toPart has the escaped address from before the query string, copy it</span>
<a href="#l7.63"></a><span id="l7.63">   // over so we can add on any additional to= addresses and unescape them all.</span>
<a href="#l7.64"></a><span id="l7.64">   escapedToPart = m_toPart;</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  if (rest &amp;&amp; *rest == '?')</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  {</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  if (rest &amp;&amp; *rest == '?') {</span>
<a href="#l7.69"></a><span id="l7.69">     /* start past the '?' */</span>
<a href="#l7.70"></a><span id="l7.70">     rest++;</span>
<a href="#l7.71"></a><span id="l7.71">   }</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-  if (rest)</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  {</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  if (rest) {</span>
<a href="#l7.76"></a><span id="l7.76">     char *token = NS_strtok(&quot;&amp;&quot;, &amp;rest);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    while (token &amp;&amp; *token)</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+    while (token &amp;&amp; *token) {</span>
<a href="#l7.80"></a><span id="l7.80">       char *value = 0;</span>
<a href="#l7.81"></a><span id="l7.81">       char *eq = PL_strchr(token, '=');</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-      if (eq)</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-      {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-        value = eq+1;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+      if (eq) {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+        value = eq + 1;</span>
<a href="#l7.87"></a><span id="l7.87">         *eq = 0;</span>
<a href="#l7.88"></a><span id="l7.88">       }</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90">       nsCString decodedName;</span>
<a href="#l7.91"></a><span id="l7.91">       MsgUnescapeString(nsDependentCString(token), 0, decodedName);</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-      if (decodedName.IsEmpty())</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-        break;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+      if (decodedName.IsEmpty()) break;</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-      switch (NS_ToUpper(decodedName.First()))</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-      {</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-        /* DO NOT support attachment= in mailto urls. This poses a security fire hole!!!</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-                          case 'A':</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-                          if (!PL_strcasecmp (token, &quot;attachment&quot;))</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-                          m_attachmentPart = value;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-                          break;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-                     */</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-      case 'B':</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;bcc&quot;))</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-        {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-          if (!escapedBccPart.IsEmpty())</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-          {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-            escapedBccPart += &quot;, &quot;;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-            escapedBccPart += value;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+      switch (NS_ToUpper(decodedName.First())) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+          /* DO NOT support attachment= in mailto urls. This poses a security</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+             fire hole!!! case 'A': if (!PL_strcasecmp (token, &quot;attachment&quot;))</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+                            m_attachmentPart = value;</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+                            break;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+                       */</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+        case 'B':</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;bcc&quot;)) {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+            if (!escapedBccPart.IsEmpty()) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+              escapedBccPart += &quot;, &quot;;</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+              escapedBccPart += value;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+            } else</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+              escapedBccPart = value;</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+          } else if (decodedName.LowerCaseEqualsLiteral(&quot;body&quot;)) {</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+            if (!escapedBodyPart.IsEmpty()) {</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+              escapedBodyPart += &quot;\n&quot;;</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+              escapedBodyPart += value;</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+            } else</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+              escapedBodyPart = value;</span>
<a href="#l7.131"></a><span id="l7.131">           }</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-          else</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-            escapedBccPart = value;</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-        }</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-        else if (decodedName.LowerCaseEqualsLiteral(&quot;body&quot;))</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-        {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-          if (!escapedBodyPart.IsEmpty())</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-          {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-            escapedBodyPart +=&quot;\n&quot;;</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-            escapedBodyPart += value;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+          break;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+        case 'C':</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;cc&quot;)) {</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+            if (!escapedCcPart.IsEmpty()) {</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+              escapedCcPart += &quot;, &quot;;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+              escapedCcPart += value;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+            } else</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+              escapedCcPart = value;</span>
<a href="#l7.149"></a><span id="l7.149">           }</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-          else</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-            escapedBodyPart = value;</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-        }</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-        break;</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-      case 'C':</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;cc&quot;))</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-        {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-          if (!escapedCcPart.IsEmpty())</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-          {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-            escapedCcPart += &quot;, &quot;;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-            escapedCcPart += value;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+          break;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+        case 'F':</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;followup-to&quot;))</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+            escapedFollowUpToPart = value;</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+          else if (decodedName.LowerCaseEqualsLiteral(&quot;from&quot;))</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+            escapedFromPart = value;</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+          break;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+        case 'H':</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;html-part&quot;) ||</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+              decodedName.LowerCaseEqualsLiteral(&quot;html-body&quot;)) {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+            // escapedHtmlPart holds the body for both html-part and html-body.</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+            escapedHtmlPart = value;</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+            mFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l7.174"></a><span id="l7.174">           }</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-          else</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-            escapedCcPart = value;</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-        }</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-        break;</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-      case 'F':</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;followup-to&quot;))</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-          escapedFollowUpToPart = value;</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-        else if (decodedName.LowerCaseEqualsLiteral(&quot;from&quot;))</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-          escapedFromPart = value;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-        break;</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-      case 'H':</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;html-part&quot;) ||</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-            decodedName.LowerCaseEqualsLiteral(&quot;html-body&quot;))</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-        {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-          // escapedHtmlPart holds the body for both html-part and html-body.</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-          escapedHtmlPart = value;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-          mFormat = nsIMsgCompFormat::HTML;</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-        }</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-        break;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-      case 'I':</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;in-reply-to&quot;))</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-          escapedInReplyToPart = value;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-        break;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+          break;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+        case 'I':</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;in-reply-to&quot;))</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+            escapedInReplyToPart = value;</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+          break;</span>
<a href="#l7.203"></a><span id="l7.203"> </span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-      case 'N':</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;newsgroups&quot;))</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-          escapedNewsgroupPart = value;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-        else if (decodedName.LowerCaseEqualsLiteral(&quot;newshost&quot;))</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-          escapedNewsHostPart = value;</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-        break;</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-      case 'O':</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;organization&quot;))</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-          escapedOrganizationPart = value;</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-        break;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-      case 'R':</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;references&quot;))</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-          escapedReferencePart = value;</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-        else if (decodedName.LowerCaseEqualsLiteral(&quot;reply-to&quot;))</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-          escapedReplyToPart = value;</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-        break;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-      case 'S':</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-        if(decodedName.LowerCaseEqualsLiteral(&quot;subject&quot;))</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-          escapedSubjectPart = value;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-        break;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-      case 'P':</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;priority&quot;))</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-          escapedPriorityPart = PL_strdup(value);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-        break;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-      case 'T':</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-        if (decodedName.LowerCaseEqualsLiteral(&quot;to&quot;))</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-        {</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-          if (!escapedToPart.IsEmpty())</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-          {</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-            escapedToPart += &quot;, &quot;;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-            escapedToPart += value;</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+        case 'N':</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;newsgroups&quot;))</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+            escapedNewsgroupPart = value;</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+          else if (decodedName.LowerCaseEqualsLiteral(&quot;newshost&quot;))</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+            escapedNewsHostPart = value;</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+          break;</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+        case 'O':</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;organization&quot;))</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+            escapedOrganizationPart = value;</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+          break;</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+        case 'R':</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;references&quot;))</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+            escapedReferencePart = value;</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+          else if (decodedName.LowerCaseEqualsLiteral(&quot;reply-to&quot;))</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+            escapedReplyToPart = value;</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+          break;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+        case 'S':</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;subject&quot;))</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+            escapedSubjectPart = value;</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+          break;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+        case 'P':</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;priority&quot;))</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+            escapedPriorityPart = PL_strdup(value);</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+          break;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+        case 'T':</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+          if (decodedName.LowerCaseEqualsLiteral(&quot;to&quot;)) {</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+            if (!escapedToPart.IsEmpty()) {</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+              escapedToPart += &quot;, &quot;;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+              escapedToPart += value;</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+            } else</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+              escapedToPart = value;</span>
<a href="#l7.266"></a><span id="l7.266">           }</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-          else</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-            escapedToPart = value;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-        }</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-        break;</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-      default:</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-        break;</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-      } // end of switch statement...</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+          break;</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+        default:</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+          break;</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+      }  // end of switch statement...</span>
<a href="#l7.278"></a><span id="l7.278"> </span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-      if (eq)</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-        *eq = '='; /* put it back */</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+      if (eq) *eq = '='; /* put it back */</span>
<a href="#l7.282"></a><span id="l7.282">       token = NS_strtok(&quot;&amp;&quot;, &amp;rest);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-    } // while we still have part of the url to parse...</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  } // if rest &amp;&amp; *rest</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    }  // while we still have part of the url to parse...</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+  }    // if rest &amp;&amp; *rest</span>
<a href="#l7.287"></a><span id="l7.287"> </span>
<a href="#l7.288"></a><span id="l7.288">   nsresult rv;</span>
<a href="#l7.289"></a><span id="l7.289">   // Get a global converter</span>
<a href="#l7.290"></a><span id="l7.290">   nsCOMPtr&lt;nsIMimeConverter&gt; mimeConverter =</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-    do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+      do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l7.293"></a><span id="l7.293">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.294"></a><span id="l7.294"> </span>
<a href="#l7.295"></a><span id="l7.295">   // Now unescape everything, and mime-decode the things that can be encoded.</span>
<a href="#l7.296"></a><span id="l7.296">   UnescapeAndConvert(mimeConverter, escapedToPart, m_toPart);</span>
<a href="#l7.297"></a><span id="l7.297">   UnescapeAndConvert(mimeConverter, escapedCcPart, m_ccPart);</span>
<a href="#l7.298"></a><span id="l7.298">   UnescapeAndConvert(mimeConverter, escapedBccPart, m_bccPart);</span>
<a href="#l7.299"></a><span id="l7.299">   UnescapeAndConvert(mimeConverter, escapedSubjectPart, m_subjectPart);</span>
<a href="#l7.300"></a><span id="l7.300">   UnescapeAndConvert(mimeConverter, escapedNewsgroupPart, m_newsgroupPart);</span>
<a href="#l7.301"></a><span id="l7.301">   UnescapeAndConvert(mimeConverter, escapedReferencePart, m_referencePart);</span>
<a href="#l7.302"></a><span id="l7.302">   if (!escapedBodyPart.IsEmpty())</span>
<a href="#l7.303"></a><span id="l7.303">     MsgUnescapeString(escapedBodyPart, 0, m_bodyPart);</span>
<a href="#l7.304"></a><span id="l7.304">   if (!escapedHtmlPart.IsEmpty())</span>
<a href="#l7.305"></a><span id="l7.305">     MsgUnescapeString(escapedHtmlPart, 0, m_htmlPart);</span>
<a href="#l7.306"></a><span id="l7.306">   UnescapeAndConvert(mimeConverter, escapedNewsHostPart, m_newsHostPart);</span>
<a href="#l7.307"></a><span id="l7.307">   UnescapeAndConvert(mimeConverter, escapedFollowUpToPart, m_followUpToPart);</span>
<a href="#l7.308"></a><span id="l7.308">   UnescapeAndConvert(mimeConverter, escapedFromPart, m_fromPart);</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-  UnescapeAndConvert(mimeConverter, escapedOrganizationPart, m_organizationPart);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+  UnescapeAndConvert(mimeConverter, escapedOrganizationPart,</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+                     m_organizationPart);</span>
<a href="#l7.312"></a><span id="l7.312">   UnescapeAndConvert(mimeConverter, escapedReplyToPart, m_replyToPart);</span>
<a href="#l7.313"></a><span id="l7.313">   UnescapeAndConvert(mimeConverter, escapedPriorityPart, m_priorityPart);</span>
<a href="#l7.314"></a><span id="l7.314"> </span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-  nsCString inReplyToPart; // Not a member like the others...</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+  nsCString inReplyToPart;  // Not a member like the others...</span>
<a href="#l7.317"></a><span id="l7.317">   UnescapeAndConvert(mimeConverter, escapedInReplyToPart, inReplyToPart);</span>
<a href="#l7.318"></a><span id="l7.318"> </span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-  if (!inReplyToPart.IsEmpty())</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-  {</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  if (!inReplyToPart.IsEmpty()) {</span>
<a href="#l7.322"></a><span id="l7.322">     // Ensure that References and In-Reply-To are consistent... The last</span>
<a href="#l7.323"></a><span id="l7.323">     // reference will be used as In-Reply-To header.</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-    if (m_referencePart.IsEmpty())</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-    {</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+    if (m_referencePart.IsEmpty()) {</span>
<a href="#l7.327"></a><span id="l7.327">       // If References is not set, set it to be the In-Reply-To.</span>
<a href="#l7.328"></a><span id="l7.328">       m_referencePart = inReplyToPart;</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-    }</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-    else</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-    {</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+    } else {</span>
<a href="#l7.333"></a><span id="l7.333">       // References is set. Add the In-Reply-To as last header unless it's</span>
<a href="#l7.334"></a><span id="l7.334">       // set as last reference already.</span>
<a href="#l7.335"></a><span id="l7.335">       int32_t lastRefStart = m_referencePart.RFindChar('&lt;');</span>
<a href="#l7.336"></a><span id="l7.336">       nsAutoCString lastReference;</span>
<a href="#l7.337"></a><span id="l7.337">       if (lastRefStart != -1)</span>
<a href="#l7.338"></a><span id="l7.338">         lastReference = StringTail(m_referencePart, lastRefStart);</span>
<a href="#l7.339"></a><span id="l7.339">       else</span>
<a href="#l7.340"></a><span id="l7.340">         lastReference = m_referencePart;</span>
<a href="#l7.341"></a><span id="l7.341"> </span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-      if (lastReference != inReplyToPart)</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-      {</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+      if (lastReference != inReplyToPart) {</span>
<a href="#l7.345"></a><span id="l7.345">         m_referencePart += &quot; &quot;;</span>
<a href="#l7.346"></a><span id="l7.346">         m_referencePart += inReplyToPart;</span>
<a href="#l7.347"></a><span id="l7.347">       }</span>
<a href="#l7.348"></a><span id="l7.348">     }</span>
<a href="#l7.349"></a><span id="l7.349">   }</span>
<a href="#l7.350"></a><span id="l7.350"> </span>
<a href="#l7.351"></a><span id="l7.351">   return NS_OK;</span>
<a href="#l7.352"></a><span id="l7.352"> }</span>
<a href="#l7.353"></a><span id="l7.353"> </span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-nsresult nsMailtoUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-{</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-  nsresult rv = NS_MutateURI(NS_SIMPLEURIMUTATOR_CONTRACTID).SetSpec(aSpec).Finalize(m_baseURL);</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+nsresult nsMailtoUrl::SetSpecInternal(const nsACString &amp;aSpec) {</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+  nsresult rv = NS_MutateURI(NS_SIMPLEURIMUTATOR_CONTRACTID)</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+                    .SetSpec(aSpec)</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+                    .Finalize(m_baseURL);</span>
<a href="#l7.361"></a><span id="l7.361">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.362"></a><span id="l7.362">   return ParseUrl();</span>
<a href="#l7.363"></a><span id="l7.363"> }</span>
<a href="#l7.364"></a><span id="l7.364"> </span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-nsresult nsMailtoUrl::CleanupMailtoState()</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-{</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-    m_ccPart = &quot;&quot;;</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-    m_subjectPart = &quot;&quot;;</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-    m_newsgroupPart = &quot;&quot;;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    m_newsHostPart = &quot;&quot;;</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-    m_referencePart = &quot;&quot;;</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-    m_bodyPart = &quot;&quot;;</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-    m_bccPart = &quot;&quot;;</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-    m_followUpToPart = &quot;&quot;;</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-    m_fromPart = &quot;&quot;;</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-    m_htmlPart = &quot;&quot;;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-    m_organizationPart = &quot;&quot;;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-    m_replyToPart = &quot;&quot;;</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-    m_priorityPart = &quot;&quot;;</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+nsresult nsMailtoUrl::CleanupMailtoState() {</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+  m_ccPart = &quot;&quot;;</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+  m_subjectPart = &quot;&quot;;</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+  m_newsgroupPart = &quot;&quot;;</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  m_newsHostPart = &quot;&quot;;</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+  m_referencePart = &quot;&quot;;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+  m_bodyPart = &quot;&quot;;</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  m_bccPart = &quot;&quot;;</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  m_followUpToPart = &quot;&quot;;</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+  m_fromPart = &quot;&quot;;</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+  m_htmlPart = &quot;&quot;;</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+  m_organizationPart = &quot;&quot;;</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  m_replyToPart = &quot;&quot;;</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  m_priorityPart = &quot;&quot;;</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.396"></a><span id="l7.396"> }</span>
<a href="#l7.397"></a><span id="l7.397"> </span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-nsresult nsMailtoUrl::ParseUrl()</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-{</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+nsresult nsMailtoUrl::ParseUrl() {</span>
<a href="#l7.401"></a><span id="l7.401">   // we can get the path from the simple url.....</span>
<a href="#l7.402"></a><span id="l7.402">   nsCString escapedPath;</span>
<a href="#l7.403"></a><span id="l7.403">   m_baseURL-&gt;GetPathQueryRef(escapedPath);</span>
<a href="#l7.404"></a><span id="l7.404"> </span>
<a href="#l7.405"></a><span id="l7.405">   int32_t startOfSearchPart = escapedPath.FindChar('?');</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-  if (startOfSearchPart &gt;= 0)</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-  {</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+  if (startOfSearchPart &gt;= 0) {</span>
<a href="#l7.409"></a><span id="l7.409">     // now parse out the search field...</span>
<a href="#l7.410"></a><span id="l7.410">     nsAutoCString searchPart(Substring(escapedPath, startOfSearchPart));</span>
<a href="#l7.411"></a><span id="l7.411"> </span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-    if (!searchPart.IsEmpty())</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-    {</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+    if (!searchPart.IsEmpty()) {</span>
<a href="#l7.415"></a><span id="l7.415">       // now we need to strip off the search part from the</span>
<a href="#l7.416"></a><span id="l7.416">       // to part....</span>
<a href="#l7.417"></a><span id="l7.417">       escapedPath.SetLength(startOfSearchPart);</span>
<a href="#l7.418"></a><span id="l7.418">       MsgUnescapeString(escapedPath, 0, m_toPart);</span>
<a href="#l7.419"></a><span id="l7.419">       ParseMailtoUrl(searchPart.BeginWriting());</span>
<a href="#l7.420"></a><span id="l7.420">     }</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-  }</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-  else if (!escapedPath.IsEmpty())</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-  {</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+  } else if (!escapedPath.IsEmpty()) {</span>
<a href="#l7.425"></a><span id="l7.425">     MsgUnescapeString(escapedPath, 0, m_toPart);</span>
<a href="#l7.426"></a><span id="l7.426">   }</span>
<a href="#l7.427"></a><span id="l7.427"> </span>
<a href="#l7.428"></a><span id="l7.428">   return NS_OK;</span>
<a href="#l7.429"></a><span id="l7.429"> }</span>
<a href="#l7.430"></a><span id="l7.430"> </span>
<a href="#l7.431"></a><span id="l7.431"> NS_IMETHODIMP</span>
<a href="#l7.432"></a><span id="l7.432"> nsMailtoUrl::GetMessageContents(nsACString &amp;aToPart, nsACString &amp;aCcPart,</span>
<a href="#l7.433"></a><span id="l7.433">                                 nsACString &amp;aBccPart, nsACString &amp;aSubjectPart,</span>
<a href="#l7.434"></a><span id="l7.434">                                 nsACString &amp;aBodyPart, nsACString &amp;aHtmlPart,</span>
<a href="#l7.435"></a><span id="l7.435">                                 nsACString &amp;aReferencePart,</span>
<a href="#l7.436"></a><span id="l7.436">                                 nsACString &amp;aNewsgroupPart,</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-                                MSG_ComposeFormat *aFormat)</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-{</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+                                MSG_ComposeFormat *aFormat) {</span>
<a href="#l7.440"></a><span id="l7.440">   NS_ENSURE_ARG_POINTER(aFormat);</span>
<a href="#l7.441"></a><span id="l7.441"> </span>
<a href="#l7.442"></a><span id="l7.442">   aToPart = m_toPart;</span>
<a href="#l7.443"></a><span id="l7.443">   aCcPart = m_ccPart;</span>
<a href="#l7.444"></a><span id="l7.444">   aBccPart = m_bccPart;</span>
<a href="#l7.445"></a><span id="l7.445">   aSubjectPart = m_subjectPart;</span>
<a href="#l7.446"></a><span id="l7.446">   aBodyPart = m_bodyPart;</span>
<a href="#l7.447"></a><span id="l7.447">   aHtmlPart = m_htmlPart;</span>
<a href="#l7.448"></a><span id="l7.448">   aReferencePart = m_referencePart;</span>
<a href="#l7.449"></a><span id="l7.449">   aNewsgroupPart = m_newsgroupPart;</span>
<a href="#l7.450"></a><span id="l7.450">   *aFormat = mFormat;</span>
<a href="#l7.451"></a><span id="l7.451">   return NS_OK;</span>
<a href="#l7.452"></a><span id="l7.452"> }</span>
<a href="#l7.453"></a><span id="l7.453"> </span>
<a href="#l7.454"></a><span id="l7.454"> NS_IMETHODIMP</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-nsMailtoUrl::GetFromPart(nsACString &amp;aResult)</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-{</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+nsMailtoUrl::GetFromPart(nsACString &amp;aResult) {</span>
<a href="#l7.458"></a><span id="l7.458">   aResult = m_fromPart;</span>
<a href="#l7.459"></a><span id="l7.459">   return NS_OK;</span>
<a href="#l7.460"></a><span id="l7.460"> }</span>
<a href="#l7.461"></a><span id="l7.461"> </span>
<a href="#l7.462"></a><span id="l7.462"> NS_IMETHODIMP</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-nsMailtoUrl::GetFollowUpToPart(nsACString &amp;aResult)</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-{</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+nsMailtoUrl::GetFollowUpToPart(nsACString &amp;aResult) {</span>
<a href="#l7.466"></a><span id="l7.466">   aResult = m_followUpToPart;</span>
<a href="#l7.467"></a><span id="l7.467">   return NS_OK;</span>
<a href="#l7.468"></a><span id="l7.468"> }</span>
<a href="#l7.469"></a><span id="l7.469"> </span>
<a href="#l7.470"></a><span id="l7.470"> NS_IMETHODIMP</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-nsMailtoUrl::GetOrganizationPart(nsACString &amp;aResult)</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-{</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+nsMailtoUrl::GetOrganizationPart(nsACString &amp;aResult) {</span>
<a href="#l7.474"></a><span id="l7.474">   aResult = m_organizationPart;</span>
<a href="#l7.475"></a><span id="l7.475">   return NS_OK;</span>
<a href="#l7.476"></a><span id="l7.476"> }</span>
<a href="#l7.477"></a><span id="l7.477"> </span>
<a href="#l7.478"></a><span id="l7.478"> NS_IMETHODIMP</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-nsMailtoUrl::GetReplyToPart(nsACString &amp;aResult)</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-{</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+nsMailtoUrl::GetReplyToPart(nsACString &amp;aResult) {</span>
<a href="#l7.482"></a><span id="l7.482">   aResult = m_replyToPart;</span>
<a href="#l7.483"></a><span id="l7.483">   return NS_OK;</span>
<a href="#l7.484"></a><span id="l7.484"> }</span>
<a href="#l7.485"></a><span id="l7.485"> </span>
<a href="#l7.486"></a><span id="l7.486"> NS_IMETHODIMP</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-nsMailtoUrl::GetPriorityPart(nsACString &amp;aResult)</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-{</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+nsMailtoUrl::GetPriorityPart(nsACString &amp;aResult) {</span>
<a href="#l7.490"></a><span id="l7.490">   aResult = m_priorityPart;</span>
<a href="#l7.491"></a><span id="l7.491">   return NS_OK;</span>
<a href="#l7.492"></a><span id="l7.492"> }</span>
<a href="#l7.493"></a><span id="l7.493"> </span>
<a href="#l7.494"></a><span id="l7.494"> NS_IMETHODIMP</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-nsMailtoUrl::GetNewsHostPart(nsACString &amp;aResult)</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-{</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+nsMailtoUrl::GetNewsHostPart(nsACString &amp;aResult) {</span>
<a href="#l7.498"></a><span id="l7.498">   aResult = m_newsHostPart;</span>
<a href="#l7.499"></a><span id="l7.499">   return NS_OK;</span>
<a href="#l7.500"></a><span id="l7.500"> }</span>
<a href="#l7.501"></a><span id="l7.501"> </span>
<a href="#l7.502"></a><span id="l7.502"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.503"></a><span id="l7.503"> // Begin nsIURI support</span>
<a href="#l7.504"></a><span id="l7.504"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.505"></a><span id="l7.505"> </span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetSpec(nsACString &amp;aSpec)</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-{</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetSpec(nsACString &amp;aSpec) {</span>
<a href="#l7.509"></a><span id="l7.509">   return m_baseURL-&gt;GetSpec(aSpec);</span>
<a href="#l7.510"></a><span id="l7.510"> }</span>
<a href="#l7.511"></a><span id="l7.511"> </span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetPrePath(nsACString &amp;aPrePath)</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineminus">-{</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetPrePath(nsACString &amp;aPrePath) {</span>
<a href="#l7.515"></a><span id="l7.515">   return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l7.516"></a><span id="l7.516"> }</span>
<a href="#l7.517"></a><span id="l7.517"> </span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-{</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l7.521"></a><span id="l7.521">   return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l7.522"></a><span id="l7.522"> }</span>
<a href="#l7.523"></a><span id="l7.523"> </span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-nsresult nsMailtoUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-{</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+nsresult nsMailtoUrl::SetScheme(const nsACString &amp;aScheme) {</span>
<a href="#l7.527"></a><span id="l7.527">   nsresult rv = NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l7.528"></a><span id="l7.528">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.529"></a><span id="l7.529">   return ParseUrl();</span>
<a href="#l7.530"></a><span id="l7.530"> }</span>
<a href="#l7.531"></a><span id="l7.531"> </span>
<a href="#l7.532"></a><span id="l7.532" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-{</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetUserPass(nsACString &amp;aUserPass) {</span>
<a href="#l7.535"></a><span id="l7.535">   return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l7.536"></a><span id="l7.536"> }</span>
<a href="#l7.537"></a><span id="l7.537"> </span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-nsresult nsMailtoUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-{</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-  nsresult rv = NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+nsresult nsMailtoUrl::SetUserPass(const nsACString &amp;aUserPass) {</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineplus">+  nsresult rv =</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+      NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l7.544"></a><span id="l7.544">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.545"></a><span id="l7.545">   return ParseUrl();</span>
<a href="#l7.546"></a><span id="l7.546"> }</span>
<a href="#l7.547"></a><span id="l7.547"> </span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-{</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetUsername(nsACString &amp;aUsername) {</span>
<a href="#l7.551"></a><span id="l7.551">   return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l7.552"></a><span id="l7.552"> }</span>
<a href="#l7.553"></a><span id="l7.553"> </span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-nsresult nsMailtoUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-{</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-  nsresult rv = NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+nsresult nsMailtoUrl::SetUsername(const nsACString &amp;aUsername) {</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+  nsresult rv =</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+      NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l7.560"></a><span id="l7.560">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.561"></a><span id="l7.561">   return ParseUrl();</span>
<a href="#l7.562"></a><span id="l7.562"> }</span>
<a href="#l7.563"></a><span id="l7.563"> </span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-{</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetPassword(nsACString &amp;aPassword) {</span>
<a href="#l7.567"></a><span id="l7.567">   return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l7.568"></a><span id="l7.568"> }</span>
<a href="#l7.569"></a><span id="l7.569"> </span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-nsresult nsMailtoUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-{</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-  nsresult rv = NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+nsresult nsMailtoUrl::SetPassword(const nsACString &amp;aPassword) {</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+  nsresult rv =</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineplus">+      NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l7.576"></a><span id="l7.576">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.577"></a><span id="l7.577">   return ParseUrl();</span>
<a href="#l7.578"></a><span id="l7.578"> }</span>
<a href="#l7.579"></a><span id="l7.579"> </span>
<a href="#l7.580"></a><span id="l7.580" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-{</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetHostPort(nsACString &amp;aHostPort) {</span>
<a href="#l7.583"></a><span id="l7.583">   return m_baseURL-&gt;GetHost(aHostPort);</span>
<a href="#l7.584"></a><span id="l7.584"> }</span>
<a href="#l7.585"></a><span id="l7.585"> </span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-nsresult nsMailtoUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-{</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-  nsresult rv = NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+nsresult nsMailtoUrl::SetHostPort(const nsACString &amp;aHostPort) {</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+  nsresult rv =</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineplus">+      NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l7.592"></a><span id="l7.592">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.593"></a><span id="l7.593">   return ParseUrl();</span>
<a href="#l7.594"></a><span id="l7.594"> }</span>
<a href="#l7.595"></a><span id="l7.595"> </span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineminus">-{</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetHost(nsACString &amp;aHost) {</span>
<a href="#l7.599"></a><span id="l7.599">   return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l7.600"></a><span id="l7.600"> }</span>
<a href="#l7.601"></a><span id="l7.601"> </span>
<a href="#l7.602"></a><span id="l7.602" class="difflineminus">-nsresult nsMailtoUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineminus">-{</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineplus">+nsresult nsMailtoUrl::SetHost(const nsACString &amp;aHost) {</span>
<a href="#l7.605"></a><span id="l7.605">   nsresult rv = NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l7.606"></a><span id="l7.606">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.607"></a><span id="l7.607">   return ParseUrl();</span>
<a href="#l7.608"></a><span id="l7.608"> }</span>
<a href="#l7.609"></a><span id="l7.609"> </span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetPort(int32_t *aPort)</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineminus">-{</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetPort(int32_t *aPort) {</span>
<a href="#l7.613"></a><span id="l7.613">   return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l7.614"></a><span id="l7.614"> }</span>
<a href="#l7.615"></a><span id="l7.615"> </span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-nsresult nsMailtoUrl::SetPort(int32_t aPort)</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-{</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+nsresult nsMailtoUrl::SetPort(int32_t aPort) {</span>
<a href="#l7.619"></a><span id="l7.619">   nsresult rv = NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l7.620"></a><span id="l7.620">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.621"></a><span id="l7.621">   return ParseUrl();</span>
<a href="#l7.622"></a><span id="l7.622"> }</span>
<a href="#l7.623"></a><span id="l7.623"> </span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-{</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetPathQueryRef(nsACString &amp;aPath) {</span>
<a href="#l7.627"></a><span id="l7.627">   return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l7.628"></a><span id="l7.628"> }</span>
<a href="#l7.629"></a><span id="l7.629"> </span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-nsresult nsMailtoUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-{</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-  nsresult rv = NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineplus">+nsresult nsMailtoUrl::SetPathQueryRef(const nsACString &amp;aPath) {</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineplus">+  nsresult rv =</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineplus">+      NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l7.636"></a><span id="l7.636">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.637"></a><span id="l7.637">   return ParseUrl();</span>
<a href="#l7.638"></a><span id="l7.638"> }</span>
<a href="#l7.639"></a><span id="l7.639"> </span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-{</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetAsciiHost(nsACString &amp;aHostA) {</span>
<a href="#l7.643"></a><span id="l7.643">   return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l7.644"></a><span id="l7.644"> }</span>
<a href="#l7.645"></a><span id="l7.645"> </span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetAsciiHostPort(nsACString &amp;aHostPortA)</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-{</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetAsciiHostPort(nsACString &amp;aHostPortA) {</span>
<a href="#l7.649"></a><span id="l7.649">   return m_baseURL-&gt;GetAsciiHostPort(aHostPortA);</span>
<a href="#l7.650"></a><span id="l7.650"> }</span>
<a href="#l7.651"></a><span id="l7.651"> </span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::GetAsciiSpec(nsACString &amp;aSpecA)</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-{</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::GetAsciiSpec(nsACString &amp;aSpecA) {</span>
<a href="#l7.655"></a><span id="l7.655">   return m_baseURL-&gt;GetAsciiSpec(aSpecA);</span>
<a href="#l7.656"></a><span id="l7.656"> }</span>
<a href="#l7.657"></a><span id="l7.657"> </span>
<a href="#l7.658"></a><span id="l7.658" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::SchemeIs(const char *aScheme, bool *_retval)</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-{</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::SchemeIs(const char *aScheme, bool *_retval) {</span>
<a href="#l7.661"></a><span id="l7.661">   return m_baseURL-&gt;SchemeIs(aScheme, _retval);</span>
<a href="#l7.662"></a><span id="l7.662"> }</span>
<a href="#l7.663"></a><span id="l7.663"> </span>
<a href="#l7.664"></a><span id="l7.664" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::Equals(nsIURI *other, bool *_retval)</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-{</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::Equals(nsIURI *other, bool *_retval) {</span>
<a href="#l7.667"></a><span id="l7.667">   // The passed-in URI might be an nsMailtoUrl. Pass our inner URL to its</span>
<a href="#l7.668"></a><span id="l7.668">   // Equals method. The other nsMailtoUrl will then pass its inner URL to</span>
<a href="#l7.669"></a><span id="l7.669">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-  if (other)</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineminus">-    return other-&gt;Equals(m_baseURL, _retval);</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+  if (other) return other-&gt;Equals(m_baseURL, _retval);</span>
<a href="#l7.673"></a><span id="l7.673"> </span>
<a href="#l7.674"></a><span id="l7.674">   return m_baseURL-&gt;Equals(other, _retval);</span>
<a href="#l7.675"></a><span id="l7.675"> }</span>
<a href="#l7.676"></a><span id="l7.676"> </span>
<a href="#l7.677"></a><span id="l7.677" class="difflineminus">-nsresult</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineminus">-nsMailtoUrl::Clone(nsIURI** _retval)</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineminus">-{</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+nsresult nsMailtoUrl::Clone(nsIURI **_retval) {</span>
<a href="#l7.681"></a><span id="l7.681">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.682"></a><span id="l7.682"> </span>
<a href="#l7.683"></a><span id="l7.683">   RefPtr&lt;nsMailtoUrl&gt; clone = new nsMailtoUrl();</span>
<a href="#l7.684"></a><span id="l7.684"> </span>
<a href="#l7.685"></a><span id="l7.685">   NS_ENSURE_TRUE(clone, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l7.686"></a><span id="l7.686"> </span>
<a href="#l7.687"></a><span id="l7.687">   nsresult rv = NS_MutateURI(m_baseURL).Finalize(clone-&gt;m_baseURL);</span>
<a href="#l7.688"></a><span id="l7.688">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.689"></a><span id="l7.689">   clone-&gt;ParseUrl();</span>
<a href="#l7.690"></a><span id="l7.690">   clone.forget(_retval);</span>
<a href="#l7.691"></a><span id="l7.691">   return NS_OK;</span>
<a href="#l7.692"></a><span id="l7.692"> }</span>
<a href="#l7.693"></a><span id="l7.693"> </span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::Resolve(const nsACString &amp;relativePath, nsACString &amp;result)</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineminus">-{</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::Resolve(const nsACString &amp;relativePath,</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+                                   nsACString &amp;result) {</span>
<a href="#l7.698"></a><span id="l7.698">   return m_baseURL-&gt;Resolve(relativePath, result);</span>
<a href="#l7.699"></a><span id="l7.699"> }</span>
<a href="#l7.700"></a><span id="l7.700"> </span>
<a href="#l7.701"></a><span id="l7.701" class="difflineminus">-nsresult nsMailtoUrl::SetRef(const nsACString &amp;aRef)</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-{</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineplus">+nsresult nsMailtoUrl::SetRef(const nsACString &amp;aRef) {</span>
<a href="#l7.704"></a><span id="l7.704">   return NS_MutateURI(m_baseURL).SetRef(aRef).Finalize(m_baseURL);</span>
<a href="#l7.705"></a><span id="l7.705"> }</span>
<a href="#l7.706"></a><span id="l7.706"> </span>
<a href="#l7.707"></a><span id="l7.707"> NS_IMETHODIMP</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-nsMailtoUrl::GetRef(nsACString &amp;result)</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-{</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-  return m_baseURL-&gt;GetRef(result);</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-}</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineplus">+nsMailtoUrl::GetRef(nsACString &amp;result) { return m_baseURL-&gt;GetRef(result); }</span>
<a href="#l7.713"></a><span id="l7.713"> </span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-NS_IMETHODIMP nsMailtoUrl::EqualsExceptRef(nsIURI *other, bool *result)</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-{</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineplus">+NS_IMETHODIMP nsMailtoUrl::EqualsExceptRef(nsIURI *other, bool *result) {</span>
<a href="#l7.717"></a><span id="l7.717">   // The passed-in URI might be an nsMailtoUrl. Pass our inner URL to its</span>
<a href="#l7.718"></a><span id="l7.718">   // Equals method. The other nsMailtoUrl will then pass its inner URL to</span>
<a href="#l7.719"></a><span id="l7.719">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineminus">-  if (other)</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineminus">-    return other-&gt;EqualsExceptRef(m_baseURL, result);</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+  if (other) return other-&gt;EqualsExceptRef(m_baseURL, result);</span>
<a href="#l7.723"></a><span id="l7.723"> </span>
<a href="#l7.724"></a><span id="l7.724">   return m_baseURL-&gt;EqualsExceptRef(other, result);</span>
<a href="#l7.725"></a><span id="l7.725"> }</span>
<a href="#l7.726"></a><span id="l7.726"> </span>
<a href="#l7.727"></a><span id="l7.727"> NS_IMETHODIMP</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineminus">-nsMailtoUrl::GetSpecIgnoringRef(nsACString &amp;result)</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineminus">-{</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+nsMailtoUrl::GetSpecIgnoringRef(nsACString &amp;result) {</span>
<a href="#l7.731"></a><span id="l7.731">   return m_baseURL-&gt;GetSpecIgnoringRef(result);</span>
<a href="#l7.732"></a><span id="l7.732"> }</span>
<a href="#l7.733"></a><span id="l7.733"> </span>
<a href="#l7.734"></a><span id="l7.734"> NS_IMETHODIMP</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineminus">-nsMailtoUrl::GetDisplaySpec(nsACString&amp; aUnicodeSpec)</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineminus">-{</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+nsMailtoUrl::GetDisplaySpec(nsACString &amp;aUnicodeSpec) {</span>
<a href="#l7.738"></a><span id="l7.738">   return GetSpec(aUnicodeSpec);</span>
<a href="#l7.739"></a><span id="l7.739"> }</span>
<a href="#l7.740"></a><span id="l7.740"> </span>
<a href="#l7.741"></a><span id="l7.741"> NS_IMETHODIMP</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineminus">-nsMailtoUrl::GetDisplayHostPort(nsACString&amp; aUnicodeHostPort)</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineminus">-{</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+nsMailtoUrl::GetDisplayHostPort(nsACString &amp;aUnicodeHostPort) {</span>
<a href="#l7.745"></a><span id="l7.745">   return GetHostPort(aUnicodeHostPort);</span>
<a href="#l7.746"></a><span id="l7.746"> }</span>
<a href="#l7.747"></a><span id="l7.747"> </span>
<a href="#l7.748"></a><span id="l7.748"> NS_IMETHODIMP</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineminus">-nsMailtoUrl::GetDisplayHost(nsACString&amp; aUnicodeHost)</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineminus">-{</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+nsMailtoUrl::GetDisplayHost(nsACString &amp;aUnicodeHost) {</span>
<a href="#l7.752"></a><span id="l7.752">   return GetHost(aUnicodeHost);</span>
<a href="#l7.753"></a><span id="l7.753"> }</span>
<a href="#l7.754"></a><span id="l7.754"> </span>
<a href="#l7.755"></a><span id="l7.755"> NS_IMETHODIMP</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineminus">-nsMailtoUrl::GetDisplayPrePath(nsACString&amp; aPrePath)</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineminus">-{</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+nsMailtoUrl::GetDisplayPrePath(nsACString &amp;aPrePath) {</span>
<a href="#l7.759"></a><span id="l7.759">   return GetPrePath(aPrePath);</span>
<a href="#l7.760"></a><span id="l7.760"> }</span>
<a href="#l7.761"></a><span id="l7.761"> </span>
<a href="#l7.762"></a><span id="l7.762"> NS_IMETHODIMP</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineminus">-nsMailtoUrl::GetHasRef(bool *result)</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineminus">-{</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineminus">-  return m_baseURL-&gt;GetHasRef(result);</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineminus">-}</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+nsMailtoUrl::GetHasRef(bool *result) { return m_baseURL-&gt;GetHasRef(result); }</span>
<a href="#l7.768"></a><span id="l7.768"> </span>
<a href="#l7.769"></a><span id="l7.769"> NS_IMETHODIMP</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineminus">-nsMailtoUrl::GetFilePath(nsACString &amp;aFilePath)</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineminus">-{</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+nsMailtoUrl::GetFilePath(nsACString &amp;aFilePath) {</span>
<a href="#l7.773"></a><span id="l7.773">   return m_baseURL-&gt;GetFilePath(aFilePath);</span>
<a href="#l7.774"></a><span id="l7.774"> }</span>
<a href="#l7.775"></a><span id="l7.775"> </span>
<a href="#l7.776"></a><span id="l7.776" class="difflineminus">-nsresult nsMailtoUrl::SetFilePath(const nsACString &amp;aFilePath)</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineminus">-{</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+nsresult nsMailtoUrl::SetFilePath(const nsACString &amp;aFilePath) {</span>
<a href="#l7.779"></a><span id="l7.779">   return NS_MutateURI(m_baseURL).SetFilePath(aFilePath).Finalize(m_baseURL);</span>
<a href="#l7.780"></a><span id="l7.780"> }</span>
<a href="#l7.781"></a><span id="l7.781"> </span>
<a href="#l7.782"></a><span id="l7.782"> NS_IMETHODIMP</span>
<a href="#l7.783"></a><span id="l7.783" class="difflineminus">-nsMailtoUrl::GetQuery(nsACString &amp;aQuery)</span>
<a href="#l7.784"></a><span id="l7.784" class="difflineminus">-{</span>
<a href="#l7.785"></a><span id="l7.785" class="difflineplus">+nsMailtoUrl::GetQuery(nsACString &amp;aQuery) {</span>
<a href="#l7.786"></a><span id="l7.786">   return m_baseURL-&gt;GetQuery(aQuery);</span>
<a href="#l7.787"></a><span id="l7.787"> }</span>
<a href="#l7.788"></a><span id="l7.788"> </span>
<a href="#l7.789"></a><span id="l7.789" class="difflineminus">-nsresult nsMailtoUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineminus">-{</span>
<a href="#l7.791"></a><span id="l7.791" class="difflineplus">+nsresult nsMailtoUrl::SetQuery(const nsACString &amp;aQuery) {</span>
<a href="#l7.792"></a><span id="l7.792">   return NS_MutateURI(m_baseURL).SetQuery(aQuery).Finalize(m_baseURL);</span>
<a href="#l7.793"></a><span id="l7.793"> }</span>
<a href="#l7.794"></a><span id="l7.794"> </span>
<a href="#l7.795"></a><span id="l7.795" class="difflineminus">-nsresult nsMailtoUrl::SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding)</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineminus">-{</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineminus">-  return NS_MutateURI(m_baseURL).SetQueryWithEncoding(aQuery, aEncoding).Finalize(m_baseURL);</span>
<a href="#l7.798"></a><span id="l7.798" class="difflineplus">+nsresult nsMailtoUrl::SetQueryWithEncoding(const nsACString &amp;aQuery,</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineplus">+                                           const mozilla::Encoding *aEncoding) {</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineplus">+  return NS_MutateURI(m_baseURL)</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineplus">+      .SetQueryWithEncoding(aQuery, aEncoding)</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineplus">+      .Finalize(m_baseURL);</span>
<a href="#l7.803"></a><span id="l7.803"> }</span>
<a href="#l7.804"></a><span id="l7.804"> </span>
<a href="#l7.805"></a><span id="l7.805"> NS_IMETHODIMP_(void)</span>
<a href="#l7.806"></a><span id="l7.806" class="difflineminus">-nsMailtoUrl::Serialize(mozilla::ipc::URIParams &amp;aParams)</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineminus">-{</span>
<a href="#l7.808"></a><span id="l7.808" class="difflineplus">+nsMailtoUrl::Serialize(mozilla::ipc::URIParams &amp;aParams) {</span>
<a href="#l7.809"></a><span id="l7.809">   m_baseURL-&gt;Serialize(aParams);</span>
<a href="#l7.810"></a><span id="l7.810"> }</span>
<a href="#l7.811"></a><span id="l7.811"> </span>
<a href="#l7.812"></a><span id="l7.812"> NS_IMPL_ISUPPORTS(nsMailtoUrl::Mutator, nsIURISetters, nsIURIMutator)</span>
<a href="#l7.813"></a><span id="l7.813"> </span>
<a href="#l7.814"></a><span id="l7.814"> NS_IMETHODIMP</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineminus">-nsMailtoUrl::Mutate(nsIURIMutator** aMutator)</span>
<a href="#l7.816"></a><span id="l7.816" class="difflineminus">-{</span>
<a href="#l7.817"></a><span id="l7.817" class="difflineplus">+nsMailtoUrl::Mutate(nsIURIMutator **aMutator) {</span>
<a href="#l7.818"></a><span id="l7.818">   RefPtr&lt;nsMailtoUrl::Mutator&gt; mutator = new nsMailtoUrl::Mutator();</span>
<a href="#l7.819"></a><span id="l7.819">   nsresult rv = mutator-&gt;InitFromURI(this);</span>
<a href="#l7.820"></a><span id="l7.820">   if (NS_FAILED(rv)) {</span>
<a href="#l7.821"></a><span id="l7.821">     return rv;</span>
<a href="#l7.822"></a><span id="l7.822">   }</span>
<a href="#l7.823"></a><span id="l7.823">   mutator.forget(aMutator);</span>
<a href="#l7.824"></a><span id="l7.824">   return NS_OK;</span>
<a href="#l7.825"></a><span id="l7.825"> }</span>
<a href="#l7.826"></a><span id="l7.826"> </span>
<a href="#l7.827"></a><span id="l7.827"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.828"></a><span id="l7.828"> // smtp url definition</span>
<a href="#l7.829"></a><span id="l7.829"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.830"></a><span id="l7.830"> </span>
<a href="#l7.831"></a><span id="l7.831" class="difflineminus">-nsSmtpUrl::nsSmtpUrl() : nsMsgMailNewsUrl()</span>
<a href="#l7.832"></a><span id="l7.832" class="difflineminus">-{</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineplus">+nsSmtpUrl::nsSmtpUrl() : nsMsgMailNewsUrl() {</span>
<a href="#l7.834"></a><span id="l7.834">   // nsISmtpUrl specific state...</span>
<a href="#l7.835"></a><span id="l7.835"> </span>
<a href="#l7.836"></a><span id="l7.836">   m_isPostMessage = true;</span>
<a href="#l7.837"></a><span id="l7.837">   m_requestDSN = false;</span>
<a href="#l7.838"></a><span id="l7.838">   m_verifyLogon = false;</span>
<a href="#l7.839"></a><span id="l7.839"> }</span>
<a href="#l7.840"></a><span id="l7.840"> </span>
<a href="#l7.841"></a><span id="l7.841" class="difflineminus">-nsSmtpUrl::~nsSmtpUrl()</span>
<a href="#l7.842"></a><span id="l7.842" class="difflineminus">-{</span>
<a href="#l7.843"></a><span id="l7.843" class="difflineminus">-}</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineplus">+nsSmtpUrl::~nsSmtpUrl() {}</span>
<a href="#l7.845"></a><span id="l7.845"> </span>
<a href="#l7.846"></a><span id="l7.846"> NS_IMETHODIMP</span>
<a href="#l7.847"></a><span id="l7.847" class="difflineminus">-nsSmtpUrl::Init(const nsACString &amp;aSpec)</span>
<a href="#l7.848"></a><span id="l7.848" class="difflineminus">-{</span>
<a href="#l7.849"></a><span id="l7.849" class="difflineminus">-  return SetSpecInternal(aSpec);</span>
<a href="#l7.850"></a><span id="l7.850" class="difflineminus">-}</span>
<a href="#l7.851"></a><span id="l7.851" class="difflineplus">+nsSmtpUrl::Init(const nsACString &amp;aSpec) { return SetSpecInternal(aSpec); }</span>
<a href="#l7.852"></a><span id="l7.852"> </span>
<a href="#l7.853"></a><span id="l7.853"> NS_IMPL_ISUPPORTS_INHERITED(nsSmtpUrl, nsMsgMailNewsUrl, nsISmtpUrl)</span>
<a href="#l7.854"></a><span id="l7.854"> </span>
<a href="#l7.855"></a><span id="l7.855"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.856"></a><span id="l7.856"> // Begin nsISmtpUrl specific support</span>
<a href="#l7.857"></a><span id="l7.857"> </span>
<a href="#l7.858"></a><span id="l7.858"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.859"></a><span id="l7.859"> </span>
<a href="#l7.860"></a><span id="l7.860"> NS_IMETHODIMP</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineminus">-nsSmtpUrl::SetRecipients(const char * aRecipientsList)</span>
<a href="#l7.862"></a><span id="l7.862" class="difflineminus">-{</span>
<a href="#l7.863"></a><span id="l7.863" class="difflineplus">+nsSmtpUrl::SetRecipients(const char *aRecipientsList) {</span>
<a href="#l7.864"></a><span id="l7.864">   NS_ENSURE_ARG(aRecipientsList);</span>
<a href="#l7.865"></a><span id="l7.865">   MsgUnescapeString(nsDependentCString(aRecipientsList), 0, m_toPart);</span>
<a href="#l7.866"></a><span id="l7.866">   return NS_OK;</span>
<a href="#l7.867"></a><span id="l7.867"> }</span>
<a href="#l7.868"></a><span id="l7.868"> </span>
<a href="#l7.869"></a><span id="l7.869"> NS_IMETHODIMP</span>
<a href="#l7.870"></a><span id="l7.870" class="difflineminus">-nsSmtpUrl::GetRecipients(char ** aRecipientsList)</span>
<a href="#l7.871"></a><span id="l7.871" class="difflineminus">-{</span>
<a href="#l7.872"></a><span id="l7.872" class="difflineplus">+nsSmtpUrl::GetRecipients(char **aRecipientsList) {</span>
<a href="#l7.873"></a><span id="l7.873">   NS_ENSURE_ARG_POINTER(aRecipientsList);</span>
<a href="#l7.874"></a><span id="l7.874" class="difflineminus">-  if (aRecipientsList)</span>
<a href="#l7.875"></a><span id="l7.875" class="difflineminus">-    *aRecipientsList = ToNewCString(m_toPart);</span>
<a href="#l7.876"></a><span id="l7.876" class="difflineplus">+  if (aRecipientsList) *aRecipientsList = ToNewCString(m_toPart);</span>
<a href="#l7.877"></a><span id="l7.877">   return NS_OK;</span>
<a href="#l7.878"></a><span id="l7.878"> }</span>
<a href="#l7.879"></a><span id="l7.879"> </span>
<a href="#l7.880"></a><span id="l7.880"> NS_IMETHODIMP</span>
<a href="#l7.881"></a><span id="l7.881" class="difflineminus">-nsSmtpUrl::SetSender(const char * aSender)</span>
<a href="#l7.882"></a><span id="l7.882" class="difflineminus">-{</span>
<a href="#l7.883"></a><span id="l7.883" class="difflineplus">+nsSmtpUrl::SetSender(const char *aSender) {</span>
<a href="#l7.884"></a><span id="l7.884">   NS_ENSURE_ARG(aSender);</span>
<a href="#l7.885"></a><span id="l7.885">   MsgUnescapeString(nsDependentCString(aSender), 0, m_fromPart);</span>
<a href="#l7.886"></a><span id="l7.886">   return NS_OK;</span>
<a href="#l7.887"></a><span id="l7.887"> }</span>
<a href="#l7.888"></a><span id="l7.888"> </span>
<a href="#l7.889"></a><span id="l7.889"> NS_IMETHODIMP</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineminus">-nsSmtpUrl::GetSender(char ** aSender)</span>
<a href="#l7.891"></a><span id="l7.891" class="difflineminus">-{</span>
<a href="#l7.892"></a><span id="l7.892" class="difflineplus">+nsSmtpUrl::GetSender(char **aSender) {</span>
<a href="#l7.893"></a><span id="l7.893">   NS_ENSURE_ARG_POINTER(aSender);</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineminus">-  if (aSender)</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineminus">-    *aSender = ToNewCString(m_fromPart);</span>
<a href="#l7.896"></a><span id="l7.896" class="difflineplus">+  if (aSender) *aSender = ToNewCString(m_fromPart);</span>
<a href="#l7.897"></a><span id="l7.897">   return NS_OK;</span>
<a href="#l7.898"></a><span id="l7.898"> }</span>
<a href="#l7.899"></a><span id="l7.899"> </span>
<a href="#l7.900"></a><span id="l7.900"> NS_IMPL_GETSET(nsSmtpUrl, PostMessage, bool, m_isPostMessage)</span>
<a href="#l7.901"></a><span id="l7.901"> </span>
<a href="#l7.902"></a><span id="l7.902"> NS_IMPL_GETSET(nsSmtpUrl, VerifyLogon, bool, m_verifyLogon)</span>
<a href="#l7.903"></a><span id="l7.903"> </span>
<a href="#l7.904"></a><span id="l7.904" class="difflineminus">-// the message can be stored in a file....allow accessors for getting and setting</span>
<a href="#l7.905"></a><span id="l7.905" class="difflineminus">-// the file name to post...</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineminus">-NS_IMETHODIMP nsSmtpUrl::SetPostMessageFile(nsIFile * aFile)</span>
<a href="#l7.907"></a><span id="l7.907" class="difflineminus">-{</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineplus">+// the message can be stored in a file....allow accessors for getting and</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineplus">+// setting the file name to post...</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineplus">+NS_IMETHODIMP nsSmtpUrl::SetPostMessageFile(nsIFile *aFile) {</span>
<a href="#l7.911"></a><span id="l7.911">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l7.912"></a><span id="l7.912">   m_fileName = aFile;</span>
<a href="#l7.913"></a><span id="l7.913">   return NS_OK;</span>
<a href="#l7.914"></a><span id="l7.914"> }</span>
<a href="#l7.915"></a><span id="l7.915"> </span>
<a href="#l7.916"></a><span id="l7.916" class="difflineminus">-NS_IMETHODIMP nsSmtpUrl::GetPostMessageFile(nsIFile ** aFile)</span>
<a href="#l7.917"></a><span id="l7.917" class="difflineminus">-{</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineplus">+NS_IMETHODIMP nsSmtpUrl::GetPostMessageFile(nsIFile **aFile) {</span>
<a href="#l7.919"></a><span id="l7.919">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l7.920"></a><span id="l7.920" class="difflineminus">-  if (m_fileName)</span>
<a href="#l7.921"></a><span id="l7.921" class="difflineminus">-  {</span>
<a href="#l7.922"></a><span id="l7.922" class="difflineplus">+  if (m_fileName) {</span>
<a href="#l7.923"></a><span id="l7.923">     // Clone the file so nsLocalFile stat caching doesn't make the caller get</span>
<a href="#l7.924"></a><span id="l7.924">     // the wrong file size.</span>
<a href="#l7.925"></a><span id="l7.925">     m_fileName-&gt;Clone(aFile);</span>
<a href="#l7.926"></a><span id="l7.926">     return *aFile ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.927"></a><span id="l7.927">   }</span>
<a href="#l7.928"></a><span id="l7.928">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.929"></a><span id="l7.929"> }</span>
<a href="#l7.930"></a><span id="l7.930"> </span>
<a href="#l7.931"></a><span id="l7.931"> NS_IMPL_GETSET(nsSmtpUrl, RequestDSN, bool, m_requestDSN)</span>
<a href="#l7.932"></a><span id="l7.932"> </span>
<a href="#l7.933"></a><span id="l7.933"> NS_IMETHODIMP</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineminus">-nsSmtpUrl::SetDsnEnvid(const nsACString &amp;aDsnEnvid)</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineminus">-{</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineminus">-    m_dsnEnvid = aDsnEnvid;</span>
<a href="#l7.937"></a><span id="l7.937" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.938"></a><span id="l7.938" class="difflineplus">+nsSmtpUrl::SetDsnEnvid(const nsACString &amp;aDsnEnvid) {</span>
<a href="#l7.939"></a><span id="l7.939" class="difflineplus">+  m_dsnEnvid = aDsnEnvid;</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.941"></a><span id="l7.941"> }</span>
<a href="#l7.942"></a><span id="l7.942"> </span>
<a href="#l7.943"></a><span id="l7.943"> NS_IMETHODIMP</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineminus">-nsSmtpUrl::GetDsnEnvid(nsACString &amp;aDsnEnvid)</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineminus">-{</span>
<a href="#l7.946"></a><span id="l7.946" class="difflineminus">-    aDsnEnvid = m_dsnEnvid;</span>
<a href="#l7.947"></a><span id="l7.947" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineplus">+nsSmtpUrl::GetDsnEnvid(nsACString &amp;aDsnEnvid) {</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineplus">+  aDsnEnvid = m_dsnEnvid;</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.951"></a><span id="l7.951"> }</span>
<a href="#l7.952"></a><span id="l7.952"> </span>
<a href="#l7.953"></a><span id="l7.953"> NS_IMETHODIMP</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineminus">-nsSmtpUrl::GetSenderIdentity(nsIMsgIdentity **aSenderIdentity)</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineminus">-{</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineplus">+nsSmtpUrl::GetSenderIdentity(nsIMsgIdentity **aSenderIdentity) {</span>
<a href="#l7.957"></a><span id="l7.957">   NS_ENSURE_ARG_POINTER(aSenderIdentity);</span>
<a href="#l7.958"></a><span id="l7.958">   NS_ADDREF(*aSenderIdentity = m_senderIdentity);</span>
<a href="#l7.959"></a><span id="l7.959">   return NS_OK;</span>
<a href="#l7.960"></a><span id="l7.960"> }</span>
<a href="#l7.961"></a><span id="l7.961"> </span>
<a href="#l7.962"></a><span id="l7.962"> NS_IMETHODIMP</span>
<a href="#l7.963"></a><span id="l7.963" class="difflineminus">-nsSmtpUrl::SetSenderIdentity(nsIMsgIdentity *aSenderIdentity)</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineminus">-{</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineplus">+nsSmtpUrl::SetSenderIdentity(nsIMsgIdentity *aSenderIdentity) {</span>
<a href="#l7.966"></a><span id="l7.966">   NS_ENSURE_ARG_POINTER(aSenderIdentity);</span>
<a href="#l7.967"></a><span id="l7.967">   m_senderIdentity = aSenderIdentity;</span>
<a href="#l7.968"></a><span id="l7.968">   return NS_OK;</span>
<a href="#l7.969"></a><span id="l7.969"> }</span>
<a href="#l7.970"></a><span id="l7.970"> </span>
<a href="#l7.971"></a><span id="l7.971"> NS_IMETHODIMP</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineminus">-nsSmtpUrl::SetPrompt(nsIPrompt *aNetPrompt)</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineminus">-{</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNetPrompt);</span>
<a href="#l7.975"></a><span id="l7.975" class="difflineminus">-    m_netPrompt = aNetPrompt;</span>
<a href="#l7.976"></a><span id="l7.976" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.977"></a><span id="l7.977" class="difflineplus">+nsSmtpUrl::SetPrompt(nsIPrompt *aNetPrompt) {</span>
<a href="#l7.978"></a><span id="l7.978" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNetPrompt);</span>
<a href="#l7.979"></a><span id="l7.979" class="difflineplus">+  m_netPrompt = aNetPrompt;</span>
<a href="#l7.980"></a><span id="l7.980" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.981"></a><span id="l7.981"> }</span>
<a href="#l7.982"></a><span id="l7.982"> </span>
<a href="#l7.983"></a><span id="l7.983"> NS_IMETHODIMP</span>
<a href="#l7.984"></a><span id="l7.984" class="difflineminus">-nsSmtpUrl::GetPrompt(nsIPrompt **aNetPrompt)</span>
<a href="#l7.985"></a><span id="l7.985" class="difflineminus">-{</span>
<a href="#l7.986"></a><span id="l7.986" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNetPrompt);</span>
<a href="#l7.987"></a><span id="l7.987" class="difflineminus">-    NS_ENSURE_TRUE(m_netPrompt, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.988"></a><span id="l7.988" class="difflineminus">-    NS_ADDREF(*aNetPrompt = m_netPrompt);</span>
<a href="#l7.989"></a><span id="l7.989" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.990"></a><span id="l7.990" class="difflineplus">+nsSmtpUrl::GetPrompt(nsIPrompt **aNetPrompt) {</span>
<a href="#l7.991"></a><span id="l7.991" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNetPrompt);</span>
<a href="#l7.992"></a><span id="l7.992" class="difflineplus">+  NS_ENSURE_TRUE(m_netPrompt, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineplus">+  NS_ADDREF(*aNetPrompt = m_netPrompt);</span>
<a href="#l7.994"></a><span id="l7.994" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.995"></a><span id="l7.995"> }</span>
<a href="#l7.996"></a><span id="l7.996"> </span>
<a href="#l7.997"></a><span id="l7.997"> NS_IMETHODIMP</span>
<a href="#l7.998"></a><span id="l7.998" class="difflineminus">-nsSmtpUrl::SetAuthPrompt(nsIAuthPrompt *aNetAuthPrompt)</span>
<a href="#l7.999"></a><span id="l7.999" class="difflineminus">-{</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNetAuthPrompt);</span>
<a href="#l7.1001"></a><span id="l7.1001" class="difflineminus">-    m_netAuthPrompt = aNetAuthPrompt;</span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1003"></a><span id="l7.1003" class="difflineplus">+nsSmtpUrl::SetAuthPrompt(nsIAuthPrompt *aNetAuthPrompt) {</span>
<a href="#l7.1004"></a><span id="l7.1004" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNetAuthPrompt);</span>
<a href="#l7.1005"></a><span id="l7.1005" class="difflineplus">+  m_netAuthPrompt = aNetAuthPrompt;</span>
<a href="#l7.1006"></a><span id="l7.1006" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1007"></a><span id="l7.1007"> }</span>
<a href="#l7.1008"></a><span id="l7.1008"> </span>
<a href="#l7.1009"></a><span id="l7.1009"> NS_IMETHODIMP</span>
<a href="#l7.1010"></a><span id="l7.1010" class="difflineminus">-nsSmtpUrl::GetAuthPrompt(nsIAuthPrompt **aNetAuthPrompt)</span>
<a href="#l7.1011"></a><span id="l7.1011" class="difflineminus">-{</span>
<a href="#l7.1012"></a><span id="l7.1012" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aNetAuthPrompt);</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineminus">-    NS_ENSURE_TRUE(m_netAuthPrompt, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1014"></a><span id="l7.1014" class="difflineminus">-    NS_ADDREF(*aNetAuthPrompt = m_netAuthPrompt);</span>
<a href="#l7.1015"></a><span id="l7.1015" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineplus">+nsSmtpUrl::GetAuthPrompt(nsIAuthPrompt **aNetAuthPrompt) {</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNetAuthPrompt);</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineplus">+  NS_ENSURE_TRUE(m_netAuthPrompt, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineplus">+  NS_ADDREF(*aNetAuthPrompt = m_netAuthPrompt);</span>
<a href="#l7.1020"></a><span id="l7.1020" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1021"></a><span id="l7.1021"> }</span>
<a href="#l7.1022"></a><span id="l7.1022"> </span>
<a href="#l7.1023"></a><span id="l7.1023"> NS_IMETHODIMP</span>
<a href="#l7.1024"></a><span id="l7.1024" class="difflineminus">-nsSmtpUrl::SetNotificationCallbacks(nsIInterfaceRequestor* aCallbacks)</span>
<a href="#l7.1025"></a><span id="l7.1025" class="difflineminus">-{</span>
<a href="#l7.1026"></a><span id="l7.1026" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCallbacks);</span>
<a href="#l7.1027"></a><span id="l7.1027" class="difflineminus">-    m_callbacks = aCallbacks;</span>
<a href="#l7.1028"></a><span id="l7.1028" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1029"></a><span id="l7.1029" class="difflineplus">+nsSmtpUrl::SetNotificationCallbacks(nsIInterfaceRequestor *aCallbacks) {</span>
<a href="#l7.1030"></a><span id="l7.1030" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCallbacks);</span>
<a href="#l7.1031"></a><span id="l7.1031" class="difflineplus">+  m_callbacks = aCallbacks;</span>
<a href="#l7.1032"></a><span id="l7.1032" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1033"></a><span id="l7.1033"> }</span>
<a href="#l7.1034"></a><span id="l7.1034"> </span>
<a href="#l7.1035"></a><span id="l7.1035"> NS_IMETHODIMP</span>
<a href="#l7.1036"></a><span id="l7.1036" class="difflineminus">-nsSmtpUrl::GetNotificationCallbacks(nsIInterfaceRequestor** aCallbacks)</span>
<a href="#l7.1037"></a><span id="l7.1037" class="difflineminus">-{</span>
<a href="#l7.1038"></a><span id="l7.1038" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCallbacks);</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineminus">-    NS_ENSURE_TRUE(m_callbacks, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1040"></a><span id="l7.1040" class="difflineminus">-    NS_ADDREF(*aCallbacks = m_callbacks);</span>
<a href="#l7.1041"></a><span id="l7.1041" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1042"></a><span id="l7.1042" class="difflineplus">+nsSmtpUrl::GetNotificationCallbacks(nsIInterfaceRequestor **aCallbacks) {</span>
<a href="#l7.1043"></a><span id="l7.1043" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCallbacks);</span>
<a href="#l7.1044"></a><span id="l7.1044" class="difflineplus">+  NS_ENSURE_TRUE(m_callbacks, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1045"></a><span id="l7.1045" class="difflineplus">+  NS_ADDREF(*aCallbacks = m_callbacks);</span>
<a href="#l7.1046"></a><span id="l7.1046" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1047"></a><span id="l7.1047"> }</span>
<a href="#l7.1048"></a><span id="l7.1048"> </span>
<a href="#l7.1049"></a><span id="l7.1049"> NS_IMETHODIMP</span>
<a href="#l7.1050"></a><span id="l7.1050" class="difflineminus">-nsSmtpUrl::SetSmtpServer(nsISmtpServer * aSmtpServer)</span>
<a href="#l7.1051"></a><span id="l7.1051" class="difflineminus">-{</span>
<a href="#l7.1052"></a><span id="l7.1052" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSmtpServer);</span>
<a href="#l7.1053"></a><span id="l7.1053" class="difflineminus">-    m_smtpServer = aSmtpServer;</span>
<a href="#l7.1054"></a><span id="l7.1054" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1055"></a><span id="l7.1055" class="difflineplus">+nsSmtpUrl::SetSmtpServer(nsISmtpServer *aSmtpServer) {</span>
<a href="#l7.1056"></a><span id="l7.1056" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSmtpServer);</span>
<a href="#l7.1057"></a><span id="l7.1057" class="difflineplus">+  m_smtpServer = aSmtpServer;</span>
<a href="#l7.1058"></a><span id="l7.1058" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1059"></a><span id="l7.1059"> }</span>
<a href="#l7.1060"></a><span id="l7.1060"> </span>
<a href="#l7.1061"></a><span id="l7.1061"> NS_IMETHODIMP</span>
<a href="#l7.1062"></a><span id="l7.1062" class="difflineminus">-nsSmtpUrl::GetSmtpServer(nsISmtpServer ** aSmtpServer)</span>
<a href="#l7.1063"></a><span id="l7.1063" class="difflineminus">-{</span>
<a href="#l7.1064"></a><span id="l7.1064" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aSmtpServer);</span>
<a href="#l7.1065"></a><span id="l7.1065" class="difflineminus">-    NS_ENSURE_TRUE(m_smtpServer, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1066"></a><span id="l7.1066" class="difflineminus">-    NS_ADDREF(*aSmtpServer = m_smtpServer);</span>
<a href="#l7.1067"></a><span id="l7.1067" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1068"></a><span id="l7.1068" class="difflineplus">+nsSmtpUrl::GetSmtpServer(nsISmtpServer **aSmtpServer) {</span>
<a href="#l7.1069"></a><span id="l7.1069" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSmtpServer);</span>
<a href="#l7.1070"></a><span id="l7.1070" class="difflineplus">+  NS_ENSURE_TRUE(m_smtpServer, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1071"></a><span id="l7.1071" class="difflineplus">+  NS_ADDREF(*aSmtpServer = m_smtpServer);</span>
<a href="#l7.1072"></a><span id="l7.1072" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1073"></a><span id="l7.1073"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -13,84 +13,80 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsMailtoUrl : public nsIMailtoUrl, public nsIURI</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-public:</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-    NS_DECL_NSIURI</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-    NS_DECL_NSIMAILTOURL</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+class nsMailtoUrl : public nsIMailtoUrl, public nsIURI {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ public:</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  NS_DECL_NSIURI</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  NS_DECL_NSIMAILTOURL</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-    nsMailtoUrl();</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  nsMailtoUrl();</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-protected:</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+ protected:</span>
<a href="#l8.29"></a><span id="l8.29">   virtual nsresult Clone(nsIURI **_retval);</span>
<a href="#l8.30"></a><span id="l8.30">   virtual nsresult SetSpecInternal(const nsACString &amp;aSpec);</span>
<a href="#l8.31"></a><span id="l8.31">   virtual nsresult SetScheme(const nsACString &amp;aScheme);</span>
<a href="#l8.32"></a><span id="l8.32">   virtual nsresult SetUserPass(const nsACString &amp;aUserPass);</span>
<a href="#l8.33"></a><span id="l8.33">   virtual nsresult SetUsername(const nsACString &amp;aUsername);</span>
<a href="#l8.34"></a><span id="l8.34">   virtual nsresult SetPassword(const nsACString &amp;aPassword);</span>
<a href="#l8.35"></a><span id="l8.35">   virtual nsresult SetHostPort(const nsACString &amp;aHostPort);</span>
<a href="#l8.36"></a><span id="l8.36">   virtual nsresult SetHost(const nsACString &amp;aHost);</span>
<a href="#l8.37"></a><span id="l8.37">   virtual nsresult SetPort(int32_t aPort);</span>
<a href="#l8.38"></a><span id="l8.38">   virtual nsresult SetPathQueryRef(const nsACString &amp;aPath);</span>
<a href="#l8.39"></a><span id="l8.39">   virtual nsresult SetRef(const nsACString &amp;aRef);</span>
<a href="#l8.40"></a><span id="l8.40">   virtual nsresult SetFilePath(const nsACString &amp;aFilePath);</span>
<a href="#l8.41"></a><span id="l8.41">   virtual nsresult SetQuery(const nsACString &amp;aQuery);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery, const mozilla::Encoding* aEncoding);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+  virtual nsresult SetQueryWithEncoding(const nsACString &amp;aQuery,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+                                        const mozilla::Encoding *aEncoding);</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-public:</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  class Mutator</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-      : public nsIURIMutator</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-      , public BaseURIMutator&lt;nsMailtoUrl&gt;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  {</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+ public:</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  class Mutator : public nsIURIMutator, public BaseURIMutator&lt;nsMailtoUrl&gt; {</span>
<a href="#l8.53"></a><span id="l8.53">     NS_DECL_ISUPPORTS</span>
<a href="#l8.54"></a><span id="l8.54">     NS_FORWARD_SAFE_NSIURISETTERS_RET(mURI)</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    NS_IMETHOD Deserialize(const mozilla::ipc::URIParams&amp; aParams) override</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    {</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    NS_IMETHOD Deserialize(const mozilla::ipc::URIParams &amp;aParams) override {</span>
<a href="#l8.59"></a><span id="l8.59">       return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.60"></a><span id="l8.60">     }</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62" class="difflineminus">-    NS_IMETHOD Finalize(nsIURI** aURI) override</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-    {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    NS_IMETHOD Finalize(nsIURI **aURI) override {</span>
<a href="#l8.65"></a><span id="l8.65">       mURI.forget(aURI);</span>
<a href="#l8.66"></a><span id="l8.66">       return NS_OK;</span>
<a href="#l8.67"></a><span id="l8.67">     }</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    NS_IMETHOD SetSpec(const nsACString &amp; aSpec, nsIURIMutator** aMutator) override</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    {</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-      if (aMutator)</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-        NS_ADDREF(*aMutator = this);</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    NS_IMETHOD SetSpec(const nsACString &amp;aSpec,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+                       nsIURIMutator **aMutator) override {</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+      if (aMutator) NS_ADDREF(*aMutator = this);</span>
<a href="#l8.76"></a><span id="l8.76">       return InitFromSpec(aSpec);</span>
<a href="#l8.77"></a><span id="l8.77">     }</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    explicit Mutator() { }</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  private:</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-    virtual ~Mutator() { }</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+    explicit Mutator() {}</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+   private:</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    virtual ~Mutator() {}</span>
<a href="#l8.86"></a><span id="l8.86"> </span>
<a href="#l8.87"></a><span id="l8.87">     friend class nsMailtoUrl;</span>
<a href="#l8.88"></a><span id="l8.88">   };</span>
<a href="#l8.89"></a><span id="l8.89">   friend BaseURIMutator&lt;nsMailtoUrl&gt;;</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-protected:</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+ protected:</span>
<a href="#l8.93"></a><span id="l8.93">   virtual ~nsMailtoUrl();</span>
<a href="#l8.94"></a><span id="l8.94">   nsresult ParseUrl();</span>
<a href="#l8.95"></a><span id="l8.95">   nsresult CleanupMailtoState();</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-  nsresult ParseMailtoUrl(char * searchPart);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  nsresult ParseMailtoUrl(char *searchPart);</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99">   nsCOMPtr&lt;nsIURI&gt; m_baseURL;</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-  // data retrieved from parsing the url: (Note the url could be a post from file or it could be in the url)</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  // data retrieved from parsing the url: (Note the url could be a post from</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+  // file or it could be in the url)</span>
<a href="#l8.104"></a><span id="l8.104">   nsCString m_toPart;</span>
<a href="#l8.105"></a><span id="l8.105">   nsCString m_ccPart;</span>
<a href="#l8.106"></a><span id="l8.106">   nsCString m_subjectPart;</span>
<a href="#l8.107"></a><span id="l8.107">   nsCString m_newsgroupPart;</span>
<a href="#l8.108"></a><span id="l8.108">   nsCString m_newsHostPart;</span>
<a href="#l8.109"></a><span id="l8.109">   nsCString m_referencePart;</span>
<a href="#l8.110"></a><span id="l8.110">   nsCString m_bodyPart;</span>
<a href="#l8.111"></a><span id="l8.111">   nsCString m_bccPart;</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineat">@@ -99,28 +95,27 @@ protected:</span>
<a href="#l8.113"></a><span id="l8.113">   nsCString m_htmlPart;</span>
<a href="#l8.114"></a><span id="l8.114">   nsCString m_organizationPart;</span>
<a href="#l8.115"></a><span id="l8.115">   nsCString m_replyToPart;</span>
<a href="#l8.116"></a><span id="l8.116">   nsCString m_priorityPart;</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118">   MSG_ComposeFormat mFormat;</span>
<a href="#l8.119"></a><span id="l8.119"> };</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-class nsSmtpUrl : public nsISmtpUrl, public nsMsgMailNewsUrl</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-{</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-public:</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+class nsSmtpUrl : public nsISmtpUrl, public nsMsgMailNewsUrl {</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+ public:</span>
<a href="#l8.126"></a><span id="l8.126">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l8.127"></a><span id="l8.127"> </span>
<a href="#l8.128"></a><span id="l8.128">   // From nsISmtpUrl</span>
<a href="#l8.129"></a><span id="l8.129">   NS_DECL_NSISMTPURL</span>
<a href="#l8.130"></a><span id="l8.130"> </span>
<a href="#l8.131"></a><span id="l8.131">   // nsSmtpUrl</span>
<a href="#l8.132"></a><span id="l8.132">   nsSmtpUrl();</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-protected:</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+ protected:</span>
<a href="#l8.136"></a><span id="l8.136">   virtual ~nsSmtpUrl();</span>
<a href="#l8.137"></a><span id="l8.137"> </span>
<a href="#l8.138"></a><span id="l8.138">   // data retrieved from parsing the url: (Note the url could be a post from</span>
<a href="#l8.139"></a><span id="l8.139">   // file or it could be in the url)</span>
<a href="#l8.140"></a><span id="l8.140">   nsCString m_toPart;</span>
<a href="#l8.141"></a><span id="l8.141">   nsCString m_fromPart;</span>
<a href="#l8.142"></a><span id="l8.142"> </span>
<a href="#l8.143"></a><span id="l8.143">   bool m_isPostMessage;</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineat">@@ -134,12 +129,12 @@ protected:</span>
<a href="#l8.145"></a><span id="l8.145">   nsCOMPtr&lt;nsIPrompt&gt; m_netPrompt;</span>
<a href="#l8.146"></a><span id="l8.146">   nsCOMPtr&lt;nsIAuthPrompt&gt; m_netAuthPrompt;</span>
<a href="#l8.147"></a><span id="l8.147">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; m_callbacks;</span>
<a href="#l8.148"></a><span id="l8.148">   nsCOMPtr&lt;nsISmtpServer&gt; m_smtpServer;</span>
<a href="#l8.149"></a><span id="l8.149"> </span>
<a href="#l8.150"></a><span id="l8.150">   // it is possible to encode the message to parse in the form of a url.</span>
<a href="#l8.151"></a><span id="l8.151">   // This function is used to decompose the search and path part into the bare</span>
<a href="#l8.152"></a><span id="l8.152">   // message components (to, fcc, bcc, etc.)</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-  nsresult ParseMessageToPost(char * searchPart);</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  nsresult ParseMessageToPost(char *searchPart);</span>
<a href="#l8.155"></a><span id="l8.155"> };</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-#endif // nsSmtpUrl_h__</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+#endif  // nsSmtpUrl_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsURLFetcher.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-#include &quot;msgCore.h&quot; // for pre-compiled headers</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+#include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &lt;stdio.h&gt;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nscore.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> #include &quot;nsIFactory.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #include &quot;nsISupports.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> #include &quot;prmem.h&quot;</span>
<a href="#l9.20"></a><span id="l9.20"> #include &quot;plstr.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineat">@@ -25,507 +25,446 @@</span>
<a href="#l9.22"></a><span id="l9.22"> #include &quot;nsMsgAttachmentHandler.h&quot;</span>
<a href="#l9.23"></a><span id="l9.23"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l9.24"></a><span id="l9.24"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l9.25"></a><span id="l9.25"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l9.26"></a><span id="l9.26"> #include &quot;nsIMsgProgress.h&quot;</span>
<a href="#l9.27"></a><span id="l9.27"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.28"></a><span id="l9.28"> #include &quot;mozilla/Components.h&quot;</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-NS_IMPL_ISUPPORTS(nsURLFetcher,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-                   nsIURLFetcher,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-                   nsIStreamListener,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-                   nsIRequestObserver,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-                   nsIURIContentListener,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-                   nsIInterfaceRequestor,</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-                   nsIWebProgressListener,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-                   nsISupportsWeakReference)</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+NS_IMPL_ISUPPORTS(nsURLFetcher, nsIURLFetcher, nsIStreamListener,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                  nsIRequestObserver, nsIURIContentListener,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                  nsIInterfaceRequestor, nsIWebProgressListener,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44"> /*</span>
<a href="#l9.45"></a><span id="l9.45">  * Inherited methods for nsMimeConverter</span>
<a href="#l9.46"></a><span id="l9.46">  */</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-nsURLFetcher::nsURLFetcher()</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-{</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+nsURLFetcher::nsURLFetcher() {</span>
<a href="#l9.50"></a><span id="l9.50">   // Init member variables...</span>
<a href="#l9.51"></a><span id="l9.51">   mTotalWritten = 0;</span>
<a href="#l9.52"></a><span id="l9.52">   mBuffer = nullptr;</span>
<a href="#l9.53"></a><span id="l9.53">   mBufferSize = 0;</span>
<a href="#l9.54"></a><span id="l9.54">   mStillRunning = true;</span>
<a href="#l9.55"></a><span id="l9.55">   mCallback = nullptr;</span>
<a href="#l9.56"></a><span id="l9.56">   mOnStopRequestProcessed = false;</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-  mIsFile=false;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  mIsFile = false;</span>
<a href="#l9.59"></a><span id="l9.59">   nsURLFetcherStreamConsumer *consumer = new nsURLFetcherStreamConsumer(this);</span>
<a href="#l9.60"></a><span id="l9.60">   mConverter = consumer;</span>
<a href="#l9.61"></a><span id="l9.61"> }</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-nsURLFetcher::~nsURLFetcher()</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-{</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+nsURLFetcher::~nsURLFetcher() {</span>
<a href="#l9.66"></a><span id="l9.66">   mStillRunning = false;</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68">   PR_FREEIF(mBuffer);</span>
<a href="#l9.69"></a><span id="l9.69">   // Remove the DocShell as a listener of the old WebProgress...</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-  if (mLoadCookie)</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  if (mLoadCookie) {</span>
<a href="#l9.73"></a><span id="l9.73">     nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_QueryInterface(mLoadCookie));</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    if (webProgress)</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-      webProgress-&gt;RemoveProgressListener(this);</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+    if (webProgress) webProgress-&gt;RemoveProgressListener(this);</span>
<a href="#l9.78"></a><span id="l9.78">   }</span>
<a href="#l9.79"></a><span id="l9.79"> }</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-NS_IMETHODIMP nsURLFetcher::GetInterface(const nsIID &amp; aIID, void * *aInstancePtr)</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-{</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-   NS_ENSURE_ARG_POINTER(aInstancePtr);</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-   return QueryInterface(aIID, aInstancePtr);</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+NS_IMETHODIMP nsURLFetcher::GetInterface(const nsIID &amp;aIID,</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+                                         void **aInstancePtr) {</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aInstancePtr);</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  return QueryInterface(aIID, aInstancePtr);</span>
<a href="#l9.89"></a><span id="l9.89"> }</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91"> // nsIURIContentListener support</span>
<a href="#l9.92"></a><span id="l9.92"> NS_IMETHODIMP</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-nsURLFetcher::OnStartURIOpen(nsIURI* aURI, bool* aAbortOpen)</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-{</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-   return NS_OK;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-}</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+nsURLFetcher::OnStartURIOpen(nsIURI *aURI, bool *aAbortOpen) { return NS_OK; }</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99"> NS_IMETHODIMP</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-nsURLFetcher::IsPreferred(const char * aContentType,</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-                                char ** aDesiredContentType,</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-                                bool * aCanHandleContent)</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+nsURLFetcher::IsPreferred(const char *aContentType, char **aDesiredContentType,</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+                          bool *aCanHandleContent)</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106"> {</span>
<a href="#l9.107"></a><span id="l9.107">   return CanHandleContent(aContentType, true, aDesiredContentType,</span>
<a href="#l9.108"></a><span id="l9.108">                           aCanHandleContent);</span>
<a href="#l9.109"></a><span id="l9.109"> }</span>
<a href="#l9.110"></a><span id="l9.110"> </span>
<a href="#l9.111"></a><span id="l9.111"> NS_IMETHODIMP</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-nsURLFetcher::CanHandleContent(const char * aContentType,</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-                                bool aIsContentPreferred,</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-                                char ** aDesiredContentType,</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-                                bool * aCanHandleContent)</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+nsURLFetcher::CanHandleContent(const char *aContentType,</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+                               bool aIsContentPreferred,</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+                               char **aDesiredContentType,</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+                               bool *aCanHandleContent)</span>
<a href="#l9.120"></a><span id="l9.120"> </span>
<a href="#l9.121"></a><span id="l9.121"> {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-    if (!mIsFile &amp;&amp; PL_strcasecmp(aContentType, MESSAGE_RFC822) == 0)</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-      *aDesiredContentType = strdup(&quot;text/html&quot;);</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  if (!mIsFile &amp;&amp; PL_strcasecmp(aContentType, MESSAGE_RFC822) == 0)</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    *aDesiredContentType = strdup(&quot;text/html&quot;);</span>
<a href="#l9.126"></a><span id="l9.126"> </span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-    // since we explicitly loaded the url, we always want to handle it!</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    *aCanHandleContent = true;</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  // since we explicitly loaded the url, we always want to handle it!</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  *aCanHandleContent = true;</span>
<a href="#l9.131"></a><span id="l9.131">   return NS_OK;</span>
<a href="#l9.132"></a><span id="l9.132"> }</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134"> NS_IMETHODIMP</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-nsURLFetcher::DoContent(const nsACString&amp; aContentType,</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-                      bool aIsContentPreferred,</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-                      nsIRequest *request,</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineminus">-                      nsIStreamListener ** aContentHandler,</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineminus">-                      bool * aAbortProcess)</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-{</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+nsURLFetcher::DoContent(const nsACString &amp;aContentType,</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+                        bool aIsContentPreferred, nsIRequest *request,</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+                        nsIStreamListener **aContentHandler,</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+                        bool *aAbortProcess) {</span>
<a href="#l9.145"></a><span id="l9.145">   nsresult rv = NS_OK;</span>
<a href="#l9.146"></a><span id="l9.146"> </span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-  if (aAbortProcess)</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-    *aAbortProcess = false;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineminus">-  QueryInterface(NS_GET_IID(nsIStreamListener), (void **) aContentHandler);</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+  if (aAbortProcess) *aAbortProcess = false;</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+  QueryInterface(NS_GET_IID(nsIStreamListener), (void **)aContentHandler);</span>
<a href="#l9.152"></a><span id="l9.152"> </span>
<a href="#l9.153"></a><span id="l9.153">   /*</span>
<a href="#l9.154"></a><span id="l9.154">     Check the content-type to see if we need to insert a converter</span>
<a href="#l9.155"></a><span id="l9.155">   */</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-  if (PL_strcasecmp(PromiseFlatCString(aContentType).get(), UNKNOWN_CONTENT_TYPE) == 0 ||</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-      PL_strcasecmp(PromiseFlatCString(aContentType).get(), MULTIPART_MIXED_REPLACE) == 0 ||</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-      PL_strcasecmp(PromiseFlatCString(aContentType).get(), MULTIPART_MIXED) == 0 ||</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-      PL_strcasecmp(PromiseFlatCString(aContentType).get(), MULTIPART_BYTERANGES) == 0)</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-  {</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+  if (PL_strcasecmp(PromiseFlatCString(aContentType).get(),</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+                    UNKNOWN_CONTENT_TYPE) == 0 ||</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+      PL_strcasecmp(PromiseFlatCString(aContentType).get(),</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+                    MULTIPART_MIXED_REPLACE) == 0 ||</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+      PL_strcasecmp(PromiseFlatCString(aContentType).get(), MULTIPART_MIXED) ==</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+          0 ||</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+      PL_strcasecmp(PromiseFlatCString(aContentType).get(),</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+                    MULTIPART_BYTERANGES) == 0) {</span>
<a href="#l9.169"></a><span id="l9.169">     rv = InsertConverter(PromiseFlatCString(aContentType).get());</span>
<a href="#l9.170"></a><span id="l9.170">     if (NS_SUCCEEDED(rv))</span>
<a href="#l9.171"></a><span id="l9.171">       mConverterContentType = PromiseFlatCString(aContentType).get();</span>
<a href="#l9.172"></a><span id="l9.172">   }</span>
<a href="#l9.173"></a><span id="l9.173"> </span>
<a href="#l9.174"></a><span id="l9.174">   return rv;</span>
<a href="#l9.175"></a><span id="l9.175"> }</span>
<a href="#l9.176"></a><span id="l9.176"> </span>
<a href="#l9.177"></a><span id="l9.177"> NS_IMETHODIMP</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-nsURLFetcher::GetParentContentListener(nsIURIContentListener** aParent)</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-{</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+nsURLFetcher::GetParentContentListener(nsIURIContentListener **aParent) {</span>
<a href="#l9.181"></a><span id="l9.181">   *aParent = nullptr;</span>
<a href="#l9.182"></a><span id="l9.182">   return NS_OK;</span>
<a href="#l9.183"></a><span id="l9.183"> }</span>
<a href="#l9.184"></a><span id="l9.184"> </span>
<a href="#l9.185"></a><span id="l9.185"> NS_IMETHODIMP</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-nsURLFetcher::SetParentContentListener(nsIURIContentListener* aParent)</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-{</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+nsURLFetcher::SetParentContentListener(nsIURIContentListener *aParent) {</span>
<a href="#l9.189"></a><span id="l9.189">   return NS_OK;</span>
<a href="#l9.190"></a><span id="l9.190"> }</span>
<a href="#l9.191"></a><span id="l9.191"> </span>
<a href="#l9.192"></a><span id="l9.192"> NS_IMETHODIMP</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-nsURLFetcher::GetLoadCookie(nsISupports ** aLoadCookie)</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-{</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+nsURLFetcher::GetLoadCookie(nsISupports **aLoadCookie) {</span>
<a href="#l9.196"></a><span id="l9.196">   NS_IF_ADDREF(*aLoadCookie = mLoadCookie);</span>
<a href="#l9.197"></a><span id="l9.197">   return NS_OK;</span>
<a href="#l9.198"></a><span id="l9.198"> }</span>
<a href="#l9.199"></a><span id="l9.199"> </span>
<a href="#l9.200"></a><span id="l9.200"> NS_IMETHODIMP</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-nsURLFetcher::SetLoadCookie(nsISupports * aLoadCookie)</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-{</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+nsURLFetcher::SetLoadCookie(nsISupports *aLoadCookie) {</span>
<a href="#l9.204"></a><span id="l9.204">   // Remove the DocShell as a listener of the old WebProgress...</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-  if (mLoadCookie)</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-  {</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+  if (mLoadCookie) {</span>
<a href="#l9.208"></a><span id="l9.208">     nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_QueryInterface(mLoadCookie));</span>
<a href="#l9.209"></a><span id="l9.209"> </span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-    if (webProgress)</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-      webProgress-&gt;RemoveProgressListener(this);</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+    if (webProgress) webProgress-&gt;RemoveProgressListener(this);</span>
<a href="#l9.213"></a><span id="l9.213">   }</span>
<a href="#l9.214"></a><span id="l9.214"> </span>
<a href="#l9.215"></a><span id="l9.215">   mLoadCookie = aLoadCookie;</span>
<a href="#l9.216"></a><span id="l9.216"> </span>
<a href="#l9.217"></a><span id="l9.217">   // Add the DocShell as a listener to the new WebProgress...</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-  if (mLoadCookie)</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineminus">-  {</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+  if (mLoadCookie) {</span>
<a href="#l9.221"></a><span id="l9.221">     nsCOMPtr&lt;nsIWebProgress&gt; webProgress(do_QueryInterface(mLoadCookie));</span>
<a href="#l9.222"></a><span id="l9.222"> </span>
<a href="#l9.223"></a><span id="l9.223">     if (webProgress)</span>
<a href="#l9.224"></a><span id="l9.224">       webProgress-&gt;AddProgressListener(this, nsIWebProgress::NOTIFY_STATE_ALL);</span>
<a href="#l9.225"></a><span id="l9.225">   }</span>
<a href="#l9.226"></a><span id="l9.226">   return NS_OK;</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-</span>
<a href="#l9.228"></a><span id="l9.228"> }</span>
<a href="#l9.229"></a><span id="l9.229"> </span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-nsresult</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-nsURLFetcher::StillRunning(bool *running)</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-{</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+nsresult nsURLFetcher::StillRunning(bool *running) {</span>
<a href="#l9.234"></a><span id="l9.234">   *running = mStillRunning;</span>
<a href="#l9.235"></a><span id="l9.235">   return NS_OK;</span>
<a href="#l9.236"></a><span id="l9.236"> }</span>
<a href="#l9.237"></a><span id="l9.237"> </span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-</span>
<a href="#l9.239"></a><span id="l9.239"> // Methods for nsIStreamListener...</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineminus">-nsresult</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineminus">-nsURLFetcher::OnDataAvailable(nsIRequest *request, nsIInputStream *aIStream,</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineminus">-                              uint64_t sourceOffset, uint32_t aLength)</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineminus">-{</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+nsresult nsURLFetcher::OnDataAvailable(nsIRequest *request,</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+                                       nsIInputStream *aIStream,</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+                                       uint64_t sourceOffset,</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+                                       uint32_t aLength) {</span>
<a href="#l9.248"></a><span id="l9.248">   /* let our converter or consumer process the data */</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-  if (!mConverter)</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+  if (!mConverter) return NS_ERROR_FAILURE;</span>
<a href="#l9.252"></a><span id="l9.252"> </span>
<a href="#l9.253"></a><span id="l9.253">   return mConverter-&gt;OnDataAvailable(request, aIStream, sourceOffset, aLength);</span>
<a href="#l9.254"></a><span id="l9.254"> }</span>
<a href="#l9.255"></a><span id="l9.255"> </span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-</span>
<a href="#l9.257"></a><span id="l9.257"> // Methods for nsIStreamObserver</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-nsresult</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-nsURLFetcher::OnStartRequest(nsIRequest *request)</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-{</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+nsresult nsURLFetcher::OnStartRequest(nsIRequest *request) {</span>
<a href="#l9.262"></a><span id="l9.262">   /* check if the user has canceld the operation */</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-  if (mTagData)</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-  {</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+  if (mTagData) {</span>
<a href="#l9.266"></a><span id="l9.266">     nsCOMPtr&lt;nsIMsgSend&gt; sendPtr;</span>
<a href="#l9.267"></a><span id="l9.267">     mTagData-&gt;GetMimeDeliveryState(getter_AddRefs(sendPtr));</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-    if (sendPtr)</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-    {</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+    if (sendPtr) {</span>
<a href="#l9.271"></a><span id="l9.271">       nsCOMPtr&lt;nsIMsgProgress&gt; progress;</span>
<a href="#l9.272"></a><span id="l9.272">       sendPtr-&gt;GetProgress(getter_AddRefs(progress));</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-      if (progress)</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-      {</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+      if (progress) {</span>
<a href="#l9.276"></a><span id="l9.276">         bool cancel = false;</span>
<a href="#l9.277"></a><span id="l9.277">         progress-&gt;GetProcessCanceledByUser(&amp;cancel);</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-        if (cancel)</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-          return request-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+        if (cancel) return request-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l9.281"></a><span id="l9.281">       }</span>
<a href="#l9.282"></a><span id="l9.282">     }</span>
<a href="#l9.283"></a><span id="l9.283">     mTagData-&gt;mRequest = request;</span>
<a href="#l9.284"></a><span id="l9.284">   }</span>
<a href="#l9.285"></a><span id="l9.285"> </span>
<a href="#l9.286"></a><span id="l9.286">   /* call our converter or consumer */</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-  if (mConverter)</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-    return mConverter-&gt;OnStartRequest(request);</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+  if (mConverter) return mConverter-&gt;OnStartRequest(request);</span>
<a href="#l9.290"></a><span id="l9.290"> </span>
<a href="#l9.291"></a><span id="l9.291">   return NS_OK;</span>
<a href="#l9.292"></a><span id="l9.292"> }</span>
<a href="#l9.293"></a><span id="l9.293"> </span>
<a href="#l9.294"></a><span id="l9.294"> NS_IMETHODIMP</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineminus">-nsURLFetcher::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineminus">-{</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineminus">-  // it's possible we could get in here from the channel calling us with an OnStopRequest and from our</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineminus">-  // onStatusChange method (in the case of an error). So we should protect against this to make sure we</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineminus">-  // don't process the on stop request twice...</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineplus">+nsURLFetcher::OnStopRequest(nsIRequest *request, nsresult aStatus) {</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+  // it's possible we could get in here from the channel calling us with an</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+  // OnStopRequest and from our onStatusChange method (in the case of an error).</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+  // So we should protect against this to make sure we don't process the on stop</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+  // request twice...</span>
<a href="#l9.305"></a><span id="l9.305"> </span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-  if (mOnStopRequestProcessed)</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+  if (mOnStopRequestProcessed) return NS_OK;</span>
<a href="#l9.309"></a><span id="l9.309"> </span>
<a href="#l9.310"></a><span id="l9.310">   mOnStopRequestProcessed = true;</span>
<a href="#l9.311"></a><span id="l9.311"> </span>
<a href="#l9.312"></a><span id="l9.312">   /* first, call our converter or consumer */</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-  if (mConverter)</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineminus">-    (void) mConverter-&gt;OnStopRequest(request, aStatus);</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+  if (mConverter) (void)mConverter-&gt;OnStopRequest(request, aStatus);</span>
<a href="#l9.316"></a><span id="l9.316"> </span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-  if (mTagData)</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-    mTagData-&gt;mRequest = nullptr;</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+  if (mTagData) mTagData-&gt;mRequest = nullptr;</span>
<a href="#l9.320"></a><span id="l9.320"> </span>
<a href="#l9.321"></a><span id="l9.321">   //</span>
<a href="#l9.322"></a><span id="l9.322">   // Now complete the stream!</span>
<a href="#l9.323"></a><span id="l9.323">   //</span>
<a href="#l9.324"></a><span id="l9.324">   mStillRunning = false;</span>
<a href="#l9.325"></a><span id="l9.325"> </span>
<a href="#l9.326"></a><span id="l9.326">   // time to close the output stream...</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-  if (mOutStream)</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-  {</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+  if (mOutStream) {</span>
<a href="#l9.330"></a><span id="l9.330">     mOutStream-&gt;Close();</span>
<a href="#l9.331"></a><span id="l9.331">     mOutStream = nullptr;</span>
<a href="#l9.332"></a><span id="l9.332"> </span>
<a href="#l9.333"></a><span id="l9.333" class="difflineminus">-    /* In case of multipart/x-mixed-replace, we need to truncate the file to the current part size */</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-    if (MsgLowerCaseEqualsLiteral(mConverterContentType, MULTIPART_MIXED_REPLACE))</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-    {</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+    /* In case of multipart/x-mixed-replace, we need to truncate the file to the</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+     * current part size */</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+    if (MsgLowerCaseEqualsLiteral(mConverterContentType,</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+                                  MULTIPART_MIXED_REPLACE)) {</span>
<a href="#l9.340"></a><span id="l9.340">       mLocalFile-&gt;SetFileSize(mTotalWritten);</span>
<a href="#l9.341"></a><span id="l9.341">     }</span>
<a href="#l9.342"></a><span id="l9.342">   }</span>
<a href="#l9.343"></a><span id="l9.343"> </span>
<a href="#l9.344"></a><span id="l9.344">   // Now if there is a callback, we need to call it...</span>
<a href="#l9.345"></a><span id="l9.345">   if (mCallback)</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-    mCallback (aStatus, mContentType, mCharset, mTotalWritten, nullptr, mTagData);</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+    mCallback(aStatus, mContentType, mCharset, mTotalWritten, nullptr,</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+              mTagData);</span>
<a href="#l9.349"></a><span id="l9.349"> </span>
<a href="#l9.350"></a><span id="l9.350">   // Time to return...</span>
<a href="#l9.351"></a><span id="l9.351">   return NS_OK;</span>
<a href="#l9.352"></a><span id="l9.352"> }</span>
<a href="#l9.353"></a><span id="l9.353"> </span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-nsresult</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-nsURLFetcher::Initialize(nsIFile *localFile,</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-                         nsIOutputStream *outputStream,</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-                         nsAttachSaveCompletionCallback cb,</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-                         nsMsgAttachmentHandler *tagData)</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-{</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-  if (!outputStream || !localFile)</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+nsresult nsURLFetcher::Initialize(nsIFile *localFile,</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+                                  nsIOutputStream *outputStream,</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+                                  nsAttachSaveCompletionCallback cb,</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+                                  nsMsgAttachmentHandler *tagData) {</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+  if (!outputStream || !localFile) return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.367"></a><span id="l9.367"> </span>
<a href="#l9.368"></a><span id="l9.368">   mOutStream = outputStream;</span>
<a href="#l9.369"></a><span id="l9.369">   mLocalFile = localFile;</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-  mCallback = cb;     //JFD: Please, no more callback, use a listener...</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+  mCallback = cb;  // JFD: Please, no more callback, use a listener...</span>
<a href="#l9.372"></a><span id="l9.372">   mTagData = tagData;</span>
<a href="#l9.373"></a><span id="l9.373">   return NS_OK;</span>
<a href="#l9.374"></a><span id="l9.374"> }</span>
<a href="#l9.375"></a><span id="l9.375"> </span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-nsresult</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-nsURLFetcher::FireURLRequest(nsIURI *aURL, nsIFile *localFile, nsIOutputStream *outputStream,</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-                             nsAttachSaveCompletionCallback cb, nsMsgAttachmentHandler *tagData)</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-{</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+nsresult nsURLFetcher::FireURLRequest(nsIURI *aURL, nsIFile *localFile,</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+                                      nsIOutputStream *outputStream,</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+                                      nsAttachSaveCompletionCallback cb,</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineplus">+                                      nsMsgAttachmentHandler *tagData) {</span>
<a href="#l9.384"></a><span id="l9.384">   nsresult rv;</span>
<a href="#l9.385"></a><span id="l9.385"> </span>
<a href="#l9.386"></a><span id="l9.386">   rv = Initialize(localFile, outputStream, cb, tagData);</span>
<a href="#l9.387"></a><span id="l9.387">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.388"></a><span id="l9.388"> </span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-  //check to see if aURL is a local file or not</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+  // check to see if aURL is a local file or not</span>
<a href="#l9.391"></a><span id="l9.391">   aURL-&gt;SchemeIs(&quot;file&quot;, &amp;mIsFile);</span>
<a href="#l9.392"></a><span id="l9.392"> </span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-  // we're about to fire a new url request so make sure the on stop request flag is cleared...</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineplus">+  // we're about to fire a new url request so make sure the on stop request flag</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+  // is cleared...</span>
<a href="#l9.396"></a><span id="l9.396">   mOnStopRequestProcessed = false;</span>
<a href="#l9.397"></a><span id="l9.397"> </span>
<a href="#l9.398"></a><span id="l9.398">   // let's try uri dispatching...</span>
<a href="#l9.399"></a><span id="l9.399">   nsCOMPtr&lt;nsIURILoader&gt; pURILoader = mozilla::components::URILoader::Service();</span>
<a href="#l9.400"></a><span id="l9.400">   NS_ENSURE_TRUE(pURILoader, NS_ERROR_FAILURE);</span>
<a href="#l9.401"></a><span id="l9.401"> </span>
<a href="#l9.402"></a><span id="l9.402">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-  rv = NS_NewChannel(getter_AddRefs(channel),</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-                     aURL,</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+  rv = NS_NewChannel(getter_AddRefs(channel), aURL,</span>
<a href="#l9.406"></a><span id="l9.406">                      nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l9.407"></a><span id="l9.407">                      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l9.408"></a><span id="l9.408">                      nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-                     nullptr, // aCookieSettings</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-                     nullptr, // aPerformanceStorage</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-                     nullptr, // aLoadGroup</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-                     this); // aCallbacks</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+                     nullptr,  // aCookieSettings</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+                     nullptr,  // aPerformanceStorage</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+                     nullptr,  // aLoadGroup</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+                     this);    // aCallbacks</span>
<a href="#l9.417"></a><span id="l9.417">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.418"></a><span id="l9.418"> </span>
<a href="#l9.419"></a><span id="l9.419">   return pURILoader-&gt;OpenURI(channel, false, this);</span>
<a href="#l9.420"></a><span id="l9.420"> }</span>
<a href="#l9.421"></a><span id="l9.421"> </span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-nsresult</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-nsURLFetcher::InsertConverter(const char * aContentType)</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-{</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+nsresult nsURLFetcher::InsertConverter(const char *aContentType) {</span>
<a href="#l9.426"></a><span id="l9.426">   nsresult rv;</span>
<a href="#l9.427"></a><span id="l9.427"> </span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-  nsCOMPtr&lt;nsIStreamConverterService&gt; convServ(do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv));</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-  {</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+  nsCOMPtr&lt;nsIStreamConverterService&gt; convServ(</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+      do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv));</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.434"></a><span id="l9.434">     nsCOMPtr&lt;nsIStreamListener&gt; toListener(mConverter);</span>
<a href="#l9.435"></a><span id="l9.435">     nsCOMPtr&lt;nsIStreamListener&gt; fromListener;</span>
<a href="#l9.436"></a><span id="l9.436"> </span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-    rv = convServ-&gt;AsyncConvertData(aContentType,</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-                                    &quot;*/*&quot;,</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-                                    toListener,</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-                                    nullptr,</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+    rv = convServ-&gt;AsyncConvertData(aContentType, &quot;*/*&quot;, toListener, nullptr,</span>
<a href="#l9.442"></a><span id="l9.442">                                     getter_AddRefs(fromListener));</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineminus">-      mConverter = fromListener;</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+    if (NS_SUCCEEDED(rv)) mConverter = fromListener;</span>
<a href="#l9.446"></a><span id="l9.446">   }</span>
<a href="#l9.447"></a><span id="l9.447"> </span>
<a href="#l9.448"></a><span id="l9.448">   return rv;</span>
<a href="#l9.449"></a><span id="l9.449"> }</span>
<a href="#l9.450"></a><span id="l9.450"> </span>
<a href="#l9.451"></a><span id="l9.451"> // web progress listener implementation</span>
<a href="#l9.452"></a><span id="l9.452"> </span>
<a href="#l9.453"></a><span id="l9.453"> NS_IMETHODIMP</span>
<a href="#l9.454"></a><span id="l9.454"> nsURLFetcher::OnProgressChange(nsIWebProgress *aProgress, nsIRequest *aRequest,</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineminus">-                             int32_t aCurSelfProgress, int32_t aMaxSelfProgress,</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-                             int32_t aCurTotalProgress, int32_t aMaxTotalProgress)</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-{</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+                               int32_t aCurSelfProgress,</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+                               int32_t aMaxSelfProgress,</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+                               int32_t aCurTotalProgress,</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+                               int32_t aMaxTotalProgress) {</span>
<a href="#l9.462"></a><span id="l9.462">   return NS_OK;</span>
<a href="#l9.463"></a><span id="l9.463"> }</span>
<a href="#l9.464"></a><span id="l9.464"> </span>
<a href="#l9.465"></a><span id="l9.465"> NS_IMETHODIMP</span>
<a href="#l9.466"></a><span id="l9.466"> nsURLFetcher::OnStateChange(nsIWebProgress *aProgress, nsIRequest *aRequest,</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-                          uint32_t aStateFlags, nsresult aStatus)</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-{</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-  // all we care about is the case where an error occurred (as in we were unable to locate the</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-  // the url....</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+                            uint32_t aStateFlags, nsresult aStatus) {</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+  // all we care about is the case where an error occurred (as in we were unable</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+  // to locate the the url....</span>
<a href="#l9.474"></a><span id="l9.474"> </span>
<a href="#l9.475"></a><span id="l9.475" class="difflineminus">-  if (NS_FAILED(aStatus))</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineminus">-    OnStopRequest(aRequest, aStatus);</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+  if (NS_FAILED(aStatus)) OnStopRequest(aRequest, aStatus);</span>
<a href="#l9.478"></a><span id="l9.478"> </span>
<a href="#l9.479"></a><span id="l9.479">   return NS_OK;</span>
<a href="#l9.480"></a><span id="l9.480"> }</span>
<a href="#l9.481"></a><span id="l9.481"> </span>
<a href="#l9.482"></a><span id="l9.482"> NS_IMETHODIMP</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineminus">-nsURLFetcher::OnLocationChange(nsIWebProgress* aWebProgress,</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineminus">-                               nsIRequest* aRequest,</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-                               nsIURI *aURI,</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineminus">-                               uint32_t aFlags)</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineminus">-{</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+nsURLFetcher::OnLocationChange(nsIWebProgress *aWebProgress,</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+                               nsIRequest *aRequest, nsIURI *aURI,</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+                               uint32_t aFlags) {</span>
<a href="#l9.491"></a><span id="l9.491">   MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l9.492"></a><span id="l9.492">   return NS_OK;</span>
<a href="#l9.493"></a><span id="l9.493"> }</span>
<a href="#l9.494"></a><span id="l9.494"> </span>
<a href="#l9.495"></a><span id="l9.495"> NS_IMETHODIMP</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-nsURLFetcher::OnStatusChange(nsIWebProgress* aWebProgress,</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-                             nsIRequest* aRequest,</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-                             nsresult aStatus,</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineminus">-                             const char16_t* aMessage)</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineminus">-{</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineplus">+nsURLFetcher::OnStatusChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest,</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineplus">+                             nsresult aStatus, const char16_t *aMessage) {</span>
<a href="#l9.503"></a><span id="l9.503">   MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l9.504"></a><span id="l9.504">   return NS_OK;</span>
<a href="#l9.505"></a><span id="l9.505"> }</span>
<a href="#l9.506"></a><span id="l9.506"> </span>
<a href="#l9.507"></a><span id="l9.507"> NS_IMETHODIMP</span>
<a href="#l9.508"></a><span id="l9.508"> nsURLFetcher::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-                               nsIRequest *aRequest,</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-                               uint32_t state)</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-{</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+                               nsIRequest *aRequest, uint32_t state) {</span>
<a href="#l9.513"></a><span id="l9.513">   MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l9.514"></a><span id="l9.514">   return NS_OK;</span>
<a href="#l9.515"></a><span id="l9.515"> }</span>
<a href="#l9.516"></a><span id="l9.516"> </span>
<a href="#l9.517"></a><span id="l9.517"> NS_IMETHODIMP</span>
<a href="#l9.518"></a><span id="l9.518"> nsURLFetcher::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineminus">-                                     nsIRequest *aRequest, uint32_t aEvent)</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-{</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+                                     nsIRequest *aRequest, uint32_t aEvent) {</span>
<a href="#l9.522"></a><span id="l9.522">   MOZ_ASSERT_UNREACHABLE(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l9.523"></a><span id="l9.523">   return NS_OK;</span>
<a href="#l9.524"></a><span id="l9.524"> }</span>
<a href="#l9.525"></a><span id="l9.525"> </span>
<a href="#l9.526"></a><span id="l9.526"> /**</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">- * Stream consumer used for handling special content type like multipart/x-mixed-replace</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+ * Stream consumer used for handling special content type like</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+ * multipart/x-mixed-replace</span>
<a href="#l9.530"></a><span id="l9.530">  */</span>
<a href="#l9.531"></a><span id="l9.531"> </span>
<a href="#l9.532"></a><span id="l9.532" class="difflineminus">-NS_IMPL_ISUPPORTS(nsURLFetcherStreamConsumer, nsIStreamListener, nsIRequestObserver)</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+NS_IMPL_ISUPPORTS(nsURLFetcherStreamConsumer, nsIStreamListener,</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+                  nsIRequestObserver)</span>
<a href="#l9.535"></a><span id="l9.535"> </span>
<a href="#l9.536"></a><span id="l9.536" class="difflineminus">-nsURLFetcherStreamConsumer::nsURLFetcherStreamConsumer(nsURLFetcher* urlFetcher) :</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineminus">-  mURLFetcher(urlFetcher)</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineminus">-{</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-}</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+nsURLFetcherStreamConsumer::nsURLFetcherStreamConsumer(nsURLFetcher *urlFetcher)</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+    : mURLFetcher(urlFetcher) {}</span>
<a href="#l9.542"></a><span id="l9.542"> </span>
<a href="#l9.543"></a><span id="l9.543" class="difflineminus">-nsURLFetcherStreamConsumer::~nsURLFetcherStreamConsumer()</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-{</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-}</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+nsURLFetcherStreamConsumer::~nsURLFetcherStreamConsumer() {}</span>
<a href="#l9.547"></a><span id="l9.547"> </span>
<a href="#l9.548"></a><span id="l9.548"> /** nsIRequestObserver methods **/</span>
<a href="#l9.549"></a><span id="l9.549"> </span>
<a href="#l9.550"></a><span id="l9.550"> /* void onStartRequest (in nsIRequest request); */</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-NS_IMETHODIMP nsURLFetcherStreamConsumer::OnStartRequest(nsIRequest *aRequest)</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-{</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-  if (!mURLFetcher || !mURLFetcher-&gt;mOutStream)</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineplus">+NS_IMETHODIMP nsURLFetcherStreamConsumer::OnStartRequest(nsIRequest *aRequest) {</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+  if (!mURLFetcher || !mURLFetcher-&gt;mOutStream) return NS_ERROR_FAILURE;</span>
<a href="#l9.557"></a><span id="l9.557"> </span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-  /* In case of multipart/x-mixed-replace, we need to erase the output file content */</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-  if (MsgLowerCaseEqualsLiteral(mURLFetcher-&gt;mConverterContentType, MULTIPART_MIXED_REPLACE))</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-  {</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineminus">-    nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(mURLFetcher-&gt;mOutStream);</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineminus">-    if (seekStream)</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineminus">-      seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+  /* In case of multipart/x-mixed-replace, we need to erase the output file</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+   * content */</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(mURLFetcher-&gt;mConverterContentType,</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+                                MULTIPART_MIXED_REPLACE)) {</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+    nsCOMPtr&lt;nsISeekableStream&gt; seekStream =</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+        do_QueryInterface(mURLFetcher-&gt;mOutStream);</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+    if (seekStream) seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l9.571"></a><span id="l9.571">     mURLFetcher-&gt;mTotalWritten = 0;</span>
<a href="#l9.572"></a><span id="l9.572">   }</span>
<a href="#l9.573"></a><span id="l9.573"> </span>
<a href="#l9.574"></a><span id="l9.574">   return NS_OK;</span>
<a href="#l9.575"></a><span id="l9.575"> }</span>
<a href="#l9.576"></a><span id="l9.576"> </span>
<a href="#l9.577"></a><span id="l9.577"> /* void onStopRequest (in nsIRequest request, in nsresult status); */</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineminus">-NS_IMETHODIMP nsURLFetcherStreamConsumer::OnStopRequest(nsIRequest *aRequest, nsresult status)</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineminus">-{</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineminus">-  if (!mURLFetcher)</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineplus">+NS_IMETHODIMP nsURLFetcherStreamConsumer::OnStopRequest(nsIRequest *aRequest,</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+                                                        nsresult status) {</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+  if (!mURLFetcher) return NS_ERROR_FAILURE;</span>
<a href="#l9.585"></a><span id="l9.585"> </span>
<a href="#l9.586"></a><span id="l9.586">   // Check the content type!</span>
<a href="#l9.587"></a><span id="l9.587">   nsAutoCString contentType;</span>
<a href="#l9.588"></a><span id="l9.588">   nsAutoCString charset;</span>
<a href="#l9.589"></a><span id="l9.589"> </span>
<a href="#l9.590"></a><span id="l9.590">   nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(aRequest);</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-  if(!channel) return NS_ERROR_FAILURE;</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+  if (!channel) return NS_ERROR_FAILURE;</span>
<a href="#l9.593"></a><span id="l9.593"> </span>
<a href="#l9.594"></a><span id="l9.594">   if (NS_SUCCEEDED(channel-&gt;GetContentType(contentType)) &amp;&amp;</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineminus">-      !contentType.EqualsLiteral(UNKNOWN_CONTENT_TYPE))</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-  {</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+      !contentType.EqualsLiteral(UNKNOWN_CONTENT_TYPE)) {</span>
<a href="#l9.598"></a><span id="l9.598">     nsAutoCString uriSpec;</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineminus">-    nsCOMPtr &lt;nsIURI&gt; channelURI;</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; channelURI;</span>
<a href="#l9.601"></a><span id="l9.601">     channel-&gt;GetURI(getter_AddRefs(channelURI));</span>
<a href="#l9.602"></a><span id="l9.602">     nsresult rv = channelURI-&gt;GetSpec(uriSpec);</span>
<a href="#l9.603"></a><span id="l9.603">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.604"></a><span id="l9.604">     if (uriSpec.Find(&quot;&amp;realtype=message/rfc822&quot;) &gt;= 0)</span>
<a href="#l9.605"></a><span id="l9.605">       mURLFetcher-&gt;mContentType = MESSAGE_RFC822;</span>
<a href="#l9.606"></a><span id="l9.606">     else</span>
<a href="#l9.607"></a><span id="l9.607">       mURLFetcher-&gt;mContentType = contentType;</span>
<a href="#l9.608"></a><span id="l9.608">   }</span>
<a href="#l9.609"></a><span id="l9.609"> </span>
<a href="#l9.610"></a><span id="l9.610" class="difflineminus">-  if (NS_SUCCEEDED(channel-&gt;GetContentCharset(charset)) &amp;&amp; !charset.IsEmpty())</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-  {</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+  if (NS_SUCCEEDED(channel-&gt;GetContentCharset(charset)) &amp;&amp; !charset.IsEmpty()) {</span>
<a href="#l9.613"></a><span id="l9.613">     mURLFetcher-&gt;mCharset = charset;</span>
<a href="#l9.614"></a><span id="l9.614">   }</span>
<a href="#l9.615"></a><span id="l9.615"> </span>
<a href="#l9.616"></a><span id="l9.616">   return NS_OK;</span>
<a href="#l9.617"></a><span id="l9.617"> }</span>
<a href="#l9.618"></a><span id="l9.618"> </span>
<a href="#l9.619"></a><span id="l9.619"> /** nsIStreamListener methods **/</span>
<a href="#l9.620"></a><span id="l9.620"> </span>
<a href="#l9.621"></a><span id="l9.621" class="difflineminus">-/* void onDataAvailable (in nsIRequest request, in nsIInputStream inStr, in unsigned long long sourceOffset, in unsigned long count); */</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineminus">-NS_IMETHODIMP nsURLFetcherStreamConsumer::OnDataAvailable(nsIRequest *aRequest, nsIInputStream *inStr, uint64_t sourceOffset, uint32_t count)</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineminus">-{</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineminus">-  uint32_t        readLen = count;</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-  uint32_t        wroteIt;</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineplus">+/* void onDataAvailable (in nsIRequest request, in nsIInputStream inStr, in</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineplus">+ * unsigned long long sourceOffset, in unsigned long count); */</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineplus">+NS_IMETHODIMP nsURLFetcherStreamConsumer::OnDataAvailable(nsIRequest *aRequest,</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineplus">+                                                          nsIInputStream *inStr,</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineplus">+                                                          uint64_t sourceOffset,</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineplus">+                                                          uint32_t count) {</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+  uint32_t readLen = count;</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+  uint32_t wroteIt;</span>
<a href="#l9.634"></a><span id="l9.634"> </span>
<a href="#l9.635"></a><span id="l9.635" class="difflineminus">-  if (!mURLFetcher)</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+  if (!mURLFetcher) return NS_ERROR_FAILURE;</span>
<a href="#l9.638"></a><span id="l9.638"> </span>
<a href="#l9.639"></a><span id="l9.639" class="difflineminus">-  if (!mURLFetcher-&gt;mOutStream)</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineplus">+  if (!mURLFetcher-&gt;mOutStream) return NS_ERROR_INVALID_ARG;</span>
<a href="#l9.642"></a><span id="l9.642"> </span>
<a href="#l9.643"></a><span id="l9.643" class="difflineminus">-  if (mURLFetcher-&gt;mBufferSize &lt; count)</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-  {</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineplus">+  if (mURLFetcher-&gt;mBufferSize &lt; count) {</span>
<a href="#l9.646"></a><span id="l9.646">     PR_FREEIF(mURLFetcher-&gt;mBuffer);</span>
<a href="#l9.647"></a><span id="l9.647"> </span>
<a href="#l9.648"></a><span id="l9.648">     if (count &gt; 0x1000)</span>
<a href="#l9.649"></a><span id="l9.649">       mURLFetcher-&gt;mBufferSize = count;</span>
<a href="#l9.650"></a><span id="l9.650">     else</span>
<a href="#l9.651"></a><span id="l9.651">       mURLFetcher-&gt;mBufferSize = 0x1000;</span>
<a href="#l9.652"></a><span id="l9.652"> </span>
<a href="#l9.653"></a><span id="l9.653">     mURLFetcher-&gt;mBuffer = (char *)PR_Malloc(mURLFetcher-&gt;mBufferSize);</span>
<a href="#l9.654"></a><span id="l9.654">     if (!mURLFetcher-&gt;mBuffer)</span>
<a href="#l9.655"></a><span id="l9.655">       return NS_ERROR_OUT_OF_MEMORY; /* we couldn't allocate the object */</span>
<a href="#l9.656"></a><span id="l9.656">   }</span>
<a href="#l9.657"></a><span id="l9.657"> </span>
<a href="#l9.658"></a><span id="l9.658">   // read the data from the input stram...</span>
<a href="#l9.659"></a><span id="l9.659">   nsresult rv = inStr-&gt;Read(mURLFetcher-&gt;mBuffer, count, &amp;readLen);</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineminus">-    return rv;</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.663"></a><span id="l9.663"> </span>
<a href="#l9.664"></a><span id="l9.664">   // write to the output file...</span>
<a href="#l9.665"></a><span id="l9.665">   mURLFetcher-&gt;mOutStream-&gt;Write(mURLFetcher-&gt;mBuffer, readLen, &amp;wroteIt);</span>
<a href="#l9.666"></a><span id="l9.666"> </span>
<a href="#l9.667"></a><span id="l9.667">   if (wroteIt != readLen)</span>
<a href="#l9.668"></a><span id="l9.668">     return NS_ERROR_FAILURE;</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-  else</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-  {</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+  else {</span>
<a href="#l9.672"></a><span id="l9.672">     mURLFetcher-&gt;mTotalWritten += wroteIt;</span>
<a href="#l9.673"></a><span id="l9.673">     return NS_OK;</span>
<a href="#l9.674"></a><span id="l9.674">   }</span>
<a href="#l9.675"></a><span id="l9.675"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -22,19 +22,18 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> class nsMsgAttachmentHandler;</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> class nsURLFetcher : public nsIURLFetcher,</span>
<a href="#l10.8"></a><span id="l10.8">                      public nsIStreamListener,</span>
<a href="#l10.9"></a><span id="l10.9">                      public nsIURIContentListener,</span>
<a href="#l10.10"></a><span id="l10.10">                      public nsIInterfaceRequestor,</span>
<a href="#l10.11"></a><span id="l10.11">                      public nsIWebProgressListener,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-                     public nsSupportsWeakReference</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-public:</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+                     public nsSupportsWeakReference {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ public:</span>
<a href="#l10.17"></a><span id="l10.17">   nsURLFetcher();</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19">   /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l10.20"></a><span id="l10.20">   NS_DECL_ISUPPORTS</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22">   // Methods for nsIURLFetcher</span>
<a href="#l10.23"></a><span id="l10.23">   NS_DECL_NSIURLFETCHER</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineat">@@ -48,54 +47,55 @@ public:</span>
<a href="#l10.26"></a><span id="l10.26">   NS_DECL_NSIURICONTENTLISTENER</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">   // Methods for nsIInterfaceRequestor</span>
<a href="#l10.29"></a><span id="l10.29">   NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">   // Methods for nsIWebProgressListener</span>
<a href="#l10.32"></a><span id="l10.32">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-protected:</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  nsresult InsertConverter(const char * aContentType);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+ protected:</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  nsresult InsertConverter(const char* aContentType);</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-private:</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+ private:</span>
<a href="#l10.41"></a><span id="l10.41">   virtual ~nsURLFetcher();</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt;       mOutStream;               // the output file stream</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;          mLocalFile;               // the output file itself</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-  nsCOMPtr&lt;nsIStreamListener&gt;     mConverter;               // the stream converter, if needed</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  nsCString                  mConverterContentType;    // The content type of the converter</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  bool                            mStillRunning;  // Are we still running?</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  int32_t                         mTotalWritten;  // Size counter variable</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  char                            *mBuffer;                 // Buffer used for reading the data</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  uint32_t                        mBufferSize;              // Buffer size;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  nsCString                  mContentType;             // The content type retrieved from the server</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  nsCString                  mCharset;                 // The charset retrieved from the server</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  RefPtr&lt;nsMsgAttachmentHandler&gt; mTagData;      // Tag data for callback...</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  nsAttachSaveCompletionCallback  mCallback;      // Callback to call once the file is saved...</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt;           mLoadCookie;    // load cookie used by the uri loader when we fetch the url</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  bool                            mOnStopRequestProcessed; // used to prevent calling OnStopRequest multiple times</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  bool                            mIsFile;        // This is used to check whether the URI is a local file.</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mOutStream;    // the output file stream</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mLocalFile;            // the output file itself</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  nsCOMPtr&lt;nsIStreamListener&gt; mConverter;  // the stream converter, if needed</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  nsCString mConverterContentType;         // The content type of the converter</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  bool mStillRunning;                      // Are we still running?</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  int32_t mTotalWritten;                   // Size counter variable</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+  char* mBuffer;                           // Buffer used for reading the data</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  uint32_t mBufferSize;                    // Buffer size;</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  nsCString mContentType;  // The content type retrieved from the server</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  nsCString mCharset;      // The charset retrieved from the server</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  RefPtr&lt;nsMsgAttachmentHandler&gt; mTagData;  // Tag data for callback...</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+  nsAttachSaveCompletionCallback</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+      mCallback;  // Callback to call once the file is saved...</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+      mLoadCookie;  // load cookie used by the uri loader when we fetch the url</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+  bool mOnStopRequestProcessed;  // used to prevent calling OnStopRequest</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                                 // multiple times</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  bool mIsFile;  // This is used to check whether the URI is a local file.</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76">   friend class nsURLFetcherStreamConsumer;</span>
<a href="#l10.77"></a><span id="l10.77"> };</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-</span>
<a href="#l10.80"></a><span id="l10.80"> /**</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">- * Stream consumer used for handling special content type like multipart/x-mixed-replace</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+ * Stream consumer used for handling special content type like</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+ * multipart/x-mixed-replace</span>
<a href="#l10.84"></a><span id="l10.84">  */</span>
<a href="#l10.85"></a><span id="l10.85"> </span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-class nsURLFetcherStreamConsumer : public nsIStreamListener</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-{</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-public:</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+class nsURLFetcherStreamConsumer : public nsIStreamListener {</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+ public:</span>
<a href="#l10.91"></a><span id="l10.91">   explicit nsURLFetcherStreamConsumer(nsURLFetcher* urlFetcher);</span>
<a href="#l10.92"></a><span id="l10.92"> </span>
<a href="#l10.93"></a><span id="l10.93">   /* additional members */</span>
<a href="#l10.94"></a><span id="l10.94">   NS_DECL_ISUPPORTS</span>
<a href="#l10.95"></a><span id="l10.95">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l10.96"></a><span id="l10.96">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-private:</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+ private:</span>
<a href="#l10.100"></a><span id="l10.100">   virtual ~nsURLFetcherStreamConsumer();</span>
<a href="#l10.101"></a><span id="l10.101">   nsURLFetcher* mURLFetcher;</span>
<a href="#l10.102"></a><span id="l10.102"> };</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-</span>
<a href="#l10.105"></a><span id="l10.105"> #endif /* nsURLFetcher_h_ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

