<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23136:18938fc0dd706992c6fd9fec8baddee302b2cd45</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 18938fc0dd706992c6fd9fec8baddee302b2cd45" />
<meta property="og:url" content="/comm-central/rev/18938fc0dd706992c6fd9fec8baddee302b2cd45" />
<meta property="og:description" content="Bug 1408662 - Move date/time/timezone related functions into calDateTimeUtils.jsm - automatic changes. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 18938fc0dd706992c6fd9fec8baddee302b2cd45 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/18938fc0dd706992c6fd9fec8baddee302b2cd45">shortlog</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/18938fc0dd706992c6fd9fec8baddee302b2cd45">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45">files</a> |
changeset |
<a href="/comm-central/raw-rev/18938fc0dd706992c6fd9fec8baddee302b2cd45">raw</a>  | <a href="/comm-central/archive/18938fc0dd706992c6fd9fec8baddee302b2cd45.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408662">Bug 1408662</a> - Move date/time/timezone related functions into calDateTimeUtils.jsm - automatic changes. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 14 Oct 2017 15:33:20 +0200</td></tr>

<tr>
 <td>changeset 23136</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/18938fc0dd706992c6fd9fec8baddee302b2cd45">18938fc0dd706992c6fd9fec8baddee302b2cd45</a></td>
</tr>



<tr>
<td>parent 23135</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">015d6cb840c4a0ed8db392a077aab10c2be6d0cd</a>
</td>
</tr>

<tr>
<td>child 23137</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ec9afb3329ab60924e34b4c0460b594d1a5f8474">ec9afb3329ab60924e34b4c0460b594d1a5f8474</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=18938fc0dd706992c6fd9fec8baddee302b2cd45">13994</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 22 Jan 2018 11:31:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@18938fc0dd70 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18938fc0dd706992c6fd9fec8baddee302b2cd45">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18938fc0dd706992c6fd9fec8baddee302b2cd45&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18938fc0dd706992c6fd9fec8baddee302b2cd45&newProject=comm-central&newRevision=d10e311b217af59593eb04d57be03fca16df6281&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18938fc0dd706992c6fd9fec8baddee302b2cd45&newProject=comm-central&newRevision=d10e311b217af59593eb04d57be03fca16df6281&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18938fc0dd706992c6fd9fec8baddee302b2cd45&newProject=comm-central&newRevision=d10e311b217af59593eb04d57be03fca16df6281&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408662">1408662</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408662">Bug 1408662</a> - Move date/time/timezone related functions into calDateTimeUtils.jsm - automatic changes. r=MakeMyDay

MozReview-Commit-ID: CbFO8nxatLy</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.xml">calendar/base/content/agenda-listbox.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/agenda-listbox.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-clipboard.js">calendar/base/content/calendar-clipboard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-clipboard.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-clipboard.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-clipboard.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-clipboard.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-clipboard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-extract.js">calendar/base/content/calendar-extract.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-extract.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-extract.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-extract.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-extract.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-extract.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-bindings.xml">calendar/base/content/calendar-item-bindings.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-bindings.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-bindings.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-bindings.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-bindings.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-bindings.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.xml">calendar/base/content/calendar-views.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/calendar-views.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-alarm-dialog.js">calendar/base/content/dialogs/calendar-alarm-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-alarm-dialog.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-alarm-dialog.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-alarm-dialog.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-alarm-dialog.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-alarm-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">calendar/base/content/dialogs/calendar-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">calendar/base/content/dialogs/calendar-event-dialog-timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.js">calendar/base/content/today-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.xul">calendar/base/content/today-pane.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.xul">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.xul">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.xul">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.xul">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/today-pane.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-alarm-widget.xml">calendar/base/content/widgets/calendar-alarm-widget.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-alarm-widget.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-alarm-widget.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-alarm-widget.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-alarm-widget.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-alarm-widget.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-widgets.xml">calendar/base/content/widgets/calendar-widgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-widgets.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-widgets.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-widgets.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-widgets.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/calendar-widgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/minimonth.xml">calendar/base/content/widgets/minimonth.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/minimonth.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/minimonth.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/minimonth.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/minimonth.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/content/widgets/minimonth.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calAlarmUtils.jsm">calendar/base/modules/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calItipUtils.jsm">calendar/base/modules/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calPrintUtils.jsm">calendar/base/modules/calPrintUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calPrintUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calPrintUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calPrintUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calPrintUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calPrintUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calRecurrenceUtils.jsm">calendar/base/modules/calRecurrenceUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calRecurrenceUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calRecurrenceUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calRecurrenceUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calRecurrenceUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calRecurrenceUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDeletedItems.js">calendar/base/src/calDeletedItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDeletedItems.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDeletedItems.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDeletedItems.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDeletedItems.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calDeletedItems.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calFilter.js">calendar/base/src/calFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calFilter.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calFilter.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calFilter.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calFilter.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calFilter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calHtmlExport.js">calendar/import-export/calHtmlExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calHtmlExport.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calHtmlExport.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calHtmlExport.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calHtmlExport.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calHtmlExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calMonthGridPrinter.js">calendar/import-export/calMonthGridPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calMonthGridPrinter.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calMonthGridPrinter.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calMonthGridPrinter.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calMonthGridPrinter.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calMonthGridPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calOutlookCSVImportExport.js">calendar/import-export/calOutlookCSVImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calOutlookCSVImportExport.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calOutlookCSVImportExport.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calOutlookCSVImportExport.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calOutlookCSVImportExport.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calOutlookCSVImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calWeekPrinter.js">calendar/import-export/calWeekPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calWeekPrinter.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calWeekPrinter.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calWeekPrinter.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calWeekPrinter.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/import-export/calWeekPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.xul">calendar/lightning/content/messenger-overlay-sidebar.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.xul">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.xul">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.xul">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.xul">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/content/messenger-overlay-sidebar.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/modules/ltnInvitationUtils.jsm">calendar/lightning/modules/ltnInvitationUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/modules/ltnInvitationUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/modules/ltnInvitationUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/modules/ltnInvitationUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/modules/ltnInvitationUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/lightning/modules/ltnInvitationUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">calendar/providers/gdata/content/gdata-calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageHelpers.jsm">calendar/providers/storage/calStorageHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageHelpers.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageHelpers.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/datetimepickers/datetimepickers.xml">calendar/resources/content/datetimepickers/datetimepickers.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/datetimepickers/datetimepickers.xml">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/datetimepickers/datetimepickers.xml">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/datetimepickers/datetimepickers.xml">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/datetimepickers/datetimepickers.xml">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/datetimepickers/datetimepickers.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/mouseoverPreviews.js">calendar/resources/content/mouseoverPreviews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/mouseoverPreviews.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/mouseoverPreviews.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/mouseoverPreviews.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/mouseoverPreviews.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/resources/content/mouseoverPreviews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/shared-modules/test-calendar-utils.js">calendar/test/mozmill/shared-modules/test-calendar-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/shared-modules/test-calendar-utils.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/shared-modules/test-calendar-utils.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/shared-modules/test-calendar-utils.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/shared-modules/test-calendar-utils.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/shared-modules/test-calendar-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/testTodayPane.js">calendar/test/mozmill/testTodayPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/testTodayPane.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/testTodayPane.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/testTodayPane.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/testTodayPane.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/testTodayPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/views/testMonthView.js">calendar/test/mozmill/views/testMonthView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/views/testMonthView.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/views/testMonthView.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/views/testMonthView.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/views/testMonthView.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/mozmill/views/testMonthView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmservice.js">calendar/test/unit/test_alarmservice.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmservice.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmservice.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmservice.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmservice.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmservice.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmutils.js">calendar/test/unit/test_alarmutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmutils.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmutils.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmutils.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmutils.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_alarmutils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_bug272411.js">calendar/test/unit/test_bug272411.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_bug272411.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_bug272411.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_bug272411.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_bug272411.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_bug272411.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_calmgr.js">calendar/test/unit/test_calmgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_calmgr.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_calmgr.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_calmgr.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_calmgr.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_calmgr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime.js">calendar/test/unit/test_datetime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime_before_1970.js">calendar/test/unit/test_datetime_before_1970.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime_before_1970.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime_before_1970.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime_before_1970.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime_before_1970.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetime_before_1970.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetimeformatter.js">calendar/test/unit/test_datetimeformatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetimeformatter.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetimeformatter.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetimeformatter.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetimeformatter.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_datetimeformatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_deleted_items.js">calendar/test/unit/test_deleted_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_deleted_items.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_deleted_items.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_deleted_items.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_deleted_items.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_deleted_items.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_gdata_provider.js">calendar/test/unit/test_gdata_provider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_gdata_provider.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_gdata_provider.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_gdata_provider.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_gdata_provider.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_gdata_provider.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_items.js">calendar/test/unit/test_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_items.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_items.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_items.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_items.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_items.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_rfc3339_parser.js">calendar/test/unit/test_rfc3339_parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_rfc3339_parser.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_rfc3339_parser.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_rfc3339_parser.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_rfc3339_parser.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_rfc3339_parser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_utils.js">calendar/test/unit/test_utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_utils.js">file</a> |
<a href="/comm-central/annotate/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_utils.js">annotate</a> |
<a href="/comm-central/diff/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_utils.js">diff</a> |
<a href="/comm-central/comparison/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_utils.js">comparison</a> |
<a href="/comm-central/log/18938fc0dd706992c6fd9fec8baddee302b2cd45/calendar/test/unit/test_utils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -510,17 +510,17 @@ agendaListbox.deleteItemsFromCalendar = </span>
<a href="#l1.4"></a><span id="l1.4">  * matches</span>
<a href="#l1.5"></a><span id="l1.5">  *</span>
<a href="#l1.6"></a><span id="l1.6">  * @param aItem         The item to compare.</span>
<a href="#l1.7"></a><span id="l1.7">  * @param aCompItem     The item to compare with.</span>
<a href="#l1.8"></a><span id="l1.8">  * @return              True, if the items match with the above noted criteria.</span>
<a href="#l1.9"></a><span id="l1.9">  */</span>
<a href="#l1.10"></a><span id="l1.10"> agendaListbox.isSameEvent = function(aItem, aCompItem) {</span>
<a href="#l1.11"></a><span id="l1.11">     return aItem.id == aCompItem.id &amp;&amp;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-           aItem[cal.calGetStartDateProp(aItem)].compare(aCompItem[cal.calGetStartDateProp(aCompItem)]) == 0;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+           aItem[cal.dtz.startDateProp(aItem)].compare(aCompItem[cal.dtz.startDateProp(aCompItem)]) == 0;</span>
<a href="#l1.14"></a><span id="l1.14"> };</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /**</span>
<a href="#l1.17"></a><span id="l1.17">  * Checks if the currently selected node in the listbox is an Event item (not a</span>
<a href="#l1.18"></a><span id="l1.18">  * period item).</span>
<a href="#l1.19"></a><span id="l1.19">  *</span>
<a href="#l1.20"></a><span id="l1.20">  * @return              True, if the node is not a period item.</span>
<a href="#l1.21"></a><span id="l1.21">  */</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -702,33 +702,33 @@ agendaListbox.setupCalendar = function()</span>
<a href="#l1.23"></a><span id="l1.23">  * Usually called at midnight to update the agenda pane. Also retrieves the</span>
<a href="#l1.24"></a><span id="l1.24">  * items from the calendar.</span>
<a href="#l1.25"></a><span id="l1.25">  *</span>
<a href="#l1.26"></a><span id="l1.26">  * @see #refreshCalendarQuery</span>
<a href="#l1.27"></a><span id="l1.27">  * @param newDate       The first date to show if the agenda pane doesn't show</span>
<a href="#l1.28"></a><span id="l1.28">  *                        today.</span>
<a href="#l1.29"></a><span id="l1.29">  */</span>
<a href="#l1.30"></a><span id="l1.30"> agendaListbox.refreshPeriodDates = function(newDate) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    this.kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    this.kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l1.33"></a><span id="l1.33">     // Today: now until midnight of tonight</span>
<a href="#l1.34"></a><span id="l1.34">     let oldshowstoday = this.showstoday;</span>
<a href="#l1.35"></a><span id="l1.35">     this.showstoday = this.showsToday(newDate);</span>
<a href="#l1.36"></a><span id="l1.36">     if ((this.showstoday) &amp;&amp; (!oldshowstoday)) {</span>
<a href="#l1.37"></a><span id="l1.37">         this.addPeriodListItem(this.tomorrow, &quot;tomorrow-header&quot;);</span>
<a href="#l1.38"></a><span id="l1.38">         this.addPeriodListItem(this.soon, &quot;nextweek-header&quot;);</span>
<a href="#l1.39"></a><span id="l1.39">     } else if (!this.showstoday) {</span>
<a href="#l1.40"></a><span id="l1.40">         this.removePeriodListItem(this.tomorrow);</span>
<a href="#l1.41"></a><span id="l1.41">         this.removePeriodListItem(this.soon);</span>
<a href="#l1.42"></a><span id="l1.42">     }</span>
<a href="#l1.43"></a><span id="l1.43">     newDate.isDate = true;</span>
<a href="#l1.44"></a><span id="l1.44">     for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l1.45"></a><span id="l1.45">         let curPeriod = this.periods[i];</span>
<a href="#l1.46"></a><span id="l1.46">         newDate.hour = newDate.minute = newDate.second = 0;</span>
<a href="#l1.47"></a><span id="l1.47">         if (i == 0 &amp;&amp; this.showstoday) {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-            curPeriod.start = cal.now();</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+            curPeriod.start = cal.dtz.now();</span>
<a href="#l1.50"></a><span id="l1.50">         } else {</span>
<a href="#l1.51"></a><span id="l1.51">             curPeriod.start = newDate.clone();</span>
<a href="#l1.52"></a><span id="l1.52">         }</span>
<a href="#l1.53"></a><span id="l1.53">         newDate.day += curPeriod.duration;</span>
<a href="#l1.54"></a><span id="l1.54">         curPeriod.end = newDate.clone();</span>
<a href="#l1.55"></a><span id="l1.55">         curPeriod.listItem.setItem(curPeriod, this.showstoday);</span>
<a href="#l1.56"></a><span id="l1.56">     }</span>
<a href="#l1.57"></a><span id="l1.57">     this.refreshCalendarQuery();</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineat">@@ -750,17 +750,17 @@ agendaListbox.addListener = function(aLi</span>
<a href="#l1.59"></a><span id="l1.59">  * @param aStartDate    (optional) The day to check if its &quot;today&quot;.</span>
<a href="#l1.60"></a><span id="l1.60">  * @return              Returns true if today is shown.</span>
<a href="#l1.61"></a><span id="l1.61">  */</span>
<a href="#l1.62"></a><span id="l1.62"> agendaListbox.showsToday = function(aStartDate) {</span>
<a href="#l1.63"></a><span id="l1.63">     let lstart = aStartDate;</span>
<a href="#l1.64"></a><span id="l1.64">     if (!lstart) {</span>
<a href="#l1.65"></a><span id="l1.65">         lstart = this.today.start;</span>
<a href="#l1.66"></a><span id="l1.66">     }</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-    let lshowsToday = cal.sameDay(cal.now(), lstart);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+    let lshowsToday = cal.dtz.sameDay(cal.dtz.now(), lstart);</span>
<a href="#l1.69"></a><span id="l1.69">     if (lshowsToday) {</span>
<a href="#l1.70"></a><span id="l1.70">         this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l1.71"></a><span id="l1.71">     } else {</span>
<a href="#l1.72"></a><span id="l1.72">         this.periods = [this.today];</span>
<a href="#l1.73"></a><span id="l1.73">     }</span>
<a href="#l1.74"></a><span id="l1.74">     return lshowsToday;</span>
<a href="#l1.75"></a><span id="l1.75"> };</span>
<a href="#l1.76"></a><span id="l1.76"> </span>
<a href="#l1.77"></a><span id="l1.77" class="difflineat">@@ -991,17 +991,17 @@ agendaListbox.calendarObserver.onDefault</span>
<a href="#l1.78"></a><span id="l1.78">  * Updates the &quot;Upcoming&quot; section of today pane when preference soondays changes</span>
<a href="#l1.79"></a><span id="l1.79">  **/</span>
<a href="#l1.80"></a><span id="l1.80"> agendaListbox.updateSoonSection = function() {</span>
<a href="#l1.81"></a><span id="l1.81">     this.soon.duration = this.soonDays;</span>
<a href="#l1.82"></a><span id="l1.82">     this.soon.open = true;</span>
<a href="#l1.83"></a><span id="l1.83">     let soonHeader = document.getElementById(&quot;nextweek-header&quot;);</span>
<a href="#l1.84"></a><span id="l1.84">     if (soonHeader) {</span>
<a href="#l1.85"></a><span id="l1.85">         soonHeader.setItem(this.soon, true);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-        agendaListbox.refreshPeriodDates(cal.now());</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+        agendaListbox.refreshPeriodDates(cal.dtz.now());</span>
<a href="#l1.88"></a><span id="l1.88">     }</span>
<a href="#l1.89"></a><span id="l1.89"> };</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91"> /**</span>
<a href="#l1.92"></a><span id="l1.92">  * Updates the event considered &quot;current&quot;. This goes through all &quot;today&quot; items</span>
<a href="#l1.93"></a><span id="l1.93">  * and sets the &quot;current&quot; attribute on all list items that are currently</span>
<a href="#l1.94"></a><span id="l1.94">  * occurring.</span>
<a href="#l1.95"></a><span id="l1.95">  *</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineat">@@ -1010,17 +1010,17 @@ agendaListbox.updateSoonSection = functi</span>
<a href="#l1.97"></a><span id="l1.97"> function setCurrentEvent() {</span>
<a href="#l1.98"></a><span id="l1.98">     if (!agendaListbox.showsToday() || !agendaListbox.today.open) {</span>
<a href="#l1.99"></a><span id="l1.99">         return;</span>
<a href="#l1.100"></a><span id="l1.100">     }</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102">     let msScheduleTime = -1;</span>
<a href="#l1.103"></a><span id="l1.103">     let complistItem = agendaListbox.tomorrow.listItem.previousSibling;</span>
<a href="#l1.104"></a><span id="l1.104">     let removelist = [];</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-    let anow = cal.now();</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    let anow = cal.dtz.now();</span>
<a href="#l1.107"></a><span id="l1.107">     let msuntillend = 0;</span>
<a href="#l1.108"></a><span id="l1.108">     let msuntillstart = 0;</span>
<a href="#l1.109"></a><span id="l1.109">     let leaveloop;</span>
<a href="#l1.110"></a><span id="l1.110">     do {</span>
<a href="#l1.111"></a><span id="l1.111">         leaveloop = !agendaListbox.isEventListItem(complistItem);</span>
<a href="#l1.112"></a><span id="l1.112">         if (!leaveloop) {</span>
<a href="#l1.113"></a><span id="l1.113">             msuntillstart = complistItem.occurrence.startDate</span>
<a href="#l1.114"></a><span id="l1.114">                                         .getInTimezone(agendaListbox.kDefaultTimezone)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -120,20 +120,20 @@</span>
<a href="#l2.4"></a><span id="l2.4">         &lt;parameter name=&quot;aPeriod&quot;/&gt;</span>
<a href="#l2.5"></a><span id="l2.5">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.6"></a><span id="l2.6">             this.mOccurrence = aOccurrence;</span>
<a href="#l2.7"></a><span id="l2.7">             this.mAllDayItem.occurrence = aOccurrence;</span>
<a href="#l2.8"></a><span id="l2.8">             let dateFormatter = cal.getDateFormatter();</span>
<a href="#l2.9"></a><span id="l2.9">             let periodStartDate = aPeriod.start.clone();</span>
<a href="#l2.10"></a><span id="l2.10">             periodStartDate.isDate = true;</span>
<a href="#l2.11"></a><span id="l2.11">             let periodEndDate = aPeriod.end;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            let startDate = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                                .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-            let endDate = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-                              .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+            let startDate = this.mOccurrence[cal.dtz.startDateProp(this.mOccurrence)]</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                                .getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            let endDate = this.mOccurrence[cal.dtz.endDateProp(this.mOccurrence)]</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+                              .getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l2.20"></a><span id="l2.20">             let endPreviousDay = endDate.clone();</span>
<a href="#l2.21"></a><span id="l2.21">             endPreviousDay.day--;</span>
<a href="#l2.22"></a><span id="l2.22">             // Show items's date for long periods but also for &quot;Upcoming&quot;</span>
<a href="#l2.23"></a><span id="l2.23">             // period with one day duration.</span>
<a href="#l2.24"></a><span id="l2.24">             let showDate = aPeriod.multiday || aPeriod.duration &gt; 1;</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26">             let date = &quot;&quot;;</span>
<a href="#l2.27"></a><span id="l2.27">             let iconType = &quot;&quot;;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineat">@@ -206,20 +206,20 @@</span>
<a href="#l2.29"></a><span id="l2.29">             this.setAttribute(&quot;status&quot;, aItem.status);</span>
<a href="#l2.30"></a><span id="l2.30">             let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l2.31"></a><span id="l2.31">                                           .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">             let periodStartDate = aPeriod.start.clone();</span>
<a href="#l2.34"></a><span id="l2.34">             periodStartDate.isDate = true;</span>
<a href="#l2.35"></a><span id="l2.35">             let periodEndDate = aPeriod.end.clone();</span>
<a href="#l2.36"></a><span id="l2.36">             periodEndDate.day--;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-            let start = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-                            .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-            let end = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-                          .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+            let start = this.mOccurrence[cal.dtz.startDateProp(this.mOccurrence)]</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                            .getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+            let end = this.mOccurrence[cal.dtz.endDateProp(this.mOccurrence)]</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+                          .getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l2.45"></a><span id="l2.45">             let startDate = start.clone();</span>
<a href="#l2.46"></a><span id="l2.46">             startDate.isDate = true;</span>
<a href="#l2.47"></a><span id="l2.47">             let endDate = end.clone();</span>
<a href="#l2.48"></a><span id="l2.48">             endDate.isDate = true;</span>
<a href="#l2.49"></a><span id="l2.49">             let endAtMidnight = (end.hour == 0 &amp;&amp; end.minute == 0);</span>
<a href="#l2.50"></a><span id="l2.50">             if (endAtMidnight) {</span>
<a href="#l2.51"></a><span id="l2.51">                 endDate.day--;</span>
<a href="#l2.52"></a><span id="l2.52">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -236,17 +236,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.5"></a><span id="l3.5">           this.tasksInView = (document.getElementById(kTasksInViewCommand)</span>
<a href="#l3.6"></a><span id="l3.6">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.7"></a><span id="l3.7">           this.rotated = (document.getElementById(kOrientation)</span>
<a href="#l3.8"></a><span id="l3.8">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">           this.showCompleted = (document.getElementById(kShowCompleted)</span>
<a href="#l3.10"></a><span id="l3.10">                                   .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-          this.mTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+          this.mTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l3.14"></a><span id="l3.14">           let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l3.15"></a><span id="l3.15">                                        .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l3.16"></a><span id="l3.16">           alarmService.addObserver(this.mObserver);</span>
<a href="#l3.17"></a><span id="l3.17">           this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l3.18"></a><span id="l3.18">           this.mResizeHandler = () =&gt; {</span>
<a href="#l3.19"></a><span id="l3.19">               this.onResize(this);</span>
<a href="#l3.20"></a><span id="l3.20">           };</span>
<a href="#l3.21"></a><span id="l3.21">           this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -412,17 +412,17 @@</span>
<a href="#l3.23"></a><span id="l3.23">             for (let i = 0; i &lt; labeldayboxkids.length; i++) {</span>
<a href="#l3.24"></a><span id="l3.24">                 labeldayboxkids[i].shortWeekNames = useShortNames;</span>
<a href="#l3.25"></a><span id="l3.25">             }</span>
<a href="#l3.26"></a><span id="l3.26">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.27"></a><span id="l3.27">       &lt;/method&gt;</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">       &lt;method name=&quot;today&quot;&gt;</span>
<a href="#l3.30"></a><span id="l3.30">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-            let date = cal.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+            let date = cal.dtz.jsDateToDateTime(new Date()).getInTimezone(this.mTimezone);</span>
<a href="#l3.33"></a><span id="l3.33">             date.isDate = true;</span>
<a href="#l3.34"></a><span id="l3.34">             return date;</span>
<a href="#l3.35"></a><span id="l3.35">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.36"></a><span id="l3.36">       &lt;/method&gt;</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">       &lt;method name=&quot;isVisible&quot;&gt;</span>
<a href="#l3.39"></a><span id="l3.39">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.40"></a><span id="l3.40">             return (this.nodeName == currentView().nodeName);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -628,17 +628,17 @@</span>
<a href="#l3.42"></a><span id="l3.42">                 case &quot;calendar.week.d2tuesdaysoff&quot;:</span>
<a href="#l3.43"></a><span id="l3.43">                 case &quot;calendar.week.d3wednesdaysoff&quot;:</span>
<a href="#l3.44"></a><span id="l3.44">                 case &quot;calendar.week.d4thursdaysoff&quot;:</span>
<a href="#l3.45"></a><span id="l3.45">                 case &quot;calendar.week.d5fridaysoff&quot;:</span>
<a href="#l3.46"></a><span id="l3.46">                 case &quot;calendar.week.d6saturdaysoff&quot;:</span>
<a href="#l3.47"></a><span id="l3.47">                     this.updateDaysOffPrefs();</span>
<a href="#l3.48"></a><span id="l3.48">                     break;</span>
<a href="#l3.49"></a><span id="l3.49">                 case &quot;calendar.timezone.local&quot;:</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-                    this.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+                    this.timezone = cal.dtz.defaultTimezone;</span>
<a href="#l3.52"></a><span id="l3.52">                     this.refreshView();</span>
<a href="#l3.53"></a><span id="l3.53">                     break;</span>
<a href="#l3.54"></a><span id="l3.54">                 case &quot;calendar.alarms.indicator.show&quot;:</span>
<a href="#l3.55"></a><span id="l3.55">                     // Break here to ensure the view is refreshed</span>
<a href="#l3.56"></a><span id="l3.56">                     break;</span>
<a href="#l3.57"></a><span id="l3.57">                 case &quot;calendar.week.start&quot;:</span>
<a href="#l3.58"></a><span id="l3.58">                     this.weekStartOffset = aSubject.getIntPref(aPreference);</span>
<a href="#l3.59"></a><span id="l3.59">                     break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-clipboard.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-clipboard.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -196,17 +196,17 @@ function pasteFromClipboard() {</span>
<a href="#l4.4"></a><span id="l4.4">             }</span>
<a href="#l4.5"></a><span id="l4.5">             let firstDate = currentView().selectedDay;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">             let offset = null;</span>
<a href="#l4.8"></a><span id="l4.8">             if (earliestDate) {</span>
<a href="#l4.9"></a><span id="l4.9">                 // Timezones and DT/DST time may differ between the earliest item</span>
<a href="#l4.10"></a><span id="l4.10">                 // and the selected day. Determine the offset between the</span>
<a href="#l4.11"></a><span id="l4.11">                 // earliestDate in local time and the selected day in whole days.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                earliestDate = earliestDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                earliestDate = earliestDate.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l4.14"></a><span id="l4.14">                 earliestDate.isDate = true;</span>
<a href="#l4.15"></a><span id="l4.15">                 offset = firstDate.subtractDate(earliestDate);</span>
<a href="#l4.16"></a><span id="l4.16">                 let deltaDST = firstDate.timezoneOffset - earliestDate.timezoneOffset;</span>
<a href="#l4.17"></a><span id="l4.17">                 offset.inSeconds += deltaDST;</span>
<a href="#l4.18"></a><span id="l4.18">             }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">             startBatchTransaction();</span>
<a href="#l4.21"></a><span id="l4.21">             for (let item of items) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -270,22 +270,22 @@ var calendarController = {</span>
<a href="#l5.4"></a><span id="l5.4">         return false;</span>
<a href="#l5.5"></a><span id="l5.5">     },</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     doCommand: function(aCommand) {</span>
<a href="#l5.8"></a><span id="l5.8">         switch (aCommand) {</span>
<a href="#l5.9"></a><span id="l5.9">             // Common Commands</span>
<a href="#l5.10"></a><span id="l5.10">             case &quot;calendar_new_event_command&quot;:</span>
<a href="#l5.11"></a><span id="l5.11">                 createEventWithDialog(getSelectedCalendar(),</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                                      cal.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                                      cal.dtz.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.14"></a><span id="l5.14">                 break;</span>
<a href="#l5.15"></a><span id="l5.15">             case &quot;calendar_new_event_context_command&quot;: {</span>
<a href="#l5.16"></a><span id="l5.16">                 let newStart = currentView().selectedDateTime;</span>
<a href="#l5.17"></a><span id="l5.17">                 if (!newStart) {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-                    newStart = cal.getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                    newStart = cal.dtz.getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.20"></a><span id="l5.20">                 }</span>
<a href="#l5.21"></a><span id="l5.21">                 createEventWithDialog(getSelectedCalendar(), newStart,</span>
<a href="#l5.22"></a><span id="l5.22">                                       null, null, null,</span>
<a href="#l5.23"></a><span id="l5.23">                                       newStart.isDate == true);</span>
<a href="#l5.24"></a><span id="l5.24">                 break;</span>
<a href="#l5.25"></a><span id="l5.25">             }</span>
<a href="#l5.26"></a><span id="l5.26">             case &quot;calendar_modify_event_command&quot;:</span>
<a href="#l5.27"></a><span id="l5.27">                 editSelectedEvents();</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineat">@@ -323,41 +323,41 @@ var calendarController = {</span>
<a href="#l5.29"></a><span id="l5.29">                         deleteSelectedEvents();</span>
<a href="#l5.30"></a><span id="l5.30">                     }</span>
<a href="#l5.31"></a><span id="l5.31">                 }</span>
<a href="#l5.32"></a><span id="l5.32">                 break;</span>
<a href="#l5.33"></a><span id="l5.33">             }</span>
<a href="#l5.34"></a><span id="l5.34">             case &quot;calendar_new_todo_command&quot;:</span>
<a href="#l5.35"></a><span id="l5.35">                 createTodoWithDialog(getSelectedCalendar(),</span>
<a href="#l5.36"></a><span id="l5.36">                                      null, null, null,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                                     cal.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+                                     cal.dtz.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.39"></a><span id="l5.39">                 break;</span>
<a href="#l5.40"></a><span id="l5.40">             case &quot;calendar_new_todo_context_command&quot;: {</span>
<a href="#l5.41"></a><span id="l5.41">                 let initialDate = currentView().selectedDateTime;</span>
<a href="#l5.42"></a><span id="l5.42">                 if (!initialDate || initialDate.isDate) {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                    initialDate = cal.getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+                    initialDate = cal.dtz.getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.45"></a><span id="l5.45">                 }</span>
<a href="#l5.46"></a><span id="l5.46">                 createTodoWithDialog(getSelectedCalendar(),</span>
<a href="#l5.47"></a><span id="l5.47">                                      null, null, null,</span>
<a href="#l5.48"></a><span id="l5.48">                                      initialDate);</span>
<a href="#l5.49"></a><span id="l5.49">                 break;</span>
<a href="#l5.50"></a><span id="l5.50">             }</span>
<a href="#l5.51"></a><span id="l5.51">             case &quot;calendar_new_todo_todaypane_command&quot;:</span>
<a href="#l5.52"></a><span id="l5.52">                 createTodoWithDialog(getSelectedCalendar(),</span>
<a href="#l5.53"></a><span id="l5.53">                                      null, null, null,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-                                     cal.getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+                                     cal.dtz.getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.56"></a><span id="l5.56">                 break;</span>
<a href="#l5.57"></a><span id="l5.57">             case &quot;calendar_delete_todo_command&quot;:</span>
<a href="#l5.58"></a><span id="l5.58">                 deleteToDoCommand();</span>
<a href="#l5.59"></a><span id="l5.59">                 break;</span>
<a href="#l5.60"></a><span id="l5.60">             case &quot;calendar_modify_todo_command&quot;:</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-                modifyTaskFromContext(null, cal.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+                modifyTaskFromContext(null, cal.dtz.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.63"></a><span id="l5.63">                 break;</span>
<a href="#l5.64"></a><span id="l5.64">             case &quot;calendar_modify_todo_todaypane_command&quot;:</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-                modifyTaskFromContext(null, cal.getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+                modifyTaskFromContext(null, cal.dtz.getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.67"></a><span id="l5.67">                 break;</span>
<a href="#l5.68"></a><span id="l5.68"> </span>
<a href="#l5.69"></a><span id="l5.69">             case &quot;calendar_new_calendar_command&quot;:</span>
<a href="#l5.70"></a><span id="l5.70">                 cal.openCalendarWizard(window);</span>
<a href="#l5.71"></a><span id="l5.71">                 break;</span>
<a href="#l5.72"></a><span id="l5.72">             case &quot;calendar_edit_calendar_command&quot;:</span>
<a href="#l5.73"></a><span id="l5.73">                 cal.openCalendarProperties(window, getSelectedCalendar());</span>
<a href="#l5.74"></a><span id="l5.74">                 break;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineat">@@ -843,17 +843,17 @@ function setupContextItemType(event, ite</span>
<a href="#l5.76"></a><span id="l5.76">  *</span>
<a href="#l5.77"></a><span id="l5.77">  * XXX This function is misplaced, should go to calendar-views.js or a minimonth</span>
<a href="#l5.78"></a><span id="l5.78">  * specific js file.</span>
<a href="#l5.79"></a><span id="l5.79">  *</span>
<a href="#l5.80"></a><span id="l5.80">  * @param aNewDate      The new date as a JSDate.</span>
<a href="#l5.81"></a><span id="l5.81">  */</span>
<a href="#l5.82"></a><span id="l5.82"> function minimonthPick(aNewDate) {</span>
<a href="#l5.83"></a><span id="l5.83">     if (gCurrentMode == &quot;calendar&quot; || gCurrentMode == &quot;task&quot;) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-        let cdt = cal.jsDateToDateTime(aNewDate, currentView().timezone);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+        let cdt = cal.dtz.jsDateToDateTime(aNewDate, currentView().timezone);</span>
<a href="#l5.86"></a><span id="l5.86">         cdt.isDate = true;</span>
<a href="#l5.87"></a><span id="l5.87">         currentView().goToDay(cdt);</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">         // update date filter for task tree</span>
<a href="#l5.90"></a><span id="l5.90">         let tree = document.getElementById(&quot;calendar-task-tree&quot;);</span>
<a href="#l5.91"></a><span id="l5.91">         tree.updateFilter();</span>
<a href="#l5.92"></a><span id="l5.92">     }</span>
<a href="#l5.93"></a><span id="l5.93"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -19,17 +19,17 @@ var itemConversion = {</span>
<a href="#l6.4"></a><span id="l6.4">      */</span>
<a href="#l6.5"></a><span id="l6.5">     calendarItemFromMessage: function iC_calendarItemFromMessage(aItem, aMsgHdr) {</span>
<a href="#l6.6"></a><span id="l6.6">         let msgFolder = aMsgHdr.folder;</span>
<a href="#l6.7"></a><span id="l6.7">         let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">         aItem.calendar = getSelectedCalendar();</span>
<a href="#l6.10"></a><span id="l6.10">         aItem.title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-        cal.setDefaultStartEndHour(aItem);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+        cal.dtz.setDefaultStartEndHour(aItem);</span>
<a href="#l6.14"></a><span id="l6.14">         cal.alarms.setDefaultValues(aItem);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">         let messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l6.17"></a><span id="l6.17">                                   .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l6.18"></a><span id="l6.18">         let streamListener = Components.classes[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l6.19"></a><span id="l6.19">                                        .createInstance(Components.interfaces.nsISyncStreamListener);</span>
<a href="#l6.20"></a><span id="l6.20">         messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l6.21"></a><span id="l6.21">                                                               streamListener,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -143,17 +143,17 @@ var itemConversion = {</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">         // Dates and alarms</span>
<a href="#l6.25"></a><span id="l6.25">         item.startDate = aTask.entryDate;</span>
<a href="#l6.26"></a><span id="l6.26">         if (!item.startDate) {</span>
<a href="#l6.27"></a><span id="l6.27">             if (aTask.dueDate) {</span>
<a href="#l6.28"></a><span id="l6.28">                 item.startDate = aTask.dueDate.clone();</span>
<a href="#l6.29"></a><span id="l6.29">                 item.startDate.minute -= Preferences.get(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l6.30"></a><span id="l6.30">             } else {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                item.startDate = cal.getDefaultStartDate();</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+                item.startDate = cal.dtz.getDefaultStartDate();</span>
<a href="#l6.33"></a><span id="l6.33">             }</span>
<a href="#l6.34"></a><span id="l6.34">         }</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">         item.endDate = aTask.dueDate;</span>
<a href="#l6.37"></a><span id="l6.37">         if (!item.endDate) {</span>
<a href="#l6.38"></a><span id="l6.38">             // Make the event be the default event length if no due date was</span>
<a href="#l6.39"></a><span id="l6.39">             // specified.</span>
<a href="#l6.40"></a><span id="l6.40">             item.endDate = item.startDate.clone();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-extract.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-extract.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -100,17 +100,17 @@ var calendarExtract = {</span>
<a href="#l7.4"></a><span id="l7.4">             extractor = new Extractor(locale, dayStart, false);</span>
<a href="#l7.5"></a><span id="l7.5">         }</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">         let item;</span>
<a href="#l7.8"></a><span id="l7.8">         item = isEvent ? cal.createEvent() : cal.createTodo();</span>
<a href="#l7.9"></a><span id="l7.9">         item.title = message.mime2DecodedSubject;</span>
<a href="#l7.10"></a><span id="l7.10">         item.calendar = getSelectedCalendar();</span>
<a href="#l7.11"></a><span id="l7.11">         item.setProperty(&quot;DESCRIPTION&quot;, content);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        cal.setDefaultStartEndHour(item);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        cal.dtz.setDefaultStartEndHour(item);</span>
<a href="#l7.14"></a><span id="l7.14">         cal.alarms.setDefaultValues(item);</span>
<a href="#l7.15"></a><span id="l7.15">         let sel = GetMessagePaneFrame().getSelection();</span>
<a href="#l7.16"></a><span id="l7.16">         // Thunderbird Conversations might be installed</span>
<a href="#l7.17"></a><span id="l7.17">         if (sel === null) {</span>
<a href="#l7.18"></a><span id="l7.18">             try {</span>
<a href="#l7.19"></a><span id="l7.19">                 sel = document.getElementById(&quot;multimessage&quot;)</span>
<a href="#l7.20"></a><span id="l7.20">                               .contentDocument.querySelector(&quot;.iframe-container iframe&quot;)</span>
<a href="#l7.21"></a><span id="l7.21">                               .contentDocument.getSelection();</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -164,17 +164,17 @@ var calendarExtract = {</span>
<a href="#l7.23"></a><span id="l7.23">                 }</span>
<a href="#l7.24"></a><span id="l7.24">                 if (endGuess.hour != null) {</span>
<a href="#l7.25"></a><span id="l7.25">                     item.endDate.hour = endGuess.hour;</span>
<a href="#l7.26"></a><span id="l7.26">                 }</span>
<a href="#l7.27"></a><span id="l7.27">                 if (endGuess.minute != null) {</span>
<a href="#l7.28"></a><span id="l7.28">                     item.endDate.minute = endGuess.minute;</span>
<a href="#l7.29"></a><span id="l7.29">                 }</span>
<a href="#l7.30"></a><span id="l7.30">             } else {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                let dtz = cal.calendarDefaultTimezone();</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                let dtz = cal.dtz.defaultTimezone;</span>
<a href="#l7.33"></a><span id="l7.33">                 let dueDate = new Date();</span>
<a href="#l7.34"></a><span id="l7.34">                 // set default</span>
<a href="#l7.35"></a><span id="l7.35">                 dueDate.setHours(0);</span>
<a href="#l7.36"></a><span id="l7.36">                 dueDate.setMinutes(0);</span>
<a href="#l7.37"></a><span id="l7.37">                 dueDate.setSeconds(0);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">                 if (endGuess.year != null) {</span>
<a href="#l7.40"></a><span id="l7.40">                     dueDate.setYear(endGuess.year);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -187,19 +187,19 @@ var calendarExtract = {</span>
<a href="#l7.42"></a><span id="l7.42">                 }</span>
<a href="#l7.43"></a><span id="l7.43">                 if (endGuess.hour != null) {</span>
<a href="#l7.44"></a><span id="l7.44">                     dueDate.setHours(endGuess.hour);</span>
<a href="#l7.45"></a><span id="l7.45">                 }</span>
<a href="#l7.46"></a><span id="l7.46">                 if (endGuess.minute != null) {</span>
<a href="#l7.47"></a><span id="l7.47">                     dueDate.setMinutes(endGuess.minute);</span>
<a href="#l7.48"></a><span id="l7.48">                 }</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-                cal.setItemProperty(item, &quot;entryDate&quot;, cal.jsDateToDateTime(date, dtz));</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                cal.setItemProperty(item, &quot;entryDate&quot;, cal.dtz.jsDateToDateTime(date, dtz));</span>
<a href="#l7.52"></a><span id="l7.52">                 if (endGuess.year != null) {</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-                    cal.setItemProperty(item, &quot;dueDate&quot;, cal.jsDateToDateTime(dueDate, dtz));</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+                    cal.setItemProperty(item, &quot;dueDate&quot;, cal.dtz.jsDateToDateTime(dueDate, dtz));</span>
<a href="#l7.55"></a><span id="l7.55">                 }</span>
<a href="#l7.56"></a><span id="l7.56">             }</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">             // if time not guessed set allday for events</span>
<a href="#l7.59"></a><span id="l7.59">             if (allDay) {</span>
<a href="#l7.60"></a><span id="l7.60">                 createEventWithDialog(null, null, null, null, item, true);</span>
<a href="#l7.61"></a><span id="l7.61">             } else {</span>
<a href="#l7.62"></a><span id="l7.62">                 createEventWithDialog(null, null, null, null, item);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -374,17 +374,17 @@ InvitationsManager.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">     /**</span>
<a href="#l8.6"></a><span id="l8.6">      * Helper function to create a start date to search from. This date is the</span>
<a href="#l8.7"></a><span id="l8.7">      * current time with hour/minute/second set to zero.</span>
<a href="#l8.8"></a><span id="l8.8">      *</span>
<a href="#l8.9"></a><span id="l8.9">      * @return      Potential start date.</span>
<a href="#l8.10"></a><span id="l8.10">      */</span>
<a href="#l8.11"></a><span id="l8.11">     getStartDate: function() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        let date = cal.now();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        let date = cal.dtz.now();</span>
<a href="#l8.14"></a><span id="l8.14">         date.second = 0;</span>
<a href="#l8.15"></a><span id="l8.15">         date.minute = 0;</span>
<a href="#l8.16"></a><span id="l8.16">         date.hour = 0;</span>
<a href="#l8.17"></a><span id="l8.17">         return date;</span>
<a href="#l8.18"></a><span id="l8.18">     },</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">     /**</span>
<a href="#l8.21"></a><span id="l8.21">      * Updates the start date for the invitations manager to the date returned</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -410,12 +410,12 @@ InvitationsManager.prototype = {</span>
<a href="#l8.23"></a><span id="l8.23">      * @param item      The item to check</span>
<a href="#l8.24"></a><span id="l8.24">      * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l8.25"></a><span id="l8.25">      */</span>
<a href="#l8.26"></a><span id="l8.26">     validateItem: function(item) {</span>
<a href="#l8.27"></a><span id="l8.27">         if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l8.28"></a><span id="l8.28">             !item.calendar.isInvitation(item)) {</span>
<a href="#l8.29"></a><span id="l8.29">             return false; // exclude if organizer has invited himself</span>
<a href="#l8.30"></a><span id="l8.30">         }</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-        let start = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+        let start = item[cal.dtz.startDateProp(item)] || item[cal.dtz.endDateProp(item)];</span>
<a href="#l8.33"></a><span id="l8.33">         return cal.isOpenInvitation(item) &amp;&amp; start.compare(this.mStartDate) &gt;= 0;</span>
<a href="#l8.34"></a><span id="l8.34">     }</span>
<a href="#l8.35"></a><span id="l8.35"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-item-bindings.xml</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-bindings.xml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -52,43 +52,43 @@</span>
<a href="#l9.4"></a><span id="l9.4">             return mItem;</span>
<a href="#l9.5"></a><span id="l9.5">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l9.6"></a><span id="l9.6">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l9.7"></a><span id="l9.7">             this.mItem = val;</span>
<a href="#l9.8"></a><span id="l9.8">             let headerLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-label&quot;);</span>
<a href="#l9.9"></a><span id="l9.9">             let itemDateTimeLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-value&quot;);</span>
<a href="#l9.10"></a><span id="l9.10">             let date;</span>
<a href="#l9.11"></a><span id="l9.11">             if (this.mode == &quot;start&quot;) {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-                date = this.mItem[cal.calGetStartDateProp(this.mItem)];</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+                date = this.mItem[cal.dtz.startDateProp(this.mItem)];</span>
<a href="#l9.14"></a><span id="l9.14">                 if (date) {</span>
<a href="#l9.15"></a><span id="l9.15">                     let label;</span>
<a href="#l9.16"></a><span id="l9.16">                     if (cal.isToDo(this.mItem)) {</span>
<a href="#l9.17"></a><span id="l9.17">                         label = this.getAttribute(&quot;taskStartLabel&quot;);</span>
<a href="#l9.18"></a><span id="l9.18">                     } else {</span>
<a href="#l9.19"></a><span id="l9.19">                         label = this.getAttribute(&quot;eventStartLabel&quot;);</span>
<a href="#l9.20"></a><span id="l9.20">                     }</span>
<a href="#l9.21"></a><span id="l9.21">                     headerLabel.value = label;</span>
<a href="#l9.22"></a><span id="l9.22">                 }</span>
<a href="#l9.23"></a><span id="l9.23">             } else {</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-                date = this.mItem[cal.calGetEndDateProp(this.mItem)];</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+                date = this.mItem[cal.dtz.endDateProp(this.mItem)];</span>
<a href="#l9.26"></a><span id="l9.26">                 if (date) {</span>
<a href="#l9.27"></a><span id="l9.27">                     let label;</span>
<a href="#l9.28"></a><span id="l9.28">                     if (cal.isToDo(this.mItem)) {</span>
<a href="#l9.29"></a><span id="l9.29">                         label = this.getAttribute(&quot;taskDueLabel&quot;);</span>
<a href="#l9.30"></a><span id="l9.30">                     } else {</span>
<a href="#l9.31"></a><span id="l9.31">                         label = this.getAttribute(&quot;eventEndLabel&quot;);</span>
<a href="#l9.32"></a><span id="l9.32">                     }</span>
<a href="#l9.33"></a><span id="l9.33">                     headerLabel.value = label;</span>
<a href="#l9.34"></a><span id="l9.34">                 }</span>
<a href="#l9.35"></a><span id="l9.35">             }</span>
<a href="#l9.36"></a><span id="l9.36">             let hideLabels = (date == null);</span>
<a href="#l9.37"></a><span id="l9.37">             if (hideLabels) {</span>
<a href="#l9.38"></a><span id="l9.38">                 this.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l9.39"></a><span id="l9.39">             } else {</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-                const kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                const kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l9.42"></a><span id="l9.42">                 let localTime = date.getInTimezone(kDefaultTimezone);</span>
<a href="#l9.43"></a><span id="l9.43">                 let formatter = cal.getDateFormatter();</span>
<a href="#l9.44"></a><span id="l9.44">                 itemDateTimeLabel.value = formatter.formatDateTime(localTime);</span>
<a href="#l9.45"></a><span id="l9.45">                 if (!date.timezone.isFloating &amp;&amp; date.timezone.tzid != kDefaultTimezone.tzid) {</span>
<a href="#l9.46"></a><span id="l9.46">                     // we additionally display the original datetime with timezone</span>
<a href="#l9.47"></a><span id="l9.47">                     let orgTime = cal.calGetString(&quot;calendar&quot;, &quot;datetimeWithTimezone&quot;, [</span>
<a href="#l9.48"></a><span id="l9.48">                         formatter.formatDateTime(date),</span>
<a href="#l9.49"></a><span id="l9.49">                         date.timezone.tzid</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -29,78 +29,78 @@ function disposeJob(job) {</span>
<a href="#l10.4"></a><span id="l10.4">  * @param aCalendar     (optional) The calendar to apply.</span>
<a href="#l10.5"></a><span id="l10.5">  * @param aStartDate    (optional) The start date to set.</span>
<a href="#l10.6"></a><span id="l10.6">  * @param aEndDate      (optional) The end date/due date to set.</span>
<a href="#l10.7"></a><span id="l10.7">  * @param aInitialDate  (optional) The reference date for the date pickers</span>
<a href="#l10.8"></a><span id="l10.8">  * @param aForceAllday  (optional) Force the event/task to be an allday item.</span>
<a href="#l10.9"></a><span id="l10.9">  */</span>
<a href="#l10.10"></a><span id="l10.10"> function setDefaultItemValues(aItem, aCalendar=null, aStartDate=null, aEndDate=null, aInitialDate=null, aForceAllday=false) {</span>
<a href="#l10.11"></a><span id="l10.11">     function endOfDay(aDate) {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-        let eod = aDate ? aDate.clone() : cal.now();</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+        let eod = aDate ? aDate.clone() : cal.dtz.now();</span>
<a href="#l10.14"></a><span id="l10.14">         eod.hour = Preferences.get(&quot;calendar.view.dayendhour&quot;, 19);</span>
<a href="#l10.15"></a><span id="l10.15">         eod.minute = 0;</span>
<a href="#l10.16"></a><span id="l10.16">         eod.second = 0;</span>
<a href="#l10.17"></a><span id="l10.17">         return eod;</span>
<a href="#l10.18"></a><span id="l10.18">     }</span>
<a href="#l10.19"></a><span id="l10.19">     function startOfDay(aDate) {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-        let sod = aDate ? aDate.clone() : cal.now();</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+        let sod = aDate ? aDate.clone() : cal.dtz.now();</span>
<a href="#l10.22"></a><span id="l10.22">         sod.hour = Preferences.get(&quot;calendar.view.daystarthour&quot;, 8);</span>
<a href="#l10.23"></a><span id="l10.23">         sod.minute = 0;</span>
<a href="#l10.24"></a><span id="l10.24">         sod.second = 0;</span>
<a href="#l10.25"></a><span id="l10.25">         return sod;</span>
<a href="#l10.26"></a><span id="l10.26">     }</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    let initialDate = aInitialDate ? aInitialDate.clone() : cal.now();</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+    let initialDate = aInitialDate ? aInitialDate.clone() : cal.dtz.now();</span>
<a href="#l10.30"></a><span id="l10.30">     initialDate.isDate = true;</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">     if (cal.isEvent(aItem)) {</span>
<a href="#l10.33"></a><span id="l10.33">         if (aStartDate) {</span>
<a href="#l10.34"></a><span id="l10.34">             aItem.startDate = aStartDate.clone();</span>
<a href="#l10.35"></a><span id="l10.35">             if (aStartDate.isDate &amp;&amp; !aForceAllday) {</span>
<a href="#l10.36"></a><span id="l10.36">                 // This is a special case where the date is specified, but the</span>
<a href="#l10.37"></a><span id="l10.37">                 // time is not. To take care, we setup up the time to our</span>
<a href="#l10.38"></a><span id="l10.38">                 // default event start time.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-                aItem.startDate = cal.getDefaultStartDate(aItem.startDate);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+                aItem.startDate = cal.dtz.getDefaultStartDate(aItem.startDate);</span>
<a href="#l10.41"></a><span id="l10.41">             } else if (aForceAllday) {</span>
<a href="#l10.42"></a><span id="l10.42">                 // If the event should be forced to be allday, then don't set up</span>
<a href="#l10.43"></a><span id="l10.43">                 // any default hours and directly make it allday.</span>
<a href="#l10.44"></a><span id="l10.44">                 aItem.startDate.isDate = true;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-                aItem.startDate.timezone = cal.floating();</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+                aItem.startDate.timezone = cal.dtz.floating;</span>
<a href="#l10.47"></a><span id="l10.47">             }</span>
<a href="#l10.48"></a><span id="l10.48">         } else {</span>
<a href="#l10.49"></a><span id="l10.49">             // If no start date was passed, then default to the next full hour</span>
<a href="#l10.50"></a><span id="l10.50">             // of today, but with the date of the selected day</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-            aItem.startDate = cal.getDefaultStartDate(initialDate);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+            aItem.startDate = cal.dtz.getDefaultStartDate(initialDate);</span>
<a href="#l10.53"></a><span id="l10.53">         }</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55">         if (aEndDate) {</span>
<a href="#l10.56"></a><span id="l10.56">             aItem.endDate = aEndDate.clone();</span>
<a href="#l10.57"></a><span id="l10.57">             if (aForceAllday) {</span>
<a href="#l10.58"></a><span id="l10.58">                 // XXX it is currently not specified, how callers that force all</span>
<a href="#l10.59"></a><span id="l10.59">                 // day should pass the end date. Right now, they should make</span>
<a href="#l10.60"></a><span id="l10.60">                 // sure that the end date is 00:00:00 of the day after.</span>
<a href="#l10.61"></a><span id="l10.61">                 aItem.endDate.isDate = true;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-                aItem.endDate.timezone = cal.floating();</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+                aItem.endDate.timezone = cal.dtz.floating;</span>
<a href="#l10.64"></a><span id="l10.64">             }</span>
<a href="#l10.65"></a><span id="l10.65">         } else {</span>
<a href="#l10.66"></a><span id="l10.66">             aItem.endDate = aItem.startDate.clone();</span>
<a href="#l10.67"></a><span id="l10.67">             if (aForceAllday) {</span>
<a href="#l10.68"></a><span id="l10.68">                 // All day events need to go to the beginning of the next day.</span>
<a href="#l10.69"></a><span id="l10.69">                 aItem.endDate.day++;</span>
<a href="#l10.70"></a><span id="l10.70">             } else {</span>
<a href="#l10.71"></a><span id="l10.71">                 // If the event is not all day, then add the default event</span>
<a href="#l10.72"></a><span id="l10.72">                 // length.</span>
<a href="#l10.73"></a><span id="l10.73">                 aItem.endDate.minute += Preferences.get(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l10.74"></a><span id="l10.74">             }</span>
<a href="#l10.75"></a><span id="l10.75">         }</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">         // Free/busy status is only valid for events, must not be set for tasks.</span>
<a href="#l10.78"></a><span id="l10.78">         aItem.setProperty(&quot;TRANSP&quot;, cal.getEventDefaultTransparency(aForceAllday));</span>
<a href="#l10.79"></a><span id="l10.79">     } else if (cal.isToDo(aItem)) {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-        let now = cal.now();</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+        let now = cal.dtz.now();</span>
<a href="#l10.82"></a><span id="l10.82">         let initDate = initialDate ? initialDate.clone() : now;</span>
<a href="#l10.83"></a><span id="l10.83">         initDate.isDate = false;</span>
<a href="#l10.84"></a><span id="l10.84">         initDate.hour = now.hour;</span>
<a href="#l10.85"></a><span id="l10.85">         initDate.minute = now.minute;</span>
<a href="#l10.86"></a><span id="l10.86">         initDate.second = now.second;</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88">         if (aStartDate) {</span>
<a href="#l10.89"></a><span id="l10.89">             aItem.entryDate = aStartDate.clone();</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineat">@@ -448,17 +448,17 @@ function openEventDialog(calendarItem, c</span>
<a href="#l10.91"></a><span id="l10.91"> </span>
<a href="#l10.92"></a><span id="l10.92">     // Setup the window arguments</span>
<a href="#l10.93"></a><span id="l10.93">     let args = {};</span>
<a href="#l10.94"></a><span id="l10.94">     args.calendarEvent = calendarItem;</span>
<a href="#l10.95"></a><span id="l10.95">     args.calendar = calendar;</span>
<a href="#l10.96"></a><span id="l10.96">     args.mode = mode;</span>
<a href="#l10.97"></a><span id="l10.97">     args.onOk = callback;</span>
<a href="#l10.98"></a><span id="l10.98">     args.job = job;</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    args.initialStartDateValue = initialDate || cal.getDefaultStartDate();</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+    args.initialStartDateValue = initialDate || cal.dtz.getDefaultStartDate();</span>
<a href="#l10.101"></a><span id="l10.101">     args.counterProposal = counterProposal;</span>
<a href="#l10.102"></a><span id="l10.102">     args.inTab = Preferences.get(&quot;calendar.item.editInTab&quot;, false);</span>
<a href="#l10.103"></a><span id="l10.103">     args.useNewItemUI = Preferences.get(&quot;calendar.item.useNewItemUI&quot;, false);</span>
<a href="#l10.104"></a><span id="l10.104"> </span>
<a href="#l10.105"></a><span id="l10.105">     // this will be called if file-&gt;new has been selected from within the dialog</span>
<a href="#l10.106"></a><span id="l10.106">     args.onNewEvent = function(opcalendar) {</span>
<a href="#l10.107"></a><span id="l10.107">         createEventWithDialog(opcalendar, null, null);</span>
<a href="#l10.108"></a><span id="l10.108">     };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -81,18 +81,18 @@</span>
<a href="#l11.4"></a><span id="l11.4">             cal.ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l11.5"></a><span id="l11.5">             this.mOccurrence = val;</span>
<a href="#l11.6"></a><span id="l11.6">             if (cal.isEvent(val)) {</span>
<a href="#l11.7"></a><span id="l11.7">                 if (!val.startDate.isDate) {</span>
<a href="#l11.8"></a><span id="l11.8">                     let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l11.9"></a><span id="l11.9">                     let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l11.10"></a><span id="l11.10">                                               .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l11.11"></a><span id="l11.11">                     let timezone = this.calendarView ? this.calendarView.mTimezone</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-                                                     : cal.calendarDefaultTimezone();</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                    let parentDate = cal.ensureDateTime(this.parentBox.date);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+                                                     : cal.dtz.defaultTimezone;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+                    let parentDate = cal.dtz.ensureDateTime(this.parentBox.date);</span>
<a href="#l11.16"></a><span id="l11.16">                     let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l11.17"></a><span id="l11.17">                     let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l11.18"></a><span id="l11.18">                     let nextDay = parentDate.clone();</span>
<a href="#l11.19"></a><span id="l11.19">                     nextDay.day++;</span>
<a href="#l11.20"></a><span id="l11.20">                     let comp = endTime.compare(nextDay);</span>
<a href="#l11.21"></a><span id="l11.21">                     if (startTime.compare(parentDate) == -1) {</span>
<a href="#l11.22"></a><span id="l11.22">                         if (comp == 1) {</span>
<a href="#l11.23"></a><span id="l11.23">                             label.value = &quot;&quot;;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -290,18 +290,18 @@</span>
<a href="#l11.25"></a><span id="l11.25">       &lt;method name=&quot;onDropItem&quot;&gt;</span>
<a href="#l11.26"></a><span id="l11.26">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l11.27"></a><span id="l11.27">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l11.28"></a><span id="l11.28">             // When item's timezone is different than the default one, the</span>
<a href="#l11.29"></a><span id="l11.29">             // item might get moved on a day different than the drop day.</span>
<a href="#l11.30"></a><span id="l11.30">             // Changing the drop day allows to compensate a possible difference.</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">             // Figure out if the timezones cause a days difference.</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-            let start = (aItem[cal.calGetStartDateProp(aItem)] ||</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-                         aItem[cal.calGetEndDateProp(aItem)]).clone();</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+            let start = (aItem[cal.dtz.startDateProp(aItem)] ||</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+                         aItem[cal.dtz.endDateProp(aItem)]).clone();</span>
<a href="#l11.37"></a><span id="l11.37">             let dayboxDate = this.mDate.clone();</span>
<a href="#l11.38"></a><span id="l11.38">             if (start.timezone != dayboxDate.timezone) {</span>
<a href="#l11.39"></a><span id="l11.39">                 let startInDefaultTz = start.clone().getInTimezone(dayboxDate.timezone);</span>
<a href="#l11.40"></a><span id="l11.40">                 start.isDate = true;</span>
<a href="#l11.41"></a><span id="l11.41">                 startInDefaultTz.isDate = true;</span>
<a href="#l11.42"></a><span id="l11.42">                 startInDefaultTz.timezone = start.timezone;</span>
<a href="#l11.43"></a><span id="l11.43">                 let dayDiff = start.subtractDate(startInDefaultTz);</span>
<a href="#l11.44"></a><span id="l11.44">                 // Change the day where to drop the item.</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineat">@@ -605,17 +605,17 @@</span>
<a href="#l11.46"></a><span id="l11.46">             }</span>
<a href="#l11.47"></a><span id="l11.47">             this.fireEvent(&quot;dayselect&quot;, realVal);</span>
<a href="#l11.48"></a><span id="l11.48">             return val;</span>
<a href="#l11.49"></a><span id="l11.49">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.50"></a><span id="l11.50">       &lt;/property&gt;</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">       &lt;property name=&quot;selectedDateTime&quot;&gt;</span>
<a href="#l11.53"></a><span id="l11.53">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-            return cal.getDefaultStartDate(this.selectedDay);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+            return cal.dtz.getDefaultStartDate(this.selectedDay);</span>
<a href="#l11.56"></a><span id="l11.56">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l11.57"></a><span id="l11.57">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l11.58"></a><span id="l11.58">             this.mClickedTime = val;</span>
<a href="#l11.59"></a><span id="l11.59">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l11.60"></a><span id="l11.60">       &lt;/property&gt;</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62">       &lt;method name=&quot;showDate&quot;&gt;</span>
<a href="#l11.63"></a><span id="l11.63">         &lt;parameter name=&quot;aDate&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -142,17 +142,17 @@</span>
<a href="#l12.4"></a><span id="l12.4">                 // calculate duration pixel as the difference between</span>
<a href="#l12.5"></a><span id="l12.5">                 // start pixel and end pixel to avoid rounding errors.</span>
<a href="#l12.6"></a><span id="l12.6">                 let startPix = Math.round(theMin * this.mPixPerMin);</span>
<a href="#l12.7"></a><span id="l12.7">                 let endPix = Math.round((theMin + dur) * this.mPixPerMin);</span>
<a href="#l12.8"></a><span id="l12.8">                 let durPix = endPix - startPix;</span>
<a href="#l12.9"></a><span id="l12.9">                 let box;</span>
<a href="#l12.10"></a><span id="l12.10">                 if (dur == 60) {</span>
<a href="#l12.11"></a><span id="l12.11">                     jsTime.setHours(theHour, 0, 0);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                    timeString = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+                    timeString = timeFormatter.formatTime(cal.dtz.jsDateToDateTime(jsTime, cal.dtz.floating));</span>
<a href="#l12.14"></a><span id="l12.14">                     box = makeTimeBox(timeString, durPix);</span>
<a href="#l12.15"></a><span id="l12.15">                 } else {</span>
<a href="#l12.16"></a><span id="l12.16">                     box = makeTimeBox(&quot;&quot;, durPix);</span>
<a href="#l12.17"></a><span id="l12.17">                 }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">                 // Set up workweek hours</span>
<a href="#l12.20"></a><span id="l12.20">                 if (theHour &lt; this.mDayStartHour || theHour &gt;= this.mDayEndHour) {</span>
<a href="#l12.21"></a><span id="l12.21">                     box.setAttribute(&quot;off-time&quot;, &quot;true&quot;);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -242,17 +242,17 @@</span>
<a href="#l12.23"></a><span id="l12.23">       &lt;xul:calendar-event-box anonid=&quot;config-box&quot; hidden=&quot;true&quot; xbl:inherits=&quot;orient&quot;/&gt;</span>
<a href="#l12.24"></a><span id="l12.24">     &lt;/content&gt;</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">     &lt;implementation&gt;</span>
<a href="#l12.27"></a><span id="l12.27">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l12.28"></a><span id="l12.28">           Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">           this.mEventInfos = [];</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-          this.mTimezone = cal.UTC();</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+          this.mTimezone = cal.dtz.UTC;</span>
<a href="#l12.33"></a><span id="l12.33">           this.mSelectedItemIds = {};</span>
<a href="#l12.34"></a><span id="l12.34">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">       &lt;!-- fields --&gt;</span>
<a href="#l12.37"></a><span id="l12.37">       &lt;field name=&quot;mPixPerMin&quot;&gt;0.6&lt;/field&gt;</span>
<a href="#l12.38"></a><span id="l12.38">       &lt;field name=&quot;mStartMin&quot;&gt;0&lt;/field&gt;</span>
<a href="#l12.39"></a><span id="l12.39">       &lt;field name=&quot;mEndMin&quot;&gt;24 * 60&lt;/field&gt;</span>
<a href="#l12.40"></a><span id="l12.40">       &lt;field name=&quot;mDayStartMin&quot;&gt;8 * 60&lt;/field&gt;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineat">@@ -1198,31 +1198,31 @@</span>
<a href="#l12.42"></a><span id="l12.42">                         prevEnd = col[col.length - 1].endDate.clone();</span>
<a href="#l12.43"></a><span id="l12.43">                     } else {</span>
<a href="#l12.44"></a><span id="l12.44">                         // First event in the column, add a placeholder for the</span>
<a href="#l12.45"></a><span id="l12.45">                         // blank time from this.mStartMin to the event's start</span>
<a href="#l12.46"></a><span id="l12.46">                         prevEnd = start.clone();</span>
<a href="#l12.47"></a><span id="l12.47">                         prevEnd.hour = 0;</span>
<a href="#l12.48"></a><span id="l12.48">                         prevEnd.minute = this.mStartMin;</span>
<a href="#l12.49"></a><span id="l12.49">                     }</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-                    prevEnd.timezone = cal.floating();</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+                    prevEnd.timezone = cal.dtz.floating;</span>
<a href="#l12.52"></a><span id="l12.52">                     // the reason why we need to calculate time durations</span>
<a href="#l12.53"></a><span id="l12.53">                     // based on floating timezones is that we need avoid</span>
<a href="#l12.54"></a><span id="l12.54">                     // dst gaps in this case. converting the date/times to</span>
<a href="#l12.55"></a><span id="l12.55">                     // floating conveys this idea in a natural way. note that</span>
<a href="#l12.56"></a><span id="l12.56">                     // we explicitly don't use getInTimezone() as it would</span>
<a href="#l12.57"></a><span id="l12.57">                     // be slightly more expensive in terms of performance.</span>
<a href="#l12.58"></a><span id="l12.58">                     let floatstart = start.clone();</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-                    floatstart.timezone = cal.floating();</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+                    floatstart.timezone = cal.dtz.floating;</span>
<a href="#l12.61"></a><span id="l12.61">                     let dur = floatstart.subtractDate(prevEnd);</span>
<a href="#l12.62"></a><span id="l12.62">                     if (dur.inSeconds) {</span>
<a href="#l12.63"></a><span id="l12.63">                         col.push({ duration: dur });</span>
<a href="#l12.64"></a><span id="l12.64">                     }</span>
<a href="#l12.65"></a><span id="l12.65">                     let floatend = end.clone();</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-                    floatend.timezone = cal.floating();</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+                    floatend.timezone = cal.dtz.floating;</span>
<a href="#l12.68"></a><span id="l12.68">                     col.push({</span>
<a href="#l12.69"></a><span id="l12.69">                         event: data.itemInfo.event,</span>
<a href="#l12.70"></a><span id="l12.70">                         endDate: end,</span>
<a href="#l12.71"></a><span id="l12.71">                         startDate: start,</span>
<a href="#l12.72"></a><span id="l12.72">                         duration: floatend.subtractDate(floatstart)</span>
<a href="#l12.73"></a><span id="l12.73">                     });</span>
<a href="#l12.74"></a><span id="l12.74">                 }</span>
<a href="#l12.75"></a><span id="l12.75">                 layerOffset = layers.length;</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineat">@@ -1956,19 +1956,19 @@</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78">             let endhr = Math.floor(realendmin / 60);</span>
<a href="#l12.79"></a><span id="l12.79">             let endmin = realendmin % 60;</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81">             let timeFormatter = cal.getDateFormatter();</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83">             let jsTime = new Date();</span>
<a href="#l12.84"></a><span id="l12.84">             jsTime.setHours(starthr, startmin);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-            let startstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+            let startstr = timeFormatter.formatTime(cal.dtz.jsDateToDateTime(jsTime, cal.dtz.floating));</span>
<a href="#l12.87"></a><span id="l12.87">             jsTime.setHours(endhr, endmin);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-            let endstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+            let endstr = timeFormatter.formatTime(cal.dtz.jsDateToDateTime(jsTime, cal.dtz.floating));</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91">             // Tasks without Entry or Due date have a string as first label</span>
<a href="#l12.92"></a><span id="l12.92">             // instead of the time.</span>
<a href="#l12.93"></a><span id="l12.93">             if (cal.isToDo(this.mDragState.dragOccurrence)) {</span>
<a href="#l12.94"></a><span id="l12.94">                 if (!this.mDragState.dragOccurrence.dueDate) {</span>
<a href="#l12.95"></a><span id="l12.95">                     startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyEntryDate&quot;);</span>
<a href="#l12.96"></a><span id="l12.96">                 } else if (!this.mDragState.dragOccurrence.entryDate) {</span>
<a href="#l12.97"></a><span id="l12.97">                     startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyDueDate&quot;);</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineat">@@ -2600,17 +2600,17 @@</span>
<a href="#l12.99"></a><span id="l12.99">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.100"></a><span id="l12.100">       &lt;/method&gt;</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102">       &lt;method name=&quot;updateTimeIndicatorPosition&quot;&gt;</span>
<a href="#l12.103"></a><span id="l12.103">         &lt;parameter name=&quot;aUpdateTheTimer&quot;/&gt;</span>
<a href="#l12.104"></a><span id="l12.104">         &lt;parameter name=&quot;aPpmChanged&quot;/&gt;</span>
<a href="#l12.105"></a><span id="l12.105">         &lt;parameter name=&quot;aViewChanged&quot;/&gt;</span>
<a href="#l12.106"></a><span id="l12.106">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-            let now = cal.now();</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+            let now = cal.dtz.now();</span>
<a href="#l12.109"></a><span id="l12.109">             let nowMinutes = now.hour * 60 + now.minute;</span>
<a href="#l12.110"></a><span id="l12.110">             if (aUpdateTheTimer) {</span>
<a href="#l12.111"></a><span id="l12.111">                 let prefInt = this.mTimeIndicatorInterval;</span>
<a href="#l12.112"></a><span id="l12.112">                 if (prefInt == 0) {</span>
<a href="#l12.113"></a><span id="l12.113">                     timeIndicator.cancel();</span>
<a href="#l12.114"></a><span id="l12.114">                     return;</span>
<a href="#l12.115"></a><span id="l12.115">                 }</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117" class="difflineat">@@ -3035,23 +3035,23 @@</span>
<a href="#l12.118"></a><span id="l12.118">             } else { // undated todo</span>
<a href="#l12.119"></a><span id="l12.119">                 return [];</span>
<a href="#l12.120"></a><span id="l12.120">             }</span>
<a href="#l12.121"></a><span id="l12.121">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.122"></a><span id="l12.122">       &lt;/method&gt;</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">       &lt;method name=&quot;centerSelectedItems&quot;&gt;</span>
<a href="#l12.125"></a><span id="l12.125">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-            let displayTZ = cal.calendarDefaultTimezone();</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+            let displayTZ = cal.dtz.defaultTimezone;</span>
<a href="#l12.128"></a><span id="l12.128">             let lowMinute = 24 * 60;</span>
<a href="#l12.129"></a><span id="l12.129">             let highMinute = 0;</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131">             for (let item of this.mSelectedItems) {</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-                let startDateProperty = cal.calGetStartDateProp(item);</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-                let endDateProperty = cal.calGetEndDateProp(item);</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+                let startDateProperty = cal.dtz.startDateProp(item);</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+                let endDateProperty = cal.dtz.endDateProp(item);</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137">                 let occs = [];</span>
<a href="#l12.138"></a><span id="l12.138">                 if (item.recurrenceInfo) {</span>
<a href="#l12.139"></a><span id="l12.139">                     // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l12.140"></a><span id="l12.140">                     occs = item.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l12.141"></a><span id="l12.141">                 } else {</span>
<a href="#l12.142"></a><span id="l12.142">                     occs = [item];</span>
<a href="#l12.143"></a><span id="l12.143">                 }</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineat">@@ -3087,17 +3087,17 @@</span>
<a href="#l12.145"></a><span id="l12.145">                     if (occStart.timezone != displayTZ) {</span>
<a href="#l12.146"></a><span id="l12.146">                         occStart = occStart.getInTimezone(displayTZ);</span>
<a href="#l12.147"></a><span id="l12.147">                     }</span>
<a href="#l12.148"></a><span id="l12.148">                     if (occEnd.timezone != displayTZ) {</span>
<a href="#l12.149"></a><span id="l12.149">                         occEnd = occEnd.getInTimezone(displayTZ);</span>
<a href="#l12.150"></a><span id="l12.150">                     }</span>
<a href="#l12.151"></a><span id="l12.151">                     // If crosses midnite in current TZ, set end just</span>
<a href="#l12.152"></a><span id="l12.152">                     // before midnite after start so start/title usually visible.</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-                    if (!cal.sameDay(occStart, occEnd)) {</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+                    if (!cal.dtz.sameDay(occStart, occEnd)) {</span>
<a href="#l12.155"></a><span id="l12.155">                         occEnd = occStart.clone();</span>
<a href="#l12.156"></a><span id="l12.156">                         occEnd.day = occStart.day;</span>
<a href="#l12.157"></a><span id="l12.157">                         occEnd.hour = 23;</span>
<a href="#l12.158"></a><span id="l12.158">                         occEnd.minute = 59;</span>
<a href="#l12.159"></a><span id="l12.159">                     }</span>
<a href="#l12.160"></a><span id="l12.160"> </span>
<a href="#l12.161"></a><span id="l12.161">                     // Ensure range shows occ</span>
<a href="#l12.162"></a><span id="l12.162">                     lowMinute = Math.min(occStart.hour * 60 + occStart.minute,</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineat">@@ -3519,19 +3519,19 @@</span>
<a href="#l12.164"></a><span id="l12.164">         &lt;parameter name=&quot;aOccurrences&quot;/&gt;</span>
<a href="#l12.165"></a><span id="l12.165">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.166"></a><span id="l12.166">             if (!this.mDateColumns || !this.mDateColumns.length) {</span>
<a href="#l12.167"></a><span id="l12.167">                 return [];</span>
<a href="#l12.168"></a><span id="l12.168">             }</span>
<a href="#l12.169"></a><span id="l12.169"> </span>
<a href="#l12.170"></a><span id="l12.170">             let occMap = {};</span>
<a href="#l12.171"></a><span id="l12.171">             for (let occ of aOccurrences) {</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineminus">-                let startDate = occ[cal.calGetStartDateProp(occ)]</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+                let startDate = occ[cal.dtz.startDateProp(occ)]</span>
<a href="#l12.174"></a><span id="l12.174">                                 .getInTimezone(this.mStartDate.timezone);</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-                let endDate = occ[cal.calGetEndDateProp(occ)]</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+                let endDate = occ[cal.dtz.endDateProp(occ)]</span>
<a href="#l12.177"></a><span id="l12.177">                                 .getInTimezone(this.mEndDate.timezone) || startDate;</span>
<a href="#l12.178"></a><span id="l12.178">                 if (startDate.compare(this.mStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l12.179"></a><span id="l12.179">                     endDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l12.180"></a><span id="l12.180">                     for (let i = startDate.day; i &lt;= endDate.day; i++) {</span>
<a href="#l12.181"></a><span id="l12.181">                         occMap[i] = true;</span>
<a href="#l12.182"></a><span id="l12.182">                     }</span>
<a href="#l12.183"></a><span id="l12.183">                 }</span>
<a href="#l12.184"></a><span id="l12.184">             }</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineat">@@ -3611,18 +3611,18 @@</span>
<a href="#l12.186"></a><span id="l12.186">             }</span>
<a href="#l12.187"></a><span id="l12.187">             return null;</span>
<a href="#l12.188"></a><span id="l12.188">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.189"></a><span id="l12.189">       &lt;/method&gt;</span>
<a href="#l12.190"></a><span id="l12.190"> </span>
<a href="#l12.191"></a><span id="l12.191">       &lt;method name=&quot;adjustScrollbarSpacersForAlldayEvents&quot;&gt;</span>
<a href="#l12.192"></a><span id="l12.192">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l12.193"></a><span id="l12.193">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-            let startDate = aEvent[cal.calGetStartDateProp(aEvent)];</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineminus">-            let endDate = aEvent[cal.calGetEndDateProp(aEvent)];</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+            let startDate = aEvent[cal.dtz.startDateProp(aEvent)];</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+            let endDate = aEvent[cal.dtz.endDateProp(aEvent)];</span>
<a href="#l12.198"></a><span id="l12.198">             if ((startDate &amp;&amp; startDate.isDate) ||</span>
<a href="#l12.199"></a><span id="l12.199">                 (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l12.200"></a><span id="l12.200">                 // If this is an all day event, then the header with allday</span>
<a href="#l12.201"></a><span id="l12.201">                 // events could possibly get a scrollbar. Readjust them.</span>
<a href="#l12.202"></a><span id="l12.202">                 this.adjustScrollBarSpacers();</span>
<a href="#l12.203"></a><span id="l12.203">             }</span>
<a href="#l12.204"></a><span id="l12.204">         ]]&gt;&lt;/body&gt;</span>
<a href="#l12.205"></a><span id="l12.205">       &lt;/method&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -285,17 +285,17 @@</span>
<a href="#l13.4"></a><span id="l13.4">             return val;</span>
<a href="#l13.5"></a><span id="l13.5">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l13.6"></a><span id="l13.6">       &lt;/property&gt;</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">       &lt;method name=&quot;duration&quot;&gt;</span>
<a href="#l13.9"></a><span id="l13.9">         &lt;parameter name=&quot;aTask&quot;/&gt;</span>
<a href="#l13.10"></a><span id="l13.10">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.11"></a><span id="l13.11">             if (aTask &amp;&amp; aTask.dueDate &amp;&amp; aTask.dueDate.isValid) {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                let dur = aTask.dueDate.subtractDate(cal.now());</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+                let dur = aTask.dueDate.subtractDate(cal.dtz.now());</span>
<a href="#l13.14"></a><span id="l13.14">                 if (!dur.isNegative) {</span>
<a href="#l13.15"></a><span id="l13.15">                     let minutes = Math.ceil(dur.inSeconds / 60);</span>
<a href="#l13.16"></a><span id="l13.16">                     if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l13.17"></a><span id="l13.17">                         let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l13.18"></a><span id="l13.18">                         return dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l13.19"></a><span id="l13.19">                     } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l13.20"></a><span id="l13.20">                         let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l13.21"></a><span id="l13.21">                         return dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -704,17 +704,17 @@</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24">             /**</span>
<a href="#l13.25"></a><span id="l13.25">              * Task Tree Events</span>
<a href="#l13.26"></a><span id="l13.26">              */</span>
<a href="#l13.27"></a><span id="l13.27">             onSelect: function(event) {},</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">             onDoubleClick: function(event) {</span>
<a href="#l13.30"></a><span id="l13.30">                 if (event.button == 0) {</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-                    let initialDate = cal.getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+                    let initialDate = cal.dtz.getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l13.33"></a><span id="l13.33">                     let col = {};</span>
<a href="#l13.34"></a><span id="l13.34">                     let item = this._getItemFromEvent(event, col);</span>
<a href="#l13.35"></a><span id="l13.35">                     if (item) {</span>
<a href="#l13.36"></a><span id="l13.36">                         let colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l13.37"></a><span id="l13.37">                         if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l13.38"></a><span id="l13.38">                             // item holds checkbox state toggled by first click,</span>
<a href="#l13.39"></a><span id="l13.39">                             // so don't call modifyEventWithDialog</span>
<a href="#l13.40"></a><span id="l13.40">                             // to make sure user notices state changed.</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -783,17 +783,17 @@</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">             // Helper function to display datetimes</span>
<a href="#l13.44"></a><span id="l13.44">             _formatDateTime: function(aDateTime) {</span>
<a href="#l13.45"></a><span id="l13.45">                 let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l13.46"></a><span id="l13.46">                                               .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48">                 // datetime is from todo object, it is not a javascript date</span>
<a href="#l13.49"></a><span id="l13.49">                 if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-                    let dateTime = aDateTime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+                    let dateTime = aDateTime.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l13.52"></a><span id="l13.52">                     return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l13.53"></a><span id="l13.53">                 }</span>
<a href="#l13.54"></a><span id="l13.54">                 return &quot;&quot;;</span>
<a href="#l13.55"></a><span id="l13.55">             }</span>
<a href="#l13.56"></a><span id="l13.56">         })</span>
<a href="#l13.57"></a><span id="l13.57">       ]]&gt;&lt;/field&gt;</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">       &lt;!--</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineat">@@ -992,17 +992,17 @@</span>
<a href="#l13.61"></a><span id="l13.61">                 let modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l13.62"></a><span id="l13.62">                 let column = this.mTreeView.selectedColumn;</span>
<a href="#l13.63"></a><span id="l13.63">                 cal.sortEntry.mSortKey = column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l13.64"></a><span id="l13.64">                                          ? column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l13.65"></a><span id="l13.65">                                          : column.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l13.66"></a><span id="l13.66">                 let sortType = cal.getSortTypeForSortKey(cal.sortEntry.mSortKey);</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68">                 // sort (key,item) entries</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-                cal.sortEntry.mSortStartedDate = cal.now();</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+                cal.sortEntry.mSortStartedDate = cal.dtz.now();</span>
<a href="#l13.71"></a><span id="l13.71">                 let entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l13.72"></a><span id="l13.72">                 entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l13.73"></a><span id="l13.73">                 this.mTaskArray = entries.map(cal.sortEntryItem);</span>
<a href="#l13.74"></a><span id="l13.74">             }</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76">             this.recreateHashTable();</span>
<a href="#l13.77"></a><span id="l13.77">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.78"></a><span id="l13.78">       &lt;/method&gt;</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineat">@@ -1018,17 +1018,17 @@</span>
<a href="#l13.80"></a><span id="l13.80">                 this.mTreeView.treebox.invalidate();</span>
<a href="#l13.81"></a><span id="l13.81">             }</span>
<a href="#l13.82"></a><span id="l13.82">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.83"></a><span id="l13.83">       &lt;/method&gt;</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">       &lt;method name=&quot;getInitialDate&quot;&gt;</span>
<a href="#l13.86"></a><span id="l13.86">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.87"></a><span id="l13.87">             let initialDate = currentView().selectedDay;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-            return initialDate ? initialDate : cal.now();</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+            return initialDate ? initialDate : cal.dtz.now();</span>
<a href="#l13.90"></a><span id="l13.90">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.91"></a><span id="l13.91">       &lt;/method&gt;</span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93">       &lt;method name=&quot;doUpdateFilter&quot;&gt;</span>
<a href="#l13.94"></a><span id="l13.94">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l13.95"></a><span id="l13.95">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.96"></a><span id="l13.96">             let needsRefresh = false;</span>
<a href="#l13.97"></a><span id="l13.97">             let oldStart = this.mFilter.mStartDate;</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineat">@@ -1160,24 +1160,24 @@</span>
<a href="#l13.99"></a><span id="l13.99">   &lt;binding id=&quot;calendar-task-tree-todaypane&quot; extends=&quot;chrome://calendar/content/calendar-task-tree.xml#calendar-task-tree&quot;&gt;</span>
<a href="#l13.100"></a><span id="l13.100">     &lt;implementation&gt;</span>
<a href="#l13.101"></a><span id="l13.101">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l13.102"></a><span id="l13.102">           Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.103"></a><span id="l13.103">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105">       &lt;method name=&quot;getInitialDate&quot;&gt;</span>
<a href="#l13.106"></a><span id="l13.106">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-            let initialDate = agendaListbox.today ? agendaListbox.today.start : cal.now();</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-            return initialDate ? initialDate : cal.now();</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+            let initialDate = agendaListbox.today ? agendaListbox.today.start : cal.dtz.now();</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+            return initialDate ? initialDate : cal.dtz.now();</span>
<a href="#l13.111"></a><span id="l13.111">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.112"></a><span id="l13.112">       &lt;/method&gt;</span>
<a href="#l13.113"></a><span id="l13.113"> </span>
<a href="#l13.114"></a><span id="l13.114">       &lt;method name=&quot;updateFilter&quot;&gt;</span>
<a href="#l13.115"></a><span id="l13.115">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l13.116"></a><span id="l13.116">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l13.117"></a><span id="l13.117">             this.mFilter.selectedDate = agendaListbox.today &amp;&amp; agendaListbox.today.start ?</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-                                        agendaListbox.today.start : cal.now();</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+                                        agendaListbox.today.start : cal.dtz.now();</span>
<a href="#l13.120"></a><span id="l13.120">             this.doUpdateFilter(aFilter);</span>
<a href="#l13.121"></a><span id="l13.121">         ]]&gt;&lt;/body&gt;</span>
<a href="#l13.122"></a><span id="l13.122">       &lt;/method&gt;</span>
<a href="#l13.123"></a><span id="l13.123">     &lt;/implementation&gt;</span>
<a href="#l13.124"></a><span id="l13.124">   &lt;/binding&gt;</span>
<a href="#l13.125"></a><span id="l13.125"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -80,17 +80,17 @@ var taskDetailsView = {</span>
<a href="#l14.4"></a><span id="l14.4">                         statusDetails.value = cal.calGetString(</span>
<a href="#l14.5"></a><span id="l14.5">                             &quot;calendar&quot;,</span>
<a href="#l14.6"></a><span id="l14.6">                             &quot;taskDetailsStatusInProgress&quot;, [percent]);</span>
<a href="#l14.7"></a><span id="l14.7">                         break;</span>
<a href="#l14.8"></a><span id="l14.8">                     }</span>
<a href="#l14.9"></a><span id="l14.9">                     case &quot;COMPLETED&quot;: {</span>
<a href="#l14.10"></a><span id="l14.10">                         if (item.completedDate) {</span>
<a href="#l14.11"></a><span id="l14.11">                             let completedDate = item.completedDate.getInTimezone(</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-                                                    cal.calendarDefaultTimezone());</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+                                                    cal.dtz.defaultTimezone);</span>
<a href="#l14.14"></a><span id="l14.14">                             statusDetails.value = cal.calGetString(</span>
<a href="#l14.15"></a><span id="l14.15">                                 &quot;calendar&quot;,</span>
<a href="#l14.16"></a><span id="l14.16">                                 &quot;taskDetailsStatusCompletedOn&quot;,</span>
<a href="#l14.17"></a><span id="l14.17">                                 [dateFormatter.formatDateTime(completedDate)]);</span>
<a href="#l14.18"></a><span id="l14.18">                         }</span>
<a href="#l14.19"></a><span id="l14.19">                         break;</span>
<a href="#l14.20"></a><span id="l14.20">                     }</span>
<a href="#l14.21"></a><span id="l14.21">                     case &quot;CANCELLED&quot;: {</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -114,17 +114,17 @@ var taskDetailsView = {</span>
<a href="#l14.23"></a><span id="l14.23">             let parentItem = item;</span>
<a href="#l14.24"></a><span id="l14.24">             if (parentItem.parentItem != parentItem) {</span>
<a href="#l14.25"></a><span id="l14.25">                 // XXXdbo Didn't we want to get rid of these checks?</span>
<a href="#l14.26"></a><span id="l14.26">                 parentItem = parentItem.parentItem;</span>
<a href="#l14.27"></a><span id="l14.27">             }</span>
<a href="#l14.28"></a><span id="l14.28">             let recurrenceInfo = parentItem.recurrenceInfo;</span>
<a href="#l14.29"></a><span id="l14.29">             let recurStart = parentItem.recurrenceStartDate;</span>
<a href="#l14.30"></a><span id="l14.30">             if (displayElement(&quot;calendar-task-details-repeat-row&quot;, recurrenceInfo &amp;&amp; recurStart)) {</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-                let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+                let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l14.33"></a><span id="l14.33">                 let startDate = recurStart.getInTimezone(kDefaultTimezone);</span>
<a href="#l14.34"></a><span id="l14.34">                 let endDate = item.dueDate ? item.dueDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l14.35"></a><span id="l14.35">                 let detailsString = recurrenceRule2String(recurrenceInfo, startDate, endDate, startDate.isDate);</span>
<a href="#l14.36"></a><span id="l14.36">                 if (detailsString) {</span>
<a href="#l14.37"></a><span id="l14.37">                     let rpv = document.getElementById(&quot;calendar-task-details-repeat&quot;);</span>
<a href="#l14.38"></a><span id="l14.38">                     rpv.value = detailsString.split(&quot;\n&quot;).join(&quot; &quot;);</span>
<a href="#l14.39"></a><span id="l14.39">                 }</span>
<a href="#l14.40"></a><span id="l14.40">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -193,17 +193,17 @@ function prepareCalendarUnifinder() {</span>
<a href="#l15.4"></a><span id="l15.4">     branch.addObserver(&quot;calendar.&quot;, unifinderObserver);</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">     // Check if this is not the hidden window, which has no UI elements</span>
<a href="#l15.7"></a><span id="l15.7">     if (unifinderTree) {</span>
<a href="#l15.8"></a><span id="l15.8">         // set up our calendar event observer</span>
<a href="#l15.9"></a><span id="l15.9">         let ccalendar = cal.getCompositeCalendar(window);</span>
<a href="#l15.10"></a><span id="l15.10">         ccalendar.addObserver(unifinderObserver);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-        kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+        kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15">         // Set up the filter</span>
<a href="#l15.16"></a><span id="l15.16">         unifinderTreeView.mFilter = new calFilter();</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">         // Set up the unifinder views.</span>
<a href="#l15.19"></a><span id="l15.19">         unifinderTreeView.treeElement = unifinderTree;</span>
<a href="#l15.20"></a><span id="l15.20">         unifinderTree.view = unifinderTreeView;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -548,17 +548,17 @@ var unifinderTreeView = {</span>
<a href="#l15.23"></a><span id="l15.23">      */</span>
<a href="#l15.24"></a><span id="l15.24">     sortItems: function() {</span>
<a href="#l15.25"></a><span id="l15.25">         if (this.selectedColumn) {</span>
<a href="#l15.26"></a><span id="l15.26">             let modifier = (this.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l15.27"></a><span id="l15.27">             let sortKey = unifinderTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l15.28"></a><span id="l15.28">             let sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l15.29"></a><span id="l15.29">             // sort (key,item) entries</span>
<a href="#l15.30"></a><span id="l15.30">             cal.sortEntry.mSortKey = sortKey;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-            cal.sortEntry.mSortStartedDate = cal.now();</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+            cal.sortEntry.mSortStartedDate = cal.dtz.now();</span>
<a href="#l15.33"></a><span id="l15.33">             let entries = this.eventArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l15.34"></a><span id="l15.34">             entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l15.35"></a><span id="l15.35">             this.eventArray = entries.map(cal.sortEntryItem);</span>
<a href="#l15.36"></a><span id="l15.36">         }</span>
<a href="#l15.37"></a><span id="l15.37">         this.calculateIndexMap();</span>
<a href="#l15.38"></a><span id="l15.38">     },</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -234,35 +234,35 @@ function switchToView(aViewType) {</span>
<a href="#l16.4"></a><span id="l16.4">     ];</span>
<a href="#l16.5"></a><span id="l16.5">     ids.forEach(x =&gt; setupViewNode(x, &quot;tooltiptext&quot;));</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">     try {</span>
<a href="#l16.8"></a><span id="l16.8">         selectedDay = viewDeck.selectedPanel.selectedDay;</span>
<a href="#l16.9"></a><span id="l16.9">         currentSelection = viewDeck.selectedPanel.getSelectedItems({});</span>
<a href="#l16.10"></a><span id="l16.10">     } catch (ex) {</span>
<a href="#l16.11"></a><span id="l16.11">         // This dies if no view has even been chosen this session, but that's</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        // ok because we'll just use cal.now() below.</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+        // ok because we'll just use cal.dtz.now() below.</span>
<a href="#l16.14"></a><span id="l16.14">     }</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16">     if (!selectedDay) {</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-        selectedDay = cal.now();</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+        selectedDay = cal.dtz.now();</span>
<a href="#l16.19"></a><span id="l16.19">     }</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21">     // Anyone wanting to plug in a view needs to follow this naming scheme</span>
<a href="#l16.22"></a><span id="l16.22">     let view = document.getElementById(aViewType + &quot;-view&quot;);</span>
<a href="#l16.23"></a><span id="l16.23">     viewDeck.selectedPanel = view;</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25">     // Select the corresponding tab</span>
<a href="#l16.26"></a><span id="l16.26">     let viewTabs = document.getElementById(&quot;view-tabs&quot;);</span>
<a href="#l16.27"></a><span id="l16.27">     viewTabs.selectedIndex = getViewDeck().selectedIndex;</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">     let compositeCal = cal.getCompositeCalendar(window);</span>
<a href="#l16.30"></a><span id="l16.30">     if (view.displayCalendar != compositeCal) {</span>
<a href="#l16.31"></a><span id="l16.31">         view.displayCalendar = compositeCal;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-        view.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+        view.timezone = cal.dtz.defaultTimezone;</span>
<a href="#l16.34"></a><span id="l16.34">         view.controller = calendarViewController;</span>
<a href="#l16.35"></a><span id="l16.35">     }</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">     view.goToDay(selectedDay);</span>
<a href="#l16.38"></a><span id="l16.38">     view.setSelectedItems(currentSelection.length, currentSelection);</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">     onCalendarViewResize();</span>
<a href="#l16.41"></a><span id="l16.41"> }</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineat">@@ -591,17 +591,17 @@ function toggleShowCompletedInView() {</span>
<a href="#l16.43"></a><span id="l16.43"> }</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45"> /**</span>
<a href="#l16.46"></a><span id="l16.46">  * Provides a neutral way to go to the current day in the views and minimonth.</span>
<a href="#l16.47"></a><span id="l16.47">  *</span>
<a href="#l16.48"></a><span id="l16.48">  * @param aDate     The date to go.</span>
<a href="#l16.49"></a><span id="l16.49">  */</span>
<a href="#l16.50"></a><span id="l16.50"> function goToDate(aDate) {</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-    getMinimonth().value = cal.dateTimeToJsDate(aDate);</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    getMinimonth().value = cal.dtz.dateTimeToJsDate(aDate);</span>
<a href="#l16.53"></a><span id="l16.53">     currentView().goToDay(aDate);</span>
<a href="#l16.54"></a><span id="l16.54"> }</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56"> /**</span>
<a href="#l16.57"></a><span id="l16.57">  * Returns the calendar view that was selected before restart, or the current</span>
<a href="#l16.58"></a><span id="l16.58">  * calendar view if it has already been set in this session</span>
<a href="#l16.59"></a><span id="l16.59">  *</span>
<a href="#l16.60"></a><span id="l16.60">  * @return          The last calendar view.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/calendar-views.xml</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.xml</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -40,17 +40,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l17.5"></a><span id="l17.5">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l17.6"></a><span id="l17.6">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.7"></a><span id="l17.7">             if (aNumber) {</span>
<a href="#l17.8"></a><span id="l17.8">                 let currentDay = this.startDay.clone();</span>
<a href="#l17.9"></a><span id="l17.9">                 currentDay.day += aNumber;</span>
<a href="#l17.10"></a><span id="l17.10">                 this.goToDay(currentDay);</span>
<a href="#l17.11"></a><span id="l17.11">             } else {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-                this.goToDay(cal.now());</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+                this.goToDay(cal.dtz.now());</span>
<a href="#l17.14"></a><span id="l17.14">             }</span>
<a href="#l17.15"></a><span id="l17.15">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.16"></a><span id="l17.16">       &lt;/method&gt;</span>
<a href="#l17.17"></a><span id="l17.17">     &lt;/implementation&gt;</span>
<a href="#l17.18"></a><span id="l17.18">   &lt;/binding&gt;</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20">   &lt;binding id=&quot;calendar-week-view&quot;</span>
<a href="#l17.21"></a><span id="l17.21">            extends=&quot;chrome://calendar/content/calendar-multiday-view.xml#calendar-multiday-view&quot;&gt;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -107,17 +107,17 @@</span>
<a href="#l17.23"></a><span id="l17.23">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l17.24"></a><span id="l17.24">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l17.25"></a><span id="l17.25">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l17.26"></a><span id="l17.26">             if (aNumber) {</span>
<a href="#l17.27"></a><span id="l17.27">                 let date = this.selectedDay.clone();</span>
<a href="#l17.28"></a><span id="l17.28">                 date.day += 7 * aNumber;</span>
<a href="#l17.29"></a><span id="l17.29">                 this.goToDay(date);</span>
<a href="#l17.30"></a><span id="l17.30">             } else {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-                this.goToDay(cal.now());</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+                this.goToDay(cal.dtz.now());</span>
<a href="#l17.33"></a><span id="l17.33">             }</span>
<a href="#l17.34"></a><span id="l17.34">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.35"></a><span id="l17.35">       &lt;/method&gt;</span>
<a href="#l17.36"></a><span id="l17.36">     &lt;/implementation&gt;</span>
<a href="#l17.37"></a><span id="l17.37">   &lt;/binding&gt;</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">   &lt;binding id=&quot;calendar-multiweek-view&quot; extends=&quot;chrome://calendar/content/calendar-month-view.xml#calendar-month-base-view&quot;&gt;</span>
<a href="#l17.40"></a><span id="l17.40">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineat">@@ -212,17 +212,17 @@</span>
<a href="#l17.42"></a><span id="l17.42">                 let savedSelectedDay = this.selectedDay.clone();</span>
<a href="#l17.43"></a><span id="l17.43">                 // aNumber only corresponds to the number of weeks to move</span>
<a href="#l17.44"></a><span id="l17.44">                 // make sure to compensate for previous weeks in view too</span>
<a href="#l17.45"></a><span id="l17.45">                 date.day += 7 * (aNumber + Preferences.get(&quot;calendar.previousweeks.inview&quot;, 4));</span>
<a href="#l17.46"></a><span id="l17.46">                 this.goToDay(date);</span>
<a href="#l17.47"></a><span id="l17.47">                 savedSelectedDay.day += 7 * aNumber;</span>
<a href="#l17.48"></a><span id="l17.48">                 this.selectedDay = savedSelectedDay;</span>
<a href="#l17.49"></a><span id="l17.49">             } else {</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-                let date = cal.now();</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+                let date = cal.dtz.now();</span>
<a href="#l17.52"></a><span id="l17.52">                 this.goToDay(date);</span>
<a href="#l17.53"></a><span id="l17.53">                 this.selectedDay = date;</span>
<a href="#l17.54"></a><span id="l17.54">             }</span>
<a href="#l17.55"></a><span id="l17.55">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.56"></a><span id="l17.56">       &lt;/method&gt;</span>
<a href="#l17.57"></a><span id="l17.57">     &lt;/implementation&gt;</span>
<a href="#l17.58"></a><span id="l17.58">   &lt;/binding&gt;</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60" class="difflineat">@@ -283,17 +283,17 @@</span>
<a href="#l17.61"></a><span id="l17.61">                 // correct for accidental rollover into the next month</span>
<a href="#l17.62"></a><span id="l17.62">                 if ((newSelectedDay.month - aNumber + 12) % 12 != oldSelectedDay.month) {</span>
<a href="#l17.63"></a><span id="l17.63">                     newSelectedDay.month -= 1;</span>
<a href="#l17.64"></a><span id="l17.64">                     newSelectedDay.day = newSelectedDay.endOfMonth.day;</span>
<a href="#l17.65"></a><span id="l17.65">                 }</span>
<a href="#l17.66"></a><span id="l17.66"> </span>
<a href="#l17.67"></a><span id="l17.67">                 this.selectedDay = newSelectedDay;</span>
<a href="#l17.68"></a><span id="l17.68">             } else {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-                let date = cal.now();</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+                let date = cal.dtz.now();</span>
<a href="#l17.71"></a><span id="l17.71">                 this.goToDay(date);</span>
<a href="#l17.72"></a><span id="l17.72">                 this.selectedDay = date;</span>
<a href="#l17.73"></a><span id="l17.73">             }</span>
<a href="#l17.74"></a><span id="l17.74">         ]]&gt;&lt;/body&gt;</span>
<a href="#l17.75"></a><span id="l17.75">       &lt;/method&gt;</span>
<a href="#l17.76"></a><span id="l17.76">     &lt;/implementation&gt;</span>
<a href="#l17.77"></a><span id="l17.77">   &lt;/binding&gt;</span>
<a href="#l17.78"></a><span id="l17.78"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -214,17 +214,17 @@ function getDuration(aMinutes) {</span>
<a href="#l18.4"></a><span id="l18.4">  * Check whether the snooze period exceeds the current limitation of the AlarmService and prompt</span>
<a href="#l18.5"></a><span id="l18.5">  * the user with a message if so</span>
<a href="#l18.6"></a><span id="l18.6">  * @param   {calIDuration}   aDuration   The duration to snooze</span>
<a href="#l18.7"></a><span id="l18.7">  * @returns {Boolean}</span>
<a href="#l18.8"></a><span id="l18.8">  */</span>
<a href="#l18.9"></a><span id="l18.9"> function aboveSnoozeLimit(aDuration) {</span>
<a href="#l18.10"></a><span id="l18.10">     const LIMIT = Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    let currentTime = cal.now().getInTimezone(cal.UTC());</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+    let currentTime = cal.dtz.now().getInTimezone(cal.dtz.UTC);</span>
<a href="#l18.14"></a><span id="l18.14">     let limitTime = currentTime.clone();</span>
<a href="#l18.15"></a><span id="l18.15">     limitTime.month += LIMIT;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17">     let durationUntilLimit = limitTime.subtractDate(currentTime);</span>
<a href="#l18.18"></a><span id="l18.18">     if (aDuration.compare(durationUntilLimit) &gt; 0) {</span>
<a href="#l18.19"></a><span id="l18.19">         let msg = PluralForm.get(LIMIT, cal.calGetString(&quot;calendar&quot;, &quot;alarmSnoozeLimitExceeded&quot;));</span>
<a href="#l18.20"></a><span id="l18.20">         cal.showError(msg.replace(&quot;#1&quot;, LIMIT), window);</span>
<a href="#l18.21"></a><span id="l18.21">         return true;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -254,18 +254,18 @@ function setupTitle() {</span>
<a href="#l18.23"></a><span id="l18.23">  *                              0 - otherwise</span>
<a href="#l18.24"></a><span id="l18.24">  */</span>
<a href="#l18.25"></a><span id="l18.25"> function widgetAlarmComptor(aItem, aWidgetItem) {</span>
<a href="#l18.26"></a><span id="l18.26">     if (aItem == null || aWidgetItem == null) {</span>
<a href="#l18.27"></a><span id="l18.27">         return -1;</span>
<a href="#l18.28"></a><span id="l18.28">     }</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30">     // Get the dates to compare</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-    let aDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    let bDate = aWidgetItem[cal.calGetStartDateProp(aWidgetItem)];</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+    let aDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+    let bDate = aWidgetItem[cal.dtz.startDateProp(aWidgetItem)];</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36">     return aDate.compare(bDate);</span>
<a href="#l18.37"></a><span id="l18.37"> }</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39"> /**</span>
<a href="#l18.40"></a><span id="l18.40">  * Add an alarm widget for the passed alarm and item.</span>
<a href="#l18.41"></a><span id="l18.41">  *</span>
<a href="#l18.42"></a><span id="l18.42">  * @param aItem       The calendar item to add a widget for.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -136,17 +136,17 @@ function createReminderFromMenuitem(aMen</span>
<a href="#l19.4"></a><span id="l19.4">  */</span>
<a href="#l19.5"></a><span id="l19.5"> function editReminder() {</span>
<a href="#l19.6"></a><span id="l19.6">     let customItem = document.getElementById(&quot;reminder-custom-menuitem&quot;);</span>
<a href="#l19.7"></a><span id="l19.7">     let args = {};</span>
<a href="#l19.8"></a><span id="l19.8">     args.reminders = customItem.reminders;</span>
<a href="#l19.9"></a><span id="l19.9">     args.item = window.calendarItem;</span>
<a href="#l19.10"></a><span id="l19.10">     args.timezone = window.gStartTimezone ||</span>
<a href="#l19.11"></a><span id="l19.11">                     window.gEndTimezone ||</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-                    cal.calendarDefaultTimezone();</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+                    cal.dtz.defaultTimezone;</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15">     args.calendar = getCurrentCalendar();</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">     // While these are &quot;just&quot; callbacks, the dialog is opened modally, so aside</span>
<a href="#l19.18"></a><span id="l19.18">     // from whats needed to set up the reminders, nothing else needs to be done.</span>
<a href="#l19.19"></a><span id="l19.19">     args.onOk = function(reminders) {</span>
<a href="#l19.20"></a><span id="l19.20">         customItem.reminders = reminders;</span>
<a href="#l19.21"></a><span id="l19.21">     };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -173,17 +173,17 @@ function zoomWithButtons(aZoomOut) {</span>
<a href="#l20.4"></a><span id="l20.4">  * Loads the passed start and end dates, fills global variables that give</span>
<a href="#l20.5"></a><span id="l20.5">  * information about the state of the dialog.</span>
<a href="#l20.6"></a><span id="l20.6">  *</span>
<a href="#l20.7"></a><span id="l20.7">  * @param aStartDate        The date/time the grid should start at.</span>
<a href="#l20.8"></a><span id="l20.8">  * @param aEndDate          The date/time the grid should end at.</span>
<a href="#l20.9"></a><span id="l20.9">  */</span>
<a href="#l20.10"></a><span id="l20.10"> function loadDateTime(aStartDate, aEndDate) {</span>
<a href="#l20.11"></a><span id="l20.11">     gDuration = aEndDate.subtractDate(aStartDate);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l20.14"></a><span id="l20.14">     gStartTimezone = aStartDate.timezone;</span>
<a href="#l20.15"></a><span id="l20.15">     gEndTimezone = aEndDate.timezone;</span>
<a href="#l20.16"></a><span id="l20.16">     gStartDate = aStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.17"></a><span id="l20.17">     gEndDate = aEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.18"></a><span id="l20.18">     gStartDate.makeImmutable();</span>
<a href="#l20.19"></a><span id="l20.19">     gEndDate.makeImmutable();</span>
<a href="#l20.20"></a><span id="l20.20"> }</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -215,17 +215,17 @@ function propagateDateTime() {</span>
<a href="#l20.23"></a><span id="l20.23">                   (grid.endDate.compare(gEndDate) != 0);</span>
<a href="#l20.24"></a><span id="l20.24">     grid.startDate = gStartDate;</span>
<a href="#l20.25"></a><span id="l20.25">     grid.endDate = gEndDate;</span>
<a href="#l20.26"></a><span id="l20.26">     if (refresh) {</span>
<a href="#l20.27"></a><span id="l20.27">         grid.forceRefresh();</span>
<a href="#l20.28"></a><span id="l20.28">     }</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30">     // Expand to 24hrs if the new range is outside of the default range.</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l20.33"></a><span id="l20.33">     let startTime = gStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.34"></a><span id="l20.34">     let endTime = gEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.35"></a><span id="l20.35">     if ((startTime.hour &lt; gStartHour) ||</span>
<a href="#l20.36"></a><span id="l20.36">         (startTime.hour &gt;= gEndHour) ||</span>
<a href="#l20.37"></a><span id="l20.37">         (endTime.hour &gt;= gEndHour) ||</span>
<a href="#l20.38"></a><span id="l20.38">         (startTime.day != endTime.day) ||</span>
<a href="#l20.39"></a><span id="l20.39">         (startTime.isDate)) {</span>
<a href="#l20.40"></a><span id="l20.40">         setForce24Hours(true);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineat">@@ -259,40 +259,40 @@ function updateDateTime() {</span>
<a href="#l20.42"></a><span id="l20.42">                     endTime = endTime.getInTimezone(startTime.timezone);</span>
<a href="#l20.43"></a><span id="l20.43">                 }</span>
<a href="#l20.44"></a><span id="l20.44">             }</span>
<a href="#l20.45"></a><span id="l20.45">         }</span>
<a href="#l20.46"></a><span id="l20.46"> </span>
<a href="#l20.47"></a><span id="l20.47">         // Before feeding the date/time value into the control we need</span>
<a href="#l20.48"></a><span id="l20.48">         // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l20.49"></a><span id="l20.49">         // automatic conversion back into the OS timezone.</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-        startTime.timezone = cal.floating();</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-        endTime.timezone = cal.floating();</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+        startTime.timezone = cal.dtz.floating;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+        endTime.timezone = cal.dtz.floating;</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-        document.getElementById(&quot;event-starttime&quot;).value = cal.dateTimeToJsDate(startTime);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-        document.getElementById(&quot;event-endtime&quot;).value = cal.dateTimeToJsDate(endTime);</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+        document.getElementById(&quot;event-starttime&quot;).value = cal.dtz.dateTimeToJsDate(startTime);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+        document.getElementById(&quot;event-endtime&quot;).value = cal.dtz.dateTimeToJsDate(endTime);</span>
<a href="#l20.59"></a><span id="l20.59">     } else {</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+        let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">         let startTime = gStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.64"></a><span id="l20.64">         let endTime = gEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66">         if (startTime.isDate) {</span>
<a href="#l20.67"></a><span id="l20.67">             document.getElementById(&quot;all-day&quot;)</span>
<a href="#l20.68"></a><span id="l20.68">                 .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l20.69"></a><span id="l20.69">         }</span>
<a href="#l20.70"></a><span id="l20.70"> </span>
<a href="#l20.71"></a><span id="l20.71">         // Before feeding the date/time value into the control we need</span>
<a href="#l20.72"></a><span id="l20.72">         // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l20.73"></a><span id="l20.73">         // automatic conversion back into the OS timezone.</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-        startTime.timezone = cal.floating();</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-        endTime.timezone = cal.floating();</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+        startTime.timezone = cal.dtz.floating;</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+        endTime.timezone = cal.dtz.floating;</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-        document.getElementById(&quot;event-starttime&quot;).value = cal.dateTimeToJsDate(startTime);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-        document.getElementById(&quot;event-endtime&quot;).value = cal.dateTimeToJsDate(endTime);</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+        document.getElementById(&quot;event-starttime&quot;).value = cal.dtz.dateTimeToJsDate(startTime);</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+        document.getElementById(&quot;event-endtime&quot;).value = cal.dtz.dateTimeToJsDate(endTime);</span>
<a href="#l20.83"></a><span id="l20.83">     }</span>
<a href="#l20.84"></a><span id="l20.84"> </span>
<a href="#l20.85"></a><span id="l20.85">     updateTimezone();</span>
<a href="#l20.86"></a><span id="l20.86">     updateAllDay();</span>
<a href="#l20.87"></a><span id="l20.87"> }</span>
<a href="#l20.88"></a><span id="l20.88"> </span>
<a href="#l20.89"></a><span id="l20.89"> /**</span>
<a href="#l20.90"></a><span id="l20.90">  * This function requires gStartDate and gEndDate and the respective timezone</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineat">@@ -347,18 +347,18 @@ function updateStartTime() {</span>
<a href="#l20.92"></a><span id="l20.92"> </span>
<a href="#l20.93"></a><span id="l20.93">     let startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l20.94"></a><span id="l20.94"> </span>
<a href="#l20.95"></a><span id="l20.95">     let startWidget = document.getElementById(startWidgetId);</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">     // jsDate is always in OS timezone, thus we create a calIDateTime</span>
<a href="#l20.98"></a><span id="l20.98">     // object from the jsDate representation and simply set the new</span>
<a href="#l20.99"></a><span id="l20.99">     // timezone instead of converting.</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-    let timezone = gDisplayTimezone ? gStartTimezone : cal.calendarDefaultTimezone();</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-    let start = cal.jsDateToDateTime(startWidget.value, timezone);</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    let timezone = gDisplayTimezone ? gStartTimezone : cal.dtz.defaultTimezone;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+    let start = cal.dtz.jsDateToDateTime(startWidget.value, timezone);</span>
<a href="#l20.104"></a><span id="l20.104"> </span>
<a href="#l20.105"></a><span id="l20.105">     gStartDate = start.clone();</span>
<a href="#l20.106"></a><span id="l20.106">     start.addDuration(gDuration);</span>
<a href="#l20.107"></a><span id="l20.107">     gEndDate = start.getInTimezone(gEndTimezone);</span>
<a href="#l20.108"></a><span id="l20.108"> </span>
<a href="#l20.109"></a><span id="l20.109">     let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l20.110"></a><span id="l20.110">     let allDay = allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l20.111"></a><span id="l20.111">     if (allDay) {</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineat">@@ -380,28 +380,28 @@ function updateEndTime() {</span>
<a href="#l20.113"></a><span id="l20.113">     let startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l20.114"></a><span id="l20.114">     let endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l20.115"></a><span id="l20.115"> </span>
<a href="#l20.116"></a><span id="l20.116">     let startWidget = document.getElementById(startWidgetId);</span>
<a href="#l20.117"></a><span id="l20.117">     let endWidget = document.getElementById(endWidgetId);</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119">     let saveStartTime = gStartDate;</span>
<a href="#l20.120"></a><span id="l20.120">     let saveEndTime = gEndDate;</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l20.123"></a><span id="l20.123"> </span>
<a href="#l20.124"></a><span id="l20.124" class="difflineminus">-    gStartDate = cal.jsDateToDateTime(startWidget.value,</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-                                  gDisplayTimezone ? gStartTimezone : cal.calendarDefaultTimezone());</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+    gStartDate = cal.dtz.jsDateToDateTime(startWidget.value,</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+                                  gDisplayTimezone ? gStartTimezone : cal.dtz.defaultTimezone);</span>
<a href="#l20.128"></a><span id="l20.128"> </span>
<a href="#l20.129"></a><span id="l20.129">     let timezone = gEndTimezone;</span>
<a href="#l20.130"></a><span id="l20.130">     if (timezone.isUTC &amp;&amp;</span>
<a href="#l20.131"></a><span id="l20.131">         gStartDate &amp;&amp;</span>
<a href="#l20.132"></a><span id="l20.132">         !cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l20.133"></a><span id="l20.133">         timezone = gStartTimezone;</span>
<a href="#l20.134"></a><span id="l20.134">     }</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineminus">-    gEndDate = cal.jsDateToDateTime(endWidget.value,</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+    gEndDate = cal.dtz.jsDateToDateTime(endWidget.value,</span>
<a href="#l20.137"></a><span id="l20.137">                                     gDisplayTimezone ? timezone : kDefaultTimezone);</span>
<a href="#l20.138"></a><span id="l20.138"> </span>
<a href="#l20.139"></a><span id="l20.139">     let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l20.140"></a><span id="l20.140">     let allDay = allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l20.141"></a><span id="l20.141">     if (allDay) {</span>
<a href="#l20.142"></a><span id="l20.142">         gStartDate.isDate = true;</span>
<a href="#l20.143"></a><span id="l20.143">         gEndDate.isDate = true;</span>
<a href="#l20.144"></a><span id="l20.144">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1277,49 +1277,49 @@</span>
<a href="#l21.4"></a><span id="l21.4">                   this, &quot;anonid&quot;, &quot;selection-bar&quot;);</span>
<a href="#l21.5"></a><span id="l21.5">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7">       &lt;property name=&quot;baseDate&quot;&gt;</span>
<a href="#l21.8"></a><span id="l21.8">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l21.9"></a><span id="l21.9">             // we need to convert the date/time in question in</span>
<a href="#l21.10"></a><span id="l21.10">             // order to calculate with hours that are aligned</span>
<a href="#l21.11"></a><span id="l21.11">             // with our timebar display.</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l21.14"></a><span id="l21.14">             this.mBaseDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l21.15"></a><span id="l21.15">             this.mBaseDate.isDate = true;</span>
<a href="#l21.16"></a><span id="l21.16">             this.mBaseDate.makeImmutable();</span>
<a href="#l21.17"></a><span id="l21.17">             return val;</span>
<a href="#l21.18"></a><span id="l21.18">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l21.19"></a><span id="l21.19">       &lt;/property&gt;</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l21.22"></a><span id="l21.22">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l21.23"></a><span id="l21.23">             // currently we *always* set the basedate to be</span>
<a href="#l21.24"></a><span id="l21.24">             // equal to the startdate. we'll most probably</span>
<a href="#l21.25"></a><span id="l21.25">             // want to change this later.</span>
<a href="#l21.26"></a><span id="l21.26">             this.baseDate = val;</span>
<a href="#l21.27"></a><span id="l21.27">             // we need to convert the date/time in question in</span>
<a href="#l21.28"></a><span id="l21.28">             // order to calculate with hours that are aligned</span>
<a href="#l21.29"></a><span id="l21.29">             // with our timebar display.</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l21.32"></a><span id="l21.32">             this.mStartDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l21.33"></a><span id="l21.33">             this.mStartDate.makeImmutable();</span>
<a href="#l21.34"></a><span id="l21.34">             return val;</span>
<a href="#l21.35"></a><span id="l21.35">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l21.36"></a><span id="l21.36">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l21.37"></a><span id="l21.37">             return this.mStartDate;</span>
<a href="#l21.38"></a><span id="l21.38">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l21.39"></a><span id="l21.39">       &lt;/property&gt;</span>
<a href="#l21.40"></a><span id="l21.40"> </span>
<a href="#l21.41"></a><span id="l21.41">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l21.42"></a><span id="l21.42">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l21.43"></a><span id="l21.43">             // we need to convert the date/time in question in</span>
<a href="#l21.44"></a><span id="l21.44">             // order to calculate with hours that are aligned</span>
<a href="#l21.45"></a><span id="l21.45">             // with our timebar display.</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l21.48"></a><span id="l21.48">             this.mEndDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l21.49"></a><span id="l21.49">             if (this.mEndDate.isDate) {</span>
<a href="#l21.50"></a><span id="l21.50">                 this.mEndDate.day += 1;</span>
<a href="#l21.51"></a><span id="l21.51">             }</span>
<a href="#l21.52"></a><span id="l21.52">             this.mEndDate.makeImmutable();</span>
<a href="#l21.53"></a><span id="l21.53">             return val;</span>
<a href="#l21.54"></a><span id="l21.54">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l21.55"></a><span id="l21.55">         &lt;getter&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -432,17 +432,17 @@</span>
<a href="#l22.4"></a><span id="l22.4">           let endTime = args.endTime;</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6">           this.initTimeRange();</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8">           // The basedate is the date/time from which the display</span>
<a href="#l22.9"></a><span id="l22.9">           // of the timebar starts. The range is the number of days</span>
<a href="#l22.10"></a><span id="l22.10">           // we should be able to show. The start- and enddate</span>
<a href="#l22.11"></a><span id="l22.11">           // is the time the event is scheduled for.</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+          let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l22.14"></a><span id="l22.14">           this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.15"></a><span id="l22.15">           this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.16"></a><span id="l22.16">           this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18">           window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l22.19"></a><span id="l22.19">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -480,17 +480,17 @@</span>
<a href="#l22.23"></a><span id="l22.23">       &lt;/method&gt;</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">       &lt;method name=&quot;initialize&quot;&gt;</span>
<a href="#l22.26"></a><span id="l22.26">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.27"></a><span id="l22.27">             let args = window.arguments[0];</span>
<a href="#l22.28"></a><span id="l22.28">             let startTime = args.startTime;</span>
<a href="#l22.29"></a><span id="l22.29">             let endTime = args.endTime;</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l22.33"></a><span id="l22.33">             this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.34"></a><span id="l22.34">             this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36">             // Set the number of 'freebusy-day'-elements</span>
<a href="#l22.37"></a><span id="l22.37">             // we need to fill up the content box.</span>
<a href="#l22.38"></a><span id="l22.38">             // TODO: hardcoded value</span>
<a href="#l22.39"></a><span id="l22.39">             this.mNumDays = 4 * this.mZoomFactor / 100;</span>
<a href="#l22.40"></a><span id="l22.40">             if (this.mNumDays &lt; 2) {</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineat">@@ -704,17 +704,17 @@</span>
<a href="#l22.42"></a><span id="l22.42">                 this.mState[i] = Components.interfaces.calIFreeBusyInterval.UNKNOWN;</span>
<a href="#l22.43"></a><span id="l22.43">             }</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45">             let step_in_minutes = Math.floor(60 * this.mZoomFactor / 100);</span>
<a href="#l22.46"></a><span id="l22.46">             let formatter = Components.classes[</span>
<a href="#l22.47"></a><span id="l22.47">                 &quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l22.48"></a><span id="l22.48">                     .getService(</span>
<a href="#l22.49"></a><span id="l22.49">                         Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-            let date = cal.jsDateToDateTime(new Date());</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+            let date = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l22.52"></a><span id="l22.52">             date.hour = this.mStartHour;</span>
<a href="#l22.53"></a><span id="l22.53">             date.minute = 0;</span>
<a href="#l22.54"></a><span id="l22.54">             let hours =</span>
<a href="#l22.55"></a><span id="l22.55">                 document.getAnonymousElementByAttribute(</span>
<a href="#l22.56"></a><span id="l22.56">                     this, &quot;anonid&quot;, &quot;hours&quot;);</span>
<a href="#l22.57"></a><span id="l22.57">             if (hours.childNodes.length &lt;= 0) {</span>
<a href="#l22.58"></a><span id="l22.58">                 let template = createXULElement(&quot;text&quot;);</span>
<a href="#l22.59"></a><span id="l22.59">                 template.className = &quot;freebusy-grid&quot;;</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineat">@@ -758,17 +758,17 @@</span>
<a href="#l22.61"></a><span id="l22.61">             // which will map the entries to attributes on the xul elements.</span>
<a href="#l22.62"></a><span id="l22.62">             if (aEntries) {</span>
<a href="#l22.63"></a><span id="l22.63">                 // Remember the free/busy array which is used to find a</span>
<a href="#l22.64"></a><span id="l22.64">                 // new time for an event. We store this array only if</span>
<a href="#l22.65"></a><span id="l22.65">                 // the provider returned a valid array. In any other case</span>
<a href="#l22.66"></a><span id="l22.66">                 // (temporarily clean the display) we keep the last know result.</span>
<a href="#l22.67"></a><span id="l22.67">                 this.mEntries = aEntries;</span>
<a href="#l22.68"></a><span id="l22.68"> </span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-                let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+                let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72">                 let start = this.mStartDate.clone();</span>
<a href="#l22.73"></a><span id="l22.73">                 start.hour = 0;</span>
<a href="#l22.74"></a><span id="l22.74">                 start.minute = 0;</span>
<a href="#l22.75"></a><span id="l22.75">                 start.second = 0;</span>
<a href="#l22.76"></a><span id="l22.76">                 start.timezone = kDefaultTimezone;</span>
<a href="#l22.77"></a><span id="l22.77">                 let end = start.clone();</span>
<a href="#l22.78"></a><span id="l22.78">                 end.day += this.mRange;</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineat">@@ -911,17 +911,17 @@</span>
<a href="#l22.80"></a><span id="l22.80">         &lt;parameter name=&quot;aEndTime&quot;/&gt;</span>
<a href="#l22.81"></a><span id="l22.81">         &lt;parameter name=&quot;allDay&quot;/&gt;</span>
<a href="#l22.82"></a><span id="l22.82">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.83"></a><span id="l22.83">             let newTime = aStartTime.clone();</span>
<a href="#l22.84"></a><span id="l22.84">             let duration = aEndTime.subtractDate(aStartTime);</span>
<a href="#l22.85"></a><span id="l22.85">             let newEndTime = newTime.clone();</span>
<a href="#l22.86"></a><span id="l22.86">             newEndTime.addDuration(duration);</span>
<a href="#l22.87"></a><span id="l22.87"> </span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l22.90"></a><span id="l22.90"> </span>
<a href="#l22.91"></a><span id="l22.91">             if (this.mEntries) {</span>
<a href="#l22.92"></a><span id="l22.92">                 for (let entry of this.mEntries) {</span>
<a href="#l22.93"></a><span id="l22.93">                     let rangeStart =</span>
<a href="#l22.94"></a><span id="l22.94">                         entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.95"></a><span id="l22.95">                     let rangeEnd =</span>
<a href="#l22.96"></a><span id="l22.96">                         entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.97"></a><span id="l22.97"> </span>
<a href="#l22.98"></a><span id="l22.98" class="difflineat">@@ -1141,17 +1141,17 @@</span>
<a href="#l22.99"></a><span id="l22.99">       &lt;/method&gt;</span>
<a href="#l22.100"></a><span id="l22.100"> </span>
<a href="#l22.101"></a><span id="l22.101">       &lt;method name=&quot;onInitialize&quot;&gt;</span>
<a href="#l22.102"></a><span id="l22.102">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l22.103"></a><span id="l22.103">             let args = window.arguments[0];</span>
<a href="#l22.104"></a><span id="l22.104">             let startTime = args.startTime;</span>
<a href="#l22.105"></a><span id="l22.105">             let endTime = args.endTime;</span>
<a href="#l22.106"></a><span id="l22.106"> </span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l22.109"></a><span id="l22.109">             this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.110"></a><span id="l22.110">             this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l22.111"></a><span id="l22.111"> </span>
<a href="#l22.112"></a><span id="l22.112">             let listbox =</span>
<a href="#l22.113"></a><span id="l22.113">                 document.getAnonymousElementByAttribute(</span>
<a href="#l22.114"></a><span id="l22.114">                     this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l22.115"></a><span id="l22.115">             let template =</span>
<a href="#l22.116"></a><span id="l22.116">                 document.getAnonymousElementByAttribute(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -48,17 +48,17 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5">       &lt;property name=&quot;dateTime&quot;&gt;</span>
<a href="#l23.6"></a><span id="l23.6">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l23.7"></a><span id="l23.7">             this.mDateTime = val.clone();</span>
<a href="#l23.8"></a><span id="l23.8">             return this.mDateTime;</span>
<a href="#l23.9"></a><span id="l23.9">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l23.10"></a><span id="l23.10">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l23.11"></a><span id="l23.11">             if (this.mDateTime == null) {</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-                this.mDateTime = cal.now();</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+                this.mDateTime = cal.dtz.now();</span>
<a href="#l23.14"></a><span id="l23.14">             }</span>
<a href="#l23.15"></a><span id="l23.15">             return this.mDateTime;</span>
<a href="#l23.16"></a><span id="l23.16">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l23.17"></a><span id="l23.17">       &lt;/property&gt;</span>
<a href="#l23.18"></a><span id="l23.18">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l23.19"></a><span id="l23.19">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.20"></a><span id="l23.20">             let minimonth =</span>
<a href="#l23.21"></a><span id="l23.21">                 document.getAnonymousElementByAttribute(</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -143,17 +143,17 @@</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24">             this.updateContent();</span>
<a href="#l23.25"></a><span id="l23.25">             this.updatePreview(this.mRecurrenceInfo);</span>
<a href="#l23.26"></a><span id="l23.26">         ]]&gt;&lt;/body&gt;</span>
<a href="#l23.27"></a><span id="l23.27">       &lt;/method&gt;</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">       &lt;method name=&quot;updateContent&quot;&gt;</span>
<a href="#l23.30"></a><span id="l23.30">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-            let date = cal.dateTimeToJsDate(this.dateTime);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+            let date = cal.dtz.dateTimeToJsDate(this.dateTime);</span>
<a href="#l23.33"></a><span id="l23.33">             let row = document.getAnonymousElementByAttribute(</span>
<a href="#l23.34"></a><span id="l23.34">                           this, &quot;anonid&quot;, &quot;row&quot;);</span>
<a href="#l23.35"></a><span id="l23.35">             while (row) {</span>
<a href="#l23.36"></a><span id="l23.36">                 let numChilds = row.childNodes.length - 1;</span>
<a href="#l23.37"></a><span id="l23.37">                 for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l23.38"></a><span id="l23.38">                     let minimonth = row.childNodes[i];</span>
<a href="#l23.39"></a><span id="l23.39">                     minimonth.showMonth(date);</span>
<a href="#l23.40"></a><span id="l23.40">                     date.setMonth(date.getMonth() + 1);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineat">@@ -181,17 +181,17 @@</span>
<a href="#l23.42"></a><span id="l23.42">             while (row) {</span>
<a href="#l23.43"></a><span id="l23.43">                 // now iterater all the child nodes of this row</span>
<a href="#l23.44"></a><span id="l23.44">                 // in order to visit each minimonth in turn.</span>
<a href="#l23.45"></a><span id="l23.45">                 let numChilds = row.childNodes.length - 1;</span>
<a href="#l23.46"></a><span id="l23.46">                 for (let i = 0; i &lt; numChilds; i++) {</span>
<a href="#l23.47"></a><span id="l23.47">                     // we now have one of the minimonth controls while 'start'</span>
<a href="#l23.48"></a><span id="l23.48">                     // and 'end' are set to the interval this minimonth shows.</span>
<a href="#l23.49"></a><span id="l23.49">                     let minimonth = row.childNodes[i];</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-                    minimonth.showMonth(cal.dateTimeToJsDate(start));</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+                    minimonth.showMonth(cal.dtz.dateTimeToJsDate(start));</span>
<a href="#l23.52"></a><span id="l23.52">                     if (aRecurrenceInfo) {</span>
<a href="#l23.53"></a><span id="l23.53">                         // retrieve an array of dates that represents all occurrences</span>
<a href="#l23.54"></a><span id="l23.54">                         // that fall into this time interval [start,end[.</span>
<a href="#l23.55"></a><span id="l23.55">                         // note: the following loop assumes that this array conains</span>
<a href="#l23.56"></a><span id="l23.56">                         // dates that are strictly monotonically increasing.</span>
<a href="#l23.57"></a><span id="l23.57">                         // should getOccurrenceDates() not enforce this assumption we</span>
<a href="#l23.58"></a><span id="l23.58">                         // need to fall back to some different algorithm.</span>
<a href="#l23.59"></a><span id="l23.59">                         let dates = aRecurrenceInfo.getOccurrenceDates(start, end, 0, {});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -23,22 +23,22 @@ function onLoad() {</span>
<a href="#l24.4"></a><span id="l24.4">     let args = window.arguments[0];</span>
<a href="#l24.5"></a><span id="l24.5">     let item = args.calendarEvent;</span>
<a href="#l24.6"></a><span id="l24.6">     let calendar = item.calendar;</span>
<a href="#l24.7"></a><span id="l24.7">     let recinfo = args.recurrenceInfo;</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9">     gStartTime = args.startTime;</span>
<a href="#l24.10"></a><span id="l24.10">     gEndTime = args.endTime;</span>
<a href="#l24.11"></a><span id="l24.11">     let preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    preview.dateTime = gStartTime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+    preview.dateTime = gStartTime.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15">     onChangeCalendar(calendar);</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17">     // Set starting value for 'repeat until' rule and highlight the start date.</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-    let repeatDate = cal.dateTimeToJsDate(gStartTime.getInTimezone(cal.floating()));</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+    let repeatDate = cal.dtz.dateTimeToJsDate(gStartTime.getInTimezone(cal.dtz.floating));</span>
<a href="#l24.20"></a><span id="l24.20">     setElementValue(&quot;repeat-until-date&quot;, repeatDate);</span>
<a href="#l24.21"></a><span id="l24.21">     document.getElementById(&quot;repeat-until-date&quot;).extraDate = repeatDate;</span>
<a href="#l24.22"></a><span id="l24.22"> </span>
<a href="#l24.23"></a><span id="l24.23">     if (item.parentItem != item) {</span>
<a href="#l24.24"></a><span id="l24.24">         item = item.parentItem;</span>
<a href="#l24.25"></a><span id="l24.25">     }</span>
<a href="#l24.26"></a><span id="l24.26">     let rule = null;</span>
<a href="#l24.27"></a><span id="l24.27">     if (recinfo) {</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineat">@@ -127,17 +127,17 @@ function initializeControls(rule) {</span>
<a href="#l24.29"></a><span id="l24.29">             document.getElementById(&quot;period-list&quot;).selectedIndex = 0;</span>
<a href="#l24.30"></a><span id="l24.30">             dump(&quot;unable to handle your rule type!\n&quot;);</span>
<a href="#l24.31"></a><span id="l24.31">             break;</span>
<a href="#l24.32"></a><span id="l24.32">     }</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34">     let byDayRuleComponent = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l24.35"></a><span id="l24.35">     let byMonthDayRuleComponent = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l24.36"></a><span id="l24.36">     let byMonthRuleComponent = rule.getComponent(&quot;BYMONTH&quot;, {});</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l24.39"></a><span id="l24.39">     let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.40"></a><span id="l24.40"> </span>
<a href="#l24.41"></a><span id="l24.41">     // &quot;DAILY&quot; ruletype</span>
<a href="#l24.42"></a><span id="l24.42">     // byDayRuleComponents may have been set priorily by &quot;MONTHLY&quot;- ruletypes</span>
<a href="#l24.43"></a><span id="l24.43">     // where they have a different context-</span>
<a href="#l24.44"></a><span id="l24.44">     // that's why we also query the current rule-type</span>
<a href="#l24.45"></a><span id="l24.45">     if (byDayRuleComponent.length == 0 || rule.type != &quot;DAILY&quot;) {</span>
<a href="#l24.46"></a><span id="l24.46">         document.getElementById(&quot;daily-group&quot;).selectedIndex = 0;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineat">@@ -230,17 +230,17 @@ function initializeControls(rule) {</span>
<a href="#l24.48"></a><span id="l24.48">         let untilDate = rule.untilDate;</span>
<a href="#l24.49"></a><span id="l24.49">         if (untilDate) {</span>
<a href="#l24.50"></a><span id="l24.50">             gUntilDate = untilDate.getInTimezone(gStartTime.timezone); // calIRecurrenceRule::untilDate is always UTC or floating</span>
<a href="#l24.51"></a><span id="l24.51">             // Change the until date to start date if the rule has a forbidden</span>
<a href="#l24.52"></a><span id="l24.52">             // value (earlier than the start date).</span>
<a href="#l24.53"></a><span id="l24.53">             if (gUntilDate.compare(gStartTime) &lt; 0) {</span>
<a href="#l24.54"></a><span id="l24.54">                 gUntilDate = gStartTime.clone();</span>
<a href="#l24.55"></a><span id="l24.55">             }</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-            let repeatDate = cal.dateTimeToJsDate(gUntilDate.getInTimezone(cal.floating()));</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+            let repeatDate = cal.dtz.dateTimeToJsDate(gUntilDate.getInTimezone(cal.dtz.floating));</span>
<a href="#l24.58"></a><span id="l24.58">             setElementValue(&quot;recurrence-duration&quot;, &quot;until&quot;);</span>
<a href="#l24.59"></a><span id="l24.59">             setElementValue(&quot;repeat-until-date&quot;, repeatDate);</span>
<a href="#l24.60"></a><span id="l24.60">         } else {</span>
<a href="#l24.61"></a><span id="l24.61">             setElementValue(&quot;recurrence-duration&quot;, &quot;forever&quot;);</span>
<a href="#l24.62"></a><span id="l24.62">         }</span>
<a href="#l24.63"></a><span id="l24.63">     }</span>
<a href="#l24.64"></a><span id="l24.64"> }</span>
<a href="#l24.65"></a><span id="l24.65"> </span>
<a href="#l24.66"></a><span id="l24.66" class="difflineat">@@ -373,17 +373,17 @@ function onSave(item) {</span>
<a href="#l24.67"></a><span id="l24.67">             recRule.count = -1;</span>
<a href="#l24.68"></a><span id="l24.68">             break;</span>
<a href="#l24.69"></a><span id="l24.69">         }</span>
<a href="#l24.70"></a><span id="l24.70">         case &quot;ntimes&quot;: {</span>
<a href="#l24.71"></a><span id="l24.71">             recRule.count = Math.max(1, getElementValue(&quot;repeat-ntimes-count&quot;));</span>
<a href="#l24.72"></a><span id="l24.72">             break;</span>
<a href="#l24.73"></a><span id="l24.73">         }</span>
<a href="#l24.74"></a><span id="l24.74">         case &quot;until&quot;: {</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-            let untilDate = cal.jsDateToDateTime(getElementValue(&quot;repeat-until-date&quot;), gStartTime.timezone);</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+            let untilDate = cal.dtz.jsDateToDateTime(getElementValue(&quot;repeat-until-date&quot;), gStartTime.timezone);</span>
<a href="#l24.77"></a><span id="l24.77">             untilDate.isDate = gStartTime.isDate; // enforce same value type as DTSTART</span>
<a href="#l24.78"></a><span id="l24.78">             if (!gStartTime.isDate) {</span>
<a href="#l24.79"></a><span id="l24.79">                 // correct UNTIL to exactly match start date's hour, minute, second:</span>
<a href="#l24.80"></a><span id="l24.80">                 untilDate.hour = gStartTime.hour;</span>
<a href="#l24.81"></a><span id="l24.81">                 untilDate.minute = gStartTime.minute;</span>
<a href="#l24.82"></a><span id="l24.82">                 untilDate.second = gStartTime.second;</span>
<a href="#l24.83"></a><span id="l24.83">             }</span>
<a href="#l24.84"></a><span id="l24.84">             recRule.untilDate = untilDate;</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineat">@@ -590,17 +590,17 @@ function updatePreview() {</span>
<a href="#l24.86"></a><span id="l24.86">         item = item.parentItem;</span>
<a href="#l24.87"></a><span id="l24.87">     }</span>
<a href="#l24.88"></a><span id="l24.88"> </span>
<a href="#l24.89"></a><span id="l24.89">     // TODO: We should better start the whole dialog with a newly cloned item</span>
<a href="#l24.90"></a><span id="l24.90">     // and always pump changes immediately into it. This would eliminate the</span>
<a href="#l24.91"></a><span id="l24.91">     // need to break the encapsulation, as we do it here. But we need the item</span>
<a href="#l24.92"></a><span id="l24.92">     // to contain the startdate in order to calculate the recurrence preview.</span>
<a href="#l24.93"></a><span id="l24.93">     item = item.clone();</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l24.96"></a><span id="l24.96">     if (cal.isEvent(item)) {</span>
<a href="#l24.97"></a><span id="l24.97">         let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.98"></a><span id="l24.98">         let endDate = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l24.99"></a><span id="l24.99">         if (startDate.isDate) {</span>
<a href="#l24.100"></a><span id="l24.100">             endDate.day--;</span>
<a href="#l24.101"></a><span id="l24.101">         }</span>
<a href="#l24.102"></a><span id="l24.102"> </span>
<a href="#l24.103"></a><span id="l24.103">         item.startDate = startDate;</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineat">@@ -628,21 +628,21 @@ function updatePreview() {</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106"> /**</span>
<a href="#l24.107"></a><span id="l24.107">  * Checks the until date just entered in the datepicker in order to avoid</span>
<a href="#l24.108"></a><span id="l24.108">  * setting a date earlier than the start date.</span>
<a href="#l24.109"></a><span id="l24.109">  * Restores the previous correct date, shows a warning and prevents to close the</span>
<a href="#l24.110"></a><span id="l24.110">  * dialog when the user enters a wrong until date.</span>
<a href="#l24.111"></a><span id="l24.111">  */</span>
<a href="#l24.112"></a><span id="l24.112"> function checkUntilDate() {</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineminus">-    let untilDate = cal.jsDateToDateTime(getElementValue(&quot;repeat-until-date&quot;), gStartTime.timezone);</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+    let untilDate = cal.dtz.jsDateToDateTime(getElementValue(&quot;repeat-until-date&quot;), gStartTime.timezone);</span>
<a href="#l24.115"></a><span id="l24.115">     let startDate = gStartTime.clone();</span>
<a href="#l24.116"></a><span id="l24.116">     startDate.isDate = true;</span>
<a href="#l24.117"></a><span id="l24.117">     if (untilDate.compare(startDate) &lt; 0) {</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-        let repeatDate = cal.dateTimeToJsDate((gUntilDate || gStartTime).getInTimezone(cal.floating()));</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+        let repeatDate = cal.dtz.dateTimeToJsDate((gUntilDate || gStartTime).getInTimezone(cal.dtz.floating));</span>
<a href="#l24.120"></a><span id="l24.120">         setElementValue(&quot;repeat-until-date&quot;, repeatDate);</span>
<a href="#l24.121"></a><span id="l24.121">         checkUntilDate.warning = true;</span>
<a href="#l24.122"></a><span id="l24.122">         let callback = function() {</span>
<a href="#l24.123"></a><span id="l24.123">             // No warning when the dialog is being closed with the Cancel button.</span>
<a href="#l24.124"></a><span id="l24.124">             if (!checkUntilDate.warning) {</span>
<a href="#l24.125"></a><span id="l24.125">                 return;</span>
<a href="#l24.126"></a><span id="l24.126">             }</span>
<a href="#l24.127"></a><span id="l24.127">             Services.prompt.alert(null, document.title,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -90,17 +90,17 @@ function loadReminders() {</span>
<a href="#l25.4"></a><span id="l25.4">             // action is actually supported by the calendar.</span>
<a href="#l25.5"></a><span id="l25.5">             listbox.appendChild(setupListItem(null, reminders[i].clone(), args.item));</span>
<a href="#l25.6"></a><span id="l25.6">         }</span>
<a href="#l25.7"></a><span id="l25.7">     }</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9">     // Set up a default absolute date. This will be overridden if the selected</span>
<a href="#l25.10"></a><span id="l25.10">     // alarm is absolute.</span>
<a href="#l25.11"></a><span id="l25.11">     let absDate = document.getElementById(&quot;reminder-absolute-date&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    absDate.value = cal.dateTimeToJsDate(cal.getDefaultStartDate());</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+    absDate.value = cal.dtz.dateTimeToJsDate(cal.dtz.getDefaultStartDate());</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15">     if (listbox.childNodes.length) {</span>
<a href="#l25.16"></a><span id="l25.16">         // We have reminders, select the first by default. For some reason,</span>
<a href="#l25.17"></a><span id="l25.17">         // setting the selected index in a load handler makes the selection</span>
<a href="#l25.18"></a><span id="l25.18">         // break for the set item, therefore we need a setTimeout.</span>
<a href="#l25.19"></a><span id="l25.19">         setupMaxReminders();</span>
<a href="#l25.20"></a><span id="l25.20">         setTimeout(() =&gt; { listbox.selectedIndex = 0; }, 0);</span>
<a href="#l25.21"></a><span id="l25.21">     } else {</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineat">@@ -244,17 +244,17 @@ function onReminderSelected() {</span>
<a href="#l25.23"></a><span id="l25.23">         // Action</span>
<a href="#l25.24"></a><span id="l25.24">         actionType.value = reminder.action;</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26">         // Absolute/relative things</span>
<a href="#l25.27"></a><span id="l25.27">         if (reminder.related == Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l25.28"></a><span id="l25.28">             relationType.value = &quot;absolute&quot;;</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30">             // Date</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-            absDate.value = cal.dateTimeToJsDate(reminder.alarmDate || cal.getDefaultStartDate());</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+            absDate.value = cal.dtz.dateTimeToJsDate(reminder.alarmDate || cal.dtz.getDefaultStartDate());</span>
<a href="#l25.33"></a><span id="l25.33">         } else {</span>
<a href="#l25.34"></a><span id="l25.34">             relationType.value = &quot;relative&quot;;</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36">             // Unit and length</span>
<a href="#l25.37"></a><span id="l25.37">             let alarmlen = Math.abs(reminder.offset.inSeconds / 60);</span>
<a href="#l25.38"></a><span id="l25.38">             if (alarmlen % 1440 == 0) {</span>
<a href="#l25.39"></a><span id="l25.39">                 unit.value = &quot;days&quot;;</span>
<a href="#l25.40"></a><span id="l25.40">                 length.value = alarmlen / 1440;</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineat">@@ -330,17 +330,17 @@ function updateReminder(event) {</span>
<a href="#l25.42"></a><span id="l25.42">         offset[unit.value] = length.value;</span>
<a href="#l25.43"></a><span id="l25.43">         offset.normalize();</span>
<a href="#l25.44"></a><span id="l25.44">         offset.isNegative = (relation == &quot;before&quot;);</span>
<a href="#l25.45"></a><span id="l25.45">         reminder.offset = offset;</span>
<a href="#l25.46"></a><span id="l25.46">     } else if (relationItem.value == &quot;absolute&quot;) {</span>
<a href="#l25.47"></a><span id="l25.47">         reminder.related = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l25.48"></a><span id="l25.48"> </span>
<a href="#l25.49"></a><span id="l25.49">         if (absDate.value) {</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-            reminder.alarmDate = cal.jsDateToDateTime(absDate.value,</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+            reminder.alarmDate = cal.dtz.jsDateToDateTime(absDate.value,</span>
<a href="#l25.52"></a><span id="l25.52">                                                       window.arguments[0].timezone);</span>
<a href="#l25.53"></a><span id="l25.53">         } else {</span>
<a href="#l25.54"></a><span id="l25.54">             reminder.alarmDate = null;</span>
<a href="#l25.55"></a><span id="l25.55">         }</span>
<a href="#l25.56"></a><span id="l25.56">     }</span>
<a href="#l25.57"></a><span id="l25.57"> </span>
<a href="#l25.58"></a><span id="l25.58">     setupListItem(listitem, reminder, window.arguments[0].item);</span>
<a href="#l25.59"></a><span id="l25.59"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -19,20 +19,20 @@ function onLoad() {</span>
<a href="#l26.4"></a><span id="l26.4">                      cal.getTimezoneService();</span>
<a href="#l26.5"></a><span id="l26.5">     window.tzProvider = tzProvider;</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">     let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l26.8"></a><span id="l26.8">     let tzMenuPopup = document.getElementById(&quot;timezone-menupopup&quot;);</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10">     // floating and UTC (if supported) at the top:</span>
<a href="#l26.11"></a><span id="l26.11">     if (args.calendar.getProperty(&quot;capabilities.timezones.floating.supported&quot;) !== false) {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-        addMenuItem(tzMenuPopup, cal.floating().displayName, cal.floating().tzid);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+        addMenuItem(tzMenuPopup, cal.dtz.floating.displayName, cal.dtz.floating.tzid);</span>
<a href="#l26.14"></a><span id="l26.14">     }</span>
<a href="#l26.15"></a><span id="l26.15">     if (args.calendar.getProperty(&quot;capabilities.timezones.UTC.supported&quot;) !== false) {</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-        addMenuItem(tzMenuPopup, cal.UTC().displayName, cal.UTC().tzid);</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+        addMenuItem(tzMenuPopup, cal.dtz.UTC.displayName, cal.dtz.UTC.tzid);</span>
<a href="#l26.18"></a><span id="l26.18">     }</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20">     let enumerator = tzProvider.timezoneIds;</span>
<a href="#l26.21"></a><span id="l26.21">     let tzids = {};</span>
<a href="#l26.22"></a><span id="l26.22">     let displayNames = [];</span>
<a href="#l26.23"></a><span id="l26.23">     while (enumerator.hasMore()) {</span>
<a href="#l26.24"></a><span id="l26.24">         let timezone = tzProvider.getTimezone(enumerator.getNext());</span>
<a href="#l26.25"></a><span id="l26.25">         if (timezone &amp;&amp; !timezone.isFloating &amp;&amp; !timezone.isUTC) {</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineat">@@ -45,17 +45,17 @@ function onLoad() {</span>
<a href="#l26.27"></a><span id="l26.27">     displayNames.sort((a, b) =&gt; a.localeCompare(b));</span>
<a href="#l26.28"></a><span id="l26.28">     for (let i = 0; i &lt; displayNames.length; ++i) {</span>
<a href="#l26.29"></a><span id="l26.29">         let displayName = displayNames[i];</span>
<a href="#l26.30"></a><span id="l26.30">         addMenuItem(tzMenuPopup, displayName, tzids[displayName]);</span>
<a href="#l26.31"></a><span id="l26.31">     }</span>
<a href="#l26.32"></a><span id="l26.32"> </span>
<a href="#l26.33"></a><span id="l26.33">     let index = findTimezone(window.time.timezone);</span>
<a href="#l26.34"></a><span id="l26.34">     if (index &lt; 0) {</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-        index = findTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+        index = findTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l26.37"></a><span id="l26.37">         if (index &lt; 0) {</span>
<a href="#l26.38"></a><span id="l26.38">             index = 0;</span>
<a href="#l26.39"></a><span id="l26.39">         }</span>
<a href="#l26.40"></a><span id="l26.40">     }</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42">     menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l26.43"></a><span id="l26.43">     menulist.selectedIndex = index;</span>
<a href="#l26.44"></a><span id="l26.44"> </span>
<a href="#l26.45"></a><span id="l26.45" class="difflineat">@@ -94,18 +94,18 @@ function updateTimezone() {</span>
<a href="#l26.46"></a><span id="l26.46"> </span>
<a href="#l26.47"></a><span id="l26.47">     // convert the date/time to the currently selected timezone</span>
<a href="#l26.48"></a><span id="l26.48">     // and display the result in the appropriate control.</span>
<a href="#l26.49"></a><span id="l26.49">     // before feeding the date/time value into the control we need</span>
<a href="#l26.50"></a><span id="l26.50">     // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l26.51"></a><span id="l26.51">     // automatic conversion back into the OS timezone.</span>
<a href="#l26.52"></a><span id="l26.52">     let datetime = document.getElementById(&quot;timezone-time&quot;);</span>
<a href="#l26.53"></a><span id="l26.53">     let time = window.time.getInTimezone(timezone);</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-    time.timezone = cal.floating();</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-    datetime.value = cal.dateTimeToJsDate(time);</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+    time.timezone = cal.dtz.floating;</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+    datetime.value = cal.dtz.dateTimeToJsDate(time);</span>
<a href="#l26.58"></a><span id="l26.58"> </span>
<a href="#l26.59"></a><span id="l26.59">     // don't highlight any timezone in the map by default</span>
<a href="#l26.60"></a><span id="l26.60">     let standardTZOffset = &quot;none&quot;;</span>
<a href="#l26.61"></a><span id="l26.61">     if (timezone.isUTC) {</span>
<a href="#l26.62"></a><span id="l26.62">         standardTZOffset = &quot;+0000&quot;;</span>
<a href="#l26.63"></a><span id="l26.63">     } else if (!timezone.isFloating) {</span>
<a href="#l26.64"></a><span id="l26.64">         let standard = timezone.icalComponent.getFirstSubcomponent(&quot;STANDARD&quot;);</span>
<a href="#l26.65"></a><span id="l26.65">         // any reason why valueAsIcalString is used instead of plain value? xxx todo: ask mickey</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -20,18 +20,18 @@ function getCalendarView() {</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> /**</span>
<a href="#l27.6"></a><span id="l27.6">  * Loads the print dialog, setting up all needed elements.</span>
<a href="#l27.7"></a><span id="l27.7">  */</span>
<a href="#l27.8"></a><span id="l27.8"> function loadCalendarPrintDialog() {</span>
<a href="#l27.9"></a><span id="l27.9">     // set the datepickers to the currently selected dates</span>
<a href="#l27.10"></a><span id="l27.10">     let theView = getCalendarView();</span>
<a href="#l27.11"></a><span id="l27.11">     if (theView) {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-        document.getElementById(&quot;start-date-picker&quot;).value = cal.dateTimeToJsDate(theView.startDay);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-        document.getElementById(&quot;end-date-picker&quot;).value = cal.dateTimeToJsDate(theView.endDay);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+        document.getElementById(&quot;start-date-picker&quot;).value = cal.dtz.dateTimeToJsDate(theView.startDay);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+        document.getElementById(&quot;end-date-picker&quot;).value = cal.dtz.dateTimeToJsDate(theView.endDay);</span>
<a href="#l27.16"></a><span id="l27.16">     } else {</span>
<a href="#l27.17"></a><span id="l27.17">         document.getElementById(&quot;printCurrentViewRadio&quot;).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l27.18"></a><span id="l27.18">     }</span>
<a href="#l27.19"></a><span id="l27.19">     if (!theView || !theView.getSelectedItems({}).length) {</span>
<a href="#l27.20"></a><span id="l27.20">         document.getElementById(&quot;selected&quot;).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l27.21"></a><span id="l27.21">     }</span>
<a href="#l27.22"></a><span id="l27.22">     document.getElementById(theView ? &quot;printCurrentViewRadio&quot; : &quot;custom-range&quot;)</span>
<a href="#l27.23"></a><span id="l27.23">             .setAttribute(&quot;selected&quot;, true);</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineat">@@ -118,20 +118,20 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l27.25"></a><span id="l27.25">             // We've set the event list above, no need to fetch items below.</span>
<a href="#l27.26"></a><span id="l27.26">             requiresFetch = false;</span>
<a href="#l27.27"></a><span id="l27.27">             break;</span>
<a href="#l27.28"></a><span id="l27.28">         }</span>
<a href="#l27.29"></a><span id="l27.29">         case &quot;custom&quot;: {</span>
<a href="#l27.30"></a><span id="l27.30">             // We return the time from the timepickers using the selected</span>
<a href="#l27.31"></a><span id="l27.31">             // timezone, as not doing so in timezones with a positive offset</span>
<a href="#l27.32"></a><span id="l27.32">             // from UTC may cause the printout to include the wrong days.</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-            let currentTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-            settings.start = cal.jsDateToDateTime(document.getElementById(&quot;start-date-picker&quot;).value);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+            let currentTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+            settings.start = cal.dtz.jsDateToDateTime(document.getElementById(&quot;start-date-picker&quot;).value);</span>
<a href="#l27.37"></a><span id="l27.37">             settings.start = settings.start.getInTimezone(currentTimezone);</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-            settings.end = cal.jsDateToDateTime(document.getElementById(&quot;end-date-picker&quot;).value);</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+            settings.end = cal.dtz.jsDateToDateTime(document.getElementById(&quot;end-date-picker&quot;).value);</span>
<a href="#l27.40"></a><span id="l27.40">             settings.end = settings.end.getInTimezone(currentTimezone);</span>
<a href="#l27.41"></a><span id="l27.41">             settings.end = settings.end.clone();</span>
<a href="#l27.42"></a><span id="l27.42">             settings.end.day += 1;</span>
<a href="#l27.43"></a><span id="l27.43">             break;</span>
<a href="#l27.44"></a><span id="l27.44">         }</span>
<a href="#l27.45"></a><span id="l27.45">         default: {</span>
<a href="#l27.46"></a><span id="l27.46">             dump(&quot;Error : no case in printDialog.js::printCalendar()&quot;);</span>
<a href="#l27.47"></a><span id="l27.47">             break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -302,17 +302,17 @@ function updateRepeatDetails() {</span>
<a href="#l28.4"></a><span id="l28.4">     // First of all collapse the details text. If we fail to</span>
<a href="#l28.5"></a><span id="l28.5">     // create a details string, we simply don't show anything.</span>
<a href="#l28.6"></a><span id="l28.6">     // this could happen if the repeat rule is something exotic</span>
<a href="#l28.7"></a><span id="l28.7">     // we don't have any strings prepared for.</span>
<a href="#l28.8"></a><span id="l28.8">     let repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l28.9"></a><span id="l28.9">     repeatDetails.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">     // Try to create a descriptive string from the rule(s).</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l28.14"></a><span id="l28.14">     let startDate = item.startDate || item.entryDate;</span>
<a href="#l28.15"></a><span id="l28.15">     let endDate = item.endDate || item.dueDate;</span>
<a href="#l28.16"></a><span id="l28.16">     startDate = startDate ? startDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l28.17"></a><span id="l28.17">     endDate = endDate ? endDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l28.18"></a><span id="l28.18">     let detailsString = recurrenceRule2String(recurrenceInfo, startDate,</span>
<a href="#l28.19"></a><span id="l28.19">                                               endDate, startDate.isDate);</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21">     if (!detailsString) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -13,18 +13,18 @@ var gCalendarGeneralPane = {</span>
<a href="#l29.4"></a><span id="l29.4">     /**</span>
<a href="#l29.5"></a><span id="l29.5">      * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l29.6"></a><span id="l29.6">      * values set in prefs.</span>
<a href="#l29.7"></a><span id="l29.7">      */</span>
<a href="#l29.8"></a><span id="l29.8">     init: function() {</span>
<a href="#l29.9"></a><span id="l29.9">         let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l29.10"></a><span id="l29.10">                                   .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-        let dateFormattedLong = formatter.formatDateLong(cal.now());</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-        let dateFormattedShort = formatter.formatDateShort(cal.now());</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+        let dateFormattedLong = formatter.formatDateLong(cal.dtz.now());</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+        let dateFormattedShort = formatter.formatDateShort(cal.dtz.now());</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17">         // menu items include examples of current date formats.</span>
<a href="#l29.18"></a><span id="l29.18">         document.getElementById(&quot;dateformat-long-menuitem&quot;)</span>
<a href="#l29.19"></a><span id="l29.19">                 .setAttribute(&quot;label&quot;, labelLong + &quot;: &quot; + dateFormattedLong);</span>
<a href="#l29.20"></a><span id="l29.20">         document.getElementById(&quot;dateformat-short-menuitem&quot;)</span>
<a href="#l29.21"></a><span id="l29.21">                 .setAttribute(&quot;label&quot;, labelShort + &quot;: &quot; + dateFormattedShort);</span>
<a href="#l29.22"></a><span id="l29.22"> </span>
<a href="#l29.23"></a><span id="l29.23">         // deselect and reselect to update visible item title</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineat">@@ -51,17 +51,17 @@ var gCalendarGeneralPane = {</span>
<a href="#l29.25"></a><span id="l29.25">         // the display names need to be sorted</span>
<a href="#l29.26"></a><span id="l29.26">         displayNames.sort((a, b) =&gt; a.localeCompare(b));</span>
<a href="#l29.27"></a><span id="l29.27">         for (let displayName of displayNames) {</span>
<a href="#l29.28"></a><span id="l29.28">             addMenuItem(tzMenuPopup, displayName, tzids[displayName]);</span>
<a href="#l29.29"></a><span id="l29.29">         }</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31">         let prefValue = document.getElementById(&quot;calendar-timezone-local&quot;).value;</span>
<a href="#l29.32"></a><span id="l29.32">         if (!prefValue) {</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-            prefValue = cal.calendarDefaultTimezone().tzid;</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+            prefValue = cal.dtz.defaultTimezone.tzid;</span>
<a href="#l29.35"></a><span id="l29.35">         }</span>
<a href="#l29.36"></a><span id="l29.36">         tzMenuList.value = prefValue;</span>
<a href="#l29.37"></a><span id="l29.37"> </span>
<a href="#l29.38"></a><span id="l29.38">         // Set the soondays menulist preference</span>
<a href="#l29.39"></a><span id="l29.39">         this.initializeTodaypaneMenu();</span>
<a href="#l29.40"></a><span id="l29.40">     },</span>
<a href="#l29.41"></a><span id="l29.41"> </span>
<a href="#l29.42"></a><span id="l29.42">     updateDefaultTodoDates: function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/content/today-pane.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/content/today-pane.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -109,17 +109,17 @@ var TodayPane = {</span>
<a href="#l30.4"></a><span id="l30.4">         let childNodes = monthdisplaydeck.childNodes;</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6">         for (let i = 0; i &lt; childNodes.length; i++) {</span>
<a href="#l30.7"></a><span id="l30.7">             let monthlabel = childNodes[i];</span>
<a href="#l30.8"></a><span id="l30.8">             this.setMonthDescription(monthlabel, i, kYEARINIT, kCALWEEKINIT);</span>
<a href="#l30.9"></a><span id="l30.9">         }</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11">         agendaListbox.addListener(this);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-        this.setDay(cal.now());</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+        this.setDay(cal.dtz.now());</span>
<a href="#l30.14"></a><span id="l30.14">     },</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16">     /**</span>
<a href="#l30.17"></a><span id="l30.17">      * Go to month/week/day views when double-clicking a label inside miniday</span>
<a href="#l30.18"></a><span id="l30.18">      */</span>
<a href="#l30.19"></a><span id="l30.19">     onDoubleClick: function(aEvent) {</span>
<a href="#l30.20"></a><span id="l30.20">         if (aEvent.button == 0) {</span>
<a href="#l30.21"></a><span id="l30.21">             if (aEvent.target.id == &quot;datevalue-label&quot;) {</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -327,18 +327,18 @@ var TodayPane = {</span>
<a href="#l30.23"></a><span id="l30.23">     },</span>
<a href="#l30.24"></a><span id="l30.24"> </span>
<a href="#l30.25"></a><span id="l30.25">     /**</span>
<a href="#l30.26"></a><span id="l30.26">      * Sets the shown date from a JSDate.</span>
<a href="#l30.27"></a><span id="l30.27">      *</span>
<a href="#l30.28"></a><span id="l30.28">      * @param aNewDate      The date to show.</span>
<a href="#l30.29"></a><span id="l30.29">      */</span>
<a href="#l30.30"></a><span id="l30.30">     setDaywithjsDate: function(aNewDate) {</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-        let newdatetime = cal.jsDateToDateTime(aNewDate, cal.floating());</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-        newdatetime = newdatetime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+        let newdatetime = cal.dtz.jsDateToDateTime(aNewDate, cal.dtz.floating);</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+        newdatetime = newdatetime.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l30.35"></a><span id="l30.35">         this.setDay(newdatetime, true);</span>
<a href="#l30.36"></a><span id="l30.36">     },</span>
<a href="#l30.37"></a><span id="l30.37"> </span>
<a href="#l30.38"></a><span id="l30.38">     /**</span>
<a href="#l30.39"></a><span id="l30.39">      * Sets the first day shown in the today pane.</span>
<a href="#l30.40"></a><span id="l30.40">      *</span>
<a href="#l30.41"></a><span id="l30.41">      * @param aNewDate                  The calIDateTime to set.</span>
<a href="#l30.42"></a><span id="l30.42">      * @param aDontUpdateMinimonth      If true, the minimonth will not be</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineat">@@ -357,17 +357,17 @@ var TodayPane = {</span>
<a href="#l30.44"></a><span id="l30.44">         monthnamedeck.selectedIndex = this.start.month;</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46">         let selMonthPanel = monthnamedeck.selectedPanel;</span>
<a href="#l30.47"></a><span id="l30.47">         this.setMonthDescription(selMonthPanel,</span>
<a href="#l30.48"></a><span id="l30.48">                                  this.start.month,</span>
<a href="#l30.49"></a><span id="l30.49">                                  this.start.year,</span>
<a href="#l30.50"></a><span id="l30.50">                                  cal.getWeekInfoService().getWeekTitle(this.start));</span>
<a href="#l30.51"></a><span id="l30.51">         if (!aDontUpdateMinimonth) {</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-            document.getElementById(&quot;today-Minimonth&quot;).value = cal.dateTimeToJsDate(this.start);</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+            document.getElementById(&quot;today-Minimonth&quot;).value = cal.dtz.dateTimeToJsDate(this.start);</span>
<a href="#l30.54"></a><span id="l30.54">         }</span>
<a href="#l30.55"></a><span id="l30.55">         this.updatePeriod();</span>
<a href="#l30.56"></a><span id="l30.56">     },</span>
<a href="#l30.57"></a><span id="l30.57"> </span>
<a href="#l30.58"></a><span id="l30.58">     /**</span>
<a href="#l30.59"></a><span id="l30.59">      * Advance by a given number of days in the today pane.</span>
<a href="#l30.60"></a><span id="l30.60">      *</span>
<a href="#l30.61"></a><span id="l30.61">      * @param aDir      The number of days to advance. Negative numbers advance</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineat">@@ -379,17 +379,17 @@ var TodayPane = {</span>
<a href="#l30.63"></a><span id="l30.63">             this.setDay(this.start);</span>
<a href="#l30.64"></a><span id="l30.64">         }</span>
<a href="#l30.65"></a><span id="l30.65">     },</span>
<a href="#l30.66"></a><span id="l30.66"> </span>
<a href="#l30.67"></a><span id="l30.67">     /**</span>
<a href="#l30.68"></a><span id="l30.68">      * Checks if the today pane is showing today's date.</span>
<a href="#l30.69"></a><span id="l30.69">      */</span>
<a href="#l30.70"></a><span id="l30.70">     showsToday: function() {</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineminus">-        return cal.sameDay(cal.now(), this.start);</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+        return cal.dtz.sameDay(cal.dtz.now(), this.start);</span>
<a href="#l30.73"></a><span id="l30.73">     },</span>
<a href="#l30.74"></a><span id="l30.74"> </span>
<a href="#l30.75"></a><span id="l30.75">     /**</span>
<a href="#l30.76"></a><span id="l30.76">      * Update the period headers in the agenda listbox using the today pane's</span>
<a href="#l30.77"></a><span id="l30.77">      * start date.</span>
<a href="#l30.78"></a><span id="l30.78">      */</span>
<a href="#l30.79"></a><span id="l30.79">     updatePeriod: function() {</span>
<a href="#l30.80"></a><span id="l30.80">         agendaListbox.refreshPeriodDates(this.start.clone());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/content/today-pane.xul</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/content/today-pane.xul</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -109,17 +109,17 @@</span>
<a href="#l31.4"></a><span id="l31.4">                           &lt;toolbarbutton id=&quot;previous-day-button&quot;</span>
<a href="#l31.5"></a><span id="l31.5">                                          class=&quot;miniday-nav-buttons&quot;</span>
<a href="#l31.6"></a><span id="l31.6">                                          tooltiptext=&quot;&amp;onedaybackward.tooltip;&quot;</span>
<a href="#l31.7"></a><span id="l31.7">                                          onmousedown=&quot;TodayPane.onMousedown(event, parseInt(this.getAttribute('dir')));&quot;</span>
<a href="#l31.8"></a><span id="l31.8">                                          dir=&quot;-1&quot;/&gt;</span>
<a href="#l31.9"></a><span id="l31.9">                           &lt;toolbarbutton id=&quot;today-button&quot;</span>
<a href="#l31.10"></a><span id="l31.10">                                          class=&quot;miniday-nav-buttons&quot;</span>
<a href="#l31.11"></a><span id="l31.11">                                          tooltiptext=&quot;&amp;showToday.tooltip;&quot;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-                                         oncommand=&quot;TodayPane.setDay(cal.now());&quot;/&gt;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+                                         oncommand=&quot;TodayPane.setDay(cal.dtz.now());&quot;/&gt;</span>
<a href="#l31.14"></a><span id="l31.14">                           &lt;toolbarbutton id=&quot;next-day-button&quot;</span>
<a href="#l31.15"></a><span id="l31.15">                                          class=&quot;miniday-nav-buttons&quot;</span>
<a href="#l31.16"></a><span id="l31.16">                                          tooltiptext=&quot;&amp;onedayforward.tooltip;&quot;</span>
<a href="#l31.17"></a><span id="l31.17">                                          onmousedown=&quot;TodayPane.onMousedown(event, parseInt(this.getAttribute('dir')));&quot;</span>
<a href="#l31.18"></a><span id="l31.18">                                          dir=&quot;1&quot;/&gt;</span>
<a href="#l31.19"></a><span id="l31.19">                         &lt;/hbox&gt;</span>
<a href="#l31.20"></a><span id="l31.20">                       &lt;/hbox&gt;</span>
<a href="#l31.21"></a><span id="l31.21">                       &lt;hbox pack=&quot;start&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -86,17 +86,17 @@</span>
<a href="#l32.4"></a><span id="l32.4"> </span>
<a href="#l32.5"></a><span id="l32.5">             // Dates</span>
<a href="#l32.6"></a><span id="l32.6">             if (cal.isEvent(this.mItem)) {</span>
<a href="#l32.7"></a><span id="l32.7">                 dateLabel.textContent = formatter.formatItemInterval(this.mItem);</span>
<a href="#l32.8"></a><span id="l32.8">             } else if (cal.isToDo(this.mItem)) {</span>
<a href="#l32.9"></a><span id="l32.9">                 let startDate = this.mItem.entryDate || this.mItem.dueDate;</span>
<a href="#l32.10"></a><span id="l32.10">                 if (startDate) {</span>
<a href="#l32.11"></a><span id="l32.11">                     // A Task with a start or due date, show with label</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-                    startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+                    startDate = startDate.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l32.14"></a><span id="l32.14">                     dateLabel.textContent = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l32.15"></a><span id="l32.15">                                                              &quot;alarmStarts&quot;,</span>
<a href="#l32.16"></a><span id="l32.16">                                                              [formatter.formatDateTime(startDate)]);</span>
<a href="#l32.17"></a><span id="l32.17">                 } else {</span>
<a href="#l32.18"></a><span id="l32.18">                     // If the task has no start date, then format the alarm date.</span>
<a href="#l32.19"></a><span id="l32.19">                     dateLabel.textContent = formatter.formatDateTime(this.mAlarm.alarmDate);</span>
<a href="#l32.20"></a><span id="l32.20">                 }</span>
<a href="#l32.21"></a><span id="l32.21">             } else {</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -134,20 +134,20 @@</span>
<a href="#l32.23"></a><span id="l32.23">       &lt;/method&gt;</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25">       &lt;method name=&quot;updateRelativeDateLabel&quot;&gt;</span>
<a href="#l32.26"></a><span id="l32.26">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l32.27"></a><span id="l32.27">             let formatter = cal.getDateFormatter();</span>
<a href="#l32.28"></a><span id="l32.28">             let item = this.mItem;</span>
<a href="#l32.29"></a><span id="l32.29">             let relativeDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-relative-date-label&quot;);</span>
<a href="#l32.30"></a><span id="l32.30">             let relativeDateString;</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-            let startDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+            let startDate = item[cal.dtz.startDateProp(item)] || item[cal.dtz.endDateProp(item)];</span>
<a href="#l32.33"></a><span id="l32.33">             if (startDate) {</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-                startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-                let currentDate = cal.now();</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+                startDate = startDate.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+                let currentDate = cal.dtz.now();</span>
<a href="#l32.38"></a><span id="l32.38">                 let sinceDayStart = (currentDate.hour * 3600) + (currentDate.minute * 60);</span>
<a href="#l32.39"></a><span id="l32.39"> </span>
<a href="#l32.40"></a><span id="l32.40">                 currentDate.second = 0;</span>
<a href="#l32.41"></a><span id="l32.41">                 startDate.second = 0;</span>
<a href="#l32.42"></a><span id="l32.42"> </span>
<a href="#l32.43"></a><span id="l32.43">                 let sinceAlarm = currentDate.subtractDate(startDate).inSeconds;</span>
<a href="#l32.44"></a><span id="l32.44">                 this.mAlarmToday = (sinceAlarm &lt; sinceDayStart) &amp;&amp; (sinceAlarm &gt; sinceDayStart - 86400);</span>
<a href="#l32.45"></a><span id="l32.45"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -239,17 +239,17 @@</span>
<a href="#l33.4"></a><span id="l33.4">     &lt;implementation&gt;</span>
<a href="#l33.5"></a><span id="l33.5">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l33.6"></a><span id="l33.6">           Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l33.7"></a><span id="l33.7">           this.setUpTodayDate();</span>
<a href="#l33.8"></a><span id="l33.8">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l33.9"></a><span id="l33.9"> </span>
<a href="#l33.10"></a><span id="l33.10">       &lt;method name=&quot;setUpTodayDate&quot;&gt;</span>
<a href="#l33.11"></a><span id="l33.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-            let dayNumber = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + cal.now().day + &quot;.number&quot;);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+            let dayNumber = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + cal.dtz.now().day + &quot;.number&quot;);</span>
<a href="#l33.14"></a><span id="l33.14">             document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;day-label&quot;).value = dayNumber;</span>
<a href="#l33.15"></a><span id="l33.15">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.16"></a><span id="l33.16">       &lt;/method&gt;</span>
<a href="#l33.17"></a><span id="l33.17">     &lt;/implementation&gt;</span>
<a href="#l33.18"></a><span id="l33.18">    &lt;/binding&gt;</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20">   &lt;!-- this binding directly extends to a checkbox but is visualized as</span>
<a href="#l33.21"></a><span id="l33.21">        a treenode in a treecontrol--&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -410,25 +410,25 @@</span>
<a href="#l34.4"></a><span id="l34.4">       &lt;property name=&quot;extra&quot;</span>
<a href="#l34.5"></a><span id="l34.5">                 onget=&quot;return this.mExtraDate&quot;</span>
<a href="#l34.6"></a><span id="l34.6">                 onset=&quot;this.mExtraDate = val&quot;/&gt;</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8">        &lt;!--returns the first (inclusive) date of the minimonth as a calIDateTime object--&gt;</span>
<a href="#l34.9"></a><span id="l34.9">       &lt;property name=&quot;firstDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l34.10"></a><span id="l34.10">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l34.11"></a><span id="l34.11">             let date = this._getCalBoxNode(1, 1).date;</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-            return cal.jsDateToDateTime(date);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+            return cal.dtz.jsDateToDateTime(date);</span>
<a href="#l34.14"></a><span id="l34.14">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l34.15"></a><span id="l34.15">       &lt;/property&gt;</span>
<a href="#l34.16"></a><span id="l34.16"> </span>
<a href="#l34.17"></a><span id="l34.17">        &lt;!--returns the last (exclusive) date of the minimonth as a calIDateTime object--&gt;</span>
<a href="#l34.18"></a><span id="l34.18">       &lt;property name=&quot;lastDate&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l34.19"></a><span id="l34.19">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l34.20"></a><span id="l34.20">             let date = this._getCalBoxNode(6, 7).date;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-            let lastDateTime = cal.jsDateToDateTime(date);</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+            let lastDateTime = cal.dtz.jsDateToDateTime(date);</span>
<a href="#l34.23"></a><span id="l34.23">             lastDateTime.day = lastDateTime.day + 1;</span>
<a href="#l34.24"></a><span id="l34.24">             return lastDateTime;</span>
<a href="#l34.25"></a><span id="l34.25">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l34.26"></a><span id="l34.26">       &lt;/property&gt;</span>
<a href="#l34.27"></a><span id="l34.27"> </span>
<a href="#l34.28"></a><span id="l34.28">       &lt;field name=&quot;mDaymap&quot;&gt;null&lt;/field&gt;</span>
<a href="#l34.29"></a><span id="l34.29">       &lt;field name=&quot;mValue&quot;&gt;null&lt;/field&gt;</span>
<a href="#l34.30"></a><span id="l34.30">       &lt;field name=&quot;mEditorDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineat">@@ -573,25 +573,25 @@</span>
<a href="#l34.32"></a><span id="l34.32">       &lt;method name=&quot;setBusyDaysForOccurrence&quot;&gt;</span>
<a href="#l34.33"></a><span id="l34.33">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l34.34"></a><span id="l34.34">         &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l34.35"></a><span id="l34.35">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.36"></a><span id="l34.36">             if (aOccurrence.getProperty(&quot;TRANSP&quot;) == &quot;TRANSPARENT&quot;) {</span>
<a href="#l34.37"></a><span id="l34.37">                 // Skip transparent events</span>
<a href="#l34.38"></a><span id="l34.38">                 return;</span>
<a href="#l34.39"></a><span id="l34.39">             }</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineminus">-            let start = aOccurrence[cal.calGetStartDateProp(aOccurrence)] || aOccurrence.dueDate;</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineminus">-            let end = aOccurrence[cal.calGetEndDateProp(aOccurrence)] || start;</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+            let start = aOccurrence[cal.dtz.startDateProp(aOccurrence)] || aOccurrence.dueDate;</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+            let end = aOccurrence[cal.dtz.endDateProp(aOccurrence)] || start;</span>
<a href="#l34.44"></a><span id="l34.44">             if (!start) {</span>
<a href="#l34.45"></a><span id="l34.45">                 return;</span>
<a href="#l34.46"></a><span id="l34.46">             }</span>
<a href="#l34.47"></a><span id="l34.47"> </span>
<a href="#l34.48"></a><span id="l34.48">             // We need to compare with midnight of the current day, so reset the</span>
<a href="#l34.49"></a><span id="l34.49">             // time here.</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineminus">-            let current = start.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+            let current = start.clone().getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l34.52"></a><span id="l34.52">             current.hour = 0;</span>
<a href="#l34.53"></a><span id="l34.53">             current.minute = 0;</span>
<a href="#l34.54"></a><span id="l34.54">             current.second = 0;</span>
<a href="#l34.55"></a><span id="l34.55"> </span>
<a href="#l34.56"></a><span id="l34.56">             // Cache the result so the compare isn't called in each iteration.</span>
<a href="#l34.57"></a><span id="l34.57">             let compareResult = (start.compare(end) == 0 ? 1 : 0);</span>
<a href="#l34.58"></a><span id="l34.58"> </span>
<a href="#l34.59"></a><span id="l34.59">             // Setup the busy days.</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineat">@@ -874,26 +874,26 @@</span>
<a href="#l34.61"></a><span id="l34.61">                 let monthName = cal.formatMonth(aDate.getMonth() + 1,</span>
<a href="#l34.62"></a><span id="l34.62">                                                 &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l34.63"></a><span id="l34.63">                 let label = cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;,</span>
<a href="#l34.64"></a><span id="l34.64">                                          [monthName, aDate.getFullYear()]);</span>
<a href="#l34.65"></a><span id="l34.65">                 calbox.setAttribute(&quot;aria-label&quot;, label);</span>
<a href="#l34.66"></a><span id="l34.66">             }</span>
<a href="#l34.67"></a><span id="l34.67"> </span>
<a href="#l34.68"></a><span id="l34.68">             this.mDayMap = {};</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-            let defaultTz = cal.calendarDefaultTimezone();</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+            let defaultTz = cal.dtz.defaultTimezone;</span>
<a href="#l34.71"></a><span id="l34.71">             let dateFormatter =</span>
<a href="#l34.72"></a><span id="l34.72">                 new Services.intl.DateTimeFormat(undefined, { dateStyle: &quot;long&quot; });</span>
<a href="#l34.73"></a><span id="l34.73">             for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l34.74"></a><span id="l34.74">                 // Set the week number.</span>
<a href="#l34.75"></a><span id="l34.75">                 let firstElement = this._getCalBoxNode(k, 0);</span>
<a href="#l34.76"></a><span id="l34.76">                 setBooleanAttribute(firstElement, &quot;hidden&quot;, !this.mShowWeekNumber);</span>
<a href="#l34.77"></a><span id="l34.77">                 if (this.mShowWeekNumber) {</span>
<a href="#l34.78"></a><span id="l34.78">                     let weekNumber = cal.getWeekInfoService()</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-                                        .getWeekTitle(cal.jsDateToDateTime(date, defaultTz));</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+                                        .getWeekTitle(cal.dtz.jsDateToDateTime(date, defaultTz));</span>
<a href="#l34.81"></a><span id="l34.81">                     let weekTitle = cal.calGetString(&quot;calendar&quot;, &quot;WeekTitle&quot;, [weekNumber]);</span>
<a href="#l34.82"></a><span id="l34.82">                     firstElement.textContent = weekNumber;</span>
<a href="#l34.83"></a><span id="l34.83">                     firstElement.setAttribute(&quot;aria-label&quot;, weekTitle);</span>
<a href="#l34.84"></a><span id="l34.84">                 }</span>
<a href="#l34.85"></a><span id="l34.85"> </span>
<a href="#l34.86"></a><span id="l34.86">                 for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l34.87"></a><span id="l34.87">                     let day = this._getCalBoxNode(k, i);</span>
<a href="#l34.88"></a><span id="l34.88">                     let ymd = date.getFullYear() + &quot;-&quot; +</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineat">@@ -1001,17 +1001,17 @@</span>
<a href="#l34.90"></a><span id="l34.90">                         default:</span>
<a href="#l34.91"></a><span id="l34.91">                             aBox.removeAttribute(aBox.attributes[allowedAttributes].nodeName);</span>
<a href="#l34.92"></a><span id="l34.92">                             break;</span>
<a href="#l34.93"></a><span id="l34.93">                     }</span>
<a href="#l34.94"></a><span id="l34.94">                 }</span>
<a href="#l34.95"></a><span id="l34.95">             }</span>
<a href="#l34.96"></a><span id="l34.96"> </span>
<a href="#l34.97"></a><span id="l34.97">             if (aDate) {</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-                let box = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+                let box = this.getBoxForDate(cal.dtz.jsDateToDateTime(aDate, cal.dtz.defaultTimezone));</span>
<a href="#l34.100"></a><span id="l34.100">                 if (box) {</span>
<a href="#l34.101"></a><span id="l34.101">                     removeForBox(box);</span>
<a href="#l34.102"></a><span id="l34.102">                 }</span>
<a href="#l34.103"></a><span id="l34.103">             } else {</span>
<a href="#l34.104"></a><span id="l34.104">                 for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l34.105"></a><span id="l34.105">                     for (let i = 1; i &lt; 8; i++) {</span>
<a href="#l34.106"></a><span id="l34.106">                         removeForBox(this._getCalBoxNode(k, i));</span>
<a href="#l34.107"></a><span id="l34.107">                     }</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineat">@@ -1109,17 +1109,17 @@</span>
<a href="#l34.109"></a><span id="l34.109">             this.updateAccessibleLabel();</span>
<a href="#l34.110"></a><span id="l34.110">         ]]&gt;&lt;/body&gt;</span>
<a href="#l34.111"></a><span id="l34.111">       &lt;/method&gt;</span>
<a href="#l34.112"></a><span id="l34.112"> </span>
<a href="#l34.113"></a><span id="l34.113">       &lt;method name=&quot;setFocusedDate&quot;&gt;</span>
<a href="#l34.114"></a><span id="l34.114">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l34.115"></a><span id="l34.115">         &lt;parameter name=&quot;aForceFocus&quot;/&gt;</span>
<a href="#l34.116"></a><span id="l34.116">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-            let newFocused = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+            let newFocused = this.getBoxForDate(cal.dtz.jsDateToDateTime(aDate, cal.dtz.defaultTimezone));</span>
<a href="#l34.119"></a><span id="l34.119">             if (!newFocused) {</span>
<a href="#l34.120"></a><span id="l34.120">                 return;</span>
<a href="#l34.121"></a><span id="l34.121">             }</span>
<a href="#l34.122"></a><span id="l34.122">             if (this.mFocused) {</span>
<a href="#l34.123"></a><span id="l34.123">                 this.mFocused.setAttribute(&quot;tabindex&quot;, &quot;-1&quot;);</span>
<a href="#l34.124"></a><span id="l34.124">             }</span>
<a href="#l34.125"></a><span id="l34.125">             this.mFocused = newFocused;</span>
<a href="#l34.126"></a><span id="l34.126">             this.mFocused.setAttribute(&quot;tabindex&quot;, &quot;0&quot;);</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineat">@@ -1185,17 +1185,17 @@</span>
<a href="#l34.128"></a><span id="l34.128">                 // change month and select day</span>
<a href="#l34.129"></a><span id="l34.129">                 this.mValue = aDate;</span>
<a href="#l34.130"></a><span id="l34.130">                 this.showMonth(aMainDate);</span>
<a href="#l34.131"></a><span id="l34.131">             } else if (!sameMonth) {</span>
<a href="#l34.132"></a><span id="l34.132">                 // change month only</span>
<a href="#l34.133"></a><span id="l34.133">                 this.showMonth(aMainDate);</span>
<a href="#l34.134"></a><span id="l34.134">             } else if (!sameDate) {</span>
<a href="#l34.135"></a><span id="l34.135">                 // select day only</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-                let day = this.getBoxForDate(cal.jsDateToDateTime(aDate, cal.calendarDefaultTimezone()));</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+                let day = this.getBoxForDate(cal.dtz.jsDateToDateTime(aDate, cal.dtz.defaultTimezone));</span>
<a href="#l34.138"></a><span id="l34.138">                 if (this.mSelected) {</span>
<a href="#l34.139"></a><span id="l34.139">                     this.mSelected.removeAttribute(&quot;selected&quot;);</span>
<a href="#l34.140"></a><span id="l34.140">                 }</span>
<a href="#l34.141"></a><span id="l34.141">                 this.mSelected = day;</span>
<a href="#l34.142"></a><span id="l34.142">                 day.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l34.143"></a><span id="l34.143">                 this.mValue = aDate;</span>
<a href="#l34.144"></a><span id="l34.144">                 this.setFocusedDate(aDate);</span>
<a href="#l34.145"></a><span id="l34.145">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/modules/calAlarmUtils.jsm</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -26,17 +26,17 @@ cal.alarms = {</span>
<a href="#l35.4"></a><span id="l35.4">                 units = &quot;minutes&quot;;</span>
<a href="#l35.5"></a><span id="l35.5">             }</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7">             alarmOffset[units] = Preferences.get(&quot;calendar.alarms.&quot; + type + &quot;alarmlen&quot;, 0);</span>
<a href="#l35.8"></a><span id="l35.8">             alarmOffset.normalize();</span>
<a href="#l35.9"></a><span id="l35.9">             alarmOffset.isNegative = true;</span>
<a href="#l35.10"></a><span id="l35.10">             if (type == &quot;todo&quot; &amp;&amp; !aItem.entryDate) {</span>
<a href="#l35.11"></a><span id="l35.11">                 // You can't have an alarm if the entryDate doesn't exist.</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-                aItem.entryDate = cal.now();</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+                aItem.entryDate = cal.dtz.now();</span>
<a href="#l35.14"></a><span id="l35.14">             }</span>
<a href="#l35.15"></a><span id="l35.15">             alarm.related = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l35.16"></a><span id="l35.16">             alarm.offset = alarmOffset;</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18">             // Default to a display alarm, unless the calendar doesn't support</span>
<a href="#l35.19"></a><span id="l35.19">             // it or we have no calendar yet. (Man this is hard to wrap)</span>
<a href="#l35.20"></a><span id="l35.20">             let actionValues = (aItem.calendar &amp;&amp;</span>
<a href="#l35.21"></a><span id="l35.21">                                  aItem.calendar.getProperty(&quot;capabilities.alarms.actionValues&quot;)) ||</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -55,32 +55,32 @@ cal.alarms = {</span>
<a href="#l35.23"></a><span id="l35.23">      * @return          The alarm date.</span>
<a href="#l35.24"></a><span id="l35.24">      */</span>
<a href="#l35.25"></a><span id="l35.25">     calculateAlarmDate: function(aItem, aAlarm) {</span>
<a href="#l35.26"></a><span id="l35.26">         if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l35.27"></a><span id="l35.27">             return aAlarm.alarmDate;</span>
<a href="#l35.28"></a><span id="l35.28">         } else {</span>
<a href="#l35.29"></a><span id="l35.29">             let returnDate;</span>
<a href="#l35.30"></a><span id="l35.30">             if (aAlarm.related == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-                returnDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+                returnDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l35.33"></a><span id="l35.33">             } else if (aAlarm.related == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-                returnDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+                returnDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l35.36"></a><span id="l35.36">             }</span>
<a href="#l35.37"></a><span id="l35.37"> </span>
<a href="#l35.38"></a><span id="l35.38">             if (returnDate &amp;&amp; aAlarm.offset) {</span>
<a href="#l35.39"></a><span id="l35.39">                 // Handle all day events.  This is kinda weird, because they don't</span>
<a href="#l35.40"></a><span id="l35.40">                 // have a well defined startTime.  We just consider the start/end</span>
<a href="#l35.41"></a><span id="l35.41">                 // to be midnight in the user's timezone.</span>
<a href="#l35.42"></a><span id="l35.42">                 if (returnDate.isDate) {</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-                    let timezone = cal.calendarDefaultTimezone();</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+                    let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l35.45"></a><span id="l35.45">                     // This returns a copy, so no extra cloning needed.</span>
<a href="#l35.46"></a><span id="l35.46">                     returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l35.47"></a><span id="l35.47">                     returnDate.isDate = false;</span>
<a href="#l35.48"></a><span id="l35.48">                 } else if (returnDate.timezone.tzid == &quot;floating&quot;) {</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-                    let timezone = cal.calendarDefaultTimezone();</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+                    let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l35.51"></a><span id="l35.51">                     returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l35.52"></a><span id="l35.52">                 } else {</span>
<a href="#l35.53"></a><span id="l35.53">                     // Clone the date to correctly add the duration.</span>
<a href="#l35.54"></a><span id="l35.54">                     returnDate = returnDate.clone();</span>
<a href="#l35.55"></a><span id="l35.55">                 }</span>
<a href="#l35.56"></a><span id="l35.56"> </span>
<a href="#l35.57"></a><span id="l35.57">                 returnDate.addDuration(aAlarm.offset);</span>
<a href="#l35.58"></a><span id="l35.58">                 return returnDate;</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineat">@@ -100,19 +100,19 @@ cal.alarms = {</span>
<a href="#l35.60"></a><span id="l35.60">      *                    passed, ALARM_RELATED_START will be assumed.</span>
<a href="#l35.61"></a><span id="l35.61">      * @return          The alarm offset.</span>
<a href="#l35.62"></a><span id="l35.62">      */</span>
<a href="#l35.63"></a><span id="l35.63">     calculateAlarmOffset: function(aItem, aAlarm, aRelated) {</span>
<a href="#l35.64"></a><span id="l35.64">         let offset = aAlarm.offset;</span>
<a href="#l35.65"></a><span id="l35.65">         if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l35.66"></a><span id="l35.66">             let returnDate;</span>
<a href="#l35.67"></a><span id="l35.67">             if (aRelated === undefined || aRelated == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineminus">-                returnDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+                returnDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l35.70"></a><span id="l35.70">             } else if (aRelated == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineminus">-                returnDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+                returnDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l35.73"></a><span id="l35.73">             }</span>
<a href="#l35.74"></a><span id="l35.74"> </span>
<a href="#l35.75"></a><span id="l35.75">             if (returnDate &amp;&amp; aAlarm.alarmDate) {</span>
<a href="#l35.76"></a><span id="l35.76">                 offset = aAlarm.alarmDate.subtractDate(returnDate);</span>
<a href="#l35.77"></a><span id="l35.77">             }</span>
<a href="#l35.78"></a><span id="l35.78">         }</span>
<a href="#l35.79"></a><span id="l35.79">         return offset;</span>
<a href="#l35.80"></a><span id="l35.80">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/modules/calItipUtils.jsm</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -977,17 +977,17 @@ function setReceivedInfo(item, itipItemI</span>
<a href="#l36.4"></a><span id="l36.4">     let wrappedItem = cal.wrapInstance(item, Components.interfaces.calIAttendee);</span>
<a href="#l36.5"></a><span id="l36.5">     item.setProperty(wrappedItem ? &quot;RECEIVED-SEQUENCE&quot;</span>
<a href="#l36.6"></a><span id="l36.6">                                  : &quot;X-MOZ-RECEIVED-SEQUENCE&quot;,</span>
<a href="#l36.7"></a><span id="l36.7">                                  String(cal.itip.getSequence(itipItemItem)));</span>
<a href="#l36.8"></a><span id="l36.8">     let dtstamp = cal.itip.getStamp(itipItemItem);</span>
<a href="#l36.9"></a><span id="l36.9">     if (dtstamp) {</span>
<a href="#l36.10"></a><span id="l36.10">         item.setProperty(wrappedItem ? &quot;RECEIVED-DTSTAMP&quot;</span>
<a href="#l36.11"></a><span id="l36.11">                                      : &quot;X-MOZ-RECEIVED-DTSTAMP&quot;,</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-                                     dtstamp.getInTimezone(cal.UTC()).icalString);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+                                     dtstamp.getInTimezone(cal.dtz.UTC).icalString);</span>
<a href="#l36.14"></a><span id="l36.14">     }</span>
<a href="#l36.15"></a><span id="l36.15"> }</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17"> /**</span>
<a href="#l36.18"></a><span id="l36.18">  * Strips user specific data, e.g. categories and alarm settings and returns the stripped item.</span>
<a href="#l36.19"></a><span id="l36.19">  */</span>
<a href="#l36.20"></a><span id="l36.20"> function stripUserData(item_) {</span>
<a href="#l36.21"></a><span id="l36.21">     let item = item_.clone();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -155,29 +155,29 @@ cal.print = {</span>
<a href="#l37.4"></a><span id="l37.4">     /**</span>
<a href="#l37.5"></a><span id="l37.5">      * Get time interval string for the given item. Returns an empty string for all-day items.</span>
<a href="#l37.6"></a><span id="l37.6">      *</span>
<a href="#l37.7"></a><span id="l37.7">      * @param aItem     The item providing the interval</span>
<a href="#l37.8"></a><span id="l37.8">      * @return          The string describing the interval</span>
<a href="#l37.9"></a><span id="l37.9">      */</span>
<a href="#l37.10"></a><span id="l37.10">     getItemIntervalString: function(aItem, aBoxDate) {</span>
<a href="#l37.11"></a><span id="l37.11">         // omit time label for all-day items</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-        let startDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-        let endDate = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+        let startDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+        let endDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l37.16"></a><span id="l37.16">         if ((startDate &amp;&amp; startDate.isDate) || (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l37.17"></a><span id="l37.17">             return &quot;&quot;;</span>
<a href="#l37.18"></a><span id="l37.18">         }</span>
<a href="#l37.19"></a><span id="l37.19"> </span>
<a href="#l37.20"></a><span id="l37.20">         // check for tasks without start and/or due date</span>
<a href="#l37.21"></a><span id="l37.21">         if (!startDate || !endDate) {</span>
<a href="#l37.22"></a><span id="l37.22">             return cal.getDateFormatter().formatItemTimeInterval(aItem);</span>
<a href="#l37.23"></a><span id="l37.23">         }</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25">         let dateFormatter = cal.getDateFormatter();</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-        let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+        let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l37.28"></a><span id="l37.28">         startDate = startDate.getInTimezone(defaultTimezone);</span>
<a href="#l37.29"></a><span id="l37.29">         endDate = endDate.getInTimezone(defaultTimezone);</span>
<a href="#l37.30"></a><span id="l37.30">         let start = startDate.clone();</span>
<a href="#l37.31"></a><span id="l37.31">         let end = endDate.clone();</span>
<a href="#l37.32"></a><span id="l37.32">         start.isDate = true;</span>
<a href="#l37.33"></a><span id="l37.33">         end.isDate = true;</span>
<a href="#l37.34"></a><span id="l37.34">         if (start.compare(end) == 0) {</span>
<a href="#l37.35"></a><span id="l37.35">             // Events that start and end in the same day.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -333,17 +333,17 @@ cal.fromRFC3339 = function(aStr, aTimezo</span>
<a href="#l38.4"></a><span id="l38.4">         dateTime.minute = matches[6];</span>
<a href="#l38.5"></a><span id="l38.5">         dateTime.second = matches[7];</span>
<a href="#l38.6"></a><span id="l38.6">     }</span>
<a href="#l38.7"></a><span id="l38.7"> </span>
<a href="#l38.8"></a><span id="l38.8">     // Timezone handling</span>
<a href="#l38.9"></a><span id="l38.9">     if (matches[9] == &quot;Z&quot; || matches[9] == &quot;z&quot;) {</span>
<a href="#l38.10"></a><span id="l38.10">         // If the dates timezone is &quot;Z&quot; or &quot;z&quot;, then this is UTC, no matter</span>
<a href="#l38.11"></a><span id="l38.11">         // what timezone was passed</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-        dateTime.timezone = cal.UTC();</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+        dateTime.timezone = cal.dtz.UTC;</span>
<a href="#l38.14"></a><span id="l38.14">     } else if (matches[9] == null) {</span>
<a href="#l38.15"></a><span id="l38.15">         // We have no timezone info, only a date. We have no way to</span>
<a href="#l38.16"></a><span id="l38.16">         // know what timezone we are in, so lets assume we are in the</span>
<a href="#l38.17"></a><span id="l38.17">         // timezone of our local calendar, or whatever was passed.</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19">         dateTime.timezone = aTimezone;</span>
<a href="#l38.20"></a><span id="l38.20">     } else {</span>
<a href="#l38.21"></a><span id="l38.21">         let offset_in_s = (matches[11] == &quot;-&quot; ? -1 : 1) *</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -365,17 +365,17 @@ cal.fromRFC3339 = function(aStr, aTimezo</span>
<a href="#l38.23"></a><span id="l38.23">                 let id = enumerator.getNext();</span>
<a href="#l38.24"></a><span id="l38.24">                 dateTime.timezone = tzService.getTimezone(id);</span>
<a href="#l38.25"></a><span id="l38.25">                 if (dateTime.timezoneOffset == offset_in_s) {</span>
<a href="#l38.26"></a><span id="l38.26">                     // This is our last step, so go ahead and return</span>
<a href="#l38.27"></a><span id="l38.27">                     return dateTime;</span>
<a href="#l38.28"></a><span id="l38.28">                 }</span>
<a href="#l38.29"></a><span id="l38.29">             }</span>
<a href="#l38.30"></a><span id="l38.30">             // We are still here: no timezone was found</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-            dateTime.timezone = cal.UTC();</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+            dateTime.timezone = cal.dtz.UTC;</span>
<a href="#l38.33"></a><span id="l38.33">             if (!dateTime.isDate) {</span>
<a href="#l38.34"></a><span id="l38.34">                 dateTime.hour += (matches[11] == &quot;-&quot; ? -1 : 1) * matches[12];</span>
<a href="#l38.35"></a><span id="l38.35">                 dateTime.minute += (matches[11] == &quot;-&quot; ? -1 : 1) * matches[13];</span>
<a href="#l38.36"></a><span id="l38.36">             }</span>
<a href="#l38.37"></a><span id="l38.37">         }</span>
<a href="#l38.38"></a><span id="l38.38">     }</span>
<a href="#l38.39"></a><span id="l38.39">     return dateTime;</span>
<a href="#l38.40"></a><span id="l38.40"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/modules/calRecurrenceUtils.jsm</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -302,17 +302,17 @@ function recurrenceRule2String(recurrenc</span>
<a href="#l39.4"></a><span id="l39.4">                 } else {</span>
<a href="#l39.5"></a><span id="l39.5">                     let month = getRString(&quot;repeatDetailsMonth&quot; + (startDate.month + 1));</span>
<a href="#l39.6"></a><span id="l39.6">                     let yearlyString = getRString(&quot;yearlyNthOn&quot;, [month, startDate.day]);</span>
<a href="#l39.7"></a><span id="l39.7">                     ruleString = PluralForm.get(rule.interval, yearlyString)</span>
<a href="#l39.8"></a><span id="l39.8">                                            .replace(&quot;#3&quot;, rule.interval);</span>
<a href="#l39.9"></a><span id="l39.9">                 }</span>
<a href="#l39.10"></a><span id="l39.10">             }</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l39.14"></a><span id="l39.14"> </span>
<a href="#l39.15"></a><span id="l39.15">             let detailsString;</span>
<a href="#l39.16"></a><span id="l39.16">             if (!endDate || allDay) {</span>
<a href="#l39.17"></a><span id="l39.17">                 if (rule.isFinite) {</span>
<a href="#l39.18"></a><span id="l39.18">                     if (rule.isByCount) {</span>
<a href="#l39.19"></a><span id="l39.19">                         let countString = getRString(&quot;repeatCountAllDay&quot;, [</span>
<a href="#l39.20"></a><span id="l39.20">                             ruleString,</span>
<a href="#l39.21"></a><span id="l39.21">                             dateFormatter.formatDateShort(startDate)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -761,60 +761,60 @@ var cal = {</span>
<a href="#l40.4"></a><span id="l40.4">      * moves an item to another startDate</span>
<a href="#l40.5"></a><span id="l40.5">      *</span>
<a href="#l40.6"></a><span id="l40.6">      * @param aOldItem             The Item to be modified</span>
<a href="#l40.7"></a><span id="l40.7">      * @param aNewDate             The date at which the new item is going to start</span>
<a href="#l40.8"></a><span id="l40.8">      * @return                     The modified item</span>
<a href="#l40.9"></a><span id="l40.9">      */</span>
<a href="#l40.10"></a><span id="l40.10">     moveItem: function(aOldItem, aNewDate) {</span>
<a href="#l40.11"></a><span id="l40.11">         let newItem = aOldItem.clone();</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-        let start = (aOldItem[cal.calGetStartDateProp(aOldItem)] ||</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-                     aOldItem[cal.calGetEndDateProp(aOldItem)]).clone();</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+        let start = (aOldItem[cal.dtz.startDateProp(aOldItem)] ||</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+                     aOldItem[cal.dtz.endDateProp(aOldItem)]).clone();</span>
<a href="#l40.16"></a><span id="l40.16">         let isDate = start.isDate;</span>
<a href="#l40.17"></a><span id="l40.17">         start.resetTo(aNewDate.year, aNewDate.month, aNewDate.day,</span>
<a href="#l40.18"></a><span id="l40.18">                       start.hour, start.minute, start.second,</span>
<a href="#l40.19"></a><span id="l40.19">                       start.timezone);</span>
<a href="#l40.20"></a><span id="l40.20">         start.isDate = isDate;</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-        if (newItem[cal.calGetStartDateProp(newItem)]) {</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-            newItem[cal.calGetStartDateProp(newItem)] = start;</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+        if (newItem[cal.dtz.startDateProp(newItem)]) {</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+            newItem[cal.dtz.startDateProp(newItem)] = start;</span>
<a href="#l40.25"></a><span id="l40.25">             let oldDuration = aOldItem.duration;</span>
<a href="#l40.26"></a><span id="l40.26">             if (oldDuration) {</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-                let oldEnd = aOldItem[cal.calGetEndDateProp(aOldItem)];</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+                let oldEnd = aOldItem[cal.dtz.endDateProp(aOldItem)];</span>
<a href="#l40.29"></a><span id="l40.29">                 let newEnd = start.clone();</span>
<a href="#l40.30"></a><span id="l40.30">                 newEnd.addDuration(oldDuration);</span>
<a href="#l40.31"></a><span id="l40.31">                 newEnd = newEnd.getInTimezone(oldEnd.timezone);</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineminus">-                newItem[cal.calGetEndDateProp(newItem)] = newEnd;</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+                newItem[cal.dtz.endDateProp(newItem)] = newEnd;</span>
<a href="#l40.34"></a><span id="l40.34">             }</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-        } else if (newItem[cal.calGetEndDateProp(newItem)]) {</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">-            newItem[cal.calGetEndDateProp(newItem)] = start;</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+        } else if (newItem[cal.dtz.endDateProp(newItem)]) {</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+            newItem[cal.dtz.endDateProp(newItem)] = start;</span>
<a href="#l40.39"></a><span id="l40.39">         }</span>
<a href="#l40.40"></a><span id="l40.40">         return newItem;</span>
<a href="#l40.41"></a><span id="l40.41">     },</span>
<a href="#l40.42"></a><span id="l40.42"> </span>
<a href="#l40.43"></a><span id="l40.43">     /**</span>
<a href="#l40.44"></a><span id="l40.44">      * sets the 'isDate' property of an item</span>
<a href="#l40.45"></a><span id="l40.45">      *</span>
<a href="#l40.46"></a><span id="l40.46">      * @param aItem         The Item to be modified</span>
<a href="#l40.47"></a><span id="l40.47">      * @param aIsDate       True or false indicating the new value of 'isDate'</span>
<a href="#l40.48"></a><span id="l40.48">      * @return              The modified item</span>
<a href="#l40.49"></a><span id="l40.49">      */</span>
<a href="#l40.50"></a><span id="l40.50">     setItemToAllDay: function(aItem, aIsDate) {</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineminus">-        let start = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineminus">-        let end = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+        let start = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+        let end = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l40.55"></a><span id="l40.55">         if (start || end) {</span>
<a href="#l40.56"></a><span id="l40.56">             let item = aItem.clone();</span>
<a href="#l40.57"></a><span id="l40.57">             if (start &amp;&amp; (start.isDate != aIsDate)) {</span>
<a href="#l40.58"></a><span id="l40.58">                 start = start.clone();</span>
<a href="#l40.59"></a><span id="l40.59">                 start.isDate = aIsDate;</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">-                item[cal.calGetStartDateProp(item)] = start;</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+                item[cal.dtz.startDateProp(item)] = start;</span>
<a href="#l40.62"></a><span id="l40.62">             }</span>
<a href="#l40.63"></a><span id="l40.63">             if (end &amp;&amp; (end.isDate != aIsDate)) {</span>
<a href="#l40.64"></a><span id="l40.64">                 end = end.clone();</span>
<a href="#l40.65"></a><span id="l40.65">                 end.isDate = aIsDate;</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-                item[cal.calGetEndDateProp(item)] = end;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+                item[cal.dtz.endDateProp(item)] = end;</span>
<a href="#l40.68"></a><span id="l40.68">             }</span>
<a href="#l40.69"></a><span id="l40.69">             return item;</span>
<a href="#l40.70"></a><span id="l40.70">         } else {</span>
<a href="#l40.71"></a><span id="l40.71">             return aItem;</span>
<a href="#l40.72"></a><span id="l40.72">         }</span>
<a href="#l40.73"></a><span id="l40.73">     },</span>
<a href="#l40.74"></a><span id="l40.74"> </span>
<a href="#l40.75"></a><span id="l40.75">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -392,17 +392,17 @@ calAlarm.prototype = {</span>
<a href="#l41.4"></a><span id="l41.4">         actionProp.value = this.action;</span>
<a href="#l41.5"></a><span id="l41.5">         comp.addProperty(actionProp);</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7">         // Set up trigger (REQUIRED)</span>
<a href="#l41.8"></a><span id="l41.8">         let triggerProp = icssvc.createIcalProperty(&quot;TRIGGER&quot;);</span>
<a href="#l41.9"></a><span id="l41.9">         if (this.related == ALARM_RELATED_ABSOLUTE &amp;&amp; this.mAbsoluteDate) {</span>
<a href="#l41.10"></a><span id="l41.10">             // Set the trigger to a specific datetime</span>
<a href="#l41.11"></a><span id="l41.11">             triggerProp.setParameter(&quot;VALUE&quot;, &quot;DATE-TIME&quot;);</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-            triggerProp.valueAsDatetime = this.mAbsoluteDate.getInTimezone(cal.UTC());</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+            triggerProp.valueAsDatetime = this.mAbsoluteDate.getInTimezone(cal.dtz.UTC);</span>
<a href="#l41.14"></a><span id="l41.14">         } else if (this.related != ALARM_RELATED_ABSOLUTE &amp;&amp; this.mOffset) {</span>
<a href="#l41.15"></a><span id="l41.15">             triggerProp.valueAsIcalString = this.mOffset.icalString;</span>
<a href="#l41.16"></a><span id="l41.16">             if (this.related == ALARM_RELATED_END) {</span>
<a href="#l41.17"></a><span id="l41.17">                 // An alarm related to the end of the event.</span>
<a href="#l41.18"></a><span id="l41.18">                 triggerProp.setParameter(&quot;RELATED&quot;, &quot;END&quot;);</span>
<a href="#l41.19"></a><span id="l41.19">             }</span>
<a href="#l41.20"></a><span id="l41.20">         } else {</span>
<a href="#l41.21"></a><span id="l41.21">             // No offset or absolute date is not valid.</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -635,17 +635,17 @@ calAlarm.prototype = {</span>
<a href="#l41.23"></a><span id="l41.23">                 return aPrefix;</span>
<a href="#l41.24"></a><span id="l41.24">             }</span>
<a href="#l41.25"></a><span id="l41.25">         }</span>
<a href="#l41.26"></a><span id="l41.26"> </span>
<a href="#l41.27"></a><span id="l41.27">         if (this.related == ALARM_RELATED_ABSOLUTE &amp;&amp; this.mAbsoluteDate) {</span>
<a href="#l41.28"></a><span id="l41.28">             // this is an absolute alarm. Use the calendar default timezone and</span>
<a href="#l41.29"></a><span id="l41.29">             // format it.</span>
<a href="#l41.30"></a><span id="l41.30">             let formatter = cal.getDateFormatter();</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-            let formatDate = this.mAbsoluteDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+            let formatDate = this.mAbsoluteDate.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l41.33"></a><span id="l41.33">             return formatter.formatDateTime(formatDate);</span>
<a href="#l41.34"></a><span id="l41.34">         } else if (this.related != ALARM_RELATED_ABSOLUTE &amp;&amp; this.mOffset) {</span>
<a href="#l41.35"></a><span id="l41.35">             // Relative alarm length</span>
<a href="#l41.36"></a><span id="l41.36">             let alarmlen = Math.abs(this.mOffset.inSeconds / 60);</span>
<a href="#l41.37"></a><span id="l41.37">             if (alarmlen == 0) {</span>
<a href="#l41.38"></a><span id="l41.38">                 // No need to get the other information if the alarm is at the start</span>
<a href="#l41.39"></a><span id="l41.39">                 // of the event/task.</span>
<a href="#l41.40"></a><span id="l41.40">                 if (this.related == ALARM_RELATED_START) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -7,17 +7,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l42.4"></a><span id="l42.4"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l42.5"></a><span id="l42.5"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l42.6"></a><span id="l42.6"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l42.7"></a><span id="l42.7"> Components.utils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9"> var kHoursBetweenUpdates = 6;</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11"> function nowUTC() {</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-    return cal.jsDateToDateTime(new Date()).getInTimezone(cal.UTC());</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+    return cal.dtz.jsDateToDateTime(new Date()).getInTimezone(cal.dtz.UTC);</span>
<a href="#l42.14"></a><span id="l42.14"> }</span>
<a href="#l42.15"></a><span id="l42.15"> </span>
<a href="#l42.16"></a><span id="l42.16"> function newTimerWithCallback(aCallback, aDelay, aRepeating) {</span>
<a href="#l42.17"></a><span id="l42.17">     let timer = Components.classes[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l42.18"></a><span id="l42.18">                           .createInstance(Components.interfaces.nsITimer);</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20">     timer.initWithCallback(aCallback,</span>
<a href="#l42.21"></a><span id="l42.21">                            aDelay,</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -138,17 +138,17 @@ calAlarmService.prototype = {</span>
<a href="#l42.23"></a><span id="l42.23">     },</span>
<a href="#l42.24"></a><span id="l42.24"> </span>
<a href="#l42.25"></a><span id="l42.25">     /**</span>
<a href="#l42.26"></a><span id="l42.26">      * calIAlarmService APIs</span>
<a href="#l42.27"></a><span id="l42.27">      */</span>
<a href="#l42.28"></a><span id="l42.28">     get timezone() {</span>
<a href="#l42.29"></a><span id="l42.29">         // TODO Do we really need this? Do we ever set the timezone to something</span>
<a href="#l42.30"></a><span id="l42.30">         // different than the default timezone?</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-        return this.mTimezone || cal.calendarDefaultTimezone();</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+        return this.mTimezone || cal.dtz.defaultTimezone;</span>
<a href="#l42.33"></a><span id="l42.33">     },</span>
<a href="#l42.34"></a><span id="l42.34"> </span>
<a href="#l42.35"></a><span id="l42.35">     set timezone(aTimezone) {</span>
<a href="#l42.36"></a><span id="l42.36">         return (this.mTimezone = aTimezone);</span>
<a href="#l42.37"></a><span id="l42.37">     },</span>
<a href="#l42.38"></a><span id="l42.38"> </span>
<a href="#l42.39"></a><span id="l42.39">     snoozeAlarm: function(aItem, aAlarm, aDuration) {</span>
<a href="#l42.40"></a><span id="l42.40">         // Right now we only support snoozing all alarms for the given item for</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineat">@@ -259,17 +259,17 @@ calAlarmService.prototype = {</span>
<a href="#l42.42"></a><span id="l42.42">                     this.alarmService.mRangeStart = start.clone();</span>
<a href="#l42.43"></a><span id="l42.43">                 }</span>
<a href="#l42.44"></a><span id="l42.44">                 let until = now.clone();</span>
<a href="#l42.45"></a><span id="l42.45">                 until.month += Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l42.46"></a><span id="l42.46"> </span>
<a href="#l42.47"></a><span id="l42.47">                 // We don't set timers for every future alarm, only those within 6 hours</span>
<a href="#l42.48"></a><span id="l42.48">                 let end = now.clone();</span>
<a href="#l42.49"></a><span id="l42.49">                 end.hour += kHoursBetweenUpdates;</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineminus">-                this.alarmService.mRangeEnd = end.getInTimezone(cal.UTC());</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+                this.alarmService.mRangeEnd = end.getInTimezone(cal.dtz.UTC);</span>
<a href="#l42.52"></a><span id="l42.52"> </span>
<a href="#l42.53"></a><span id="l42.53">                 this.alarmService.findAlarms(cal.getCalendarManager().getCalendars({}),</span>
<a href="#l42.54"></a><span id="l42.54">                                              start, until);</span>
<a href="#l42.55"></a><span id="l42.55">             }</span>
<a href="#l42.56"></a><span id="l42.56">         };</span>
<a href="#l42.57"></a><span id="l42.57">         timerCallback.notify();</span>
<a href="#l42.58"></a><span id="l42.58"> </span>
<a href="#l42.59"></a><span id="l42.59">         this.mUpdateTimer = newTimerWithCallback(timerCallback, kHoursBetweenUpdates * 3600000, true);</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineat">@@ -338,17 +338,17 @@ calAlarmService.prototype = {</span>
<a href="#l42.61"></a><span id="l42.61"> </span>
<a href="#l42.62"></a><span id="l42.62">             // Handle all day events.  This is kinda weird, because they don't have</span>
<a href="#l42.63"></a><span id="l42.63">             // a well defined startTime.  We just consider the start/end to be</span>
<a href="#l42.64"></a><span id="l42.64">             // midnight in the user's timezone.</span>
<a href="#l42.65"></a><span id="l42.65">             if (alarmDate.isDate) {</span>
<a href="#l42.66"></a><span id="l42.66">                 alarmDate = alarmDate.getInTimezone(this.timezone);</span>
<a href="#l42.67"></a><span id="l42.67">                 alarmDate.isDate = false;</span>
<a href="#l42.68"></a><span id="l42.68">             }</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-            alarmDate = alarmDate.getInTimezone(cal.UTC());</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineplus">+            alarmDate = alarmDate.getInTimezone(cal.dtz.UTC);</span>
<a href="#l42.71"></a><span id="l42.71"> </span>
<a href="#l42.72"></a><span id="l42.72">             // Check for snooze</span>
<a href="#l42.73"></a><span id="l42.73">             let snoozeDate;</span>
<a href="#l42.74"></a><span id="l42.74">             if (aItem.parentItem == aItem) {</span>
<a href="#l42.75"></a><span id="l42.75">                 snoozeDate = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l42.76"></a><span id="l42.76">             } else {</span>
<a href="#l42.77"></a><span id="l42.77">                 snoozeDate = aItem.parentItem.getProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime);</span>
<a href="#l42.78"></a><span id="l42.78">             }</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineat">@@ -360,18 +360,18 @@ calAlarmService.prototype = {</span>
<a href="#l42.80"></a><span id="l42.80">             // an alarm can only be snoozed to a later time, if earlier it's from another alarm.</span>
<a href="#l42.81"></a><span id="l42.81">             if (snoozeDate &amp;&amp; snoozeDate.compare(alarmDate) &gt; 0) {</span>
<a href="#l42.82"></a><span id="l42.82">                 // If the alarm was snoozed, the snooze time is more important.</span>
<a href="#l42.83"></a><span id="l42.83">                 alarmDate = snoozeDate;</span>
<a href="#l42.84"></a><span id="l42.84">             }</span>
<a href="#l42.85"></a><span id="l42.85"> </span>
<a href="#l42.86"></a><span id="l42.86">             let now = nowUTC();</span>
<a href="#l42.87"></a><span id="l42.87">             if (alarmDate.timezone.isFloating) {</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-                now = cal.now();</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-                now.timezone = cal.floating();</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+                now = cal.dtz.now();</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+                now.timezone = cal.dtz.floating;</span>
<a href="#l42.92"></a><span id="l42.92">             }</span>
<a href="#l42.93"></a><span id="l42.93"> </span>
<a href="#l42.94"></a><span id="l42.94">             if (alarmDate.compare(now) &gt;= 0) {</span>
<a href="#l42.95"></a><span id="l42.95">                 // We assume that future alarms haven't been acknowledged</span>
<a href="#l42.96"></a><span id="l42.96">                 // Delay is in msec, so don't forget to multiply</span>
<a href="#l42.97"></a><span id="l42.97">                 let timeout = alarmDate.subtractDate(now).inSeconds * 1000;</span>
<a href="#l42.98"></a><span id="l42.98"> </span>
<a href="#l42.99"></a><span id="l42.99">                 // No sense in keeping an extra timeout for an alarm thats past</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -72,17 +72,17 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l43.4"></a><span id="l43.4">     _inTimezone: function(aDate, aOptions) {</span>
<a href="#l43.5"></a><span id="l43.5">         let timezone = aDate.timezone;</span>
<a href="#l43.6"></a><span id="l43.6">         // we set the tz only if we have a valid tz - otherwise localtime will be used on formatting.</span>
<a href="#l43.7"></a><span id="l43.7">         if (timezone &amp;&amp; (timezone.isUTC || timezone.icalComponent)) {</span>
<a href="#l43.8"></a><span id="l43.8">             aOptions.timeZone = timezone.tzid;</span>
<a href="#l43.9"></a><span id="l43.9">         }</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11">         let formatter = new Services.intl.DateTimeFormat(undefined, aOptions);</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-        return formatter.format(cal.dateTimeToJsDate(aDate));</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+        return formatter.format(cal.dtz.dateTimeToJsDate(aDate));</span>
<a href="#l43.14"></a><span id="l43.14">     },</span>
<a href="#l43.15"></a><span id="l43.15"> </span>
<a href="#l43.16"></a><span id="l43.16">     formatTimeInterval: function(aStartDate, aEndDate) {</span>
<a href="#l43.17"></a><span id="l43.17">         if (!aStartDate &amp;&amp; aEndDate) {</span>
<a href="#l43.18"></a><span id="l43.18">             return this.formatTime(aEndDate);</span>
<a href="#l43.19"></a><span id="l43.19">         }</span>
<a href="#l43.20"></a><span id="l43.20">         if (!aEndDate &amp;&amp; aStartDate) {</span>
<a href="#l43.21"></a><span id="l43.21">             return this.formatTime(aStartDate);</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineat">@@ -166,19 +166,19 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24">     formatDayWithOrdinal: function(aDay) {</span>
<a href="#l43.25"></a><span id="l43.25">         let ordinalSymbols = this.mDateStringBundle.GetStringFromName(&quot;dayOrdinalSymbol&quot;).split(&quot;,&quot;);</span>
<a href="#l43.26"></a><span id="l43.26">         let dayOrdinalSymbol = ordinalSymbols[aDay - 1] || ordinalSymbols[0];</span>
<a href="#l43.27"></a><span id="l43.27">         return aDay + dayOrdinalSymbol;</span>
<a href="#l43.28"></a><span id="l43.28">     },</span>
<a href="#l43.29"></a><span id="l43.29"> </span>
<a href="#l43.30"></a><span id="l43.30">     _getItemDates: function(aItem) {</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-        let start = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">-        let end = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+        let start = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+        let end = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+        let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l43.37"></a><span id="l43.37">         // Check for tasks without start and/or due date</span>
<a href="#l43.38"></a><span id="l43.38">         if (start) {</span>
<a href="#l43.39"></a><span id="l43.39">             start = start.getInTimezone(kDefaultTimezone);</span>
<a href="#l43.40"></a><span id="l43.40">         }</span>
<a href="#l43.41"></a><span id="l43.41">         if (end) {</span>
<a href="#l43.42"></a><span id="l43.42">             end = end.getInTimezone(kDefaultTimezone);</span>
<a href="#l43.43"></a><span id="l43.43">         }</span>
<a href="#l43.44"></a><span id="l43.44">         // EndDate is exclusive. For all-day events, we ened to substract one day,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/src/calDeletedItems.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/src/calDeletedItems.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -46,17 +46,17 @@ calDeletedItems.prototype = {</span>
<a href="#l44.4"></a><span id="l44.4"> </span>
<a href="#l44.5"></a><span id="l44.5">     // To make the tests more failsafe, we have an internal notifier function.</span>
<a href="#l44.6"></a><span id="l44.6">     // As the deleted items store is just meant to be a hint, this should not</span>
<a href="#l44.7"></a><span id="l44.7">     // be used in real code.</span>
<a href="#l44.8"></a><span id="l44.8">     completedNotifier: null,</span>
<a href="#l44.9"></a><span id="l44.9"> </span>
<a href="#l44.10"></a><span id="l44.10">     flush: function() {</span>
<a href="#l44.11"></a><span id="l44.11">         this.ensureStatements();</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-        this.stmtFlush.params.stale_time = cal.now().nativeTime - this.STALE_TIME;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+        this.stmtFlush.params.stale_time = cal.dtz.now().nativeTime - this.STALE_TIME;</span>
<a href="#l44.14"></a><span id="l44.14">         this.stmtFlush.executeAsync(this.completedNotifier);</span>
<a href="#l44.15"></a><span id="l44.15">     },</span>
<a href="#l44.16"></a><span id="l44.16"> </span>
<a href="#l44.17"></a><span id="l44.17">     getDeletedDate: function(aId, aCalId) {</span>
<a href="#l44.18"></a><span id="l44.18">         this.ensureStatements();</span>
<a href="#l44.19"></a><span id="l44.19">         let stmt;</span>
<a href="#l44.20"></a><span id="l44.20">         if (aCalId) {</span>
<a href="#l44.21"></a><span id="l44.21">             stmt = this.stmtGetWithCal;</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineat">@@ -65,31 +65,31 @@ calDeletedItems.prototype = {</span>
<a href="#l44.23"></a><span id="l44.23">             stmt = this.stmtGet;</span>
<a href="#l44.24"></a><span id="l44.24">         }</span>
<a href="#l44.25"></a><span id="l44.25"> </span>
<a href="#l44.26"></a><span id="l44.26">         stmt.params.id = aId;</span>
<a href="#l44.27"></a><span id="l44.27">         try {</span>
<a href="#l44.28"></a><span id="l44.28">             if (stmt.executeStep()) {</span>
<a href="#l44.29"></a><span id="l44.29">                 let date = cal.createDateTime();</span>
<a href="#l44.30"></a><span id="l44.30">                 date.nativeTime = stmt.row.time_deleted;</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-                return date.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+                return date.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l44.33"></a><span id="l44.33">             }</span>
<a href="#l44.34"></a><span id="l44.34">         } catch (e) {</span>
<a href="#l44.35"></a><span id="l44.35">             cal.ERROR(e);</span>
<a href="#l44.36"></a><span id="l44.36">         } finally {</span>
<a href="#l44.37"></a><span id="l44.37">             stmt.reset();</span>
<a href="#l44.38"></a><span id="l44.38">         }</span>
<a href="#l44.39"></a><span id="l44.39">         return null;</span>
<a href="#l44.40"></a><span id="l44.40">     },</span>
<a href="#l44.41"></a><span id="l44.41"> </span>
<a href="#l44.42"></a><span id="l44.42">     markDeleted: function(aItem) {</span>
<a href="#l44.43"></a><span id="l44.43">         this.ensureStatements();</span>
<a href="#l44.44"></a><span id="l44.44">         this.stmtMarkDelete.params.calId = aItem.calendar.id;</span>
<a href="#l44.45"></a><span id="l44.45">         this.stmtMarkDelete.params.id = aItem.id;</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineminus">-        this.stmtMarkDelete.params.time = cal.now().nativeTime;</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+        this.stmtMarkDelete.params.time = cal.dtz.now().nativeTime;</span>
<a href="#l44.48"></a><span id="l44.48">         this.stmtMarkDelete.params.rid = (aItem.recurrenceId &amp;&amp; aItem.recurrenceId.nativeTime) || &quot;&quot;;</span>
<a href="#l44.49"></a><span id="l44.49">         this.stmtMarkDelete.executeAsync(this.completedNotifier);</span>
<a href="#l44.50"></a><span id="l44.50">     },</span>
<a href="#l44.51"></a><span id="l44.51"> </span>
<a href="#l44.52"></a><span id="l44.52">     unmarkDeleted: function(aItem) {</span>
<a href="#l44.53"></a><span id="l44.53">         this.ensureStatements();</span>
<a href="#l44.54"></a><span id="l44.54">         this.stmtUnmarkDelete.params.id = aItem.id;</span>
<a href="#l44.55"></a><span id="l44.55">         this.stmtUnmarkDelete.executeAsync(this.completedNotifier);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/src/calFilter.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/src/calFilter.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -391,17 +391,17 @@ calFilter.prototype = {</span>
<a href="#l45.4"></a><span id="l45.4">         if (!props) {</span>
<a href="#l45.5"></a><span id="l45.5">             return false;</span>
<a href="#l45.6"></a><span id="l45.6">         }</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8">         // the today and tomorrow properties are precalculated in the updateFilterDates function</span>
<a href="#l45.9"></a><span id="l45.9">         // for better performance when filtering batches of items.</span>
<a href="#l45.10"></a><span id="l45.10">         let today = this.mToday;</span>
<a href="#l45.11"></a><span id="l45.11">         if (!today) {</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-            today = cal.now();</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+            today = cal.dtz.now();</span>
<a href="#l45.14"></a><span id="l45.14">             today.isDate = true;</span>
<a href="#l45.15"></a><span id="l45.15">         }</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17">         let tomorrow = this.mTomorrow;</span>
<a href="#l45.18"></a><span id="l45.18">         if (!tomorrow) {</span>
<a href="#l45.19"></a><span id="l45.19">             tomorrow = today.clone();</span>
<a href="#l45.20"></a><span id="l45.20">             tomorrow.day++;</span>
<a href="#l45.21"></a><span id="l45.21">         }</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -436,17 +436,17 @@ calFilter.prototype = {</span>
<a href="#l45.23"></a><span id="l45.23">                       !(completed &amp;&amp; current)) &amp;&amp;</span>
<a href="#l45.24"></a><span id="l45.24">                      ((props.status &amp; props.FILTER_STATUS_COMPLETED_BEFORE) ||</span>
<a href="#l45.25"></a><span id="l45.25">                       !(completed &amp;&amp; !current));</span>
<a href="#l45.26"></a><span id="l45.26">         }</span>
<a href="#l45.27"></a><span id="l45.27"> </span>
<a href="#l45.28"></a><span id="l45.28">         // test the due property. Only applies to tasks.</span>
<a href="#l45.29"></a><span id="l45.29">         if (result &amp;&amp; props.due != null &amp;&amp; cal.isToDo(aItem)) {</span>
<a href="#l45.30"></a><span id="l45.30">             let due = aItem.dueDate;</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-            let now = cal.now();</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+            let now = cal.dtz.now();</span>
<a href="#l45.33"></a><span id="l45.33"> </span>
<a href="#l45.34"></a><span id="l45.34">             result = ((props.due &amp; props.FILTER_DUE_PAST) ||</span>
<a href="#l45.35"></a><span id="l45.35">                       !(due &amp;&amp; (due.compare(now) &lt; 0))) &amp;&amp;</span>
<a href="#l45.36"></a><span id="l45.36">                      ((props.due &amp; props.FILTER_DUE_TODAY) ||</span>
<a href="#l45.37"></a><span id="l45.37">                       !(due &amp;&amp; (due.compare(now) &gt;= 0) &amp;&amp; (due.compare(tomorrow) &lt; 0))) &amp;&amp;</span>
<a href="#l45.38"></a><span id="l45.38">                      ((props.due &amp; props.FILTER_DUE_FUTURE) ||</span>
<a href="#l45.39"></a><span id="l45.39">                       !(due &amp;&amp; (due.compare(tomorrow) &gt;= 0))) &amp;&amp;</span>
<a href="#l45.40"></a><span id="l45.40">                      ((props.due &amp; props.FILTER_DUE_NONE) ||</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineat">@@ -471,18 +471,18 @@ calFilter.prototype = {</span>
<a href="#l45.42"></a><span id="l45.42">      * @param start               If true, the function will return the date value for the</span>
<a href="#l45.43"></a><span id="l45.43">      *                            start of the relative date range, otherwise it will return the</span>
<a href="#l45.44"></a><span id="l45.44">      *                            date value for the end of the date range.</span>
<a href="#l45.45"></a><span id="l45.45">      * @return                    The calculated date for the property.</span>
<a href="#l45.46"></a><span id="l45.46">      */</span>
<a href="#l45.47"></a><span id="l45.47">     getDateForProperty: function(prop, start) {</span>
<a href="#l45.48"></a><span id="l45.48">         let props = this.mFilterProperties || new calFilterProperties();</span>
<a href="#l45.49"></a><span id="l45.49">         let result = null;</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineminus">-        let selectedDate = this.mSelectedDate || currentView().selectedDay || cal.now();</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineminus">-        let nowDate = cal.now();</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineplus">+        let selectedDate = this.mSelectedDate || currentView().selectedDay || cal.dtz.now();</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineplus">+        let nowDate = cal.dtz.now();</span>
<a href="#l45.54"></a><span id="l45.54"> </span>
<a href="#l45.55"></a><span id="l45.55">         if (typeof prop == &quot;string&quot;) {</span>
<a href="#l45.56"></a><span id="l45.56">             let duration = cal.createDuration(prop);</span>
<a href="#l45.57"></a><span id="l45.57">             if (duration) {</span>
<a href="#l45.58"></a><span id="l45.58">                 result = nowDate;</span>
<a href="#l45.59"></a><span id="l45.59">                 result.addDuration(duration);</span>
<a href="#l45.60"></a><span id="l45.60">             }</span>
<a href="#l45.61"></a><span id="l45.61">         } else {</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineat">@@ -495,18 +495,18 @@ calFilter.prototype = {</span>
<a href="#l45.63"></a><span id="l45.63">                                    : currentView().endDay.clone();</span>
<a href="#l45.64"></a><span id="l45.64">                     break;</span>
<a href="#l45.65"></a><span id="l45.65">                 case props.FILTER_DATE_SELECTED:</span>
<a href="#l45.66"></a><span id="l45.66">                     result = selectedDate.clone();</span>
<a href="#l45.67"></a><span id="l45.67">                     result.isDate = true;</span>
<a href="#l45.68"></a><span id="l45.68">                     break;</span>
<a href="#l45.69"></a><span id="l45.69">                 case props.FILTER_DATE_SELECTED_OR_NOW: {</span>
<a href="#l45.70"></a><span id="l45.70">                     result = selectedDate.clone();</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineminus">-                    let resultJSDate = cal.dateTimeToJsDate(result);</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineminus">-                    let nowJSDate = cal.dateTimeToJsDate(nowDate);</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+                    let resultJSDate = cal.dtz.dateTimeToJsDate(result);</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+                    let nowJSDate = cal.dtz.dateTimeToJsDate(nowDate);</span>
<a href="#l45.75"></a><span id="l45.75">                     if ((start &amp;&amp; resultJSDate &gt; nowJSDate) ||</span>
<a href="#l45.76"></a><span id="l45.76">                         (!start &amp;&amp; resultJSDate &lt; nowJSDate)) {</span>
<a href="#l45.77"></a><span id="l45.77">                         result = nowDate;</span>
<a href="#l45.78"></a><span id="l45.78">                     }</span>
<a href="#l45.79"></a><span id="l45.79">                     result.isDate = true;</span>
<a href="#l45.80"></a><span id="l45.80">                     break;</span>
<a href="#l45.81"></a><span id="l45.81">                 }</span>
<a href="#l45.82"></a><span id="l45.82">                 case props.FILTER_DATE_NOW:</span>
<a href="#l45.83"></a><span id="l45.83" class="difflineat">@@ -701,17 +701,17 @@ calFilter.prototype = {</span>
<a href="#l45.84"></a><span id="l45.84">      */</span>
<a href="#l45.85"></a><span id="l45.85">     updateFilterDates: function() {</span>
<a href="#l45.86"></a><span id="l45.86">         let [startDate, endDate] = this.getDatesForFilter();</span>
<a href="#l45.87"></a><span id="l45.87">         this.mStartDate = startDate;</span>
<a href="#l45.88"></a><span id="l45.88">         this.mEndDate = endDate;</span>
<a href="#l45.89"></a><span id="l45.89"> </span>
<a href="#l45.90"></a><span id="l45.90">         // the today and tomorrow properties are precalculated here</span>
<a href="#l45.91"></a><span id="l45.91">         // for better performance when filtering batches of items.</span>
<a href="#l45.92"></a><span id="l45.92" class="difflineminus">-        this.mToday = cal.now();</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineplus">+        this.mToday = cal.dtz.now();</span>
<a href="#l45.94"></a><span id="l45.94">         this.mToday.isDate = true;</span>
<a href="#l45.95"></a><span id="l45.95"> </span>
<a href="#l45.96"></a><span id="l45.96">         this.mTomorrow = this.mToday.clone();</span>
<a href="#l45.97"></a><span id="l45.97">         this.mTomorrow.day++;</span>
<a href="#l45.98"></a><span id="l45.98"> </span>
<a href="#l45.99"></a><span id="l45.99">         return [startDate, endDate];</span>
<a href="#l45.100"></a><span id="l45.100">     },</span>
<a href="#l45.101"></a><span id="l45.101"> </span>
<a href="#l45.102"></a><span id="l45.102" class="difflineat">@@ -761,17 +761,17 @@ calFilter.prototype = {</span>
<a href="#l45.103"></a><span id="l45.103">      *                            or null if no match is found.</span>
<a href="#l45.104"></a><span id="l45.104">      */</span>
<a href="#l45.105"></a><span id="l45.105">     getNextOccurrence: function(aItem) {</span>
<a href="#l45.106"></a><span id="l45.106">         if (!aItem.recurrenceInfo) {</span>
<a href="#l45.107"></a><span id="l45.107">             return this.isItemInFilters(aItem) ? aItem : null;</span>
<a href="#l45.108"></a><span id="l45.108">         }</span>
<a href="#l45.109"></a><span id="l45.109"> </span>
<a href="#l45.110"></a><span id="l45.110">         let count = 0;</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineminus">-        let start = cal.now();</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineplus">+        let start = cal.dtz.now();</span>
<a href="#l45.113"></a><span id="l45.113"> </span>
<a href="#l45.114"></a><span id="l45.114">         // If the base item matches the filter, we need to check each future occurrence.</span>
<a href="#l45.115"></a><span id="l45.115">         // Otherwise, we only need to check the exceptions.</span>
<a href="#l45.116"></a><span id="l45.116">         if (this.isItemInFilters(aItem)) {</span>
<a href="#l45.117"></a><span id="l45.117">             while (count++ &lt; this.mMaxIterations) {</span>
<a href="#l45.118"></a><span id="l45.118">                 let next = aItem.recurrenceInfo.getNextOccurrence(start);</span>
<a href="#l45.119"></a><span id="l45.119">                 if (!next) {</span>
<a href="#l45.120"></a><span id="l45.120">                     // there are no more occurrences</span>
<a href="#l45.121"></a><span id="l45.121" class="difflineat">@@ -787,17 +787,17 @@ calFilter.prototype = {</span>
<a href="#l45.122"></a><span id="l45.122">             cal.WARN(&quot;[calFilter] getNextOccurrence: reached maximum iterations for &quot; + aItem.title);</span>
<a href="#l45.123"></a><span id="l45.123">             return null;</span>
<a href="#l45.124"></a><span id="l45.124">         } else {</span>
<a href="#l45.125"></a><span id="l45.125">             // the parent item doesn't match the filter, we can return the first future exception</span>
<a href="#l45.126"></a><span id="l45.126">             // that matches the filter</span>
<a href="#l45.127"></a><span id="l45.127">             let exMatch = null;</span>
<a href="#l45.128"></a><span id="l45.128">             aItem.recurrenceInfo.getExceptionIds({}).forEach(function(rID) {</span>
<a href="#l45.129"></a><span id="l45.129">                 let ex = aItem.recurrenceInfo.getExceptionFor(rID);</span>
<a href="#l45.130"></a><span id="l45.130" class="difflineminus">-                if (ex &amp;&amp; cal.now().compare(ex.startDate || ex.entryDate) &lt; 0 &amp;&amp;</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineplus">+                if (ex &amp;&amp; cal.dtz.now().compare(ex.startDate || ex.entryDate) &lt; 0 &amp;&amp;</span>
<a href="#l45.132"></a><span id="l45.132">                     this.isItemInFilters(ex)) {</span>
<a href="#l45.133"></a><span id="l45.133">                     exMatch = ex;</span>
<a href="#l45.134"></a><span id="l45.134">                 }</span>
<a href="#l45.135"></a><span id="l45.135">             }, this);</span>
<a href="#l45.136"></a><span id="l45.136">             return exMatch;</span>
<a href="#l45.137"></a><span id="l45.137">         }</span>
<a href="#l45.138"></a><span id="l45.138">     },</span>
<a href="#l45.139"></a><span id="l45.139"> </span>
<a href="#l45.140"></a><span id="l45.140" class="difflineat">@@ -820,17 +820,17 @@ calFilter.prototype = {</span>
<a href="#l45.141"></a><span id="l45.141">         if (!aItem.recurrenceInfo || (!props.occurrences &amp;&amp; !this.mEndDate) ||</span>
<a href="#l45.142"></a><span id="l45.142">             props.occurrences == props.FILTER_OCCURRENCES_NONE) {</span>
<a href="#l45.143"></a><span id="l45.143">             // either this isn't a repeating item, the occurrence filter specifies that</span>
<a href="#l45.144"></a><span id="l45.144">             // we don't want occurrences, or we have a default occurrence filter with an</span>
<a href="#l45.145"></a><span id="l45.145">             // unbound date range, so we return just the unexpanded item.</span>
<a href="#l45.146"></a><span id="l45.146">             occs = [aItem];</span>
<a href="#l45.147"></a><span id="l45.147">         } else {</span>
<a href="#l45.148"></a><span id="l45.148">             occs = aItem.getOccurrencesBetween(this.mStartDate || cal.createDateTime(),</span>
<a href="#l45.149"></a><span id="l45.149" class="difflineminus">-                                               this.mEndDate || cal.now(), {});</span>
<a href="#l45.150"></a><span id="l45.150" class="difflineplus">+                                               this.mEndDate || cal.dtz.now(), {});</span>
<a href="#l45.151"></a><span id="l45.151">             if ((props.occurrences == props.FILTER_OCCURRENCES_PAST_AND_NEXT) &amp;&amp;</span>
<a href="#l45.152"></a><span id="l45.152">                 !this.mEndDate) {</span>
<a href="#l45.153"></a><span id="l45.153">                 // we have an unbound date range and the occurrence filter specifies</span>
<a href="#l45.154"></a><span id="l45.154">                 // that we also want the next matching occurrence if available.</span>
<a href="#l45.155"></a><span id="l45.155">                 let next = this.getNextOccurrence(aItem);</span>
<a href="#l45.156"></a><span id="l45.156">                 if (next) {</span>
<a href="#l45.157"></a><span id="l45.157">                     occs.push(next);</span>
<a href="#l45.158"></a><span id="l45.158">                 }</span>
<a href="#l45.159"></a><span id="l45.159" class="difflineat">@@ -899,14 +899,14 @@ calFilter.prototype = {</span>
<a href="#l45.160"></a><span id="l45.160">         let endDate = this.endDate;</span>
<a href="#l45.161"></a><span id="l45.161"> </span>
<a href="#l45.162"></a><span id="l45.162">         // we only want occurrences returned from calICalendar.getItems() with a default</span>
<a href="#l45.163"></a><span id="l45.163">         // occurence filter property and a bound date range, otherwise the local listener</span>
<a href="#l45.164"></a><span id="l45.164">         // will handle occurrence expansion.</span>
<a href="#l45.165"></a><span id="l45.165">         if (!props.occurrences &amp;&amp; this.endDate) {</span>
<a href="#l45.166"></a><span id="l45.166">             filter |= aCalendar.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l45.167"></a><span id="l45.167">             startDate = startDate || cal.createDateTime();</span>
<a href="#l45.168"></a><span id="l45.168" class="difflineminus">-            endDate = endDate || cal.now();</span>
<a href="#l45.169"></a><span id="l45.169" class="difflineplus">+            endDate = endDate || cal.dtz.now();</span>
<a href="#l45.170"></a><span id="l45.170">         }</span>
<a href="#l45.171"></a><span id="l45.171"> </span>
<a href="#l45.172"></a><span id="l45.172">         return aCalendar.getItems(filter, 0, startDate, endDate, listener);</span>
<a href="#l45.173"></a><span id="l45.173">     }</span>
<a href="#l45.174"></a><span id="l45.174"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -42,17 +42,17 @@ calItemBase.prototype = {</span>
<a href="#l46.4"></a><span id="l46.4">     /**</span>
<a href="#l46.5"></a><span id="l46.5">      * Initialize the base item's attributes. Can be called from inheriting</span>
<a href="#l46.6"></a><span id="l46.6">      * objects in their constructor.</span>
<a href="#l46.7"></a><span id="l46.7">      */</span>
<a href="#l46.8"></a><span id="l46.8">     initItemBase: function() {</span>
<a href="#l46.9"></a><span id="l46.9">         this.wrappedJSObject = this;</span>
<a href="#l46.10"></a><span id="l46.10">         this.mProperties = new cal.calPropertyBag();</span>
<a href="#l46.11"></a><span id="l46.11">         this.mPropertyParams = {};</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-        this.mProperties.setProperty(&quot;CREATED&quot;, cal.jsDateToDateTime(new Date()));</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+        this.mProperties.setProperty(&quot;CREATED&quot;, cal.dtz.jsDateToDateTime(new Date()));</span>
<a href="#l46.14"></a><span id="l46.14">     },</span>
<a href="#l46.15"></a><span id="l46.15"> </span>
<a href="#l46.16"></a><span id="l46.16">     /**</span>
<a href="#l46.17"></a><span id="l46.17">      * @see nsISupports</span>
<a href="#l46.18"></a><span id="l46.18">      */</span>
<a href="#l46.19"></a><span id="l46.19">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIItemBase]),</span>
<a href="#l46.20"></a><span id="l46.20"> </span>
<a href="#l46.21"></a><span id="l46.21">     /**</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineat">@@ -78,17 +78,17 @@ calItemBase.prototype = {</span>
<a href="#l46.23"></a><span id="l46.23">     // readonly attribute AUTF8String hashId;</span>
<a href="#l46.24"></a><span id="l46.24">     get hashId() {</span>
<a href="#l46.25"></a><span id="l46.25">         if (this.mHashId === null) {</span>
<a href="#l46.26"></a><span id="l46.26">             let rid = this.recurrenceId;</span>
<a href="#l46.27"></a><span id="l46.27">             let calendar = this.calendar;</span>
<a href="#l46.28"></a><span id="l46.28">             // some unused delim character:</span>
<a href="#l46.29"></a><span id="l46.29">             this.mHashId = [</span>
<a href="#l46.30"></a><span id="l46.30">                 encodeURIComponent(this.id),</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-                rid ? rid.getInTimezone(cal.UTC()).icalString : &quot;&quot;,</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+                rid ? rid.getInTimezone(cal.dtz.UTC).icalString : &quot;&quot;,</span>
<a href="#l46.33"></a><span id="l46.33">                 calendar ? encodeURIComponent(calendar.id) : &quot;&quot;</span>
<a href="#l46.34"></a><span id="l46.34">             ].join(&quot;#&quot;);</span>
<a href="#l46.35"></a><span id="l46.35">         }</span>
<a href="#l46.36"></a><span id="l46.36">         return this.mHashId;</span>
<a href="#l46.37"></a><span id="l46.37">     },</span>
<a href="#l46.38"></a><span id="l46.38"> </span>
<a href="#l46.39"></a><span id="l46.39">     // attribute AUTF8String id;</span>
<a href="#l46.40"></a><span id="l46.40">     get id() {</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineat">@@ -173,17 +173,17 @@ calItemBase.prototype = {</span>
<a href="#l46.42"></a><span id="l46.42">     },</span>
<a href="#l46.43"></a><span id="l46.43"> </span>
<a href="#l46.44"></a><span id="l46.44">     /**</span>
<a href="#l46.45"></a><span id="l46.45">      * Makes sure the item is not dirty. If the item is dirty, properties like</span>
<a href="#l46.46"></a><span id="l46.46">      * LAST-MODIFIED and DTSTAMP are set to now.</span>
<a href="#l46.47"></a><span id="l46.47">      */</span>
<a href="#l46.48"></a><span id="l46.48">     ensureNotDirty: function() {</span>
<a href="#l46.49"></a><span id="l46.49">         if (this.mDirty) {</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineminus">-            let now = cal.jsDateToDateTime(new Date());</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineplus">+            let now = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l46.52"></a><span id="l46.52">             this.setProperty(&quot;LAST-MODIFIED&quot;, now);</span>
<a href="#l46.53"></a><span id="l46.53">             this.setProperty(&quot;DTSTAMP&quot;, now);</span>
<a href="#l46.54"></a><span id="l46.54">             this.mDirty = false;</span>
<a href="#l46.55"></a><span id="l46.55">         }</span>
<a href="#l46.56"></a><span id="l46.56">     },</span>
<a href="#l46.57"></a><span id="l46.57"> </span>
<a href="#l46.58"></a><span id="l46.58">     /**</span>
<a href="#l46.59"></a><span id="l46.59">      * Makes all properties of the base item immutable. Can be called by</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineat">@@ -322,17 +322,17 @@ calItemBase.prototype = {</span>
<a href="#l46.61"></a><span id="l46.61"> </span>
<a href="#l46.62"></a><span id="l46.62">     // attribute calIDateTime alarmLastAck;</span>
<a href="#l46.63"></a><span id="l46.63">     get alarmLastAck() {</span>
<a href="#l46.64"></a><span id="l46.64">         return this.mAlarmLastAck;</span>
<a href="#l46.65"></a><span id="l46.65">     },</span>
<a href="#l46.66"></a><span id="l46.66">     set alarmLastAck(aValue) {</span>
<a href="#l46.67"></a><span id="l46.67">         this.modify();</span>
<a href="#l46.68"></a><span id="l46.68">         if (aValue &amp;&amp; !aValue.timezone.isUTC) {</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineminus">-            aValue = aValue.getInTimezone(cal.UTC());</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineplus">+            aValue = aValue.getInTimezone(cal.dtz.UTC);</span>
<a href="#l46.71"></a><span id="l46.71">         }</span>
<a href="#l46.72"></a><span id="l46.72">         return (this.mAlarmLastAck = aValue);</span>
<a href="#l46.73"></a><span id="l46.73">     },</span>
<a href="#l46.74"></a><span id="l46.74"> </span>
<a href="#l46.75"></a><span id="l46.75">     // readonly attribute calIDateTime lastModifiedTime;</span>
<a href="#l46.76"></a><span id="l46.76">     get lastModifiedTime() {</span>
<a href="#l46.77"></a><span id="l46.77">         this.ensureNotDirty();</span>
<a href="#l46.78"></a><span id="l46.78">         return this.getProperty(&quot;LAST-MODIFIED&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -6,17 +6,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l47.4"></a><span id="l47.4"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l47.5"></a><span id="l47.5"> </span>
<a href="#l47.6"></a><span id="l47.6"> function getRidKey(date) {</span>
<a href="#l47.7"></a><span id="l47.7">     if (!date) {</span>
<a href="#l47.8"></a><span id="l47.8">         return null;</span>
<a href="#l47.9"></a><span id="l47.9">     }</span>
<a href="#l47.10"></a><span id="l47.10">     let timezone = date.timezone;</span>
<a href="#l47.11"></a><span id="l47.11">     if (!timezone.isUTC &amp;&amp; !timezone.isFloating) {</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-        date = date.getInTimezone(cal.UTC());</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+        date = date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l47.14"></a><span id="l47.14">     }</span>
<a href="#l47.15"></a><span id="l47.15">     return date.icalString;</span>
<a href="#l47.16"></a><span id="l47.16"> }</span>
<a href="#l47.17"></a><span id="l47.17"> </span>
<a href="#l47.18"></a><span id="l47.18"> function calRecurrenceInfo() {</span>
<a href="#l47.19"></a><span id="l47.19">     this.mRecurrenceItems = [];</span>
<a href="#l47.20"></a><span id="l47.20">     this.mExceptionMap = {};</span>
<a href="#l47.21"></a><span id="l47.21"> </span>
<a href="#l47.22"></a><span id="l47.22" class="difflineat">@@ -423,18 +423,18 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l47.23"></a><span id="l47.23">         this.ensureBaseItem();</span>
<a href="#l47.24"></a><span id="l47.24">         this.ensureSortedRecurrenceRules();</span>
<a href="#l47.25"></a><span id="l47.25"> </span>
<a href="#l47.26"></a><span id="l47.26">         function ridDateSortComptor(a, b) {</span>
<a href="#l47.27"></a><span id="l47.27">             return a.rstart.compare(b.rstart);</span>
<a href="#l47.28"></a><span id="l47.28">         }</span>
<a href="#l47.29"></a><span id="l47.29"> </span>
<a href="#l47.30"></a><span id="l47.30">         // workaround for UTC- timezones</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-        let rangeStart = cal.ensureDateTime(aRangeStart);</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-        let rangeEnd = cal.ensureDateTime(aRangeEnd);</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineplus">+        let rangeStart = cal.dtz.ensureDateTime(aRangeStart);</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineplus">+        let rangeEnd = cal.dtz.ensureDateTime(aRangeEnd);</span>
<a href="#l47.35"></a><span id="l47.35"> </span>
<a href="#l47.36"></a><span id="l47.36">         // If aRangeStart falls in the middle of an occurrence, libical will</span>
<a href="#l47.37"></a><span id="l47.37">         // not return that occurrence when we go and ask for an</span>
<a href="#l47.38"></a><span id="l47.38">         // icalrecur_iterator_new.  This actually seems fairly rational, so</span>
<a href="#l47.39"></a><span id="l47.39">         // instead of hacking libical, I'm going to move aRangeStart back far</span>
<a href="#l47.40"></a><span id="l47.40">         // enough to make sure we get the occurrences we might miss.</span>
<a href="#l47.41"></a><span id="l47.41">         let searchStart = rangeStart.clone();</span>
<a href="#l47.42"></a><span id="l47.42">         let baseDuration = this.mBaseItem.duration;</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineat">@@ -739,17 +739,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l47.44"></a><span id="l47.44">         cal.ASSERT(aNewStartTime, &quot;invalid arg!&quot;, true);</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46">         // no need to check for changes if there's no previous starttime.</span>
<a href="#l47.47"></a><span id="l47.47">         if (!aOldStartTime) {</span>
<a href="#l47.48"></a><span id="l47.48">             return;</span>
<a href="#l47.49"></a><span id="l47.49">         }</span>
<a href="#l47.50"></a><span id="l47.50"> </span>
<a href="#l47.51"></a><span id="l47.51">         // convert both dates to UTC since subtractDate is not timezone aware.</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineminus">-        let timeDiff = aNewStartTime.getInTimezone(cal.UTC()).subtractDate(aOldStartTime.getInTimezone(cal.UTC()));</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineplus">+        let timeDiff = aNewStartTime.getInTimezone(cal.dtz.UTC).subtractDate(aOldStartTime.getInTimezone(cal.dtz.UTC));</span>
<a href="#l47.54"></a><span id="l47.54"> </span>
<a href="#l47.55"></a><span id="l47.55">         let rdates = {};</span>
<a href="#l47.56"></a><span id="l47.56"> </span>
<a href="#l47.57"></a><span id="l47.57">         // take RDATE's and EXDATE's into account.</span>
<a href="#l47.58"></a><span id="l47.58">         const kCalIRecurrenceDate = Components.interfaces.calIRecurrenceDate;</span>
<a href="#l47.59"></a><span id="l47.59">         let ritems = this.getRecurrenceItems({});</span>
<a href="#l47.60"></a><span id="l47.60">         for (let ritem of ritems) {</span>
<a href="#l47.61"></a><span id="l47.61">             let rDateInstance = cal.wrapInstance(ritem, kCalIRecurrenceDate);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -439,17 +439,17 @@ function guessSystemTimezone() {</span>
<a href="#l48.4"></a><span id="l48.4">             (beforeSpringShiftJSDate.getTimezoneOffset() &gt;</span>
<a href="#l48.5"></a><span id="l48.5">              afterSpringShiftJSDate.getTimezoneOffset())) {</span>
<a href="#l48.6"></a><span id="l48.6">             return 1;</span>
<a href="#l48.7"></a><span id="l48.7">         }</span>
<a href="#l48.8"></a><span id="l48.8">         // no match</span>
<a href="#l48.9"></a><span id="l48.9">         return 0;</span>
<a href="#l48.10"></a><span id="l48.10">     }</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-    const todayUTC = cal.jsDateToDateTime(new Date());</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+    const todayUTC = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l48.14"></a><span id="l48.14">     const oneYrUTC = todayUTC.clone(); oneYrUTC.year += 1;</span>
<a href="#l48.15"></a><span id="l48.15">     const periodStartCalDate = cal.createDateTime();</span>
<a href="#l48.16"></a><span id="l48.16">     const periodUntilCalDate = cal.createDateTime(); // until timezone is UTC</span>
<a href="#l48.17"></a><span id="l48.17">     const periodCalRule = cal.createRecurrenceRule();</span>
<a href="#l48.18"></a><span id="l48.18">     const untilRegex = /UNTIL=(\d{8}T\d{6}Z)/;</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20">     function findCurrentTimePeriod(timezone, subComp, standardOrDaylight,</span>
<a href="#l48.21"></a><span id="l48.21">                                    isForNextTransitionDate) {</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineat">@@ -480,26 +480,26 @@ function guessSystemTimezone() {</span>
<a href="#l48.23"></a><span id="l48.23">             } // else no daylight rule</span>
<a href="#l48.24"></a><span id="l48.24"> </span>
<a href="#l48.25"></a><span id="l48.25">             // found period that covers today.</span>
<a href="#l48.26"></a><span id="l48.26">             if (!isForNextTransitionDate) {</span>
<a href="#l48.27"></a><span id="l48.27">                 return period;</span>
<a href="#l48.28"></a><span id="l48.28">             } else if (todayUTC.nativeTime &lt; periodStartCalDate.nativeTime) {</span>
<a href="#l48.29"></a><span id="l48.29">                 // already know periodStartCalDate &lt; oneYr from now,</span>
<a href="#l48.30"></a><span id="l48.30">                 // and transitions are at most once per year, so it is next.</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineminus">-                return cal.dateTimeToJsDate(periodStartCalDate);</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+                return cal.dtz.dateTimeToJsDate(periodStartCalDate);</span>
<a href="#l48.33"></a><span id="l48.33">             } else if (rrule) {</span>
<a href="#l48.34"></a><span id="l48.34">                 // find next occurrence after today</span>
<a href="#l48.35"></a><span id="l48.35">                 periodCalRule.icalProperty = rrule;</span>
<a href="#l48.36"></a><span id="l48.36">                 let nextTransitionDate =</span>
<a href="#l48.37"></a><span id="l48.37">                     periodCalRule.getNextOccurrence(periodStartCalDate,</span>
<a href="#l48.38"></a><span id="l48.38">                                                     todayUTC);</span>
<a href="#l48.39"></a><span id="l48.39">                 // make sure rule doesn't end before next transition date.</span>
<a href="#l48.40"></a><span id="l48.40">                 if (nextTransitionDate) {</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-                    return cal.dateTimeToJsDate(nextTransitionDate);</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+                    return cal.dtz.dateTimeToJsDate(nextTransitionDate);</span>
<a href="#l48.43"></a><span id="l48.43">                 }</span>
<a href="#l48.44"></a><span id="l48.44">             }</span>
<a href="#l48.45"></a><span id="l48.45">         }</span>
<a href="#l48.46"></a><span id="l48.46">         // no such period found</span>
<a href="#l48.47"></a><span id="l48.47">         return null;</span>
<a href="#l48.48"></a><span id="l48.48">     }</span>
<a href="#l48.49"></a><span id="l48.49"> </span>
<a href="#l48.50"></a><span id="l48.50">     function environmentVariableValue(varName) {</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineat">@@ -561,17 +561,17 @@ function guessSystemTimezone() {</span>
<a href="#l48.52"></a><span id="l48.52">             Components.utils.reportError(filepath + &quot;: &quot; + ex);</span>
<a href="#l48.53"></a><span id="l48.53">             return &quot;&quot;;</span>
<a href="#l48.54"></a><span id="l48.54">         }</span>
<a href="#l48.55"></a><span id="l48.55">     }</span>
<a href="#l48.56"></a><span id="l48.56"> </span>
<a href="#l48.57"></a><span id="l48.57">     function weekday(icsDate, timezone) {</span>
<a href="#l48.58"></a><span id="l48.58">         let calDate = cal.createDateTime(icsDate);</span>
<a href="#l48.59"></a><span id="l48.59">         calDate.timezone = timezone;</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineminus">-        return cal.dateTimeToJsDate(calDate).toLocaleString(undefined, { weekday: &quot;short&quot; });</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+        return cal.dtz.dateTimeToJsDate(calDate).toLocaleString(undefined, { weekday: &quot;short&quot; });</span>
<a href="#l48.62"></a><span id="l48.62">     }</span>
<a href="#l48.63"></a><span id="l48.63"> </span>
<a href="#l48.64"></a><span id="l48.64">     // Try to find a tz that matches OS/JSDate timezone.  If no name match,</span>
<a href="#l48.65"></a><span id="l48.65">     // will use first of probable timezone(s) with highest score.</span>
<a href="#l48.66"></a><span id="l48.66">     let probableTZId = &quot;floating&quot;; // default fallback tz if no tz matches.</span>
<a href="#l48.67"></a><span id="l48.67">     let probableTZScore = 0;</span>
<a href="#l48.68"></a><span id="l48.68">     let probableTZSource = null;</span>
<a href="#l48.69"></a><span id="l48.69"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -73,17 +73,17 @@ calTodo.prototype = {</span>
<a href="#l49.4"></a><span id="l49.4">         return this.completedDate != null ||</span>
<a href="#l49.5"></a><span id="l49.5">                this.percentComplete == 100 ||</span>
<a href="#l49.6"></a><span id="l49.6">                this.status == &quot;COMPLETED&quot;;</span>
<a href="#l49.7"></a><span id="l49.7">     },</span>
<a href="#l49.8"></a><span id="l49.8"> </span>
<a href="#l49.9"></a><span id="l49.9">     set isCompleted(completed) {</span>
<a href="#l49.10"></a><span id="l49.10">         if (completed) {</span>
<a href="#l49.11"></a><span id="l49.11">             if (!this.completedDate) {</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-                this.completedDate = cal.jsDateToDateTime(new Date());</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+                this.completedDate = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l49.14"></a><span id="l49.14">             }</span>
<a href="#l49.15"></a><span id="l49.15">             this.status = &quot;COMPLETED&quot;;</span>
<a href="#l49.16"></a><span id="l49.16">             this.percentComplete = 100;</span>
<a href="#l49.17"></a><span id="l49.17">         } else {</span>
<a href="#l49.18"></a><span id="l49.18">             this.deleteProperty(&quot;COMPLETED&quot;);</span>
<a href="#l49.19"></a><span id="l49.19">             this.deleteProperty(&quot;STATUS&quot;);</span>
<a href="#l49.20"></a><span id="l49.20">             this.deleteProperty(&quot;PERCENT-COMPLETE&quot;);</span>
<a href="#l49.21"></a><span id="l49.21">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -672,17 +672,17 @@ function getContrastingTextColor(bgColor</span>
<a href="#l50.4"></a><span id="l50.4">  * @param rangeStart         (inclusive) range start or null (open range)</span>
<a href="#l50.5"></a><span id="l50.5">  * @param rangeStart         (exclusive) range end or null (open range)</span>
<a href="#l50.6"></a><span id="l50.6">  * @param returnDtstartOrDue returns item's start (or due) date in case</span>
<a href="#l50.7"></a><span id="l50.7">  *                           the item is in the specified Range; null otherwise.</span>
<a href="#l50.8"></a><span id="l50.8">  */</span>
<a href="#l50.9"></a><span id="l50.9"> function checkIfInRange(item, rangeStart, rangeEnd, returnDtstartOrDue) {</span>
<a href="#l50.10"></a><span id="l50.10">     let startDate;</span>
<a href="#l50.11"></a><span id="l50.11">     let endDate;</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-    let queryStart = cal.ensureDateTime(rangeStart);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+    let queryStart = cal.dtz.ensureDateTime(rangeStart);</span>
<a href="#l50.14"></a><span id="l50.14">     if (isEvent(item)) {</span>
<a href="#l50.15"></a><span id="l50.15">         startDate = item.startDate;</span>
<a href="#l50.16"></a><span id="l50.16">         if (!startDate) { // DTSTART mandatory</span>
<a href="#l50.17"></a><span id="l50.17">             // xxx todo: should we assert this case?</span>
<a href="#l50.18"></a><span id="l50.18">             return null;</span>
<a href="#l50.19"></a><span id="l50.19">         }</span>
<a href="#l50.20"></a><span id="l50.20">         endDate = item.endDate || startDate;</span>
<a href="#l50.21"></a><span id="l50.21">     } else {</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -691,28 +691,28 @@ function checkIfInRange(item, rangeStart</span>
<a href="#l50.23"></a><span id="l50.23">         if (!item.entryDate) {</span>
<a href="#l50.24"></a><span id="l50.24">             if (returnDtstartOrDue) { // DTSTART or DUE mandatory</span>
<a href="#l50.25"></a><span id="l50.25">                 return null;</span>
<a href="#l50.26"></a><span id="l50.26">             }</span>
<a href="#l50.27"></a><span id="l50.27">             // 3.6.2. To-do Component</span>
<a href="#l50.28"></a><span id="l50.28">             // A &quot;VTODO&quot; calendar component without the &quot;DTSTART&quot; and &quot;DUE&quot; (or</span>
<a href="#l50.29"></a><span id="l50.29">             // &quot;DURATION&quot;) properties specifies a to-do that will be associated</span>
<a href="#l50.30"></a><span id="l50.30">             // with each successive calendar date, until it is completed.</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-            let completedDate = cal.ensureDateTime(item.completedDate);</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineminus">-            dueDate = cal.ensureDateTime(dueDate);</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+            let completedDate = cal.dtz.ensureDateTime(item.completedDate);</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineplus">+            dueDate = cal.dtz.ensureDateTime(dueDate);</span>
<a href="#l50.35"></a><span id="l50.35">             return !completedDate || !queryStart ||</span>
<a href="#l50.36"></a><span id="l50.36">                    completedDate.compare(queryStart) &gt; 0 ||</span>
<a href="#l50.37"></a><span id="l50.37">                    (dueDate &amp;&amp; dueDate.compare(queryStart) &gt;= 0);</span>
<a href="#l50.38"></a><span id="l50.38">         }</span>
<a href="#l50.39"></a><span id="l50.39">         endDate = dueDate || startDate;</span>
<a href="#l50.40"></a><span id="l50.40">     }</span>
<a href="#l50.41"></a><span id="l50.41"> </span>
<a href="#l50.42"></a><span id="l50.42" class="difflineminus">-    let start = cal.ensureDateTime(startDate);</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineminus">-    let end = cal.ensureDateTime(endDate);</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineminus">-    let queryEnd = cal.ensureDateTime(rangeEnd);</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineplus">+    let start = cal.dtz.ensureDateTime(startDate);</span>
<a href="#l50.46"></a><span id="l50.46" class="difflineplus">+    let end = cal.dtz.ensureDateTime(endDate);</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineplus">+    let queryEnd = cal.dtz.ensureDateTime(rangeEnd);</span>
<a href="#l50.48"></a><span id="l50.48"> </span>
<a href="#l50.49"></a><span id="l50.49">     if (start.compare(end) == 0) {</span>
<a href="#l50.50"></a><span id="l50.50">         if ((!queryStart || start.compare(queryStart) &gt;= 0) &amp;&amp;</span>
<a href="#l50.51"></a><span id="l50.51">             (!queryEnd || start.compare(queryEnd) &lt; 0)) {</span>
<a href="#l50.52"></a><span id="l50.52">             return startDate;</span>
<a href="#l50.53"></a><span id="l50.53">         }</span>
<a href="#l50.54"></a><span id="l50.54">     } else if ((!queryEnd || start.compare(queryEnd) &lt; 0) &amp;&amp;</span>
<a href="#l50.55"></a><span id="l50.55">                (!queryStart || end.compare(queryStart) &gt; 0)) {</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineat">@@ -735,27 +735,27 @@ function getProgressAtom(aTask) {</span>
<a href="#l50.57"></a><span id="l50.57">         return &quot;repeating&quot;;</span>
<a href="#l50.58"></a><span id="l50.58">     }</span>
<a href="#l50.59"></a><span id="l50.59"> </span>
<a href="#l50.60"></a><span id="l50.60">     if (aTask.isCompleted) {</span>
<a href="#l50.61"></a><span id="l50.61">         return &quot;completed&quot;;</span>
<a href="#l50.62"></a><span id="l50.62">     }</span>
<a href="#l50.63"></a><span id="l50.63"> </span>
<a href="#l50.64"></a><span id="l50.64">     if (aTask.dueDate &amp;&amp; aTask.dueDate.isValid) {</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineminus">-        if (cal.dateTimeToJsDate(aTask.dueDate).getTime() &lt; nowdate.getTime()) {</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineplus">+        if (cal.dtz.dateTimeToJsDate(aTask.dueDate).getTime() &lt; nowdate.getTime()) {</span>
<a href="#l50.67"></a><span id="l50.67">             return &quot;overdue&quot;;</span>
<a href="#l50.68"></a><span id="l50.68">         } else if (aTask.dueDate.year == nowdate.getFullYear() &amp;&amp;</span>
<a href="#l50.69"></a><span id="l50.69">                    aTask.dueDate.month == nowdate.getMonth() &amp;&amp;</span>
<a href="#l50.70"></a><span id="l50.70">                    aTask.dueDate.day == nowdate.getDate()) {</span>
<a href="#l50.71"></a><span id="l50.71">             return &quot;duetoday&quot;;</span>
<a href="#l50.72"></a><span id="l50.72">         }</span>
<a href="#l50.73"></a><span id="l50.73">     }</span>
<a href="#l50.74"></a><span id="l50.74"> </span>
<a href="#l50.75"></a><span id="l50.75">     if (aTask.entryDate &amp;&amp; aTask.entryDate.isValid &amp;&amp;</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-        cal.dateTimeToJsDate(aTask.entryDate).getTime() &lt; nowdate.getTime()) {</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineplus">+        cal.dtz.dateTimeToJsDate(aTask.entryDate).getTime() &lt; nowdate.getTime()) {</span>
<a href="#l50.78"></a><span id="l50.78">         return &quot;inprogress&quot;;</span>
<a href="#l50.79"></a><span id="l50.79">     }</span>
<a href="#l50.80"></a><span id="l50.80"> </span>
<a href="#l50.81"></a><span id="l50.81">     return &quot;future&quot;;</span>
<a href="#l50.82"></a><span id="l50.82"> }</span>
<a href="#l50.83"></a><span id="l50.83"> </span>
<a href="#l50.84"></a><span id="l50.84"> function calInterfaceBag(iid) {</span>
<a href="#l50.85"></a><span id="l50.85">     this.init(iid);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/import-export/calHtmlExport.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/import-export/calHtmlExport.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -41,21 +41,21 @@ calHtmlExporter.prototype = {</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5">     exportToStream: function(aStream, aCount, aItems, aTitle) {</span>
<a href="#l51.6"></a><span id="l51.6">         let document = cal.xml.parseFile(&quot;chrome://calendar-common/skin/printing/calHtmlExport.html&quot;);</span>
<a href="#l51.7"></a><span id="l51.7">         let itemContainer = document.getElementById(&quot;item-container&quot;);</span>
<a href="#l51.8"></a><span id="l51.8">         document.getElementById(&quot;title&quot;).textContent = aTitle || cal.calGetString(&quot;calendar&quot;, &quot;HTMLTitle&quot;);</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10">         // Sort aItems</span>
<a href="#l51.11"></a><span id="l51.11">         aItems.sort((a, b) =&gt; {</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-            let start_a = a[cal.calGetStartDateProp(a)];</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+            let start_a = a[cal.dtz.startDateProp(a)];</span>
<a href="#l51.14"></a><span id="l51.14">             if (!start_a) {</span>
<a href="#l51.15"></a><span id="l51.15">                 return -1;</span>
<a href="#l51.16"></a><span id="l51.16">             }</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineminus">-            let start_b = b[cal.calGetStartDateProp(b)];</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+            let start_b = b[cal.dtz.startDateProp(b)];</span>
<a href="#l51.19"></a><span id="l51.19">             if (!start_b) {</span>
<a href="#l51.20"></a><span id="l51.20">                 return 1;</span>
<a href="#l51.21"></a><span id="l51.21">             }</span>
<a href="#l51.22"></a><span id="l51.22">             return start_a.compare(start_b);</span>
<a href="#l51.23"></a><span id="l51.23">         });</span>
<a href="#l51.24"></a><span id="l51.24"> </span>
<a href="#l51.25"></a><span id="l51.25">         for (let item of aItems) {</span>
<a href="#l51.26"></a><span id="l51.26">             let itemNode = document.getElementById(&quot;item-template&quot;).cloneNode(true);</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineat">@@ -70,18 +70,18 @@ calHtmlExporter.prototype = {</span>
<a href="#l51.28"></a><span id="l51.28">                     let row = itemNode.querySelector(&quot;.&quot; + classKey + &quot;row&quot;);</span>
<a href="#l51.29"></a><span id="l51.29">                     if (row.nextSibling instanceof Components.interfaces.nsIDOMText) {</span>
<a href="#l51.30"></a><span id="l51.30">                         row.nextSibling.remove();</span>
<a href="#l51.31"></a><span id="l51.31">                     }</span>
<a href="#l51.32"></a><span id="l51.32">                     row.remove();</span>
<a href="#l51.33"></a><span id="l51.33">                 }</span>
<a href="#l51.34"></a><span id="l51.34">             };</span>
<a href="#l51.35"></a><span id="l51.35"> </span>
<a href="#l51.36"></a><span id="l51.36" class="difflineminus">-            let startDate = item[cal.calGetStartDateProp(item)];</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineminus">-            let endDate = item[cal.calGetEndDateProp(item)];</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineplus">+            let startDate = item[cal.dtz.startDateProp(item)];</span>
<a href="#l51.39"></a><span id="l51.39" class="difflineplus">+            let endDate = item[cal.dtz.endDateProp(item)];</span>
<a href="#l51.40"></a><span id="l51.40">             if (startDate || endDate) {</span>
<a href="#l51.41"></a><span id="l51.41">                 // This is a task with a start or due date, format accordingly</span>
<a href="#l51.42"></a><span id="l51.42">                 let prefixWhen = cal.calGetString(&quot;calendar&quot;, &quot;htmlPrefixWhen&quot;);</span>
<a href="#l51.43"></a><span id="l51.43">                 itemNode.querySelector(&quot;.intervalkey&quot;).textContent = prefixWhen;</span>
<a href="#l51.44"></a><span id="l51.44"> </span>
<a href="#l51.45"></a><span id="l51.45">                 let startNode = itemNode.querySelector(&quot;.dtstart&quot;);</span>
<a href="#l51.46"></a><span id="l51.46">                 let dateString = cal.getDateFormatter().formatItemInterval(item);</span>
<a href="#l51.47"></a><span id="l51.47">                 startNode.setAttribute(&quot;title&quot;, startDate ? startDate.icalString : &quot;none&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -28,17 +28,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l52.4"></a><span id="l52.4">         classDescription: &quot;Calendar Month Grid Print Formatter&quot;,</span>
<a href="#l52.5"></a><span id="l52.5">         interfaces: calMonthPrinterInterfaces</span>
<a href="#l52.6"></a><span id="l52.6">     }),</span>
<a href="#l52.7"></a><span id="l52.7"> </span>
<a href="#l52.8"></a><span id="l52.8">     get name() { return cal.calGetString(&quot;calendar&quot;, &quot;monthPrinterName&quot;); },</span>
<a href="#l52.9"></a><span id="l52.9"> </span>
<a href="#l52.10"></a><span id="l52.10">     formatToHtml: function(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l52.11"></a><span id="l52.11">         let document = cal.xml.parseFile(&quot;chrome://calendar-common/skin/printing/calMonthGridPrinter.html&quot;);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-        let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+        let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l52.14"></a><span id="l52.14"> </span>
<a href="#l52.15"></a><span id="l52.15">         // Set page title</span>
<a href="#l52.16"></a><span id="l52.16">         document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l52.17"></a><span id="l52.17"> </span>
<a href="#l52.18"></a><span id="l52.18">         // Table that maps YYYY-MM-DD to the DOM node container where items are to be added</span>
<a href="#l52.19"></a><span id="l52.19">         let dayTable = {};</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21">         // Make sure to create tables from start to end, if passed</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineat">@@ -51,18 +51,18 @@ calMonthPrinter.prototype = {</span>
<a href="#l52.23"></a><span id="l52.23">             for (let current = startDate.clone();</span>
<a href="#l52.24"></a><span id="l52.24">                  weekInfoService.getEndOfWeek(current.endOfMonth).compare(endDate) &lt; 0;</span>
<a href="#l52.25"></a><span id="l52.25">                  current.month += 1) {</span>
<a href="#l52.26"></a><span id="l52.26">                 this.setupMonth(document, current, dayTable);</span>
<a href="#l52.27"></a><span id="l52.27">             }</span>
<a href="#l52.28"></a><span id="l52.28">         }</span>
<a href="#l52.29"></a><span id="l52.29"> </span>
<a href="#l52.30"></a><span id="l52.30">         for (let item of aItems) {</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineminus">-            let itemStartDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineminus">-            let itemEndDate = item[cal.calGetEndDateProp(item)] || item[cal.calGetStartDateProp(item)];</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+            let itemStartDate = item[cal.dtz.startDateProp(item)] || item[cal.dtz.endDateProp(item)];</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+            let itemEndDate = item[cal.dtz.endDateProp(item)] || item[cal.dtz.startDateProp(item)];</span>
<a href="#l52.35"></a><span id="l52.35"> </span>
<a href="#l52.36"></a><span id="l52.36">             if (!itemStartDate &amp;&amp; !itemEndDate) {</span>
<a href="#l52.37"></a><span id="l52.37">                 cal.print.addItemToDayboxNodate(document, item);</span>
<a href="#l52.38"></a><span id="l52.38">                 continue;</span>
<a href="#l52.39"></a><span id="l52.39">             }</span>
<a href="#l52.40"></a><span id="l52.40">             itemStartDate = itemStartDate.getInTimezone(defaultTimezone);</span>
<a href="#l52.41"></a><span id="l52.41">             itemEndDate = itemEndDate.getInTimezone(defaultTimezone);</span>
<a href="#l52.42"></a><span id="l52.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -366,17 +366,17 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l53.4"></a><span id="l53.4">         aCount.value = eventArray.length;</span>
<a href="#l53.5"></a><span id="l53.5">         return eventArray;</span>
<a href="#l53.6"></a><span id="l53.6">     },</span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8">     parseDateTime: function(aDate, aTime, aLocale) {</span>
<a href="#l53.9"></a><span id="l53.9">         let date = cal.createDateTime();</span>
<a href="#l53.10"></a><span id="l53.10"> </span>
<a href="#l53.11"></a><span id="l53.11">         // XXX Can we do better?</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-        date.timezone = cal.floating();</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+        date.timezone = cal.dtz.floating;</span>
<a href="#l53.14"></a><span id="l53.14"> </span>
<a href="#l53.15"></a><span id="l53.15">         let datepart = aLocale.dateRe.exec(aDate);</span>
<a href="#l53.16"></a><span id="l53.16">         let timepart = aLocale.timeRe.exec(aTime);</span>
<a href="#l53.17"></a><span id="l53.17"> </span>
<a href="#l53.18"></a><span id="l53.18">         if (!datepart) {</span>
<a href="#l53.19"></a><span id="l53.19">             return null;</span>
<a href="#l53.20"></a><span id="l53.20">         }</span>
<a href="#l53.21"></a><span id="l53.21"> </span>
<a href="#l53.22"></a><span id="l53.22" class="difflineat">@@ -424,20 +424,20 @@ calOutlookCSVExporter.prototype = {</span>
<a href="#l53.23"></a><span id="l53.23">         interfaces: calOutlookCSVExporterInterfaces</span>
<a href="#l53.24"></a><span id="l53.24">     }),</span>
<a href="#l53.25"></a><span id="l53.25"> </span>
<a href="#l53.26"></a><span id="l53.26">     getFileTypes: getOutlookCsvFileTypes,</span>
<a href="#l53.27"></a><span id="l53.27"> </span>
<a href="#l53.28"></a><span id="l53.28">     exportToStream: function(aStream, aCount, aItems) {</span>
<a href="#l53.29"></a><span id="l53.29">         // Helper functions</span>
<a href="#l53.30"></a><span id="l53.30">         function dateString(aDateTime) {</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-            return cal.dateTimeToJsDate(aDateTime).toLocaleString(&quot;en-US&quot;, localeEn.dateFormat);</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+            return cal.dtz.dateTimeToJsDate(aDateTime).toLocaleString(&quot;en-US&quot;, localeEn.dateFormat);</span>
<a href="#l53.33"></a><span id="l53.33">         }</span>
<a href="#l53.34"></a><span id="l53.34">         function timeString(aDateTime) {</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-            return cal.dateTimeToJsDate(aDateTime).toLocaleString(&quot;en-US&quot;, localeEn.timeFormat);</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+            return cal.dtz.dateTimeToJsDate(aDateTime).toLocaleString(&quot;en-US&quot;, localeEn.timeFormat);</span>
<a href="#l53.37"></a><span id="l53.37">         }</span>
<a href="#l53.38"></a><span id="l53.38">         function txtString(aString) { return aString || &quot;&quot;; }</span>
<a href="#l53.39"></a><span id="l53.39"> </span>
<a href="#l53.40"></a><span id="l53.40">         let headers = [];</span>
<a href="#l53.41"></a><span id="l53.41">         // Not using a loop here, since we need to be sure the order here matches</span>
<a href="#l53.42"></a><span id="l53.42">         // with the orders the field data is added later on</span>
<a href="#l53.43"></a><span id="l53.43">         headers.push(localeEn.headTitle);</span>
<a href="#l53.44"></a><span id="l53.44">         headers.push(localeEn.headStartDate);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/import-export/calWeekPrinter.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/import-export/calWeekPrinter.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -28,35 +28,35 @@ calWeekPrinter.prototype = {</span>
<a href="#l54.4"></a><span id="l54.4">         classDescription: &quot;Calendar Week Print Formatter&quot;,</span>
<a href="#l54.5"></a><span id="l54.5">         interfaces: calWeekPrinterInterfaces</span>
<a href="#l54.6"></a><span id="l54.6">     }),</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8">     get name() { return cal.calGetString(&quot;calendar&quot;, &quot;weekPrinterName&quot;); },</span>
<a href="#l54.9"></a><span id="l54.9"> </span>
<a href="#l54.10"></a><span id="l54.10">     formatToHtml: function(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l54.11"></a><span id="l54.11">         let document = cal.xml.parseFile(&quot;chrome://calendar-common/skin/printing/calWeekPrinter.html&quot;);</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-        let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+        let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l54.14"></a><span id="l54.14"> </span>
<a href="#l54.15"></a><span id="l54.15">         // Set page title</span>
<a href="#l54.16"></a><span id="l54.16">         document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l54.17"></a><span id="l54.17"> </span>
<a href="#l54.18"></a><span id="l54.18">         // Table that maps YYYY-MM-DD to the DOM node container where items are to be added</span>
<a href="#l54.19"></a><span id="l54.19">         let dayTable = {};</span>
<a href="#l54.20"></a><span id="l54.20">         let weekInfoService = cal.getWeekInfoService();</span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22">         // Make sure to create tables from start to end, if passed</span>
<a href="#l54.23"></a><span id="l54.23">         if (aStart &amp;&amp; aEnd) {</span>
<a href="#l54.24"></a><span id="l54.24">             for (let current = weekInfoService.getStartOfWeek(aStart); current.compare(aEnd) &lt; 0; current.day += 7) {</span>
<a href="#l54.25"></a><span id="l54.25">                 this.setupWeek(document, current, dayTable);</span>
<a href="#l54.26"></a><span id="l54.26">             }</span>
<a href="#l54.27"></a><span id="l54.27">         }</span>
<a href="#l54.28"></a><span id="l54.28"> </span>
<a href="#l54.29"></a><span id="l54.29">         for (let item of aItems) {</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-            let itemStartDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-            let itemEndDate = item[cal.calGetEndDateProp(item)] || item[cal.calGetStartDateProp(item)];</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineplus">+            let itemStartDate = item[cal.dtz.startDateProp(item)] || item[cal.dtz.endDateProp(item)];</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineplus">+            let itemEndDate = item[cal.dtz.endDateProp(item)] || item[cal.dtz.startDateProp(item)];</span>
<a href="#l54.34"></a><span id="l54.34"> </span>
<a href="#l54.35"></a><span id="l54.35">             if (!itemStartDate &amp;&amp; !itemEndDate) {</span>
<a href="#l54.36"></a><span id="l54.36">                 cal.print.addItemToDayboxNodate(document, item);</span>
<a href="#l54.37"></a><span id="l54.37">                 continue;</span>
<a href="#l54.38"></a><span id="l54.38">             }</span>
<a href="#l54.39"></a><span id="l54.39">             itemStartDate = itemStartDate.getInTimezone(defaultTimezone);</span>
<a href="#l54.40"></a><span id="l54.40">             itemEndDate = itemEndDate.getInTimezone(defaultTimezone);</span>
<a href="#l54.41"></a><span id="l54.41"> </span>
<a href="#l54.42"></a><span id="l54.42" class="difflineat">@@ -94,17 +94,17 @@ calWeekPrinter.prototype = {</span>
<a href="#l54.43"></a><span id="l54.43">         convStream.writeString(html);</span>
<a href="#l54.44"></a><span id="l54.44">     },</span>
<a href="#l54.45"></a><span id="l54.45"> </span>
<a href="#l54.46"></a><span id="l54.46">     setupWeek: function(document, startOfWeek, dayTable) {</span>
<a href="#l54.47"></a><span id="l54.47">         const weekdayMap = [&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;, &quot;saturday&quot;];</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49">         let weekTemplate = document.getElementById(&quot;week-template&quot;);</span>
<a href="#l54.50"></a><span id="l54.50">         let weekContainer = document.getElementById(&quot;week-container&quot;);</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-        let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineplus">+        let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l54.53"></a><span id="l54.53"> </span>
<a href="#l54.54"></a><span id="l54.54">         // Clone the template week and make sure it doesn't have an id</span>
<a href="#l54.55"></a><span id="l54.55">         let currentPage = weekTemplate.cloneNode(true);</span>
<a href="#l54.56"></a><span id="l54.56">         currentPage.removeAttribute(&quot;id&quot;);</span>
<a href="#l54.57"></a><span id="l54.57">         currentPage.item = startOfWeek.clone();</span>
<a href="#l54.58"></a><span id="l54.58"> </span>
<a href="#l54.59"></a><span id="l54.59">         // Set up the week number title</span>
<a href="#l54.60"></a><span id="l54.60">         let weekInfo = cal.getWeekInfoService();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -362,17 +362,17 @@ function onLoad() {</span>
<a href="#l55.4"></a><span id="l55.4"> </span>
<a href="#l55.5"></a><span id="l55.5">     window.recurrenceInfo = null;</span>
<a href="#l55.6"></a><span id="l55.6">     if (parentItem.recurrenceInfo) {</span>
<a href="#l55.7"></a><span id="l55.7">         window.recurrenceInfo = parentItem.recurrenceInfo.clone();</span>
<a href="#l55.8"></a><span id="l55.8">     }</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10">     // Set initial values for datepickers in New Tasks dialog</span>
<a href="#l55.11"></a><span id="l55.11">     if (cal.isToDo(item)) {</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-        let initialDatesValue = cal.dateTimeToJsDate(args.initialStartDateValue);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+        let initialDatesValue = cal.dtz.dateTimeToJsDate(args.initialStartDateValue);</span>
<a href="#l55.14"></a><span id="l55.14">         if (!gNewItemUI) {</span>
<a href="#l55.15"></a><span id="l55.15">             setElementValue(&quot;completed-date-picker&quot;, initialDatesValue);</span>
<a href="#l55.16"></a><span id="l55.16">             setElementValue(&quot;todo-entrydate&quot;, initialDatesValue);</span>
<a href="#l55.17"></a><span id="l55.17">             setElementValue(&quot;todo-duedate&quot;, initialDatesValue);</span>
<a href="#l55.18"></a><span id="l55.18">         }</span>
<a href="#l55.19"></a><span id="l55.19">     }</span>
<a href="#l55.20"></a><span id="l55.20">     loadDialog(window.calendarItem);</span>
<a href="#l55.21"></a><span id="l55.21"> </span>
<a href="#l55.22"></a><span id="l55.22" class="difflineat">@@ -658,17 +658,17 @@ function loadDialog(aItem) {</span>
<a href="#l55.23"></a><span id="l55.23">         itemProps.initialDescription = aItem.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l55.24"></a><span id="l55.24">     } else {</span>
<a href="#l55.25"></a><span id="l55.25">         setElementValue(&quot;item-description&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l55.26"></a><span id="l55.26">     }</span>
<a href="#l55.27"></a><span id="l55.27"> </span>
<a href="#l55.28"></a><span id="l55.28">     // Task completed date</span>
<a href="#l55.29"></a><span id="l55.29">     if (!gNewItemUI) {</span>
<a href="#l55.30"></a><span id="l55.30">         if (aItem.completedDate) {</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-            updateToDoStatus(aItem.status, cal.dateTimeToJsDate(aItem.completedDate));</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+            updateToDoStatus(aItem.status, cal.dtz.dateTimeToJsDate(aItem.completedDate));</span>
<a href="#l55.33"></a><span id="l55.33">         } else {</span>
<a href="#l55.34"></a><span id="l55.34">             updateToDoStatus(aItem.status);</span>
<a href="#l55.35"></a><span id="l55.35">         }</span>
<a href="#l55.36"></a><span id="l55.36">     }</span>
<a href="#l55.37"></a><span id="l55.37"> </span>
<a href="#l55.38"></a><span id="l55.38">     // Task percent complete</span>
<a href="#l55.39"></a><span id="l55.39">     if (cal.isToDo(aItem)) {</span>
<a href="#l55.40"></a><span id="l55.40">         let percentCompleteInteger = 0;</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineat">@@ -886,17 +886,17 @@ function saveCategories(aItem) {</span>
<a href="#l55.42"></a><span id="l55.42"> }</span>
<a href="#l55.43"></a><span id="l55.43"> </span>
<a href="#l55.44"></a><span id="l55.44"> /**</span>
<a href="#l55.45"></a><span id="l55.45">  * Sets up all date related controls from the passed item</span>
<a href="#l55.46"></a><span id="l55.46">  *</span>
<a href="#l55.47"></a><span id="l55.47">  * @param item      The item to parse information out of.</span>
<a href="#l55.48"></a><span id="l55.48">  */</span>
<a href="#l55.49"></a><span id="l55.49"> function loadDateTime(item) {</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.52"></a><span id="l55.52">     if (cal.isEvent(item)) {</span>
<a href="#l55.53"></a><span id="l55.53">         let startTime = item.startDate;</span>
<a href="#l55.54"></a><span id="l55.54">         let endTime = item.endDate;</span>
<a href="#l55.55"></a><span id="l55.55">         let duration = endTime.subtractDate(startTime);</span>
<a href="#l55.56"></a><span id="l55.56"> </span>
<a href="#l55.57"></a><span id="l55.57">         // Check if an all-day event has been passed in (to adapt endDate).</span>
<a href="#l55.58"></a><span id="l55.58">         if (startTime.isDate) {</span>
<a href="#l55.59"></a><span id="l55.59">             startTime = startTime.clone();</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineat">@@ -1003,27 +1003,27 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l55.61"></a><span id="l55.61">             gItemDuration = null;</span>
<a href="#l55.62"></a><span id="l55.62">         }</span>
<a href="#l55.63"></a><span id="l55.63">         startWidgetId = &quot;todo-entrydate&quot;;</span>
<a href="#l55.64"></a><span id="l55.64">         endWidgetId = &quot;todo-duedate&quot;;</span>
<a href="#l55.65"></a><span id="l55.65">     }</span>
<a href="#l55.66"></a><span id="l55.66"> </span>
<a href="#l55.67"></a><span id="l55.67">     let saveStartTime = gStartTime;</span>
<a href="#l55.68"></a><span id="l55.68">     let saveEndTime = gEndTime;</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.71"></a><span id="l55.71"> </span>
<a href="#l55.72"></a><span id="l55.72">     if (gStartTime) {</span>
<a href="#l55.73"></a><span id="l55.73">         // jsDate is always in OS timezone, thus we create a calIDateTime</span>
<a href="#l55.74"></a><span id="l55.74">         // object from the jsDate representation then we convert the timezone</span>
<a href="#l55.75"></a><span id="l55.75">         // in order to keep gStartTime in default timezone.</span>
<a href="#l55.76"></a><span id="l55.76">         if (gTimezonesEnabled || allDay) {</span>
<a href="#l55.77"></a><span id="l55.77" class="difflineminus">-            gStartTime = cal.jsDateToDateTime(getElementValue(startWidgetId), gStartTimezone);</span>
<a href="#l55.78"></a><span id="l55.78" class="difflineplus">+            gStartTime = cal.dtz.jsDateToDateTime(getElementValue(startWidgetId), gStartTimezone);</span>
<a href="#l55.79"></a><span id="l55.79">             gStartTime = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.80"></a><span id="l55.80">         } else {</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineminus">-            gStartTime = cal.jsDateToDateTime(getElementValue(startWidgetId), kDefaultTimezone);</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineplus">+            gStartTime = cal.dtz.jsDateToDateTime(getElementValue(startWidgetId), kDefaultTimezone);</span>
<a href="#l55.83"></a><span id="l55.83">         }</span>
<a href="#l55.84"></a><span id="l55.84">         gStartTime.isDate = allDay;</span>
<a href="#l55.85"></a><span id="l55.85">     }</span>
<a href="#l55.86"></a><span id="l55.86">     if (gEndTime) {</span>
<a href="#l55.87"></a><span id="l55.87">         if (aStartDatepicker) {</span>
<a href="#l55.88"></a><span id="l55.88">             // Change the End date in order to keep the duration.</span>
<a href="#l55.89"></a><span id="l55.89">             gEndTime = gStartTime.clone();</span>
<a href="#l55.90"></a><span id="l55.90">             if (gItemDuration) {</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineat">@@ -1032,20 +1032,20 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l55.92"></a><span id="l55.92">         } else {</span>
<a href="#l55.93"></a><span id="l55.93">             let timezone = gEndTimezone;</span>
<a href="#l55.94"></a><span id="l55.94">             if (timezone.isUTC) {</span>
<a href="#l55.95"></a><span id="l55.95">                 if (gStartTime &amp;&amp; !cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l55.96"></a><span id="l55.96">                     timezone = gStartTimezone;</span>
<a href="#l55.97"></a><span id="l55.97">                 }</span>
<a href="#l55.98"></a><span id="l55.98">             }</span>
<a href="#l55.99"></a><span id="l55.99">             if (gTimezonesEnabled || allDay) {</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineminus">-                gEndTime = cal.jsDateToDateTime(getElementValue(endWidgetId), timezone);</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+                gEndTime = cal.dtz.jsDateToDateTime(getElementValue(endWidgetId), timezone);</span>
<a href="#l55.102"></a><span id="l55.102">                 gEndTime = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.103"></a><span id="l55.103">             } else {</span>
<a href="#l55.104"></a><span id="l55.104" class="difflineminus">-                gEndTime = cal.jsDateToDateTime(getElementValue(endWidgetId), kDefaultTimezone);</span>
<a href="#l55.105"></a><span id="l55.105" class="difflineplus">+                gEndTime = cal.dtz.jsDateToDateTime(getElementValue(endWidgetId), kDefaultTimezone);</span>
<a href="#l55.106"></a><span id="l55.106">             }</span>
<a href="#l55.107"></a><span id="l55.107">             gEndTime.isDate = allDay;</span>
<a href="#l55.108"></a><span id="l55.108">             if (keepAttribute &amp;&amp; gItemDuration) {</span>
<a href="#l55.109"></a><span id="l55.109">                 // Keepduration-button links the the Start to the End date. We</span>
<a href="#l55.110"></a><span id="l55.110">                 // have to change the Start date in order to keep the duration.</span>
<a href="#l55.111"></a><span id="l55.111">                 let fduration = gItemDuration.clone();</span>
<a href="#l55.112"></a><span id="l55.112">                 fduration.isNegative = true;</span>
<a href="#l55.113"></a><span id="l55.113">                 gStartTime = gEndTime.clone();</span>
<a href="#l55.114"></a><span id="l55.114" class="difflineat">@@ -1077,17 +1077,17 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l55.115"></a><span id="l55.115"> </span>
<a href="#l55.116"></a><span id="l55.116">     let startChanged = false;</span>
<a href="#l55.117"></a><span id="l55.117">     if (gStartTime &amp;&amp; saveStartTime) {</span>
<a href="#l55.118"></a><span id="l55.118">         startChanged = gStartTime.compare(saveStartTime) != 0;</span>
<a href="#l55.119"></a><span id="l55.119">     }</span>
<a href="#l55.120"></a><span id="l55.120">     // Preset the date in the until-datepicker's minimonth to the new start</span>
<a href="#l55.121"></a><span id="l55.121">     // date if it has changed.</span>
<a href="#l55.122"></a><span id="l55.122">     if (startChanged) {</span>
<a href="#l55.123"></a><span id="l55.123" class="difflineminus">-        let startDate = cal.dateTimeToJsDate(gStartTime.getInTimezone(cal.floating()));</span>
<a href="#l55.124"></a><span id="l55.124" class="difflineplus">+        let startDate = cal.dtz.dateTimeToJsDate(gStartTime.getInTimezone(cal.dtz.floating));</span>
<a href="#l55.125"></a><span id="l55.125">         document.getElementById(&quot;repeat-until-datepicker&quot;).extraDate = startDate;</span>
<a href="#l55.126"></a><span id="l55.126">     }</span>
<a href="#l55.127"></a><span id="l55.127"> </span>
<a href="#l55.128"></a><span id="l55.128">     // Sort out and verify the until date if the start date has changed.</span>
<a href="#l55.129"></a><span id="l55.129">     if (gUntilDate &amp;&amp; startChanged) {</span>
<a href="#l55.130"></a><span id="l55.130">         // Make the time part of the until date equal to the time of start date.</span>
<a href="#l55.131"></a><span id="l55.131">         updateUntildateRecRule();</span>
<a href="#l55.132"></a><span id="l55.132"> </span>
<a href="#l55.133"></a><span id="l55.133" class="difflineat">@@ -1101,17 +1101,17 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l55.134"></a><span id="l55.134">             let rrules = splitRecurrenceRules(window.recurrenceInfo);</span>
<a href="#l55.135"></a><span id="l55.135">             recRule = rrules[0][0];</span>
<a href="#l55.136"></a><span id="l55.136">             recRule.untilDate = gUntilDate.clone();</span>
<a href="#l55.137"></a><span id="l55.137">             // Update the until-date-picker. In case of &quot;custom&quot; rule, the</span>
<a href="#l55.138"></a><span id="l55.138">             // recurrence string is going to be changed by updateDateTime() below.</span>
<a href="#l55.139"></a><span id="l55.139">             let notCustomRule = document.getElementById(&quot;repeat-deck&quot;).selectedIndex == 0;</span>
<a href="#l55.140"></a><span id="l55.140">             if (notCustomRule) {</span>
<a href="#l55.141"></a><span id="l55.141">                 setElementValue(&quot;repeat-until-datepicker&quot;,</span>
<a href="#l55.142"></a><span id="l55.142" class="difflineminus">-                                cal.dateTimeToJsDate(gUntilDate.getInTimezone(cal.floating())));</span>
<a href="#l55.143"></a><span id="l55.143" class="difflineplus">+                                cal.dtz.dateTimeToJsDate(gUntilDate.getInTimezone(cal.dtz.floating)));</span>
<a href="#l55.144"></a><span id="l55.144">             }</span>
<a href="#l55.145"></a><span id="l55.145"> </span>
<a href="#l55.146"></a><span id="l55.146">             warning = true;</span>
<a href="#l55.147"></a><span id="l55.147">             stringWarning = cal.calGetString(&quot;calendar&quot;, &quot;warningUntilDateBeforeStart&quot;);</span>
<a href="#l55.148"></a><span id="l55.148">         }</span>
<a href="#l55.149"></a><span id="l55.149">     }</span>
<a href="#l55.150"></a><span id="l55.150"> </span>
<a href="#l55.151"></a><span id="l55.151">     updateDateTime();</span>
<a href="#l55.152"></a><span id="l55.152" class="difflineat">@@ -1189,28 +1189,28 @@ function updateDateCheckboxes(aDatePicke</span>
<a href="#l55.153"></a><span id="l55.153">     setElementValue(aDatePickerId, getElementValue(aDatePickerId));</span>
<a href="#l55.154"></a><span id="l55.154"> </span>
<a href="#l55.155"></a><span id="l55.155">     // first of all disable the datetime picker if we don't have a date</span>
<a href="#l55.156"></a><span id="l55.156">     let hasDate = getElementValue(aCheckboxId, &quot;checked&quot;);</span>
<a href="#l55.157"></a><span id="l55.157">     setElementValue(aDatePickerId, !hasDate, &quot;disabled&quot;);</span>
<a href="#l55.158"></a><span id="l55.158"> </span>
<a href="#l55.159"></a><span id="l55.159">     // create a new datetime object if date is now checked for the first time</span>
<a href="#l55.160"></a><span id="l55.160">     if (hasDate &amp;&amp; !aDateTime.isValid()) {</span>
<a href="#l55.161"></a><span id="l55.161" class="difflineminus">-        let date = cal.jsDateToDateTime(getElementValue(aDatePickerId), cal.calendarDefaultTimezone());</span>
<a href="#l55.162"></a><span id="l55.162" class="difflineplus">+        let date = cal.dtz.jsDateToDateTime(getElementValue(aDatePickerId), cal.dtz.defaultTimezone);</span>
<a href="#l55.163"></a><span id="l55.163">         aDateTime.setDateTime(date);</span>
<a href="#l55.164"></a><span id="l55.164">     } else if (!hasDate &amp;&amp; aDateTime.isValid()) {</span>
<a href="#l55.165"></a><span id="l55.165">         aDateTime.setDateTime(null);</span>
<a href="#l55.166"></a><span id="l55.166">     }</span>
<a href="#l55.167"></a><span id="l55.167"> </span>
<a href="#l55.168"></a><span id="l55.168">     // calculate the duration if possible</span>
<a href="#l55.169"></a><span id="l55.169">     let hasEntryDate = getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;);</span>
<a href="#l55.170"></a><span id="l55.170">     let hasDueDate = getElementValue(&quot;todo-has-duedate&quot;, &quot;checked&quot;);</span>
<a href="#l55.171"></a><span id="l55.171">     if (hasEntryDate &amp;&amp; hasDueDate) {</span>
<a href="#l55.172"></a><span id="l55.172" class="difflineminus">-        let start = cal.jsDateToDateTime(getElementValue(&quot;todo-entrydate&quot;));</span>
<a href="#l55.173"></a><span id="l55.173" class="difflineminus">-        let end = cal.jsDateToDateTime(getElementValue(&quot;todo-duedate&quot;));</span>
<a href="#l55.174"></a><span id="l55.174" class="difflineplus">+        let start = cal.dtz.jsDateToDateTime(getElementValue(&quot;todo-entrydate&quot;));</span>
<a href="#l55.175"></a><span id="l55.175" class="difflineplus">+        let end = cal.dtz.jsDateToDateTime(getElementValue(&quot;todo-duedate&quot;));</span>
<a href="#l55.176"></a><span id="l55.176">         gItemDuration = end.subtractDate(start);</span>
<a href="#l55.177"></a><span id="l55.177">     } else {</span>
<a href="#l55.178"></a><span id="l55.178">         gItemDuration = null;</span>
<a href="#l55.179"></a><span id="l55.179">     }</span>
<a href="#l55.180"></a><span id="l55.180">     setBooleanAttribute(&quot;keepduration-button&quot;, &quot;disabled&quot;, !(hasEntryDate &amp;&amp; hasDueDate));</span>
<a href="#l55.181"></a><span id="l55.181">     updateDateTime();</span>
<a href="#l55.182"></a><span id="l55.182">     updateTimezone();</span>
<a href="#l55.183"></a><span id="l55.183"> }</span>
<a href="#l55.184"></a><span id="l55.184" class="difflineat">@@ -1229,18 +1229,18 @@ function getRepeatTypeAndUntilDate(aItem</span>
<a href="#l55.185"></a><span id="l55.185">     /**</span>
<a href="#l55.186"></a><span id="l55.186">      * Updates the until date (locally and globally).</span>
<a href="#l55.187"></a><span id="l55.187">      *</span>
<a href="#l55.188"></a><span id="l55.188">      * @param aRule  The recurrence rule</span>
<a href="#l55.189"></a><span id="l55.189">      */</span>
<a href="#l55.190"></a><span id="l55.190">     let updateUntilDate = (aRule) =&gt; {</span>
<a href="#l55.191"></a><span id="l55.191">         if (!aRule.isByCount) {</span>
<a href="#l55.192"></a><span id="l55.192">             if (aRule.isFinite) {</span>
<a href="#l55.193"></a><span id="l55.193" class="difflineminus">-                gUntilDate = aRule.untilDate.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l55.194"></a><span id="l55.194" class="difflineminus">-                untilDate = cal.dateTimeToJsDate(gUntilDate.getInTimezone(cal.floating()));</span>
<a href="#l55.195"></a><span id="l55.195" class="difflineplus">+                gUntilDate = aRule.untilDate.clone().getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l55.196"></a><span id="l55.196" class="difflineplus">+                untilDate = cal.dtz.dateTimeToJsDate(gUntilDate.getInTimezone(cal.dtz.floating));</span>
<a href="#l55.197"></a><span id="l55.197">             } else {</span>
<a href="#l55.198"></a><span id="l55.198">                 gUntilDate = null;</span>
<a href="#l55.199"></a><span id="l55.199">             }</span>
<a href="#l55.200"></a><span id="l55.200">         }</span>
<a href="#l55.201"></a><span id="l55.201">     };</span>
<a href="#l55.202"></a><span id="l55.202"> </span>
<a href="#l55.203"></a><span id="l55.203">     if (recurrenceInfo) {</span>
<a href="#l55.204"></a><span id="l55.204">         repeatType = &quot;custom&quot;;</span>
<a href="#l55.205"></a><span id="l55.205" class="difflineat">@@ -1454,17 +1454,17 @@ function saveDialog(item) {</span>
<a href="#l55.206"></a><span id="l55.206">         item.deleteProperty(&quot;TRANSP&quot;);</span>
<a href="#l55.207"></a><span id="l55.207">     }</span>
<a href="#l55.208"></a><span id="l55.208"> </span>
<a href="#l55.209"></a><span id="l55.209">     // Privacy</span>
<a href="#l55.210"></a><span id="l55.210">     cal.setItemProperty(item, &quot;CLASS&quot;, gConfig.privacy, &quot;privacy&quot;);</span>
<a href="#l55.211"></a><span id="l55.211"> </span>
<a href="#l55.212"></a><span id="l55.212">     if (item.status == &quot;COMPLETED&quot; &amp;&amp; cal.isToDo(item)) {</span>
<a href="#l55.213"></a><span id="l55.213">         let elementValue = getElementValue(&quot;completed-date-picker&quot;);</span>
<a href="#l55.214"></a><span id="l55.214" class="difflineminus">-        item.completedDate = cal.jsDateToDateTime(elementValue);</span>
<a href="#l55.215"></a><span id="l55.215" class="difflineplus">+        item.completedDate = cal.dtz.jsDateToDateTime(elementValue);</span>
<a href="#l55.216"></a><span id="l55.216">     }</span>
<a href="#l55.217"></a><span id="l55.217"> </span>
<a href="#l55.218"></a><span id="l55.218">     saveReminder(item);</span>
<a href="#l55.219"></a><span id="l55.219"> }</span>
<a href="#l55.220"></a><span id="l55.220"> </span>
<a href="#l55.221"></a><span id="l55.221"> /**</span>
<a href="#l55.222"></a><span id="l55.222">  * Save date and time related values from the dialog to the passed item.</span>
<a href="#l55.223"></a><span id="l55.223">  *</span>
<a href="#l55.224"></a><span id="l55.224" class="difflineat">@@ -1506,17 +1506,17 @@ function saveDateTime(item) {</span>
<a href="#l55.225"></a><span id="l55.225">  * correction caused by the function onStartDateChange() when saving the</span>
<a href="#l55.226"></a><span id="l55.226">  * item.</span>
<a href="#l55.227"></a><span id="l55.227">  * It allows to keep the until date set in the dialog irrespective of the</span>
<a href="#l55.228"></a><span id="l55.228">  * changes that the user has done to the start date.</span>
<a href="#l55.229"></a><span id="l55.229">  */</span>
<a href="#l55.230"></a><span id="l55.230"> function untilDateCompensation(aItem) {</span>
<a href="#l55.231"></a><span id="l55.231">     // The current start date in the item is always the date that we get</span>
<a href="#l55.232"></a><span id="l55.232">     // when opening the dialog or after the last save.</span>
<a href="#l55.233"></a><span id="l55.233" class="difflineminus">-    let startDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l55.234"></a><span id="l55.234" class="difflineplus">+    let startDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l55.235"></a><span id="l55.235"> </span>
<a href="#l55.236"></a><span id="l55.236">     if (aItem.recurrenceInfo) {</span>
<a href="#l55.237"></a><span id="l55.237">         let rrules = splitRecurrenceRules(aItem.recurrenceInfo);</span>
<a href="#l55.238"></a><span id="l55.238">         let rule = rrules[0][0];</span>
<a href="#l55.239"></a><span id="l55.239">         if (!rule.isByCount &amp;&amp; rule.isFinite &amp;&amp; startDate) {</span>
<a href="#l55.240"></a><span id="l55.240">             let compensation = startDate.subtractDate(gStartTime);</span>
<a href="#l55.241"></a><span id="l55.241">             if (compensation != &quot;PT0S&quot;) {</span>
<a href="#l55.242"></a><span id="l55.242">                 let untilDate = rule.untilDate.clone();</span>
<a href="#l55.243"></a><span id="l55.243" class="difflineat">@@ -1547,30 +1547,30 @@ function updateTitle() {</span>
<a href="#l55.244"></a><span id="l55.244"> </span>
<a href="#l55.245"></a><span id="l55.245"> /**</span>
<a href="#l55.246"></a><span id="l55.246">  * Update the disabled status of the accept button. The button is enabled if all</span>
<a href="#l55.247"></a><span id="l55.247">  * parts of the dialog have options selected that make sense.</span>
<a href="#l55.248"></a><span id="l55.248">  * constraining factors like</span>
<a href="#l55.249"></a><span id="l55.249">  */</span>
<a href="#l55.250"></a><span id="l55.250"> function updateAccept() {</span>
<a href="#l55.251"></a><span id="l55.251">     let enableAccept = true;</span>
<a href="#l55.252"></a><span id="l55.252" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.253"></a><span id="l55.253" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.254"></a><span id="l55.254">     let startDate;</span>
<a href="#l55.255"></a><span id="l55.255">     let endDate;</span>
<a href="#l55.256"></a><span id="l55.256">     let isEvent = cal.isEvent(window.calendarItem);</span>
<a href="#l55.257"></a><span id="l55.257"> </span>
<a href="#l55.258"></a><span id="l55.258">     // don't allow for end dates to be before start dates</span>
<a href="#l55.259"></a><span id="l55.259">     if (isEvent) {</span>
<a href="#l55.260"></a><span id="l55.260" class="difflineminus">-        startDate = cal.jsDateToDateTime(getElementValue(&quot;event-starttime&quot;));</span>
<a href="#l55.261"></a><span id="l55.261" class="difflineminus">-        endDate = cal.jsDateToDateTime(getElementValue(&quot;event-endtime&quot;));</span>
<a href="#l55.262"></a><span id="l55.262" class="difflineplus">+        startDate = cal.dtz.jsDateToDateTime(getElementValue(&quot;event-starttime&quot;));</span>
<a href="#l55.263"></a><span id="l55.263" class="difflineplus">+        endDate = cal.dtz.jsDateToDateTime(getElementValue(&quot;event-endtime&quot;));</span>
<a href="#l55.264"></a><span id="l55.264">     } else {</span>
<a href="#l55.265"></a><span id="l55.265">         startDate = getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;) ?</span>
<a href="#l55.266"></a><span id="l55.266" class="difflineminus">-            cal.jsDateToDateTime(getElementValue(&quot;todo-entrydate&quot;)) : null;</span>
<a href="#l55.267"></a><span id="l55.267" class="difflineplus">+            cal.dtz.jsDateToDateTime(getElementValue(&quot;todo-entrydate&quot;)) : null;</span>
<a href="#l55.268"></a><span id="l55.268">         endDate = getElementValue(&quot;todo-has-duedate&quot;, &quot;checked&quot;) ?</span>
<a href="#l55.269"></a><span id="l55.269" class="difflineminus">-            cal.jsDateToDateTime(getElementValue(&quot;todo-duedate&quot;)) : null;</span>
<a href="#l55.270"></a><span id="l55.270" class="difflineplus">+            cal.dtz.jsDateToDateTime(getElementValue(&quot;todo-duedate&quot;)) : null;</span>
<a href="#l55.271"></a><span id="l55.271">     }</span>
<a href="#l55.272"></a><span id="l55.272"> </span>
<a href="#l55.273"></a><span id="l55.273">     if (startDate &amp;&amp; endDate) {</span>
<a href="#l55.274"></a><span id="l55.274">         if (gTimezonesEnabled) {</span>
<a href="#l55.275"></a><span id="l55.275">             let startTimezone = gStartTimezone;</span>
<a href="#l55.276"></a><span id="l55.276">             let endTimezone = gEndTimezone;</span>
<a href="#l55.277"></a><span id="l55.277">             if (endTimezone.isUTC) {</span>
<a href="#l55.278"></a><span id="l55.278">                 if (!cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l55.279"></a><span id="l55.279" class="difflineat">@@ -1636,17 +1636,17 @@ var gOldEndTimezone = null;</span>
<a href="#l55.280"></a><span id="l55.280">  * Handler function to update controls and state in consequence of the &quot;all</span>
<a href="#l55.281"></a><span id="l55.281">  * day&quot; checkbox being clicked.</span>
<a href="#l55.282"></a><span id="l55.282">  */</span>
<a href="#l55.283"></a><span id="l55.283"> function onUpdateAllDay() {</span>
<a href="#l55.284"></a><span id="l55.284">     if (!cal.isEvent(window.calendarItem)) {</span>
<a href="#l55.285"></a><span id="l55.285">         return;</span>
<a href="#l55.286"></a><span id="l55.286">     }</span>
<a href="#l55.287"></a><span id="l55.287">     let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l55.288"></a><span id="l55.288" class="difflineminus">-    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.289"></a><span id="l55.289" class="difflineplus">+    let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.290"></a><span id="l55.290"> </span>
<a href="#l55.291"></a><span id="l55.291">     if (allDay) {</span>
<a href="#l55.292"></a><span id="l55.292">         // Store date-times and related timezones so we can restore</span>
<a href="#l55.293"></a><span id="l55.293">         // if the user unchecks the &quot;all day&quot; checkbox.</span>
<a href="#l55.294"></a><span id="l55.294">         gOldStartTime = gStartTime.clone();</span>
<a href="#l55.295"></a><span id="l55.295">         gOldEndTime = gEndTime.clone();</span>
<a href="#l55.296"></a><span id="l55.296">         gOldStartTimezone = gStartTimezone;</span>
<a href="#l55.297"></a><span id="l55.297">         gOldEndTimezone = gEndTimezone;</span>
<a href="#l55.298"></a><span id="l55.298" class="difflineat">@@ -1663,17 +1663,17 @@ function onUpdateAllDay() {</span>
<a href="#l55.299"></a><span id="l55.299">             }</span>
<a href="#l55.300"></a><span id="l55.300">         }</span>
<a href="#l55.301"></a><span id="l55.301">     } else {</span>
<a href="#l55.302"></a><span id="l55.302">         gStartTime.isDate = false;</span>
<a href="#l55.303"></a><span id="l55.303">         gEndTime.isDate = false;</span>
<a href="#l55.304"></a><span id="l55.304">         if (!gOldStartTime &amp;&amp; !gOldEndTime) {</span>
<a href="#l55.305"></a><span id="l55.305">             // The checkbox has been unchecked for the first time, the event</span>
<a href="#l55.306"></a><span id="l55.306">             // was an &quot;All day&quot; type, so we have to set default values.</span>
<a href="#l55.307"></a><span id="l55.307" class="difflineminus">-            gStartTime.hour = cal.getDefaultStartDate(window.initialStartDateValue).hour;</span>
<a href="#l55.308"></a><span id="l55.308" class="difflineplus">+            gStartTime.hour = cal.dtz.getDefaultStartDate(window.initialStartDateValue).hour;</span>
<a href="#l55.309"></a><span id="l55.309">             gEndTime.hour = gStartTime.hour;</span>
<a href="#l55.310"></a><span id="l55.310">             gEndTime.minute += Preferences.get(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l55.311"></a><span id="l55.311">             gOldStartTimezone = kDefaultTimezone;</span>
<a href="#l55.312"></a><span id="l55.312">             gOldEndTimezone = kDefaultTimezone;</span>
<a href="#l55.313"></a><span id="l55.313">         } else {</span>
<a href="#l55.314"></a><span id="l55.314">             // Restore date-times previously stored.</span>
<a href="#l55.315"></a><span id="l55.315">             gStartTime.hour = gOldStartTime.hour;</span>
<a href="#l55.316"></a><span id="l55.316">             gStartTime.minute = gOldStartTime.minute;</span>
<a href="#l55.317"></a><span id="l55.317" class="difflineat">@@ -1681,18 +1681,18 @@ function onUpdateAllDay() {</span>
<a href="#l55.318"></a><span id="l55.318">             gEndTime.minute = gOldEndTime.minute;</span>
<a href="#l55.319"></a><span id="l55.319">             // When we restore 0:00 as end time, we need to add one day to</span>
<a href="#l55.320"></a><span id="l55.320">             // the end date in order to include the last day until midnight.</span>
<a href="#l55.321"></a><span id="l55.321">             if (gEndTime.hour == 0 &amp;&amp; gEndTime.minute == 0) {</span>
<a href="#l55.322"></a><span id="l55.322">                 gEndTime.day++;</span>
<a href="#l55.323"></a><span id="l55.323">             }</span>
<a href="#l55.324"></a><span id="l55.324">         }</span>
<a href="#l55.325"></a><span id="l55.325">     }</span>
<a href="#l55.326"></a><span id="l55.326" class="difflineminus">-    gStartTimezone = (allDay ? cal.floating() : gOldStartTimezone);</span>
<a href="#l55.327"></a><span id="l55.327" class="difflineminus">-    gEndTimezone = (allDay ? cal.floating() : gOldEndTimezone);</span>
<a href="#l55.328"></a><span id="l55.328" class="difflineplus">+    gStartTimezone = (allDay ? cal.dtz.floating : gOldStartTimezone);</span>
<a href="#l55.329"></a><span id="l55.329" class="difflineplus">+    gEndTimezone = (allDay ? cal.dtz.floating : gOldEndTimezone);</span>
<a href="#l55.330"></a><span id="l55.330">     setShowTimeAs(allDay);</span>
<a href="#l55.331"></a><span id="l55.331"> </span>
<a href="#l55.332"></a><span id="l55.332">     updateAllDay();</span>
<a href="#l55.333"></a><span id="l55.333"> }</span>
<a href="#l55.334"></a><span id="l55.334"> </span>
<a href="#l55.335"></a><span id="l55.335"> /**</span>
<a href="#l55.336"></a><span id="l55.336">  * This function sets the enabled/disabled state of the following controls:</span>
<a href="#l55.337"></a><span id="l55.337">  * - 'event-starttime'</span>
<a href="#l55.338"></a><span id="l55.338" class="difflineat">@@ -1784,17 +1784,17 @@ function editAttendees() {</span>
<a href="#l55.339"></a><span id="l55.339">                     organizer.commonName = null;</span>
<a href="#l55.340"></a><span id="l55.340">                 }</span>
<a href="#l55.341"></a><span id="l55.341">             }</span>
<a href="#l55.342"></a><span id="l55.342">             savedWindow.organizer = organizer;</span>
<a href="#l55.343"></a><span id="l55.343">         }</span>
<a href="#l55.344"></a><span id="l55.344">         let duration = endTime.subtractDate(startTime);</span>
<a href="#l55.345"></a><span id="l55.345">         startTime = startTime.clone();</span>
<a href="#l55.346"></a><span id="l55.346">         endTime = endTime.clone();</span>
<a href="#l55.347"></a><span id="l55.347" class="difflineminus">-        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.348"></a><span id="l55.348" class="difflineplus">+        let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.349"></a><span id="l55.349">         gStartTimezone = startTime.timezone;</span>
<a href="#l55.350"></a><span id="l55.350">         gEndTimezone = endTime.timezone;</span>
<a href="#l55.351"></a><span id="l55.351">         gStartTime = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.352"></a><span id="l55.352">         gEndTime = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.353"></a><span id="l55.353">         gItemDuration = duration;</span>
<a href="#l55.354"></a><span id="l55.354">         updateAttendees();</span>
<a href="#l55.355"></a><span id="l55.355">         updateDateTime();</span>
<a href="#l55.356"></a><span id="l55.356">         updateAllDay();</span>
<a href="#l55.357"></a><span id="l55.357" class="difflineat">@@ -2439,17 +2439,17 @@ function updateCalendar() {</span>
<a href="#l55.358"></a><span id="l55.358"> </span>
<a href="#l55.359"></a><span id="l55.359">         let collapseElements = document.getElementsByAttribute(&quot;collapse-on-readonly&quot;, &quot;true&quot;);</span>
<a href="#l55.360"></a><span id="l55.360">         for (let element of collapseElements) {</span>
<a href="#l55.361"></a><span id="l55.361">             element.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l55.362"></a><span id="l55.362">         }</span>
<a href="#l55.363"></a><span id="l55.363"> </span>
<a href="#l55.364"></a><span id="l55.364">         // Task completed date</span>
<a href="#l55.365"></a><span id="l55.365">         if (item.completedDate) {</span>
<a href="#l55.366"></a><span id="l55.366" class="difflineminus">-            updateToDoStatus(item.status, cal.dateTimeToJsDate(item.completedDate));</span>
<a href="#l55.367"></a><span id="l55.367" class="difflineplus">+            updateToDoStatus(item.status, cal.dtz.dateTimeToJsDate(item.completedDate));</span>
<a href="#l55.368"></a><span id="l55.368">         } else {</span>
<a href="#l55.369"></a><span id="l55.369">             updateToDoStatus(item.status);</span>
<a href="#l55.370"></a><span id="l55.370">         }</span>
<a href="#l55.371"></a><span id="l55.371"> </span>
<a href="#l55.372"></a><span id="l55.372">         // disable repeat menupopup if this is an occurrence</span>
<a href="#l55.373"></a><span id="l55.373">         item = window.calendarItem;</span>
<a href="#l55.374"></a><span id="l55.374">         if (item.parentItem != item) {</span>
<a href="#l55.375"></a><span id="l55.375">             disableElement(&quot;item-repeat&quot;);</span>
<a href="#l55.376"></a><span id="l55.376" class="difflineat">@@ -2578,17 +2578,17 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l55.377"></a><span id="l55.377"> </span>
<a href="#l55.378"></a><span id="l55.378">         // Assign gUntilDate on the first run or when returning from the</span>
<a href="#l55.379"></a><span id="l55.379">         // edit recurrence dialog.</span>
<a href="#l55.380"></a><span id="l55.380">         if (window.recurrenceInfo) {</span>
<a href="#l55.381"></a><span id="l55.381">             let rrules = splitRecurrenceRules(window.recurrenceInfo);</span>
<a href="#l55.382"></a><span id="l55.382">             let rule = rrules[0][0];</span>
<a href="#l55.383"></a><span id="l55.383">             gUntilDate = null;</span>
<a href="#l55.384"></a><span id="l55.384">             if (!rule.isByCount &amp;&amp; rule.isFinite) {</span>
<a href="#l55.385"></a><span id="l55.385" class="difflineminus">-                gUntilDate = rule.untilDate.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l55.386"></a><span id="l55.386" class="difflineplus">+                gUntilDate = rule.untilDate.clone().getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l55.387"></a><span id="l55.387">             }</span>
<a href="#l55.388"></a><span id="l55.388">         }</span>
<a href="#l55.389"></a><span id="l55.389"> </span>
<a href="#l55.390"></a><span id="l55.390">         // we need to address two separate cases here.</span>
<a href="#l55.391"></a><span id="l55.391">         // 1)- We need to revoke the selection of the repeat</span>
<a href="#l55.392"></a><span id="l55.392">         //     drop down list in case the user didn't specify</span>
<a href="#l55.393"></a><span id="l55.393">         //     a new repeat pattern (i.e. canceled the dialog);</span>
<a href="#l55.394"></a><span id="l55.394">         //   - re-enable the 'has entrydate' option in case</span>
<a href="#l55.395"></a><span id="l55.395" class="difflineat">@@ -2632,32 +2632,32 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l55.396"></a><span id="l55.396"> </span>
<a href="#l55.397"></a><span id="l55.397">             // If the previous rule was &quot;custom&quot; we have to recover the until</span>
<a href="#l55.398"></a><span id="l55.398">             // date, or the last occurrence's date in order to set the</span>
<a href="#l55.399"></a><span id="l55.399">             // repeat-until-datepicker with the same date.</span>
<a href="#l55.400"></a><span id="l55.400">             if (aItemRepeatCall &amp;&amp; repeatDeck.selectedIndex == 1) {</span>
<a href="#l55.401"></a><span id="l55.401">                 let repeatDate;</span>
<a href="#l55.402"></a><span id="l55.402">                 if (!rule.isByCount || !rule.isFinite) {</span>
<a href="#l55.403"></a><span id="l55.403">                     if (rule.isFinite) {</span>
<a href="#l55.404"></a><span id="l55.404" class="difflineminus">-                        repeatDate = rule.untilDate.getInTimezone(cal.floating());</span>
<a href="#l55.405"></a><span id="l55.405" class="difflineminus">-                        repeatDate = cal.dateTimeToJsDate(repeatDate);</span>
<a href="#l55.406"></a><span id="l55.406" class="difflineplus">+                        repeatDate = rule.untilDate.getInTimezone(cal.dtz.floating);</span>
<a href="#l55.407"></a><span id="l55.407" class="difflineplus">+                        repeatDate = cal.dtz.dateTimeToJsDate(repeatDate);</span>
<a href="#l55.408"></a><span id="l55.408">                     } else {</span>
<a href="#l55.409"></a><span id="l55.409">                         repeatDate = &quot;forever&quot;;</span>
<a href="#l55.410"></a><span id="l55.410">                     }</span>
<a href="#l55.411"></a><span id="l55.411">                 } else {</span>
<a href="#l55.412"></a><span id="l55.412">                     // Try to recover the last occurrence in 10(?) years.</span>
<a href="#l55.413"></a><span id="l55.413">                     let endDate = gStartTime.clone();</span>
<a href="#l55.414"></a><span id="l55.414">                     endDate.year += 10;</span>
<a href="#l55.415"></a><span id="l55.415">                     let lastOccurrenceDate = null;</span>
<a href="#l55.416"></a><span id="l55.416">                     let dates = recurrenceInfo.getOccurrenceDates(gStartTime, endDate, 0, {});</span>
<a href="#l55.417"></a><span id="l55.417">                     if (dates) {</span>
<a href="#l55.418"></a><span id="l55.418">                         lastOccurrenceDate = dates[dates.length - 1];</span>
<a href="#l55.419"></a><span id="l55.419">                     }</span>
<a href="#l55.420"></a><span id="l55.420" class="difflineminus">-                    repeatDate = (lastOccurrenceDate || proposedUntilDate).getInTimezone(cal.floating());</span>
<a href="#l55.421"></a><span id="l55.421" class="difflineminus">-                    repeatDate = cal.dateTimeToJsDate(repeatDate);</span>
<a href="#l55.422"></a><span id="l55.422" class="difflineplus">+                    repeatDate = (lastOccurrenceDate || proposedUntilDate).getInTimezone(cal.dtz.floating);</span>
<a href="#l55.423"></a><span id="l55.423" class="difflineplus">+                    repeatDate = cal.dtz.dateTimeToJsDate(repeatDate);</span>
<a href="#l55.424"></a><span id="l55.424">                 }</span>
<a href="#l55.425"></a><span id="l55.425">                 setElementValue(&quot;repeat-until-datepicker&quot;, repeatDate);</span>
<a href="#l55.426"></a><span id="l55.426">             }</span>
<a href="#l55.427"></a><span id="l55.427">             if (rrules[0].length &gt; 0) {</span>
<a href="#l55.428"></a><span id="l55.428">                 recurrenceInfo.deleteRecurrenceItem(rule);</span>
<a href="#l55.429"></a><span id="l55.429">             }</span>
<a href="#l55.430"></a><span id="l55.430">         } else {</span>
<a href="#l55.431"></a><span id="l55.431">             // New event proposes &quot;forever&quot; as default until date.</span>
<a href="#l55.432"></a><span id="l55.432" class="difflineat">@@ -2701,17 +2701,17 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l55.433"></a><span id="l55.433">         if (cal.isToDo(item)) {</span>
<a href="#l55.434"></a><span id="l55.434">             if (!getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;)) {</span>
<a href="#l55.435"></a><span id="l55.435">                 setElementValue(&quot;todo-has-entrydate&quot;, &quot;true&quot;, &quot;checked&quot;);</span>
<a href="#l55.436"></a><span id="l55.436">             }</span>
<a href="#l55.437"></a><span id="l55.437">             disableElementWithLock(&quot;todo-has-entrydate&quot;, &quot;repeat-lock&quot;);</span>
<a href="#l55.438"></a><span id="l55.438">         }</span>
<a href="#l55.439"></a><span id="l55.439"> </span>
<a href="#l55.440"></a><span id="l55.440">         // Preset the until-datepicker's minimonth to the start date.</span>
<a href="#l55.441"></a><span id="l55.441" class="difflineminus">-        let startDate = cal.dateTimeToJsDate(gStartTime.getInTimezone(cal.floating()));</span>
<a href="#l55.442"></a><span id="l55.442" class="difflineplus">+        let startDate = cal.dtz.dateTimeToJsDate(gStartTime.getInTimezone(cal.dtz.floating));</span>
<a href="#l55.443"></a><span id="l55.443">         document.getElementById(&quot;repeat-until-datepicker&quot;).extraDate = startDate;</span>
<a href="#l55.444"></a><span id="l55.444">     }</span>
<a href="#l55.445"></a><span id="l55.445"> </span>
<a href="#l55.446"></a><span id="l55.446">     gLastRepeatSelection = repeatMenu.selectedIndex;</span>
<a href="#l55.447"></a><span id="l55.447">     repeatMenu.setAttribute(&quot;last-value&quot;, repeatValue);</span>
<a href="#l55.448"></a><span id="l55.448"> </span>
<a href="#l55.449"></a><span id="l55.449">     updateRepeatDetails();</span>
<a href="#l55.450"></a><span id="l55.450">     updateEntryDate();</span>
<a href="#l55.451"></a><span id="l55.451" class="difflineat">@@ -2729,28 +2729,28 @@ function updateUntildateRecRule(recRule)</span>
<a href="#l55.452"></a><span id="l55.452">     if (!recRule) {</span>
<a href="#l55.453"></a><span id="l55.453">         let recurrenceInfo = window.recurrenceInfo;</span>
<a href="#l55.454"></a><span id="l55.454">         if (!recurrenceInfo) {</span>
<a href="#l55.455"></a><span id="l55.455">             return;</span>
<a href="#l55.456"></a><span id="l55.456">         }</span>
<a href="#l55.457"></a><span id="l55.457">         let rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l55.458"></a><span id="l55.458">         recRule = rrules[0][0];</span>
<a href="#l55.459"></a><span id="l55.459">     }</span>
<a href="#l55.460"></a><span id="l55.460" class="difflineminus">-    let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.461"></a><span id="l55.461" class="difflineplus">+    let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.462"></a><span id="l55.462">     let repeatUntilDate = null;</span>
<a href="#l55.463"></a><span id="l55.463"> </span>
<a href="#l55.464"></a><span id="l55.464">     let itemRepeat = document.getElementById(&quot;item-repeat&quot;).selectedItem.value;</span>
<a href="#l55.465"></a><span id="l55.465">     if (itemRepeat == &quot;none&quot;) {</span>
<a href="#l55.466"></a><span id="l55.466">         return;</span>
<a href="#l55.467"></a><span id="l55.467">     } else if (itemRepeat == &quot;custom&quot;) {</span>
<a href="#l55.468"></a><span id="l55.468">         repeatUntilDate = gUntilDate;</span>
<a href="#l55.469"></a><span id="l55.469">     } else {</span>
<a href="#l55.470"></a><span id="l55.470">         let untilDatepickerDate = getElementValue(&quot;repeat-until-datepicker&quot;);</span>
<a href="#l55.471"></a><span id="l55.471">         if (untilDatepickerDate != &quot;forever&quot;) {</span>
<a href="#l55.472"></a><span id="l55.472" class="difflineminus">-            repeatUntilDate = cal.jsDateToDateTime(untilDatepickerDate, defaultTimezone);</span>
<a href="#l55.473"></a><span id="l55.473" class="difflineplus">+            repeatUntilDate = cal.dtz.jsDateToDateTime(untilDatepickerDate, defaultTimezone);</span>
<a href="#l55.474"></a><span id="l55.474">         }</span>
<a href="#l55.475"></a><span id="l55.475">     }</span>
<a href="#l55.476"></a><span id="l55.476"> </span>
<a href="#l55.477"></a><span id="l55.477">     if (repeatUntilDate) {</span>
<a href="#l55.478"></a><span id="l55.478">         if (onLoad.hasLoaded) {</span>
<a href="#l55.479"></a><span id="l55.479">             repeatUntilDate.isDate = gStartTime.isDate; // Enforce same value type as DTSTART</span>
<a href="#l55.480"></a><span id="l55.480">             if (!gStartTime.isDate) {</span>
<a href="#l55.481"></a><span id="l55.481">                 repeatUntilDate.hour = gStartTime.hour;</span>
<a href="#l55.482"></a><span id="l55.482" class="difflineat">@@ -3158,18 +3158,18 @@ function showTimezonePopup(event, dateTi</span>
<a href="#l55.483"></a><span id="l55.483">     // the opening node is disabled.</span>
<a href="#l55.484"></a><span id="l55.484">     if (event.button != 0 || event.target.disabled) {</span>
<a href="#l55.485"></a><span id="l55.485">         return;</span>
<a href="#l55.486"></a><span id="l55.486">     }</span>
<a href="#l55.487"></a><span id="l55.487"> </span>
<a href="#l55.488"></a><span id="l55.488">     let timezonePopup = document.getElementById(&quot;timezone-popup&quot;);</span>
<a href="#l55.489"></a><span id="l55.489">     let timezoneDefaultItem = document.getElementById(&quot;timezone-popup-defaulttz&quot;);</span>
<a href="#l55.490"></a><span id="l55.490">     let timezoneSeparator = document.getElementById(&quot;timezone-popup-menuseparator&quot;);</span>
<a href="#l55.491"></a><span id="l55.491" class="difflineminus">-    let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.492"></a><span id="l55.492" class="difflineminus">-    let recentTimezones = cal.getRecentTimezones(true);</span>
<a href="#l55.493"></a><span id="l55.493" class="difflineplus">+    let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.494"></a><span id="l55.494" class="difflineplus">+    let recentTimezones = cal.dtz.getRecentTimezones(true);</span>
<a href="#l55.495"></a><span id="l55.495"> </span>
<a href="#l55.496"></a><span id="l55.496">     // Set up the right editTimezone function, so the custom item can use it.</span>
<a href="#l55.497"></a><span id="l55.497">     timezonePopup.editTimezone = editFunc;</span>
<a href="#l55.498"></a><span id="l55.498">     timezonePopup.dateTime = dateTime;</span>
<a href="#l55.499"></a><span id="l55.499"> </span>
<a href="#l55.500"></a><span id="l55.500">     // Set up the default timezone item</span>
<a href="#l55.501"></a><span id="l55.501">     timezoneDefaultItem.value = defaultTimezone.tzid;</span>
<a href="#l55.502"></a><span id="l55.502">     timezoneDefaultItem.label = defaultTimezone.displayName;</span>
<a href="#l55.503"></a><span id="l55.503" class="difflineat">@@ -3205,17 +3205,17 @@ function editTimezone(aElementId, aDateT</span>
<a href="#l55.504"></a><span id="l55.504">         return;</span>
<a href="#l55.505"></a><span id="l55.505">     }</span>
<a href="#l55.506"></a><span id="l55.506"> </span>
<a href="#l55.507"></a><span id="l55.507">     // prepare the arguments that will be passed to the dialog</span>
<a href="#l55.508"></a><span id="l55.508">     let args = {};</span>
<a href="#l55.509"></a><span id="l55.509">     args.time = aDateTime;</span>
<a href="#l55.510"></a><span id="l55.510">     args.calendar = getCurrentCalendar();</span>
<a href="#l55.511"></a><span id="l55.511">     args.onOk = function(datetime) {</span>
<a href="#l55.512"></a><span id="l55.512" class="difflineminus">-        cal.saveRecentTimezone(datetime.timezone.tzid);</span>
<a href="#l55.513"></a><span id="l55.513" class="difflineplus">+        cal.dtz.saveRecentTimezone(datetime.timezone.tzid);</span>
<a href="#l55.514"></a><span id="l55.514">         return aCallback(datetime);</span>
<a href="#l55.515"></a><span id="l55.515">     };</span>
<a href="#l55.516"></a><span id="l55.516"> </span>
<a href="#l55.517"></a><span id="l55.517">     // open the dialog modally</span>
<a href="#l55.518"></a><span id="l55.518">     openDialog(</span>
<a href="#l55.519"></a><span id="l55.519">         &quot;chrome://calendar/content/calendar-event-dialog-timezone.xul&quot;,</span>
<a href="#l55.520"></a><span id="l55.520">         &quot;_blank&quot;,</span>
<a href="#l55.521"></a><span id="l55.521">         &quot;chrome,titlebar,modal,resizable&quot;,</span>
<a href="#l55.522"></a><span id="l55.522" class="difflineat">@@ -3262,113 +3262,113 @@ function updateDateTime() {</span>
<a href="#l55.523"></a><span id="l55.523">                         endTime = endTime.getInTimezone(startTime.timezone);</span>
<a href="#l55.524"></a><span id="l55.524">                     }</span>
<a href="#l55.525"></a><span id="l55.525">                 }</span>
<a href="#l55.526"></a><span id="l55.526">             }</span>
<a href="#l55.527"></a><span id="l55.527"> </span>
<a href="#l55.528"></a><span id="l55.528">             // before feeding the date/time value into the control we need</span>
<a href="#l55.529"></a><span id="l55.529">             // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l55.530"></a><span id="l55.530">             // automatic conversion back into the OS timezone.</span>
<a href="#l55.531"></a><span id="l55.531" class="difflineminus">-            startTime.timezone = cal.floating();</span>
<a href="#l55.532"></a><span id="l55.532" class="difflineminus">-            endTime.timezone = cal.floating();</span>
<a href="#l55.533"></a><span id="l55.533" class="difflineminus">-</span>
<a href="#l55.534"></a><span id="l55.534" class="difflineminus">-            setElementValue(&quot;event-starttime&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.535"></a><span id="l55.535" class="difflineminus">-            setElementValue(&quot;event-endtime&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.536"></a><span id="l55.536" class="difflineplus">+            startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.537"></a><span id="l55.537" class="difflineplus">+            endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.538"></a><span id="l55.538" class="difflineplus">+</span>
<a href="#l55.539"></a><span id="l55.539" class="difflineplus">+            setElementValue(&quot;event-starttime&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.540"></a><span id="l55.540" class="difflineplus">+            setElementValue(&quot;event-endtime&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.541"></a><span id="l55.541">         }</span>
<a href="#l55.542"></a><span id="l55.542"> </span>
<a href="#l55.543"></a><span id="l55.543">         if (cal.isToDo(item)) {</span>
<a href="#l55.544"></a><span id="l55.544">             let startTime = gStartTime &amp;&amp; gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l55.545"></a><span id="l55.545">             let endTime = gEndTime &amp;&amp; gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l55.546"></a><span id="l55.546">             let hasEntryDate = (startTime != null);</span>
<a href="#l55.547"></a><span id="l55.547">             let hasDueDate = (endTime != null);</span>
<a href="#l55.548"></a><span id="l55.548"> </span>
<a href="#l55.549"></a><span id="l55.549">             if (hasEntryDate &amp;&amp; hasDueDate) {</span>
<a href="#l55.550"></a><span id="l55.550">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l55.551"></a><span id="l55.551" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.552"></a><span id="l55.552" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.553"></a><span id="l55.553" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.554"></a><span id="l55.554" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.555"></a><span id="l55.555"> </span>
<a href="#l55.556"></a><span id="l55.556">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l55.557"></a><span id="l55.557" class="difflineminus">-                endTime.timezone = cal.floating();</span>
<a href="#l55.558"></a><span id="l55.558" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.559"></a><span id="l55.559" class="difflineplus">+                endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.560"></a><span id="l55.560" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.561"></a><span id="l55.561">             } else if (hasEntryDate) {</span>
<a href="#l55.562"></a><span id="l55.562">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l55.563"></a><span id="l55.563" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.564"></a><span id="l55.564" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.565"></a><span id="l55.565" class="difflineminus">-</span>
<a href="#l55.566"></a><span id="l55.566" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.567"></a><span id="l55.567" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.568"></a><span id="l55.568" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.569"></a><span id="l55.569" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.570"></a><span id="l55.570" class="difflineplus">+</span>
<a href="#l55.571"></a><span id="l55.571" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.572"></a><span id="l55.572" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.573"></a><span id="l55.573">             } else if (hasDueDate) {</span>
<a href="#l55.574"></a><span id="l55.574" class="difflineminus">-                endTime.timezone = cal.floating();</span>
<a href="#l55.575"></a><span id="l55.575" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.576"></a><span id="l55.576" class="difflineplus">+                endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.577"></a><span id="l55.577" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.578"></a><span id="l55.578"> </span>
<a href="#l55.579"></a><span id="l55.579">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l55.580"></a><span id="l55.580" class="difflineminus">-                endTime.timezone = cal.floating();</span>
<a href="#l55.581"></a><span id="l55.581" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.582"></a><span id="l55.582" class="difflineplus">+                endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.583"></a><span id="l55.583" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.584"></a><span id="l55.584">             } else {</span>
<a href="#l55.585"></a><span id="l55.585">                 startTime = window.initialStartDateValue;</span>
<a href="#l55.586"></a><span id="l55.586" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.587"></a><span id="l55.587" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.588"></a><span id="l55.588">                 endTime = startTime.clone();</span>
<a href="#l55.589"></a><span id="l55.589"> </span>
<a href="#l55.590"></a><span id="l55.590" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.591"></a><span id="l55.591" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.592"></a><span id="l55.592" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.593"></a><span id="l55.593" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.594"></a><span id="l55.594">             }</span>
<a href="#l55.595"></a><span id="l55.595">         }</span>
<a href="#l55.596"></a><span id="l55.596">     } else {</span>
<a href="#l55.597"></a><span id="l55.597" class="difflineminus">-        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.598"></a><span id="l55.598" class="difflineplus">+        let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.599"></a><span id="l55.599"> </span>
<a href="#l55.600"></a><span id="l55.600">         if (cal.isEvent(item)) {</span>
<a href="#l55.601"></a><span id="l55.601">             let startTime = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.602"></a><span id="l55.602">             let endTime = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.603"></a><span id="l55.603">             setElementValue(&quot;event-all-day&quot;, startTime.isDate, &quot;checked&quot;);</span>
<a href="#l55.604"></a><span id="l55.604"> </span>
<a href="#l55.605"></a><span id="l55.605">             // before feeding the date/time value into the control we need</span>
<a href="#l55.606"></a><span id="l55.606">             // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l55.607"></a><span id="l55.607">             // automatic conversion back into the OS timezone.</span>
<a href="#l55.608"></a><span id="l55.608" class="difflineminus">-            startTime.timezone = cal.floating();</span>
<a href="#l55.609"></a><span id="l55.609" class="difflineminus">-            endTime.timezone = cal.floating();</span>
<a href="#l55.610"></a><span id="l55.610" class="difflineminus">-            setElementValue(&quot;event-starttime&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.611"></a><span id="l55.611" class="difflineminus">-            setElementValue(&quot;event-endtime&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.612"></a><span id="l55.612" class="difflineplus">+            startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.613"></a><span id="l55.613" class="difflineplus">+            endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.614"></a><span id="l55.614" class="difflineplus">+            setElementValue(&quot;event-starttime&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.615"></a><span id="l55.615" class="difflineplus">+            setElementValue(&quot;event-endtime&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.616"></a><span id="l55.616">         }</span>
<a href="#l55.617"></a><span id="l55.617"> </span>
<a href="#l55.618"></a><span id="l55.618">         if (cal.isToDo(item)) {</span>
<a href="#l55.619"></a><span id="l55.619">             let startTime = gStartTime &amp;&amp;</span>
<a href="#l55.620"></a><span id="l55.620">                             gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.621"></a><span id="l55.621">             let endTime = gEndTime &amp;&amp; gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l55.622"></a><span id="l55.622">             let hasEntryDate = (startTime != null);</span>
<a href="#l55.623"></a><span id="l55.623">             let hasDueDate = (endTime != null);</span>
<a href="#l55.624"></a><span id="l55.624"> </span>
<a href="#l55.625"></a><span id="l55.625">             if (hasEntryDate &amp;&amp; hasDueDate) {</span>
<a href="#l55.626"></a><span id="l55.626">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l55.627"></a><span id="l55.627" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.628"></a><span id="l55.628" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.629"></a><span id="l55.629" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.630"></a><span id="l55.630" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.631"></a><span id="l55.631"> </span>
<a href="#l55.632"></a><span id="l55.632">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l55.633"></a><span id="l55.633" class="difflineminus">-                endTime.timezone = cal.floating();</span>
<a href="#l55.634"></a><span id="l55.634" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.635"></a><span id="l55.635" class="difflineplus">+                endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.636"></a><span id="l55.636" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.637"></a><span id="l55.637">             } else if (hasEntryDate) {</span>
<a href="#l55.638"></a><span id="l55.638">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l55.639"></a><span id="l55.639" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.640"></a><span id="l55.640" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.641"></a><span id="l55.641" class="difflineminus">-</span>
<a href="#l55.642"></a><span id="l55.642" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.643"></a><span id="l55.643" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.644"></a><span id="l55.644" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.645"></a><span id="l55.645" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.646"></a><span id="l55.646" class="difflineplus">+</span>
<a href="#l55.647"></a><span id="l55.647" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.648"></a><span id="l55.648" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.649"></a><span id="l55.649">             } else if (hasDueDate) {</span>
<a href="#l55.650"></a><span id="l55.650" class="difflineminus">-                endTime.timezone = cal.floating();</span>
<a href="#l55.651"></a><span id="l55.651" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.652"></a><span id="l55.652" class="difflineplus">+                endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.653"></a><span id="l55.653" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.654"></a><span id="l55.654"> </span>
<a href="#l55.655"></a><span id="l55.655">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l55.656"></a><span id="l55.656" class="difflineminus">-                endTime.timezone = cal.floating();</span>
<a href="#l55.657"></a><span id="l55.657" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.658"></a><span id="l55.658" class="difflineplus">+                endTime.timezone = cal.dtz.floating;</span>
<a href="#l55.659"></a><span id="l55.659" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.660"></a><span id="l55.660">             } else {</span>
<a href="#l55.661"></a><span id="l55.661">                 startTime = window.initialStartDateValue;</span>
<a href="#l55.662"></a><span id="l55.662" class="difflineminus">-                startTime.timezone = cal.floating();</span>
<a href="#l55.663"></a><span id="l55.663" class="difflineplus">+                startTime.timezone = cal.dtz.floating;</span>
<a href="#l55.664"></a><span id="l55.664">                 endTime = startTime.clone();</span>
<a href="#l55.665"></a><span id="l55.665"> </span>
<a href="#l55.666"></a><span id="l55.666" class="difflineminus">-                setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l55.667"></a><span id="l55.667" class="difflineminus">-                setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l55.668"></a><span id="l55.668" class="difflineplus">+                setElementValue(&quot;todo-entrydate&quot;, cal.dtz.dateTimeToJsDate(startTime));</span>
<a href="#l55.669"></a><span id="l55.669" class="difflineplus">+                setElementValue(&quot;todo-duedate&quot;, cal.dtz.dateTimeToJsDate(endTime));</span>
<a href="#l55.670"></a><span id="l55.670">             }</span>
<a href="#l55.671"></a><span id="l55.671">         }</span>
<a href="#l55.672"></a><span id="l55.672">     }</span>
<a href="#l55.673"></a><span id="l55.673"> </span>
<a href="#l55.674"></a><span id="l55.674">     updateTimezone();</span>
<a href="#l55.675"></a><span id="l55.675">     updateAllDay();</span>
<a href="#l55.676"></a><span id="l55.676">     updateRepeatDetails();</span>
<a href="#l55.677"></a><span id="l55.677"> </span>
<a href="#l55.678"></a><span id="l55.678" class="difflineat">@@ -3575,23 +3575,23 @@ function updateRepeatDetails() {</span>
<a href="#l55.679"></a><span id="l55.679">         // First of all collapse the details text. If we fail to</span>
<a href="#l55.680"></a><span id="l55.680">         // create a details string, we simply don't show anything.</span>
<a href="#l55.681"></a><span id="l55.681">         // this could happen if the repeat rule is something exotic</span>
<a href="#l55.682"></a><span id="l55.682">         // we don't have any strings prepared for.</span>
<a href="#l55.683"></a><span id="l55.683">         let repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l55.684"></a><span id="l55.684">         repeatDetails.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l55.685"></a><span id="l55.685"> </span>
<a href="#l55.686"></a><span id="l55.686">         // Try to create a descriptive string from the rule(s).</span>
<a href="#l55.687"></a><span id="l55.687" class="difflineminus">-        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l55.688"></a><span id="l55.688" class="difflineplus">+        let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l55.689"></a><span id="l55.689">         let event = cal.isEvent(item);</span>
<a href="#l55.690"></a><span id="l55.690"> </span>
<a href="#l55.691"></a><span id="l55.691">         let startDate = getElementValue(event ? &quot;event-starttime&quot; : &quot;todo-entrydate&quot;);</span>
<a href="#l55.692"></a><span id="l55.692">         let endDate = getElementValue(event ? &quot;event-endtime&quot; : &quot;todo-duedate&quot;);</span>
<a href="#l55.693"></a><span id="l55.693" class="difflineminus">-        startDate = cal.jsDateToDateTime(startDate, kDefaultTimezone);</span>
<a href="#l55.694"></a><span id="l55.694" class="difflineminus">-        endDate = cal.jsDateToDateTime(endDate, kDefaultTimezone);</span>
<a href="#l55.695"></a><span id="l55.695" class="difflineplus">+        startDate = cal.dtz.jsDateToDateTime(startDate, kDefaultTimezone);</span>
<a href="#l55.696"></a><span id="l55.696" class="difflineplus">+        endDate = cal.dtz.jsDateToDateTime(endDate, kDefaultTimezone);</span>
<a href="#l55.697"></a><span id="l55.697"> </span>
<a href="#l55.698"></a><span id="l55.698">         let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l55.699"></a><span id="l55.699">         let detailsString = recurrenceRule2String(recurrenceInfo, startDate,</span>
<a href="#l55.700"></a><span id="l55.700">                                                   endDate, allDay);</span>
<a href="#l55.701"></a><span id="l55.701"> </span>
<a href="#l55.702"></a><span id="l55.702">         if (!detailsString) {</span>
<a href="#l55.703"></a><span id="l55.703">             detailsString = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;ruleTooComplex&quot;);</span>
<a href="#l55.704"></a><span id="l55.704">         }</span>
<a href="#l55.705"></a><span id="l55.705" class="difflineat">@@ -3814,24 +3814,24 @@ function checkUntilDate() {</span>
<a href="#l55.706"></a><span id="l55.706">     let repeatUntilDate = getElementValue(&quot;repeat-until-datepicker&quot;);</span>
<a href="#l55.707"></a><span id="l55.707">     if (repeatUntilDate == &quot;forever&quot;) {</span>
<a href="#l55.708"></a><span id="l55.708">         updateRepeat();</span>
<a href="#l55.709"></a><span id="l55.709">         // &quot;forever&quot; is never earlier than another date.</span>
<a href="#l55.710"></a><span id="l55.710">         return;</span>
<a href="#l55.711"></a><span id="l55.711">     }</span>
<a href="#l55.712"></a><span id="l55.712"> </span>
<a href="#l55.713"></a><span id="l55.713">     // Check whether the date is valid. Set the correct time just in this case.</span>
<a href="#l55.714"></a><span id="l55.714" class="difflineminus">-    let untilDate = cal.jsDateToDateTime(repeatUntilDate, gStartTime.timezone);</span>
<a href="#l55.715"></a><span id="l55.715" class="difflineplus">+    let untilDate = cal.dtz.jsDateToDateTime(repeatUntilDate, gStartTime.timezone);</span>
<a href="#l55.716"></a><span id="l55.716">     let startDate = gStartTime.clone();</span>
<a href="#l55.717"></a><span id="l55.717">     startDate.isDate = true;</span>
<a href="#l55.718"></a><span id="l55.718">     if (untilDate.compare(startDate) &lt; 0) {</span>
<a href="#l55.719"></a><span id="l55.719">         // Invalid date: restore the previous date. Since we are checking an</span>
<a href="#l55.720"></a><span id="l55.720">         // until date, a null value for gUntilDate means repeat &quot;forever&quot;.</span>
<a href="#l55.721"></a><span id="l55.721">         setElementValue(&quot;repeat-until-datepicker&quot;,</span>
<a href="#l55.722"></a><span id="l55.722" class="difflineminus">-                        gUntilDate ? cal.dateTimeToJsDate(gUntilDate.getInTimezone(cal.floating()))</span>
<a href="#l55.723"></a><span id="l55.723" class="difflineplus">+                        gUntilDate ? cal.dtz.dateTimeToJsDate(gUntilDate.getInTimezone(cal.dtz.floating))</span>
<a href="#l55.724"></a><span id="l55.724">                                    : &quot;forever&quot;);</span>
<a href="#l55.725"></a><span id="l55.725">         gWarning = true;</span>
<a href="#l55.726"></a><span id="l55.726">         let callback = function() {</span>
<a href="#l55.727"></a><span id="l55.727">             // Disable the &quot;Save&quot; and &quot;Save and Close&quot; commands as long as the</span>
<a href="#l55.728"></a><span id="l55.728">             // warning dialog is showed.</span>
<a href="#l55.729"></a><span id="l55.729">             enableAcceptCommand(false);</span>
<a href="#l55.730"></a><span id="l55.730"> </span>
<a href="#l55.731"></a><span id="l55.731">             Services.prompt.alert(</span>
<a href="#l55.732"></a><span id="l55.732" class="difflineat">@@ -3976,17 +3976,17 @@ function lookupCounterLabel(aProperty) {</span>
<a href="#l55.733"></a><span id="l55.733">  * @returns {String|null}             The value to display or null if the property is not supported</span>
<a href="#l55.734"></a><span id="l55.734">  */</span>
<a href="#l55.735"></a><span id="l55.735"> function formatCounterValue(aProperty) {</span>
<a href="#l55.736"></a><span id="l55.736">     const dateProps = [&quot;DTSTART&quot;, &quot;DTEND&quot;];</span>
<a href="#l55.737"></a><span id="l55.737">     const stringProps = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;];</span>
<a href="#l55.738"></a><span id="l55.738"> </span>
<a href="#l55.739"></a><span id="l55.739">     let val;</span>
<a href="#l55.740"></a><span id="l55.740">     if (dateProps.includes(aProperty.property)) {</span>
<a href="#l55.741"></a><span id="l55.741" class="difflineminus">-        let localTime = aProperty.proposed.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l55.742"></a><span id="l55.742" class="difflineplus">+        let localTime = aProperty.proposed.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l55.743"></a><span id="l55.743">         let formatter = cal.getDateFormatter();</span>
<a href="#l55.744"></a><span id="l55.744">         val = formatter.formatDateTime(localTime);</span>
<a href="#l55.745"></a><span id="l55.745">         if (gTimezonesEnabled) {</span>
<a href="#l55.746"></a><span id="l55.746">             let tzone = localTime.timezone.displayName || localTime.timezone.tzid;</span>
<a href="#l55.747"></a><span id="l55.747">             val += &quot; &quot; + tzone;</span>
<a href="#l55.748"></a><span id="l55.748">         }</span>
<a href="#l55.749"></a><span id="l55.749">     } else if (stringProps.includes(aProperty.property)) {</span>
<a href="#l55.750"></a><span id="l55.750">         val = aProperty.proposed;</span>
<a href="#l55.751"></a><span id="l55.751" class="difflineat">@@ -4030,16 +4030,16 @@ function applyValues(aType) {</span>
<a href="#l55.752"></a><span id="l55.752">     }</span>
<a href="#l55.753"></a><span id="l55.753">     let nodeIds = getPropertyMap();</span>
<a href="#l55.754"></a><span id="l55.754">     window.counterProposal.proposal.forEach(aProperty =&gt; {</span>
<a href="#l55.755"></a><span id="l55.755">         if (aProperty.property != &quot;COMMENT&quot;) {</span>
<a href="#l55.756"></a><span id="l55.756">             let valueNode = nodeIds.has(aProperty.property) &amp;&amp;</span>
<a href="#l55.757"></a><span id="l55.757">                             document.getElementById(nodeIds.get(aProperty.property));</span>
<a href="#l55.758"></a><span id="l55.758">             if (valueNode) {</span>
<a href="#l55.759"></a><span id="l55.759">                 if ([&quot;DTSTART&quot;, &quot;DTEND&quot;].includes(aProperty.property)) {</span>
<a href="#l55.760"></a><span id="l55.760" class="difflineminus">-                    valueNode.value = cal.dateTimeToJsDate(aProperty[aType]);</span>
<a href="#l55.761"></a><span id="l55.761" class="difflineplus">+                    valueNode.value = cal.dtz.dateTimeToJsDate(aProperty[aType]);</span>
<a href="#l55.762"></a><span id="l55.762">                 } else {</span>
<a href="#l55.763"></a><span id="l55.763">                     valueNode.value = aProperty[aType];</span>
<a href="#l55.764"></a><span id="l55.764">                 }</span>
<a href="#l55.765"></a><span id="l55.765">             }</span>
<a href="#l55.766"></a><span id="l55.766">         }</span>
<a href="#l55.767"></a><span id="l55.767">     });</span>
<a href="#l55.768"></a><span id="l55.768"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -327,17 +327,17 @@ var calendarItemTabType = {</span>
<a href="#l56.4"></a><span id="l56.4">      * @param {Object} aTabmail  The tabmail interface</span>
<a href="#l56.5"></a><span id="l56.5">      * @param {Object} aState    The state of the tab to restore</span>
<a href="#l56.6"></a><span id="l56.6">      */</span>
<a href="#l56.7"></a><span id="l56.7">     restoreTab: function(aTabmail, aState) {</span>
<a href="#l56.8"></a><span id="l56.8">         // Sometimes restoreTab is called for tabs that were never saved</span>
<a href="#l56.9"></a><span id="l56.9">         // and never meant to be persisted or restored. See persistTab.</span>
<a href="#l56.10"></a><span id="l56.10">         if (aState.args &amp;&amp; aState.calendarId &amp;&amp; aState.itemId) {</span>
<a href="#l56.11"></a><span id="l56.11">             aState.args.initialStartDateValue = aState.initialStartDate</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-                ? cal.createDateTime(aState.initialStartDate) : cal.getDefaultStartDate();</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+                ? cal.createDateTime(aState.initialStartDate) : cal.dtz.getDefaultStartDate();</span>
<a href="#l56.14"></a><span id="l56.14"> </span>
<a href="#l56.15"></a><span id="l56.15">             aState.args.onOk = doTransaction.bind(null, &quot;modify&quot;);</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17">             aState.args.calendar = cal.getCalendarManager().getCalendarById(aState.calendarId);</span>
<a href="#l56.18"></a><span id="l56.18">             if (aState.args.calendar) {</span>
<a href="#l56.19"></a><span id="l56.19">                 // using wrappedJSObject is a hack that is needed to prevent a proxy error</span>
<a href="#l56.20"></a><span id="l56.20">                 let pcal = cal.async.promisifyCalendar(aState.args.calendar.wrappedJSObject);</span>
<a href="#l56.21"></a><span id="l56.21">                 pcal.getItem(aState.itemId).then((item) =&gt; {</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineat">@@ -549,17 +549,17 @@ function refreshUIBits() {</span>
<a href="#l56.23"></a><span id="l56.23">         ];</span>
<a href="#l56.24"></a><span id="l56.24">         for (let view of views) {</span>
<a href="#l56.25"></a><span id="l56.25">             if (view != currView.id) {</span>
<a href="#l56.26"></a><span id="l56.26">                 document.getElementById(view).mToggleStatus = -1;</span>
<a href="#l56.27"></a><span id="l56.27">             }</span>
<a href="#l56.28"></a><span id="l56.28">         }</span>
<a href="#l56.29"></a><span id="l56.29"> </span>
<a href="#l56.30"></a><span id="l56.30">         if (!TodayPane.showsToday()) {</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-            TodayPane.setDay(cal.now());</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineplus">+            TodayPane.setDay(cal.dtz.now());</span>
<a href="#l56.33"></a><span id="l56.33">         }</span>
<a href="#l56.34"></a><span id="l56.34"> </span>
<a href="#l56.35"></a><span id="l56.35">         // update the unifinder</span>
<a href="#l56.36"></a><span id="l56.36">         refreshEventTree();</span>
<a href="#l56.37"></a><span id="l56.37"> </span>
<a href="#l56.38"></a><span id="l56.38">         // update today's date on todaypane button</span>
<a href="#l56.39"></a><span id="l56.39">         document.getElementById(&quot;calendar-status-todaypane-button&quot;).setUpTodayDate();</span>
<a href="#l56.40"></a><span id="l56.40">     } catch (exc) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.xul</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.xul</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -78,17 +78,17 @@</span>
<a href="#l57.4"></a><span id="l57.4">       &lt;command id=&quot;switch2task&quot;</span>
<a href="#l57.5"></a><span id="l57.5">                oncommand=&quot;document.getElementById('tabmail').openTab('tasks', { title: document.getElementById('task-tab-button').getAttribute('title') })&quot;/&gt;</span>
<a href="#l57.6"></a><span id="l57.6">       &lt;command id=&quot;new_calendar_tab&quot;</span>
<a href="#l57.7"></a><span id="l57.7">                oncommand=&quot;document.getElementById('tabmail').openTab('calendar', { title: document.getElementById('calendar-tab-button').getAttribute('title') })&quot;/&gt;</span>
<a href="#l57.8"></a><span id="l57.8">       &lt;command id=&quot;new_task_tab&quot;</span>
<a href="#l57.9"></a><span id="l57.9">                oncommand=&quot;document.getElementById('tabmail').openTab('tasks', { title: document.getElementById('task-tab-button').getAttribute('title') })&quot;/&gt;</span>
<a href="#l57.10"></a><span id="l57.10">       &lt;command id=&quot;calendar_go_to_today_command&quot;</span>
<a href="#l57.11"></a><span id="l57.11">                observes=&quot;calendar_mode_calendar&quot;</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-               oncommand=&quot;document.getElementById('tabmail').openTab('calendar', { title: document.getElementById('calendar-tab-button').getAttribute('title') }); goToDate(cal.now())&quot;/&gt;</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+               oncommand=&quot;document.getElementById('tabmail').openTab('calendar', { title: document.getElementById('calendar-tab-button').getAttribute('title') }); goToDate(cal.dtz.now())&quot;/&gt;</span>
<a href="#l57.14"></a><span id="l57.14">     &lt;/commandset&gt;</span>
<a href="#l57.15"></a><span id="l57.15"> </span>
<a href="#l57.16"></a><span id="l57.16">     &lt;commandset id=&quot;mailCommands&quot;&gt;</span>
<a href="#l57.17"></a><span id="l57.17">       &lt;command id=&quot;cmd_CustomizeMailToolbar&quot;</span>
<a href="#l57.18"></a><span id="l57.18">                oncommand=&quot;customizeMailToolbarForTabType()&quot;/&gt;</span>
<a href="#l57.19"></a><span id="l57.19">     &lt;/commandset&gt;</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21">     &lt;keyset id=&quot;calendar-keys&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -131,17 +131,17 @@ ltn.invitation = {</span>
<a href="#l58.4"></a><span id="l58.4">         }</span>
<a href="#l58.5"></a><span id="l58.5"> </span>
<a href="#l58.6"></a><span id="l58.6">         field(&quot;summary&quot;, aEvent.title, true);</span>
<a href="#l58.7"></a><span id="l58.7">         field(&quot;location&quot;, aEvent.getProperty(&quot;LOCATION&quot;), true);</span>
<a href="#l58.8"></a><span id="l58.8"> </span>
<a href="#l58.9"></a><span id="l58.9">         let dateString = formatter.formatItemInterval(aEvent);</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11">         if (aEvent.recurrenceInfo) {</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-            let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+            let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l58.14"></a><span id="l58.14">             let startDate = aEvent.startDate;</span>
<a href="#l58.15"></a><span id="l58.15">             let endDate = aEvent.endDate;</span>
<a href="#l58.16"></a><span id="l58.16">             startDate = startDate ? startDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l58.17"></a><span id="l58.17">             endDate = endDate ? endDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l58.18"></a><span id="l58.18">             let repeatString = recurrenceRule2String(aEvent.recurrenceInfo, startDate,</span>
<a href="#l58.19"></a><span id="l58.19">                                                      endDate, startDate.isDate);</span>
<a href="#l58.20"></a><span id="l58.20">             if (repeatString) {</span>
<a href="#l58.21"></a><span id="l58.21">                 dateString = repeatString;</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineat">@@ -469,17 +469,17 @@ ltn.invitation = {</span>
<a href="#l58.23"></a><span id="l58.23">      */</span>
<a href="#l58.24"></a><span id="l58.24">     getRfc5322FormattedDate: function(aDate = null) {</span>
<a href="#l58.25"></a><span id="l58.25">         let date = aDate || new Date();</span>
<a href="#l58.26"></a><span id="l58.26">         let str = date.toString()</span>
<a href="#l58.27"></a><span id="l58.27">                       .replace(/^(\w{3}) (\w{3}) (\d{2}) (\d{4}) ([0-9:]{8}) GMT([+-])(\d{4}).*$/,</span>
<a href="#l58.28"></a><span id="l58.28">                                &quot;$1, $3 $2 $4 $5 $6$7&quot;);</span>
<a href="#l58.29"></a><span id="l58.29">         // according to section 3.3 of RfC5322, +0000 should be used for defined timezones using</span>
<a href="#l58.30"></a><span id="l58.30">         // UTC time, while -0000 should indicate a floating time instead</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">-        let timezone = cal.calendarDefaultTimezone();</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+        let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l58.33"></a><span id="l58.33">         if (timezone &amp;&amp; timezone.isFloating) {</span>
<a href="#l58.34"></a><span id="l58.34">             str.replace(/\+0000$/, &quot;-0000&quot;);</span>
<a href="#l58.35"></a><span id="l58.35">         }</span>
<a href="#l58.36"></a><span id="l58.36">         return str;</span>
<a href="#l58.37"></a><span id="l58.37">     },</span>
<a href="#l58.38"></a><span id="l58.38"> </span>
<a href="#l58.39"></a><span id="l58.39">     /**</span>
<a href="#l58.40"></a><span id="l58.40">      * Converts a given unicode text to utf-8 and normalizes line-breaks to \r\n</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -2420,22 +2420,22 @@ calDavCalendar.prototype = {</span>
<a href="#l59.4"></a><span id="l59.4">         let organizer = this.calendarUserAddress;</span>
<a href="#l59.5"></a><span id="l59.5"> </span>
<a href="#l59.6"></a><span id="l59.6">         let fbQuery = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l59.7"></a><span id="l59.7">         cal.calSetProdidVersion(fbQuery);</span>
<a href="#l59.8"></a><span id="l59.8">         let prop = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l59.9"></a><span id="l59.9">         prop.value = &quot;REQUEST&quot;;</span>
<a href="#l59.10"></a><span id="l59.10">         fbQuery.addProperty(prop);</span>
<a href="#l59.11"></a><span id="l59.11">         let fbComp = cal.getIcsService().createIcalComponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-        fbComp.stampTime = cal.now().getInTimezone(cal.UTC());</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+        fbComp.stampTime = cal.dtz.now().getInTimezone(cal.dtz.UTC);</span>
<a href="#l59.14"></a><span id="l59.14">         prop = cal.getIcsService().createIcalProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l59.15"></a><span id="l59.15">         prop.value = organizer;</span>
<a href="#l59.16"></a><span id="l59.16">         fbComp.addProperty(prop);</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-        fbComp.startTime = aRangeStart.getInTimezone(cal.UTC());</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-        fbComp.endTime = aRangeEnd.getInTimezone(cal.UTC());</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineplus">+        fbComp.startTime = aRangeStart.getInTimezone(cal.dtz.UTC);</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+        fbComp.endTime = aRangeEnd.getInTimezone(cal.dtz.UTC);</span>
<a href="#l59.21"></a><span id="l59.21">         fbComp.uid = cal.getUUID();</span>
<a href="#l59.22"></a><span id="l59.22">         prop = cal.getIcsService().createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l59.23"></a><span id="l59.23">         prop.setParameter(&quot;PARTSTAT&quot;, &quot;NEEDS-ACTION&quot;);</span>
<a href="#l59.24"></a><span id="l59.24">         prop.setParameter(&quot;ROLE&quot;, &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l59.25"></a><span id="l59.25">         prop.setParameter(&quot;CUTYPE&quot;, &quot;INDIVIDUAL&quot;);</span>
<a href="#l59.26"></a><span id="l59.26">         prop.value = mailto_aCalId;</span>
<a href="#l59.27"></a><span id="l59.27">         fbComp.addProperty(prop);</span>
<a href="#l59.28"></a><span id="l59.28">         fbQuery.addSubcomponent(fbComp);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -211,17 +211,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l60.4"></a><span id="l60.4">         return tasksURI;</span>
<a href="#l60.5"></a><span id="l60.5">     },</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7">     getUpdatedMin: function getUpdatedMin(aWhich) {</span>
<a href="#l60.8"></a><span id="l60.8">         let updatedMin = null;</span>
<a href="#l60.9"></a><span id="l60.9">         let lastUpdated = this.getProperty(&quot;lastUpdated.&quot; + aWhich);</span>
<a href="#l60.10"></a><span id="l60.10">         if (lastUpdated) {</span>
<a href="#l60.11"></a><span id="l60.11">             updatedMin = cal.createDateTime(lastUpdated);</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-            let lastWeek = cal.now();</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+            let lastWeek = cal.dtz.now();</span>
<a href="#l60.14"></a><span id="l60.14">             lastWeek.day -= 7;</span>
<a href="#l60.15"></a><span id="l60.15">             if (updatedMin.compare(lastWeek) &lt;= 0) {</span>
<a href="#l60.16"></a><span id="l60.16">                 cal.LOG(&quot;[calGoogleCalendar] Last updated time for &quot; + aWhich +</span>
<a href="#l60.17"></a><span id="l60.17">                         &quot; is very old, doing full sync&quot;);</span>
<a href="#l60.18"></a><span id="l60.18">                 this.resetLog();</span>
<a href="#l60.19"></a><span id="l60.19">                 updatedMin = null;</span>
<a href="#l60.20"></a><span id="l60.20">             }</span>
<a href="#l60.21"></a><span id="l60.21">         }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -76,21 +76,21 @@ Components.utils.import(&quot;resource://gdat</span>
<a href="#l61.4"></a><span id="l61.4">         }</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6">         let duedate = document.getElementById(&quot;todo-duedate&quot;);</span>
<a href="#l61.7"></a><span id="l61.7">         let duetime = document.getAnonymousElementByAttribute(duedate, &quot;anonid&quot;, &quot;time-picker&quot;);</span>
<a href="#l61.8"></a><span id="l61.8">         duetime.style.display = isGoogleTask ? &quot;none&quot; : &quot;&quot;;</span>
<a href="#l61.9"></a><span id="l61.9"> </span>
<a href="#l61.10"></a><span id="l61.10">         if (gEndTime) {</span>
<a href="#l61.11"></a><span id="l61.11">             if (isGoogleTask) {</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-                let floating = cal.floating();</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+                let floating = cal.dtz.floating;</span>
<a href="#l61.14"></a><span id="l61.14">                 if (gEndTimezone != floating) {</span>
<a href="#l61.15"></a><span id="l61.15">                   gOldEndTimezone = gEndTimezone;</span>
<a href="#l61.16"></a><span id="l61.16">                 }</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineminus">-                gEndTimezone = cal.floating();</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+                gEndTimezone = cal.dtz.floating;</span>
<a href="#l61.19"></a><span id="l61.19">                 gEndTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l61.20"></a><span id="l61.20">                 gEndTime.isDate = true;</span>
<a href="#l61.21"></a><span id="l61.21">             } else {</span>
<a href="#l61.22"></a><span id="l61.22">                 if (gOldEndTimezone) {</span>
<a href="#l61.23"></a><span id="l61.23">                     gEndTimezone = gOldEndTimezone;</span>
<a href="#l61.24"></a><span id="l61.24">                 }</span>
<a href="#l61.25"></a><span id="l61.25">                 gEndTime.isDate = false;</span>
<a href="#l61.26"></a><span id="l61.26">                 gEndTime = gEndTime.getInTimezone(gEndTimezone);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -417,20 +417,20 @@ calGoogleSession.prototype = {</span>
<a href="#l62.4"></a><span id="l62.4"> </span>
<a href="#l62.5"></a><span id="l62.5">         if (!aCalId.includes(&quot;@&quot;) || !aCalId.includes(&quot;.&quot;) ||</span>
<a href="#l62.6"></a><span id="l62.6">             !aCalId.toLowerCase().startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l62.7"></a><span id="l62.7">             // No valid email, screw it</span>
<a href="#l62.8"></a><span id="l62.8">             return failSync(Components.results.NS_ERROR_FAILURE, null);</span>
<a href="#l62.9"></a><span id="l62.9">         }</span>
<a href="#l62.10"></a><span id="l62.10"> </span>
<a href="#l62.11"></a><span id="l62.11">         if (aRangeStart) {</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-            aRangeStart = aRangeStart.getInTimezone(cal.UTC());</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+            aRangeStart = aRangeStart.getInTimezone(cal.dtz.UTC);</span>
<a href="#l62.14"></a><span id="l62.14">         }</span>
<a href="#l62.15"></a><span id="l62.15">         if (aRangeEnd) {</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineminus">-            aRangeEnd = aRangeEnd.getInTimezone(cal.UTC());</span>
<a href="#l62.17"></a><span id="l62.17" class="difflineplus">+            aRangeEnd = aRangeEnd.getInTimezone(cal.dtz.UTC);</span>
<a href="#l62.18"></a><span id="l62.18">         }</span>
<a href="#l62.19"></a><span id="l62.19"> </span>
<a href="#l62.20"></a><span id="l62.20">         let rfcRangeStart = cal.toRFC3339(aRangeStart);</span>
<a href="#l62.21"></a><span id="l62.21">         let rfcRangeEnd = cal.toRFC3339(aRangeEnd);</span>
<a href="#l62.22"></a><span id="l62.22">         /* 7 is the length of &quot;mailto:&quot;, we've asserted this above */</span>
<a href="#l62.23"></a><span id="l62.23">         let strippedCalId = aCalId.substr(7);</span>
<a href="#l62.24"></a><span id="l62.24"> </span>
<a href="#l62.25"></a><span id="l62.25">         let requestData = {</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineat">@@ -451,17 +451,17 @@ calGoogleSession.prototype = {</span>
<a href="#l62.27"></a><span id="l62.27">         this.asyncItemRequest(request).then(function(aData) {</span>
<a href="#l62.28"></a><span id="l62.28">             if (&quot;calendars&quot; in aData &amp;&amp; strippedCalId in aData.calendars) {</span>
<a href="#l62.29"></a><span id="l62.29">                 let calData = aData.calendars[strippedCalId];</span>
<a href="#l62.30"></a><span id="l62.30">                 let reason = calData.errors &amp;&amp; calData.errors[0] &amp;&amp; calData.errors[0].reason;</span>
<a href="#l62.31"></a><span id="l62.31">                 if (reason) {</span>
<a href="#l62.32"></a><span id="l62.32">                     cal.LOG(&quot;[calGoogleCalendar] Could not request freebusy for &quot; + strippedCalId + &quot;: &quot; + reason);</span>
<a href="#l62.33"></a><span id="l62.33">                     failSync(Components.results.NS_ERROR_FAILURE, reason);</span>
<a href="#l62.34"></a><span id="l62.34">                 } else {</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineminus">-                    let utcZone = cal.UTC();</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineplus">+                    let utcZone = cal.dtz.UTC;</span>
<a href="#l62.37"></a><span id="l62.37">                     cal.LOG(&quot;[calGoogleCalendar] Found &quot; + calData.busy.length + &quot; busy slots within range for &quot; + strippedCalId);</span>
<a href="#l62.38"></a><span id="l62.38">                     let busyRanges = calData.busy.map(function(entry) {</span>
<a href="#l62.39"></a><span id="l62.39">                         let start = cal.fromRFC3339(entry.start, utcZone);</span>
<a href="#l62.40"></a><span id="l62.40">                         let end = cal.fromRFC3339(entry.end, utcZone);</span>
<a href="#l62.41"></a><span id="l62.41">                         let interval = new cal.FreeBusyInterval(aCalId, cIFBI.BUSY, start, end);</span>
<a href="#l62.42"></a><span id="l62.42">                         LOGinterval(interval);</span>
<a href="#l62.43"></a><span id="l62.43">                         return interval;</span>
<a href="#l62.44"></a><span id="l62.44">                     });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -36,17 +36,17 @@ var EXPORTED_SYMBOLS = [</span>
<a href="#l63.4"></a><span id="l63.4">  * @param aItem             The Item to get the id for.</span>
<a href="#l63.5"></a><span id="l63.5">  * @param aOfflineStorage   The offline storage that holds the metadata for this item.</span>
<a href="#l63.6"></a><span id="l63.6">  */</span>
<a href="#l63.7"></a><span id="l63.7"> function getGoogleId(aItem, aOfflineStorage) {</span>
<a href="#l63.8"></a><span id="l63.8">     let meta = getItemMetadata(aOfflineStorage, aItem) ||</span>
<a href="#l63.9"></a><span id="l63.9">                getItemMetadata(aOfflineStorage, aItem.parentItem);</span>
<a href="#l63.10"></a><span id="l63.10">     let baseId = meta ? meta.path : aItem.id.replace(&quot;@google.com&quot;, &quot;&quot;);</span>
<a href="#l63.11"></a><span id="l63.11">     if (aItem.recurrenceId) {</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-        let recSuffix = &quot;_&quot; + aItem.recurrenceId.getInTimezone(cal.UTC()).icalString;</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+        let recSuffix = &quot;_&quot; + aItem.recurrenceId.getInTimezone(cal.dtz.UTC).icalString;</span>
<a href="#l63.14"></a><span id="l63.14">         if (!baseId.endsWith(recSuffix)) {</span>
<a href="#l63.15"></a><span id="l63.15">             baseId += recSuffix;</span>
<a href="#l63.16"></a><span id="l63.16">         }</span>
<a href="#l63.17"></a><span id="l63.17">     }</span>
<a href="#l63.18"></a><span id="l63.18">     return baseId;</span>
<a href="#l63.19"></a><span id="l63.19"> }</span>
<a href="#l63.20"></a><span id="l63.20"> </span>
<a href="#l63.21"></a><span id="l63.21"> /**</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineat">@@ -475,17 +475,17 @@ function EventToJSON(aItem, aOfflineStor</span>
<a href="#l63.23"></a><span id="l63.23">         itemData.recurrence = [];</span>
<a href="#l63.24"></a><span id="l63.24">         let recurrenceItems = aItem.recurrenceInfo.getRecurrenceItems({});</span>
<a href="#l63.25"></a><span id="l63.25">         for (let ritem of recurrenceItems) {</span>
<a href="#l63.26"></a><span id="l63.26">             let prop = ritem.icalProperty;</span>
<a href="#l63.27"></a><span id="l63.27">             if (ritem instanceof Components.interfaces.calIRecurrenceDate) {</span>
<a href="#l63.28"></a><span id="l63.28">                 // EXDATES require special casing, since they might contain</span>
<a href="#l63.29"></a><span id="l63.29">                 // a TZID. To avoid the need for conversion of TZID strings,</span>
<a href="#l63.30"></a><span id="l63.30">                 // convert to UTC before serialization.</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-                prop.valueAsDatetime = ritem.date.getInTimezone(cal.UTC());</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineplus">+                prop.valueAsDatetime = ritem.date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l63.33"></a><span id="l63.33">             }</span>
<a href="#l63.34"></a><span id="l63.34">             itemData.recurrence.push(prop.icalString.trim());</span>
<a href="#l63.35"></a><span id="l63.35">         }</span>
<a href="#l63.36"></a><span id="l63.36">     } else if (aItem.recurrenceId) {</span>
<a href="#l63.37"></a><span id="l63.37">         itemData.originalStartTime = dateToJSON(aItem.recurrenceId);</span>
<a href="#l63.38"></a><span id="l63.38">         let parentMeta = getItemMetadata(aOfflineStorage, aItem.parentItem);</span>
<a href="#l63.39"></a><span id="l63.39">         itemData.recurringEventId = parentMeta ? parentMeta.path : aItem.id.replace(&quot;@google.com&quot;, &quot;&quot;);</span>
<a href="#l63.40"></a><span id="l63.40">     }</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineat">@@ -508,17 +508,17 @@ function TaskToJSON(aItem, aOfflineStora</span>
<a href="#l63.42"></a><span id="l63.42"> </span>
<a href="#l63.43"></a><span id="l63.43">     setIf(itemData, &quot;id&quot;, aItem.id);</span>
<a href="#l63.44"></a><span id="l63.44">     setIf(itemData, &quot;title&quot;, aItem.title);</span>
<a href="#l63.45"></a><span id="l63.45">     setIf(itemData, &quot;notes&quot;, aItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l63.46"></a><span id="l63.46">     setIf(itemData, &quot;position&quot;, aItem.getProperty(&quot;X-SORTKEY&quot;));</span>
<a href="#l63.47"></a><span id="l63.47">     itemData.status = (aItem.isCompleted ? &quot;completed&quot; : &quot;needsAction&quot;);</span>
<a href="#l63.48"></a><span id="l63.48"> </span>
<a href="#l63.49"></a><span id="l63.49">     if (aItem.dueDate) {</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineminus">-        let dueDate = aItem.dueDate.getInTimezone(cal.UTC());</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineplus">+        let dueDate = aItem.dueDate.getInTimezone(cal.dtz.UTC);</span>
<a href="#l63.52"></a><span id="l63.52">         dueDate.isDate = false;</span>
<a href="#l63.53"></a><span id="l63.53">         itemData.due = cal.toRFC3339(dueDate);</span>
<a href="#l63.54"></a><span id="l63.54">     }</span>
<a href="#l63.55"></a><span id="l63.55">     setIf(itemData, &quot;completed&quot;, cal.toRFC3339(aItem.completedDate));</span>
<a href="#l63.56"></a><span id="l63.56"> </span>
<a href="#l63.57"></a><span id="l63.57">     for (let relation of aItem.getRelations({})) {</span>
<a href="#l63.58"></a><span id="l63.58">         if (relation.relId &amp;&amp;</span>
<a href="#l63.59"></a><span id="l63.59">             (!relation.relType || relation.relType == &quot;PARENT&quot;)) {</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineat">@@ -674,17 +674,17 @@ function JSONToEvent(aEntry, aCalendar, </span>
<a href="#l63.61"></a><span id="l63.61">     if (!aEntry || !(&quot;kind&quot; in aEntry) || aEntry.kind != &quot;calendar#event&quot;) {</span>
<a href="#l63.62"></a><span id="l63.62">         cal.ERROR(&quot;[calGoogleCalendar] Attempt to decode invalid event: &quot; +</span>
<a href="#l63.63"></a><span id="l63.63">                   (aEntry &amp;&amp; JSON.stringify(aEntry, null, &quot; &quot;)));</span>
<a href="#l63.64"></a><span id="l63.64">         return null;</span>
<a href="#l63.65"></a><span id="l63.65">     }</span>
<a href="#l63.66"></a><span id="l63.66"> </span>
<a href="#l63.67"></a><span id="l63.67">     let tzs = cal.getTimezoneService();</span>
<a href="#l63.68"></a><span id="l63.68">     let calendarZoneName = aCalendar.getProperty(&quot;settings.timeZone&quot;);</span>
<a href="#l63.69"></a><span id="l63.69" class="difflineminus">-    let calendarZone = calendarZoneName ? tzs.getTimezone(calendarZoneName) : cal.calendarDefaultTimezone();</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineplus">+    let calendarZone = calendarZoneName ? tzs.getTimezone(calendarZoneName) : cal.dtz.defaultTimezone;</span>
<a href="#l63.71"></a><span id="l63.71"> </span>
<a href="#l63.72"></a><span id="l63.72">     try {</span>
<a href="#l63.73"></a><span id="l63.73">         item.id = aEntry.iCalUID || ((aEntry.recurringEventId || aEntry.id) + &quot;@google.com&quot;);</span>
<a href="#l63.74"></a><span id="l63.74">         item.recurrenceId = JSONToDate(aEntry.originalStartTime, calendarZone);</span>
<a href="#l63.75"></a><span id="l63.75">         if (!item.recurrenceId) {</span>
<a href="#l63.76"></a><span id="l63.76">             // Sometimes recurring event instances don't have recurringEventId</span>
<a href="#l63.77"></a><span id="l63.77">             // set, but are still instances. work around by detecting the ID.</span>
<a href="#l63.78"></a><span id="l63.78">             // http://code.google.com/a/google.com/p/apps-api-issues/issues/detail?id=3199</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineat">@@ -694,17 +694,17 @@ function JSONToEvent(aEntry, aCalendar, </span>
<a href="#l63.80"></a><span id="l63.80">         item.status = (aEntry.status ? aEntry.status.toUpperCase() : null);</span>
<a href="#l63.81"></a><span id="l63.81">         item.title = aEntry.summary;</span>
<a href="#l63.82"></a><span id="l63.82">         if (accessRole == &quot;freeBusyReader&quot;) {</span>
<a href="#l63.83"></a><span id="l63.83">             item.title = getProviderString(&quot;busyTitle&quot;, aCalendar.name);</span>
<a href="#l63.84"></a><span id="l63.84">         }</span>
<a href="#l63.85"></a><span id="l63.85">         item.privacy = (aEntry.visibility ? aEntry.visibility.toUpperCase() : null);</span>
<a href="#l63.86"></a><span id="l63.86"> </span>
<a href="#l63.87"></a><span id="l63.87">         item.setProperty(&quot;URL&quot;, aEntry.htmlLink &amp;&amp; aCalendar.uri.schemeIs(&quot;https&quot;) ? aEntry.htmlLink.replace(/^http:/, &quot;https:&quot;) : aEntry.htmlLink);</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineminus">-        item.setProperty(&quot;CREATED&quot;, (aEntry.created ? cal.fromRFC3339(aEntry.created, calendarZone).getInTimezone(cal.UTC()) : null));</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineplus">+        item.setProperty(&quot;CREATED&quot;, (aEntry.created ? cal.fromRFC3339(aEntry.created, calendarZone).getInTimezone(cal.dtz.UTC) : null));</span>
<a href="#l63.90"></a><span id="l63.90">         item.setProperty(&quot;DESCRIPTION&quot;, aEntry.description);</span>
<a href="#l63.91"></a><span id="l63.91">         item.setProperty(&quot;LOCATION&quot;, aEntry.location);</span>
<a href="#l63.92"></a><span id="l63.92">         item.setProperty(&quot;TRANSP&quot;, (aEntry.transparency ? aEntry.transparency.toUpperCase() : null));</span>
<a href="#l63.93"></a><span id="l63.93">         item.setProperty(&quot;SEQUENCE&quot;, aEntry.sequence);</span>
<a href="#l63.94"></a><span id="l63.94">         aMetadata.etag = aEntry.etag;</span>
<a href="#l63.95"></a><span id="l63.95">         aMetadata.path = aEntry.id;</span>
<a href="#l63.96"></a><span id="l63.96"> </span>
<a href="#l63.97"></a><span id="l63.97">         // organizer</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineat">@@ -822,17 +822,17 @@ function JSONToEvent(aEntry, aCalendar, </span>
<a href="#l63.99"></a><span id="l63.99">         // Google does not support categories natively, but allows us to store</span>
<a href="#l63.100"></a><span id="l63.100">         // data as an &quot;extendedProperty&quot;, and here it's going to be retrieved</span>
<a href="#l63.101"></a><span id="l63.101">         // again</span>
<a href="#l63.102"></a><span id="l63.102">         let categories = cal.categoriesStringToArray(sharedProps[&quot;X-MOZ-CATEGORIES&quot;]);</span>
<a href="#l63.103"></a><span id="l63.103">         item.setCategories(categories.length, categories);</span>
<a href="#l63.104"></a><span id="l63.104"> </span>
<a href="#l63.105"></a><span id="l63.105">         // updated (This must be set last!)</span>
<a href="#l63.106"></a><span id="l63.106">         if (aEntry.updated) {</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineminus">-            let updated = cal.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.UTC());</span>
<a href="#l63.108"></a><span id="l63.108" class="difflineplus">+            let updated = cal.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.dtz.UTC);</span>
<a href="#l63.109"></a><span id="l63.109">             item.setProperty(&quot;DTSTAMP&quot;, updated);</span>
<a href="#l63.110"></a><span id="l63.110">             item.setProperty(&quot;LAST-MODIFIED&quot;, updated);</span>
<a href="#l63.111"></a><span id="l63.111">         }</span>
<a href="#l63.112"></a><span id="l63.112">     } catch (e) {</span>
<a href="#l63.113"></a><span id="l63.113">         cal.ERROR(stringException(e));</span>
<a href="#l63.114"></a><span id="l63.114">         throw e;</span>
<a href="#l63.115"></a><span id="l63.115">     }</span>
<a href="#l63.116"></a><span id="l63.116">     return item;</span>
<a href="#l63.117"></a><span id="l63.117" class="difflineat">@@ -854,33 +854,33 @@ function JSONToTask(aEntry, aCalendar, a</span>
<a href="#l63.118"></a><span id="l63.118">                   (aEntry &amp;&amp; JSON.stringify(aEntry, null, &quot; &quot;)));</span>
<a href="#l63.119"></a><span id="l63.119">         return null;</span>
<a href="#l63.120"></a><span id="l63.120">     }</span>
<a href="#l63.121"></a><span id="l63.121">     let item = cal.createTodo();</span>
<a href="#l63.122"></a><span id="l63.122">     item.calendar = aCalendar.superCalendar;</span>
<a href="#l63.123"></a><span id="l63.123"> </span>
<a href="#l63.124"></a><span id="l63.124">     let tzs = cal.getTimezoneService();</span>
<a href="#l63.125"></a><span id="l63.125">     let calendarZoneName = aCalendar.getProperty(&quot;settings.timeZone&quot;);</span>
<a href="#l63.126"></a><span id="l63.126" class="difflineminus">-    let calendarZone = calendarZoneName ? tzs.getTimezone(calendarZoneName) : cal.calendarDefaultTimezone();</span>
<a href="#l63.127"></a><span id="l63.127" class="difflineplus">+    let calendarZone = calendarZoneName ? tzs.getTimezone(calendarZoneName) : cal.dtz.defaultTimezone;</span>
<a href="#l63.128"></a><span id="l63.128"> </span>
<a href="#l63.129"></a><span id="l63.129">     try {</span>
<a href="#l63.130"></a><span id="l63.130">         item.id = aEntry.id;</span>
<a href="#l63.131"></a><span id="l63.131">         item.title = aEntry.title || &quot;&quot;;</span>
<a href="#l63.132"></a><span id="l63.132">         item.setProperty(&quot;DESCRIPTION&quot;, aEntry.notes);</span>
<a href="#l63.133"></a><span id="l63.133">         item.setProperty(&quot;X-GOOGLE-SORTKEY&quot;, aEntry.position);</span>
<a href="#l63.134"></a><span id="l63.134">         item.isCompleted = (aEntry.status == &quot;completed&quot;);</span>
<a href="#l63.135"></a><span id="l63.135"> </span>
<a href="#l63.136"></a><span id="l63.136">         aMetadata.etag = aEntry.etag;</span>
<a href="#l63.137"></a><span id="l63.137">         aMetadata.path = aEntry.id;</span>
<a href="#l63.138"></a><span id="l63.138"> </span>
<a href="#l63.139"></a><span id="l63.139">         // Google Tasks don't have a due time, but still use 0:00 UTC. They</span>
<a href="#l63.140"></a><span id="l63.140">         // should really be using floating time.</span>
<a href="#l63.141"></a><span id="l63.141" class="difflineminus">-        item.dueDate = cal.fromRFC3339(aEntry.due, cal.floating())</span>
<a href="#l63.142"></a><span id="l63.142" class="difflineplus">+        item.dueDate = cal.fromRFC3339(aEntry.due, cal.dtz.floating)</span>
<a href="#l63.143"></a><span id="l63.143">         if (item.dueDate) {</span>
<a href="#l63.144"></a><span id="l63.144" class="difflineminus">-            item.dueDate.timezone = cal.floating();</span>
<a href="#l63.145"></a><span id="l63.145" class="difflineplus">+            item.dueDate.timezone = cal.dtz.floating;</span>
<a href="#l63.146"></a><span id="l63.146">             item.dueDate.isDate = true;</span>
<a href="#l63.147"></a><span id="l63.147">         }</span>
<a href="#l63.148"></a><span id="l63.148">         item.completedDate = cal.fromRFC3339(aEntry.completed, calendarZone);</span>
<a href="#l63.149"></a><span id="l63.149">         if (aEntry.deleted) {</span>
<a href="#l63.150"></a><span id="l63.150">             item.status = &quot;CANCELLED&quot;;</span>
<a href="#l63.151"></a><span id="l63.151">         } else if (aEntry.status == &quot;needsAction&quot;) {</span>
<a href="#l63.152"></a><span id="l63.152">             item.status = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l63.153"></a><span id="l63.153">         } else {</span>
<a href="#l63.154"></a><span id="l63.154" class="difflineat">@@ -900,18 +900,18 @@ function JSONToTask(aEntry, aCalendar, a</span>
<a href="#l63.155"></a><span id="l63.155">                 attach.uri = Services.io.newURI(link.link);</span>
<a href="#l63.156"></a><span id="l63.156">                 attach.setParameter(&quot;FILENAME&quot;, link.description);</span>
<a href="#l63.157"></a><span id="l63.157">                 attach.setParameter(&quot;X-GOOGLE-TYPE&quot;, link.type);</span>
<a href="#l63.158"></a><span id="l63.158">                 item.addAttachment(attach);</span>
<a href="#l63.159"></a><span id="l63.159">             }</span>
<a href="#l63.160"></a><span id="l63.160">         }</span>
<a href="#l63.161"></a><span id="l63.161"> </span>
<a href="#l63.162"></a><span id="l63.162">         // updated (This must be set last!)</span>
<a href="#l63.163"></a><span id="l63.163" class="difflineminus">-        item.setProperty(&quot;DTSTAMP&quot;, cal.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.UTC()));</span>
<a href="#l63.164"></a><span id="l63.164" class="difflineminus">-        item.setProperty(&quot;LAST-MODIFIED&quot;, cal.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.UTC()));</span>
<a href="#l63.165"></a><span id="l63.165" class="difflineplus">+        item.setProperty(&quot;DTSTAMP&quot;, cal.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.dtz.UTC));</span>
<a href="#l63.166"></a><span id="l63.166" class="difflineplus">+        item.setProperty(&quot;LAST-MODIFIED&quot;, cal.fromRFC3339(aEntry.updated, calendarZone).getInTimezone(cal.dtz.UTC));</span>
<a href="#l63.167"></a><span id="l63.167">     } catch (e) {</span>
<a href="#l63.168"></a><span id="l63.168">         cal.ERROR(&quot;[calGoogleCalendar] Error parsing JSON tasks stream: &quot; + stringException(e));</span>
<a href="#l63.169"></a><span id="l63.169">         throw e;</span>
<a href="#l63.170"></a><span id="l63.170">     }</span>
<a href="#l63.171"></a><span id="l63.171"> </span>
<a href="#l63.172"></a><span id="l63.172">     return item;</span>
<a href="#l63.173"></a><span id="l63.173"> }</span>
<a href="#l63.174"></a><span id="l63.174"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -412,18 +412,18 @@ calMemoryCalendar.prototype = {</span>
<a href="#l64.4"></a><span id="l64.4">         } else if (wantEvents &amp;&amp; wantTodos) {</span>
<a href="#l64.5"></a><span id="l64.5">             typeIID = Components.interfaces.calIItemBase;</span>
<a href="#l64.6"></a><span id="l64.6">         } else if (wantEvents) {</span>
<a href="#l64.7"></a><span id="l64.7">             typeIID = Components.interfaces.calIEvent;</span>
<a href="#l64.8"></a><span id="l64.8">         } else if (wantTodos) {</span>
<a href="#l64.9"></a><span id="l64.9">             typeIID = Components.interfaces.calITodo;</span>
<a href="#l64.10"></a><span id="l64.10">         }</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-        aRangeStart = cal.ensureDateTime(aRangeStart);</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-        aRangeEnd = cal.ensureDateTime(aRangeEnd);</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+        aRangeStart = cal.dtz.ensureDateTime(aRangeStart);</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+        aRangeEnd = cal.dtz.ensureDateTime(aRangeEnd);</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17">         let requestedFlag = 0;</span>
<a href="#l64.18"></a><span id="l64.18">         if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_CREATED) != 0) {</span>
<a href="#l64.19"></a><span id="l64.19">             requestedFlag = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l64.20"></a><span id="l64.20">         } else if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_MODIFIED) != 0) {</span>
<a href="#l64.21"></a><span id="l64.21">             requestedFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l64.22"></a><span id="l64.22">         } else if ((aItemFilter &amp; calICalendar.ITEM_FILTER_OFFLINE_DELETED) != 0) {</span>
<a href="#l64.23"></a><span id="l64.23">             requestedFlag = cICL.OFFLINE_FLAG_DELETED_RECORD;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -44,17 +44,17 @@ var gForeignTimezonesCache = {};</span>
<a href="#l65.4"></a><span id="l65.4">  * @param date      The calIDateTime to convert.</span>
<a href="#l65.5"></a><span id="l65.5">  * @return          The possibly converted calIDateTime.</span>
<a href="#l65.6"></a><span id="l65.6">  */</span>
<a href="#l65.7"></a><span id="l65.7"> function getInUtcOrKeepFloating(date) {</span>
<a href="#l65.8"></a><span id="l65.8">     let timezone = date.timezone;</span>
<a href="#l65.9"></a><span id="l65.9">     if (timezone.isFloating || timezone.isUTC) {</span>
<a href="#l65.10"></a><span id="l65.10">         return date;</span>
<a href="#l65.11"></a><span id="l65.11">     } else {</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-        return date.getInTimezone(cal.UTC());</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+        return date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l65.14"></a><span id="l65.14">     }</span>
<a href="#l65.15"></a><span id="l65.15"> }</span>
<a href="#l65.16"></a><span id="l65.16"> </span>
<a href="#l65.17"></a><span id="l65.17"> /**</span>
<a href="#l65.18"></a><span id="l65.18">  * Transforms a date object to a text which is suitable for the database</span>
<a href="#l65.19"></a><span id="l65.19">  *</span>
<a href="#l65.20"></a><span id="l65.20">  * @param date  The calIDateTime to transform.</span>
<a href="#l65.21"></a><span id="l65.21">  * @return      The string representation of the date object.</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -184,12 +184,12 @@ function newDateTime(aNativeTime, aTimez</span>
<a href="#l65.23"></a><span id="l65.23">     if (aTimezone) {</span>
<a href="#l65.24"></a><span id="l65.24">         let timezone = getTimezone(aTimezone);</span>
<a href="#l65.25"></a><span id="l65.25">         if (timezone) {</span>
<a href="#l65.26"></a><span id="l65.26">             date = date.getInTimezone(timezone);</span>
<a href="#l65.27"></a><span id="l65.27">         } else {</span>
<a href="#l65.28"></a><span id="l65.28">             cal.ASSERT(false, &quot;Timezone not available: &quot; + aTimezone);</span>
<a href="#l65.29"></a><span id="l65.29">         }</span>
<a href="#l65.30"></a><span id="l65.30">     } else {</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-        date.timezone = cal.floating();</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+        date.timezone = cal.dtz.floating;</span>
<a href="#l65.33"></a><span id="l65.33">     }</span>
<a href="#l65.34"></a><span id="l65.34">     return date;</span>
<a href="#l65.35"></a><span id="l65.35"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -1122,17 +1122,17 @@ upgrade.v16 = function(db, version) {</span>
<a href="#l66.4"></a><span id="l66.4">                         if (aTzId == &quot;floating&quot;) {</span>
<a href="#l66.5"></a><span id="l66.5">                             // The current calDateTime code assumes that if a</span>
<a href="#l66.6"></a><span id="l66.6">                             // date is floating then we can just assign the new</span>
<a href="#l66.7"></a><span id="l66.7">                             // timezone. I have the feeling this is wrong so I</span>
<a href="#l66.8"></a><span id="l66.8">                             // filed bug 520463. Since we want to release 1.0b1</span>
<a href="#l66.9"></a><span id="l66.9">                             // soon, I will just fix this on the &quot;client side&quot;</span>
<a href="#l66.10"></a><span id="l66.10">                             // and do the conversion here.</span>
<a href="#l66.11"></a><span id="l66.11">                             alarmDate.timezone = cal.getTimezoneService().defaultTimezone;</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-                            alarmDate = alarmDate.getInTimezone(cal.UTC());</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+                            alarmDate = alarmDate.getInTimezone(cal.dtz.UTC);</span>
<a href="#l66.14"></a><span id="l66.14">                         } else {</span>
<a href="#l66.15"></a><span id="l66.15">                             alarmDate.timezone = cal.getTimezoneService().getTimezone(aTzId);</span>
<a href="#l66.16"></a><span id="l66.16">                         }</span>
<a href="#l66.17"></a><span id="l66.17">                         alarm.alarmDate = alarmDate;</span>
<a href="#l66.18"></a><span id="l66.18">                     }</span>
<a href="#l66.19"></a><span id="l66.19">                     return alarm.icalString;</span>
<a href="#l66.20"></a><span id="l66.20">                 } catch (e) {</span>
<a href="#l66.21"></a><span id="l66.21">                     // Errors in this function are not really logged. Do this</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -50,19 +50,19 @@ calWcapCalendar.prototype.getRecurrenceP</span>
<a href="#l67.4"></a><span id="l67.4">                 if (isNeg) {</span>
<a href="#l67.5"></a><span id="l67.5">                     out_exrules.value.push(rule);</span>
<a href="#l67.6"></a><span id="l67.6">                 } else {</span>
<a href="#l67.7"></a><span id="l67.7">                     out_rrules.value.push(rule);</span>
<a href="#l67.8"></a><span id="l67.8">                 }</span>
<a href="#l67.9"></a><span id="l67.9">             } else if (rDateInstance) {</span>
<a href="#l67.10"></a><span id="l67.10">                 // cs does not accept DATEs here:</span>
<a href="#l67.11"></a><span id="l67.11">                 if (isNeg) {</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-                    out_exdates.value.push(getIcalUTC(cal.ensureDateTime(rDateInstance.date)));</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+                    out_exdates.value.push(getIcalUTC(cal.dtz.ensureDateTime(rDateInstance.date)));</span>
<a href="#l67.14"></a><span id="l67.14">                 } else {</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineminus">-                    out_rdates.value.push(getIcalUTC(cal.ensureDateTime(rDateInstance.date)));</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineplus">+                    out_rdates.value.push(getIcalUTC(cal.dtz.ensureDateTime(rDateInstance.date)));</span>
<a href="#l67.17"></a><span id="l67.17">                 }</span>
<a href="#l67.18"></a><span id="l67.18">             } else {</span>
<a href="#l67.19"></a><span id="l67.19">                 this.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l67.20"></a><span id="l67.20">                                  &quot;don't know how to handle this recurrence item: &quot; + rItem.valueAsIcalString);</span>
<a href="#l67.21"></a><span id="l67.21">             }</span>
<a href="#l67.22"></a><span id="l67.22">         }</span>
<a href="#l67.23"></a><span id="l67.23">     }</span>
<a href="#l67.24"></a><span id="l67.24"> };</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineat">@@ -549,17 +549,17 @@ calWcapCalendar.prototype.storeItem = fu</span>
<a href="#l67.26"></a><span id="l67.26">             params += &quot;&amp;storetype=1&quot;;</span>
<a href="#l67.27"></a><span id="l67.27">         } else if (oldItem) {</span>
<a href="#l67.28"></a><span id="l67.28">             params += &quot;&amp;storetype=2&quot;;</span>
<a href="#l67.29"></a><span id="l67.29">         } // else we don't know exactly, so don't check</span>
<a href="#l67.30"></a><span id="l67.30"> </span>
<a href="#l67.31"></a><span id="l67.31">         if (bIsParent) {</span>
<a href="#l67.32"></a><span id="l67.32">             params += &quot;&amp;mod=4&quot;; // THIS AND ALL INSTANCES</span>
<a href="#l67.33"></a><span id="l67.33">         } else {</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineminus">-            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.ensureDateTime(item.recurrenceId)); // THIS INSTANCE</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineplus">+            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.dtz.ensureDateTime(item.recurrenceId)); // THIS INSTANCE</span>
<a href="#l67.36"></a><span id="l67.36">         }</span>
<a href="#l67.37"></a><span id="l67.37"> </span>
<a href="#l67.38"></a><span id="l67.38">         params += &quot;&amp;method=&quot; + method;</span>
<a href="#l67.39"></a><span id="l67.39">         if (bNoSmtpNotify) {</span>
<a href="#l67.40"></a><span id="l67.40">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l67.41"></a><span id="l67.41">         }</span>
<a href="#l67.42"></a><span id="l67.42">         params += &quot;&amp;replace=1&quot;; // (update) don't append to any lists</span>
<a href="#l67.43"></a><span id="l67.43">         params += &quot;&amp;fetch=1&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineat">@@ -747,17 +747,17 @@ calWcapCalendar.prototype.deleteItem = f</span>
<a href="#l67.45"></a><span id="l67.45">         if (!item.id) {</span>
<a href="#l67.46"></a><span id="l67.46">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l67.47"></a><span id="l67.47">         }</span>
<a href="#l67.48"></a><span id="l67.48">         let params = &quot;&amp;uid=&quot; + encodeURIComponent(item.id);</span>
<a href="#l67.49"></a><span id="l67.49">         if (isParent(item)) { // delete THIS AND ALL:</span>
<a href="#l67.50"></a><span id="l67.50">             params += &quot;&amp;mod=4&amp;rid=0&quot;;</span>
<a href="#l67.51"></a><span id="l67.51">         } else { // delete THIS INSTANCE:</span>
<a href="#l67.52"></a><span id="l67.52">             // cs does not accept DATE here:</span>
<a href="#l67.53"></a><span id="l67.53" class="difflineminus">-            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.ensureDateTime(item.recurrenceId));</span>
<a href="#l67.54"></a><span id="l67.54" class="difflineplus">+            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.dtz.ensureDateTime(item.recurrenceId));</span>
<a href="#l67.55"></a><span id="l67.55">         }</span>
<a href="#l67.56"></a><span id="l67.56"> </span>
<a href="#l67.57"></a><span id="l67.57">         let orgCalId = getCalId(item.organizer);</span>
<a href="#l67.58"></a><span id="l67.58">         if (!orgCalId || (orgCalId != this.calId)) {</span>
<a href="#l67.59"></a><span id="l67.59">             // item does not belong to this user, so don't notify:</span>
<a href="#l67.60"></a><span id="l67.60">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l67.61"></a><span id="l67.61">         }</span>
<a href="#l67.62"></a><span id="l67.62"> </span>
<a href="#l67.63"></a><span id="l67.63" class="difflineat">@@ -1118,18 +1118,18 @@ function getItemFilterParams(itemFilter)</span>
<a href="#l67.64"></a><span id="l67.64">     //         compstate += &quot;;REQUEST-WAITFORREPLY&quot;;</span>
<a href="#l67.65"></a><span id="l67.65">     if (compstate.length &gt; 0) {</span>
<a href="#l67.66"></a><span id="l67.66">         params += &quot;&amp;compstate=&quot; + compstate.substr(1);</span>
<a href="#l67.67"></a><span id="l67.67">     }</span>
<a href="#l67.68"></a><span id="l67.68">     return params;</span>
<a href="#l67.69"></a><span id="l67.69"> }</span>
<a href="#l67.70"></a><span id="l67.70"> </span>
<a href="#l67.71"></a><span id="l67.71"> calWcapCalendar.prototype.getItems = function(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l67.72"></a><span id="l67.72" class="difflineminus">-    rangeStart = cal.ensureDateTime(rangeStart);</span>
<a href="#l67.73"></a><span id="l67.73" class="difflineminus">-    rangeEnd = cal.ensureDateTime(rangeEnd);</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineplus">+    rangeStart = cal.dtz.ensureDateTime(rangeStart);</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineplus">+    rangeEnd = cal.dtz.ensureDateTime(rangeEnd);</span>
<a href="#l67.76"></a><span id="l67.76">     let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l67.77"></a><span id="l67.77">     let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l67.78"></a><span id="l67.78"> </span>
<a href="#l67.79"></a><span id="l67.79">     let request = new calWcapRequest(</span>
<a href="#l67.80"></a><span id="l67.80">         (oprequest, err, data) =&gt; {</span>
<a href="#l67.81"></a><span id="l67.81">             log(&quot;getItems() complete: &quot; + errorToString(err), this);</span>
<a href="#l67.82"></a><span id="l67.82">             this.notifyOperationComplete(listener,</span>
<a href="#l67.83"></a><span id="l67.83">                                          getResultCode(err),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -161,19 +161,19 @@ calWcapSession.prototype = {</span>
<a href="#l68.4"></a><span id="l68.4">             hasMore: function() {</span>
<a href="#l68.5"></a><span id="l68.5">                 return (this.m_index &lt; tzids.length);</span>
<a href="#l68.6"></a><span id="l68.6">             }</span>
<a href="#l68.7"></a><span id="l68.7">         };</span>
<a href="#l68.8"></a><span id="l68.8">     },</span>
<a href="#l68.9"></a><span id="l68.9">     getTimezone: function(tzid) {</span>
<a href="#l68.10"></a><span id="l68.10">         switch (tzid) {</span>
<a href="#l68.11"></a><span id="l68.11">             case &quot;floating&quot;:</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-                return cal.floating();</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+                return cal.dtz.floating;</span>
<a href="#l68.14"></a><span id="l68.14">             case &quot;UTC&quot;:</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-                return cal.UTC();</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+                return cal.dtz.UTC;</span>
<a href="#l68.17"></a><span id="l68.17">             default:</span>
<a href="#l68.18"></a><span id="l68.18">                 if (this.m_serverTimezones) {</span>
<a href="#l68.19"></a><span id="l68.19">                     return this.m_serverTimezones[tzid];</span>
<a href="#l68.20"></a><span id="l68.20">                 }</span>
<a href="#l68.21"></a><span id="l68.21">                 return null;</span>
<a href="#l68.22"></a><span id="l68.22">         }</span>
<a href="#l68.23"></a><span id="l68.23">     },</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25" class="difflineat">@@ -920,18 +920,18 @@ calWcapSession.prototype = {</span>
<a href="#l68.26"></a><span id="l68.26">         } catch (exc) {</span>
<a href="#l68.27"></a><span id="l68.27">             request.execRespFunc(exc);</span>
<a href="#l68.28"></a><span id="l68.28">         }</span>
<a href="#l68.29"></a><span id="l68.29">         return request;</span>
<a href="#l68.30"></a><span id="l68.30">     },</span>
<a href="#l68.31"></a><span id="l68.31"> </span>
<a href="#l68.32"></a><span id="l68.32">     // calIFreeBusyProvider:</span>
<a href="#l68.33"></a><span id="l68.33">     getFreeBusyIntervals: function(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineminus">-        rangeStart = cal.ensureDateTime(rangeStart);</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineminus">-        rangeEnd = cal.ensureDateTime(rangeEnd);</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+        rangeStart = cal.dtz.ensureDateTime(rangeStart);</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+        rangeEnd = cal.dtz.ensureDateTime(rangeEnd);</span>
<a href="#l68.38"></a><span id="l68.38">         let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l68.39"></a><span id="l68.39">         let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l68.40"></a><span id="l68.40"> </span>
<a href="#l68.41"></a><span id="l68.41">         let request = new calWcapRequest(</span>
<a href="#l68.42"></a><span id="l68.42">             (oprequest, err, data) =&gt; {</span>
<a href="#l68.43"></a><span id="l68.43">                 let rc = getResultCode(err);</span>
<a href="#l68.44"></a><span id="l68.44">                 switch (rc) {</span>
<a href="#l68.45"></a><span id="l68.45">                     case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l69.4"></a><span id="l69.4"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l69.5"></a><span id="l69.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l69.6"></a><span id="l69.6"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l69.7"></a><span id="l69.7"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l69.8"></a><span id="l69.8"> </span>
<a href="#l69.9"></a><span id="l69.9"> var g_bShutdown = false;</span>
<a href="#l69.10"></a><span id="l69.10"> </span>
<a href="#l69.11"></a><span id="l69.11"> function initLogging() {</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-    initLogging.mLogTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+    initLogging.mLogTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l69.14"></a><span id="l69.14">     if (initLogging.mLogFilestream) {</span>
<a href="#l69.15"></a><span id="l69.15">         try {</span>
<a href="#l69.16"></a><span id="l69.16">             initLogging.mLogFilestream.close();</span>
<a href="#l69.17"></a><span id="l69.17">         } catch (exc) {</span>
<a href="#l69.18"></a><span id="l69.18">             cal.ASSERT(false, exc);</span>
<a href="#l69.19"></a><span id="l69.19">         }</span>
<a href="#l69.20"></a><span id="l69.20">         initLogging.mLogFilestream = null;</span>
<a href="#l69.21"></a><span id="l69.21">     }</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineat">@@ -175,28 +175,28 @@ function filterXmlNodes(name, rootNode) </span>
<a href="#l69.23"></a><span id="l69.23">     }</span>
<a href="#l69.24"></a><span id="l69.24">     return ret;</span>
<a href="#l69.25"></a><span id="l69.25"> }</span>
<a href="#l69.26"></a><span id="l69.26"> </span>
<a href="#l69.27"></a><span id="l69.27"> function getTime() {</span>
<a href="#l69.28"></a><span id="l69.28">     if (g_bShutdown) {</span>
<a href="#l69.29"></a><span id="l69.29">         return null;</span>
<a href="#l69.30"></a><span id="l69.30">     }</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-    return cal.jsDateToDateTime(new Date());</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+    return cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l69.33"></a><span id="l69.33"> }</span>
<a href="#l69.34"></a><span id="l69.34"> </span>
<a href="#l69.35"></a><span id="l69.35"> function getIcalUTC(date) {</span>
<a href="#l69.36"></a><span id="l69.36">     if (!date || !date.isValid) {</span>
<a href="#l69.37"></a><span id="l69.37">         return &quot;0&quot;;</span>
<a href="#l69.38"></a><span id="l69.38">     } else {</span>
<a href="#l69.39"></a><span id="l69.39">         let dtz = date.timezone;</span>
<a href="#l69.40"></a><span id="l69.40">         if (dtz.isUTC || dtz.isFloating) {</span>
<a href="#l69.41"></a><span id="l69.41">             return date.icalString;</span>
<a href="#l69.42"></a><span id="l69.42">         } else {</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineminus">-            return date.getInTimezone(cal.UTC()).icalString;</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+            return date.getInTimezone(cal.dtz.UTC).icalString;</span>
<a href="#l69.45"></a><span id="l69.45">         }</span>
<a href="#l69.46"></a><span id="l69.46">     }</span>
<a href="#l69.47"></a><span id="l69.47"> }</span>
<a href="#l69.48"></a><span id="l69.48"> </span>
<a href="#l69.49"></a><span id="l69.49"> function getDatetimeFromIcalString(val) {</span>
<a href="#l69.50"></a><span id="l69.50">     if (!val || val.length == 0 || val == &quot;0&quot;) {</span>
<a href="#l69.51"></a><span id="l69.51">         return null;</span>
<a href="#l69.52"></a><span id="l69.52">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -155,23 +155,23 @@</span>
<a href="#l70.4"></a><span id="l70.4">             // corresponding to the nearest day in the future that is</span>
<a href="#l70.5"></a><span id="l70.5">             // that day of the week</span>
<a href="#l70.6"></a><span id="l70.6">             function getDateForDay(aWord) {</span>
<a href="#l70.7"></a><span id="l70.7">                 for (let i in self.mDayNames) {</span>
<a href="#l70.8"></a><span id="l70.8">                     if (aWord != self.mDayNames[i]) {</span>
<a href="#l70.9"></a><span id="l70.9">                         continue;</span>
<a href="#l70.10"></a><span id="l70.10">                     }</span>
<a href="#l70.11"></a><span id="l70.11">                     // Figure out what day of the week today is.</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-                    let today = cal.now();</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+                    let today = cal.dtz.now();</span>
<a href="#l70.14"></a><span id="l70.14"> </span>
<a href="#l70.15"></a><span id="l70.15">                     // i-weekday gets the offset. Add 7 to ensure that the %</span>
<a href="#l70.16"></a><span id="l70.16">                     // operation stays positive.</span>
<a href="#l70.17"></a><span id="l70.17">                     let offset = (i - today.weekday + 7) % 7;</span>
<a href="#l70.18"></a><span id="l70.18">                     today.day = today.day + offset;</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineminus">-                    return cal.dateTimeToJsDate(today);</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+                    return cal.dtz.dateTimeToJsDate(today);</span>
<a href="#l70.21"></a><span id="l70.21">                 }</span>
<a href="#l70.22"></a><span id="l70.22">                 return null;</span>
<a href="#l70.23"></a><span id="l70.23">             }</span>
<a href="#l70.24"></a><span id="l70.24"> </span>
<a href="#l70.25"></a><span id="l70.25">             // Remove commas</span>
<a href="#l70.26"></a><span id="l70.26">             val = val.replace(&quot;,&quot;, &quot;&quot;);</span>
<a href="#l70.27"></a><span id="l70.27"> </span>
<a href="#l70.28"></a><span id="l70.28">             if (!val.includes(&quot; &quot;)) {</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineat">@@ -1864,17 +1864,17 @@</span>
<a href="#l70.30"></a><span id="l70.30">             this.amRegExp = new RegExp(&quot;^(?:&quot; + amExpr + &quot;)$&quot;);</span>
<a href="#l70.31"></a><span id="l70.31">             this.pmRegExp = new RegExp(&quot;^(?:&quot; + pmExpr + &quot;)$&quot;);</span>
<a href="#l70.32"></a><span id="l70.32">         ]]&gt;&lt;/body&gt;</span>
<a href="#l70.33"></a><span id="l70.33">       &lt;/method&gt;</span>
<a href="#l70.34"></a><span id="l70.34"> </span>
<a href="#l70.35"></a><span id="l70.35">       &lt;method name=&quot;formatDate&quot;&gt;</span>
<a href="#l70.36"></a><span id="l70.36">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l70.37"></a><span id="l70.37">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineminus">-            return cal.getDateFormatter().formatDateShort(cal.jsDateToDateTime(aDate, cal.floating()));</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineplus">+            return cal.getDateFormatter().formatDateShort(cal.dtz.jsDateToDateTime(aDate, cal.dtz.floating));</span>
<a href="#l70.40"></a><span id="l70.40">         ]]&gt;&lt;/body&gt;</span>
<a href="#l70.41"></a><span id="l70.41">       &lt;/method&gt;</span>
<a href="#l70.42"></a><span id="l70.42"> </span>
<a href="#l70.43"></a><span id="l70.43">       &lt;method name=&quot;formatTime&quot;&gt;</span>
<a href="#l70.44"></a><span id="l70.44">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l70.45"></a><span id="l70.45">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l70.46"></a><span id="l70.46">             let formatter = new Services.intl.DateTimeFormat(undefined, this.kTimeFormatObject);</span>
<a href="#l70.47"></a><span id="l70.47">             return formatter.format(aValue);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -317,17 +317,17 @@ function boxAppendBody(box, textString, </span>
<a href="#l71.4"></a><span id="l71.4">  * PRIVATE: Use dateFormatter to format date and time,</span>
<a href="#l71.5"></a><span id="l71.5">  * and to header grid append a row containing localized Label: date.</span>
<a href="#l71.6"></a><span id="l71.6">  *</span>
<a href="#l71.7"></a><span id="l71.7">  * @param {Node}         box            The node to add the date label to</span>
<a href="#l71.8"></a><span id="l71.8">  * @param {String}       labelProperty  The label</span>
<a href="#l71.9"></a><span id="l71.9">  * @param {calIDateTime} date           The datetime object to format and add</span>
<a href="#l71.10"></a><span id="l71.10">  */</span>
<a href="#l71.11"></a><span id="l71.11"> function boxAppendLabeledDateTime(box, labelProperty, date) {</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-    date = date.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+    date = date.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l71.14"></a><span id="l71.14">     let formattedDateTime = cal.getDateFormatter().formatDateTime(date);</span>
<a href="#l71.15"></a><span id="l71.15">     boxAppendLabeledText(box, labelProperty, formattedDateTime);</span>
<a href="#l71.16"></a><span id="l71.16"> }</span>
<a href="#l71.17"></a><span id="l71.17"> </span>
<a href="#l71.18"></a><span id="l71.18"> /**</span>
<a href="#l71.19"></a><span id="l71.19">  * PRIVATE: Use dateFormatter to format date and time interval,</span>
<a href="#l71.20"></a><span id="l71.20">  * and to header grid append a row containing localized Label: interval.</span>
<a href="#l71.21"></a><span id="l71.21">  *</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineat">@@ -426,17 +426,17 @@ function getCurrentNextOrPreviousRecurre</span>
<a href="#l71.23"></a><span id="l71.23">         return calendarEvent;</span>
<a href="#l71.24"></a><span id="l71.24">     }</span>
<a href="#l71.25"></a><span id="l71.25"> </span>
<a href="#l71.26"></a><span id="l71.26">     let dur = calendarEvent.duration.clone();</span>
<a href="#l71.27"></a><span id="l71.27">     dur.isNegative = true;</span>
<a href="#l71.28"></a><span id="l71.28"> </span>
<a href="#l71.29"></a><span id="l71.29">     // To find current event when now is during event, look for occurrence</span>
<a href="#l71.30"></a><span id="l71.30">     // starting duration ago.</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineminus">-    let probeTime = cal.now();</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+    let probeTime = cal.dtz.now();</span>
<a href="#l71.33"></a><span id="l71.33">     probeTime.addDuration(dur);</span>
<a href="#l71.34"></a><span id="l71.34"> </span>
<a href="#l71.35"></a><span id="l71.35">     let occ = calendarEvent.recurrenceInfo.getNextOccurrence(probeTime);</span>
<a href="#l71.36"></a><span id="l71.36"> </span>
<a href="#l71.37"></a><span id="l71.37">     if (!occ) {</span>
<a href="#l71.38"></a><span id="l71.38">         let occs = calendarEvent.recurrenceInfo.getOccurrences(calendarEvent.startDate, probeTime, 0, {});</span>
<a href="#l71.39"></a><span id="l71.39">         occ = occs[occs.length - 1];</span>
<a href="#l71.40"></a><span id="l71.40">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/test/mozmill/cal-recurrence/testWeeklyUntilRecurrence.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -167,17 +167,17 @@ function setRecurrence(recurrence) {</span>
<a href="#l72.4"></a><span id="l72.4"> </span>
<a href="#l72.5"></a><span id="l72.5">     // delete previous date</span>
<a href="#l72.6"></a><span id="l72.6">     let untilInput = reclookup(REC_DLG_UNTIL_INPUT);</span>
<a href="#l72.7"></a><span id="l72.7">     recurrence.keypress(untilInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l72.8"></a><span id="l72.8">     recurrence.keypress(untilInput, &quot;VK_DELETE&quot;, {});</span>
<a href="#l72.9"></a><span id="l72.9"> </span>
<a href="#l72.10"></a><span id="l72.10">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-    let endDateString = dateFormatter.formatDateShort(cal.jsDateToDateTime(ENDDATE, cal.floating()));</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+    let endDateString = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(ENDDATE, cal.dtz.floating));</span>
<a href="#l72.14"></a><span id="l72.14">     recsleep(SHORT_SLEEP);</span>
<a href="#l72.15"></a><span id="l72.15">     recurrence.type(untilInput, endDateString);</span>
<a href="#l72.16"></a><span id="l72.16"> </span>
<a href="#l72.17"></a><span id="l72.17">     recsleep(SHORT_SLEEP);</span>
<a href="#l72.18"></a><span id="l72.18">     // Move focus to ensure the date is selected</span>
<a href="#l72.19"></a><span id="l72.19">     recurrence.keypress(untilInput, &quot;VK_TAB&quot;, {});</span>
<a href="#l72.20"></a><span id="l72.20"> </span>
<a href="#l72.21"></a><span id="l72.21">     // close dialog</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyUntilRecurrence.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -178,17 +178,17 @@ function setRecurrence(recurrence) {</span>
<a href="#l73.4"></a><span id="l73.4">     `;</span>
<a href="#l73.5"></a><span id="l73.5"> </span>
<a href="#l73.6"></a><span id="l73.6">     // delete previous date</span>
<a href="#l73.7"></a><span id="l73.7">     recurrence.keypress(reclookup(input), &quot;a&quot;, { ctrlKey: true });</span>
<a href="#l73.8"></a><span id="l73.8">     recurrence.keypress(reclookup(input), &quot;VK_DELETE&quot;, {});</span>
<a href="#l73.9"></a><span id="l73.9"> </span>
<a href="#l73.10"></a><span id="l73.10">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-    let endDateString = dateFormatter.formatDateShort(cal.jsDateToDateTime(ENDDATE, cal.floating()));</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+    let endDateString = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(ENDDATE, cal.dtz.floating));</span>
<a href="#l73.14"></a><span id="l73.14"> </span>
<a href="#l73.15"></a><span id="l73.15">     recurrence.type(reclookup(input), endDateString);</span>
<a href="#l73.16"></a><span id="l73.16"> </span>
<a href="#l73.17"></a><span id="l73.17">     // close dialog</span>
<a href="#l73.18"></a><span id="l73.18">     recurrence.click(reclookup(`</span>
<a href="#l73.19"></a><span id="l73.19">         /id(&quot;calendar-event-dialog-recurrence&quot;)/anon({&quot;anonid&quot;:&quot;buttons&quot;})/</span>
<a href="#l73.20"></a><span id="l73.20">         {&quot;dlgtype&quot;:&quot;accept&quot;}</span>
<a href="#l73.21"></a><span id="l73.21">     `));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/test/mozmill/recurrenceRotated/testWeeklyWithExceptionRecurrence.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -85,17 +85,17 @@ function testWeeklyWithExceptionRecurren</span>
<a href="#l74.4"></a><span id="l74.4">             anon({&quot;class&quot;:&quot;menulist-editable-box textbox-input-box&quot;})/</span>
<a href="#l74.5"></a><span id="l74.5">             anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l74.6"></a><span id="l74.6">         `);</span>
<a href="#l74.7"></a><span id="l74.7"> </span>
<a href="#l74.8"></a><span id="l74.8">         event.keypress(startDateInput, &quot;a&quot;, { ctrlKey: true });</span>
<a href="#l74.9"></a><span id="l74.9"> </span>
<a href="#l74.10"></a><span id="l74.10">         let dateFormatter = cal.getDateFormatter();</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-        let startDateString = dateFormatter.formatDateShort(cal.jsDateToDateTime(STARTDATE, cal.floating()));</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+        let startDateString = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(STARTDATE, cal.dtz.floating));</span>
<a href="#l74.14"></a><span id="l74.14">         event.type(startDateInput, startDateString);</span>
<a href="#l74.15"></a><span id="l74.15">         // applies startdate change</span>
<a href="#l74.16"></a><span id="l74.16">         event.click(endDateInput);</span>
<a href="#l74.17"></a><span id="l74.17"> </span>
<a href="#l74.18"></a><span id="l74.18">         event.click(eventid(&quot;button-saveandclose&quot;));</span>
<a href="#l74.19"></a><span id="l74.19">     });</span>
<a href="#l74.20"></a><span id="l74.20"> </span>
<a href="#l74.21"></a><span id="l74.21">     // change recurrence rule</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -711,45 +711,45 @@ function setData(dialog, iframe, data) {</span>
<a href="#l75.4"></a><span id="l75.4">     if (data.timezone != undefined) {</span>
<a href="#l75.5"></a><span id="l75.5">         let menuitem = iframeId(&quot;options-timezones-menuitem&quot;);</span>
<a href="#l75.6"></a><span id="l75.6">         menuitem.getNode().setAttribute(&quot;checked&quot;, data.timezone);</span>
<a href="#l75.7"></a><span id="l75.7">         dialog.click(menuitem);</span>
<a href="#l75.8"></a><span id="l75.8">     }</span>
<a href="#l75.9"></a><span id="l75.9"> </span>
<a href="#l75.10"></a><span id="l75.10">     // startdate</span>
<a href="#l75.11"></a><span id="l75.11">     if (data.startdate != undefined &amp;&amp; data.startdate.constructor.name == &quot;Date&quot;) {</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-        let startdate = dateFormatter.formatDateShort(cal.jsDateToDateTime(data.startdate, cal.floating()));</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+        let startdate = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(data.startdate, cal.dtz.floating));</span>
<a href="#l75.14"></a><span id="l75.14"> </span>
<a href="#l75.15"></a><span id="l75.15">         if (!isEvent) {</span>
<a href="#l75.16"></a><span id="l75.16">             dialog.check(iframeId(&quot;todo-has-entrydate&quot;), true);</span>
<a href="#l75.17"></a><span id="l75.17">         }</span>
<a href="#l75.18"></a><span id="l75.18">         dialog.keypress(startDateInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l75.19"></a><span id="l75.19">         dialog.type(startDateInput, startdate);</span>
<a href="#l75.20"></a><span id="l75.20">     }</span>
<a href="#l75.21"></a><span id="l75.21"> </span>
<a href="#l75.22"></a><span id="l75.22">     // starttime</span>
<a href="#l75.23"></a><span id="l75.23">     if (data.starttime != undefined &amp;&amp; data.starttime.constructor.name == &quot;Date&quot;) {</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineminus">-        let starttime = dateFormatter.formatTime(cal.jsDateToDateTime(data.starttime, cal.floating()));</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineplus">+        let starttime = dateFormatter.formatTime(cal.dtz.jsDateToDateTime(data.starttime, cal.dtz.floating));</span>
<a href="#l75.26"></a><span id="l75.26">         startTimeInput.getNode().value = starttime;</span>
<a href="#l75.27"></a><span id="l75.27">         sleep();</span>
<a href="#l75.28"></a><span id="l75.28">     }</span>
<a href="#l75.29"></a><span id="l75.29"> </span>
<a href="#l75.30"></a><span id="l75.30">     // enddate</span>
<a href="#l75.31"></a><span id="l75.31">     if (data.enddate != undefined &amp;&amp; data.enddate.constructor.name == &quot;Date&quot;) {</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineminus">-        let enddate = dateFormatter.formatDateShort(cal.jsDateToDateTime(data.enddate, cal.floating()));</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineplus">+        let enddate = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(data.enddate, cal.dtz.floating));</span>
<a href="#l75.34"></a><span id="l75.34">         if (!isEvent) {</span>
<a href="#l75.35"></a><span id="l75.35">             dialog.check(iframeId(&quot;todo-has-duedate&quot;), true);</span>
<a href="#l75.36"></a><span id="l75.36">         }</span>
<a href="#l75.37"></a><span id="l75.37">         dialog.keypress(endDateInput, &quot;a&quot;, { accelKey: true });</span>
<a href="#l75.38"></a><span id="l75.38">         dialog.type(endDateInput, enddate);</span>
<a href="#l75.39"></a><span id="l75.39">     }</span>
<a href="#l75.40"></a><span id="l75.40"> </span>
<a href="#l75.41"></a><span id="l75.41">     // endtime</span>
<a href="#l75.42"></a><span id="l75.42">     if (data.endtime != undefined &amp;&amp; data.endtime.constructor.name == &quot;Date&quot;) {</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineminus">-        let endtime = dateFormatter.formatTime(cal.jsDateToDateTime(data.endtime, cal.floating()));</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineplus">+        let endtime = dateFormatter.formatTime(cal.dtz.jsDateToDateTime(data.endtime, cal.dtz.floating));</span>
<a href="#l75.45"></a><span id="l75.45">         endTimeInput.getNode().value = endtime;</span>
<a href="#l75.46"></a><span id="l75.46">     }</span>
<a href="#l75.47"></a><span id="l75.47"> </span>
<a href="#l75.48"></a><span id="l75.48">     // recurrence</span>
<a href="#l75.49"></a><span id="l75.49">     if (data.repeat != undefined) {</span>
<a href="#l75.50"></a><span id="l75.50">         menulistSelect(iframeId(&quot;item-repeat&quot;), data.repeat, dialog);</span>
<a href="#l75.51"></a><span id="l75.51">     }</span>
<a href="#l75.52"></a><span id="l75.52"> </span>
<a href="#l75.53"></a><span id="l75.53" class="difflineat">@@ -787,17 +787,17 @@ function setData(dialog, iframe, data) {</span>
<a href="#l75.54"></a><span id="l75.54">             menulistSelect(iframeId(&quot;todo-status&quot;), data.status.toUpperCase(), dialog);</span>
<a href="#l75.55"></a><span id="l75.55">         }</span>
<a href="#l75.56"></a><span id="l75.56">     }</span>
<a href="#l75.57"></a><span id="l75.57"> </span>
<a href="#l75.58"></a><span id="l75.58">     let currentStatus = iframeId(&quot;todo-status&quot;).getNode().value;</span>
<a href="#l75.59"></a><span id="l75.59"> </span>
<a href="#l75.60"></a><span id="l75.60">     // completed on</span>
<a href="#l75.61"></a><span id="l75.61">     if (data.completed != undefined &amp;&amp; data.completed.constructor.name == &quot;Date&quot; &amp;&amp; !isEvent) {</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineminus">-        let completeddate = dateFormatter.formatDateShort(cal.jsDateToDateTime(data.completed, cal.floating()));</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineplus">+        let completeddate = dateFormatter.formatDateShort(cal.dtz.jsDateToDateTime(data.completed, cal.dtz.floating));</span>
<a href="#l75.64"></a><span id="l75.64"> </span>
<a href="#l75.65"></a><span id="l75.65">         if (currentStatus == &quot;COMPLETED&quot;) {</span>
<a href="#l75.66"></a><span id="l75.66">             completedDateInput.getNode().value = completeddate;</span>
<a href="#l75.67"></a><span id="l75.67">         }</span>
<a href="#l75.68"></a><span id="l75.68">     }</span>
<a href="#l75.69"></a><span id="l75.69"> </span>
<a href="#l75.70"></a><span id="l75.70">     // percent complete</span>
<a href="#l75.71"></a><span id="l75.71">     if (data.percent != undefined &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/test/mozmill/testTodayPane.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/test/mozmill/testTodayPane.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -156,41 +156,41 @@ function testTodayPane() {</span>
<a href="#l76.4"></a><span id="l76.4">         anon({&quot;anonid&quot;:&quot;agenda-checkbox-widget&quot;})/anon({&quot;class&quot;:&quot;checkbox-check&quot;})</span>
<a href="#l76.5"></a><span id="l76.5">     `));</span>
<a href="#l76.6"></a><span id="l76.6">     sleep();</span>
<a href="#l76.7"></a><span id="l76.7"> </span>
<a href="#l76.8"></a><span id="l76.8">     // verify events shown in today pane</span>
<a href="#l76.9"></a><span id="l76.9">     let now = new Date();</span>
<a href="#l76.10"></a><span id="l76.10">     now.setHours(startHour);</span>
<a href="#l76.11"></a><span id="l76.11">     now.setMinutes(0);</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-    let dtz = cal.calendarDefaultTimezone();</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-    let probeDate = cal.jsDateToDateTime(now, dtz);</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+    let dtz = cal.dtz.defaultTimezone;</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+    let probeDate = cal.dtz.jsDateToDateTime(now, dtz);</span>
<a href="#l76.16"></a><span id="l76.16">     let dateFormatter = cal.getDateFormatter();</span>
<a href="#l76.17"></a><span id="l76.17">     let startTime = dateFormatter.formatTime(probeDate);</span>
<a href="#l76.18"></a><span id="l76.18">     controller.assertText(lookup(`</span>
<a href="#l76.19"></a><span id="l76.19">         /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l76.20"></a><span id="l76.20">         [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[2]/</span>
<a href="#l76.21"></a><span id="l76.21">         anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l76.22"></a><span id="l76.22">         anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/</span>
<a href="#l76.23"></a><span id="l76.23">         anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})/</span>
<a href="#l76.24"></a><span id="l76.24">     `), startTime + &quot; Today's Event&quot;);</span>
<a href="#l76.25"></a><span id="l76.25"> </span>
<a href="#l76.26"></a><span id="l76.26">     let tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 9, 0);</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineminus">-    probeDate = cal.jsDateToDateTime(tomorrow, dtz);</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+    probeDate = cal.dtz.jsDateToDateTime(tomorrow, dtz);</span>
<a href="#l76.29"></a><span id="l76.29">     startTime = dateFormatter.formatTime(probeDate);</span>
<a href="#l76.30"></a><span id="l76.30">     controller.assertText(lookup(`</span>
<a href="#l76.31"></a><span id="l76.31">         /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l76.32"></a><span id="l76.32">         [1]/id(&quot;agenda-panel&quot;)/{&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[4]/</span>
<a href="#l76.33"></a><span id="l76.33">         anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l76.34"></a><span id="l76.34">         anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/</span>
<a href="#l76.35"></a><span id="l76.35">         anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})/</span>
<a href="#l76.36"></a><span id="l76.36">     `), startTime + &quot; Tomorrow's Event&quot;);</span>
<a href="#l76.37"></a><span id="l76.37"> </span>
<a href="#l76.38"></a><span id="l76.38">     let future = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 6, 9, 0);</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-    probeDate = cal.jsDateToDateTime(future, dtz);</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+    probeDate = cal.dtz.jsDateToDateTime(future, dtz);</span>
<a href="#l76.41"></a><span id="l76.41">     startTime = dateFormatter.formatDateTime(probeDate);</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43">     // Future event's start time</span>
<a href="#l76.44"></a><span id="l76.44">     controller.assertText(lookup(`</span>
<a href="#l76.45"></a><span id="l76.45">         /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;today-pane-panel&quot;)/</span>
<a href="#l76.46"></a><span id="l76.46">         [1]/id(&quot;agenda-panel&quot;)/</span>
<a href="#l76.47"></a><span id="l76.47">         {&quot;flex&quot;:&quot;1&quot;}/id(&quot;agenda-listbox&quot;)/[6]/anon({&quot;anonid&quot;:&quot;agenda-container-box&quot;})/</span>
<a href="#l76.48"></a><span id="l76.48">         anon({&quot;anonid&quot;:&quot;agenda-description&quot;})/[0]/anon({&quot;anonid&quot;:&quot;agenda-event-start&quot;})</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/test/mozmill/views/testMonthView.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/test/mozmill/views/testMonthView.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -110,17 +110,17 @@ function testMonthView() {</span>
<a href="#l77.4"></a><span id="l77.4">             anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;time-picker&quot;})/</span>
<a href="#l77.5"></a><span id="l77.5">             anon({&quot;class&quot;:&quot;timepicker-box-class&quot;})/</span>
<a href="#l77.6"></a><span id="l77.6">             anon({&quot;class&quot;:&quot;timepicker-text-class&quot;})/anon({&quot;flex&quot;:&quot;1&quot;})/</span>
<a href="#l77.7"></a><span id="l77.7">             anon({&quot;anonid&quot;:&quot;input&quot;})</span>
<a href="#l77.8"></a><span id="l77.8">         `);</span>
<a href="#l77.9"></a><span id="l77.9">         event.waitForElement(startTimeInput);</span>
<a href="#l77.10"></a><span id="l77.10">         event.assertValue(startTimeInput, startTime);</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-        let someTime = cal.now();</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+        let someTime = cal.dtz.now();</span>
<a href="#l77.14"></a><span id="l77.14">         someTime.resetTo(2009, 1, 1);</span>
<a href="#l77.15"></a><span id="l77.15">         let date = dateFormatter.formatDateShort(someDate);</span>
<a href="#l77.16"></a><span id="l77.16">         event.assertValue(eventlookup(`</span>
<a href="#l77.17"></a><span id="l77.17">             ${eventDialog}/id(&quot;event-grid-startdate-row&quot;)/</span>
<a href="#l77.18"></a><span id="l77.18">             id(&quot;event-grid-startdate-picker-box&quot;)/id(&quot;event-starttime&quot;)/</span>
<a href="#l77.19"></a><span id="l77.19">             anon({&quot;anonid&quot;:&quot;hbox&quot;})/anon({&quot;anonid&quot;:&quot;date-picker&quot;})/</span>
<a href="#l77.20"></a><span id="l77.20">             anon({&quot;flex&quot;:&quot;1&quot;,&quot;id&quot;:&quot;hbox&quot;,&quot;class&quot;:&quot;datepicker-box-class&quot;})/</span>
<a href="#l77.21"></a><span id="l77.21">             {&quot;class&quot;:&quot;datepicker-text-class&quot;}/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -37,17 +37,17 @@ function createDate(aYear, aMonth, aDay,</span>
<a href="#l78.4"></a><span id="l78.4">     let date = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l78.5"></a><span id="l78.5">                .createInstance(Ci.calIDateTime);</span>
<a href="#l78.6"></a><span id="l78.6">     date.resetTo(aYear,</span>
<a href="#l78.7"></a><span id="l78.7">                aMonth,</span>
<a href="#l78.8"></a><span id="l78.8">                aDay,</span>
<a href="#l78.9"></a><span id="l78.9">                aHour || 0,</span>
<a href="#l78.10"></a><span id="l78.10">                aMinute || 0,</span>
<a href="#l78.11"></a><span id="l78.11">                aSecond || 0,</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-               aTimezone || cal.UTC());</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+               aTimezone || cal.dtz.UTC);</span>
<a href="#l78.14"></a><span id="l78.14">     date.isDate = !aHasTime;</span>
<a href="#l78.15"></a><span id="l78.15">     return date;</span>
<a href="#l78.16"></a><span id="l78.16"> }</span>
<a href="#l78.17"></a><span id="l78.17"> </span>
<a href="#l78.18"></a><span id="l78.18"> function createEventFromIcalString(icalString) {</span>
<a href="#l78.19"></a><span id="l78.19">     if (/^BEGIN:VCALENDAR/.test(icalString)) {</span>
<a href="#l78.20"></a><span id="l78.20">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l78.21"></a><span id="l78.21">                                .createInstance(Components.interfaces.calIIcsParser);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/test/unit/test_alarmservice.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmservice.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -161,42 +161,42 @@ function createAlarmFromDuration(aOffset</span>
<a href="#l79.4"></a><span id="l79.4"> }</span>
<a href="#l79.5"></a><span id="l79.5"> </span>
<a href="#l79.6"></a><span id="l79.6"> function createEventWithAlarm(aCalendar, aStart, aEnd, aOffset, aRRule) {</span>
<a href="#l79.7"></a><span id="l79.7">     let alarm = null;</span>
<a href="#l79.8"></a><span id="l79.8">     let item = cal.createEvent();</span>
<a href="#l79.9"></a><span id="l79.9"> </span>
<a href="#l79.10"></a><span id="l79.10">     item.id = cal.getUUID();</span>
<a href="#l79.11"></a><span id="l79.11">     item.calendar = aCalendar;</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-    item.startDate = aStart || cal.now();</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-    item.endDate = aEnd || cal.now();</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+    item.startDate = aStart || cal.dtz.now();</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+    item.endDate = aEnd || cal.dtz.now();</span>
<a href="#l79.16"></a><span id="l79.16">     if (aOffset) {</span>
<a href="#l79.17"></a><span id="l79.17">         alarm = createAlarmFromDuration(aOffset);</span>
<a href="#l79.18"></a><span id="l79.18">         item.addAlarm(alarm);</span>
<a href="#l79.19"></a><span id="l79.19">     }</span>
<a href="#l79.20"></a><span id="l79.20">     if (aRRule) {</span>
<a href="#l79.21"></a><span id="l79.21">         item.recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l79.22"></a><span id="l79.22">         item.recurrenceInfo.appendRecurrenceItem(cal.createRecurrenceRule(aRRule));</span>
<a href="#l79.23"></a><span id="l79.23">     }</span>
<a href="#l79.24"></a><span id="l79.24">     return [item, alarm];</span>
<a href="#l79.25"></a><span id="l79.25"> }</span>
<a href="#l79.26"></a><span id="l79.26"> </span>
<a href="#l79.27"></a><span id="l79.27"> function addTestItems(aCalendar) {</span>
<a href="#l79.28"></a><span id="l79.28">     let item, alarm;</span>
<a href="#l79.29"></a><span id="l79.29"> </span>
<a href="#l79.30"></a><span id="l79.30">     // alarm on an item starting more than a month in the past should not fire</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineminus">-    let date = cal.now();</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+    let date = cal.dtz.now();</span>
<a href="#l79.33"></a><span id="l79.33">     date.day -= 32;</span>
<a href="#l79.34"></a><span id="l79.34">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;P7D&quot;);</span>
<a href="#l79.35"></a><span id="l79.35">     item.title=&quot;addTestItems Test 1&quot;;</span>
<a href="#l79.36"></a><span id="l79.36">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_NONE);</span>
<a href="#l79.37"></a><span id="l79.37">     aCalendar.addItem(item, null);</span>
<a href="#l79.38"></a><span id="l79.38"> </span>
<a href="#l79.39"></a><span id="l79.39">     // alarm 15 minutes ago should fire</span>
<a href="#l79.40"></a><span id="l79.40" class="difflineminus">-    date = cal.now();</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineplus">+    date = cal.dtz.now();</span>
<a href="#l79.42"></a><span id="l79.42">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT15M&quot;);</span>
<a href="#l79.43"></a><span id="l79.43">     item.title=&quot;addTestItems Test 2&quot;;</span>
<a href="#l79.44"></a><span id="l79.44">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l79.45"></a><span id="l79.45">     aCalendar.addItem(item, null);</span>
<a href="#l79.46"></a><span id="l79.46"> </span>
<a href="#l79.47"></a><span id="l79.47">     // alarm within 6 hours should have a timer set</span>
<a href="#l79.48"></a><span id="l79.48">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;PT1H&quot;);</span>
<a href="#l79.49"></a><span id="l79.49">     item.title=&quot;addTestItems Test 3&quot;;</span>
<a href="#l79.50"></a><span id="l79.50" class="difflineat">@@ -221,17 +221,17 @@ function addTestItems(aCalendar) {</span>
<a href="#l79.51"></a><span id="l79.51">         alarm = createAlarmFromDuration(offset);</span>
<a href="#l79.52"></a><span id="l79.52">         item.addAlarm(alarm);</span>
<a href="#l79.53"></a><span id="l79.53">         alarmObserver.expectResult(aCalendar, item, alarm, expected);</span>
<a href="#l79.54"></a><span id="l79.54">     });</span>
<a href="#l79.55"></a><span id="l79.55">     aCalendar.addItem(item, null);</span>
<a href="#l79.56"></a><span id="l79.56"> </span>
<a href="#l79.57"></a><span id="l79.57">     // Bug 1344068 - Alarm with lastAck on exception, should take parent lastAck.</span>
<a href="#l79.58"></a><span id="l79.58">     // Alarm 15 minutes ago should fire.</span>
<a href="#l79.59"></a><span id="l79.59" class="difflineminus">-    date = cal.now();</span>
<a href="#l79.60"></a><span id="l79.60" class="difflineplus">+    date = cal.dtz.now();</span>
<a href="#l79.61"></a><span id="l79.61">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT15M&quot;, &quot;RRULE:FREQ=DAILY;COUNT=1&quot;);</span>
<a href="#l79.62"></a><span id="l79.62">     item.title=&quot;addTestItems Test 6&quot;;</span>
<a href="#l79.63"></a><span id="l79.63"> </span>
<a href="#l79.64"></a><span id="l79.64">     // Parent item is acknowledged before alarm, so it should fire.</span>
<a href="#l79.65"></a><span id="l79.65">     let lastAck = item.startDate.clone();</span>
<a href="#l79.66"></a><span id="l79.66">     lastAck.hour -= 1;</span>
<a href="#l79.67"></a><span id="l79.67">     item.alarmLastAck = lastAck;</span>
<a href="#l79.68"></a><span id="l79.68"> </span>
<a href="#l79.69"></a><span id="l79.69" class="difflineat">@@ -242,30 +242,30 @@ function addTestItems(aCalendar) {</span>
<a href="#l79.70"></a><span id="l79.70">     item.recurrenceInfo.modifyException(occ, true);</span>
<a href="#l79.71"></a><span id="l79.71"> </span>
<a href="#l79.72"></a><span id="l79.72">     alarmObserver.expectOccurrences(aCalendar, item, alarm, [EXPECT_FIRED]);</span>
<a href="#l79.73"></a><span id="l79.73">     aCalendar.addItem(item, null);</span>
<a href="#l79.74"></a><span id="l79.74"> </span>
<a href="#l79.75"></a><span id="l79.75"> </span>
<a href="#l79.76"></a><span id="l79.76">     // daily repeating event starting almost 2 full days ago. The alarms on the first 2 occurrences</span>
<a href="#l79.77"></a><span id="l79.77">     // should fire, and a timer should be set for the next occurrence only</span>
<a href="#l79.78"></a><span id="l79.78" class="difflineminus">-    date = cal.now();</span>
<a href="#l79.79"></a><span id="l79.79" class="difflineplus">+    date = cal.dtz.now();</span>
<a href="#l79.80"></a><span id="l79.80">     date.hour -= 47;</span>
<a href="#l79.81"></a><span id="l79.81">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT15M&quot;, &quot;RRULE:FREQ=DAILY&quot;);</span>
<a href="#l79.82"></a><span id="l79.82">     item.title=&quot;addTestItems Test 7&quot;;</span>
<a href="#l79.83"></a><span id="l79.83">     alarmObserver.expectOccurrences(aCalendar, item, alarm, [</span>
<a href="#l79.84"></a><span id="l79.84">         EXPECT_FIRED, EXPECT_FIRED, EXPECT_TIMER, EXPECT_NONE, EXPECT_NONE</span>
<a href="#l79.85"></a><span id="l79.85">     ]);</span>
<a href="#l79.86"></a><span id="l79.86">     aCalendar.addItem(item, null);</span>
<a href="#l79.87"></a><span id="l79.87"> </span>
<a href="#l79.88"></a><span id="l79.88">     // monthly repeating event starting 2 months and a day ago. The alarms on the first 2 occurrences</span>
<a href="#l79.89"></a><span id="l79.89">     // should be ignored, the alarm on the next occurrence only should fire.</span>
<a href="#l79.90"></a><span id="l79.90">     // Missing recurrences of the event in particular days of the year generate exceptions to the</span>
<a href="#l79.91"></a><span id="l79.91">     // regular sequence of alarms.</span>
<a href="#l79.92"></a><span id="l79.92" class="difflineminus">-    date = cal.now();</span>
<a href="#l79.93"></a><span id="l79.93" class="difflineplus">+    date = cal.dtz.now();</span>
<a href="#l79.94"></a><span id="l79.94">     let statusAlarmSequences = {</span>
<a href="#l79.95"></a><span id="l79.95">         reg: [EXPECT_NONE, EXPECT_NONE, EXPECT_FIRED, EXPECT_NONE, EXPECT_NONE],</span>
<a href="#l79.96"></a><span id="l79.96">         excep1: [EXPECT_NONE, EXPECT_FIRED, EXPECT_NONE, EXPECT_NONE, EXPECT_NONE],</span>
<a href="#l79.97"></a><span id="l79.97">         excep2: [EXPECT_NONE, EXPECT_NONE, EXPECT_NONE, EXPECT_NONE, EXPECT_NONE]</span>
<a href="#l79.98"></a><span id="l79.98">     };</span>
<a href="#l79.99"></a><span id="l79.99">     let expected = [];</span>
<a href="#l79.100"></a><span id="l79.100">     if (date.day == 1) {</span>
<a href="#l79.101"></a><span id="l79.101">         // Exceptions for missing occurrences on months with 30 days when the event starts on 31st.</span>
<a href="#l79.102"></a><span id="l79.102" class="difflineat">@@ -294,17 +294,17 @@ function addTestItems(aCalendar) {</span>
<a href="#l79.103"></a><span id="l79.103">     alarmObserver.expectOccurrences(aCalendar, item, alarm, expected);</span>
<a href="#l79.104"></a><span id="l79.104">     aCalendar.addItem(item, null);</span>
<a href="#l79.105"></a><span id="l79.105"> }</span>
<a href="#l79.106"></a><span id="l79.106"> </span>
<a href="#l79.107"></a><span id="l79.107"> function doModifyItemTest(aCalendar) {</span>
<a href="#l79.108"></a><span id="l79.108">     let item, alarm;</span>
<a href="#l79.109"></a><span id="l79.109"> </span>
<a href="#l79.110"></a><span id="l79.110">     // begin with item starting before the alarm date range</span>
<a href="#l79.111"></a><span id="l79.111" class="difflineminus">-    let date = cal.now();</span>
<a href="#l79.112"></a><span id="l79.112" class="difflineplus">+    let date = cal.dtz.now();</span>
<a href="#l79.113"></a><span id="l79.113">     date.day -= 32;</span>
<a href="#l79.114"></a><span id="l79.114">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;PT0S&quot;);</span>
<a href="#l79.115"></a><span id="l79.115">     aCalendar.addItem(item, null);</span>
<a href="#l79.116"></a><span id="l79.116">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_NONE);</span>
<a href="#l79.117"></a><span id="l79.117">     alarmObserver.checkExpected(&quot;doModifyItemTest Test 1&quot;);</span>
<a href="#l79.118"></a><span id="l79.118"> </span>
<a href="#l79.119"></a><span id="l79.119">     // move event into the fired range</span>
<a href="#l79.120"></a><span id="l79.120">     let oldItem = item.clone();</span>
<a href="#l79.121"></a><span id="l79.121" class="difflineat">@@ -340,34 +340,34 @@ function doModifyItemTest(aCalendar) {</span>
<a href="#l79.122"></a><span id="l79.122">     item.startDate = date.clone();</span>
<a href="#l79.123"></a><span id="l79.123">     item.generation++;</span>
<a href="#l79.124"></a><span id="l79.124">     aCalendar.modifyItem(item, oldItem, null);</span>
<a href="#l79.125"></a><span id="l79.125">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_TIMER);</span>
<a href="#l79.126"></a><span id="l79.126">     alarmObserver.checkExpected(&quot;doModifyItemTest Test 5&quot;);</span>
<a href="#l79.127"></a><span id="l79.127">     let oldTimer = alarmObserver.getTimer(aCalendar.id, item.hashId, alarm.icalString);</span>
<a href="#l79.128"></a><span id="l79.128">     oldItem = item.clone();</span>
<a href="#l79.129"></a><span id="l79.129">     // change the timezone to floating</span>
<a href="#l79.130"></a><span id="l79.130" class="difflineminus">-    item.startDate.timezone = cal.floating();</span>
<a href="#l79.131"></a><span id="l79.131" class="difflineplus">+    item.startDate.timezone = cal.dtz.floating;</span>
<a href="#l79.132"></a><span id="l79.132">     item.generation++;</span>
<a href="#l79.133"></a><span id="l79.133">     aCalendar.modifyItem(item, oldItem, null);</span>
<a href="#l79.134"></a><span id="l79.134">     // the alarm must still be timer and with the same value (apart from milliseconds)</span>
<a href="#l79.135"></a><span id="l79.135">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_TIMER);</span>
<a href="#l79.136"></a><span id="l79.136">     alarmObserver.checkExpected(&quot;doModifyItemTest Test 5, floating timezone&quot;);</span>
<a href="#l79.137"></a><span id="l79.137">     let newTimer = alarmObserver.getTimer(aCalendar.id, item.hashId, alarm.icalString);</span>
<a href="#l79.138"></a><span id="l79.138">     ok((newTimer.delay - oldTimer.delay) &lt;= 1000,</span>
<a href="#l79.139"></a><span id="l79.139">        &quot;doModifyItemTest Test 5, floating timezone; check timer value&quot;);</span>
<a href="#l79.140"></a><span id="l79.140"> }</span>
<a href="#l79.141"></a><span id="l79.141"> </span>
<a href="#l79.142"></a><span id="l79.142"> function doDeleteItemTest(aCalendar) {</span>
<a href="#l79.143"></a><span id="l79.143">     alarmObserver.clear();</span>
<a href="#l79.144"></a><span id="l79.144">     let item, alarm;</span>
<a href="#l79.145"></a><span id="l79.145">     let item2, alarm2;</span>
<a href="#l79.146"></a><span id="l79.146"> </span>
<a href="#l79.147"></a><span id="l79.147">     // create a fired alarm and a timer</span>
<a href="#l79.148"></a><span id="l79.148" class="difflineminus">-    let date = cal.now();</span>
<a href="#l79.149"></a><span id="l79.149" class="difflineplus">+    let date = cal.dtz.now();</span>
<a href="#l79.150"></a><span id="l79.150">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT5M&quot;);</span>
<a href="#l79.151"></a><span id="l79.151">     [item2, alarm2] = createEventWithAlarm(aCalendar, date, date, &quot;PT1H&quot;);</span>
<a href="#l79.152"></a><span id="l79.152">     item.title=&quot;doDeleteItemTest item Test 1&quot;;</span>
<a href="#l79.153"></a><span id="l79.153">     item2.title=&quot;doDeleteItemTest item2 Test 1&quot;;</span>
<a href="#l79.154"></a><span id="l79.154">     aCalendar.addItem(item, null);</span>
<a href="#l79.155"></a><span id="l79.155">     aCalendar.addItem(item2, null);</span>
<a href="#l79.156"></a><span id="l79.156">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l79.157"></a><span id="l79.157">     alarmObserver.expectResult(aCalendar, item2, alarm2, EXPECT_TIMER);</span>
<a href="#l79.158"></a><span id="l79.158" class="difflineat">@@ -382,17 +382,17 @@ function doDeleteItemTest(aCalendar) {</span>
<a href="#l79.159"></a><span id="l79.159"> }</span>
<a href="#l79.160"></a><span id="l79.160"> </span>
<a href="#l79.161"></a><span id="l79.161"> function doAcknowledgeTest(aCalendar) {</span>
<a href="#l79.162"></a><span id="l79.162">     alarmObserver.clear();</span>
<a href="#l79.163"></a><span id="l79.163">     let item, alarm;</span>
<a href="#l79.164"></a><span id="l79.164">     let item2, alarm2;</span>
<a href="#l79.165"></a><span id="l79.165"> </span>
<a href="#l79.166"></a><span id="l79.166">     // create the fired alarms</span>
<a href="#l79.167"></a><span id="l79.167" class="difflineminus">-    let date = cal.now();</span>
<a href="#l79.168"></a><span id="l79.168" class="difflineplus">+    let date = cal.dtz.now();</span>
<a href="#l79.169"></a><span id="l79.169">     [item, alarm] = createEventWithAlarm(aCalendar, date, date, &quot;-PT5M&quot;);</span>
<a href="#l79.170"></a><span id="l79.170">     [item2, alarm2] = createEventWithAlarm(aCalendar, date, date, &quot;-PT5M&quot;);</span>
<a href="#l79.171"></a><span id="l79.171">     item.title=&quot;doAcknowledgeTest item Test 1&quot;;</span>
<a href="#l79.172"></a><span id="l79.172">     item2.title=&quot;doAcknowledgeTest item2 Test 1&quot;;</span>
<a href="#l79.173"></a><span id="l79.173">     aCalendar.addItem(item, null);</span>
<a href="#l79.174"></a><span id="l79.174">     aCalendar.addItem(item2, null);</span>
<a href="#l79.175"></a><span id="l79.175">     alarmObserver.expectResult(aCalendar, item, alarm, EXPECT_FIRED);</span>
<a href="#l79.176"></a><span id="l79.176">     alarmObserver.expectResult(aCalendar, item2, alarm2, EXPECT_FIRED);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/test/unit/test_alarmutils.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmutils.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -61,19 +61,19 @@ add_task(function* test_setDefaultValues</span>
<a href="#l80.4"></a><span id="l80.4"> </span>
<a href="#l80.5"></a><span id="l80.5">     Preferences.reset(&quot;calendar.alarms.onforevents&quot;);</span>
<a href="#l80.6"></a><span id="l80.6">     Preferences.reset(&quot;calendar.alarms.eventalarmunit&quot;);</span>
<a href="#l80.7"></a><span id="l80.7">     Preferences.reset(&quot;calendar.alarms.eventalarmlen&quot;);</span>
<a href="#l80.8"></a><span id="l80.8"> });</span>
<a href="#l80.9"></a><span id="l80.9"> </span>
<a href="#l80.10"></a><span id="l80.10"> add_task(function* test_setDefaultValues_tasks() {</span>
<a href="#l80.11"></a><span id="l80.11">     let item, alarm;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-    let calnow = cal.now;</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+    let calnow = cal.dtz.now;</span>
<a href="#l80.14"></a><span id="l80.14">     let nowDate = cal.createDateTime(&quot;20150815T120000&quot;);</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineminus">-    cal.now = function() {</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineplus">+    cal.dtz.now = function() {</span>
<a href="#l80.17"></a><span id="l80.17">         return nowDate;</span>
<a href="#l80.18"></a><span id="l80.18">     };</span>
<a href="#l80.19"></a><span id="l80.19"> </span>
<a href="#l80.20"></a><span id="l80.20">     Preferences.set(&quot;calendar.alarms.onfortodos&quot;, 1);</span>
<a href="#l80.21"></a><span id="l80.21">     Preferences.set(&quot;calendar.alarms.todoalarmunit&quot;, &quot;hours&quot;);</span>
<a href="#l80.22"></a><span id="l80.22">     Preferences.set(&quot;calendar.alarms.todoalarmlen&quot;, 60);</span>
<a href="#l80.23"></a><span id="l80.23">     item = cal.createTodo();</span>
<a href="#l80.24"></a><span id="l80.24">     equal(item.entryDate, null);</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineat">@@ -117,17 +117,17 @@ add_task(function* test_setDefaultValues</span>
<a href="#l80.26"></a><span id="l80.26">     ok(alarm);</span>
<a href="#l80.27"></a><span id="l80.27">     equal(alarm.related, alarm.ALARM_RELATED_START);</span>
<a href="#l80.28"></a><span id="l80.28">     equal(alarm.action, &quot;SHOUT&quot;);</span>
<a href="#l80.29"></a><span id="l80.29">     equal(alarm.offset.icalString, &quot;-P2DT12H&quot;);</span>
<a href="#l80.30"></a><span id="l80.30"> </span>
<a href="#l80.31"></a><span id="l80.31">     Preferences.reset(&quot;calendar.alarms.onfortodos&quot;);</span>
<a href="#l80.32"></a><span id="l80.32">     Preferences.reset(&quot;calendar.alarms.todoalarmunit&quot;);</span>
<a href="#l80.33"></a><span id="l80.33">     Preferences.reset(&quot;calendar.alarms.todoalarmlen&quot;);</span>
<a href="#l80.34"></a><span id="l80.34" class="difflineminus">-    cal.now = calnow;</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineplus">+    cal.dtz.now = calnow;</span>
<a href="#l80.36"></a><span id="l80.36"> });</span>
<a href="#l80.37"></a><span id="l80.37"> </span>
<a href="#l80.38"></a><span id="l80.38"> add_task(function* test_calculateAlarmDate() {</span>
<a href="#l80.39"></a><span id="l80.39">     let item = cal.createEvent();</span>
<a href="#l80.40"></a><span id="l80.40">     item.startDate = cal.createDateTime(&quot;20150815T120000&quot;);</span>
<a href="#l80.41"></a><span id="l80.41">     item.endDate = cal.createDateTime(&quot;20150815T130000&quot;);</span>
<a href="#l80.42"></a><span id="l80.42"> </span>
<a href="#l80.43"></a><span id="l80.43">     let calculateAlarmDate = cal.alarms.calculateAlarmDate.bind(cal.alarms, item);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/test/unit/test_bug272411.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/test/unit/test_bug272411.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l81.4"></a><span id="l81.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l81.5"></a><span id="l81.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l81.6"></a><span id="l81.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l81.7"></a><span id="l81.7"> </span>
<a href="#l81.8"></a><span id="l81.8"> function run_test() {</span>
<a href="#l81.9"></a><span id="l81.9">     let jsd = new Date();</span>
<a href="#l81.10"></a><span id="l81.10" class="difflineminus">-    let cdt = cal.jsDateToDateTime(jsd);</span>
<a href="#l81.11"></a><span id="l81.11" class="difflineplus">+    let cdt = cal.dtz.jsDateToDateTime(jsd);</span>
<a href="#l81.12"></a><span id="l81.12"> </span>
<a href="#l81.13"></a><span id="l81.13" class="difflineminus">-    let cdtTime = cal.dateTimeToJsDate(cdt).getTime() / 1000;</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineplus">+    let cdtTime = cal.dtz.dateTimeToJsDate(cdt).getTime() / 1000;</span>
<a href="#l81.15"></a><span id="l81.15">     let jsdTime = Math.floor(jsd.getTime() / 1000);</span>
<a href="#l81.16"></a><span id="l81.16"> </span>
<a href="#l81.17"></a><span id="l81.17">     // calIDateTime is only accurate to the second, milliseconds need to be</span>
<a href="#l81.18"></a><span id="l81.18">     // stripped.</span>
<a href="#l81.19"></a><span id="l81.19">     equal(cdtTime, jsdTime);</span>
<a href="#l81.20"></a><span id="l81.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/test/unit/test_calmgr.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/test/unit/test_calmgr.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -148,18 +148,18 @@ add_test(function test_calobserver() {</span>
<a href="#l82.4"></a><span id="l82.4">     calmgr.registerCalendar(memory);</span>
<a href="#l82.5"></a><span id="l82.5">     calmgr.registerCalendar(memory2);</span>
<a href="#l82.6"></a><span id="l82.6">     calmgr.addCalendarObserver(allobs);</span>
<a href="#l82.7"></a><span id="l82.7">     memory.addObserver(calobs);</span>
<a href="#l82.8"></a><span id="l82.8"> </span>
<a href="#l82.9"></a><span id="l82.9">     // Add an item</span>
<a href="#l82.10"></a><span id="l82.10">     let item = cal.createEvent();</span>
<a href="#l82.11"></a><span id="l82.11">     item.id = cal.getUUID();</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-    item.startDate = cal.now();</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineminus">-    item.endDate = cal.now();</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+    item.startDate = cal.dtz.now();</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+    item.endDate = cal.dtz.now();</span>
<a href="#l82.16"></a><span id="l82.16">     memory.addItem(item, null);</span>
<a href="#l82.17"></a><span id="l82.17">     checkCounters(1, 0, 0);</span>
<a href="#l82.18"></a><span id="l82.18"> </span>
<a href="#l82.19"></a><span id="l82.19">     // Modify the item</span>
<a href="#l82.20"></a><span id="l82.20">     let newItem = item.clone();</span>
<a href="#l82.21"></a><span id="l82.21">     newItem.title = &quot;title&quot;;</span>
<a href="#l82.22"></a><span id="l82.22">     memory.modifyItem(newItem, item, null);</span>
<a href="#l82.23"></a><span id="l82.23">     checkCounters(0, 1, 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/test/unit/test_datetime.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/test/unit/test_datetime.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -14,21 +14,21 @@ function really_run_test() {</span>
<a href="#l83.4"></a><span id="l83.4">     let date = cal.createDateTime();</span>
<a href="#l83.5"></a><span id="l83.5">     date.resetTo(2005, 10, 13,</span>
<a href="#l83.6"></a><span id="l83.6">                  10, 0, 0,</span>
<a href="#l83.7"></a><span id="l83.7">                  getMozTimezone(&quot;/mozilla.org/20050126_1/America/Bogota&quot;));</span>
<a href="#l83.8"></a><span id="l83.8"> </span>
<a href="#l83.9"></a><span id="l83.9">     equal(date.hour, 10);</span>
<a href="#l83.10"></a><span id="l83.10">     equal(date.icalString, &quot;20051113T100000&quot;);</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-    let date_floating = date.getInTimezone(cal.floating());</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+    let date_floating = date.getInTimezone(cal.dtz.floating);</span>
<a href="#l83.14"></a><span id="l83.14">     equal(date_floating.hour, 10);</span>
<a href="#l83.15"></a><span id="l83.15"> </span>
<a href="#l83.16"></a><span id="l83.16"> </span>
<a href="#l83.17"></a><span id="l83.17" class="difflineminus">-    let date_utc = date.getInTimezone(cal.UTC());</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineplus">+    let date_utc = date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l83.19"></a><span id="l83.19">     equal(date_utc.hour, 15);</span>
<a href="#l83.20"></a><span id="l83.20">     equal(date_utc.icalString, &quot;20051113T150000Z&quot;);</span>
<a href="#l83.21"></a><span id="l83.21"> </span>
<a href="#l83.22"></a><span id="l83.22">     date.hour = 25;</span>
<a href="#l83.23"></a><span id="l83.23">     equal(date.hour, 1);</span>
<a href="#l83.24"></a><span id="l83.24">     equal(date.day, 14);</span>
<a href="#l83.25"></a><span id="l83.25"> </span>
<a href="#l83.26"></a><span id="l83.26"> </span>
<a href="#l83.27"></a><span id="l83.27" class="difflineat">@@ -53,17 +53,17 @@ function really_run_test() {</span>
<a href="#l83.28"></a><span id="l83.28"> </span>
<a href="#l83.29"></a><span id="l83.29">     // Bug 398724 - Problems with floating all-day items</span>
<a href="#l83.30"></a><span id="l83.30">     let event = cal.createEvent(&quot;BEGIN:VEVENT\nUID:45674d53-229f-48c6-9f3b-f2b601e7ae4d\nSUMMARY:New Event\nDTSTART;VALUE=DATE:20071003\nDTEND;VALUE=DATE:20071004\nEND:VEVENT&quot;);</span>
<a href="#l83.31"></a><span id="l83.31">     ok(event.startDate.timezone.isFloating);</span>
<a href="#l83.32"></a><span id="l83.32">     ok(event.endDate.timezone.isFloating);</span>
<a href="#l83.33"></a><span id="l83.33"> </span>
<a href="#l83.34"></a><span id="l83.34">     // Bug 392853 - Same times, different timezones, but subtractDate says times are PT0S apart</span>
<a href="#l83.35"></a><span id="l83.35">     const zeroLength = cal.createDuration();</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineminus">-    const a = cal.jsDateToDateTime(new Date());</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineplus">+    const a = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l83.38"></a><span id="l83.38">     a.timezone = getMozTimezone(&quot;/mozilla.org/20071231_1/Europe/Berlin&quot;);</span>
<a href="#l83.39"></a><span id="l83.39"> </span>
<a href="#l83.40"></a><span id="l83.40">     let b = a.clone();</span>
<a href="#l83.41"></a><span id="l83.41">     b.timezone = getMozTimezone(&quot;/mozilla.org/20071231_1/America/New_York&quot;);</span>
<a href="#l83.42"></a><span id="l83.42"> </span>
<a href="#l83.43"></a><span id="l83.43">     let duration = a.subtractDate(b);</span>
<a href="#l83.44"></a><span id="l83.44">     notEqual(duration.compare(zeroLength), 0);</span>
<a href="#l83.45"></a><span id="l83.45">     notEqual(a.compare(b), 0);</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineat">@@ -85,16 +85,16 @@ function really_run_test() {</span>
<a href="#l83.47"></a><span id="l83.47">     // A newly created date should be in UTC, as should its clone</span>
<a href="#l83.48"></a><span id="l83.48">     let utc = cal.createDateTime();</span>
<a href="#l83.49"></a><span id="l83.49">     equal(utc.timezone.tzid, &quot;UTC&quot;);</span>
<a href="#l83.50"></a><span id="l83.50">     equal(utc.clone().timezone.tzid, &quot;UTC&quot;);</span>
<a href="#l83.51"></a><span id="l83.51">     equal(utc.timezoneOffset, 0);</span>
<a href="#l83.52"></a><span id="l83.52"> </span>
<a href="#l83.53"></a><span id="l83.53">     // Bug 794477 - setting jsdate across compartments needs to work</span>
<a href="#l83.54"></a><span id="l83.54">     let someDate = new Date();</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineminus">-    let createdDate = cal.jsDateToDateTime(someDate).getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineplus">+    let createdDate = cal.dtz.jsDateToDateTime(someDate).getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l83.57"></a><span id="l83.57">     someDate.setMilliseconds(0);</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineminus">-    equal(someDate.getTime(), cal.dateTimeToJsDate(createdDate).getTime());</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineplus">+    equal(someDate.getTime(), cal.dtz.dateTimeToJsDate(createdDate).getTime());</span>
<a href="#l83.60"></a><span id="l83.60"> </span>
<a href="#l83.61"></a><span id="l83.61">     // Comparing a date-time with a date of the same day should be 0</span>
<a href="#l83.62"></a><span id="l83.62">     equal(cal.createDateTime(&quot;20120101T120000&quot;).compare(cal.createDateTime(&quot;20120101&quot;)), 0);</span>
<a href="#l83.63"></a><span id="l83.63">     equal(cal.createDateTime(&quot;20120101&quot;).compare(cal.createDateTime(&quot;20120101T120000&quot;)), 0);</span>
<a href="#l83.64"></a><span id="l83.64"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/test/unit/test_datetime_before_1970.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/test/unit/test_datetime_before_1970.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l84.4"></a><span id="l84.4"> function run_test() {</span>
<a href="#l84.5"></a><span id="l84.5">     // Bug 769938 - dates before 1970 are not handled correctly</span>
<a href="#l84.6"></a><span id="l84.6">     // due to signed vs. unsigned mismatch in PRTime in xpconnect</span>
<a href="#l84.7"></a><span id="l84.7"> </span>
<a href="#l84.8"></a><span id="l84.8">     let dateTime1950 = cal.createDateTime();</span>
<a href="#l84.9"></a><span id="l84.9">     dateTime1950.year = 1950;</span>
<a href="#l84.10"></a><span id="l84.10">     equal(dateTime1950.year, 1950);</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-    let dateTime1955 = cal.jsDateToDateTime(new Date(1955, 6, 15));</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+    let dateTime1955 = cal.dtz.jsDateToDateTime(new Date(1955, 6, 15));</span>
<a href="#l84.14"></a><span id="l84.14">     equal(dateTime1955.year, 1955);</span>
<a href="#l84.15"></a><span id="l84.15"> </span>
<a href="#l84.16"></a><span id="l84.16">     let dateTime1965 = cal.createDateTime();</span>
<a href="#l84.17"></a><span id="l84.17">     dateTime1965.nativeTime = -150000000000000;</span>
<a href="#l84.18"></a><span id="l84.18">     equal(dateTime1965.year, 1965);</span>
<a href="#l84.19"></a><span id="l84.19">     equal(dateTime1965.nativeTime, -150000000000000);</span>
<a href="#l84.20"></a><span id="l84.20"> </span>
<a href="#l84.21"></a><span id="l84.21">     let dateTime1990 = cal.createDateTime();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/test/unit/test_datetimeformatter.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/test/unit/test_datetimeformatter.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -38,17 +38,17 @@ add_task(function* formatDate_test() {</span>
<a href="#l85.4"></a><span id="l85.4"> </span>
<a href="#l85.5"></a><span id="l85.5"> </span>
<a href="#l85.6"></a><span id="l85.6">     let tzs = cal.getTimezoneService();</span>
<a href="#l85.7"></a><span id="l85.7"> </span>
<a href="#l85.8"></a><span id="l85.8">     let i = 0;</span>
<a href="#l85.9"></a><span id="l85.9">     for (let test of data) {</span>
<a href="#l85.10"></a><span id="l85.10">         i++;</span>
<a href="#l85.11"></a><span id="l85.11">         Preferences.set(&quot;calendar.date.format&quot;, test.input.dateformat);</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.floating() : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.14"></a><span id="l85.14">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l85.15"></a><span id="l85.15"> </span>
<a href="#l85.16"></a><span id="l85.16">         let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l85.17"></a><span id="l85.17">                                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l85.18"></a><span id="l85.18">         let formatted = dtFormatter.formatDate(date);</span>
<a href="#l85.19"></a><span id="l85.19">         ok(</span>
<a href="#l85.20"></a><span id="l85.20">             test.expected.includes(formatted),</span>
<a href="#l85.21"></a><span id="l85.21">             &quot;(test #&quot; + i + &quot;: result '&quot; + formatted + &quot;', expected '&quot; + test.expected + &quot;')&quot;</span>
<a href="#l85.22"></a><span id="l85.22" class="difflineat">@@ -117,17 +117,17 @@ add_task(function* formatDateShort_test(</span>
<a href="#l85.23"></a><span id="l85.23">     Preferences.set(&quot;calendar.date.format&quot;, 0);</span>
<a href="#l85.24"></a><span id="l85.24"> </span>
<a href="#l85.25"></a><span id="l85.25">     let tzs = cal.getTimezoneService();</span>
<a href="#l85.26"></a><span id="l85.26"> </span>
<a href="#l85.27"></a><span id="l85.27">     let i = 0;</span>
<a href="#l85.28"></a><span id="l85.28">     for (let test of data) {</span>
<a href="#l85.29"></a><span id="l85.29">         i++;</span>
<a href="#l85.30"></a><span id="l85.30"> </span>
<a href="#l85.31"></a><span id="l85.31" class="difflineminus">-        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.floating() : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineplus">+        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.33"></a><span id="l85.33">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l85.34"></a><span id="l85.34"> </span>
<a href="#l85.35"></a><span id="l85.35">         let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l85.36"></a><span id="l85.36">                                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l85.37"></a><span id="l85.37"> </span>
<a href="#l85.38"></a><span id="l85.38">         let formatted = dtFormatter.formatDateShort(date);</span>
<a href="#l85.39"></a><span id="l85.39">         ok(</span>
<a href="#l85.40"></a><span id="l85.40">             test.expected.includes(formatted),</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineat">@@ -197,17 +197,17 @@ add_task(function* formatDateLong_test()</span>
<a href="#l85.42"></a><span id="l85.42">     Preferences.set(&quot;calendar.date.format&quot;, 1);</span>
<a href="#l85.43"></a><span id="l85.43"> </span>
<a href="#l85.44"></a><span id="l85.44">     let tzs = cal.getTimezoneService();</span>
<a href="#l85.45"></a><span id="l85.45"> </span>
<a href="#l85.46"></a><span id="l85.46">     let i = 0;</span>
<a href="#l85.47"></a><span id="l85.47">     for (let test of data) {</span>
<a href="#l85.48"></a><span id="l85.48">         i++;</span>
<a href="#l85.49"></a><span id="l85.49"> </span>
<a href="#l85.50"></a><span id="l85.50" class="difflineminus">-        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.floating() : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.51"></a><span id="l85.51" class="difflineplus">+        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.52"></a><span id="l85.52">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l85.53"></a><span id="l85.53"> </span>
<a href="#l85.54"></a><span id="l85.54">         let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l85.55"></a><span id="l85.55">                                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l85.56"></a><span id="l85.56"> </span>
<a href="#l85.57"></a><span id="l85.57">         let formatted = dtFormatter.formatDateLong(date);</span>
<a href="#l85.58"></a><span id="l85.58">         ok(</span>
<a href="#l85.59"></a><span id="l85.59">             test.expected.includes(formatted),</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineat">@@ -277,17 +277,17 @@ add_task(function* formatDateWithoutYear</span>
<a href="#l85.61"></a><span id="l85.61">     Preferences.set(&quot;calendar.date.format&quot;, 1);</span>
<a href="#l85.62"></a><span id="l85.62"> </span>
<a href="#l85.63"></a><span id="l85.63">     let tzs = cal.getTimezoneService();</span>
<a href="#l85.64"></a><span id="l85.64"> </span>
<a href="#l85.65"></a><span id="l85.65">     let i = 0;</span>
<a href="#l85.66"></a><span id="l85.66">     for (let test of data) {</span>
<a href="#l85.67"></a><span id="l85.67">         i++;</span>
<a href="#l85.68"></a><span id="l85.68"> </span>
<a href="#l85.69"></a><span id="l85.69" class="difflineminus">-        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.floating() : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.70"></a><span id="l85.70" class="difflineplus">+        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.71"></a><span id="l85.71">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l85.72"></a><span id="l85.72"> </span>
<a href="#l85.73"></a><span id="l85.73">         let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l85.74"></a><span id="l85.74">                                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l85.75"></a><span id="l85.75"> </span>
<a href="#l85.76"></a><span id="l85.76">         equal(dtFormatter.formatDateWithoutYear(date), test.expected, &quot;(test #&quot; + i + &quot;)&quot;);</span>
<a href="#l85.77"></a><span id="l85.77">     }</span>
<a href="#l85.78"></a><span id="l85.78">     // let's reset the preferences</span>
<a href="#l85.79"></a><span id="l85.79" class="difflineat">@@ -332,17 +332,17 @@ add_task(function* formatTime_test() {</span>
<a href="#l85.80"></a><span id="l85.80">     Preferences.set(&quot;calendar.timezone.local&quot;, &quot;Pacific/Fakaofo&quot;);</span>
<a href="#l85.81"></a><span id="l85.81"> </span>
<a href="#l85.82"></a><span id="l85.82">     let tzs = cal.getTimezoneService();</span>
<a href="#l85.83"></a><span id="l85.83"> </span>
<a href="#l85.84"></a><span id="l85.84">     let i = 0;</span>
<a href="#l85.85"></a><span id="l85.85">     for (let test of data) {</span>
<a href="#l85.86"></a><span id="l85.86">         i++;</span>
<a href="#l85.87"></a><span id="l85.87"> </span>
<a href="#l85.88"></a><span id="l85.88" class="difflineminus">-        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.floating() : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.89"></a><span id="l85.89" class="difflineplus">+        let zone = (test.input.timezone == &quot;floating&quot;) ? cal.dtz.floating : tzs.getTimezone(test.input.timezone);</span>
<a href="#l85.90"></a><span id="l85.90">         let date = cal.createDateTime(test.input.datetime).getInTimezone(zone);</span>
<a href="#l85.91"></a><span id="l85.91"> </span>
<a href="#l85.92"></a><span id="l85.92">         let dtFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l85.93"></a><span id="l85.93">                                     .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l85.94"></a><span id="l85.94"> </span>
<a href="#l85.95"></a><span id="l85.95">         let formatted = dtFormatter.formatTime(date);</span>
<a href="#l85.96"></a><span id="l85.96">         ok(</span>
<a href="#l85.97"></a><span id="l85.97">             test.expected.includes(formatted),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/test/unit/test_deleted_items.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/test/unit/test_deleted_items.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -34,30 +34,30 @@ add_task(function* test_deleted_items() </span>
<a href="#l86.4"></a><span id="l86.4">     // error.</span>
<a href="#l86.5"></a><span id="l86.5">     yield check_delmgr_call(() =&gt; delmgr.flush());</span>
<a href="#l86.6"></a><span id="l86.6"> </span>
<a href="#l86.7"></a><span id="l86.7">     let memory = calmgr.createCalendar(&quot;memory&quot;, Services.io.newURI(&quot;moz-storage-calendar://&quot;));</span>
<a href="#l86.8"></a><span id="l86.8">     calmgr.registerCalendar(memory);</span>
<a href="#l86.9"></a><span id="l86.9"> </span>
<a href="#l86.10"></a><span id="l86.10">     let item = cal.createEvent();</span>
<a href="#l86.11"></a><span id="l86.11">     item.id = &quot;test-item-1&quot;;</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-    item.startDate = cal.now();</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-    item.endDate = cal.now();</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+    item.startDate = cal.dtz.now();</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineplus">+    item.endDate = cal.dtz.now();</span>
<a href="#l86.16"></a><span id="l86.16"> </span>
<a href="#l86.17"></a><span id="l86.17">     // Add the item, it still shouldn't be in the deleted database.</span>
<a href="#l86.18"></a><span id="l86.18">     yield check_delmgr_call(() =&gt; memory.addItem(item, null));</span>
<a href="#l86.19"></a><span id="l86.19">     equal(delmgr.getDeletedDate(item.id), null);</span>
<a href="#l86.20"></a><span id="l86.20">     equal(delmgr.getDeletedDate(item.id, memory.id), null);</span>
<a href="#l86.21"></a><span id="l86.21"> </span>
<a href="#l86.22"></a><span id="l86.22">     // We need to stop time so we have something to compare with.</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineminus">-    let referenceDate = cal.createDateTime(&quot;20120726T112045&quot;); referenceDate.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineminus">-    let futureDate = cal.createDateTime(&quot;20380101T000000&quot;); futureDate.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineplus">+    let referenceDate = cal.createDateTime(&quot;20120726T112045&quot;); referenceDate.timezone = cal.dtz.defaultTimezone;</span>
<a href="#l86.26"></a><span id="l86.26" class="difflineplus">+    let futureDate = cal.createDateTime(&quot;20380101T000000&quot;); futureDate.timezone = cal.dtz.defaultTimezone;</span>
<a href="#l86.27"></a><span id="l86.27">     let useFutureDate = false;</span>
<a href="#l86.28"></a><span id="l86.28" class="difflineminus">-    let oldNowFunction = cal.now;</span>
<a href="#l86.29"></a><span id="l86.29" class="difflineminus">-    cal.now = function() {</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineplus">+    let oldNowFunction = cal.dtz.now;</span>
<a href="#l86.31"></a><span id="l86.31" class="difflineplus">+    cal.dtz.now = function() {</span>
<a href="#l86.32"></a><span id="l86.32">         return (useFutureDate ? futureDate : referenceDate).clone();</span>
<a href="#l86.33"></a><span id="l86.33">     };</span>
<a href="#l86.34"></a><span id="l86.34"> </span>
<a href="#l86.35"></a><span id="l86.35">     // Deleting an item should trigger it being marked for deletion.</span>
<a href="#l86.36"></a><span id="l86.36">     yield check_delmgr_call(() =&gt; memory.deleteItem(item, null));</span>
<a href="#l86.37"></a><span id="l86.37"> </span>
<a href="#l86.38"></a><span id="l86.38">     // Now check if it was deleted at our reference date.</span>
<a href="#l86.39"></a><span id="l86.39">     let deltime = delmgr.getDeletedDate(item.id);</span>
<a href="#l86.40"></a><span id="l86.40" class="difflineat">@@ -85,10 +85,10 @@ add_task(function* test_deleted_items() </span>
<a href="#l86.41"></a><span id="l86.41">     yield check_delmgr_call(() =&gt; memory.addItem(item, null));</span>
<a href="#l86.42"></a><span id="l86.42">     equal(delmgr.getDeletedDate(item.id), null);</span>
<a href="#l86.43"></a><span id="l86.43">     yield check_delmgr_call(() =&gt; memory.deleteItem(item, null));</span>
<a href="#l86.44"></a><span id="l86.44">     equal(delmgr.getDeletedDate(item.id).compare(referenceDate), 0);</span>
<a href="#l86.45"></a><span id="l86.45">     yield check_delmgr_call(() =&gt; memory.addItem(item, null));</span>
<a href="#l86.46"></a><span id="l86.46">     equal(delmgr.getDeletedDate(item.id), null);</span>
<a href="#l86.47"></a><span id="l86.47"> </span>
<a href="#l86.48"></a><span id="l86.48">     // Revert now function, in case more tests are written.</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineminus">-    cal.now = oldNowFunction;</span>
<a href="#l86.50"></a><span id="l86.50" class="difflineplus">+    cal.dtz.now = oldNowFunction;</span>
<a href="#l86.51"></a><span id="l86.51"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/test/unit/test_gdata_provider.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -393,35 +393,35 @@ GDataServer.prototype = {</span>
<a href="#l87.4"></a><span id="l87.4">         jsonData.kind = &quot;calendar#event&quot;;</span>
<a href="#l87.5"></a><span id="l87.5">         jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l87.6"></a><span id="l87.6">         jsonData.id = generateID();</span>
<a href="#l87.7"></a><span id="l87.7">         if (!isImport) { jsonData.htmlLink = this.baseUri + &quot;/calendar/event?eid=&quot; + jsonData.id; }</span>
<a href="#l87.8"></a><span id="l87.8">         if (!isImport || !jsonData.iCalUID) {</span>
<a href="#l87.9"></a><span id="l87.9">             jsonData.iCalUID = jsonData.id + &quot;@google.com&quot;;</span>
<a href="#l87.10"></a><span id="l87.10">         }</span>
<a href="#l87.11"></a><span id="l87.11">         if (!isImport || !jsonData.created) {</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-            jsonData.created = cal.toRFC3339(cal.now());</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+            jsonData.created = cal.toRFC3339(cal.dtz.now());</span>
<a href="#l87.14"></a><span id="l87.14">         }</span>
<a href="#l87.15"></a><span id="l87.15">         if (!isImport || !jsonData.updated) {</span>
<a href="#l87.16"></a><span id="l87.16" class="difflineminus">-            jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l87.17"></a><span id="l87.17" class="difflineplus">+            jsonData.updated = cal.toRFC3339(cal.dtz.now());</span>
<a href="#l87.18"></a><span id="l87.18">         }</span>
<a href="#l87.19"></a><span id="l87.19">         if (!isImport || !jsonData.creator) {</span>
<a href="#l87.20"></a><span id="l87.20">             jsonData.creator = this.creator;</span>
<a href="#l87.21"></a><span id="l87.21">         }</span>
<a href="#l87.22"></a><span id="l87.22">         if (!isImport || !jsonData.organizer) {</span>
<a href="#l87.23"></a><span id="l87.23">             jsonData.organizer = this.creator;</span>
<a href="#l87.24"></a><span id="l87.24">         }</span>
<a href="#l87.25"></a><span id="l87.25">         this.nextEtag = null;</span>
<a href="#l87.26"></a><span id="l87.26">         return jsonData;</span>
<a href="#l87.27"></a><span id="l87.27">     },</span>
<a href="#l87.28"></a><span id="l87.28"> </span>
<a href="#l87.29"></a><span id="l87.29">     processModifyEvent: function(jsonData, id) {</span>
<a href="#l87.30"></a><span id="l87.30">         jsonData.kind = &quot;calendar#event&quot;;</span>
<a href="#l87.31"></a><span id="l87.31">         jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l87.32"></a><span id="l87.32" class="difflineminus">-        jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l87.33"></a><span id="l87.33" class="difflineplus">+        jsonData.updated = cal.toRFC3339(cal.dtz.now());</span>
<a href="#l87.34"></a><span id="l87.34">         jsonData.id = id;</span>
<a href="#l87.35"></a><span id="l87.35">         jsonData.iCalUID = (jsonData.recurringEventId || jsonData.id) + &quot;@google.com&quot;;</span>
<a href="#l87.36"></a><span id="l87.36">         if (!jsonData.creator) {</span>
<a href="#l87.37"></a><span id="l87.37">             jsonData.creator = this.creator;</span>
<a href="#l87.38"></a><span id="l87.38">         }</span>
<a href="#l87.39"></a><span id="l87.39">         if (!jsonData.organizer) {</span>
<a href="#l87.40"></a><span id="l87.40">             jsonData.organizer = this.creator;</span>
<a href="#l87.41"></a><span id="l87.41">         }</span>
<a href="#l87.42"></a><span id="l87.42" class="difflineat">@@ -434,32 +434,32 @@ GDataServer.prototype = {</span>
<a href="#l87.43"></a><span id="l87.43">         jsonData.kind = &quot;tasks#task&quot;;</span>
<a href="#l87.44"></a><span id="l87.44">         jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l87.45"></a><span id="l87.45">         jsonData.id = generateID();</span>
<a href="#l87.46"></a><span id="l87.46">         jsonData.position = generateID(); // Not a real position, but we don't really use this at the moment</span>
<a href="#l87.47"></a><span id="l87.47">         if (!jsonData.status) {</span>
<a href="#l87.48"></a><span id="l87.48">             jsonData.status = &quot;needsAction&quot;;</span>
<a href="#l87.49"></a><span id="l87.49">         }</span>
<a href="#l87.50"></a><span id="l87.50">         if (!jsonData.updated) {</span>
<a href="#l87.51"></a><span id="l87.51" class="difflineminus">-            jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l87.52"></a><span id="l87.52" class="difflineplus">+            jsonData.updated = cal.toRFC3339(cal.dtz.now());</span>
<a href="#l87.53"></a><span id="l87.53">         }</span>
<a href="#l87.54"></a><span id="l87.54"> </span>
<a href="#l87.55"></a><span id="l87.55">         this.nextEtag = null;</span>
<a href="#l87.56"></a><span id="l87.56">         return jsonData;</span>
<a href="#l87.57"></a><span id="l87.57">     },</span>
<a href="#l87.58"></a><span id="l87.58"> </span>
<a href="#l87.59"></a><span id="l87.59">     processModifyTask: function(jsonData) {</span>
<a href="#l87.60"></a><span id="l87.60">         jsonData.kind = &quot;tasks#task&quot;;</span>
<a href="#l87.61"></a><span id="l87.61">         jsonData.etag = this.nextEtag || '&quot;' + (new Date()).getTime() + '&quot;';</span>
<a href="#l87.62"></a><span id="l87.62" class="difflineminus">-        jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l87.63"></a><span id="l87.63" class="difflineplus">+        jsonData.updated = cal.toRFC3339(cal.dtz.now());</span>
<a href="#l87.64"></a><span id="l87.64">         if (!jsonData.status) {</span>
<a href="#l87.65"></a><span id="l87.65">             jsonData.status = &quot;needsAction&quot;;</span>
<a href="#l87.66"></a><span id="l87.66">         }</span>
<a href="#l87.67"></a><span id="l87.67">         if (!jsonData.updated) {</span>
<a href="#l87.68"></a><span id="l87.68" class="difflineminus">-            jsonData.updated = cal.toRFC3339(cal.now());</span>
<a href="#l87.69"></a><span id="l87.69" class="difflineplus">+            jsonData.updated = cal.toRFC3339(cal.dtz.now());</span>
<a href="#l87.70"></a><span id="l87.70">         }</span>
<a href="#l87.71"></a><span id="l87.71"> </span>
<a href="#l87.72"></a><span id="l87.72">         this.nextEtag = null;</span>
<a href="#l87.73"></a><span id="l87.73">         return jsonData;</span>
<a href="#l87.74"></a><span id="l87.74">     },</span>
<a href="#l87.75"></a><span id="l87.75"> };</span>
<a href="#l87.76"></a><span id="l87.76"> </span>
<a href="#l87.77"></a><span id="l87.77"> function findKey(container, key, searchKey) {</span>
<a href="#l87.78"></a><span id="l87.78" class="difflineat">@@ -608,17 +608,17 @@ add_task(function* test_dateToJSON() {</span>
<a href="#l87.79"></a><span id="l87.79">         parser.parseString(ics);</span>
<a href="#l87.80"></a><span id="l87.80">         let items = parser.getItems({});</span>
<a href="#l87.81"></a><span id="l87.81">         return items[0].startDate;</span>
<a href="#l87.82"></a><span id="l87.82">     }</span>
<a href="#l87.83"></a><span id="l87.83"> </span>
<a href="#l87.84"></a><span id="l87.84">     let date;</span>
<a href="#l87.85"></a><span id="l87.85"> </span>
<a href="#l87.86"></a><span id="l87.86">     // no timezone</span>
<a href="#l87.87"></a><span id="l87.87" class="difflineminus">-    date = _createDateTime(cal.floating());</span>
<a href="#l87.88"></a><span id="l87.88" class="difflineplus">+    date = _createDateTime(cal.dtz.floating);</span>
<a href="#l87.89"></a><span id="l87.89">     deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00-00:00&quot; });</span>
<a href="#l87.90"></a><span id="l87.90"> </span>
<a href="#l87.91"></a><span id="l87.91">     // valid non-Olson tz name</span>
<a href="#l87.92"></a><span id="l87.92">     date = _createDateTime(&quot;Eastern Standard Time&quot;);</span>
<a href="#l87.93"></a><span id="l87.93">     deepEqual(dateToJSON(date), { dateTime: &quot;2015-01-30T12:00:00&quot;, timeZone: &quot;America/New_York&quot; });</span>
<a href="#l87.94"></a><span id="l87.94"> </span>
<a href="#l87.95"></a><span id="l87.95">     // valid continent/city Olson tz</span>
<a href="#l87.96"></a><span id="l87.96">     date = _createDateTime(&quot;America/New_York&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/test/unit/test_items.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/test/unit/test_items.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -203,17 +203,17 @@ function test_immutable() {</span>
<a href="#l88.4"></a><span id="l88.4">     alarm.offset = cal.createDuration(&quot;PT1S&quot;);</span>
<a href="#l88.5"></a><span id="l88.5">     event.addAlarm(alarm);</span>
<a href="#l88.6"></a><span id="l88.6"> </span>
<a href="#l88.7"></a><span id="l88.7">     event.setProperty(&quot;X-NAME&quot;, &quot;X-VALUE&quot;);</span>
<a href="#l88.8"></a><span id="l88.8">     event.setPropertyParameter(&quot;X-NAME&quot;, &quot;X-PARAM&quot;, &quot;X-PARAMVAL&quot;);</span>
<a href="#l88.9"></a><span id="l88.9"> </span>
<a href="#l88.10"></a><span id="l88.10">     event.setCategories(3, [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]);</span>
<a href="#l88.11"></a><span id="l88.11"> </span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-    equal(event.alarmLastAck.timezone.tzid, cal.UTC().tzid);</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+    equal(event.alarmLastAck.timezone.tzid, cal.dtz.UTC.tzid);</span>
<a href="#l88.14"></a><span id="l88.14"> </span>
<a href="#l88.15"></a><span id="l88.15">     event.makeImmutable();</span>
<a href="#l88.16"></a><span id="l88.16"> </span>
<a href="#l88.17"></a><span id="l88.17">     // call again, should not throw</span>
<a href="#l88.18"></a><span id="l88.18">     event.makeImmutable();</span>
<a href="#l88.19"></a><span id="l88.19"> </span>
<a href="#l88.20"></a><span id="l88.20">     ok(!event.alarmLastAck.isMutable);</span>
<a href="#l88.21"></a><span id="l88.21">     ok(!org.isMutable);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -705,22 +705,22 @@ function test_rrule_interface() {</span>
<a href="#l89.4"></a><span id="l89.4"> </span>
<a href="#l89.5"></a><span id="l89.5">     // untilDate (without UTC)</span>
<a href="#l89.6"></a><span id="l89.6">     rrule.count = 3;</span>
<a href="#l89.7"></a><span id="l89.7">     let untilDate = cal.createDateTime();</span>
<a href="#l89.8"></a><span id="l89.8">     untilDate.timezone = cal.getTimezoneService().getTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l89.9"></a><span id="l89.9">     rrule.untilDate = untilDate;</span>
<a href="#l89.10"></a><span id="l89.10">     ok(!rrule.isByCount);</span>
<a href="#l89.11"></a><span id="l89.11">     throws(() =&gt; rrule.count, /0x80004005/);</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-    equal(rrule.untilDate.icalString, untilDate.getInTimezone(cal.UTC()).icalString);</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+    equal(rrule.untilDate.icalString, untilDate.getInTimezone(cal.dtz.UTC).icalString);</span>
<a href="#l89.14"></a><span id="l89.14"> </span>
<a href="#l89.15"></a><span id="l89.15">     // untilDate (with UTC)</span>
<a href="#l89.16"></a><span id="l89.16">     rrule.count = 3;</span>
<a href="#l89.17"></a><span id="l89.17">     untilDate = cal.createDateTime();</span>
<a href="#l89.18"></a><span id="l89.18" class="difflineminus">-    untilDate.timezone = cal.UTC();</span>
<a href="#l89.19"></a><span id="l89.19" class="difflineplus">+    untilDate.timezone = cal.dtz.UTC;</span>
<a href="#l89.20"></a><span id="l89.20">     rrule.untilDate = untilDate;</span>
<a href="#l89.21"></a><span id="l89.21">     ok(!rrule.isByCount);</span>
<a href="#l89.22"></a><span id="l89.22">     throws(() =&gt; rrule.count, /0x80004005/);</span>
<a href="#l89.23"></a><span id="l89.23">     equal(rrule.untilDate.icalString, untilDate.icalString);</span>
<a href="#l89.24"></a><span id="l89.24"> }</span>
<a href="#l89.25"></a><span id="l89.25"> </span>
<a href="#l89.26"></a><span id="l89.26"> function test_startdate_change() {</span>
<a href="#l89.27"></a><span id="l89.27">     // Setting a start date if its missing shouldn't throw</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/test/unit/test_rfc3339_parser.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/test/unit/test_rfc3339_parser.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -62,17 +62,17 @@ function really_run_test() {</span>
<a href="#l90.4"></a><span id="l90.4">      *</span>
<a href="#l90.5"></a><span id="l90.5">      * All tests are done under the default timezone and UTC (although both</span>
<a href="#l90.6"></a><span id="l90.6">      * should give the same time).</span>
<a href="#l90.7"></a><span id="l90.7">      */</span>
<a href="#l90.8"></a><span id="l90.8"> </span>
<a href="#l90.9"></a><span id="l90.9">     // An arbitrary timezone (that has daylight savings time).</span>
<a href="#l90.10"></a><span id="l90.10">     let getTz = (aTz) =&gt; cal.getTimezoneService().getTimezone(aTz);</span>
<a href="#l90.11"></a><span id="l90.11">     let timezone = getTz(&quot;America/New_York&quot;);</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-    let utc = cal.UTC();</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+    let utc = cal.dtz.UTC;</span>
<a href="#l90.14"></a><span id="l90.14">     // Timezones used in tests.</span>
<a href="#l90.15"></a><span id="l90.15">     let belize = getTz(&quot;America/Belize&quot;);</span>
<a href="#l90.16"></a><span id="l90.16">     let dawson = getTz(&quot;America/Dawson&quot;);</span>
<a href="#l90.17"></a><span id="l90.17"> </span>
<a href="#l90.18"></a><span id="l90.18">     /*</span>
<a href="#l90.19"></a><span id="l90.19">      * Basic tests</span>
<a href="#l90.20"></a><span id="l90.20">      */</span>
<a href="#l90.21"></a><span id="l90.21">     // This represents March 14, 2006 in the default timezone.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/test/unit/test_utils.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/test/unit/test_utils.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -16,43 +16,43 @@ function really_run_test() {</span>
<a href="#l91.4"></a><span id="l91.4">     test_sameDay();</span>
<a href="#l91.5"></a><span id="l91.5">     test_binarySearch();</span>
<a href="#l91.6"></a><span id="l91.6"> }</span>
<a href="#l91.7"></a><span id="l91.7"> </span>
<a href="#l91.8"></a><span id="l91.8"> function test_recentzones() {</span>
<a href="#l91.9"></a><span id="l91.9">     let oldDefaultTz = Preferences.get(&quot;calendar.timezone.local&quot;, &quot;&quot;);</span>
<a href="#l91.10"></a><span id="l91.10">     Preferences.set(&quot;calendar.timezone.local&quot;, &quot;floating&quot;);</span>
<a href="#l91.11"></a><span id="l91.11"> </span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-    equal(cal.getRecentTimezones().length, 0);</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineminus">-    equal(cal.getRecentTimezones(true).length, 0);</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineplus">+    equal(cal.dtz.getRecentTimezones().length, 0);</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineplus">+    equal(cal.dtz.getRecentTimezones(true).length, 0);</span>
<a href="#l91.16"></a><span id="l91.16"> </span>
<a href="#l91.17"></a><span id="l91.17" class="difflineminus">-    cal.saveRecentTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l91.18"></a><span id="l91.18" class="difflineplus">+    cal.dtz.saveRecentTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l91.19"></a><span id="l91.19"> </span>
<a href="#l91.20"></a><span id="l91.20" class="difflineminus">-    let zones = cal.getRecentTimezones();</span>
<a href="#l91.21"></a><span id="l91.21" class="difflineplus">+    let zones = cal.dtz.getRecentTimezones();</span>
<a href="#l91.22"></a><span id="l91.22">     equal(zones.length, 1);</span>
<a href="#l91.23"></a><span id="l91.23">     equal(zones[0], &quot;Europe/Berlin&quot;);</span>
<a href="#l91.24"></a><span id="l91.24" class="difflineminus">-    zones = cal.getRecentTimezones(true);</span>
<a href="#l91.25"></a><span id="l91.25" class="difflineplus">+    zones = cal.dtz.getRecentTimezones(true);</span>
<a href="#l91.26"></a><span id="l91.26">     equal(zones.length, 1);</span>
<a href="#l91.27"></a><span id="l91.27">     equal(zones[0].tzid, &quot;Europe/Berlin&quot;);</span>
<a href="#l91.28"></a><span id="l91.28"> </span>
<a href="#l91.29"></a><span id="l91.29" class="difflineminus">-    cal.saveRecentTimezone(cal.calendarDefaultTimezone().tzid);</span>
<a href="#l91.30"></a><span id="l91.30" class="difflineminus">-    equal(cal.getRecentTimezones().length, 1);</span>
<a href="#l91.31"></a><span id="l91.31" class="difflineminus">-    equal(cal.getRecentTimezones(true).length, 1);</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineplus">+    cal.dtz.saveRecentTimezone(cal.dtz.defaultTimezone.tzid);</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineplus">+    equal(cal.dtz.getRecentTimezones().length, 1);</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineplus">+    equal(cal.dtz.getRecentTimezones(true).length, 1);</span>
<a href="#l91.35"></a><span id="l91.35"> </span>
<a href="#l91.36"></a><span id="l91.36" class="difflineminus">-    cal.saveRecentTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineminus">-    equal(cal.getRecentTimezones().length, 1);</span>
<a href="#l91.38"></a><span id="l91.38" class="difflineminus">-    equal(cal.getRecentTimezones(true).length, 1);</span>
<a href="#l91.39"></a><span id="l91.39" class="difflineplus">+    cal.dtz.saveRecentTimezone(&quot;Europe/Berlin&quot;);</span>
<a href="#l91.40"></a><span id="l91.40" class="difflineplus">+    equal(cal.dtz.getRecentTimezones().length, 1);</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineplus">+    equal(cal.dtz.getRecentTimezones(true).length, 1);</span>
<a href="#l91.42"></a><span id="l91.42"> </span>
<a href="#l91.43"></a><span id="l91.43" class="difflineminus">-    cal.saveRecentTimezone(&quot;America/New_York&quot;);</span>
<a href="#l91.44"></a><span id="l91.44" class="difflineminus">-    equal(cal.getRecentTimezones().length, 2);</span>
<a href="#l91.45"></a><span id="l91.45" class="difflineminus">-    equal(cal.getRecentTimezones(true).length, 2);</span>
<a href="#l91.46"></a><span id="l91.46" class="difflineplus">+    cal.dtz.saveRecentTimezone(&quot;America/New_York&quot;);</span>
<a href="#l91.47"></a><span id="l91.47" class="difflineplus">+    equal(cal.dtz.getRecentTimezones().length, 2);</span>
<a href="#l91.48"></a><span id="l91.48" class="difflineplus">+    equal(cal.dtz.getRecentTimezones(true).length, 2);</span>
<a href="#l91.49"></a><span id="l91.49"> </span>
<a href="#l91.50"></a><span id="l91.50" class="difflineminus">-    cal.saveRecentTimezone(&quot;Unknown&quot;);</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineminus">-    equal(cal.getRecentTimezones().length, 3);</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineminus">-    equal(cal.getRecentTimezones(true).length, 2);</span>
<a href="#l91.53"></a><span id="l91.53" class="difflineplus">+    cal.dtz.saveRecentTimezone(&quot;Unknown&quot;);</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineplus">+    equal(cal.dtz.getRecentTimezones().length, 3);</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineplus">+    equal(cal.dtz.getRecentTimezones(true).length, 2);</span>
<a href="#l91.56"></a><span id="l91.56"> </span>
<a href="#l91.57"></a><span id="l91.57">     Preferences.set(&quot;calendar.timezone.local&quot;, oldDefaultTz);</span>
<a href="#l91.58"></a><span id="l91.58"> }</span>
<a href="#l91.59"></a><span id="l91.59"> </span>
<a href="#l91.60"></a><span id="l91.60"> function test_formatcss() {</span>
<a href="#l91.61"></a><span id="l91.61">     equal(cal.formatStringForCSSRule(&quot; &quot;), &quot;_&quot;);</span>
<a href="#l91.62"></a><span id="l91.62">     equal(cal.formatStringForCSSRule(&quot;&quot;), &quot;-uxfc-&quot;);</span>
<a href="#l91.63"></a><span id="l91.63">     equal(cal.formatStringForCSSRule(&quot;a&quot;), &quot;a&quot;);</span>
<a href="#l91.64"></a><span id="l91.64" class="difflineat">@@ -69,61 +69,61 @@ function test_attendeeMatchesAddresses()</span>
<a href="#l91.65"></a><span id="l91.65">     ok(!cal.attendeeMatchesAddresses(a, [&quot;HORSTpeter&quot;, &quot;peter&quot;]));</span>
<a href="#l91.66"></a><span id="l91.66">     ok(!cal.attendeeMatchesAddresses(a, [&quot;peter&quot;]));</span>
<a href="#l91.67"></a><span id="l91.67"> }</span>
<a href="#l91.68"></a><span id="l91.68"> </span>
<a href="#l91.69"></a><span id="l91.69"> function test_getDefaultStartDate() {</span>
<a href="#l91.70"></a><span id="l91.70">     function transform(nowString, refDateString) {</span>
<a href="#l91.71"></a><span id="l91.71">         now = cal.createDateTime(nowString);</span>
<a href="#l91.72"></a><span id="l91.72">         let refDate = refDateString ? cal.createDateTime(refDateString) : null;</span>
<a href="#l91.73"></a><span id="l91.73" class="difflineminus">-        return cal.getDefaultStartDate(refDate);</span>
<a href="#l91.74"></a><span id="l91.74" class="difflineplus">+        return cal.dtz.getDefaultStartDate(refDate);</span>
<a href="#l91.75"></a><span id="l91.75">     }</span>
<a href="#l91.76"></a><span id="l91.76"> </span>
<a href="#l91.77"></a><span id="l91.77" class="difflineminus">-    let oldNow = cal.now;</span>
<a href="#l91.78"></a><span id="l91.78" class="difflineplus">+    let oldNow = cal.dtz.now;</span>
<a href="#l91.79"></a><span id="l91.79">     let now = cal.createDateTime(&quot;20120101T000000&quot;);</span>
<a href="#l91.80"></a><span id="l91.80" class="difflineminus">-    cal.now = function() {</span>
<a href="#l91.81"></a><span id="l91.81" class="difflineplus">+    cal.dtz.now = function() {</span>
<a href="#l91.82"></a><span id="l91.82">         return now;</span>
<a href="#l91.83"></a><span id="l91.83">     };</span>
<a href="#l91.84"></a><span id="l91.84"> </span>
<a href="#l91.85"></a><span id="l91.85">     dump(&quot;TT: &quot; + cal.createDateTime(&quot;20120101T000000&quot;) + &quot;\n&quot;);</span>
<a href="#l91.86"></a><span id="l91.86" class="difflineminus">-    dump(&quot;TT: &quot; + cal.getDefaultStartDate(cal.createDateTime(&quot;20120101T000000&quot;)) + &quot;\n&quot;);</span>
<a href="#l91.87"></a><span id="l91.87" class="difflineplus">+    dump(&quot;TT: &quot; + cal.dtz.getDefaultStartDate(cal.createDateTime(&quot;20120101T000000&quot;)) + &quot;\n&quot;);</span>
<a href="#l91.88"></a><span id="l91.88"> </span>
<a href="#l91.89"></a><span id="l91.89">     equal(transform(&quot;20120101T000000&quot;).icalString, &quot;20120101T010000&quot;);</span>
<a href="#l91.90"></a><span id="l91.90">     equal(transform(&quot;20120101T015959&quot;).icalString, &quot;20120101T020000&quot;);</span>
<a href="#l91.91"></a><span id="l91.91">     equal(transform(&quot;20120101T230000&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l91.92"></a><span id="l91.92">     equal(transform(&quot;20120101T235959&quot;).icalString, &quot;20120101T230000&quot;);</span>
<a href="#l91.93"></a><span id="l91.93"> </span>
<a href="#l91.94"></a><span id="l91.94">     equal(transform(&quot;20120101T000000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T010000&quot;);</span>
<a href="#l91.95"></a><span id="l91.95">     equal(transform(&quot;20120101T015959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T020000&quot;);</span>
<a href="#l91.96"></a><span id="l91.96">     equal(transform(&quot;20120101T230000&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l91.97"></a><span id="l91.97">     equal(transform(&quot;20120101T235959&quot;, &quot;20120202&quot;).icalString, &quot;20120202T230000&quot;);</span>
<a href="#l91.98"></a><span id="l91.98"> </span>
<a href="#l91.99"></a><span id="l91.99">     let event = cal.createEvent();</span>
<a href="#l91.100"></a><span id="l91.100">     now = cal.createDateTime(&quot;20120101T015959&quot;);</span>
<a href="#l91.101"></a><span id="l91.101" class="difflineminus">-    cal.setDefaultStartEndHour(event, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l91.102"></a><span id="l91.102" class="difflineplus">+    cal.dtz.setDefaultStartEndHour(event, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l91.103"></a><span id="l91.103">     equal(event.startDate.icalString, &quot;20120202T020000&quot;);</span>
<a href="#l91.104"></a><span id="l91.104">     equal(event.endDate.icalString, &quot;20120202T030000&quot;);</span>
<a href="#l91.105"></a><span id="l91.105"> </span>
<a href="#l91.106"></a><span id="l91.106">     let todo = cal.createTodo();</span>
<a href="#l91.107"></a><span id="l91.107">     now = cal.createDateTime(&quot;20120101T000000&quot;);</span>
<a href="#l91.108"></a><span id="l91.108" class="difflineminus">-    cal.setDefaultStartEndHour(todo, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l91.109"></a><span id="l91.109" class="difflineplus">+    cal.dtz.setDefaultStartEndHour(todo, cal.createDateTime(&quot;20120202&quot;));</span>
<a href="#l91.110"></a><span id="l91.110">     equal(todo.entryDate.icalString, &quot;20120202T010000&quot;);</span>
<a href="#l91.111"></a><span id="l91.111"> </span>
<a href="#l91.112"></a><span id="l91.112" class="difflineminus">-    cal.now = oldNow;</span>
<a href="#l91.113"></a><span id="l91.113" class="difflineplus">+    cal.dtz.now = oldNow;</span>
<a href="#l91.114"></a><span id="l91.114"> }</span>
<a href="#l91.115"></a><span id="l91.115"> </span>
<a href="#l91.116"></a><span id="l91.116"> function test_getStartEndProps() {</span>
<a href="#l91.117"></a><span id="l91.117" class="difflineminus">-    equal(cal.calGetStartDateProp(cal.createEvent()), &quot;startDate&quot;);</span>
<a href="#l91.118"></a><span id="l91.118" class="difflineminus">-    equal(cal.calGetEndDateProp(cal.createEvent()), &quot;endDate&quot;);</span>
<a href="#l91.119"></a><span id="l91.119" class="difflineminus">-    equal(cal.calGetStartDateProp(cal.createTodo()), &quot;entryDate&quot;);</span>
<a href="#l91.120"></a><span id="l91.120" class="difflineminus">-    equal(cal.calGetEndDateProp(cal.createTodo()), &quot;dueDate&quot;);</span>
<a href="#l91.121"></a><span id="l91.121" class="difflineplus">+    equal(cal.dtz.startDateProp(cal.createEvent()), &quot;startDate&quot;);</span>
<a href="#l91.122"></a><span id="l91.122" class="difflineplus">+    equal(cal.dtz.endDateProp(cal.createEvent()), &quot;endDate&quot;);</span>
<a href="#l91.123"></a><span id="l91.123" class="difflineplus">+    equal(cal.dtz.startDateProp(cal.createTodo()), &quot;entryDate&quot;);</span>
<a href="#l91.124"></a><span id="l91.124" class="difflineplus">+    equal(cal.dtz.endDateProp(cal.createTodo()), &quot;dueDate&quot;);</span>
<a href="#l91.125"></a><span id="l91.125"> </span>
<a href="#l91.126"></a><span id="l91.126" class="difflineminus">-    throws(() =&gt; cal.calGetStartDateProp(null),</span>
<a href="#l91.127"></a><span id="l91.127" class="difflineplus">+    throws(() =&gt; cal.dtz.startDateProp(null),</span>
<a href="#l91.128"></a><span id="l91.128">            /2147500033/);</span>
<a href="#l91.129"></a><span id="l91.129" class="difflineminus">-    throws(() =&gt; cal.calGetEndDateProp(null),</span>
<a href="#l91.130"></a><span id="l91.130" class="difflineplus">+    throws(() =&gt; cal.dtz.endDateProp(null),</span>
<a href="#l91.131"></a><span id="l91.131">            /2147500033/);</span>
<a href="#l91.132"></a><span id="l91.132"> }</span>
<a href="#l91.133"></a><span id="l91.133"> </span>
<a href="#l91.134"></a><span id="l91.134"> function test_calOperationGroup() {</span>
<a href="#l91.135"></a><span id="l91.135">     let cancelCalled = false;</span>
<a href="#l91.136"></a><span id="l91.136">     function cancelFunc() {</span>
<a href="#l91.137"></a><span id="l91.137">         cancelCalled = true;</span>
<a href="#l91.138"></a><span id="l91.138">         return true;</span>
<a href="#l91.139"></a><span id="l91.139" class="difflineat">@@ -169,20 +169,20 @@ function test_calOperationGroup() {</span>
<a href="#l91.140"></a><span id="l91.140">     ok(!group.isPending);</span>
<a href="#l91.141"></a><span id="l91.141">     ok(cancelCalled);</span>
<a href="#l91.142"></a><span id="l91.142">     ok(pendingOp2.cancelCalled);</span>
<a href="#l91.143"></a><span id="l91.143"> }</span>
<a href="#l91.144"></a><span id="l91.144"> </span>
<a href="#l91.145"></a><span id="l91.145"> function test_sameDay() {</span>
<a href="#l91.146"></a><span id="l91.146">     let createDate = cal.createDateTime.bind(cal);</span>
<a href="#l91.147"></a><span id="l91.147"> </span>
<a href="#l91.148"></a><span id="l91.148" class="difflineminus">-    ok(cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101T120000&quot;)));</span>
<a href="#l91.149"></a><span id="l91.149" class="difflineminus">-    ok(cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101&quot;)));</span>
<a href="#l91.150"></a><span id="l91.150" class="difflineminus">-    ok(!cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120102&quot;)));</span>
<a href="#l91.151"></a><span id="l91.151" class="difflineminus">-    ok(!cal.sameDay(createDate(&quot;20120101T120000&quot;), createDate(&quot;20120102T120000&quot;)));</span>
<a href="#l91.152"></a><span id="l91.152" class="difflineplus">+    ok(cal.dtz.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101T120000&quot;)));</span>
<a href="#l91.153"></a><span id="l91.153" class="difflineplus">+    ok(cal.dtz.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101&quot;)));</span>
<a href="#l91.154"></a><span id="l91.154" class="difflineplus">+    ok(!cal.dtz.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120102&quot;)));</span>
<a href="#l91.155"></a><span id="l91.155" class="difflineplus">+    ok(!cal.dtz.sameDay(createDate(&quot;20120101T120000&quot;), createDate(&quot;20120102T120000&quot;)));</span>
<a href="#l91.156"></a><span id="l91.156"> }</span>
<a href="#l91.157"></a><span id="l91.157"> </span>
<a href="#l91.158"></a><span id="l91.158"> function test_binarySearch() {</span>
<a href="#l91.159"></a><span id="l91.159">     let arr = [2, 5, 7, 9, 20, 27, 34, 39, 41, 53, 62];</span>
<a href="#l91.160"></a><span id="l91.160">     equal(cal.binarySearch(arr, 27), 5); // Center</span>
<a href="#l91.161"></a><span id="l91.161">     equal(cal.binarySearch(arr, 2), 0); // Left most</span>
<a href="#l91.162"></a><span id="l91.162">     equal(cal.binarySearch(arr, 62), 11); // Right most</span>
<a href="#l91.163"></a><span id="l91.163"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

