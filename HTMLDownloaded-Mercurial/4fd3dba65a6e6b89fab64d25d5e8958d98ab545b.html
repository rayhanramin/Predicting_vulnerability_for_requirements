<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 772:4fd3dba65a6e6b89fab64d25d5e8958d98ab545b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4fd3dba65a6e6b89fab64d25d5e8958d98ab545b" />
<meta property="og:url" content="/comm-central/rev/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b" />
<meta property="og:description" content="Bug 449768 - &quot;Reindexing should save message metadata (junk-related, tags, etc.)&quot; [r+sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4fd3dba65a6e6b89fab64d25d5e8958d98ab545b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">shortlog</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">files</a> |
changeset |
<a href="/comm-central/raw-rev/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">raw</a>  | <a href="/comm-central/archive/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449768">Bug 449768</a> - &quot;Reindexing should save message metadata (junk-related, tags, etc.)&quot; [r+sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 30 Oct 2008 15:38:30 +0000</td></tr>

<tr>
 <td>changeset 772</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">4fd3dba65a6e6b89fab64d25d5e8958d98ab545b</a></td>
</tr>



<tr>
<td>parent 771</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/dc4edb5fe229fe1c743e4f421b2e55d2e526e068">dc4edb5fe229fe1c743e4f421b2e55d2e526e068</a>
</td>
</tr>

<tr>
<td>child 773</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0a9821e4db57bda91775e57961614f857c545e37">0a9821e4db57bda91775e57961614f857c545e37</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">697</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 30 Oct 2008 15:39:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4fd3dba65a6e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&newProject=comm-central&newRevision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&newProject=comm-central&newRevision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&newProject=comm-central&newRevision=4fd3dba65a6e6b89fab64d25d5e8958d98ab545b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449768">449768</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=449768">Bug 449768</a> - &quot;Reindexing should save message metadata (junk-related, tags, etc.)&quot; [r+sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mail/base/content/widgetglue.js">mail/base/content/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mail/base/content/widgetglue.js">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mail/base/content/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mail/base/content/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mail/base/content/widgetglue.js">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mail/base/content/widgetglue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/resources/content/widgetglue.js">mailnews/base/resources/content/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/resources/content/widgetglue.js">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/resources/content/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/resources/content/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/resources/content/widgetglue.js">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/resources/content/widgetglue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/public/nsIMsgParseMailMsgState.idl">mailnews/local/public/nsIMsgParseMailMsgState.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/public/nsIMsgParseMailMsgState.idl">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/public/nsIMsgParseMailMsgState.idl">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/public/nsIMsgParseMailMsgState.idl">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/public/nsIMsgParseMailMsgState.idl">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/public/nsIMsgParseMailMsgState.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.h">mailnews/local/src/nsParseMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.h">file</a> |
<a href="/comm-central/annotate/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.h">annotate</a> |
<a href="/comm-central/diff/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.h">diff</a> |
<a href="/comm-central/comparison/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.h">comparison</a> |
<a href="/comm-central/log/4fd3dba65a6e6b89fab64d25d5e8958d98ab545b/mailnews/local/src/nsParseMailbox.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/widgetglue.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/widgetglue.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -232,17 +232,23 @@ function RebuildSummaryFile(msgFolder)</span>
<a href="#l1.4"></a><span id="l1.4"> {</span>
<a href="#l1.5"></a><span id="l1.5">   if (msgFolder.locked)</span>
<a href="#l1.6"></a><span id="l1.6">   {</span>
<a href="#l1.7"></a><span id="l1.7">     msgFolder.throwAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l1.8"></a><span id="l1.8">     return;</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10">   var msgDB = msgFolder.getMsgDatabase(msgWindow);</span>
<a href="#l1.11"></a><span id="l1.11">   msgDB.summaryValid = false;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  msgFolder.ForceDBClosed();</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  try {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    msgFolder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  }</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  catch(e) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    msgFolder.ForceDBClosed();</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  }</span>
<a href="#l1.20"></a><span id="l1.20">   // these two lines will cause the thread pane to get reloaded</span>
<a href="#l1.21"></a><span id="l1.21">   // when the download/reparse is finished. Only do this</span>
<a href="#l1.22"></a><span id="l1.22">   // if the selected folder is loaded (i.e., not thru the</span>
<a href="#l1.23"></a><span id="l1.23">   // context menu on a non-loaded folder).</span>
<a href="#l1.24"></a><span id="l1.24">   if (msgFolder == GetLoadedMsgFolder())</span>
<a href="#l1.25"></a><span id="l1.25">   {</span>
<a href="#l1.26"></a><span id="l1.26">     gRerootOnFolderLoad = true;</span>
<a href="#l1.27"></a><span id="l1.27">     gCurrentFolderToReroot = msgFolder.URI;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -62,18 +62,17 @@ interface nsILocalFile;</span>
<a href="#l2.4"></a><span id="l2.4"> interface nsIMsgIdentity;</span>
<a href="#l2.5"></a><span id="l2.5"> interface nsIArray;</span>
<a href="#l2.6"></a><span id="l2.6"> interface nsIMutableArray;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> typedef long nsMsgBiffState;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l2.11"></a><span id="l2.11"> typedef long nsMsgDispositionState;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-[scriptable, uuid(294b98e9-dbdd-4f7f-9d81-5c17073a32c3)]</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+[scriptable, uuid(EAE4729C-4CC1-4167-8E00-0C159DA05FD2)]</span>
<a href="#l2.15"></a><span id="l2.15"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l2.18"></a><span id="l2.18">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l2.19"></a><span id="l2.19">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21">   nsISimpleEnumerator getMessages(in nsIMsgWindow aMsgWindow);</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineat">@@ -134,16 +133,25 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.24"></a><span id="l2.24">   /**</span>
<a href="#l2.25"></a><span id="l2.25">    * function to get the filter list on folder's server</span>
<a href="#l2.26"></a><span id="l2.26">    * (or in the case of news, the filter list for this newsgroup)'</span>
<a href="#l2.27"></a><span id="l2.27">    */</span>
<a href="#l2.28"></a><span id="l2.28">   nsIMsgFilterList getFilterList(in nsIMsgWindow msgWindow);</span>
<a href="#l2.29"></a><span id="l2.29">   void setFilterList(in nsIMsgFilterList filterList);</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31">   void ForceDBClosed ();</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  /**</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+   * Close and backup a folder database prior to reparsing</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   *</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   * @param  newName  New name of the corresponding message folder.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   *                  Used in rename to set the file name to match the renamed</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   *                  folder. Set to empty to use the existing folder name.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+   */</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  void closeAndBackupFolderDB(in ACString newName);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span>
<a href="#l2.41"></a><span id="l2.41">   void Delete ();</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   void deleteSubFolders(in nsIArray folders, in nsIMsgWindow msgWindow);</span>
<a href="#l2.44"></a><span id="l2.44">   void propagateDelete(in nsIMsgFolder folder, in boolean deleteStorage,</span>
<a href="#l2.45"></a><span id="l2.45">                        in nsIMsgWindow msgWindow);</span>
<a href="#l2.46"></a><span id="l2.46">   void recursiveDelete(in boolean deleteStorage, in nsIMsgWindow msgWindow);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">   void createSubfolder(in AString folderName, in nsIMsgWindow msgWindow);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineat">@@ -407,16 +415,31 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">   void markMessagesRead(in nsIArray messages, in boolean markRead);</span>
<a href="#l2.52"></a><span id="l2.52">   void markAllMessagesRead();</span>
<a href="#l2.53"></a><span id="l2.53">   void markMessagesFlagged(in nsIArray messages, in boolean markFlagged);</span>
<a href="#l2.54"></a><span id="l2.54">   void markThreadRead(in nsIMsgThread thread);</span>
<a href="#l2.55"></a><span id="l2.55">   void setLabelForMessages(in nsIArray messages, in nsMsgLabelValue label);</span>
<a href="#l2.56"></a><span id="l2.56">   nsIMsgDatabase getMsgDatabase(in nsIMsgWindow msgWindow);</span>
<a href="#l2.57"></a><span id="l2.57">   void setMsgDatabase (in nsIMsgDatabase msgDatabase);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  /**</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+   * Get the backup message database, used in reparsing. This database must</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+   * be created first using closeAndBackupFolderDB()</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+   *</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+   * @return   backup message database</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+   */</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  nsIMsgDatabase getBackupMsgDatabase();</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  /**</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+   * Remove the backup message database file</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+   */</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  void removeBackupMsgDatabase();</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  /**</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+   * Open the backup message database file</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+   */</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  void openBackupMsgDatabase();</span>
<a href="#l2.73"></a><span id="l2.73">   nsIMsgDatabase getDBFolderInfoAndDB(out nsIDBFolderInfo folderInfo);</span>
<a href="#l2.74"></a><span id="l2.74">   nsIMsgDBHdr GetMessageHeader(in nsMsgKey msgKey);</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76">   readonly attribute boolean supportsOffline;</span>
<a href="#l2.77"></a><span id="l2.77">   boolean shouldStoreMsgOffline(in nsMsgKey msgKey);</span>
<a href="#l2.78"></a><span id="l2.78">   boolean hasMsgOffline(in nsMsgKey msgKey);</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">   nsIInputStream getOfflineFileStream(in nsMsgKey msgKey, out PRUint32 offset,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/resources/content/widgetglue.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/resources/content/widgetglue.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -263,17 +263,24 @@ function RebuildSummaryFile(msgFolder)</span>
<a href="#l3.4"></a><span id="l3.4"> {</span>
<a href="#l3.5"></a><span id="l3.5">   if (msgFolder.locked)</span>
<a href="#l3.6"></a><span id="l3.6">   {</span>
<a href="#l3.7"></a><span id="l3.7">     msgFolder.throwAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l3.8"></a><span id="l3.8">     return;</span>
<a href="#l3.9"></a><span id="l3.9">   }</span>
<a href="#l3.10"></a><span id="l3.10">   var msgDB = msgFolder.getMsgDatabase(msgWindow);</span>
<a href="#l3.11"></a><span id="l3.11">   msgDB.summaryValid = false;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  msgFolder.ForceDBClosed();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  try {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    msgFolder.closeAndBackupFolderDB(&quot;&quot;);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  }</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  catch(e) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    // In a failure, proceed anyway since we're dealing with problems</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    msgFolder.ForceDBClosed();</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  }</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21">   // these two lines will cause the thread pane to get reloaded</span>
<a href="#l3.22"></a><span id="l3.22">   // when the download/reparse are finised.</span>
<a href="#l3.23"></a><span id="l3.23">   gRerootOnFolderLoad = true;</span>
<a href="#l3.24"></a><span id="l3.24">   gCurrentFolderToReroot = msgFolder.URI;</span>
<a href="#l3.25"></a><span id="l3.25">   msgFolder.updateFolder(msgWindow);</span>
<a href="#l3.26"></a><span id="l3.26"> }</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28"> function FolderProperties(name, oldName, uri)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -86,16 +86,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIMIMEHeaderParam.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;plbase64.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &lt;time.h&gt;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> #define oneHour 3600000000U</span>
<a href="#l4.15"></a><span id="l4.15"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> static PRTime gtimeOfLastPurgeCheck;    //variable to know when to check for purge_threshhold</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> #define PREF_MAIL_PROMPT_PURGE_THRESHOLD &quot;mail.prompt_purge_threshhold&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> #define PREF_MAIL_PURGE_THRESHOLD &quot;mail.purge_threshhold&quot;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -218,17 +219,21 @@ nsMsgDBFolder::~nsMsgDBFolder(void)</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> NS_IMETHODIMP nsMsgDBFolder::Shutdown(PRBool shutdownChildren)</span>
<a href="#l4.24"></a><span id="l4.24"> {</span>
<a href="#l4.25"></a><span id="l4.25">   if(mDatabase)</span>
<a href="#l4.26"></a><span id="l4.26">   {</span>
<a href="#l4.27"></a><span id="l4.27">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l4.28"></a><span id="l4.28">     mDatabase-&gt;Close(PR_TRUE);</span>
<a href="#l4.29"></a><span id="l4.29">     mDatabase = nsnull;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    if (mBackupDatabase)</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+    {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+      mBackupDatabase-&gt;ForceClosed();</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      mBackupDatabase = nsnull;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    }</span>
<a href="#l4.36"></a><span id="l4.36">   }</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">   if(shutdownChildren)</span>
<a href="#l4.39"></a><span id="l4.39">   {</span>
<a href="#l4.40"></a><span id="l4.40">     PRInt32 count = mSubFolders.Count();</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">     for (PRInt32 i = 0; i &lt; count; i++)</span>
<a href="#l4.43"></a><span id="l4.43">       mSubFolders[i]-&gt;Shutdown(PR_TRUE);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineat">@@ -259,16 +264,134 @@ NS_IMETHODIMP nsMsgDBFolder::ForceDBClos</span>
<a href="#l4.45"></a><span id="l4.45">   {</span>
<a href="#l4.46"></a><span id="l4.46">     nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory = do_CreateInstance(kCMailDB);</span>
<a href="#l4.47"></a><span id="l4.47">     if (mailDBFactory)</span>
<a href="#l4.48"></a><span id="l4.48">       mailDBFactory-&gt;ForceFolderDBClosed(this);</span>
<a href="#l4.49"></a><span id="l4.49">   }</span>
<a href="#l4.50"></a><span id="l4.50">   return NS_OK;</span>
<a href="#l4.51"></a><span id="l4.51"> }</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::CloseAndBackupFolderDB(const nsACString&amp; newName)</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+{</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  ForceDBClosed();</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+  // We only support backup for mail at the moment</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  if ( !(mFlags &amp; nsMsgFolderFlags::Mail))</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  nsresult rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; dbFile;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+  rv = GetSummaryFileLocation(folderPath, getter_AddRefs(dbFile));</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDir;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  rv = CreateBackupDirectory(getter_AddRefs(backupDir));</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDBFile;</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+  rv = GetBackupSummaryFile(getter_AddRefs(backupDBFile), newName);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  if (mBackupDatabase)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  {</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+    mBackupDatabase-&gt;ForceClosed();</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+    mBackupDatabase = nsnull;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  backupDBFile-&gt;Remove(PR_FALSE);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  PRBool backupExists;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  backupDBFile-&gt;Exists(&amp;backupExists);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  NS_ASSERTION(!backupExists, &quot;Couldn't delete database backup&quot;);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  if (backupExists)</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  if (!newName.IsEmpty())</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+  {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+    nsCAutoString backupName;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+    rv = backupDBFile-&gt;GetNativeLeafName(backupName);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+    return dbFile-&gt;CopyToNative(backupDir, backupName);</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  }</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  else</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+    return dbFile-&gt;CopyToNative(backupDir, EmptyCString());</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+}</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::OpenBackupMsgDatabase()</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+{</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  if (mBackupDatabase)</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  nsresult rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+  nsAutoString folderName;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+  rv = folderPath-&gt;GetLeafName(folderName);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDir;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  rv = CreateBackupDirectory(getter_AddRefs(backupDir));</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  // We use a dummy message folder file so we can use</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  // GetSummaryFileLocation to get the db file name</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDBDummyFolder;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  rv = CreateBackupDirectory(getter_AddRefs(backupDBDummyFolder));</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  rv = backupDBDummyFolder-&gt;Append(folderName);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  mBackupDatabase = do_CreateInstance(NS_MAILBOXDB_CONTRACTID, &amp;rv);</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+  rv = msgDBService-&gt;OpenMailDBFromFile(</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+      backupDBDummyFolder, PR_FALSE, PR_TRUE, getter_AddRefs(mBackupDatabase));</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+  if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    // this is normal in reparsing</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+    rv = NS_OK;</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+  return rv;</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+}</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::RemoveBackupMsgDatabase()</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+{</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+  nsresult rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+  nsAutoString folderName;</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  rv = folderPath-&gt;GetLeafName(folderName);</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDir;</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+  rv = CreateBackupDirectory(getter_AddRefs(backupDir));</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  // We use a dummy message folder file so we can use</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  // GetSummaryFileLocation to get the db file name</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDBDummyFolder;</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+  rv = CreateBackupDirectory(getter_AddRefs(backupDBDummyFolder));</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+  rv = backupDBDummyFolder-&gt;Append(folderName);</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDBFile;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  rv = GetSummaryFileLocation(backupDBDummyFolder, getter_AddRefs(backupDBFile));</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+  if (mBackupDatabase)</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+  {</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+    mBackupDatabase-&gt;ForceClosed();</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+    mBackupDatabase = nsnull;</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  }</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+  return backupDBFile-&gt;Remove(PR_FALSE);</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+}  </span>
<a href="#l4.171"></a><span id="l4.171"> </span>
<a href="#l4.172"></a><span id="l4.172"> NS_IMETHODIMP nsMsgDBFolder::StartFolderLoading(void)</span>
<a href="#l4.173"></a><span id="l4.173"> {</span>
<a href="#l4.174"></a><span id="l4.174">   if(mDatabase)</span>
<a href="#l4.175"></a><span id="l4.175">     mDatabase-&gt;RemoveListener(this);</span>
<a href="#l4.176"></a><span id="l4.176">   mAddListener = PR_FALSE;</span>
<a href="#l4.177"></a><span id="l4.177">   return NS_OK;</span>
<a href="#l4.178"></a><span id="l4.178"> }</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineat">@@ -775,16 +898,29 @@ nsMsgDBFolder::SetMsgDatabase(nsIMsgData</span>
<a href="#l4.180"></a><span id="l4.180">   mDatabase = aMsgDatabase;</span>
<a href="#l4.181"></a><span id="l4.181"> </span>
<a href="#l4.182"></a><span id="l4.182">   if (aMsgDatabase)</span>
<a href="#l4.183"></a><span id="l4.183">     aMsgDatabase-&gt;AddListener(this);</span>
<a href="#l4.184"></a><span id="l4.184">   return NS_OK;</span>
<a href="#l4.185"></a><span id="l4.185"> }</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187"> NS_IMETHODIMP</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+nsMsgDBFolder::GetBackupMsgDatabase(nsIMsgDatabase** aMsgDatabase)</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+{</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgDatabase);</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+  nsresult rv = OpenBackupMsgDatabase();</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+  if (!mBackupDatabase)</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+  NS_ADDREF(*aMsgDatabase = mBackupDatabase);</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+}</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.201"></a><span id="l4.201"> nsMsgDBFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **database)</span>
<a href="#l4.202"></a><span id="l4.202"> {</span>
<a href="#l4.203"></a><span id="l4.203">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l4.204"></a><span id="l4.204"> }</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206"> NS_IMETHODIMP</span>
<a href="#l4.207"></a><span id="l4.207"> nsMsgDBFolder::OnReadChanged(nsIDBChangeListener * aInstigator)</span>
<a href="#l4.208"></a><span id="l4.208"> {</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineat">@@ -3114,16 +3250,86 @@ nsresult nsMsgDBFolder::CreateDirectoryF</span>
<a href="#l4.210"></a><span id="l4.210">       rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY : path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l4.211"></a><span id="l4.211">     }</span>
<a href="#l4.212"></a><span id="l4.212">   }</span>
<a href="#l4.213"></a><span id="l4.213">   if (NS_SUCCEEDED(rv))</span>
<a href="#l4.214"></a><span id="l4.214">     path.swap(*resultFile);</span>
<a href="#l4.215"></a><span id="l4.215">   return rv;</span>
<a href="#l4.216"></a><span id="l4.216"> }</span>
<a href="#l4.217"></a><span id="l4.217"> </span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+/* Finds the backup directory associated with this folder, stored on the temp</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+   drive. If that path doesn't currently exist then it will create it. Path is</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+   strictly an out parameter.</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+  */</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+nsresult nsMsgDBFolder::CreateBackupDirectory(nsILocalFile **resultFile)</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+{</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pathIFile;</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_OS_TEMP_DIR,</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+                                       getter_AddRefs(pathIFile));</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path = do_QueryInterface(pathIFile, &amp;rv);</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+  rv = path-&gt;Append(NS_LITERAL_STRING(&quot;MozillaMailnews&quot;));</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+  PRBool pathIsDirectory;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+  path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+  // If that doesn't exist, then we have to create this directory</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+  if (!pathIsDirectory)</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+  {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+    PRBool pathExists;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+    path-&gt;Exists(&amp;pathExists);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+    // If for some reason there's a file with the directory separator</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    // then we are going to fail.</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY :</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+                      path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+  }</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    path.swap(*resultFile);</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+  return rv;</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+}</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+nsresult nsMsgDBFolder::GetBackupSummaryFile(nsILocalFile **aBackupFile, const nsACString&amp; newName)</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+{</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDir;</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+  nsresult rv = CreateBackupDirectory(getter_AddRefs(backupDir));</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+  // We use a dummy message folder file so we can use</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+  // GetSummaryFileLocation to get the db file name</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDBDummyFolder;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+  rv = CreateBackupDirectory(getter_AddRefs(backupDBDummyFolder));</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  if (!newName.IsEmpty())</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+  {</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    rv = backupDBDummyFolder-&gt;AppendNative(newName);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+  }</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+  else // if newName is null, use the folder name</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+  {</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    rv = GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+    nsCAutoString folderName;</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+    rv = folderPath-&gt;GetNativeLeafName(folderName);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineplus">+    rv = backupDBDummyFolder-&gt;AppendNative(folderName);</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineplus">+  }</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; backupDBFile;</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+  rv = GetSummaryFileLocation(backupDBDummyFolder, getter_AddRefs(backupDBFile));</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+  backupDBFile.swap(*aBackupFile);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+}</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+</span>
<a href="#l4.288"></a><span id="l4.288"> NS_IMETHODIMP nsMsgDBFolder::Rename(const nsAString&amp; aNewName, nsIMsgWindow *msgWindow)</span>
<a href="#l4.289"></a><span id="l4.289"> {</span>
<a href="#l4.290"></a><span id="l4.290">   nsCOMPtr&lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l4.291"></a><span id="l4.291">   nsCOMPtr&lt;nsIAtom&gt; folderRenameAtom;</span>
<a href="#l4.292"></a><span id="l4.292">   nsresult rv = GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l4.293"></a><span id="l4.293">   if (NS_FAILED(rv))</span>
<a href="#l4.294"></a><span id="l4.294">     return rv;</span>
<a href="#l4.295"></a><span id="l4.295">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -97,16 +97,18 @@ public:</span>
<a href="#l5.4"></a><span id="l5.4">   // struct used by the FE</span>
<a href="#l5.5"></a><span id="l5.5">   PRInt32 GetNumPendingUnread();</span>
<a href="#l5.6"></a><span id="l5.6">   PRInt32 GetNumPendingTotalMessages();</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   void ChangeNumPendingUnread(PRInt32 delta);</span>
<a href="#l5.9"></a><span id="l5.9">   void ChangeNumPendingTotalMessages(PRInt32 delta);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   nsresult CreateDirectoryForFolder(nsILocalFile **result);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  nsresult CreateBackupDirectory(nsILocalFile **result);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  nsresult GetBackupSummaryFile(nsILocalFile **result, const nsACString&amp; newName);</span>
<a href="#l5.14"></a><span id="l5.14">   nsresult GetMsgPreviewTextFromStream(nsIMsgDBHdr *msgHdr, nsIInputStream *stream);</span>
<a href="#l5.15"></a><span id="l5.15"> protected:</span>
<a href="#l5.16"></a><span id="l5.16">   </span>
<a href="#l5.17"></a><span id="l5.17">   // this is a little helper function that is not part of the public interface. </span>
<a href="#l5.18"></a><span id="l5.18">   // we use it to get the IID of the incoming server for the derived folder.</span>
<a href="#l5.19"></a><span id="l5.19">   // w/out a function like this we would have to implement GetServer in each</span>
<a href="#l5.20"></a><span id="l5.20">   // derived folder class.</span>
<a href="#l5.21"></a><span id="l5.21">   virtual void GetIncomingServerType(nsCString&amp; serverType) = 0;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -160,16 +162,17 @@ protected:</span>
<a href="#l5.23"></a><span id="l5.23">   nsresult CloseDBIfFolderNotOpen();</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   virtual nsresult SpamFilterClassifyMessage(const char *aURI, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l5.26"></a><span id="l5.26">   virtual nsresult SpamFilterClassifyMessages(const char **aURIArray, PRUint32 aURICount, nsIMsgWindow *aMsgWindow, nsIJunkMailPlugin *aJunkMailPlugin);</span>
<a href="#l5.27"></a><span id="l5.27">   void    SetMRUTime();</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29"> protected:</span>
<a href="#l5.30"></a><span id="l5.30">   nsCOMPtr&lt;nsIMsgDatabase&gt; mDatabase;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; mBackupDatabase;</span>
<a href="#l5.32"></a><span id="l5.32">   nsCString mCharset;</span>
<a href="#l5.33"></a><span id="l5.33">   PRBool mCharsetOverride;</span>
<a href="#l5.34"></a><span id="l5.34">   PRBool mAddListener;</span>
<a href="#l5.35"></a><span id="l5.35">   PRBool mNewMessages;</span>
<a href="#l5.36"></a><span id="l5.36">   PRBool mGettingNewMessages;</span>
<a href="#l5.37"></a><span id="l5.37">   nsMsgKey mLastMessageLoaded;</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39">   nsCOMPtr &lt;nsIMsgDBHdr&gt; m_offlineHeader;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1216,17 +1216,17 @@ NS_IMETHODIMP nsMsgDatabase::ForceClosed</span>
<a href="#l6.4"></a><span id="l6.4">   // make sure someone has a reference so object won't get deleted out from under us.</span>
<a href="#l6.5"></a><span id="l6.5">   AddRef();</span>
<a href="#l6.6"></a><span id="l6.6">   NotifyAnnouncerGoingAway();</span>
<a href="#l6.7"></a><span id="l6.7">   // make sure dbFolderInfo isn't holding onto mork stuff because mork db is going away</span>
<a href="#l6.8"></a><span id="l6.8">   if (m_dbFolderInfo)</span>
<a href="#l6.9"></a><span id="l6.9">     m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l6.10"></a><span id="l6.10">   NS_IF_RELEASE(m_dbFolderInfo);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  err = CloseMDB(PR_FALSE);  // since we're about to delete it, no need to commit.</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  err = CloseMDB(PR_TRUE);  // Backup DB will try to recover info, so commit</span>
<a href="#l6.14"></a><span id="l6.14">   ClearCachedObjects(PR_TRUE);</span>
<a href="#l6.15"></a><span id="l6.15">   if (m_mdbAllMsgHeadersTable)</span>
<a href="#l6.16"></a><span id="l6.16">   {</span>
<a href="#l6.17"></a><span id="l6.17">     m_mdbAllMsgHeadersTable-&gt;Release();</span>
<a href="#l6.18"></a><span id="l6.18">     m_mdbAllMsgHeadersTable = nsnull;</span>
<a href="#l6.19"></a><span id="l6.19">   }</span>
<a href="#l6.20"></a><span id="l6.20">   if (m_mdbAllThreadsTable)</span>
<a href="#l6.21"></a><span id="l6.21">   {</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -4043,19 +4043,23 @@ NS_IMETHODIMP nsMsgDatabase::GetMsgHdrFo</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   messageIdYarn.mYarn_Buf = (void *) msgID;</span>
<a href="#l6.25"></a><span id="l6.25">   messageIdYarn.mYarn_Fill = PL_strlen(msgID);</span>
<a href="#l6.26"></a><span id="l6.26">   messageIdYarn.mYarn_Form = 0;</span>
<a href="#l6.27"></a><span id="l6.27">   messageIdYarn.mYarn_Size = messageIdYarn.mYarn_Fill;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   nsIMdbRow *hdrRow;</span>
<a href="#l6.30"></a><span id="l6.30">   mdbOid outRowId;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  mdb_err result = GetStore()-&gt;FindRow(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    m_messageIdColumnToken, &amp;messageIdYarn,  &amp;outRowId,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    &amp;hdrRow);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  mdb_err result;</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  if (m_mdbStore)</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+    result = m_mdbStore-&gt;FindRow(GetEnv(), m_hdrRowScopeToken,</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+      m_messageIdColumnToken, &amp;messageIdYarn,  &amp;outRowId,</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+      &amp;hdrRow);</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+  else</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l6.41"></a><span id="l6.41">   if (NS_SUCCEEDED(result) &amp;&amp; hdrRow)</span>
<a href="#l6.42"></a><span id="l6.42">   {</span>
<a href="#l6.43"></a><span id="l6.43">     //Get key from row</span>
<a href="#l6.44"></a><span id="l6.44">     mdbOid outOid;</span>
<a href="#l6.45"></a><span id="l6.45">     nsMsgKey key=0;</span>
<a href="#l6.46"></a><span id="l6.46">     if (hdrRow-&gt;GetOid(GetEnv(), &amp;outOid) == NS_OK)</span>
<a href="#l6.47"></a><span id="l6.47">       key = outOid.mOid_Id;</span>
<a href="#l6.48"></a><span id="l6.48">     rv = GetHdrFromUseCache(key, &amp;msgHdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1541,17 +1541,17 @@ NS_IMETHODIMP nsImapMailFolder::RenameLo</span>
<a href="#l7.4"></a><span id="l7.4">   nsCAutoString leafname(newName);</span>
<a href="#l7.5"></a><span id="l7.5">   nsCAutoString parentName;</span>
<a href="#l7.6"></a><span id="l7.6">   // newName always in the canonical form &quot;greatparent/parentname/leafname&quot;</span>
<a href="#l7.7"></a><span id="l7.7">   PRInt32 leafpos = leafname.RFindChar('/');</span>
<a href="#l7.8"></a><span id="l7.8">   if (leafpos &gt;0)</span>
<a href="#l7.9"></a><span id="l7.9">       leafname.Cut(0, leafpos+1);</span>
<a href="#l7.10"></a><span id="l7.10">   m_msgParser = nsnull;</span>
<a href="#l7.11"></a><span id="l7.11">   PrepareToRename();</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  ForceDBClosed();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  CloseAndBackupFolderDB(leafname);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15">   nsresult rv = NS_OK;</span>
<a href="#l7.16"></a><span id="l7.16">   nsCOMPtr&lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l7.17"></a><span id="l7.17">   rv = GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l7.18"></a><span id="l7.18">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   nsCOMPtr&lt;nsILocalFile&gt; parentPathFile;</span>
<a href="#l7.21"></a><span id="l7.21">   rv = parent-&gt;GetFilePath(getter_AddRefs(parentPathFile));</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -2502,20 +2502,32 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l7.23"></a><span id="l7.23">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">     nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.26"></a><span id="l7.26">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">     nsCOMPtr &lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l7.29"></a><span id="l7.29">     if (dbFolderInfo)</span>
<a href="#l7.30"></a><span id="l7.30">       dbFolderInfo-&gt;GetTransferInfo(getter_AddRefs(transferInfo));</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    // A backup message database might have been created earlier, for example</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    // if the user requested a reindex. We'll use the earlier one if we can,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    // otherwise we'll try to backup at this point.</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    nsresult rvbackup = OpenBackupMsgDatabase();</span>
<a href="#l7.36"></a><span id="l7.36">     if (mDatabase)</span>
<a href="#l7.37"></a><span id="l7.37">     {</span>
<a href="#l7.38"></a><span id="l7.38">       dbFolderInfo = nsnull;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-      mDatabase-&gt;ForceClosed();</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+      if (NS_FAILED(rvbackup))</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+      {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+        CloseAndBackupFolderDB(EmptyCString());</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+        if (NS_FAILED(OpenBackupMsgDatabase()))</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+          mBackupDatabase = nsnull;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+      }</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      else</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+        mDatabase-&gt;ForceClosed();</span>
<a href="#l7.48"></a><span id="l7.48">     }</span>
<a href="#l7.49"></a><span id="l7.49">     mDatabase = nsnull;</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51">     nsCOMPtr &lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l7.52"></a><span id="l7.52">     GetSummaryFileLocation(pathFile, getter_AddRefs(summaryFile));</span>
<a href="#l7.53"></a><span id="l7.53">     // Remove summary file.</span>
<a href="#l7.54"></a><span id="l7.54">     summaryFile-&gt;Remove(PR_FALSE);</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56" class="difflineat">@@ -2736,16 +2748,18 @@ nsresult nsImapMailFolder::SetupHeaderPa</span>
<a href="#l7.57"></a><span id="l7.57">     nsresult rv;</span>
<a href="#l7.58"></a><span id="l7.58">     m_msgParser = do_CreateInstance(kParseMailMsgStateCID, &amp;rv);</span>
<a href="#l7.59"></a><span id="l7.59">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.60"></a><span id="l7.60">   }</span>
<a href="#l7.61"></a><span id="l7.61">   else</span>
<a href="#l7.62"></a><span id="l7.62">     m_msgParser-&gt;Clear();</span>
<a href="#l7.63"></a><span id="l7.63"> </span>
<a href="#l7.64"></a><span id="l7.64">   m_msgParser-&gt;SetMailDB(mDatabase);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  if (mBackupDatabase)</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    m_msgParser-&gt;SetBackupMailDB(mBackupDatabase);</span>
<a href="#l7.67"></a><span id="l7.67">   return m_msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l7.68"></a><span id="l7.68"> }</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70"> nsresult nsImapMailFolder::ParseAdoptedHeaderLine(const char *aMessageLine, PRUint32 aMsgKey)</span>
<a href="#l7.71"></a><span id="l7.71"> {</span>
<a href="#l7.72"></a><span id="l7.72">   // we can get blocks that contain more than one line,</span>
<a href="#l7.73"></a><span id="l7.73">   // but they never contain partial lines</span>
<a href="#l7.74"></a><span id="l7.74">   const char *str = aMessageLine;</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineat">@@ -5026,16 +5040,19 @@ nsImapMailFolder::GetMessageId(nsIImapUr</span>
<a href="#l7.76"></a><span id="l7.76"> }</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78"> NS_IMETHODIMP</span>
<a href="#l7.79"></a><span id="l7.79"> nsImapMailFolder::HeaderFetchCompleted(nsIImapProtocol* aProtocol)</span>
<a href="#l7.80"></a><span id="l7.80"> {</span>
<a href="#l7.81"></a><span id="l7.81">   nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow; // we might need this for the filter plugins.</span>
<a href="#l7.82"></a><span id="l7.82">   if (mDatabase)</span>
<a href="#l7.83"></a><span id="l7.83">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  if (mBackupDatabase)</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    RemoveBackupMsgDatabase();</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+</span>
<a href="#l7.87"></a><span id="l7.87">   SetSizeOnDisk(mFolderSize);</span>
<a href="#l7.88"></a><span id="l7.88">   PRInt32 numNewBiffMsgs = 0;</span>
<a href="#l7.89"></a><span id="l7.89">   if (m_performingBiff)</span>
<a href="#l7.90"></a><span id="l7.90">     GetNumNewMessages(PR_FALSE, &amp;numNewBiffMsgs);</span>
<a href="#l7.91"></a><span id="l7.91"> </span>
<a href="#l7.92"></a><span id="l7.92">   PRBool pendingMoves = m_moveCoalescer &amp;&amp; m_moveCoalescer-&gt;HasPendingMoves();</span>
<a href="#l7.93"></a><span id="l7.93">   PlaybackCoalescedOperations();</span>
<a href="#l7.94"></a><span id="l7.94">   if (aProtocol)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/public/nsIMsgParseMailMsgState.idl</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/public/nsIMsgParseMailMsgState.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -43,21 +43,28 @@ interface nsIOutputStream;</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> %{C++</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> %}</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> typedef long nsMailboxParseState;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-[scriptable, uuid(BE2B880F-B696-46FB-B78A-18FB3C795AEB)]</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+[scriptable, uuid(9BE9B91D-5D5B-4e85-84B2-79FBFF56F5D4)]</span>
<a href="#l8.14"></a><span id="l8.14"> interface nsIMsgParseMailMsgState : nsISupports {</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">     attribute unsigned long envelopePos;</span>
<a href="#l8.17"></a><span id="l8.17">     void SetMailDB(in nsIMsgDatabase aDatabase);</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    /*</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+     * Set a backup mail database, whose data will be read during parsing to</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+     * attempt to recover message metadata</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+     *</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+     * @param aDatabase   the backup database</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+     */</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    void SetBackupMailDB(in nsIMsgDatabase aDatabase);</span>
<a href="#l8.25"></a><span id="l8.25">     void setDBFolderStream(in nsIOutputStream fileStream);</span>
<a href="#l8.26"></a><span id="l8.26">     void Clear();</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">     void ParseAFolderLine(in string line, in unsigned long lineLength);</span>
<a href="#l8.29"></a><span id="l8.29">     nsIMsgDBHdr GetNewMsgHdr();</span>
<a href="#l8.30"></a><span id="l8.30">     void FinishHeader();</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">     long GetAllHeaders(out string headers);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -515,17 +515,29 @@ NS_IMETHODIMP nsMsgLocalMailFolder::GetD</span>
<a href="#l9.4"></a><span id="l9.4">         {</span>
<a href="#l9.5"></a><span id="l9.5">           if (folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l9.6"></a><span id="l9.6">             dbFolderInfo-&gt;SetFlags(mFlags);</span>
<a href="#l9.7"></a><span id="l9.7">           dbFolderInfo-&gt;SetNumMessages(0);</span>
<a href="#l9.8"></a><span id="l9.8">           dbFolderInfo-&gt;SetNumUnreadMessages(0);</span>
<a href="#l9.9"></a><span id="l9.9">           dbFolderInfo-&gt;GetTransferInfo(getter_AddRefs(transferInfo));</span>
<a href="#l9.10"></a><span id="l9.10">         }</span>
<a href="#l9.11"></a><span id="l9.11">         dbFolderInfo = nsnull;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-        mDatabase-&gt;ForceClosed();</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+        // A backup message database might have been created earlier, for example</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+        // if the user requested a reindex. We'll use the earlier one if we can,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+        // otherwise we'll try to backup at this point.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+        if (NS_FAILED(OpenBackupMsgDatabase()))</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+        {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+          CloseAndBackupFolderDB(EmptyCString());</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+          if (NS_FAILED(OpenBackupMsgDatabase()))</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+            mBackupDatabase = nsnull;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+        }</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+        else</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+          mDatabase-&gt;ForceClosed();</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+</span>
<a href="#l9.26"></a><span id="l9.26">         mDatabase = nsnull;</span>
<a href="#l9.27"></a><span id="l9.27">       }</span>
<a href="#l9.28"></a><span id="l9.28">       nsCOMPtr &lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l9.29"></a><span id="l9.29">       rv = GetSummaryFileLocation(pathFile, getter_AddRefs(summaryFile));</span>
<a href="#l9.30"></a><span id="l9.30">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.31"></a><span id="l9.31">       // Remove summary file.</span>
<a href="#l9.32"></a><span id="l9.32">       summaryFile-&gt;Remove(PR_FALSE);</span>
<a href="#l9.33"></a><span id="l9.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -158,16 +158,25 @@ NS_IMETHODIMP nsMsgMailboxParser::OnStar</span>
<a href="#l10.4"></a><span id="l10.4">             if (msgDBService)</span>
<a href="#l10.5"></a><span id="l10.5">             {</span>
<a href="#l10.6"></a><span id="l10.6">                 //Use OpenFolderDB to always open the db so that db's m_folder is set correctly.</span>
<a href="#l10.7"></a><span id="l10.7">                 rv = msgDBService-&gt;OpenFolderDB(folder, PR_TRUE, PR_TRUE, (nsIMsgDatabase **) getter_AddRefs(m_mailDB));</span>
<a href="#l10.8"></a><span id="l10.8">                 if (m_mailDB)</span>
<a href="#l10.9"></a><span id="l10.9">                     m_mailDB-&gt;AddListener(this);</span>
<a href="#l10.10"></a><span id="l10.10">             }</span>
<a href="#l10.11"></a><span id="l10.11">             NS_ASSERTION(m_mailDB, &quot;failed to open mail db parsing folder&quot;);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+            // try to get a backup message database</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+            nsresult rvignore = folder-&gt;GetBackupMsgDatabase(</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+                getter_AddRefs(m_backupMailDB));</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+            // We'll accept failures and move on, as we're dealing with some</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+            // sort of unknown problem to begin with.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+            if (NS_FAILED(rvignore))</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+              m_backupMailDB = nsnull;</span>
<a href="#l10.21"></a><span id="l10.21">         }</span>
<a href="#l10.22"></a><span id="l10.22">     }</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">     // need to get the mailbox name out of the url and call SetMailboxName with it.</span>
<a href="#l10.25"></a><span id="l10.25">     // then, we need to open the mail db for this parser.</span>
<a href="#l10.26"></a><span id="l10.26">     return rv;</span>
<a href="#l10.27"></a><span id="l10.27"> }</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29" class="difflineat">@@ -335,16 +344,25 @@ void nsMsgMailboxParser::DoneParsingFold</span>
<a href="#l10.30"></a><span id="l10.30">   PublishMsgHeader(nsnull);</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   // only mark the db valid if we've succeeded.</span>
<a href="#l10.33"></a><span id="l10.33">   if (NS_SUCCEEDED(status) &amp;&amp; m_mailDB)  // finished parsing, so flush db folder info</span>
<a href="#l10.34"></a><span id="l10.34">     UpdateDBFolderInfo();</span>
<a href="#l10.35"></a><span id="l10.35">   else if (m_mailDB)</span>
<a href="#l10.36"></a><span id="l10.36">     m_mailDB-&gt;SetSummaryValid(PR_FALSE);</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  // remove the backup database</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  if (m_backupMailDB)</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+  {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    if (folder)</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+      folder-&gt;RemoveBackupMsgDatabase();</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    m_backupMailDB = nsnull;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  }</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+</span>
<a href="#l10.47"></a><span id="l10.47">   //  if (m_folder != nsnull)</span>
<a href="#l10.48"></a><span id="l10.48">   //    m_folder-&gt;SummaryChanged();</span>
<a href="#l10.49"></a><span id="l10.49">   FreeBuffers();</span>
<a href="#l10.50"></a><span id="l10.50"> }</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52"> void nsMsgMailboxParser::FreeBuffers()</span>
<a href="#l10.53"></a><span id="l10.53"> {</span>
<a href="#l10.54"></a><span id="l10.54">   /* We're done reading the folder - we don't need these things</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineat">@@ -650,16 +668,22 @@ PRInt32 nsParseMailMessageState::ParseFo</span>
<a href="#l10.56"></a><span id="l10.56"> }</span>
<a href="#l10.57"></a><span id="l10.57"> </span>
<a href="#l10.58"></a><span id="l10.58"> NS_IMETHODIMP nsParseMailMessageState::SetMailDB(nsIMsgDatabase *mailDB)</span>
<a href="#l10.59"></a><span id="l10.59"> {</span>
<a href="#l10.60"></a><span id="l10.60">   m_mailDB = mailDB;</span>
<a href="#l10.61"></a><span id="l10.61">   return NS_OK;</span>
<a href="#l10.62"></a><span id="l10.62"> }</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetBackupMailDB(nsIMsgDatabase *aBackupMailDB)</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+{</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+  m_backupMailDB = aBackupMailDB;</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  return NS_OK;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+}</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+</span>
<a href="#l10.70"></a><span id="l10.70"> NS_IMETHODIMP nsParseMailMessageState::SetDBFolderStream(nsIOutputStream *fileStream)</span>
<a href="#l10.71"></a><span id="l10.71"> {</span>
<a href="#l10.72"></a><span id="l10.72">   NS_ASSERTION(m_mailDB, &quot;m_mailDB is not set&quot;);</span>
<a href="#l10.73"></a><span id="l10.73">   if (m_mailDB)</span>
<a href="#l10.74"></a><span id="l10.74">     m_mailDB-&gt;SetFolderStream(fileStream);</span>
<a href="#l10.75"></a><span id="l10.75">   return NS_OK;</span>
<a href="#l10.76"></a><span id="l10.76"> }</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78" class="difflineat">@@ -1259,17 +1283,47 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l10.79"></a><span id="l10.79">   {</span>
<a href="#l10.80"></a><span id="l10.80">     PRUint32 flags2 = 0;</span>
<a href="#l10.81"></a><span id="l10.81">     sscanf(mozstatus2-&gt;value, &quot; %x &quot;, &amp;flags2);</span>
<a href="#l10.82"></a><span id="l10.82">     flags |= flags2;</span>
<a href="#l10.83"></a><span id="l10.83">   }</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85">   if (!(flags &amp; MSG_FLAG_EXPUNGED))  // message was deleted, don't bother creating a hdr.</span>
<a href="#l10.86"></a><span id="l10.86">   {</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-    nsresult ret = m_mailDB-&gt;CreateNewHdr(m_envelope_pos, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+    // We'll need the message id first to recover data from the backup database</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+    nsCAutoString rawMsgId;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    /* Take off &lt;&gt; around message ID. */</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+    if (id)</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    {</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+      if (id-&gt;value[0] == '&lt;')</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+        id-&gt;value++, id-&gt;length--;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+      if (id-&gt;value[id-&gt;length - 1] == '&gt;')</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+        /* generate a new null-terminated string without the final &gt; */</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+        rawMsgId.Assign(id-&gt;value, id-&gt;length - 1);</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+      else</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+        rawMsgId.Assign(id-&gt;value);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+    }</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+    /*</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+     * Try to copy the data from the backup database, referencing the MessageID</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+     * If that fails, just create a new header</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+     */</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHeader;</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    nsresult ret = NS_ERROR_FAILURE;</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+    if (m_backupMailDB &amp;&amp; !rawMsgId.IsEmpty())</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+      ret = m_backupMailDB-&gt;GetMsgHdrForMessageID(</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+              rawMsgId.get(), getter_AddRefs(oldHeader));</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+    if (NS_SUCCEEDED(ret) &amp;&amp; oldHeader)</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+        ret = m_mailDB-&gt;CopyHdrFromExistingHdr(m_envelope_pos,</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+                oldHeader, PR_FALSE, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+    else</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+      ret = m_mailDB-&gt;CreateNewHdr(m_envelope_pos, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+</span>
<a href="#l10.119"></a><span id="l10.119">     if (NS_SUCCEEDED(ret) &amp;&amp; m_newMsgHdr)</span>
<a href="#l10.120"></a><span id="l10.120">     {</span>
<a href="#l10.121"></a><span id="l10.121">       PRUint32 origFlags;</span>
<a href="#l10.122"></a><span id="l10.122">       (void)m_newMsgHdr-&gt;GetFlags(&amp;origFlags);</span>
<a href="#l10.123"></a><span id="l10.123">       if (origFlags &amp; MSG_FLAG_HAS_RE)</span>
<a href="#l10.124"></a><span id="l10.124">         flags |= MSG_FLAG_HAS_RE;</span>
<a href="#l10.125"></a><span id="l10.125">       else</span>
<a href="#l10.126"></a><span id="l10.126">         flags &amp;= ~MSG_FLAG_HAS_RE;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineat">@@ -1383,28 +1437,20 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l10.128"></a><span id="l10.128">               md5_b64 = hash.get();</span>
<a href="#l10.129"></a><span id="l10.129">           }</span>
<a href="#l10.130"></a><span id="l10.130">           PR_snprintf (md5_data, sizeof(md5_data), &quot;&lt;md5:%s&gt;&quot;, md5_b64);</span>
<a href="#l10.131"></a><span id="l10.131">           md5_header.value = md5_data;</span>
<a href="#l10.132"></a><span id="l10.132">           md5_header.length = strlen(md5_data);</span>
<a href="#l10.133"></a><span id="l10.133">           id = &amp;md5_header;</span>
<a href="#l10.134"></a><span id="l10.134">         }</span>
<a href="#l10.135"></a><span id="l10.135"> </span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-        /* Take off &lt;&gt; around message ID. */</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-        if (id-&gt;value[0] == '&lt;')</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-          id-&gt;value++, id-&gt;length--;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-        if (id-&gt;value[id-&gt;length-1] == '&gt;') {</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-          /* generate a new null-terminated string without the final &gt; */</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-          nsCAutoString rawMsgId;</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-          rawMsgId.Assign(id-&gt;value, id-&gt;length - 1);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+        if (!rawMsgId.IsEmpty())</span>
<a href="#l10.145"></a><span id="l10.145">           m_newMsgHdr-&gt;SetMessageId(rawMsgId.get());</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-        } else {</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+        else</span>
<a href="#l10.148"></a><span id="l10.148">           m_newMsgHdr-&gt;SetMessageId(id-&gt;value);</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-        }</span>
<a href="#l10.150"></a><span id="l10.150"> </span>
<a href="#l10.151"></a><span id="l10.151">         if (!mozstatus &amp;&amp; statush)</span>
<a href="#l10.152"></a><span id="l10.152">         {</span>
<a href="#l10.153"></a><span id="l10.153">           /* Parse a little bit of the Berkeley Mail status header. */</span>
<a href="#l10.154"></a><span id="l10.154">           for (s = statush-&gt;value; *s; s++) {</span>
<a href="#l10.155"></a><span id="l10.155">             PRUint32 msgFlags = 0;</span>
<a href="#l10.156"></a><span id="l10.156">             (void)m_newMsgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l10.157"></a><span id="l10.157">             switch (*s)</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineat">@@ -1477,17 +1523,36 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l10.159"></a><span id="l10.159">         }</span>
<a href="#l10.160"></a><span id="l10.160">         m_newMsgHdr-&gt;SetUint32Property(&quot;dateReceived&quot;, rcvTimeSecs);</span>
<a href="#l10.161"></a><span id="l10.161"> </span>
<a href="#l10.162"></a><span id="l10.162">         if (priority)</span>
<a href="#l10.163"></a><span id="l10.163">           m_newMsgHdr-&gt;SetPriorityString(priority-&gt;value);</span>
<a href="#l10.164"></a><span id="l10.164">         else if (priorityFlags == nsMsgPriority::notSet)</span>
<a href="#l10.165"></a><span id="l10.165">           m_newMsgHdr-&gt;SetPriority(nsMsgPriority::none);</span>
<a href="#l10.166"></a><span id="l10.166">         if (keywords)</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-          m_newMsgHdr-&gt;SetStringProperty(&quot;keywords&quot;, keywords-&gt;value);</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+        {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+          // When there are many keywords, some may not have been written</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+          // to the message file, so add extra keywords from the backup</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+          nsCAutoString oldKeywords;</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+          m_newMsgHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(oldKeywords));</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+          nsCStringArray newKeywordArray, oldKeywordArray;</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+          newKeywordArray.ParseString(keywords-&gt;value, &quot; &quot;);</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+          oldKeywordArray.ParseString(oldKeywords.get(), &quot; &quot;);</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+          for (PRInt32 i = 0; i &lt; oldKeywordArray.Count(); i++)</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+            if (newKeywordArray.IndexOf(*oldKeywordArray.CStringAt(i)) &lt; 0)</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+              newKeywordArray.AppendCString(*oldKeywordArray.CStringAt(i));</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+          nsCAutoString newKeywords;</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+          for (PRInt32 i = 0; i &lt; newKeywordArray.Count(); i++)</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+          {</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+            if (i)</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+              newKeywords.Append(&quot; &quot;);</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+            newKeywords.Append(*newKeywordArray.CStringAt(i));</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+          }</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+          m_newMsgHdr-&gt;SetStringProperty(&quot;keywords&quot;, newKeywords.get());</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+        }</span>
<a href="#l10.188"></a><span id="l10.188">         for (PRInt32 i = 0; i &lt; m_customDBHeaders.Count(); i++)</span>
<a href="#l10.189"></a><span id="l10.189">         {</span>
<a href="#l10.190"></a><span id="l10.190">           if (m_customDBHeaderValues[i].length)</span>
<a href="#l10.191"></a><span id="l10.191">             m_newMsgHdr-&gt;SetStringProperty((m_customDBHeaders[i])-&gt;get(), m_customDBHeaderValues[i].value);</span>
<a href="#l10.192"></a><span id="l10.192">         }</span>
<a href="#l10.193"></a><span id="l10.193">         if (content_type)</span>
<a href="#l10.194"></a><span id="l10.194">         {</span>
<a href="#l10.195"></a><span id="l10.195">           char *substring = PL_strstr(content_type-&gt;value, &quot;charset&quot;);</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineat">@@ -1608,16 +1673,18 @@ nsParseNewMailState::Init(nsIMsgFolder *</span>
<a href="#l10.197"></a><span id="l10.197">   m_disableFilters = PR_FALSE;</span>
<a href="#l10.198"></a><span id="l10.198">   return NS_OK;</span>
<a href="#l10.199"></a><span id="l10.199"> }</span>
<a href="#l10.200"></a><span id="l10.200"> </span>
<a href="#l10.201"></a><span id="l10.201"> nsParseNewMailState::~nsParseNewMailState()</span>
<a href="#l10.202"></a><span id="l10.202"> {</span>
<a href="#l10.203"></a><span id="l10.203">   if (m_mailDB)</span>
<a href="#l10.204"></a><span id="l10.204">     m_mailDB-&gt;Close(PR_TRUE);</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineplus">+  if (m_backupMailDB)</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineplus">+    m_backupMailDB-&gt;ForceClosed();</span>
<a href="#l10.207"></a><span id="l10.207"> #ifdef DOING_JSFILTERS</span>
<a href="#l10.208"></a><span id="l10.208">   JSFilter_cleanup();</span>
<a href="#l10.209"></a><span id="l10.209"> #endif</span>
<a href="#l10.210"></a><span id="l10.210"> }</span>
<a href="#l10.211"></a><span id="l10.211"> </span>
<a href="#l10.212"></a><span id="l10.212"> // not an IMETHOD so we don't need to do error checking or return an error.</span>
<a href="#l10.213"></a><span id="l10.213"> // We only have one caller.</span>
<a href="#l10.214"></a><span id="l10.214"> void nsParseNewMailState::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -96,16 +96,17 @@ public:</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">   static PRBool  IsEnvelopeLine(const char *buf, PRInt32 buf_size);</span>
<a href="#l11.6"></a><span id="l11.6">   static int  msg_UnHex(char C);</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; m_HeaderAddressParser;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newMsgHdr; /* current message header we're building */</span>
<a href="#l11.11"></a><span id="l11.11">   nsCOMPtr&lt;nsIMsgDatabase&gt;  m_mailDB;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_backupMailDB;</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14">   nsMailboxParseState   m_state;</span>
<a href="#l11.15"></a><span id="l11.15">   PRUint32              m_position;</span>
<a href="#l11.16"></a><span id="l11.16">   PRUint32              m_envelope_pos;</span>
<a href="#l11.17"></a><span id="l11.17">   PRUint32              m_headerstartpos;</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   nsByteArray           m_headers;</span>
<a href="#l11.20"></a><span id="l11.20"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

