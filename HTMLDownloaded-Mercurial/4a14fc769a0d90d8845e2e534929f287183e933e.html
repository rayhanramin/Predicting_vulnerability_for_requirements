<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8755:4a14fc769a0d90d8845e2e534929f287183e933e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4a14fc769a0d90d8845e2e534929f287183e933e" />
<meta property="og:url" content="/comm-central/rev/4a14fc769a0d90d8845e2e534929f287183e933e" />
<meta property="og:description" content="Fix bug 697553 - Adapt to the calIChangeLog interface changes (gdata offline support)." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4a14fc769a0d90d8845e2e534929f287183e933e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4a14fc769a0d90d8845e2e534929f287183e933e">shortlog</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4a14fc769a0d90d8845e2e534929f287183e933e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e">files</a> |
changeset |
<a href="/comm-central/raw-rev/4a14fc769a0d90d8845e2e534929f287183e933e">raw</a>  | <a href="/comm-central/archive/4a14fc769a0d90d8845e2e534929f287183e933e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=697553">bug 697553</a> - Adapt to the calIChangeLog interface changes (gdata offline support).
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 02 Nov 2011 23:41:02 +0100</td></tr>

<tr>
 <td>changeset 8755</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4a14fc769a0d90d8845e2e534929f287183e933e">4a14fc769a0d90d8845e2e534929f287183e933e</a></td>
</tr>



<tr>
<td>parent 8754</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/79fa4eac2aee9fcf02838a5d599e616e3611391f">79fa4eac2aee9fcf02838a5d599e616e3611391f</a>
</td>
</tr>

<tr>
<td>child 8756</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b519ca5ae1f2d935572ee4538784d9e0debbb472">b519ca5ae1f2d935572ee4538784d9e0debbb472</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4a14fc769a0d90d8845e2e534929f287183e933e">6732</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Wed, 02 Nov 2011 23:04:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1e91922620ba [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1e91922620bafb8ae925fd84d2c5954b1c30f432">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1e91922620bafb8ae925fd84d2c5954b1c30f432&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1e91922620bafb8ae925fd84d2c5954b1c30f432&newProject=comm-central&newRevision=4a14fc769a0d90d8845e2e534929f287183e933e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1e91922620bafb8ae925fd84d2c5954b1c30f432&newProject=comm-central&newRevision=4a14fc769a0d90d8845e2e534929f287183e933e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1e91922620bafb8ae925fd84d2c5954b1c30f432&newProject=comm-central&newRevision=4a14fc769a0d90d8845e2e534929f287183e933e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=697553">697553</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=697553">bug 697553</a> - Adapt to the calIChangeLog interface changes (gdata offline support).</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">calendar/base/content/dialogs/calendar-conflicts-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendarModule.js">calendar/providers/gdata/components/calGoogleCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendarModule.js">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendarModule.js">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleRequest.js">calendar/providers/gdata/components/calGoogleRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleRequest.js">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleRequest.js">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleRequest.js">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleRequest.js">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleSession.js">calendar/providers/gdata/components/calGoogleSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleSession.js">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleSession.js">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleSession.js">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleSession.js">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleSession.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleUtils.js">calendar/providers/gdata/components/calGoogleUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleUtils.js">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleUtils.js">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleUtils.js">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleUtils.js">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/components/calGoogleUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/public/calIGoogleRequest.idl">calendar/providers/gdata/public/calIGoogleRequest.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/public/calIGoogleRequest.idl">file</a> |
<a href="/comm-central/annotate/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/public/calIGoogleRequest.idl">annotate</a> |
<a href="/comm-central/diff/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/public/calIGoogleRequest.idl">diff</a> |
<a href="/comm-central/comparison/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/public/calIGoogleRequest.idl">comparison</a> |
<a href="/comm-central/log/4a14fc769a0d90d8845e2e534929f287183e933e/calendar/providers/gdata/public/calIGoogleRequest.idl">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-conflicts-dialog.xul</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-conflicts-dialog.xul</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -61,17 +61,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">         // should be reworked!</span>
<a href="#l1.5"></a><span id="l1.5">         docEl.title =  cal.calGetString(&quot;calendar&quot;, &quot;itemModifiedOnServerTitle&quot;);</span>
<a href="#l1.6"></a><span id="l1.6">         descr.textContent = cal.calGetString(&quot;calendar&quot;, &quot;itemModifiedOnServer&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">         if (window.arguments[0].mode == &quot;modify&quot;) {</span>
<a href="#l1.9"></a><span id="l1.9">             descr.textContent += cal.calGetString(&quot;calendar&quot;, &quot;modifyWillLoseData&quot;);</span>
<a href="#l1.10"></a><span id="l1.10">             docEl.getButton(&quot;accept&quot;).setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;proceedModify&quot;));</span>
<a href="#l1.11"></a><span id="l1.11">         } else {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-            promptMessage += cal.calGetString(&quot;calendar&quot;, &quot;deleteWillLoseData&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+            descr.textContent += cal.calGetString(&quot;calendar&quot;, &quot;deleteWillLoseData&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">             docEl.getButton(&quot;accept&quot;).setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;proceedDelete&quot;));</span>
<a href="#l1.15"></a><span id="l1.15">         }</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">         docEl.getButton(&quot;cancel&quot;).setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;updateFromServer&quot;));</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">         window.sizeToContent();</span>
<a href="#l1.20"></a><span id="l1.20">     }</span>
<a href="#l1.21"></a><span id="l1.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -448,17 +448,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">             itemCount: 0,</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">             onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l2.7"></a><span id="l2.7">             },</span>
<a href="#l2.8"></a><span id="l2.8">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.9"></a><span id="l2.9">                 if (Components.isSuccessCode(status)) {</span>
<a href="#l2.10"></a><span id="l2.10">                     storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l2.11"></a><span id="l2.11">                 } else {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-                    cal.LOG(&quot;[calCachedCalendar.js] Unable to playback the items to the server. Will try back again. Aborting\n&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+                    cal.LOG(&quot;[calCachedCalendar.js] Unable to playback the items to the server. Will try again later. Aborting\n&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">                     // TODO does something need to be called back?</span>
<a href="#l2.15"></a><span id="l2.15">                 }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">                 this.itemCount--;</span>
<a href="#l2.18"></a><span id="l2.18">                 if (this.itemCount == 0) {</span>
<a href="#l2.19"></a><span id="l2.19">                     this_.playbackModifiedItems(callbackFunc);</span>
<a href="#l2.20"></a><span id="l2.20">                 }</span>
<a href="#l2.21"></a><span id="l2.21">             }</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -473,22 +473,31 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.23"></a><span id="l2.23">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.24"></a><span id="l2.24">                 if (this_.offline) {</span>
<a href="#l2.25"></a><span id="l2.25">                     cal.LOG(&quot;[calCachedCalendar] back to offline mode, reconciliation aborted&quot;);</span>
<a href="#l2.26"></a><span id="l2.26">                     callbackFunc();</span>
<a href="#l2.27"></a><span id="l2.27">                 } else {</span>
<a href="#l2.28"></a><span id="l2.28">                     cal.LOG(&quot;[calCachedCalendar] Adding &quot;  + this.items.length + &quot; items to &quot; + this_.name);</span>
<a href="#l2.29"></a><span id="l2.29">                     if (this.items.length &gt; 0) {</span>
<a href="#l2.30"></a><span id="l2.30">                         addListener.itemCount = this.items.length;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-                        for each (var aItem in this.items) {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-                            if (this_.supportsChangeLog) {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-                                this_.mUncachedCalendar.addItemOrUseCache(aItem, false, addListener);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                            } else {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-                                // default mechanism for providers not implementing calIChangeLog</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-                                this_.mUncachedCalendar.adoptItem(aItem.clone(), addListener);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+                        for each (let item in this.items) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+                            try {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+                                if (this_.supportsChangeLog) {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+                                    this_.mUncachedCalendar.addItemOrUseCache(item, false, addListener);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+                                } else {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                                    // default mechanism for providers not implementing calIChangeLog</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+                                    this_.mUncachedCalendar.adoptItem(item.clone(), addListener);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+                                }</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+                            } catch (e) {</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+                                cal.ERROR(&quot;[calCachedCalendar] Could not playback added item &quot; + item.title + &quot;: &quot; + e);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+                                addListener.onOperationComplete(thisCalendar,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+                                                                e.result,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+                                                                Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+                                                                item.id,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                                                                e.message);</span>
<a href="#l2.52"></a><span id="l2.52">                             }</span>
<a href="#l2.53"></a><span id="l2.53">                         }</span>
<a href="#l2.54"></a><span id="l2.54">                     } else {</span>
<a href="#l2.55"></a><span id="l2.55">                         this_.playbackModifiedItems(callbackFunc);</span>
<a href="#l2.56"></a><span id="l2.56">                     }</span>
<a href="#l2.57"></a><span id="l2.57">                 }</span>
<a href="#l2.58"></a><span id="l2.58">                 delete this.items;</span>
<a href="#l2.59"></a><span id="l2.59">             }</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineat">@@ -532,23 +541,32 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.61"></a><span id="l2.61">                 if (this_.offline) {</span>
<a href="#l2.62"></a><span id="l2.62">                     cal.LOG(&quot;[calCachedCalendar] Returning to offline mode, reconciliation aborted&quot;);</span>
<a href="#l2.63"></a><span id="l2.63">                     callbackFunc();</span>
<a href="#l2.64"></a><span id="l2.64">                 } else {</span>
<a href="#l2.65"></a><span id="l2.65">                     cal.LOG(&quot;[calCachedCalendar] Modifying &quot; + this.items.length + &quot; items in &quot; + this_.name);</span>
<a href="#l2.66"></a><span id="l2.66">                     if (this.items.length &gt; 0) {</span>
<a href="#l2.67"></a><span id="l2.67">                         modifyListener.itemCount = this.items.length;</span>
<a href="#l2.68"></a><span id="l2.68">                         for each (let item in this.items) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-                            if (this_.supportsChangeLog) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                                // The calendar supports the changelog functions, let it modify the item</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-                                // TODO is it ok to not have the old item here? Pass null or the new item?</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-                                this_.mUncachedCalendar.modifyItemOrUseCache(item, item, false, modifyListener);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-                            } else {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-                                // Default strategy for providers not implementing calIChangeLog</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                                this_.mUncachedCalendar.modifyItem(item, null, modifyListener);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+                            try {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+                                if (this_.supportsChangeLog) {</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+                                    // The calendar supports the changelog functions, let it modify the item</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+                                    // TODO is it ok to not have the old item here? Pass null or the new item?</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+                                    this_.mUncachedCalendar.modifyItemOrUseCache(item, item, false, modifyListener);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+                                } else {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+                                    // Default strategy for providers not implementing calIChangeLog</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+                                    this_.mUncachedCalendar.modifyItem(item, null, modifyListener);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                                }</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+                            } catch (e) {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+                                cal.ERROR(&quot;[calCachedCalendar] Could not playback modified item &quot; + item.title + &quot;: &quot; + e);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                                modifyListener.onOperationComplete(thisCalendar,</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                                                                   e.result,</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+                                                                   Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+                                                                   item.id,</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+                                                                   e.message);</span>
<a href="#l2.92"></a><span id="l2.92">                             }</span>
<a href="#l2.93"></a><span id="l2.93">                         }</span>
<a href="#l2.94"></a><span id="l2.94">                     } else {</span>
<a href="#l2.95"></a><span id="l2.95">                         this_.playbackDeletedItems(callbackFunc);</span>
<a href="#l2.96"></a><span id="l2.96">                     }</span>
<a href="#l2.97"></a><span id="l2.97">                 }</span>
<a href="#l2.98"></a><span id="l2.98">                 delete this.items;</span>
<a href="#l2.99"></a><span id="l2.99">             }</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineat">@@ -590,22 +608,31 @@ calCachedCalendar.prototype = {</span>
<a href="#l2.101"></a><span id="l2.101">             onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l2.102"></a><span id="l2.102">                 if (this_.offline) {</span>
<a href="#l2.103"></a><span id="l2.103">                     cal.LOG(&quot;[calCachedCalendar] Returning to offline mode, reconciliation aborted&quot;);</span>
<a href="#l2.104"></a><span id="l2.104">                     callbackFunc();</span>
<a href="#l2.105"></a><span id="l2.105">                 } else {</span>
<a href="#l2.106"></a><span id="l2.106">                     cal.LOG(&quot;[calCachedCalendar] Deleting &quot;  + this.items.length + &quot; items from &quot; + this_.name);</span>
<a href="#l2.107"></a><span id="l2.107">                     if (this.items.length &gt; 0) {</span>
<a href="#l2.108"></a><span id="l2.108">                         deleteListener.itemCount = this.items.length;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-                        for each (var aItem in this.items) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-                            if (this_.supportsChangeLog) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-                                this_.mUncachedCalendar.deleteItemOrUseCache(aItem, false, deleteListener);</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-                            } else {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-                                //Default strategy for providers not implementing calIChangeLog</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-                                this_.mUncachedCalendar.deleteItem(aItem, deleteListener);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+                        for each (let item in this.items) {</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+                            try {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+                                if (this_.supportsChangeLog) {</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+                                    this_.mUncachedCalendar.deleteItemOrUseCache(item, false, deleteListener);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+                                } else {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+                                    // Default strategy for providers not implementing calIChangeLog</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+                                    this_.mUncachedCalendar.deleteItem(item, deleteListener);</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+                                }</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+                            } catch (e) {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+                                cal.ERROR(&quot;[calCachedCalendar] Could not playback deleted item &quot; + item.title + &quot;: &quot; + e);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+                                deleteListener.onOperationComplete(thisCalendar,</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+                                                                   e.result,</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+                                                                   Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+                                                                   item.id,</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+                                                                   e.message);</span>
<a href="#l2.130"></a><span id="l2.130">                             }</span>
<a href="#l2.131"></a><span id="l2.131">                         }</span>
<a href="#l2.132"></a><span id="l2.132">                     } else if (callbackFunc) {</span>
<a href="#l2.133"></a><span id="l2.133">                         callbackFunc();</span>
<a href="#l2.134"></a><span id="l2.134">                     }</span>
<a href="#l2.135"></a><span id="l2.135">                 }</span>
<a href="#l2.136"></a><span id="l2.136">                 delete this.items;</span>
<a href="#l2.137"></a><span id="l2.137">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -34,16 +34,18 @@</span>
<a href="#l3.4"></a><span id="l3.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l3.5"></a><span id="l3.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l3.6"></a><span id="l3.6">  *</span>
<a href="#l3.7"></a><span id="l3.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+const cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+</span>
<a href="#l3.14"></a><span id="l3.14"> /**</span>
<a href="#l3.15"></a><span id="l3.15">  * calGoogleCalendar</span>
<a href="#l3.16"></a><span id="l3.16">  * This Implements a calICalendar Object adapted to the Google Calendar</span>
<a href="#l3.17"></a><span id="l3.17">  * Provider.</span>
<a href="#l3.18"></a><span id="l3.18">  *</span>
<a href="#l3.19"></a><span id="l3.19">  * @class</span>
<a href="#l3.20"></a><span id="l3.20">  * @constructor</span>
<a href="#l3.21"></a><span id="l3.21">  */</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -322,17 +324,21 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.23"></a><span id="l3.23">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l3.24"></a><span id="l3.24">     },</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">     get canRefresh() {</span>
<a href="#l3.27"></a><span id="l3.27">         return true;</span>
<a href="#l3.28"></a><span id="l3.28">     },</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">     adoptItem: function cGC_adoptItem(aItem, aListener) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-        LOG(&quot;Adding item &quot; + aItem.title);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        return this.adoptItemOrUseCache(aItem, !!this.mOfflineStorage, aListener);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    },</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    adoptItemOrUseCache: function adoptItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aItem.title);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">         try {</span>
<a href="#l3.39"></a><span id="l3.39">             // Check if calendar is readonly</span>
<a href="#l3.40"></a><span id="l3.40">             if (this.readOnly) {</span>
<a href="#l3.41"></a><span id="l3.41">                 throw new Components.Exception(&quot;&quot;,</span>
<a href="#l3.42"></a><span id="l3.42">                                                Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l3.43"></a><span id="l3.43">             }</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45" class="difflineat">@@ -351,30 +357,25 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.46"></a><span id="l3.46">                                           this.session.userName,</span>
<a href="#l3.47"></a><span id="l3.47">                                           this.session.fullName);</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">             request.type = request.ADD;</span>
<a href="#l3.50"></a><span id="l3.50">             request.uri = this.fullUri.spec;</span>
<a href="#l3.51"></a><span id="l3.51">             request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, xmlEntry);</span>
<a href="#l3.52"></a><span id="l3.52">             request.operationListener = aListener;</span>
<a href="#l3.53"></a><span id="l3.53">             request.calendar = this;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-            var calendar = this;</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-            request.responseListener = {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-                onResult: function cGC_addItem_response_onResult(aOperation, aData) {</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-                    calendar.addItem_response(aOperation, aData);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-                }</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-            };</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+            request.newItem = aItem;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+            request.useCache = useCache;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+            request.responseListener = { onResult: this.addItem_response.bind(this) };</span>
<a href="#l3.65"></a><span id="l3.65">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">             this.session.asyncItemRequest(request);</span>
<a href="#l3.68"></a><span id="l3.68">             return request;</span>
<a href="#l3.69"></a><span id="l3.69">         } catch (e) {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-            LOG(&quot;adoptItem failed before request &quot; + aItem.title + &quot;\n:&quot; + e);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] adoptItem failed before request &quot; + aItem.title + &quot;\n:&quot; + e);</span>
<a href="#l3.72"></a><span id="l3.72">             if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l3.73"></a><span id="l3.73">                 // The calendar is readonly, make sure this is set and</span>
<a href="#l3.74"></a><span id="l3.74">                 // notify the user. This can come from above or from</span>
<a href="#l3.75"></a><span id="l3.75">                 // mSession.addItem which checks for the editURI</span>
<a href="#l3.76"></a><span id="l3.76">                 this.readOnly = true;</span>
<a href="#l3.77"></a><span id="l3.77">             }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineat">@@ -384,54 +385,92 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.81"></a><span id="l3.81">                                          e.message);</span>
<a href="#l3.82"></a><span id="l3.82">         }</span>
<a href="#l3.83"></a><span id="l3.83">         return null;</span>
<a href="#l3.84"></a><span id="l3.84">     },</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">     addItem: function cGC_addItem(aItem, aListener) {</span>
<a href="#l3.87"></a><span id="l3.87">         // Google assigns an ID to every event added. Any id set here or in</span>
<a href="#l3.88"></a><span id="l3.88">         // adoptItem will be overridden.</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-        return this.adoptItem( aItem.clone(), aListener );</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+        return this.addItemOrUseCache(aItem, !!this.mOfflineStorage, aListener);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+    },</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    addItemOrUseCache: function addItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+        return this.adoptItemOrUseCache(aItem.clone(), useCache, aListener);</span>
<a href="#l3.95"></a><span id="l3.95">     },</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97">     modifyItem: function cGC_modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-        LOG(&quot;Modifying item &quot; + aOldItem.title);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+        if (this.mOfflineStorage) {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+            return this.modifyItemOrUseCache(aNewItem, aOldItem, true, aListener);</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+        } else {</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+            return this.doModifyItem(aNewItem, aOldItem, false, aListener);</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+        }</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+    },</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+    modifyItemOrUseCache: function modifyItemOrUseCache(aNewItem, aOldItem, useCache, aListener) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+        let modifyOfflineListener = {</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+                storage.modifyOfflineItem(detail, aListener);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+            }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+        };</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+        let offlineFlagListener = {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+                let offline_flag = detail;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+                    storage.modifyItem(aNewItem, aOldItem, modifyOfflineListener);</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+                } else {</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+                    thisCalendar.doModifyItem(aNewItem, aOldItem, useCache, aListener, false);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+                }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+            }</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+        };</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+        storage.getItemOfflineFlag(aOldItem, offlineFlagListener);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+    },</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+    doModifyItem: function doModifyItem(aNewItem, aOldItem, useCache, aListener) {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOldItem.title);</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134">         try {</span>
<a href="#l3.135"></a><span id="l3.135">             if (this.readOnly) {</span>
<a href="#l3.136"></a><span id="l3.136">                 throw new Components.Exception(&quot;&quot;,</span>
<a href="#l3.137"></a><span id="l3.137">                                                Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l3.138"></a><span id="l3.138">             }</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l3.141"></a><span id="l3.141">             // the login prompt.</span>
<a href="#l3.142"></a><span id="l3.142">             this.ensureSession();</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144">             // Check if enough fields have changed to warrant sending the event</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-            // to google. This saves network traffic.</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-            if (relevantFieldsMatch(aOldItem, aNewItem)) {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-                LOG(&quot;Not requesting item modification for &quot; + aOldItem.id +</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-                    &quot;(&quot; + aOldItem.title + &quot;), relevant fields match&quot;);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+            // to google. This saves network traffic. Also check if the item isn't</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+            // the same to work around a bug in the cache layer.</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+            if (aOldItem != aNewItem &amp;&amp; relevantFieldsMatch(aOldItem, aNewItem)) {</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Not requesting item modification for &quot; + aOldItem.id +</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+                        &quot;(&quot; + aOldItem.title + &quot;), relevant fields match&quot;);</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155">                 this.notifyOperationComplete(aListener,</span>
<a href="#l3.156"></a><span id="l3.156">                                              Components.results.NS_OK,</span>
<a href="#l3.157"></a><span id="l3.157">                                              Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.158"></a><span id="l3.158">                                              aNewItem.id,</span>
<a href="#l3.159"></a><span id="l3.159">                                              aNewItem);</span>
<a href="#l3.160"></a><span id="l3.160">                 this.mObservers.notify(&quot;onModifyItem&quot;, [aNewItem, aOldItem]);</span>
<a href="#l3.161"></a><span id="l3.161">                 return null;</span>
<a href="#l3.162"></a><span id="l3.162">             }</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164">             // Set up the request</span>
<a href="#l3.165"></a><span id="l3.165">             var request = new calGoogleRequest(this.session);</span>
<a href="#l3.166"></a><span id="l3.166"> </span>
<a href="#l3.167"></a><span id="l3.167">             // We need to clone the new item, its possible that ItemToXMLEntry</span>
<a href="#l3.168"></a><span id="l3.168">             // will modify the item. For example, if the item is organized by</span>
<a href="#l3.169"></a><span id="l3.169">             // someone else, we cannot save alarms on it and they should</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-            // therefore not be added in the returned item. </span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+            // therefore not be added in the returned item.</span>
<a href="#l3.172"></a><span id="l3.172">             var newItem = aNewItem.clone();</span>
<a href="#l3.173"></a><span id="l3.173"> </span>
<a href="#l3.174"></a><span id="l3.174">             var xmlEntry = ItemToXMLEntry(newItem, this,</span>
<a href="#l3.175"></a><span id="l3.175">                                           this.session.userName,</span>
<a href="#l3.176"></a><span id="l3.176">                                           this.session.fullName);</span>
<a href="#l3.177"></a><span id="l3.177"> </span>
<a href="#l3.178"></a><span id="l3.178">             if (aOldItem.parentItem != aOldItem &amp;&amp;</span>
<a href="#l3.179"></a><span id="l3.179">                 !aOldItem.parentItem.recurrenceInfo.getExceptionFor(aOldItem.startDate)) {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineat">@@ -441,36 +480,29 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.181"></a><span id="l3.181">                 request.uri = this.fullUri.spec;</span>
<a href="#l3.182"></a><span id="l3.182">             } else {</span>
<a href="#l3.183"></a><span id="l3.183">                 // We are  making a negative exception or modifying a parent item</span>
<a href="#l3.184"></a><span id="l3.184">                 request.type = request.MODIFY;</span>
<a href="#l3.185"></a><span id="l3.185">                 request.uri = getItemEditURI(aOldItem);</span>
<a href="#l3.186"></a><span id="l3.186">             }</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188">             request.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, xmlEntry);</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-            request.responseListener = this.modifyItem_response,</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+            request.responseListener = { onResult: this.modifyItem_response.bind(this) };</span>
<a href="#l3.191"></a><span id="l3.191">             request.operationListener = aListener;</span>
<a href="#l3.192"></a><span id="l3.192">             request.newItem = newItem;</span>
<a href="#l3.193"></a><span id="l3.193">             request.oldItem = aOldItem;</span>
<a href="#l3.194"></a><span id="l3.194">             request.calendar = this;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-            var calendar = this;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-            request.responseListener = {</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-                onResult: function cGC_modifyItem_response_onResult(aOperation, aData) {</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-                    calendar.modifyItem_response(aOperation, aData);</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-                }</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-            };</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+            request.useCache = useCache;</span>
<a href="#l3.204"></a><span id="l3.204">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l3.205"></a><span id="l3.205"> </span>
<a href="#l3.206"></a><span id="l3.206">             this.session.asyncItemRequest(request);</span>
<a href="#l3.207"></a><span id="l3.207">             return request;</span>
<a href="#l3.208"></a><span id="l3.208">         } catch (e) {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-            LOG(&quot;modifyItem failed before request &quot; +</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-                aNewItem.title + &quot;(&quot; + aNewItem.id + &quot;):\n&quot; + e);</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] modifyItem failed before request &quot; +</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+                    aNewItem.title + &quot;(&quot; + aNewItem.id + &quot;):\n&quot; + e);</span>
<a href="#l3.213"></a><span id="l3.213"> </span>
<a href="#l3.214"></a><span id="l3.214">             if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l3.215"></a><span id="l3.215">                 // The calendar is readonly, make sure this is set and</span>
<a href="#l3.216"></a><span id="l3.216">                 // notify the user. This can come from above or from</span>
<a href="#l3.217"></a><span id="l3.217">                 // mSession.modifyItem which checks for the editURI</span>
<a href="#l3.218"></a><span id="l3.218">                 this.readOnly = true;</span>
<a href="#l3.219"></a><span id="l3.219">             }</span>
<a href="#l3.220"></a><span id="l3.220"> </span>
<a href="#l3.221"></a><span id="l3.221" class="difflineat">@@ -478,18 +510,55 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.222"></a><span id="l3.222">                                          e.result,</span>
<a href="#l3.223"></a><span id="l3.223">                                          Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.224"></a><span id="l3.224">                                          null,</span>
<a href="#l3.225"></a><span id="l3.225">                                          e.message);</span>
<a href="#l3.226"></a><span id="l3.226">         }</span>
<a href="#l3.227"></a><span id="l3.227">         return null;</span>
<a href="#l3.228"></a><span id="l3.228">     },</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+</span>
<a href="#l3.231"></a><span id="l3.231">     deleteItem: function cGC_deleteItem(aItem, aListener) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-        LOG(&quot;Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+        if (this.mOfflineStorage) {</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+            return this.deleteItemOrUseCache(aItem, true, aListener);</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+        } else {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+            return this.doDeleteItem(aItem, false, aListener);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+        }</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+    },</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+    deleteItemOrUseCache: function deleteItemOrUseCache(aItem, useCache, aListener) {</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+        let thisCalendar = this;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+        let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+        let deleteOfflineListener = {</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+                if (aListener) {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+                    aListener.onOperationComplete(calendar, status, opType, aItem.id, aItem);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+                }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+            }</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+        };</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+        let offlineFlagListener = {</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+            onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+            onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+                let offline_flag = detail;</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+                if ((offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+                     offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) &amp;&amp; useCache) {</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+                    /* We do not delete the item from the cache, but mark it deleted */</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+                    storage.deleteOfflineItem(aItem, aListener);</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+                } else {</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+                    thisCalendar.doDeleteItem(aItem, useCache, aListener);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+                }</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+            }</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+        };</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+        storage.getItemOfflineFlag(aItem, offlineFlagListener);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+    },</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    doDeleteItem: function doDeleteItem(aItem, useCache, aListener) {</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aItem.title + &quot;(&quot; + aItem.id + &quot;)&quot;);</span>
<a href="#l3.270"></a><span id="l3.270"> </span>
<a href="#l3.271"></a><span id="l3.271">         try {</span>
<a href="#l3.272"></a><span id="l3.272">             if (this.readOnly) {</span>
<a href="#l3.273"></a><span id="l3.273">                 throw new Components.Exception(&quot;&quot;,</span>
<a href="#l3.274"></a><span id="l3.274">                                                Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l3.275"></a><span id="l3.275">             }</span>
<a href="#l3.276"></a><span id="l3.276"> </span>
<a href="#l3.277"></a><span id="l3.277">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineat">@@ -500,29 +569,24 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.279"></a><span id="l3.279">             // item XML data on delete, and we need to call the observers.</span>
<a href="#l3.280"></a><span id="l3.280">             var request = new calGoogleRequest(this);</span>
<a href="#l3.281"></a><span id="l3.281"> </span>
<a href="#l3.282"></a><span id="l3.282">             request.type = request.DELETE;</span>
<a href="#l3.283"></a><span id="l3.283">             request.uri = getItemEditURI(aItem);</span>
<a href="#l3.284"></a><span id="l3.284">             request.operationListener = aListener;</span>
<a href="#l3.285"></a><span id="l3.285">             request.oldItem = aItem;</span>
<a href="#l3.286"></a><span id="l3.286">             request.calendar = this;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-            var calendar = this;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-            request.responseListener = {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-                onResult: function cGC_deleteItem_response_onResult(aOperation, aData) {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-                    calendar.deleteItem_response(aOperation, aData);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-                }</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-            };</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+            request.useCache = useCache;</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+            request.responseListener = { onResult: this.deleteItem_response.bind(this) };</span>
<a href="#l3.296"></a><span id="l3.296"> </span>
<a href="#l3.297"></a><span id="l3.297">             this.session.asyncItemRequest(request);</span>
<a href="#l3.298"></a><span id="l3.298">             return request;</span>
<a href="#l3.299"></a><span id="l3.299">         } catch (e) {</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-            LOG(&quot;deleteItem failed before request for &quot; +</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-                aItem.title + &quot;(&quot; + aItem.id + &quot;):\n&quot; + e);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] deleteItem failed before request for &quot; +</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+                    aItem.title + &quot;(&quot; + aItem.id + &quot;):\n&quot; + e);</span>
<a href="#l3.304"></a><span id="l3.304"> </span>
<a href="#l3.305"></a><span id="l3.305">             if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l3.306"></a><span id="l3.306">                 // The calendar is readonly, make sure this is set and</span>
<a href="#l3.307"></a><span id="l3.307">                 // notify the user. This can come from above or from</span>
<a href="#l3.308"></a><span id="l3.308">                 // mSession.deleteItem which checks for the editURI</span>
<a href="#l3.309"></a><span id="l3.309">                 this.readOnly = true;</span>
<a href="#l3.310"></a><span id="l3.310">             }</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineat">@@ -532,49 +596,43 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.313"></a><span id="l3.313">                                          null,</span>
<a href="#l3.314"></a><span id="l3.314">                                          e.message);</span>
<a href="#l3.315"></a><span id="l3.315">         }</span>
<a href="#l3.316"></a><span id="l3.316">         return null;</span>
<a href="#l3.317"></a><span id="l3.317">     },</span>
<a href="#l3.318"></a><span id="l3.318"> </span>
<a href="#l3.319"></a><span id="l3.319">     getItem: function cGC_getItem(aId, aListener) {</span>
<a href="#l3.320"></a><span id="l3.320">         // This function needs a test case using mechanisms in bug 365212</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-        LOG(&quot;Getting item with id &quot; + aId);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Getting item with id &quot; + aId);</span>
<a href="#l3.323"></a><span id="l3.323">         try {</span>
<a href="#l3.324"></a><span id="l3.324"> </span>
<a href="#l3.325"></a><span id="l3.325">             // Check if we have a session. If not, then the user has canceled</span>
<a href="#l3.326"></a><span id="l3.326">             // the login prompt.</span>
<a href="#l3.327"></a><span id="l3.327">             this.ensureSession();</span>
<a href="#l3.328"></a><span id="l3.328"> </span>
<a href="#l3.329"></a><span id="l3.329">             // Set up the request</span>
<a href="#l3.330"></a><span id="l3.330"> </span>
<a href="#l3.331"></a><span id="l3.331">             var request = new calGoogleRequest(this);</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333">             request.itemId = aId;</span>
<a href="#l3.334"></a><span id="l3.334">             request.type = request.GET;</span>
<a href="#l3.335"></a><span id="l3.335">             request.uri = this.fullUri.spec;</span>
<a href="#l3.336"></a><span id="l3.336">             request.operationListener = aListener;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+            request.responseListener = { onResult: this.getItem_response.bind(this) };</span>
<a href="#l3.338"></a><span id="l3.338">             request.calendar = this;</span>
<a href="#l3.339"></a><span id="l3.339"> </span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-            var calendar = this;</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-            request.responseListener = {</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-                onResult: function cGC_getItem_response_onResult(aOperation, aData) {</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-                    calendar.getItem_response(aOperation, aData);</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-                }</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-            };</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-</span>
<a href="#l3.347"></a><span id="l3.347">             // Request Parameters</span>
<a href="#l3.348"></a><span id="l3.348">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l3.349"></a><span id="l3.349">             request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l3.350"></a><span id="l3.350">             request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l3.351"></a><span id="l3.351"> </span>
<a href="#l3.352"></a><span id="l3.352">             this.session.asyncItemRequest(request);</span>
<a href="#l3.353"></a><span id="l3.353">             return request;</span>
<a href="#l3.354"></a><span id="l3.354">         } catch (e) {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-            LOG(&quot;getItem failed before request &quot; + aId + &quot;):\n&quot; + e);</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] getItem failed before request &quot; + aId + &quot;):\n&quot; + e);</span>
<a href="#l3.357"></a><span id="l3.357"> </span>
<a href="#l3.358"></a><span id="l3.358">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.359"></a><span id="l3.359">                                          e.result,</span>
<a href="#l3.360"></a><span id="l3.360">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.361"></a><span id="l3.361">                                          null,</span>
<a href="#l3.362"></a><span id="l3.362">                                          e.message);</span>
<a href="#l3.363"></a><span id="l3.363">         }</span>
<a href="#l3.364"></a><span id="l3.364">         return null;</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineat">@@ -632,24 +690,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.366"></a><span id="l3.366"> </span>
<a href="#l3.367"></a><span id="l3.367">             // Request Parameters</span>
<a href="#l3.368"></a><span id="l3.368">             request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l3.369"></a><span id="l3.369">             request.addQueryParameter(&quot;max-results&quot;,</span>
<a href="#l3.370"></a><span id="l3.370">                                       aCount ? aCount : kMANY_EVENTS);</span>
<a href="#l3.371"></a><span id="l3.371">             request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l3.372"></a><span id="l3.372">             request.addQueryParameter(&quot;start-min&quot;, rfcRangeStart);</span>
<a href="#l3.373"></a><span id="l3.373">             request.addQueryParameter(&quot;start-max&quot;, rfcRangeEnd);</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-            var calendar = this;</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-            request.responseListener = {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-                onResult: function cGC_getItems_response_onResult(aOperation, aData) {</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-                    calendar.getItems_response(aOperation, aData);</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-                }</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-            };</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+            request.responseListener = { onResult: this.getItems_response.bind(this) };</span>
<a href="#l3.383"></a><span id="l3.383">             this.session.asyncItemRequest(request);</span>
<a href="#l3.384"></a><span id="l3.384">             return request;</span>
<a href="#l3.385"></a><span id="l3.385">         } catch (e) {</span>
<a href="#l3.386"></a><span id="l3.386">             this.notifyOperationComplete(aListener,</span>
<a href="#l3.387"></a><span id="l3.387">                                          e.result,</span>
<a href="#l3.388"></a><span id="l3.388">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.389"></a><span id="l3.389">                                          null,</span>
<a href="#l3.390"></a><span id="l3.390">                                          e.message);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineat">@@ -669,86 +720,246 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.392"></a><span id="l3.392">      * addItem_response</span>
<a href="#l3.393"></a><span id="l3.393">      * Response function, called by the session object when an item was added</span>
<a href="#l3.394"></a><span id="l3.394">      *</span>
<a href="#l3.395"></a><span id="l3.395">      * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l3.396"></a><span id="l3.396">      * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l3.397"></a><span id="l3.397">      *                     an XML representation of the added item.</span>
<a href="#l3.398"></a><span id="l3.398">      */</span>
<a href="#l3.399"></a><span id="l3.399">     addItem_response: function cGC_addItem_response(aOperation, aData) {</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-        var item = this.general_response(aOperation, aData);</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+        // First, have the general response retrieve the item</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+        let item, e;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+        try {</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+            item = DataToItem(aOperation, aData, this, null);</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+            if (!resolveConflicts(aOperation, item)) {</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+                // If a conflict occurred and the user wants to overwrite, a new</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+                // request will be sent. bail out here, this method will be</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+                // called again</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+                return;</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+            }</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+        } catch (exp) {</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+            item = null;</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+            e = exp;</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+        }</span>
<a href="#l3.415"></a><span id="l3.415"> </span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-        if (item) {</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-            this.mObservers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+        // Now we can do some processing on it. If the cache is used, then we</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+        // ultimately need to add the item to the cache, either as offline item</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+        // or normal item. We will also have to notify the listener and the</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+        // observers sooner or later.</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+        if (aOperation.useCache &amp;&amp; this.mOfflineStorage &amp;&amp; (!e || isCacheException(e))) {</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+            let listener;</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+            if (item) {</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+                // If we have an item, then we can directly notify the target</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+                // listener</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+                listener = aOperation.operationListener;</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.title + &quot; successful&quot;);</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+            } else {</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+                // Otherwise we create an intermediate listener that also sets</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+                // the offline flag</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+                let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+                let self = this;</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+                item = aOperation.newItem;</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+                listener = {</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+                        if (Components.isSuccessCode(status)) {</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+                            // On success, the addOfflineItem call will notify the listener</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+                            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.title + &quot; failed, but the operation will be retried (status: &quot; + status + &quot;, exception: &quot; + e + &quot;)&quot;);</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+                            storage.addOfflineItem(detail, aOperation.operationListener);</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+                            self.mObservers.notify(&quot;onAddItem&quot;, [aOperation.newItem]);</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+                        } else if (aOperation.operationListener) {</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+                            cal.ERROR(&quot;[calGoogleCalendar] Could not add item &quot; + aOperation.newItem.title + &quot; to the offline cache:&quot; +</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+                                      new Components.Exception(detail, status));</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+                            // Otherwise we have to do it ourselves.</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+                            self.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+                                                         status,</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+                                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+                                                         null,</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+                                                         null);</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+                        }</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+                    }</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+                };</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+            }</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+            // Now send the item to the offline storage</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+            this.mOfflineStorage.adoptItem(item, listener);</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+        } else {</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+            // When not using the cache, we merely have to notify onAddItem and</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+            // tell the operation listener we are done (error or not)</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+            if (item) {</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + item.title + &quot; successful&quot;);</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+                this.mObservers.notify(&quot;onAddItem&quot;, [item]);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+            } else {</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aOperation.newItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+            }</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+                                         (item ? Components.results.NS_OK : e.result),</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+                                         (item ? item.id : null),</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+                                         (item ? item : e.message));</span>
<a href="#l3.473"></a><span id="l3.473">         }</span>
<a href="#l3.474"></a><span id="l3.474">     },</span>
<a href="#l3.475"></a><span id="l3.475"> </span>
<a href="#l3.476"></a><span id="l3.476">     /**</span>
<a href="#l3.477"></a><span id="l3.477">      * modifyItem_response</span>
<a href="#l3.478"></a><span id="l3.478">      * Response function, called by the session object when an item was modified</span>
<a href="#l3.479"></a><span id="l3.479">      *</span>
<a href="#l3.480"></a><span id="l3.480">      * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l3.481"></a><span id="l3.481">      * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l3.482"></a><span id="l3.482">      *                     an XML representation of the added item.</span>
<a href="#l3.483"></a><span id="l3.483">      */</span>
<a href="#l3.484"></a><span id="l3.484">     modifyItem_response: function cGC_modifyItem_response_onResult(aOperation,</span>
<a href="#l3.485"></a><span id="l3.485">                                                                    aData) {</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-        var item = this.general_response(aOperation,</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-                                         aData,</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-                                         aOperation.newItem);</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-        // Notify Observers</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-        if (item) {</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-            var oldItem = aOperation.oldItem;</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-            if (item.parentItem != item) {</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+        let self = this;</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+        function notifyObserver(item, oldItem) {</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+            if (item &amp;&amp; item.parentItem != item) {</span>
<a href="#l3.496"></a><span id="l3.496">                 item.parentItem.recurrenceInfo.modifyException(item, false);</span>
<a href="#l3.497"></a><span id="l3.497">                 item = item.parentItem;</span>
<a href="#l3.498"></a><span id="l3.498">                 oldItem = oldItem.parentItem;</span>
<a href="#l3.499"></a><span id="l3.499">             }</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-            this.mObservers.notify(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+            // Notify Observers</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+            if (item) {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+                self.mObservers.notify(&quot;onModifyItem&quot;, [item, oldItem]);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+            }</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+        }</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+        // First, convert the data to an item and make sure no conflicts occurred.</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+        let newItem, e;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+        try {</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+            newItem = DataToItem(aOperation, aData, this, aOperation.newItem);</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+            if (!resolveConflicts(aOperation, newItem)) {</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+                // If a conflict occurred and the user wants to overwrite, a new</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+                // request will be sent. bail out here, this method will be</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+                // called again</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+                return;</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+            }</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+        } catch (exp) {</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+            newItem = null;</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+            e = exp;</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+        }</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+        // Now we can do some processing on it. If the cache is used, then we</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+        // ultimately need to modify the item in the cache, either as offline item</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+        // or normal item. We will also have to notify the listener and the</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+        // observers sooner or later.</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+        if (aOperation.useCache &amp;&amp; this.mOfflineStorage &amp;&amp; (!e || isCacheException(e))) {</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+            let listener;</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+            if (newItem) {</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+                // If we have an item, then we can directly notify the target</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+                // listener</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+                listener = aOperation.operationListener;</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+            } else {</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+                let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+                newItem = aOperation.newItem;</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+                listener = {</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+                        if (Components.isSuccessCode(status)) {</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+                            cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; failed, but the operation will be retried (status: &quot; + status + &quot;, exception: &quot; + e + &quot;)&quot;);</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+                            // On success, the modifyOfflineItem call will notify the listener</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+                            storage.modifyOfflineItem(detail, aOperation.operationListener);</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+                            notifyObserver(newItem, aOperation.oldItem);</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+                        } else if (aOperation.operationListener) {</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+                            cal.ERROR(&quot;[calGoogleCalendar] Could not modify item &quot; + aOperation.newItem.id + &quot; in the offline cache:&quot; +</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+                                      new Components.Exception(detail, status));</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+                            // Otherwise we have to do it ourselves.</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+                            self.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+                                                         status,</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+                                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+                                                         null,</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+                                                         null);</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+                        }</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+                    }</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+                };</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+            }</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+            // Now send the item to the offline storage</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+            this.mOfflineStorage.modifyItem(newItem, aOperation.oldItem, listener);</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+        } else {</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+            // When not using the cache, we merely have to notify onModifyItem and</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+            // tell the operation listener we are done (error or not)</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+            notifyObserver(newItem, aOperation.oldItem);</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+            if (newItem) {</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + newItem.id + &quot; successful&quot;);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+            } else {</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Modifying item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+            }</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+                                         (newItem ? Components.results.NS_OK : e.result || Components.results.NS_ERROR_FAILURE),</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+                                         Components.interfaces.calIOperationListener.MODIFY,</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+                                         (newItem ? newItem.id : null),</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+                                         (newItem ? newItem : e.message));</span>
<a href="#l3.574"></a><span id="l3.574">         }</span>
<a href="#l3.575"></a><span id="l3.575">     },</span>
<a href="#l3.576"></a><span id="l3.576"> </span>
<a href="#l3.577"></a><span id="l3.577">     /**</span>
<a href="#l3.578"></a><span id="l3.578">      * deleteItem_response</span>
<a href="#l3.579"></a><span id="l3.579">      * Response function, called by the session object when an Item was deleted</span>
<a href="#l3.580"></a><span id="l3.580">      *</span>
<a href="#l3.581"></a><span id="l3.581">      * @param aOperation The calIGoogleRequest processing the request</span>
<a href="#l3.582"></a><span id="l3.582">      * @param aData      In case of an error, this is the error string, otherwise</span>
<a href="#l3.583"></a><span id="l3.583">      *                     an XML representation of the added item.</span>
<a href="#l3.584"></a><span id="l3.584">      */</span>
<a href="#l3.585"></a><span id="l3.585">     deleteItem_response: function cGC_deleteItem_response_onResult(aOperation,</span>
<a href="#l3.586"></a><span id="l3.586">                                                                    aData) {</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        // The reason we are not using general_response here is because deleted</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-        // items are not returned as xml from google. We need to pass the item</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-        // we saved with the request.</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+        let item, e;</span>
<a href="#l3.592"></a><span id="l3.592">         try {</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-            // Check if the call succeeded</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-            if (aOperation.status != Components.results.NS_OK) {</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-                throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+            item = DataToItem(aOperation, aData, this, aOperation.oldItem);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+            if (!resolveConflicts(aOperation, item)) {</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+                // If a conflict occurred and the user wants to overwrite, a new</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+                // request will be sent. bail out here, this method will be</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+                // called again</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+                return;</span>
<a href="#l3.602"></a><span id="l3.602">             }</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+        } catch (exp) {</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+            item = null;</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+            e = exp;</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+        }</span>
<a href="#l3.607"></a><span id="l3.607"> </span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-            // All operations need to call onOperationComplete</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-            LOG(&quot;Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+        if (aOperation.useCache &amp;&amp; this.mOfflineStorage &amp;&amp; (!e || isCacheException(e))) {</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+            if (item) {</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+                // If we have an item, then we can directly notify the target</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+                // listener using the offline storage</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+                this.mOfflineStorage.deleteItem(item, aOperation.operationListener);</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+            } else {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+                // Otherwise we shouldn't remove it from the cache, but set the</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+                // offline flag to mark it deleted</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+                let self = this;</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+                let offlineListener = {</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+                    // We should not return a success code since the listeners can delete the physical item in case of success</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+                    onGetResult: function(calendar, status, itemType, detail, count, items) {},</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+                    onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+                        self.mObservers.notify(&quot;onDeleteItem&quot;, [aOperation.oldItem]);</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+                        cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; failed, but the operation will be retried&quot;);</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+                        self.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+                                                     Components.results.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+                                                     Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+                                                     aOperation.oldItem.id,</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+                                                     aOperation.oldItem);</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+                    }</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+                };</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+                let storage = this.mOfflineStorage.QueryInterface(Components.interfaces.calIOfflineStorage);</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+                storage.deleteOfflineItem(aOperation.oldItem, offlineListener);</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+            }</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+        } else {</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+            // When not using the cache, we merely have to notify onDeleteItem and</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+            // tell the operation listener we are done (error or not)</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+            if (item) {</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; successful&quot;);</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+                this.mObservers.notify(&quot;onDeleteItem&quot;, [item]);</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+            } else {</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Deleting item &quot; + aOperation.oldItem.id + &quot; failed, status &quot; + aOperation.status + &quot;, Exception: &quot; + e);</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+            }</span>
<a href="#l3.645"></a><span id="l3.645">             this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-                                         aOperation.oldItem.id,</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-                                         aOperation.oldItem);</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-            // Notify Observers</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-            this.mObservers.notify(&quot;onDeleteItem&quot;, [aOperation.oldItem]);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-        } catch (e) {</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-            LOG(&quot;Deleting item &quot; + aOperation.oldItem.id + &quot; failed&quot;);</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-            // Operation failed</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-                                         e.result,</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-                                         Components.interfaces.calIOperationListener.DELETE,</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-                                         null,</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-                                         e.message);</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+                                         (item ? Components.results.NS_OK : e.result || Components.results.NS_ERROR_FAILURE),</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+                                         Components.interfaces.calIOperationListener.ADD,</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+                                         (item ? item.id : null),</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+                                         (item ? item : e.message));</span>
<a href="#l3.665"></a><span id="l3.665">         }</span>
<a href="#l3.666"></a><span id="l3.666">     },</span>
<a href="#l3.667"></a><span id="l3.667"> </span>
<a href="#l3.668"></a><span id="l3.668">     /**</span>
<a href="#l3.669"></a><span id="l3.669">      * getItem_response</span>
<a href="#l3.670"></a><span id="l3.670">      * Response function, called by the session object when a single Item was</span>
<a href="#l3.671"></a><span id="l3.671">      * downloaded.</span>
<a href="#l3.672"></a><span id="l3.672">      *</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineat">@@ -787,16 +998,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.674"></a><span id="l3.674"> </span>
<a href="#l3.675"></a><span id="l3.675">             // Get the item entry by id.</span>
<a href="#l3.676"></a><span id="l3.676">             var itemEntry = xml.entry.(id.substring(id.lastIndexOf('/') + 1) == aOperation.itemId ||</span>
<a href="#l3.677"></a><span id="l3.677">                                        gCal::uid.@value == aOperation.itemId);</span>
<a href="#l3.678"></a><span id="l3.678">             if (!itemEntry || !itemEntry.length()) {</span>
<a href="#l3.679"></a><span id="l3.679">                 // Item wasn't found. Skip onGetResult and just complete. Not</span>
<a href="#l3.680"></a><span id="l3.680">                 // finding an item isn't a user-important error, it may be a</span>
<a href="#l3.681"></a><span id="l3.681">                 // wanted case. (i.e itip)</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Item &quot; + aOperation.itemId + &quot; not found in calendar &quot; + this.name);</span>
<a href="#l3.683"></a><span id="l3.683">                 throw new Components.Exception(&quot;Item not found&quot;, Components.results.NS_OK);</span>
<a href="#l3.684"></a><span id="l3.684">             }</span>
<a href="#l3.685"></a><span id="l3.685">             var item = XMLEntryToItem(itemEntry, timezone, this);</span>
<a href="#l3.686"></a><span id="l3.686">             item.calendar = this.superCalendar;</span>
<a href="#l3.687"></a><span id="l3.687"> </span>
<a href="#l3.688"></a><span id="l3.688">             if (item.recurrenceInfo) {</span>
<a href="#l3.689"></a><span id="l3.689">                 // If this item is recurring, get all exceptions for this item.</span>
<a href="#l3.690"></a><span id="l3.690">                 for each (var entry in xml.entry.gd::originalEvent.(@id == aOperation.itemId)) {</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineat">@@ -809,30 +1021,31 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.692"></a><span id="l3.692">                     } else {</span>
<a href="#l3.693"></a><span id="l3.693">                         excItem.calendar = this;</span>
<a href="#l3.694"></a><span id="l3.694">                         item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l3.695"></a><span id="l3.695">                     }</span>
<a href="#l3.696"></a><span id="l3.696">                 }</span>
<a href="#l3.697"></a><span id="l3.697">             }</span>
<a href="#l3.698"></a><span id="l3.698">             // We are done, notify the listener of our result and that we are</span>
<a href="#l3.699"></a><span id="l3.699">             // done.</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Item &quot; + aOperation.itemId + &quot; was found in calendar &quot; + this.name);</span>
<a href="#l3.701"></a><span id="l3.701">             aOperation.operationListener.onGetResult(this.superCalendar,</span>
<a href="#l3.702"></a><span id="l3.702">                                                      Components.results.NS_OK,</span>
<a href="#l3.703"></a><span id="l3.703">                                                      Components.interfaces.calIEvent,</span>
<a href="#l3.704"></a><span id="l3.704">                                                      null,</span>
<a href="#l3.705"></a><span id="l3.705">                                                      1,</span>
<a href="#l3.706"></a><span id="l3.706">                                                      [item]);</span>
<a href="#l3.707"></a><span id="l3.707">             this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.708"></a><span id="l3.708">                                          Components.results.NS_OK,</span>
<a href="#l3.709"></a><span id="l3.709">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.710"></a><span id="l3.710">                                          item.id,</span>
<a href="#l3.711"></a><span id="l3.711">                                          null);</span>
<a href="#l3.712"></a><span id="l3.712">         } catch (e) {</span>
<a href="#l3.713"></a><span id="l3.713">             if (!Components.isSuccessCode(e.result)) {</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-                LOG(&quot;Error getting item &quot; + aOperation.itemId + &quot;:\n&quot; + e);</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Error getting item &quot; + aOperation.itemId + &quot;:\n&quot; + e);</span>
<a href="#l3.716"></a><span id="l3.716">                 Components.utils.reportError(e);</span>
<a href="#l3.717"></a><span id="l3.717">             }</span>
<a href="#l3.718"></a><span id="l3.718">             this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.719"></a><span id="l3.719">                                          e.result,</span>
<a href="#l3.720"></a><span id="l3.720">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.721"></a><span id="l3.721">                                          null,</span>
<a href="#l3.722"></a><span id="l3.722">                                          e.message);</span>
<a href="#l3.723"></a><span id="l3.723">         }</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineat">@@ -848,17 +1061,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.725"></a><span id="l3.725">      *                     an XML representation of the added item.</span>
<a href="#l3.726"></a><span id="l3.726">      */</span>
<a href="#l3.727"></a><span id="l3.727">     getItems_response: function cGC_getItems_response(aOperation, aData) {</span>
<a href="#l3.728"></a><span id="l3.728">         // To simplify code, provide a one-stop function to call, independant of</span>
<a href="#l3.729"></a><span id="l3.729">         // if and what type of listener was passed.</span>
<a href="#l3.730"></a><span id="l3.730">         var listener = aOperation.operationListener ||</span>
<a href="#l3.731"></a><span id="l3.731">             { onGetResult: function() {}, onOperationComplete: function() {} };</span>
<a href="#l3.732"></a><span id="l3.732"> </span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-        LOG(&quot;Recieved response for &quot; + aOperation.uri);</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Recieved response for &quot; + aOperation.uri);</span>
<a href="#l3.735"></a><span id="l3.735">         try {</span>
<a href="#l3.736"></a><span id="l3.736">             // Check if the call succeeded</span>
<a href="#l3.737"></a><span id="l3.737">             if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l3.738"></a><span id="l3.738">                 throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l3.739"></a><span id="l3.739">             }</span>
<a href="#l3.740"></a><span id="l3.740"> </span>
<a href="#l3.741"></a><span id="l3.741">             // Prepare Namespaces</span>
<a href="#l3.742"></a><span id="l3.742">             var gCal = new Namespace(&quot;gCal&quot;,</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineat">@@ -866,17 +1079,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.744"></a><span id="l3.744">             var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l3.745"></a><span id="l3.745">             var atom = new Namespace(&quot;&quot;, &quot;http://www.w3.org/2005/Atom&quot;);</span>
<a href="#l3.746"></a><span id="l3.746">             default xml namespace = atom;</span>
<a href="#l3.747"></a><span id="l3.747"> </span>
<a href="#l3.748"></a><span id="l3.748">             // A feed was passed back, parse it.</span>
<a href="#l3.749"></a><span id="l3.749">             var xml = cal.safeNewXML(aData);</span>
<a href="#l3.750"></a><span id="l3.750">             var timezoneString = xml.gCal::timezone.@value.toString() || &quot;UTC&quot;;</span>
<a href="#l3.751"></a><span id="l3.751">             var timezone = gdataTimezoneService.getTimezone(timezoneString);</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-            </span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+</span>
<a href="#l3.754"></a><span id="l3.754">             // This line is needed, otherwise the for each () block will never</span>
<a href="#l3.755"></a><span id="l3.755">             // be entered. It may seem strange, but if you don't believe me, try</span>
<a href="#l3.756"></a><span id="l3.756">             // it!</span>
<a href="#l3.757"></a><span id="l3.757">             xml.link.(@rel);</span>
<a href="#l3.758"></a><span id="l3.758"> </span>
<a href="#l3.759"></a><span id="l3.759">             // We might be able to get the full name through this feed's author</span>
<a href="#l3.760"></a><span id="l3.760">             // tags. We need to make sure we have a session for that.</span>
<a href="#l3.761"></a><span id="l3.761">             this.ensureSession();</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineat">@@ -911,31 +1124,31 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.763"></a><span id="l3.763">                     var att = item.getAttendeeById(&quot;mailto:&quot; + this.session.userName);</span>
<a href="#l3.764"></a><span id="l3.764">                     if (!this.isInvitation(item) ||</span>
<a href="#l3.765"></a><span id="l3.765">                         !att ||</span>
<a href="#l3.766"></a><span id="l3.766">                         att.participationStatus != &quot;NEEDS-ACTION&quot;) {</span>
<a href="#l3.767"></a><span id="l3.767">                         continue;</span>
<a href="#l3.768"></a><span id="l3.768">                     }</span>
<a href="#l3.769"></a><span id="l3.769">                 }</span>
<a href="#l3.770"></a><span id="l3.770"> </span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-                LOG(&quot;Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l3.773"></a><span id="l3.773"> </span>
<a href="#l3.774"></a><span id="l3.774">                 if (item.recurrenceInfo) {</span>
<a href="#l3.775"></a><span id="l3.775">                     // If we are doing an uncached operation, then we need to</span>
<a href="#l3.776"></a><span id="l3.776">                     // gather all exceptions and put them into the item.</span>
<a href="#l3.777"></a><span id="l3.777">                     // Otherwise, our listener will take care of mapping the</span>
<a href="#l3.778"></a><span id="l3.778">                     // exception to the base item.</span>
<a href="#l3.779"></a><span id="l3.779">                     for each (var oid in xml.entry.gd::originalEvent.(@id == item.id)) {</span>
<a href="#l3.780"></a><span id="l3.780">                         // Get specific fields so we can speed up the parsing process</span>
<a href="#l3.781"></a><span id="l3.781">                         var status = oid.parent().gd::eventStatus.@value.toString().substring(39);</span>
<a href="#l3.782"></a><span id="l3.782"> </span>
<a href="#l3.783"></a><span id="l3.783">                         if (status == &quot;canceled&quot;) {</span>
<a href="#l3.784"></a><span id="l3.784">                             let rId = oid.gd::when.@startTime.toString();</span>
<a href="#l3.785"></a><span id="l3.785">                             let rDate = cal.fromRFC3339(rId, timezone);</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-                            LOG(&quot;Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+                            cal.LOG(&quot;[calGoogleCalendar] Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l3.788"></a><span id="l3.788">                             item.recurrenceInfo.removeOccurrenceAt(rDate);</span>
<a href="#l3.789"></a><span id="l3.789">                         } else {</span>
<a href="#l3.790"></a><span id="l3.790">                             // Parse the exception and modify the current item</span>
<a href="#l3.791"></a><span id="l3.791">                             var excItem = XMLEntryToItem(oid.parent(),</span>
<a href="#l3.792"></a><span id="l3.792">                                                          timezone,</span>
<a href="#l3.793"></a><span id="l3.793">                                                          this);</span>
<a href="#l3.794"></a><span id="l3.794">                             if (excItem) {</span>
<a href="#l3.795"></a><span id="l3.795">                                 // Google uses the status field to reflect negative</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineat">@@ -962,112 +1175,42 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.797"></a><span id="l3.797">             }</span>
<a href="#l3.798"></a><span id="l3.798">             // Operation Completed successfully.</span>
<a href="#l3.799"></a><span id="l3.799">             this.notifyOperationComplete(listener,</span>
<a href="#l3.800"></a><span id="l3.800">                                          Components.results.NS_OK,</span>
<a href="#l3.801"></a><span id="l3.801">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.802"></a><span id="l3.802">                                          null,</span>
<a href="#l3.803"></a><span id="l3.803">                                          null);</span>
<a href="#l3.804"></a><span id="l3.804">         } catch (e) {</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-            LOG(&quot;Error getting items:\n&quot; + e);</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Error getting items:\n&quot; + e);</span>
<a href="#l3.807"></a><span id="l3.807">             this.notifyOperationComplete(listener,</span>
<a href="#l3.808"></a><span id="l3.808">                                          e.result,</span>
<a href="#l3.809"></a><span id="l3.809">                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l3.810"></a><span id="l3.810">                                          null,</span>
<a href="#l3.811"></a><span id="l3.811">                                          e.message);</span>
<a href="#l3.812"></a><span id="l3.812">         }</span>
<a href="#l3.813"></a><span id="l3.813">     },</span>
<a href="#l3.814"></a><span id="l3.814"> </span>
<a href="#l3.815"></a><span id="l3.815">     /**</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-     * general_response</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-     * Handles common actions for multiple response types. This does not notify</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-     * observers.</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-     *</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-     * @param aOperation        The calIGoogleRequest that initiated the request.</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-     * @param aData             The string represenation of the item</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-     * @param aReferenceItem    The item to apply the information from the xml</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-     *                            to. If null, a new item will be used.</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-     * @return                  The Item as a calIEvent, or null if an error</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-     *                            happened</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+     * Implement calIChangeLog</span>
<a href="#l3.827"></a><span id="l3.827">      */</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-    general_response: function cGC_general_response(aOperation,</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-                                                    aData,</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-                                                    aReferenceItem) {</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-        try {</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-            // Check if the call succeeded, if not then aData is an error</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-            // message</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-            if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-                throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-            }</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-            // An Item was passed back, parse it.</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-            var xml = cal.safeNewXML(aData);</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-            // Get the local timezone from the preferences</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-            var timezone = calendarDefaultTimezone();</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-            // Parse the Item with the given timezone</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-            var item = XMLEntryToItem(xml,</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-                                      timezone,</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-                                      this,</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-                                      aReferenceItem);</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-            LOGitem(item);</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-            item.calendar = this.superCalendar;</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-            // GET operations need to call onGetResult</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-            if (aOperation.type == aOperation.GET) {</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-                aOperation.operationListener</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-                          .onGetResult(this.superCalendar,</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-                                       Components.results.NS_OK,</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-                                       Components.interfaces.calIEvent,</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-                                       null,</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-                                       1,</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-                                       [item]);</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-            }</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-            // All operations need to call onOperationComplete</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-            // calIGoogleRequest's type corresponds to calIOperationListener's</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-            // constants, so we can use them here.</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-                                         Components.results.NS_OK,</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-                                         aOperation.type,</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-                                         (item ? item.id : null),</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-                                         item);</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-            return item;</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-        } catch (e) {</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-            LOG(&quot;General response failed: &quot; + e);</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-            if (e.result == Components.interfaces.calIErrors.CAL_IS_READONLY) {</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-                // The calendar is readonly, make sure this is set and</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-                // notify the user.</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-                this.readOnly = true;</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-            }</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-            // Operation failed</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-            this.notifyOperationComplete(aOperation.operationListener,</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-                                         e.result,</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-                                         aOperation.type,</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-                                         null,</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-                                         e.message);</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-        }</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-        return null;</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+    get offlineStorage() {</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+        return this.mOfflineStorage;</span>
<a href="#l3.894"></a><span id="l3.894">     },</span>
<a href="#l3.895"></a><span id="l3.895"> </span>
<a href="#l3.896"></a><span id="l3.896" class="difflineminus">-    /**</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineminus">-     * Implement calIChangeLog</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineminus">-     */</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+    set offlineStorage(val) {</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+        return (this.mOfflineStorage = val);</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+    },</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+</span>
<a href="#l3.903"></a><span id="l3.903">     resetLog: function cGC_resetLog() {</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-        LOG(&quot;Resetting last updated counter for &quot; + this.name);</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Resetting last updated counter for &quot; + this.name);</span>
<a href="#l3.906"></a><span id="l3.906">         this.deleteProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l3.907"></a><span id="l3.907">     },</span>
<a href="#l3.908"></a><span id="l3.908"> </span>
<a href="#l3.909"></a><span id="l3.909" class="difflineminus">-    replayChangesOn: function cGC_replayChangesOn(aDestination, aListener) {</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+    replayChangesOn: function cGC_replayChangesOn(aListener) {</span>
<a href="#l3.911"></a><span id="l3.911">         var lastUpdate = this.getProperty(&quot;google.lastUpdated&quot;);</span>
<a href="#l3.912"></a><span id="l3.912">         var lastUpdateDateTime;</span>
<a href="#l3.913"></a><span id="l3.913">         if (lastUpdate) {</span>
<a href="#l3.914"></a><span id="l3.914">             // Set up the last sync stamp</span>
<a href="#l3.915"></a><span id="l3.915">             lastUpdateDateTime = createDateTime();</span>
<a href="#l3.916"></a><span id="l3.916">             lastUpdateDateTime.icalString = lastUpdate;</span>
<a href="#l3.917"></a><span id="l3.917"> </span>
<a href="#l3.918"></a><span id="l3.918">             // Set up last week</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineat">@@ -1075,33 +1218,27 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.920"></a><span id="l3.920">             lastWeek.day -= 7;</span>
<a href="#l3.921"></a><span id="l3.921">             if (lastWeek.compare(lastUpdateDateTime) &gt;= 0) {</span>
<a href="#l3.922"></a><span id="l3.922">                 // The last sync was longer than a week ago. Google requires a full</span>
<a href="#l3.923"></a><span id="l3.923">                 // sync in that case. This call also takes care of calling</span>
<a href="#l3.924"></a><span id="l3.924">                 // resetLog().</span>
<a href="#l3.925"></a><span id="l3.925">                 this.superCalendar.wrappedJSObject.setupCachedCalendar();</span>
<a href="#l3.926"></a><span id="l3.926">                 lastUpdateDateTime = null;</span>
<a href="#l3.927"></a><span id="l3.927">             }</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">-            LOG(&quot;The calendar &quot; + this.name + &quot; was last modified: &quot; + lastUpdateDateTime);</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">-</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] The calendar &quot; + this.name + &quot; was last modified: &quot; + lastUpdateDateTime);</span>
<a href="#l3.931"></a><span id="l3.931">         }</span>
<a href="#l3.932"></a><span id="l3.932"> </span>
<a href="#l3.933"></a><span id="l3.933">         var request = new calGoogleRequest(this.mSession);</span>
<a href="#l3.934"></a><span id="l3.934"> </span>
<a href="#l3.935"></a><span id="l3.935">         request.type = request.GET;</span>
<a href="#l3.936"></a><span id="l3.936">         request.uri = this.fullUri.spec</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-        request.destinationCal = aDestination;</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+        request.destinationCal = this.mOfflineStorage;</span>
<a href="#l3.939"></a><span id="l3.939"> </span>
<a href="#l3.940"></a><span id="l3.940">         var calendar = this;</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineminus">-        request.responseListener = {</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-            onResult: function cGC_syncItems_response_onResult(aOperation, aData) {</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-                calendar.syncItems_response(aOperation, aData, (lastUpdateDateTime == null));</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-            }</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-        };</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+        request.responseListener = { onResult: this.syncItems_response.bind(this, (lastUpdateDateTime == null)) }</span>
<a href="#l3.948"></a><span id="l3.948">         request.operationListener = aListener;</span>
<a href="#l3.949"></a><span id="l3.949">         request.calendar = this;</span>
<a href="#l3.950"></a><span id="l3.950"> </span>
<a href="#l3.951"></a><span id="l3.951">         // Request Parameters</span>
<a href="#l3.952"></a><span id="l3.952">         request.addQueryParameter(&quot;ctz&quot;, calendarDefaultTimezone().tzid);</span>
<a href="#l3.953"></a><span id="l3.953">         request.addQueryParameter(&quot;max-results&quot;, kMANY_EVENTS);</span>
<a href="#l3.954"></a><span id="l3.954">         request.addQueryParameter(&quot;singleevents&quot;, &quot;false&quot;);</span>
<a href="#l3.955"></a><span id="l3.955"> </span>
<a href="#l3.956"></a><span id="l3.956" class="difflineat">@@ -1115,23 +1252,23 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.957"></a><span id="l3.957">         this.mSession.asyncItemRequest(request);</span>
<a href="#l3.958"></a><span id="l3.958">     },</span>
<a href="#l3.959"></a><span id="l3.959"> </span>
<a href="#l3.960"></a><span id="l3.960">     /**</span>
<a href="#l3.961"></a><span id="l3.961">      * syncItems_response</span>
<a href="#l3.962"></a><span id="l3.962">      * Response function, called by the session object when an Item feed was</span>
<a href="#l3.963"></a><span id="l3.963">      * downloaded.</span>
<a href="#l3.964"></a><span id="l3.964">      *</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+     * @param aIsFullSync   If set, this is a full sync rather than an update.</span>
<a href="#l3.966"></a><span id="l3.966">      * @param aOperation    The calIGoogleRequest processing the request</span>
<a href="#l3.967"></a><span id="l3.967">      * @param aData         In case of an error, this is the error string, otherwise</span>
<a href="#l3.968"></a><span id="l3.968">      *                        an XML representation of the added item.</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-     * @param aIsFullSync   If set, this is a full sync rather than an update.</span>
<a href="#l3.970"></a><span id="l3.970">      */</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-    syncItems_response: function cGC_syncItems_response(aOperation, aData, isFullSync) {</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-        LOG(&quot;Recieved response for &quot; + aOperation.uri + (isFullSync ? &quot; (full sync)&quot; : &quot;&quot;));</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+    syncItems_response: function cGC_syncItems_response(aIsFullSync, aOperation, aData) {</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Recieved response for &quot; + aOperation.uri + (aIsFullSync ? &quot; (full sync)&quot; : &quot;&quot;));</span>
<a href="#l3.975"></a><span id="l3.975">         try {</span>
<a href="#l3.976"></a><span id="l3.976">             // Check if the call succeeded</span>
<a href="#l3.977"></a><span id="l3.977">             if (!Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l3.978"></a><span id="l3.978">                 throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l3.979"></a><span id="l3.979">             }</span>
<a href="#l3.980"></a><span id="l3.980"> </span>
<a href="#l3.981"></a><span id="l3.981">             // Prepare Namespaces</span>
<a href="#l3.982"></a><span id="l3.982">             var gCal = new Namespace(&quot;gCal&quot;,</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineat">@@ -1161,50 +1298,50 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.984"></a><span id="l3.984">             }</span>
<a href="#l3.985"></a><span id="l3.985"> </span>
<a href="#l3.986"></a><span id="l3.986">             // This is the calendar we should sync changes into.</span>
<a href="#l3.987"></a><span id="l3.987">             var destinationCal = aOperation.destinationCal;</span>
<a href="#l3.988"></a><span id="l3.988"> </span>
<a href="#l3.989"></a><span id="l3.989">             for each (var entry in xml.entry) {</span>
<a href="#l3.990"></a><span id="l3.990"> </span>
<a href="#l3.991"></a><span id="l3.991">                 var recurrenceId = getRecurrenceIdFromEntry(entry, timezone);</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-                if (isFullSync &amp;&amp; recurrenceId) {</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+                if (aIsFullSync &amp;&amp; recurrenceId) {</span>
<a href="#l3.994"></a><span id="l3.994">                     // On a full sync, we parse exceptions different.</span>
<a href="#l3.995"></a><span id="l3.995">                     continue;</span>
<a href="#l3.996"></a><span id="l3.996">                 }</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-                LOG(&quot;Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + entry + &quot;\n&quot;);</span>
<a href="#l3.999"></a><span id="l3.999"> </span>
<a href="#l3.1000"></a><span id="l3.1000">                 var referenceItemObj = {}</span>
<a href="#l3.1001"></a><span id="l3.1001">                 destinationCal.getItem(getIdFromEntry(entry),</span>
<a href="#l3.1002"></a><span id="l3.1002">                                        new syncSetter(referenceItemObj));</span>
<a href="#l3.1003"></a><span id="l3.1003">                 var referenceItem = referenceItemObj.value &amp;&amp;</span>
<a href="#l3.1004"></a><span id="l3.1004">                                     referenceItemObj.value.clone();</span>
<a href="#l3.1005"></a><span id="l3.1005"> </span>
<a href="#l3.1006"></a><span id="l3.1006">                 // Parse the item. If we got a reference item from the storage</span>
<a href="#l3.1007"></a><span id="l3.1007">                 // calendar, put that in to make sure we get all exceptions and</span>
<a href="#l3.1008"></a><span id="l3.1008">                 // such.</span>
<a href="#l3.1009"></a><span id="l3.1009">                 var item = XMLEntryToItem(entry,</span>
<a href="#l3.1010"></a><span id="l3.1010">                                           timezone,</span>
<a href="#l3.1011"></a><span id="l3.1011">                                           this,</span>
<a href="#l3.1012"></a><span id="l3.1012">                                           (recurrenceId &amp;&amp; referenceItem ? null : referenceItem));</span>
<a href="#l3.1013"></a><span id="l3.1013">                 item.calendar = this.superCalendar;</span>
<a href="#l3.1014"></a><span id="l3.1014"> </span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-                if (isFullSync &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineplus">+                if (aIsFullSync &amp;&amp; item.recurrenceInfo) {</span>
<a href="#l3.1017"></a><span id="l3.1017">                     // On a full synchronization, we can go ahead and pre-parse</span>
<a href="#l3.1018"></a><span id="l3.1018">                     // all exceptions and then add the item at once. This way we</span>
<a href="#l3.1019"></a><span id="l3.1019">                     // make sure</span>
<a href="#l3.1020"></a><span id="l3.1020">                     for each (var oid in xml.entry.gd::originalEvent.(@id == item.id)) {</span>
<a href="#l3.1021"></a><span id="l3.1021">                         // Get specific fields so we can speed up the parsing process</span>
<a href="#l3.1022"></a><span id="l3.1022">                         var status = oid.parent().gd::eventStatus.@value.toString().substring(39);</span>
<a href="#l3.1023"></a><span id="l3.1023"> </span>
<a href="#l3.1024"></a><span id="l3.1024">                         if (status == &quot;canceled&quot;) {</span>
<a href="#l3.1025"></a><span id="l3.1025">                             let rId = oid.gd::when.@startTime.toString();</span>
<a href="#l3.1026"></a><span id="l3.1026">                             let rDate = cal.fromRFC3339(rId, timezone);</span>
<a href="#l3.1027"></a><span id="l3.1027">                             item.recurrenceInfo.removeOccurrenceAt(rDate);</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-                            LOG(&quot;Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+                            cal.LOG(&quot;[calGoogleCalendar] Negative exception &quot; + rId + &quot;/&quot; + rDate);</span>
<a href="#l3.1030"></a><span id="l3.1030">                         } else {</span>
<a href="#l3.1031"></a><span id="l3.1031">                             // Parse the exception and modify the current item</span>
<a href="#l3.1032"></a><span id="l3.1032">                             var excItem = XMLEntryToItem(oid.parent(),</span>
<a href="#l3.1033"></a><span id="l3.1033">                                                          timezone,</span>
<a href="#l3.1034"></a><span id="l3.1034">                                                          this);</span>
<a href="#l3.1035"></a><span id="l3.1035">                             if (excItem) {</span>
<a href="#l3.1036"></a><span id="l3.1036">                                 // Google uses the status field to reflect negative</span>
<a href="#l3.1037"></a><span id="l3.1037">                                 // exceptions.</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineat">@@ -1212,17 +1349,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.1039"></a><span id="l3.1039">                                 item.recurrenceInfo.modifyException(excItem, true);</span>
<a href="#l3.1040"></a><span id="l3.1040">                             }</span>
<a href="#l3.1041"></a><span id="l3.1041">                         }</span>
<a href="#l3.1042"></a><span id="l3.1042">                     }</span>
<a href="#l3.1043"></a><span id="l3.1043">                 }</span>
<a href="#l3.1044"></a><span id="l3.1044"> </span>
<a href="#l3.1045"></a><span id="l3.1045">                 LOGitem(item);</span>
<a href="#l3.1046"></a><span id="l3.1046"> </span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-                if (!isFullSync &amp;&amp; item.recurrenceId &amp;&amp; referenceItem) {</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+                if (!aIsFullSync &amp;&amp; item.recurrenceId &amp;&amp; referenceItem) {</span>
<a href="#l3.1049"></a><span id="l3.1049">                     // This is a single occurrence that has been updated.</span>
<a href="#l3.1050"></a><span id="l3.1050">                     if (item.status == &quot;CANCELED&quot;) {</span>
<a href="#l3.1051"></a><span id="l3.1051">                         // Canceled means the occurrence is an EXDATE.</span>
<a href="#l3.1052"></a><span id="l3.1052">                         referenceItem.recurrenceInfo.removeOccurrenceAt(item.recurrenceId);</span>
<a href="#l3.1053"></a><span id="l3.1053">                     } else {</span>
<a href="#l3.1054"></a><span id="l3.1054">                         // Not canceled means the occurrence was modified.</span>
<a href="#l3.1055"></a><span id="l3.1055">                         item.parentItem = referenceItem;</span>
<a href="#l3.1056"></a><span id="l3.1056">                         referenceItem.recurrenceInfo.modifyException(item, true);</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineat">@@ -1241,25 +1378,25 @@ calGoogleCalendar.prototype = {</span>
<a href="#l3.1058"></a><span id="l3.1058">                 } else {</span>
<a href="#l3.1059"></a><span id="l3.1059">                     // We could not find the parent item for the occurrence in</span>
<a href="#l3.1060"></a><span id="l3.1060">                     // the feed.</span>
<a href="#l3.1061"></a><span id="l3.1061">                     WARN(&quot;occurrence without parent for item &quot;  + item.id);</span>
<a href="#l3.1062"></a><span id="l3.1062">                 }</span>
<a href="#l3.1063"></a><span id="l3.1063">             }</span>
<a href="#l3.1064"></a><span id="l3.1064"> </span>
<a href="#l3.1065"></a><span id="l3.1065">             // Set the last updated timestamp to now.</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-            LOG(&quot;Last sync date for &quot; + this.name + &quot; is now: &quot; +</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-                aOperation.requestDate.toString());</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Last sync date for &quot; + this.name + &quot; is now: &quot; +</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineplus">+                    aOperation.requestDate.toString());</span>
<a href="#l3.1070"></a><span id="l3.1070">             this.setProperty(&quot;google.lastUpdated&quot;,</span>
<a href="#l3.1071"></a><span id="l3.1071">                              aOperation.requestDate.icalString);</span>
<a href="#l3.1072"></a><span id="l3.1072"> </span>
<a href="#l3.1073"></a><span id="l3.1073">             // Tell our listener we are done.</span>
<a href="#l3.1074"></a><span id="l3.1074">             aOperation.operationListener.onResult(aOperation, null);</span>
<a href="#l3.1075"></a><span id="l3.1075">         } catch (e) {</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-            LOG(&quot;Error syncing items:\n&quot; + e);</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Error syncing items:\n&quot; + e);</span>
<a href="#l3.1078"></a><span id="l3.1078">             aOperation.operationListener.onResult({ status: e.result }, e.message);</span>
<a href="#l3.1079"></a><span id="l3.1079">         }</span>
<a href="#l3.1080"></a><span id="l3.1080">     },</span>
<a href="#l3.1081"></a><span id="l3.1081"> </span>
<a href="#l3.1082"></a><span id="l3.1082">     /**</span>
<a href="#l3.1083"></a><span id="l3.1083">      * Implement calISchedulingSupport. Most is taken care of by the base</span>
<a href="#l3.1084"></a><span id="l3.1084">      * provider, but we want to advertise that we will always take care of</span>
<a href="#l3.1085"></a><span id="l3.1085">      * notifications.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendarModule.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -33,19 +33,21 @@</span>
<a href="#l4.4"></a><span id="l4.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.5"></a><span id="l4.5">  *</span>
<a href="#l4.6"></a><span id="l4.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-// This constant is used internally to signal a failed login to the login</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-// handler's response function.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+// These constants are used internally to signal errors, to avoid the need for</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+// our own error range in calIErrors</span>
<a href="#l4.16"></a><span id="l4.16"> const kGOOGLE_LOGIN_FAILED = 1;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+const kGOOGLE_CONFLICT_DELETED = 2;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+const kGOOGLE_CONFLICT_MODIFY = 3</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> /** Module Registration */</span>
<a href="#l4.21"></a><span id="l4.21"> const calendarScriptLoadOrder = [</span>
<a href="#l4.22"></a><span id="l4.22">     &quot;calUtils.js&quot;,</span>
<a href="#l4.23"></a><span id="l4.23"> ];</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> const gdataScriptLoadOrder = [</span>
<a href="#l4.26"></a><span id="l4.26">     &quot;calGoogleCalendar.js&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleRequest.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -178,23 +178,16 @@ calGoogleRequest.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">      * The HTTP body data for a POST or PUT request.</span>
<a href="#l5.5"></a><span id="l5.5">      *</span>
<a href="#l5.6"></a><span id="l5.6">      * @param aContentType The Content type of the Data</span>
<a href="#l5.7"></a><span id="l5.7">      * @param aData        The Data to upload</span>
<a href="#l5.8"></a><span id="l5.8">      */</span>
<a href="#l5.9"></a><span id="l5.9">     setUploadData: function cGR_setUploadData(aContentType, aData) {</span>
<a href="#l5.10"></a><span id="l5.10">         this.mUploadContent = aContentType;</span>
<a href="#l5.11"></a><span id="l5.11">         this.mUploadData = aData;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        if (this.mType == this.LOGIN) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-            LOG(&quot;Setting upload data for login request (hidden)&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-        } else {</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-            LOG({action:&quot;Setting Upload Data:&quot;,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-                 content:aContentType,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-                 data:aData});</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-        }</span>
<a href="#l5.19"></a><span id="l5.19">     },</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">     /**</span>
<a href="#l5.22"></a><span id="l5.22">      * addQueryParameter</span>
<a href="#l5.23"></a><span id="l5.23">      * Adds a query parameter to this request. This will be used in conjunction</span>
<a href="#l5.24"></a><span id="l5.24">      * with the uri.</span>
<a href="#l5.25"></a><span id="l5.25">      *</span>
<a href="#l5.26"></a><span id="l5.26">      * @param aKey      The key of the request parameter.</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineat">@@ -237,18 +230,18 @@ calGoogleRequest.prototype = {</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">             this.prepareChannel(channel);</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">             channel = channel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l5.32"></a><span id="l5.32">             channel.redirectionLimit = 3;</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">             this.mLoader = cal.createStreamLoader();</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-            LOG(&quot;calGoogleRequest: Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-                channel.URI.spec);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Requesting &quot; + this.method + &quot; &quot; +</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+                    channel.URI.spec);</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">             channel.notificationCallbacks = this;</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">             cal.sendHttpRequest(this.mLoader, channel, this);</span>
<a href="#l5.44"></a><span id="l5.44">         } catch (e) {</span>
<a href="#l5.45"></a><span id="l5.45">             // Let the response function handle the error that happens here</span>
<a href="#l5.46"></a><span id="l5.46">             this.fail(e.result, e.message);</span>
<a href="#l5.47"></a><span id="l5.47">         }</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineat">@@ -295,16 +288,23 @@ calGoogleRequest.prototype = {</span>
<a href="#l5.49"></a><span id="l5.49">         if (this.mUploadData) {</span>
<a href="#l5.50"></a><span id="l5.50">             var converter = Components.classes[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].</span>
<a href="#l5.51"></a><span id="l5.51">                             createInstance(Components.interfaces.nsIScriptableUnicodeConverter);</span>
<a href="#l5.52"></a><span id="l5.52">             converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">             var stream = converter.convertToInputStream(this.mUploadData);</span>
<a href="#l5.55"></a><span id="l5.55">             aChannel = aChannel.QueryInterface(Components.interfaces.nsIUploadChannel);</span>
<a href="#l5.56"></a><span id="l5.56">             aChannel.setUploadStream(stream, this.mUploadContent, -1);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+            if (this.mType == this.LOGIN) {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Setting upload data for login request (hidden)&quot;);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+            } else {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Setting Upload Data (&quot; +</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+                        this.mUploadContent + &quot;):\n&quot; + this.mUploadData);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+            }</span>
<a href="#l5.64"></a><span id="l5.64">         }</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">         aChannel  = aChannel.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">         // Depending on the preference, we will use X-HTTP-Method-Override to</span>
<a href="#l5.69"></a><span id="l5.69">         // get around some proxies. This will default to true.</span>
<a href="#l5.70"></a><span id="l5.70">         if (getPrefSafe(&quot;calendar.google.useHTTPMethodOverride&quot;, true) &amp;&amp;</span>
<a href="#l5.71"></a><span id="l5.71">             (this.method == &quot;PUT&quot; || this.method == &quot;DELETE&quot;)) {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineat">@@ -393,18 +393,18 @@ calGoogleRequest.prototype = {</span>
<a href="#l5.73"></a><span id="l5.73">             case 201: /* Creation of a resource was successful. */</span>
<a href="#l5.74"></a><span id="l5.74">                 // Everything worked out, we are done</span>
<a href="#l5.75"></a><span id="l5.75">                 this.succeed(result);</span>
<a href="#l5.76"></a><span id="l5.76">                 break;</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78">             case 401: /* Authorization required. */</span>
<a href="#l5.79"></a><span id="l5.79">             case 403: /* Unsupported standard parameter, or authentication or</span>
<a href="#l5.80"></a><span id="l5.80">                          Authorization failed. */</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-                LOG(&quot;Login failed for &quot; + this.mSession.userName +</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-                    &quot; HTTP Status &quot; + httpChannel.responseStatus );</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Login failed for &quot; + this.mSession.userName +</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+                        &quot; HTTP Status &quot; + httpChannel.responseStatus);</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86">                 // login failed. auth token must be invalid, password too</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88">                 if (this.type == this.MODIFY ||</span>
<a href="#l5.89"></a><span id="l5.89">                     this.type == this.DELETE ||</span>
<a href="#l5.90"></a><span id="l5.90">                     this.type == this.ADD) {</span>
<a href="#l5.91"></a><span id="l5.91">                     // Encountering this error on a write request means the</span>
<a href="#l5.92"></a><span id="l5.92">                     // calendar is readonly</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineat">@@ -421,39 +421,47 @@ calGoogleRequest.prototype = {</span>
<a href="#l5.94"></a><span id="l5.94">                 } else {</span>
<a href="#l5.95"></a><span id="l5.95">                     // Retry the request. Invalidating the session will trigger</span>
<a href="#l5.96"></a><span id="l5.96">                     // a new login dialog.</span>
<a href="#l5.97"></a><span id="l5.97">                     this.mSession.invalidate();</span>
<a href="#l5.98"></a><span id="l5.98">                     this.mSession.asyncItemRequest(this);</span>
<a href="#l5.99"></a><span id="l5.99">                 }</span>
<a href="#l5.100"></a><span id="l5.100"> </span>
<a href="#l5.101"></a><span id="l5.101">                 break;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+            case 404: /* The resource was not found on the server, which is</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+                         also a conflict */</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+                //  404 NOT FOUND: Resource (such as a feed or entry) not found.</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+                this.fail(kGOOGLE_CONFLICT_DELETED, &quot;&quot;);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+                break;</span>
<a href="#l5.107"></a><span id="l5.107">             case 409: /* Specified version number doesn't match resource's</span>
<a href="#l5.108"></a><span id="l5.108">                          latest version number. */</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+                this.fail(kGOOGLE_CONFLICT_MODIFY, result);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+                break;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+            case 400:</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+                //  400 BAD REQUEST: Invalid request URI or header, or</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+                //                   unsupported nonstandard parameter.</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-                // 409 Conflict. The client should get a newer version of the</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-                // event</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-                // and edit that one.</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+                // HACK Ugh, this sucks. If we send a lower sequence number, Google</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+                // will throw a 400 and not a 409, even though both cases are a conflict.</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+                if (result == &quot;Cannot decrease the sequence number of an event&quot;) {</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+                    this.fail(kGOOGLE_CONFLICT_MODIFY, &quot;SEQUENCE-HACK&quot;);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+                    break;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+                }</span>
<a href="#l5.124"></a><span id="l5.124"> </span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-                // TODO Enhancement tracked in bug 362645</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-                // Fall through, if 409 is not handled then the event is not</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-                // modified/deleted, which is definitly an error.</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+                // Otherwise fall through</span>
<a href="#l5.129"></a><span id="l5.129">             default:</span>
<a href="#l5.130"></a><span id="l5.130">                 // The following codes are caught here:</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-                //  400 BAD REQUEST: Invalid request URI or header, or</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-                //                   unsupported nonstandard parameter.</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-                //  404 NOT FOUND: Resource (such as a feed or entry) not found.</span>
<a href="#l5.134"></a><span id="l5.134">                 //  500 INTERNAL SERVER ERROR: Internal error. This is the</span>
<a href="#l5.135"></a><span id="l5.135">                 //                             default code that is used for</span>
<a href="#l5.136"></a><span id="l5.136">                 //                             all unrecognized errors.</span>
<a href="#l5.137"></a><span id="l5.137">                 //</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139">                 // Something else went wrong</span>
<a href="#l5.140"></a><span id="l5.140">                 var error = &quot;A request Error Occurred. Status Code: &quot; +</span>
<a href="#l5.141"></a><span id="l5.141">                             httpChannel.responseStatus + &quot; &quot; +</span>
<a href="#l5.142"></a><span id="l5.142">                             httpChannel.responseStatusText + &quot; Body: &quot; +</span>
<a href="#l5.143"></a><span id="l5.143">                             result;</span>
<a href="#l5.144"></a><span id="l5.144"> </span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-                this.fail(Components.results.NS_ERROR_FAILURE, error);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+                this.fail(Components.results.NS_ERROR_NOT_AVAILABLE, error);</span>
<a href="#l5.147"></a><span id="l5.147">                 break;</span>
<a href="#l5.148"></a><span id="l5.148">         }</span>
<a href="#l5.149"></a><span id="l5.149">     }</span>
<a href="#l5.150"></a><span id="l5.150"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleSession.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -89,20 +89,20 @@ calGoogleSessionManager.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">             aUsername += &quot;@gmail.com&quot;;</span>
<a href="#l6.5"></a><span id="l6.5">         }</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7">         // Check if the session exists</span>
<a href="#l6.8"></a><span id="l6.8">         if (!this.mSessionMap.hasOwnProperty(aUsername)) {</span>
<a href="#l6.9"></a><span id="l6.9">             if (!aCreate) {</span>
<a href="#l6.10"></a><span id="l6.10">                 return null;</span>
<a href="#l6.11"></a><span id="l6.11">             }</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-            LOG(&quot;Creating session for: &quot; + aUsername);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Creating session for: &quot; + aUsername);</span>
<a href="#l6.14"></a><span id="l6.14">             this.mSessionMap[aUsername] = new calGoogleSession(aUsername);</span>
<a href="#l6.15"></a><span id="l6.15">         } else {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-            LOG(&quot;Reusing session for: &quot; + aUsername);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Reusing session for: &quot; + aUsername);</span>
<a href="#l6.18"></a><span id="l6.18">         }</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">         // XXX What happens if the username is &quot;toSource&quot; :)</span>
<a href="#l6.21"></a><span id="l6.21">         return this.mSessionMap[aUsername];</span>
<a href="#l6.22"></a><span id="l6.22">     }</span>
<a href="#l6.23"></a><span id="l6.23"> };</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25"> /**</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineat">@@ -256,21 +256,21 @@ calGoogleSession.prototype = {</span>
<a href="#l6.27"></a><span id="l6.27">      * loginAndContinue</span>
<a href="#l6.28"></a><span id="l6.28">      * Prepares a login request, then requests via #asyncRawRequest</span>
<a href="#l6.29"></a><span id="l6.29">      *</span>
<a href="#l6.30"></a><span id="l6.30">      *</span>
<a href="#l6.31"></a><span id="l6.31">      * @param aCalendar    The calendar of the request that initiated the login.</span>
<a href="#l6.32"></a><span id="l6.32">      */</span>
<a href="#l6.33"></a><span id="l6.33">     loginAndContinue: function cGS_loginAndContinue(aCalendar) {</span>
<a href="#l6.34"></a><span id="l6.34">         if (this.mLoggingIn) {</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-            LOG(&quot;loginAndContinue called while logging in&quot;);</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] loginAndContinue called while logging in&quot;);</span>
<a href="#l6.37"></a><span id="l6.37">             return;</span>
<a href="#l6.38"></a><span id="l6.38">         }</span>
<a href="#l6.39"></a><span id="l6.39">         try {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-            LOG(&quot;Logging in to &quot; + this.mGoogleUser);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Logging in to &quot; + this.mGoogleUser);</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">             // We need to have a user and should not be logging in</span>
<a href="#l6.44"></a><span id="l6.44">             ASSERT(!this.mLoggingIn);</span>
<a href="#l6.45"></a><span id="l6.45">             ASSERT(this.mGoogleUser);</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">             // Start logging in</span>
<a href="#l6.48"></a><span id="l6.48">             this.mLoggingIn = true;</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50" class="difflineat">@@ -305,42 +305,42 @@ calGoogleSession.prototype = {</span>
<a href="#l6.51"></a><span id="l6.51">                                     aCalendar.googleCalendarName :</span>
<a href="#l6.52"></a><span id="l6.52">                                     this.mGoogleUser);</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">                 if (getCalendarCredentials(calendarName,</span>
<a href="#l6.55"></a><span id="l6.55">                                            username,</span>
<a href="#l6.56"></a><span id="l6.56">                                            password,</span>
<a href="#l6.57"></a><span id="l6.57">                                            persist)) {</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-                    LOG(&quot;Got the pw from the calendar credentials: &quot; +</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-                        calendarName);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Got the pw from the calendar credentials: &quot; +</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+                            calendarName);</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64">                     // If a different username was entered, switch sessions</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66">                     if (aCalendar &amp;&amp; username.value != this.mGoogleUser) {</span>
<a href="#l6.67"></a><span id="l6.67">                         var newSession = getGoogleSessionManager()</span>
<a href="#l6.68"></a><span id="l6.68">                                          .getSessionByUsername(username.value,</span>
<a href="#l6.69"></a><span id="l6.69">                                                                true);</span>
<a href="#l6.70"></a><span id="l6.70">                         newSession.password = password.value;</span>
<a href="#l6.71"></a><span id="l6.71">                         newSession.persist = persist.value;</span>
<a href="#l6.72"></a><span id="l6.72">                         setCalendarPref(aCalendar,</span>
<a href="#l6.73"></a><span id="l6.73">                                         &quot;googleUser&quot;,</span>
<a href="#l6.74"></a><span id="l6.74">                                         &quot;CHAR&quot;,</span>
<a href="#l6.75"></a><span id="l6.75">                                         username.value);</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">                         // Set the new session for the calendar</span>
<a href="#l6.78"></a><span id="l6.78">                         aCalendar.session = newSession;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-                        LOG(&quot;Setting &quot; + aCalendar.name +</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-                            &quot;'s Session to &quot; + newSession.userName);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineplus">+                        cal.LOG(&quot;[calGoogleCalendar] Setting &quot; + aCalendar.name +</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+                                &quot;'s Session to &quot; + newSession.userName);</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">                         // Move all requests by this calendar to its new session</span>
<a href="#l6.85"></a><span id="l6.85">                         function cGS_login_moveToSession(element, index, arr) {</span>
<a href="#l6.86"></a><span id="l6.86">                             if (element.calendar == aCalendar) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-                                LOG(&quot;Moving &quot; + element.uri + &quot; to &quot; +</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-                                    newSession.userName);</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineplus">+                                cal.LOG(&quot;[calGoogleCalendar] Moving &quot; + element.uri + &quot; to &quot; +</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+                                        newSession.userName);</span>
<a href="#l6.91"></a><span id="l6.91">                                 newSession.asyncItemRequest(element);</span>
<a href="#l6.92"></a><span id="l6.92">                                 return false;</span>
<a href="#l6.93"></a><span id="l6.93">                             }</span>
<a href="#l6.94"></a><span id="l6.94">                             return true;</span>
<a href="#l6.95"></a><span id="l6.95">                         }</span>
<a href="#l6.96"></a><span id="l6.96">                         this.mItemQueue = this.mItemQueue</span>
<a href="#l6.97"></a><span id="l6.97">                                           .filter(cGS_login_moveToSession);</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99" class="difflineat">@@ -351,19 +351,19 @@ calGoogleSession.prototype = {</span>
<a href="#l6.100"></a><span id="l6.100">                     }</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102">                     // If we arrive at this point, then the session was not</span>
<a href="#l6.103"></a><span id="l6.103">                     // changed. Just adapt the password from the dialog and</span>
<a href="#l6.104"></a><span id="l6.104">                     // continue.</span>
<a href="#l6.105"></a><span id="l6.105">                     this.mGooglePass = password.value;</span>
<a href="#l6.106"></a><span id="l6.106">                     this.persist = persist.value;</span>
<a href="#l6.107"></a><span id="l6.107">                 } else {</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-                    LOG(&quot;Could not get any credentials for &quot; +</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-                        calendarName + &quot; (&quot; +</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-                        this.mGoogleUser + &quot;)&quot;);</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Could not get any credentials for &quot; +</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+                            calendarName + &quot; (&quot; +</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+                            this.mGoogleUser + &quot;)&quot;);</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115">                     if (aCalendar) {</span>
<a href="#l6.116"></a><span id="l6.116">                         // First of all, disable the calendar so no further login</span>
<a href="#l6.117"></a><span id="l6.117">                         // dialogs show up.</span>
<a href="#l6.118"></a><span id="l6.118">                         aCalendar.setProperty(&quot;disabled&quot;, true);</span>
<a href="#l6.119"></a><span id="l6.119">                         aCalendar.setProperty(&quot;auto-enabled&quot;, true);</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121">                         // Unset the session in the requesting calendar, if the user</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineat">@@ -410,17 +410,17 @@ calGoogleSession.prototype = {</span>
<a href="#l6.123"></a><span id="l6.123">                                   &quot;&amp;Passwd=&quot; + encodeURIComponent(this.mGooglePass) +</span>
<a href="#l6.124"></a><span id="l6.124">                                   &quot;&amp;accountType=HOSTED_OR_GOOGLE&quot; +</span>
<a href="#l6.125"></a><span id="l6.125">                                   &quot;&amp;source=&quot; + encodeURIComponent(source) +</span>
<a href="#l6.126"></a><span id="l6.126">                                   &quot;&amp;service=cl&quot;);</span>
<a href="#l6.127"></a><span id="l6.127">             this.asyncRawRequest(request);</span>
<a href="#l6.128"></a><span id="l6.128">         } catch (e) {</span>
<a href="#l6.129"></a><span id="l6.129">             // If something went wrong, reset the login state just in case</span>
<a href="#l6.130"></a><span id="l6.130">             this.mLoggingIn = false;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-            LOG(&quot;Error Logging In: &quot; + e);</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Error Logging In: &quot; + e);</span>
<a href="#l6.133"></a><span id="l6.133"> </span>
<a href="#l6.134"></a><span id="l6.134">             // If something went wrong, then this.loginComplete should handle</span>
<a href="#l6.135"></a><span id="l6.135">             // the error. We don't need to take care of the request that</span>
<a href="#l6.136"></a><span id="l6.136">             // initiated the login, since it is also in the item queue.</span>
<a href="#l6.137"></a><span id="l6.137">             this.onResult({ status: e.result}, e.message);</span>
<a href="#l6.138"></a><span id="l6.138">         }</span>
<a href="#l6.139"></a><span id="l6.139">     },</span>
<a href="#l6.140"></a><span id="l6.140"> </span>
<a href="#l6.141"></a><span id="l6.141" class="difflineat">@@ -440,25 +440,25 @@ calGoogleSession.prototype = {</span>
<a href="#l6.142"></a><span id="l6.142">      onResult: function cGS_onResult(aOperation, aData) {</span>
<a href="#l6.143"></a><span id="l6.143">         // About mLoggingIn: this should only be set to false when either</span>
<a href="#l6.144"></a><span id="l6.144">         // something went wrong or mAuthToken is set. This avoids redundant</span>
<a href="#l6.145"></a><span id="l6.145">         // logins to Google. Hence mLoggingIn is set three times in the course</span>
<a href="#l6.146"></a><span id="l6.146">         // of this function</span>
<a href="#l6.147"></a><span id="l6.147"> </span>
<a href="#l6.148"></a><span id="l6.148">         if (!aData || !Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l6.149"></a><span id="l6.149">             this.mLoggingIn = false;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-            LOG(&quot;Login failed. Status: &quot; + aOperation.status);</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Login failed. Status: &quot; + aOperation.status);</span>
<a href="#l6.152"></a><span id="l6.152"> </span>
<a href="#l6.153"></a><span id="l6.153">             if (aOperation.status == kGOOGLE_LOGIN_FAILED &amp;&amp;</span>
<a href="#l6.154"></a><span id="l6.154">                 aOperation.reauthenticate) {</span>
<a href="#l6.155"></a><span id="l6.155">                 // If the login failed, then retry the login. This is not an</span>
<a href="#l6.156"></a><span id="l6.156">                 // error that should trigger failing the calICalendar's request.</span>
<a href="#l6.157"></a><span id="l6.157">                 this.loginAndContinue(aOperation.calendar);</span>
<a href="#l6.158"></a><span id="l6.158">             } else {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-                LOG(&quot;Failing queue with &quot; + aOperation.status);</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+                cal.LOG(&quot;[calGoogleCalendar] Failing queue with &quot; + aOperation.status);</span>
<a href="#l6.161"></a><span id="l6.161">                 this.failQueue(aOperation.status);</span>
<a href="#l6.162"></a><span id="l6.162">             }</span>
<a href="#l6.163"></a><span id="l6.163">         } else {</span>
<a href="#l6.164"></a><span id="l6.164">             var start = aData.indexOf(&quot;Auth=&quot;);</span>
<a href="#l6.165"></a><span id="l6.165">             if (start == -1) {</span>
<a href="#l6.166"></a><span id="l6.166">                 // The Auth token could not be extracted</span>
<a href="#l6.167"></a><span id="l6.167">                 this.mLoggingIn = false;</span>
<a href="#l6.168"></a><span id="l6.168">                 this.invalidate();</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineat">@@ -472,25 +472,25 @@ calGoogleSession.prototype = {</span>
<a href="#l6.170"></a><span id="l6.170"> </span>
<a href="#l6.171"></a><span id="l6.171">                 if (this.persist) {</span>
<a href="#l6.172"></a><span id="l6.172">                     try {</span>
<a href="#l6.173"></a><span id="l6.173">                         passwordManagerSave(this.mGoogleUser,</span>
<a href="#l6.174"></a><span id="l6.174">                                             this.mGooglePass);</span>
<a href="#l6.175"></a><span id="l6.175">                     } catch (e) {</span>
<a href="#l6.176"></a><span id="l6.176">                         // This error is non-fatal, but would constrict</span>
<a href="#l6.177"></a><span id="l6.177">                         // functionality</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-                        LOG(&quot;Error adding password to manager&quot;);</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+                        cal.LOG(&quot;[calGoogleCalendar] Error adding password to manager&quot;);</span>
<a href="#l6.180"></a><span id="l6.180">                     }</span>
<a href="#l6.181"></a><span id="l6.181">                 }</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183">                 // Process Items that were requested while logging in</span>
<a href="#l6.184"></a><span id="l6.184">                 var request;</span>
<a href="#l6.185"></a><span id="l6.185">                 // Extra parentheses to avoid js strict warning.</span>
<a href="#l6.186"></a><span id="l6.186">                 while ((request = this.mItemQueue.shift())) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-                    LOG(&quot;Processing Queue Item: &quot; + request.uri);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Processing Queue Item: &quot; + request.uri);</span>
<a href="#l6.189"></a><span id="l6.189">                     request.commit(this);</span>
<a href="#l6.190"></a><span id="l6.190">                 }</span>
<a href="#l6.191"></a><span id="l6.191">             }</span>
<a href="#l6.192"></a><span id="l6.192">         }</span>
<a href="#l6.193"></a><span id="l6.193">     },</span>
<a href="#l6.194"></a><span id="l6.194"> </span>
<a href="#l6.195"></a><span id="l6.195">     /**</span>
<a href="#l6.196"></a><span id="l6.196">      * asyncItemRequest</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineat">@@ -504,17 +504,17 @@ calGoogleSession.prototype = {</span>
<a href="#l6.198"></a><span id="l6.198">         if (!this.mLoggingIn &amp;&amp; this.mAuthToken) {</span>
<a href="#l6.199"></a><span id="l6.199">             // We are not currently logging in and we have an auth token, so</span>
<a href="#l6.200"></a><span id="l6.200">             // directly try the login request</span>
<a href="#l6.201"></a><span id="l6.201">             this.asyncRawRequest(aRequest);</span>
<a href="#l6.202"></a><span id="l6.202">         } else {</span>
<a href="#l6.203"></a><span id="l6.203">             // Push the request in the queue to be executed later</span>
<a href="#l6.204"></a><span id="l6.204">             this.mItemQueue.push(aRequest);</span>
<a href="#l6.205"></a><span id="l6.205"> </span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-            LOG(&quot;Adding item &quot; + aRequest.uri + &quot; to queue&quot;);</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Adding item &quot; + aRequest.uri + &quot; to queue&quot;);</span>
<a href="#l6.208"></a><span id="l6.208"> </span>
<a href="#l6.209"></a><span id="l6.209">             // If we are logging in, then we are done since the passed request</span>
<a href="#l6.210"></a><span id="l6.210">             // will be processed when the login is complete. Otherwise start</span>
<a href="#l6.211"></a><span id="l6.211">             // logging in.</span>
<a href="#l6.212"></a><span id="l6.212">             if (!this.mLoggingIn &amp;&amp; this.mAuthToken == null) {</span>
<a href="#l6.213"></a><span id="l6.213">                 // We need to do this on a timeout, otherwise the UI thread will</span>
<a href="#l6.214"></a><span id="l6.214">                 // block when the password prompt is shown.</span>
<a href="#l6.215"></a><span id="l6.215">                 setTimeout(function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleUtils.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -214,16 +214,134 @@ function passwordManagerGet(aUsername, a</span>
<a href="#l7.4"></a><span id="l7.4">  * @param aUsername     The username to remove.</span>
<a href="#l7.5"></a><span id="l7.5">  * @return              Could the user be removed?</span>
<a href="#l7.6"></a><span id="l7.6">  */</span>
<a href="#l7.7"></a><span id="l7.7"> function passwordManagerRemove(aUsername) {</span>
<a href="#l7.8"></a><span id="l7.8">     return cal.auth.passwordManagerRemove(aUsername, aUsername, &quot;Google Calendar&quot;);</span>
<a href="#l7.9"></a><span id="l7.9"> }</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> /**</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ * If the operation has signaled that a conflict occurred, then prompt the user</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * to overwrite. If the user chooses to overwrite, restart the request with the</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ * right parameters so the request succeeds.</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+ *</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+ * @param aOperation        The operation to check</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+ * @param aItem             The updated item from the response</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+ * @return                  False if further processing should be cancelled</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+ */</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+function resolveConflicts(aOperation, aItem) {</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    if (aItem &amp;&amp; (aOperation.status == kGOOGLE_CONFLICT_DELETED ||</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+                  aOperation.status == kGOOGLE_CONFLICT_MODIFY)) {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+        if (aItem == &quot;SEQUENCE-HACK&quot;) {</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+            // Working around a Google issue here, see what happens on a 400</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+            // code in calGoogleRequest.js. This will cause a new request</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+            // without the sequence number. In return, we get a new item with</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+            // the correct sequence number.</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+            let newItem =  aOperation.newItem.clone();</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+            let session = aOperation.calendar.session;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+            newItem.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+            let xmlEntry = ItemToXMLEntry(newItem, aOperation.calendar,</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                                          session.userName, session.fullName);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+            aOperation.newItem = newItem;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+            aOperation.setUploadData(&quot;application/atom+xml; charset=UTF-8&quot;, xmlEntry);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+            session.asyncItemRequest(aOperation);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+            return false;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+        } else if (aOperation.status == kGOOGLE_CONFLICT_DELETED &amp;&amp;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+                   aOperation.type == aOperation.DELETE) {</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+            // Deleted on the server and deleted locally. Great!</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+            return true;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+        } else {</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+            // If a conflict occurred, then prompt</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+            let method = (aOperation.type == aOperation.DELETE ? &quot;delete&quot; : &quot;modify&quot;)</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+            let inputItem = aOperation.oldItem || aOperation.newItem;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+            let overwrite = cal.promptOverwrite(method, inputItem);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+            if (overwrite) {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                if (aOperation.status == kGOOGLE_CONFLICT_DELETED &amp;&amp;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+                    aOperation.type == aOperation.MODIFY) {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                    // The item was deleted on the server, but modified locally.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                    // Add it again</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                    aOperation.type = aOperation.ADD;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+                    aOperation.uri = aOperation.calendar.fullUri.spec;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+                    aOperation.calendar.session.asyncItemRequest(aOperation);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                    return false;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                } else if (aOperation.status == kGOOGLE_CONFLICT_MODIFY &amp;&amp;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                           aOperation.type == aOperation.MODIFY) {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                    // The item was modified in both places, repeat the current</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+                    // request with the edit uri of the updated event</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                    aOperation.uri = getItemEditURI(aItem);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+                    aOperation.calendar.session.asyncItemRequest(aOperation);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+                    return false;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+                } else if (aOperation.status == kGOOGLE_CONFLICT_MODIFY &amp;&amp;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                           aOperation.type == aOperation.DELETE) {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+                    // Modified on the server, deleted locally. Just repeat the</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+                    // delete request with the updated edit uri.</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+                    aOperation.uri = getItemEditURI(aItem);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+                    aOperation.calendar.session.asyncItemRequest(aOperation);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+                    return false;</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+                }</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+            }</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+        }</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+        // Otherwise, we can just continue using the item that was parsed, it</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+        // is the newest version on the server.</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    }</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    return true;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+}</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+/**</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+ * Helper function to convert raw data directly into a calIItemBase. If the</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+ * passed operation signals an error, then throw an exception</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+ *</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+ * @param aOperation        The operation to check for errors</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+ * @param aData             The result from the response</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+ * @param aGoogleCalendar   The calIGoogleCalendar to operate on</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+ * @param aReferenceItem    The reference item to apply the information to</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+ * @return                  The parsed item</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+ * @throws                  An exception on a parsing or request error</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+ */</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+function DataToItem(aOperation, aData, aGoogleCalendar, aReferenceItem) {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    if (aOperation.status == kGOOGLE_CONFLICT_DELETED ||</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+        aOperation.status == kGOOGLE_CONFLICT_MODIFY ||</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+        Components.isSuccessCode(aOperation.status)) {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+        let item;</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+        if (aData == &quot;SEQUENCE-HACK&quot;) {</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+            // Working around a Google issue here, see what happens on a 400</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+            // code in calGoogleRequest.js. This will be processed in</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+            // resolveConflicts().</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+            return &quot;SEQUENCE-HACK&quot;;</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+        }</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+        if (aData &amp;&amp; aData.length) {</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+            let xml = cal.safeNewXML(aData);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] Parsing entry:\n&quot; + xml + &quot;\n&quot;);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+            // Get the local timezone from the preferences</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+            let timezone = calendarDefaultTimezone();</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+            // Parse the Item with the given timezone</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+            item = XMLEntryToItem(xml, timezone,</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+                                  aGoogleCalendar,</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+                                  aReferenceItem);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+        } else {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+            cal.LOG(&quot;[calGoogleCalendar] No content, using reference item instead &quot;);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+            // No data happens for example on delete. Just assume the reference</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+            // item.</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+            item = aReferenceItem.clone();</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+        }</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+        LOGitem(item);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+        item.calendar = aGoogleCalendar.superCalendar;</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+        return item;</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    } else {</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+        throw new Components.Exception(aData, aOperation.status);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    }</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+}</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+/**</span>
<a href="#l7.130"></a><span id="l7.130">  * ItemToXMLEntry</span>
<a href="#l7.131"></a><span id="l7.131">  * Converts a calIEvent to a string of xml data.</span>
<a href="#l7.132"></a><span id="l7.132">  *</span>
<a href="#l7.133"></a><span id="l7.133">  * @param aItem         The item to convert</span>
<a href="#l7.134"></a><span id="l7.134">  * @param aCalendar     The calendar to use, this must be a calIGoogleCalendar</span>
<a href="#l7.135"></a><span id="l7.135">  * @param aAuthorEmail  The email of the author of the event</span>
<a href="#l7.136"></a><span id="l7.136">  * @param aAuthorName   The full name of the author of the event</span>
<a href="#l7.137"></a><span id="l7.137">  * @return              The xml data of the item</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineat">@@ -452,18 +570,16 @@ function ItemToXMLEntry(aItem, aCalendar</span>
<a href="#l7.139"></a><span id="l7.139"> </span>
<a href="#l7.140"></a><span id="l7.140">     // gd:visibility</span>
<a href="#l7.141"></a><span id="l7.141">     var privacy = aItem.privacy || &quot;default&quot;;</span>
<a href="#l7.142"></a><span id="l7.142">     entry.gd::visibility.@value = kEVENT_SCHEMA + privacy.toLowerCase();</span>
<a href="#l7.143"></a><span id="l7.143"> </span>
<a href="#l7.144"></a><span id="l7.144">     // categories</span>
<a href="#l7.145"></a><span id="l7.145">     // Google does not support categories natively, but allows us to store data</span>
<a href="#l7.146"></a><span id="l7.146">     // as an &quot;extendedProperty&quot;, so we do here</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-    cal.WARN(&quot;CAT: &quot; + aItem.getCategories({}).toSource() + &quot; = &quot; +</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-             categoriesArrayToString(aItem.getCategories({})));</span>
<a href="#l7.149"></a><span id="l7.149">     addExtendedProperty(&quot;X-MOZ-CATEGORIES&quot;,</span>
<a href="#l7.150"></a><span id="l7.150">                         categoriesArrayToString(aItem.getCategories({})));</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152">     // gd:recurrence</span>
<a href="#l7.153"></a><span id="l7.153">     if (aItem.recurrenceInfo) {</span>
<a href="#l7.154"></a><span id="l7.154">         try {</span>
<a href="#l7.155"></a><span id="l7.155">             const kNEWLINE = &quot;\r\n&quot;;</span>
<a href="#l7.156"></a><span id="l7.156">             var icalString;</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineat">@@ -487,30 +603,33 @@ function ItemToXMLEntry(aItem, aCalendar</span>
<a href="#l7.158"></a><span id="l7.158">                     prop.valueAsDatetime = ritem.date.getInTimezone(UTC());</span>
<a href="#l7.159"></a><span id="l7.159">                 }</span>
<a href="#l7.160"></a><span id="l7.160">                 icalString += prop.icalString;</span>
<a href="#l7.161"></a><span id="l7.161">             }</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163">             // Put the ical string in a &lt;gd:recurrence&gt; tag</span>
<a href="#l7.164"></a><span id="l7.164">             entry.gd::recurrence = icalString + kNEWLINE;</span>
<a href="#l7.165"></a><span id="l7.165">         } catch (e) {</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-            LOG(&quot;Error: &quot; + e);</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+            cal.ERROR(&quot;[calGoogleCalendar] Error: &quot; + e);</span>
<a href="#l7.168"></a><span id="l7.168">         }</span>
<a href="#l7.169"></a><span id="l7.169">     }</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171">     // gd:originalEvent</span>
<a href="#l7.172"></a><span id="l7.172">     if (aItem.recurrenceId) {</span>
<a href="#l7.173"></a><span id="l7.173">         entry.gd::originalEvent.@id = aItem.parentItem.id;</span>
<a href="#l7.174"></a><span id="l7.174">         entry.gd::originalEvent.gd::when.@startTime =</span>
<a href="#l7.175"></a><span id="l7.175">             cal.toRFC3339(aItem.recurrenceId.getInTimezone(UTC()));</span>
<a href="#l7.176"></a><span id="l7.176">     }</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178">     // While it may sometimes not work out, we can always try to set the uid and</span>
<a href="#l7.179"></a><span id="l7.179">     // sequence properties</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-    entry.gCal::sequence.@value = aItem.getProperty(&quot;SEQUENCE&quot;) || 0;</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    let sequence = aItem.getProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+    if (sequence) {</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+        entry.gCal::sequence.@value = sequence;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    }</span>
<a href="#l7.185"></a><span id="l7.185">     entry.gCal::uid.@value = aItem.id || &quot;&quot;;</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187">     // TODO gd:comments: Enhancement tracked in bug 362653</span>
<a href="#l7.188"></a><span id="l7.188"> </span>
<a href="#l7.189"></a><span id="l7.189">     // XXX Google currently has no priority support. See</span>
<a href="#l7.190"></a><span id="l7.190">     // http://code.google.com/p/google-gdata/issues/detail?id=52</span>
<a href="#l7.191"></a><span id="l7.191">     // for details.</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193" class="difflineat">@@ -653,17 +772,17 @@ function relevantFieldsMatch(a, b) {</span>
<a href="#l7.194"></a><span id="l7.194">  * @return              The edit URI</span>
<a href="#l7.195"></a><span id="l7.195">  */</span>
<a href="#l7.196"></a><span id="l7.196"> function getItemEditURI(aItem) {</span>
<a href="#l7.197"></a><span id="l7.197"> </span>
<a href="#l7.198"></a><span id="l7.198">     ASSERT(aItem);</span>
<a href="#l7.199"></a><span id="l7.199">     var edituri = aItem.getProperty(&quot;X-GOOGLE-EDITURL&quot;);</span>
<a href="#l7.200"></a><span id="l7.200">     if (!edituri) {</span>
<a href="#l7.201"></a><span id="l7.201">         // If the item has no edit uri, it is read-only</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-        throw new Components.Exception(&quot;&quot;, Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+        throw new Components.Exception(&quot;The item is readonly&quot;, Components.interfaces.calIErrors.CAL_IS_READONLY);</span>
<a href="#l7.204"></a><span id="l7.204">     }</span>
<a href="#l7.205"></a><span id="l7.205">     return edituri;</span>
<a href="#l7.206"></a><span id="l7.206"> }</span>
<a href="#l7.207"></a><span id="l7.207"> </span>
<a href="#l7.208"></a><span id="l7.208"> function getIdFromEntry(aXMLEntry) {</span>
<a href="#l7.209"></a><span id="l7.209">     var gCal = new Namespace(&quot;gCal&quot;, &quot;http://schemas.google.com/gCal/2005&quot;);</span>
<a href="#l7.210"></a><span id="l7.210">     var gd = new Namespace(&quot;gd&quot;, &quot;http://schemas.google.com/g/2005&quot;);</span>
<a href="#l7.211"></a><span id="l7.211">     var id = aXMLEntry.gCal::uid.@value.toString();</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineat">@@ -1021,29 +1140,59 @@ function XMLEntryToItem(aXMLEntry, aTime</span>
<a href="#l7.213"></a><span id="l7.213">  * Otherwise returns the item in an array.</span>
<a href="#l7.214"></a><span id="l7.214">  *</span>
<a href="#l7.215"></a><span id="l7.215">  * @param aItem         The item to expand</span>
<a href="#l7.216"></a><span id="l7.216">  * @param aOperation    The calIGoogleRequest that contains the filter and</span>
<a href="#l7.217"></a><span id="l7.217">  *                        ranges.</span>
<a href="#l7.218"></a><span id="l7.218">  * @return              The (possibly expanded) items in an array.</span>
<a href="#l7.219"></a><span id="l7.219">  */</span>
<a href="#l7.220"></a><span id="l7.220"> function expandItems(aItem, aOperation) {</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-    var expandedItems;</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    let expandedItems;</span>
<a href="#l7.223"></a><span id="l7.223">     if (aOperation.itemFilter &amp;</span>
<a href="#l7.224"></a><span id="l7.224">         Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES) {</span>
<a href="#l7.225"></a><span id="l7.225">         expandedItems = aItem.getOccurrencesBetween(aOperation.itemRangeStart,</span>
<a href="#l7.226"></a><span id="l7.226">                                                     aOperation.itemRangeEnd,</span>
<a href="#l7.227"></a><span id="l7.227">                                                     {});</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-        LOG(&quot;Expanded item &quot; + aItem.title + &quot; to &quot; +</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-            expandedItems.length + &quot; items&quot;);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+        cal.LOG(&quot;[calGoogleCalendar] Expanded item &quot; + aItem.title + &quot; to &quot; +</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+                expandedItems.length + &quot; items&quot;);</span>
<a href="#l7.232"></a><span id="l7.232">     }</span>
<a href="#l7.233"></a><span id="l7.233">     return expandedItems || [aItem];</span>
<a href="#l7.234"></a><span id="l7.234"> }</span>
<a href="#l7.235"></a><span id="l7.235"> </span>
<a href="#l7.236"></a><span id="l7.236"> /**</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+ * Returns true if the exception passed is one that should cause the cache</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+ * layer to retry the operation. This is usually a network error or other</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+ * temporary error</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+ *</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+ * @param e     The exception to check</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+ */</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+function isCacheException(e) {</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+    // Stolen from nserror.h</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+    const NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    function NS_ERROR_GET_MODULE(code) {</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+        return (((code &gt;&gt; 16) - 0x45) &amp; 0x1fff);</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+    }</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+    if (NS_ERROR_GET_MODULE(e.result) == NS_ERROR_MODULE_NETWORK &amp;&amp;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+        !Components.isSuccessCode(e.result)) {</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+        // This is a network error, which most likely means we should</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+        // retry it some time.</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+        return true;</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+    }</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+    // Other potential errors we want to retry with</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+    switch (e.result) {</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+        case Components.results.NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+            return true;</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+        default:</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+            return false;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+    }</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+}</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+/**</span>
<a href="#l7.267"></a><span id="l7.267">  * Helper prototype to set a certain variable to the first item passed via get</span>
<a href="#l7.268"></a><span id="l7.268">  * listener. Cleans up code.</span>
<a href="#l7.269"></a><span id="l7.269">  */</span>
<a href="#l7.270"></a><span id="l7.270"> function syncSetter(aObj) {</span>
<a href="#l7.271"></a><span id="l7.271">     this.mObj = aObj</span>
<a href="#l7.272"></a><span id="l7.272"> }</span>
<a href="#l7.273"></a><span id="l7.273"> syncSetter.prototype = {</span>
<a href="#l7.274"></a><span id="l7.274"> </span>
<a href="#l7.275"></a><span id="l7.275" class="difflineat">@@ -1118,29 +1267,30 @@ function LOGitem(item) {</span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277">     let astr = &quot;\n&quot;;</span>
<a href="#l7.278"></a><span id="l7.278">     let alarms = item.getAlarms({});</span>
<a href="#l7.279"></a><span id="l7.279">     for each (let alarm in alarms) {</span>
<a href="#l7.280"></a><span id="l7.280">         astr += &quot;\t\t&quot; + LOGalarm(alarm) + &quot;\n&quot;;</span>
<a href="#l7.281"></a><span id="l7.281">     }</span>
<a href="#l7.282"></a><span id="l7.282"> </span>
<a href="#l7.283"></a><span id="l7.283"> </span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-    LOG(&quot;Logging calIEvent:&quot; +</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    cal.LOG(&quot;[calGoogleCalendar] Logging calIEvent:&quot; +</span>
<a href="#l7.286"></a><span id="l7.286">         &quot;\n\tid:&quot; + item.id +</span>
<a href="#l7.287"></a><span id="l7.287">         &quot;\n\tediturl:&quot; + item.getProperty(&quot;X-GOOGLE-EDITURL&quot;) +</span>
<a href="#l7.288"></a><span id="l7.288">         &quot;\n\tcreated:&quot; + item.getProperty(&quot;CREATED&quot;) +</span>
<a href="#l7.289"></a><span id="l7.289">         &quot;\n\tupdated:&quot; + item.getProperty(&quot;LAST-MODIFIED&quot;) +</span>
<a href="#l7.290"></a><span id="l7.290">         &quot;\n\ttitle:&quot; + item.title +</span>
<a href="#l7.291"></a><span id="l7.291">         &quot;\n\tcontent:&quot; + item.getProperty(&quot;DESCRIPTION&quot;) +</span>
<a href="#l7.292"></a><span id="l7.292">         &quot;\n\ttransparency:&quot; + item.getProperty(&quot;TRANSP&quot;) +</span>
<a href="#l7.293"></a><span id="l7.293">         &quot;\n\tstatus:&quot; + item.status +</span>
<a href="#l7.294"></a><span id="l7.294">         &quot;\n\tstartTime:&quot; + item.startDate.toString() +</span>
<a href="#l7.295"></a><span id="l7.295">         &quot;\n\tendTime:&quot; + item.endDate.toString() +</span>
<a href="#l7.296"></a><span id="l7.296">         &quot;\n\tlocation:&quot; + item.getProperty(&quot;LOCATION&quot;) +</span>
<a href="#l7.297"></a><span id="l7.297">         &quot;\n\tprivacy:&quot; + item.privacy +</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+        &quot;\n\tsequence:&quot; + item.getProperty(&quot;SEQUENCE&quot;) +</span>
<a href="#l7.299"></a><span id="l7.299">         &quot;\n\talarmLastAck:&quot; + item.alarmLastAck +</span>
<a href="#l7.300"></a><span id="l7.300">         &quot;\n\tsnoozeTime:&quot; + item.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;) +</span>
<a href="#l7.301"></a><span id="l7.301">         &quot;\n\tisOccurrence: &quot; + (item.recurrenceId != null) +</span>
<a href="#l7.302"></a><span id="l7.302">         &quot;\n\tOrganizer: &quot; + LOGattendee(item.organizer) +</span>
<a href="#l7.303"></a><span id="l7.303">         &quot;\n\tAttendees: &quot; + attendeeString +</span>
<a href="#l7.304"></a><span id="l7.304">         &quot;\n\trecurrence: &quot; + (rstr.length &gt; 1 ? &quot;yes: &quot; + rstr : &quot;no&quot;) +</span>
<a href="#l7.305"></a><span id="l7.305">         &quot;\n\talarms: &quot; + (astr.length &gt; 1 ? &quot;yes: &quot; + astr : &quot;no&quot;));</span>
<a href="#l7.306"></a><span id="l7.306"> }</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineat">@@ -1184,11 +1334,12 @@ function LOGinterval(aInterval) {</span>
<a href="#l7.308"></a><span id="l7.308">     if (aInterval.freeBusyType == fbtypes.FREE) {</span>
<a href="#l7.309"></a><span id="l7.309">         type = &quot;FREE&quot;;</span>
<a href="#l7.310"></a><span id="l7.310">     } else if (aInterval.freeBusyType == fbtypes.BUSY) {</span>
<a href="#l7.311"></a><span id="l7.311">         type = &quot;BUSY&quot;;</span>
<a href="#l7.312"></a><span id="l7.312">     } else {</span>
<a href="#l7.313"></a><span id="l7.313">         type = aInterval.freeBusyType + &quot;(UNKNOWN)&quot;;</span>
<a href="#l7.314"></a><span id="l7.314">     }</span>
<a href="#l7.315"></a><span id="l7.315"> </span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-    LOG(&quot;Interval from &quot; + aInterval.interval.start + &quot; to &quot;</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-                         + aInterval.interval.end + &quot; is &quot; + type);</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+    cal.LOG(&quot;[calGoogleCalendar] Interval from &quot; +</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+            aInterval.interval.start + &quot; to &quot; + aInterval.interval.end +</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+            &quot; is &quot; + type);</span>
<a href="#l7.321"></a><span id="l7.321"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/providers/gdata/public/calIGoogleRequest.idl</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/providers/gdata/public/calIGoogleRequest.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -102,16 +102,17 @@ interface calIGoogleRequest : calIOperat</span>
<a href="#l8.4"></a><span id="l8.4">      * XXX The corresponding options are not set up automatically just by</span>
<a href="#l8.5"></a><span id="l8.5">      * setting these options. You still need to use addQueryParameter to filter</span>
<a href="#l8.6"></a><span id="l8.6">      * by item range or other property.</span>
<a href="#l8.7"></a><span id="l8.7">      */</span>
<a href="#l8.8"></a><span id="l8.8">     attribute calIDateTime itemRangeStart;</span>
<a href="#l8.9"></a><span id="l8.9">     attribute calIDateTime itemRangeEnd;</span>
<a href="#l8.10"></a><span id="l8.10">     attribute unsigned long itemFilter;</span>
<a href="#l8.11"></a><span id="l8.11">     attribute AUTF8String itemId;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    attribute boolean useCache;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14">     /**</span>
<a href="#l8.15"></a><span id="l8.15">      * For add/modify/delete item requests, these contain the old and new items.</span>
<a href="#l8.16"></a><span id="l8.16">      */</span>
<a href="#l8.17"></a><span id="l8.17">     attribute calIItemBase newItem;</span>
<a href="#l8.18"></a><span id="l8.18">     attribute calIItemBase oldItem;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">     /**</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

