<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26430:33f38e5bef3517802c7fc5a4c973f8c653ad1cee</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 33f38e5bef3517802c7fc5a4c973f8c653ad1cee" />
<meta property="og:url" content="/comm-central/rev/33f38e5bef3517802c7fc5a4c973f8c653ad1cee" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/local. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 33f38e5bef3517802c7fc5a4c973f8c653ad1cee 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">shortlog</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">files</a> |
changeset |
<a href="/comm-central/raw-rev/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">raw</a>  | <a href="/comm-central/archive/33f38e5bef3517802c7fc5a4c973f8c653ad1cee.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/local. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 16:33:09 +0200</td></tr>

<tr>
 <td>changeset 26430</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/33f38e5bef3517802c7fc5a4c973f8c653ad1cee">33f38e5bef3517802c7fc5a4c973f8c653ad1cee</a></td>
</tr>



<tr>
<td>parent 26429</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d2800cf831c17f139a01dcb98bfb94b6447ad2d2">d2800cf831c17f139a01dcb98bfb94b6447ad2d2</a>
</td>
</tr>

<tr>
<td>child 26431</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2d54904493f8b8e1252d720a869c741c0f11fe0b">2d54904493f8b8e1252d720a869c741c0f11fe0b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=33f38e5bef3517802c7fc5a4c973f8c653ad1cee">15831</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Apr 2019 14:40:57 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2d54904493f8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2d54904493f8b8e1252d720a869c741c0f11fe0b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2d54904493f8b8e1252d720a869c741c0f11fe0b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d54904493f8b8e1252d720a869c741c0f11fe0b&newProject=comm-central&newRevision=d9de9c99bf922c2ee88afb525723eac2bf62a54e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d54904493f8b8e1252d720a869c741c0f11fe0b&newProject=comm-central&newRevision=d9de9c99bf922c2ee88afb525723eac2bf62a54e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2d54904493f8b8e1252d720a869c741c0f11fe0b&newProject=comm-central&newRevision=d9de9c99bf922c2ee88afb525723eac2bf62a54e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/local. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/public/nsMsgLocalCID.h">mailnews/local/public/nsMsgLocalCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/public/nsMsgLocalCID.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/public/nsMsgLocalCID.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/public/nsMsgLocalCID.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/public/nsMsgLocalCID.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/public/nsMsgLocalCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.cpp">mailnews/local/src/nsLocalUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.h">mailnews/local/src/nsLocalUndoTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUndoTxn.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.cpp">mailnews/local/src/nsLocalUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.h">mailnews/local/src/nsLocalUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsLocalUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.h">mailnews/local/src/nsMailboxProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.cpp">mailnews/local/src/nsMailboxServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.h">mailnews/local/src/nsMailboxServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.cpp">mailnews/local/src/nsMailboxService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.h">mailnews/local/src/nsMailboxService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.cpp">mailnews/local/src/nsMailboxUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.h">mailnews/local/src/nsMailboxUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMailboxUrl.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.cpp">mailnews/local/src/nsMovemailIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.h">mailnews/local/src/nsMovemailIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.cpp">mailnews/local/src/nsMovemailService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.h">mailnews/local/src/nsMovemailService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMovemailService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.cpp">mailnews/local/src/nsMsgBrkMBoxStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.h">mailnews/local/src/nsMsgBrkMBoxStore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgBrkMBoxStore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.cpp">mailnews/local/src/nsMsgLocalStoreUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.h">mailnews/local/src/nsMsgLocalStoreUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgLocalStoreUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.h">mailnews/local/src/nsMsgMaildirStore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsMsgMaildirStore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.cpp">mailnews/local/src/nsNoIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.h">mailnews/local/src/nsNoIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.cpp">mailnews/local/src/nsNoneService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.h">mailnews/local/src/nsNoneService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsNoneService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.h">mailnews/local/src/nsParseMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsParseMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.h">mailnews/local/src/nsPop3IncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3IncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.h">mailnews/local/src/nsPop3Protocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Protocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.cpp">mailnews/local/src/nsPop3Service.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.h">mailnews/local/src/nsPop3Service.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Service.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.h">mailnews/local/src/nsPop3Sink.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3Sink.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.cpp">mailnews/local/src/nsPop3URL.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.h">mailnews/local/src/nsPop3URL.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsPop3URL.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.cpp">mailnews/local/src/nsRssIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.h">mailnews/local/src/nsRssIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.cpp">mailnews/local/src/nsRssService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.cpp">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.cpp">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.cpp">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.cpp">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.h">mailnews/local/src/nsRssService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.h">file</a> |
<a href="/comm-central/annotate/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.h">annotate</a> |
<a href="/comm-central/diff/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.h">diff</a> |
<a href="/comm-central/comparison/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.h">comparison</a> |
<a href="/comm-central/log/33f38e5bef3517802c7fc5a4c973f8c653ad1cee/mailnews/local/src/nsRssService.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/local/public/nsMsgLocalCID.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/local/public/nsMsgLocalCID.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -10,224 +10,243 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> #define NS_POP3INCOMINGSERVER_TYPE &quot;pop3&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> //</span>
<a href="#l1.8"></a><span id="l1.8"> // nsLocalMailFolderResourceCID</span>
<a href="#l1.9"></a><span id="l1.9"> //</span>
<a href="#l1.10"></a><span id="l1.10"> #define NS_LOCALMAILFOLDERRESOURCE_CONTRACTID \</span>
<a href="#l1.11"></a><span id="l1.11">   NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX &quot;mailbox&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#define  NS_LOCALMAILFOLDERRESOURCE_CID              \</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{ /* e490d22c-cd67-11d2-8cca-0060b0fc14a3 */         \</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  0xe490d22c,                     \</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    0xcd67,                                          \</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    0x11d2,                                          \</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    {0x8c, 0xca, 0x00, 0x60, 0xb0, 0xfc, 0x14, 0xa3} \</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-}</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+#define NS_LOCALMAILFOLDERRESOURCE_CID               \</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+  { /* e490d22c-cd67-11d2-8cca-0060b0fc14a3 */       \</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    0xe490d22c, 0xcd67, 0x11d2, {                    \</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+      0x8c, 0xca, 0x00, 0x60, 0xb0, 0xfc, 0x14, 0xa3 \</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    }                                                \</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  }</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> //</span>
<a href="#l1.27"></a><span id="l1.27"> // nsPop3IncomingServer</span>
<a href="#l1.28"></a><span id="l1.28"> //</span>
<a href="#l1.29"></a><span id="l1.29"> #define NS_POP3INCOMINGSERVER_CONTRACTID \</span>
<a href="#l1.30"></a><span id="l1.30">   NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX NS_POP3INCOMINGSERVER_TYPE</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> #define NS_POP3INCOMINGSERVER_CID                  \</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-{ /* D2876E51-E62C-11d2-B7FC-00805F05FFA5 */      \</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">- 0xd2876e51, 0xe62c, 0x11d2,                      \</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">- {0xb7, 0xfc, 0x0, 0x80, 0x5f, 0x5, 0xff, 0xa5 }}</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+  { /* D2876E51-E62C-11d2-B7FC-00805F05FFA5 */     \</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    0xd2876e51, 0xe62c, 0x11d2, {                  \</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+      0xb7, 0xfc, 0x0, 0x80, 0x5f, 0x5, 0xff, 0xa5 \</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    }                                              \</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l1.43"></a><span id="l1.43"> //</span>
<a href="#l1.44"></a><span id="l1.44"> // nsMovemailIncomingServer</span>
<a href="#l1.45"></a><span id="l1.45"> //</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-#define NS_MOVEMAILINCOMINGSERVER_CONTRACTID \</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX &quot;movemail&quot;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+#  define NS_MOVEMAILINCOMINGSERVER_CONTRACTID \</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX &quot;movemail&quot;</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-#define NS_MOVEMAILINCOMINGSERVER_CID                  \</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-{ /* efbb77e4-1dd2-11b2-bbcf-961563396fec */      \</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">- 0xefbb77e4, 0x1dd2, 0x11b2,                      \</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">- {0xbb, 0xcf, 0x96, 0x15, 0x63, 0x39, 0x6f, 0xec }}</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+#  define NS_MOVEMAILINCOMINGSERVER_CID                \</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    { /* efbb77e4-1dd2-11b2-bbcf-961563396fec */       \</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      0xefbb77e4, 0x1dd2, 0x11b2, {                    \</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+        0xbb, 0xcf, 0x96, 0x15, 0x63, 0x39, 0x6f, 0xec \</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+      }                                                \</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    }</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64"> //</span>
<a href="#l1.65"></a><span id="l1.65"> // nsNoIncomingServer</span>
<a href="#l1.66"></a><span id="l1.66"> //</span>
<a href="#l1.67"></a><span id="l1.67"> #define NS_NOINCOMINGSERVER_CONTRACTID \</span>
<a href="#l1.68"></a><span id="l1.68">   NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX &quot;none&quot;</span>
<a href="#l1.69"></a><span id="l1.69"> </span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-#define NS_NOINCOMINGSERVER_CID              \</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-{ /* {ca5ffe7e-5f47-11d3-9a51-004005263078} */  \</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-  0xca5ffe7e, 0x5f47, 0x11d3,       \</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-  {0x9a, 0x51, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78}}</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+#define NS_NOINCOMINGSERVER_CID                      \</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  { /* {ca5ffe7e-5f47-11d3-9a51-004005263078} */     \</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+    0xca5ffe7e, 0x5f47, 0x11d3, {                    \</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+      0x9a, 0x51, 0x00, 0x40, 0x05, 0x26, 0x30, 0x78 \</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    }                                                \</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  }</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82"> //</span>
<a href="#l1.83"></a><span id="l1.83"> // nsMsgMailboxService</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-#define NS_MAILBOXSERVICE_CONTRACTID1  \</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  &quot;@mozilla.org/messenger/mailboxservice;1&quot;</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+#define NS_MAILBOXSERVICE_CONTRACTID1 &quot;@mozilla.org/messenger/mailboxservice;1&quot;</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88"> #define NS_MAILBOXSERVICE_CONTRACTID2 \</span>
<a href="#l1.89"></a><span id="l1.89">   &quot;@mozilla.org/messenger/messageservice;1?type=mailbox&quot;</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91"> #define NS_MAILBOXSERVICE_CONTRACTID3 \</span>
<a href="#l1.92"></a><span id="l1.92">   &quot;@mozilla.org/messenger/messageservice;1?type=mailbox-message&quot;</span>
<a href="#l1.93"></a><span id="l1.93"> </span>
<a href="#l1.94"></a><span id="l1.94"> #define NS_MAILBOXSERVICE_CONTRACTID4 \</span>
<a href="#l1.95"></a><span id="l1.95">   NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;mailbox&quot;</span>
<a href="#l1.96"></a><span id="l1.96"> </span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-#define NS_MAILBOXSERVICE_CID                         \</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-{ /* EEF82462-CB69-11d2-8065-006008128C4E */      \</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">- 0xeef82462, 0xcb69, 0x11d2,                      \</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">- {0x80, 0x65, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e}}</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+#define NS_MAILBOXSERVICE_CID                      \</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  { /* EEF82462-CB69-11d2-8065-006008128C4E */     \</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+    0xeef82462, 0xcb69, 0x11d2, {                  \</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+      0x80, 0x65, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+    }                                              \</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+  }</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> //</span>
<a href="#l1.110"></a><span id="l1.110"> // nsMailboxUrl</span>
<a href="#l1.111"></a><span id="l1.111"> //</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-#define NS_MAILBOXURL_CONTRACTID  \</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-  &quot;@mozilla.org/messenger/mailboxurl;1&quot;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+#define NS_MAILBOXURL_CONTRACTID &quot;@mozilla.org/messenger/mailboxurl;1&quot;</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116"> /* 46EFCB10-CB6D-11d2-8065-006008128C4E */</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-#define NS_MAILBOXURL_CID                      \</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-{ 0x46efcb10, 0xcb6d, 0x11d2,                  \</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    { 0x80, 0x65, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e } }</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+#define NS_MAILBOXURL_CID                          \</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+  {                                                \</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+    0x46efcb10, 0xcb6d, 0x11d2, {                  \</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+      0x80, 0x65, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+    }                                              \</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+  }</span>
<a href="#l1.126"></a><span id="l1.126"> </span>
<a href="#l1.127"></a><span id="l1.127"> //</span>
<a href="#l1.128"></a><span id="l1.128"> // nsMsgMailNewsUrl</span>
<a href="#l1.129"></a><span id="l1.129"> //</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-#define NS_MSGMAILNEWSURL_CONTRACTID  \</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-  &quot;@mozilla.org/messenger/msgmailnewsurl;1&quot;</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+#define NS_MSGMAILNEWSURL_CONTRACTID &quot;@mozilla.org/messenger/msgmailnewsurl;1&quot;</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-#define NS_MSGMAILNEWSURL_CID \</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-{ 0x3fdae3ab, 0x4ac1, 0x4ad4, \</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-  { 0xb2, 0x8a, 0x28, 0xd0, 0xfa, 0x36, 0x39, 0x29 } }</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+#define NS_MSGMAILNEWSURL_CID                        \</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  {                                                  \</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+    0x3fdae3ab, 0x4ac1, 0x4ad4, {                    \</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+      0xb2, 0x8a, 0x28, 0xd0, 0xfa, 0x36, 0x39, 0x29 \</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+    }                                                \</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  }</span>
<a href="#l1.143"></a><span id="l1.143"> </span>
<a href="#l1.144"></a><span id="l1.144"> //</span>
<a href="#l1.145"></a><span id="l1.145"> // nsPop3Url</span>
<a href="#l1.146"></a><span id="l1.146"> //</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-#define NS_POP3URL_CONTRACTID \</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-  &quot;@mozilla.org/messenger/popurl;1&quot;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+#define NS_POP3URL_CONTRACTID &quot;@mozilla.org/messenger/popurl;1&quot;</span>
<a href="#l1.150"></a><span id="l1.150"> </span>
<a href="#l1.151"></a><span id="l1.151"> /* EA1B0A11-E6F4-11d2-8070-006008128C4E */</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-#define NS_POP3URL_CID                         \</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-{ 0xea1b0a11, 0xe6f4, 0x11d2,                   \</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-    { 0x80, 0x70, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e } }</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+#define NS_POP3URL_CID                             \</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  {                                                \</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    0xea1b0a11, 0xe6f4, 0x11d2, {                  \</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+      0x80, 0x70, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    }                                              \</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  }</span>
<a href="#l1.162"></a><span id="l1.162"> </span>
<a href="#l1.163"></a><span id="l1.163"> //</span>
<a href="#l1.164"></a><span id="l1.164"> // nsPop3Service</span>
<a href="#l1.165"></a><span id="l1.165"> //</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-#define NS_POP3SERVICE_CONTRACTID1 \</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  &quot;@mozilla.org/messenger/popservice;1&quot;</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+#define NS_POP3SERVICE_CONTRACTID1 &quot;@mozilla.org/messenger/popservice;1&quot;</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-#define NS_POP3SERVICE_CONTRACTID2 \</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-  NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;pop&quot;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+#define NS_POP3SERVICE_CONTRACTID2 NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;pop&quot;</span>
<a href="#l1.174"></a><span id="l1.174"> </span>
<a href="#l1.175"></a><span id="l1.175"> // Mailnews has used &quot;pop&quot; as the protocol scheme for pop3 in some places,</span>
<a href="#l1.176"></a><span id="l1.176"> // but &quot;pop3&quot; in others. Necko code needs to be able to locate protocolInfo</span>
<a href="#l1.177"></a><span id="l1.177"> // based on pop3 to get proxy information.</span>
<a href="#l1.178"></a><span id="l1.178"> //</span>
<a href="#l1.179"></a><span id="l1.179"> // TODO: fix the mailnews code to use a consistent POP3 protocol scheme.</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-#define NS_POP3SERVICE_CONTRACTID3 \</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;pop3&quot;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+#define NS_POP3SERVICE_CONTRACTID3 NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;pop3&quot;</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185"> #define NS_POP3PROTOCOLINFO_CONTRACTID \</span>
<a href="#l1.186"></a><span id="l1.186">   NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX NS_POP3INCOMINGSERVER_TYPE</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-#define NS_POP3SERVICE_CID                \</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-{ /* 3BB459E3-D746-11d2-806A-006008128C4E */      \</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">- 0x3bb459e3, 0xd746, 0x11d2,              \</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-  { 0x80, 0x6a, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e }}</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+#define NS_POP3SERVICE_CID                         \</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+  { /* 3BB459E3-D746-11d2-806A-006008128C4E */     \</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+    0x3bb459e3, 0xd746, 0x11d2, {                  \</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+      0x80, 0x6a, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+    }                                              \</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+  }</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199"> //</span>
<a href="#l1.200"></a><span id="l1.200"> // nsNoneService</span>
<a href="#l1.201"></a><span id="l1.201"> //</span>
<a href="#l1.202"></a><span id="l1.202"> </span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-#define NS_NONESERVICE_CONTRACTID \</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  &quot;@mozilla.org/messenger/noneservice;1&quot;</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+#define NS_NONESERVICE_CONTRACTID &quot;@mozilla.org/messenger/noneservice;1&quot;</span>
<a href="#l1.206"></a><span id="l1.206"> </span>
<a href="#l1.207"></a><span id="l1.207"> #define NS_NONEPROTOCOLINFO_CONTRACTID \</span>
<a href="#l1.208"></a><span id="l1.208">   NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX &quot;none&quot;</span>
<a href="#l1.209"></a><span id="l1.209"> </span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-#define NS_NONESERVICE_CID                \</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-{ /* 75b63b46-1dd2-11b2-9873-bb375e1550fa */      \</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">- 0x75b63b46, 0x1dd2, 0x11b2,              \</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">- { 0x98, 0x73, 0xbb, 0x37, 0x5e, 0x15, 0x50, 0xfa }}</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+#define NS_NONESERVICE_CID                           \</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  { /* 75b63b46-1dd2-11b2-9873-bb375e1550fa */       \</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+    0x75b63b46, 0x1dd2, 0x11b2, {                    \</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+      0x98, 0x73, 0xbb, 0x37, 0x5e, 0x15, 0x50, 0xfa \</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+    }                                                \</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+  }</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l1.222"></a><span id="l1.222"> //</span>
<a href="#l1.223"></a><span id="l1.223"> // nsMovemailService</span>
<a href="#l1.224"></a><span id="l1.224"> //</span>
<a href="#l1.225"></a><span id="l1.225"> </span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-#define NS_MOVEMAILSERVICE_CONTRACTID \</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-  &quot;@mozilla.org/messenger/movemailservice;1&quot;</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+#  define NS_MOVEMAILSERVICE_CONTRACTID \</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+    &quot;@mozilla.org/messenger/movemailservice;1&quot;</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+#  define NS_MOVEMAILPROTOCOLINFO_CONTRACTID \</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+    NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX &quot;movemail&quot;</span>
<a href="#l1.233"></a><span id="l1.233"> </span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-#define NS_MOVEMAILPROTOCOLINFO_CONTRACTID \</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-  NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX &quot;movemail&quot;</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-#define NS_MOVEMAILSERVICE_CID                \</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-{ /* 0e4db62e-1dd2-11b2-a5e4-f128fe4f1b69 */      \</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">- 0x0e4db62e, 0x1dd2, 0x11b2,              \</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">- { 0xa5, 0xe4, 0xf1, 0x28, 0xfe, 0x4f, 0x1b, 0x69 }}</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+#  define NS_MOVEMAILSERVICE_CID                       \</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+    { /* 0e4db62e-1dd2-11b2-a5e4-f128fe4f1b69 */       \</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+      0x0e4db62e, 0x1dd2, 0x11b2, {                    \</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+        0xa5, 0xe4, 0xf1, 0x28, 0xfe, 0x4f, 0x1b, 0x69 \</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+      }                                                \</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+    }</span>
<a href="#l1.247"></a><span id="l1.247"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l1.248"></a><span id="l1.248"> </span>
<a href="#l1.249"></a><span id="l1.249"> //</span>
<a href="#l1.250"></a><span id="l1.250"> // nsParseMailMsgState</span>
<a href="#l1.251"></a><span id="l1.251"> //</span>
<a href="#l1.252"></a><span id="l1.252"> #define NS_PARSEMAILMSGSTATE_CONTRACTID \</span>
<a href="#l1.253"></a><span id="l1.253">   &quot;@mozilla.org/messenger/messagestateparser;1&quot;</span>
<a href="#l1.254"></a><span id="l1.254"> </span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-#define NS_PARSEMAILMSGSTATE_CID \</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-{ /* 2B79AC51-1459-11d3-8097-006008128C4E */ \</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">- 0x2b79ac51, 0x1459, 0x11d3, \</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-  {0x80, 0x97, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e} }</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+#define NS_PARSEMAILMSGSTATE_CID                   \</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+  { /* 2B79AC51-1459-11d3-8097-006008128C4E */     \</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+    0x2b79ac51, 0x1459, 0x11d3, {                  \</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+      0x80, 0x97, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+    }                                              \</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+  }</span>
<a href="#l1.265"></a><span id="l1.265"> </span>
<a href="#l1.266"></a><span id="l1.266"> //</span>
<a href="#l1.267"></a><span id="l1.267"> // nsMsgMailboxParser</span>
<a href="#l1.268"></a><span id="l1.268"> //</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-#define NS_MAILBOXPARSER_CONTRACTID \</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-  &quot;@mozilla.org/messenger/mailboxparser;1&quot;</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+#define NS_MAILBOXPARSER_CONTRACTID &quot;@mozilla.org/messenger/mailboxparser;1&quot;</span>
<a href="#l1.273"></a><span id="l1.273"> </span>
<a href="#l1.274"></a><span id="l1.274"> /* 46EFCB10-CB6D-11d2-8065-006008128C4E */</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-#define NS_MAILBOXPARSER_CID                      \</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-{ 0x8597ab60, 0xd4e2, 0x11d2,                  \</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-    { 0x80, 0x69, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e } }</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+#define NS_MAILBOXPARSER_CID                       \</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+  {                                                \</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+    0x8597ab60, 0xd4e2, 0x11d2, {                  \</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+      0x80, 0x69, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+    }                                              \</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+  }</span>
<a href="#l1.284"></a><span id="l1.284"> </span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-#define NS_RSSSERVICE_CONTRACTID \</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-  &quot;@mozilla.org/messenger/rssservice;1&quot;</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+#define NS_RSSSERVICE_CONTRACTID &quot;@mozilla.org/messenger/rssservice;1&quot;</span>
<a href="#l1.288"></a><span id="l1.288"> </span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-#define NS_RSSPROTOCOLINFO_CONTRACTID \</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-  NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX &quot;rss&quot;</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+#define NS_RSSPROTOCOLINFO_CONTRACTID NS_MSGPROTOCOLINFO_CONTRACTID_PREFIX &quot;rss&quot;</span>
<a href="#l1.292"></a><span id="l1.292"> </span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-#define NS_RSSSERVICE_CID                \</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-{ /* 44aef4ce-475b-42e3-bc42-7730d5ce7365 */      \</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">- 0x44aef4ce, 0x475b, 0x42e3,              \</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">- { 0xbc, 0x42, 0x77, 0x30, 0xd5, 0xce, 0x73, 0x65 }}</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+#define NS_RSSSERVICE_CID                            \</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+  { /* 44aef4ce-475b-42e3-bc42-7730d5ce7365 */       \</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    0x44aef4ce, 0x475b, 0x42e3, {                    \</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+      0xbc, 0x42, 0x77, 0x30, 0xd5, 0xce, 0x73, 0x65 \</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+    }                                                \</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+  }</span>
<a href="#l1.303"></a><span id="l1.303"> </span>
<a href="#l1.304"></a><span id="l1.304"> #define NS_RSSINCOMINGSERVER_CONTRACTID \</span>
<a href="#l1.305"></a><span id="l1.305">   NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX &quot;rss&quot;</span>
<a href="#l1.306"></a><span id="l1.306"> </span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-#define NS_RSSINCOMINGSERVER_CID                  \</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-{ /* 3a874285-5520-41a0-bcda-a3dee3dbf4f3 */      \</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">- 0x3a874285, 0x5520, 0x41a0,                      \</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">- {0xbc, 0xda, 0xa3, 0xde, 0xe3, 0xdb, 0xf4, 0xf3 }}</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-#define NS_BRKMBOXSTORE_CID \</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-{ /* 36358199-a0e4-4b68-929f-77c01de34c67 */ \</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">- 0x36358199, 0xa0e4, 0x4b68, \</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">- {0x92, 0x9f, 0x77, 0xc0, 0x1d, 0xe3, 0x4c, 0x67}}</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+#define NS_RSSINCOMINGSERVER_CID                     \</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+  { /* 3a874285-5520-41a0-bcda-a3dee3dbf4f3 */       \</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+    0x3a874285, 0x5520, 0x41a0, {                    \</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+      0xbc, 0xda, 0xa3, 0xde, 0xe3, 0xdb, 0xf4, 0xf3 \</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+    }                                                \</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+  }</span>
<a href="#l1.322"></a><span id="l1.322"> </span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-#define NS_BRKMBOXSTORE_CONTRACTID \</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-  &quot;@mozilla.org/msgstore/berkeleystore;1&quot;</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+#define NS_BRKMBOXSTORE_CID                          \</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+  { /* 36358199-a0e4-4b68-929f-77c01de34c67 */       \</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+    0x36358199, 0xa0e4, 0x4b68, {                    \</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+      0x92, 0x9f, 0x77, 0xc0, 0x1d, 0xe3, 0x4c, 0x67 \</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+    }                                                \</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+  }</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+#define NS_BRKMBOXSTORE_CONTRACTID &quot;@mozilla.org/msgstore/berkeleystore;1&quot;</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-#define NS_MAILDIRSTORE_CID \</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-{ /* 1F993EDA-7DD9-11DF-819A-6257DFD72085 */ \</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">- 0x1F993EDA, 0x7DD9, 0x11DF, \</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">- { 0x81, 0x9A, 0x62, 0x57, 0xDF, 0xD7, 0x20, 0x85 }}</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+#define NS_MAILDIRSTORE_CID                          \</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+  { /* 1F993EDA-7DD9-11DF-819A-6257DFD72085 */       \</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+    0x1F993EDA, 0x7DD9, 0x11DF, {                    \</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+      0x81, 0x9A, 0x62, 0x57, 0xDF, 0xD7, 0x20, 0x85 \</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+    }                                                \</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+  }</span>
<a href="#l1.344"></a><span id="l1.344"> </span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-#define NS_MAILDIRSTORE_CONTRACTID \</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+#define NS_MAILDIRSTORE_CONTRACTID &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l1.348"></a><span id="l1.348"> </span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-#endif // nsMsgLocalCID_h__</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+#endif  // nsMsgLocalCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;prlog.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsLocalMailFolder.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;prprf.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;prmem.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21"> #include &quot;nsIArray.h&quot;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -58,341 +58,292 @@</span>
<a href="#l2.23"></a><span id="l2.23"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l2.24"></a><span id="l2.24"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l2.25"></a><span id="l2.25"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.28"></a><span id="l2.28"> // nsLocal</span>
<a href="#l2.29"></a><span id="l2.29"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-nsLocalMailCopyState::nsLocalMailCopyState() :</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  m_flags(0),</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  m_lastProgressTime(PR_IntervalToMilliseconds(PR_IntervalNow())),</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  m_curDstKey(nsMsgKey_None),</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  m_curCopyIndex(0),</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  m_totalMsgCount(0),</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  m_dataBufferSize(0),</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  m_leftOver(0),</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  m_isMove(false),</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  m_dummyEnvelopeNeeded(false),</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  m_fromLineSeen(false),</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-  m_writeFailed(false),</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-  m_notifyFolderLoaded(false)</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-{</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-}</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-nsLocalMailCopyState::~nsLocalMailCopyState()</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-{</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+nsLocalMailCopyState::nsLocalMailCopyState()</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    : m_flags(0),</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      m_lastProgressTime(PR_IntervalToMilliseconds(PR_IntervalNow())),</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+      m_curDstKey(nsMsgKey_None),</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+      m_curCopyIndex(0),</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+      m_totalMsgCount(0),</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+      m_dataBufferSize(0),</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+      m_leftOver(0),</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+      m_isMove(false),</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+      m_dummyEnvelopeNeeded(false),</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+      m_fromLineSeen(false),</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+      m_writeFailed(false),</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+      m_notifyFolderLoaded(false) {}</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+nsLocalMailCopyState::~nsLocalMailCopyState() {</span>
<a href="#l2.64"></a><span id="l2.64">   PR_Free(m_dataBuffer);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  if (m_fileStream)</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    m_fileStream-&gt;Close();</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  if (m_messageService)</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(m_srcSupport);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    if (srcFolder &amp;&amp; m_message)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  if (m_fileStream) m_fileStream-&gt;Close();</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  if (m_messageService) {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(m_srcSupport);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    if (srcFolder &amp;&amp; m_message) {</span>
<a href="#l2.76"></a><span id="l2.76">       nsCString uri;</span>
<a href="#l2.77"></a><span id="l2.77">       srcFolder-&gt;GetUriForMsg(m_message, uri);</span>
<a href="#l2.78"></a><span id="l2.78">     }</span>
<a href="#l2.79"></a><span id="l2.79">   }</span>
<a href="#l2.80"></a><span id="l2.80"> }</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-nsLocalFolderScanState::nsLocalFolderScanState() : m_uidl(nullptr)</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-{</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-}</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-nsLocalFolderScanState::~nsLocalFolderScanState()</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-{</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-}</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+nsLocalFolderScanState::nsLocalFolderScanState() : m_uidl(nullptr) {}</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+nsLocalFolderScanState::~nsLocalFolderScanState() {}</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.94"></a><span id="l2.94"> // nsMsgLocalMailFolder interface</span>
<a href="#l2.95"></a><span id="l2.95"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97"> nsMsgLocalMailFolder::nsMsgLocalMailFolder(void)</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-  : mCopyState(nullptr), mHaveReadNameFromDB(false),</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-    mInitialized(false),</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    mCheckForNewMessagesAfterParsing(false), m_parsingFolder(false),</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    mDownloadState(DOWNLOAD_STATE_NONE)</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-{</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-}</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-nsMsgLocalMailFolder::~nsMsgLocalMailFolder(void)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-{</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-}</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsMsgLocalMailFolder,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-                             nsMsgDBFolder,</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-                             nsICopyMessageListener,</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-                             nsIMsgLocalMailFolder)</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    : mCopyState(nullptr),</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      mHaveReadNameFromDB(false),</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+      mInitialized(false),</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+      mCheckForNewMessagesAfterParsing(false),</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+      m_parsingFolder(false),</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+      mDownloadState(DOWNLOAD_STATE_NONE) {}</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+nsMsgLocalMailFolder::~nsMsgLocalMailFolder(void) {}</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsMsgLocalMailFolder, nsMsgDBFolder,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+                            nsICopyMessageListener, nsIMsgLocalMailFolder)</span>
<a href="#l2.124"></a><span id="l2.124"> </span>
<a href="#l2.125"></a><span id="l2.125"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.126"></a><span id="l2.126"> </span>
<a href="#l2.127"></a><span id="l2.127"> NS_IMETHODIMP</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-nsMsgLocalMailFolder::Init(const char* aURI)</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-{</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+nsMsgLocalMailFolder::Init(const char *aURI) {</span>
<a href="#l2.131"></a><span id="l2.131">   return nsMsgDBFolder::Init(aURI);</span>
<a href="#l2.132"></a><span id="l2.132"> }</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-nsresult nsMsgLocalMailFolder::CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder)</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-{</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+nsresult nsMsgLocalMailFolder::CreateChildFromURI(const nsCString &amp;uri,</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+                                                  nsIMsgFolder **folder) {</span>
<a href="#l2.138"></a><span id="l2.138">   nsMsgLocalMailFolder *newFolder = new nsMsgLocalMailFolder;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  if (!newFolder)</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+  if (!newFolder) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143">   NS_ADDREF(*folder = newFolder);</span>
<a href="#l2.144"></a><span id="l2.144">   newFolder-&gt;Init(uri.get());</span>
<a href="#l2.145"></a><span id="l2.145">   return NS_OK;</span>
<a href="#l2.146"></a><span id="l2.146"> }</span>
<a href="#l2.147"></a><span id="l2.147"> </span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::CreateLocalSubfolder(const nsAString &amp;aFolderName,</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-                                                         nsIMsgFolder **aChild)</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-{</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::CreateLocalSubfolder(</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    const nsAString &amp;aFolderName, nsIMsgFolder **aChild) {</span>
<a href="#l2.153"></a><span id="l2.153">   NS_ENSURE_ARG_POINTER(aChild);</span>
<a href="#l2.154"></a><span id="l2.154">   nsresult rv = CreateSubfolderInternal(aFolderName, nullptr, aChild);</span>
<a href="#l2.155"></a><span id="l2.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-    do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-  if (notifier)</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-    notifier-&gt;NotifyFolderAdded(*aChild);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+  if (notifier) notifier-&gt;NotifyFolderAdded(*aChild);</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164">   return NS_OK;</span>
<a href="#l2.165"></a><span id="l2.165"> }</span>
<a href="#l2.166"></a><span id="l2.166"> </span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetManyHeadersToDownload(bool *retval)</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-{</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetManyHeadersToDownload(bool *retval) {</span>
<a href="#l2.170"></a><span id="l2.170">   bool isLocked;</span>
<a href="#l2.171"></a><span id="l2.171">   // if the folder is locked, we're probably reparsing - let's build the</span>
<a href="#l2.172"></a><span id="l2.172">   // view when we've finished reparsing.</span>
<a href="#l2.173"></a><span id="l2.173">   GetLocked(&amp;isLocked);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-  if (isLocked)</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-  {</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  if (isLocked) {</span>
<a href="#l2.177"></a><span id="l2.177">     *retval = true;</span>
<a href="#l2.178"></a><span id="l2.178">     return NS_OK;</span>
<a href="#l2.179"></a><span id="l2.179">   }</span>
<a href="#l2.180"></a><span id="l2.180"> </span>
<a href="#l2.181"></a><span id="l2.181">   return nsMsgDBFolder::GetManyHeadersToDownload(retval);</span>
<a href="#l2.182"></a><span id="l2.182"> }</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-//run the url to parse the mailbox</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+// run the url to parse the mailbox</span>
<a href="#l2.186"></a><span id="l2.186"> NS_IMETHODIMP nsMsgLocalMailFolder::ParseFolder(nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-                                                nsIUrlListener *aListener)</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-{</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+                                                nsIUrlListener *aListener) {</span>
<a href="#l2.190"></a><span id="l2.190">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.191"></a><span id="l2.191">   nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.192"></a><span id="l2.192">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-  if (aListener != this)</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    mReparseListener = aListener;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+  if (aListener != this) mReparseListener = aListener;</span>
<a href="#l2.196"></a><span id="l2.196">   // if parsing is synchronous, we need to set m_parsingFolder to</span>
<a href="#l2.197"></a><span id="l2.197">   // true before starting. And we need to open the db before</span>
<a href="#l2.198"></a><span id="l2.198">   // setting m_parsingFolder to true.</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-//  OpenDatabase();</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+  //  OpenDatabase();</span>
<a href="#l2.201"></a><span id="l2.201">   rv = msgStore-&gt;RebuildIndex(this, mDatabase, aMsgWindow, this);</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    m_parsingFolder = true;</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+  if (NS_SUCCEEDED(rv)) m_parsingFolder = true;</span>
<a href="#l2.205"></a><span id="l2.205"> </span>
<a href="#l2.206"></a><span id="l2.206">   return rv;</span>
<a href="#l2.207"></a><span id="l2.207"> }</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209"> // this won't force a reparse of the folder if the db is invalid.</span>
<a href="#l2.210"></a><span id="l2.210"> NS_IMETHODIMP</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-nsMsgLocalMailFolder::GetMsgDatabase(nsIMsgDatabase** aMsgDatabase)</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-{</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+nsMsgLocalMailFolder::GetMsgDatabase(nsIMsgDatabase **aMsgDatabase) {</span>
<a href="#l2.214"></a><span id="l2.214">   return GetDatabaseWOReparse(aMsgDatabase);</span>
<a href="#l2.215"></a><span id="l2.215"> }</span>
<a href="#l2.216"></a><span id="l2.216"> </span>
<a href="#l2.217"></a><span id="l2.217"> NS_IMETHODIMP</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-nsMsgLocalMailFolder::GetSubFolders(nsISimpleEnumerator **aResult)</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-{</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-  if (!mInitialized)</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-  {</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+nsMsgLocalMailFolder::GetSubFolders(nsISimpleEnumerator **aResult) {</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+  if (!mInitialized) {</span>
<a href="#l2.224"></a><span id="l2.224">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.225"></a><span id="l2.225">     nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.226"></a><span id="l2.226">     NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.227"></a><span id="l2.227">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.228"></a><span id="l2.228">     // need to set this flag here to avoid infinite recursion</span>
<a href="#l2.229"></a><span id="l2.229">     mInitialized = true;</span>
<a href="#l2.230"></a><span id="l2.230">     rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.231"></a><span id="l2.231">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.232"></a><span id="l2.232">     // This should add all existing folders as sub-folders of this folder.</span>
<a href="#l2.233"></a><span id="l2.233">     rv = msgStore-&gt;DiscoverSubFolders(this, true);</span>
<a href="#l2.234"></a><span id="l2.234"> </span>
<a href="#l2.235"></a><span id="l2.235">     nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l2.236"></a><span id="l2.236">     rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-      return rv;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.240"></a><span id="l2.240"> </span>
<a href="#l2.241"></a><span id="l2.241">     bool directory;</span>
<a href="#l2.242"></a><span id="l2.242">     path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-    if (directory)</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-    {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    if (directory) {</span>
<a href="#l2.246"></a><span id="l2.246">       SetFlag(nsMsgFolderFlags::Mail | nsMsgFolderFlags::Elided |</span>
<a href="#l2.247"></a><span id="l2.247">               nsMsgFolderFlags::Directory);</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249">       bool isServer;</span>
<a href="#l2.250"></a><span id="l2.250">       GetIsServer(&amp;isServer);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-      if (isServer)</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+      if (isServer) {</span>
<a href="#l2.254"></a><span id="l2.254">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.255"></a><span id="l2.255">         rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.256"></a><span id="l2.256">         NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.257"></a><span id="l2.257"> </span>
<a href="#l2.258"></a><span id="l2.258">         nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer;</span>
<a href="#l2.259"></a><span id="l2.259">         localMailServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l2.260"></a><span id="l2.260">         NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.261"></a><span id="l2.261"> </span>
<a href="#l2.262"></a><span id="l2.262">         // first create the folders on disk (as empty files)</span>
<a href="#l2.263"></a><span id="l2.263">         rv = localMailServer-&gt;CreateDefaultMailboxes();</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-        if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_FOLDER_EXISTS)</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-          return rv;</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+        if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_FOLDER_EXISTS) return rv;</span>
<a href="#l2.267"></a><span id="l2.267"> </span>
<a href="#l2.268"></a><span id="l2.268">         // must happen after CreateSubFolders, or the folders won't exist.</span>
<a href="#l2.269"></a><span id="l2.269">         rv = localMailServer-&gt;SetFlagsOnDefaultMailboxes();</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-          return rv;</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.273"></a><span id="l2.273">       }</span>
<a href="#l2.274"></a><span id="l2.274">     }</span>
<a href="#l2.275"></a><span id="l2.275">     UpdateSummaryTotals(false);</span>
<a href="#l2.276"></a><span id="l2.276">   }</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-  return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders, NS_GET_IID(nsIMsgFolder)) : NS_ERROR_NULL_POINTER;</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+  return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders,</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+                                         NS_GET_IID(nsIMsgFolder))</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+                 : NS_ERROR_NULL_POINTER;</span>
<a href="#l2.282"></a><span id="l2.282"> }</span>
<a href="#l2.283"></a><span id="l2.283"> </span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-nsresult nsMsgLocalMailFolder::GetDatabase()</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-{</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+nsresult nsMsgLocalMailFolder::GetDatabase() {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.289"></a><span id="l2.289">   return GetDatabaseWOReparse(getter_AddRefs(msgDB));</span>
<a href="#l2.290"></a><span id="l2.290"> }</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-//we treat failure as null db returned</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetDatabaseWOReparse(nsIMsgDatabase **aDatabase)</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-{</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+// we treat failure as null db returned</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetDatabaseWOReparse(</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    nsIMsgDatabase **aDatabase) {</span>
<a href="#l2.298"></a><span id="l2.298">   NS_ENSURE_ARG(aDatabase);</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-  if (m_parsingFolder)</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-    return NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+  if (m_parsingFolder) return NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l2.302"></a><span id="l2.302"> </span>
<a href="#l2.303"></a><span id="l2.303">   nsresult rv = NS_OK;</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-  {</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l2.307"></a><span id="l2.307">     rv = OpenDatabase();</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-    if (mDatabase)</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-    {</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+    if (mDatabase) {</span>
<a href="#l2.311"></a><span id="l2.311">       mDatabase-&gt;AddListener(this);</span>
<a href="#l2.312"></a><span id="l2.312">       UpdateNewMessages();</span>
<a href="#l2.313"></a><span id="l2.313">     }</span>
<a href="#l2.314"></a><span id="l2.314">   }</span>
<a href="#l2.315"></a><span id="l2.315">   NS_IF_ADDREF(*aDatabase = mDatabase);</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-  if (mDatabase)</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-    mDatabase-&gt;SetLastUseTime(PR_Now());</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+  if (mDatabase) mDatabase-&gt;SetLastUseTime(PR_Now());</span>
<a href="#l2.319"></a><span id="l2.319">   return rv;</span>
<a href="#l2.320"></a><span id="l2.320"> }</span>
<a href="#l2.321"></a><span id="l2.321"> </span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-</span>
<a href="#l2.323"></a><span id="l2.323"> // Makes sure the database is open and exists.  If the database is out of date,</span>
<a href="#l2.324"></a><span id="l2.324"> // then this call will run an async url to reparse the folder. The passed in</span>
<a href="#l2.325"></a><span id="l2.325"> // url listener will get called when the url is done.</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetDatabaseWithReparse(nsIUrlListener *aReparseUrlListener, nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-                                                           nsIMsgDatabase **aMsgDatabase)</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-{</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetDatabaseWithReparse(</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+    nsIUrlListener *aReparseUrlListener, nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+    nsIMsgDatabase **aMsgDatabase) {</span>
<a href="#l2.332"></a><span id="l2.332">   nsresult rv = NS_OK;</span>
<a href="#l2.333"></a><span id="l2.333">   // if we're already reparsing, just remember the listener so we can notify it</span>
<a href="#l2.334"></a><span id="l2.334">   // when we've finished.</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-  if (m_parsingFolder)</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-  {</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  if (m_parsingFolder) {</span>
<a href="#l2.338"></a><span id="l2.338">     NS_ASSERTION(!mReparseListener, &quot;can't have an existing listener&quot;);</span>
<a href="#l2.339"></a><span id="l2.339">     mReparseListener = aReparseUrlListener;</span>
<a href="#l2.340"></a><span id="l2.340">     return NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l2.341"></a><span id="l2.341">   }</span>
<a href="#l2.342"></a><span id="l2.342"> </span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-  {</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; pathFile;</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l2.348"></a><span id="l2.348">     rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-      return rv;</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.352"></a><span id="l2.352"> </span>
<a href="#l2.353"></a><span id="l2.353">     bool exists;</span>
<a href="#l2.354"></a><span id="l2.354">     rv = pathFile-&gt;Exists(&amp;exists);</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.357"></a><span id="l2.357">     if (!exists)</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-      return NS_ERROR_NULL_POINTER;  //mDatabase will be null at this point.</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+      return NS_ERROR_NULL_POINTER;  // mDatabase will be null at this point.</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.365"></a><span id="l2.365">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.366"></a><span id="l2.366"> </span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-    nsresult folderOpen = msgDBService-&gt;OpenFolderDB(this, true,</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-                                                     getter_AddRefs(mDatabase));</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-    if (folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-    {</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-      nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-      nsCOMPtr &lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-      if (mDatabase)</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-      {</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+    nsresult folderOpen =</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+        msgDBService-&gt;OpenFolderDB(this, true, getter_AddRefs(mDatabase));</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+    if (folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) {</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+      if (mDatabase) {</span>
<a href="#l2.381"></a><span id="l2.381">         mDatabase-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-        if (dbFolderInfo)</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-        {</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+        if (dbFolderInfo) {</span>
<a href="#l2.385"></a><span id="l2.385">           dbFolderInfo-&gt;SetNumMessages(0);</span>
<a href="#l2.386"></a><span id="l2.386">           dbFolderInfo-&gt;SetNumUnreadMessages(0);</span>
<a href="#l2.387"></a><span id="l2.387">           dbFolderInfo-&gt;GetTransferInfo(getter_AddRefs(transferInfo));</span>
<a href="#l2.388"></a><span id="l2.388">         }</span>
<a href="#l2.389"></a><span id="l2.389">         dbFolderInfo = nullptr;</span>
<a href="#l2.390"></a><span id="l2.390"> </span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-        // A backup message database might have been created earlier, for example</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-        // if the user requested a reindex. We'll use the earlier one if we can,</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-        // otherwise we'll try to backup at this point.</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-        if (NS_FAILED(OpenBackupMsgDatabase()))</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-        {</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+        // A backup message database might have been created earlier, for</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+        // example if the user requested a reindex. We'll use the earlier one if</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+        // we can, otherwise we'll try to backup at this point.</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+        if (NS_FAILED(OpenBackupMsgDatabase())) {</span>
<a href="#l2.400"></a><span id="l2.400">           CloseAndBackupFolderDB(EmptyCString());</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-          if (NS_FAILED(OpenBackupMsgDatabase()) &amp;&amp; mBackupDatabase)</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-          {</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+          if (NS_FAILED(OpenBackupMsgDatabase()) &amp;&amp; mBackupDatabase) {</span>
<a href="#l2.404"></a><span id="l2.404">             mBackupDatabase-&gt;RemoveListener(this);</span>
<a href="#l2.405"></a><span id="l2.405">             mBackupDatabase = nullptr;</span>
<a href="#l2.406"></a><span id="l2.406">           }</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-        }</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-        else</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+        } else</span>
<a href="#l2.410"></a><span id="l2.410">           mDatabase-&gt;ForceClosed();</span>
<a href="#l2.411"></a><span id="l2.411"> </span>
<a href="#l2.412"></a><span id="l2.412">         mDatabase = nullptr;</span>
<a href="#l2.413"></a><span id="l2.413">       }</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; summaryFile;</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; summaryFile;</span>
<a href="#l2.416"></a><span id="l2.416">       rv = GetSummaryFileLocation(pathFile, getter_AddRefs(summaryFile));</span>
<a href="#l2.417"></a><span id="l2.417">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.418"></a><span id="l2.418">       // Remove summary file.</span>
<a href="#l2.419"></a><span id="l2.419">       summaryFile-&gt;Remove(false);</span>
<a href="#l2.420"></a><span id="l2.420"> </span>
<a href="#l2.421"></a><span id="l2.421">       // if it's out of date then reopen with upgrade.</span>
<a href="#l2.422"></a><span id="l2.422">       rv = msgDBService-&gt;CreateNewDB(this, getter_AddRefs(mDatabase));</span>
<a href="#l2.423"></a><span id="l2.423">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.424"></a><span id="l2.424"> </span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-      if (transferInfo &amp;&amp; mDatabase)</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-      {</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+      if (transferInfo &amp;&amp; mDatabase) {</span>
<a href="#l2.428"></a><span id="l2.428">         SetDBTransferInfo(transferInfo);</span>
<a href="#l2.429"></a><span id="l2.429">         mDatabase-&gt;SetSummaryValid(false);</span>
<a href="#l2.430"></a><span id="l2.430">       }</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-    }</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-    else if (folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-    {</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+    } else if (folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING) {</span>
<a href="#l2.435"></a><span id="l2.435">       rv = msgDBService-&gt;CreateNewDB(this, getter_AddRefs(mDatabase));</span>
<a href="#l2.436"></a><span id="l2.436">     }</span>
<a href="#l2.437"></a><span id="l2.437"> </span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-    if (mDatabase)</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-    {</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-      if (mAddListener)</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-        mDatabase-&gt;AddListener(this);</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+    if (mDatabase) {</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+      if (mAddListener) mDatabase-&gt;AddListener(this);</span>
<a href="#l2.444"></a><span id="l2.444"> </span>
<a href="#l2.445"></a><span id="l2.445">       // if we have to regenerate the folder, run the parser url.</span>
<a href="#l2.446"></a><span id="l2.446">       if (folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING ||</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-          folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-      {</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-        if (NS_FAILED(rv = ParseFolder(aMsgWindow, aReparseUrlListener)))</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-        {</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-          if (rv == NS_MSG_FOLDER_BUSY)</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-          {</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-            mDatabase-&gt;RemoveListener(this);  //we need to null out the db so that parsing gets kicked off again.</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+          folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) {</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+        if (NS_FAILED(rv = ParseFolder(aMsgWindow, aReparseUrlListener))) {</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+          if (rv == NS_MSG_FOLDER_BUSY) {</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+            mDatabase-&gt;RemoveListener(</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+                this);  // we need to null out the db so that parsing gets</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+                        // kicked off again.</span>
<a href="#l2.460"></a><span id="l2.460">             mDatabase = nullptr;</span>
<a href="#l2.461"></a><span id="l2.461">             ThrowAlertMsg(&quot;parsingFolderFailed&quot;, aMsgWindow);</span>
<a href="#l2.462"></a><span id="l2.462">           }</span>
<a href="#l2.463"></a><span id="l2.463">           return rv;</span>
<a href="#l2.464"></a><span id="l2.464">         }</span>
<a href="#l2.465"></a><span id="l2.465"> </span>
<a href="#l2.466"></a><span id="l2.466">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l2.467"></a><span id="l2.467">       }</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineat">@@ -401,1109 +352,1010 @@ NS_IMETHODIMP nsMsgLocalMailFolder::GetD</span>
<a href="#l2.469"></a><span id="l2.469">       UpdateSummaryTotals(true);</span>
<a href="#l2.470"></a><span id="l2.470">     }</span>
<a href="#l2.471"></a><span id="l2.471">   }</span>
<a href="#l2.472"></a><span id="l2.472">   NS_IF_ADDREF(*aMsgDatabase = mDatabase);</span>
<a href="#l2.473"></a><span id="l2.473">   return rv;</span>
<a href="#l2.474"></a><span id="l2.474"> }</span>
<a href="#l2.475"></a><span id="l2.475"> </span>
<a href="#l2.476"></a><span id="l2.476"> NS_IMETHODIMP</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-nsMsgLocalMailFolder::UpdateFolder(nsIMsgWindow *aWindow)</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-{</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+nsMsgLocalMailFolder::UpdateFolder(nsIMsgWindow *aWindow) {</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l2.482"></a><span id="l2.482">   nsresult rv;</span>
<a href="#l2.483"></a><span id="l2.483"> </span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-  if (!PromptForMasterPasswordIfNecessary())</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-  //If we don't currently have a database, get it.  Otherwise, the folder has been updated (presumably this</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-  //changes when we download headers when opening inbox).  If it's updated, send NotifyFolderLoaded.</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-  if (!mDatabase)</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-  {</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+  if (!PromptForMasterPasswordIfNecessary()) return NS_ERROR_FAILURE;</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+  // If we don't currently have a database, get it.  Otherwise, the folder has</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+  // been updated (presumably this changes when we download headers when opening</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+  // inbox).  If it's updated, send NotifyFolderLoaded.</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+  if (!mDatabase) {</span>
<a href="#l2.497"></a><span id="l2.497">     // return of NS_ERROR_NOT_INITIALIZED means running parsing URL</span>
<a href="#l2.498"></a><span id="l2.498">     // We don't need the return value, and assigning it to mDatabase which</span>
<a href="#l2.499"></a><span id="l2.499">     // is already set internally leaks.</span>
<a href="#l2.500"></a><span id="l2.500">     nsCOMPtr&lt;nsIMsgDatabase&gt; returnedDb;</span>
<a href="#l2.501"></a><span id="l2.501">     rv = GetDatabaseWithReparse(this, aWindow, getter_AddRefs(returnedDb));</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-      NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-  }</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-  else</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-  {</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+    if (NS_SUCCEEDED(rv)) NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+  } else {</span>
<a href="#l2.509"></a><span id="l2.509">     bool valid;</span>
<a href="#l2.510"></a><span id="l2.510">     rv = mDatabase-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l2.511"></a><span id="l2.511">     // don't notify folder loaded or try compaction if db isn't valid</span>
<a href="#l2.512"></a><span id="l2.512">     // (we're probably reparsing or copying msgs to it)</span>
<a href="#l2.513"></a><span id="l2.513">     if (NS_SUCCEEDED(rv) &amp;&amp; valid)</span>
<a href="#l2.514"></a><span id="l2.514">       NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l2.515"></a><span id="l2.515">     else if (mCopyState)</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-      mCopyState-&gt;m_notifyFolderLoaded = true; //defer folder loaded notification</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-    else if (!m_parsingFolder)// if the db was already open, it's probably OK to load it if not parsing</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+      mCopyState-&gt;m_notifyFolderLoaded =</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+          true;                 // defer folder loaded notification</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+    else if (!m_parsingFolder)  // if the db was already open, it's probably OK</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+                                // to load it if not parsing</span>
<a href="#l2.522"></a><span id="l2.522">       NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l2.523"></a><span id="l2.523">   }</span>
<a href="#l2.524"></a><span id="l2.524">   bool filtersRun;</span>
<a href="#l2.525"></a><span id="l2.525">   bool hasNewMessages;</span>
<a href="#l2.526"></a><span id="l2.526">   GetHasNewMessages(&amp;hasNewMessages);</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-  if (mDatabase)</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-    ApplyRetentionSettings();</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineplus">+  if (mDatabase) ApplyRetentionSettings();</span>
<a href="#l2.530"></a><span id="l2.530">   // if we have new messages, try the filter plugins.</span>
<a href="#l2.531"></a><span id="l2.531">   if (NS_SUCCEEDED(rv) &amp;&amp; hasNewMessages)</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-    (void) CallFilterPlugins(aWindow, &amp;filtersRun);</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-  // Callers should rely on folder loaded event to ensure completion of loading. So we'll</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-  // return NS_OK even if parsing is still in progress</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-  if (rv == NS_ERROR_NOT_INITIALIZED)</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    (void)CallFilterPlugins(aWindow, &amp;filtersRun);</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+  // Callers should rely on folder loaded event to ensure completion of loading.</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+  // So we'll return NS_OK even if parsing is still in progress</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+  if (rv == NS_ERROR_NOT_INITIALIZED) rv = NS_OK;</span>
<a href="#l2.541"></a><span id="l2.541">   return rv;</span>
<a href="#l2.542"></a><span id="l2.542"> }</span>
<a href="#l2.543"></a><span id="l2.543"> </span>
<a href="#l2.544"></a><span id="l2.544"> NS_IMETHODIMP</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-nsMsgLocalMailFolder::GetMessages(nsISimpleEnumerator **result)</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineminus">-{</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+nsMsgLocalMailFolder::GetMessages(nsISimpleEnumerator **result) {</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.550"></a><span id="l2.550">   nsresult rv = GetDatabaseWOReparse(getter_AddRefs(msgDB));</span>
<a href="#l2.551"></a><span id="l2.551">   return NS_SUCCEEDED(rv) ? msgDB-&gt;EnumerateMessages(result) : rv;</span>
<a href="#l2.552"></a><span id="l2.552"> }</span>
<a href="#l2.553"></a><span id="l2.553"> </span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetFolderURL(nsACString&amp; aUrl)</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-{</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetFolderURL(nsACString &amp;aUrl) {</span>
<a href="#l2.557"></a><span id="l2.557">   nsresult rv;</span>
<a href="#l2.558"></a><span id="l2.558">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l2.559"></a><span id="l2.559">   rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineminus">-    return rv;</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.563"></a><span id="l2.563"> </span>
<a href="#l2.564"></a><span id="l2.564">   rv = NS_GetURLSpecFromFile(path, aUrl);</span>
<a href="#l2.565"></a><span id="l2.565">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.566"></a><span id="l2.566"> </span>
<a href="#l2.567"></a><span id="l2.567">   aUrl.Replace(0, strlen(&quot;file:&quot;), &quot;mailbox:&quot;);</span>
<a href="#l2.568"></a><span id="l2.568"> </span>
<a href="#l2.569"></a><span id="l2.569">   return NS_OK;</span>
<a href="#l2.570"></a><span id="l2.570"> }</span>
<a href="#l2.571"></a><span id="l2.571"> </span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::CreateStorageIfMissing(nsIUrlListener* aUrlListener)</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineminus">-{</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::CreateStorageIfMissing(</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+    nsIUrlListener *aUrlListener) {</span>
<a href="#l2.576"></a><span id="l2.576">   nsresult rv = NS_OK;</span>
<a href="#l2.577"></a><span id="l2.577">   nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l2.578"></a><span id="l2.578">   GetParent(getter_AddRefs(msgParent));</span>
<a href="#l2.579"></a><span id="l2.579"> </span>
<a href="#l2.580"></a><span id="l2.580">   // parent is probably not set because *this* was probably created by rdf</span>
<a href="#l2.581"></a><span id="l2.581">   // and not by folder discovery. So, we have to compute the parent.</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-  if (!msgParent)</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-  {</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+  if (!msgParent) {</span>
<a href="#l2.585"></a><span id="l2.585">     nsAutoCString folderName(mURI);</span>
<a href="#l2.586"></a><span id="l2.586">     nsAutoCString uri;</span>
<a href="#l2.587"></a><span id="l2.587">     int32_t leafPos = folderName.RFindChar('/');</span>
<a href="#l2.588"></a><span id="l2.588">     nsAutoCString parentName(folderName);</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-    if (leafPos &gt; 0)</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineminus">-    {</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineplus">+    if (leafPos &gt; 0) {</span>
<a href="#l2.592"></a><span id="l2.592">       // If there is a hierarchy, there is a parent.</span>
<a href="#l2.593"></a><span id="l2.593">       // Don't strip off slash if it's the first character</span>
<a href="#l2.594"></a><span id="l2.594">       parentName.SetLength(leafPos);</span>
<a href="#l2.595"></a><span id="l2.595">       rv = GetOrCreateFolder(parentName, getter_AddRefs(msgParent));</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.598"></a><span id="l2.598">     }</span>
<a href="#l2.599"></a><span id="l2.599">   }</span>
<a href="#l2.600"></a><span id="l2.600"> </span>
<a href="#l2.601"></a><span id="l2.601" class="difflineminus">-  if (msgParent)</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineminus">-  {</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineplus">+  if (msgParent) {</span>
<a href="#l2.604"></a><span id="l2.604">     nsString folderName;</span>
<a href="#l2.605"></a><span id="l2.605">     GetName(folderName);</span>
<a href="#l2.606"></a><span id="l2.606">     rv = msgParent-&gt;CreateSubfolder(folderName, nullptr);</span>
<a href="#l2.607"></a><span id="l2.607">     // by definition, this is OK.</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-    if (rv == NS_MSG_FOLDER_EXISTS)</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-      return NS_OK;</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+    if (rv == NS_MSG_FOLDER_EXISTS) return NS_OK;</span>
<a href="#l2.611"></a><span id="l2.611">   }</span>
<a href="#l2.612"></a><span id="l2.612"> </span>
<a href="#l2.613"></a><span id="l2.613">   return rv;</span>
<a href="#l2.614"></a><span id="l2.614"> }</span>
<a href="#l2.615"></a><span id="l2.615"> </span>
<a href="#l2.616"></a><span id="l2.616"> NS_IMETHODIMP</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-nsMsgLocalMailFolder::CreateSubfolder(const nsAString&amp; folderName, nsIMsgWindow *msgWindow)</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-{</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineplus">+nsMsgLocalMailFolder::CreateSubfolder(const nsAString &amp;folderName,</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineplus">+                                      nsIMsgWindow *msgWindow) {</span>
<a href="#l2.621"></a><span id="l2.621">   nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-  nsresult rv = CreateSubfolderInternal(folderName, msgWindow, getter_AddRefs(newFolder));</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+  nsresult rv =</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+      CreateSubfolderInternal(folderName, msgWindow, getter_AddRefs(newFolder));</span>
<a href="#l2.625"></a><span id="l2.625">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.626"></a><span id="l2.626"> </span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-  if (notifier)</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-    notifier-&gt;NotifyFolderAdded(newFolder);</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+  if (notifier) notifier-&gt;NotifyFolderAdded(newFolder);</span>
<a href="#l2.633"></a><span id="l2.633"> </span>
<a href="#l2.634"></a><span id="l2.634">   return NS_OK;</span>
<a href="#l2.635"></a><span id="l2.635"> }</span>
<a href="#l2.636"></a><span id="l2.636"> </span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-nsresult</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-nsMsgLocalMailFolder::CreateSubfolderInternal(const nsAString&amp; folderName,</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-                                              nsIMsgWindow *msgWindow,</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-                                              nsIMsgFolder **aNewFolder)</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-{</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+nsresult nsMsgLocalMailFolder::CreateSubfolderInternal(</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+    const nsAString &amp;folderName, nsIMsgWindow *msgWindow,</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+    nsIMsgFolder **aNewFolder) {</span>
<a href="#l2.645"></a><span id="l2.645">   nsresult rv = CheckIfFolderExists(folderName, this, msgWindow);</span>
<a href="#l2.646"></a><span id="l2.646">   // No need for an assertion: we already throw an alert.</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineminus">-    return rv;</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.650"></a><span id="l2.650">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.651"></a><span id="l2.651">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.652"></a><span id="l2.652">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.653"></a><span id="l2.653">   rv = msgStore-&gt;CreateFolder(this, folderName, aNewFolder);</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-  if (rv == NS_MSG_ERROR_INVALID_FOLDER_NAME)</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-  {</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+  if (rv == NS_MSG_ERROR_INVALID_FOLDER_NAME) {</span>
<a href="#l2.657"></a><span id="l2.657">     ThrowAlertMsg(&quot;folderCreationFailed&quot;, msgWindow);</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-  }</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineminus">-  else if (rv == NS_MSG_FOLDER_EXISTS)</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineminus">-  {</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineplus">+  } else if (rv == NS_MSG_FOLDER_EXISTS) {</span>
<a href="#l2.662"></a><span id="l2.662">     ThrowAlertMsg(&quot;folderExists&quot;, msgWindow);</span>
<a href="#l2.663"></a><span id="l2.663">   }</span>
<a href="#l2.664"></a><span id="l2.664"> </span>
<a href="#l2.665"></a><span id="l2.665" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineminus">-  {</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-    //we need to notify explicitly the flag change because it failed when we did AddSubfolder</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineplus">+    // we need to notify explicitly the flag change because it failed when we</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+    // did AddSubfolder</span>
<a href="#l2.671"></a><span id="l2.671">     (*aNewFolder)-&gt;OnFlagChange(mFlags);</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineminus">-    (*aNewFolder)-&gt;SetPrettyName(folderName);  //because empty trash will create a new trash folder</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+    (*aNewFolder)</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+        -&gt;SetPrettyName(</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+            folderName);  // because empty trash will create a new trash folder</span>
<a href="#l2.676"></a><span id="l2.676">     NotifyItemAdded(*aNewFolder);</span>
<a href="#l2.677"></a><span id="l2.677">   }</span>
<a href="#l2.678"></a><span id="l2.678"> </span>
<a href="#l2.679"></a><span id="l2.679">   return rv;</span>
<a href="#l2.680"></a><span id="l2.680"> }</span>
<a href="#l2.681"></a><span id="l2.681"> </span>
<a href="#l2.682"></a><span id="l2.682"> NS_IMETHODIMP nsMsgLocalMailFolder::CompactAll(nsIUrlListener *aListener,</span>
<a href="#l2.683"></a><span id="l2.683">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-                                               bool aCompactOfflineAlso)</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-{</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+                                               bool aCompactOfflineAlso) {</span>
<a href="#l2.687"></a><span id="l2.687">   nsresult rv = NS_OK;</span>
<a href="#l2.688"></a><span id="l2.688">   nsCOMPtr&lt;nsIMutableArray&gt; folderArray;</span>
<a href="#l2.689"></a><span id="l2.689">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l2.690"></a><span id="l2.690">   nsCOMPtr&lt;nsIArray&gt; allDescendents;</span>
<a href="#l2.691"></a><span id="l2.691">   rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l2.692"></a><span id="l2.692">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.693"></a><span id="l2.693">   GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.694"></a><span id="l2.694">   bool storeSupportsCompaction;</span>
<a href="#l2.695"></a><span id="l2.695">   msgStore-&gt;GetSupportsCompaction(&amp;storeSupportsCompaction);</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineminus">-  if (!storeSupportsCompaction)</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineminus">-    return NotifyCompactCompleted();</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineminus">-</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineminus">-  {</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineplus">+  if (!storeSupportsCompaction) return NotifyCompactCompleted();</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineplus">+</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l2.704"></a><span id="l2.704">     rv = rootFolder-&gt;GetDescendants(getter_AddRefs(allDescendents));</span>
<a href="#l2.705"></a><span id="l2.705">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.706"></a><span id="l2.706">     uint32_t cnt = 0;</span>
<a href="#l2.707"></a><span id="l2.707">     rv = allDescendents-&gt;GetLength(&amp;cnt);</span>
<a href="#l2.708"></a><span id="l2.708">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.709"></a><span id="l2.709">     folderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l2.710"></a><span id="l2.710">     int64_t expungedBytes = 0;</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineminus">-    for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineminus">-    {</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineplus">+    for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l2.714"></a><span id="l2.714">       nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendents, i, &amp;rv);</span>
<a href="#l2.715"></a><span id="l2.715">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.716"></a><span id="l2.716"> </span>
<a href="#l2.717"></a><span id="l2.717">       expungedBytes = 0;</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineminus">-      if (folder)</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineminus">-        rv = folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+      if (folder) rv = folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l2.721"></a><span id="l2.721"> </span>
<a href="#l2.722"></a><span id="l2.722">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.723"></a><span id="l2.723"> </span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-      if (expungedBytes &gt; 0)</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineminus">-        rv = folderArray-&gt;AppendElement(folder);</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineplus">+      if (expungedBytes &gt; 0) rv = folderArray-&gt;AppendElement(folder);</span>
<a href="#l2.727"></a><span id="l2.727">     }</span>
<a href="#l2.728"></a><span id="l2.728">     rv = folderArray-&gt;GetLength(&amp;cnt);</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineminus">-    if (cnt == 0)</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineminus">-      return NotifyCompactCompleted();</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+    if (cnt == 0) return NotifyCompactCompleted();</span>
<a href="#l2.734"></a><span id="l2.734">   }</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineplus">+      do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l2.738"></a><span id="l2.738">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineminus">-  return folderCompactor-&gt;CompactFolders(folderArray, nullptr,</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineminus">-                                         aListener, aMsgWindow);</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineplus">+  return folderCompactor-&gt;CompactFolders(folderArray, nullptr, aListener,</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+                                         aMsgWindow);</span>
<a href="#l2.743"></a><span id="l2.743"> }</span>
<a href="#l2.744"></a><span id="l2.744"> </span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineminus">-{</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::Compact(nsIUrlListener *aListener,</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+                                            nsIMsgWindow *aMsgWindow) {</span>
<a href="#l2.749"></a><span id="l2.749">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.750"></a><span id="l2.750">   nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.751"></a><span id="l2.751">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.752"></a><span id="l2.752">   bool supportsCompaction;</span>
<a href="#l2.753"></a><span id="l2.753">   msgStore-&gt;GetSupportsCompaction(&amp;supportsCompaction);</span>
<a href="#l2.754"></a><span id="l2.754">   if (supportsCompaction)</span>
<a href="#l2.755"></a><span id="l2.755">     return msgStore-&gt;CompactFolder(this, aListener, aMsgWindow);</span>
<a href="#l2.756"></a><span id="l2.756">   return NS_OK;</span>
<a href="#l2.757"></a><span id="l2.757"> }</span>
<a href="#l2.758"></a><span id="l2.758"> </span>
<a href="#l2.759"></a><span id="l2.759"> NS_IMETHODIMP nsMsgLocalMailFolder::EmptyTrash(nsIMsgWindow *msgWindow,</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-                                               nsIUrlListener *aListener)</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-{</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineplus">+                                               nsIUrlListener *aListener) {</span>
<a href="#l2.763"></a><span id="l2.763">   nsresult rv;</span>
<a href="#l2.764"></a><span id="l2.764">   nsCOMPtr&lt;nsIMsgFolder&gt; trashFolder;</span>
<a href="#l2.765"></a><span id="l2.765">   rv = GetTrashFolder(getter_AddRefs(trashFolder));</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-  {</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.769"></a><span id="l2.769">     uint32_t flags;</span>
<a href="#l2.770"></a><span id="l2.770">     trashFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l2.771"></a><span id="l2.771">     int32_t totalMessages = 0;</span>
<a href="#l2.772"></a><span id="l2.772">     rv = trashFolder-&gt;GetTotalMessages(true, &amp;totalMessages);</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineminus">-    if (totalMessages &lt;= 0)</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-    {</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineplus">+    if (totalMessages &lt;= 0) {</span>
<a href="#l2.776"></a><span id="l2.776">       nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l2.777"></a><span id="l2.777">       rv = trashFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.780"></a><span id="l2.780">       // Any folders to deal with?</span>
<a href="#l2.781"></a><span id="l2.781">       bool hasMore;</span>
<a href="#l2.782"></a><span id="l2.782">       rv = enumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineminus">-      if (NS_FAILED(rv) || !hasMore)</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineminus">-        return NS_OK;</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+      if (NS_FAILED(rv) || !hasMore) return NS_OK;</span>
<a href="#l2.786"></a><span id="l2.786">     }</span>
<a href="#l2.787"></a><span id="l2.787">     nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l2.788"></a><span id="l2.788">     rv = trashFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; parentFolder)</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-    {</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-      nsCOMPtr &lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; parentFolder) {</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l2.794"></a><span id="l2.794">       trashFolder-&gt;GetDBTransferInfo(getter_AddRefs(transferInfo));</span>
<a href="#l2.795"></a><span id="l2.795">       trashFolder-&gt;SetParent(nullptr);</span>
<a href="#l2.796"></a><span id="l2.796">       parentFolder-&gt;PropagateDelete(trashFolder, true, msgWindow);</span>
<a href="#l2.797"></a><span id="l2.797">       parentFolder-&gt;CreateSubfolder(NS_LITERAL_STRING(&quot;Trash&quot;), nullptr);</span>
<a href="#l2.798"></a><span id="l2.798">       nsCOMPtr&lt;nsIMsgFolder&gt; newTrashFolder;</span>
<a href="#l2.799"></a><span id="l2.799">       rv = GetTrashFolder(getter_AddRefs(newTrashFolder));</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; newTrashFolder)</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineminus">-      {</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineminus">-        nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localTrash = do_QueryInterface(newTrashFolder);</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; newTrashFolder) {</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineplus">+        nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localTrash =</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+            do_QueryInterface(newTrashFolder);</span>
<a href="#l2.806"></a><span id="l2.806">         newTrashFolder-&gt;SetDBTransferInfo(transferInfo);</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineminus">-        if (localTrash)</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineminus">-          localTrash-&gt;RefreshSizeOnDisk();</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineplus">+        if (localTrash) localTrash-&gt;RefreshSizeOnDisk();</span>
<a href="#l2.810"></a><span id="l2.810">         // update the summary totals so the front end will</span>
<a href="#l2.811"></a><span id="l2.811">         // show the right thing for the new trash folder</span>
<a href="#l2.812"></a><span id="l2.812">         // see bug #161999</span>
<a href="#l2.813"></a><span id="l2.813">         nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l2.814"></a><span id="l2.814">         nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineminus">-        newTrashFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(db));</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineminus">-        if (dbFolderInfo)</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineminus">-        {</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineplus">+        newTrashFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineplus">+                                             getter_AddRefs(db));</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineplus">+        if (dbFolderInfo) {</span>
<a href="#l2.821"></a><span id="l2.821">           dbFolderInfo-&gt;SetNumUnreadMessages(0);</span>
<a href="#l2.822"></a><span id="l2.822">           dbFolderInfo-&gt;SetNumMessages(0);</span>
<a href="#l2.823"></a><span id="l2.823">         }</span>
<a href="#l2.824"></a><span id="l2.824">         newTrashFolder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l2.825"></a><span id="l2.825">       }</span>
<a href="#l2.826"></a><span id="l2.826">     }</span>
<a href="#l2.827"></a><span id="l2.827">   }</span>
<a href="#l2.828"></a><span id="l2.828">   return rv;</span>
<a href="#l2.829"></a><span id="l2.829"> }</span>
<a href="#l2.830"></a><span id="l2.830"> </span>
<a href="#l2.831"></a><span id="l2.831" class="difflineminus">-nsresult nsMsgLocalMailFolder::IsChildOfTrash(bool *result)</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-{</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+nsresult nsMsgLocalMailFolder::IsChildOfTrash(bool *result) {</span>
<a href="#l2.834"></a><span id="l2.834">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l2.835"></a><span id="l2.835">   uint32_t parentFlags = 0;</span>
<a href="#l2.836"></a><span id="l2.836">   *result = false;</span>
<a href="#l2.837"></a><span id="l2.837">   bool isServer;</span>
<a href="#l2.838"></a><span id="l2.838">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineminus">-  if (NS_FAILED(rv) || isServer)</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineminus">-</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineminus">-  rv= GetFlags(&amp;parentFlags);  //this is the parent folder</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineminus">-  if (parentFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineminus">-  {</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineplus">+  if (NS_FAILED(rv) || isServer) return NS_OK;</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineplus">+  rv = GetFlags(&amp;parentFlags);  // this is the parent folder</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineplus">+  if (parentFlags &amp; nsMsgFolderFlags::Trash) {</span>
<a href="#l2.849"></a><span id="l2.849">     *result = true;</span>
<a href="#l2.850"></a><span id="l2.850">     return rv;</span>
<a href="#l2.851"></a><span id="l2.851">   }</span>
<a href="#l2.852"></a><span id="l2.852"> </span>
<a href="#l2.853"></a><span id="l2.853">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l2.854"></a><span id="l2.854">   nsCOMPtr&lt;nsIMsgFolder&gt; thisFolder;</span>
<a href="#l2.855"></a><span id="l2.855">   rv = QueryInterface(NS_GET_IID(nsIMsgFolder), getter_AddRefs(thisFolder));</span>
<a href="#l2.856"></a><span id="l2.856"> </span>
<a href="#l2.857"></a><span id="l2.857" class="difflineminus">-  while (!isServer)</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineminus">-  {</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineplus">+  while (!isServer) {</span>
<a href="#l2.860"></a><span id="l2.860">     thisFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineminus">-    if (!parentFolder)</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineminus">-      return NS_OK;</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineplus">+    if (!parentFolder) return NS_OK;</span>
<a href="#l2.864"></a><span id="l2.864"> </span>
<a href="#l2.865"></a><span id="l2.865">     rv = parentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineminus">-    if (NS_FAILED(rv) || isServer)</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineminus">-      return NS_OK;</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineplus">+    if (NS_FAILED(rv) || isServer) return NS_OK;</span>
<a href="#l2.869"></a><span id="l2.869"> </span>
<a href="#l2.870"></a><span id="l2.870">     rv = parentFolder-&gt;GetFlags(&amp;parentFlags);</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineminus">-      return NS_OK;</span>
<a href="#l2.873"></a><span id="l2.873" class="difflineminus">-</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineminus">-    if (parentFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l2.875"></a><span id="l2.875" class="difflineminus">-    {</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineplus">+    if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineplus">+</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineplus">+    if (parentFlags &amp; nsMsgFolderFlags::Trash) {</span>
<a href="#l2.879"></a><span id="l2.879">       *result = true;</span>
<a href="#l2.880"></a><span id="l2.880">       return rv;</span>
<a href="#l2.881"></a><span id="l2.881">     }</span>
<a href="#l2.882"></a><span id="l2.882"> </span>
<a href="#l2.883"></a><span id="l2.883">     thisFolder = parentFolder;</span>
<a href="#l2.884"></a><span id="l2.884">   }</span>
<a href="#l2.885"></a><span id="l2.885">   return rv;</span>
<a href="#l2.886"></a><span id="l2.886"> }</span>
<a href="#l2.887"></a><span id="l2.887"> </span>
<a href="#l2.888"></a><span id="l2.888" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::DeleteSubFolders(nsIArray *folders, nsIMsgWindow *msgWindow)</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineminus">-{</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::DeleteSubFolders(nsIArray *folders,</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+                                                     nsIMsgWindow *msgWindow) {</span>
<a href="#l2.892"></a><span id="l2.892">   nsresult rv;</span>
<a href="#l2.893"></a><span id="l2.893">   bool isChildOfTrash;</span>
<a href="#l2.894"></a><span id="l2.894">   IsChildOfTrash(&amp;isChildOfTrash);</span>
<a href="#l2.895"></a><span id="l2.895"> </span>
<a href="#l2.896"></a><span id="l2.896">   // we don't allow multiple folder selection so this is ok.</span>
<a href="#l2.897"></a><span id="l2.897">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(folders, 0);</span>
<a href="#l2.898"></a><span id="l2.898">   uint32_t folderFlags = 0;</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineminus">-  if (folder)</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineminus">-    folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineplus">+  if (folder) folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l2.902"></a><span id="l2.902">   // when deleting from trash, or virtual folder, just delete it.</span>
<a href="#l2.903"></a><span id="l2.903">   if (isChildOfTrash || folderFlags &amp; nsMsgFolderFlags::Virtual)</span>
<a href="#l2.904"></a><span id="l2.904">     return nsMsgDBFolder::DeleteSubFolders(folders, msgWindow);</span>
<a href="#l2.905"></a><span id="l2.905"> </span>
<a href="#l2.906"></a><span id="l2.906">   nsCOMPtr&lt;nsIMsgFolder&gt; trashFolder;</span>
<a href="#l2.907"></a><span id="l2.907">   rv = GetTrashFolder(getter_AddRefs(trashFolder));</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.909"></a><span id="l2.909" class="difflineminus">-  {</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineminus">-    if (folder)</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineminus">-    {</span>
<a href="#l2.912"></a><span id="l2.912" class="difflineminus">-      nsCOMPtr&lt;nsIMsgCopyService&gt; copyService(do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.913"></a><span id="l2.913" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.914"></a><span id="l2.914" class="difflineplus">+    if (folder) {</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineplus">+      nsCOMPtr&lt;nsIMsgCopyService&gt; copyService(</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineplus">+          do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.917"></a><span id="l2.917">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineminus">-      rv = copyService-&gt;CopyFolders(folders, trashFolder, true, nullptr, msgWindow);</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineplus">+      rv = copyService-&gt;CopyFolders(folders, trashFolder, true, nullptr,</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineplus">+                                    msgWindow);</span>
<a href="#l2.921"></a><span id="l2.921">     }</span>
<a href="#l2.922"></a><span id="l2.922">   }</span>
<a href="#l2.923"></a><span id="l2.923">   return rv;</span>
<a href="#l2.924"></a><span id="l2.924"> }</span>
<a href="#l2.925"></a><span id="l2.925"> </span>
<a href="#l2.926"></a><span id="l2.926"> nsresult nsMsgLocalMailFolder::ConfirmFolderDeletion(nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineminus">-                                                     nsIMsgFolder *aFolder, bool *aResult)</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineminus">-{</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineplus">+                                                     nsIMsgFolder *aFolder,</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineplus">+                                                     bool *aResult) {</span>
<a href="#l2.931"></a><span id="l2.931">   NS_ENSURE_ARG(aResult);</span>
<a href="#l2.932"></a><span id="l2.932">   NS_ENSURE_ARG(aMsgWindow);</span>
<a href="#l2.933"></a><span id="l2.933">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l2.934"></a><span id="l2.934">   nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l2.935"></a><span id="l2.935">   aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineminus">-  if (docShell)</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineminus">-  {</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineplus">+  if (docShell) {</span>
<a href="#l2.939"></a><span id="l2.939">     bool confirmDeletion = true;</span>
<a href="#l2.940"></a><span id="l2.940">     nsresult rv;</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.944"></a><span id="l2.944">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineminus">-    pPrefBranch-&gt;GetBoolPref(&quot;mailnews.confirm.moveFoldersToTrash&quot;, &amp;confirmDeletion);</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineminus">-    if (confirmDeletion)</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineminus">-    {</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineplus">+    pPrefBranch-&gt;GetBoolPref(&quot;mailnews.confirm.moveFoldersToTrash&quot;,</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineplus">+                             &amp;confirmDeletion);</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineplus">+    if (confirmDeletion) {</span>
<a href="#l2.951"></a><span id="l2.951">       nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l2.954"></a><span id="l2.954">       NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l2.955"></a><span id="l2.955">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-      rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineplus">+      rv = bundleService-&gt;CreateBundle(</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineplus">+          &quot;chrome://messenger/locale/localMsgs.properties&quot;,</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineplus">+          getter_AddRefs(bundle));</span>
<a href="#l2.960"></a><span id="l2.960">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.961"></a><span id="l2.961"> </span>
<a href="#l2.962"></a><span id="l2.962">       nsAutoString folderName;</span>
<a href="#l2.963"></a><span id="l2.963">       rv = aFolder-&gt;GetName(folderName);</span>
<a href="#l2.964"></a><span id="l2.964">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineminus">-      const char16_t *formatStrings[1] = { folderName.get() };</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+      const char16_t *formatStrings[1] = {folderName.get()};</span>
<a href="#l2.967"></a><span id="l2.967"> </span>
<a href="#l2.968"></a><span id="l2.968">       nsAutoString deleteFolderDialogTitle;</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineminus">-      rv = bundle-&gt;GetStringFromName(</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineminus">-        &quot;pop3DeleteFolderDialogTitle&quot;,</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineminus">-        deleteFolderDialogTitle);</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineplus">+      rv = bundle-&gt;GetStringFromName(&quot;pop3DeleteFolderDialogTitle&quot;,</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineplus">+                                     deleteFolderDialogTitle);</span>
<a href="#l2.974"></a><span id="l2.974">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.975"></a><span id="l2.975"> </span>
<a href="#l2.976"></a><span id="l2.976">       nsAutoString deleteFolderButtonLabel;</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineminus">-      rv = bundle-&gt;GetStringFromName(</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineminus">-        &quot;pop3DeleteFolderButtonLabel&quot;,</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineminus">-        deleteFolderButtonLabel);</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineplus">+      rv = bundle-&gt;GetStringFromName(&quot;pop3DeleteFolderButtonLabel&quot;,</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineplus">+                                     deleteFolderButtonLabel);</span>
<a href="#l2.982"></a><span id="l2.982">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.983"></a><span id="l2.983"> </span>
<a href="#l2.984"></a><span id="l2.984">       nsAutoString confirmationStr;</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineminus">-        &quot;pop3MoveFolderToTrash&quot;, formatStrings, 1,</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineminus">-        confirmationStr);</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;pop3MoveFolderToTrash&quot;, formatStrings,</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineplus">+                                        1, confirmationStr);</span>
<a href="#l2.990"></a><span id="l2.990">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.991"></a><span id="l2.991"> </span>
<a href="#l2.992"></a><span id="l2.992">       nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(docShell));</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineminus">-      if (dialog)</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineminus">-      {</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineplus">+      if (dialog) {</span>
<a href="#l2.996"></a><span id="l2.996">         int32_t buttonPressed = 0;</span>
<a href="#l2.997"></a><span id="l2.997">         // Default the dialog to &quot;cancel&quot;.</span>
<a href="#l2.998"></a><span id="l2.998">         const uint32_t buttonFlags =</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-          (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineminus">-          (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineplus">+            (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineplus">+            (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l2.1003"></a><span id="l2.1003">         bool dummyValue = false;</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineminus">-        rv = dialog-&gt;ConfirmEx(deleteFolderDialogTitle.get(), confirmationStr.get(),</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineminus">-                               buttonFlags,  deleteFolderButtonLabel.get(),</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineminus">-                               nullptr, nullptr, nullptr, &amp;dummyValue,</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineminus">-                               &amp;buttonPressed);</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineplus">+        rv = dialog-&gt;ConfirmEx(deleteFolderDialogTitle.get(),</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineplus">+                               confirmationStr.get(), buttonFlags,</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+                               deleteFolderButtonLabel.get(), nullptr, nullptr,</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineplus">+                               nullptr, &amp;dummyValue, &amp;buttonPressed);</span>
<a href="#l2.1012"></a><span id="l2.1012">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineminus">-        *aResult = !buttonPressed; // &quot;ok&quot; is in position 0</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineplus">+        *aResult = !buttonPressed;  // &quot;ok&quot; is in position 0</span>
<a href="#l2.1015"></a><span id="l2.1015">       }</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineminus">-    }</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineminus">-    else</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineplus">+    } else</span>
<a href="#l2.1019"></a><span id="l2.1019">       *aResult = true;</span>
<a href="#l2.1020"></a><span id="l2.1020">   }</span>
<a href="#l2.1021"></a><span id="l2.1021">   return NS_OK;</span>
<a href="#l2.1022"></a><span id="l2.1022"> }</span>
<a href="#l2.1023"></a><span id="l2.1023"> </span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::Rename(const nsAString&amp; aNewName, nsIMsgWindow *msgWindow)</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineminus">-{</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::Rename(const nsAString &amp;aNewName,</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineplus">+                                           nsIMsgWindow *msgWindow) {</span>
<a href="#l2.1028"></a><span id="l2.1028">   // Renaming to the same name is easy</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineminus">-  if (mName.Equals(aNewName))</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineplus">+  if (mName.Equals(aNewName)) return NS_OK;</span>
<a href="#l2.1032"></a><span id="l2.1032"> </span>
<a href="#l2.1033"></a><span id="l2.1033">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l2.1034"></a><span id="l2.1034">   nsresult rv = GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineminus">-  if (!parentFolder)</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+  if (!parentFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.1038"></a><span id="l2.1038"> </span>
<a href="#l2.1039"></a><span id="l2.1039">   rv = CheckIfFolderExists(aNewName, parentFolder, msgWindow);</span>
<a href="#l2.1040"></a><span id="l2.1040" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineminus">-    return rv;</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.1043"></a><span id="l2.1043"> </span>
<a href="#l2.1044"></a><span id="l2.1044">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1045"></a><span id="l2.1045">   nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l2.1046"></a><span id="l2.1046">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1047"></a><span id="l2.1047">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1048"></a><span id="l2.1048">   rv = msgStore-&gt;RenameFolder(this, aNewName, getter_AddRefs(newFolder));</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineminus">-  {</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l2.1052"></a><span id="l2.1052">     if (msgWindow)</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineminus">-      (void) ThrowAlertMsg((rv == NS_MSG_FOLDER_EXISTS) ?</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineminus">-                            &quot;folderExists&quot; : &quot;folderRenameFailed&quot;, msgWindow);</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineplus">+      (void)ThrowAlertMsg(</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineplus">+          (rv == NS_MSG_FOLDER_EXISTS) ? &quot;folderExists&quot; : &quot;folderRenameFailed&quot;,</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineplus">+          msgWindow);</span>
<a href="#l2.1058"></a><span id="l2.1058">     return rv;</span>
<a href="#l2.1059"></a><span id="l2.1059">   }</span>
<a href="#l2.1060"></a><span id="l2.1060"> </span>
<a href="#l2.1061"></a><span id="l2.1061">   int32_t count = mSubFolders.Count();</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineminus">-    if (newFolder)</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineminus">-    {</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineminus">-      // Because we just renamed the db, w/o setting the pretty name in it,</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineminus">-      // we need to force the pretty name to be correct.</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineminus">-      // SetPrettyName won't write the name to the db if it doesn't think the</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineminus">-      // name has changed. This hack forces the pretty name to get set in the db.</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineminus">-      // We could set the new pretty name on the db before renaming the .msf file,</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineminus">-      // but if the rename failed, it would be out of sync.</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineminus">-      newFolder-&gt;SetPrettyName(EmptyString());</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineminus">-      newFolder-&gt;SetPrettyName(aNewName);</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineminus">-      bool changed = false;</span>
<a href="#l2.1073"></a><span id="l2.1073" class="difflineminus">-      MatchOrChangeFilterDestination(newFolder, true /*case-insensitive*/, &amp;changed);</span>
<a href="#l2.1074"></a><span id="l2.1074" class="difflineminus">-      if (changed)</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineminus">-        AlertFilterChanged(msgWindow);</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineminus">-</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineminus">-      if (count &gt; 0)</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineminus">-        newFolder-&gt;RenameSubFolders(msgWindow, this);</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineminus">-</span>
<a href="#l2.1080"></a><span id="l2.1080" class="difflineminus">-      // Discover the subfolders inside this folder (this is recursive)</span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineminus">-      nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineminus">-      newFolder-&gt;GetSubFolders(getter_AddRefs(dummy));</span>
<a href="#l2.1083"></a><span id="l2.1083" class="difflineminus">-</span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineminus">-      // the newFolder should have the same flags</span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineminus">-      newFolder-&gt;SetFlags(mFlags);</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-      if (parentFolder)</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-      {</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-        SetParent(nullptr);</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineminus">-        parentFolder-&gt;PropagateDelete(this, false, msgWindow);</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineminus">-        parentFolder-&gt;NotifyItemAdded(newFolder);</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineminus">-      }</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineminus">-      SetFilePath(nullptr); // forget our path, since this folder object renamed itself</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineminus">-      newFolder-&gt;NotifyFolderEvent(kRenameCompleted);</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineminus">-</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineminus">-      if (notifier)</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineminus">-        notifier-&gt;NotifyFolderRenamed(this, newFolder);</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+  if (newFolder) {</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineplus">+    // Because we just renamed the db, w/o setting the pretty name in it,</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineplus">+    // we need to force the pretty name to be correct.</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+    // SetPrettyName won't write the name to the db if it doesn't think the</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineplus">+    // name has changed. This hack forces the pretty name to get set in the db.</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineplus">+    // We could set the new pretty name on the db before renaming the .msf file,</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineplus">+    // but if the rename failed, it would be out of sync.</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineplus">+    newFolder-&gt;SetPrettyName(EmptyString());</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineplus">+    newFolder-&gt;SetPrettyName(aNewName);</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineplus">+    bool changed = false;</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineplus">+    MatchOrChangeFilterDestination(newFolder, true /*case-insensitive*/,</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineplus">+                                   &amp;changed);</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineplus">+    if (changed) AlertFilterChanged(msgWindow);</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineplus">+</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineplus">+    if (count &gt; 0) newFolder-&gt;RenameSubFolders(msgWindow, this);</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineplus">+</span>
<a href="#l2.1114"></a><span id="l2.1114" class="difflineplus">+    // Discover the subfolders inside this folder (this is recursive)</span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineplus">+    newFolder-&gt;GetSubFolders(getter_AddRefs(dummy));</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineplus">+</span>
<a href="#l2.1118"></a><span id="l2.1118" class="difflineplus">+    // the newFolder should have the same flags</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineplus">+    newFolder-&gt;SetFlags(mFlags);</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineplus">+    if (parentFolder) {</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineplus">+      SetParent(nullptr);</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineplus">+      parentFolder-&gt;PropagateDelete(this, false, msgWindow);</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineplus">+      parentFolder-&gt;NotifyItemAdded(newFolder);</span>
<a href="#l2.1124"></a><span id="l2.1124">     }</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineplus">+    SetFilePath(</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineplus">+        nullptr);  // forget our path, since this folder object renamed itself</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+    newFolder-&gt;NotifyFolderEvent(kRenameCompleted);</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineplus">+</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineplus">+    if (notifier) notifier-&gt;NotifyFolderRenamed(this, newFolder);</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineplus">+  }</span>
<a href="#l2.1133"></a><span id="l2.1133">   return rv;</span>
<a href="#l2.1134"></a><span id="l2.1134"> }</span>
<a href="#l2.1135"></a><span id="l2.1135"> </span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::RenameSubFolders(nsIMsgWindow *msgWindow, nsIMsgFolder *oldFolder)</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineminus">-{</span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineminus">-  nsresult rv =NS_OK;</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::RenameSubFolders(nsIMsgWindow *msgWindow,</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineplus">+                                                     nsIMsgFolder *oldFolder) {</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l2.1142"></a><span id="l2.1142">   mInitialized = true;</span>
<a href="#l2.1143"></a><span id="l2.1143"> </span>
<a href="#l2.1144"></a><span id="l2.1144">   uint32_t flags;</span>
<a href="#l2.1145"></a><span id="l2.1145">   oldFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l2.1146"></a><span id="l2.1146">   SetFlags(flags);</span>
<a href="#l2.1147"></a><span id="l2.1147"> </span>
<a href="#l2.1148"></a><span id="l2.1148">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l2.1149"></a><span id="l2.1149">   rv = oldFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l2.1150"></a><span id="l2.1150">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1151"></a><span id="l2.1151"> </span>
<a href="#l2.1152"></a><span id="l2.1152">   bool hasMore;</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineminus">-  {</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.1156"></a><span id="l2.1156">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l2.1157"></a><span id="l2.1157">     enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l2.1158"></a><span id="l2.1158"> </span>
<a href="#l2.1159"></a><span id="l2.1159">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryInterface(item));</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineminus">-    if (!msgFolder)</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineminus">-      continue;</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineplus">+    if (!msgFolder) continue;</span>
<a href="#l2.1163"></a><span id="l2.1163"> </span>
<a href="#l2.1164"></a><span id="l2.1164">     nsString folderName;</span>
<a href="#l2.1165"></a><span id="l2.1165">     rv = msgFolder-&gt;GetName(folderName);</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l2.1168"></a><span id="l2.1168">     AddSubfolder(folderName, getter_AddRefs(newFolder));</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineminus">-    if (newFolder)</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineminus">-    {</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+    if (newFolder) {</span>
<a href="#l2.1172"></a><span id="l2.1172">       newFolder-&gt;SetPrettyName(folderName);</span>
<a href="#l2.1173"></a><span id="l2.1173">       bool changed = false;</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineminus">-      msgFolder-&gt;MatchOrChangeFilterDestination(newFolder, true /*case-insensitive*/, &amp;changed);</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineminus">-      if (changed)</span>
<a href="#l2.1176"></a><span id="l2.1176" class="difflineminus">-        msgFolder-&gt;AlertFilterChanged(msgWindow);</span>
<a href="#l2.1177"></a><span id="l2.1177" class="difflineplus">+      msgFolder-&gt;MatchOrChangeFilterDestination(</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineplus">+          newFolder, true /*case-insensitive*/, &amp;changed);</span>
<a href="#l2.1179"></a><span id="l2.1179" class="difflineplus">+      if (changed) msgFolder-&gt;AlertFilterChanged(msgWindow);</span>
<a href="#l2.1180"></a><span id="l2.1180">       newFolder-&gt;RenameSubFolders(msgWindow, msgFolder);</span>
<a href="#l2.1181"></a><span id="l2.1181">     }</span>
<a href="#l2.1182"></a><span id="l2.1182">   }</span>
<a href="#l2.1183"></a><span id="l2.1183">   return NS_OK;</span>
<a href="#l2.1184"></a><span id="l2.1184"> }</span>
<a href="#l2.1185"></a><span id="l2.1185"> </span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetPrettyName(nsAString&amp; prettyName)</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineminus">-{</span>
<a href="#l2.1188"></a><span id="l2.1188" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetPrettyName(nsAString &amp;prettyName) {</span>
<a href="#l2.1189"></a><span id="l2.1189">   return nsMsgDBFolder::GetPrettyName(prettyName);</span>
<a href="#l2.1190"></a><span id="l2.1190"> }</span>
<a href="#l2.1191"></a><span id="l2.1191"> </span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::SetPrettyName(const nsAString&amp; aName)</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineminus">-{</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::SetPrettyName(const nsAString &amp;aName) {</span>
<a href="#l2.1195"></a><span id="l2.1195">   nsresult rv = nsMsgDBFolder::SetPrettyName(aName);</span>
<a href="#l2.1196"></a><span id="l2.1196">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1197"></a><span id="l2.1197">   nsCString folderName;</span>
<a href="#l2.1198"></a><span id="l2.1198">   rv = GetStringProperty(&quot;folderName&quot;, folderName);</span>
<a href="#l2.1199"></a><span id="l2.1199">   NS_ConvertUTF16toUTF8 utf8FolderName(mName);</span>
<a href="#l2.1200"></a><span id="l2.1200" class="difflineminus">-  return NS_FAILED(rv) || !folderName.Equals(utf8FolderName) ? SetStringProperty(&quot;folderName&quot;, utf8FolderName) : rv;</span>
<a href="#l2.1201"></a><span id="l2.1201" class="difflineplus">+  return NS_FAILED(rv) || !folderName.Equals(utf8FolderName)</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineplus">+             ? SetStringProperty(&quot;folderName&quot;, utf8FolderName)</span>
<a href="#l2.1203"></a><span id="l2.1203" class="difflineplus">+             : rv;</span>
<a href="#l2.1204"></a><span id="l2.1204"> }</span>
<a href="#l2.1205"></a><span id="l2.1205"> </span>
<a href="#l2.1206"></a><span id="l2.1206" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetName(nsAString&amp; aName)</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineminus">-{</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetName(nsAString &amp;aName) {</span>
<a href="#l2.1209"></a><span id="l2.1209">   ReadDBFolderInfo(false);</span>
<a href="#l2.1210"></a><span id="l2.1210">   return nsMsgDBFolder::GetName(aName);</span>
<a href="#l2.1211"></a><span id="l2.1211"> }</span>
<a href="#l2.1212"></a><span id="l2.1212"> </span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineminus">-nsresult nsMsgLocalMailFolder::OpenDatabase()</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineminus">-{</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineplus">+nsresult nsMsgLocalMailFolder::OpenDatabase() {</span>
<a href="#l2.1216"></a><span id="l2.1216">   nsresult rv;</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1220"></a><span id="l2.1220">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1221"></a><span id="l2.1221"> </span>
<a href="#l2.1222"></a><span id="l2.1222" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l2.1223"></a><span id="l2.1223" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l2.1224"></a><span id="l2.1224">   rv = GetFilePath(getter_AddRefs(file));</span>
<a href="#l2.1225"></a><span id="l2.1225"> </span>
<a href="#l2.1226"></a><span id="l2.1226">   rv = msgDBService-&gt;OpenFolderDB(this, true, getter_AddRefs(mDatabase));</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineminus">-    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l2.1228"></a><span id="l2.1228" class="difflineminus">-    {</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineplus">+  if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING) {</span>
<a href="#l2.1230"></a><span id="l2.1230">     // check if we're a real folder by looking at the parent folder.</span>
<a href="#l2.1231"></a><span id="l2.1231">     nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l2.1232"></a><span id="l2.1232">     GetParent(getter_AddRefs(parent));</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineminus">-    if (parent)</span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineminus">-    {</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineplus">+    if (parent) {</span>
<a href="#l2.1236"></a><span id="l2.1236">       // This little dance creates an empty .msf file and then checks</span>
<a href="#l2.1237"></a><span id="l2.1237">       // if the db is valid - this works if the folder is empty, which</span>
<a href="#l2.1238"></a><span id="l2.1238">       // we don't have a direct way of checking.</span>
<a href="#l2.1239"></a><span id="l2.1239">       nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.1240"></a><span id="l2.1240">       rv = msgDBService-&gt;CreateNewDB(this, getter_AddRefs(db));</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineminus">-      if (db)</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineminus">-      {</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineplus">+      if (db) {</span>
<a href="#l2.1244"></a><span id="l2.1244">         UpdateSummaryTotals(true);</span>
<a href="#l2.1245"></a><span id="l2.1245">         db-&gt;Close(true);</span>
<a href="#l2.1246"></a><span id="l2.1246">         mDatabase = nullptr;</span>
<a href="#l2.1247"></a><span id="l2.1247">         db = nullptr;</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineminus">-        rv = msgDBService-&gt;OpenFolderDB(this, false,</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineminus">-                                        getter_AddRefs(mDatabase));</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineminus">-          mDatabase = nullptr;</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineplus">+        rv = msgDBService-&gt;OpenFolderDB(this, false, getter_AddRefs(mDatabase));</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+        if (NS_FAILED(rv)) mDatabase = nullptr;</span>
<a href="#l2.1254"></a><span id="l2.1254">       }</span>
<a href="#l2.1255"></a><span id="l2.1255">     }</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineminus">-  }</span>
<a href="#l2.1257"></a><span id="l2.1257" class="difflineminus">-  else if (NS_FAILED(rv))</span>
<a href="#l2.1258"></a><span id="l2.1258" class="difflineplus">+  } else if (NS_FAILED(rv))</span>
<a href="#l2.1259"></a><span id="l2.1259">     mDatabase = nullptr;</span>
<a href="#l2.1260"></a><span id="l2.1260"> </span>
<a href="#l2.1261"></a><span id="l2.1261">   return rv;</span>
<a href="#l2.1262"></a><span id="l2.1262"> }</span>
<a href="#l2.1263"></a><span id="l2.1263"> </span>
<a href="#l2.1264"></a><span id="l2.1264"> NS_IMETHODIMP</span>
<a href="#l2.1265"></a><span id="l2.1265" class="difflineminus">-nsMsgLocalMailFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **db)</span>
<a href="#l2.1266"></a><span id="l2.1266" class="difflineminus">-{</span>
<a href="#l2.1267"></a><span id="l2.1267" class="difflineplus">+nsMsgLocalMailFolder::GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineplus">+                                           nsIMsgDatabase **db) {</span>
<a href="#l2.1269"></a><span id="l2.1269">   if (!db || !folderInfo || !mPath || mIsServer)</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineminus">-    return NS_ERROR_NULL_POINTER;   //ducarroz: should we use NS_ERROR_INVALID_ARG?</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineplus">+    return NS_ERROR_NULL_POINTER;  // ducarroz: should we use</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineplus">+                                   // NS_ERROR_INVALID_ARG?</span>
<a href="#l2.1273"></a><span id="l2.1273"> </span>
<a href="#l2.1274"></a><span id="l2.1274">   nsresult rv;</span>
<a href="#l2.1275"></a><span id="l2.1275">   if (mDatabase)</span>
<a href="#l2.1276"></a><span id="l2.1276">     rv = NS_OK;</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineminus">-  else</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineminus">-  {</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineplus">+  else {</span>
<a href="#l2.1280"></a><span id="l2.1280">     rv = OpenDatabase();</span>
<a href="#l2.1281"></a><span id="l2.1281"> </span>
<a href="#l2.1282"></a><span id="l2.1282" class="difflineminus">-    if (mAddListener &amp;&amp; mDatabase)</span>
<a href="#l2.1283"></a><span id="l2.1283" class="difflineminus">-      mDatabase-&gt;AddListener(this);</span>
<a href="#l2.1284"></a><span id="l2.1284" class="difflineplus">+    if (mAddListener &amp;&amp; mDatabase) mDatabase-&gt;AddListener(this);</span>
<a href="#l2.1285"></a><span id="l2.1285">   }</span>
<a href="#l2.1286"></a><span id="l2.1286"> </span>
<a href="#l2.1287"></a><span id="l2.1287">   NS_IF_ADDREF(*db = mDatabase);</span>
<a href="#l2.1288"></a><span id="l2.1288" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; *db)</span>
<a href="#l2.1289"></a><span id="l2.1289" class="difflineminus">-    rv = (*db)-&gt;GetDBFolderInfo(folderInfo);</span>
<a href="#l2.1290"></a><span id="l2.1290" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; *db) rv = (*db)-&gt;GetDBFolderInfo(folderInfo);</span>
<a href="#l2.1291"></a><span id="l2.1291">   return rv;</span>
<a href="#l2.1292"></a><span id="l2.1292"> }</span>
<a href="#l2.1293"></a><span id="l2.1293"> </span>
<a href="#l2.1294"></a><span id="l2.1294" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element)</span>
<a href="#l2.1295"></a><span id="l2.1295" class="difflineminus">-{</span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::ReadFromFolderCacheElem(</span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineplus">+    nsIMsgFolderCacheElement *element) {</span>
<a href="#l2.1298"></a><span id="l2.1298">   NS_ENSURE_ARG_POINTER(element);</span>
<a href="#l2.1299"></a><span id="l2.1299">   nsresult rv = nsMsgDBFolder::ReadFromFolderCacheElem(element);</span>
<a href="#l2.1300"></a><span id="l2.1300">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1301"></a><span id="l2.1301">   nsCString utf8Name;</span>
<a href="#l2.1302"></a><span id="l2.1302">   rv = element-&gt;GetStringProperty(&quot;folderName&quot;, utf8Name);</span>
<a href="#l2.1303"></a><span id="l2.1303">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1304"></a><span id="l2.1304">   CopyUTF8toUTF16(utf8Name, mName);</span>
<a href="#l2.1305"></a><span id="l2.1305">   return rv;</span>
<a href="#l2.1306"></a><span id="l2.1306"> }</span>
<a href="#l2.1307"></a><span id="l2.1307"> </span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::WriteToFolderCacheElem(nsIMsgFolderCacheElement *element)</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineminus">-{</span>
<a href="#l2.1310"></a><span id="l2.1310" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::WriteToFolderCacheElem(</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineplus">+    nsIMsgFolderCacheElement *element) {</span>
<a href="#l2.1312"></a><span id="l2.1312">   NS_ENSURE_ARG_POINTER(element);</span>
<a href="#l2.1313"></a><span id="l2.1313">   nsMsgDBFolder::WriteToFolderCacheElem(element);</span>
<a href="#l2.1314"></a><span id="l2.1314">   return element-&gt;SetStringProperty(&quot;folderName&quot;, NS_ConvertUTF16toUTF8(mName));</span>
<a href="#l2.1315"></a><span id="l2.1315"> }</span>
<a href="#l2.1316"></a><span id="l2.1316"> </span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetDeletable(bool *deletable)</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineminus">-{</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetDeletable(bool *deletable) {</span>
<a href="#l2.1320"></a><span id="l2.1320">   NS_ENSURE_ARG_POINTER(deletable);</span>
<a href="#l2.1321"></a><span id="l2.1321"> </span>
<a href="#l2.1322"></a><span id="l2.1322">   bool isServer;</span>
<a href="#l2.1323"></a><span id="l2.1323">   GetIsServer(&amp;isServer);</span>
<a href="#l2.1324"></a><span id="l2.1324">   *deletable = !(isServer || (mFlags &amp; nsMsgFolderFlags::SpecialUse));</span>
<a href="#l2.1325"></a><span id="l2.1325">   return NS_OK;</span>
<a href="#l2.1326"></a><span id="l2.1326"> }</span>
<a href="#l2.1327"></a><span id="l2.1327"> </span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::RefreshSizeOnDisk()</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineminus">-{</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::RefreshSizeOnDisk() {</span>
<a href="#l2.1331"></a><span id="l2.1331">   int64_t oldFolderSize = mFolderSize;</span>
<a href="#l2.1332"></a><span id="l2.1332">   // we set this to unknown to force it to get recalculated from disk</span>
<a href="#l2.1333"></a><span id="l2.1333">   mFolderSize = kSizeUnknown;</span>
<a href="#l2.1334"></a><span id="l2.1334">   if (NS_SUCCEEDED(GetSizeOnDisk(&amp;mFolderSize)))</span>
<a href="#l2.1335"></a><span id="l2.1335">     NotifyIntPropertyChanged(kFolderSize, oldFolderSize, mFolderSize);</span>
<a href="#l2.1336"></a><span id="l2.1336">   return NS_OK;</span>
<a href="#l2.1337"></a><span id="l2.1337"> }</span>
<a href="#l2.1338"></a><span id="l2.1338"> </span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetSizeOnDisk(int64_t *aSize)</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineminus">-{</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetSizeOnDisk(int64_t *aSize) {</span>
<a href="#l2.1342"></a><span id="l2.1342">   NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l2.1343"></a><span id="l2.1343"> </span>
<a href="#l2.1344"></a><span id="l2.1344">   bool isServer = false;</span>
<a href="#l2.1345"></a><span id="l2.1345">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l2.1346"></a><span id="l2.1346">   // If this is the rootFolder, return 0 as a safe value.</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineminus">-  if (NS_FAILED(rv) || isServer)</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineminus">-    mFolderSize = 0;</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineminus">-</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineminus">-  if (mFolderSize == kSizeUnknown)</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineminus">-  {</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+  if (NS_FAILED(rv) || isServer) mFolderSize = 0;</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineplus">+</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineplus">+  if (mFolderSize == kSizeUnknown) {</span>
<a href="#l2.1355"></a><span id="l2.1355">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l2.1356"></a><span id="l2.1356">     rv = GetFilePath(getter_AddRefs(file));</span>
<a href="#l2.1357"></a><span id="l2.1357">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1358"></a><span id="l2.1358">     // Use a temporary variable so that we keep mFolderSize on kSizeUnknown</span>
<a href="#l2.1359"></a><span id="l2.1359">     // if GetFileSize() fails.</span>
<a href="#l2.1360"></a><span id="l2.1360">     int64_t folderSize;</span>
<a href="#l2.1361"></a><span id="l2.1361">     rv = file-&gt;GetFileSize(&amp;folderSize);</span>
<a href="#l2.1362"></a><span id="l2.1362">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1363"></a><span id="l2.1363"> </span>
<a href="#l2.1364"></a><span id="l2.1364">     mFolderSize = folderSize;</span>
<a href="#l2.1365"></a><span id="l2.1365">   }</span>
<a href="#l2.1366"></a><span id="l2.1366">   *aSize = mFolderSize;</span>
<a href="#l2.1367"></a><span id="l2.1367">   return NS_OK;</span>
<a href="#l2.1368"></a><span id="l2.1368"> }</span>
<a href="#l2.1369"></a><span id="l2.1369"> </span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineminus">-nsresult</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineminus">-nsMsgLocalMailFolder::GetTrashFolder(nsIMsgFolder** result)</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineminus">-{</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineplus">+nsresult nsMsgLocalMailFolder::GetTrashFolder(nsIMsgFolder **result) {</span>
<a href="#l2.1374"></a><span id="l2.1374">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l2.1375"></a><span id="l2.1375">   nsresult rv;</span>
<a href="#l2.1376"></a><span id="l2.1376">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l2.1377"></a><span id="l2.1377">   rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineminus">-  {</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1381"></a><span id="l2.1381">     rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Trash, result);</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineminus">-    if (!*result)</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+    if (!*result) rv = NS_ERROR_FAILURE;</span>
<a href="#l2.1385"></a><span id="l2.1385">   }</span>
<a href="#l2.1386"></a><span id="l2.1386">   return rv;</span>
<a href="#l2.1387"></a><span id="l2.1387"> }</span>
<a href="#l2.1388"></a><span id="l2.1388"> </span>
<a href="#l2.1389"></a><span id="l2.1389"> NS_IMETHODIMP</span>
<a href="#l2.1390"></a><span id="l2.1390"> nsMsgLocalMailFolder::DeleteMessages(nsIArray *messages,</span>
<a href="#l2.1391"></a><span id="l2.1391">                                      nsIMsgWindow *msgWindow,</span>
<a href="#l2.1392"></a><span id="l2.1392">                                      bool deleteStorage, bool isMove,</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineminus">-                                     nsIMsgCopyServiceListener* listener, bool allowUndo)</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineminus">-{</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineplus">+                                     nsIMsgCopyServiceListener *listener,</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineplus">+                                     bool allowUndo) {</span>
<a href="#l2.1397"></a><span id="l2.1397">   NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l2.1398"></a><span id="l2.1398"> </span>
<a href="#l2.1399"></a><span id="l2.1399">   uint32_t messageCount;</span>
<a href="#l2.1400"></a><span id="l2.1400">   nsresult rv = messages-&gt;GetLength(&amp;messageCount);</span>
<a href="#l2.1401"></a><span id="l2.1401">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1402"></a><span id="l2.1402"> </span>
<a href="#l2.1403"></a><span id="l2.1403">   // shift delete case - (delete to trash is handled in EndMove)</span>
<a href="#l2.1404"></a><span id="l2.1404">   // this is also the case when applying retention settings.</span>
<a href="#l2.1405"></a><span id="l2.1405" class="difflineminus">-  if (deleteStorage &amp;&amp; !isMove)</span>
<a href="#l2.1406"></a><span id="l2.1406" class="difflineminus">-  {</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineplus">+  if (deleteStorage &amp;&amp; !isMove) {</span>
<a href="#l2.1408"></a><span id="l2.1408">     MarkMsgsOnPop3Server(messages, POP3_DELETE);</span>
<a href="#l2.1409"></a><span id="l2.1409">   }</span>
<a href="#l2.1410"></a><span id="l2.1410"> </span>
<a href="#l2.1411"></a><span id="l2.1411">   bool isTrashFolder = mFlags &amp; nsMsgFolderFlags::Trash;</span>
<a href="#l2.1412"></a><span id="l2.1412"> </span>
<a href="#l2.1413"></a><span id="l2.1413">   // notify on delete from trash and shift-delete</span>
<a href="#l2.1414"></a><span id="l2.1414" class="difflineminus">-  if (!isMove &amp;&amp; (deleteStorage || isTrashFolder))</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineminus">-  {</span>
<a href="#l2.1416"></a><span id="l2.1416" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.1417"></a><span id="l2.1417" class="difflineplus">+  if (!isMove &amp;&amp; (deleteStorage || isTrashFolder)) {</span>
<a href="#l2.1418"></a><span id="l2.1418" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l2.1419"></a><span id="l2.1419" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.1420"></a><span id="l2.1420">     if (notifier) {</span>
<a href="#l2.1421"></a><span id="l2.1421" class="difflineminus">-      if (listener)</span>
<a href="#l2.1422"></a><span id="l2.1422" class="difflineminus">-      {</span>
<a href="#l2.1423"></a><span id="l2.1423" class="difflineplus">+      if (listener) {</span>
<a href="#l2.1424"></a><span id="l2.1424">         listener-&gt;OnStartCopy();</span>
<a href="#l2.1425"></a><span id="l2.1425">         listener-&gt;OnStopCopy(NS_OK);</span>
<a href="#l2.1426"></a><span id="l2.1426">       }</span>
<a href="#l2.1427"></a><span id="l2.1427">       notifier-&gt;NotifyMsgsDeleted(messages);</span>
<a href="#l2.1428"></a><span id="l2.1428">     }</span>
<a href="#l2.1429"></a><span id="l2.1429">   }</span>
<a href="#l2.1430"></a><span id="l2.1430"> </span>
<a href="#l2.1431"></a><span id="l2.1431" class="difflineminus">-  if (!deleteStorage &amp;&amp; !isTrashFolder)</span>
<a href="#l2.1432"></a><span id="l2.1432" class="difflineminus">-  {</span>
<a href="#l2.1433"></a><span id="l2.1433" class="difflineplus">+  if (!deleteStorage &amp;&amp; !isTrashFolder) {</span>
<a href="#l2.1434"></a><span id="l2.1434">     nsCOMPtr&lt;nsIMsgFolder&gt; trashFolder;</span>
<a href="#l2.1435"></a><span id="l2.1435">     rv = GetTrashFolder(getter_AddRefs(trashFolder));</span>
<a href="#l2.1436"></a><span id="l2.1436" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1437"></a><span id="l2.1437" class="difflineminus">-    {</span>
<a href="#l2.1438"></a><span id="l2.1438" class="difflineminus">-      nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1439"></a><span id="l2.1439" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1440"></a><span id="l2.1440" class="difflineplus">+      nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l2.1441"></a><span id="l2.1441" class="difflineplus">+          do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1442"></a><span id="l2.1442">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineminus">-      return copyService-&gt;CopyMessages(this, messages, trashFolder,</span>
<a href="#l2.1444"></a><span id="l2.1444" class="difflineminus">-                                       true, listener, msgWindow, allowUndo);</span>
<a href="#l2.1445"></a><span id="l2.1445" class="difflineplus">+      return copyService-&gt;CopyMessages(this, messages, trashFolder, true,</span>
<a href="#l2.1446"></a><span id="l2.1446" class="difflineplus">+                                       listener, msgWindow, allowUndo);</span>
<a href="#l2.1447"></a><span id="l2.1447">     }</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineminus">-  }</span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineminus">-  else</span>
<a href="#l2.1450"></a><span id="l2.1450" class="difflineminus">-  {</span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.1452"></a><span id="l2.1452" class="difflineplus">+  } else {</span>
<a href="#l2.1453"></a><span id="l2.1453" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.1454"></a><span id="l2.1454">     rv = GetDatabaseWOReparse(getter_AddRefs(msgDB));</span>
<a href="#l2.1455"></a><span id="l2.1455" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1456"></a><span id="l2.1456" class="difflineminus">-    {</span>
<a href="#l2.1457"></a><span id="l2.1457" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1458"></a><span id="l2.1458">       if (deleteStorage &amp;&amp; isMove &amp;&amp; GetDeleteFromServerOnMove())</span>
<a href="#l2.1459"></a><span id="l2.1459">         MarkMsgsOnPop3Server(messages, POP3_DELETE);</span>
<a href="#l2.1460"></a><span id="l2.1460"> </span>
<a href="#l2.1461"></a><span id="l2.1461">       nsCOMPtr&lt;nsISupports&gt; msgSupport;</span>
<a href="#l2.1462"></a><span id="l2.1462">       rv = EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l2.1463"></a><span id="l2.1463" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1464"></a><span id="l2.1464" class="difflineminus">-      {</span>
<a href="#l2.1465"></a><span id="l2.1465" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1466"></a><span id="l2.1466">         nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1467"></a><span id="l2.1467">         rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1468"></a><span id="l2.1468" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l2.1469"></a><span id="l2.1469" class="difflineminus">-        {</span>
<a href="#l2.1470"></a><span id="l2.1470" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1471"></a><span id="l2.1471">           rv = msgStore-&gt;DeleteMessages(messages);</span>
<a href="#l2.1472"></a><span id="l2.1472">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l2.1473"></a><span id="l2.1473" class="difflineminus">-          for (uint32_t i = 0; i &lt; messageCount; ++i)</span>
<a href="#l2.1474"></a><span id="l2.1474" class="difflineminus">-          {</span>
<a href="#l2.1475"></a><span id="l2.1475" class="difflineplus">+          for (uint32_t i = 0; i &lt; messageCount; ++i) {</span>
<a href="#l2.1476"></a><span id="l2.1476">             msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l2.1477"></a><span id="l2.1477">             rv = msgDB-&gt;DeleteHeader(msgDBHdr, nullptr, false, true);</span>
<a href="#l2.1478"></a><span id="l2.1478">           }</span>
<a href="#l2.1479"></a><span id="l2.1479">         }</span>
<a href="#l2.1480"></a><span id="l2.1480" class="difflineminus">-      }</span>
<a href="#l2.1481"></a><span id="l2.1481" class="difflineminus">-      else if (rv == NS_MSG_FOLDER_BUSY)</span>
<a href="#l2.1482"></a><span id="l2.1482" class="difflineplus">+      } else if (rv == NS_MSG_FOLDER_BUSY)</span>
<a href="#l2.1483"></a><span id="l2.1483">         ThrowAlertMsg(&quot;deletingMsgsFailed&quot;, msgWindow);</span>
<a href="#l2.1484"></a><span id="l2.1484"> </span>
<a href="#l2.1485"></a><span id="l2.1485">       // we are the source folder here for a move or shift delete</span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineminus">-      //enable notifications because that will close the file stream</span>
<a href="#l2.1487"></a><span id="l2.1487" class="difflineplus">+      // enable notifications because that will close the file stream</span>
<a href="#l2.1488"></a><span id="l2.1488">       // we've been caching, mark the db as valid, and commit it.</span>
<a href="#l2.1489"></a><span id="l2.1489">       EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.1490"></a><span id="l2.1490">       if (!isMove)</span>
<a href="#l2.1491"></a><span id="l2.1491" class="difflineminus">-        NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted : kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1492"></a><span id="l2.1492" class="difflineminus">-      if (msgWindow &amp;&amp; !isMove)</span>
<a href="#l2.1493"></a><span id="l2.1493" class="difflineminus">-        AutoCompact(msgWindow);</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineplus">+        NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted</span>
<a href="#l2.1495"></a><span id="l2.1495" class="difflineplus">+                                           : kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1496"></a><span id="l2.1496" class="difflineplus">+      if (msgWindow &amp;&amp; !isMove) AutoCompact(msgWindow);</span>
<a href="#l2.1497"></a><span id="l2.1497">     }</span>
<a href="#l2.1498"></a><span id="l2.1498">   }</span>
<a href="#l2.1499"></a><span id="l2.1499"> </span>
<a href="#l2.1500"></a><span id="l2.1500">   if (msgWindow &amp;&amp; !isMove &amp;&amp; (deleteStorage || isTrashFolder)) {</span>
<a href="#l2.1501"></a><span id="l2.1501">     // Clear undo and redo stack.</span>
<a href="#l2.1502"></a><span id="l2.1502">     nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l2.1503"></a><span id="l2.1503">     msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l2.1504"></a><span id="l2.1504">     if (txnMgr) {</span>
<a href="#l2.1505"></a><span id="l2.1505">       txnMgr-&gt;Clear();</span>
<a href="#l2.1506"></a><span id="l2.1506">     }</span>
<a href="#l2.1507"></a><span id="l2.1507">   }</span>
<a href="#l2.1508"></a><span id="l2.1508">   return rv;</span>
<a href="#l2.1509"></a><span id="l2.1509"> }</span>
<a href="#l2.1510"></a><span id="l2.1510"> </span>
<a href="#l2.1511"></a><span id="l2.1511"> NS_IMETHODIMP</span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineminus">-nsMsgLocalMailFolder::AddMessageDispositionState(nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag)</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineminus">-{</span>
<a href="#l2.1514"></a><span id="l2.1514" class="difflineplus">+nsMsgLocalMailFolder::AddMessageDispositionState(</span>
<a href="#l2.1515"></a><span id="l2.1515" class="difflineplus">+    nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) {</span>
<a href="#l2.1516"></a><span id="l2.1516">   nsMsgMessageFlagType msgFlag = 0;</span>
<a href="#l2.1517"></a><span id="l2.1517">   switch (aDispositionFlag) {</span>
<a href="#l2.1518"></a><span id="l2.1518">     case nsIMsgFolder::nsMsgDispositionState_Replied:</span>
<a href="#l2.1519"></a><span id="l2.1519">       msgFlag = nsMsgMessageFlags::Replied;</span>
<a href="#l2.1520"></a><span id="l2.1520">       break;</span>
<a href="#l2.1521"></a><span id="l2.1521">     case nsIMsgFolder::nsMsgDispositionState_Forwarded:</span>
<a href="#l2.1522"></a><span id="l2.1522">       msgFlag = nsMsgMessageFlags::Forwarded;</span>
<a href="#l2.1523"></a><span id="l2.1523">       break;</span>
<a href="#l2.1524"></a><span id="l2.1524">     default:</span>
<a href="#l2.1525"></a><span id="l2.1525">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l2.1526"></a><span id="l2.1526">   }</span>
<a href="#l2.1527"></a><span id="l2.1527"> </span>
<a href="#l2.1528"></a><span id="l2.1528" class="difflineminus">-  nsresult rv = nsMsgDBFolder::AddMessageDispositionState(aMessage, aDispositionFlag);</span>
<a href="#l2.1529"></a><span id="l2.1529" class="difflineplus">+  nsresult rv =</span>
<a href="#l2.1530"></a><span id="l2.1530" class="difflineplus">+      nsMsgDBFolder::AddMessageDispositionState(aMessage, aDispositionFlag);</span>
<a href="#l2.1531"></a><span id="l2.1531">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1532"></a><span id="l2.1532"> </span>
<a href="#l2.1533"></a><span id="l2.1533">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1534"></a><span id="l2.1534">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1535"></a><span id="l2.1535">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1536"></a><span id="l2.1536" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.1539"></a><span id="l2.1539">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1540"></a><span id="l2.1540">   messages-&gt;AppendElement(aMessage);</span>
<a href="#l2.1541"></a><span id="l2.1541">   return msgStore-&gt;ChangeFlags(messages, msgFlag, true);</span>
<a href="#l2.1542"></a><span id="l2.1542"> }</span>
<a href="#l2.1543"></a><span id="l2.1543"> </span>
<a href="#l2.1544"></a><span id="l2.1544"> NS_IMETHODIMP</span>
<a href="#l2.1545"></a><span id="l2.1545" class="difflineminus">-nsMsgLocalMailFolder::MarkMessagesRead(nsIArray *aMessages, bool aMarkRead)</span>
<a href="#l2.1546"></a><span id="l2.1546" class="difflineminus">-{</span>
<a href="#l2.1547"></a><span id="l2.1547" class="difflineplus">+nsMsgLocalMailFolder::MarkMessagesRead(nsIArray *aMessages, bool aMarkRead) {</span>
<a href="#l2.1548"></a><span id="l2.1548">   nsresult rv = nsMsgDBFolder::MarkMessagesRead(aMessages, aMarkRead);</span>
<a href="#l2.1549"></a><span id="l2.1549">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1550"></a><span id="l2.1550">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1551"></a><span id="l2.1551">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1552"></a><span id="l2.1552">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1553"></a><span id="l2.1553">   return msgStore-&gt;ChangeFlags(aMessages, nsMsgMessageFlags::Read, aMarkRead);</span>
<a href="#l2.1554"></a><span id="l2.1554"> }</span>
<a href="#l2.1555"></a><span id="l2.1555"> </span>
<a href="#l2.1556"></a><span id="l2.1556"> NS_IMETHODIMP</span>
<a href="#l2.1557"></a><span id="l2.1557"> nsMsgLocalMailFolder::MarkMessagesFlagged(nsIArray *aMessages,</span>
<a href="#l2.1558"></a><span id="l2.1558" class="difflineminus">-                                          bool aMarkFlagged)</span>
<a href="#l2.1559"></a><span id="l2.1559" class="difflineminus">-{</span>
<a href="#l2.1560"></a><span id="l2.1560" class="difflineplus">+                                          bool aMarkFlagged) {</span>
<a href="#l2.1561"></a><span id="l2.1561">   nsresult rv = nsMsgDBFolder::MarkMessagesFlagged(aMessages, aMarkFlagged);</span>
<a href="#l2.1562"></a><span id="l2.1562">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1563"></a><span id="l2.1563">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1564"></a><span id="l2.1564">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1565"></a><span id="l2.1565">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1566"></a><span id="l2.1566">   return msgStore-&gt;ChangeFlags(aMessages, nsMsgMessageFlags::Marked,</span>
<a href="#l2.1567"></a><span id="l2.1567">                                aMarkFlagged);</span>
<a href="#l2.1568"></a><span id="l2.1568"> }</span>
<a href="#l2.1569"></a><span id="l2.1569"> </span>
<a href="#l2.1570"></a><span id="l2.1570"> NS_IMETHODIMP</span>
<a href="#l2.1571"></a><span id="l2.1571" class="difflineminus">-nsMsgLocalMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l2.1572"></a><span id="l2.1572" class="difflineminus">-{</span>
<a href="#l2.1573"></a><span id="l2.1573" class="difflineplus">+nsMsgLocalMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l2.1574"></a><span id="l2.1574">   nsresult rv = GetDatabase();</span>
<a href="#l2.1575"></a><span id="l2.1575">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1576"></a><span id="l2.1576"> </span>
<a href="#l2.1577"></a><span id="l2.1577">   nsMsgKey *thoseMarked = nullptr;</span>
<a href="#l2.1578"></a><span id="l2.1578">   uint32_t numMarked = 0;</span>
<a href="#l2.1579"></a><span id="l2.1579">   EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l2.1580"></a><span id="l2.1580">   rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l2.1581"></a><span id="l2.1581">   EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.1582"></a><span id="l2.1582" class="difflineminus">-  if (NS_FAILED(rv) || !numMarked || !thoseMarked)</span>
<a href="#l2.1583"></a><span id="l2.1583" class="difflineminus">-    return rv;</span>
<a href="#l2.1584"></a><span id="l2.1584" class="difflineplus">+  if (NS_FAILED(rv) || !numMarked || !thoseMarked) return rv;</span>
<a href="#l2.1585"></a><span id="l2.1585"> </span>
<a href="#l2.1586"></a><span id="l2.1586">   do {</span>
<a href="#l2.1587"></a><span id="l2.1587">     nsCOMPtr&lt;nsIMutableArray&gt; messages;</span>
<a href="#l2.1588"></a><span id="l2.1588" class="difflineminus">-    rv = MsgGetHdrsFromKeys(mDatabase, thoseMarked, numMarked, getter_AddRefs(messages));</span>
<a href="#l2.1589"></a><span id="l2.1589" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1590"></a><span id="l2.1590" class="difflineminus">-      break;</span>
<a href="#l2.1591"></a><span id="l2.1591" class="difflineplus">+    rv = MsgGetHdrsFromKeys(mDatabase, thoseMarked, numMarked,</span>
<a href="#l2.1592"></a><span id="l2.1592" class="difflineplus">+                            getter_AddRefs(messages));</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1594"></a><span id="l2.1594"> </span>
<a href="#l2.1595"></a><span id="l2.1595">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1596"></a><span id="l2.1596">     rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineminus">-      break;</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1600"></a><span id="l2.1600"> </span>
<a href="#l2.1601"></a><span id="l2.1601">     rv = msgStore-&gt;ChangeFlags(messages, nsMsgMessageFlags::Read, true);</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1603"></a><span id="l2.1603" class="difflineminus">-      break;</span>
<a href="#l2.1604"></a><span id="l2.1604" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1605"></a><span id="l2.1605"> </span>
<a href="#l2.1606"></a><span id="l2.1606">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.1607"></a><span id="l2.1607"> </span>
<a href="#l2.1608"></a><span id="l2.1608">     // Setup a undo-state</span>
<a href="#l2.1609"></a><span id="l2.1609">     if (aMsgWindow)</span>
<a href="#l2.1610"></a><span id="l2.1610">       rv = AddMarkAllReadUndoAction(aMsgWindow, thoseMarked, numMarked);</span>
<a href="#l2.1611"></a><span id="l2.1611">   } while (false);</span>
<a href="#l2.1612"></a><span id="l2.1612"> </span>
<a href="#l2.1613"></a><span id="l2.1613">   free(thoseMarked);</span>
<a href="#l2.1614"></a><span id="l2.1614">   return rv;</span>
<a href="#l2.1615"></a><span id="l2.1615"> }</span>
<a href="#l2.1616"></a><span id="l2.1616"> </span>
<a href="#l2.1617"></a><span id="l2.1617" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::MarkThreadRead(nsIMsgThread *thread)</span>
<a href="#l2.1618"></a><span id="l2.1618" class="difflineminus">-{</span>
<a href="#l2.1619"></a><span id="l2.1619" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::MarkThreadRead(nsIMsgThread *thread) {</span>
<a href="#l2.1620"></a><span id="l2.1620">   nsresult rv = GetDatabase();</span>
<a href="#l2.1621"></a><span id="l2.1621">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1622"></a><span id="l2.1622"> </span>
<a href="#l2.1623"></a><span id="l2.1623">   nsMsgKey *thoseMarked = nullptr;</span>
<a href="#l2.1624"></a><span id="l2.1624">   uint32_t numMarked = 0;</span>
<a href="#l2.1625"></a><span id="l2.1625">   rv = mDatabase-&gt;MarkThreadRead(thread, nullptr, &amp;numMarked, &amp;thoseMarked);</span>
<a href="#l2.1626"></a><span id="l2.1626" class="difflineminus">-  if (NS_FAILED(rv) || !numMarked || !thoseMarked)</span>
<a href="#l2.1627"></a><span id="l2.1627" class="difflineminus">-    return rv;</span>
<a href="#l2.1628"></a><span id="l2.1628" class="difflineplus">+  if (NS_FAILED(rv) || !numMarked || !thoseMarked) return rv;</span>
<a href="#l2.1629"></a><span id="l2.1629"> </span>
<a href="#l2.1630"></a><span id="l2.1630">   do {</span>
<a href="#l2.1631"></a><span id="l2.1631">     nsCOMPtr&lt;nsIMutableArray&gt; messages;</span>
<a href="#l2.1632"></a><span id="l2.1632" class="difflineminus">-    rv = MsgGetHdrsFromKeys(mDatabase, thoseMarked, numMarked, getter_AddRefs(messages));</span>
<a href="#l2.1633"></a><span id="l2.1633" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1634"></a><span id="l2.1634" class="difflineminus">-      break;</span>
<a href="#l2.1635"></a><span id="l2.1635" class="difflineplus">+    rv = MsgGetHdrsFromKeys(mDatabase, thoseMarked, numMarked,</span>
<a href="#l2.1636"></a><span id="l2.1636" class="difflineplus">+                            getter_AddRefs(messages));</span>
<a href="#l2.1637"></a><span id="l2.1637" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1638"></a><span id="l2.1638"> </span>
<a href="#l2.1639"></a><span id="l2.1639">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1640"></a><span id="l2.1640">     rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1641"></a><span id="l2.1641" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1642"></a><span id="l2.1642" class="difflineminus">-      break;</span>
<a href="#l2.1643"></a><span id="l2.1643" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1644"></a><span id="l2.1644"> </span>
<a href="#l2.1645"></a><span id="l2.1645">     rv = msgStore-&gt;ChangeFlags(messages, nsMsgMessageFlags::Read, true);</span>
<a href="#l2.1646"></a><span id="l2.1646" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.1647"></a><span id="l2.1647" class="difflineminus">-      break;</span>
<a href="#l2.1648"></a><span id="l2.1648" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l2.1649"></a><span id="l2.1649"> </span>
<a href="#l2.1650"></a><span id="l2.1650">     mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.1651"></a><span id="l2.1651">   } while (false);</span>
<a href="#l2.1652"></a><span id="l2.1652"> </span>
<a href="#l2.1653"></a><span id="l2.1653">   free(thoseMarked);</span>
<a href="#l2.1654"></a><span id="l2.1654">   return rv;</span>
<a href="#l2.1655"></a><span id="l2.1655"> }</span>
<a href="#l2.1656"></a><span id="l2.1656"> </span>
<a href="#l2.1657"></a><span id="l2.1657" class="difflineminus">-nsresult</span>
<a href="#l2.1658"></a><span id="l2.1658" class="difflineminus">-nsMsgLocalMailFolder::InitCopyState(nsISupports* aSupport,</span>
<a href="#l2.1659"></a><span id="l2.1659" class="difflineminus">-                                    nsIArray* messages,</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineminus">-                                    bool isMove,</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineminus">-                                    nsIMsgCopyServiceListener* listener,</span>
<a href="#l2.1662"></a><span id="l2.1662" class="difflineminus">-                                    nsIMsgWindow *msgWindow, bool isFolder,</span>
<a href="#l2.1663"></a><span id="l2.1663" class="difflineminus">-                                    bool allowUndo)</span>
<a href="#l2.1664"></a><span id="l2.1664" class="difflineminus">-{</span>
<a href="#l2.1665"></a><span id="l2.1665" class="difflineplus">+nsresult nsMsgLocalMailFolder::InitCopyState(</span>
<a href="#l2.1666"></a><span id="l2.1666" class="difflineplus">+    nsISupports *aSupport, nsIArray *messages, bool isMove,</span>
<a href="#l2.1667"></a><span id="l2.1667" class="difflineplus">+    nsIMsgCopyServiceListener *listener, nsIMsgWindow *msgWindow, bool isFolder,</span>
<a href="#l2.1668"></a><span id="l2.1668" class="difflineplus">+    bool allowUndo) {</span>
<a href="#l2.1669"></a><span id="l2.1669">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l2.1670"></a><span id="l2.1670"> </span>
<a href="#l2.1671"></a><span id="l2.1671">   NS_ASSERTION(!mCopyState, &quot;already copying a msg into this folder&quot;);</span>
<a href="#l2.1672"></a><span id="l2.1672" class="difflineminus">-  if (mCopyState)</span>
<a href="#l2.1673"></a><span id="l2.1673" class="difflineminus">-    return NS_ERROR_FAILURE; // already has a  copy in progress</span>
<a href="#l2.1674"></a><span id="l2.1674" class="difflineplus">+  if (mCopyState) return NS_ERROR_FAILURE;  // already has a  copy in progress</span>
<a href="#l2.1675"></a><span id="l2.1675"> </span>
<a href="#l2.1676"></a><span id="l2.1676">   // get mDatabase set, so we can use it to add new hdrs to this db.</span>
<a href="#l2.1677"></a><span id="l2.1677">   // calling GetDatabase will set mDatabase - we use the comptr</span>
<a href="#l2.1678"></a><span id="l2.1678">   // here to avoid doubling the refcnt on mDatabase. We don't care if this</span>
<a href="#l2.1679"></a><span id="l2.1679">   // fails - we just want to give it a chance. It will definitely fail in</span>
<a href="#l2.1680"></a><span id="l2.1680">   // nsLocalMailFolder::EndCopy because we will have written data to the folder</span>
<a href="#l2.1681"></a><span id="l2.1681">   // and changed its size.</span>
<a href="#l2.1682"></a><span id="l2.1682" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.1683"></a><span id="l2.1683" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l2.1684"></a><span id="l2.1684">   GetDatabaseWOReparse(getter_AddRefs(msgDB));</span>
<a href="#l2.1685"></a><span id="l2.1685">   bool isLocked;</span>
<a href="#l2.1686"></a><span id="l2.1686"> </span>
<a href="#l2.1687"></a><span id="l2.1687">   GetLocked(&amp;isLocked);</span>
<a href="#l2.1688"></a><span id="l2.1688" class="difflineminus">-  if (isLocked)</span>
<a href="#l2.1689"></a><span id="l2.1689" class="difflineminus">-    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l2.1690"></a><span id="l2.1690" class="difflineminus">-</span>
<a href="#l2.1691"></a><span id="l2.1691" class="difflineminus">-  AcquireSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l2.1692"></a><span id="l2.1692" class="difflineplus">+  if (isLocked) return NS_MSG_FOLDER_BUSY;</span>
<a href="#l2.1693"></a><span id="l2.1693" class="difflineplus">+</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineplus">+  AcquireSemaphore(static_cast&lt;nsIMsgLocalMailFolder *&gt;(this));</span>
<a href="#l2.1695"></a><span id="l2.1695"> </span>
<a href="#l2.1696"></a><span id="l2.1696">   mCopyState = new nsLocalMailCopyState();</span>
<a href="#l2.1697"></a><span id="l2.1697">   NS_ENSURE_TRUE(mCopyState, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1698"></a><span id="l2.1698"> </span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineminus">-  mCopyState-&gt;m_dataBuffer = (char*) PR_CALLOC(COPY_BUFFER_SIZE+1);</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineplus">+  mCopyState-&gt;m_dataBuffer = (char *)PR_CALLOC(COPY_BUFFER_SIZE + 1);</span>
<a href="#l2.1701"></a><span id="l2.1701">   NS_ENSURE_TRUE(mCopyState-&gt;m_dataBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.1702"></a><span id="l2.1702"> </span>
<a href="#l2.1703"></a><span id="l2.1703">   mCopyState-&gt;m_dataBufferSize = COPY_BUFFER_SIZE;</span>
<a href="#l2.1704"></a><span id="l2.1704">   mCopyState-&gt;m_destDB = msgDB;</span>
<a href="#l2.1705"></a><span id="l2.1705"> </span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineminus">-  //Before we continue we should verify that there is enough diskspace.</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineminus">-  //XXX How do we do this?</span>
<a href="#l2.1708"></a><span id="l2.1708" class="difflineplus">+  // Before we continue we should verify that there is enough diskspace.</span>
<a href="#l2.1709"></a><span id="l2.1709" class="difflineplus">+  // XXX How do we do this?</span>
<a href="#l2.1710"></a><span id="l2.1710">   nsresult rv;</span>
<a href="#l2.1711"></a><span id="l2.1711">   mCopyState-&gt;m_srcSupport = do_QueryInterface(aSupport, &amp;rv);</span>
<a href="#l2.1712"></a><span id="l2.1712">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1713"></a><span id="l2.1713">   mCopyState-&gt;m_messages = messages;</span>
<a href="#l2.1714"></a><span id="l2.1714">   mCopyState-&gt;m_curCopyIndex = 0;</span>
<a href="#l2.1715"></a><span id="l2.1715">   mCopyState-&gt;m_isMove = isMove;</span>
<a href="#l2.1716"></a><span id="l2.1716">   mCopyState-&gt;m_isFolder = isFolder;</span>
<a href="#l2.1717"></a><span id="l2.1717">   mCopyState-&gt;m_allowUndo = allowUndo;</span>
<a href="#l2.1718"></a><span id="l2.1718">   mCopyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l2.1719"></a><span id="l2.1719">   rv = messages-&gt;GetLength(&amp;mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.1720"></a><span id="l2.1720" class="difflineminus">-  if (listener)</span>
<a href="#l2.1721"></a><span id="l2.1721" class="difflineminus">-    mCopyState-&gt;m_listener = listener;</span>
<a href="#l2.1722"></a><span id="l2.1722" class="difflineplus">+  if (listener) mCopyState-&gt;m_listener = listener;</span>
<a href="#l2.1723"></a><span id="l2.1723">   mCopyState-&gt;m_copyingMultipleMessages = false;</span>
<a href="#l2.1724"></a><span id="l2.1724">   mCopyState-&gt;m_wholeMsgInStream = false;</span>
<a href="#l2.1725"></a><span id="l2.1725"> </span>
<a href="#l2.1726"></a><span id="l2.1726">   // If we have source messages then we need destination messages too.</span>
<a href="#l2.1727"></a><span id="l2.1727">   if (messages)</span>
<a href="#l2.1728"></a><span id="l2.1728">     mCopyState-&gt;m_destMessages = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l2.1729"></a><span id="l2.1729"> </span>
<a href="#l2.1730"></a><span id="l2.1730">   return rv;</span>
<a href="#l2.1731"></a><span id="l2.1731"> }</span>
<a href="#l2.1732"></a><span id="l2.1732"> </span>
<a href="#l2.1733"></a><span id="l2.1733" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l2.1734"></a><span id="l2.1734" class="difflineminus">-{</span>
<a href="#l2.1735"></a><span id="l2.1735" class="difflineminus">-  if (mCopyState)</span>
<a href="#l2.1736"></a><span id="l2.1736" class="difflineminus">-    mCopyState-&gt;m_destDB = nullptr;</span>
<a href="#l2.1737"></a><span id="l2.1737" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::OnAnnouncerGoingAway(</span>
<a href="#l2.1738"></a><span id="l2.1738" class="difflineplus">+    nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineplus">+  if (mCopyState) mCopyState-&gt;m_destDB = nullptr;</span>
<a href="#l2.1740"></a><span id="l2.1740">   return nsMsgDBFolder::OnAnnouncerGoingAway(instigator);</span>
<a href="#l2.1741"></a><span id="l2.1741"> }</span>
<a href="#l2.1742"></a><span id="l2.1742"> </span>
<a href="#l2.1743"></a><span id="l2.1743"> NS_IMETHODIMP</span>
<a href="#l2.1744"></a><span id="l2.1744" class="difflineminus">-nsMsgLocalMailFolder::OnCopyCompleted(nsISupports *srcSupport, bool moveCopySucceeded)</span>
<a href="#l2.1745"></a><span id="l2.1745" class="difflineminus">-{</span>
<a href="#l2.1746"></a><span id="l2.1746" class="difflineplus">+nsMsgLocalMailFolder::OnCopyCompleted(nsISupports *srcSupport,</span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineplus">+                                      bool moveCopySucceeded) {</span>
<a href="#l2.1748"></a><span id="l2.1748">   if (mCopyState &amp;&amp; mCopyState-&gt;m_notifyFolderLoaded)</span>
<a href="#l2.1749"></a><span id="l2.1749">     NotifyFolderEvent(kFolderLoaded);</span>
<a href="#l2.1750"></a><span id="l2.1750"> </span>
<a href="#l2.1751"></a><span id="l2.1751" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l2.1752"></a><span id="l2.1752" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l2.1753"></a><span id="l2.1753">   // we are the destination folder for a move/copy</span>
<a href="#l2.1754"></a><span id="l2.1754">   bool haveSemaphore;</span>
<a href="#l2.1755"></a><span id="l2.1755" class="difflineminus">-  nsresult rv = TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this), &amp;haveSemaphore);</span>
<a href="#l2.1756"></a><span id="l2.1756" class="difflineplus">+  nsresult rv =</span>
<a href="#l2.1757"></a><span id="l2.1757" class="difflineplus">+      TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder *&gt;(this), &amp;haveSemaphore);</span>
<a href="#l2.1758"></a><span id="l2.1758">   if (NS_SUCCEEDED(rv) &amp;&amp; haveSemaphore)</span>
<a href="#l2.1759"></a><span id="l2.1759" class="difflineminus">-    ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineplus">+    ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder *&gt;(this));</span>
<a href="#l2.1761"></a><span id="l2.1761"> </span>
<a href="#l2.1762"></a><span id="l2.1762">   if (mCopyState &amp;&amp; !mCopyState-&gt;m_newMsgKeywords.IsEmpty() &amp;&amp;</span>
<a href="#l2.1763"></a><span id="l2.1763" class="difflineminus">-      mCopyState-&gt;m_newHdr)</span>
<a href="#l2.1764"></a><span id="l2.1764" class="difflineminus">-  {</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineplus">+      mCopyState-&gt;m_newHdr) {</span>
<a href="#l2.1767"></a><span id="l2.1767" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l2.1768"></a><span id="l2.1768" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l2.1769"></a><span id="l2.1769">     NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l2.1770"></a><span id="l2.1770">     messageArray-&gt;AppendElement(mCopyState-&gt;m_newHdr);</span>
<a href="#l2.1771"></a><span id="l2.1771">     AddKeywordsToMessages(messageArray, mCopyState-&gt;m_newMsgKeywords);</span>
<a href="#l2.1772"></a><span id="l2.1772">   }</span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineminus">-  if (moveCopySucceeded &amp;&amp; mDatabase)</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineminus">-  {</span>
<a href="#l2.1775"></a><span id="l2.1775" class="difflineplus">+  if (moveCopySucceeded &amp;&amp; mDatabase) {</span>
<a href="#l2.1776"></a><span id="l2.1776">     mDatabase-&gt;SetSummaryValid(true);</span>
<a href="#l2.1777"></a><span id="l2.1777" class="difflineminus">-    (void) CloseDBIfFolderNotOpen();</span>
<a href="#l2.1778"></a><span id="l2.1778" class="difflineplus">+    (void)CloseDBIfFolderNotOpen();</span>
<a href="#l2.1779"></a><span id="l2.1779">   }</span>
<a href="#l2.1780"></a><span id="l2.1780"> </span>
<a href="#l2.1781"></a><span id="l2.1781">   delete mCopyState;</span>
<a href="#l2.1782"></a><span id="l2.1782">   mCopyState = nullptr;</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l2.1785"></a><span id="l2.1785" class="difflineplus">+      do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.1786"></a><span id="l2.1786">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1787"></a><span id="l2.1787" class="difflineminus">-  return copyService-&gt;NotifyCompletion(srcSupport, this, moveCopySucceeded ? NS_OK : NS_ERROR_FAILURE);</span>
<a href="#l2.1788"></a><span id="l2.1788" class="difflineplus">+  return copyService-&gt;NotifyCompletion(</span>
<a href="#l2.1789"></a><span id="l2.1789" class="difflineplus">+      srcSupport, this, moveCopySucceeded ? NS_OK : NS_ERROR_FAILURE);</span>
<a href="#l2.1790"></a><span id="l2.1790"> }</span>
<a href="#l2.1791"></a><span id="l2.1791"> </span>
<a href="#l2.1792"></a><span id="l2.1792"> bool nsMsgLocalMailFolder::CheckIfSpaceForCopy(nsIMsgWindow *msgWindow,</span>
<a href="#l2.1793"></a><span id="l2.1793" class="difflineminus">-                                                 nsIMsgFolder *srcFolder,</span>
<a href="#l2.1794"></a><span id="l2.1794" class="difflineminus">-                                                 nsISupports *srcSupports,</span>
<a href="#l2.1795"></a><span id="l2.1795" class="difflineminus">-                                                 bool isMove,</span>
<a href="#l2.1796"></a><span id="l2.1796" class="difflineminus">-                                                 int64_t totalMsgSize)</span>
<a href="#l2.1797"></a><span id="l2.1797" class="difflineminus">-{</span>
<a href="#l2.1798"></a><span id="l2.1798" class="difflineplus">+                                               nsIMsgFolder *srcFolder,</span>
<a href="#l2.1799"></a><span id="l2.1799" class="difflineplus">+                                               nsISupports *srcSupports,</span>
<a href="#l2.1800"></a><span id="l2.1800" class="difflineplus">+                                               bool isMove,</span>
<a href="#l2.1801"></a><span id="l2.1801" class="difflineplus">+                                               int64_t totalMsgSize) {</span>
<a href="#l2.1802"></a><span id="l2.1802">   bool spaceNotAvailable = true;</span>
<a href="#l2.1803"></a><span id="l2.1803" class="difflineminus">-  nsresult rv = WarnIfLocalFileTooBig(msgWindow, totalMsgSize, &amp;spaceNotAvailable);</span>
<a href="#l2.1804"></a><span id="l2.1804" class="difflineminus">-  if (NS_FAILED(rv) || spaceNotAvailable)</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineminus">-  {</span>
<a href="#l2.1806"></a><span id="l2.1806" class="difflineplus">+  nsresult rv =</span>
<a href="#l2.1807"></a><span id="l2.1807" class="difflineplus">+      WarnIfLocalFileTooBig(msgWindow, totalMsgSize, &amp;spaceNotAvailable);</span>
<a href="#l2.1808"></a><span id="l2.1808" class="difflineplus">+  if (NS_FAILED(rv) || spaceNotAvailable) {</span>
<a href="#l2.1809"></a><span id="l2.1809">     if (isMove &amp;&amp; srcFolder)</span>
<a href="#l2.1810"></a><span id="l2.1810">       srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1811"></a><span id="l2.1811">     OnCopyCompleted(srcSupports, false);</span>
<a href="#l2.1812"></a><span id="l2.1812">     return false;</span>
<a href="#l2.1813"></a><span id="l2.1813">   }</span>
<a href="#l2.1814"></a><span id="l2.1814">   return true;</span>
<a href="#l2.1815"></a><span id="l2.1815"> }</span>
<a href="#l2.1816"></a><span id="l2.1816"> </span>
<a href="#l2.1817"></a><span id="l2.1817"> NS_IMETHODIMP</span>
<a href="#l2.1818"></a><span id="l2.1818" class="difflineminus">-nsMsgLocalMailFolder::CopyMessages(nsIMsgFolder* srcFolder, nsIArray*</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineminus">-                                   messages, bool isMove,</span>
<a href="#l2.1820"></a><span id="l2.1820" class="difflineminus">-                                   nsIMsgWindow *msgWindow,</span>
<a href="#l2.1821"></a><span id="l2.1821" class="difflineminus">-                                   nsIMsgCopyServiceListener* listener,</span>
<a href="#l2.1822"></a><span id="l2.1822" class="difflineminus">-                                   bool isFolder, bool allowUndo)</span>
<a href="#l2.1823"></a><span id="l2.1823" class="difflineminus">-{</span>
<a href="#l2.1824"></a><span id="l2.1824" class="difflineplus">+nsMsgLocalMailFolder::CopyMessages(nsIMsgFolder *srcFolder, nsIArray *messages,</span>
<a href="#l2.1825"></a><span id="l2.1825" class="difflineplus">+                                   bool isMove, nsIMsgWindow *msgWindow,</span>
<a href="#l2.1826"></a><span id="l2.1826" class="difflineplus">+                                   nsIMsgCopyServiceListener *listener,</span>
<a href="#l2.1827"></a><span id="l2.1827" class="difflineplus">+                                   bool isFolder, bool allowUndo) {</span>
<a href="#l2.1828"></a><span id="l2.1828">   nsCOMPtr&lt;nsISupports&gt; srcSupport = do_QueryInterface(srcFolder);</span>
<a href="#l2.1829"></a><span id="l2.1829">   bool isServer;</span>
<a href="#l2.1830"></a><span id="l2.1830">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l2.1831"></a><span id="l2.1831" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l2.1832"></a><span id="l2.1832" class="difflineminus">-  {</span>
<a href="#l2.1833"></a><span id="l2.1833" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; isServer) {</span>
<a href="#l2.1834"></a><span id="l2.1834">     NS_ERROR(&quot;Destination is the root folder. Cannot move/copy here&quot;);</span>
<a href="#l2.1835"></a><span id="l2.1835" class="difflineminus">-    if (isMove)</span>
<a href="#l2.1836"></a><span id="l2.1836" class="difflineminus">-      srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineplus">+    if (isMove) srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1838"></a><span id="l2.1838">     return OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.1839"></a><span id="l2.1839">   }</span>
<a href="#l2.1840"></a><span id="l2.1840"> </span>
<a href="#l2.1841"></a><span id="l2.1841">   UpdateTimestamps(allowUndo);</span>
<a href="#l2.1842"></a><span id="l2.1842">   nsCString protocolType;</span>
<a href="#l2.1843"></a><span id="l2.1843">   rv = srcFolder-&gt;GetURI(protocolType);</span>
<a href="#l2.1844"></a><span id="l2.1844">   protocolType.SetLength(protocolType.FindChar(':'));</span>
<a href="#l2.1845"></a><span id="l2.1845"> </span>
<a href="#l2.1846"></a><span id="l2.1846" class="difflineminus">-  bool needOfflineBody = (WeAreOffline() &amp;&amp;</span>
<a href="#l2.1847"></a><span id="l2.1847" class="difflineminus">-    (MsgLowerCaseEqualsLiteral(protocolType, &quot;imap&quot;) ||</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineminus">-     MsgLowerCaseEqualsLiteral(protocolType, &quot;news&quot;)));</span>
<a href="#l2.1849"></a><span id="l2.1849" class="difflineplus">+  bool needOfflineBody =</span>
<a href="#l2.1850"></a><span id="l2.1850" class="difflineplus">+      (WeAreOffline() &amp;&amp; (MsgLowerCaseEqualsLiteral(protocolType, &quot;imap&quot;) ||</span>
<a href="#l2.1851"></a><span id="l2.1851" class="difflineplus">+                          MsgLowerCaseEqualsLiteral(protocolType, &quot;news&quot;)));</span>
<a href="#l2.1852"></a><span id="l2.1852">   int64_t totalMsgSize = 0;</span>
<a href="#l2.1853"></a><span id="l2.1853">   uint32_t numMessages = 0;</span>
<a href="#l2.1854"></a><span id="l2.1854">   messages-&gt;GetLength(&amp;numMessages);</span>
<a href="#l2.1855"></a><span id="l2.1855" class="difflineminus">-  for (uint32_t i = 0; i &lt; numMessages; i++)</span>
<a href="#l2.1856"></a><span id="l2.1856" class="difflineminus">-  {</span>
<a href="#l2.1857"></a><span id="l2.1857" class="difflineplus">+  for (uint32_t i = 0; i &lt; numMessages; i++) {</span>
<a href="#l2.1858"></a><span id="l2.1858">     nsCOMPtr&lt;nsIMsgDBHdr&gt; message(do_QueryElementAt(messages, i, &amp;rv));</span>
<a href="#l2.1859"></a><span id="l2.1859" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; message)</span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineminus">-    {</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; message) {</span>
<a href="#l2.1862"></a><span id="l2.1862">       nsMsgKey key;</span>
<a href="#l2.1863"></a><span id="l2.1863">       uint32_t msgSize;</span>
<a href="#l2.1864"></a><span id="l2.1864">       message-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l2.1865"></a><span id="l2.1865"> </span>
<a href="#l2.1866"></a><span id="l2.1866">       /* 200 is a per-message overhead to account for any extra data added</span>
<a href="#l2.1867"></a><span id="l2.1867">          to the message.</span>
<a href="#l2.1868"></a><span id="l2.1868">       */</span>
<a href="#l2.1869"></a><span id="l2.1869">       totalMsgSize += msgSize + 200;</span>
<a href="#l2.1870"></a><span id="l2.1870"> </span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineminus">-      if (needOfflineBody)</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineminus">-      {</span>
<a href="#l2.1873"></a><span id="l2.1873" class="difflineplus">+      if (needOfflineBody) {</span>
<a href="#l2.1874"></a><span id="l2.1874">         bool hasMsgOffline = false;</span>
<a href="#l2.1875"></a><span id="l2.1875">         message-&gt;GetMessageKey(&amp;key);</span>
<a href="#l2.1876"></a><span id="l2.1876">         srcFolder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l2.1877"></a><span id="l2.1877" class="difflineminus">-        if (!hasMsgOffline)</span>
<a href="#l2.1878"></a><span id="l2.1878" class="difflineminus">-        {</span>
<a href="#l2.1879"></a><span id="l2.1879" class="difflineminus">-          if (isMove)</span>
<a href="#l2.1880"></a><span id="l2.1880" class="difflineminus">-            srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineplus">+        if (!hasMsgOffline) {</span>
<a href="#l2.1882"></a><span id="l2.1882" class="difflineplus">+          if (isMove) srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1883"></a><span id="l2.1883">           ThrowAlertMsg(&quot;cantMoveMsgWOBodyOffline&quot;, msgWindow);</span>
<a href="#l2.1884"></a><span id="l2.1884">           return OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.1885"></a><span id="l2.1885">         }</span>
<a href="#l2.1886"></a><span id="l2.1886">       }</span>
<a href="#l2.1887"></a><span id="l2.1887">     }</span>
<a href="#l2.1888"></a><span id="l2.1888">   }</span>
<a href="#l2.1889"></a><span id="l2.1889"> </span>
<a href="#l2.1890"></a><span id="l2.1890">   if (!CheckIfSpaceForCopy(msgWindow, srcFolder, srcSupport, isMove,</span>
<a href="#l2.1891"></a><span id="l2.1891" class="difflineat">@@ -1515,44 +1367,40 @@ nsMsgLocalMailFolder::CopyMessages(nsIMs</span>
<a href="#l2.1892"></a><span id="l2.1892">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.1893"></a><span id="l2.1893">   rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.1894"></a><span id="l2.1894">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1895"></a><span id="l2.1895">   nsCOMPtr&lt;nsITransaction&gt; undoTxn;</span>
<a href="#l2.1896"></a><span id="l2.1896">   nsCOMPtr&lt;nsIArray&gt; dstHdrs;</span>
<a href="#l2.1897"></a><span id="l2.1897">   rv = msgStore-&gt;CopyMessages(isMove, messages, this, listener,</span>
<a href="#l2.1898"></a><span id="l2.1898">                               getter_AddRefs(dstHdrs), getter_AddRefs(undoTxn),</span>
<a href="#l2.1899"></a><span id="l2.1899">                               &amp;storeDidCopy);</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineminus">-  if (storeDidCopy)</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineminus">-  {</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineplus">+  if (storeDidCopy) {</span>
<a href="#l2.1903"></a><span id="l2.1903">     NS_ASSERTION(undoTxn, &quot;if store does copy, it needs to add undo action&quot;);</span>
<a href="#l2.1904"></a><span id="l2.1904" class="difflineminus">-    if (msgWindow &amp;&amp; undoTxn)</span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-    {</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineplus">+    if (msgWindow &amp;&amp; undoTxn) {</span>
<a href="#l2.1907"></a><span id="l2.1907">       nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l2.1908"></a><span id="l2.1908">       msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineminus">-      if (txnMgr)</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineminus">-        txnMgr-&gt;DoTransaction(undoTxn);</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineplus">+      if (txnMgr) txnMgr-&gt;DoTransaction(undoTxn);</span>
<a href="#l2.1912"></a><span id="l2.1912">     }</span>
<a href="#l2.1913"></a><span id="l2.1913">     if (isMove)</span>
<a href="#l2.1914"></a><span id="l2.1914" class="difflineminus">-      srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted :</span>
<a href="#l2.1915"></a><span id="l2.1915" class="difflineminus">-                                                      kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1916"></a><span id="l2.1916" class="difflineplus">+      srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted</span>
<a href="#l2.1917"></a><span id="l2.1917" class="difflineplus">+                                                    : kDeleteOrMoveMsgFailed);</span>
<a href="#l2.1918"></a><span id="l2.1918"> </span>
<a href="#l2.1919"></a><span id="l2.1919">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineminus">-      // If the store did the copy, like maildir, we need to mark messages on the server.</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineminus">-      // Otherwise that's done in EndMove().</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineminus">-      nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localDstFolder;</span>
<a href="#l2.1923"></a><span id="l2.1923" class="difflineminus">-      QueryInterface(NS_GET_IID(nsIMsgLocalMailFolder), getter_AddRefs(localDstFolder));</span>
<a href="#l2.1924"></a><span id="l2.1924" class="difflineminus">-      if (localDstFolder)</span>
<a href="#l2.1925"></a><span id="l2.1925" class="difflineminus">-      {</span>
<a href="#l2.1926"></a><span id="l2.1926" class="difflineminus">-        // If we are the trash and a local msg is being moved to us, mark the source</span>
<a href="#l2.1927"></a><span id="l2.1927" class="difflineminus">-        // for delete from server, if so configured.</span>
<a href="#l2.1928"></a><span id="l2.1928" class="difflineminus">-        if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l2.1929"></a><span id="l2.1929" class="difflineminus">-        {</span>
<a href="#l2.1930"></a><span id="l2.1930" class="difflineminus">-          // If we're deleting on all moves, we'll mark this message for deletion when</span>
<a href="#l2.1931"></a><span id="l2.1931" class="difflineminus">-          // we call DeleteMessages on the source folder. So don't mark it for deletion</span>
<a href="#l2.1932"></a><span id="l2.1932" class="difflineminus">-          // here, in that case.</span>
<a href="#l2.1933"></a><span id="l2.1933" class="difflineplus">+      // If the store did the copy, like maildir, we need to mark messages on</span>
<a href="#l2.1934"></a><span id="l2.1934" class="difflineplus">+      // the server. Otherwise that's done in EndMove().</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineplus">+      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localDstFolder;</span>
<a href="#l2.1936"></a><span id="l2.1936" class="difflineplus">+      QueryInterface(NS_GET_IID(nsIMsgLocalMailFolder),</span>
<a href="#l2.1937"></a><span id="l2.1937" class="difflineplus">+                     getter_AddRefs(localDstFolder));</span>
<a href="#l2.1938"></a><span id="l2.1938" class="difflineplus">+      if (localDstFolder) {</span>
<a href="#l2.1939"></a><span id="l2.1939" class="difflineplus">+        // If we are the trash and a local msg is being moved to us, mark the</span>
<a href="#l2.1940"></a><span id="l2.1940" class="difflineplus">+        // source for delete from server, if so configured.</span>
<a href="#l2.1941"></a><span id="l2.1941" class="difflineplus">+        if (mFlags &amp; nsMsgFolderFlags::Trash) {</span>
<a href="#l2.1942"></a><span id="l2.1942" class="difflineplus">+          // If we're deleting on all moves, we'll mark this message for</span>
<a href="#l2.1943"></a><span id="l2.1943" class="difflineplus">+          // deletion when we call DeleteMessages on the source folder. So don't</span>
<a href="#l2.1944"></a><span id="l2.1944" class="difflineplus">+          // mark it for deletion here, in that case.</span>
<a href="#l2.1945"></a><span id="l2.1945">           if (!GetDeleteFromServerOnMove())</span>
<a href="#l2.1946"></a><span id="l2.1946">             localDstFolder-&gt;MarkMsgsOnPop3Server(dstHdrs, POP3_DELETE);</span>
<a href="#l2.1947"></a><span id="l2.1947">         }</span>
<a href="#l2.1948"></a><span id="l2.1948">       }</span>
<a href="#l2.1949"></a><span id="l2.1949">     }</span>
<a href="#l2.1950"></a><span id="l2.1950">     return rv;</span>
<a href="#l2.1951"></a><span id="l2.1951">   }</span>
<a href="#l2.1952"></a><span id="l2.1952">   // If the store doesn't do the copy, we'll stream the source messages into</span>
<a href="#l2.1953"></a><span id="l2.1953" class="difflineat">@@ -1560,259 +1408,233 @@ nsMsgLocalMailFolder::CopyMessages(nsIMs</span>
<a href="#l2.1954"></a><span id="l2.1954"> </span>
<a href="#l2.1955"></a><span id="l2.1955">   // don't update the counts in the dest folder until it is all over</span>
<a href="#l2.1956"></a><span id="l2.1956">   EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l2.1957"></a><span id="l2.1957"> </span>
<a href="#l2.1958"></a><span id="l2.1958">   // sort the message array by key</span>
<a href="#l2.1959"></a><span id="l2.1959">   uint32_t numMsgs = 0;</span>
<a href="#l2.1960"></a><span id="l2.1960">   messages-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l2.1961"></a><span id="l2.1961">   nsTArray&lt;nsMsgKey&gt; keyArray(numMsgs);</span>
<a href="#l2.1962"></a><span id="l2.1962" class="difflineminus">-  if (numMsgs &gt; 1)</span>
<a href="#l2.1963"></a><span id="l2.1963" class="difflineminus">-  {</span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineminus">-    for (uint32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l2.1965"></a><span id="l2.1965" class="difflineminus">-    {</span>
<a href="#l2.1966"></a><span id="l2.1966" class="difflineplus">+  if (numMsgs &gt; 1) {</span>
<a href="#l2.1967"></a><span id="l2.1967" class="difflineplus">+    for (uint32_t i = 0; i &lt; numMsgs; i++) {</span>
<a href="#l2.1968"></a><span id="l2.1968">       nsCOMPtr&lt;nsIMsgDBHdr&gt; aMessage = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l2.1969"></a><span id="l2.1969" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; aMessage)</span>
<a href="#l2.1970"></a><span id="l2.1970" class="difflineminus">-      {</span>
<a href="#l2.1971"></a><span id="l2.1971" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; aMessage) {</span>
<a href="#l2.1972"></a><span id="l2.1972">         nsMsgKey key;</span>
<a href="#l2.1973"></a><span id="l2.1973">         aMessage-&gt;GetMessageKey(&amp;key);</span>
<a href="#l2.1974"></a><span id="l2.1974">         keyArray.AppendElement(key);</span>
<a href="#l2.1975"></a><span id="l2.1975">       }</span>
<a href="#l2.1976"></a><span id="l2.1976">     }</span>
<a href="#l2.1977"></a><span id="l2.1977"> </span>
<a href="#l2.1978"></a><span id="l2.1978">     keyArray.Sort();</span>
<a href="#l2.1979"></a><span id="l2.1979"> </span>
<a href="#l2.1980"></a><span id="l2.1980" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; sortedMsgs(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.1981"></a><span id="l2.1981" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; sortedMsgs(</span>
<a href="#l2.1982"></a><span id="l2.1982" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.1983"></a><span id="l2.1983">     rv = MessagesInKeyOrder(keyArray, srcFolder, sortedMsgs);</span>
<a href="#l2.1984"></a><span id="l2.1984">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.1985"></a><span id="l2.1985"> </span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineminus">-    rv = InitCopyState(srcSupport, sortedMsgs, isMove, listener, msgWindow, isFolder, allowUndo);</span>
<a href="#l2.1987"></a><span id="l2.1987" class="difflineminus">-  }</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineminus">-  else</span>
<a href="#l2.1989"></a><span id="l2.1989" class="difflineminus">-    rv = InitCopyState(srcSupport, messages, isMove, listener, msgWindow, isFolder, allowUndo);</span>
<a href="#l2.1990"></a><span id="l2.1990" class="difflineminus">-</span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineminus">-  {</span>
<a href="#l2.1993"></a><span id="l2.1993" class="difflineplus">+    rv = InitCopyState(srcSupport, sortedMsgs, isMove, listener, msgWindow,</span>
<a href="#l2.1994"></a><span id="l2.1994" class="difflineplus">+                       isFolder, allowUndo);</span>
<a href="#l2.1995"></a><span id="l2.1995" class="difflineplus">+  } else</span>
<a href="#l2.1996"></a><span id="l2.1996" class="difflineplus">+    rv = InitCopyState(srcSupport, messages, isMove, listener, msgWindow,</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineplus">+                       isFolder, allowUndo);</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineplus">+</span>
<a href="#l2.1999"></a><span id="l2.1999" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l2.2000"></a><span id="l2.2000">     ThrowAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineminus">-    (void) OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.2002"></a><span id="l2.2002" class="difflineplus">+    (void)OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.2003"></a><span id="l2.2003">     return rv;</span>
<a href="#l2.2004"></a><span id="l2.2004">   }</span>
<a href="#l2.2005"></a><span id="l2.2005"> </span>
<a href="#l2.2006"></a><span id="l2.2006" class="difflineminus">-  if (!MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;))</span>
<a href="#l2.2007"></a><span id="l2.2007" class="difflineminus">-  {</span>
<a href="#l2.2008"></a><span id="l2.2008" class="difflineplus">+  if (!MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;)) {</span>
<a href="#l2.2009"></a><span id="l2.2009">     mCopyState-&gt;m_dummyEnvelopeNeeded = true;</span>
<a href="#l2.2010"></a><span id="l2.2010" class="difflineminus">-    nsParseMailMessageState* parseMsgState = new nsParseMailMessageState();</span>
<a href="#l2.2011"></a><span id="l2.2011" class="difflineminus">-    if (parseMsgState)</span>
<a href="#l2.2012"></a><span id="l2.2012" class="difflineminus">-    {</span>
<a href="#l2.2013"></a><span id="l2.2013" class="difflineplus">+    nsParseMailMessageState *parseMsgState = new nsParseMailMessageState();</span>
<a href="#l2.2014"></a><span id="l2.2014" class="difflineplus">+    if (parseMsgState) {</span>
<a href="#l2.2015"></a><span id="l2.2015">       nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l2.2016"></a><span id="l2.2016">       mCopyState-&gt;m_parseMsgState = parseMsgState;</span>
<a href="#l2.2017"></a><span id="l2.2017">       GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l2.2018"></a><span id="l2.2018" class="difflineminus">-      if (msgDb)</span>
<a href="#l2.2019"></a><span id="l2.2019" class="difflineminus">-        parseMsgState-&gt;SetMailDB(msgDb);</span>
<a href="#l2.2020"></a><span id="l2.2020" class="difflineplus">+      if (msgDb) parseMsgState-&gt;SetMailDB(msgDb);</span>
<a href="#l2.2021"></a><span id="l2.2021">     }</span>
<a href="#l2.2022"></a><span id="l2.2022">   }</span>
<a href="#l2.2023"></a><span id="l2.2023"> </span>
<a href="#l2.2024"></a><span id="l2.2024">   // undo stuff</span>
<a href="#l2.2025"></a><span id="l2.2025" class="difflineminus">-  if (allowUndo)    //no undo for folder move/copy or or move/copy from search window</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineplus">+  if (allowUndo)  // no undo for folder move/copy or or move/copy from search</span>
<a href="#l2.2027"></a><span id="l2.2027" class="difflineplus">+                  // window</span>
<a href="#l2.2028"></a><span id="l2.2028">   {</span>
<a href="#l2.2029"></a><span id="l2.2029">     RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; msgTxn = new nsLocalMoveCopyMsgTxn;</span>
<a href="#l2.2030"></a><span id="l2.2030" class="difflineminus">-    if (msgTxn &amp;&amp; NS_SUCCEEDED(msgTxn-&gt;Init(srcFolder, this, isMove)))</span>
<a href="#l2.2031"></a><span id="l2.2031" class="difflineminus">-    {</span>
<a href="#l2.2032"></a><span id="l2.2032" class="difflineplus">+    if (msgTxn &amp;&amp; NS_SUCCEEDED(msgTxn-&gt;Init(srcFolder, this, isMove))) {</span>
<a href="#l2.2033"></a><span id="l2.2033">       msgTxn-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l2.2034"></a><span id="l2.2034" class="difflineminus">-      if (isMove)</span>
<a href="#l2.2035"></a><span id="l2.2035" class="difflineminus">-      {</span>
<a href="#l2.2036"></a><span id="l2.2036" class="difflineplus">+      if (isMove) {</span>
<a href="#l2.2037"></a><span id="l2.2037">         if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l2.2038"></a><span id="l2.2038">           msgTxn-&gt;SetTransactionType(nsIMessenger::eDeleteMsg);</span>
<a href="#l2.2039"></a><span id="l2.2039">         else</span>
<a href="#l2.2040"></a><span id="l2.2040">           msgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l2.2041"></a><span id="l2.2041" class="difflineminus">-      }</span>
<a href="#l2.2042"></a><span id="l2.2042" class="difflineminus">-      else</span>
<a href="#l2.2043"></a><span id="l2.2043" class="difflineplus">+      } else</span>
<a href="#l2.2044"></a><span id="l2.2044">         msgTxn-&gt;SetTransactionType(nsIMessenger::eCopyMsg);</span>
<a href="#l2.2045"></a><span id="l2.2045">       msgTxn.swap(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l2.2046"></a><span id="l2.2046">     }</span>
<a href="#l2.2047"></a><span id="l2.2047">   }</span>
<a href="#l2.2048"></a><span id="l2.2048"> </span>
<a href="#l2.2049"></a><span id="l2.2049" class="difflineminus">-  if (numMsgs &gt; 1 &amp;&amp; ((MsgLowerCaseEqualsLiteral(protocolType, &quot;imap&quot;) &amp;&amp; !WeAreOffline()) ||</span>
<a href="#l2.2050"></a><span id="l2.2050" class="difflineminus">-                      MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;)))</span>
<a href="#l2.2051"></a><span id="l2.2051" class="difflineminus">-  {</span>
<a href="#l2.2052"></a><span id="l2.2052" class="difflineplus">+  if (numMsgs &gt; 1 &amp;&amp;</span>
<a href="#l2.2053"></a><span id="l2.2053" class="difflineplus">+      ((MsgLowerCaseEqualsLiteral(protocolType, &quot;imap&quot;) &amp;&amp; !WeAreOffline()) ||</span>
<a href="#l2.2054"></a><span id="l2.2054" class="difflineplus">+       MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;))) {</span>
<a href="#l2.2055"></a><span id="l2.2055">     mCopyState-&gt;m_copyingMultipleMessages = true;</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineminus">-    rv = CopyMessagesTo(mCopyState-&gt;m_messages, keyArray, msgWindow, this, isMove);</span>
<a href="#l2.2057"></a><span id="l2.2057" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.2058"></a><span id="l2.2058" class="difflineminus">-    {</span>
<a href="#l2.2059"></a><span id="l2.2059" class="difflineplus">+    rv = CopyMessagesTo(mCopyState-&gt;m_messages, keyArray, msgWindow, this,</span>
<a href="#l2.2060"></a><span id="l2.2060" class="difflineplus">+                        isMove);</span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l2.2062"></a><span id="l2.2062">       NS_ERROR(&quot;copy message failed&quot;);</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-      (void) OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.2064"></a><span id="l2.2064" class="difflineplus">+      (void)OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.2065"></a><span id="l2.2065">     }</span>
<a href="#l2.2066"></a><span id="l2.2066" class="difflineminus">-  }</span>
<a href="#l2.2067"></a><span id="l2.2067" class="difflineminus">-  else</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineminus">-  {</span>
<a href="#l2.2069"></a><span id="l2.2069" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; msgSupport = do_QueryElementAt(mCopyState-&gt;m_messages, 0);</span>
<a href="#l2.2070"></a><span id="l2.2070" class="difflineminus">-    if (msgSupport)</span>
<a href="#l2.2071"></a><span id="l2.2071" class="difflineminus">-    {</span>
<a href="#l2.2072"></a><span id="l2.2072" class="difflineplus">+  } else {</span>
<a href="#l2.2073"></a><span id="l2.2073" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; msgSupport =</span>
<a href="#l2.2074"></a><span id="l2.2074" class="difflineplus">+        do_QueryElementAt(mCopyState-&gt;m_messages, 0);</span>
<a href="#l2.2075"></a><span id="l2.2075" class="difflineplus">+    if (msgSupport) {</span>
<a href="#l2.2076"></a><span id="l2.2076">       rv = CopyMessageTo(msgSupport, this, msgWindow, isMove);</span>
<a href="#l2.2077"></a><span id="l2.2077" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l2.2078"></a><span id="l2.2078" class="difflineminus">-      {</span>
<a href="#l2.2079"></a><span id="l2.2079" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l2.2080"></a><span id="l2.2080">         NS_ASSERTION(false, &quot;copy message failed&quot;);</span>
<a href="#l2.2081"></a><span id="l2.2081" class="difflineminus">-        (void) OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.2082"></a><span id="l2.2082" class="difflineplus">+        (void)OnCopyCompleted(srcSupport, false);</span>
<a href="#l2.2083"></a><span id="l2.2083">       }</span>
<a href="#l2.2084"></a><span id="l2.2084">     }</span>
<a href="#l2.2085"></a><span id="l2.2085">   }</span>
<a href="#l2.2086"></a><span id="l2.2086" class="difflineminus">-  // if this failed immediately, need to turn back on notifications and inform FE.</span>
<a href="#l2.2087"></a><span id="l2.2087" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.2088"></a><span id="l2.2088" class="difflineminus">-  {</span>
<a href="#l2.2089"></a><span id="l2.2089" class="difflineminus">-    if (isMove)</span>
<a href="#l2.2090"></a><span id="l2.2090" class="difflineminus">-      srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.2091"></a><span id="l2.2091" class="difflineplus">+  // if this failed immediately, need to turn back on notifications and inform</span>
<a href="#l2.2092"></a><span id="l2.2092" class="difflineplus">+  // FE.</span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l2.2094"></a><span id="l2.2094" class="difflineplus">+    if (isMove) srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.2095"></a><span id="l2.2095">     EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.2096"></a><span id="l2.2096">   }</span>
<a href="#l2.2097"></a><span id="l2.2097">   return rv;</span>
<a href="#l2.2098"></a><span id="l2.2098"> }</span>
<a href="#l2.2099"></a><span id="l2.2099"> // for srcFolder that are on different server than the dstFolder.</span>
<a href="#l2.2100"></a><span id="l2.2100"> // &quot;this&quot; is the parent of the new dest folder.</span>
<a href="#l2.2101"></a><span id="l2.2101" class="difflineminus">-nsresult</span>
<a href="#l2.2102"></a><span id="l2.2102" class="difflineminus">-nsMsgLocalMailFolder::CopyFolderAcrossServer(nsIMsgFolder* srcFolder, nsIMsgWindow *msgWindow,</span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineminus">-                  nsIMsgCopyServiceListener *listener )</span>
<a href="#l2.2104"></a><span id="l2.2104" class="difflineminus">-{</span>
<a href="#l2.2105"></a><span id="l2.2105" class="difflineplus">+nsresult nsMsgLocalMailFolder::CopyFolderAcrossServer(</span>
<a href="#l2.2106"></a><span id="l2.2106" class="difflineplus">+    nsIMsgFolder *srcFolder, nsIMsgWindow *msgWindow,</span>
<a href="#l2.2107"></a><span id="l2.2107" class="difflineplus">+    nsIMsgCopyServiceListener *listener) {</span>
<a href="#l2.2108"></a><span id="l2.2108">   mInitialized = true;</span>
<a href="#l2.2109"></a><span id="l2.2109"> </span>
<a href="#l2.2110"></a><span id="l2.2110">   nsString folderName;</span>
<a href="#l2.2111"></a><span id="l2.2111">   srcFolder-&gt;GetName(folderName);</span>
<a href="#l2.2112"></a><span id="l2.2112"> </span>
<a href="#l2.2113"></a><span id="l2.2113">   nsCOMPtr&lt;nsIMsgFolder&gt; newMsgFolder;</span>
<a href="#l2.2114"></a><span id="l2.2114" class="difflineminus">-  nsresult rv = CreateSubfolderInternal(folderName, msgWindow, getter_AddRefs(newMsgFolder));</span>
<a href="#l2.2115"></a><span id="l2.2115" class="difflineplus">+  nsresult rv = CreateSubfolderInternal(folderName, msgWindow,</span>
<a href="#l2.2116"></a><span id="l2.2116" class="difflineplus">+                                        getter_AddRefs(newMsgFolder));</span>
<a href="#l2.2117"></a><span id="l2.2117">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2118"></a><span id="l2.2118"> </span>
<a href="#l2.2119"></a><span id="l2.2119">   nsCOMPtr&lt;nsISimpleEnumerator&gt; messages;</span>
<a href="#l2.2120"></a><span id="l2.2120">   rv = srcFolder-&gt;GetMessages(getter_AddRefs(messages));</span>
<a href="#l2.2121"></a><span id="l2.2121">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2122"></a><span id="l2.2122"> </span>
<a href="#l2.2123"></a><span id="l2.2123">   nsCOMPtr&lt;nsIMutableArray&gt; msgArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.2124"></a><span id="l2.2124"> </span>
<a href="#l2.2125"></a><span id="l2.2125">   bool hasMoreElements = false;</span>
<a href="#l2.2126"></a><span id="l2.2126">   nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l2.2127"></a><span id="l2.2127"> </span>
<a href="#l2.2128"></a><span id="l2.2128" class="difflineminus">-  if (messages)</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineminus">-    rv = messages-&gt;HasMoreElements(&amp;hasMoreElements);</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineminus">-</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; hasMoreElements)</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineminus">-  {</span>
<a href="#l2.2133"></a><span id="l2.2133" class="difflineplus">+  if (messages) rv = messages-&gt;HasMoreElements(&amp;hasMoreElements);</span>
<a href="#l2.2134"></a><span id="l2.2134" class="difflineplus">+</span>
<a href="#l2.2135"></a><span id="l2.2135" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; hasMoreElements) {</span>
<a href="#l2.2136"></a><span id="l2.2136">     rv = messages-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l2.2137"></a><span id="l2.2137">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2138"></a><span id="l2.2138">     rv = msgArray-&gt;AppendElement(aSupport);</span>
<a href="#l2.2139"></a><span id="l2.2139">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2140"></a><span id="l2.2140">     rv = messages-&gt;HasMoreElements(&amp;hasMoreElements);</span>
<a href="#l2.2141"></a><span id="l2.2141">   }</span>
<a href="#l2.2142"></a><span id="l2.2142"> </span>
<a href="#l2.2143"></a><span id="l2.2143" class="difflineminus">-  uint32_t numMsgs=0;</span>
<a href="#l2.2144"></a><span id="l2.2144" class="difflineplus">+  uint32_t numMsgs = 0;</span>
<a href="#l2.2145"></a><span id="l2.2145">   msgArray-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l2.2146"></a><span id="l2.2146"> </span>
<a href="#l2.2147"></a><span id="l2.2147" class="difflineminus">-  if (numMsgs &gt; 0 )   //if only srcFolder has messages..</span>
<a href="#l2.2148"></a><span id="l2.2148" class="difflineminus">-    newMsgFolder-&gt;CopyMessages(srcFolder, msgArray, false, msgWindow, listener, true /* is folder*/, false /* allowUndo */);</span>
<a href="#l2.2149"></a><span id="l2.2149" class="difflineminus">-  else</span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineminus">-  {</span>
<a href="#l2.2151"></a><span id="l2.2151" class="difflineminus">-    nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(newMsgFolder);</span>
<a href="#l2.2152"></a><span id="l2.2152" class="difflineminus">-    if (localFolder)</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineminus">-    {</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineplus">+  if (numMsgs &gt; 0)  // if only srcFolder has messages..</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineplus">+    newMsgFolder-&gt;CopyMessages(srcFolder, msgArray, false, msgWindow, listener,</span>
<a href="#l2.2156"></a><span id="l2.2156" class="difflineplus">+                               true /* is folder*/, false /* allowUndo */);</span>
<a href="#l2.2157"></a><span id="l2.2157" class="difflineplus">+  else {</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineplus">+        do_QueryInterface(newMsgFolder);</span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineplus">+    if (localFolder) {</span>
<a href="#l2.2161"></a><span id="l2.2161">       // normally these would get called from ::EndCopy when the last message</span>
<a href="#l2.2162"></a><span id="l2.2162">       // was finished copying. But since there are no messages, we have to call</span>
<a href="#l2.2163"></a><span id="l2.2163">       // them explicitly.</span>
<a href="#l2.2164"></a><span id="l2.2164">       nsCOMPtr&lt;nsISupports&gt; srcSupports = do_QueryInterface(newMsgFolder);</span>
<a href="#l2.2165"></a><span id="l2.2165">       localFolder-&gt;CopyAllSubFolders(srcFolder, msgWindow, listener);</span>
<a href="#l2.2166"></a><span id="l2.2166">       return localFolder-&gt;OnCopyCompleted(srcSupports, true);</span>
<a href="#l2.2167"></a><span id="l2.2167">     }</span>
<a href="#l2.2168"></a><span id="l2.2168">   }</span>
<a href="#l2.2169"></a><span id="l2.2169">   return NS_OK;  // otherwise the front-end will say Exception::CopyFolder</span>
<a href="#l2.2170"></a><span id="l2.2170"> }</span>
<a href="#l2.2171"></a><span id="l2.2171"> </span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineminus">-nsresult    //copy the sub folders</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineplus">+nsresult  // copy the sub folders</span>
<a href="#l2.2174"></a><span id="l2.2174"> nsMsgLocalMailFolder::CopyAllSubFolders(nsIMsgFolder *srcFolder,</span>
<a href="#l2.2175"></a><span id="l2.2175" class="difflineminus">-                                      nsIMsgWindow *msgWindow,</span>
<a href="#l2.2176"></a><span id="l2.2176" class="difflineminus">-                                      nsIMsgCopyServiceListener *listener )</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineminus">-{</span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineplus">+                                        nsIMsgWindow *msgWindow,</span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineplus">+                                        nsIMsgCopyServiceListener *listener) {</span>
<a href="#l2.2180"></a><span id="l2.2180">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l2.2181"></a><span id="l2.2181">   nsresult rv = srcFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l2.2182"></a><span id="l2.2182">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2183"></a><span id="l2.2183"> </span>
<a href="#l2.2184"></a><span id="l2.2184">   bool hasMore;</span>
<a href="#l2.2185"></a><span id="l2.2185" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l2.2186"></a><span id="l2.2186" class="difflineminus">-  {</span>
<a href="#l2.2187"></a><span id="l2.2187" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.2188"></a><span id="l2.2188">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l2.2189"></a><span id="l2.2189">     enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l2.2190"></a><span id="l2.2190"> </span>
<a href="#l2.2191"></a><span id="l2.2191">     nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l2.2192"></a><span id="l2.2192" class="difflineminus">-    if (folder)</span>
<a href="#l2.2193"></a><span id="l2.2193" class="difflineminus">-      CopyFolderAcrossServer(folder, msgWindow, listener);</span>
<a href="#l2.2194"></a><span id="l2.2194" class="difflineplus">+    if (folder) CopyFolderAcrossServer(folder, msgWindow, listener);</span>
<a href="#l2.2195"></a><span id="l2.2195">   }</span>
<a href="#l2.2196"></a><span id="l2.2196">   return rv;</span>
<a href="#l2.2197"></a><span id="l2.2197"> }</span>
<a href="#l2.2198"></a><span id="l2.2198"> </span>
<a href="#l2.2199"></a><span id="l2.2199"> NS_IMETHODIMP</span>
<a href="#l2.2200"></a><span id="l2.2200" class="difflineminus">-nsMsgLocalMailFolder::CopyFolder( nsIMsgFolder* srcFolder, bool isMoveFolder,</span>
<a href="#l2.2201"></a><span id="l2.2201" class="difflineminus">-                                   nsIMsgWindow *msgWindow,</span>
<a href="#l2.2202"></a><span id="l2.2202" class="difflineminus">-                                   nsIMsgCopyServiceListener* listener)</span>
<a href="#l2.2203"></a><span id="l2.2203" class="difflineminus">-{</span>
<a href="#l2.2204"></a><span id="l2.2204" class="difflineplus">+nsMsgLocalMailFolder::CopyFolder(nsIMsgFolder *srcFolder, bool isMoveFolder,</span>
<a href="#l2.2205"></a><span id="l2.2205" class="difflineplus">+                                 nsIMsgWindow *msgWindow,</span>
<a href="#l2.2206"></a><span id="l2.2206" class="difflineplus">+                                 nsIMsgCopyServiceListener *listener) {</span>
<a href="#l2.2207"></a><span id="l2.2207">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l2.2208"></a><span id="l2.2208">   // isMoveFolder == true when &quot;this&quot; and srcFolder are on same server</span>
<a href="#l2.2209"></a><span id="l2.2209" class="difflineminus">-  return isMoveFolder ? CopyFolderLocal(srcFolder, isMoveFolder, msgWindow, listener ) :</span>
<a href="#l2.2210"></a><span id="l2.2210" class="difflineminus">-                      CopyFolderAcrossServer(srcFolder, msgWindow, listener );</span>
<a href="#l2.2211"></a><span id="l2.2211" class="difflineplus">+  return isMoveFolder</span>
<a href="#l2.2212"></a><span id="l2.2212" class="difflineplus">+             ? CopyFolderLocal(srcFolder, isMoveFolder, msgWindow, listener)</span>
<a href="#l2.2213"></a><span id="l2.2213" class="difflineplus">+             : CopyFolderAcrossServer(srcFolder, msgWindow, listener);</span>
<a href="#l2.2214"></a><span id="l2.2214"> }</span>
<a href="#l2.2215"></a><span id="l2.2215"> </span>
<a href="#l2.2216"></a><span id="l2.2216"> NS_IMETHODIMP</span>
<a href="#l2.2217"></a><span id="l2.2217"> nsMsgLocalMailFolder::CopyFolderLocal(nsIMsgFolder *srcFolder,</span>
<a href="#l2.2218"></a><span id="l2.2218">                                       bool isMoveFolder,</span>
<a href="#l2.2219"></a><span id="l2.2219">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l2.2220"></a><span id="l2.2220" class="difflineminus">-                                      nsIMsgCopyServiceListener *aListener)</span>
<a href="#l2.2221"></a><span id="l2.2221" class="difflineminus">-{</span>
<a href="#l2.2222"></a><span id="l2.2222" class="difflineplus">+                                      nsIMsgCopyServiceListener *aListener) {</span>
<a href="#l2.2223"></a><span id="l2.2223">   mInitialized = true;</span>
<a href="#l2.2224"></a><span id="l2.2224">   bool isChildOfTrash;</span>
<a href="#l2.2225"></a><span id="l2.2225">   nsresult rv = IsChildOfTrash(&amp;isChildOfTrash);</span>
<a href="#l2.2226"></a><span id="l2.2226" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; isChildOfTrash)</span>
<a href="#l2.2227"></a><span id="l2.2227" class="difflineminus">-  {</span>
<a href="#l2.2228"></a><span id="l2.2228" class="difflineminus">-    // do it just for the parent folder (isMoveFolder is true for parent only) if we are deleting/moving a folder tree</span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineminus">-    // don't confirm for rss folders.</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineminus">-    if (isMoveFolder)</span>
<a href="#l2.2231"></a><span id="l2.2231" class="difflineminus">-    {</span>
<a href="#l2.2232"></a><span id="l2.2232" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; isChildOfTrash) {</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineplus">+    // do it just for the parent folder (isMoveFolder is true for parent only)</span>
<a href="#l2.2234"></a><span id="l2.2234" class="difflineplus">+    // if we are deleting/moving a folder tree don't confirm for rss folders.</span>
<a href="#l2.2235"></a><span id="l2.2235" class="difflineplus">+    if (isMoveFolder) {</span>
<a href="#l2.2236"></a><span id="l2.2236">       // if there's a msgWindow, confirm the deletion</span>
<a href="#l2.2237"></a><span id="l2.2237" class="difflineminus">-      if (msgWindow)</span>
<a href="#l2.2238"></a><span id="l2.2238" class="difflineminus">-      {</span>
<a href="#l2.2239"></a><span id="l2.2239" class="difflineminus">-</span>
<a href="#l2.2240"></a><span id="l2.2240" class="difflineplus">+      if (msgWindow) {</span>
<a href="#l2.2241"></a><span id="l2.2241">         bool okToDelete = false;</span>
<a href="#l2.2242"></a><span id="l2.2242">         ConfirmFolderDeletion(msgWindow, srcFolder, &amp;okToDelete);</span>
<a href="#l2.2243"></a><span id="l2.2243" class="difflineminus">-        if (!okToDelete)</span>
<a href="#l2.2244"></a><span id="l2.2244" class="difflineminus">-          return NS_MSG_ERROR_COPY_FOLDER_ABORTED;</span>
<a href="#l2.2245"></a><span id="l2.2245" class="difflineplus">+        if (!okToDelete) return NS_MSG_ERROR_COPY_FOLDER_ABORTED;</span>
<a href="#l2.2246"></a><span id="l2.2246">       }</span>
<a href="#l2.2247"></a><span id="l2.2247" class="difflineminus">-      // if we are moving a favorite folder to trash, we should clear the favorites flag</span>
<a href="#l2.2248"></a><span id="l2.2248" class="difflineminus">-      // so it gets removed from the view.</span>
<a href="#l2.2249"></a><span id="l2.2249" class="difflineplus">+      // if we are moving a favorite folder to trash, we should clear the</span>
<a href="#l2.2250"></a><span id="l2.2250" class="difflineplus">+      // favorites flag so it gets removed from the view.</span>
<a href="#l2.2251"></a><span id="l2.2251">       srcFolder-&gt;ClearFlag(nsMsgFolderFlags::Favorite);</span>
<a href="#l2.2252"></a><span id="l2.2252">     }</span>
<a href="#l2.2253"></a><span id="l2.2253"> </span>
<a href="#l2.2254"></a><span id="l2.2254">     bool match = false;</span>
<a href="#l2.2255"></a><span id="l2.2255">     rv = srcFolder-&gt;MatchOrChangeFilterDestination(nullptr, false, &amp;match);</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineminus">-    if (match &amp;&amp; msgWindow)</span>
<a href="#l2.2257"></a><span id="l2.2257" class="difflineminus">-    {</span>
<a href="#l2.2258"></a><span id="l2.2258" class="difflineplus">+    if (match &amp;&amp; msgWindow) {</span>
<a href="#l2.2259"></a><span id="l2.2259">       bool confirmed = false;</span>
<a href="#l2.2260"></a><span id="l2.2260">       srcFolder-&gt;ConfirmFolderDeletionForFilter(msgWindow, &amp;confirmed);</span>
<a href="#l2.2261"></a><span id="l2.2261" class="difflineminus">-      if (!confirmed)</span>
<a href="#l2.2262"></a><span id="l2.2262" class="difflineminus">-        return NS_MSG_ERROR_COPY_FOLDER_ABORTED;</span>
<a href="#l2.2263"></a><span id="l2.2263" class="difflineplus">+      if (!confirmed) return NS_MSG_ERROR_COPY_FOLDER_ABORTED;</span>
<a href="#l2.2264"></a><span id="l2.2264">     }</span>
<a href="#l2.2265"></a><span id="l2.2265">   }</span>
<a href="#l2.2266"></a><span id="l2.2266"> </span>
<a href="#l2.2267"></a><span id="l2.2267">   nsAutoString newFolderName;</span>
<a href="#l2.2268"></a><span id="l2.2268">   nsAutoString folderName;</span>
<a href="#l2.2269"></a><span id="l2.2269">   rv = srcFolder-&gt;GetName(folderName);</span>
<a href="#l2.2270"></a><span id="l2.2270">   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<a href="#l2.2271"></a><span id="l2.2271">     return rv;</span>
<a href="#l2.2272"></a><span id="l2.2272">   }</span>
<a href="#l2.2273"></a><span id="l2.2273"> </span>
<a href="#l2.2274"></a><span id="l2.2274">   if (!isMoveFolder) {</span>
<a href="#l2.2275"></a><span id="l2.2275">     rv = CheckIfFolderExists(folderName, this, msgWindow);</span>
<a href="#l2.2276"></a><span id="l2.2276">     if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<a href="#l2.2277"></a><span id="l2.2277">       return rv;</span>
<a href="#l2.2278"></a><span id="l2.2278">     }</span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineminus">-  }</span>
<a href="#l2.2280"></a><span id="l2.2280" class="difflineminus">-  else</span>
<a href="#l2.2281"></a><span id="l2.2281" class="difflineminus">-  {</span>
<a href="#l2.2282"></a><span id="l2.2282" class="difflineplus">+  } else {</span>
<a href="#l2.2283"></a><span id="l2.2283">     // If folder name already exists in destination, generate a new unique name.</span>
<a href="#l2.2284"></a><span id="l2.2284">     bool containsChild = true;</span>
<a href="#l2.2285"></a><span id="l2.2285">     uint32_t i;</span>
<a href="#l2.2286"></a><span id="l2.2286">     for (i = 1; containsChild; i++) {</span>
<a href="#l2.2287"></a><span id="l2.2287">       newFolderName.Assign(folderName);</span>
<a href="#l2.2288"></a><span id="l2.2288">       if (i &gt; 1) {</span>
<a href="#l2.2289"></a><span id="l2.2289">         // This could be localizable but Toolkit is fine without it, see</span>
<a href="#l2.2290"></a><span id="l2.2290">         // mozilla/toolkit/content/contentAreaUtils.js::uniqueFile()</span>
<a href="#l2.2291"></a><span id="l2.2291" class="difflineat">@@ -1842,394 +1664,378 @@ nsMsgLocalMailFolder::CopyFolderLocal(ns</span>
<a href="#l2.2292"></a><span id="l2.2292">     return rv;</span>
<a href="#l2.2293"></a><span id="l2.2293">   }</span>
<a href="#l2.2294"></a><span id="l2.2294"> </span>
<a href="#l2.2295"></a><span id="l2.2295">   return msgStore-&gt;CopyFolder(srcFolder, this, isMoveFolder, msgWindow,</span>
<a href="#l2.2296"></a><span id="l2.2296">                               aListener, newFolderName);</span>
<a href="#l2.2297"></a><span id="l2.2297"> }</span>
<a href="#l2.2298"></a><span id="l2.2298"> </span>
<a href="#l2.2299"></a><span id="l2.2299"> NS_IMETHODIMP</span>
<a href="#l2.2300"></a><span id="l2.2300" class="difflineminus">-nsMsgLocalMailFolder::CopyFileMessage(nsIFile* aFile,</span>
<a href="#l2.2301"></a><span id="l2.2301" class="difflineminus">-                                      nsIMsgDBHdr *msgToReplace,</span>
<a href="#l2.2302"></a><span id="l2.2302" class="difflineplus">+nsMsgLocalMailFolder::CopyFileMessage(nsIFile *aFile, nsIMsgDBHdr *msgToReplace,</span>
<a href="#l2.2303"></a><span id="l2.2303">                                       bool isDraftOrTemplate,</span>
<a href="#l2.2304"></a><span id="l2.2304">                                       uint32_t newMsgFlags,</span>
<a href="#l2.2305"></a><span id="l2.2305">                                       const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l2.2306"></a><span id="l2.2306">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineminus">-                                      nsIMsgCopyServiceListener* listener)</span>
<a href="#l2.2308"></a><span id="l2.2308" class="difflineminus">-{</span>
<a href="#l2.2309"></a><span id="l2.2309" class="difflineplus">+                                      nsIMsgCopyServiceListener *listener) {</span>
<a href="#l2.2310"></a><span id="l2.2310">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l2.2311"></a><span id="l2.2311">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l2.2312"></a><span id="l2.2312" class="difflineminus">-  nsParseMailMessageState* parseMsgState = nullptr;</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineplus">+  nsParseMailMessageState *parseMsgState = nullptr;</span>
<a href="#l2.2314"></a><span id="l2.2314">   int64_t fileSize = 0;</span>
<a href="#l2.2315"></a><span id="l2.2315"> </span>
<a href="#l2.2316"></a><span id="l2.2316">   nsCOMPtr&lt;nsISupports&gt; fileSupport(do_QueryInterface(aFile, &amp;rv));</span>
<a href="#l2.2317"></a><span id="l2.2317"> </span>
<a href="#l2.2318"></a><span id="l2.2318">   aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l2.2319"></a><span id="l2.2319">   if (!CheckIfSpaceForCopy(msgWindow, nullptr, fileSupport, false, fileSize))</span>
<a href="#l2.2320"></a><span id="l2.2320">     return NS_OK;</span>
<a href="#l2.2321"></a><span id="l2.2321"> </span>
<a href="#l2.2322"></a><span id="l2.2322">   nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.2323"></a><span id="l2.2323"> </span>
<a href="#l2.2324"></a><span id="l2.2324" class="difflineminus">-  if (msgToReplace)</span>
<a href="#l2.2325"></a><span id="l2.2325" class="difflineminus">-    messages-&gt;AppendElement(msgToReplace);</span>
<a href="#l2.2326"></a><span id="l2.2326" class="difflineplus">+  if (msgToReplace) messages-&gt;AppendElement(msgToReplace);</span>
<a href="#l2.2327"></a><span id="l2.2327"> </span>
<a href="#l2.2328"></a><span id="l2.2328">   rv = InitCopyState(fileSupport, messages, msgToReplace ? true : false,</span>
<a href="#l2.2329"></a><span id="l2.2329">                      listener, msgWindow, false, false);</span>
<a href="#l2.2330"></a><span id="l2.2330" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineminus">-  {</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineminus">-    if (mCopyState)</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineminus">-      mCopyState-&gt;m_newMsgKeywords = aNewMsgKeywords;</span>
<a href="#l2.2334"></a><span id="l2.2334" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineplus">+    if (mCopyState) mCopyState-&gt;m_newMsgKeywords = aNewMsgKeywords;</span>
<a href="#l2.2336"></a><span id="l2.2336"> </span>
<a href="#l2.2337"></a><span id="l2.2337">     parseMsgState = new nsParseMailMessageState();</span>
<a href="#l2.2338"></a><span id="l2.2338">     NS_ENSURE_TRUE(parseMsgState, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.2339"></a><span id="l2.2339" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineminus">-      mCopyState-&gt;m_parseMsgState = parseMsgState;</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineminus">-      GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineminus">-      if (msgDb)</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineminus">-        parseMsgState-&gt;SetMailDB(msgDb);</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineplus">+    mCopyState-&gt;m_parseMsgState = parseMsgState;</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+    GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l2.2347"></a><span id="l2.2347" class="difflineplus">+    if (msgDb) parseMsgState-&gt;SetMailDB(msgDb);</span>
<a href="#l2.2348"></a><span id="l2.2348"> </span>
<a href="#l2.2349"></a><span id="l2.2349">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l2.2350"></a><span id="l2.2350">     rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l2.2351"></a><span id="l2.2351"> </span>
<a href="#l2.2352"></a><span id="l2.2352">     // All or none for adding a message file to the store</span>
<a href="#l2.2353"></a><span id="l2.2353">     if (NS_SUCCEEDED(rv) &amp;&amp; fileSize &gt; PR_INT32_MAX)</span>
<a href="#l2.2354"></a><span id="l2.2354" class="difflineminus">-        rv = NS_ERROR_ILLEGAL_VALUE; // may need error code for max msg size</span>
<a href="#l2.2355"></a><span id="l2.2355" class="difflineminus">-</span>
<a href="#l2.2356"></a><span id="l2.2356" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l2.2357"></a><span id="l2.2357" class="difflineminus">-    {</span>
<a href="#l2.2358"></a><span id="l2.2358" class="difflineplus">+      rv = NS_ERROR_ILLEGAL_VALUE;  // may need error code for max msg size</span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineplus">+</span>
<a href="#l2.2360"></a><span id="l2.2360" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; inputStream) {</span>
<a href="#l2.2361"></a><span id="l2.2361">       char buffer[5];</span>
<a href="#l2.2362"></a><span id="l2.2362">       uint32_t readCount;</span>
<a href="#l2.2363"></a><span id="l2.2363">       rv = inputStream-&gt;Read(buffer, 5, &amp;readCount);</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2365"></a><span id="l2.2365" class="difflineminus">-      {</span>
<a href="#l2.2366"></a><span id="l2.2366" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.2367"></a><span id="l2.2367">         if (strncmp(buffer, &quot;From &quot;, 5))</span>
<a href="#l2.2368"></a><span id="l2.2368">           mCopyState-&gt;m_dummyEnvelopeNeeded = true;</span>
<a href="#l2.2369"></a><span id="l2.2369" class="difflineminus">-        nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream, &amp;rv);</span>
<a href="#l2.2370"></a><span id="l2.2370" class="difflineplus">+        nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineplus">+            do_QueryInterface(inputStream, &amp;rv);</span>
<a href="#l2.2372"></a><span id="l2.2372">         if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2373"></a><span id="l2.2373">           seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, 0);</span>
<a href="#l2.2374"></a><span id="l2.2374">       }</span>
<a href="#l2.2375"></a><span id="l2.2375">     }</span>
<a href="#l2.2376"></a><span id="l2.2376"> </span>
<a href="#l2.2377"></a><span id="l2.2377" class="difflineminus">-     mCopyState-&gt;m_wholeMsgInStream = true;</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineminus">-     if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineminus">-      rv = BeginCopy(nullptr);</span>
<a href="#l2.2380"></a><span id="l2.2380" class="difflineminus">-</span>
<a href="#l2.2381"></a><span id="l2.2381" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2382"></a><span id="l2.2382" class="difflineminus">-      rv = CopyData(inputStream, (int32_t) fileSize);</span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineminus">-</span>
<a href="#l2.2384"></a><span id="l2.2384" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2385"></a><span id="l2.2385" class="difflineminus">-      rv = EndCopy(true);</span>
<a href="#l2.2386"></a><span id="l2.2386" class="difflineminus">-</span>
<a href="#l2.2387"></a><span id="l2.2387" class="difflineminus">-    //mDatabase should have been initialized above - if we got msgDb</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineplus">+    mCopyState-&gt;m_wholeMsgInStream = true;</span>
<a href="#l2.2389"></a><span id="l2.2389" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = BeginCopy(nullptr);</span>
<a href="#l2.2390"></a><span id="l2.2390" class="difflineplus">+</span>
<a href="#l2.2391"></a><span id="l2.2391" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = CopyData(inputStream, (int32_t)fileSize);</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineplus">+</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = EndCopy(true);</span>
<a href="#l2.2394"></a><span id="l2.2394" class="difflineplus">+</span>
<a href="#l2.2395"></a><span id="l2.2395" class="difflineplus">+    // mDatabase should have been initialized above - if we got msgDb</span>
<a href="#l2.2396"></a><span id="l2.2396">     // If we were going to delete, here is where we would do it. But because</span>
<a href="#l2.2397"></a><span id="l2.2397">     // existing code already supports doing those deletes, we are just going</span>
<a href="#l2.2398"></a><span id="l2.2398">     // to end the copy.</span>
<a href="#l2.2399"></a><span id="l2.2399">     if (NS_SUCCEEDED(rv) &amp;&amp; msgToReplace &amp;&amp; mDatabase)</span>
<a href="#l2.2400"></a><span id="l2.2400">       rv = OnCopyCompleted(fileSupport, true);</span>
<a href="#l2.2401"></a><span id="l2.2401"> </span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineminus">-    if (inputStream)</span>
<a href="#l2.2403"></a><span id="l2.2403" class="difflineminus">-      inputStream-&gt;Close();</span>
<a href="#l2.2404"></a><span id="l2.2404" class="difflineplus">+    if (inputStream) inputStream-&gt;Close();</span>
<a href="#l2.2405"></a><span id="l2.2405">   }</span>
<a href="#l2.2406"></a><span id="l2.2406"> </span>
<a href="#l2.2407"></a><span id="l2.2407" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineminus">-    (void) OnCopyCompleted(fileSupport, false);</span>
<a href="#l2.2409"></a><span id="l2.2409" class="difflineplus">+  if (NS_FAILED(rv)) (void)OnCopyCompleted(fileSupport, false);</span>
<a href="#l2.2410"></a><span id="l2.2410"> </span>
<a href="#l2.2411"></a><span id="l2.2411">   return rv;</span>
<a href="#l2.2412"></a><span id="l2.2412"> }</span>
<a href="#l2.2413"></a><span id="l2.2413"> </span>
<a href="#l2.2414"></a><span id="l2.2414"> nsresult nsMsgLocalMailFolder::DeleteMessage(nsISupports *message,</span>
<a href="#l2.2415"></a><span id="l2.2415">                                              nsIMsgWindow *msgWindow,</span>
<a href="#l2.2416"></a><span id="l2.2416" class="difflineminus">-                                             bool deleteStorage, bool commit)</span>
<a href="#l2.2417"></a><span id="l2.2417" class="difflineminus">-{</span>
<a href="#l2.2418"></a><span id="l2.2418" class="difflineplus">+                                             bool deleteStorage, bool commit) {</span>
<a href="#l2.2419"></a><span id="l2.2419">   nsresult rv = NS_OK;</span>
<a href="#l2.2420"></a><span id="l2.2420" class="difflineminus">-  if (deleteStorage)</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineminus">-  {</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryInterface(message, &amp;rv));</span>
<a href="#l2.2423"></a><span id="l2.2423" class="difflineminus">-</span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineminus">-    {</span>
<a href="#l2.2426"></a><span id="l2.2426" class="difflineplus">+  if (deleteStorage) {</span>
<a href="#l2.2427"></a><span id="l2.2427" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryInterface(message, &amp;rv));</span>
<a href="#l2.2428"></a><span id="l2.2428" class="difflineplus">+</span>
<a href="#l2.2429"></a><span id="l2.2429" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.2430"></a><span id="l2.2430">       GetDatabase();</span>
<a href="#l2.2431"></a><span id="l2.2431">       if (mDatabase)</span>
<a href="#l2.2432"></a><span id="l2.2432">         rv = mDatabase-&gt;DeleteHeader(msgDBHdr, nullptr, commit, true);</span>
<a href="#l2.2433"></a><span id="l2.2433">     }</span>
<a href="#l2.2434"></a><span id="l2.2434">   }</span>
<a href="#l2.2435"></a><span id="l2.2435">   return rv;</span>
<a href="#l2.2436"></a><span id="l2.2436"> }</span>
<a href="#l2.2437"></a><span id="l2.2437"> </span>
<a href="#l2.2438"></a><span id="l2.2438" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::GetNewMessages(nsIMsgWindow *aWindow, nsIUrlListener *aListener)</span>
<a href="#l2.2439"></a><span id="l2.2439" class="difflineminus">-{</span>
<a href="#l2.2440"></a><span id="l2.2440" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::GetNewMessages(nsIMsgWindow *aWindow,</span>
<a href="#l2.2441"></a><span id="l2.2441" class="difflineplus">+                                                   nsIUrlListener *aListener) {</span>
<a href="#l2.2442"></a><span id="l2.2442">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.2443"></a><span id="l2.2443">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.2444"></a><span id="l2.2444">   NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.2445"></a><span id="l2.2445"> </span>
<a href="#l2.2446"></a><span id="l2.2446" class="difflineminus">-  nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineplus">+  nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer =</span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineplus">+      do_QueryInterface(server, &amp;rv);</span>
<a href="#l2.2449"></a><span id="l2.2449">   NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.2450"></a><span id="l2.2450"> </span>
<a href="#l2.2451"></a><span id="l2.2451">   // XXX todo, move all this into nsILocalMailIncomingServer's GetNewMail</span>
<a href="#l2.2452"></a><span id="l2.2452">   // so that we don't have to have RSS foo here.</span>
<a href="#l2.2453"></a><span id="l2.2453">   nsCOMPtr&lt;nsIRssIncomingServer&gt; rssServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l2.2454"></a><span id="l2.2454">   mozilla::Unused &lt;&lt; rssServer;</span>
<a href="#l2.2455"></a><span id="l2.2455">   if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2456"></a><span id="l2.2456">     return localMailServer-&gt;GetNewMail(aWindow, aListener, this, nullptr);</span>
<a href="#l2.2457"></a><span id="l2.2457"> </span>
<a href="#l2.2458"></a><span id="l2.2458">   nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l2.2459"></a><span id="l2.2459">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l2.2460"></a><span id="l2.2460">   rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootFolder));</span>
<a href="#l2.2461"></a><span id="l2.2461" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineminus">-  {</span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineminus">-    rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox, getter_AddRefs(inbox));</span>
<a href="#l2.2464"></a><span id="l2.2464" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineplus">+    rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineplus">+                                   getter_AddRefs(inbox));</span>
<a href="#l2.2467"></a><span id="l2.2467">   }</span>
<a href="#l2.2468"></a><span id="l2.2468">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localInbox = do_QueryInterface(inbox, &amp;rv);</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2470"></a><span id="l2.2470" class="difflineminus">-  {</span>
<a href="#l2.2471"></a><span id="l2.2471" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.2472"></a><span id="l2.2472">     bool valid = false;</span>
<a href="#l2.2473"></a><span id="l2.2473" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.2474"></a><span id="l2.2474" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l2.2475"></a><span id="l2.2475">     // this will kick off a reparse if the db is out of date.</span>
<a href="#l2.2476"></a><span id="l2.2476" class="difflineminus">-    rv = localInbox-&gt;GetDatabaseWithReparse(nullptr, aWindow, getter_AddRefs(db));</span>
<a href="#l2.2477"></a><span id="l2.2477" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.2478"></a><span id="l2.2478" class="difflineminus">-    {</span>
<a href="#l2.2479"></a><span id="l2.2479" class="difflineplus">+    rv = localInbox-&gt;GetDatabaseWithReparse(nullptr, aWindow,</span>
<a href="#l2.2480"></a><span id="l2.2480" class="difflineplus">+                                            getter_AddRefs(db));</span>
<a href="#l2.2481"></a><span id="l2.2481" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.2482"></a><span id="l2.2482">       db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l2.2483"></a><span id="l2.2483" class="difflineminus">-      rv = valid ? localMailServer-&gt;GetNewMail(aWindow, aListener, inbox, nullptr) :</span>
<a href="#l2.2484"></a><span id="l2.2484" class="difflineminus">-                   localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l2.2485"></a><span id="l2.2485" class="difflineplus">+      rv = valid</span>
<a href="#l2.2486"></a><span id="l2.2486" class="difflineplus">+               ? localMailServer-&gt;GetNewMail(aWindow, aListener, inbox, nullptr)</span>
<a href="#l2.2487"></a><span id="l2.2487" class="difflineplus">+               : localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l2.2488"></a><span id="l2.2488">     }</span>
<a href="#l2.2489"></a><span id="l2.2489">   }</span>
<a href="#l2.2490"></a><span id="l2.2490">   return rv;</span>
<a href="#l2.2491"></a><span id="l2.2491"> }</span>
<a href="#l2.2492"></a><span id="l2.2492"> </span>
<a href="#l2.2493"></a><span id="l2.2493" class="difflineminus">-nsresult nsMsgLocalMailFolder::WriteStartOfNewMessage()</span>
<a href="#l2.2494"></a><span id="l2.2494" class="difflineminus">-{</span>
<a href="#l2.2495"></a><span id="l2.2495" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream);</span>
<a href="#l2.2496"></a><span id="l2.2496" class="difflineplus">+nsresult nsMsgLocalMailFolder::WriteStartOfNewMessage() {</span>
<a href="#l2.2497"></a><span id="l2.2497" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l2.2498"></a><span id="l2.2498" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_fileStream);</span>
<a href="#l2.2499"></a><span id="l2.2499">   int64_t filePos;</span>
<a href="#l2.2500"></a><span id="l2.2500">   seekableStream-&gt;Tell(&amp;filePos);</span>
<a href="#l2.2501"></a><span id="l2.2501"> </span>
<a href="#l2.2502"></a><span id="l2.2502">   // CopyFileMessage() and CopyMessages() from servers other than pop3</span>
<a href="#l2.2503"></a><span id="l2.2503" class="difflineminus">-  if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2504"></a><span id="l2.2504" class="difflineminus">-  {</span>
<a href="#l2.2505"></a><span id="l2.2505" class="difflineplus">+  if (mCopyState-&gt;m_parseMsgState) {</span>
<a href="#l2.2506"></a><span id="l2.2506">     if (mCopyState-&gt;m_parseMsgState-&gt;m_newMsgHdr)</span>
<a href="#l2.2507"></a><span id="l2.2507" class="difflineminus">-      mCopyState-&gt;m_parseMsgState-&gt;m_newMsgHdr-&gt;GetMessageKey(&amp;mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.2508"></a><span id="l2.2508" class="difflineplus">+      mCopyState-&gt;m_parseMsgState-&gt;m_newMsgHdr-&gt;GetMessageKey(</span>
<a href="#l2.2509"></a><span id="l2.2509" class="difflineplus">+          &amp;mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.2510"></a><span id="l2.2510">     mCopyState-&gt;m_parseMsgState-&gt;SetEnvelopePos(filePos);</span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineminus">-    mCopyState-&gt;m_parseMsgState-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineplus">+    mCopyState-&gt;m_parseMsgState-&gt;SetState(</span>
<a href="#l2.2513"></a><span id="l2.2513" class="difflineplus">+        nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l2.2514"></a><span id="l2.2514">   }</span>
<a href="#l2.2515"></a><span id="l2.2515" class="difflineminus">-  if (mCopyState-&gt;m_dummyEnvelopeNeeded)</span>
<a href="#l2.2516"></a><span id="l2.2516" class="difflineminus">-  {</span>
<a href="#l2.2517"></a><span id="l2.2517" class="difflineplus">+  if (mCopyState-&gt;m_dummyEnvelopeNeeded) {</span>
<a href="#l2.2518"></a><span id="l2.2518">     nsCString result;</span>
<a href="#l2.2519"></a><span id="l2.2519">     nsAutoCString nowStr;</span>
<a href="#l2.2520"></a><span id="l2.2520">     MsgGenerateNowStr(nowStr);</span>
<a href="#l2.2521"></a><span id="l2.2521">     result.AppendLiteral(&quot;From - &quot;);</span>
<a href="#l2.2522"></a><span id="l2.2522">     result.Append(nowStr);</span>
<a href="#l2.2523"></a><span id="l2.2523">     result.Append(MSG_LINEBREAK);</span>
<a href="#l2.2524"></a><span id="l2.2524"> </span>
<a href="#l2.2525"></a><span id="l2.2525">     // *** jt - hard code status line for now; come back later</span>
<a href="#l2.2526"></a><span id="l2.2526">     nsresult rv;</span>
<a href="#l2.2527"></a><span id="l2.2527" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; curSourceMessage = do_QueryElementAt(mCopyState-&gt;m_messages,</span>
<a href="#l2.2528"></a><span id="l2.2528" class="difflineminus">-                                                                mCopyState-&gt;m_curCopyIndex, &amp;rv);</span>
<a href="#l2.2529"></a><span id="l2.2529" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; curSourceMessage = do_QueryElementAt(</span>
<a href="#l2.2530"></a><span id="l2.2530" class="difflineplus">+        mCopyState-&gt;m_messages, mCopyState-&gt;m_curCopyIndex, &amp;rv);</span>
<a href="#l2.2531"></a><span id="l2.2531"> </span>
<a href="#l2.2532"></a><span id="l2.2532">     char statusStrBuf[50];</span>
<a href="#l2.2533"></a><span id="l2.2533" class="difflineminus">-    if (curSourceMessage)</span>
<a href="#l2.2534"></a><span id="l2.2534" class="difflineminus">-    {</span>
<a href="#l2.2535"></a><span id="l2.2535" class="difflineplus">+    if (curSourceMessage) {</span>
<a href="#l2.2536"></a><span id="l2.2536">       uint32_t dbFlags = 0;</span>
<a href="#l2.2537"></a><span id="l2.2537">       curSourceMessage-&gt;GetFlags(&amp;dbFlags);</span>
<a href="#l2.2538"></a><span id="l2.2538"> </span>
<a href="#l2.2539"></a><span id="l2.2539" class="difflineminus">-      // write out x-mozilla-status, but make sure we don't write out nsMsgMessageFlags::Offline</span>
<a href="#l2.2540"></a><span id="l2.2540" class="difflineminus">-      PR_snprintf(statusStrBuf, sizeof(statusStrBuf), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK,</span>
<a href="#l2.2541"></a><span id="l2.2541" class="difflineminus">-        dbFlags &amp; ~(nsMsgMessageFlags::RuntimeOnly | nsMsgMessageFlags::Offline) &amp; 0x0000FFFF);</span>
<a href="#l2.2542"></a><span id="l2.2542" class="difflineminus">-    }</span>
<a href="#l2.2543"></a><span id="l2.2543" class="difflineminus">-    else</span>
<a href="#l2.2544"></a><span id="l2.2544" class="difflineplus">+      // write out x-mozilla-status, but make sure we don't write out</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineplus">+      // nsMsgMessageFlags::Offline</span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineplus">+      PR_snprintf(</span>
<a href="#l2.2547"></a><span id="l2.2547" class="difflineplus">+          statusStrBuf, sizeof(statusStrBuf),</span>
<a href="#l2.2548"></a><span id="l2.2548" class="difflineplus">+          X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK,</span>
<a href="#l2.2549"></a><span id="l2.2549" class="difflineplus">+          dbFlags &amp;</span>
<a href="#l2.2550"></a><span id="l2.2550" class="difflineplus">+              ~(nsMsgMessageFlags::RuntimeOnly | nsMsgMessageFlags::Offline) &amp;</span>
<a href="#l2.2551"></a><span id="l2.2551" class="difflineplus">+              0x0000FFFF);</span>
<a href="#l2.2552"></a><span id="l2.2552" class="difflineplus">+    } else</span>
<a href="#l2.2553"></a><span id="l2.2553">       strcpy(statusStrBuf, &quot;X-Mozilla-Status: 0001&quot; MSG_LINEBREAK);</span>
<a href="#l2.2554"></a><span id="l2.2554">     uint32_t bytesWritten;</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineminus">-    mCopyState-&gt;m_fileStream-&gt;Write(result.get(), result.Length(), &amp;bytesWritten);</span>
<a href="#l2.2556"></a><span id="l2.2556" class="difflineplus">+    mCopyState-&gt;m_fileStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l2.2557"></a><span id="l2.2557" class="difflineplus">+                                    &amp;bytesWritten);</span>
<a href="#l2.2558"></a><span id="l2.2558">     if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2559"></a><span id="l2.2559" class="difflineminus">-        mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(</span>
<a href="#l2.2560"></a><span id="l2.2560" class="difflineminus">-          result.get(), result.Length());</span>
<a href="#l2.2561"></a><span id="l2.2561" class="difflineminus">-    mCopyState-&gt;m_fileStream-&gt;Write(statusStrBuf, strlen(statusStrBuf), &amp;bytesWritten);</span>
<a href="#l2.2562"></a><span id="l2.2562" class="difflineminus">-    if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2563"></a><span id="l2.2563" class="difflineminus">-        mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(</span>
<a href="#l2.2564"></a><span id="l2.2564" class="difflineminus">-        statusStrBuf, strlen(statusStrBuf));</span>
<a href="#l2.2565"></a><span id="l2.2565" class="difflineminus">-    result = &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK;</span>
<a href="#l2.2566"></a><span id="l2.2566" class="difflineminus">-    mCopyState-&gt;m_fileStream-&gt;Write(result.get(), result.Length(), &amp;bytesWritten);</span>
<a href="#l2.2567"></a><span id="l2.2567" class="difflineplus">+      mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(result.get(),</span>
<a href="#l2.2568"></a><span id="l2.2568" class="difflineplus">+                                                    result.Length());</span>
<a href="#l2.2569"></a><span id="l2.2569" class="difflineplus">+    mCopyState-&gt;m_fileStream-&gt;Write(statusStrBuf, strlen(statusStrBuf),</span>
<a href="#l2.2570"></a><span id="l2.2570" class="difflineplus">+                                    &amp;bytesWritten);</span>
<a href="#l2.2571"></a><span id="l2.2571">     if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2572"></a><span id="l2.2572" class="difflineminus">-        mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(</span>
<a href="#l2.2573"></a><span id="l2.2573" class="difflineminus">-          result.get(), result.Length());</span>
<a href="#l2.2574"></a><span id="l2.2574" class="difflineminus">-    result = X_MOZILLA_KEYWORDS;</span>
<a href="#l2.2575"></a><span id="l2.2575" class="difflineminus">-    mCopyState-&gt;m_fileStream-&gt;Write(result.get(), result.Length(), &amp;bytesWritten);</span>
<a href="#l2.2576"></a><span id="l2.2576" class="difflineplus">+      mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(statusStrBuf,</span>
<a href="#l2.2577"></a><span id="l2.2577" class="difflineplus">+                                                    strlen(statusStrBuf));</span>
<a href="#l2.2578"></a><span id="l2.2578" class="difflineplus">+    result = &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK;</span>
<a href="#l2.2579"></a><span id="l2.2579" class="difflineplus">+    mCopyState-&gt;m_fileStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l2.2580"></a><span id="l2.2580" class="difflineplus">+                                    &amp;bytesWritten);</span>
<a href="#l2.2581"></a><span id="l2.2581">     if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2582"></a><span id="l2.2582" class="difflineminus">-        mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(</span>
<a href="#l2.2583"></a><span id="l2.2583" class="difflineminus">-          result.get(), result.Length());</span>
<a href="#l2.2584"></a><span id="l2.2584" class="difflineminus">-   mCopyState-&gt;m_fromLineSeen = true;</span>
<a href="#l2.2585"></a><span id="l2.2585" class="difflineminus">-  }</span>
<a href="#l2.2586"></a><span id="l2.2586" class="difflineminus">-  else</span>
<a href="#l2.2587"></a><span id="l2.2587" class="difflineplus">+      mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(result.get(),</span>
<a href="#l2.2588"></a><span id="l2.2588" class="difflineplus">+                                                    result.Length());</span>
<a href="#l2.2589"></a><span id="l2.2589" class="difflineplus">+    result = X_MOZILLA_KEYWORDS;</span>
<a href="#l2.2590"></a><span id="l2.2590" class="difflineplus">+    mCopyState-&gt;m_fileStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l2.2591"></a><span id="l2.2591" class="difflineplus">+                                    &amp;bytesWritten);</span>
<a href="#l2.2592"></a><span id="l2.2592" class="difflineplus">+    if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2593"></a><span id="l2.2593" class="difflineplus">+      mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(result.get(),</span>
<a href="#l2.2594"></a><span id="l2.2594" class="difflineplus">+                                                    result.Length());</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineplus">+    mCopyState-&gt;m_fromLineSeen = true;</span>
<a href="#l2.2596"></a><span id="l2.2596" class="difflineplus">+  } else</span>
<a href="#l2.2597"></a><span id="l2.2597">     mCopyState-&gt;m_fromLineSeen = false;</span>
<a href="#l2.2598"></a><span id="l2.2598"> </span>
<a href="#l2.2599"></a><span id="l2.2599">   mCopyState-&gt;m_curCopyIndex++;</span>
<a href="#l2.2600"></a><span id="l2.2600">   return NS_OK;</span>
<a href="#l2.2601"></a><span id="l2.2601"> }</span>
<a href="#l2.2602"></a><span id="l2.2602"> </span>
<a href="#l2.2603"></a><span id="l2.2603" class="difflineminus">-nsresult nsMsgLocalMailFolder::InitCopyMsgHdrAndFileStream()</span>
<a href="#l2.2604"></a><span id="l2.2604" class="difflineminus">-{</span>
<a href="#l2.2605"></a><span id="l2.2605" class="difflineplus">+nsresult nsMsgLocalMailFolder::InitCopyMsgHdrAndFileStream() {</span>
<a href="#l2.2606"></a><span id="l2.2606">   nsresult rv = GetMsgStore(getter_AddRefs(mCopyState-&gt;m_msgStore));</span>
<a href="#l2.2607"></a><span id="l2.2607">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2608"></a><span id="l2.2608">   bool reusable;</span>
<a href="#l2.2609"></a><span id="l2.2609" class="difflineminus">-  rv = mCopyState-&gt;m_msgStore-&gt;</span>
<a href="#l2.2610"></a><span id="l2.2610" class="difflineminus">-         GetNewMsgOutputStream(this, getter_AddRefs(mCopyState-&gt;m_newHdr),</span>
<a href="#l2.2611"></a><span id="l2.2611" class="difflineminus">-                               &amp;reusable,</span>
<a href="#l2.2612"></a><span id="l2.2612" class="difflineminus">-                               getter_AddRefs(mCopyState-&gt;m_fileStream));</span>
<a href="#l2.2613"></a><span id="l2.2613" class="difflineplus">+  rv = mCopyState-&gt;m_msgStore-&gt;GetNewMsgOutputStream(</span>
<a href="#l2.2614"></a><span id="l2.2614" class="difflineplus">+      this, getter_AddRefs(mCopyState-&gt;m_newHdr), &amp;reusable,</span>
<a href="#l2.2615"></a><span id="l2.2615" class="difflineplus">+      getter_AddRefs(mCopyState-&gt;m_fileStream));</span>
<a href="#l2.2616"></a><span id="l2.2616">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2617"></a><span id="l2.2617">   if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2618"></a><span id="l2.2618">     mCopyState-&gt;m_parseMsgState-&gt;SetNewMsgHdr(mCopyState-&gt;m_newHdr);</span>
<a href="#l2.2619"></a><span id="l2.2619">   return rv;</span>
<a href="#l2.2620"></a><span id="l2.2620"> }</span>
<a href="#l2.2621"></a><span id="l2.2621"> </span>
<a href="#l2.2622"></a><span id="l2.2622" class="difflineminus">-//nsICopyMessageListener</span>
<a href="#l2.2623"></a><span id="l2.2623" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::BeginCopy(nsIMsgDBHdr *message)</span>
<a href="#l2.2624"></a><span id="l2.2624" class="difflineminus">-{</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineminus">-  if (!mCopyState)</span>
<a href="#l2.2626"></a><span id="l2.2626" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.2627"></a><span id="l2.2627" class="difflineplus">+// nsICopyMessageListener</span>
<a href="#l2.2628"></a><span id="l2.2628" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::BeginCopy(nsIMsgDBHdr *message) {</span>
<a href="#l2.2629"></a><span id="l2.2629" class="difflineplus">+  if (!mCopyState) return NS_ERROR_NULL_POINTER;</span>
<a href="#l2.2630"></a><span id="l2.2630"> </span>
<a href="#l2.2631"></a><span id="l2.2631">   nsresult rv;</span>
<a href="#l2.2632"></a><span id="l2.2632" class="difflineminus">-  if (!mCopyState-&gt;m_copyingMultipleMessages)</span>
<a href="#l2.2633"></a><span id="l2.2633" class="difflineminus">-  {</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineplus">+  if (!mCopyState-&gt;m_copyingMultipleMessages) {</span>
<a href="#l2.2635"></a><span id="l2.2635">     rv = InitCopyMsgHdrAndFileStream();</span>
<a href="#l2.2636"></a><span id="l2.2636">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2637"></a><span id="l2.2637">   }</span>
<a href="#l2.2638"></a><span id="l2.2638" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l2.2639"></a><span id="l2.2639" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l2.2640"></a><span id="l2.2640" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l2.2641"></a><span id="l2.2641"> </span>
<a href="#l2.2642"></a><span id="l2.2642">   //  XXX ToDo: When copying multiple messages from a non-offline-enabled IMAP</span>
<a href="#l2.2643"></a><span id="l2.2643">   //  server, this fails. (The copy succeeds because the file stream is created</span>
<a href="#l2.2644"></a><span id="l2.2644" class="difflineminus">-  //  subsequently in StartMessage) We should not be warning on an expected error.</span>
<a href="#l2.2645"></a><span id="l2.2645" class="difflineminus">-  //  Perhaps there are unexpected consequences of returning early?</span>
<a href="#l2.2646"></a><span id="l2.2646" class="difflineplus">+  //  subsequently in StartMessage) We should not be warning on an expected</span>
<a href="#l2.2647"></a><span id="l2.2647" class="difflineplus">+  //  error. Perhaps there are unexpected consequences of returning early?</span>
<a href="#l2.2648"></a><span id="l2.2648">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2649"></a><span id="l2.2649">   seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l2.2650"></a><span id="l2.2650"> </span>
<a href="#l2.2651"></a><span id="l2.2651" class="difflineminus">-  int32_t messageIndex = (mCopyState-&gt;m_copyingMultipleMessages) ? mCopyState-&gt;m_curCopyIndex - 1 : mCopyState-&gt;m_curCopyIndex;</span>
<a href="#l2.2652"></a><span id="l2.2652" class="difflineminus">-  NS_ASSERTION(!mCopyState-&gt;m_copyingMultipleMessages || messageIndex &gt;= 0, &quot;messageIndex invalid&quot;);</span>
<a href="#l2.2653"></a><span id="l2.2653" class="difflineminus">-  // by the time we get here, m_curCopyIndex is 1 relative because WriteStartOfNewMessage increments it</span>
<a href="#l2.2654"></a><span id="l2.2654" class="difflineminus">-  mCopyState-&gt;m_message = do_QueryElementAt(mCopyState-&gt;m_messages, messageIndex);</span>
<a href="#l2.2655"></a><span id="l2.2655" class="difflineplus">+  int32_t messageIndex = (mCopyState-&gt;m_copyingMultipleMessages)</span>
<a href="#l2.2656"></a><span id="l2.2656" class="difflineplus">+                             ? mCopyState-&gt;m_curCopyIndex - 1</span>
<a href="#l2.2657"></a><span id="l2.2657" class="difflineplus">+                             : mCopyState-&gt;m_curCopyIndex;</span>
<a href="#l2.2658"></a><span id="l2.2658" class="difflineplus">+  NS_ASSERTION(!mCopyState-&gt;m_copyingMultipleMessages || messageIndex &gt;= 0,</span>
<a href="#l2.2659"></a><span id="l2.2659" class="difflineplus">+               &quot;messageIndex invalid&quot;);</span>
<a href="#l2.2660"></a><span id="l2.2660" class="difflineplus">+  // by the time we get here, m_curCopyIndex is 1 relative because</span>
<a href="#l2.2661"></a><span id="l2.2661" class="difflineplus">+  // WriteStartOfNewMessage increments it</span>
<a href="#l2.2662"></a><span id="l2.2662" class="difflineplus">+  mCopyState-&gt;m_message =</span>
<a href="#l2.2663"></a><span id="l2.2663" class="difflineplus">+      do_QueryElementAt(mCopyState-&gt;m_messages, messageIndex);</span>
<a href="#l2.2664"></a><span id="l2.2664">   // The flags of the source message can get changed when it is deleted, so</span>
<a href="#l2.2665"></a><span id="l2.2665">   // save them here.</span>
<a href="#l2.2666"></a><span id="l2.2666">   if (mCopyState-&gt;m_message)</span>
<a href="#l2.2667"></a><span id="l2.2667">     mCopyState-&gt;m_message-&gt;GetFlags(&amp;(mCopyState-&gt;m_flags));</span>
<a href="#l2.2668"></a><span id="l2.2668">   DisplayMoveCopyStatusMsg();</span>
<a href="#l2.2669"></a><span id="l2.2669">   if (mCopyState-&gt;m_listener)</span>
<a href="#l2.2670"></a><span id="l2.2670" class="difflineminus">-    mCopyState-&gt;m_listener-&gt;OnProgress(mCopyState-&gt;m_curCopyIndex, mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.2671"></a><span id="l2.2671" class="difflineplus">+    mCopyState-&gt;m_listener-&gt;OnProgress(mCopyState-&gt;m_curCopyIndex,</span>
<a href="#l2.2672"></a><span id="l2.2672" class="difflineplus">+                                       mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.2673"></a><span id="l2.2673">   // if we're copying more than one message, StartMessage will handle this.</span>
<a href="#l2.2674"></a><span id="l2.2674">   return !mCopyState-&gt;m_copyingMultipleMessages ? WriteStartOfNewMessage() : rv;</span>
<a href="#l2.2675"></a><span id="l2.2675"> }</span>
<a href="#l2.2676"></a><span id="l2.2676"> </span>
<a href="#l2.2677"></a><span id="l2.2677" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::CopyData(nsIInputStream *aIStream, int32_t aLength)</span>
<a href="#l2.2678"></a><span id="l2.2678" class="difflineminus">-{</span>
<a href="#l2.2679"></a><span id="l2.2679" class="difflineminus">-  //check to make sure we have control of the write.</span>
<a href="#l2.2680"></a><span id="l2.2680" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::CopyData(nsIInputStream *aIStream,</span>
<a href="#l2.2681"></a><span id="l2.2681" class="difflineplus">+                                             int32_t aLength) {</span>
<a href="#l2.2682"></a><span id="l2.2682" class="difflineplus">+  // check to make sure we have control of the write.</span>
<a href="#l2.2683"></a><span id="l2.2683">   bool haveSemaphore;</span>
<a href="#l2.2684"></a><span id="l2.2684">   nsresult rv = NS_OK;</span>
<a href="#l2.2685"></a><span id="l2.2685"> </span>
<a href="#l2.2686"></a><span id="l2.2686" class="difflineminus">-  rv = TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this), &amp;haveSemaphore);</span>
<a href="#l2.2687"></a><span id="l2.2687" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.2688"></a><span id="l2.2688" class="difflineminus">-    return rv;</span>
<a href="#l2.2689"></a><span id="l2.2689" class="difflineminus">-  if (!haveSemaphore)</span>
<a href="#l2.2690"></a><span id="l2.2690" class="difflineminus">-    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l2.2691"></a><span id="l2.2691" class="difflineminus">-</span>
<a href="#l2.2692"></a><span id="l2.2692" class="difflineminus">-  if (!mCopyState)</span>
<a href="#l2.2693"></a><span id="l2.2693" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineplus">+  rv =</span>
<a href="#l2.2695"></a><span id="l2.2695" class="difflineplus">+      TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder *&gt;(this), &amp;haveSemaphore);</span>
<a href="#l2.2696"></a><span id="l2.2696" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.2697"></a><span id="l2.2697" class="difflineplus">+  if (!haveSemaphore) return NS_MSG_FOLDER_BUSY;</span>
<a href="#l2.2698"></a><span id="l2.2698" class="difflineplus">+</span>
<a href="#l2.2699"></a><span id="l2.2699" class="difflineplus">+  if (!mCopyState) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.2700"></a><span id="l2.2700"> </span>
<a href="#l2.2701"></a><span id="l2.2701">   uint32_t readCount;</span>
<a href="#l2.2702"></a><span id="l2.2702" class="difflineminus">-  //allocate one extra byte for '\0' at the end and another extra byte at the</span>
<a href="#l2.2703"></a><span id="l2.2703" class="difflineminus">-  //front to insert a '&gt;' if we have a &quot;From&quot; line</span>
<a href="#l2.2704"></a><span id="l2.2704" class="difflineminus">-  //allocate 2 more for crlf that may be needed for those without crlf at end of file</span>
<a href="#l2.2705"></a><span id="l2.2705" class="difflineminus">-  if ( aLength + mCopyState-&gt;m_leftOver + 4 &gt; mCopyState-&gt;m_dataBufferSize )</span>
<a href="#l2.2706"></a><span id="l2.2706" class="difflineminus">-  {</span>
<a href="#l2.2707"></a><span id="l2.2707" class="difflineminus">-    char *newBuffer = (char *) PR_REALLOC(mCopyState-&gt;m_dataBuffer, aLength + mCopyState-&gt;m_leftOver + 4);</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineminus">-    if (!newBuffer)</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.2710"></a><span id="l2.2710" class="difflineplus">+  // allocate one extra byte for '\0' at the end and another extra byte at the</span>
<a href="#l2.2711"></a><span id="l2.2711" class="difflineplus">+  // front to insert a '&gt;' if we have a &quot;From&quot; line</span>
<a href="#l2.2712"></a><span id="l2.2712" class="difflineplus">+  // allocate 2 more for crlf that may be needed for those without crlf at end</span>
<a href="#l2.2713"></a><span id="l2.2713" class="difflineplus">+  // of file</span>
<a href="#l2.2714"></a><span id="l2.2714" class="difflineplus">+  if (aLength + mCopyState-&gt;m_leftOver + 4 &gt; mCopyState-&gt;m_dataBufferSize) {</span>
<a href="#l2.2715"></a><span id="l2.2715" class="difflineplus">+    char *newBuffer = (char *)PR_REALLOC(mCopyState-&gt;m_dataBuffer,</span>
<a href="#l2.2716"></a><span id="l2.2716" class="difflineplus">+                                         aLength + mCopyState-&gt;m_leftOver + 4);</span>
<a href="#l2.2717"></a><span id="l2.2717" class="difflineplus">+    if (!newBuffer) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.2718"></a><span id="l2.2718"> </span>
<a href="#l2.2719"></a><span id="l2.2719">     mCopyState-&gt;m_dataBuffer = newBuffer;</span>
<a href="#l2.2720"></a><span id="l2.2720">     mCopyState-&gt;m_dataBufferSize = aLength + mCopyState-&gt;m_leftOver + 3;</span>
<a href="#l2.2721"></a><span id="l2.2721">   }</span>
<a href="#l2.2722"></a><span id="l2.2722"> </span>
<a href="#l2.2723"></a><span id="l2.2723" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l2.2724"></a><span id="l2.2724" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l2.2725"></a><span id="l2.2725" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l2.2726"></a><span id="l2.2726">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2727"></a><span id="l2.2727">   seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l2.2728"></a><span id="l2.2728"> </span>
<a href="#l2.2729"></a><span id="l2.2729" class="difflineminus">-  rv = aIStream-&gt;Read(mCopyState-&gt;m_dataBuffer + mCopyState-&gt;m_leftOver + 1, aLength, &amp;readCount);</span>
<a href="#l2.2730"></a><span id="l2.2730" class="difflineplus">+  rv = aIStream-&gt;Read(mCopyState-&gt;m_dataBuffer + mCopyState-&gt;m_leftOver + 1,</span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineplus">+                      aLength, &amp;readCount);</span>
<a href="#l2.2732"></a><span id="l2.2732">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.2733"></a><span id="l2.2733">   mCopyState-&gt;m_leftOver += readCount;</span>
<a href="#l2.2734"></a><span id="l2.2734" class="difflineminus">-  mCopyState-&gt;m_dataBuffer[mCopyState-&gt;m_leftOver + 1] ='\0';</span>
<a href="#l2.2735"></a><span id="l2.2735" class="difflineplus">+  mCopyState-&gt;m_dataBuffer[mCopyState-&gt;m_leftOver + 1] = '\0';</span>
<a href="#l2.2736"></a><span id="l2.2736">   char *start = mCopyState-&gt;m_dataBuffer + 1;</span>
<a href="#l2.2737"></a><span id="l2.2737">   char *endBuffer = mCopyState-&gt;m_dataBuffer + mCopyState-&gt;m_leftOver + 1;</span>
<a href="#l2.2738"></a><span id="l2.2738"> </span>
<a href="#l2.2739"></a><span id="l2.2739">   uint32_t lineLength;</span>
<a href="#l2.2740"></a><span id="l2.2740">   uint32_t bytesWritten;</span>
<a href="#l2.2741"></a><span id="l2.2741"> </span>
<a href="#l2.2742"></a><span id="l2.2742" class="difflineminus">-  while (1)</span>
<a href="#l2.2743"></a><span id="l2.2743" class="difflineminus">-  {</span>
<a href="#l2.2744"></a><span id="l2.2744" class="difflineplus">+  while (1) {</span>
<a href="#l2.2745"></a><span id="l2.2745">     char *end = PL_strnpbrk(start, &quot;\r\n&quot;, endBuffer - start);</span>
<a href="#l2.2746"></a><span id="l2.2746" class="difflineminus">-    if (!end)</span>
<a href="#l2.2747"></a><span id="l2.2747" class="difflineminus">-    {</span>
<a href="#l2.2748"></a><span id="l2.2748" class="difflineplus">+    if (!end) {</span>
<a href="#l2.2749"></a><span id="l2.2749">       mCopyState-&gt;m_leftOver -= (start - mCopyState-&gt;m_dataBuffer - 1);</span>
<a href="#l2.2750"></a><span id="l2.2750">       // In CopyFileMessage, a complete message is being copied in a single</span>
<a href="#l2.2751"></a><span id="l2.2751">       // call to CopyData, and if it does not have a LINEBREAK at the EOF,</span>
<a href="#l2.2752"></a><span id="l2.2752">       // then end will be null after reading the last line, and we need</span>
<a href="#l2.2753"></a><span id="l2.2753" class="difflineminus">-      // to append the LINEBREAK to the buffer to enable transfer of the last line.</span>
<a href="#l2.2754"></a><span id="l2.2754" class="difflineminus">-      if (mCopyState-&gt;m_wholeMsgInStream)</span>
<a href="#l2.2755"></a><span id="l2.2755" class="difflineminus">-      {</span>
<a href="#l2.2756"></a><span id="l2.2756" class="difflineplus">+      // to append the LINEBREAK to the buffer to enable transfer of the last</span>
<a href="#l2.2757"></a><span id="l2.2757" class="difflineplus">+      // line.</span>
<a href="#l2.2758"></a><span id="l2.2758" class="difflineplus">+      if (mCopyState-&gt;m_wholeMsgInStream) {</span>
<a href="#l2.2759"></a><span id="l2.2759">         end = start + mCopyState-&gt;m_leftOver;</span>
<a href="#l2.2760"></a><span id="l2.2760">         memcpy(end, MSG_LINEBREAK &quot;\0&quot;, MSG_LINEBREAK_LEN + 1);</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineminus">-      }</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineminus">-      else</span>
<a href="#l2.2763"></a><span id="l2.2763" class="difflineminus">-      {</span>
<a href="#l2.2764"></a><span id="l2.2764" class="difflineminus">-        memmove (mCopyState-&gt;m_dataBuffer + 1, start, mCopyState-&gt;m_leftOver);</span>
<a href="#l2.2765"></a><span id="l2.2765" class="difflineplus">+      } else {</span>
<a href="#l2.2766"></a><span id="l2.2766" class="difflineplus">+        memmove(mCopyState-&gt;m_dataBuffer + 1, start, mCopyState-&gt;m_leftOver);</span>
<a href="#l2.2767"></a><span id="l2.2767">         break;</span>
<a href="#l2.2768"></a><span id="l2.2768">       }</span>
<a href="#l2.2769"></a><span id="l2.2769">     }</span>
<a href="#l2.2770"></a><span id="l2.2770"> </span>
<a href="#l2.2771"></a><span id="l2.2771" class="difflineminus">-    //need to set the linebreak_len each time</span>
<a href="#l2.2772"></a><span id="l2.2772" class="difflineminus">-    uint32_t linebreak_len = 1; //assume CR or LF</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineminus">-    if (*end == '\r' &amp;&amp; *(end+1) == '\n')</span>
<a href="#l2.2774"></a><span id="l2.2774" class="difflineminus">-      linebreak_len = 2;  //CRLF</span>
<a href="#l2.2775"></a><span id="l2.2775" class="difflineminus">-</span>
<a href="#l2.2776"></a><span id="l2.2776" class="difflineminus">-    if (!mCopyState-&gt;m_fromLineSeen)</span>
<a href="#l2.2777"></a><span id="l2.2777" class="difflineminus">-    {</span>
<a href="#l2.2778"></a><span id="l2.2778" class="difflineplus">+    // need to set the linebreak_len each time</span>
<a href="#l2.2779"></a><span id="l2.2779" class="difflineplus">+    uint32_t linebreak_len = 1;  // assume CR or LF</span>
<a href="#l2.2780"></a><span id="l2.2780" class="difflineplus">+    if (*end == '\r' &amp;&amp; *(end + 1) == '\n') linebreak_len = 2;  // CRLF</span>
<a href="#l2.2781"></a><span id="l2.2781" class="difflineplus">+</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineplus">+    if (!mCopyState-&gt;m_fromLineSeen) {</span>
<a href="#l2.2783"></a><span id="l2.2783">       mCopyState-&gt;m_fromLineSeen = true;</span>
<a href="#l2.2784"></a><span id="l2.2784">       NS_ASSERTION(strncmp(start, &quot;From &quot;, 5) == 0,</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineminus">-        &quot;Fatal ... bad message format\n&quot;);</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineminus">-    }</span>
<a href="#l2.2787"></a><span id="l2.2787" class="difflineminus">-    else if (strncmp(start, &quot;From &quot;, 5) == 0)</span>
<a href="#l2.2788"></a><span id="l2.2788" class="difflineminus">-    {</span>
<a href="#l2.2789"></a><span id="l2.2789" class="difflineminus">-      //if we're at the beginning of the buffer, we've reserved a byte to</span>
<a href="#l2.2790"></a><span id="l2.2790" class="difflineminus">-      //insert a '&gt;'.  If we're in the middle, we're overwriting the previous</span>
<a href="#l2.2791"></a><span id="l2.2791" class="difflineminus">-      //line ending, but we've already written it to m_fileStream, so it's OK.</span>
<a href="#l2.2792"></a><span id="l2.2792" class="difflineplus">+                   &quot;Fatal ... bad message format\n&quot;);</span>
<a href="#l2.2793"></a><span id="l2.2793" class="difflineplus">+    } else if (strncmp(start, &quot;From &quot;, 5) == 0) {</span>
<a href="#l2.2794"></a><span id="l2.2794" class="difflineplus">+      // if we're at the beginning of the buffer, we've reserved a byte to</span>
<a href="#l2.2795"></a><span id="l2.2795" class="difflineplus">+      // insert a '&gt;'.  If we're in the middle, we're overwriting the previous</span>
<a href="#l2.2796"></a><span id="l2.2796" class="difflineplus">+      // line ending, but we've already written it to m_fileStream, so it's OK.</span>
<a href="#l2.2797"></a><span id="l2.2797">       *--start = '&gt;';</span>
<a href="#l2.2798"></a><span id="l2.2798">     }</span>
<a href="#l2.2799"></a><span id="l2.2799"> </span>
<a href="#l2.2800"></a><span id="l2.2800">     lineLength = end - start + linebreak_len;</span>
<a href="#l2.2801"></a><span id="l2.2801">     rv = mCopyState-&gt;m_fileStream-&gt;Write(start, lineLength, &amp;bytesWritten);</span>
<a href="#l2.2802"></a><span id="l2.2802" class="difflineminus">-    if (bytesWritten != lineLength || NS_FAILED(rv))</span>
<a href="#l2.2803"></a><span id="l2.2803" class="difflineminus">-    {</span>
<a href="#l2.2804"></a><span id="l2.2804" class="difflineplus">+    if (bytesWritten != lineLength || NS_FAILED(rv)) {</span>
<a href="#l2.2805"></a><span id="l2.2805">       ThrowAlertMsg(&quot;copyMsgWriteFailed&quot;, mCopyState-&gt;m_msgWindow);</span>
<a href="#l2.2806"></a><span id="l2.2806">       mCopyState-&gt;m_writeFailed = true;</span>
<a href="#l2.2807"></a><span id="l2.2807">       return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l2.2808"></a><span id="l2.2808">     }</span>
<a href="#l2.2809"></a><span id="l2.2809"> </span>
<a href="#l2.2810"></a><span id="l2.2810">     if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2811"></a><span id="l2.2811">       mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(start, lineLength);</span>
<a href="#l2.2812"></a><span id="l2.2812"> </span>
<a href="#l2.2813"></a><span id="l2.2813">     start = end + linebreak_len;</span>
<a href="#l2.2814"></a><span id="l2.2814" class="difflineminus">-    if (start &gt;= endBuffer)</span>
<a href="#l2.2815"></a><span id="l2.2815" class="difflineminus">-    {</span>
<a href="#l2.2816"></a><span id="l2.2816" class="difflineplus">+    if (start &gt;= endBuffer) {</span>
<a href="#l2.2817"></a><span id="l2.2817">       mCopyState-&gt;m_leftOver = 0;</span>
<a href="#l2.2818"></a><span id="l2.2818">       break;</span>
<a href="#l2.2819"></a><span id="l2.2819">     }</span>
<a href="#l2.2820"></a><span id="l2.2820">   }</span>
<a href="#l2.2821"></a><span id="l2.2821">   return rv;</span>
<a href="#l2.2822"></a><span id="l2.2822"> }</span>
<a href="#l2.2823"></a><span id="l2.2823"> </span>
<a href="#l2.2824"></a><span id="l2.2824"> void nsMsgLocalMailFolder::CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr,</span>
<a href="#l2.2825"></a><span id="l2.2825">                                                   nsIMsgDBHdr *srcHdr,</span>
<a href="#l2.2826"></a><span id="l2.2826" class="difflineminus">-                                                  bool aIsMove)</span>
<a href="#l2.2827"></a><span id="l2.2827" class="difflineminus">-{</span>
<a href="#l2.2828"></a><span id="l2.2828" class="difflineplus">+                                                  bool aIsMove) {</span>
<a href="#l2.2829"></a><span id="l2.2829">   nsresult rv;</span>
<a href="#l2.2830"></a><span id="l2.2830" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.2831"></a><span id="l2.2831" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.2833"></a><span id="l2.2833">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l2.2834"></a><span id="l2.2834"> </span>
<a href="#l2.2835"></a><span id="l2.2835">   nsCString dontPreserve;</span>
<a href="#l2.2836"></a><span id="l2.2836"> </span>
<a href="#l2.2837"></a><span id="l2.2837">   // These preferences exist so that extensions can control which properties</span>
<a href="#l2.2838"></a><span id="l2.2838">   // are preserved in the database when a message is moved or copied. All</span>
<a href="#l2.2839"></a><span id="l2.2839">   // properties are preserved except those listed in these preferences</span>
<a href="#l2.2840"></a><span id="l2.2840">   if (aIsMove)</span>
<a href="#l2.2841"></a><span id="l2.2841" class="difflineat">@@ -2237,1482 +2043,1401 @@ void nsMsgLocalMailFolder::CopyPropertie</span>
<a href="#l2.2842"></a><span id="l2.2842">                             dontPreserve);</span>
<a href="#l2.2843"></a><span id="l2.2843">   else</span>
<a href="#l2.2844"></a><span id="l2.2844">     prefBranch-&gt;GetCharPref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span>
<a href="#l2.2845"></a><span id="l2.2845">                             dontPreserve);</span>
<a href="#l2.2846"></a><span id="l2.2846"> </span>
<a href="#l2.2847"></a><span id="l2.2847">   CopyHdrPropertiesWithSkipList(destHdr, srcHdr, dontPreserve);</span>
<a href="#l2.2848"></a><span id="l2.2848"> }</span>
<a href="#l2.2849"></a><span id="l2.2849"> </span>
<a href="#l2.2850"></a><span id="l2.2850" class="difflineminus">-void</span>
<a href="#l2.2851"></a><span id="l2.2851" class="difflineminus">-nsMsgLocalMailFolder::CopyHdrPropertiesWithSkipList(nsIMsgDBHdr *destHdr,</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineminus">-                                                    nsIMsgDBHdr *srcHdr,</span>
<a href="#l2.2853"></a><span id="l2.2853" class="difflineminus">-                                                    const nsCString &amp;skipList)</span>
<a href="#l2.2854"></a><span id="l2.2854" class="difflineminus">-{</span>
<a href="#l2.2855"></a><span id="l2.2855" class="difflineplus">+void nsMsgLocalMailFolder::CopyHdrPropertiesWithSkipList(</span>
<a href="#l2.2856"></a><span id="l2.2856" class="difflineplus">+    nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr, const nsCString &amp;skipList) {</span>
<a href="#l2.2857"></a><span id="l2.2857">   nsCOMPtr&lt;nsIUTF8StringEnumerator&gt; propertyEnumerator;</span>
<a href="#l2.2858"></a><span id="l2.2858" class="difflineminus">-  nsresult rv = srcHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l2.2859"></a><span id="l2.2859" class="difflineplus">+  nsresult rv =</span>
<a href="#l2.2860"></a><span id="l2.2860" class="difflineplus">+      srcHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l2.2861"></a><span id="l2.2861">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l2.2862"></a><span id="l2.2862"> </span>
<a href="#l2.2863"></a><span id="l2.2863">   // We'll add spaces at beginning and end so we can search for space-name-space</span>
<a href="#l2.2864"></a><span id="l2.2864">   nsCString dontPreserveEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l2.2865"></a><span id="l2.2865">   dontPreserveEx.Append(skipList);</span>
<a href="#l2.2866"></a><span id="l2.2866">   dontPreserveEx.Append(' ');</span>
<a href="#l2.2867"></a><span id="l2.2867"> </span>
<a href="#l2.2868"></a><span id="l2.2868">   nsAutoCString property;</span>
<a href="#l2.2869"></a><span id="l2.2869">   nsCString sourceString;</span>
<a href="#l2.2870"></a><span id="l2.2870">   bool hasMore;</span>
<a href="#l2.2871"></a><span id="l2.2871" class="difflineminus">-  while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l2.2872"></a><span id="l2.2872" class="difflineminus">-  {</span>
<a href="#l2.2873"></a><span id="l2.2873" class="difflineplus">+  while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l2.2874"></a><span id="l2.2874">     propertyEnumerator-&gt;GetNext(property);</span>
<a href="#l2.2875"></a><span id="l2.2875">     nsAutoCString propertyEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l2.2876"></a><span id="l2.2876">     propertyEx.Append(property);</span>
<a href="#l2.2877"></a><span id="l2.2877">     propertyEx.Append(' ');</span>
<a href="#l2.2878"></a><span id="l2.2878" class="difflineminus">-    if (dontPreserveEx.Find(propertyEx) != -1) // -1 is not found</span>
<a href="#l2.2879"></a><span id="l2.2879" class="difflineplus">+    if (dontPreserveEx.Find(propertyEx) != -1)  // -1 is not found</span>
<a href="#l2.2880"></a><span id="l2.2880">       continue;</span>
<a href="#l2.2881"></a><span id="l2.2881"> </span>
<a href="#l2.2882"></a><span id="l2.2882">     srcHdr-&gt;GetStringProperty(property.get(), getter_Copies(sourceString));</span>
<a href="#l2.2883"></a><span id="l2.2883">     destHdr-&gt;SetStringProperty(property.get(), sourceString.get());</span>
<a href="#l2.2884"></a><span id="l2.2884">   }</span>
<a href="#l2.2885"></a><span id="l2.2885"> </span>
<a href="#l2.2886"></a><span id="l2.2886">   nsMsgLabelValue label = 0;</span>
<a href="#l2.2887"></a><span id="l2.2887">   srcHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l2.2888"></a><span id="l2.2888">   destHdr-&gt;SetLabel(label);</span>
<a href="#l2.2889"></a><span id="l2.2889"> }</span>
<a href="#l2.2890"></a><span id="l2.2890"> </span>
<a href="#l2.2891"></a><span id="l2.2891" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::EndCopy(bool aCopySucceeded)</span>
<a href="#l2.2892"></a><span id="l2.2892" class="difflineminus">-{</span>
<a href="#l2.2893"></a><span id="l2.2893" class="difflineminus">-  if (!mCopyState)</span>
<a href="#l2.2894"></a><span id="l2.2894" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.2895"></a><span id="l2.2895" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::EndCopy(bool aCopySucceeded) {</span>
<a href="#l2.2896"></a><span id="l2.2896" class="difflineplus">+  if (!mCopyState) return NS_OK;</span>
<a href="#l2.2897"></a><span id="l2.2897"> </span>
<a href="#l2.2898"></a><span id="l2.2898">   // we are the destination folder for a move/copy</span>
<a href="#l2.2899"></a><span id="l2.2899">   nsresult rv = aCopySucceeded ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l2.2900"></a><span id="l2.2900"> </span>
<a href="#l2.2901"></a><span id="l2.2901" class="difflineminus">-  if (!aCopySucceeded || mCopyState-&gt;m_writeFailed)</span>
<a href="#l2.2902"></a><span id="l2.2902" class="difflineminus">-  {</span>
<a href="#l2.2903"></a><span id="l2.2903" class="difflineminus">-    if (mCopyState-&gt;m_fileStream)</span>
<a href="#l2.2904"></a><span id="l2.2904" class="difflineminus">-    {</span>
<a href="#l2.2905"></a><span id="l2.2905" class="difflineplus">+  if (!aCopySucceeded || mCopyState-&gt;m_writeFailed) {</span>
<a href="#l2.2906"></a><span id="l2.2906" class="difflineplus">+    if (mCopyState-&gt;m_fileStream) {</span>
<a href="#l2.2907"></a><span id="l2.2907">       if (mCopyState-&gt;m_curDstKey != nsMsgKey_None)</span>
<a href="#l2.2908"></a><span id="l2.2908">         mCopyState-&gt;m_msgStore-&gt;DiscardNewMessage(mCopyState-&gt;m_fileStream,</span>
<a href="#l2.2909"></a><span id="l2.2909">                                                   mCopyState-&gt;m_newHdr);</span>
<a href="#l2.2910"></a><span id="l2.2910">       mCopyState-&gt;m_fileStream-&gt;Close();</span>
<a href="#l2.2911"></a><span id="l2.2911">     }</span>
<a href="#l2.2912"></a><span id="l2.2912"> </span>
<a href="#l2.2913"></a><span id="l2.2913" class="difflineminus">-    if (!mCopyState-&gt;m_isMove)</span>
<a href="#l2.2914"></a><span id="l2.2914" class="difflineminus">-    {</span>
<a href="#l2.2915"></a><span id="l2.2915" class="difflineplus">+    if (!mCopyState-&gt;m_isMove) {</span>
<a href="#l2.2916"></a><span id="l2.2916">       // passing true because the messages that have been successfully</span>
<a href="#l2.2917"></a><span id="l2.2917">       // copied have their corresponding hdrs in place. The message that has</span>
<a href="#l2.2918"></a><span id="l2.2918">       // failed has been truncated so the msf file and berkeley mailbox</span>
<a href="#l2.2919"></a><span id="l2.2919">       // are in sync.</span>
<a href="#l2.2920"></a><span id="l2.2920" class="difflineminus">-      (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l2.2921"></a><span id="l2.2921" class="difflineplus">+      (void)OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l2.2922"></a><span id="l2.2922">       // enable the dest folder</span>
<a href="#l2.2923"></a><span id="l2.2923">       EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.2924"></a><span id="l2.2924">     }</span>
<a href="#l2.2925"></a><span id="l2.2925">     return NS_OK;</span>
<a href="#l2.2926"></a><span id="l2.2926">   }</span>
<a href="#l2.2927"></a><span id="l2.2927"> </span>
<a href="#l2.2928"></a><span id="l2.2928" class="difflineminus">-  bool multipleCopiesFinished = (mCopyState-&gt;m_curCopyIndex &gt;= mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.2929"></a><span id="l2.2929" class="difflineplus">+  bool multipleCopiesFinished =</span>
<a href="#l2.2930"></a><span id="l2.2930" class="difflineplus">+      (mCopyState-&gt;m_curCopyIndex &gt;= mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.2931"></a><span id="l2.2931"> </span>
<a href="#l2.2932"></a><span id="l2.2932">   RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; localUndoTxn = mCopyState-&gt;m_undoMsgTxn;</span>
<a href="#l2.2933"></a><span id="l2.2933"> </span>
<a href="#l2.2934"></a><span id="l2.2934" class="difflineminus">-  NS_ASSERTION(mCopyState-&gt;m_leftOver == 0, &quot;whoops, something wrong with previous copy&quot;);</span>
<a href="#l2.2935"></a><span id="l2.2935" class="difflineminus">-  mCopyState-&gt;m_leftOver = 0; // reset to 0.</span>
<a href="#l2.2936"></a><span id="l2.2936" class="difflineplus">+  NS_ASSERTION(mCopyState-&gt;m_leftOver == 0,</span>
<a href="#l2.2937"></a><span id="l2.2937" class="difflineplus">+               &quot;whoops, something wrong with previous copy&quot;);</span>
<a href="#l2.2938"></a><span id="l2.2938" class="difflineplus">+  mCopyState-&gt;m_leftOver = 0;  // reset to 0.</span>
<a href="#l2.2939"></a><span id="l2.2939">   // need to reset this in case we're move/copying multiple msgs.</span>
<a href="#l2.2940"></a><span id="l2.2940">   mCopyState-&gt;m_fromLineSeen = false;</span>
<a href="#l2.2941"></a><span id="l2.2941"> </span>
<a href="#l2.2942"></a><span id="l2.2942">   // flush the copied message. We need a close at the end to get the</span>
<a href="#l2.2943"></a><span id="l2.2943">   // file size and time updated correctly.</span>
<a href="#l2.2944"></a><span id="l2.2944">   //</span>
<a href="#l2.2945"></a><span id="l2.2945">   // These filestream closes are handled inconsistently in the code. In some</span>
<a href="#l2.2946"></a><span id="l2.2946">   // cases, this is done in EndMessage, while in others it is done here in</span>
<a href="#l2.2947"></a><span id="l2.2947">   // EndCopy. When we do the close in EndMessage, we'll set</span>
<a href="#l2.2948"></a><span id="l2.2948">   // mCopyState-&gt;m_fileStream to null since it is no longer needed, and detect</span>
<a href="#l2.2949"></a><span id="l2.2949">   // here the null stream so we know that we don't have to close it here.</span>
<a href="#l2.2950"></a><span id="l2.2950">   //</span>
<a href="#l2.2951"></a><span id="l2.2951">   // Similarly, m_parseMsgState-&gt;GetNewMsgHdr() returns a null hdr if the hdr</span>
<a href="#l2.2952"></a><span id="l2.2952">   // has already been processed by EndMessage so it is not doubly added here.</span>
<a href="#l2.2953"></a><span id="l2.2953"> </span>
<a href="#l2.2954"></a><span id="l2.2954" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(mCopyState-&gt;m_fileStream));</span>
<a href="#l2.2955"></a><span id="l2.2955" class="difflineminus">-  if (seekableStream)</span>
<a href="#l2.2956"></a><span id="l2.2956" class="difflineminus">-  {</span>
<a href="#l2.2957"></a><span id="l2.2957" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(</span>
<a href="#l2.2958"></a><span id="l2.2958" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_fileStream));</span>
<a href="#l2.2959"></a><span id="l2.2959" class="difflineplus">+  if (seekableStream) {</span>
<a href="#l2.2960"></a><span id="l2.2960">     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l2.2961"></a><span id="l2.2961">     rv = FinishNewLocalMessage(mCopyState-&gt;m_fileStream, mCopyState-&gt;m_newHdr,</span>
<a href="#l2.2962"></a><span id="l2.2962">                                mCopyState-&gt;m_msgStore,</span>
<a href="#l2.2963"></a><span id="l2.2963">                                mCopyState-&gt;m_parseMsgState);</span>
<a href="#l2.2964"></a><span id="l2.2964">     if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_newHdr)</span>
<a href="#l2.2965"></a><span id="l2.2965">       mCopyState-&gt;m_newHdr-&gt;GetMessageKey(&amp;mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.2966"></a><span id="l2.2966">     if (multipleCopiesFinished)</span>
<a href="#l2.2967"></a><span id="l2.2967">       mCopyState-&gt;m_fileStream-&gt;Close();</span>
<a href="#l2.2968"></a><span id="l2.2968">     else</span>
<a href="#l2.2969"></a><span id="l2.2969">       mCopyState-&gt;m_fileStream-&gt;Flush();</span>
<a href="#l2.2970"></a><span id="l2.2970">   }</span>
<a href="#l2.2971"></a><span id="l2.2971" class="difflineminus">-  //Copy the header to the new database</span>
<a href="#l2.2972"></a><span id="l2.2972" class="difflineminus">-  if (mCopyState-&gt;m_message)</span>
<a href="#l2.2973"></a><span id="l2.2973" class="difflineminus">-  {</span>
<a href="#l2.2974"></a><span id="l2.2974" class="difflineplus">+  // Copy the header to the new database</span>
<a href="#l2.2975"></a><span id="l2.2975" class="difflineplus">+  if (mCopyState-&gt;m_message) {</span>
<a href="#l2.2976"></a><span id="l2.2976">     //  CopyMessages() goes here, and CopyFileMessages() with metadata to save;</span>
<a href="#l2.2977"></a><span id="l2.2977">     nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l2.2978"></a><span id="l2.2978" class="difflineminus">-    if (!mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.2979"></a><span id="l2.2979" class="difflineminus">-    {</span>
<a href="#l2.2980"></a><span id="l2.2980" class="difflineminus">-      if (mCopyState-&gt;m_destDB)</span>
<a href="#l2.2981"></a><span id="l2.2981" class="difflineminus">-      {</span>
<a href="#l2.2982"></a><span id="l2.2982" class="difflineminus">-        if (mCopyState-&gt;m_newHdr)</span>
<a href="#l2.2983"></a><span id="l2.2983" class="difflineminus">-        {</span>
<a href="#l2.2984"></a><span id="l2.2984" class="difflineplus">+    if (!mCopyState-&gt;m_parseMsgState) {</span>
<a href="#l2.2985"></a><span id="l2.2985" class="difflineplus">+      if (mCopyState-&gt;m_destDB) {</span>
<a href="#l2.2986"></a><span id="l2.2986" class="difflineplus">+        if (mCopyState-&gt;m_newHdr) {</span>
<a href="#l2.2987"></a><span id="l2.2987">           newHdr = mCopyState-&gt;m_newHdr;</span>
<a href="#l2.2988"></a><span id="l2.2988" class="difflineminus">-          CopyHdrPropertiesWithSkipList(newHdr, mCopyState-&gt;m_message,</span>
<a href="#l2.2989"></a><span id="l2.2989" class="difflineminus">-                                        NS_LITERAL_CSTRING(&quot;storeToken msgOffset&quot;));</span>
<a href="#l2.2990"></a><span id="l2.2990" class="difflineminus">-//          UpdateNewMsgHdr(mCopyState-&gt;m_message, newHdr);</span>
<a href="#l2.2991"></a><span id="l2.2991" class="difflineplus">+          CopyHdrPropertiesWithSkipList(</span>
<a href="#l2.2992"></a><span id="l2.2992" class="difflineplus">+              newHdr, mCopyState-&gt;m_message,</span>
<a href="#l2.2993"></a><span id="l2.2993" class="difflineplus">+              NS_LITERAL_CSTRING(&quot;storeToken msgOffset&quot;));</span>
<a href="#l2.2994"></a><span id="l2.2994" class="difflineplus">+          //          UpdateNewMsgHdr(mCopyState-&gt;m_message, newHdr);</span>
<a href="#l2.2995"></a><span id="l2.2995">           // We need to copy more than just what UpdateNewMsgHdr does. In fact,</span>
<a href="#l2.2996"></a><span id="l2.2996">           // I think we want to copy almost every property other than</span>
<a href="#l2.2997"></a><span id="l2.2997">           // storeToken and msgOffset.</span>
<a href="#l2.2998"></a><span id="l2.2998">           mCopyState-&gt;m_destDB-&gt;AddNewHdrToDB(newHdr, true);</span>
<a href="#l2.2999"></a><span id="l2.2999" class="difflineminus">-        }</span>
<a href="#l2.3000"></a><span id="l2.3000" class="difflineminus">-        else</span>
<a href="#l2.3001"></a><span id="l2.3001" class="difflineminus">-        {</span>
<a href="#l2.3002"></a><span id="l2.3002" class="difflineminus">-        rv = mCopyState-&gt;m_destDB-&gt;CopyHdrFromExistingHdr(mCopyState-&gt;m_curDstKey,</span>
<a href="#l2.3003"></a><span id="l2.3003" class="difflineminus">-          mCopyState-&gt;m_message, true,</span>
<a href="#l2.3004"></a><span id="l2.3004" class="difflineminus">-          getter_AddRefs(newHdr));</span>
<a href="#l2.3005"></a><span id="l2.3005" class="difflineplus">+        } else {</span>
<a href="#l2.3006"></a><span id="l2.3006" class="difflineplus">+          rv = mCopyState-&gt;m_destDB-&gt;CopyHdrFromExistingHdr(</span>
<a href="#l2.3007"></a><span id="l2.3007" class="difflineplus">+              mCopyState-&gt;m_curDstKey, mCopyState-&gt;m_message, true,</span>
<a href="#l2.3008"></a><span id="l2.3008" class="difflineplus">+              getter_AddRefs(newHdr));</span>
<a href="#l2.3009"></a><span id="l2.3009">         }</span>
<a href="#l2.3010"></a><span id="l2.3010">         uint32_t newHdrFlags;</span>
<a href="#l2.3011"></a><span id="l2.3011" class="difflineminus">-        if (newHdr)</span>
<a href="#l2.3012"></a><span id="l2.3012" class="difflineminus">-        {</span>
<a href="#l2.3013"></a><span id="l2.3013" class="difflineplus">+        if (newHdr) {</span>
<a href="#l2.3014"></a><span id="l2.3014">           // turn off offline flag - it's not valid for local mail folders.</span>
<a href="#l2.3015"></a><span id="l2.3015">           newHdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;newHdrFlags);</span>
<a href="#l2.3016"></a><span id="l2.3016">           mCopyState-&gt;m_destMessages-&gt;AppendElement(newHdr);</span>
<a href="#l2.3017"></a><span id="l2.3017">         }</span>
<a href="#l2.3018"></a><span id="l2.3018">       }</span>
<a href="#l2.3019"></a><span id="l2.3019">       // we can do undo with the dest folder db, see bug #198909</span>
<a href="#l2.3020"></a><span id="l2.3020" class="difflineminus">-      //else</span>
<a href="#l2.3021"></a><span id="l2.3021" class="difflineminus">-      //  mCopyState-&gt;m_undoMsgTxn = nullptr; //null out the transaction because we can't undo w/o the msg db</span>
<a href="#l2.3022"></a><span id="l2.3022" class="difflineplus">+      // else</span>
<a href="#l2.3023"></a><span id="l2.3023" class="difflineplus">+      //  mCopyState-&gt;m_undoMsgTxn = nullptr; //null out the transaction because</span>
<a href="#l2.3024"></a><span id="l2.3024" class="difflineplus">+      //  we can't undo w/o the msg db</span>
<a href="#l2.3025"></a><span id="l2.3025">     }</span>
<a href="#l2.3026"></a><span id="l2.3026"> </span>
<a href="#l2.3027"></a><span id="l2.3027" class="difflineminus">-    // if we plan on allowing undo, (if we have a mCopyState-&gt;m_parseMsgState or not)</span>
<a href="#l2.3028"></a><span id="l2.3028" class="difflineminus">-    // we need to save the source and dest keys on the undo txn.</span>
<a href="#l2.3029"></a><span id="l2.3029" class="difflineminus">-    // see bug #179856 for details</span>
<a href="#l2.3030"></a><span id="l2.3030" class="difflineplus">+    // if we plan on allowing undo, (if we have a mCopyState-&gt;m_parseMsgState or</span>
<a href="#l2.3031"></a><span id="l2.3031" class="difflineplus">+    // not) we need to save the source and dest keys on the undo txn. see bug</span>
<a href="#l2.3032"></a><span id="l2.3032" class="difflineplus">+    // #179856 for details</span>
<a href="#l2.3033"></a><span id="l2.3033">     bool isImap;</span>
<a href="#l2.3034"></a><span id="l2.3034">     if (NS_SUCCEEDED(rv) &amp;&amp; localUndoTxn) {</span>
<a href="#l2.3035"></a><span id="l2.3035">       localUndoTxn-&gt;GetSrcIsImap(&amp;isImap);</span>
<a href="#l2.3036"></a><span id="l2.3036" class="difflineminus">-      if (!isImap || !mCopyState-&gt;m_copyingMultipleMessages)</span>
<a href="#l2.3037"></a><span id="l2.3037" class="difflineminus">-      {</span>
<a href="#l2.3038"></a><span id="l2.3038" class="difflineplus">+      if (!isImap || !mCopyState-&gt;m_copyingMultipleMessages) {</span>
<a href="#l2.3039"></a><span id="l2.3039">         nsMsgKey aKey;</span>
<a href="#l2.3040"></a><span id="l2.3040">         uint32_t statusOffset;</span>
<a href="#l2.3041"></a><span id="l2.3041">         mCopyState-&gt;m_message-&gt;GetMessageKey(&amp;aKey);</span>
<a href="#l2.3042"></a><span id="l2.3042">         mCopyState-&gt;m_message-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l2.3043"></a><span id="l2.3043">         localUndoTxn-&gt;AddSrcKey(aKey);</span>
<a href="#l2.3044"></a><span id="l2.3044">         localUndoTxn-&gt;AddSrcStatusOffset(statusOffset);</span>
<a href="#l2.3045"></a><span id="l2.3045">         localUndoTxn-&gt;AddDstKey(mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.3046"></a><span id="l2.3046">       }</span>
<a href="#l2.3047"></a><span id="l2.3047">     }</span>
<a href="#l2.3048"></a><span id="l2.3048">   }</span>
<a href="#l2.3049"></a><span id="l2.3049">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l2.3050"></a><span id="l2.3050">   // CopyFileMessage() and CopyMessages() from servers other than mailbox</span>
<a href="#l2.3051"></a><span id="l2.3051" class="difflineminus">-  if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.3052"></a><span id="l2.3052" class="difflineminus">-  {</span>
<a href="#l2.3053"></a><span id="l2.3053" class="difflineplus">+  if (mCopyState-&gt;m_parseMsgState) {</span>
<a href="#l2.3054"></a><span id="l2.3054">     nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l2.3055"></a><span id="l2.3055">     mCopyState-&gt;m_parseMsgState-&gt;FinishHeader();</span>
<a href="#l2.3056"></a><span id="l2.3056">     GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l2.3057"></a><span id="l2.3057" class="difflineminus">-    if (msgDb)</span>
<a href="#l2.3058"></a><span id="l2.3058" class="difflineminus">-    {</span>
<a href="#l2.3059"></a><span id="l2.3059" class="difflineminus">-      nsresult result = mCopyState-&gt;m_parseMsgState-&gt;GetNewMsgHdr(getter_AddRefs(newHdr));</span>
<a href="#l2.3060"></a><span id="l2.3060" class="difflineplus">+    if (msgDb) {</span>
<a href="#l2.3061"></a><span id="l2.3061" class="difflineplus">+      nsresult result =</span>
<a href="#l2.3062"></a><span id="l2.3062" class="difflineplus">+          mCopyState-&gt;m_parseMsgState-&gt;GetNewMsgHdr(getter_AddRefs(newHdr));</span>
<a href="#l2.3063"></a><span id="l2.3063">       // we need to copy newHdr because mCopyState will get cleared</span>
<a href="#l2.3064"></a><span id="l2.3064">       // in OnCopyCompleted, but we need OnCopyCompleted to know about</span>
<a href="#l2.3065"></a><span id="l2.3065">       // the newHdr, via mCopyState. And we send a notification about newHdr</span>
<a href="#l2.3066"></a><span id="l2.3066">       // after OnCopyCompleted.</span>
<a href="#l2.3067"></a><span id="l2.3067">       mCopyState-&gt;m_newHdr = newHdr;</span>
<a href="#l2.3068"></a><span id="l2.3068" class="difflineminus">-      if (NS_SUCCEEDED(result) &amp;&amp; newHdr)</span>
<a href="#l2.3069"></a><span id="l2.3069" class="difflineminus">-      {</span>
<a href="#l2.3070"></a><span id="l2.3070" class="difflineplus">+      if (NS_SUCCEEDED(result) &amp;&amp; newHdr) {</span>
<a href="#l2.3071"></a><span id="l2.3071">         // Copy message metadata.</span>
<a href="#l2.3072"></a><span id="l2.3072" class="difflineminus">-        if (mCopyState-&gt;m_message)</span>
<a href="#l2.3073"></a><span id="l2.3073" class="difflineminus">-        {</span>
<a href="#l2.3074"></a><span id="l2.3074" class="difflineplus">+        if (mCopyState-&gt;m_message) {</span>
<a href="#l2.3075"></a><span id="l2.3075">           // Propagate the new flag on an imap to local folder filter action</span>
<a href="#l2.3076"></a><span id="l2.3076">           // Flags may get changed when deleting the original source message in</span>
<a href="#l2.3077"></a><span id="l2.3077">           // IMAP. We have a copy of the original flags, but parseMsgState has</span>
<a href="#l2.3078"></a><span id="l2.3078">           // already tried to decide what those flags should be. Who to believe?</span>
<a href="#l2.3079"></a><span id="l2.3079">           // Let's only deal here with the flags that might get changed, Read</span>
<a href="#l2.3080"></a><span id="l2.3080">           // and New, and trust upstream code for everything else.</span>
<a href="#l2.3081"></a><span id="l2.3081" class="difflineminus">-          uint32_t readAndNew = nsMsgMessageFlags::New | nsMsgMessageFlags::Read;</span>
<a href="#l2.3082"></a><span id="l2.3082" class="difflineplus">+          uint32_t readAndNew =</span>
<a href="#l2.3083"></a><span id="l2.3083" class="difflineplus">+              nsMsgMessageFlags::New | nsMsgMessageFlags::Read;</span>
<a href="#l2.3084"></a><span id="l2.3084">           uint32_t newFlags;</span>
<a href="#l2.3085"></a><span id="l2.3085">           newHdr-&gt;GetFlags(&amp;newFlags);</span>
<a href="#l2.3086"></a><span id="l2.3086" class="difflineminus">-          newHdr-&gt;SetFlags( (newFlags &amp; ~readAndNew) |</span>
<a href="#l2.3087"></a><span id="l2.3087" class="difflineminus">-                            ((mCopyState-&gt;m_flags) &amp; readAndNew));</span>
<a href="#l2.3088"></a><span id="l2.3088" class="difflineplus">+          newHdr-&gt;SetFlags((newFlags &amp; ~readAndNew) |</span>
<a href="#l2.3089"></a><span id="l2.3089" class="difflineplus">+                           ((mCopyState-&gt;m_flags) &amp; readAndNew));</span>
<a href="#l2.3090"></a><span id="l2.3090"> </span>
<a href="#l2.3091"></a><span id="l2.3091">           // Copy other message properties.</span>
<a href="#l2.3092"></a><span id="l2.3092" class="difflineminus">-          CopyPropertiesToMsgHdr(newHdr, mCopyState-&gt;m_message, mCopyState-&gt;m_isMove);</span>
<a href="#l2.3093"></a><span id="l2.3093" class="difflineplus">+          CopyPropertiesToMsgHdr(newHdr, mCopyState-&gt;m_message,</span>
<a href="#l2.3094"></a><span id="l2.3094" class="difflineplus">+                                 mCopyState-&gt;m_isMove);</span>
<a href="#l2.3095"></a><span id="l2.3095">         }</span>
<a href="#l2.3096"></a><span id="l2.3096">         msgDb-&gt;AddNewHdrToDB(newHdr, true);</span>
<a href="#l2.3097"></a><span id="l2.3097" class="difflineminus">-        if (localUndoTxn)</span>
<a href="#l2.3098"></a><span id="l2.3098" class="difflineminus">-        {</span>
<a href="#l2.3099"></a><span id="l2.3099" class="difflineplus">+        if (localUndoTxn) {</span>
<a href="#l2.3100"></a><span id="l2.3100">           // ** jt - recording the message size for possible undo use; the</span>
<a href="#l2.3101"></a><span id="l2.3101">           // message size is different for pop3 and imap4 messages</span>
<a href="#l2.3102"></a><span id="l2.3102">           uint32_t msgSize;</span>
<a href="#l2.3103"></a><span id="l2.3103">           newHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l2.3104"></a><span id="l2.3104">           localUndoTxn-&gt;AddDstMsgSize(msgSize);</span>
<a href="#l2.3105"></a><span id="l2.3105">         }</span>
<a href="#l2.3106"></a><span id="l2.3106"> </span>
<a href="#l2.3107"></a><span id="l2.3107">         mCopyState-&gt;m_destMessages-&gt;AppendElement(newHdr);</span>
<a href="#l2.3108"></a><span id="l2.3108">       }</span>
<a href="#l2.3109"></a><span id="l2.3109">       // msgDb-&gt;SetSummaryValid(true);</span>
<a href="#l2.3110"></a><span id="l2.3110">       // msgDb-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l2.3111"></a><span id="l2.3111" class="difflineminus">-    }</span>
<a href="#l2.3112"></a><span id="l2.3112" class="difflineminus">-    else</span>
<a href="#l2.3113"></a><span id="l2.3113" class="difflineminus">-      mCopyState-&gt;m_undoMsgTxn = nullptr; //null out the transaction because we can't undo w/o the msg db</span>
<a href="#l2.3114"></a><span id="l2.3114" class="difflineplus">+    } else</span>
<a href="#l2.3115"></a><span id="l2.3115" class="difflineplus">+      mCopyState-&gt;m_undoMsgTxn = nullptr;  // null out the transaction because</span>
<a href="#l2.3116"></a><span id="l2.3116" class="difflineplus">+                                           // we can't undo w/o the msg db</span>
<a href="#l2.3117"></a><span id="l2.3117"> </span>
<a href="#l2.3118"></a><span id="l2.3118">     mCopyState-&gt;m_parseMsgState-&gt;Clear();</span>
<a href="#l2.3119"></a><span id="l2.3119" class="difflineminus">-    if (mCopyState-&gt;m_listener) // CopyFileMessage() only</span>
<a href="#l2.3120"></a><span id="l2.3120" class="difflineplus">+    if (mCopyState-&gt;m_listener)  // CopyFileMessage() only</span>
<a href="#l2.3121"></a><span id="l2.3121">       mCopyState-&gt;m_listener-&gt;SetMessageKey(mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.3122"></a><span id="l2.3122">   }</span>
<a href="#l2.3123"></a><span id="l2.3123"> </span>
<a href="#l2.3124"></a><span id="l2.3124" class="difflineminus">-  if (!multipleCopiesFinished &amp;&amp; !mCopyState-&gt;m_copyingMultipleMessages)</span>
<a href="#l2.3125"></a><span id="l2.3125" class="difflineminus">-  {</span>
<a href="#l2.3126"></a><span id="l2.3126" class="difflineplus">+  if (!multipleCopiesFinished &amp;&amp; !mCopyState-&gt;m_copyingMultipleMessages) {</span>
<a href="#l2.3127"></a><span id="l2.3127">     // CopyMessages() goes here; CopyFileMessage() never gets in here because</span>
<a href="#l2.3128"></a><span id="l2.3128">     // curCopyIndex will always be less than the mCopyState-&gt;m_totalMsgCount</span>
<a href="#l2.3129"></a><span id="l2.3129" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport = do_QueryElementAt(mCopyState-&gt;m_messages, mCopyState-&gt;m_curCopyIndex);</span>
<a href="#l2.3130"></a><span id="l2.3130" class="difflineminus">-    rv = CopyMessageTo(aSupport, this, mCopyState-&gt;m_msgWindow, mCopyState-&gt;m_isMove);</span>
<a href="#l2.3131"></a><span id="l2.3131" class="difflineminus">-  }</span>
<a href="#l2.3132"></a><span id="l2.3132" class="difflineminus">-  else</span>
<a href="#l2.3133"></a><span id="l2.3133" class="difflineminus">-  {</span>
<a href="#l2.3134"></a><span id="l2.3134" class="difflineminus">-    // If we have some headers, then there is a source, so notify itemMoveCopyCompleted.</span>
<a href="#l2.3135"></a><span id="l2.3135" class="difflineminus">-    // If we don't have any headers already, (eg save as draft, send) then notify itemAdded.</span>
<a href="#l2.3136"></a><span id="l2.3136" class="difflineminus">-    // This notification is done after the messages are deleted, so that saving a new draft</span>
<a href="#l2.3137"></a><span id="l2.3137" class="difflineminus">-    // of a message works correctly -- first an itemDeleted is sent for the old draft, then</span>
<a href="#l2.3138"></a><span id="l2.3138" class="difflineminus">-    // an itemAdded for the new draft.</span>
<a href="#l2.3139"></a><span id="l2.3139" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; aSupport =</span>
<a href="#l2.3140"></a><span id="l2.3140" class="difflineplus">+        do_QueryElementAt(mCopyState-&gt;m_messages, mCopyState-&gt;m_curCopyIndex);</span>
<a href="#l2.3141"></a><span id="l2.3141" class="difflineplus">+    rv = CopyMessageTo(aSupport, this, mCopyState-&gt;m_msgWindow,</span>
<a href="#l2.3142"></a><span id="l2.3142" class="difflineplus">+                       mCopyState-&gt;m_isMove);</span>
<a href="#l2.3143"></a><span id="l2.3143" class="difflineplus">+  } else {</span>
<a href="#l2.3144"></a><span id="l2.3144" class="difflineplus">+    // If we have some headers, then there is a source, so notify</span>
<a href="#l2.3145"></a><span id="l2.3145" class="difflineplus">+    // itemMoveCopyCompleted. If we don't have any headers already, (eg save as</span>
<a href="#l2.3146"></a><span id="l2.3146" class="difflineplus">+    // draft, send) then notify itemAdded. This notification is done after the</span>
<a href="#l2.3147"></a><span id="l2.3147" class="difflineplus">+    // messages are deleted, so that saving a new draft of a message works</span>
<a href="#l2.3148"></a><span id="l2.3148" class="difflineplus">+    // correctly -- first an itemDeleted is sent for the old draft, then an</span>
<a href="#l2.3149"></a><span id="l2.3149" class="difflineplus">+    // itemAdded for the new draft.</span>
<a href="#l2.3150"></a><span id="l2.3150">     uint32_t numHdrs;</span>
<a href="#l2.3151"></a><span id="l2.3151">     mCopyState-&gt;m_messages-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l2.3152"></a><span id="l2.3152"> </span>
<a href="#l2.3153"></a><span id="l2.3153" class="difflineminus">-    if (multipleCopiesFinished &amp;&amp; numHdrs &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l2.3154"></a><span id="l2.3154" class="difflineminus">-    {</span>
<a href="#l2.3155"></a><span id="l2.3155" class="difflineplus">+    if (multipleCopiesFinished &amp;&amp; numHdrs &amp;&amp; !mCopyState-&gt;m_isFolder) {</span>
<a href="#l2.3156"></a><span id="l2.3156">       // we need to send this notification before we delete the source messages,</span>
<a href="#l2.3157"></a><span id="l2.3157">       // because deleting the source messages clears out the src msg db hdr.</span>
<a href="#l2.3158"></a><span id="l2.3158" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.3159"></a><span id="l2.3159" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l2.3160"></a><span id="l2.3160" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.3161"></a><span id="l2.3161">       if (notifier)</span>
<a href="#l2.3162"></a><span id="l2.3162">         notifier-&gt;NotifyMsgsMoveCopyCompleted(mCopyState-&gt;m_isMove,</span>
<a href="#l2.3163"></a><span id="l2.3163" class="difflineminus">-                                              mCopyState-&gt;m_messages,</span>
<a href="#l2.3164"></a><span id="l2.3164" class="difflineminus">-                                              this, mCopyState-&gt;m_destMessages);</span>
<a href="#l2.3165"></a><span id="l2.3165" class="difflineplus">+                                              mCopyState-&gt;m_messages, this,</span>
<a href="#l2.3166"></a><span id="l2.3166" class="difflineplus">+                                              mCopyState-&gt;m_destMessages);</span>
<a href="#l2.3167"></a><span id="l2.3167">     }</span>
<a href="#l2.3168"></a><span id="l2.3168"> </span>
<a href="#l2.3169"></a><span id="l2.3169" class="difflineminus">-    if (!mCopyState-&gt;m_isMove)</span>
<a href="#l2.3170"></a><span id="l2.3170" class="difflineminus">-    {</span>
<a href="#l2.3171"></a><span id="l2.3171" class="difflineminus">-      if (multipleCopiesFinished)</span>
<a href="#l2.3172"></a><span id="l2.3172" class="difflineminus">-      {</span>
<a href="#l2.3173"></a><span id="l2.3173" class="difflineplus">+    if (!mCopyState-&gt;m_isMove) {</span>
<a href="#l2.3174"></a><span id="l2.3174" class="difflineplus">+      if (multipleCopiesFinished) {</span>
<a href="#l2.3175"></a><span id="l2.3175">         nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder;</span>
<a href="#l2.3176"></a><span id="l2.3176">         srcFolder = do_QueryInterface(mCopyState-&gt;m_srcSupport);</span>
<a href="#l2.3177"></a><span id="l2.3177">         if (mCopyState-&gt;m_isFolder)</span>
<a href="#l2.3178"></a><span id="l2.3178" class="difflineminus">-          CopyAllSubFolders(srcFolder, nullptr, nullptr);  //Copy all subfolders then notify completion</span>
<a href="#l2.3179"></a><span id="l2.3179" class="difflineminus">-</span>
<a href="#l2.3180"></a><span id="l2.3180" class="difflineminus">-        if (mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l2.3181"></a><span id="l2.3181" class="difflineminus">-        {</span>
<a href="#l2.3182"></a><span id="l2.3182" class="difflineplus">+          CopyAllSubFolders(</span>
<a href="#l2.3183"></a><span id="l2.3183" class="difflineplus">+              srcFolder, nullptr,</span>
<a href="#l2.3184"></a><span id="l2.3184" class="difflineplus">+              nullptr);  // Copy all subfolders then notify completion</span>
<a href="#l2.3185"></a><span id="l2.3185" class="difflineplus">+</span>
<a href="#l2.3186"></a><span id="l2.3186" class="difflineplus">+        if (mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn) {</span>
<a href="#l2.3187"></a><span id="l2.3187">           nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l2.3188"></a><span id="l2.3188" class="difflineminus">-          mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l2.3189"></a><span id="l2.3189" class="difflineminus">-          if (txnMgr)</span>
<a href="#l2.3190"></a><span id="l2.3190" class="difflineminus">-            txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l2.3191"></a><span id="l2.3191" class="difflineplus">+          mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(</span>
<a href="#l2.3192"></a><span id="l2.3192" class="difflineplus">+              getter_AddRefs(txnMgr));</span>
<a href="#l2.3193"></a><span id="l2.3193" class="difflineplus">+          if (txnMgr) txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l2.3194"></a><span id="l2.3194">         }</span>
<a href="#l2.3195"></a><span id="l2.3195"> </span>
<a href="#l2.3196"></a><span id="l2.3196">         // enable the dest folder</span>
<a href="#l2.3197"></a><span id="l2.3197">         EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.3198"></a><span id="l2.3198" class="difflineminus">-        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l2.3199"></a><span id="l2.3199" class="difflineminus">-        {</span>
<a href="#l2.3200"></a><span id="l2.3200" class="difflineminus">-          // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l2.3201"></a><span id="l2.3201" class="difflineminus">-          // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l2.3202"></a><span id="l2.3202" class="difflineminus">-          // during the kDeleteOrMoveMsgCompleted call.</span>
<a href="#l2.3203"></a><span id="l2.3203" class="difflineplus">+        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder) {</span>
<a href="#l2.3204"></a><span id="l2.3204" class="difflineplus">+          // I'm not too sure of the proper location of this event. It seems to</span>
<a href="#l2.3205"></a><span id="l2.3205" class="difflineplus">+          // need to be after the EnableNotifications, or the folder counts can</span>
<a href="#l2.3206"></a><span id="l2.3206" class="difflineplus">+          // be incorrect during the kDeleteOrMoveMsgCompleted call.</span>
<a href="#l2.3207"></a><span id="l2.3207">           srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgCompleted);</span>
<a href="#l2.3208"></a><span id="l2.3208">         }</span>
<a href="#l2.3209"></a><span id="l2.3209" class="difflineminus">-        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l2.3210"></a><span id="l2.3210" class="difflineplus">+        (void)OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l2.3211"></a><span id="l2.3211">       }</span>
<a href="#l2.3212"></a><span id="l2.3212">     }</span>
<a href="#l2.3213"></a><span id="l2.3213" class="difflineminus">-    // Send the itemAdded notification in case we didn't send the itemMoveCopyCompleted notification earlier.</span>
<a href="#l2.3214"></a><span id="l2.3214" class="difflineminus">-    // Posting news messages involves this, yet doesn't have the newHdr initialized, so don't send any</span>
<a href="#l2.3215"></a><span id="l2.3215" class="difflineplus">+    // Send the itemAdded notification in case we didn't send the</span>
<a href="#l2.3216"></a><span id="l2.3216" class="difflineplus">+    // itemMoveCopyCompleted notification earlier. Posting news messages</span>
<a href="#l2.3217"></a><span id="l2.3217" class="difflineplus">+    // involves this, yet doesn't have the newHdr initialized, so don't send any</span>
<a href="#l2.3218"></a><span id="l2.3218">     // notifications in that case.</span>
<a href="#l2.3219"></a><span id="l2.3219" class="difflineminus">-    if (!numHdrs &amp;&amp; newHdr)</span>
<a href="#l2.3220"></a><span id="l2.3220" class="difflineminus">-    {</span>
<a href="#l2.3221"></a><span id="l2.3221" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.3222"></a><span id="l2.3222" class="difflineminus">-      if (notifier)</span>
<a href="#l2.3223"></a><span id="l2.3223" class="difflineminus">-      {</span>
<a href="#l2.3224"></a><span id="l2.3224" class="difflineplus">+    if (!numHdrs &amp;&amp; newHdr) {</span>
<a href="#l2.3225"></a><span id="l2.3225" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l2.3226"></a><span id="l2.3226" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l2.3227"></a><span id="l2.3227" class="difflineplus">+      if (notifier) {</span>
<a href="#l2.3228"></a><span id="l2.3228">         notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l2.3229"></a><span id="l2.3229">         // We do not appear to trigger classification in this case, so let's</span>
<a href="#l2.3230"></a><span id="l2.3230">         // paper over the abyss by just sending the classification notification.</span>
<a href="#l2.3231"></a><span id="l2.3231" class="difflineminus">-        nsCOMPtr &lt;nsIMutableArray&gt; oneHeaderArray =</span>
<a href="#l2.3232"></a><span id="l2.3232" class="difflineminus">-          do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l2.3233"></a><span id="l2.3233" class="difflineplus">+        nsCOMPtr&lt;nsIMutableArray&gt; oneHeaderArray =</span>
<a href="#l2.3234"></a><span id="l2.3234" class="difflineplus">+            do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l2.3235"></a><span id="l2.3235">         oneHeaderArray-&gt;AppendElement(newHdr);</span>
<a href="#l2.3236"></a><span id="l2.3236">         notifier-&gt;NotifyMsgsClassified(oneHeaderArray, false, false);</span>
<a href="#l2.3237"></a><span id="l2.3237">         // (We do not add the NotReportedClassified processing flag since we</span>
<a href="#l2.3238"></a><span id="l2.3238">         // just reported it!)</span>
<a href="#l2.3239"></a><span id="l2.3239">       }</span>
<a href="#l2.3240"></a><span id="l2.3240">     }</span>
<a href="#l2.3241"></a><span id="l2.3241">   }</span>
<a href="#l2.3242"></a><span id="l2.3242">   return rv;</span>
<a href="#l2.3243"></a><span id="l2.3243"> }</span>
<a href="#l2.3244"></a><span id="l2.3244"> </span>
<a href="#l2.3245"></a><span id="l2.3245"> static bool gGotGlobalPrefs;</span>
<a href="#l2.3246"></a><span id="l2.3246"> static bool gDeleteFromServerOnMove;</span>
<a href="#l2.3247"></a><span id="l2.3247"> </span>
<a href="#l2.3248"></a><span id="l2.3248" class="difflineminus">-bool nsMsgLocalMailFolder::GetDeleteFromServerOnMove()</span>
<a href="#l2.3249"></a><span id="l2.3249" class="difflineminus">-{</span>
<a href="#l2.3250"></a><span id="l2.3250" class="difflineminus">-  if (!gGotGlobalPrefs)</span>
<a href="#l2.3251"></a><span id="l2.3251" class="difflineminus">-  {</span>
<a href="#l2.3252"></a><span id="l2.3252" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l2.3253"></a><span id="l2.3253" class="difflineminus">-    if (pPrefBranch)</span>
<a href="#l2.3254"></a><span id="l2.3254" class="difflineminus">-    {</span>
<a href="#l2.3255"></a><span id="l2.3255" class="difflineminus">-      pPrefBranch-&gt;GetBoolPref(&quot;mail.pop3.deleteFromServerOnMove&quot;, &amp;gDeleteFromServerOnMove);</span>
<a href="#l2.3256"></a><span id="l2.3256" class="difflineplus">+bool nsMsgLocalMailFolder::GetDeleteFromServerOnMove() {</span>
<a href="#l2.3257"></a><span id="l2.3257" class="difflineplus">+  if (!gGotGlobalPrefs) {</span>
<a href="#l2.3258"></a><span id="l2.3258" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l2.3259"></a><span id="l2.3259" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l2.3260"></a><span id="l2.3260" class="difflineplus">+    if (pPrefBranch) {</span>
<a href="#l2.3261"></a><span id="l2.3261" class="difflineplus">+      pPrefBranch-&gt;GetBoolPref(&quot;mail.pop3.deleteFromServerOnMove&quot;,</span>
<a href="#l2.3262"></a><span id="l2.3262" class="difflineplus">+                               &amp;gDeleteFromServerOnMove);</span>
<a href="#l2.3263"></a><span id="l2.3263">       gGotGlobalPrefs = true;</span>
<a href="#l2.3264"></a><span id="l2.3264">     }</span>
<a href="#l2.3265"></a><span id="l2.3265">   }</span>
<a href="#l2.3266"></a><span id="l2.3266">   return gDeleteFromServerOnMove;</span>
<a href="#l2.3267"></a><span id="l2.3267"> }</span>
<a href="#l2.3268"></a><span id="l2.3268"> </span>
<a href="#l2.3269"></a><span id="l2.3269" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::EndMove(bool moveSucceeded)</span>
<a href="#l2.3270"></a><span id="l2.3270" class="difflineminus">-{</span>
<a href="#l2.3271"></a><span id="l2.3271" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::EndMove(bool moveSucceeded) {</span>
<a href="#l2.3272"></a><span id="l2.3272">   nsresult rv;</span>
<a href="#l2.3273"></a><span id="l2.3273" class="difflineminus">-  if (!mCopyState)</span>
<a href="#l2.3274"></a><span id="l2.3274" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.3275"></a><span id="l2.3275" class="difflineminus">-</span>
<a href="#l2.3276"></a><span id="l2.3276" class="difflineminus">-  if (!moveSucceeded || mCopyState-&gt;m_writeFailed)</span>
<a href="#l2.3277"></a><span id="l2.3277" class="difflineminus">-  {</span>
<a href="#l2.3278"></a><span id="l2.3278" class="difflineminus">-    //Notify that a completion finished.</span>
<a href="#l2.3279"></a><span id="l2.3279" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l2.3280"></a><span id="l2.3280" class="difflineplus">+  if (!mCopyState) return NS_OK;</span>
<a href="#l2.3281"></a><span id="l2.3281" class="difflineplus">+</span>
<a href="#l2.3282"></a><span id="l2.3282" class="difflineplus">+  if (!moveSucceeded || mCopyState-&gt;m_writeFailed) {</span>
<a href="#l2.3283"></a><span id="l2.3283" class="difflineplus">+    // Notify that a completion finished.</span>
<a href="#l2.3284"></a><span id="l2.3284" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder =</span>
<a href="#l2.3285"></a><span id="l2.3285" class="difflineplus">+        do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l2.3286"></a><span id="l2.3286">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3287"></a><span id="l2.3287">     srcFolder-&gt;NotifyFolderEvent(kDeleteOrMoveMsgFailed);</span>
<a href="#l2.3288"></a><span id="l2.3288"> </span>
<a href="#l2.3289"></a><span id="l2.3289" class="difflineminus">-    /* passing true because the messages that have been successfully copied have their corressponding</span>
<a href="#l2.3290"></a><span id="l2.3290" class="difflineminus">-               hdrs in place. The message that has failed has been truncated so the msf file and berkeley mailbox</span>
<a href="#l2.3291"></a><span id="l2.3291" class="difflineminus">-               are in sync*/</span>
<a href="#l2.3292"></a><span id="l2.3292" class="difflineminus">-</span>
<a href="#l2.3293"></a><span id="l2.3293" class="difflineminus">-    (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l2.3294"></a><span id="l2.3294" class="difflineplus">+    /* passing true because the messages that have been successfully copied have</span>
<a href="#l2.3295"></a><span id="l2.3295" class="difflineplus">+       their corressponding hdrs in place. The message that has failed has been</span>
<a href="#l2.3296"></a><span id="l2.3296" class="difflineplus">+       truncated so the msf file and berkeley mailbox are in sync*/</span>
<a href="#l2.3297"></a><span id="l2.3297" class="difflineplus">+</span>
<a href="#l2.3298"></a><span id="l2.3298" class="difflineplus">+    (void)OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l2.3299"></a><span id="l2.3299">     // enable the dest folder</span>
<a href="#l2.3300"></a><span id="l2.3300">     EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.3301"></a><span id="l2.3301">     return NS_OK;</span>
<a href="#l2.3302"></a><span id="l2.3302">   }</span>
<a href="#l2.3303"></a><span id="l2.3303"> </span>
<a href="#l2.3304"></a><span id="l2.3304" class="difflineminus">-  if (mCopyState &amp;&amp; mCopyState-&gt;m_curCopyIndex &gt;= mCopyState-&gt;m_totalMsgCount)</span>
<a href="#l2.3305"></a><span id="l2.3305" class="difflineminus">-  {</span>
<a href="#l2.3306"></a><span id="l2.3306" class="difflineminus">-    //Notify that a completion finished.</span>
<a href="#l2.3307"></a><span id="l2.3307" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l2.3308"></a><span id="l2.3308" class="difflineplus">+  if (mCopyState &amp;&amp; mCopyState-&gt;m_curCopyIndex &gt;= mCopyState-&gt;m_totalMsgCount) {</span>
<a href="#l2.3309"></a><span id="l2.3309" class="difflineplus">+    // Notify that a completion finished.</span>
<a href="#l2.3310"></a><span id="l2.3310" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder =</span>
<a href="#l2.3311"></a><span id="l2.3311" class="difflineplus">+        do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l2.3312"></a><span id="l2.3312">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3313"></a><span id="l2.3313" class="difflineminus">-    nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localSrcFolder = do_QueryInterface(srcFolder);</span>
<a href="#l2.3314"></a><span id="l2.3314" class="difflineminus">-    if (localSrcFolder)</span>
<a href="#l2.3315"></a><span id="l2.3315" class="difflineminus">-    {</span>
<a href="#l2.3316"></a><span id="l2.3316" class="difflineminus">-      // if we are the trash and a local msg is being moved to us, mark the source</span>
<a href="#l2.3317"></a><span id="l2.3317" class="difflineminus">-      // for delete from server, if so configured.</span>
<a href="#l2.3318"></a><span id="l2.3318" class="difflineminus">-      if (mFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l2.3319"></a><span id="l2.3319" class="difflineminus">-      {</span>
<a href="#l2.3320"></a><span id="l2.3320" class="difflineminus">-        // if we're deleting on all moves, we'll mark this message for deletion when</span>
<a href="#l2.3321"></a><span id="l2.3321" class="difflineminus">-        // we call DeleteMessages on the source folder. So don't mark it for deletion</span>
<a href="#l2.3322"></a><span id="l2.3322" class="difflineminus">-        // here, in that case.</span>
<a href="#l2.3323"></a><span id="l2.3323" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localSrcFolder =</span>
<a href="#l2.3324"></a><span id="l2.3324" class="difflineplus">+        do_QueryInterface(srcFolder);</span>
<a href="#l2.3325"></a><span id="l2.3325" class="difflineplus">+    if (localSrcFolder) {</span>
<a href="#l2.3326"></a><span id="l2.3326" class="difflineplus">+      // if we are the trash and a local msg is being moved to us, mark the</span>
<a href="#l2.3327"></a><span id="l2.3327" class="difflineplus">+      // source for delete from server, if so configured.</span>
<a href="#l2.3328"></a><span id="l2.3328" class="difflineplus">+      if (mFlags &amp; nsMsgFolderFlags::Trash) {</span>
<a href="#l2.3329"></a><span id="l2.3329" class="difflineplus">+        // if we're deleting on all moves, we'll mark this message for deletion</span>
<a href="#l2.3330"></a><span id="l2.3330" class="difflineplus">+        // when we call DeleteMessages on the source folder. So don't mark it</span>
<a href="#l2.3331"></a><span id="l2.3331" class="difflineplus">+        // for deletion here, in that case.</span>
<a href="#l2.3332"></a><span id="l2.3332">         if (!GetDeleteFromServerOnMove())</span>
<a href="#l2.3333"></a><span id="l2.3333" class="difflineminus">-          localSrcFolder-&gt;MarkMsgsOnPop3Server(mCopyState-&gt;m_messages, POP3_DELETE);</span>
<a href="#l2.3334"></a><span id="l2.3334" class="difflineplus">+          localSrcFolder-&gt;MarkMsgsOnPop3Server(mCopyState-&gt;m_messages,</span>
<a href="#l2.3335"></a><span id="l2.3335" class="difflineplus">+                                               POP3_DELETE);</span>
<a href="#l2.3336"></a><span id="l2.3336">       }</span>
<a href="#l2.3337"></a><span id="l2.3337">     }</span>
<a href="#l2.3338"></a><span id="l2.3338">     // lets delete these all at once - much faster that way</span>
<a href="#l2.3339"></a><span id="l2.3339" class="difflineminus">-    rv = srcFolder-&gt;DeleteMessages(mCopyState-&gt;m_messages, mCopyState-&gt;m_msgWindow, true, true, nullptr, mCopyState-&gt;m_allowUndo);</span>
<a href="#l2.3340"></a><span id="l2.3340" class="difflineplus">+    rv = srcFolder-&gt;DeleteMessages(mCopyState-&gt;m_messages,</span>
<a href="#l2.3341"></a><span id="l2.3341" class="difflineplus">+                                   mCopyState-&gt;m_msgWindow, true, true, nullptr,</span>
<a href="#l2.3342"></a><span id="l2.3342" class="difflineplus">+                                   mCopyState-&gt;m_allowUndo);</span>
<a href="#l2.3343"></a><span id="l2.3343">     AutoCompact(mCopyState-&gt;m_msgWindow);</span>
<a href="#l2.3344"></a><span id="l2.3344"> </span>
<a href="#l2.3345"></a><span id="l2.3345">     // enable the dest folder</span>
<a href="#l2.3346"></a><span id="l2.3346">     EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l2.3347"></a><span id="l2.3347" class="difflineminus">-    // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l2.3348"></a><span id="l2.3348" class="difflineminus">-    // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l2.3349"></a><span id="l2.3349" class="difflineminus">-    // during the kDeleteOrMoveMsgCompleted call.</span>
<a href="#l2.3350"></a><span id="l2.3350" class="difflineminus">-    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted : kDeleteOrMoveMsgFailed);</span>
<a href="#l2.3351"></a><span id="l2.3351" class="difflineminus">-</span>
<a href="#l2.3352"></a><span id="l2.3352" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l2.3353"></a><span id="l2.3353" class="difflineminus">-    {</span>
<a href="#l2.3354"></a><span id="l2.3354" class="difflineplus">+    // I'm not too sure of the proper location of this event. It seems to need</span>
<a href="#l2.3355"></a><span id="l2.3355" class="difflineplus">+    // to be after the EnableNotifications, or the folder counts can be</span>
<a href="#l2.3356"></a><span id="l2.3356" class="difflineplus">+    // incorrect during the kDeleteOrMoveMsgCompleted call.</span>
<a href="#l2.3357"></a><span id="l2.3357" class="difflineplus">+    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? kDeleteOrMoveMsgCompleted</span>
<a href="#l2.3358"></a><span id="l2.3358" class="difflineplus">+                                                  : kDeleteOrMoveMsgFailed);</span>
<a href="#l2.3359"></a><span id="l2.3359" class="difflineplus">+</span>
<a href="#l2.3360"></a><span id="l2.3360" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_msgWindow &amp;&amp;</span>
<a href="#l2.3361"></a><span id="l2.3361" class="difflineplus">+        mCopyState-&gt;m_undoMsgTxn) {</span>
<a href="#l2.3362"></a><span id="l2.3362">       nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l2.3363"></a><span id="l2.3363">       mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l2.3364"></a><span id="l2.3364" class="difflineminus">-      if (txnMgr)</span>
<a href="#l2.3365"></a><span id="l2.3365" class="difflineminus">-        txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l2.3366"></a><span id="l2.3366" class="difflineplus">+      if (txnMgr) txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l2.3367"></a><span id="l2.3367">     }</span>
<a href="#l2.3368"></a><span id="l2.3368" class="difflineminus">-    (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, NS_SUCCEEDED(rv) ? true : false);  //clear the copy state so that the next message from a different folder can be move</span>
<a href="#l2.3369"></a><span id="l2.3369" class="difflineplus">+    (void)OnCopyCompleted(</span>
<a href="#l2.3370"></a><span id="l2.3370" class="difflineplus">+        mCopyState-&gt;m_srcSupport,</span>
<a href="#l2.3371"></a><span id="l2.3371" class="difflineplus">+        NS_SUCCEEDED(rv)</span>
<a href="#l2.3372"></a><span id="l2.3372" class="difflineplus">+            ? true</span>
<a href="#l2.3373"></a><span id="l2.3373" class="difflineplus">+            : false);  // clear the copy state so that the next message from a</span>
<a href="#l2.3374"></a><span id="l2.3374" class="difflineplus">+                       // different folder can be move</span>
<a href="#l2.3375"></a><span id="l2.3375">   }</span>
<a href="#l2.3376"></a><span id="l2.3376"> </span>
<a href="#l2.3377"></a><span id="l2.3377">   return NS_OK;</span>
<a href="#l2.3378"></a><span id="l2.3378" class="difflineminus">-</span>
<a href="#l2.3379"></a><span id="l2.3379"> }</span>
<a href="#l2.3380"></a><span id="l2.3380"> </span>
<a href="#l2.3381"></a><span id="l2.3381"> // this is the beginning of the next message copied</span>
<a href="#l2.3382"></a><span id="l2.3382" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::StartMessage()</span>
<a href="#l2.3383"></a><span id="l2.3383" class="difflineminus">-{</span>
<a href="#l2.3384"></a><span id="l2.3384" class="difflineminus">-  // We get crashes that we don't understand (bug 284876), so stupidly prevent that.</span>
<a href="#l2.3385"></a><span id="l2.3385" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::StartMessage() {</span>
<a href="#l2.3386"></a><span id="l2.3386" class="difflineplus">+  // We get crashes that we don't understand (bug 284876), so stupidly prevent</span>
<a href="#l2.3387"></a><span id="l2.3387" class="difflineplus">+  // that.</span>
<a href="#l2.3388"></a><span id="l2.3388">   NS_ENSURE_ARG_POINTER(mCopyState);</span>
<a href="#l2.3389"></a><span id="l2.3389">   nsresult rv = InitCopyMsgHdrAndFileStream();</span>
<a href="#l2.3390"></a><span id="l2.3390">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3391"></a><span id="l2.3391">   return WriteStartOfNewMessage();</span>
<a href="#l2.3392"></a><span id="l2.3392"> }</span>
<a href="#l2.3393"></a><span id="l2.3393"> </span>
<a href="#l2.3394"></a><span id="l2.3394"> // just finished the current message.</span>
<a href="#l2.3395"></a><span id="l2.3395" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::EndMessage(nsMsgKey key)</span>
<a href="#l2.3396"></a><span id="l2.3396" class="difflineminus">-{</span>
<a href="#l2.3397"></a><span id="l2.3397" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::EndMessage(nsMsgKey key) {</span>
<a href="#l2.3398"></a><span id="l2.3398">   NS_ENSURE_ARG_POINTER(mCopyState);</span>
<a href="#l2.3399"></a><span id="l2.3399"> </span>
<a href="#l2.3400"></a><span id="l2.3400">   RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; localUndoTxn = mCopyState-&gt;m_undoMsgTxn;</span>
<a href="#l2.3401"></a><span id="l2.3401">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l2.3402"></a><span id="l2.3402">   nsresult rv;</span>
<a href="#l2.3403"></a><span id="l2.3403"> </span>
<a href="#l2.3404"></a><span id="l2.3404" class="difflineminus">-  if (localUndoTxn)</span>
<a href="#l2.3405"></a><span id="l2.3405" class="difflineminus">-  {</span>
<a href="#l2.3406"></a><span id="l2.3406" class="difflineplus">+  if (localUndoTxn) {</span>
<a href="#l2.3407"></a><span id="l2.3407">     localUndoTxn-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l2.3408"></a><span id="l2.3408">     localUndoTxn-&gt;AddSrcKey(key);</span>
<a href="#l2.3409"></a><span id="l2.3409">     localUndoTxn-&gt;AddDstKey(mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.3410"></a><span id="l2.3410">   }</span>
<a href="#l2.3411"></a><span id="l2.3411"> </span>
<a href="#l2.3412"></a><span id="l2.3412">   // I think this is always true for online to offline copy</span>
<a href="#l2.3413"></a><span id="l2.3413">   mCopyState-&gt;m_dummyEnvelopeNeeded = true;</span>
<a href="#l2.3414"></a><span id="l2.3414" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l2.3415"></a><span id="l2.3415" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l2.3416"></a><span id="l2.3416" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l2.3417"></a><span id="l2.3417">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3418"></a><span id="l2.3418">   seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l2.3419"></a><span id="l2.3419">   rv = FinishNewLocalMessage(mCopyState-&gt;m_fileStream, mCopyState-&gt;m_newHdr,</span>
<a href="#l2.3420"></a><span id="l2.3420">                              mCopyState-&gt;m_msgStore,</span>
<a href="#l2.3421"></a><span id="l2.3421">                              mCopyState-&gt;m_parseMsgState);</span>
<a href="#l2.3422"></a><span id="l2.3422">   mCopyState-&gt;m_fileStream-&gt;Close();</span>
<a href="#l2.3423"></a><span id="l2.3423" class="difflineminus">-  mCopyState-&gt;m_fileStream = nullptr; // all done with the file stream</span>
<a href="#l2.3424"></a><span id="l2.3424" class="difflineplus">+  mCopyState-&gt;m_fileStream = nullptr;  // all done with the file stream</span>
<a href="#l2.3425"></a><span id="l2.3425"> </span>
<a href="#l2.3426"></a><span id="l2.3426">   // CopyFileMessage() and CopyMessages() from servers other than mailbox</span>
<a href="#l2.3427"></a><span id="l2.3427" class="difflineminus">-  if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l2.3428"></a><span id="l2.3428" class="difflineminus">-  {</span>
<a href="#l2.3429"></a><span id="l2.3429" class="difflineplus">+  if (mCopyState-&gt;m_parseMsgState) {</span>
<a href="#l2.3430"></a><span id="l2.3430">     nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l2.3431"></a><span id="l2.3431">     nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l2.3432"></a><span id="l2.3432"> </span>
<a href="#l2.3433"></a><span id="l2.3433">     mCopyState-&gt;m_parseMsgState-&gt;FinishHeader();</span>
<a href="#l2.3434"></a><span id="l2.3434"> </span>
<a href="#l2.3435"></a><span id="l2.3435">     rv = mCopyState-&gt;m_parseMsgState-&gt;GetNewMsgHdr(getter_AddRefs(newHdr));</span>
<a href="#l2.3436"></a><span id="l2.3436" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; newHdr)</span>
<a href="#l2.3437"></a><span id="l2.3437" class="difflineminus">-    {</span>
<a href="#l2.3438"></a><span id="l2.3438" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l2.3439"></a><span id="l2.3439" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; newHdr) {</span>
<a href="#l2.3440"></a><span id="l2.3440" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder =</span>
<a href="#l2.3441"></a><span id="l2.3441" class="difflineplus">+          do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l2.3442"></a><span id="l2.3442">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3443"></a><span id="l2.3443">       nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l2.3444"></a><span id="l2.3444">       srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l2.3445"></a><span id="l2.3445" class="difflineminus">-      if (srcDB)</span>
<a href="#l2.3446"></a><span id="l2.3446" class="difflineminus">-      {</span>
<a href="#l2.3447"></a><span id="l2.3447" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; srcMsgHdr;</span>
<a href="#l2.3448"></a><span id="l2.3448" class="difflineplus">+      if (srcDB) {</span>
<a href="#l2.3449"></a><span id="l2.3449" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; srcMsgHdr;</span>
<a href="#l2.3450"></a><span id="l2.3450">         srcDB-&gt;GetMsgHdrForKey(key, getter_AddRefs(srcMsgHdr));</span>
<a href="#l2.3451"></a><span id="l2.3451">         if (srcMsgHdr)</span>
<a href="#l2.3452"></a><span id="l2.3452">           CopyPropertiesToMsgHdr(newHdr, srcMsgHdr, mCopyState-&gt;m_isMove);</span>
<a href="#l2.3453"></a><span id="l2.3453">       }</span>
<a href="#l2.3454"></a><span id="l2.3454">       rv = GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l2.3455"></a><span id="l2.3455" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; msgDb)</span>
<a href="#l2.3456"></a><span id="l2.3456" class="difflineminus">-      {</span>
<a href="#l2.3457"></a><span id="l2.3457" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; msgDb) {</span>
<a href="#l2.3458"></a><span id="l2.3458">         msgDb-&gt;AddNewHdrToDB(newHdr, true);</span>
<a href="#l2.3459"></a><span id="l2.3459" class="difflineminus">-        if (localUndoTxn)</span>
<a href="#l2.3460"></a><span id="l2.3460" class="difflineminus">-        {</span>
<a href="#l2.3461"></a><span id="l2.3461" class="difflineplus">+        if (localUndoTxn) {</span>
<a href="#l2.3462"></a><span id="l2.3462">           // ** jt - recording the message size for possible undo use; the</span>
<a href="#l2.3463"></a><span id="l2.3463">           // message size is different for pop3 and imap4 messages</span>
<a href="#l2.3464"></a><span id="l2.3464">           uint32_t msgSize;</span>
<a href="#l2.3465"></a><span id="l2.3465">           newHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l2.3466"></a><span id="l2.3466">           localUndoTxn-&gt;AddDstMsgSize(msgSize);</span>
<a href="#l2.3467"></a><span id="l2.3467">         }</span>
<a href="#l2.3468"></a><span id="l2.3468" class="difflineminus">-      }</span>
<a href="#l2.3469"></a><span id="l2.3469" class="difflineminus">-      else</span>
<a href="#l2.3470"></a><span id="l2.3470" class="difflineminus">-        mCopyState-&gt;m_undoMsgTxn = nullptr; //null out the transaction because we can't undo w/o the msg db</span>
<a href="#l2.3471"></a><span id="l2.3471" class="difflineplus">+      } else</span>
<a href="#l2.3472"></a><span id="l2.3472" class="difflineplus">+        mCopyState-&gt;m_undoMsgTxn = nullptr;  // null out the transaction because</span>
<a href="#l2.3473"></a><span id="l2.3473" class="difflineplus">+                                             // we can't undo w/o the msg db</span>
<a href="#l2.3474"></a><span id="l2.3474">     }</span>
<a href="#l2.3475"></a><span id="l2.3475">     mCopyState-&gt;m_parseMsgState-&gt;Clear();</span>
<a href="#l2.3476"></a><span id="l2.3476"> </span>
<a href="#l2.3477"></a><span id="l2.3477" class="difflineminus">-    if (mCopyState-&gt;m_listener) // CopyFileMessage() only</span>
<a href="#l2.3478"></a><span id="l2.3478" class="difflineplus">+    if (mCopyState-&gt;m_listener)  // CopyFileMessage() only</span>
<a href="#l2.3479"></a><span id="l2.3479">       mCopyState-&gt;m_listener-&gt;SetMessageKey(mCopyState-&gt;m_curDstKey);</span>
<a href="#l2.3480"></a><span id="l2.3480">   }</span>
<a href="#l2.3481"></a><span id="l2.3481"> </span>
<a href="#l2.3482"></a><span id="l2.3482" class="difflineminus">-  if (mCopyState-&gt;m_fileStream)</span>
<a href="#l2.3483"></a><span id="l2.3483" class="difflineminus">-    mCopyState-&gt;m_fileStream-&gt;Flush();</span>
<a href="#l2.3484"></a><span id="l2.3484" class="difflineplus">+  if (mCopyState-&gt;m_fileStream) mCopyState-&gt;m_fileStream-&gt;Flush();</span>
<a href="#l2.3485"></a><span id="l2.3485">   return NS_OK;</span>
<a href="#l2.3486"></a><span id="l2.3486"> }</span>
<a href="#l2.3487"></a><span id="l2.3487"> </span>
<a href="#l2.3488"></a><span id="l2.3488" class="difflineminus">-</span>
<a href="#l2.3489"></a><span id="l2.3489" class="difflineminus">-nsresult nsMsgLocalMailFolder::CopyMessagesTo(nsIArray *messages, nsTArray&lt;nsMsgKey&gt; &amp;keyArray,</span>
<a href="#l2.3490"></a><span id="l2.3490" class="difflineminus">-                                             nsIMsgWindow *aMsgWindow, nsIMsgFolder *dstFolder,</span>
<a href="#l2.3491"></a><span id="l2.3491" class="difflineminus">-                                             bool isMove)</span>
<a href="#l2.3492"></a><span id="l2.3492" class="difflineminus">-{</span>
<a href="#l2.3493"></a><span id="l2.3493" class="difflineminus">-  if (!mCopyState)</span>
<a href="#l2.3494"></a><span id="l2.3494" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.3495"></a><span id="l2.3495" class="difflineplus">+nsresult nsMsgLocalMailFolder::CopyMessagesTo(nsIArray *messages,</span>
<a href="#l2.3496"></a><span id="l2.3496" class="difflineplus">+                                              nsTArray&lt;nsMsgKey&gt; &amp;keyArray,</span>
<a href="#l2.3497"></a><span id="l2.3497" class="difflineplus">+                                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.3498"></a><span id="l2.3498" class="difflineplus">+                                              nsIMsgFolder *dstFolder,</span>
<a href="#l2.3499"></a><span id="l2.3499" class="difflineplus">+                                              bool isMove) {</span>
<a href="#l2.3500"></a><span id="l2.3500" class="difflineplus">+  if (!mCopyState) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.3501"></a><span id="l2.3501"> </span>
<a href="#l2.3502"></a><span id="l2.3502">   nsresult rv;</span>
<a href="#l2.3503"></a><span id="l2.3503"> </span>
<a href="#l2.3504"></a><span id="l2.3504" class="difflineminus">-  nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener = do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3505"></a><span id="l2.3505" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.3506"></a><span id="l2.3506" class="difflineminus">-</span>
<a href="#l2.3507"></a><span id="l2.3507" class="difflineminus">-  nsCOMPtr&lt;nsICopyMessageListener&gt; copyListener(do_QueryInterface(dstFolder, &amp;rv));</span>
<a href="#l2.3508"></a><span id="l2.3508" class="difflineplus">+  nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener =</span>
<a href="#l2.3509"></a><span id="l2.3509" class="difflineplus">+      do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3510"></a><span id="l2.3510" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3511"></a><span id="l2.3511" class="difflineplus">+</span>
<a href="#l2.3512"></a><span id="l2.3512" class="difflineplus">+  nsCOMPtr&lt;nsICopyMessageListener&gt; copyListener(</span>
<a href="#l2.3513"></a><span id="l2.3513" class="difflineplus">+      do_QueryInterface(dstFolder, &amp;rv));</span>
<a href="#l2.3514"></a><span id="l2.3514">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3515"></a><span id="l2.3515"> </span>
<a href="#l2.3516"></a><span id="l2.3516" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l2.3517"></a><span id="l2.3517" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(</span>
<a href="#l2.3518"></a><span id="l2.3518" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l2.3519"></a><span id="l2.3519">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3520"></a><span id="l2.3520"> </span>
<a href="#l2.3521"></a><span id="l2.3521">   rv = copyStreamListener-&gt;Init(srcFolder, copyListener, nullptr);</span>
<a href="#l2.3522"></a><span id="l2.3522" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3523"></a><span id="l2.3523" class="difflineminus">-    return rv;</span>
<a href="#l2.3524"></a><span id="l2.3524" class="difflineminus">-</span>
<a href="#l2.3525"></a><span id="l2.3525" class="difflineminus">-  if (!mCopyState-&gt;m_messageService)</span>
<a href="#l2.3526"></a><span id="l2.3526" class="difflineminus">-  {</span>
<a href="#l2.3527"></a><span id="l2.3527" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.3528"></a><span id="l2.3528" class="difflineplus">+</span>
<a href="#l2.3529"></a><span id="l2.3529" class="difflineplus">+  if (!mCopyState-&gt;m_messageService) {</span>
<a href="#l2.3530"></a><span id="l2.3530">     nsCString uri;</span>
<a href="#l2.3531"></a><span id="l2.3531">     srcFolder-&gt;GetURI(uri);</span>
<a href="#l2.3532"></a><span id="l2.3532" class="difflineminus">-    rv = GetMessageServiceFromURI(uri, getter_AddRefs(mCopyState-&gt;m_messageService));</span>
<a href="#l2.3533"></a><span id="l2.3533" class="difflineplus">+    rv = GetMessageServiceFromURI(uri,</span>
<a href="#l2.3534"></a><span id="l2.3534" class="difflineplus">+                                  getter_AddRefs(mCopyState-&gt;m_messageService));</span>
<a href="#l2.3535"></a><span id="l2.3535">   }</span>
<a href="#l2.3536"></a><span id="l2.3536"> </span>
<a href="#l2.3537"></a><span id="l2.3537" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_messageService)</span>
<a href="#l2.3538"></a><span id="l2.3538" class="difflineminus">-  {</span>
<a href="#l2.3539"></a><span id="l2.3539" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; streamListener(do_QueryInterface(copyStreamListener, &amp;rv));</span>
<a href="#l2.3540"></a><span id="l2.3540" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_messageService) {</span>
<a href="#l2.3541"></a><span id="l2.3541" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; streamListener(</span>
<a href="#l2.3542"></a><span id="l2.3542" class="difflineplus">+        do_QueryInterface(copyStreamListener, &amp;rv));</span>
<a href="#l2.3543"></a><span id="l2.3543">     NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3544"></a><span id="l2.3544"> </span>
<a href="#l2.3545"></a><span id="l2.3545">     mCopyState-&gt;m_curCopyIndex = 0;</span>
<a href="#l2.3546"></a><span id="l2.3546">     // we need to kick off the first message - subsequent messages</span>
<a href="#l2.3547"></a><span id="l2.3547">     // are kicked off by nsMailboxProtocol when it finishes a message</span>
<a href="#l2.3548"></a><span id="l2.3548">     // before starting the next message. Only do this if the source folder</span>
<a href="#l2.3549"></a><span id="l2.3549">     // is a local folder, however. IMAP will handle calling StartMessage for</span>
<a href="#l2.3550"></a><span id="l2.3550">     // each message that gets downloaded, and news doesn't go through here</span>
<a href="#l2.3551"></a><span id="l2.3551">     // because news only downloads one message at a time, and this routine</span>
<a href="#l2.3552"></a><span id="l2.3552">     // is for multiple message copy.</span>
<a href="#l2.3553"></a><span id="l2.3553" class="difflineminus">-    nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; srcLocalFolder = do_QueryInterface(srcFolder);</span>
<a href="#l2.3554"></a><span id="l2.3554" class="difflineminus">-    if (srcLocalFolder)</span>
<a href="#l2.3555"></a><span id="l2.3555" class="difflineminus">-      StartMessage();</span>
<a href="#l2.3556"></a><span id="l2.3556" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; srcLocalFolder =</span>
<a href="#l2.3557"></a><span id="l2.3557" class="difflineplus">+        do_QueryInterface(srcFolder);</span>
<a href="#l2.3558"></a><span id="l2.3558" class="difflineplus">+    if (srcLocalFolder) StartMessage();</span>
<a href="#l2.3559"></a><span id="l2.3559">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l2.3560"></a><span id="l2.3560" class="difflineminus">-    rv = mCopyState-&gt;m_messageService-&gt;CopyMessages(keyArray.Length(),</span>
<a href="#l2.3561"></a><span id="l2.3561" class="difflineminus">-                                                    keyArray.Elements(),</span>
<a href="#l2.3562"></a><span id="l2.3562" class="difflineminus">-                                                    srcFolder, streamListener,</span>
<a href="#l2.3563"></a><span id="l2.3563" class="difflineminus">-                                                    isMove, nullptr, aMsgWindow,</span>
<a href="#l2.3564"></a><span id="l2.3564" class="difflineminus">-                                                    getter_AddRefs(dummyNull));</span>
<a href="#l2.3565"></a><span id="l2.3565" class="difflineplus">+    rv = mCopyState-&gt;m_messageService-&gt;CopyMessages(</span>
<a href="#l2.3566"></a><span id="l2.3566" class="difflineplus">+        keyArray.Length(), keyArray.Elements(), srcFolder, streamListener,</span>
<a href="#l2.3567"></a><span id="l2.3567" class="difflineplus">+        isMove, nullptr, aMsgWindow, getter_AddRefs(dummyNull));</span>
<a href="#l2.3568"></a><span id="l2.3568">   }</span>
<a href="#l2.3569"></a><span id="l2.3569">   return rv;</span>
<a href="#l2.3570"></a><span id="l2.3570"> }</span>
<a href="#l2.3571"></a><span id="l2.3571"> </span>
<a href="#l2.3572"></a><span id="l2.3572" class="difflineminus">-nsresult nsMsgLocalMailFolder::CopyMessageTo(nsISupports *message,</span>
<a href="#l2.3573"></a><span id="l2.3573" class="difflineminus">-                                             nsIMsgFolder *dstFolder /* dst same as &quot;this&quot; */,</span>
<a href="#l2.3574"></a><span id="l2.3574" class="difflineminus">-                                             nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.3575"></a><span id="l2.3575" class="difflineminus">-                                             bool isMove)</span>
<a href="#l2.3576"></a><span id="l2.3576" class="difflineminus">-{</span>
<a href="#l2.3577"></a><span id="l2.3577" class="difflineminus">-  if (!mCopyState)</span>
<a href="#l2.3578"></a><span id="l2.3578" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.3579"></a><span id="l2.3579" class="difflineplus">+nsresult nsMsgLocalMailFolder::CopyMessageTo(</span>
<a href="#l2.3580"></a><span id="l2.3580" class="difflineplus">+    nsISupports *message, nsIMsgFolder *dstFolder /* dst same as &quot;this&quot; */,</span>
<a href="#l2.3581"></a><span id="l2.3581" class="difflineplus">+    nsIMsgWindow *aMsgWindow, bool isMove) {</span>
<a href="#l2.3582"></a><span id="l2.3582" class="difflineplus">+  if (!mCopyState) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.3583"></a><span id="l2.3583"> </span>
<a href="#l2.3584"></a><span id="l2.3584">   nsresult rv;</span>
<a href="#l2.3585"></a><span id="l2.3585">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryInterface(message, &amp;rv));</span>
<a href="#l2.3586"></a><span id="l2.3586">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3587"></a><span id="l2.3587"> </span>
<a href="#l2.3588"></a><span id="l2.3588">   mCopyState-&gt;m_message = msgHdr;</span>
<a href="#l2.3589"></a><span id="l2.3589"> </span>
<a href="#l2.3590"></a><span id="l2.3590" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l2.3591"></a><span id="l2.3591" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(</span>
<a href="#l2.3592"></a><span id="l2.3592" class="difflineplus">+      do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l2.3593"></a><span id="l2.3593">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3594"></a><span id="l2.3594">   nsCString uri;</span>
<a href="#l2.3595"></a><span id="l2.3595">   srcFolder-&gt;GetUriForMsg(msgHdr, uri);</span>
<a href="#l2.3596"></a><span id="l2.3596"> </span>
<a href="#l2.3597"></a><span id="l2.3597" class="difflineminus">-  nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener = do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3598"></a><span id="l2.3598" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.3599"></a><span id="l2.3599" class="difflineminus">-</span>
<a href="#l2.3600"></a><span id="l2.3600" class="difflineminus">-  nsCOMPtr&lt;nsICopyMessageListener&gt; copyListener(do_QueryInterface(dstFolder, &amp;rv));</span>
<a href="#l2.3601"></a><span id="l2.3601" class="difflineplus">+  nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener =</span>
<a href="#l2.3602"></a><span id="l2.3602" class="difflineplus">+      do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3603"></a><span id="l2.3603" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3604"></a><span id="l2.3604" class="difflineplus">+</span>
<a href="#l2.3605"></a><span id="l2.3605" class="difflineplus">+  nsCOMPtr&lt;nsICopyMessageListener&gt; copyListener(</span>
<a href="#l2.3606"></a><span id="l2.3606" class="difflineplus">+      do_QueryInterface(dstFolder, &amp;rv));</span>
<a href="#l2.3607"></a><span id="l2.3607">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3608"></a><span id="l2.3608"> </span>
<a href="#l2.3609"></a><span id="l2.3609">   rv = copyStreamListener-&gt;Init(srcFolder, copyListener, nullptr);</span>
<a href="#l2.3610"></a><span id="l2.3610" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l2.3611"></a><span id="l2.3611" class="difflineminus">-    return rv;</span>
<a href="#l2.3612"></a><span id="l2.3612" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.3613"></a><span id="l2.3613"> </span>
<a href="#l2.3614"></a><span id="l2.3614">   if (!mCopyState-&gt;m_messageService)</span>
<a href="#l2.3615"></a><span id="l2.3615" class="difflineminus">-    rv = GetMessageServiceFromURI(uri, getter_AddRefs(mCopyState-&gt;m_messageService));</span>
<a href="#l2.3616"></a><span id="l2.3616" class="difflineminus">-</span>
<a href="#l2.3617"></a><span id="l2.3617" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_messageService)</span>
<a href="#l2.3618"></a><span id="l2.3618" class="difflineminus">-  {</span>
<a href="#l2.3619"></a><span id="l2.3619" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; streamListener(do_QueryInterface(copyStreamListener, &amp;rv));</span>
<a href="#l2.3620"></a><span id="l2.3620" class="difflineplus">+    rv = GetMessageServiceFromURI(uri,</span>
<a href="#l2.3621"></a><span id="l2.3621" class="difflineplus">+                                  getter_AddRefs(mCopyState-&gt;m_messageService));</span>
<a href="#l2.3622"></a><span id="l2.3622" class="difflineplus">+</span>
<a href="#l2.3623"></a><span id="l2.3623" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_messageService) {</span>
<a href="#l2.3624"></a><span id="l2.3624" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; streamListener(</span>
<a href="#l2.3625"></a><span id="l2.3625" class="difflineplus">+        do_QueryInterface(copyStreamListener, &amp;rv));</span>
<a href="#l2.3626"></a><span id="l2.3626">     NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l2.3627"></a><span id="l2.3627">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l2.3628"></a><span id="l2.3628" class="difflineminus">-    rv = mCopyState-&gt;m_messageService-&gt;CopyMessage(uri.get(), streamListener, isMove, nullptr, aMsgWindow,</span>
<a href="#l2.3629"></a><span id="l2.3629" class="difflineplus">+    rv = mCopyState-&gt;m_messageService-&gt;CopyMessage(uri.get(), streamListener,</span>
<a href="#l2.3630"></a><span id="l2.3630" class="difflineplus">+                                                   isMove, nullptr, aMsgWindow,</span>
<a href="#l2.3631"></a><span id="l2.3631">                                                    getter_AddRefs(dummyNull));</span>
<a href="#l2.3632"></a><span id="l2.3632">   }</span>
<a href="#l2.3633"></a><span id="l2.3633">   return rv;</span>
<a href="#l2.3634"></a><span id="l2.3634"> }</span>
<a href="#l2.3635"></a><span id="l2.3635"> </span>
<a href="#l2.3636"></a><span id="l2.3636" class="difflineminus">-// A message is being deleted from a POP3 mail file, so check and see if we have the message</span>
<a href="#l2.3637"></a><span id="l2.3637" class="difflineminus">-// being deleted in the server. If so, then we need to remove the message from the server as well.</span>
<a href="#l2.3638"></a><span id="l2.3638" class="difflineminus">-// We have saved the UIDL of the message in the popstate.dat file and we must match this uidl, so</span>
<a href="#l2.3639"></a><span id="l2.3639" class="difflineminus">-// read the message headers and see if we have it, then mark the message for deletion from the server.</span>
<a href="#l2.3640"></a><span id="l2.3640" class="difflineplus">+// A message is being deleted from a POP3 mail file, so check and see if we have</span>
<a href="#l2.3641"></a><span id="l2.3641" class="difflineplus">+// the message being deleted in the server. If so, then we need to remove the</span>
<a href="#l2.3642"></a><span id="l2.3642" class="difflineplus">+// message from the server as well. We have saved the UIDL of the message in the</span>
<a href="#l2.3643"></a><span id="l2.3643" class="difflineplus">+// popstate.dat file and we must match this uidl, so read the message headers</span>
<a href="#l2.3644"></a><span id="l2.3644" class="difflineplus">+// and see if we have it, then mark the message for deletion from the server.</span>
<a href="#l2.3645"></a><span id="l2.3645"> // The next time we look at mail the message will be deleted from the server.</span>
<a href="#l2.3646"></a><span id="l2.3646"> </span>
<a href="#l2.3647"></a><span id="l2.3647"> NS_IMETHODIMP</span>
<a href="#l2.3648"></a><span id="l2.3648" class="difflineminus">-nsMsgLocalMailFolder::MarkMsgsOnPop3Server(nsIArray *aMessages, int32_t aMark)</span>
<a href="#l2.3649"></a><span id="l2.3649" class="difflineminus">-{</span>
<a href="#l2.3650"></a><span id="l2.3650" class="difflineplus">+nsMsgLocalMailFolder::MarkMsgsOnPop3Server(nsIArray *aMessages, int32_t aMark) {</span>
<a href="#l2.3651"></a><span id="l2.3651">   nsLocalFolderScanState folderScanState;</span>
<a href="#l2.3652"></a><span id="l2.3652">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; curFolderPop3MailServer;</span>
<a href="#l2.3653"></a><span id="l2.3653" class="difflineminus">-  nsCOMArray&lt;nsIPop3IncomingServer&gt; pop3Servers; // servers with msgs deleted...</span>
<a href="#l2.3654"></a><span id="l2.3654" class="difflineplus">+  nsCOMArray&lt;nsIPop3IncomingServer&gt;</span>
<a href="#l2.3655"></a><span id="l2.3655" class="difflineplus">+      pop3Servers;  // servers with msgs deleted...</span>
<a href="#l2.3656"></a><span id="l2.3656"> </span>
<a href="#l2.3657"></a><span id="l2.3657">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l2.3658"></a><span id="l2.3658">   nsresult rv = GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l2.3659"></a><span id="l2.3659">   NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.3660"></a><span id="l2.3660"> </span>
<a href="#l2.3661"></a><span id="l2.3661" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3662"></a><span id="l2.3662" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.3663"></a><span id="l2.3663" class="difflineminus">-</span>
<a href="#l2.3664"></a><span id="l2.3664" class="difflineminus">-  // I wonder if we should run through the pop3 accounts and see if any of them have</span>
<a href="#l2.3665"></a><span id="l2.3665" class="difflineminus">-  // leave on server set. If not, we could short-circuit some of this.</span>
<a href="#l2.3666"></a><span id="l2.3666" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l2.3667"></a><span id="l2.3667" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3668"></a><span id="l2.3668" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3669"></a><span id="l2.3669" class="difflineplus">+</span>
<a href="#l2.3670"></a><span id="l2.3670" class="difflineplus">+  // I wonder if we should run through the pop3 accounts and see if any of them</span>
<a href="#l2.3671"></a><span id="l2.3671" class="difflineplus">+  // have leave on server set. If not, we could short-circuit some of this.</span>
<a href="#l2.3672"></a><span id="l2.3672"> </span>
<a href="#l2.3673"></a><span id="l2.3673">   curFolderPop3MailServer = do_QueryInterface(incomingServer, &amp;rv);</span>
<a href="#l2.3674"></a><span id="l2.3674">   rv = GetFolderScanState(&amp;folderScanState);</span>
<a href="#l2.3675"></a><span id="l2.3675" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.3676"></a><span id="l2.3676" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3677"></a><span id="l2.3677"> </span>
<a href="#l2.3678"></a><span id="l2.3678">   uint32_t srcCount;</span>
<a href="#l2.3679"></a><span id="l2.3679">   aMessages-&gt;GetLength(&amp;srcCount);</span>
<a href="#l2.3680"></a><span id="l2.3680"> </span>
<a href="#l2.3681"></a><span id="l2.3681">   // Filter delete requests are always honored, others are subject</span>
<a href="#l2.3682"></a><span id="l2.3682">   // to the deleteMailLeftOnServer preference.</span>
<a href="#l2.3683"></a><span id="l2.3683">   int32_t mark;</span>
<a href="#l2.3684"></a><span id="l2.3684">   mark = (aMark == POP3_FORCE_DEL) ? POP3_DELETE : aMark;</span>
<a href="#l2.3685"></a><span id="l2.3685"> </span>
<a href="#l2.3686"></a><span id="l2.3686" class="difflineminus">-  for (uint32_t i = 0; i &lt; srcCount; i++)</span>
<a href="#l2.3687"></a><span id="l2.3687" class="difflineminus">-  {</span>
<a href="#l2.3688"></a><span id="l2.3688" class="difflineplus">+  for (uint32_t i = 0; i &lt; srcCount; i++) {</span>
<a href="#l2.3689"></a><span id="l2.3689">     /* get uidl for this message */</span>
<a href="#l2.3690"></a><span id="l2.3690" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr (do_QueryElementAt(aMessages, i, &amp;rv));</span>
<a href="#l2.3691"></a><span id="l2.3691" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryElementAt(aMessages, i, &amp;rv));</span>
<a href="#l2.3692"></a><span id="l2.3692"> </span>
<a href="#l2.3693"></a><span id="l2.3693">     uint32_t flags = 0;</span>
<a href="#l2.3694"></a><span id="l2.3694"> </span>
<a href="#l2.3695"></a><span id="l2.3695" class="difflineminus">-    if (msgDBHdr)</span>
<a href="#l2.3696"></a><span id="l2.3696" class="difflineminus">-    {</span>
<a href="#l2.3697"></a><span id="l2.3697" class="difflineplus">+    if (msgDBHdr) {</span>
<a href="#l2.3698"></a><span id="l2.3698">       msgDBHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l2.3699"></a><span id="l2.3699" class="difflineminus">-      nsCOMPtr &lt;nsIPop3IncomingServer&gt; msgPop3Server = curFolderPop3MailServer;</span>
<a href="#l2.3700"></a><span id="l2.3700" class="difflineplus">+      nsCOMPtr&lt;nsIPop3IncomingServer&gt; msgPop3Server = curFolderPop3MailServer;</span>
<a href="#l2.3701"></a><span id="l2.3701">       bool leaveOnServer = false;</span>
<a href="#l2.3702"></a><span id="l2.3702">       bool deleteMailLeftOnServer = false;</span>
<a href="#l2.3703"></a><span id="l2.3703">       // set up defaults, in case there's no x-mozilla-account header</span>
<a href="#l2.3704"></a><span id="l2.3704" class="difflineminus">-      if (curFolderPop3MailServer)</span>
<a href="#l2.3705"></a><span id="l2.3705" class="difflineminus">-      {</span>
<a href="#l2.3706"></a><span id="l2.3706" class="difflineminus">-        curFolderPop3MailServer-&gt;GetDeleteMailLeftOnServer(&amp;deleteMailLeftOnServer);</span>
<a href="#l2.3707"></a><span id="l2.3707" class="difflineplus">+      if (curFolderPop3MailServer) {</span>
<a href="#l2.3708"></a><span id="l2.3708" class="difflineplus">+        curFolderPop3MailServer-&gt;GetDeleteMailLeftOnServer(</span>
<a href="#l2.3709"></a><span id="l2.3709" class="difflineplus">+            &amp;deleteMailLeftOnServer);</span>
<a href="#l2.3710"></a><span id="l2.3710">         curFolderPop3MailServer-&gt;GetLeaveMessagesOnServer(&amp;leaveOnServer);</span>
<a href="#l2.3711"></a><span id="l2.3711">       }</span>
<a href="#l2.3712"></a><span id="l2.3712"> </span>
<a href="#l2.3713"></a><span id="l2.3713">       rv = GetUidlFromFolder(&amp;folderScanState, msgDBHdr);</span>
<a href="#l2.3714"></a><span id="l2.3714" class="difflineminus">-      if (!NS_SUCCEEDED(rv))</span>
<a href="#l2.3715"></a><span id="l2.3715" class="difflineminus">-        continue;</span>
<a href="#l2.3716"></a><span id="l2.3716" class="difflineminus">-</span>
<a href="#l2.3717"></a><span id="l2.3717" class="difflineminus">-      if (folderScanState.m_uidl)</span>
<a href="#l2.3718"></a><span id="l2.3718" class="difflineminus">-      {</span>
<a href="#l2.3719"></a><span id="l2.3719" class="difflineminus">-        nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l2.3720"></a><span id="l2.3720" class="difflineminus">-        rv = accountManager-&gt;GetAccount(folderScanState.m_accountKey, getter_AddRefs(account));</span>
<a href="#l2.3721"></a><span id="l2.3721" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; account)</span>
<a href="#l2.3722"></a><span id="l2.3722" class="difflineminus">-        {</span>
<a href="#l2.3723"></a><span id="l2.3723" class="difflineplus">+      if (!NS_SUCCEEDED(rv)) continue;</span>
<a href="#l2.3724"></a><span id="l2.3724" class="difflineplus">+</span>
<a href="#l2.3725"></a><span id="l2.3725" class="difflineplus">+      if (folderScanState.m_uidl) {</span>
<a href="#l2.3726"></a><span id="l2.3726" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l2.3727"></a><span id="l2.3727" class="difflineplus">+        rv = accountManager-&gt;GetAccount(folderScanState.m_accountKey,</span>
<a href="#l2.3728"></a><span id="l2.3728" class="difflineplus">+                                        getter_AddRefs(account));</span>
<a href="#l2.3729"></a><span id="l2.3729" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l2.3730"></a><span id="l2.3730">           account-&gt;GetIncomingServer(getter_AddRefs(incomingServer));</span>
<a href="#l2.3731"></a><span id="l2.3731" class="difflineminus">-          nsCOMPtr&lt;nsIPop3IncomingServer&gt; curMsgPop3MailServer = do_QueryInterface(incomingServer);</span>
<a href="#l2.3732"></a><span id="l2.3732" class="difflineminus">-          if (curMsgPop3MailServer)</span>
<a href="#l2.3733"></a><span id="l2.3733" class="difflineminus">-          {</span>
<a href="#l2.3734"></a><span id="l2.3734" class="difflineplus">+          nsCOMPtr&lt;nsIPop3IncomingServer&gt; curMsgPop3MailServer =</span>
<a href="#l2.3735"></a><span id="l2.3735" class="difflineplus">+              do_QueryInterface(incomingServer);</span>
<a href="#l2.3736"></a><span id="l2.3736" class="difflineplus">+          if (curMsgPop3MailServer) {</span>
<a href="#l2.3737"></a><span id="l2.3737">             msgPop3Server = curMsgPop3MailServer;</span>
<a href="#l2.3738"></a><span id="l2.3738">             msgPop3Server-&gt;GetDeleteMailLeftOnServer(&amp;deleteMailLeftOnServer);</span>
<a href="#l2.3739"></a><span id="l2.3739">             msgPop3Server-&gt;GetLeaveMessagesOnServer(&amp;leaveOnServer);</span>
<a href="#l2.3740"></a><span id="l2.3740">           }</span>
<a href="#l2.3741"></a><span id="l2.3741">         }</span>
<a href="#l2.3742"></a><span id="l2.3742">       }</span>
<a href="#l2.3743"></a><span id="l2.3743">       // ignore this header if not partial and leaveOnServer not set...</span>
<a href="#l2.3744"></a><span id="l2.3744">       // or if we can't find the pop3 server.</span>
<a href="#l2.3745"></a><span id="l2.3745" class="difflineminus">-      if (!msgPop3Server || (! (flags &amp; nsMsgMessageFlags::Partial) &amp;&amp; !leaveOnServer))</span>
<a href="#l2.3746"></a><span id="l2.3746" class="difflineplus">+      if (!msgPop3Server ||</span>
<a href="#l2.3747"></a><span id="l2.3747" class="difflineplus">+          (!(flags &amp; nsMsgMessageFlags::Partial) &amp;&amp; !leaveOnServer))</span>
<a href="#l2.3748"></a><span id="l2.3748">         continue;</span>
<a href="#l2.3749"></a><span id="l2.3749">       // if marking deleted, ignore header if we're not deleting from</span>
<a href="#l2.3750"></a><span id="l2.3750">       // server when deleting locally.</span>
<a href="#l2.3751"></a><span id="l2.3751">       if (aMark == POP3_DELETE &amp;&amp; leaveOnServer &amp;&amp; !deleteMailLeftOnServer)</span>
<a href="#l2.3752"></a><span id="l2.3752">         continue;</span>
<a href="#l2.3753"></a><span id="l2.3753" class="difflineminus">-      if (folderScanState.m_uidl)</span>
<a href="#l2.3754"></a><span id="l2.3754" class="difflineminus">-      {</span>
<a href="#l2.3755"></a><span id="l2.3755" class="difflineplus">+      if (folderScanState.m_uidl) {</span>
<a href="#l2.3756"></a><span id="l2.3756">         msgPop3Server-&gt;AddUidlToMark(folderScanState.m_uidl, mark);</span>
<a href="#l2.3757"></a><span id="l2.3757">         // remember this pop server in list of servers with msgs deleted</span>
<a href="#l2.3758"></a><span id="l2.3758">         if (pop3Servers.IndexOfObject(msgPop3Server) == -1)</span>
<a href="#l2.3759"></a><span id="l2.3759">           pop3Servers.AppendObject(msgPop3Server);</span>
<a href="#l2.3760"></a><span id="l2.3760">       }</span>
<a href="#l2.3761"></a><span id="l2.3761">     }</span>
<a href="#l2.3762"></a><span id="l2.3762">   }</span>
<a href="#l2.3763"></a><span id="l2.3763" class="difflineminus">-  if (folderScanState.m_inputStream)</span>
<a href="#l2.3764"></a><span id="l2.3764" class="difflineminus">-    folderScanState.m_inputStream-&gt;Close();</span>
<a href="#l2.3765"></a><span id="l2.3765" class="difflineplus">+  if (folderScanState.m_inputStream) folderScanState.m_inputStream-&gt;Close();</span>
<a href="#l2.3766"></a><span id="l2.3766">   // need to do this for all pop3 mail servers that had messages deleted.</span>
<a href="#l2.3767"></a><span id="l2.3767">   uint32_t serverCount = pop3Servers.Count();</span>
<a href="#l2.3768"></a><span id="l2.3768">   for (uint32_t index = 0; index &lt; serverCount; index++)</span>
<a href="#l2.3769"></a><span id="l2.3769">     pop3Servers[index]-&gt;MarkMessages();</span>
<a href="#l2.3770"></a><span id="l2.3770"> </span>
<a href="#l2.3771"></a><span id="l2.3771">   return rv;</span>
<a href="#l2.3772"></a><span id="l2.3772"> }</span>
<a href="#l2.3773"></a><span id="l2.3773"> </span>
<a href="#l2.3774"></a><span id="l2.3774" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::DeleteDownloadMsg(nsIMsgDBHdr *aMsgHdr, bool *aDoSelect)</span>
<a href="#l2.3775"></a><span id="l2.3775" class="difflineminus">-{</span>
<a href="#l2.3776"></a><span id="l2.3776" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::DeleteDownloadMsg(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l2.3777"></a><span id="l2.3777" class="difflineplus">+                                                      bool *aDoSelect) {</span>
<a href="#l2.3778"></a><span id="l2.3778">   uint32_t numMsgs;</span>
<a href="#l2.3779"></a><span id="l2.3779">   char *newMsgId;</span>
<a href="#l2.3780"></a><span id="l2.3780"> </span>
<a href="#l2.3781"></a><span id="l2.3781">   // This method is only invoked through DownloadMessagesForOffline()</span>
<a href="#l2.3782"></a><span id="l2.3782" class="difflineminus">-  if (mDownloadState != DOWNLOAD_STATE_NONE)</span>
<a href="#l2.3783"></a><span id="l2.3783" class="difflineminus">-  {</span>
<a href="#l2.3784"></a><span id="l2.3784" class="difflineplus">+  if (mDownloadState != DOWNLOAD_STATE_NONE) {</span>
<a href="#l2.3785"></a><span id="l2.3785">     // We only remember the first key, no matter how many</span>
<a href="#l2.3786"></a><span id="l2.3786">     // messages were originally selected.</span>
<a href="#l2.3787"></a><span id="l2.3787" class="difflineminus">-    if (mDownloadState == DOWNLOAD_STATE_INITED)</span>
<a href="#l2.3788"></a><span id="l2.3788" class="difflineminus">-    {</span>
<a href="#l2.3789"></a><span id="l2.3789" class="difflineplus">+    if (mDownloadState == DOWNLOAD_STATE_INITED) {</span>
<a href="#l2.3790"></a><span id="l2.3790">       aMsgHdr-&gt;GetMessageKey(&amp;mDownloadSelectKey);</span>
<a href="#l2.3791"></a><span id="l2.3791">       mDownloadState = DOWNLOAD_STATE_GOTMSG;</span>
<a href="#l2.3792"></a><span id="l2.3792">     }</span>
<a href="#l2.3793"></a><span id="l2.3793"> </span>
<a href="#l2.3794"></a><span id="l2.3794">     aMsgHdr-&gt;GetMessageId(&amp;newMsgId);</span>
<a href="#l2.3795"></a><span id="l2.3795"> </span>
<a href="#l2.3796"></a><span id="l2.3796">     // Walk through all the selected headers, looking for a matching</span>
<a href="#l2.3797"></a><span id="l2.3797">     // Message-ID.</span>
<a href="#l2.3798"></a><span id="l2.3798">     numMsgs = mDownloadMessages.Length();</span>
<a href="#l2.3799"></a><span id="l2.3799" class="difflineminus">-    for (uint32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l2.3800"></a><span id="l2.3800" class="difflineminus">-    {</span>
<a href="#l2.3801"></a><span id="l2.3801" class="difflineplus">+    for (uint32_t i = 0; i &lt; numMsgs; i++) {</span>
<a href="#l2.3802"></a><span id="l2.3802">       nsresult rv;</span>
<a href="#l2.3803"></a><span id="l2.3803">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr = mDownloadMessages[i];</span>
<a href="#l2.3804"></a><span id="l2.3804">       char *oldMsgId = nullptr;</span>
<a href="#l2.3805"></a><span id="l2.3805">       msgDBHdr-&gt;GetMessageId(&amp;oldMsgId);</span>
<a href="#l2.3806"></a><span id="l2.3806"> </span>
<a href="#l2.3807"></a><span id="l2.3807">       // Delete the first match and remove it from the array</span>
<a href="#l2.3808"></a><span id="l2.3808" class="difflineminus">-      if (!PL_strcmp(newMsgId, oldMsgId))</span>
<a href="#l2.3809"></a><span id="l2.3809" class="difflineminus">-      {</span>
<a href="#l2.3810"></a><span id="l2.3810" class="difflineplus">+      if (!PL_strcmp(newMsgId, oldMsgId)) {</span>
<a href="#l2.3811"></a><span id="l2.3811">         rv = GetDatabase();</span>
<a href="#l2.3812"></a><span id="l2.3812" class="difflineminus">-        if (!mDatabase)</span>
<a href="#l2.3813"></a><span id="l2.3813" class="difflineminus">-          return rv;</span>
<a href="#l2.3814"></a><span id="l2.3814" class="difflineplus">+        if (!mDatabase) return rv;</span>
<a href="#l2.3815"></a><span id="l2.3815"> </span>
<a href="#l2.3816"></a><span id="l2.3816">         UpdateNewMsgHdr(msgDBHdr, aMsgHdr);</span>
<a href="#l2.3817"></a><span id="l2.3817"> </span>
<a href="#l2.3818"></a><span id="l2.3818"> #if DOWNLOAD_NOTIFY_STYLE == DOWNLOAD_NOTIFY_LAST</span>
<a href="#l2.3819"></a><span id="l2.3819">         msgDBHdr-&gt;GetMessageKey(&amp;mDownloadOldKey);</span>
<a href="#l2.3820"></a><span id="l2.3820">         msgDBHdr-&gt;GetThreadParent(&amp;mDownloadOldParent);</span>
<a href="#l2.3821"></a><span id="l2.3821">         msgDBHdr-&gt;GetFlags(&amp;mDownloadOldFlags);</span>
<a href="#l2.3822"></a><span id="l2.3822">         mDatabase-&gt;DeleteHeader(msgDBHdr, nullptr, false, false);</span>
<a href="#l2.3823"></a><span id="l2.3823">         // Tell caller we want to select this message</span>
<a href="#l2.3824"></a><span id="l2.3824" class="difflineminus">-        if (aDoSelect)</span>
<a href="#l2.3825"></a><span id="l2.3825" class="difflineminus">-          *aDoSelect = true;</span>
<a href="#l2.3826"></a><span id="l2.3826" class="difflineplus">+        if (aDoSelect) *aDoSelect = true;</span>
<a href="#l2.3827"></a><span id="l2.3827"> #else</span>
<a href="#l2.3828"></a><span id="l2.3828">         mDatabase-&gt;DeleteHeader(msgDBHdr, nullptr, false, true);</span>
<a href="#l2.3829"></a><span id="l2.3829">         // Tell caller we want to select this message</span>
<a href="#l2.3830"></a><span id="l2.3830">         if (aDoSelect &amp;&amp; mDownloadState == DOWNLOAD_STATE_GOTMSG)</span>
<a href="#l2.3831"></a><span id="l2.3831">           *aDoSelect = true;</span>
<a href="#l2.3832"></a><span id="l2.3832"> #endif</span>
<a href="#l2.3833"></a><span id="l2.3833">         mDownloadMessages.RemoveElementAt(i);</span>
<a href="#l2.3834"></a><span id="l2.3834">         break;</span>
<a href="#l2.3835"></a><span id="l2.3835">       }</span>
<a href="#l2.3836"></a><span id="l2.3836">     }</span>
<a href="#l2.3837"></a><span id="l2.3837">   }</span>
<a href="#l2.3838"></a><span id="l2.3838"> </span>
<a href="#l2.3839"></a><span id="l2.3839">   return NS_OK;</span>
<a href="#l2.3840"></a><span id="l2.3840"> }</span>
<a href="#l2.3841"></a><span id="l2.3841"> </span>
<a href="#l2.3842"></a><span id="l2.3842" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::SelectDownloadMsg()</span>
<a href="#l2.3843"></a><span id="l2.3843" class="difflineminus">-{</span>
<a href="#l2.3844"></a><span id="l2.3844" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::SelectDownloadMsg() {</span>
<a href="#l2.3845"></a><span id="l2.3845"> #if DOWNLOAD_NOTIFY_STYLE == DOWNLOAD_NOTIFY_LAST</span>
<a href="#l2.3846"></a><span id="l2.3846" class="difflineminus">-  if (mDownloadState &gt;= DOWNLOAD_STATE_GOTMSG)</span>
<a href="#l2.3847"></a><span id="l2.3847" class="difflineminus">-  {</span>
<a href="#l2.3848"></a><span id="l2.3848" class="difflineplus">+  if (mDownloadState &gt;= DOWNLOAD_STATE_GOTMSG) {</span>
<a href="#l2.3849"></a><span id="l2.3849">     nsresult rv = GetDatabase();</span>
<a href="#l2.3850"></a><span id="l2.3850" class="difflineminus">-    if (!mDatabase)</span>
<a href="#l2.3851"></a><span id="l2.3851" class="difflineminus">-      return rv;</span>
<a href="#l2.3852"></a><span id="l2.3852" class="difflineminus">-    }</span>
<a href="#l2.3853"></a><span id="l2.3853" class="difflineminus">-    mDatabase-&gt;NotifyKeyDeletedAll(mDownloadOldKey, mDownloadOldParent, mDownloadOldFlags, nullptr);</span>
<a href="#l2.3854"></a><span id="l2.3854" class="difflineplus">+    if (!mDatabase) return rv;</span>
<a href="#l2.3855"></a><span id="l2.3855">   }</span>
<a href="#l2.3856"></a><span id="l2.3856" class="difflineplus">+  mDatabase-&gt;NotifyKeyDeletedAll(mDownloadOldKey, mDownloadOldParent,</span>
<a href="#l2.3857"></a><span id="l2.3857" class="difflineplus">+                                 mDownloadOldFlags, nullptr);</span>
<a href="#l2.3858"></a><span id="l2.3858" class="difflineplus">+}</span>
<a href="#l2.3859"></a><span id="l2.3859"> #endif</span>
<a href="#l2.3860"></a><span id="l2.3860"> </span>
<a href="#l2.3861"></a><span id="l2.3861" class="difflineminus">-  if (mDownloadState == DOWNLOAD_STATE_GOTMSG &amp;&amp; mDownloadWindow)</span>
<a href="#l2.3862"></a><span id="l2.3862" class="difflineminus">-  {</span>
<a href="#l2.3863"></a><span id="l2.3863" class="difflineminus">-    nsAutoCString newuri;</span>
<a href="#l2.3864"></a><span id="l2.3864" class="difflineminus">-    nsBuildLocalMessageURI(mBaseMessageURI.get(), mDownloadSelectKey, newuri);</span>
<a href="#l2.3865"></a><span id="l2.3865" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l2.3866"></a><span id="l2.3866" class="difflineminus">-    mDownloadWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l2.3867"></a><span id="l2.3867" class="difflineminus">-    if (windowCommands)</span>
<a href="#l2.3868"></a><span id="l2.3868" class="difflineminus">-      windowCommands-&gt;SelectMessage(newuri);</span>
<a href="#l2.3869"></a><span id="l2.3869" class="difflineminus">-    mDownloadState = DOWNLOAD_STATE_DIDSEL;</span>
<a href="#l2.3870"></a><span id="l2.3870" class="difflineminus">-  }</span>
<a href="#l2.3871"></a><span id="l2.3871" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.3872"></a><span id="l2.3872" class="difflineplus">+if (mDownloadState == DOWNLOAD_STATE_GOTMSG &amp;&amp; mDownloadWindow) {</span>
<a href="#l2.3873"></a><span id="l2.3873" class="difflineplus">+  nsAutoCString newuri;</span>
<a href="#l2.3874"></a><span id="l2.3874" class="difflineplus">+  nsBuildLocalMessageURI(mBaseMessageURI.get(), mDownloadSelectKey, newuri);</span>
<a href="#l2.3875"></a><span id="l2.3875" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l2.3876"></a><span id="l2.3876" class="difflineplus">+  mDownloadWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l2.3877"></a><span id="l2.3877" class="difflineplus">+  if (windowCommands) windowCommands-&gt;SelectMessage(newuri);</span>
<a href="#l2.3878"></a><span id="l2.3878" class="difflineplus">+  mDownloadState = DOWNLOAD_STATE_DIDSEL;</span>
<a href="#l2.3879"></a><span id="l2.3879"> }</span>
<a href="#l2.3880"></a><span id="l2.3880" class="difflineminus">-</span>
<a href="#l2.3881"></a><span id="l2.3881" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::DownloadMessagesForOffline(nsIArray *aMessages, nsIMsgWindow *aWindow)</span>
<a href="#l2.3882"></a><span id="l2.3882" class="difflineminus">-{</span>
<a href="#l2.3883"></a><span id="l2.3883" class="difflineplus">+return NS_OK;</span>
<a href="#l2.3884"></a><span id="l2.3884" class="difflineplus">+}</span>
<a href="#l2.3885"></a><span id="l2.3885" class="difflineplus">+</span>
<a href="#l2.3886"></a><span id="l2.3886" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::DownloadMessagesForOffline(</span>
<a href="#l2.3887"></a><span id="l2.3887" class="difflineplus">+    nsIArray *aMessages, nsIMsgWindow *aWindow) {</span>
<a href="#l2.3888"></a><span id="l2.3888">   if (mDownloadState != DOWNLOAD_STATE_NONE)</span>
<a href="#l2.3889"></a><span id="l2.3889" class="difflineminus">-    return NS_ERROR_FAILURE; // already has a download in progress</span>
<a href="#l2.3890"></a><span id="l2.3890" class="difflineplus">+    return NS_ERROR_FAILURE;  // already has a download in progress</span>
<a href="#l2.3891"></a><span id="l2.3891"> </span>
<a href="#l2.3892"></a><span id="l2.3892">   // We're starting a download...</span>
<a href="#l2.3893"></a><span id="l2.3893">   mDownloadState = DOWNLOAD_STATE_INITED;</span>
<a href="#l2.3894"></a><span id="l2.3894"> </span>
<a href="#l2.3895"></a><span id="l2.3895">   MarkMsgsOnPop3Server(aMessages, POP3_FETCH_BODY);</span>
<a href="#l2.3896"></a><span id="l2.3896"> </span>
<a href="#l2.3897"></a><span id="l2.3897">   // Pull out all the PARTIAL messages into a new array</span>
<a href="#l2.3898"></a><span id="l2.3898">   uint32_t srcCount;</span>
<a href="#l2.3899"></a><span id="l2.3899">   aMessages-&gt;GetLength(&amp;srcCount);</span>
<a href="#l2.3900"></a><span id="l2.3900"> </span>
<a href="#l2.3901"></a><span id="l2.3901">   nsresult rv;</span>
<a href="#l2.3902"></a><span id="l2.3902" class="difflineminus">-  for (uint32_t i = 0; i &lt; srcCount; i++)</span>
<a href="#l2.3903"></a><span id="l2.3903" class="difflineminus">-  {</span>
<a href="#l2.3904"></a><span id="l2.3904" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr (do_QueryElementAt(aMessages, i, &amp;rv));</span>
<a href="#l2.3905"></a><span id="l2.3905" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.3906"></a><span id="l2.3906" class="difflineminus">-    {</span>
<a href="#l2.3907"></a><span id="l2.3907" class="difflineplus">+  for (uint32_t i = 0; i &lt; srcCount; i++) {</span>
<a href="#l2.3908"></a><span id="l2.3908" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryElementAt(aMessages, i, &amp;rv));</span>
<a href="#l2.3909"></a><span id="l2.3909" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.3910"></a><span id="l2.3910">       uint32_t flags = 0;</span>
<a href="#l2.3911"></a><span id="l2.3911">       msgDBHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l2.3912"></a><span id="l2.3912">       if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l2.3913"></a><span id="l2.3913">         mDownloadMessages.AppendElement(msgDBHdr);</span>
<a href="#l2.3914"></a><span id="l2.3914">     }</span>
<a href="#l2.3915"></a><span id="l2.3915">   }</span>
<a href="#l2.3916"></a><span id="l2.3916">   mDownloadWindow = aWindow;</span>
<a href="#l2.3917"></a><span id="l2.3917"> </span>
<a href="#l2.3918"></a><span id="l2.3918">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.3919"></a><span id="l2.3919">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.3920"></a><span id="l2.3920">   NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.3921"></a><span id="l2.3921"> </span>
<a href="#l2.3922"></a><span id="l2.3922" class="difflineminus">-  nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l2.3923"></a><span id="l2.3923" class="difflineplus">+  nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer =</span>
<a href="#l2.3924"></a><span id="l2.3924" class="difflineplus">+      do_QueryInterface(server, &amp;rv);</span>
<a href="#l2.3925"></a><span id="l2.3925">   NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l2.3926"></a><span id="l2.3926">   return localMailServer-&gt;GetNewMail(aWindow, this, this, nullptr);</span>
<a href="#l2.3927"></a><span id="l2.3927"> }</span>
<a href="#l2.3928"></a><span id="l2.3928"> </span>
<a href="#l2.3929"></a><span id="l2.3929" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::NotifyDelete()</span>
<a href="#l2.3930"></a><span id="l2.3930" class="difflineminus">-{</span>
<a href="#l2.3931"></a><span id="l2.3931" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::NotifyDelete() {</span>
<a href="#l2.3932"></a><span id="l2.3932">   NotifyFolderEvent(kDeleteOrMoveMsgCompleted);</span>
<a href="#l2.3933"></a><span id="l2.3933">   return NS_OK;</span>
<a href="#l2.3934"></a><span id="l2.3934"> }</span>
<a href="#l2.3935"></a><span id="l2.3935"> </span>
<a href="#l2.3936"></a><span id="l2.3936"> // TODO:  once we move certain code into the IncomingServer (search for TODO)</span>
<a href="#l2.3937"></a><span id="l2.3937"> // this method will go away.</span>
<a href="#l2.3938"></a><span id="l2.3938"> // sometimes this gets called when we don't have the server yet, so</span>
<a href="#l2.3939"></a><span id="l2.3939"> // that's why we're not calling GetServer()</span>
<a href="#l2.3940"></a><span id="l2.3940"> NS_IMETHODIMP</span>
<a href="#l2.3941"></a><span id="l2.3941" class="difflineminus">-nsMsgLocalMailFolder::GetIncomingServerType(nsACString&amp; aServerType)</span>
<a href="#l2.3942"></a><span id="l2.3942" class="difflineminus">-{</span>
<a href="#l2.3943"></a><span id="l2.3943" class="difflineplus">+nsMsgLocalMailFolder::GetIncomingServerType(nsACString &amp;aServerType) {</span>
<a href="#l2.3944"></a><span id="l2.3944">   nsresult rv;</span>
<a href="#l2.3945"></a><span id="l2.3945" class="difflineminus">-  if (mType.IsEmpty())</span>
<a href="#l2.3946"></a><span id="l2.3946" class="difflineminus">-  {</span>
<a href="#l2.3947"></a><span id="l2.3947" class="difflineplus">+  if (mType.IsEmpty()) {</span>
<a href="#l2.3948"></a><span id="l2.3948">     nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l2.3949"></a><span id="l2.3949" class="difflineminus">-    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(mURI).Finalize(url);</span>
<a href="#l2.3950"></a><span id="l2.3950" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3951"></a><span id="l2.3951" class="difflineminus">-      return rv;</span>
<a href="#l2.3952"></a><span id="l2.3952" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l2.3953"></a><span id="l2.3953" class="difflineplus">+             .SetSpec(mURI)</span>
<a href="#l2.3954"></a><span id="l2.3954" class="difflineplus">+             .Finalize(url);</span>
<a href="#l2.3955"></a><span id="l2.3955" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.3956"></a><span id="l2.3956"> </span>
<a href="#l2.3957"></a><span id="l2.3957">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l2.3958"></a><span id="l2.3958" class="difflineminus">-             do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3959"></a><span id="l2.3959" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l2.3960"></a><span id="l2.3960" class="difflineminus">-      return rv;</span>
<a href="#l2.3961"></a><span id="l2.3961" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l2.3962"></a><span id="l2.3962" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l2.3963"></a><span id="l2.3963"> </span>
<a href="#l2.3964"></a><span id="l2.3964">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.3965"></a><span id="l2.3965">     // try &quot;none&quot; first</span>
<a href="#l2.3966"></a><span id="l2.3966">     rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;)).Finalize(url);</span>
<a href="#l2.3967"></a><span id="l2.3967">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3968"></a><span id="l2.3968">     rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l2.3969"></a><span id="l2.3969">     if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l2.3970"></a><span id="l2.3970">       mType.AssignLiteral(&quot;none&quot;);</span>
<a href="#l2.3971"></a><span id="l2.3971" class="difflineminus">-    else</span>
<a href="#l2.3972"></a><span id="l2.3972" class="difflineminus">-    {</span>
<a href="#l2.3973"></a><span id="l2.3973" class="difflineplus">+    else {</span>
<a href="#l2.3974"></a><span id="l2.3974">       // next try &quot;pop3&quot;</span>
<a href="#l2.3975"></a><span id="l2.3975" class="difflineminus">-      rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l2.3976"></a><span id="l2.3976" class="difflineplus">+      rv =</span>
<a href="#l2.3977"></a><span id="l2.3977" class="difflineplus">+          NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l2.3978"></a><span id="l2.3978">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3979"></a><span id="l2.3979">       rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l2.3980"></a><span id="l2.3980">       if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l2.3981"></a><span id="l2.3981">         mType.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l2.3982"></a><span id="l2.3982" class="difflineminus">-      else</span>
<a href="#l2.3983"></a><span id="l2.3983" class="difflineminus">-      {</span>
<a href="#l2.3984"></a><span id="l2.3984" class="difflineplus">+      else {</span>
<a href="#l2.3985"></a><span id="l2.3985">         // next try &quot;rss&quot;</span>
<a href="#l2.3986"></a><span id="l2.3986" class="difflineminus">-        rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;)).Finalize(url);</span>
<a href="#l2.3987"></a><span id="l2.3987" class="difflineplus">+        rv = NS_MutateURI(url)</span>
<a href="#l2.3988"></a><span id="l2.3988" class="difflineplus">+                 .SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;))</span>
<a href="#l2.3989"></a><span id="l2.3989" class="difflineplus">+                 .Finalize(url);</span>
<a href="#l2.3990"></a><span id="l2.3990">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.3991"></a><span id="l2.3991" class="difflineminus">-        rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l2.3992"></a><span id="l2.3992" class="difflineplus">+        rv =</span>
<a href="#l2.3993"></a><span id="l2.3993" class="difflineplus">+            accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l2.3994"></a><span id="l2.3994">         if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l2.3995"></a><span id="l2.3995">           mType.AssignLiteral(&quot;rss&quot;);</span>
<a href="#l2.3996"></a><span id="l2.3996" class="difflineminus">-        else</span>
<a href="#l2.3997"></a><span id="l2.3997" class="difflineminus">-        {</span>
<a href="#l2.3998"></a><span id="l2.3998" class="difflineplus">+        else {</span>
<a href="#l2.3999"></a><span id="l2.3999"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l2.4000"></a><span id="l2.4000">           // next try &quot;movemail&quot;</span>
<a href="#l2.4001"></a><span id="l2.4001" class="difflineminus">-          rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;)).Finalize(url);</span>
<a href="#l2.4002"></a><span id="l2.4002" class="difflineplus">+          rv = NS_MutateURI(url)</span>
<a href="#l2.4003"></a><span id="l2.4003" class="difflineplus">+                   .SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;))</span>
<a href="#l2.4004"></a><span id="l2.4004" class="difflineplus">+                   .Finalize(url);</span>
<a href="#l2.4005"></a><span id="l2.4005">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4006"></a><span id="l2.4006" class="difflineminus">-          rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l2.4007"></a><span id="l2.4007" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l2.4008"></a><span id="l2.4008" class="difflineminus">-            mType.AssignLiteral(&quot;movemail&quot;);</span>
<a href="#l2.4009"></a><span id="l2.4009" class="difflineplus">+          rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l2.4010"></a><span id="l2.4010" class="difflineplus">+                                               getter_AddRefs(server));</span>
<a href="#l2.4011"></a><span id="l2.4011" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; server) mType.AssignLiteral(&quot;movemail&quot;);</span>
<a href="#l2.4012"></a><span id="l2.4012"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l2.4013"></a><span id="l2.4013">         }</span>
<a href="#l2.4014"></a><span id="l2.4014">       }</span>
<a href="#l2.4015"></a><span id="l2.4015">     }</span>
<a href="#l2.4016"></a><span id="l2.4016">   }</span>
<a href="#l2.4017"></a><span id="l2.4017">   aServerType = mType;</span>
<a href="#l2.4018"></a><span id="l2.4018">   return NS_OK;</span>
<a href="#l2.4019"></a><span id="l2.4019"> }</span>
<a href="#l2.4020"></a><span id="l2.4020"> </span>
<a href="#l2.4021"></a><span id="l2.4021" class="difflineminus">-nsresult nsMsgLocalMailFolder::CreateBaseMessageURI(const nsACString&amp; aURI)</span>
<a href="#l2.4022"></a><span id="l2.4022" class="difflineminus">-{</span>
<a href="#l2.4023"></a><span id="l2.4023" class="difflineplus">+nsresult nsMsgLocalMailFolder::CreateBaseMessageURI(const nsACString &amp;aURI) {</span>
<a href="#l2.4024"></a><span id="l2.4024">   return nsCreateLocalBaseMessageURI(aURI, mBaseMessageURI);</span>
<a href="#l2.4025"></a><span id="l2.4025"> }</span>
<a href="#l2.4026"></a><span id="l2.4026"> </span>
<a href="#l2.4027"></a><span id="l2.4027"> NS_IMETHODIMP</span>
<a href="#l2.4028"></a><span id="l2.4028" class="difflineminus">-nsMsgLocalMailFolder::OnStartRunningUrl(nsIURI * aUrl)</span>
<a href="#l2.4029"></a><span id="l2.4029" class="difflineminus">-{</span>
<a href="#l2.4030"></a><span id="l2.4030" class="difflineplus">+nsMsgLocalMailFolder::OnStartRunningUrl(nsIURI *aUrl) {</span>
<a href="#l2.4031"></a><span id="l2.4031">   nsresult rv;</span>
<a href="#l2.4032"></a><span id="l2.4032">   nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l2.4033"></a><span id="l2.4033" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4034"></a><span id="l2.4034" class="difflineminus">-  {</span>
<a href="#l2.4035"></a><span id="l2.4035" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4036"></a><span id="l2.4036">     nsAutoCString aSpec;</span>
<a href="#l2.4037"></a><span id="l2.4037">     rv = aUrl-&gt;GetSpec(aSpec);</span>
<a href="#l2.4038"></a><span id="l2.4038">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4039"></a><span id="l2.4039" class="difflineminus">-    if (strstr(aSpec.get(), &quot;uidl=&quot;))</span>
<a href="#l2.4040"></a><span id="l2.4040" class="difflineminus">-    {</span>
<a href="#l2.4041"></a><span id="l2.4041" class="difflineplus">+    if (strstr(aSpec.get(), &quot;uidl=&quot;)) {</span>
<a href="#l2.4042"></a><span id="l2.4042">       nsCOMPtr&lt;nsIPop3Sink&gt; popsink;</span>
<a href="#l2.4043"></a><span id="l2.4043">       rv = popurl-&gt;GetPop3Sink(getter_AddRefs(popsink));</span>
<a href="#l2.4044"></a><span id="l2.4044" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4045"></a><span id="l2.4045" class="difflineminus">-      {</span>
<a href="#l2.4046"></a><span id="l2.4046" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4047"></a><span id="l2.4047">         popsink-&gt;SetBaseMessageUri(mBaseMessageURI.get());</span>
<a href="#l2.4048"></a><span id="l2.4048">         nsCString messageuri;</span>
<a href="#l2.4049"></a><span id="l2.4049">         popurl-&gt;GetMessageUri(getter_Copies(messageuri));</span>
<a href="#l2.4050"></a><span id="l2.4050">         popsink-&gt;SetOrigMessageUri(messageuri);</span>
<a href="#l2.4051"></a><span id="l2.4051">       }</span>
<a href="#l2.4052"></a><span id="l2.4052">     }</span>
<a href="#l2.4053"></a><span id="l2.4053">   }</span>
<a href="#l2.4054"></a><span id="l2.4054">   return nsMsgDBFolder::OnStartRunningUrl(aUrl);</span>
<a href="#l2.4055"></a><span id="l2.4055"> }</span>
<a href="#l2.4056"></a><span id="l2.4056"> </span>
<a href="#l2.4057"></a><span id="l2.4057"> NS_IMETHODIMP</span>
<a href="#l2.4058"></a><span id="l2.4058" class="difflineminus">-nsMsgLocalMailFolder::OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode)</span>
<a href="#l2.4059"></a><span id="l2.4059" class="difflineminus">-{</span>
<a href="#l2.4060"></a><span id="l2.4060" class="difflineplus">+nsMsgLocalMailFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l2.4061"></a><span id="l2.4061">   // If we just finished a DownloadMessages call, reset...</span>
<a href="#l2.4062"></a><span id="l2.4062" class="difflineminus">-  if (mDownloadState != DOWNLOAD_STATE_NONE)</span>
<a href="#l2.4063"></a><span id="l2.4063" class="difflineminus">-  {</span>
<a href="#l2.4064"></a><span id="l2.4064" class="difflineplus">+  if (mDownloadState != DOWNLOAD_STATE_NONE) {</span>
<a href="#l2.4065"></a><span id="l2.4065">     mDownloadState = DOWNLOAD_STATE_NONE;</span>
<a href="#l2.4066"></a><span id="l2.4066">     mDownloadMessages.Clear();</span>
<a href="#l2.4067"></a><span id="l2.4067">     mDownloadWindow = nullptr;</span>
<a href="#l2.4068"></a><span id="l2.4068">     return nsMsgDBFolder::OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l2.4069"></a><span id="l2.4069">   }</span>
<a href="#l2.4070"></a><span id="l2.4070"> </span>
<a href="#l2.4071"></a><span id="l2.4071">   nsresult rv;</span>
<a href="#l2.4072"></a><span id="l2.4072" class="difflineminus">-  if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l2.4073"></a><span id="l2.4073" class="difflineminus">-  {</span>
<a href="#l2.4074"></a><span id="l2.4074" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l2.4075"></a><span id="l2.4075" class="difflineplus">+  if (NS_SUCCEEDED(aExitCode)) {</span>
<a href="#l2.4076"></a><span id="l2.4076" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l2.4077"></a><span id="l2.4077" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l2.4078"></a><span id="l2.4078">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4079"></a><span id="l2.4079">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l2.4080"></a><span id="l2.4080">     rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l2.4081"></a><span id="l2.4081">     nsAutoCString aSpec;</span>
<a href="#l2.4082"></a><span id="l2.4082">     if (aUrl) {</span>
<a href="#l2.4083"></a><span id="l2.4083">       rv = aUrl-&gt;GetSpec(aSpec);</span>
<a href="#l2.4084"></a><span id="l2.4084">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4085"></a><span id="l2.4085">     }</span>
<a href="#l2.4086"></a><span id="l2.4086"> </span>
<a href="#l2.4087"></a><span id="l2.4087" class="difflineminus">-    if (strstr(aSpec.get(), &quot;uidl=&quot;))</span>
<a href="#l2.4088"></a><span id="l2.4088" class="difflineminus">-    {</span>
<a href="#l2.4089"></a><span id="l2.4089" class="difflineplus">+    if (strstr(aSpec.get(), &quot;uidl=&quot;)) {</span>
<a href="#l2.4090"></a><span id="l2.4090">       nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l2.4091"></a><span id="l2.4091" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4092"></a><span id="l2.4092" class="difflineminus">-      {</span>
<a href="#l2.4093"></a><span id="l2.4093" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4094"></a><span id="l2.4094">         nsCString messageuri;</span>
<a href="#l2.4095"></a><span id="l2.4095">         rv = popurl-&gt;GetMessageUri(getter_Copies(messageuri));</span>
<a href="#l2.4096"></a><span id="l2.4096" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4097"></a><span id="l2.4097" class="difflineminus">-        {</span>
<a href="#l2.4098"></a><span id="l2.4098" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4099"></a><span id="l2.4099">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4100"></a><span id="l2.4100" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l2.4101"></a><span id="l2.4101" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l2.4102"></a><span id="l2.4102">           rv = GetMsgDBHdrFromURI(messageuri.get(), getter_AddRefs(msgDBHdr));</span>
<a href="#l2.4103"></a><span id="l2.4103" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4104"></a><span id="l2.4104" class="difflineminus">-          {</span>
<a href="#l2.4105"></a><span id="l2.4105" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4106"></a><span id="l2.4106">             GetDatabase();</span>
<a href="#l2.4107"></a><span id="l2.4107">             if (mDatabase)</span>
<a href="#l2.4108"></a><span id="l2.4108">               mDatabase-&gt;DeleteHeader(msgDBHdr, nullptr, true, true);</span>
<a href="#l2.4109"></a><span id="l2.4109">           }</span>
<a href="#l2.4110"></a><span id="l2.4110"> </span>
<a href="#l2.4111"></a><span id="l2.4111">           nsCOMPtr&lt;nsIPop3Sink&gt; pop3sink;</span>
<a href="#l2.4112"></a><span id="l2.4112">           nsCString newMessageUri;</span>
<a href="#l2.4113"></a><span id="l2.4113">           rv = popurl-&gt;GetPop3Sink(getter_AddRefs(pop3sink));</span>
<a href="#l2.4114"></a><span id="l2.4114" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4115"></a><span id="l2.4115" class="difflineminus">-          {</span>
<a href="#l2.4116"></a><span id="l2.4116" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4117"></a><span id="l2.4117">             pop3sink-&gt;GetMessageUri(getter_Copies(newMessageUri));</span>
<a href="#l2.4118"></a><span id="l2.4118" class="difflineminus">-            if (msgWindow)</span>
<a href="#l2.4119"></a><span id="l2.4119" class="difflineminus">-            {</span>
<a href="#l2.4120"></a><span id="l2.4120" class="difflineplus">+            if (msgWindow) {</span>
<a href="#l2.4121"></a><span id="l2.4121">               nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l2.4122"></a><span id="l2.4122">               msgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l2.4123"></a><span id="l2.4123" class="difflineminus">-              if (windowCommands)</span>
<a href="#l2.4124"></a><span id="l2.4124" class="difflineminus">-                windowCommands-&gt;SelectMessage(newMessageUri);</span>
<a href="#l2.4125"></a><span id="l2.4125" class="difflineplus">+              if (windowCommands) windowCommands-&gt;SelectMessage(newMessageUri);</span>
<a href="#l2.4126"></a><span id="l2.4126">             }</span>
<a href="#l2.4127"></a><span id="l2.4127">           }</span>
<a href="#l2.4128"></a><span id="l2.4128">         }</span>
<a href="#l2.4129"></a><span id="l2.4129">       }</span>
<a href="#l2.4130"></a><span id="l2.4130">     }</span>
<a href="#l2.4131"></a><span id="l2.4131"> </span>
<a href="#l2.4132"></a><span id="l2.4132" class="difflineminus">-    if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l2.4133"></a><span id="l2.4133" class="difflineminus">-    {</span>
<a href="#l2.4134"></a><span id="l2.4134" class="difflineminus">-      if (mDatabase &amp;&amp; mCheckForNewMessagesAfterParsing)</span>
<a href="#l2.4135"></a><span id="l2.4135" class="difflineminus">-      {</span>
<a href="#l2.4136"></a><span id="l2.4136" class="difflineminus">-        bool valid = false; // GetSummaryValid may return without setting valid.</span>
<a href="#l2.4137"></a><span id="l2.4137" class="difflineplus">+    if (mFlags &amp; nsMsgFolderFlags::Inbox) {</span>
<a href="#l2.4138"></a><span id="l2.4138" class="difflineplus">+      if (mDatabase &amp;&amp; mCheckForNewMessagesAfterParsing) {</span>
<a href="#l2.4139"></a><span id="l2.4139" class="difflineplus">+        bool valid =</span>
<a href="#l2.4140"></a><span id="l2.4140" class="difflineplus">+            false;  // GetSummaryValid may return without setting valid.</span>
<a href="#l2.4141"></a><span id="l2.4141">         mDatabase-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l2.4142"></a><span id="l2.4142" class="difflineminus">-        if (valid &amp;&amp; msgWindow)</span>
<a href="#l2.4143"></a><span id="l2.4143" class="difflineminus">-          rv = GetNewMessages(msgWindow, nullptr);</span>
<a href="#l2.4144"></a><span id="l2.4144" class="difflineplus">+        if (valid &amp;&amp; msgWindow) rv = GetNewMessages(msgWindow, nullptr);</span>
<a href="#l2.4145"></a><span id="l2.4145">         mCheckForNewMessagesAfterParsing = false;</span>
<a href="#l2.4146"></a><span id="l2.4146">       }</span>
<a href="#l2.4147"></a><span id="l2.4147">     }</span>
<a href="#l2.4148"></a><span id="l2.4148">   }</span>
<a href="#l2.4149"></a><span id="l2.4149"> </span>
<a href="#l2.4150"></a><span id="l2.4150" class="difflineminus">-  if (m_parsingFolder)</span>
<a href="#l2.4151"></a><span id="l2.4151" class="difflineminus">-  {</span>
<a href="#l2.4152"></a><span id="l2.4152" class="difflineplus">+  if (m_parsingFolder) {</span>
<a href="#l2.4153"></a><span id="l2.4153">     // Clear this before calling OnStopRunningUrl, in case the url listener</span>
<a href="#l2.4154"></a><span id="l2.4154">     // tries to get the database.</span>
<a href="#l2.4155"></a><span id="l2.4155">     m_parsingFolder = false;</span>
<a href="#l2.4156"></a><span id="l2.4156"> </span>
<a href="#l2.4157"></a><span id="l2.4157">     // TODO: Updating the size should be pushed down into the msg store backend</span>
<a href="#l2.4158"></a><span id="l2.4158">     // so that the size is recalculated as part of parsing the folder data</span>
<a href="#l2.4159"></a><span id="l2.4159">     // (important for maildir), once GetSizeOnDisk is pushed into the msgStores</span>
<a href="#l2.4160"></a><span id="l2.4160">     // (bug 1032360).</span>
<a href="#l2.4161"></a><span id="l2.4161">     (void)RefreshSizeOnDisk();</span>
<a href="#l2.4162"></a><span id="l2.4162"> </span>
<a href="#l2.4163"></a><span id="l2.4163">     // Update the summary totals so the front end will</span>
<a href="#l2.4164"></a><span id="l2.4164">     // show the right thing.</span>
<a href="#l2.4165"></a><span id="l2.4165">     UpdateSummaryTotals(true);</span>
<a href="#l2.4166"></a><span id="l2.4166"> </span>
<a href="#l2.4167"></a><span id="l2.4167" class="difflineminus">-    if (mReparseListener)</span>
<a href="#l2.4168"></a><span id="l2.4168" class="difflineminus">-    {</span>
<a href="#l2.4169"></a><span id="l2.4169" class="difflineplus">+    if (mReparseListener) {</span>
<a href="#l2.4170"></a><span id="l2.4170">       nsCOMPtr&lt;nsIUrlListener&gt; saveReparseListener = mReparseListener;</span>
<a href="#l2.4171"></a><span id="l2.4171">       mReparseListener = nullptr;</span>
<a href="#l2.4172"></a><span id="l2.4172">       saveReparseListener-&gt;OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l2.4173"></a><span id="l2.4173">     }</span>
<a href="#l2.4174"></a><span id="l2.4174">   }</span>
<a href="#l2.4175"></a><span id="l2.4175" class="difflineminus">-  if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l2.4176"></a><span id="l2.4176" class="difflineminus">-  {</span>
<a href="#l2.4177"></a><span id="l2.4177" class="difflineplus">+  if (mFlags &amp; nsMsgFolderFlags::Inbox) {</span>
<a href="#l2.4178"></a><span id="l2.4178">     // if we are the inbox and running pop url</span>
<a href="#l2.4179"></a><span id="l2.4179">     nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l2.4180"></a><span id="l2.4180">     mozilla::Unused &lt;&lt; popurl;</span>
<a href="#l2.4181"></a><span id="l2.4181" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4182"></a><span id="l2.4182" class="difflineminus">-    {</span>
<a href="#l2.4183"></a><span id="l2.4183" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4184"></a><span id="l2.4184">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.4185"></a><span id="l2.4185">       GetServer(getter_AddRefs(server));</span>
<a href="#l2.4186"></a><span id="l2.4186">       // this is the deferred to account, in the global inbox case</span>
<a href="#l2.4187"></a><span id="l2.4187" class="difflineminus">-      if (server)</span>
<a href="#l2.4188"></a><span id="l2.4188" class="difflineminus">-        server-&gt;SetPerformingBiff(false);  //biff is over</span>
<a href="#l2.4189"></a><span id="l2.4189" class="difflineplus">+      if (server) server-&gt;SetPerformingBiff(false);  // biff is over</span>
<a href="#l2.4190"></a><span id="l2.4190">     }</span>
<a href="#l2.4191"></a><span id="l2.4191">   }</span>
<a href="#l2.4192"></a><span id="l2.4192">   return nsMsgDBFolder::OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l2.4193"></a><span id="l2.4193"> }</span>
<a href="#l2.4194"></a><span id="l2.4194"> </span>
<a href="#l2.4195"></a><span id="l2.4195" class="difflineminus">-nsresult nsMsgLocalMailFolder::DisplayMoveCopyStatusMsg()</span>
<a href="#l2.4196"></a><span id="l2.4196" class="difflineminus">-{</span>
<a href="#l2.4197"></a><span id="l2.4197" class="difflineplus">+nsresult nsMsgLocalMailFolder::DisplayMoveCopyStatusMsg() {</span>
<a href="#l2.4198"></a><span id="l2.4198">   nsresult rv = NS_OK;</span>
<a href="#l2.4199"></a><span id="l2.4199" class="difflineminus">-  if (mCopyState)</span>
<a href="#l2.4200"></a><span id="l2.4200" class="difflineminus">-  {</span>
<a href="#l2.4201"></a><span id="l2.4201" class="difflineminus">-    if (!mCopyState-&gt;m_statusFeedback)</span>
<a href="#l2.4202"></a><span id="l2.4202" class="difflineminus">-    {</span>
<a href="#l2.4203"></a><span id="l2.4203" class="difflineplus">+  if (mCopyState) {</span>
<a href="#l2.4204"></a><span id="l2.4204" class="difflineplus">+    if (!mCopyState-&gt;m_statusFeedback) {</span>
<a href="#l2.4205"></a><span id="l2.4205">       // get msgWindow from undo txn</span>
<a href="#l2.4206"></a><span id="l2.4206">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l2.4207"></a><span id="l2.4207">       if (mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l2.4208"></a><span id="l2.4208">         mCopyState-&gt;m_undoMsgTxn-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l2.4209"></a><span id="l2.4209" class="difflineminus">-      if (!msgWindow)</span>
<a href="#l2.4210"></a><span id="l2.4210" class="difflineminus">-        return NS_OK; // not a fatal error.</span>
<a href="#l2.4211"></a><span id="l2.4211" class="difflineminus">-</span>
<a href="#l2.4212"></a><span id="l2.4212" class="difflineminus">-      msgWindow-&gt;GetStatusFeedback(getter_AddRefs(mCopyState-&gt;m_statusFeedback));</span>
<a href="#l2.4213"></a><span id="l2.4213" class="difflineplus">+      if (!msgWindow) return NS_OK;  // not a fatal error.</span>
<a href="#l2.4214"></a><span id="l2.4214" class="difflineplus">+</span>
<a href="#l2.4215"></a><span id="l2.4215" class="difflineplus">+      msgWindow-&gt;GetStatusFeedback(</span>
<a href="#l2.4216"></a><span id="l2.4216" class="difflineplus">+          getter_AddRefs(mCopyState-&gt;m_statusFeedback));</span>
<a href="#l2.4217"></a><span id="l2.4217">     }</span>
<a href="#l2.4218"></a><span id="l2.4218"> </span>
<a href="#l2.4219"></a><span id="l2.4219" class="difflineminus">-    if (!mCopyState-&gt;m_stringBundle)</span>
<a href="#l2.4220"></a><span id="l2.4220" class="difflineminus">-    {</span>
<a href="#l2.4221"></a><span id="l2.4221" class="difflineplus">+    if (!mCopyState-&gt;m_stringBundle) {</span>
<a href="#l2.4222"></a><span id="l2.4222">       nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l2.4223"></a><span id="l2.4223" class="difflineminus">-        mozilla::services::GetStringBundleService();</span>
<a href="#l2.4224"></a><span id="l2.4224" class="difflineplus">+          mozilla::services::GetStringBundleService();</span>
<a href="#l2.4225"></a><span id="l2.4225">       NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l2.4226"></a><span id="l2.4226" class="difflineminus">-      rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(mCopyState-&gt;m_stringBundle));</span>
<a href="#l2.4227"></a><span id="l2.4227" class="difflineplus">+      rv = bundleService-&gt;CreateBundle(</span>
<a href="#l2.4228"></a><span id="l2.4228" class="difflineplus">+          &quot;chrome://messenger/locale/localMsgs.properties&quot;,</span>
<a href="#l2.4229"></a><span id="l2.4229" class="difflineplus">+          getter_AddRefs(mCopyState-&gt;m_stringBundle));</span>
<a href="#l2.4230"></a><span id="l2.4230">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4231"></a><span id="l2.4231">     }</span>
<a href="#l2.4232"></a><span id="l2.4232" class="difflineminus">-    if (mCopyState-&gt;m_statusFeedback &amp;&amp; mCopyState-&gt;m_stringBundle)</span>
<a href="#l2.4233"></a><span id="l2.4233" class="difflineminus">-    {</span>
<a href="#l2.4234"></a><span id="l2.4234" class="difflineplus">+    if (mCopyState-&gt;m_statusFeedback &amp;&amp; mCopyState-&gt;m_stringBundle) {</span>
<a href="#l2.4235"></a><span id="l2.4235">       nsString folderName;</span>
<a href="#l2.4236"></a><span id="l2.4236">       GetName(folderName);</span>
<a href="#l2.4237"></a><span id="l2.4237">       nsAutoString numMsgSoFarString;</span>
<a href="#l2.4238"></a><span id="l2.4238" class="difflineminus">-      numMsgSoFarString.AppendInt((mCopyState-&gt;m_copyingMultipleMessages) ? mCopyState-&gt;m_curCopyIndex : 1);</span>
<a href="#l2.4239"></a><span id="l2.4239" class="difflineplus">+      numMsgSoFarString.AppendInt((mCopyState-&gt;m_copyingMultipleMessages)</span>
<a href="#l2.4240"></a><span id="l2.4240" class="difflineplus">+                                      ? mCopyState-&gt;m_curCopyIndex</span>
<a href="#l2.4241"></a><span id="l2.4241" class="difflineplus">+                                      : 1);</span>
<a href="#l2.4242"></a><span id="l2.4242"> </span>
<a href="#l2.4243"></a><span id="l2.4243">       nsAutoString totalMessagesString;</span>
<a href="#l2.4244"></a><span id="l2.4244">       totalMessagesString.AppendInt(mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.4245"></a><span id="l2.4245">       nsString finalString;</span>
<a href="#l2.4246"></a><span id="l2.4246" class="difflineminus">-      const char16_t * stringArray[] = { numMsgSoFarString.get(), totalMessagesString.get(), folderName.get() };</span>
<a href="#l2.4247"></a><span id="l2.4247" class="difflineplus">+      const char16_t *stringArray[] = {</span>
<a href="#l2.4248"></a><span id="l2.4248" class="difflineplus">+          numMsgSoFarString.get(), totalMessagesString.get(), folderName.get()};</span>
<a href="#l2.4249"></a><span id="l2.4249">       rv = mCopyState-&gt;m_stringBundle-&gt;FormatStringFromName(</span>
<a href="#l2.4250"></a><span id="l2.4250" class="difflineminus">-        (mCopyState-&gt;m_isMove) ?</span>
<a href="#l2.4251"></a><span id="l2.4251" class="difflineminus">-        &quot;movingMessagesStatus&quot; :</span>
<a href="#l2.4252"></a><span id="l2.4252" class="difflineminus">-        &quot;copyingMessagesStatus&quot;,</span>
<a href="#l2.4253"></a><span id="l2.4253" class="difflineminus">-        stringArray, 3, finalString);</span>
<a href="#l2.4254"></a><span id="l2.4254" class="difflineplus">+          (mCopyState-&gt;m_isMove) ? &quot;movingMessagesStatus&quot;</span>
<a href="#l2.4255"></a><span id="l2.4255" class="difflineplus">+                                 : &quot;copyingMessagesStatus&quot;,</span>
<a href="#l2.4256"></a><span id="l2.4256" class="difflineplus">+          stringArray, 3, finalString);</span>
<a href="#l2.4257"></a><span id="l2.4257">       int64_t nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l2.4258"></a><span id="l2.4258"> </span>
<a href="#l2.4259"></a><span id="l2.4259">       // only update status/progress every half second</span>
<a href="#l2.4260"></a><span id="l2.4260">       if (nowMS - mCopyState-&gt;m_lastProgressTime &lt; 500 &amp;&amp;</span>
<a href="#l2.4261"></a><span id="l2.4261">           mCopyState-&gt;m_curCopyIndex &lt; mCopyState-&gt;m_totalMsgCount)</span>
<a href="#l2.4262"></a><span id="l2.4262">         return NS_OK;</span>
<a href="#l2.4263"></a><span id="l2.4263"> </span>
<a href="#l2.4264"></a><span id="l2.4264">       mCopyState-&gt;m_lastProgressTime = nowMS;</span>
<a href="#l2.4265"></a><span id="l2.4265">       mCopyState-&gt;m_statusFeedback-&gt;ShowStatusString(finalString);</span>
<a href="#l2.4266"></a><span id="l2.4266" class="difflineminus">-      mCopyState-&gt;m_statusFeedback-&gt;ShowProgress(mCopyState-&gt;m_curCopyIndex * 100 / mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.4267"></a><span id="l2.4267" class="difflineplus">+      mCopyState-&gt;m_statusFeedback-&gt;ShowProgress(</span>
<a href="#l2.4268"></a><span id="l2.4268" class="difflineplus">+          mCopyState-&gt;m_curCopyIndex * 100 / mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l2.4269"></a><span id="l2.4269">     }</span>
<a href="#l2.4270"></a><span id="l2.4270">   }</span>
<a href="#l2.4271"></a><span id="l2.4271">   return rv;</span>
<a href="#l2.4272"></a><span id="l2.4272"> }</span>
<a href="#l2.4273"></a><span id="l2.4273"> </span>
<a href="#l2.4274"></a><span id="l2.4274"> NS_IMETHODIMP</span>
<a href="#l2.4275"></a><span id="l2.4275" class="difflineminus">-nsMsgLocalMailFolder::SetFlagsOnDefaultMailboxes(uint32_t flags)</span>
<a href="#l2.4276"></a><span id="l2.4276" class="difflineminus">-{</span>
<a href="#l2.4277"></a><span id="l2.4277" class="difflineplus">+nsMsgLocalMailFolder::SetFlagsOnDefaultMailboxes(uint32_t flags) {</span>
<a href="#l2.4278"></a><span id="l2.4278">   if (flags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l2.4279"></a><span id="l2.4279">     setSubfolderFlag(NS_LITERAL_STRING(&quot;Inbox&quot;), nsMsgFolderFlags::Inbox);</span>
<a href="#l2.4280"></a><span id="l2.4280"> </span>
<a href="#l2.4281"></a><span id="l2.4281">   if (flags &amp; nsMsgFolderFlags::SentMail)</span>
<a href="#l2.4282"></a><span id="l2.4282">     setSubfolderFlag(NS_LITERAL_STRING(&quot;Sent&quot;), nsMsgFolderFlags::SentMail);</span>
<a href="#l2.4283"></a><span id="l2.4283"> </span>
<a href="#l2.4284"></a><span id="l2.4284">   if (flags &amp; nsMsgFolderFlags::Drafts)</span>
<a href="#l2.4285"></a><span id="l2.4285">     setSubfolderFlag(NS_LITERAL_STRING(&quot;Drafts&quot;), nsMsgFolderFlags::Drafts);</span>
<a href="#l2.4286"></a><span id="l2.4286"> </span>
<a href="#l2.4287"></a><span id="l2.4287">   if (flags &amp; nsMsgFolderFlags::Templates)</span>
<a href="#l2.4288"></a><span id="l2.4288" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Templates&quot;), nsMsgFolderFlags::Templates);</span>
<a href="#l2.4289"></a><span id="l2.4289" class="difflineplus">+    setSubfolderFlag(NS_LITERAL_STRING(&quot;Templates&quot;),</span>
<a href="#l2.4290"></a><span id="l2.4290" class="difflineplus">+                     nsMsgFolderFlags::Templates);</span>
<a href="#l2.4291"></a><span id="l2.4291"> </span>
<a href="#l2.4292"></a><span id="l2.4292">   if (flags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l2.4293"></a><span id="l2.4293">     setSubfolderFlag(NS_LITERAL_STRING(&quot;Trash&quot;), nsMsgFolderFlags::Trash);</span>
<a href="#l2.4294"></a><span id="l2.4294"> </span>
<a href="#l2.4295"></a><span id="l2.4295">   if (flags &amp; nsMsgFolderFlags::Queue)</span>
<a href="#l2.4296"></a><span id="l2.4296" class="difflineminus">-    setSubfolderFlag(NS_LITERAL_STRING(&quot;Unsent Messages&quot;), nsMsgFolderFlags::Queue);</span>
<a href="#l2.4297"></a><span id="l2.4297" class="difflineplus">+    setSubfolderFlag(NS_LITERAL_STRING(&quot;Unsent Messages&quot;),</span>
<a href="#l2.4298"></a><span id="l2.4298" class="difflineplus">+                     nsMsgFolderFlags::Queue);</span>
<a href="#l2.4299"></a><span id="l2.4299"> </span>
<a href="#l2.4300"></a><span id="l2.4300">   if (flags &amp; nsMsgFolderFlags::Junk)</span>
<a href="#l2.4301"></a><span id="l2.4301">     setSubfolderFlag(NS_LITERAL_STRING(&quot;Junk&quot;), nsMsgFolderFlags::Junk);</span>
<a href="#l2.4302"></a><span id="l2.4302"> </span>
<a href="#l2.4303"></a><span id="l2.4303">   if (flags &amp; nsMsgFolderFlags::Archive)</span>
<a href="#l2.4304"></a><span id="l2.4304">     setSubfolderFlag(NS_LITERAL_STRING(&quot;Archives&quot;), nsMsgFolderFlags::Archive);</span>
<a href="#l2.4305"></a><span id="l2.4305"> </span>
<a href="#l2.4306"></a><span id="l2.4306">   return NS_OK;</span>
<a href="#l2.4307"></a><span id="l2.4307"> }</span>
<a href="#l2.4308"></a><span id="l2.4308"> </span>
<a href="#l2.4309"></a><span id="l2.4309" class="difflineminus">-nsresult</span>
<a href="#l2.4310"></a><span id="l2.4310" class="difflineminus">-nsMsgLocalMailFolder::setSubfolderFlag(const nsAString&amp; aFolderName, uint32_t flags)</span>
<a href="#l2.4311"></a><span id="l2.4311" class="difflineminus">-{</span>
<a href="#l2.4312"></a><span id="l2.4312" class="difflineplus">+nsresult nsMsgLocalMailFolder::setSubfolderFlag(const nsAString &amp;aFolderName,</span>
<a href="#l2.4313"></a><span id="l2.4313" class="difflineplus">+                                                uint32_t flags) {</span>
<a href="#l2.4314"></a><span id="l2.4314">   // FindSubFolder() expects the folder name to be escaped</span>
<a href="#l2.4315"></a><span id="l2.4315">   // see bug #192043</span>
<a href="#l2.4316"></a><span id="l2.4316">   nsAutoCString escapedFolderName;</span>
<a href="#l2.4317"></a><span id="l2.4317">   nsresult rv = NS_MsgEscapeEncodeURLPath(aFolderName, escapedFolderName);</span>
<a href="#l2.4318"></a><span id="l2.4318" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4319"></a><span id="l2.4319" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4320"></a><span id="l2.4320">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l2.4321"></a><span id="l2.4321">   rv = FindSubFolder(escapedFolderName, getter_AddRefs(msgFolder));</span>
<a href="#l2.4322"></a><span id="l2.4322">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4323"></a><span id="l2.4323"> </span>
<a href="#l2.4324"></a><span id="l2.4324">   // we only want to do this if the folder *really* exists,</span>
<a href="#l2.4325"></a><span id="l2.4325">   // so check if it has a parent. Otherwise, we'll create the</span>
<a href="#l2.4326"></a><span id="l2.4326">   // .msf file when we don't want to.</span>
<a href="#l2.4327"></a><span id="l2.4327" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l2.4328"></a><span id="l2.4328" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l2.4329"></a><span id="l2.4329">   msgFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l2.4330"></a><span id="l2.4330" class="difflineminus">-  if (!parent)</span>
<a href="#l2.4331"></a><span id="l2.4331" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l2.4332"></a><span id="l2.4332" class="difflineplus">+  if (!parent) return NS_ERROR_FAILURE;</span>
<a href="#l2.4333"></a><span id="l2.4333"> </span>
<a href="#l2.4334"></a><span id="l2.4334">   rv = msgFolder-&gt;SetFlag(flags);</span>
<a href="#l2.4335"></a><span id="l2.4335">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4336"></a><span id="l2.4336">   return msgFolder-&gt;SetPrettyName(aFolderName);</span>
<a href="#l2.4337"></a><span id="l2.4337"> }</span>
<a href="#l2.4338"></a><span id="l2.4338"> </span>
<a href="#l2.4339"></a><span id="l2.4339"> NS_IMETHODIMP</span>
<a href="#l2.4340"></a><span id="l2.4340" class="difflineminus">-nsMsgLocalMailFolder::GetCheckForNewMessagesAfterParsing(bool *aCheckForNewMessagesAfterParsing)</span>
<a href="#l2.4341"></a><span id="l2.4341" class="difflineminus">-{</span>
<a href="#l2.4342"></a><span id="l2.4342" class="difflineplus">+nsMsgLocalMailFolder::GetCheckForNewMessagesAfterParsing(</span>
<a href="#l2.4343"></a><span id="l2.4343" class="difflineplus">+    bool *aCheckForNewMessagesAfterParsing) {</span>
<a href="#l2.4344"></a><span id="l2.4344">   NS_ENSURE_ARG_POINTER(aCheckForNewMessagesAfterParsing);</span>
<a href="#l2.4345"></a><span id="l2.4345">   *aCheckForNewMessagesAfterParsing = mCheckForNewMessagesAfterParsing;</span>
<a href="#l2.4346"></a><span id="l2.4346">   return NS_OK;</span>
<a href="#l2.4347"></a><span id="l2.4347"> }</span>
<a href="#l2.4348"></a><span id="l2.4348"> </span>
<a href="#l2.4349"></a><span id="l2.4349"> NS_IMETHODIMP</span>
<a href="#l2.4350"></a><span id="l2.4350" class="difflineminus">-nsMsgLocalMailFolder::SetCheckForNewMessagesAfterParsing(bool aCheckForNewMessagesAfterParsing)</span>
<a href="#l2.4351"></a><span id="l2.4351" class="difflineminus">-{</span>
<a href="#l2.4352"></a><span id="l2.4352" class="difflineplus">+nsMsgLocalMailFolder::SetCheckForNewMessagesAfterParsing(</span>
<a href="#l2.4353"></a><span id="l2.4353" class="difflineplus">+    bool aCheckForNewMessagesAfterParsing) {</span>
<a href="#l2.4354"></a><span id="l2.4354">   mCheckForNewMessagesAfterParsing = aCheckForNewMessagesAfterParsing;</span>
<a href="#l2.4355"></a><span id="l2.4355">   return NS_OK;</span>
<a href="#l2.4356"></a><span id="l2.4356"> }</span>
<a href="#l2.4357"></a><span id="l2.4357"> </span>
<a href="#l2.4358"></a><span id="l2.4358"> NS_IMETHODIMP</span>
<a href="#l2.4359"></a><span id="l2.4359" class="difflineminus">-nsMsgLocalMailFolder::NotifyCompactCompleted()</span>
<a href="#l2.4360"></a><span id="l2.4360" class="difflineminus">-{</span>
<a href="#l2.4361"></a><span id="l2.4361" class="difflineplus">+nsMsgLocalMailFolder::NotifyCompactCompleted() {</span>
<a href="#l2.4362"></a><span id="l2.4362">   mExpungedBytes = 0;</span>
<a href="#l2.4363"></a><span id="l2.4363" class="difflineminus">-  m_newMsgs.Clear(); // if compacted, m_newMsgs probably aren't valid.</span>
<a href="#l2.4364"></a><span id="l2.4364" class="difflineplus">+  m_newMsgs.Clear();  // if compacted, m_newMsgs probably aren't valid.</span>
<a href="#l2.4365"></a><span id="l2.4365">   // if compacted, processing flags probably also aren't valid.</span>
<a href="#l2.4366"></a><span id="l2.4366">   ClearProcessingFlags();</span>
<a href="#l2.4367"></a><span id="l2.4367" class="difflineminus">-  (void) RefreshSizeOnDisk();</span>
<a href="#l2.4368"></a><span id="l2.4368" class="difflineminus">-  (void) CloseDBIfFolderNotOpen();</span>
<a href="#l2.4369"></a><span id="l2.4369" class="difflineplus">+  (void)RefreshSizeOnDisk();</span>
<a href="#l2.4370"></a><span id="l2.4370" class="difflineplus">+  (void)CloseDBIfFolderNotOpen();</span>
<a href="#l2.4371"></a><span id="l2.4371">   NotifyFolderEvent(kCompactCompleted);</span>
<a href="#l2.4372"></a><span id="l2.4372">   return NS_OK;</span>
<a href="#l2.4373"></a><span id="l2.4373"> }</span>
<a href="#l2.4374"></a><span id="l2.4374"> </span>
<a href="#l2.4375"></a><span id="l2.4375" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::Shutdown(bool shutdownChildren)</span>
<a href="#l2.4376"></a><span id="l2.4376" class="difflineminus">-{</span>
<a href="#l2.4377"></a><span id="l2.4377" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::Shutdown(bool shutdownChildren) {</span>
<a href="#l2.4378"></a><span id="l2.4378">   mInitialized = false;</span>
<a href="#l2.4379"></a><span id="l2.4379">   return nsMsgDBFolder::Shutdown(shutdownChildren);</span>
<a href="#l2.4380"></a><span id="l2.4380"> }</span>
<a href="#l2.4381"></a><span id="l2.4381"> </span>
<a href="#l2.4382"></a><span id="l2.4382"> NS_IMETHODIMP</span>
<a href="#l2.4383"></a><span id="l2.4383"> nsMsgLocalMailFolder::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l2.4384"></a><span id="l2.4384" class="difflineminus">-  nsMsgJunkStatus aClassification,</span>
<a href="#l2.4385"></a><span id="l2.4385" class="difflineminus">-  uint32_t aJunkPercent)</span>
<a href="#l2.4386"></a><span id="l2.4386" class="difflineplus">+                                          nsMsgJunkStatus aClassification,</span>
<a href="#l2.4387"></a><span id="l2.4387" class="difflineplus">+                                          uint32_t aJunkPercent)</span>
<a href="#l2.4388"></a><span id="l2.4388"> </span>
<a href="#l2.4389"></a><span id="l2.4389"> {</span>
<a href="#l2.4390"></a><span id="l2.4390">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.4391"></a><span id="l2.4391">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.4392"></a><span id="l2.4392">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4393"></a><span id="l2.4393"> </span>
<a href="#l2.4394"></a><span id="l2.4394">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l2.4395"></a><span id="l2.4395">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l2.4396"></a><span id="l2.4396">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4397"></a><span id="l2.4397"> </span>
<a href="#l2.4398"></a><span id="l2.4398">   nsCString spamFolderURI;</span>
<a href="#l2.4399"></a><span id="l2.4399">   rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l2.4400"></a><span id="l2.4400" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4401"></a><span id="l2.4401" class="difflineminus">-</span>
<a href="#l2.4402"></a><span id="l2.4402" class="difflineminus">-  if (aMsgURI) // not end of batch</span>
<a href="#l2.4403"></a><span id="l2.4403" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4404"></a><span id="l2.4404" class="difflineplus">+</span>
<a href="#l2.4405"></a><span id="l2.4405" class="difflineplus">+  if (aMsgURI)  // not end of batch</span>
<a href="#l2.4406"></a><span id="l2.4406">   {</span>
<a href="#l2.4407"></a><span id="l2.4407" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.4408"></a><span id="l2.4408" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.4409"></a><span id="l2.4409">     rv = GetMsgDBHdrFromURI(aMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l2.4410"></a><span id="l2.4410">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4411"></a><span id="l2.4411"> </span>
<a href="#l2.4412"></a><span id="l2.4412">     nsMsgKey msgKey;</span>
<a href="#l2.4413"></a><span id="l2.4413">     rv = msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l2.4414"></a><span id="l2.4414">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4415"></a><span id="l2.4415"> </span>
<a href="#l2.4416"></a><span id="l2.4416">     // check if this message needs junk classification</span>
<a href="#l2.4417"></a><span id="l2.4417">     uint32_t processingFlags;</span>
<a href="#l2.4418"></a><span id="l2.4418">     GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l2.4419"></a><span id="l2.4419"> </span>
<a href="#l2.4420"></a><span id="l2.4420" class="difflineminus">-    if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk)</span>
<a href="#l2.4421"></a><span id="l2.4421" class="difflineminus">-    {</span>
<a href="#l2.4422"></a><span id="l2.4422" class="difflineminus">-      nsMsgDBFolder::OnMessageClassified(aMsgURI, aClassification, aJunkPercent);</span>
<a href="#l2.4423"></a><span id="l2.4423" class="difflineminus">-</span>
<a href="#l2.4424"></a><span id="l2.4424" class="difflineminus">-      if (aClassification == nsIJunkMailPlugin::JUNK)</span>
<a href="#l2.4425"></a><span id="l2.4425" class="difflineminus">-      {</span>
<a href="#l2.4426"></a><span id="l2.4426" class="difflineplus">+    if (processingFlags &amp; nsMsgProcessingFlags::ClassifyJunk) {</span>
<a href="#l2.4427"></a><span id="l2.4427" class="difflineplus">+      nsMsgDBFolder::OnMessageClassified(aMsgURI, aClassification,</span>
<a href="#l2.4428"></a><span id="l2.4428" class="difflineplus">+                                         aJunkPercent);</span>
<a href="#l2.4429"></a><span id="l2.4429" class="difflineplus">+</span>
<a href="#l2.4430"></a><span id="l2.4430" class="difflineplus">+      if (aClassification == nsIJunkMailPlugin::JUNK) {</span>
<a href="#l2.4431"></a><span id="l2.4431">         bool willMoveMessage = false;</span>
<a href="#l2.4432"></a><span id="l2.4432"> </span>
<a href="#l2.4433"></a><span id="l2.4433">         // don't do the move when we are opening up</span>
<a href="#l2.4434"></a><span id="l2.4434">         // the junk mail folder or the trash folder</span>
<a href="#l2.4435"></a><span id="l2.4435">         // or when manually classifying messages in those folders</span>
<a href="#l2.4436"></a><span id="l2.4436" class="difflineminus">-        if (!(mFlags &amp; nsMsgFolderFlags::Junk || mFlags &amp; nsMsgFolderFlags::Trash))</span>
<a href="#l2.4437"></a><span id="l2.4437" class="difflineminus">-        {</span>
<a href="#l2.4438"></a><span id="l2.4438" class="difflineplus">+        if (!(mFlags &amp; nsMsgFolderFlags::Junk ||</span>
<a href="#l2.4439"></a><span id="l2.4439" class="difflineplus">+              mFlags &amp; nsMsgFolderFlags::Trash)) {</span>
<a href="#l2.4440"></a><span id="l2.4440">           bool moveOnSpam = false;</span>
<a href="#l2.4441"></a><span id="l2.4441">           rv = spamSettings-&gt;GetMoveOnSpam(&amp;moveOnSpam);</span>
<a href="#l2.4442"></a><span id="l2.4442" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4443"></a><span id="l2.4443" class="difflineminus">-          if (moveOnSpam)</span>
<a href="#l2.4444"></a><span id="l2.4444" class="difflineminus">-          {</span>
<a href="#l2.4445"></a><span id="l2.4445" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4446"></a><span id="l2.4446" class="difflineplus">+          if (moveOnSpam) {</span>
<a href="#l2.4447"></a><span id="l2.4447">             nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l2.4448"></a><span id="l2.4448">             rv = FindFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l2.4449"></a><span id="l2.4449">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4450"></a><span id="l2.4450" class="difflineminus">-            if (folder)</span>
<a href="#l2.4451"></a><span id="l2.4451" class="difflineminus">-            {</span>
<a href="#l2.4452"></a><span id="l2.4452" class="difflineplus">+            if (folder) {</span>
<a href="#l2.4453"></a><span id="l2.4453">               rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l2.4454"></a><span id="l2.4454" class="difflineminus">-              NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4455"></a><span id="l2.4455" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4456"></a><span id="l2.4456">               mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l2.4457"></a><span id="l2.4457">               willMoveMessage = true;</span>
<a href="#l2.4458"></a><span id="l2.4458" class="difflineminus">-            }</span>
<a href="#l2.4459"></a><span id="l2.4459" class="difflineminus">-            else</span>
<a href="#l2.4460"></a><span id="l2.4460" class="difflineminus">-            {</span>
<a href="#l2.4461"></a><span id="l2.4461" class="difflineplus">+            } else {</span>
<a href="#l2.4462"></a><span id="l2.4462">               // XXX TODO</span>
<a href="#l2.4463"></a><span id="l2.4463">               // JUNK MAIL RELATED</span>
<a href="#l2.4464"></a><span id="l2.4464">               // the listener should do</span>
<a href="#l2.4465"></a><span id="l2.4465">               // rv = folder-&gt;SetFlag(nsMsgFolderFlags::Junk);</span>
<a href="#l2.4466"></a><span id="l2.4466">               // NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4467"></a><span id="l2.4467">               // mSpamKeysToMove.AppendElement(msgKey);</span>
<a href="#l2.4468"></a><span id="l2.4468">               // willMoveMessage = true;</span>
<a href="#l2.4469"></a><span id="l2.4469" class="difflineminus">-              rv = GetOrCreateJunkFolder(spamFolderURI, nullptr /* aListener */);</span>
<a href="#l2.4470"></a><span id="l2.4470" class="difflineplus">+              rv =</span>
<a href="#l2.4471"></a><span id="l2.4471" class="difflineplus">+                  GetOrCreateJunkFolder(spamFolderURI, nullptr /* aListener */);</span>
<a href="#l2.4472"></a><span id="l2.4472">               NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateJunkFolder failed&quot;);</span>
<a href="#l2.4473"></a><span id="l2.4473">             }</span>
<a href="#l2.4474"></a><span id="l2.4474">           }</span>
<a href="#l2.4475"></a><span id="l2.4475">         }</span>
<a href="#l2.4476"></a><span id="l2.4476">         rv = spamSettings-&gt;LogJunkHit(msgHdr, willMoveMessage);</span>
<a href="#l2.4477"></a><span id="l2.4477" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4478"></a><span id="l2.4478" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4479"></a><span id="l2.4479">       }</span>
<a href="#l2.4480"></a><span id="l2.4480">     }</span>
<a href="#l2.4481"></a><span id="l2.4481">   }</span>
<a href="#l2.4482"></a><span id="l2.4482"> </span>
<a href="#l2.4483"></a><span id="l2.4483" class="difflineminus">-  else // end of batch</span>
<a href="#l2.4484"></a><span id="l2.4484" class="difflineplus">+  else  // end of batch</span>
<a href="#l2.4485"></a><span id="l2.4485">   {</span>
<a href="#l2.4486"></a><span id="l2.4486">     // Parent will apply post bayes filters.</span>
<a href="#l2.4487"></a><span id="l2.4487" class="difflineminus">-    nsMsgDBFolder::OnMessageClassified(nullptr, nsIJunkMailPlugin::UNCLASSIFIED, 0);</span>
<a href="#l2.4488"></a><span id="l2.4488" class="difflineplus">+    nsMsgDBFolder::OnMessageClassified(nullptr, nsIJunkMailPlugin::UNCLASSIFIED,</span>
<a href="#l2.4489"></a><span id="l2.4489" class="difflineplus">+                                       0);</span>
<a href="#l2.4490"></a><span id="l2.4490">     nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l2.4491"></a><span id="l2.4491" class="difflineminus">-    if (!mSpamKeysToMove.IsEmpty())</span>
<a href="#l2.4492"></a><span id="l2.4492" class="difflineminus">-    {</span>
<a href="#l2.4493"></a><span id="l2.4493" class="difflineplus">+    if (!mSpamKeysToMove.IsEmpty()) {</span>
<a href="#l2.4494"></a><span id="l2.4494">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l2.4495"></a><span id="l2.4495">       if (!spamFolderURI.IsEmpty()) {</span>
<a href="#l2.4496"></a><span id="l2.4496">         rv = FindFolder(spamFolderURI, getter_AddRefs(folder));</span>
<a href="#l2.4497"></a><span id="l2.4497">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4498"></a><span id="l2.4498">       }</span>
<a href="#l2.4499"></a><span id="l2.4499" class="difflineminus">-      for (uint32_t keyIndex = 0; keyIndex &lt; mSpamKeysToMove.Length(); keyIndex++)</span>
<a href="#l2.4500"></a><span id="l2.4500" class="difflineminus">-      {</span>
<a href="#l2.4501"></a><span id="l2.4501" class="difflineplus">+      for (uint32_t keyIndex = 0; keyIndex &lt; mSpamKeysToMove.Length();</span>
<a href="#l2.4502"></a><span id="l2.4502" class="difflineplus">+           keyIndex++) {</span>
<a href="#l2.4503"></a><span id="l2.4503">         // If an upstream filter moved this message, don't move it here.</span>
<a href="#l2.4504"></a><span id="l2.4504">         nsMsgKey msgKey = mSpamKeysToMove.ElementAt(keyIndex);</span>
<a href="#l2.4505"></a><span id="l2.4505">         nsMsgProcessingFlagType processingFlags;</span>
<a href="#l2.4506"></a><span id="l2.4506">         GetProcessingFlags(msgKey, &amp;processingFlags);</span>
<a href="#l2.4507"></a><span id="l2.4507" class="difflineminus">-        if (folder &amp;&amp; !(processingFlags &amp; nsMsgProcessingFlags::FilterToMove))</span>
<a href="#l2.4508"></a><span id="l2.4508" class="difflineminus">-        {</span>
<a href="#l2.4509"></a><span id="l2.4509" class="difflineplus">+        if (folder &amp;&amp; !(processingFlags &amp; nsMsgProcessingFlags::FilterToMove)) {</span>
<a href="#l2.4510"></a><span id="l2.4510">           nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr;</span>
<a href="#l2.4511"></a><span id="l2.4511">           rv = GetMessageHeader(msgKey, getter_AddRefs(mailHdr));</span>
<a href="#l2.4512"></a><span id="l2.4512" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr)</span>
<a href="#l2.4513"></a><span id="l2.4513" class="difflineminus">-            messages-&gt;AppendElement(mailHdr);</span>
<a href="#l2.4514"></a><span id="l2.4514" class="difflineminus">-        }</span>
<a href="#l2.4515"></a><span id="l2.4515" class="difflineminus">-        else</span>
<a href="#l2.4516"></a><span id="l2.4516" class="difflineminus">-        {</span>
<a href="#l2.4517"></a><span id="l2.4517" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; mailHdr) messages-&gt;AppendElement(mailHdr);</span>
<a href="#l2.4518"></a><span id="l2.4518" class="difflineplus">+        } else {</span>
<a href="#l2.4519"></a><span id="l2.4519">           // We don't need the processing flag any more.</span>
<a href="#l2.4520"></a><span id="l2.4520">           AndProcessingFlags(msgKey, ~nsMsgProcessingFlags::FilterToMove);</span>
<a href="#l2.4521"></a><span id="l2.4521">         }</span>
<a href="#l2.4522"></a><span id="l2.4522">       }</span>
<a href="#l2.4523"></a><span id="l2.4523"> </span>
<a href="#l2.4524"></a><span id="l2.4524" class="difflineminus">-      if (folder)</span>
<a href="#l2.4525"></a><span id="l2.4525" class="difflineminus">-      {</span>
<a href="#l2.4526"></a><span id="l2.4526" class="difflineminus">-        nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.4527"></a><span id="l2.4527" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4528"></a><span id="l2.4528" class="difflineminus">-</span>
<a href="#l2.4529"></a><span id="l2.4529" class="difflineminus">-        rv = copySvc-&gt;CopyMessages(this, messages, folder, true,</span>
<a href="#l2.4530"></a><span id="l2.4530" class="difflineminus">-          /*nsIMsgCopyServiceListener* listener*/ nullptr, nullptr, false /*allowUndo*/);</span>
<a href="#l2.4531"></a><span id="l2.4531" class="difflineplus">+      if (folder) {</span>
<a href="#l2.4532"></a><span id="l2.4532" class="difflineplus">+        nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc =</span>
<a href="#l2.4533"></a><span id="l2.4533" class="difflineplus">+            do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l2.4534"></a><span id="l2.4534" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4535"></a><span id="l2.4535" class="difflineplus">+</span>
<a href="#l2.4536"></a><span id="l2.4536" class="difflineplus">+        rv = copySvc-&gt;CopyMessages(</span>
<a href="#l2.4537"></a><span id="l2.4537" class="difflineplus">+            this, messages, folder, true,</span>
<a href="#l2.4538"></a><span id="l2.4538" class="difflineplus">+            /*nsIMsgCopyServiceListener* listener*/ nullptr, nullptr,</span>
<a href="#l2.4539"></a><span id="l2.4539" class="difflineplus">+            false /*allowUndo*/);</span>
<a href="#l2.4540"></a><span id="l2.4540">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CopyMessages failed&quot;);</span>
<a href="#l2.4541"></a><span id="l2.4541" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l2.4542"></a><span id="l2.4542" class="difflineminus">-        {</span>
<a href="#l2.4543"></a><span id="l2.4543" class="difflineminus">-          nsAutoCString logMsg(&quot;failed to copy junk messages to junk folder rv = &quot;);</span>
<a href="#l2.4544"></a><span id="l2.4544" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l2.4545"></a><span id="l2.4545" class="difflineplus">+          nsAutoCString logMsg(</span>
<a href="#l2.4546"></a><span id="l2.4546" class="difflineplus">+              &quot;failed to copy junk messages to junk folder rv = &quot;);</span>
<a href="#l2.4547"></a><span id="l2.4547">           logMsg.AppendInt(static_cast&lt;uint32_t&gt;(rv), 16);</span>
<a href="#l2.4548"></a><span id="l2.4548">           spamSettings-&gt;LogJunkString(logMsg.get());</span>
<a href="#l2.4549"></a><span id="l2.4549">         }</span>
<a href="#l2.4550"></a><span id="l2.4550">       }</span>
<a href="#l2.4551"></a><span id="l2.4551">     }</span>
<a href="#l2.4552"></a><span id="l2.4552">     int32_t numNewMessages;</span>
<a href="#l2.4553"></a><span id="l2.4553">     GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l2.4554"></a><span id="l2.4554">     uint32_t length;</span>
<a href="#l2.4555"></a><span id="l2.4555">     messages-&gt;GetLength(&amp;length);</span>
<a href="#l2.4556"></a><span id="l2.4556">     SetNumNewMessages(numNewMessages - length);</span>
<a href="#l2.4557"></a><span id="l2.4557">     mSpamKeysToMove.Clear();</span>
<a href="#l2.4558"></a><span id="l2.4558">     // check if this is the inbox first...</span>
<a href="#l2.4559"></a><span id="l2.4559" class="difflineminus">-    if (mFlags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l2.4560"></a><span id="l2.4560" class="difflineminus">-      PerformBiffNotifications();</span>
<a href="#l2.4561"></a><span id="l2.4561" class="difflineplus">+    if (mFlags &amp; nsMsgFolderFlags::Inbox) PerformBiffNotifications();</span>
<a href="#l2.4562"></a><span id="l2.4562">   }</span>
<a href="#l2.4563"></a><span id="l2.4563">   return NS_OK;</span>
<a href="#l2.4564"></a><span id="l2.4564"> }</span>
<a href="#l2.4565"></a><span id="l2.4565"> </span>
<a href="#l2.4566"></a><span id="l2.4566"> NS_IMETHODIMP</span>
<a href="#l2.4567"></a><span id="l2.4567" class="difflineminus">-nsMsgLocalMailFolder::GetFolderScanState(nsLocalFolderScanState *aState)</span>
<a href="#l2.4568"></a><span id="l2.4568" class="difflineminus">-{</span>
<a href="#l2.4569"></a><span id="l2.4569" class="difflineplus">+nsMsgLocalMailFolder::GetFolderScanState(nsLocalFolderScanState *aState) {</span>
<a href="#l2.4570"></a><span id="l2.4570">   NS_ENSURE_ARG_POINTER(aState);</span>
<a href="#l2.4571"></a><span id="l2.4571"> </span>
<a href="#l2.4572"></a><span id="l2.4572">   nsresult rv = GetMsgStore(getter_AddRefs(aState-&gt;m_msgStore));</span>
<a href="#l2.4573"></a><span id="l2.4573">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4574"></a><span id="l2.4574" class="difflineminus">-    aState-&gt;m_uidl = nullptr;</span>
<a href="#l2.4575"></a><span id="l2.4575" class="difflineplus">+  aState-&gt;m_uidl = nullptr;</span>
<a href="#l2.4576"></a><span id="l2.4576">   return rv;</span>
<a href="#l2.4577"></a><span id="l2.4577"> }</span>
<a href="#l2.4578"></a><span id="l2.4578"> </span>
<a href="#l2.4579"></a><span id="l2.4579"> NS_IMETHODIMP</span>
<a href="#l2.4580"></a><span id="l2.4580" class="difflineminus">-nsMsgLocalMailFolder::GetUidlFromFolder(nsLocalFolderScanState *aState, nsIMsgDBHdr *aMsgDBHdr)</span>
<a href="#l2.4581"></a><span id="l2.4581" class="difflineminus">-{</span>
<a href="#l2.4582"></a><span id="l2.4582" class="difflineplus">+nsMsgLocalMailFolder::GetUidlFromFolder(nsLocalFolderScanState *aState,</span>
<a href="#l2.4583"></a><span id="l2.4583" class="difflineplus">+                                        nsIMsgDBHdr *aMsgDBHdr) {</span>
<a href="#l2.4584"></a><span id="l2.4584">   bool more = false;</span>
<a href="#l2.4585"></a><span id="l2.4585">   uint32_t size = 0, len = 0;</span>
<a href="#l2.4586"></a><span id="l2.4586">   const char *accountKey = nullptr;</span>
<a href="#l2.4587"></a><span id="l2.4587">   nsresult rv = GetMsgInputStream(aMsgDBHdr, &amp;aState-&gt;m_streamReusable,</span>
<a href="#l2.4588"></a><span id="l2.4588">                                   getter_AddRefs(aState-&gt;m_inputStream));</span>
<a href="#l2.4589"></a><span id="l2.4589">   aState-&gt;m_seekableStream = do_QueryInterface(aState-&gt;m_inputStream);</span>
<a href="#l2.4590"></a><span id="l2.4590" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4591"></a><span id="l2.4591" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4592"></a><span id="l2.4592"> </span>
<a href="#l2.4593"></a><span id="l2.4593">   nsAutoPtr&lt;nsLineBuffer&lt;char&gt; &gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l2.4594"></a><span id="l2.4594">   NS_ENSURE_TRUE(lineBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.4595"></a><span id="l2.4595"> </span>
<a href="#l2.4596"></a><span id="l2.4596">   aState-&gt;m_uidl = nullptr;</span>
<a href="#l2.4597"></a><span id="l2.4597"> </span>
<a href="#l2.4598"></a><span id="l2.4598">   aMsgDBHdr-&gt;GetMessageSize(&amp;len);</span>
<a href="#l2.4599"></a><span id="l2.4599" class="difflineminus">-  while (len &gt; 0)</span>
<a href="#l2.4600"></a><span id="l2.4600" class="difflineminus">-  {</span>
<a href="#l2.4601"></a><span id="l2.4601" class="difflineminus">-    rv = NS_ReadLine(aState-&gt;m_inputStream.get(), lineBuffer.get(), aState-&gt;m_header, &amp;more);</span>
<a href="#l2.4602"></a><span id="l2.4602" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4603"></a><span id="l2.4603" class="difflineminus">-    {</span>
<a href="#l2.4604"></a><span id="l2.4604" class="difflineplus">+  while (len &gt; 0) {</span>
<a href="#l2.4605"></a><span id="l2.4605" class="difflineplus">+    rv = NS_ReadLine(aState-&gt;m_inputStream.get(), lineBuffer.get(),</span>
<a href="#l2.4606"></a><span id="l2.4606" class="difflineplus">+                     aState-&gt;m_header, &amp;more);</span>
<a href="#l2.4607"></a><span id="l2.4607" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4608"></a><span id="l2.4608">       size = aState-&gt;m_header.Length();</span>
<a href="#l2.4609"></a><span id="l2.4609" class="difflineminus">-      if (!size)</span>
<a href="#l2.4610"></a><span id="l2.4610" class="difflineminus">-        break;</span>
<a href="#l2.4611"></a><span id="l2.4611" class="difflineplus">+      if (!size) break;</span>
<a href="#l2.4612"></a><span id="l2.4612">       // this isn't quite right - need to account for line endings</span>
<a href="#l2.4613"></a><span id="l2.4613">       len -= size;</span>
<a href="#l2.4614"></a><span id="l2.4614">       // account key header will always be before X_UIDL header</span>
<a href="#l2.4615"></a><span id="l2.4615" class="difflineminus">-      if (!accountKey)</span>
<a href="#l2.4616"></a><span id="l2.4616" class="difflineminus">-      {</span>
<a href="#l2.4617"></a><span id="l2.4617" class="difflineminus">-        accountKey = strstr(aState-&gt;m_header.get(), HEADER_X_MOZILLA_ACCOUNT_KEY);</span>
<a href="#l2.4618"></a><span id="l2.4618" class="difflineminus">-        if (accountKey)</span>
<a href="#l2.4619"></a><span id="l2.4619" class="difflineminus">-        {</span>
<a href="#l2.4620"></a><span id="l2.4620" class="difflineplus">+      if (!accountKey) {</span>
<a href="#l2.4621"></a><span id="l2.4621" class="difflineplus">+        accountKey =</span>
<a href="#l2.4622"></a><span id="l2.4622" class="difflineplus">+            strstr(aState-&gt;m_header.get(), HEADER_X_MOZILLA_ACCOUNT_KEY);</span>
<a href="#l2.4623"></a><span id="l2.4623" class="difflineplus">+        if (accountKey) {</span>
<a href="#l2.4624"></a><span id="l2.4624">           accountKey += strlen(HEADER_X_MOZILLA_ACCOUNT_KEY) + 2;</span>
<a href="#l2.4625"></a><span id="l2.4625">           aState-&gt;m_accountKey = accountKey;</span>
<a href="#l2.4626"></a><span id="l2.4626">         }</span>
<a href="#l2.4627"></a><span id="l2.4627" class="difflineminus">-      }</span>
<a href="#l2.4628"></a><span id="l2.4628" class="difflineminus">-      else</span>
<a href="#l2.4629"></a><span id="l2.4629" class="difflineminus">-      {</span>
<a href="#l2.4630"></a><span id="l2.4630" class="difflineplus">+      } else {</span>
<a href="#l2.4631"></a><span id="l2.4631">         aState-&gt;m_uidl = strstr(aState-&gt;m_header.get(), X_UIDL);</span>
<a href="#l2.4632"></a><span id="l2.4632" class="difflineminus">-        if (aState-&gt;m_uidl)</span>
<a href="#l2.4633"></a><span id="l2.4633" class="difflineminus">-        {</span>
<a href="#l2.4634"></a><span id="l2.4634" class="difflineminus">-          aState-&gt;m_uidl += X_UIDL_LEN + 2; // skip UIDL: header</span>
<a href="#l2.4635"></a><span id="l2.4635" class="difflineplus">+        if (aState-&gt;m_uidl) {</span>
<a href="#l2.4636"></a><span id="l2.4636" class="difflineplus">+          aState-&gt;m_uidl += X_UIDL_LEN + 2;  // skip UIDL: header</span>
<a href="#l2.4637"></a><span id="l2.4637">           break;</span>
<a href="#l2.4638"></a><span id="l2.4638">         }</span>
<a href="#l2.4639"></a><span id="l2.4639">       }</span>
<a href="#l2.4640"></a><span id="l2.4640">     }</span>
<a href="#l2.4641"></a><span id="l2.4641">   }</span>
<a href="#l2.4642"></a><span id="l2.4642" class="difflineminus">-  if (!aState-&gt;m_streamReusable)</span>
<a href="#l2.4643"></a><span id="l2.4643" class="difflineminus">-  {</span>
<a href="#l2.4644"></a><span id="l2.4644" class="difflineplus">+  if (!aState-&gt;m_streamReusable) {</span>
<a href="#l2.4645"></a><span id="l2.4645">     aState-&gt;m_inputStream-&gt;Close();</span>
<a href="#l2.4646"></a><span id="l2.4646">     aState-&gt;m_inputStream = nullptr;</span>
<a href="#l2.4647"></a><span id="l2.4647">   }</span>
<a href="#l2.4648"></a><span id="l2.4648">   lineBuffer = nullptr;</span>
<a href="#l2.4649"></a><span id="l2.4649">   return rv;</span>
<a href="#l2.4650"></a><span id="l2.4650"> }</span>
<a href="#l2.4651"></a><span id="l2.4651"> </span>
<a href="#l2.4652"></a><span id="l2.4652"> /**</span>
<a href="#l2.4653"></a><span id="l2.4653">  * Adds a message to the end of the folder, parsing it as it goes, and</span>
<a href="#l2.4654"></a><span id="l2.4654">  * applying filters, if applicable.</span>
<a href="#l2.4655"></a><span id="l2.4655">  */</span>
<a href="#l2.4656"></a><span id="l2.4656"> NS_IMETHODIMP</span>
<a href="#l2.4657"></a><span id="l2.4657" class="difflineminus">-nsMsgLocalMailFolder::AddMessage(const char *aMessage, nsIMsgDBHdr **aHdr)</span>
<a href="#l2.4658"></a><span id="l2.4658" class="difflineminus">-{</span>
<a href="#l2.4659"></a><span id="l2.4659" class="difflineplus">+nsMsgLocalMailFolder::AddMessage(const char *aMessage, nsIMsgDBHdr **aHdr) {</span>
<a href="#l2.4660"></a><span id="l2.4660">   const char *aMessages[] = {aMessage};</span>
<a href="#l2.4661"></a><span id="l2.4661">   nsCOMPtr&lt;nsIArray&gt; hdrs;</span>
<a href="#l2.4662"></a><span id="l2.4662">   nsresult rv = AddMessageBatch(1, aMessages, getter_AddRefs(hdrs));</span>
<a href="#l2.4663"></a><span id="l2.4663">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4664"></a><span id="l2.4664">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr(do_QueryElementAt(hdrs, 0, &amp;rv));</span>
<a href="#l2.4665"></a><span id="l2.4665">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4666"></a><span id="l2.4666">   hdr.forget(aHdr);</span>
<a href="#l2.4667"></a><span id="l2.4667">   return rv;</span>
<a href="#l2.4668"></a><span id="l2.4668"> }</span>
<a href="#l2.4669"></a><span id="l2.4669"> </span>
<a href="#l2.4670"></a><span id="l2.4670"> NS_IMETHODIMP</span>
<a href="#l2.4671"></a><span id="l2.4671"> nsMsgLocalMailFolder::AddMessageBatch(uint32_t aMessageCount,</span>
<a href="#l2.4672"></a><span id="l2.4672">                                       const char **aMessages,</span>
<a href="#l2.4673"></a><span id="l2.4673" class="difflineminus">-                                      nsIArray **aHdrArray)</span>
<a href="#l2.4674"></a><span id="l2.4674" class="difflineminus">-{</span>
<a href="#l2.4675"></a><span id="l2.4675" class="difflineplus">+                                      nsIArray **aHdrArray) {</span>
<a href="#l2.4676"></a><span id="l2.4676">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l2.4677"></a><span id="l2.4677"> </span>
<a href="#l2.4678"></a><span id="l2.4678">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.4679"></a><span id="l2.4679">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l2.4680"></a><span id="l2.4680">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4681"></a><span id="l2.4681"> </span>
<a href="#l2.4682"></a><span id="l2.4682">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.4683"></a><span id="l2.4683" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outFileStream;</span>
<a href="#l2.4684"></a><span id="l2.4684" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outFileStream;</span>
<a href="#l2.4685"></a><span id="l2.4685">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l2.4686"></a><span id="l2.4686"> </span>
<a href="#l2.4687"></a><span id="l2.4687">   rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.4688"></a><span id="l2.4688">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4689"></a><span id="l2.4689"> </span>
<a href="#l2.4690"></a><span id="l2.4690">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l2.4691"></a><span id="l2.4691">   rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l2.4692"></a><span id="l2.4692">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4693"></a><span id="l2.4693"> </span>
<a href="#l2.4694"></a><span id="l2.4694">   bool isLocked;</span>
<a href="#l2.4695"></a><span id="l2.4695"> </span>
<a href="#l2.4696"></a><span id="l2.4696">   GetLocked(&amp;isLocked);</span>
<a href="#l2.4697"></a><span id="l2.4697" class="difflineminus">-  if (isLocked)</span>
<a href="#l2.4698"></a><span id="l2.4698" class="difflineminus">-    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l2.4699"></a><span id="l2.4699" class="difflineminus">-</span>
<a href="#l2.4700"></a><span id="l2.4700" class="difflineminus">-  AcquireSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l2.4701"></a><span id="l2.4701" class="difflineminus">-</span>
<a href="#l2.4702"></a><span id="l2.4702" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4703"></a><span id="l2.4703" class="difflineminus">-  {</span>
<a href="#l2.4704"></a><span id="l2.4704" class="difflineplus">+  if (isLocked) return NS_MSG_FOLDER_BUSY;</span>
<a href="#l2.4705"></a><span id="l2.4705" class="difflineplus">+</span>
<a href="#l2.4706"></a><span id="l2.4706" class="difflineplus">+  AcquireSemaphore(static_cast&lt;nsIMsgLocalMailFolder *&gt;(this));</span>
<a href="#l2.4707"></a><span id="l2.4707" class="difflineplus">+</span>
<a href="#l2.4708"></a><span id="l2.4708" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l2.4709"></a><span id="l2.4709">     nsCOMPtr&lt;nsIMutableArray&gt; hdrArray =</span>
<a href="#l2.4710"></a><span id="l2.4710" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l2.4711"></a><span id="l2.4711" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l2.4712"></a><span id="l2.4712">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4713"></a><span id="l2.4713" class="difflineminus">-    for (uint32_t i = 0; i &lt; aMessageCount; i++)</span>
<a href="#l2.4714"></a><span id="l2.4714" class="difflineminus">-    {</span>
<a href="#l2.4715"></a><span id="l2.4715" class="difflineplus">+    for (uint32_t i = 0; i &lt; aMessageCount; i++) {</span>
<a href="#l2.4716"></a><span id="l2.4716">       RefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l2.4717"></a><span id="l2.4717">       NS_ENSURE_TRUE(newMailParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l2.4718"></a><span id="l2.4718" class="difflineminus">-      if (!mGettingNewMessages)</span>
<a href="#l2.4719"></a><span id="l2.4719" class="difflineminus">-        newMailParser-&gt;DisableFilters();</span>
<a href="#l2.4720"></a><span id="l2.4720" class="difflineplus">+      if (!mGettingNewMessages) newMailParser-&gt;DisableFilters();</span>
<a href="#l2.4721"></a><span id="l2.4721">       bool reusable;</span>
<a href="#l2.4722"></a><span id="l2.4722">       rv = msgStore-&gt;GetNewMsgOutputStream(this, getter_AddRefs(newHdr),</span>
<a href="#l2.4723"></a><span id="l2.4723" class="difflineminus">-                                      &amp;reusable,</span>
<a href="#l2.4724"></a><span id="l2.4724" class="difflineminus">-                                      getter_AddRefs(outFileStream));</span>
<a href="#l2.4725"></a><span id="l2.4725" class="difflineplus">+                                           &amp;reusable,</span>
<a href="#l2.4726"></a><span id="l2.4726" class="difflineplus">+                                           getter_AddRefs(outFileStream));</span>
<a href="#l2.4727"></a><span id="l2.4727">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4728"></a><span id="l2.4728"> </span>
<a href="#l2.4729"></a><span id="l2.4729" class="difflineminus">-      // Get a msgWindow. Proceed without one, but filter actions to imap folders</span>
<a href="#l2.4730"></a><span id="l2.4730" class="difflineminus">-      // will silently fail if not signed in and no window for a prompt.</span>
<a href="#l2.4731"></a><span id="l2.4731" class="difflineplus">+      // Get a msgWindow. Proceed without one, but filter actions to imap</span>
<a href="#l2.4732"></a><span id="l2.4732" class="difflineplus">+      // folders will silently fail if not signed in and no window for a prompt.</span>
<a href="#l2.4733"></a><span id="l2.4733">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l2.4734"></a><span id="l2.4734" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l2.4735"></a><span id="l2.4735" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l2.4736"></a><span id="l2.4736" class="difflineplus">+          do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l2.4737"></a><span id="l2.4737">       if (NS_SUCCEEDED(rv))</span>
<a href="#l2.4738"></a><span id="l2.4738">         mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l2.4739"></a><span id="l2.4739"> </span>
<a href="#l2.4740"></a><span id="l2.4740" class="difflineminus">-      rv = newMailParser-&gt;Init(rootFolder, this,</span>
<a href="#l2.4741"></a><span id="l2.4741" class="difflineminus">-                               msgWindow, newHdr, outFileStream);</span>
<a href="#l2.4742"></a><span id="l2.4742" class="difflineplus">+      rv = newMailParser-&gt;Init(rootFolder, this, msgWindow, newHdr,</span>
<a href="#l2.4743"></a><span id="l2.4743" class="difflineplus">+                               outFileStream);</span>
<a href="#l2.4744"></a><span id="l2.4744"> </span>
<a href="#l2.4745"></a><span id="l2.4745">       uint32_t bytesWritten, messageLen = strlen(aMessages[i]);</span>
<a href="#l2.4746"></a><span id="l2.4746">       outFileStream-&gt;Write(aMessages[i], messageLen, &amp;bytesWritten);</span>
<a href="#l2.4747"></a><span id="l2.4747">       newMailParser-&gt;BufferInput(aMessages[i], messageLen);</span>
<a href="#l2.4748"></a><span id="l2.4748"> </span>
<a href="#l2.4749"></a><span id="l2.4749">       FinishNewLocalMessage(outFileStream, newHdr, msgStore, newMailParser);</span>
<a href="#l2.4750"></a><span id="l2.4750">       outFileStream-&gt;Close();</span>
<a href="#l2.4751"></a><span id="l2.4751">       outFileStream = nullptr;</span>
<a href="#l2.4752"></a><span id="l2.4752">       newMailParser-&gt;OnStopRequest(nullptr, NS_OK);</span>
<a href="#l2.4753"></a><span id="l2.4753">       newMailParser-&gt;EndMsgDownload();</span>
<a href="#l2.4754"></a><span id="l2.4754">       hdrArray-&gt;AppendElement(newHdr);</span>
<a href="#l2.4755"></a><span id="l2.4755">     }</span>
<a href="#l2.4756"></a><span id="l2.4756">     hdrArray.forget(aHdrArray);</span>
<a href="#l2.4757"></a><span id="l2.4757">   }</span>
<a href="#l2.4758"></a><span id="l2.4758" class="difflineminus">-  ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l2.4759"></a><span id="l2.4759" class="difflineplus">+  ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder *&gt;(this));</span>
<a href="#l2.4760"></a><span id="l2.4760">   return rv;</span>
<a href="#l2.4761"></a><span id="l2.4761"> }</span>
<a href="#l2.4762"></a><span id="l2.4762"> </span>
<a href="#l2.4763"></a><span id="l2.4763" class="difflineminus">-nsresult</span>
<a href="#l2.4764"></a><span id="l2.4764" class="difflineminus">-nsMsgLocalMailFolder::FinishNewLocalMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l2.4765"></a><span id="l2.4765" class="difflineminus">-                                            nsIMsgDBHdr *aNewHdr,</span>
<a href="#l2.4766"></a><span id="l2.4766" class="difflineminus">-                                            nsIMsgPluggableStore *aMsgStore,</span>
<a href="#l2.4767"></a><span id="l2.4767" class="difflineminus">-                                            nsParseMailMessageState *aParseMsgState)</span>
<a href="#l2.4768"></a><span id="l2.4768" class="difflineminus">-{</span>
<a href="#l2.4769"></a><span id="l2.4769" class="difflineplus">+nsresult nsMsgLocalMailFolder::FinishNewLocalMessage(</span>
<a href="#l2.4770"></a><span id="l2.4770" class="difflineplus">+    nsIOutputStream *aOutputStream, nsIMsgDBHdr *aNewHdr,</span>
<a href="#l2.4771"></a><span id="l2.4771" class="difflineplus">+    nsIMsgPluggableStore *aMsgStore, nsParseMailMessageState *aParseMsgState) {</span>
<a href="#l2.4772"></a><span id="l2.4772">   uint32_t bytesWritten;</span>
<a href="#l2.4773"></a><span id="l2.4773">   aOutputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;bytesWritten);</span>
<a href="#l2.4774"></a><span id="l2.4774">   if (aParseMsgState)</span>
<a href="#l2.4775"></a><span id="l2.4775">     aParseMsgState-&gt;ParseAFolderLine(MSG_LINEBREAK, MSG_LINEBREAK_LEN);</span>
<a href="#l2.4776"></a><span id="l2.4776">   return aMsgStore-&gt;FinishNewMessage(aOutputStream, aNewHdr);</span>
<a href="#l2.4777"></a><span id="l2.4777"> }</span>
<a href="#l2.4778"></a><span id="l2.4778"> </span>
<a href="#l2.4779"></a><span id="l2.4779"> NS_IMETHODIMP</span>
<a href="#l2.4780"></a><span id="l2.4780"> nsMsgLocalMailFolder::WarnIfLocalFileTooBig(nsIMsgWindow *aWindow,</span>
<a href="#l2.4781"></a><span id="l2.4781">                                             int64_t aSpaceRequested,</span>
<a href="#l2.4782"></a><span id="l2.4782" class="difflineminus">-                                            bool *aTooBig)</span>
<a href="#l2.4783"></a><span id="l2.4783" class="difflineminus">-{</span>
<a href="#l2.4784"></a><span id="l2.4784" class="difflineplus">+                                            bool *aTooBig) {</span>
<a href="#l2.4785"></a><span id="l2.4785">   NS_ENSURE_ARG_POINTER(aTooBig);</span>
<a href="#l2.4786"></a><span id="l2.4786"> </span>
<a href="#l2.4787"></a><span id="l2.4787">   *aTooBig = true;</span>
<a href="#l2.4788"></a><span id="l2.4788">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.4789"></a><span id="l2.4789">   nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.4790"></a><span id="l2.4790">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4791"></a><span id="l2.4791">   bool spaceAvailable = false;</span>
<a href="#l2.4792"></a><span id="l2.4792">   // check if we have a reasonable amount of space left</span>
<a href="#l2.4793"></a><span id="l2.4793" class="difflineat">@@ -3722,71 +3447,69 @@ nsMsgLocalMailFolder::WarnIfLocalFileToo</span>
<a href="#l2.4794"></a><span id="l2.4794">   } else if (rv == NS_ERROR_FILE_TOO_BIG) {</span>
<a href="#l2.4795"></a><span id="l2.4795">     ThrowAlertMsg(&quot;mailboxTooLarge&quot;, aWindow);</span>
<a href="#l2.4796"></a><span id="l2.4796">   } else {</span>
<a href="#l2.4797"></a><span id="l2.4797">     ThrowAlertMsg(&quot;outOfDiskSpace&quot;, aWindow);</span>
<a href="#l2.4798"></a><span id="l2.4798">   }</span>
<a href="#l2.4799"></a><span id="l2.4799">   return NS_OK;</span>
<a href="#l2.4800"></a><span id="l2.4800"> }</span>
<a href="#l2.4801"></a><span id="l2.4801"> </span>
<a href="#l2.4802"></a><span id="l2.4802" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::FetchMsgPreviewText(nsMsgKey *aKeysToFetch, uint32_t aNumKeys,</span>
<a href="#l2.4803"></a><span id="l2.4803" class="difflineminus">-                                                 bool aLocalOnly, nsIUrlListener *aUrlListener,</span>
<a href="#l2.4804"></a><span id="l2.4804" class="difflineminus">-                                                 bool *aAsyncResults)</span>
<a href="#l2.4805"></a><span id="l2.4805" class="difflineminus">-{</span>
<a href="#l2.4806"></a><span id="l2.4806" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::FetchMsgPreviewText(</span>
<a href="#l2.4807"></a><span id="l2.4807" class="difflineplus">+    nsMsgKey *aKeysToFetch, uint32_t aNumKeys, bool aLocalOnly,</span>
<a href="#l2.4808"></a><span id="l2.4808" class="difflineplus">+    nsIUrlListener *aUrlListener, bool *aAsyncResults) {</span>
<a href="#l2.4809"></a><span id="l2.4809">   NS_ENSURE_ARG_POINTER(aKeysToFetch);</span>
<a href="#l2.4810"></a><span id="l2.4810">   NS_ENSURE_ARG_POINTER(aAsyncResults);</span>
<a href="#l2.4811"></a><span id="l2.4811"> </span>
<a href="#l2.4812"></a><span id="l2.4812">   *aAsyncResults = false;</span>
<a href="#l2.4813"></a><span id="l2.4813" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l2.4814"></a><span id="l2.4814" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l2.4815"></a><span id="l2.4815">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.4816"></a><span id="l2.4816">   nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.4817"></a><span id="l2.4817">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4818"></a><span id="l2.4818"> </span>
<a href="#l2.4819"></a><span id="l2.4819" class="difflineminus">-  for (uint32_t i = 0; i &lt; aNumKeys; i++)</span>
<a href="#l2.4820"></a><span id="l2.4820" class="difflineminus">-  {</span>
<a href="#l2.4821"></a><span id="l2.4821" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.4822"></a><span id="l2.4822" class="difflineplus">+  for (uint32_t i = 0; i &lt; aNumKeys; i++) {</span>
<a href="#l2.4823"></a><span id="l2.4823" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l2.4824"></a><span id="l2.4824">     nsCString prevBody;</span>
<a href="#l2.4825"></a><span id="l2.4825">     rv = GetMessageHeader(aKeysToFetch[i], getter_AddRefs(msgHdr));</span>
<a href="#l2.4826"></a><span id="l2.4826">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4827"></a><span id="l2.4827">     // ignore messages that already have a preview body.</span>
<a href="#l2.4828"></a><span id="l2.4828">     msgHdr-&gt;GetStringProperty(&quot;preview&quot;, getter_Copies(prevBody));</span>
<a href="#l2.4829"></a><span id="l2.4829" class="difflineminus">-    if (!prevBody.IsEmpty())</span>
<a href="#l2.4830"></a><span id="l2.4830" class="difflineminus">-      continue;</span>
<a href="#l2.4831"></a><span id="l2.4831" class="difflineplus">+    if (!prevBody.IsEmpty()) continue;</span>
<a href="#l2.4832"></a><span id="l2.4832"> </span>
<a href="#l2.4833"></a><span id="l2.4833">     bool reusable;</span>
<a href="#l2.4834"></a><span id="l2.4834">     rv = GetMsgInputStream(msgHdr, &amp;reusable, getter_AddRefs(inputStream));</span>
<a href="#l2.4835"></a><span id="l2.4835" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l2.4836"></a><span id="l2.4836" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4837"></a><span id="l2.4837">     rv = GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l2.4838"></a><span id="l2.4838">   }</span>
<a href="#l2.4839"></a><span id="l2.4839">   return rv;</span>
<a href="#l2.4840"></a><span id="l2.4840"> }</span>
<a href="#l2.4841"></a><span id="l2.4841"> </span>
<a href="#l2.4842"></a><span id="l2.4842" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l2.4843"></a><span id="l2.4843" class="difflineminus">-{</span>
<a href="#l2.4844"></a><span id="l2.4844" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::AddKeywordsToMessages(</span>
<a href="#l2.4845"></a><span id="l2.4845" class="difflineplus">+    nsIArray *aMessages, const nsACString &amp;aKeywords) {</span>
<a href="#l2.4846"></a><span id="l2.4846">   return ChangeKeywordForMessages(aMessages, aKeywords, true /* add */);</span>
<a href="#l2.4847"></a><span id="l2.4847"> }</span>
<a href="#l2.4848"></a><span id="l2.4848" class="difflineminus">-nsresult nsMsgLocalMailFolder::ChangeKeywordForMessages(nsIArray *aMessages, const nsACString&amp; aKeywords, bool add)</span>
<a href="#l2.4849"></a><span id="l2.4849" class="difflineminus">-{</span>
<a href="#l2.4850"></a><span id="l2.4850" class="difflineminus">-  nsresult rv = (add) ? nsMsgDBFolder::AddKeywordsToMessages(aMessages, aKeywords)</span>
<a href="#l2.4851"></a><span id="l2.4851" class="difflineminus">-                      : nsMsgDBFolder::RemoveKeywordsFromMessages(aMessages, aKeywords);</span>
<a href="#l2.4852"></a><span id="l2.4852" class="difflineminus">-</span>
<a href="#l2.4853"></a><span id="l2.4853" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4854"></a><span id="l2.4854" class="difflineplus">+nsresult nsMsgLocalMailFolder::ChangeKeywordForMessages(</span>
<a href="#l2.4855"></a><span id="l2.4855" class="difflineplus">+    nsIArray *aMessages, const nsACString &amp;aKeywords, bool add) {</span>
<a href="#l2.4856"></a><span id="l2.4856" class="difflineplus">+  nsresult rv =</span>
<a href="#l2.4857"></a><span id="l2.4857" class="difflineplus">+      (add) ? nsMsgDBFolder::AddKeywordsToMessages(aMessages, aKeywords)</span>
<a href="#l2.4858"></a><span id="l2.4858" class="difflineplus">+            : nsMsgDBFolder::RemoveKeywordsFromMessages(aMessages, aKeywords);</span>
<a href="#l2.4859"></a><span id="l2.4859" class="difflineplus">+</span>
<a href="#l2.4860"></a><span id="l2.4860" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4861"></a><span id="l2.4861">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l2.4862"></a><span id="l2.4862">   GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l2.4863"></a><span id="l2.4863" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4864"></a><span id="l2.4864" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.4865"></a><span id="l2.4865">   return msgStore-&gt;ChangeKeywords(aMessages, aKeywords, add);</span>
<a href="#l2.4866"></a><span id="l2.4866"> }</span>
<a href="#l2.4867"></a><span id="l2.4867"> </span>
<a href="#l2.4868"></a><span id="l2.4868" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::RemoveKeywordsFromMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l2.4869"></a><span id="l2.4869" class="difflineminus">-{</span>
<a href="#l2.4870"></a><span id="l2.4870" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::RemoveKeywordsFromMessages(</span>
<a href="#l2.4871"></a><span id="l2.4871" class="difflineplus">+    nsIArray *aMessages, const nsACString &amp;aKeywords) {</span>
<a href="#l2.4872"></a><span id="l2.4872">   return ChangeKeywordForMessages(aMessages, aKeywords, false /* remove */);</span>
<a href="#l2.4873"></a><span id="l2.4873"> }</span>
<a href="#l2.4874"></a><span id="l2.4874"> </span>
<a href="#l2.4875"></a><span id="l2.4875" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::UpdateNewMsgHdr(nsIMsgDBHdr* aOldHdr, nsIMsgDBHdr* aNewHdr)</span>
<a href="#l2.4876"></a><span id="l2.4876" class="difflineminus">-{</span>
<a href="#l2.4877"></a><span id="l2.4877" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::UpdateNewMsgHdr(nsIMsgDBHdr *aOldHdr,</span>
<a href="#l2.4878"></a><span id="l2.4878" class="difflineplus">+                                                    nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l2.4879"></a><span id="l2.4879">   NS_ENSURE_ARG_POINTER(aOldHdr);</span>
<a href="#l2.4880"></a><span id="l2.4880">   NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l2.4881"></a><span id="l2.4881">   // Preserve any properties set on the message.</span>
<a href="#l2.4882"></a><span id="l2.4882">   CopyPropertiesToMsgHdr(aNewHdr, aOldHdr, true);</span>
<a href="#l2.4883"></a><span id="l2.4883"> </span>
<a href="#l2.4884"></a><span id="l2.4884">   // Preserve keywords manually, since they are set as don't preserve.</span>
<a href="#l2.4885"></a><span id="l2.4885">   nsCString keywordString;</span>
<a href="#l2.4886"></a><span id="l2.4886">   aOldHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywordString));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -29,245 +29,264 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsLocalUndoTxn.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> #define COPY_BUFFER_SIZE 16384</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> class nsParseMailMessageState;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-struct nsLocalMailCopyState</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+struct nsLocalMailCopyState {</span>
<a href="#l3.15"></a><span id="l3.15">   nsLocalMailCopyState();</span>
<a href="#l3.16"></a><span id="l3.16">   virtual ~nsLocalMailCopyState();</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; m_fileStream;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; m_fileStream;</span>
<a href="#l3.20"></a><span id="l3.20">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l3.21"></a><span id="l3.21">   nsCOMPtr&lt;nsISupports&gt; m_srcSupport;</span>
<a href="#l3.22"></a><span id="l3.22">   /// Source nsIMsgDBHdr instances.</span>
<a href="#l3.23"></a><span id="l3.23">   nsCOMPtr&lt;nsIArray&gt; m_messages;</span>
<a href="#l3.24"></a><span id="l3.24">   /// Destination nsIMsgDBHdr instances.</span>
<a href="#l3.25"></a><span id="l3.25">   nsCOMPtr&lt;nsIMutableArray&gt; m_destMessages;</span>
<a href="#l3.26"></a><span id="l3.26">   RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; m_undoMsgTxn;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_message; // current copy message</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  nsMsgMessageFlagType m_flags; // current copy message flags</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_message;  // current copy message</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  nsMsgMessageFlagType m_flags;     // current copy message flags</span>
<a href="#l3.31"></a><span id="l3.31">   RefPtr&lt;nsParseMailMessageState&gt; m_parseMsgState;</span>
<a href="#l3.32"></a><span id="l3.32">   nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; m_listener;</span>
<a href="#l3.33"></a><span id="l3.33">   nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l3.34"></a><span id="l3.34">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_destDB;</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36">   // for displaying status;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  nsCOMPtr &lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l3.41"></a><span id="l3.41">   int64_t m_lastProgressTime;</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">   nsMsgKey m_curDstKey;</span>
<a href="#l3.44"></a><span id="l3.44">   uint32_t m_curCopyIndex;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; m_messageService;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; m_messageService;</span>
<a href="#l3.47"></a><span id="l3.47">   /// The number of messages in m_messages.</span>
<a href="#l3.48"></a><span id="l3.48">   uint32_t m_totalMsgCount;</span>
<a href="#l3.49"></a><span id="l3.49">   char *m_dataBuffer;</span>
<a href="#l3.50"></a><span id="l3.50">   uint32_t m_dataBufferSize;</span>
<a href="#l3.51"></a><span id="l3.51">   uint32_t m_leftOver;</span>
<a href="#l3.52"></a><span id="l3.52">   bool m_isMove;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  bool m_isFolder;   // isFolder move/copy</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+  bool m_isFolder;  // isFolder move/copy</span>
<a href="#l3.55"></a><span id="l3.55">   bool m_dummyEnvelopeNeeded;</span>
<a href="#l3.56"></a><span id="l3.56">   bool m_copyingMultipleMessages;</span>
<a href="#l3.57"></a><span id="l3.57">   bool m_fromLineSeen;</span>
<a href="#l3.58"></a><span id="l3.58">   bool m_allowUndo;</span>
<a href="#l3.59"></a><span id="l3.59">   bool m_writeFailed;</span>
<a href="#l3.60"></a><span id="l3.60">   bool m_notifyFolderLoaded;</span>
<a href="#l3.61"></a><span id="l3.61">   bool m_wholeMsgInStream;</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  nsCString    m_newMsgKeywords;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_newHdr;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  nsCString m_newMsgKeywords;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newHdr;</span>
<a href="#l3.66"></a><span id="l3.66"> };</span>
<a href="#l3.67"></a><span id="l3.67"> </span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-struct nsLocalFolderScanState</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-{</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+struct nsLocalFolderScanState {</span>
<a href="#l3.71"></a><span id="l3.71">   nsLocalFolderScanState();</span>
<a href="#l3.72"></a><span id="l3.72">   ~nsLocalFolderScanState();</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">   nsCOMPtr&lt;nsIInputStream&gt; m_inputStream;</span>
<a href="#l3.75"></a><span id="l3.75">   nsCOMPtr&lt;nsISeekableStream&gt; m_seekableStream;</span>
<a href="#l3.76"></a><span id="l3.76">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l3.77"></a><span id="l3.77">   nsCString m_header;</span>
<a href="#l3.78"></a><span id="l3.78">   nsCString m_accountKey;</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  const char *m_uidl; // memory is owned by m_header</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  const char *m_uidl;  // memory is owned by m_header</span>
<a href="#l3.81"></a><span id="l3.81">   // false if we need a new input stream for each message</span>
<a href="#l3.82"></a><span id="l3.82">   bool m_streamReusable;</span>
<a href="#l3.83"></a><span id="l3.83"> };</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85"> class nsMsgLocalMailFolder : public nsMsgDBFolder,</span>
<a href="#l3.86"></a><span id="l3.86">                              public nsIMsgLocalMailFolder,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-                             public nsICopyMessageListener</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-{</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-public:</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+                             public nsICopyMessageListener {</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+ public:</span>
<a href="#l3.92"></a><span id="l3.92">   nsMsgLocalMailFolder(void);</span>
<a href="#l3.93"></a><span id="l3.93">   NS_DECL_NSICOPYMESSAGELISTENER</span>
<a href="#l3.94"></a><span id="l3.94">   NS_DECL_NSIMSGLOCALMAILFOLDER</span>
<a href="#l3.95"></a><span id="l3.95">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l3.96"></a><span id="l3.96">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l3.97"></a><span id="l3.97">   // nsIRDFResource methods:</span>
<a href="#l3.98"></a><span id="l3.98">   NS_IMETHOD Init(const char *aURI) override;</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   // nsIUrlListener methods</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-  NS_IMETHOD OnStartRunningUrl(nsIURI * aUrl) override;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-  NS_IMETHOD OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode) override;</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  NS_IMETHOD OnStartRunningUrl(nsIURI *aUrl) override;</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  NS_IMETHOD OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) override;</span>
<a href="#l3.105"></a><span id="l3.105"> </span>
<a href="#l3.106"></a><span id="l3.106">   // nsIMsgFolder methods:</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-  NS_IMETHOD GetSubFolders(nsISimpleEnumerator* *aResult) override;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  NS_IMETHOD GetSubFolders(nsISimpleEnumerator **aResult) override;</span>
<a href="#l3.109"></a><span id="l3.109">   NS_IMETHOD GetMsgDatabase(nsIMsgDatabase **aMsgDatabase) override;</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111">   NS_IMETHOD OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator) override;</span>
<a href="#l3.112"></a><span id="l3.112">   NS_IMETHOD GetMessages(nsISimpleEnumerator **result) override;</span>
<a href="#l3.113"></a><span id="l3.113">   NS_IMETHOD UpdateFolder(nsIMsgWindow *aWindow) override;</span>
<a href="#l3.114"></a><span id="l3.114"> </span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-  NS_IMETHOD CreateSubfolder(const nsAString&amp; folderName ,nsIMsgWindow *msgWindow) override;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  NS_IMETHOD CreateSubfolder(const nsAString &amp;folderName,</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+                             nsIMsgWindow *msgWindow) override;</span>
<a href="#l3.118"></a><span id="l3.118"> </span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  NS_IMETHOD Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-  NS_IMETHOD CompactAll(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow, bool aCompactOfflineAlso) override;</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-  NS_IMETHOD EmptyTrash(nsIMsgWindow *msgWindow, nsIUrlListener *aListener) override;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-  NS_IMETHOD DeleteSubFolders(nsIArray *folders, nsIMsgWindow *msgWindow) override;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-  NS_IMETHOD CreateStorageIfMissing(nsIUrlListener* urlListener) override;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-  NS_IMETHOD Rename (const nsAString&amp; aNewName, nsIMsgWindow *msgWindow) override;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-  NS_IMETHOD RenameSubFolders (nsIMsgWindow *msgWindow, nsIMsgFolder *oldFolder) override;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+  NS_IMETHOD Compact(nsIUrlListener *aListener,</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+                     nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  NS_IMETHOD CompactAll(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+                        bool aCompactOfflineAlso) override;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  NS_IMETHOD EmptyTrash(nsIMsgWindow *msgWindow,</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+                        nsIUrlListener *aListener) override;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  NS_IMETHOD DeleteSubFolders(nsIArray *folders,</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+                              nsIMsgWindow *msgWindow) override;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  NS_IMETHOD CreateStorageIfMissing(nsIUrlListener *urlListener) override;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  NS_IMETHOD Rename(const nsAString &amp;aNewName,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+                    nsIMsgWindow *msgWindow) override;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  NS_IMETHOD RenameSubFolders(nsIMsgWindow *msgWindow,</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+                              nsIMsgFolder *oldFolder) override;</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-  NS_IMETHOD GetPrettyName(nsAString&amp; prettyName) override; // Override of the base, for top-level mail folder</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  NS_IMETHOD SetPrettyName(const nsAString&amp; aName) override;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+  NS_IMETHOD GetPrettyName(nsAString &amp;prettyName)</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+      override;  // Override of the base, for top-level mail folder</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+  NS_IMETHOD SetPrettyName(const nsAString &amp;aName) override;</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-  NS_IMETHOD GetFolderURL(nsACString&amp; url) override;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  NS_IMETHOD GetFolderURL(nsACString &amp;url) override;</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149">   NS_IMETHOD GetManyHeadersToDownload(bool *retval) override;</span>
<a href="#l3.150"></a><span id="l3.150"> </span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-  NS_IMETHOD GetDeletable (bool *deletable) override;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+  NS_IMETHOD GetDeletable(bool *deletable) override;</span>
<a href="#l3.153"></a><span id="l3.153">   NS_IMETHOD GetSizeOnDisk(int64_t *size) override;</span>
<a href="#l3.154"></a><span id="l3.154"> </span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-  NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo, nsIMsgDatabase **db) override;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+  NS_IMETHOD GetDBFolderInfoAndDB(nsIDBFolderInfo **folderInfo,</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+                                  nsIMsgDatabase **db) override;</span>
<a href="#l3.158"></a><span id="l3.158"> </span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-  NS_IMETHOD DeleteMessages(nsIArray *messages,</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-                      nsIMsgWindow *msgWindow, bool</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-                      deleteStorage, bool isMove,</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-                      nsIMsgCopyServiceListener* listener, bool allowUndo) override;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  NS_IMETHOD CopyMessages(nsIMsgFolder *srcFolder, nsIArray* messages,</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  NS_IMETHOD DeleteMessages(nsIArray *messages, nsIMsgWindow *msgWindow,</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+                            bool deleteStorage, bool isMove,</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+                            nsIMsgCopyServiceListener *listener,</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+                            bool allowUndo) override;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  NS_IMETHOD CopyMessages(nsIMsgFolder *srcFolder, nsIArray *messages,</span>
<a href="#l3.169"></a><span id="l3.169">                           bool isMove, nsIMsgWindow *msgWindow,</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-                          nsIMsgCopyServiceListener* listener, bool isFolder, bool allowUndo) override;</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-  NS_IMETHOD CopyFolder(nsIMsgFolder *srcFolder, bool isMoveFolder, nsIMsgWindow *msgWindow,</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-                          nsIMsgCopyServiceListener* listener) override;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-  NS_IMETHOD CopyFileMessage(nsIFile* aFile, nsIMsgDBHdr* msgToReplace,</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-                             bool isDraftOrTemplate,</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-                             uint32_t newMsgFlags,</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+                          nsIMsgCopyServiceListener *listener, bool isFolder,</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+                          bool allowUndo) override;</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  NS_IMETHOD CopyFolder(nsIMsgFolder *srcFolder, bool isMoveFolder,</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+                        nsIMsgWindow *msgWindow,</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+                        nsIMsgCopyServiceListener *listener) override;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  NS_IMETHOD CopyFileMessage(nsIFile *aFile, nsIMsgDBHdr *msgToReplace,</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+                             bool isDraftOrTemplate, uint32_t newMsgFlags,</span>
<a href="#l3.183"></a><span id="l3.183">                              const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l3.184"></a><span id="l3.184">                              nsIMsgWindow *msgWindow,</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-                             nsIMsgCopyServiceListener* listener) override;</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+                             nsIMsgCopyServiceListener *listener) override;</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-  NS_IMETHOD AddMessageDispositionState(nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) override;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+  NS_IMETHOD AddMessageDispositionState(</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+      nsIMsgDBHdr *aMessage, nsMsgDispositionState aDispositionFlag) override;</span>
<a href="#l3.191"></a><span id="l3.191">   NS_IMETHOD MarkMessagesRead(nsIArray *aMessages, bool aMarkRead) override;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-  NS_IMETHOD MarkMessagesFlagged(nsIArray *aMessages, bool aMarkFlagged) override;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  NS_IMETHOD MarkMessagesFlagged(nsIArray *aMessages,</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+                                 bool aMarkFlagged) override;</span>
<a href="#l3.195"></a><span id="l3.195">   NS_IMETHOD MarkAllMessagesRead(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l3.196"></a><span id="l3.196">   NS_IMETHOD MarkThreadRead(nsIMsgThread *thread) override;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-  NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow, nsIUrlListener *aListener) override;</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow,</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+                            nsIUrlListener *aListener) override;</span>
<a href="#l3.200"></a><span id="l3.200">   NS_IMETHOD NotifyCompactCompleted() override;</span>
<a href="#l3.201"></a><span id="l3.201">   NS_IMETHOD Shutdown(bool shutdownChildren) override;</span>
<a href="#l3.202"></a><span id="l3.202"> </span>
<a href="#l3.203"></a><span id="l3.203">   NS_IMETHOD WriteToFolderCacheElem(nsIMsgFolderCacheElement *element) override;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-  NS_IMETHOD ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element) override;</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  NS_IMETHOD ReadFromFolderCacheElem(</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+      nsIMsgFolderCacheElement *element) override;</span>
<a href="#l3.207"></a><span id="l3.207"> </span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-  NS_IMETHOD GetName(nsAString&amp; aName) override;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  NS_IMETHOD GetName(nsAString &amp;aName) override;</span>
<a href="#l3.210"></a><span id="l3.210"> </span>
<a href="#l3.211"></a><span id="l3.211">   // Used when headers_only is TRUE</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-  NS_IMETHOD DownloadMessagesForOffline(nsIArray *aMessages, nsIMsgWindow *aWindow) override;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  NS_IMETHOD DownloadMessagesForOffline(nsIArray *aMessages,</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+                                        nsIMsgWindow *aWindow) override;</span>
<a href="#l3.215"></a><span id="l3.215">   NS_IMETHOD FetchMsgPreviewText(nsMsgKey *aKeysToFetch, uint32_t aNumKeys,</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-                                                 bool aLocalOnly, nsIUrlListener *aUrlListener,</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-                                                 bool *aAsyncResults) override;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-  NS_IMETHOD AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords) override;</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  NS_IMETHOD RemoveKeywordsFromMessages(nsIArray *aMessages, const nsACString&amp; aKeywords) override;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-  NS_IMETHOD GetIncomingServerType(nsACString&amp; serverType) override;</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+                                 bool aLocalOnly, nsIUrlListener *aUrlListener,</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+                                 bool *aAsyncResults) override;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+  NS_IMETHOD AddKeywordsToMessages(nsIArray *aMessages,</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+                                   const nsACString &amp;aKeywords) override;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  NS_IMETHOD RemoveKeywordsFromMessages(nsIArray *aMessages,</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+                                        const nsACString &amp;aKeywords) override;</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+  NS_IMETHOD GetIncomingServerType(nsACString &amp;serverType) override;</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-protected:</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+ protected:</span>
<a href="#l3.231"></a><span id="l3.231">   virtual ~nsMsgLocalMailFolder();</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-  nsresult CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder) override;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  nsresult CopyFolderAcrossServer(nsIMsgFolder *srcFolder, nsIMsgWindow *msgWindow,nsIMsgCopyServiceListener* listener);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+  nsresult CreateChildFromURI(const nsCString &amp;uri,</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+                              nsIMsgFolder **folder) override;</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+  nsresult CopyFolderAcrossServer(nsIMsgFolder *srcFolder,</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+                                  nsIMsgWindow *msgWindow,</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+                                  nsIMsgCopyServiceListener *listener);</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240">   nsresult CreateSubFolders(nsIFile *path);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-  nsresult GetTrashFolder(nsIMsgFolder** trashFolder);</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  nsresult GetTrashFolder(nsIMsgFolder **trashFolder);</span>
<a href="#l3.243"></a><span id="l3.243">   nsresult WriteStartOfNewMessage();</span>
<a href="#l3.244"></a><span id="l3.244"> </span>
<a href="#l3.245"></a><span id="l3.245">   // CreateSubfolder, but without the nsIMsgFolderListener notification</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-  nsresult CreateSubfolderInternal(const nsAString&amp; folderName, nsIMsgWindow *msgWindow,</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  nsresult CreateSubfolderInternal(const nsAString &amp;folderName,</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+                                   nsIMsgWindow *msgWindow,</span>
<a href="#l3.249"></a><span id="l3.249">                                    nsIMsgFolder **aNewFolder);</span>
<a href="#l3.250"></a><span id="l3.250"> </span>
<a href="#l3.251"></a><span id="l3.251">   nsresult IsChildOfTrash(bool *result);</span>
<a href="#l3.252"></a><span id="l3.252">   nsresult RecursiveSetDeleteIsMoveTrash(bool bVal);</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-  nsresult ConfirmFolderDeletion(nsIMsgWindow *aMsgWindow, nsIMsgFolder *aFolder, bool *aResult);</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+  nsresult ConfirmFolderDeletion(nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+                                 nsIMsgFolder *aFolder, bool *aResult);</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257">   nsresult DeleteMessage(nsISupports *message, nsIMsgWindow *msgWindow,</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-                   bool deleteStorage, bool commit);</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+                         bool deleteStorage, bool commit);</span>
<a href="#l3.260"></a><span id="l3.260">   nsresult GetDatabase() override;</span>
<a href="#l3.261"></a><span id="l3.261">   // this will set mDatabase, if successful. It will also create a .msf file</span>
<a href="#l3.262"></a><span id="l3.262">   // for an empty local mail folder. It will leave invalid DBs in place, and</span>
<a href="#l3.263"></a><span id="l3.263">   // return an error.</span>
<a href="#l3.264"></a><span id="l3.264">   nsresult OpenDatabase();</span>
<a href="#l3.265"></a><span id="l3.265"> </span>
<a href="#l3.266"></a><span id="l3.266">   // copy message helper</span>
<a href="#l3.267"></a><span id="l3.267">   nsresult DisplayMoveCopyStatusMsg();</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269">   nsresult CopyMessageTo(nsISupports *message, nsIMsgFolder *dstFolder,</span>
<a href="#l3.270"></a><span id="l3.270">                          nsIMsgWindow *msgWindow, bool isMove);</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272">   /**</span>
<a href="#l3.273"></a><span id="l3.273">    * Checks if there's room in the target folder to copy message(s) into.</span>
<a href="#l3.274"></a><span id="l3.274">    * If not, handles alerting the user, and sending the copy notifications.</span>
<a href="#l3.275"></a><span id="l3.275">    */</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  bool CheckIfSpaceForCopy(nsIMsgWindow *msgWindow,</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-                             nsIMsgFolder *srcFolder,</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-                             nsISupports *srcSupports,</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-                             bool isMove,</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-                             int64_t totalMsgSize);</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  bool CheckIfSpaceForCopy(nsIMsgWindow *msgWindow, nsIMsgFolder *srcFolder,</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+                           nsISupports *srcSupports, bool isMove,</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+                           int64_t totalMsgSize);</span>
<a href="#l3.284"></a><span id="l3.284"> </span>
<a href="#l3.285"></a><span id="l3.285">   // copy multiple messages at a time from this folder</span>
<a href="#l3.286"></a><span id="l3.286">   nsresult CopyMessagesTo(nsIArray *messages, nsTArray&lt;nsMsgKey&gt; &amp;keyArray,</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-                                       nsIMsgFolder *dstFolder,</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-                                       bool isMove);</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-  nsresult InitCopyState(nsISupports* aSupport, nsIArray* messages,</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-                         bool isMove, nsIMsgCopyServiceListener* listener, nsIMsgWindow *msgWindow, bool isMoveFolder, bool allowUndo);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+                          nsIMsgWindow *aMsgWindow, nsIMsgFolder *dstFolder,</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+                          bool isMove);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+  nsresult InitCopyState(nsISupports *aSupport, nsIArray *messages, bool isMove,</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+                         nsIMsgCopyServiceListener *listener,</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+                         nsIMsgWindow *msgWindow, bool isMoveFolder,</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+                         bool allowUndo);</span>
<a href="#l3.298"></a><span id="l3.298">   nsresult InitCopyMsgHdrAndFileStream();</span>
<a href="#l3.299"></a><span id="l3.299">   // preserve message metadata when moving or copying messages</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-  void CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr, bool isMove);</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-  virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI) override;</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-  nsresult ChangeKeywordForMessages(nsIArray *aMessages, const nsACString&amp; aKeyword, bool add);</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+  void CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr,</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+                              bool isMove);</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+  virtual nsresult CreateBaseMessageURI(const nsACString &amp;aURI) override;</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  nsresult ChangeKeywordForMessages(nsIArray *aMessages,</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+                                    const nsACString &amp;aKeyword, bool add);</span>
<a href="#l3.308"></a><span id="l3.308">   bool GetDeleteFromServerOnMove();</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-  void CopyHdrPropertiesWithSkipList(nsIMsgDBHdr *destHdr,</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-                                     nsIMsgDBHdr *srcHdr,</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+  void CopyHdrPropertiesWithSkipList(nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr,</span>
<a href="#l3.312"></a><span id="l3.312">                                      const nsCString &amp;skipList);</span>
<a href="#l3.313"></a><span id="l3.313">   nsresult FinishNewLocalMessage(nsIOutputStream *outputStream,</span>
<a href="#l3.314"></a><span id="l3.314">                                  nsIMsgDBHdr *newHdr,</span>
<a href="#l3.315"></a><span id="l3.315">                                  nsIMsgPluggableStore *msgStore,</span>
<a href="#l3.316"></a><span id="l3.316">                                  nsParseMailMessageState *parseMsgState);</span>
<a href="#l3.317"></a><span id="l3.317"> </span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-protected:</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-  nsLocalMailCopyState *mCopyState; //We only allow one of these at a time</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+ protected:</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+  nsLocalMailCopyState *mCopyState;  // We only allow one of these at a time</span>
<a href="#l3.322"></a><span id="l3.322">   nsCString mType;</span>
<a href="#l3.323"></a><span id="l3.323">   bool mHaveReadNameFromDB;</span>
<a href="#l3.324"></a><span id="l3.324">   bool mInitialized;</span>
<a href="#l3.325"></a><span id="l3.325">   bool mCheckForNewMessagesAfterParsing;</span>
<a href="#l3.326"></a><span id="l3.326">   bool m_parsingFolder;</span>
<a href="#l3.327"></a><span id="l3.327">   nsCOMPtr&lt;nsIUrlListener&gt; mReparseListener;</span>
<a href="#l3.328"></a><span id="l3.328">   nsTArray&lt;nsMsgKey&gt; mSpamKeysToMove;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-  nsresult setSubfolderFlag(const nsAString&amp; aFolderName, uint32_t flags);</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+  nsresult setSubfolderFlag(const nsAString &amp;aFolderName, uint32_t flags);</span>
<a href="#l3.331"></a><span id="l3.331"> </span>
<a href="#l3.332"></a><span id="l3.332">   // state variables for DownloadMessagesForOffline</span>
<a href="#l3.333"></a><span id="l3.333"> </span>
<a href="#l3.334"></a><span id="l3.334">   // Do we notify the owning window of Delete's before or after</span>
<a href="#l3.335"></a><span id="l3.335">   // Adding the new msg?</span>
<a href="#l3.336"></a><span id="l3.336"> #define DOWNLOAD_NOTIFY_FIRST 1</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-#define DOWNLOAD_NOTIFY_LAST  2</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+#define DOWNLOAD_NOTIFY_LAST 2</span>
<a href="#l3.339"></a><span id="l3.339"> </span>
<a href="#l3.340"></a><span id="l3.340"> #ifndef DOWNLOAD_NOTIFY_STYLE</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-#define DOWNLOAD_NOTIFY_STYLE DOWNLOAD_NOTIFY_FIRST</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+#  define DOWNLOAD_NOTIFY_STYLE DOWNLOAD_NOTIFY_FIRST</span>
<a href="#l3.343"></a><span id="l3.343"> #endif</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345">   nsCOMArray&lt;nsIMsgDBHdr&gt; mDownloadMessages;</span>
<a href="#l3.346"></a><span id="l3.346">   nsCOMPtr&lt;nsIMsgWindow&gt; mDownloadWindow;</span>
<a href="#l3.347"></a><span id="l3.347">   nsMsgKey mDownloadSelectKey;</span>
<a href="#l3.348"></a><span id="l3.348">   uint32_t mDownloadState;</span>
<a href="#l3.349"></a><span id="l3.349"> #define DOWNLOAD_STATE_NONE 0</span>
<a href="#l3.350"></a><span id="l3.350"> #define DOWNLOAD_STATE_INITED 1</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineat">@@ -276,9 +295,9 @@ protected:</span>
<a href="#l3.352"></a><span id="l3.352"> </span>
<a href="#l3.353"></a><span id="l3.353"> #if DOWNLOAD_NOTIFY_STYLE == DOWNLOAD_NOTIFY_LAST</span>
<a href="#l3.354"></a><span id="l3.354">   nsMsgKey mDownloadOldKey;</span>
<a href="#l3.355"></a><span id="l3.355">   nsMsgKey mDownloadOldParent;</span>
<a href="#l3.356"></a><span id="l3.356">   uint32_t mDownloadOldFlags;</span>
<a href="#l3.357"></a><span id="l3.357"> #endif</span>
<a href="#l3.358"></a><span id="l3.358"> };</span>
<a href="#l3.359"></a><span id="l3.359"> </span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-#endif // nsMsgLocalMailFolder_h__</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+#endif  // nsMsgLocalMailFolder_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -18,539 +18,475 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsMsgDBFolder.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> NS_IMPL_ISUPPORTS_INHERITED(nsLocalMoveCopyMsgTxn, nsMsgTxn, nsIFolderListener)</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-nsLocalMoveCopyMsgTxn::nsLocalMoveCopyMsgTxn()  : m_srcIsImap4(false),</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  m_canUndelete(false)</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-{</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-}</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+nsLocalMoveCopyMsgTxn::nsLocalMoveCopyMsgTxn()</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    : m_srcIsImap4(false), m_canUndelete(false) {}</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-nsLocalMoveCopyMsgTxn::~nsLocalMoveCopyMsgTxn()</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-{</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-}</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+nsLocalMoveCopyMsgTxn::~nsLocalMoveCopyMsgTxn() {}</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-nsresult</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-nsLocalMoveCopyMsgTxn::Init(nsIMsgFolder* srcFolder, nsIMsgFolder* dstFolder,</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-                            bool isMove)</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-{</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    nsresult rv;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-    rv = SetSrcFolder(srcFolder);</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-    rv = SetDstFolder(dstFolder);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    m_isMove = isMove;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::Init(nsIMsgFolder *srcFolder,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+                                     nsIMsgFolder *dstFolder, bool isMove) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  nsresult rv;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  rv = SetSrcFolder(srcFolder);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  rv = SetDstFolder(dstFolder);</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+  m_isMove = isMove;</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    mUndoFolderListener = nullptr;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+  mUndoFolderListener = nullptr;</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    nsCString protocolType;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    rv = srcFolder-&gt;GetURI(protocolType);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    protocolType.SetLength(protocolType.FindChar(':'));</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    if (MsgLowerCaseEqualsLiteral(protocolType, &quot;imap&quot;))</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-      m_srcIsImap4 = true;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    return nsMsgTxn::Init();</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  nsCString protocolType;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  rv = srcFolder-&gt;GetURI(protocolType);</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  protocolType.SetLength(protocolType.FindChar(':'));</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(protocolType, &quot;imap&quot;)) m_srcIsImap4 = true;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+  return nsMsgTxn::Init();</span>
<a href="#l4.57"></a><span id="l4.57"> }</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-nsresult</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-nsLocalMoveCopyMsgTxn::GetSrcIsImap(bool *isImap)</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-{</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::GetSrcIsImap(bool *isImap) {</span>
<a href="#l4.62"></a><span id="l4.62">   *isImap = m_srcIsImap4;</span>
<a href="#l4.63"></a><span id="l4.63">   return NS_OK;</span>
<a href="#l4.64"></a><span id="l4.64"> }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-nsresult</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-nsLocalMoveCopyMsgTxn::SetSrcFolder(nsIMsgFolder* srcFolder)</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-{</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::SetSrcFolder(nsIMsgFolder *srcFolder) {</span>
<a href="#l4.69"></a><span id="l4.69">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  if (srcFolder)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    m_srcFolder = do_GetWeakReference(srcFolder, &amp;rv);</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  if (srcFolder) m_srcFolder = do_GetWeakReference(srcFolder, &amp;rv);</span>
<a href="#l4.73"></a><span id="l4.73">   return rv;</span>
<a href="#l4.74"></a><span id="l4.74"> }</span>
<a href="#l4.75"></a><span id="l4.75"> </span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-nsresult</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-nsLocalMoveCopyMsgTxn::SetDstFolder(nsIMsgFolder* dstFolder)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-{</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::SetDstFolder(nsIMsgFolder *dstFolder) {</span>
<a href="#l4.80"></a><span id="l4.80">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  if (dstFolder)</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-    m_dstFolder = do_GetWeakReference(dstFolder, &amp;rv);</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  if (dstFolder) m_dstFolder = do_GetWeakReference(dstFolder, &amp;rv);</span>
<a href="#l4.84"></a><span id="l4.84">   return rv;</span>
<a href="#l4.85"></a><span id="l4.85"> }</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-nsresult</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-nsLocalMoveCopyMsgTxn::AddSrcKey(nsMsgKey aKey)</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-{</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::AddSrcKey(nsMsgKey aKey) {</span>
<a href="#l4.91"></a><span id="l4.91">   m_srcKeyArray.AppendElement(aKey);</span>
<a href="#l4.92"></a><span id="l4.92">   return NS_OK;</span>
<a href="#l4.93"></a><span id="l4.93"> }</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-nsresult</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-nsLocalMoveCopyMsgTxn::AddSrcStatusOffset(uint32_t aStatusOffset)</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-{</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::AddSrcStatusOffset(uint32_t aStatusOffset) {</span>
<a href="#l4.99"></a><span id="l4.99">   m_srcStatusOffsetArray.AppendElement(aStatusOffset);</span>
<a href="#l4.100"></a><span id="l4.100">   return NS_OK;</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-nsresult</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-nsLocalMoveCopyMsgTxn::AddDstKey(nsMsgKey aKey)</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-{</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::AddDstKey(nsMsgKey aKey) {</span>
<a href="#l4.108"></a><span id="l4.108">   m_dstKeyArray.AppendElement(aKey);</span>
<a href="#l4.109"></a><span id="l4.109">   return NS_OK;</span>
<a href="#l4.110"></a><span id="l4.110"> }</span>
<a href="#l4.111"></a><span id="l4.111"> </span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-nsresult</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-nsLocalMoveCopyMsgTxn::AddDstMsgSize(uint32_t msgSize)</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-{</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-    m_dstSizeArray.AppendElement(msgSize);</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::AddDstMsgSize(uint32_t msgSize) {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  m_dstSizeArray.AppendElement(msgSize);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.120"></a><span id="l4.120"> }</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-nsresult</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-nsLocalMoveCopyMsgTxn::UndoImapDeleteFlag(nsIMsgFolder* folder,</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-                                          nsTArray&lt;nsMsgKey&gt;&amp; keyArray,</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-                                          bool deleteFlag)</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-{</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::UndoImapDeleteFlag(nsIMsgFolder *folder,</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+                                                   nsTArray&lt;nsMsgKey&gt; &amp;keyArray,</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+                                                   bool deleteFlag) {</span>
<a href="#l4.130"></a><span id="l4.130">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-  if (m_srcIsImap4)</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-  {</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-    nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+  if (m_srcIsImap4) {</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+        do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.137"></a><span id="l4.137">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.138"></a><span id="l4.138">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l4.139"></a><span id="l4.139">     nsCString msgIds;</span>
<a href="#l4.140"></a><span id="l4.140">     uint32_t i, count = keyArray.Length();</span>
<a href="#l4.141"></a><span id="l4.141">     urlListener = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-    for (i=0; i &lt; count; i++)</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-    {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-      if (!msgIds.IsEmpty())</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-          msgIds.Append(',');</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-      msgIds.AppendInt((int32_t) keyArray[i]);</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+      if (!msgIds.IsEmpty()) msgIds.Append(',');</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+      msgIds.AppendInt((int32_t)keyArray[i]);</span>
<a href="#l4.150"></a><span id="l4.150">     }</span>
<a href="#l4.151"></a><span id="l4.151">     // This is to make sure that we are in the selected state</span>
<a href="#l4.152"></a><span id="l4.152">     // when executing the imap url; we don't want to load the</span>
<a href="#l4.153"></a><span id="l4.153">     // folder so use lite select to do the trick</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    rv = imapService-&gt;LiteSelectFolder(folder,</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-                                       urlListener, nullptr, nullptr);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+    rv = imapService-&gt;LiteSelectFolder(folder, urlListener, nullptr, nullptr);</span>
<a href="#l4.157"></a><span id="l4.157">     if (!deleteFlag)</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-        rv =imapService-&gt;AddMessageFlags(folder,</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-                                         urlListener, nullptr,</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-                                         msgIds,</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-                                         kImapMsgDeletedFlag,</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-                                         true);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+      rv = imapService-&gt;AddMessageFlags(folder, urlListener, nullptr, msgIds,</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+                                        kImapMsgDeletedFlag, true);</span>
<a href="#l4.165"></a><span id="l4.165">     else</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-        rv = imapService-&gt;SubtractMessageFlags(folder,</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-                                               urlListener, nullptr,</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-                                               msgIds,</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-                                               kImapMsgDeletedFlag,</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-                                               true);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; m_msgWindow)</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-        folder-&gt;UpdateFolder(m_msgWindow);</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    rv = NS_OK; // always return NS_OK to indicate that the src is imap</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  }</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-  else</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+      rv = imapService-&gt;SubtractMessageFlags(folder, urlListener, nullptr,</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+                                             msgIds, kImapMsgDeletedFlag, true);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; m_msgWindow) folder-&gt;UpdateFolder(m_msgWindow);</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+    rv = NS_OK;  // always return NS_OK to indicate that the src is imap</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+  } else</span>
<a href="#l4.181"></a><span id="l4.181">     rv = NS_ERROR_FAILURE;</span>
<a href="#l4.182"></a><span id="l4.182">   return rv;</span>
<a href="#l4.183"></a><span id="l4.183"> }</span>
<a href="#l4.184"></a><span id="l4.184"> </span>
<a href="#l4.185"></a><span id="l4.185"> NS_IMETHODIMP</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-nsLocalMoveCopyMsgTxn::UndoTransaction()</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-{</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+nsLocalMoveCopyMsgTxn::UndoTransaction() {</span>
<a href="#l4.189"></a><span id="l4.189">   nsresult rv;</span>
<a href="#l4.190"></a><span id="l4.190">   nsCOMPtr&lt;nsIMsgDatabase&gt; dstDB;</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">   nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l4.193"></a><span id="l4.193">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; dstlocalMailFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; dstlocalMailFolder =</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+      do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l4.197"></a><span id="l4.197">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.198"></a><span id="l4.198">   dstlocalMailFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(dstDB));</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  if (!dstDB)</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+  if (!dstDB) {</span>
<a href="#l4.203"></a><span id="l4.203">     // This will listen for the db reparse finishing, and the corresponding</span>
<a href="#l4.204"></a><span id="l4.204">     // FolderLoadedNotification. When it gets that, it will then call</span>
<a href="#l4.205"></a><span id="l4.205">     // UndoTransactionInternal.</span>
<a href="#l4.206"></a><span id="l4.206">     mUndoFolderListener = new nsLocalUndoFolderListener(this, dstFolder);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-    if (!mUndoFolderListener)</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+    if (!mUndoFolderListener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.210"></a><span id="l4.210">     NS_ADDREF(mUndoFolderListener);</span>
<a href="#l4.211"></a><span id="l4.211"> </span>
<a href="#l4.212"></a><span id="l4.212">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.217"></a><span id="l4.217"> </span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-    rv = mailSession-&gt;AddFolderListener(mUndoFolderListener, nsIFolderListener::event);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+    rv = mailSession-&gt;AddFolderListener(mUndoFolderListener,</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+                                        nsIFolderListener::event);</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.223"></a><span id="l4.223"> </span>
<a href="#l4.224"></a><span id="l4.224">     rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstDB));</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-  }</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-  else</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+  } else</span>
<a href="#l4.230"></a><span id="l4.230">     rv = UndoTransactionInternal();</span>
<a href="#l4.231"></a><span id="l4.231">   return rv;</span>
<a href="#l4.232"></a><span id="l4.232"> }</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-nsresult</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-nsLocalMoveCopyMsgTxn::UndoTransactionInternal()</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-{</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+nsresult nsLocalMoveCopyMsgTxn::UndoTransactionInternal() {</span>
<a href="#l4.238"></a><span id="l4.238">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l4.239"></a><span id="l4.239"> </span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-  if (mUndoFolderListener)</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-  {</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+  if (mUndoFolderListener) {</span>
<a href="#l4.243"></a><span id="l4.243">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.248"></a><span id="l4.248"> </span>
<a href="#l4.249"></a><span id="l4.249">     rv = mailSession-&gt;RemoveFolderListener(mUndoFolderListener);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.252"></a><span id="l4.252"> </span>
<a href="#l4.253"></a><span id="l4.253">     NS_RELEASE(mUndoFolderListener);</span>
<a href="#l4.254"></a><span id="l4.254">     mUndoFolderListener = nullptr;</span>
<a href="#l4.255"></a><span id="l4.255">   }</span>
<a href="#l4.256"></a><span id="l4.256"> </span>
<a href="#l4.257"></a><span id="l4.257">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l4.258"></a><span id="l4.258">   nsCOMPtr&lt;nsIMsgDatabase&gt; dstDB;</span>
<a href="#l4.259"></a><span id="l4.259">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.262"></a><span id="l4.262"> </span>
<a href="#l4.263"></a><span id="l4.263">   nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.266"></a><span id="l4.266"> </span>
<a href="#l4.267"></a><span id="l4.267">   rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-  if(NS_FAILED(rv)) return rv;</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.270"></a><span id="l4.270"> </span>
<a href="#l4.271"></a><span id="l4.271">   rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstDB));</span>
<a href="#l4.272"></a><span id="l4.272">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.273"></a><span id="l4.273"> </span>
<a href="#l4.274"></a><span id="l4.274">   uint32_t count = m_srcKeyArray.Length();</span>
<a href="#l4.275"></a><span id="l4.275">   uint32_t i;</span>
<a href="#l4.276"></a><span id="l4.276">   nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHdr;</span>
<a href="#l4.277"></a><span id="l4.277">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279">   // protect against a bogus undo txn without any source keys</span>
<a href="#l4.280"></a><span id="l4.280">   // see bug #179856 for details</span>
<a href="#l4.281"></a><span id="l4.281">   NS_ASSERTION(count, &quot;no source keys&quot;);</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-  if (!count)</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+  if (!count) return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.285"></a><span id="l4.285"> </span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-  if (m_isMove)</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-  {</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-    if (m_srcIsImap4)</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-    {</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-      bool deleteFlag = true;  //message has been deleted -we are trying to undo it</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-      CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deleteFlag); //there could have been a toggle.</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+  if (m_isMove) {</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+    if (m_srcIsImap4) {</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+      bool deleteFlag =</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+          true;  // message has been deleted -we are trying to undo it</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+      CheckForToggleDelete(srcFolder, m_srcKeyArray[0],</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+                           &amp;deleteFlag);  // there could have been a toggle.</span>
<a href="#l4.298"></a><span id="l4.298">       rv = UndoImapDeleteFlag(srcFolder, m_srcKeyArray, deleteFlag);</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-    }</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-    else if (m_canUndelete)</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-    {</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+    } else if (m_canUndelete) {</span>
<a href="#l4.303"></a><span id="l4.303">       nsCOMPtr&lt;nsIMutableArray&gt; srcMessages =</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.306"></a><span id="l4.306">       nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.309"></a><span id="l4.309"> </span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-      for (i = 0; i &lt; count; i++)</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-      {</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-        rv = dstDB-&gt;GetMsgHdrForKey(m_dstKeyArray[i],</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-                                    getter_AddRefs(oldHdr));</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+      for (i = 0; i &lt; count; i++) {</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+        rv = dstDB-&gt;GetMsgHdrForKey(m_dstKeyArray[i], getter_AddRefs(oldHdr));</span>
<a href="#l4.316"></a><span id="l4.316">         NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header&quot;);</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr)</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-        {</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-          rv = srcDB-&gt;CopyHdrFromExistingHdr(m_srcKeyArray[i],</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-                                             oldHdr, true,</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr) {</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineplus">+          rv = srcDB-&gt;CopyHdrFromExistingHdr(m_srcKeyArray[i], oldHdr, true,</span>
<a href="#l4.323"></a><span id="l4.323">                                              getter_AddRefs(newHdr));</span>
<a href="#l4.324"></a><span id="l4.324">           NS_ASSERTION(newHdr, &quot;fatal ... cannot create new msg header&quot;);</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; newHdr)</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-          {</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; newHdr) {</span>
<a href="#l4.328"></a><span id="l4.328">             newHdr-&gt;SetStatusOffset(m_srcStatusOffsetArray[i]);</span>
<a href="#l4.329"></a><span id="l4.329">             srcDB-&gt;UndoDelete(newHdr);</span>
<a href="#l4.330"></a><span id="l4.330">             srcMessages-&gt;AppendElement(newHdr);</span>
<a href="#l4.331"></a><span id="l4.331">             // (we want to keep these two lists in sync)</span>
<a href="#l4.332"></a><span id="l4.332">             dstMessages-&gt;AppendElement(oldHdr);</span>
<a href="#l4.333"></a><span id="l4.333">           }</span>
<a href="#l4.334"></a><span id="l4.334">         }</span>
<a href="#l4.335"></a><span id="l4.335">       }</span>
<a href="#l4.336"></a><span id="l4.336"> </span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-        notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-      if (notifier)</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-      {</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+      if (notifier) {</span>
<a href="#l4.344"></a><span id="l4.344">         // Remember that we're actually moving things back from the destination</span>
<a href="#l4.345"></a><span id="l4.345">         //  to the source!</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-        notifier-&gt;NotifyMsgsMoveCopyCompleted(true, dstMessages,</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-                                              srcFolder, srcMessages);</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+        notifier-&gt;NotifyMsgsMoveCopyCompleted(true, dstMessages, srcFolder,</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+                                              srcMessages);</span>
<a href="#l4.350"></a><span id="l4.350">       }</span>
<a href="#l4.351"></a><span id="l4.351"> </span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-      nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(srcFolder);</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+          do_QueryInterface(srcFolder);</span>
<a href="#l4.355"></a><span id="l4.355">       if (localFolder)</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-        localFolder-&gt;MarkMsgsOnPop3Server(srcMessages, POP3_NONE /*deleteMsgs*/);</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-    }</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-    else // undoing a move means moving the messages back.</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+        localFolder-&gt;MarkMsgsOnPop3Server(srcMessages,</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+                                          POP3_NONE /*deleteMsgs*/);</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    } else  // undoing a move means moving the messages back.</span>
<a href="#l4.362"></a><span id="l4.362">     {</span>
<a href="#l4.363"></a><span id="l4.363">       nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-        do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.366"></a><span id="l4.366">       m_numHdrsCopied = 0;</span>
<a href="#l4.367"></a><span id="l4.367">       m_srcKeyArray.Clear();</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-      for (i = 0; i &lt; count; i++)</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-      {</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+      for (i = 0; i &lt; count; i++) {</span>
<a href="#l4.371"></a><span id="l4.371">         // GetMsgHdrForKey is not a test for whether the key exists, so check.</span>
<a href="#l4.372"></a><span id="l4.372">         bool hasKey = false;</span>
<a href="#l4.373"></a><span id="l4.373">         dstDB-&gt;ContainsKey(m_dstKeyArray[i], &amp;hasKey);</span>
<a href="#l4.374"></a><span id="l4.374">         nsCOMPtr&lt;nsIMsgDBHdr&gt; dstHdr;</span>
<a href="#l4.375"></a><span id="l4.375">         if (hasKey)</span>
<a href="#l4.376"></a><span id="l4.376">           dstDB-&gt;GetMsgHdrForKey(m_dstKeyArray[i], getter_AddRefs(dstHdr));</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-        if (dstHdr)</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-        {</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+        if (dstHdr) {</span>
<a href="#l4.380"></a><span id="l4.380">           nsCString messageId;</span>
<a href="#l4.381"></a><span id="l4.381">           dstHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l4.382"></a><span id="l4.382">           dstMessages-&gt;AppendElement(dstHdr);</span>
<a href="#l4.383"></a><span id="l4.383">           m_copiedMsgIds.AppendElement(messageId);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-        }</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-        else</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-        {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+        } else {</span>
<a href="#l4.388"></a><span id="l4.388">           NS_WARNING(&quot;Cannot get old msg header&quot;);</span>
<a href="#l4.389"></a><span id="l4.389">         }</span>
<a href="#l4.390"></a><span id="l4.390">       }</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-      if (m_copiedMsgIds.Length())</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-      {</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+      if (m_copiedMsgIds.Length()) {</span>
<a href="#l4.394"></a><span id="l4.394">         srcFolder-&gt;AddFolderListener(this);</span>
<a href="#l4.395"></a><span id="l4.395">         m_undoing = true;</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-        return srcFolder-&gt;CopyMessages(dstFolder, dstMessages,</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-                                       true, nullptr, nullptr, false,</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-                                       false);</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-      }</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-      else</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-      {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+        return srcFolder-&gt;CopyMessages(dstFolder, dstMessages, true, nullptr,</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+                                       nullptr, false, false);</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+      } else {</span>
<a href="#l4.405"></a><span id="l4.405">         // Nothing to do, probably because original messages were deleted.</span>
<a href="#l4.406"></a><span id="l4.406">         NS_WARNING(&quot;Undo did not find any messages to move&quot;);</span>
<a href="#l4.407"></a><span id="l4.407">       }</span>
<a href="#l4.408"></a><span id="l4.408">     }</span>
<a href="#l4.409"></a><span id="l4.409">     srcDB-&gt;SetSummaryValid(true);</span>
<a href="#l4.410"></a><span id="l4.410">   }</span>
<a href="#l4.411"></a><span id="l4.411"> </span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-  dstDB-&gt;DeleteMessages(m_dstKeyArray.Length(), m_dstKeyArray.Elements(), nullptr);</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineplus">+  dstDB-&gt;DeleteMessages(m_dstKeyArray.Length(), m_dstKeyArray.Elements(),</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineplus">+                        nullptr);</span>
<a href="#l4.415"></a><span id="l4.415">   dstDB-&gt;SetSummaryValid(true);</span>
<a href="#l4.416"></a><span id="l4.416"> </span>
<a href="#l4.417"></a><span id="l4.417">   return rv;</span>
<a href="#l4.418"></a><span id="l4.418"> }</span>
<a href="#l4.419"></a><span id="l4.419"> </span>
<a href="#l4.420"></a><span id="l4.420"> NS_IMETHODIMP</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-nsLocalMoveCopyMsgTxn::RedoTransaction()</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-{</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+nsLocalMoveCopyMsgTxn::RedoTransaction() {</span>
<a href="#l4.424"></a><span id="l4.424">   nsresult rv;</span>
<a href="#l4.425"></a><span id="l4.425">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l4.426"></a><span id="l4.426">   nsCOMPtr&lt;nsIMsgDatabase&gt; dstDB;</span>
<a href="#l4.427"></a><span id="l4.427"> </span>
<a href="#l4.428"></a><span id="l4.428">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.431"></a><span id="l4.431"> </span>
<a href="#l4.432"></a><span id="l4.432">   nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.435"></a><span id="l4.435"> </span>
<a href="#l4.436"></a><span id="l4.436">   rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-  if(NS_FAILED(rv)) return rv;</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.439"></a><span id="l4.439">   rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstDB));</span>
<a href="#l4.440"></a><span id="l4.440">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.441"></a><span id="l4.441"> </span>
<a href="#l4.442"></a><span id="l4.442">   uint32_t count = m_srcKeyArray.Length();</span>
<a href="#l4.443"></a><span id="l4.443">   uint32_t i;</span>
<a href="#l4.444"></a><span id="l4.444">   nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHdr;</span>
<a href="#l4.445"></a><span id="l4.445">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l4.446"></a><span id="l4.446"> </span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; srcMessages = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; msgSupports;</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; srcMessages =</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; msgSupports;</span>
<a href="#l4.452"></a><span id="l4.452"> </span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-  for (i=0; i&lt;count; i++)</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-  {</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-    rv = srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i],</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-                                getter_AddRefs(oldHdr));</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+    rv = srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i], getter_AddRefs(oldHdr));</span>
<a href="#l4.459"></a><span id="l4.459">     NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header&quot;);</span>
<a href="#l4.460"></a><span id="l4.460"> </span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr)</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-    {</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-      msgSupports =do_QueryInterface(oldHdr);</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr) {</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineplus">+      msgSupports = do_QueryInterface(oldHdr);</span>
<a href="#l4.466"></a><span id="l4.466">       srcMessages-&gt;AppendElement(msgSupports);</span>
<a href="#l4.467"></a><span id="l4.467"> </span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-      if (m_canUndelete)</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-      {</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-      rv = dstDB-&gt;CopyHdrFromExistingHdr(m_dstKeyArray[i],</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-                                         oldHdr, true,</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-                                         getter_AddRefs(newHdr));</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-      NS_ASSERTION(newHdr, &quot;fatal ... cannot get new msg header&quot;);</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; newHdr)</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-      {</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-        if (i &lt; m_dstSizeArray.Length())</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-          rv = newHdr-&gt;SetMessageSize(m_dstSizeArray[i]);</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-        dstDB-&gt;UndoDelete(newHdr);</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineplus">+      if (m_canUndelete) {</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+        rv = dstDB-&gt;CopyHdrFromExistingHdr(m_dstKeyArray[i], oldHdr, true,</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+                                           getter_AddRefs(newHdr));</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+        NS_ASSERTION(newHdr, &quot;fatal ... cannot get new msg header&quot;);</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; newHdr) {</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+          if (i &lt; m_dstSizeArray.Length())</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+            rv = newHdr-&gt;SetMessageSize(m_dstSizeArray[i]);</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+          dstDB-&gt;UndoDelete(newHdr);</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+        }</span>
<a href="#l4.488"></a><span id="l4.488">       }</span>
<a href="#l4.489"></a><span id="l4.489">     }</span>
<a href="#l4.490"></a><span id="l4.490">   }</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-  }</span>
<a href="#l4.492"></a><span id="l4.492">   dstDB-&gt;SetSummaryValid(true);</span>
<a href="#l4.493"></a><span id="l4.493"> </span>
<a href="#l4.494"></a><span id="l4.494" class="difflineminus">-  if (m_isMove)</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineminus">-  {</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-    if (m_srcIsImap4)</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-    {</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+  if (m_isMove) {</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+    if (m_srcIsImap4) {</span>
<a href="#l4.500"></a><span id="l4.500">       // protect against a bogus undo txn without any source keys</span>
<a href="#l4.501"></a><span id="l4.501">       // see bug #179856 for details</span>
<a href="#l4.502"></a><span id="l4.502">       NS_ASSERTION(!m_srcKeyArray.IsEmpty(), &quot;no source keys&quot;);</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-      if (m_srcKeyArray.IsEmpty())</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineplus">+      if (m_srcKeyArray.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.506"></a><span id="l4.506"> </span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-      bool deleteFlag = false; //message is un-deleted- we are trying to redo</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-      CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deleteFlag); // there could have been a toggle</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+      bool deleteFlag = false;  // message is un-deleted- we are trying to redo</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+      CheckForToggleDelete(srcFolder, m_srcKeyArray[0],</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+                           &amp;deleteFlag);  // there could have been a toggle</span>
<a href="#l4.512"></a><span id="l4.512">       rv = UndoImapDeleteFlag(srcFolder, m_srcKeyArray, deleteFlag);</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-    }</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-    else if (m_canUndelete)</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-    {</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-      nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(srcFolder);</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+    } else if (m_canUndelete) {</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineplus">+      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineplus">+          do_QueryInterface(srcFolder);</span>
<a href="#l4.520"></a><span id="l4.520">       if (localFolder)</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-        localFolder-&gt;MarkMsgsOnPop3Server(srcMessages, POP3_DELETE /*deleteMsgs*/);</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineplus">+        localFolder-&gt;MarkMsgsOnPop3Server(srcMessages,</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+                                          POP3_DELETE /*deleteMsgs*/);</span>
<a href="#l4.524"></a><span id="l4.524"> </span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-      rv = srcDB-&gt;DeleteMessages(m_srcKeyArray.Length(), m_srcKeyArray.Elements(), nullptr);</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+      rv = srcDB-&gt;DeleteMessages(m_srcKeyArray.Length(),</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+                                 m_srcKeyArray.Elements(), nullptr);</span>
<a href="#l4.528"></a><span id="l4.528">       srcDB-&gt;SetSummaryValid(true);</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-    }</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-    else</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-    {</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineplus">+    } else {</span>
<a href="#l4.533"></a><span id="l4.533">       nsCOMPtr&lt;nsIMsgDBHdr&gt; srcHdr;</span>
<a href="#l4.534"></a><span id="l4.534">       m_numHdrsCopied = 0;</span>
<a href="#l4.535"></a><span id="l4.535">       m_dstKeyArray.Clear();</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-      for (i = 0; i &lt; count; i++)</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-      {</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+      for (i = 0; i &lt; count; i++) {</span>
<a href="#l4.539"></a><span id="l4.539">         srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i], getter_AddRefs(srcHdr));</span>
<a href="#l4.540"></a><span id="l4.540">         NS_ASSERTION(srcHdr, &quot;fatal ... cannot get old msg header&quot;);</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-        if (srcHdr)</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-        {</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+        if (srcHdr) {</span>
<a href="#l4.544"></a><span id="l4.544">           nsCString messageId;</span>
<a href="#l4.545"></a><span id="l4.545">           srcHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l4.546"></a><span id="l4.546">           m_copiedMsgIds.AppendElement(messageId);</span>
<a href="#l4.547"></a><span id="l4.547">         }</span>
<a href="#l4.548"></a><span id="l4.548">       }</span>
<a href="#l4.549"></a><span id="l4.549">       dstFolder-&gt;AddFolderListener(this);</span>
<a href="#l4.550"></a><span id="l4.550">       m_undoing = false;</span>
<a href="#l4.551"></a><span id="l4.551">       return dstFolder-&gt;CopyMessages(srcFolder, srcMessages, true, nullptr,</span>
<a href="#l4.552"></a><span id="l4.552">                                      nullptr, false, false);</span>
<a href="#l4.553"></a><span id="l4.553">     }</span>
<a href="#l4.554"></a><span id="l4.554">   }</span>
<a href="#l4.555"></a><span id="l4.555"> </span>
<a href="#l4.556"></a><span id="l4.556">   return rv;</span>
<a href="#l4.557"></a><span id="l4.557"> }</span>
<a href="#l4.558"></a><span id="l4.558"> </span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-{</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemAdded(nsIMsgFolder *parentItem,</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineplus">+                                                 nsISupports *item) {</span>
<a href="#l4.563"></a><span id="l4.563">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryInterface(item));</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-  if (msgHdr)</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-  {</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+  if (msgHdr) {</span>
<a href="#l4.567"></a><span id="l4.567">     nsresult rv;</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_undoing ? m_srcFolder :</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-                                                     m_dstFolder, &amp;rv);</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder =</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+        do_QueryReferent(m_undoing ? m_srcFolder : m_dstFolder, &amp;rv);</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.574"></a><span id="l4.574">     nsCString messageId;</span>
<a href="#l4.575"></a><span id="l4.575">     msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-    if (m_copiedMsgIds.Contains(messageId))</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineminus">-    {</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineplus">+    if (m_copiedMsgIds.Contains(messageId)) {</span>
<a href="#l4.579"></a><span id="l4.579">       nsMsgKey msgKey;</span>
<a href="#l4.580"></a><span id="l4.580">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l4.581"></a><span id="l4.581">       if (m_undoing)</span>
<a href="#l4.582"></a><span id="l4.582">         m_srcKeyArray.AppendElement(msgKey);</span>
<a href="#l4.583"></a><span id="l4.583">       else</span>
<a href="#l4.584"></a><span id="l4.584">         m_dstKeyArray.AppendElement(msgKey);</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-      if (++m_numHdrsCopied == m_copiedMsgIds.Length())</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-      {</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+      if (++m_numHdrsCopied == m_copiedMsgIds.Length()) {</span>
<a href="#l4.588"></a><span id="l4.588">         folder-&gt;RemoveFolderListener(this);</span>
<a href="#l4.589"></a><span id="l4.589">         m_copiedMsgIds.Clear();</span>
<a href="#l4.590"></a><span id="l4.590">       }</span>
<a href="#l4.591"></a><span id="l4.591">     }</span>
<a href="#l4.592"></a><span id="l4.592">   }</span>
<a href="#l4.593"></a><span id="l4.593">   return NS_OK;</span>
<a href="#l4.594"></a><span id="l4.594"> }</span>
<a href="#l4.595"></a><span id="l4.595"> </span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-{</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemRemoved(nsIMsgFolder *parentItem,</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+                                                   nsISupports *item) {</span>
<a href="#l4.600"></a><span id="l4.600">   return NS_OK;</span>
<a href="#l4.601"></a><span id="l4.601"> }</span>
<a href="#l4.602"></a><span id="l4.602"> </span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue, const char *newValue)</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-{</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemPropertyChanged(</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue,</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+    const char *newValue) {</span>
<a href="#l4.608"></a><span id="l4.608">   return NS_OK;</span>
<a href="#l4.609"></a><span id="l4.609"> }</span>
<a href="#l4.610"></a><span id="l4.610"> </span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemIntPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue, int64_t newValue)</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-{</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemIntPropertyChanged(</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue,</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+    int64_t newValue) {</span>
<a href="#l4.616"></a><span id="l4.616">   return NS_OK;</span>
<a href="#l4.617"></a><span id="l4.617"> }</span>
<a href="#l4.618"></a><span id="l4.618"> </span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemBoolPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, bool oldValue, bool newValue)</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-{</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemBoolPropertyChanged(</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, bool oldValue,</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineplus">+    bool newValue) {</span>
<a href="#l4.624"></a><span id="l4.624">   return NS_OK;</span>
<a href="#l4.625"></a><span id="l4.625"> }</span>
<a href="#l4.626"></a><span id="l4.626"> </span>
<a href="#l4.627"></a><span id="l4.627" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemUnicharPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineminus">-{</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemUnicharPropertyChanged(</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue,</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineplus">+    const char16_t *newValue) {</span>
<a href="#l4.632"></a><span id="l4.632">   return NS_OK;</span>
<a href="#l4.633"></a><span id="l4.633"> }</span>
<a href="#l4.634"></a><span id="l4.634"> </span>
<a href="#l4.635"></a><span id="l4.635" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineminus">-{</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemPropertyFlagChanged(</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+    nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag,</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineplus">+    uint32_t newFlag) {</span>
<a href="#l4.640"></a><span id="l4.640">   return NS_OK;</span>
<a href="#l4.641"></a><span id="l4.641"> }</span>
<a href="#l4.642"></a><span id="l4.642"> </span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemEvent(nsIMsgFolder *aItem, const nsACString &amp;aEvent)</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineminus">-{</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemEvent(nsIMsgFolder *aItem,</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineplus">+                                                 const nsACString &amp;aEvent) {</span>
<a href="#l4.647"></a><span id="l4.647">   return NS_OK;</span>
<a href="#l4.648"></a><span id="l4.648"> }</span>
<a href="#l4.649"></a><span id="l4.649"> </span>
<a href="#l4.650"></a><span id="l4.650"> NS_IMPL_ISUPPORTS(nsLocalUndoFolderListener, nsIFolderListener)</span>
<a href="#l4.651"></a><span id="l4.651"> </span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-nsLocalUndoFolderListener::nsLocalUndoFolderListener(nsLocalMoveCopyMsgTxn *aTxn, nsIMsgFolder *aFolder)</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineminus">-{</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+nsLocalUndoFolderListener::nsLocalUndoFolderListener(</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineplus">+    nsLocalMoveCopyMsgTxn *aTxn, nsIMsgFolder *aFolder) {</span>
<a href="#l4.656"></a><span id="l4.656">   mTxn = aTxn;</span>
<a href="#l4.657"></a><span id="l4.657">   mFolder = aFolder;</span>
<a href="#l4.658"></a><span id="l4.658"> }</span>
<a href="#l4.659"></a><span id="l4.659"> </span>
<a href="#l4.660"></a><span id="l4.660" class="difflineminus">-nsLocalUndoFolderListener::~nsLocalUndoFolderListener()</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-{</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-}</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+nsLocalUndoFolderListener::~nsLocalUndoFolderListener() {}</span>
<a href="#l4.664"></a><span id="l4.664"> </span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineminus">-{</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemAdded(nsIMsgFolder *parentItem,</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineplus">+                                                     nsISupports *item) {</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.671"></a><span id="l4.671"> }</span>
<a href="#l4.672"></a><span id="l4.672"> </span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-{</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemRemoved(nsIMsgFolder *parentItem,</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+                                                       nsISupports *item) {</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.679"></a><span id="l4.679"> }</span>
<a href="#l4.680"></a><span id="l4.680"> </span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue, const char *newValue)</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-{</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemPropertyChanged(</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue,</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+    const char *newValue) {</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.688"></a><span id="l4.688"> }</span>
<a href="#l4.689"></a><span id="l4.689"> </span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemIntPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue, int64_t newValue)</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineminus">-{</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemIntPropertyChanged(</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue,</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+    int64_t newValue) {</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.697"></a><span id="l4.697"> }</span>
<a href="#l4.698"></a><span id="l4.698"> </span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemBoolPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, bool oldValue, bool newValue)</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-{</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemBoolPropertyChanged(</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, bool oldValue,</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineplus">+    bool newValue) {</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.706"></a><span id="l4.706"> }</span>
<a href="#l4.707"></a><span id="l4.707"> </span>
<a href="#l4.708"></a><span id="l4.708" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemUnicharPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-{</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemUnicharPropertyChanged(</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue,</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+    const char16_t *newValue) {</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.715"></a><span id="l4.715"> }</span>
<a href="#l4.716"></a><span id="l4.716"> </span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineminus">-{</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineminus">-    return NS_OK;</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemPropertyFlagChanged(</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+    nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag,</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+    uint32_t newFlag) {</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+  return NS_OK;</span>
<a href="#l4.724"></a><span id="l4.724"> }</span>
<a href="#l4.725"></a><span id="l4.725"> </span>
<a href="#l4.726"></a><span id="l4.726" class="difflineminus">-NS_IMETHODIMP nsLocalUndoFolderListener::OnItemEvent(nsIMsgFolder *aItem, const nsACString &amp;aEvent)</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineminus">-{</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineplus">+NS_IMETHODIMP nsLocalUndoFolderListener::OnItemEvent(nsIMsgFolder *aItem,</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+                                                     const nsACString &amp;aEvent) {</span>
<a href="#l4.730"></a><span id="l4.730">   if (mTxn &amp;&amp; mFolder &amp;&amp; aItem == mFolder) {</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineminus">-      if (aEvent.Equals(kFolderLoaded))</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineminus">-        return mTxn-&gt;UndoTransactionInternal();</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+    if (aEvent.Equals(kFolderLoaded)) return mTxn-&gt;UndoTransactionInternal();</span>
<a href="#l4.734"></a><span id="l4.734">   }</span>
<a href="#l4.735"></a><span id="l4.735"> </span>
<a href="#l4.736"></a><span id="l4.736">   return NS_ERROR_FAILURE;</span>
<a href="#l4.737"></a><span id="l4.737"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -14,72 +14,68 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> class nsLocalUndoFolderListener;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-class nsLocalMoveCopyMsgTxn : public nsIFolderListener, public nsMsgTxn</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-public:</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-    nsLocalMoveCopyMsgTxn();</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+class nsLocalMoveCopyMsgTxn : public nsIFolderListener, public nsMsgTxn {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+ public:</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  nsLocalMoveCopyMsgTxn();</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+  NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-    // overloading nsITransaction methods</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    NS_IMETHOD UndoTransaction(void) override;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-    NS_IMETHOD RedoTransaction(void) override;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  // overloading nsITransaction methods</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  NS_IMETHOD UndoTransaction(void) override;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  NS_IMETHOD RedoTransaction(void) override;</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    // helper</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    nsresult AddSrcKey(nsMsgKey aKey);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    nsresult AddSrcStatusOffset(uint32_t statusOffset);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-    nsresult AddDstKey(nsMsgKey aKey);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    nsresult AddDstMsgSize(uint32_t msgSize);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-    nsresult SetSrcFolder(nsIMsgFolder* srcFolder);</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-    nsresult GetSrcIsImap(bool *isImap);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    nsresult SetDstFolder(nsIMsgFolder* dstFolder);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-    nsresult Init(nsIMsgFolder* srcFolder,</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-                  nsIMsgFolder* dstFolder, bool isMove);</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    nsresult UndoImapDeleteFlag(nsIMsgFolder* aFolder,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-                                nsTArray&lt;nsMsgKey&gt;&amp; aKeyArray,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                                bool deleteFlag);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    nsresult UndoTransactionInternal();</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    // If the store using this undo transaction can &quot;undelete&quot; a message,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-    // it will call this function on the transaction; This makes undo/redo</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    // easy because message keys don't change after undo/redo. Otherwise,</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    // we need to adjust the src or dst keys after every undo/redo action</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    // to note the new keys.</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    void SetCanUndelete(bool canUndelete) {m_canUndelete = canUndelete;}</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  // helper</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+  nsresult AddSrcKey(nsMsgKey aKey);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+  nsresult AddSrcStatusOffset(uint32_t statusOffset);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  nsresult AddDstKey(nsMsgKey aKey);</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  nsresult AddDstMsgSize(uint32_t msgSize);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+  nsresult SetSrcFolder(nsIMsgFolder* srcFolder);</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  nsresult GetSrcIsImap(bool* isImap);</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  nsresult SetDstFolder(nsIMsgFolder* dstFolder);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  nsresult Init(nsIMsgFolder* srcFolder, nsIMsgFolder* dstFolder, bool isMove);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  nsresult UndoImapDeleteFlag(nsIMsgFolder* aFolder,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+                              nsTArray&lt;nsMsgKey&gt;&amp; aKeyArray, bool deleteFlag);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  nsresult UndoTransactionInternal();</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  // If the store using this undo transaction can &quot;undelete&quot; a message,</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  // it will call this function on the transaction; This makes undo/redo</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+  // easy because message keys don't change after undo/redo. Otherwise,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  // we need to adjust the src or dst keys after every undo/redo action</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  // to note the new keys.</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+  void SetCanUndelete(bool canUndelete) { m_canUndelete = canUndelete; }</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-private:</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    virtual ~nsLocalMoveCopyMsgTxn();</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-    nsWeakPtr m_srcFolder;</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; m_srcKeyArray; // used when src is local or imap</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-    nsTArray&lt;uint32_t&gt; m_srcStatusOffsetArray; // used when src is local</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    nsWeakPtr m_dstFolder;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    nsTArray&lt;nsMsgKey&gt; m_dstKeyArray;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    bool m_isMove;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-    bool m_srcIsImap4;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-    bool m_canUndelete;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    nsTArray&lt;uint32_t&gt; m_dstSizeArray;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    bool m_undoing; // if false, re-doing</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-    uint32_t m_numHdrsCopied;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    nsTArray&lt;nsCString&gt; m_copiedMsgIds;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-    nsLocalUndoFolderListener *mUndoFolderListener;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+ private:</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  virtual ~nsLocalMoveCopyMsgTxn();</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  nsWeakPtr m_srcFolder;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_srcKeyArray;           // used when src is local or imap</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  nsTArray&lt;uint32_t&gt; m_srcStatusOffsetArray;  // used when src is local</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  nsWeakPtr m_dstFolder;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  nsTArray&lt;nsMsgKey&gt; m_dstKeyArray;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  bool m_isMove;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  bool m_srcIsImap4;</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  bool m_canUndelete;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  nsTArray&lt;uint32_t&gt; m_dstSizeArray;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  bool m_undoing;  // if false, re-doing</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  uint32_t m_numHdrsCopied;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_copiedMsgIds;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+  nsLocalUndoFolderListener* mUndoFolderListener;</span>
<a href="#l5.100"></a><span id="l5.100"> };</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-class nsLocalUndoFolderListener : public nsIFolderListener</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-{</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-public:</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+class nsLocalUndoFolderListener : public nsIFolderListener {</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+ public:</span>
<a href="#l5.107"></a><span id="l5.107">   NS_DECL_ISUPPORTS</span>
<a href="#l5.108"></a><span id="l5.108">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l5.109"></a><span id="l5.109"> </span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-  nsLocalUndoFolderListener(nsLocalMoveCopyMsgTxn *aTxn, nsIMsgFolder *aFolder);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+  nsLocalUndoFolderListener(nsLocalMoveCopyMsgTxn* aTxn, nsIMsgFolder* aFolder);</span>
<a href="#l5.112"></a><span id="l5.112"> </span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-private:</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+ private:</span>
<a href="#l5.115"></a><span id="l5.115">   virtual ~nsLocalUndoFolderListener();</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-  nsLocalMoveCopyMsgTxn *mTxn;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-  nsIMsgFolder *mFolder;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  nsLocalMoveCopyMsgTxn* mTxn;</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  nsIMsgFolder* mFolder;</span>
<a href="#l5.120"></a><span id="l5.120"> };</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUtils.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUtils.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -17,229 +17,213 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> // it would be really cool to:</span>
<a href="#l6.9"></a><span id="l6.9"> // - cache the last hostname-&gt;path match</span>
<a href="#l6.10"></a><span id="l6.10"> // - if no such server exists, behave like an old-style mailbox URL</span>
<a href="#l6.11"></a><span id="l6.11"> // (i.e. return the mail.directory preference or something)</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-static nsresult</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-nsGetMailboxServer(const char *uriStr, nsIMsgIncomingServer** aResult)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-{</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+static nsresult nsGetMailboxServer(const char* uriStr,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+                                   nsIMsgIncomingServer** aResult) {</span>
<a href="#l6.17"></a><span id="l6.17">   nsresult rv = NS_OK;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(nsDependentCString(uriStr))</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-                                                     .Finalize(url);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+           .SetSpec(nsDependentCString(uriStr))</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+           .Finalize(url);</span>
<a href="#l6.25"></a><span id="l6.25">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   // retrieve the AccountManager</span>
<a href="#l6.28"></a><span id="l6.28">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l6.31"></a><span id="l6.31">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33">   // find all local mail &quot;no servers&quot; matching the given hostname</span>
<a href="#l6.34"></a><span id="l6.34">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; none_server;</span>
<a href="#l6.35"></a><span id="l6.35">   rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;none&quot;)).Finalize(url);</span>
<a href="#l6.36"></a><span id="l6.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.37"></a><span id="l6.37">   // No unescaping of username or hostname done here.</span>
<a href="#l6.38"></a><span id="l6.38">   // The unescaping is done inside of FindServerByURI</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-                                  getter_AddRefs(none_server));</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(none_server));</span>
<a href="#l6.42"></a><span id="l6.42">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.43"></a><span id="l6.43">     none_server.forget(aResult);</span>
<a href="#l6.44"></a><span id="l6.44">     return rv;</span>
<a href="#l6.45"></a><span id="l6.45">   }</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">   // if that fails, look for the rss hosts matching the given hostname</span>
<a href="#l6.48"></a><span id="l6.48">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; rss_server;</span>
<a href="#l6.49"></a><span id="l6.49">   rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;rss&quot;)).Finalize(url);</span>
<a href="#l6.50"></a><span id="l6.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-  rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-                                  getter_AddRefs(rss_server));</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-     rss_server.forget(aResult);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-     return rv;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(rss_server));</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+    rss_server.forget(aResult);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+    return rv;</span>
<a href="#l6.61"></a><span id="l6.61">   }</span>
<a href="#l6.62"></a><span id="l6.62"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l6.63"></a><span id="l6.63">   // find all movemail &quot;servers&quot; matching the given hostname</span>
<a href="#l6.64"></a><span id="l6.64">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; movemail_server;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-  rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;)).Finalize(url);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+  rv =</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+      NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;movemail&quot;)).Finalize(url);</span>
<a href="#l6.68"></a><span id="l6.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.69"></a><span id="l6.69">   rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-                                  getter_AddRefs(movemail_server));</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+                                       getter_AddRefs(movemail_server));</span>
<a href="#l6.72"></a><span id="l6.72">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.73"></a><span id="l6.73">     movemail_server.forget(aResult);</span>
<a href="#l6.74"></a><span id="l6.74">     return rv;</span>
<a href="#l6.75"></a><span id="l6.75">   }</span>
<a href="#l6.76"></a><span id="l6.76"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78">   // if that fails, look for the pop hosts matching the given hostname</span>
<a href="#l6.79"></a><span id="l6.79">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  {</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l6.83"></a><span id="l6.83">     rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;pop3&quot;)).Finalize(url);</span>
<a href="#l6.84"></a><span id="l6.84">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-    rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-                                    getter_AddRefs(server));</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+    rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l6.88"></a><span id="l6.88"> </span>
<a href="#l6.89"></a><span id="l6.89">     // if we can't find a pop server, maybe it's a local message</span>
<a href="#l6.90"></a><span id="l6.90">     // in an imap hierarchy. look for an imap server.</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-      rv = NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;imap&quot;)).Finalize(url);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+      rv =</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+          NS_MutateURI(url).SetScheme(NS_LITERAL_CSTRING(&quot;imap&quot;)).Finalize(url);</span>
<a href="#l6.97"></a><span id="l6.97">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-      rv = accountManager-&gt;FindServerByURI(url, false,</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-                                    getter_AddRefs(server));</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+      rv = accountManager-&gt;FindServerByURI(url, false, getter_AddRefs(server));</span>
<a href="#l6.101"></a><span id="l6.101">     }</span>
<a href="#l6.102"></a><span id="l6.102">   }</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l6.106"></a><span id="l6.106">     server.forget(aResult);</span>
<a href="#l6.107"></a><span id="l6.107">     return rv;</span>
<a href="#l6.108"></a><span id="l6.108">   }</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-  // if you fail after looking at all &quot;pop3&quot;, &quot;movemail&quot; and &quot;none&quot; servers, you fail.</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">- return rv;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  // if you fail after looking at all &quot;pop3&quot;, &quot;movemail&quot; and &quot;none&quot; servers, you</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  // fail.</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  return rv;</span>
<a href="#l6.115"></a><span id="l6.115"> }</span>
<a href="#l6.116"></a><span id="l6.116"> </span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-static nsresult</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-nsLocalURI2Server(const char* uriStr,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-                  nsIMsgIncomingServer ** aResult)</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-{</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+static nsresult nsLocalURI2Server(const char* uriStr,</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+                                  nsIMsgIncomingServer** aResult) {</span>
<a href="#l6.123"></a><span id="l6.123">   nsresult rv;</span>
<a href="#l6.124"></a><span id="l6.124">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.125"></a><span id="l6.125">   rv = nsGetMailboxServer(uriStr, getter_AddRefs(server));</span>
<a href="#l6.126"></a><span id="l6.126">   server.forget(aResult);</span>
<a href="#l6.127"></a><span id="l6.127">   return rv;</span>
<a href="#l6.128"></a><span id="l6.128"> }</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130"> // given rootURI and rootURI##folder, return on-disk path of folder</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-nsresult</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-nsLocalURI2Path(const char* rootURI, const char* uriStr,</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-                nsCString&amp; pathResult)</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-{</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineplus">+nsresult nsLocalURI2Path(const char* rootURI, const char* uriStr,</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineplus">+                         nsCString&amp; pathResult) {</span>
<a href="#l6.137"></a><span id="l6.137">   nsresult rv;</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139">   // verify that rootURI starts with &quot;mailbox:/&quot; or &quot;mailbox-message:/&quot;</span>
<a href="#l6.140"></a><span id="l6.140">   if ((PL_strcmp(rootURI, kMailboxRootURI) != 0) &amp;&amp;</span>
<a href="#l6.141"></a><span id="l6.141">       (PL_strcmp(rootURI, kMailboxMessageRootURI) != 0)) {</span>
<a href="#l6.142"></a><span id="l6.142">     return NS_ERROR_FAILURE;</span>
<a href="#l6.143"></a><span id="l6.143">   }</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145">   // verify that uristr starts with rooturi</span>
<a href="#l6.146"></a><span id="l6.146">   nsAutoCString uri(uriStr);</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  if (uri.Find(rootURI) != 0)</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  if (uri.Find(rootURI) != 0) return NS_ERROR_FAILURE;</span>
<a href="#l6.151"></a><span id="l6.151"> </span>
<a href="#l6.152"></a><span id="l6.152">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.153"></a><span id="l6.153">   rv = nsLocalURI2Server(uriStr, getter_AddRefs(server));</span>
<a href="#l6.154"></a><span id="l6.154"> </span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-    return rv;</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">   // now ask the server what it's root is</span>
<a href="#l6.160"></a><span id="l6.160">   // and begin pathResult with the mailbox root</span>
<a href="#l6.161"></a><span id="l6.161">   nsCOMPtr&lt;nsIFile&gt; localPath;</span>
<a href="#l6.162"></a><span id="l6.162">   rv = server-&gt;GetLocalPath(getter_AddRefs(localPath));</span>
<a href="#l6.163"></a><span id="l6.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.164"></a><span id="l6.164"> </span>
<a href="#l6.165"></a><span id="l6.165"> #ifdef XP_WIN</span>
<a href="#l6.166"></a><span id="l6.166">   nsString path = localPath-&gt;NativePath();</span>
<a href="#l6.167"></a><span id="l6.167">   nsCString localNativePath;</span>
<a href="#l6.168"></a><span id="l6.168">   NS_CopyUnicodeToNative(path, localNativePath);</span>
<a href="#l6.169"></a><span id="l6.169"> #else</span>
<a href="#l6.170"></a><span id="l6.170">   nsCString localNativePath = localPath-&gt;NativePath();</span>
<a href="#l6.171"></a><span id="l6.171"> #endif</span>
<a href="#l6.172"></a><span id="l6.172">   nsEscapeNativePath(localNativePath);</span>
<a href="#l6.173"></a><span id="l6.173">   pathResult = localNativePath.get();</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  const char *curPos = uriStr + PL_strlen(rootURI);</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  const char* curPos = uriStr + PL_strlen(rootURI);</span>
<a href="#l6.176"></a><span id="l6.176">   if (curPos) {</span>
<a href="#l6.177"></a><span id="l6.177">     // advance past hostname</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-    while ((*curPos)=='/') curPos++;</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    while (*curPos &amp;&amp; (*curPos)!='/') curPos++;</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+    while ((*curPos) == '/') curPos++;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+    while (*curPos &amp;&amp; (*curPos) != '/') curPos++;</span>
<a href="#l6.182"></a><span id="l6.182"> </span>
<a href="#l6.183"></a><span id="l6.183">     nsAutoCString newPath(&quot;&quot;);</span>
<a href="#l6.184"></a><span id="l6.184"> </span>
<a href="#l6.185"></a><span id="l6.185">     // Unescape folder name</span>
<a href="#l6.186"></a><span id="l6.186">     if (curPos) {</span>
<a href="#l6.187"></a><span id="l6.187">       nsCString unescapedStr;</span>
<a href="#l6.188"></a><span id="l6.188">       MsgUnescapeString(nsDependentCString(curPos), 0, unescapedStr);</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-      NS_MsgCreatePathStringFromFolderURI(unescapedStr.get(), newPath, NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+      NS_MsgCreatePathStringFromFolderURI(unescapedStr.get(), newPath,</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+                                          NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l6.192"></a><span id="l6.192">     } else</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-      NS_MsgCreatePathStringFromFolderURI(curPos, newPath, NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+      NS_MsgCreatePathStringFromFolderURI(curPos, newPath,</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+                                          NS_LITERAL_CSTRING(&quot;none&quot;));</span>
<a href="#l6.196"></a><span id="l6.196"> </span>
<a href="#l6.197"></a><span id="l6.197">     pathResult.Append('/');</span>
<a href="#l6.198"></a><span id="l6.198">     pathResult.Append(newPath);</span>
<a href="#l6.199"></a><span id="l6.199">   }</span>
<a href="#l6.200"></a><span id="l6.200"> </span>
<a href="#l6.201"></a><span id="l6.201">   return NS_OK;</span>
<a href="#l6.202"></a><span id="l6.202"> }</span>
<a href="#l6.203"></a><span id="l6.203"> </span>
<a href="#l6.204"></a><span id="l6.204"> /* parses LocalMessageURI</span>
<a href="#l6.205"></a><span id="l6.205">  * mailbox-message://folder1/folder2#123?header=none or</span>
<a href="#l6.206"></a><span id="l6.206">  * mailbox-message://folder1/folder2#1234&amp;part=1.2</span>
<a href="#l6.207"></a><span id="l6.207">  *</span>
<a href="#l6.208"></a><span id="l6.208">  * puts folder URI in folderURI (mailbox://folder1/folder2)</span>
<a href="#l6.209"></a><span id="l6.209">  * message key number in key</span>
<a href="#l6.210"></a><span id="l6.210">  */</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-nsresult nsParseLocalMessageURI(const char* uri,</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-                                nsCString&amp; folderURI,</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-                                nsMsgKey *key)</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-{</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-  if(!key)</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+nsresult nsParseLocalMessageURI(const char* uri, nsCString&amp; folderURI,</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+                                nsMsgKey* key) {</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+  if (!key) return NS_ERROR_NULL_POINTER;</span>
<a href="#l6.220"></a><span id="l6.220"> </span>
<a href="#l6.221"></a><span id="l6.221">   nsAutoCString uriStr(uri);</span>
<a href="#l6.222"></a><span id="l6.222">   int32_t keySeparator = uriStr.FindChar('#');</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-  if(keySeparator != -1)</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-  {</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+  if (keySeparator != -1) {</span>
<a href="#l6.226"></a><span id="l6.226">     int32_t keyEndSeparator = MsgFindCharInSet(uriStr, &quot;?&amp;&quot;, keySeparator);</span>
<a href="#l6.227"></a><span id="l6.227">     folderURI = StringHead(uriStr, keySeparator);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-    folderURI.Cut(7, 8);    // cut out the -message part of mailbox-message:</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineplus">+    folderURI.Cut(7, 8);  // cut out the -message part of mailbox-message:</span>
<a href="#l6.230"></a><span id="l6.230"> </span>
<a href="#l6.231"></a><span id="l6.231">     nsAutoCString keyStr;</span>
<a href="#l6.232"></a><span id="l6.232">     if (keyEndSeparator != -1)</span>
<a href="#l6.233"></a><span id="l6.233">       keyStr = Substring(uriStr, keySeparator + 1,</span>
<a href="#l6.234"></a><span id="l6.234">                          keyEndSeparator - (keySeparator + 1));</span>
<a href="#l6.235"></a><span id="l6.235">     else</span>
<a href="#l6.236"></a><span id="l6.236">       keyStr = StringTail(uriStr, uriStr.Length() - (keySeparator + 1));</span>
<a href="#l6.237"></a><span id="l6.237"> </span>
<a href="#l6.238"></a><span id="l6.238">     *key = msgKeyFromInt(ParseUint64Str(keyStr.get()));</span>
<a href="#l6.239"></a><span id="l6.239">     return NS_OK;</span>
<a href="#l6.240"></a><span id="l6.240">   }</span>
<a href="#l6.241"></a><span id="l6.241">   return NS_ERROR_FAILURE;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-</span>
<a href="#l6.243"></a><span id="l6.243"> }</span>
<a href="#l6.244"></a><span id="l6.244"> </span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-nsresult nsBuildLocalMessageURI(const char *baseURI, nsMsgKey key, nsCString&amp; uri)</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-{</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineplus">+nsresult nsBuildLocalMessageURI(const char* baseURI, nsMsgKey key,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineplus">+                                nsCString&amp; uri) {</span>
<a href="#l6.249"></a><span id="l6.249">   // need to convert mailbox://hostname/.. to mailbox-message://hostname/..</span>
<a href="#l6.250"></a><span id="l6.250">   uri.Append(baseURI);</span>
<a href="#l6.251"></a><span id="l6.251">   uri.Append('#');</span>
<a href="#l6.252"></a><span id="l6.252">   uri.AppendInt(key);</span>
<a href="#l6.253"></a><span id="l6.253">   return NS_OK;</span>
<a href="#l6.254"></a><span id="l6.254"> }</span>
<a href="#l6.255"></a><span id="l6.255"> </span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-nsresult nsCreateLocalBaseMessageURI(const nsACString&amp; baseURI, nsCString &amp;baseMessageURI)</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-{</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineplus">+nsresult nsCreateLocalBaseMessageURI(const nsACString&amp; baseURI,</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+                                     nsCString&amp; baseMessageURI) {</span>
<a href="#l6.260"></a><span id="l6.260">   nsAutoCString tailURI(baseURI);</span>
<a href="#l6.261"></a><span id="l6.261"> </span>
<a href="#l6.262"></a><span id="l6.262">   // chop off mailbox:/</span>
<a href="#l6.263"></a><span id="l6.263">   if (tailURI.Find(kMailboxRootURI) == 0)</span>
<a href="#l6.264"></a><span id="l6.264">     tailURI.Cut(0, PL_strlen(kMailboxRootURI));</span>
<a href="#l6.265"></a><span id="l6.265"> </span>
<a href="#l6.266"></a><span id="l6.266">   baseMessageURI = kMailboxMessageRootURI;</span>
<a href="#l6.267"></a><span id="l6.267">   baseMessageURI += tailURI;</span>
<a href="#l6.268"></a><span id="l6.268"> </span>
<a href="#l6.269"></a><span id="l6.269">   return NS_OK;</span>
<a href="#l6.270"></a><span id="l6.270"> }</span>
<a href="#l6.271"></a><span id="l6.271"> </span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-void nsEscapeNativePath(nsCString&amp; nativePath)</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-{</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+void nsEscapeNativePath(nsCString&amp; nativePath) {</span>
<a href="#l6.275"></a><span id="l6.275"> #if defined(XP_WIN)</span>
<a href="#l6.276"></a><span id="l6.276">   nativePath.Insert('/', 0);</span>
<a href="#l6.277"></a><span id="l6.277">   MsgReplaceChar(nativePath, '\\', '/');</span>
<a href="#l6.278"></a><span id="l6.278"> #endif</span>
<a href="#l6.279"></a><span id="l6.279"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUtils.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUtils.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,24 +7,23 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #define NS_LOCALUTILS_H</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsString.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;MailNewsTypes2.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> static const char kMailboxRootURI[] = &quot;mailbox:/&quot;;</span>
<a href="#l7.10"></a><span id="l7.10"> static const char kMailboxMessageRootURI[] = &quot;mailbox-message:/&quot;;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-nsresult</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-nsLocalURI2Path(const char* rootURI, const char* uriStr, nsCString&amp; pathResult);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+nsresult nsLocalURI2Path(const char* rootURI, const char* uriStr,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+                         nsCString&amp; pathResult);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-nsresult</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-nsParseLocalMessageURI(const char* uri, nsCString&amp; folderURI, nsMsgKey *key);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+nsresult nsParseLocalMessageURI(const char* uri, nsCString&amp; folderURI,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+                                nsMsgKey* key);</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-nsresult</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-nsBuildLocalMessageURI(const char* baseURI, nsMsgKey key, nsCString&amp; uri);</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+nsresult nsBuildLocalMessageURI(const char* baseURI, nsMsgKey key,</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+                                nsCString&amp; uri);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-nsresult</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-nsCreateLocalBaseMessageURI(const nsACString&amp; baseURI, nsCString &amp;baseMessageURI);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+nsresult nsCreateLocalBaseMessageURI(const nsACString&amp; baseURI,</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+                                     nsCString&amp; baseMessageURI);</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-void</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-nsEscapeNativePath(nsCString&amp; nativePath);</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+void nsEscapeNativePath(nsCString&amp; nativePath);</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-#endif //NS_LOCALUTILS_H</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+#endif  // NS_LOCALUTILS_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -37,29 +37,24 @@ static LazyLogModule MAILBOX(&quot;Mailbox&quot;);</span>
<a href="#l8.4"></a><span id="l8.4">  * 2000 seems good for news</span>
<a href="#l8.5"></a><span id="l8.5">  *</span>
<a href="#l8.6"></a><span id="l8.6">  * jwz: I increased this to 4k since it must be big enough to hold the</span>
<a href="#l8.7"></a><span id="l8.7">  * entire button-bar HTML, and with the new &quot;mailto&quot; format, that can</span>
<a href="#l8.8"></a><span id="l8.8">  * contain arbitrarily long header fields like &quot;references&quot;.</span>
<a href="#l8.9"></a><span id="l8.9">  *</span>
<a href="#l8.10"></a><span id="l8.10">  * fortezza: proxy auth is huge, buffer increased to 8k (sigh).</span>
<a href="#l8.11"></a><span id="l8.11">  */</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#define OUTPUT_BUFFER_SIZE (4096*2)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+#define OUTPUT_BUFFER_SIZE (4096 * 2)</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-nsMailboxProtocol::nsMailboxProtocol(nsIURI * aURI)</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-    : nsMsgProtocol(aURI)</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-{</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-}</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+nsMailboxProtocol::nsMailboxProtocol(nsIURI *aURI) : nsMsgProtocol(aURI) {}</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-nsMailboxProtocol::~nsMailboxProtocol()</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-{</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-}</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+nsMailboxProtocol::~nsMailboxProtocol() {}</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-nsresult nsMailboxProtocol::OpenMultipleMsgTransport(uint64_t offset, int64_t size)</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-{</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+nsresult nsMailboxProtocol::OpenMultipleMsgTransport(uint64_t offset,</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+                                                     int64_t size) {</span>
<a href="#l8.30"></a><span id="l8.30">   nsresult rv;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   nsCOMPtr&lt;nsIStreamTransportService&gt; serv =</span>
<a href="#l8.33"></a><span id="l8.33">       do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.34"></a><span id="l8.34">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   nsCOMPtr&lt;nsIInputStream&gt; clonedStream;</span>
<a href="#l8.37"></a><span id="l8.37">   nsCOMPtr&lt;nsIInputStream&gt; replacementStream;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineat">@@ -71,133 +66,125 @@ nsresult nsMailboxProtocol::OpenMultiple</span>
<a href="#l8.39"></a><span id="l8.39">     // If m_multipleMsgMoveCopyStream is not cloneable, NS_CloneInputStream</span>
<a href="#l8.40"></a><span id="l8.40">     // will clone it using a pipe. In order to keep the copy alive and working,</span>
<a href="#l8.41"></a><span id="l8.41">     // we have to replace the original stream with the replacement.</span>
<a href="#l8.42"></a><span id="l8.42">     m_multipleMsgMoveCopyStream = replacementStream.forget();</span>
<a href="#l8.43"></a><span id="l8.43">   }</span>
<a href="#l8.44"></a><span id="l8.44">   // XXX 64-bit</span>
<a href="#l8.45"></a><span id="l8.45">   // This can be called with size == -1 which means &quot;read as much as we can&quot;.</span>
<a href="#l8.46"></a><span id="l8.46">   // We pass this on as UINT64_MAX, which is in fact uint64_t(-1).</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  RefPtr&lt;SlicedInputStream&gt; slicedStream =</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-    new SlicedInputStream(clonedStream.forget(), offset,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-                          size == -1 ? UINT64_MAX : uint64_t(size));</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  RefPtr&lt;SlicedInputStream&gt; slicedStream = new SlicedInputStream(</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      clonedStream.forget(), offset, size == -1 ? UINT64_MAX : uint64_t(size));</span>
<a href="#l8.52"></a><span id="l8.52">   // Always close the sliced stream when done, we still have the original.</span>
<a href="#l8.53"></a><span id="l8.53">   rv = serv-&gt;CreateInputTransport(slicedStream, true,</span>
<a href="#l8.54"></a><span id="l8.54">                                   getter_AddRefs(m_transport));</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">   return rv;</span>
<a href="#l8.57"></a><span id="l8.57"> }</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-nsresult nsMailboxProtocol::Initialize(nsIURI * aURL)</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-{</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+nsresult nsMailboxProtocol::Initialize(nsIURI *aURL) {</span>
<a href="#l8.62"></a><span id="l8.62">   NS_ASSERTION(aURL, &quot;invalid URL passed into MAILBOX Protocol&quot;);</span>
<a href="#l8.63"></a><span id="l8.63">   nsresult rv = NS_OK;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-  if (aURL)</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineminus">-  {</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  if (aURL) {</span>
<a href="#l8.67"></a><span id="l8.67">     m_runningUrl = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; m_runningUrl)</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-      nsCOMPtr &lt;nsIMsgWindow&gt; window;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; m_runningUrl) {</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; window;</span>
<a href="#l8.73"></a><span id="l8.73">       rv = m_runningUrl-&gt;GetMailboxAction(&amp;m_mailboxAction);</span>
<a href="#l8.74"></a><span id="l8.74">       // clear stopped flag on msg window, because we care.</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-      nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-      if (mailnewsUrl)</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-      {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+      if (mailnewsUrl) {</span>
<a href="#l8.80"></a><span id="l8.80">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(window));</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-        if (window)</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-          window-&gt;SetStopped(false);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+        if (window) window-&gt;SetStopped(false);</span>
<a href="#l8.84"></a><span id="l8.84">       }</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-      if (m_mailboxAction == nsIMailboxUrl::ActionParseMailbox)</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-      {</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+      if (m_mailboxAction == nsIMailboxUrl::ActionParseMailbox) {</span>
<a href="#l8.89"></a><span id="l8.89">         // Set the length of the file equal to the max progress</span>
<a href="#l8.90"></a><span id="l8.90">         nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l8.91"></a><span id="l8.91">         GetFileFromURL(aURL, getter_AddRefs(file));</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-        if (file)</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-        {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+        if (file) {</span>
<a href="#l8.95"></a><span id="l8.95">           int64_t fileSize = 0;</span>
<a href="#l8.96"></a><span id="l8.96">           file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l8.97"></a><span id="l8.97">           mailnewsUrl-&gt;SetMaxProgress(fileSize);</span>
<a href="#l8.98"></a><span id="l8.98">         }</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        rv = OpenFileSocket(aURL, 0, -1 /* read in all the bytes in the file */);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-      }</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-      else</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-      {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-        // we need to specify a byte range to read in so we read in JUST the message we want.</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineplus">+        rv =</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineplus">+            OpenFileSocket(aURL, 0, -1 /* read in all the bytes in the file */);</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+      } else {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+        // we need to specify a byte range to read in so we read in JUST the</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+        // message we want.</span>
<a href="#l8.110"></a><span id="l8.110">         rv = SetupMessageExtraction();</span>
<a href="#l8.111"></a><span id="l8.111">         if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.112"></a><span id="l8.112">         uint32_t msgSize = 0;</span>
<a href="#l8.113"></a><span id="l8.113">         rv = m_runningUrl-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l8.114"></a><span id="l8.114">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l8.115"></a><span id="l8.115">         SetContentLength(msgSize);</span>
<a href="#l8.116"></a><span id="l8.116">         mailnewsUrl-&gt;SetMaxProgress(msgSize);</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-        if (RunningMultipleMsgUrl())</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        {</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-          // if we're running multiple msg url, we clear the event sink because the multiple</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-          // msg urls will handle setting the progress.</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+        if (RunningMultipleMsgUrl()) {</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+          // if we're running multiple msg url, we clear the event sink because</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+          // the multiple msg urls will handle setting the progress.</span>
<a href="#l8.125"></a><span id="l8.125">           mProgressEventSink = nullptr;</span>
<a href="#l8.126"></a><span id="l8.126">         }</span>
<a href="#l8.127"></a><span id="l8.127"> </span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-        {</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl =</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+            do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.134"></a><span id="l8.134">           nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.135"></a><span id="l8.135">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.136"></a><span id="l8.136">           rv = msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-          {</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr) {</span>
<a href="#l8.140"></a><span id="l8.140">             rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; folder)</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-            {</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l8.144"></a><span id="l8.144">               nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l8.145"></a><span id="l8.145">               int64_t offset = 0;</span>
<a href="#l8.146"></a><span id="l8.146">               bool reusable = false;</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-              rv = folder-&gt;GetMsgInputStream(msgHdr, &amp;reusable, getter_AddRefs(stream));</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+              rv = folder-&gt;GetMsgInputStream(msgHdr, &amp;reusable,</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+                                             getter_AddRefs(stream));</span>
<a href="#l8.151"></a><span id="l8.151">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-              nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(stream, &amp;rv));</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+              nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+                  do_QueryInterface(stream, &amp;rv));</span>
<a href="#l8.155"></a><span id="l8.155">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.156"></a><span id="l8.156">               seekableStream-&gt;Tell(&amp;offset);</span>
<a href="#l8.157"></a><span id="l8.157">               // create input stream transport</span>
<a href="#l8.158"></a><span id="l8.158">               nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l8.159"></a><span id="l8.159">                   do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.160"></a><span id="l8.160">               if (NS_FAILED(rv)) return rv;</span>
<a href="#l8.161"></a><span id="l8.161">               m_readCount = msgSize;</span>
<a href="#l8.162"></a><span id="l8.162">               // Save the stream for reuse, but only for multiple URLs.</span>
<a href="#l8.163"></a><span id="l8.163">               if (reusable &amp;&amp; RunningMultipleMsgUrl()) {</span>
<a href="#l8.164"></a><span id="l8.164">                 nsCOMPtr&lt;nsIInputStream&gt; clonedStream;</span>
<a href="#l8.165"></a><span id="l8.165">                 nsCOMPtr&lt;nsIInputStream&gt; replacementStream;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-                rv = NS_CloneInputStream(stream,</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-                                         getter_AddRefs(clonedStream),</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+                rv = NS_CloneInputStream(stream, getter_AddRefs(clonedStream),</span>
<a href="#l8.169"></a><span id="l8.169">                                          getter_AddRefs(replacementStream));</span>
<a href="#l8.170"></a><span id="l8.170">                 NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.171"></a><span id="l8.171">                 if (replacementStream) {</span>
<a href="#l8.172"></a><span id="l8.172">                   // If stream is not cloneable, NS_CloneInputStream</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-                  // will clone it using a pipe. In order to keep the copy alive and working,</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-                  // we have to replace the original stream with the replacement.</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+                  // will clone it using a pipe. In order to keep the copy alive</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+                  // and working, we have to replace the original stream with</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+                  // the replacement.</span>
<a href="#l8.178"></a><span id="l8.178">                   stream = replacementStream.forget();</span>
<a href="#l8.179"></a><span id="l8.179">                 }</span>
<a href="#l8.180"></a><span id="l8.180">                 // Keep the original and use the clone for the next operation.</span>
<a href="#l8.181"></a><span id="l8.181">                 m_multipleMsgMoveCopyStream = stream;</span>
<a href="#l8.182"></a><span id="l8.182">                 stream = clonedStream;</span>
<a href="#l8.183"></a><span id="l8.183">               } else {</span>
<a href="#l8.184"></a><span id="l8.184">                 reusable = false;</span>
<a href="#l8.185"></a><span id="l8.185">               }</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-              RefPtr&lt;SlicedInputStream&gt; slicedStream =</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-                new SlicedInputStream(stream.forget(), offset, uint64_t(msgSize));</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-              // Always close the sliced stream when done, we still have the original.</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+              RefPtr&lt;SlicedInputStream&gt; slicedStream = new SlicedInputStream(</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+                  stream.forget(), offset, uint64_t(msgSize));</span>
<a href="#l8.191"></a><span id="l8.191" class="difflineplus">+              // Always close the sliced stream when done, we still have the</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineplus">+              // original.</span>
<a href="#l8.193"></a><span id="l8.193">               rv = sts-&gt;CreateInputTransport(slicedStream, true,</span>
<a href="#l8.194"></a><span id="l8.194">                                              getter_AddRefs(m_transport));</span>
<a href="#l8.195"></a><span id="l8.195"> </span>
<a href="#l8.196"></a><span id="l8.196">               m_socketIsOpen = false;</span>
<a href="#l8.197"></a><span id="l8.197">             }</span>
<a href="#l8.198"></a><span id="l8.198">           }</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-          if (!folder) // must be a .eml file</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+          if (!folder)  // must be a .eml file</span>
<a href="#l8.201"></a><span id="l8.201">             rv = OpenFileSocket(aURL, 0, int64_t(msgSize));</span>
<a href="#l8.202"></a><span id="l8.202">         }</span>
<a href="#l8.203"></a><span id="l8.203">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l8.204"></a><span id="l8.204">       }</span>
<a href="#l8.205"></a><span id="l8.205">     }</span>
<a href="#l8.206"></a><span id="l8.206">   }</span>
<a href="#l8.207"></a><span id="l8.207"> </span>
<a href="#l8.208"></a><span id="l8.208">   m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true);</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineat">@@ -210,545 +197,515 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l8.210"></a><span id="l8.210">   m_tempMessageFile = m_tempMsgFile;</span>
<a href="#l8.211"></a><span id="l8.211">   return rv;</span>
<a href="#l8.212"></a><span id="l8.212"> }</span>
<a href="#l8.213"></a><span id="l8.213"> </span>
<a href="#l8.214"></a><span id="l8.214"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.215"></a><span id="l8.215"> // we support the nsIStreamListener interface</span>
<a href="#l8.216"></a><span id="l8.216"> ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.217"></a><span id="l8.217"> </span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-NS_IMETHODIMP nsMailboxProtocol::OnStartRequest(nsIRequest *request)</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-{</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-  // extract the appropriate event sinks from the url and initialize them in our protocol data</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-  // the URL should be queried for a nsINewsURL. If it doesn't support a news URL interface then</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-  // we have an error.</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-  if (m_nextState == MAILBOX_READ_FOLDER &amp;&amp; m_mailboxParser)</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-  {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+NS_IMETHODIMP nsMailboxProtocol::OnStartRequest(nsIRequest *request) {</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+  // extract the appropriate event sinks from the url and initialize them in our</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+  // protocol data the URL should be queried for a nsINewsURL. If it doesn't</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+  // support a news URL interface then we have an error.</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineplus">+  if (m_nextState == MAILBOX_READ_FOLDER &amp;&amp; m_mailboxParser) {</span>
<a href="#l8.230"></a><span id="l8.230">     // we need to inform our mailbox parser that it's time to start...</span>
<a href="#l8.231"></a><span id="l8.231">     // NOTE: `request` here will be an nsInputStreamPump, but our callbacks</span>
<a href="#l8.232"></a><span id="l8.232">     // are expecting to be able to QI to a `nsIChannel` to get the URI.</span>
<a href="#l8.233"></a><span id="l8.233">     // So we pass `this`. See Bug 1528662.</span>
<a href="#l8.234"></a><span id="l8.234">     m_mailboxParser-&gt;OnStartRequest(this);</span>
<a href="#l8.235"></a><span id="l8.235">   }</span>
<a href="#l8.236"></a><span id="l8.236">   return nsMsgProtocol::OnStartRequest(request);</span>
<a href="#l8.237"></a><span id="l8.237"> }</span>
<a href="#l8.238"></a><span id="l8.238"> </span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-bool nsMailboxProtocol::RunningMultipleMsgUrl()</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineminus">-{</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-  if (m_mailboxAction == nsIMailboxUrl::ActionCopyMessage || m_mailboxAction == nsIMailboxUrl::ActionMoveMessage)</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineminus">-  {</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+bool nsMailboxProtocol::RunningMultipleMsgUrl() {</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineplus">+  if (m_mailboxAction == nsIMailboxUrl::ActionCopyMessage ||</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineplus">+      m_mailboxAction == nsIMailboxUrl::ActionMoveMessage) {</span>
<a href="#l8.246"></a><span id="l8.246">     uint32_t numMoveCopyMsgs;</span>
<a href="#l8.247"></a><span id="l8.247">     nsresult rv = m_runningUrl-&gt;GetNumMoveCopyMsgs(&amp;numMoveCopyMsgs);</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; numMoveCopyMsgs &gt; 1)</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-      return true;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; numMoveCopyMsgs &gt; 1) return true;</span>
<a href="#l8.251"></a><span id="l8.251">   }</span>
<a href="#l8.252"></a><span id="l8.252">   return false;</span>
<a href="#l8.253"></a><span id="l8.253"> }</span>
<a href="#l8.254"></a><span id="l8.254"> </span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-NS_IMETHODIMP nsMailboxProtocol::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-{</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+// stop binding is a &quot;notification&quot; informing us that the stream associated with</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+// aURL is going away.</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+NS_IMETHODIMP nsMailboxProtocol::OnStopRequest(nsIRequest *request,</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+                                               nsresult aStatus) {</span>
<a href="#l8.262"></a><span id="l8.262">   nsresult rv;</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-  if (m_nextState == MAILBOX_READ_FOLDER &amp;&amp; m_mailboxParser)</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-  {</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-    // we need to inform our mailbox parser that there is no more incoming data...</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-    // NOTE: `request` here will be an nsInputStreamPump, but our callbacks</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-    // are expecting to be able to QI to a `nsIChannel` to get the URI.</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-    // So we pass `this`. See Bug 1528662.</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+  if (m_nextState == MAILBOX_READ_FOLDER &amp;&amp; m_mailboxParser) {</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+    // we need to inform our mailbox parser that there is no more incoming</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineplus">+    // data... NOTE: `request` here will be an nsInputStreamPump, but our</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineplus">+    // callbacks are expecting to be able to QI to a `nsIChannel` to get the</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+    // URI. So we pass `this`. See Bug 1528662.</span>
<a href="#l8.274"></a><span id="l8.274">     m_mailboxParser-&gt;OnStopRequest(this, aStatus);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-  }</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineminus">-  else if (m_nextState == MAILBOX_READ_MESSAGE)</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-  {</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+  } else if (m_nextState == MAILBOX_READ_MESSAGE) {</span>
<a href="#l8.279"></a><span id="l8.279">     DoneReadingMessage();</span>
<a href="#l8.280"></a><span id="l8.280">   }</span>
<a href="#l8.281"></a><span id="l8.281">   // I'm not getting cancel status - maybe the load group still has the status.</span>
<a href="#l8.282"></a><span id="l8.282">   bool stopped = false;</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-  if (m_runningUrl)</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-  {</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-    {</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-      nsCOMPtr &lt;nsIMsgWindow&gt; window;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+  if (m_runningUrl) {</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+    if (mailnewsUrl) {</span>
<a href="#l8.292"></a><span id="l8.292" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; window;</span>
<a href="#l8.293"></a><span id="l8.293">       mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(window));</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-      if (window)</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-        window-&gt;GetStopped(&amp;stopped);</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineplus">+      if (window) window-&gt;GetStopped(&amp;stopped);</span>
<a href="#l8.297"></a><span id="l8.297">     }</span>
<a href="#l8.298"></a><span id="l8.298"> </span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-    if (!stopped &amp;&amp; NS_SUCCEEDED(aStatus) &amp;&amp; (m_mailboxAction == nsIMailboxUrl::ActionCopyMessage || m_mailboxAction == nsIMailboxUrl::ActionMoveMessage))</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-    {</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+    if (!stopped &amp;&amp; NS_SUCCEEDED(aStatus) &amp;&amp;</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+        (m_mailboxAction == nsIMailboxUrl::ActionCopyMessage ||</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+         m_mailboxAction == nsIMailboxUrl::ActionMoveMessage)) {</span>
<a href="#l8.304"></a><span id="l8.304">       uint32_t numMoveCopyMsgs;</span>
<a href="#l8.305"></a><span id="l8.305">       uint32_t curMoveCopyMsgIndex;</span>
<a href="#l8.306"></a><span id="l8.306">       rv = m_runningUrl-&gt;GetNumMoveCopyMsgs(&amp;numMoveCopyMsgs);</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; numMoveCopyMsgs &gt; 0)</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineminus">-      {</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; numMoveCopyMsgs &gt; 0) {</span>
<a href="#l8.310"></a><span id="l8.310">         m_runningUrl-&gt;GetCurMoveCopyMsgIndex(&amp;curMoveCopyMsgIndex);</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-        if (++curMoveCopyMsgIndex &lt; numMoveCopyMsgs)</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineminus">-        {</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineminus">-          if (!mSuppressListenerNotifications &amp;&amp; m_channelListener)</span>
<a href="#l8.314"></a><span id="l8.314" class="difflineminus">-          {</span>
<a href="#l8.315"></a><span id="l8.315" class="difflineminus">-            nsCOMPtr&lt;nsICopyMessageStreamListener&gt; listener = do_QueryInterface(m_channelListener, &amp;rv);</span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-            if (listener)</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineminus">-            {</span>
<a href="#l8.318"></a><span id="l8.318" class="difflineplus">+        if (++curMoveCopyMsgIndex &lt; numMoveCopyMsgs) {</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineplus">+          if (!mSuppressListenerNotifications &amp;&amp; m_channelListener) {</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+            nsCOMPtr&lt;nsICopyMessageStreamListener&gt; listener =</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineplus">+                do_QueryInterface(m_channelListener, &amp;rv);</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+            if (listener) {</span>
<a href="#l8.323"></a><span id="l8.323">               listener-&gt;EndCopy(m_runningUrl, aStatus);</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-              listener-&gt;StartMessage(); // start next message.</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+              listener-&gt;StartMessage();  // start next message.</span>
<a href="#l8.326"></a><span id="l8.326">             }</span>
<a href="#l8.327"></a><span id="l8.327">           }</span>
<a href="#l8.328"></a><span id="l8.328">           m_runningUrl-&gt;SetCurMoveCopyMsgIndex(curMoveCopyMsgIndex);</span>
<a href="#l8.329"></a><span id="l8.329" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDBHdr&gt; nextMsg;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-          rv = m_runningUrl-&gt;GetMoveCopyMsgHdrForIndex(curMoveCopyMsgIndex, getter_AddRefs(nextMsg));</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; nextMsg)</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineminus">-          {</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; nextMsg;</span>
<a href="#l8.334"></a><span id="l8.334" class="difflineplus">+          rv = m_runningUrl-&gt;GetMoveCopyMsgHdrForIndex(curMoveCopyMsgIndex,</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineplus">+                                                       getter_AddRefs(nextMsg));</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; nextMsg) {</span>
<a href="#l8.337"></a><span id="l8.337">             uint32_t msgSize = 0;</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-            nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l8.340"></a><span id="l8.340">             nextMsg-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-            NS_ASSERTION(msgFolder, &quot;couldn't get folder for next msg in multiple msg local copy&quot;);</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-            if (msgFolder)</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineminus">-            {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+            NS_ASSERTION(</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+                msgFolder,</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+                &quot;couldn't get folder for next msg in multiple msg local copy&quot;);</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+            if (msgFolder) {</span>
<a href="#l8.348"></a><span id="l8.348">               nsCString uri;</span>
<a href="#l8.349"></a><span id="l8.349">               msgFolder-&gt;GetUriForMsg(nextMsg, uri);</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineminus">-              nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.351"></a><span id="l8.351" class="difflineminus">-              if (msgUrl)</span>
<a href="#l8.352"></a><span id="l8.352" class="difflineminus">-              {</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineplus">+              nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl =</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineplus">+                  do_QueryInterface(m_runningUrl);</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+              if (msgUrl) {</span>
<a href="#l8.356"></a><span id="l8.356">                 msgUrl-&gt;SetOriginalSpec(uri.get());</span>
<a href="#l8.357"></a><span id="l8.357">                 msgUrl-&gt;SetUri(uri.get());</span>
<a href="#l8.358"></a><span id="l8.358"> </span>
<a href="#l8.359"></a><span id="l8.359">                 uint64_t msgOffset;</span>
<a href="#l8.360"></a><span id="l8.360">                 nextMsg-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l8.361"></a><span id="l8.361">                 nextMsg-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l8.362"></a><span id="l8.362">                 // now we have to seek to the right position in the file and</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-                // basically re-initialize the transport with the correct message size.</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineminus">-                // then, we have to make sure the url keeps running somehow.</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineminus">-                nsCOMPtr&lt;nsISupports&gt; urlSupports = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+                // basically re-initialize the transport with the correct</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+                // message size. then, we have to make sure the url keeps</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineplus">+                // running somehow.</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+                nsCOMPtr&lt;nsISupports&gt; urlSupports =</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineplus">+                    do_QueryInterface(m_runningUrl);</span>
<a href="#l8.371"></a><span id="l8.371">                 //</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-                // put us in a state where we are always notified of incoming data</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+                // put us in a state where we are always notified of incoming</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+                // data</span>
<a href="#l8.375"></a><span id="l8.375">                 //</span>
<a href="#l8.376"></a><span id="l8.376"> </span>
<a href="#l8.377"></a><span id="l8.377" class="difflineminus">-                m_transport = nullptr; // open new stream transport</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineplus">+                m_transport = nullptr;  // open new stream transport</span>
<a href="#l8.379"></a><span id="l8.379">                 m_outputStream = nullptr;</span>
<a href="#l8.380"></a><span id="l8.380"> </span>
<a href="#l8.381"></a><span id="l8.381" class="difflineminus">-                if (m_multipleMsgMoveCopyStream)</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineminus">-                {</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+                if (m_multipleMsgMoveCopyStream) {</span>
<a href="#l8.384"></a><span id="l8.384">                   rv = OpenMultipleMsgTransport(msgOffset, msgSize);</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineminus">-                }</span>
<a href="#l8.386"></a><span id="l8.386" class="difflineminus">-                else</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-                {</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineplus">+                } else {</span>
<a href="#l8.389"></a><span id="l8.389">                   nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l8.390"></a><span id="l8.390">                   bool reusable = false;</span>
<a href="#l8.391"></a><span id="l8.391">                   rv = msgFolder-&gt;GetMsgInputStream(nextMsg, &amp;reusable,</span>
<a href="#l8.392"></a><span id="l8.392">                                                     getter_AddRefs(stream));</span>
<a href="#l8.393"></a><span id="l8.393" class="difflineminus">-                  NS_ASSERTION(!reusable, &quot;We thought streams were not reusable!&quot;);</span>
<a href="#l8.394"></a><span id="l8.394" class="difflineplus">+                  NS_ASSERTION(!reusable,</span>
<a href="#l8.395"></a><span id="l8.395" class="difflineplus">+                               &quot;We thought streams were not reusable!&quot;);</span>
<a href="#l8.396"></a><span id="l8.396"> </span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-                  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-                  {</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineplus">+                  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.400"></a><span id="l8.400">                     // create input stream transport</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-                    nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-                        do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+                    nsCOMPtr&lt;nsIStreamTransportService&gt; sts = do_GetService(</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+                        NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l8.405"></a><span id="l8.405"> </span>
<a href="#l8.406"></a><span id="l8.406" class="difflineminus">-                    if (NS_SUCCEEDED(rv))</span>
<a href="#l8.407"></a><span id="l8.407" class="difflineminus">-                    {</span>
<a href="#l8.408"></a><span id="l8.408" class="difflineplus">+                    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.409"></a><span id="l8.409">                       m_readCount = msgSize;</span>
<a href="#l8.410"></a><span id="l8.410">                       RefPtr&lt;SlicedInputStream&gt; slicedStream =</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-                        new SlicedInputStream(stream.forget(), msgOffset, uint64_t(msgSize));</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-                      rv = sts-&gt;CreateInputTransport(slicedStream, true,</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineminus">-                                                     getter_AddRefs(m_transport));</span>
<a href="#l8.414"></a><span id="l8.414" class="difflineplus">+                          new SlicedInputStream(stream.forget(), msgOffset,</span>
<a href="#l8.415"></a><span id="l8.415" class="difflineplus">+                                                uint64_t(msgSize));</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineplus">+                      rv = sts-&gt;CreateInputTransport(</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineplus">+                          slicedStream, true, getter_AddRefs(m_transport));</span>
<a href="#l8.418"></a><span id="l8.418">                     }</span>
<a href="#l8.419"></a><span id="l8.419">                   }</span>
<a href="#l8.420"></a><span id="l8.420">                 }</span>
<a href="#l8.421"></a><span id="l8.421"> </span>
<a href="#l8.422"></a><span id="l8.422" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-                {</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineplus">+                if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.425"></a><span id="l8.425">                   nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l8.426"></a><span id="l8.426" class="difflineminus">-                  rv = m_transport-&gt;OpenInputStream(0, 0, 0, getter_AddRefs(stream));</span>
<a href="#l8.427"></a><span id="l8.427" class="difflineplus">+                  rv = m_transport-&gt;OpenInputStream(0, 0, 0,</span>
<a href="#l8.428"></a><span id="l8.428" class="difflineplus">+                                                    getter_AddRefs(stream));</span>
<a href="#l8.429"></a><span id="l8.429"> </span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-                  if (NS_SUCCEEDED(rv))</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-                  {</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+                  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.433"></a><span id="l8.433">                     nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l8.434"></a><span id="l8.434" class="difflineminus">-                    rv = NS_NewInputStreamPump(getter_AddRefs(pump), stream.forget());</span>
<a href="#l8.435"></a><span id="l8.435" class="difflineplus">+                    rv = NS_NewInputStreamPump(getter_AddRefs(pump),</span>
<a href="#l8.436"></a><span id="l8.436" class="difflineplus">+                                               stream.forget());</span>
<a href="#l8.437"></a><span id="l8.437">                     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.438"></a><span id="l8.438">                       rv = pump-&gt;AsyncRead(this, urlSupports);</span>
<a href="#l8.439"></a><span id="l8.439" class="difflineminus">-                      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.440"></a><span id="l8.440" class="difflineminus">-                        m_request = pump;</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineplus">+                      if (NS_SUCCEEDED(rv)) m_request = pump;</span>
<a href="#l8.442"></a><span id="l8.442">                     }</span>
<a href="#l8.443"></a><span id="l8.443">                   }</span>
<a href="#l8.444"></a><span id="l8.444">                 }</span>
<a href="#l8.445"></a><span id="l8.445"> </span>
<a href="#l8.446"></a><span id="l8.446">                 NS_ASSERTION(NS_SUCCEEDED(rv), &quot;AsyncRead failed&quot;);</span>
<a href="#l8.447"></a><span id="l8.447">                 if (m_loadGroup)</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-                  m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr, aStatus);</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-                m_socketIsOpen = true; // mark the channel as open</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineplus">+                  m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this),</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineplus">+                                             nullptr, aStatus);</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineplus">+                m_socketIsOpen = true;  // mark the channel as open</span>
<a href="#l8.453"></a><span id="l8.453">                 return aStatus;</span>
<a href="#l8.454"></a><span id="l8.454">               }</span>
<a href="#l8.455"></a><span id="l8.455">             }</span>
<a href="#l8.456"></a><span id="l8.456">           }</span>
<a href="#l8.457"></a><span id="l8.457" class="difflineminus">-        }</span>
<a href="#l8.458"></a><span id="l8.458" class="difflineminus">-        else</span>
<a href="#l8.459"></a><span id="l8.459" class="difflineminus">-        {</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineplus">+        } else {</span>
<a href="#l8.461"></a><span id="l8.461">         }</span>
<a href="#l8.462"></a><span id="l8.462">       }</span>
<a href="#l8.463"></a><span id="l8.463">     }</span>
<a href="#l8.464"></a><span id="l8.464">   }</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-  // and we want to mark ourselves for deletion or some how inform our protocol manager that we are</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineminus">-  // available for another url if there is one.</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+  // and we want to mark ourselves for deletion or some how inform our protocol</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+  // manager that we are available for another url if there is one.</span>
<a href="#l8.469"></a><span id="l8.469"> </span>
<a href="#l8.470"></a><span id="l8.470" class="difflineminus">-  // mscott --&gt; maybe we should set our state to done because we don't run multiple urls in a mailbox</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-  // protocol connection....</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineplus">+  // mscott --&gt; maybe we should set our state to done because we don't run</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+  // multiple urls in a mailbox protocol connection....</span>
<a href="#l8.474"></a><span id="l8.474">   m_nextState = MAILBOX_DONE;</span>
<a href="#l8.475"></a><span id="l8.475"> </span>
<a href="#l8.476"></a><span id="l8.476" class="difflineminus">-  // the following is for smoke test purposes. QA is looking at this &quot;Mailbox Done&quot; string which</span>
<a href="#l8.477"></a><span id="l8.477" class="difflineminus">-  // is printed out to the console and determining if the mail app loaded up correctly...obviously</span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-  // this solution is not very good so we should look at something better, but don't remove this</span>
<a href="#l8.479"></a><span id="l8.479" class="difflineminus">-  // line before talking to me (mscott) and mailnews QA....</span>
<a href="#l8.480"></a><span id="l8.480" class="difflineplus">+  // the following is for smoke test purposes. QA is looking at this &quot;Mailbox</span>
<a href="#l8.481"></a><span id="l8.481" class="difflineplus">+  // Done&quot; string which is printed out to the console and determining if the</span>
<a href="#l8.482"></a><span id="l8.482" class="difflineplus">+  // mail app loaded up correctly...obviously this solution is not very good so</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineplus">+  // we should look at something better, but don't remove this line before</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineplus">+  // talking to me (mscott) and mailnews QA....</span>
<a href="#l8.485"></a><span id="l8.485"> </span>
<a href="#l8.486"></a><span id="l8.486">   MOZ_LOG(MAILBOX, LogLevel::Info, (&quot;Mailbox Done\n&quot;));</span>
<a href="#l8.487"></a><span id="l8.487"> </span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-  // when on stop binding is called, we as the protocol are done...let's close down the connection</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-  // releasing all of our interfaces. It's important to remember that this on stop binding call</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-  // is coming from netlib so they are never going to ping us again with on data available. This means</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-  // we'll never be going through the Process loop...</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+  // when on stop binding is called, we as the protocol are done...let's close</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+  // down the connection releasing all of our interfaces. It's important to</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+  // remember that this on stop binding call is coming from netlib so they are</span>
<a href="#l8.495"></a><span id="l8.495" class="difflineplus">+  // never going to ping us again with on data available. This means we'll never</span>
<a href="#l8.496"></a><span id="l8.496" class="difflineplus">+  // be going through the Process loop...</span>
<a href="#l8.497"></a><span id="l8.497"> </span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-  if (m_multipleMsgMoveCopyStream)</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-  {</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineplus">+  if (m_multipleMsgMoveCopyStream) {</span>
<a href="#l8.501"></a><span id="l8.501">     m_multipleMsgMoveCopyStream-&gt;Close();</span>
<a href="#l8.502"></a><span id="l8.502">     m_multipleMsgMoveCopyStream = nullptr;</span>
<a href="#l8.503"></a><span id="l8.503">   }</span>
<a href="#l8.504"></a><span id="l8.504">   nsMsgProtocol::OnStopRequest(request, aStatus);</span>
<a href="#l8.505"></a><span id="l8.505">   return CloseSocket();</span>
<a href="#l8.506"></a><span id="l8.506"> }</span>
<a href="#l8.507"></a><span id="l8.507"> </span>
<a href="#l8.508"></a><span id="l8.508"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.509"></a><span id="l8.509"> // End of nsIStreamListenerSupport</span>
<a href="#l8.510"></a><span id="l8.510"> //////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.511"></a><span id="l8.511"> </span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-nsresult nsMailboxProtocol::DoneReadingMessage()</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineminus">-{</span>
<a href="#l8.514"></a><span id="l8.514" class="difflineplus">+nsresult nsMailboxProtocol::DoneReadingMessage() {</span>
<a href="#l8.515"></a><span id="l8.515">   nsresult rv = NS_OK;</span>
<a href="#l8.516"></a><span id="l8.516">   // and close the article file if it was open....</span>
<a href="#l8.517"></a><span id="l8.517"> </span>
<a href="#l8.518"></a><span id="l8.518" class="difflineminus">-  if (m_mailboxAction == nsIMailboxUrl::ActionSaveMessageToDisk &amp;&amp; m_msgFileOutputStream)</span>
<a href="#l8.519"></a><span id="l8.519" class="difflineplus">+  if (m_mailboxAction == nsIMailboxUrl::ActionSaveMessageToDisk &amp;&amp;</span>
<a href="#l8.520"></a><span id="l8.520" class="difflineplus">+      m_msgFileOutputStream)</span>
<a href="#l8.521"></a><span id="l8.521">     rv = m_msgFileOutputStream-&gt;Close();</span>
<a href="#l8.522"></a><span id="l8.522"> </span>
<a href="#l8.523"></a><span id="l8.523">   return rv;</span>
<a href="#l8.524"></a><span id="l8.524"> }</span>
<a href="#l8.525"></a><span id="l8.525"> </span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-nsresult nsMailboxProtocol::SetupMessageExtraction()</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-{</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineplus">+nsresult nsMailboxProtocol::SetupMessageExtraction() {</span>
<a href="#l8.529"></a><span id="l8.529">   // Determine the number of bytes we are going to need to read out of the</span>
<a href="#l8.530"></a><span id="l8.530">   // mailbox url....</span>
<a href="#l8.531"></a><span id="l8.531">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l8.532"></a><span id="l8.532">   nsresult rv = NS_OK;</span>
<a href="#l8.533"></a><span id="l8.533"> </span>
<a href="#l8.534"></a><span id="l8.534">   NS_ASSERTION(m_runningUrl, &quot;Not running a url&quot;);</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-  if (m_runningUrl)</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineminus">-  {</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+  if (m_runningUrl) {</span>
<a href="#l8.538"></a><span id="l8.538">     uint32_t messageSize = 0;</span>
<a href="#l8.539"></a><span id="l8.539">     m_runningUrl-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-    if (!messageSize)</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-    {</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineplus">+    if (!messageSize) {</span>
<a href="#l8.543"></a><span id="l8.543">       nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.546"></a><span id="l8.546">       rv = msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l8.547"></a><span id="l8.547" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l8.548"></a><span id="l8.548" class="difflineminus">-      {</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr) {</span>
<a href="#l8.550"></a><span id="l8.550">         msgHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l8.551"></a><span id="l8.551">         m_runningUrl-&gt;SetMessageSize(messageSize);</span>
<a href="#l8.552"></a><span id="l8.552">         msgHdr-&gt;GetMessageOffset(&amp;m_msgOffset);</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-      }</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-      else</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+      } else</span>
<a href="#l8.556"></a><span id="l8.556">         NS_ASSERTION(false, &quot;couldn't get message header&quot;);</span>
<a href="#l8.557"></a><span id="l8.557">     }</span>
<a href="#l8.558"></a><span id="l8.558">   }</span>
<a href="#l8.559"></a><span id="l8.559">   return rv;</span>
<a href="#l8.560"></a><span id="l8.560"> }</span>
<a href="#l8.561"></a><span id="l8.561"> </span>
<a href="#l8.562"></a><span id="l8.562"> /////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.563"></a><span id="l8.563"> // Begin protocol state machine functions...</span>
<a href="#l8.564"></a><span id="l8.564"> //////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l8.565"></a><span id="l8.565"> </span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-nsresult nsMailboxProtocol::LoadUrl(nsIURI * aURL, nsISupports * aConsumer)</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-{</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineplus">+nsresult nsMailboxProtocol::LoadUrl(nsIURI *aURL, nsISupports *aConsumer) {</span>
<a href="#l8.569"></a><span id="l8.569">   nsresult rv = NS_OK;</span>
<a href="#l8.570"></a><span id="l8.570">   // if we were already initialized with a consumer, use it...</span>
<a href="#l8.571"></a><span id="l8.571">   nsCOMPtr&lt;nsIStreamListener&gt; consumer = do_QueryInterface(aConsumer);</span>
<a href="#l8.572"></a><span id="l8.572" class="difflineminus">-  if (consumer)</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-    m_channelListener = consumer;</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+  if (consumer) m_channelListener = consumer;</span>
<a href="#l8.575"></a><span id="l8.575"> </span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-  if (aURL)</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineminus">-  {</span>
<a href="#l8.578"></a><span id="l8.578" class="difflineplus">+  if (aURL) {</span>
<a href="#l8.579"></a><span id="l8.579">     m_runningUrl = do_QueryInterface(aURL);</span>
<a href="#l8.580"></a><span id="l8.580" class="difflineminus">-    if (m_runningUrl)</span>
<a href="#l8.581"></a><span id="l8.581" class="difflineminus">-    {</span>
<a href="#l8.582"></a><span id="l8.582" class="difflineplus">+    if (m_runningUrl) {</span>
<a href="#l8.583"></a><span id="l8.583">       // find out from the url what action we are supposed to perform...</span>
<a href="#l8.584"></a><span id="l8.584">       rv = m_runningUrl-&gt;GetMailboxAction(&amp;m_mailboxAction);</span>
<a href="#l8.585"></a><span id="l8.585"> </span>
<a href="#l8.586"></a><span id="l8.586">       bool convertData = false;</span>
<a href="#l8.587"></a><span id="l8.587"> </span>
<a href="#l8.588"></a><span id="l8.588">       // need to check if we're fetching an rfc822 part in order to</span>
<a href="#l8.589"></a><span id="l8.589">       // quote a message.</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-      if (m_mailboxAction == nsIMailboxUrl::ActionFetchMessage)</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-      {</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+      if (m_mailboxAction == nsIMailboxUrl::ActionFetchMessage) {</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl =</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+            do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.597"></a><span id="l8.597" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.598"></a><span id="l8.598"> </span>
<a href="#l8.599"></a><span id="l8.599">         nsAutoCString queryStr;</span>
<a href="#l8.600"></a><span id="l8.600">         rv = msgUrl-&gt;GetQuery(queryStr);</span>
<a href="#l8.601"></a><span id="l8.601" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.603"></a><span id="l8.603"> </span>
<a href="#l8.604"></a><span id="l8.604">         // check if this is a filter plugin requesting the message.</span>
<a href="#l8.605"></a><span id="l8.605">         // in that case, set up a text converter</span>
<a href="#l8.606"></a><span id="l8.606">         convertData = (queryStr.Find(&quot;header=filter&quot;) != -1 ||</span>
<a href="#l8.607"></a><span id="l8.607">                        queryStr.Find(&quot;header=attach&quot;) != -1);</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-      }</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-      else if (m_mailboxAction == nsIMailboxUrl::ActionFetchPart)</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-      {</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-        // when fetching a part, we need to insert a converter into the listener chain order to</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineminus">-        // force just the part out of the message. Our channel listener is the consumer we'll</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineminus">-        // pass in to AsyncConvertData.</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+      } else if (m_mailboxAction == nsIMailboxUrl::ActionFetchPart) {</span>
<a href="#l8.615"></a><span id="l8.615" class="difflineplus">+        // when fetching a part, we need to insert a converter into the listener</span>
<a href="#l8.616"></a><span id="l8.616" class="difflineplus">+        // chain order to force just the part out of the message. Our channel</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineplus">+        // listener is the consumer we'll pass in to AsyncConvertData.</span>
<a href="#l8.618"></a><span id="l8.618">         convertData = true;</span>
<a href="#l8.619"></a><span id="l8.619">         consumer = m_channelListener;</span>
<a href="#l8.620"></a><span id="l8.620">       }</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-      if (convertData)</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineminus">-      {</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineminus">-          nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverter = do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-          nsCOMPtr &lt;nsIStreamListener&gt; conversionListener;</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-          nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-          QueryInterface(NS_GET_IID(nsIChannel), getter_AddRefs(channel));</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+      if (convertData) {</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+        nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverter =</span>
<a href="#l8.630"></a><span id="l8.630" class="difflineplus">+            do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l8.631"></a><span id="l8.631" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineplus">+        nsCOMPtr&lt;nsIStreamListener&gt; conversionListener;</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineplus">+        nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineplus">+        QueryInterface(NS_GET_IID(nsIChannel), getter_AddRefs(channel));</span>
<a href="#l8.635"></a><span id="l8.635"> </span>
<a href="#l8.636"></a><span id="l8.636" class="difflineminus">-          rv = streamConverter-&gt;AsyncConvertData(&quot;message/rfc822&quot;,</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineminus">-                                                 &quot;*/*&quot;,</span>
<a href="#l8.638"></a><span id="l8.638" class="difflineminus">-                                                 consumer, channel, getter_AddRefs(m_channelListener));</span>
<a href="#l8.639"></a><span id="l8.639" class="difflineplus">+        rv = streamConverter-&gt;AsyncConvertData(</span>
<a href="#l8.640"></a><span id="l8.640" class="difflineplus">+            &quot;message/rfc822&quot;, &quot;*/*&quot;, consumer, channel,</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineplus">+            getter_AddRefs(m_channelListener));</span>
<a href="#l8.642"></a><span id="l8.642">       }</span>
<a href="#l8.643"></a><span id="l8.643"> </span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-      {</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-        switch (m_mailboxAction)</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineminus">-        {</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineminus">-        case nsIMailboxUrl::ActionParseMailbox:</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineminus">-          // extract the mailbox parser..</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineminus">-          rv = m_runningUrl-&gt;GetMailboxParser(getter_AddRefs(m_mailboxParser));</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineminus">-          m_nextState = MAILBOX_READ_FOLDER;</span>
<a href="#l8.652"></a><span id="l8.652" class="difflineminus">-          break;</span>
<a href="#l8.653"></a><span id="l8.653" class="difflineminus">-        case nsIMailboxUrl::ActionSaveMessageToDisk:</span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-          // ohhh, display message already writes a msg to disk (as part of a hack)</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-          // so we can piggy back off of that!! We just need to change m_tempMessageFile</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineminus">-          // to be the name of our save message to disk file. Since save message to disk</span>
<a href="#l8.657"></a><span id="l8.657" class="difflineminus">-          // urls are run without a docshell to display the msg into, we won't be trying</span>
<a href="#l8.658"></a><span id="l8.658" class="difflineminus">-          // to display the message after we write it to disk...</span>
<a href="#l8.659"></a><span id="l8.659" class="difflineminus">-          {</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-            nsCOMPtr&lt;nsIMsgMessageUrl&gt; messageUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+        switch (m_mailboxAction) {</span>
<a href="#l8.664"></a><span id="l8.664" class="difflineplus">+          case nsIMailboxUrl::ActionParseMailbox:</span>
<a href="#l8.665"></a><span id="l8.665" class="difflineplus">+            // extract the mailbox parser..</span>
<a href="#l8.666"></a><span id="l8.666" class="difflineplus">+            rv =</span>
<a href="#l8.667"></a><span id="l8.667" class="difflineplus">+                m_runningUrl-&gt;GetMailboxParser(getter_AddRefs(m_mailboxParser));</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineplus">+            m_nextState = MAILBOX_READ_FOLDER;</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+            break;</span>
<a href="#l8.670"></a><span id="l8.670" class="difflineplus">+          case nsIMailboxUrl::ActionSaveMessageToDisk:</span>
<a href="#l8.671"></a><span id="l8.671" class="difflineplus">+            // ohhh, display message already writes a msg to disk (as part of a</span>
<a href="#l8.672"></a><span id="l8.672" class="difflineplus">+            // hack) so we can piggy back off of that!! We just need to change</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+            // m_tempMessageFile to be the name of our save message to disk</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+            // file. Since save message to disk urls are run without a docshell</span>
<a href="#l8.675"></a><span id="l8.675" class="difflineplus">+            // to display the msg into, we won't be trying to display the</span>
<a href="#l8.676"></a><span id="l8.676" class="difflineplus">+            // message after we write it to disk...</span>
<a href="#l8.677"></a><span id="l8.677">             {</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineminus">-              messageUrl-&gt;GetMessageFile(getter_AddRefs(m_tempMessageFile));</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-              rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_msgFileOutputStream), m_tempMessageFile, -1, 00600);</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineminus">-              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.681"></a><span id="l8.681" class="difflineplus">+              nsCOMPtr&lt;nsIMsgMessageUrl&gt; messageUrl =</span>
<a href="#l8.682"></a><span id="l8.682" class="difflineplus">+                  do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l8.683"></a><span id="l8.683" class="difflineplus">+              if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineplus">+                messageUrl-&gt;GetMessageFile(getter_AddRefs(m_tempMessageFile));</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+                rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l8.686"></a><span id="l8.686" class="difflineplus">+                    getter_AddRefs(m_msgFileOutputStream), m_tempMessageFile,</span>
<a href="#l8.687"></a><span id="l8.687" class="difflineplus">+                    -1, 00600);</span>
<a href="#l8.688"></a><span id="l8.688" class="difflineplus">+                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.689"></a><span id="l8.689"> </span>
<a href="#l8.690"></a><span id="l8.690" class="difflineminus">-              bool addDummyEnvelope = false;</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineminus">-              messageUrl-&gt;GetAddDummyEnvelope(&amp;addDummyEnvelope);</span>
<a href="#l8.692"></a><span id="l8.692" class="difflineminus">-              if (addDummyEnvelope)</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-                SetFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-              else</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-                ClearFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+                bool addDummyEnvelope = false;</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineplus">+                messageUrl-&gt;GetAddDummyEnvelope(&amp;addDummyEnvelope);</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineplus">+                if (addDummyEnvelope)</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+                  SetFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+                else</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+                  ClearFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.702"></a><span id="l8.702" class="difflineplus">+              }</span>
<a href="#l8.703"></a><span id="l8.703">             }</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineminus">-          }</span>
<a href="#l8.705"></a><span id="l8.705" class="difflineminus">-          m_nextState = MAILBOX_READ_MESSAGE;</span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-          break;</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineminus">-        case nsIMailboxUrl::ActionCopyMessage:</span>
<a href="#l8.708"></a><span id="l8.708" class="difflineminus">-        case nsIMailboxUrl::ActionMoveMessage:</span>
<a href="#l8.709"></a><span id="l8.709" class="difflineminus">-        case nsIMailboxUrl::ActionFetchMessage:</span>
<a href="#l8.710"></a><span id="l8.710" class="difflineminus">-          ClearFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.711"></a><span id="l8.711" class="difflineminus">-          m_nextState = MAILBOX_READ_MESSAGE;</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-          break;</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-        case nsIMailboxUrl::ActionFetchPart:</span>
<a href="#l8.714"></a><span id="l8.714">             m_nextState = MAILBOX_READ_MESSAGE;</span>
<a href="#l8.715"></a><span id="l8.715">             break;</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-        default:</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-          break;</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineplus">+          case nsIMailboxUrl::ActionCopyMessage:</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+          case nsIMailboxUrl::ActionMoveMessage:</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+          case nsIMailboxUrl::ActionFetchMessage:</span>
<a href="#l8.721"></a><span id="l8.721" class="difflineplus">+            ClearFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.722"></a><span id="l8.722" class="difflineplus">+            m_nextState = MAILBOX_READ_MESSAGE;</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineplus">+            break;</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineplus">+          case nsIMailboxUrl::ActionFetchPart:</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+            m_nextState = MAILBOX_READ_MESSAGE;</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineplus">+            break;</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+          default:</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+            break;</span>
<a href="#l8.729"></a><span id="l8.729">         }</span>
<a href="#l8.730"></a><span id="l8.730">       }</span>
<a href="#l8.731"></a><span id="l8.731"> </span>
<a href="#l8.732"></a><span id="l8.732">       rv = nsMsgProtocol::LoadUrl(aURL, m_channelListener);</span>
<a href="#l8.733"></a><span id="l8.733"> </span>
<a href="#l8.734"></a><span id="l8.734" class="difflineminus">-    } // if we received an MAILBOX url...</span>
<a href="#l8.735"></a><span id="l8.735" class="difflineminus">-  } // if we received a url!</span>
<a href="#l8.736"></a><span id="l8.736" class="difflineplus">+    }  // if we received an MAILBOX url...</span>
<a href="#l8.737"></a><span id="l8.737" class="difflineplus">+  }    // if we received a url!</span>
<a href="#l8.738"></a><span id="l8.738"> </span>
<a href="#l8.739"></a><span id="l8.739">   return rv;</span>
<a href="#l8.740"></a><span id="l8.740"> }</span>
<a href="#l8.741"></a><span id="l8.741"> </span>
<a href="#l8.742"></a><span id="l8.742" class="difflineminus">-int32_t nsMailboxProtocol::ReadFolderResponse(nsIInputStream * inputStream, uint64_t sourceOffset, uint32_t length)</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-{</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineplus">+int32_t nsMailboxProtocol::ReadFolderResponse(nsIInputStream *inputStream,</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineplus">+                                              uint64_t sourceOffset,</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineplus">+                                              uint32_t length) {</span>
<a href="#l8.747"></a><span id="l8.747">   // okay we are doing a folder read in 8K chunks of a mail folder....</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineminus">-  // this is almost too easy....we can just forward the data in this stream on to our</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineminus">-  // folder parser object!!!</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+  // this is almost too easy....we can just forward the data in this stream on</span>
<a href="#l8.751"></a><span id="l8.751" class="difflineplus">+  // to our folder parser object!!!</span>
<a href="#l8.752"></a><span id="l8.752"> </span>
<a href="#l8.753"></a><span id="l8.753">   nsresult rv = NS_OK;</span>
<a href="#l8.754"></a><span id="l8.754">   mCurrentProgress += length;</span>
<a href="#l8.755"></a><span id="l8.755"> </span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-  if (m_mailboxParser)</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-  {</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineminus">-    rv = m_mailboxParser-&gt;OnDataAvailable(nullptr, inputStream, sourceOffset, length); // let the parser deal with it...</span>
<a href="#l8.759"></a><span id="l8.759" class="difflineplus">+  if (m_mailboxParser) {</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineplus">+    rv = m_mailboxParser-&gt;OnDataAvailable(</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineplus">+        nullptr, inputStream, sourceOffset,</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineplus">+        length);  // let the parser deal with it...</span>
<a href="#l8.763"></a><span id="l8.763">   }</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-  {</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-    m_nextState = MAILBOX_ERROR_DONE; // drop out of the loop....</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineplus">+    m_nextState = MAILBOX_ERROR_DONE;  // drop out of the loop....</span>
<a href="#l8.769"></a><span id="l8.769">     return -1;</span>
<a href="#l8.770"></a><span id="l8.770">   }</span>
<a href="#l8.771"></a><span id="l8.771"> </span>
<a href="#l8.772"></a><span id="l8.772">   // now wait for the next 8K chunk to come in.....</span>
<a href="#l8.773"></a><span id="l8.773">   SetFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l8.774"></a><span id="l8.774"> </span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-  // leave our state alone so when the next chunk of the mailbox comes in we jump to this state</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-  // and repeat....how does this process end? Well when the file is done being read in, core net lib</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-  // will issue an ::OnStopRequest to us...we'll use that as our sign to drop out of this state and to</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-  // close the protocol instance...</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineplus">+  // leave our state alone so when the next chunk of the mailbox comes in we</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineplus">+  // jump to this state and repeat....how does this process end? Well when the</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineplus">+  // file is done being read in, core net lib will issue an ::OnStopRequest to</span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+  // us...we'll use that as our sign to drop out of this state and to close the</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+  // protocol instance...</span>
<a href="#l8.784"></a><span id="l8.784"> </span>
<a href="#l8.785"></a><span id="l8.785">   return 0;</span>
<a href="#l8.786"></a><span id="l8.786"> }</span>
<a href="#l8.787"></a><span id="l8.787"> </span>
<a href="#l8.788"></a><span id="l8.788" class="difflineminus">-int32_t nsMailboxProtocol::ReadMessageResponse(nsIInputStream * inputStream, uint64_t sourceOffset, uint32_t length)</span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-{</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineplus">+int32_t nsMailboxProtocol::ReadMessageResponse(nsIInputStream *inputStream,</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+                                               uint64_t sourceOffset,</span>
<a href="#l8.792"></a><span id="l8.792" class="difflineplus">+                                               uint32_t length) {</span>
<a href="#l8.793"></a><span id="l8.793">   char *line = nullptr;</span>
<a href="#l8.794"></a><span id="l8.794">   uint32_t status = 0;</span>
<a href="#l8.795"></a><span id="l8.795">   nsresult rv = NS_OK;</span>
<a href="#l8.796"></a><span id="l8.796">   mCurrentProgress += length;</span>
<a href="#l8.797"></a><span id="l8.797"> </span>
<a href="#l8.798"></a><span id="l8.798">   // if we are doing a move or a copy, forward the data onto the copy handler...</span>
<a href="#l8.799"></a><span id="l8.799">   // if we want to display the message then parse the incoming data...</span>
<a href="#l8.800"></a><span id="l8.800"> </span>
<a href="#l8.801"></a><span id="l8.801" class="difflineminus">-  if (m_channelListener)</span>
<a href="#l8.802"></a><span id="l8.802" class="difflineminus">-  {</span>
<a href="#l8.803"></a><span id="l8.803" class="difflineplus">+  if (m_channelListener) {</span>
<a href="#l8.804"></a><span id="l8.804">     // just forward the data we read in to the listener...</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    rv = m_channelListener-&gt;OnDataAvailable(this, inputStream, sourceOffset, length);</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-  }</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-  else</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-  {</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+    rv = m_channelListener-&gt;OnDataAvailable(this, inputStream, sourceOffset,</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineplus">+                                            length);</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineplus">+  } else {</span>
<a href="#l8.812"></a><span id="l8.812">     bool pauseForMoreData = false;</span>
<a href="#l8.813"></a><span id="l8.813">     bool canonicalLineEnding = false;</span>
<a href="#l8.814"></a><span id="l8.814">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.815"></a><span id="l8.815"> </span>
<a href="#l8.816"></a><span id="l8.816" class="difflineminus">-    if (msgurl)</span>
<a href="#l8.817"></a><span id="l8.817" class="difflineminus">-      msgurl-&gt;GetCanonicalLineEnding(&amp;canonicalLineEnding);</span>
<a href="#l8.818"></a><span id="l8.818" class="difflineplus">+    if (msgurl) msgurl-&gt;GetCanonicalLineEnding(&amp;canonicalLineEnding);</span>
<a href="#l8.819"></a><span id="l8.819"> </span>
<a href="#l8.820"></a><span id="l8.820" class="difflineminus">-    while ((line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData)) &amp;&amp;</span>
<a href="#l8.821"></a><span id="l8.821" class="difflineminus">-           !pauseForMoreData)</span>
<a href="#l8.822"></a><span id="l8.822" class="difflineminus">-    {</span>
<a href="#l8.823"></a><span id="l8.823" class="difflineplus">+    while ((line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l8.824"></a><span id="l8.824" class="difflineplus">+                                                    pauseForMoreData)) &amp;&amp;</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineplus">+           !pauseForMoreData) {</span>
<a href="#l8.826"></a><span id="l8.826">       /* When we're sending this line to a converter (ie,</span>
<a href="#l8.827"></a><span id="l8.827">       it's a message/rfc822) use the local line termination</span>
<a href="#l8.828"></a><span id="l8.828">       convention, not CRLF.  This makes text articles get</span>
<a href="#l8.829"></a><span id="l8.829">       saved with the local line terminators.  Since SMTP</span>
<a href="#l8.830"></a><span id="l8.830">       and NNTP mandate the use of CRLF, it is expected that</span>
<a href="#l8.831"></a><span id="l8.831">       the local system will convert that to the local line</span>
<a href="#l8.832"></a><span id="l8.832">       terminator as it is read.</span>
<a href="#l8.833"></a><span id="l8.833">       */</span>
<a href="#l8.834"></a><span id="l8.834">       // mscott - the firstline hack is aimed at making sure we don't write</span>
<a href="#l8.835"></a><span id="l8.835">       // out the dummy header when we are trying to display the message.</span>
<a href="#l8.836"></a><span id="l8.836">       // The dummy header is the From line with the date tag on it.</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-      if (m_msgFileOutputStream &amp;&amp; TestFlag(MAILBOX_MSG_PARSE_FIRST_LINE))</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-      {</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+      if (m_msgFileOutputStream &amp;&amp; TestFlag(MAILBOX_MSG_PARSE_FIRST_LINE)) {</span>
<a href="#l8.840"></a><span id="l8.840">         uint32_t count = 0;</span>
<a href="#l8.841"></a><span id="l8.841">         rv = m_msgFileOutputStream-&gt;Write(line, PL_strlen(line), &amp;count);</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l8.843"></a><span id="l8.843" class="difflineminus">-          break;</span>
<a href="#l8.844"></a><span id="l8.844" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l8.845"></a><span id="l8.845"> </span>
<a href="#l8.846"></a><span id="l8.846">         if (canonicalLineEnding)</span>
<a href="#l8.847"></a><span id="l8.847">           rv = m_msgFileOutputStream-&gt;Write(CRLF, 2, &amp;count);</span>
<a href="#l8.848"></a><span id="l8.848">         else</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-          rv = m_msgFileOutputStream-&gt;Write(MSG_LINEBREAK,</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineminus">-                                            MSG_LINEBREAK_LEN, &amp;count);</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+          rv = m_msgFileOutputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l8.852"></a><span id="l8.852" class="difflineplus">+                                            &amp;count);</span>
<a href="#l8.853"></a><span id="l8.853"> </span>
<a href="#l8.854"></a><span id="l8.854" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l8.855"></a><span id="l8.855" class="difflineminus">-          break;</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-      }</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineminus">-      else</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l8.859"></a><span id="l8.859" class="difflineplus">+      } else</span>
<a href="#l8.860"></a><span id="l8.860">         SetFlag(MAILBOX_MSG_PARSE_FIRST_LINE);</span>
<a href="#l8.861"></a><span id="l8.861">       PR_Free(line);</span>
<a href="#l8.862"></a><span id="l8.862">     }</span>
<a href="#l8.863"></a><span id="l8.863">     PR_Free(line);</span>
<a href="#l8.864"></a><span id="l8.864">   }</span>
<a href="#l8.865"></a><span id="l8.865"> </span>
<a href="#l8.866"></a><span id="l8.866" class="difflineminus">-  SetFlag(MAILBOX_PAUSE_FOR_READ); // wait for more data to become available...</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-  if (mProgressEventSink &amp;&amp; m_runningUrl)</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineminus">-  {</span>
<a href="#l8.869"></a><span id="l8.869" class="difflineplus">+  SetFlag(MAILBOX_PAUSE_FOR_READ);  // wait for more data to become available...</span>
<a href="#l8.870"></a><span id="l8.870" class="difflineplus">+  if (mProgressEventSink &amp;&amp; m_runningUrl) {</span>
<a href="#l8.871"></a><span id="l8.871">     int64_t maxProgress;</span>
<a href="#l8.872"></a><span id="l8.872">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(m_runningUrl));</span>
<a href="#l8.873"></a><span id="l8.873">     mailnewsUrl-&gt;GetMaxProgress(&amp;maxProgress);</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-    mProgressEventSink-&gt;OnProgress(this, m_channelContext,</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-                                   mCurrentProgress,</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+    mProgressEventSink-&gt;OnProgress(this, m_channelContext, mCurrentProgress,</span>
<a href="#l8.877"></a><span id="l8.877">                                    maxProgress);</span>
<a href="#l8.878"></a><span id="l8.878">   }</span>
<a href="#l8.879"></a><span id="l8.879"> </span>
<a href="#l8.880"></a><span id="l8.880">   if (NS_FAILED(rv)) return -1;</span>
<a href="#l8.881"></a><span id="l8.881"> </span>
<a href="#l8.882"></a><span id="l8.882">   return 0;</span>
<a href="#l8.883"></a><span id="l8.883"> }</span>
<a href="#l8.884"></a><span id="l8.884"> </span>
<a href="#l8.885"></a><span id="l8.885" class="difflineminus">-</span>
<a href="#l8.886"></a><span id="l8.886"> /*</span>
<a href="#l8.887"></a><span id="l8.887">  * returns negative if the transfer is finished or error'd out</span>
<a href="#l8.888"></a><span id="l8.888">  *</span>
<a href="#l8.889"></a><span id="l8.889">  * returns zero or more if the transfer needs to be continued.</span>
<a href="#l8.890"></a><span id="l8.890">  */</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-nsresult nsMailboxProtocol::ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream, uint64_t offset, uint32_t length)</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-{</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineplus">+nsresult nsMailboxProtocol::ProcessProtocolState(nsIURI *url,</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineplus">+                                                 nsIInputStream *inputStream,</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineplus">+                                                 uint64_t offset,</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineplus">+                                                 uint32_t length) {</span>
<a href="#l8.897"></a><span id="l8.897">   nsresult rv = NS_OK;</span>
<a href="#l8.898"></a><span id="l8.898">   int32_t status = 0;</span>
<a href="#l8.899"></a><span id="l8.899">   ClearFlag(MAILBOX_PAUSE_FOR_READ); /* already paused; reset */</span>
<a href="#l8.900"></a><span id="l8.900"> </span>
<a href="#l8.901"></a><span id="l8.901" class="difflineminus">-  while(!TestFlag(MAILBOX_PAUSE_FOR_READ))</span>
<a href="#l8.902"></a><span id="l8.902" class="difflineminus">-  {</span>
<a href="#l8.903"></a><span id="l8.903" class="difflineminus">-</span>
<a href="#l8.904"></a><span id="l8.904" class="difflineminus">-    switch(m_nextState)</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-    {</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-    case MAILBOX_READ_MESSAGE:</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l8.908"></a><span id="l8.908" class="difflineminus">-        SetFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l8.909"></a><span id="l8.909" class="difflineminus">-      else</span>
<a href="#l8.910"></a><span id="l8.910" class="difflineminus">-        status = ReadMessageResponse(inputStream, offset, length);</span>
<a href="#l8.911"></a><span id="l8.911" class="difflineminus">-      break;</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineminus">-    case MAILBOX_READ_FOLDER:</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineminus">-      if (inputStream == nullptr)</span>
<a href="#l8.914"></a><span id="l8.914" class="difflineminus">-        SetFlag(MAILBOX_PAUSE_FOR_READ);   // wait for file socket to read in the next chunk...</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-      else</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-        status = ReadFolderResponse(inputStream, offset, length);</span>
<a href="#l8.917"></a><span id="l8.917" class="difflineminus">-      break;</span>
<a href="#l8.918"></a><span id="l8.918" class="difflineminus">-    case MAILBOX_DONE:</span>
<a href="#l8.919"></a><span id="l8.919" class="difflineminus">-    case MAILBOX_ERROR_DONE:</span>
<a href="#l8.920"></a><span id="l8.920" class="difflineminus">-      {</span>
<a href="#l8.921"></a><span id="l8.921" class="difflineminus">-        nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; anotherUrl = do_QueryInterface(m_runningUrl);</span>
<a href="#l8.922"></a><span id="l8.922" class="difflineplus">+  while (!TestFlag(MAILBOX_PAUSE_FOR_READ)) {</span>
<a href="#l8.923"></a><span id="l8.923" class="difflineplus">+    switch (m_nextState) {</span>
<a href="#l8.924"></a><span id="l8.924" class="difflineplus">+      case MAILBOX_READ_MESSAGE:</span>
<a href="#l8.925"></a><span id="l8.925" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l8.926"></a><span id="l8.926" class="difflineplus">+          SetFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l8.927"></a><span id="l8.927" class="difflineplus">+        else</span>
<a href="#l8.928"></a><span id="l8.928" class="difflineplus">+          status = ReadMessageResponse(inputStream, offset, length);</span>
<a href="#l8.929"></a><span id="l8.929" class="difflineplus">+        break;</span>
<a href="#l8.930"></a><span id="l8.930" class="difflineplus">+      case MAILBOX_READ_FOLDER:</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineplus">+        if (inputStream == nullptr)</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+          SetFlag(MAILBOX_PAUSE_FOR_READ);  // wait for file socket to read in</span>
<a href="#l8.933"></a><span id="l8.933" class="difflineplus">+                                            // the next chunk...</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineplus">+        else</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+          status = ReadFolderResponse(inputStream, offset, length);</span>
<a href="#l8.936"></a><span id="l8.936" class="difflineplus">+        break;</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineplus">+      case MAILBOX_DONE:</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+      case MAILBOX_ERROR_DONE: {</span>
<a href="#l8.939"></a><span id="l8.939" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; anotherUrl =</span>
<a href="#l8.940"></a><span id="l8.940" class="difflineplus">+            do_QueryInterface(m_runningUrl);</span>
<a href="#l8.941"></a><span id="l8.941">         rv = m_nextState == MAILBOX_DONE ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l8.942"></a><span id="l8.942">         anotherUrl-&gt;SetUrlState(false, rv);</span>
<a href="#l8.943"></a><span id="l8.943">         m_nextState = MAILBOX_FREE;</span>
<a href="#l8.944"></a><span id="l8.944" class="difflineminus">-      }</span>
<a href="#l8.945"></a><span id="l8.945" class="difflineminus">-      break;</span>
<a href="#l8.946"></a><span id="l8.946" class="difflineplus">+      } break;</span>
<a href="#l8.947"></a><span id="l8.947"> </span>
<a href="#l8.948"></a><span id="l8.948" class="difflineminus">-    case MAILBOX_FREE:</span>
<a href="#l8.949"></a><span id="l8.949" class="difflineminus">-      // MAILBOX is a one time use connection so kill it if we get here...</span>
<a href="#l8.950"></a><span id="l8.950" class="difflineminus">-      CloseSocket();</span>
<a href="#l8.951"></a><span id="l8.951" class="difflineminus">-      return rv; /* final end */</span>
<a href="#l8.952"></a><span id="l8.952" class="difflineplus">+      case MAILBOX_FREE:</span>
<a href="#l8.953"></a><span id="l8.953" class="difflineplus">+        // MAILBOX is a one time use connection so kill it if we get here...</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineplus">+        CloseSocket();</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineplus">+        return rv; /* final end */</span>
<a href="#l8.956"></a><span id="l8.956"> </span>
<a href="#l8.957"></a><span id="l8.957" class="difflineminus">-    default: /* should never happen !!! */</span>
<a href="#l8.958"></a><span id="l8.958" class="difflineminus">-      m_nextState = MAILBOX_ERROR_DONE;</span>
<a href="#l8.959"></a><span id="l8.959" class="difflineminus">-      break;</span>
<a href="#l8.960"></a><span id="l8.960" class="difflineplus">+      default: /* should never happen !!! */</span>
<a href="#l8.961"></a><span id="l8.961" class="difflineplus">+        m_nextState = MAILBOX_ERROR_DONE;</span>
<a href="#l8.962"></a><span id="l8.962" class="difflineplus">+        break;</span>
<a href="#l8.963"></a><span id="l8.963">     }</span>
<a href="#l8.964"></a><span id="l8.964"> </span>
<a href="#l8.965"></a><span id="l8.965">     /* check for errors during load and call error</span>
<a href="#l8.966"></a><span id="l8.966" class="difflineminus">-    * state if found</span>
<a href="#l8.967"></a><span id="l8.967" class="difflineminus">-    */</span>
<a href="#l8.968"></a><span id="l8.968" class="difflineminus">-    if(status &lt; 0 &amp;&amp; m_nextState != MAILBOX_FREE)</span>
<a href="#l8.969"></a><span id="l8.969" class="difflineminus">-    {</span>
<a href="#l8.970"></a><span id="l8.970" class="difflineplus">+     * state if found</span>
<a href="#l8.971"></a><span id="l8.971" class="difflineplus">+     */</span>
<a href="#l8.972"></a><span id="l8.972" class="difflineplus">+    if (status &lt; 0 &amp;&amp; m_nextState != MAILBOX_FREE) {</span>
<a href="#l8.973"></a><span id="l8.973">       m_nextState = MAILBOX_ERROR_DONE;</span>
<a href="#l8.974"></a><span id="l8.974">       /* don't exit! loop around again and do the free case */</span>
<a href="#l8.975"></a><span id="l8.975">       ClearFlag(MAILBOX_PAUSE_FOR_READ);</span>
<a href="#l8.976"></a><span id="l8.976">     }</span>
<a href="#l8.977"></a><span id="l8.977">   } /* while(!MAILBOX_PAUSE_FOR_READ) */</span>
<a href="#l8.978"></a><span id="l8.978"> </span>
<a href="#l8.979"></a><span id="l8.979">   return rv;</span>
<a href="#l8.980"></a><span id="l8.980"> }</span>
<a href="#l8.981"></a><span id="l8.981"> </span>
<a href="#l8.982"></a><span id="l8.982" class="difflineminus">-nsresult nsMailboxProtocol::CloseSocket()</span>
<a href="#l8.983"></a><span id="l8.983" class="difflineminus">-{</span>
<a href="#l8.984"></a><span id="l8.984" class="difflineplus">+nsresult nsMailboxProtocol::CloseSocket() {</span>
<a href="#l8.985"></a><span id="l8.985">   // how do you force a release when closing the connection??</span>
<a href="#l8.986"></a><span id="l8.986">   nsMsgProtocol::CloseSocket();</span>
<a href="#l8.987"></a><span id="l8.987">   m_runningUrl = nullptr;</span>
<a href="#l8.988"></a><span id="l8.988">   m_mailboxParser = nullptr;</span>
<a href="#l8.989"></a><span id="l8.989">   return NS_OK;</span>
<a href="#l8.990"></a><span id="l8.990"> }</span>
<a href="#l8.991"></a><span id="l8.991"> </span>
<a href="#l8.992"></a><span id="l8.992"> // vim: ts=2 sw=2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -11,18 +11,20 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIFile.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> // State Flags (Note, I use the word state in terms of storing</span>
<a href="#l9.9"></a><span id="l9.9"> // state information about the connection (authentication, have we sent</span>
<a href="#l9.10"></a><span id="l9.10"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#define MAILBOX_PAUSE_FOR_READ      0x00000001  /* should we pause for the next read */</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-#define MAILBOX_MSG_PARSE_FIRST_LINE    0x00000002 /* have we read in the first line of the msg */</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+#define MAILBOX_PAUSE_FOR_READ \</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  0x00000001 /* should we pause for the next read */</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+#define MAILBOX_MSG_PARSE_FIRST_LINE \</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  0x00000002 /* have we read in the first line of the msg */</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> /* states of the machine</span>
<a href="#l9.20"></a><span id="l9.20">  */</span>
<a href="#l9.21"></a><span id="l9.21"> typedef enum _MailboxStatesEnum {</span>
<a href="#l9.22"></a><span id="l9.22">   MAILBOX_READ_FOLDER,</span>
<a href="#l9.23"></a><span id="l9.23">   MAILBOX_FINISH_OPEN_FOLDER,</span>
<a href="#l9.24"></a><span id="l9.24">   MAILBOX_OPEN_MESSAGE,</span>
<a href="#l9.25"></a><span id="l9.25">   MAILBOX_OPEN_STREAM,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineat">@@ -38,86 +40,88 @@ typedef enum _MailboxStatesEnum {</span>
<a href="#l9.27"></a><span id="l9.27">   MAILBOX_ERROR_DONE,</span>
<a href="#l9.28"></a><span id="l9.28">   MAILBOX_FREE,</span>
<a href="#l9.29"></a><span id="l9.29">   MAILBOX_COPY_MESSAGES,</span>
<a href="#l9.30"></a><span id="l9.30">   MAILBOX_FINISH_COPY_MESSAGES</span>
<a href="#l9.31"></a><span id="l9.31"> } MailboxStatesEnum;</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33"> class nsMsgLineStreamBuffer;</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-class nsMailboxProtocol : public nsMsgProtocol</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-{</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-public:</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-  // Creating a protocol instance requires the URL which needs to be run AND it requires</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-  // a transport layer.</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-  explicit nsMailboxProtocol(nsIURI * aURL);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+class nsMailboxProtocol : public nsMsgProtocol {</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+ public:</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  // Creating a protocol instance requires the URL which needs to be run AND it</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  // requires a transport layer.</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  explicit nsMailboxProtocol(nsIURI *aURL);</span>
<a href="#l9.46"></a><span id="l9.46">   virtual ~nsMailboxProtocol();</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">   // initialization function given a new url and transport layer</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-  nsresult Initialize(nsIURI * aURL);</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  nsresult Initialize(nsIURI *aURL);</span>
<a href="#l9.51"></a><span id="l9.51"> </span>
<a href="#l9.52"></a><span id="l9.52">   // the consumer of the url might be something like an nsIDocShell....</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-  virtual nsresult LoadUrl(nsIURI * aURL, nsISupports * aConsumer) override;</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  virtual nsresult LoadUrl(nsIURI *aURL, nsISupports *aConsumer) override;</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.57"></a><span id="l9.57">   // we support the nsIStreamListener interface</span>
<a href="#l9.58"></a><span id="l9.58">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">   NS_IMETHOD OnStartRequest(nsIRequest *request) override;</span>
<a href="#l9.61"></a><span id="l9.61">   NS_IMETHOD OnStopRequest(nsIRequest *request, nsresult aStatus) override;</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-private:</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  nsCOMPtr&lt;nsIMailboxUrl&gt;  m_runningUrl; // the nsIMailboxURL that is currently running</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  nsMailboxAction m_mailboxAction; // current mailbox action associated with this connection...</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+ private:</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  nsCOMPtr&lt;nsIMailboxUrl&gt;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      m_runningUrl;  // the nsIMailboxURL that is currently running</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  nsMailboxAction m_mailboxAction;  // current mailbox action associated with</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+                                    // this connection...</span>
<a href="#l9.71"></a><span id="l9.71">   uint64_t m_msgOffset;</span>
<a href="#l9.72"></a><span id="l9.72">   // Event sink handles</span>
<a href="#l9.73"></a><span id="l9.73">   nsCOMPtr&lt;nsIStreamListener&gt; m_mailboxParser;</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">   // Local state for the current operation</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  RefPtr&lt;nsMsgLineStreamBuffer&gt; m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  RefPtr&lt;nsMsgLineStreamBuffer&gt;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+      m_lineStreamBuffer;  // used to efficiently extract lines from the</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+                           // incoming data stream</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-  // Generic state information -- What state are we in? What state do we want to go to</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-  // after the next response? What was the last response code? etc.</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-  MailboxStatesEnum  m_nextState;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-  MailboxStatesEnum  m_initialState;</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+  // Generic state information -- What state are we in? What state do we want to</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  // go to after the next response? What was the last response code? etc.</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  MailboxStatesEnum m_nextState;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  MailboxStatesEnum m_initialState;</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-  int64_t   mCurrentProgress;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  int64_t mCurrentProgress;</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-        // can we just use the base class m_tempMsgFile?</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  // can we just use the base class m_tempMsgFile?</span>
<a href="#l9.95"></a><span id="l9.95">   nsCOMPtr&lt;nsIFile&gt; m_tempMessageFile;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-        nsCOMPtr&lt;nsIOutputStream&gt; m_msgFileOutputStream;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; m_msgFileOutputStream;</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99">   // this is used to hold the source mailbox file open when move/copying</span>
<a href="#l9.100"></a><span id="l9.100">   // multiple messages.</span>
<a href="#l9.101"></a><span id="l9.101">   nsCOMPtr&lt;nsIInputStream&gt; m_multipleMsgMoveCopyStream;</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-                                        uint64_t sourceOffset, uint32_t length) override;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  virtual nsresult ProcessProtocolState(nsIURI *url,</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+                                        nsIInputStream *inputStream,</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+                                        uint64_t sourceOffset,</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+                                        uint32_t length) override;</span>
<a href="#l9.109"></a><span id="l9.109">   virtual nsresult CloseSocket() override;</span>
<a href="#l9.110"></a><span id="l9.110"> </span>
<a href="#l9.111"></a><span id="l9.111">   nsresult SetupMessageExtraction();</span>
<a href="#l9.112"></a><span id="l9.112">   nsresult OpenMultipleMsgTransport(uint64_t offset, int64_t size);</span>
<a href="#l9.113"></a><span id="l9.113">   bool RunningMultipleMsgUrl();</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-  // Protocol Methods --&gt; This protocol is state driven so each protocol method is</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  // Protocol Methods --&gt; This protocol is state driven so each protocol method</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  // is</span>
<a href="#l9.119"></a><span id="l9.119">   //            designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l9.120"></a><span id="l9.120">   //            group them together based on functionality.</span>
<a href="#l9.121"></a><span id="l9.121">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.122"></a><span id="l9.122"> </span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-  // When parsing a mailbox folder in chunks, this protocol state reads in the current chunk</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-  // and forwards it to the mailbox parser.</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-  int32_t ReadFolderResponse(nsIInputStream * inputStream, uint64_t sourceOffset, uint32_t length);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-  int32_t ReadMessageResponse(nsIInputStream * inputStream, uint64_t sourceOffset, uint32_t length);</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+  // When parsing a mailbox folder in chunks, this protocol state reads in the</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  // current chunk and forwards it to the mailbox parser.</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  int32_t ReadFolderResponse(nsIInputStream *inputStream, uint64_t sourceOffset,</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+                             uint32_t length);</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  int32_t ReadMessageResponse(nsIInputStream *inputStream,</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+                              uint64_t sourceOffset, uint32_t length);</span>
<a href="#l9.133"></a><span id="l9.133">   nsresult DoneReadingMessage();</span>
<a href="#l9.134"></a><span id="l9.134"> </span>
<a href="#l9.135"></a><span id="l9.135">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.136"></a><span id="l9.136">   // End of Protocol Methods</span>
<a href="#l9.137"></a><span id="l9.137">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l9.138"></a><span id="l9.138"> };</span>
<a href="#l9.139"></a><span id="l9.139"> </span>
<a href="#l9.140"></a><span id="l9.140"> #endif  // nsMailboxProtocol_h___</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxServer.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxServer.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -2,32 +2,27 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsMailboxServer.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsLocalMailFolder.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> NS_IMETHODIMP</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-nsMailboxServer::GetLocalStoreType(nsACString&amp; type)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+nsMailboxServer::GetLocalStoreType(nsACString &amp;type) {</span>
<a href="#l10.15"></a><span id="l10.15">   type.AssignLiteral(&quot;mailbox&quot;);</span>
<a href="#l10.16"></a><span id="l10.16">   return NS_OK;</span>
<a href="#l10.17"></a><span id="l10.17"> }</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> NS_IMETHODIMP</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-nsMailboxServer::GetLocalDatabaseType(nsACString&amp; type)</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-{</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+nsMailboxServer::GetLocalDatabaseType(nsACString &amp;type) {</span>
<a href="#l10.23"></a><span id="l10.23">   type.AssignLiteral(&quot;mailbox&quot;);</span>
<a href="#l10.24"></a><span id="l10.24">   return NS_OK;</span>
<a href="#l10.25"></a><span id="l10.25"> }</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-nsresult</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-nsMailboxServer::CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-                                         nsIMsgFolder **rootFolder)</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-{</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+nsresult nsMailboxServer::CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                                                  nsIMsgFolder **rootFolder) {</span>
<a href="#l10.33"></a><span id="l10.33">   nsMsgLocalMailFolder *newRootFolder = new nsMsgLocalMailFolder;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  if (!newRootFolder)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  if (!newRootFolder) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.37"></a><span id="l10.37">   NS_ADDREF(*rootFolder = newRootFolder);</span>
<a href="#l10.38"></a><span id="l10.38">   newRootFolder-&gt;Init(serverUri.get());</span>
<a href="#l10.39"></a><span id="l10.39">   return NS_OK;</span>
<a href="#l10.40"></a><span id="l10.40"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxServer.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxServer.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4,19 +4,19 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #ifndef nsMailboxServer_h__</span>
<a href="#l11.7"></a><span id="l11.7"> #define nsMailboxServer_h__</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsMsgIncomingServer.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-class nsMailboxServer : public nsMsgIncomingServer</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-public:</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+class nsMailboxServer : public nsMsgIncomingServer {</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ public:</span>
<a href="#l11.17"></a><span id="l11.17">   NS_IMETHOD GetLocalStoreType(nsACString&amp; type) override;</span>
<a href="#l11.18"></a><span id="l11.18">   NS_IMETHOD GetLocalDatabaseType(nsACString&amp; type) override;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-protected:</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-  virtual nsresult CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-                                           nsIMsgFolder **rootFolder) override;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ protected:</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  virtual nsresult CreateRootFolderFromUri(const nsCString&amp; serverUri,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+                                           nsIMsgFolder** rootFolder) override;</span>
<a href="#l11.26"></a><span id="l11.26"> };</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l12.5"></a><span id="l12.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12"> </span>
<a href="#l12.13"></a><span id="l12.13"> #include &quot;nsMailboxService.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14"> #include &quot;nsMailboxUrl.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> #include &quot;nsMailboxProtocol.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineat">@@ -24,582 +24,532 @@</span>
<a href="#l12.20"></a><span id="l12.20"> #include &quot;nsIWebNavigation.h&quot;</span>
<a href="#l12.21"></a><span id="l12.21"> #include &quot;prprf.h&quot;</span>
<a href="#l12.22"></a><span id="l12.22"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l12.23"></a><span id="l12.23"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l12.24"></a><span id="l12.24"> #include &quot;mozilla/RefPtr.h&quot;</span>
<a href="#l12.25"></a><span id="l12.25"> #include &quot;nsDocShellLoadState.h&quot;</span>
<a href="#l12.26"></a><span id="l12.26"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-nsMailboxService::nsMailboxService()</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-{</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    mPrintingOperation = false;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-}</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+nsMailboxService::nsMailboxService() { mPrintingOperation = false; }</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+nsMailboxService::~nsMailboxService() {}</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-nsMailboxService::~nsMailboxService()</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-{}</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMailboxService, nsIMailboxService, nsIMsgMessageService,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+                  nsIProtocolHandler, nsIMsgMessageFetchPartService)</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMailboxService, nsIMailboxService, nsIMsgMessageService, nsIProtocolHandler, nsIMsgMessageFetchPartService)</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-nsresult nsMailboxService::ParseMailbox(nsIMsgWindow *aMsgWindow, nsIFile *aMailboxPath, nsIStreamListener *aMailboxParser,</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-                    nsIUrlListener * aUrlListener, nsIURI ** aURL)</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-{</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+nsresult nsMailboxService::ParseMailbox(nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+                                        nsIFile *aMailboxPath,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+                                        nsIStreamListener *aMailboxParser,</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+                                        nsIUrlListener *aUrlListener,</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+                                        nsIURI **aURL) {</span>
<a href="#l12.51"></a><span id="l12.51">   NS_ENSURE_ARG_POINTER(aMailboxPath);</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">   nsresult rv;</span>
<a href="#l12.54"></a><span id="l12.54">   nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl =</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-    do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl)</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-  {</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+      do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl) {</span>
<a href="#l12.60"></a><span id="l12.60">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(mailboxurl);</span>
<a href="#l12.61"></a><span id="l12.61">     // okay now generate the url string</span>
<a href="#l12.62"></a><span id="l12.62"> #ifdef XP_WIN</span>
<a href="#l12.63"></a><span id="l12.63">     nsString path = aMailboxPath-&gt;NativePath();</span>
<a href="#l12.64"></a><span id="l12.64">     nsCString mailboxPath;</span>
<a href="#l12.65"></a><span id="l12.65">     NS_CopyUnicodeToNative(path, mailboxPath);</span>
<a href="#l12.66"></a><span id="l12.66"> #else</span>
<a href="#l12.67"></a><span id="l12.67">     nsCString mailboxPath = aMailboxPath-&gt;NativePath();</span>
<a href="#l12.68"></a><span id="l12.68"> #endif</span>
<a href="#l12.69"></a><span id="l12.69">     nsAutoCString buf;</span>
<a href="#l12.70"></a><span id="l12.70">     MsgEscapeURL(mailboxPath,</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-                 nsINetUtil::ESCAPE_URL_MINIMAL | nsINetUtil::ESCAPE_URL_FORCED, buf);</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+                 nsINetUtil::ESCAPE_URL_MINIMAL | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+                 buf);</span>
<a href="#l12.74"></a><span id="l12.74">     nsEscapeNativePath(buf);</span>
<a href="#l12.75"></a><span id="l12.75">     url-&gt;SetUpdatingFolder(true);</span>
<a href="#l12.76"></a><span id="l12.76">     url-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l12.77"></a><span id="l12.77">     nsAutoCString uriSpec(&quot;mailbox://&quot;);</span>
<a href="#l12.78"></a><span id="l12.78">     uriSpec.Append(buf);</span>
<a href="#l12.79"></a><span id="l12.79">     rv = url-&gt;SetSpecInternal(uriSpec);</span>
<a href="#l12.80"></a><span id="l12.80">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.81"></a><span id="l12.81"> </span>
<a href="#l12.82"></a><span id="l12.82">     mailboxurl-&gt;SetMailboxParser(aMailboxParser);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-    if (aUrlListener)</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-      url-&gt;RegisterListener(aUrlListener);</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+    if (aUrlListener) url-&gt;RegisterListener(aUrlListener);</span>
<a href="#l12.86"></a><span id="l12.86"> </span>
<a href="#l12.87"></a><span id="l12.87">     rv = RunMailboxUrl(url, nullptr);</span>
<a href="#l12.88"></a><span id="l12.88">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-    if (aURL)</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-    {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    if (aURL) {</span>
<a href="#l12.93"></a><span id="l12.93">       url.forget(aURL);</span>
<a href="#l12.94"></a><span id="l12.94">     }</span>
<a href="#l12.95"></a><span id="l12.95">   }</span>
<a href="#l12.96"></a><span id="l12.96"> </span>
<a href="#l12.97"></a><span id="l12.97">   return rv;</span>
<a href="#l12.98"></a><span id="l12.98"> }</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-nsresult nsMailboxService::CopyMessage(const char * aSrcMailboxURI,</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-                              nsIStreamListener * aMailboxCopyHandler,</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-                              bool moveMessage,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-                              nsIUrlListener * aUrlListener,</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-                              nsIURI **aURL)</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-{</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    nsMailboxAction mailboxAction = nsIMailboxUrl::ActionMoveMessage;</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-    if (!moveMessage)</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-        mailboxAction = nsIMailboxUrl::ActionCopyMessage;</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  return FetchMessage(aSrcMailboxURI, aMailboxCopyHandler, aMsgWindow, aUrlListener, nullptr, mailboxAction, nullptr, aURL);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+nsresult nsMailboxService::CopyMessage(const char *aSrcMailboxURI,</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+                                       nsIStreamListener *aMailboxCopyHandler,</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+                                       bool moveMessage,</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+                                       nsIUrlListener *aUrlListener,</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+                                       nsIURI **aURL) {</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  nsMailboxAction mailboxAction = nsIMailboxUrl::ActionMoveMessage;</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  if (!moveMessage) mailboxAction = nsIMailboxUrl::ActionCopyMessage;</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  return FetchMessage(aSrcMailboxURI, aMailboxCopyHandler, aMsgWindow,</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+                      aUrlListener, nullptr, mailboxAction, nullptr, aURL);</span>
<a href="#l12.121"></a><span id="l12.121"> }</span>
<a href="#l12.122"></a><span id="l12.122"> </span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-nsresult nsMailboxService::CopyMessages(uint32_t aNumKeys,</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-                                        nsMsgKey* aMsgKeys,</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-                                        nsIMsgFolder *srcFolder,</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-                                        nsIStreamListener * aMailboxCopyHandler,</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-                                        bool moveMessage,</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-                                        nsIUrlListener * aUrlListener,</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-                                        nsIURI **aURL)</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-{</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+nsresult nsMailboxService::CopyMessages(</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+    uint32_t aNumKeys, nsMsgKey *aMsgKeys, nsIMsgFolder *srcFolder,</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+    nsIStreamListener *aMailboxCopyHandler, bool moveMessage,</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+    nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l12.136"></a><span id="l12.136">   nsresult rv = NS_OK;</span>
<a href="#l12.137"></a><span id="l12.137">   NS_ENSURE_ARG(srcFolder);</span>
<a href="#l12.138"></a><span id="l12.138">   NS_ENSURE_ARG(aMsgKeys);</span>
<a href="#l12.139"></a><span id="l12.139">   nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl;</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141">   nsMailboxAction actionToUse = nsIMailboxUrl::ActionMoveMessage;</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-  if (!moveMessage)</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-     actionToUse = nsIMailboxUrl::ActionCopyMessage;</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  if (!moveMessage) actionToUse = nsIMailboxUrl::ActionCopyMessage;</span>
<a href="#l12.145"></a><span id="l12.145"> </span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l12.150"></a><span id="l12.150">   srcFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  if (db)</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-  {</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  if (db) {</span>
<a href="#l12.154"></a><span id="l12.154">     db-&gt;GetMsgHdrForKey(aMsgKeys[0], getter_AddRefs(msgHdr));</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-    if (msgHdr)</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-    {</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l12.158"></a><span id="l12.158">       nsCString uri;</span>
<a href="#l12.159"></a><span id="l12.159">       srcFolder-&gt;GetUriForMsg(msgHdr, uri);</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-      rv = PrepareMessageUrl(uri.get(), aUrlListener, actionToUse , getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+      rv = PrepareMessageUrl(uri.get(), aUrlListener, actionToUse,</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+                             getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.163"></a><span id="l12.163"> </span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-      {</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.167"></a><span id="l12.167">         nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(mailboxurl);</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(url));</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineminus">-        nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl (do_QueryInterface(url));</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(url));</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+        nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl(do_QueryInterface(url));</span>
<a href="#l12.172"></a><span id="l12.172">         msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l12.173"></a><span id="l12.173"> </span>
<a href="#l12.174"></a><span id="l12.174">         mailboxUrl-&gt;SetMoveCopyMsgKeys(aMsgKeys, aNumKeys);</span>
<a href="#l12.175"></a><span id="l12.175">         rv = RunMailboxUrl(url, aMailboxCopyHandler);</span>
<a href="#l12.176"></a><span id="l12.176">       }</span>
<a href="#l12.177"></a><span id="l12.177">     }</span>
<a href="#l12.178"></a><span id="l12.178">   }</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-  if (aURL &amp;&amp; mailboxurl)</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-    CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+  if (aURL &amp;&amp; mailboxurl) CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.182"></a><span id="l12.182"> </span>
<a href="#l12.183"></a><span id="l12.183">   return rv;</span>
<a href="#l12.184"></a><span id="l12.184"> }</span>
<a href="#l12.185"></a><span id="l12.185"> </span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-nsresult nsMailboxService::FetchMessage(const char* aMessageURI,</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineminus">-                                        nsISupports * aDisplayConsumer,</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineminus">-                                        nsIMsgWindow * aMsgWindow,</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineminus">-                                        nsIUrlListener * aUrlListener,</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineminus">-                                        const char * aFileName, /* only used by open attachment... */</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineminus">-                                        nsMailboxAction mailboxAction,</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineminus">-                                        const char * aCharsetOverride,</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineminus">-                                        nsIURI ** aURL)</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-{</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+nsresult nsMailboxService::FetchMessage(</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+    const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener,</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+    const char *aFileName, /* only used by open attachment... */</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+    nsMailboxAction mailboxAction, const char *aCharsetOverride,</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+    nsIURI **aURL) {</span>
<a href="#l12.201"></a><span id="l12.201">   nsresult rv = NS_OK;</span>
<a href="#l12.202"></a><span id="l12.202">   nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl;</span>
<a href="#l12.203"></a><span id="l12.203">   nsMailboxAction actionToUse = mailboxAction;</span>
<a href="#l12.204"></a><span id="l12.204">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l12.205"></a><span id="l12.205">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl;</span>
<a href="#l12.206"></a><span id="l12.206">   nsAutoCString uriString(aMessageURI);</span>
<a href="#l12.207"></a><span id="l12.207"> </span>
<a href="#l12.208"></a><span id="l12.208" class="difflineminus">-  if (!strncmp(aMessageURI, &quot;file:&quot;, 5))</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineminus">-  {</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+  if (!strncmp(aMessageURI, &quot;file:&quot;, 5)) {</span>
<a href="#l12.211"></a><span id="l12.211">     int64_t fileSize;</span>
<a href="#l12.212"></a><span id="l12.212">     nsCOMPtr&lt;nsIURI&gt; fileUri;</span>
<a href="#l12.213"></a><span id="l12.213">     rv = NS_NewURI(getter_AddRefs(fileUri), aMessageURI);</span>
<a href="#l12.214"></a><span id="l12.214">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-    nsCOMPtr &lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+    nsCOMPtr&lt;nsIFileURL&gt; fileUrl = do_QueryInterface(fileUri, &amp;rv);</span>
<a href="#l12.217"></a><span id="l12.217">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l12.220"></a><span id="l12.220">     rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l12.221"></a><span id="l12.221">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.222"></a><span id="l12.222">     file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l12.223"></a><span id="l12.223">     uriString.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l12.224"></a><span id="l12.224">     uriString.AppendLiteral(&quot;&amp;number=0&quot;);</span>
<a href="#l12.225"></a><span id="l12.225">     rv = NS_NewURI(getter_AddRefs(url), uriString);</span>
<a href="#l12.226"></a><span id="l12.226">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.227"></a><span id="l12.227"> </span>
<a href="#l12.228"></a><span id="l12.228">     msgUrl = do_QueryInterface(url);</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineminus">-    if (msgUrl)</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-    {</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+    if (msgUrl) {</span>
<a href="#l12.232"></a><span id="l12.232">       msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-      nsCOMPtr &lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(msgUrl, &amp;rv);</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-      mailboxUrl-&gt;SetMessageSize((uint32_t) fileSize);</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-      nsCOMPtr &lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-       // need to tell the header sink to capture some headers to create a fake db header</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-       // so we can do reply to a .eml file or a rfc822 msg attachment.</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-      if (aMsgWindow)</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-        aMsgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-      if (headerSink)</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-      {</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; dummyHeader;</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+      nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(msgUrl, &amp;rv);</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      mailboxUrl-&gt;SetMessageSize((uint32_t)fileSize);</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+      nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+      // need to tell the header sink to capture some headers to create a fake</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+      // db header so we can do reply to a .eml file or a rfc822 msg attachment.</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+      if (aMsgWindow) aMsgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+      if (headerSink) {</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; dummyHeader;</span>
<a href="#l12.251"></a><span id="l12.251">         headerSink-&gt;GetDummyMsgHeader(getter_AddRefs(dummyHeader));</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-        if (dummyHeader)</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-          dummyHeader-&gt;SetMessageSize((uint32_t) fileSize);</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+        if (dummyHeader) dummyHeader-&gt;SetMessageSize((uint32_t)fileSize);</span>
<a href="#l12.255"></a><span id="l12.255">       }</span>
<a href="#l12.256"></a><span id="l12.256">     }</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineminus">-  }</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineminus">-  else</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineminus">-  {</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+  } else {</span>
<a href="#l12.261"></a><span id="l12.261">     // this happens with forward inline of message/rfc822 attachment</span>
<a href="#l12.262"></a><span id="l12.262">     // opened in a stand-alone msg window.</span>
<a href="#l12.263"></a><span id="l12.263">     int32_t typeIndex = uriString.Find(&quot;&amp;type=application/x-message-display&quot;);</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-    if (typeIndex != -1)</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-    {</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineminus">-      uriString.Cut(typeIndex, sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+    if (typeIndex != -1) {</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+      uriString.Cut(typeIndex,</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+                    sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l12.270"></a><span id="l12.270">       rv = NS_NewURI(getter_AddRefs(url), uriString.get());</span>
<a href="#l12.271"></a><span id="l12.271">       mailboxurl = do_QueryInterface(url);</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-    }</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-    else</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineminus">-      rv = PrepareMessageUrl(aMessageURI, aUrlListener, actionToUse , getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+    } else</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+      rv = PrepareMessageUrl(aMessageURI, aUrlListener, actionToUse,</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+                             getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.278"></a><span id="l12.278"> </span>
<a href="#l12.279"></a><span id="l12.279" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineminus">-    {</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.282"></a><span id="l12.282">       url = do_QueryInterface(mailboxurl);</span>
<a href="#l12.283"></a><span id="l12.283">       msgUrl = do_QueryInterface(url);</span>
<a href="#l12.284"></a><span id="l12.284">       msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineminus">-      if (aFileName)</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineminus">-        msgUrl-&gt;SetFileNameInternal(nsDependentCString(aFileName));</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+      if (aFileName) msgUrl-&gt;SetFileNameInternal(nsDependentCString(aFileName));</span>
<a href="#l12.288"></a><span id="l12.288">     }</span>
<a href="#l12.289"></a><span id="l12.289">   }</span>
<a href="#l12.290"></a><span id="l12.290"> </span>
<a href="#l12.291"></a><span id="l12.291">   nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl(do_QueryInterface(msgUrl));</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineminus">-  if (i18nurl)</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">-    i18nurl-&gt;SetCharsetOverRide(aCharsetOverride);</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+  if (i18nurl) i18nurl-&gt;SetCharsetOverRide(aCharsetOverride);</span>
<a href="#l12.295"></a><span id="l12.295"> </span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">-  // instead of running the mailbox url like we used to, let's try to run the url in the docshell...</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+  // instead of running the mailbox url like we used to, let's try to run the</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+  // url in the docshell...</span>
<a href="#l12.299"></a><span id="l12.299">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-  // if we were given a docShell, run the url in the docshell..otherwise just run it normally.</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; docShell)</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineminus">-  {</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineminus">-    // DIRTY LITTLE HACK --&gt; if we are opening an attachment we want the docshell to</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-    // treat this load as if it were a user click event. Then the dispatching stuff will be much</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineminus">-    // happier.</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+  // if we were given a docShell, run the url in the docshell..otherwise just</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+  // run it normally.</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; docShell) {</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+    // DIRTY LITTLE HACK --&gt; if we are opening an attachment we want the</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+    // docshell to treat this load as if it were a user click event. Then the</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+    // dispatching stuff will be much happier.</span>
<a href="#l12.312"></a><span id="l12.312">     RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(url);</span>
<a href="#l12.313"></a><span id="l12.313">     loadState-&gt;SetLoadFlags(mailboxAction == nsIMailboxUrl::ActionFetchPart</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineminus">-                              ? nsIWebNavigation::LOAD_FLAGS_IS_LINK</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineminus">-                              : nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+                                ? nsIWebNavigation::LOAD_FLAGS_IS_LINK</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+                                : nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l12.318"></a><span id="l12.318">     if (mailboxAction == nsIMailboxUrl::ActionFetchPart)</span>
<a href="#l12.319"></a><span id="l12.319">       loadState-&gt;SetLoadType(LOAD_LINK);</span>
<a href="#l12.320"></a><span id="l12.320">     loadState-&gt;SetFirstParty(false);</span>
<a href="#l12.321"></a><span id="l12.321">     loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l12.322"></a><span id="l12.322">     rv = docShell-&gt;LoadURI(loadState);</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineminus">-  }</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineminus">-  else</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+  } else</span>
<a href="#l12.326"></a><span id="l12.326">     rv = RunMailboxUrl(url, aDisplayConsumer);</span>
<a href="#l12.327"></a><span id="l12.327"> </span>
<a href="#l12.328"></a><span id="l12.328" class="difflineminus">-  if (aURL &amp;&amp; mailboxurl)</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineminus">-    CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+  if (aURL &amp;&amp; mailboxurl) CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.331"></a><span id="l12.331"> </span>
<a href="#l12.332"></a><span id="l12.332">   return rv;</span>
<a href="#l12.333"></a><span id="l12.333"> }</span>
<a href="#l12.334"></a><span id="l12.334"> </span>
<a href="#l12.335"></a><span id="l12.335" class="difflineminus">-NS_IMETHODIMP nsMailboxService::FetchMimePart(nsIURI *aURI, const char *aMessageURI, nsISupports *aDisplayConsumer, nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL)</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineminus">-{</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+NS_IMETHODIMP nsMailboxService::FetchMimePart(</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+    nsIURI *aURI, const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l12.340"></a><span id="l12.340">   nsresult rv;</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl (do_QueryInterface(aURI, &amp;rv));</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(aURI, &amp;rv));</span>
<a href="#l12.343"></a><span id="l12.343">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.344"></a><span id="l12.344"> </span>
<a href="#l12.345"></a><span id="l12.345">   msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l12.346"></a><span id="l12.346"> </span>
<a href="#l12.347"></a><span id="l12.347">   // set up the url listener</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineminus">-  if (aUrlListener)</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineminus">-    msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+  if (aUrlListener) msgUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l12.351"></a><span id="l12.351"> </span>
<a href="#l12.352"></a><span id="l12.352">   return RunMailboxUrl(msgUrl, aDisplayConsumer);</span>
<a href="#l12.353"></a><span id="l12.353"> }</span>
<a href="#l12.354"></a><span id="l12.354"> </span>
<a href="#l12.355"></a><span id="l12.355" class="difflineminus">-NS_IMETHODIMP nsMailboxService::DisplayMessage(const char* aMessageURI,</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineminus">-                                               nsISupports * aDisplayConsumer,</span>
<a href="#l12.357"></a><span id="l12.357" class="difflineminus">-                                               nsIMsgWindow * aMsgWindow,</span>
<a href="#l12.358"></a><span id="l12.358" class="difflineminus">-                                               nsIUrlListener * aUrlListener,</span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-                                               const char * aCharsetOveride,</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-                                               nsIURI ** aURL)</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-{</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineminus">-  return FetchMessage(aMessageURI, aDisplayConsumer,</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineminus">-    aMsgWindow,aUrlListener, nullptr,</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineminus">-    nsIMailboxUrl::ActionFetchMessage, aCharsetOveride, aURL);</span>
<a href="#l12.365"></a><span id="l12.365" class="difflineplus">+NS_IMETHODIMP nsMailboxService::DisplayMessage(const char *aMessageURI,</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineplus">+                                               nsISupports *aDisplayConsumer,</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.368"></a><span id="l12.368" class="difflineplus">+                                               nsIUrlListener *aUrlListener,</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineplus">+                                               const char *aCharsetOveride,</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+                                               nsIURI **aURL) {</span>
<a href="#l12.371"></a><span id="l12.371" class="difflineplus">+  return FetchMessage(aMessageURI, aDisplayConsumer, aMsgWindow, aUrlListener,</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineplus">+                      nullptr, nsIMailboxUrl::ActionFetchMessage,</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+                      aCharsetOveride, aURL);</span>
<a href="#l12.374"></a><span id="l12.374"> }</span>
<a href="#l12.375"></a><span id="l12.375"> </span>
<a href="#l12.376"></a><span id="l12.376"> NS_IMETHODIMP</span>
<a href="#l12.377"></a><span id="l12.377" class="difflineminus">-nsMailboxService::StreamMessage(const char *aMessageURI,</span>
<a href="#l12.378"></a><span id="l12.378" class="difflineminus">-                                nsISupports *aConsumer,</span>
<a href="#l12.379"></a><span id="l12.379" class="difflineplus">+nsMailboxService::StreamMessage(const char *aMessageURI, nsISupports *aConsumer,</span>
<a href="#l12.380"></a><span id="l12.380">                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.381"></a><span id="l12.381">                                 nsIUrlListener *aUrlListener,</span>
<a href="#l12.382"></a><span id="l12.382">                                 bool /* aConvertData */,</span>
<a href="#l12.383"></a><span id="l12.383">                                 const nsACString &amp;aAdditionalHeader,</span>
<a href="#l12.384"></a><span id="l12.384" class="difflineminus">-                                bool aLocalOnly,</span>
<a href="#l12.385"></a><span id="l12.385" class="difflineminus">-                                nsIURI **aURL)</span>
<a href="#l12.386"></a><span id="l12.386" class="difflineminus">-{</span>
<a href="#l12.387"></a><span id="l12.387" class="difflineminus">-    // The mailbox protocol object will look for &quot;header=filter&quot; or</span>
<a href="#l12.388"></a><span id="l12.388" class="difflineminus">-    // &quot;header=attach&quot; to decide if it wants to convert the data instead of</span>
<a href="#l12.389"></a><span id="l12.389" class="difflineminus">-    // using aConvertData. It turns out to be way too hard to pass aConvertData</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineminus">-    // all the way over to the mailbox protocol object.</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineminus">-    nsAutoCString aURIString(aMessageURI);</span>
<a href="#l12.392"></a><span id="l12.392" class="difflineminus">-    if (!aAdditionalHeader.IsEmpty())</span>
<a href="#l12.393"></a><span id="l12.393" class="difflineminus">-    {</span>
<a href="#l12.394"></a><span id="l12.394" class="difflineminus">-      aURIString.FindChar('?') == -1 ? aURIString += &quot;?&quot; : aURIString += &quot;&amp;&quot;;</span>
<a href="#l12.395"></a><span id="l12.395" class="difflineminus">-      aURIString += &quot;header=&quot;;</span>
<a href="#l12.396"></a><span id="l12.396" class="difflineminus">-      aURIString += aAdditionalHeader;</span>
<a href="#l12.397"></a><span id="l12.397" class="difflineminus">-    }</span>
<a href="#l12.398"></a><span id="l12.398" class="difflineplus">+                                bool aLocalOnly, nsIURI **aURL) {</span>
<a href="#l12.399"></a><span id="l12.399" class="difflineplus">+  // The mailbox protocol object will look for &quot;header=filter&quot; or</span>
<a href="#l12.400"></a><span id="l12.400" class="difflineplus">+  // &quot;header=attach&quot; to decide if it wants to convert the data instead of</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+  // using aConvertData. It turns out to be way too hard to pass aConvertData</span>
<a href="#l12.402"></a><span id="l12.402" class="difflineplus">+  // all the way over to the mailbox protocol object.</span>
<a href="#l12.403"></a><span id="l12.403" class="difflineplus">+  nsAutoCString aURIString(aMessageURI);</span>
<a href="#l12.404"></a><span id="l12.404" class="difflineplus">+  if (!aAdditionalHeader.IsEmpty()) {</span>
<a href="#l12.405"></a><span id="l12.405" class="difflineplus">+    aURIString.FindChar('?') == -1 ? aURIString += &quot;?&quot; : aURIString += &quot;&amp;&quot;;</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+    aURIString += &quot;header=&quot;;</span>
<a href="#l12.407"></a><span id="l12.407" class="difflineplus">+    aURIString += aAdditionalHeader;</span>
<a href="#l12.408"></a><span id="l12.408" class="difflineplus">+  }</span>
<a href="#l12.409"></a><span id="l12.409"> </span>
<a href="#l12.410"></a><span id="l12.410" class="difflineminus">-    return FetchMessage(aURIString.get(), aConsumer, aMsgWindow, aUrlListener, nullptr,</span>
<a href="#l12.411"></a><span id="l12.411" class="difflineminus">-                                        nsIMailboxUrl::ActionFetchMessage, nullptr, aURL);</span>
<a href="#l12.412"></a><span id="l12.412" class="difflineplus">+  return FetchMessage(aURIString.get(), aConsumer, aMsgWindow, aUrlListener,</span>
<a href="#l12.413"></a><span id="l12.413" class="difflineplus">+                      nullptr, nsIMailboxUrl::ActionFetchMessage, nullptr,</span>
<a href="#l12.414"></a><span id="l12.414" class="difflineplus">+                      aURL);</span>
<a href="#l12.415"></a><span id="l12.415"> }</span>
<a href="#l12.416"></a><span id="l12.416"> </span>
<a href="#l12.417"></a><span id="l12.417"> NS_IMETHODIMP nsMailboxService::StreamHeaders(const char *aMessageURI,</span>
<a href="#l12.418"></a><span id="l12.418">                                               nsIStreamListener *aConsumer,</span>
<a href="#l12.419"></a><span id="l12.419">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l12.420"></a><span id="l12.420" class="difflineminus">-                                              bool aLocalOnly,</span>
<a href="#l12.421"></a><span id="l12.421" class="difflineminus">-                                              nsIURI **aURL)</span>
<a href="#l12.422"></a><span id="l12.422" class="difflineminus">-{</span>
<a href="#l12.423"></a><span id="l12.423" class="difflineplus">+                                              bool aLocalOnly, nsIURI **aURL) {</span>
<a href="#l12.424"></a><span id="l12.424">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l12.425"></a><span id="l12.425">   NS_ENSURE_ARG_POINTER(aConsumer);</span>
<a href="#l12.426"></a><span id="l12.426">   nsAutoCString folderURI;</span>
<a href="#l12.427"></a><span id="l12.427">   nsMsgKey msgKey;</span>
<a href="#l12.428"></a><span id="l12.428">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineminus">-  nsresult rv = DecomposeMailboxURI(aMessageURI, getter_AddRefs(folder), &amp;msgKey);</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineminus">-  if (msgKey == nsMsgKey_None)</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.432"></a><span id="l12.432" class="difflineplus">+  nsresult rv =</span>
<a href="#l12.433"></a><span id="l12.433" class="difflineplus">+      DecomposeMailboxURI(aMessageURI, getter_AddRefs(folder), &amp;msgKey);</span>
<a href="#l12.434"></a><span id="l12.434" class="difflineplus">+  if (msgKey == nsMsgKey_None) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l12.435"></a><span id="l12.435"> </span>
<a href="#l12.436"></a><span id="l12.436">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l12.437"></a><span id="l12.437">   int64_t messageOffset;</span>
<a href="#l12.438"></a><span id="l12.438">   uint32_t messageSize;</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineminus">-  rv = folder-&gt;GetOfflineFileStream(msgKey, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l12.440"></a><span id="l12.440" class="difflineplus">+  rv = folder-&gt;GetOfflineFileStream(msgKey, &amp;messageOffset, &amp;messageSize,</span>
<a href="#l12.441"></a><span id="l12.441" class="difflineplus">+                                    getter_AddRefs(inputStream));</span>
<a href="#l12.442"></a><span id="l12.442">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.443"></a><span id="l12.443"> </span>
<a href="#l12.444"></a><span id="l12.444" class="difflineminus">-  // GetOfflineFileStream returns NS_OK but null inputStream when there is an error getting the database</span>
<a href="#l12.445"></a><span id="l12.445" class="difflineminus">-  if (!inputStream)</span>
<a href="#l12.446"></a><span id="l12.446" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l12.447"></a><span id="l12.447" class="difflineplus">+  // GetOfflineFileStream returns NS_OK but null inputStream when there is an</span>
<a href="#l12.448"></a><span id="l12.448" class="difflineplus">+  // error getting the database</span>
<a href="#l12.449"></a><span id="l12.449" class="difflineplus">+  if (!inputStream) return NS_ERROR_FAILURE;</span>
<a href="#l12.450"></a><span id="l12.450">   return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l12.451"></a><span id="l12.451"> }</span>
<a href="#l12.452"></a><span id="l12.452"> </span>
<a href="#l12.453"></a><span id="l12.453" class="difflineminus">-</span>
<a href="#l12.454"></a><span id="l12.454"> NS_IMETHODIMP nsMailboxService::IsMsgInMemCache(nsIURI *aUrl,</span>
<a href="#l12.455"></a><span id="l12.455">                                                 nsIMsgFolder *aFolder,</span>
<a href="#l12.456"></a><span id="l12.456" class="difflineminus">-                                                bool *aResult)</span>
<a href="#l12.457"></a><span id="l12.457" class="difflineminus">-{</span>
<a href="#l12.458"></a><span id="l12.458" class="difflineplus">+                                                bool *aResult) {</span>
<a href="#l12.459"></a><span id="l12.459">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.460"></a><span id="l12.460"> }</span>
<a href="#l12.461"></a><span id="l12.461"> </span>
<a href="#l12.462"></a><span id="l12.462" class="difflineminus">-NS_IMETHODIMP nsMailboxService::OpenAttachment(const char *aContentType,</span>
<a href="#l12.463"></a><span id="l12.463" class="difflineminus">-                                               const char *aFileName,</span>
<a href="#l12.464"></a><span id="l12.464" class="difflineminus">-                                               const char *aUrl,</span>
<a href="#l12.465"></a><span id="l12.465" class="difflineminus">-                                               const char *aMessageUri,</span>
<a href="#l12.466"></a><span id="l12.466" class="difflineminus">-                                               nsISupports *aDisplayConsumer,</span>
<a href="#l12.467"></a><span id="l12.467" class="difflineminus">-                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.468"></a><span id="l12.468" class="difflineminus">-                                               nsIUrlListener *aUrlListener)</span>
<a href="#l12.469"></a><span id="l12.469" class="difflineminus">-{</span>
<a href="#l12.470"></a><span id="l12.470" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; URL;</span>
<a href="#l12.471"></a><span id="l12.471" class="difflineplus">+NS_IMETHODIMP nsMailboxService::OpenAttachment(</span>
<a href="#l12.472"></a><span id="l12.472" class="difflineplus">+    const char *aContentType, const char *aFileName, const char *aUrl,</span>
<a href="#l12.473"></a><span id="l12.473" class="difflineplus">+    const char *aMessageUri, nsISupports *aDisplayConsumer,</span>
<a href="#l12.474"></a><span id="l12.474" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener) {</span>
<a href="#l12.475"></a><span id="l12.475" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; URL;</span>
<a href="#l12.476"></a><span id="l12.476">   nsAutoCString urlString(aUrl);</span>
<a href="#l12.477"></a><span id="l12.477">   urlString += &quot;&amp;type=&quot;;</span>
<a href="#l12.478"></a><span id="l12.478">   urlString += aContentType;</span>
<a href="#l12.479"></a><span id="l12.479">   urlString += &quot;&amp;filename=&quot;;</span>
<a href="#l12.480"></a><span id="l12.480">   urlString += aFileName;</span>
<a href="#l12.481"></a><span id="l12.481">   nsresult rv = NS_NewURI(getter_AddRefs(URL), urlString);</span>
<a href="#l12.482"></a><span id="l12.482">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.483"></a><span id="l12.483"> </span>
<a href="#l12.484"></a><span id="l12.484">   // try to run the url in the docshell...</span>
<a href="#l12.485"></a><span id="l12.485">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l12.486"></a><span id="l12.486" class="difflineminus">-  // if we were given a docShell, run the url in the docshell..otherwise just run it normally.</span>
<a href="#l12.487"></a><span id="l12.487" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; docShell)</span>
<a href="#l12.488"></a><span id="l12.488" class="difflineminus">-  {</span>
<a href="#l12.489"></a><span id="l12.489" class="difflineminus">-    // DIRTY LITTLE HACK --&gt; since we are opening an attachment we want the docshell to</span>
<a href="#l12.490"></a><span id="l12.490" class="difflineminus">-    // treat this load as if it were a user click event. Then the dispatching stuff will be much</span>
<a href="#l12.491"></a><span id="l12.491" class="difflineminus">-    // happier.</span>
<a href="#l12.492"></a><span id="l12.492" class="difflineplus">+  // if we were given a docShell, run the url in the docshell..otherwise just</span>
<a href="#l12.493"></a><span id="l12.493" class="difflineplus">+  // run it normally.</span>
<a href="#l12.494"></a><span id="l12.494" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; docShell) {</span>
<a href="#l12.495"></a><span id="l12.495" class="difflineplus">+    // DIRTY LITTLE HACK --&gt; since we are opening an attachment we want the</span>
<a href="#l12.496"></a><span id="l12.496" class="difflineplus">+    // docshell to treat this load as if it were a user click event. Then the</span>
<a href="#l12.497"></a><span id="l12.497" class="difflineplus">+    // dispatching stuff will be much happier.</span>
<a href="#l12.498"></a><span id="l12.498">     RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(URL);</span>
<a href="#l12.499"></a><span id="l12.499">     loadState-&gt;SetLoadFlags(nsIWebNavigation::LOAD_FLAGS_IS_LINK);</span>
<a href="#l12.500"></a><span id="l12.500">     loadState-&gt;SetLoadType(LOAD_LINK);</span>
<a href="#l12.501"></a><span id="l12.501">     loadState-&gt;SetFirstParty(false);</span>
<a href="#l12.502"></a><span id="l12.502">     loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l12.503"></a><span id="l12.503">     return docShell-&gt;LoadURI(loadState);</span>
<a href="#l12.504"></a><span id="l12.504">   }</span>
<a href="#l12.505"></a><span id="l12.505">   return RunMailboxUrl(URL, aDisplayConsumer);</span>
<a href="#l12.506"></a><span id="l12.506" class="difflineminus">-</span>
<a href="#l12.507"></a><span id="l12.507"> }</span>
<a href="#l12.508"></a><span id="l12.508"> </span>
<a href="#l12.509"></a><span id="l12.509" class="difflineminus">-</span>
<a href="#l12.510"></a><span id="l12.510"> NS_IMETHODIMP</span>
<a href="#l12.511"></a><span id="l12.511" class="difflineminus">-nsMailboxService::SaveMessageToDisk(const char *aMessageURI,</span>
<a href="#l12.512"></a><span id="l12.512" class="difflineminus">-                                    nsIFile *aFile,</span>
<a href="#l12.513"></a><span id="l12.513" class="difflineplus">+nsMailboxService::SaveMessageToDisk(const char *aMessageURI, nsIFile *aFile,</span>
<a href="#l12.514"></a><span id="l12.514">                                     bool aAddDummyEnvelope,</span>
<a href="#l12.515"></a><span id="l12.515" class="difflineminus">-                                    nsIUrlListener *aUrlListener,</span>
<a href="#l12.516"></a><span id="l12.516" class="difflineminus">-                                    nsIURI **aURL,</span>
<a href="#l12.517"></a><span id="l12.517" class="difflineplus">+                                    nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l12.518"></a><span id="l12.518">                                     bool canonicalLineEnding,</span>
<a href="#l12.519"></a><span id="l12.519" class="difflineminus">-                                    nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.520"></a><span id="l12.520" class="difflineminus">-{</span>
<a href="#l12.521"></a><span id="l12.521" class="difflineplus">+                                    nsIMsgWindow *aMsgWindow) {</span>
<a href="#l12.522"></a><span id="l12.522">   nsresult rv = NS_OK;</span>
<a href="#l12.523"></a><span id="l12.523">   nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl;</span>
<a href="#l12.524"></a><span id="l12.524"> </span>
<a href="#l12.525"></a><span id="l12.525" class="difflineminus">-  rv = PrepareMessageUrl(aMessageURI, aUrlListener, nsIMailboxUrl::ActionSaveMessageToDisk, getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.526"></a><span id="l12.526" class="difflineplus">+  rv = PrepareMessageUrl(aMessageURI, aUrlListener,</span>
<a href="#l12.527"></a><span id="l12.527" class="difflineplus">+                         nsIMailboxUrl::ActionSaveMessageToDisk,</span>
<a href="#l12.528"></a><span id="l12.528" class="difflineplus">+                         getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.529"></a><span id="l12.529"> </span>
<a href="#l12.530"></a><span id="l12.530" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l12.531"></a><span id="l12.531" class="difflineminus">-  {</span>
<a href="#l12.532"></a><span id="l12.532" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.533"></a><span id="l12.533">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(mailboxurl);</span>
<a href="#l12.534"></a><span id="l12.534" class="difflineminus">-    if (msgUrl)</span>
<a href="#l12.535"></a><span id="l12.535" class="difflineminus">-    {</span>
<a href="#l12.536"></a><span id="l12.536" class="difflineplus">+    if (msgUrl) {</span>
<a href="#l12.537"></a><span id="l12.537">       msgUrl-&gt;SetMessageFile(aFile);</span>
<a href="#l12.538"></a><span id="l12.538">       msgUrl-&gt;SetAddDummyEnvelope(aAddDummyEnvelope);</span>
<a href="#l12.539"></a><span id="l12.539">       msgUrl-&gt;SetCanonicalLineEnding(canonicalLineEnding);</span>
<a href="#l12.540"></a><span id="l12.540">     }</span>
<a href="#l12.541"></a><span id="l12.541"> </span>
<a href="#l12.542"></a><span id="l12.542">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(mailboxurl);</span>
<a href="#l12.543"></a><span id="l12.543">     rv = RunMailboxUrl(url);</span>
<a href="#l12.544"></a><span id="l12.544">   }</span>
<a href="#l12.545"></a><span id="l12.545"> </span>
<a href="#l12.546"></a><span id="l12.546" class="difflineminus">-  if (aURL &amp;&amp; mailboxurl)</span>
<a href="#l12.547"></a><span id="l12.547" class="difflineminus">-    CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.548"></a><span id="l12.548" class="difflineplus">+  if (aURL &amp;&amp; mailboxurl) CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.549"></a><span id="l12.549"> </span>
<a href="#l12.550"></a><span id="l12.550">   return rv;</span>
<a href="#l12.551"></a><span id="l12.551"> }</span>
<a href="#l12.552"></a><span id="l12.552"> </span>
<a href="#l12.553"></a><span id="l12.553" class="difflineminus">-NS_IMETHODIMP nsMailboxService::GetUrlForUri(const char *aMessageURI, nsIURI **aURL, nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.554"></a><span id="l12.554" class="difflineminus">-{</span>
<a href="#l12.555"></a><span id="l12.555" class="difflineplus">+NS_IMETHODIMP nsMailboxService::GetUrlForUri(const char *aMessageURI,</span>
<a href="#l12.556"></a><span id="l12.556" class="difflineplus">+                                             nsIURI **aURL,</span>
<a href="#l12.557"></a><span id="l12.557" class="difflineplus">+                                             nsIMsgWindow *aMsgWindow) {</span>
<a href="#l12.558"></a><span id="l12.558">   NS_ENSURE_ARG_POINTER(aURL);</span>
<a href="#l12.559"></a><span id="l12.559" class="difflineminus">-  if (!strncmp(aMessageURI, &quot;file:&quot;, 5) || PL_strstr(aMessageURI, &quot;type=application/x-message-display&quot;)</span>
<a href="#l12.560"></a><span id="l12.560" class="difflineminus">-    || !strncmp(aMessageURI, &quot;mailbox:&quot;, 8))</span>
<a href="#l12.561"></a><span id="l12.561" class="difflineplus">+  if (!strncmp(aMessageURI, &quot;file:&quot;, 5) ||</span>
<a href="#l12.562"></a><span id="l12.562" class="difflineplus">+      PL_strstr(aMessageURI, &quot;type=application/x-message-display&quot;) ||</span>
<a href="#l12.563"></a><span id="l12.563" class="difflineplus">+      !strncmp(aMessageURI, &quot;mailbox:&quot;, 8))</span>
<a href="#l12.564"></a><span id="l12.564">     return NS_NewURI(aURL, aMessageURI);</span>
<a href="#l12.565"></a><span id="l12.565"> </span>
<a href="#l12.566"></a><span id="l12.566">   nsresult rv = NS_OK;</span>
<a href="#l12.567"></a><span id="l12.567">   nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl;</span>
<a href="#l12.568"></a><span id="l12.568" class="difflineminus">-  rv = PrepareMessageUrl(aMessageURI, nullptr, nsIMailboxUrl::ActionFetchMessage, getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.569"></a><span id="l12.569" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl)</span>
<a href="#l12.570"></a><span id="l12.570" class="difflineminus">-    rv = CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.571"></a><span id="l12.571" class="difflineplus">+  rv =</span>
<a href="#l12.572"></a><span id="l12.572" class="difflineplus">+      PrepareMessageUrl(aMessageURI, nullptr, nsIMailboxUrl::ActionFetchMessage,</span>
<a href="#l12.573"></a><span id="l12.573" class="difflineplus">+                        getter_AddRefs(mailboxurl), aMsgWindow);</span>
<a href="#l12.574"></a><span id="l12.574" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl) rv = CallQueryInterface(mailboxurl, aURL);</span>
<a href="#l12.575"></a><span id="l12.575">   return rv;</span>
<a href="#l12.576"></a><span id="l12.576"> }</span>
<a href="#l12.577"></a><span id="l12.577"> </span>
<a href="#l12.578"></a><span id="l12.578" class="difflineminus">-// Takes a mailbox url, this method creates a protocol instance and loads the url</span>
<a href="#l12.579"></a><span id="l12.579" class="difflineminus">-// into the protocol instance.</span>
<a href="#l12.580"></a><span id="l12.580" class="difflineminus">-nsresult nsMailboxService::RunMailboxUrl(nsIURI * aMailboxUrl, nsISupports * aDisplayConsumer)</span>
<a href="#l12.581"></a><span id="l12.581" class="difflineminus">-{</span>
<a href="#l12.582"></a><span id="l12.582" class="difflineplus">+// Takes a mailbox url, this method creates a protocol instance and loads the</span>
<a href="#l12.583"></a><span id="l12.583" class="difflineplus">+// url into the protocol instance.</span>
<a href="#l12.584"></a><span id="l12.584" class="difflineplus">+nsresult nsMailboxService::RunMailboxUrl(nsIURI *aMailboxUrl,</span>
<a href="#l12.585"></a><span id="l12.585" class="difflineplus">+                                         nsISupports *aDisplayConsumer) {</span>
<a href="#l12.586"></a><span id="l12.586">   // create a protocol instance to run the url..</span>
<a href="#l12.587"></a><span id="l12.587">   nsresult rv = NS_OK;</span>
<a href="#l12.588"></a><span id="l12.588">   RefPtr&lt;nsMailboxProtocol&gt; protocol = new nsMailboxProtocol(aMailboxUrl);</span>
<a href="#l12.589"></a><span id="l12.589"> </span>
<a href="#l12.590"></a><span id="l12.590" class="difflineminus">-  if (protocol)</span>
<a href="#l12.591"></a><span id="l12.591" class="difflineminus">-  {</span>
<a href="#l12.592"></a><span id="l12.592" class="difflineplus">+  if (protocol) {</span>
<a href="#l12.593"></a><span id="l12.593">     rv = protocol-&gt;Initialize(aMailboxUrl);</span>
<a href="#l12.594"></a><span id="l12.594" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l12.595"></a><span id="l12.595" class="difflineminus">-    {</span>
<a href="#l12.596"></a><span id="l12.596" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l12.597"></a><span id="l12.597">       protocol = nullptr;</span>
<a href="#l12.598"></a><span id="l12.598">       return rv;</span>
<a href="#l12.599"></a><span id="l12.599">     }</span>
<a href="#l12.600"></a><span id="l12.600">     rv = protocol-&gt;LoadUrl(aMailboxUrl, aDisplayConsumer);</span>
<a href="#l12.601"></a><span id="l12.601">   }</span>
<a href="#l12.602"></a><span id="l12.602"> </span>
<a href="#l12.603"></a><span id="l12.603">   return rv;</span>
<a href="#l12.604"></a><span id="l12.604"> }</span>
<a href="#l12.605"></a><span id="l12.605"> </span>
<a href="#l12.606"></a><span id="l12.606"> // This function takes a message uri, converts it into a file path &amp; msgKey</span>
<a href="#l12.607"></a><span id="l12.607"> // pair. It then turns that into a mailbox url object. It also registers a url</span>
<a href="#l12.608"></a><span id="l12.608" class="difflineminus">-// listener if appropriate. AND it can take in a mailbox action and set that field</span>
<a href="#l12.609"></a><span id="l12.609" class="difflineminus">-// on the returned url as well.</span>
<a href="#l12.610"></a><span id="l12.610" class="difflineminus">-nsresult nsMailboxService::PrepareMessageUrl(const char * aSrcMsgMailboxURI, nsIUrlListener * aUrlListener,</span>
<a href="#l12.611"></a><span id="l12.611" class="difflineminus">-                                             nsMailboxAction aMailboxAction, nsIMailboxUrl ** aMailboxUrl,</span>
<a href="#l12.612"></a><span id="l12.612" class="difflineminus">-                                             nsIMsgWindow *msgWindow)</span>
<a href="#l12.613"></a><span id="l12.613" class="difflineminus">-{</span>
<a href="#l12.614"></a><span id="l12.614" class="difflineplus">+// listener if appropriate. AND it can take in a mailbox action and set that</span>
<a href="#l12.615"></a><span id="l12.615" class="difflineplus">+// field on the returned url as well.</span>
<a href="#l12.616"></a><span id="l12.616" class="difflineplus">+nsresult nsMailboxService::PrepareMessageUrl(const char *aSrcMsgMailboxURI,</span>
<a href="#l12.617"></a><span id="l12.617" class="difflineplus">+                                             nsIUrlListener *aUrlListener,</span>
<a href="#l12.618"></a><span id="l12.618" class="difflineplus">+                                             nsMailboxAction aMailboxAction,</span>
<a href="#l12.619"></a><span id="l12.619" class="difflineplus">+                                             nsIMailboxUrl **aMailboxUrl,</span>
<a href="#l12.620"></a><span id="l12.620" class="difflineplus">+                                             nsIMsgWindow *msgWindow) {</span>
<a href="#l12.621"></a><span id="l12.621">   nsresult rv = CallCreateInstance(NS_MAILBOXURL_CONTRACTID, aMailboxUrl);</span>
<a href="#l12.622"></a><span id="l12.622" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; aMailboxUrl &amp;&amp; *aMailboxUrl)</span>
<a href="#l12.623"></a><span id="l12.623" class="difflineminus">-  {</span>
<a href="#l12.624"></a><span id="l12.624" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; aMailboxUrl &amp;&amp; *aMailboxUrl) {</span>
<a href="#l12.625"></a><span id="l12.625">     // okay now generate the url string</span>
<a href="#l12.626"></a><span id="l12.626" class="difflineminus">-    char * urlSpec;</span>
<a href="#l12.627"></a><span id="l12.627" class="difflineplus">+    char *urlSpec;</span>
<a href="#l12.628"></a><span id="l12.628">     nsAutoCString folderURI;</span>
<a href="#l12.629"></a><span id="l12.629">     nsMsgKey msgKey;</span>
<a href="#l12.630"></a><span id="l12.630">     nsCString folderPath;</span>
<a href="#l12.631"></a><span id="l12.631">     const char *part = PL_strstr(aSrcMsgMailboxURI, &quot;part=&quot;);</span>
<a href="#l12.632"></a><span id="l12.632">     const char *header = PL_strstr(aSrcMsgMailboxURI, &quot;header=&quot;);</span>
<a href="#l12.633"></a><span id="l12.633">     rv = nsParseLocalMessageURI(aSrcMsgMailboxURI, folderURI, &amp;msgKey);</span>
<a href="#l12.634"></a><span id="l12.634" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.635"></a><span id="l12.635" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.636"></a><span id="l12.636">     rv = nsLocalURI2Path(kMailboxRootURI, folderURI.get(), folderPath);</span>
<a href="#l12.637"></a><span id="l12.637"> </span>
<a href="#l12.638"></a><span id="l12.638" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.639"></a><span id="l12.639" class="difflineminus">-    {</span>
<a href="#l12.640"></a><span id="l12.640" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.641"></a><span id="l12.641">       // set up the url spec and initialize the url with it.</span>
<a href="#l12.642"></a><span id="l12.642">       nsAutoCString buf;</span>
<a href="#l12.643"></a><span id="l12.643" class="difflineminus">-      MsgEscapeURL(folderPath,</span>
<a href="#l12.644"></a><span id="l12.644" class="difflineminus">-                   nsINetUtil::ESCAPE_URL_DIRECTORY | nsINetUtil::ESCAPE_URL_FORCED, buf);</span>
<a href="#l12.645"></a><span id="l12.645" class="difflineplus">+      MsgEscapeURL(</span>
<a href="#l12.646"></a><span id="l12.646" class="difflineplus">+          folderPath,</span>
<a href="#l12.647"></a><span id="l12.647" class="difflineplus">+          nsINetUtil::ESCAPE_URL_DIRECTORY | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l12.648"></a><span id="l12.648" class="difflineplus">+          buf);</span>
<a href="#l12.649"></a><span id="l12.649">       if (mPrintingOperation)</span>
<a href="#l12.650"></a><span id="l12.650" class="difflineminus">-        urlSpec = PR_smprintf(&quot;mailbox://%s?number=%lu&amp;header=print&quot;, buf.get(), msgKey);</span>
<a href="#l12.651"></a><span id="l12.651" class="difflineplus">+        urlSpec = PR_smprintf(&quot;mailbox://%s?number=%lu&amp;header=print&quot;, buf.get(),</span>
<a href="#l12.652"></a><span id="l12.652" class="difflineplus">+                              msgKey);</span>
<a href="#l12.653"></a><span id="l12.653">       else if (part)</span>
<a href="#l12.654"></a><span id="l12.654" class="difflineminus">-        urlSpec = PR_smprintf(&quot;mailbox://%s?number=%lu&amp;%s&quot;, buf.get(), msgKey, part);</span>
<a href="#l12.655"></a><span id="l12.655" class="difflineplus">+        urlSpec =</span>
<a href="#l12.656"></a><span id="l12.656" class="difflineplus">+            PR_smprintf(&quot;mailbox://%s?number=%lu&amp;%s&quot;, buf.get(), msgKey, part);</span>
<a href="#l12.657"></a><span id="l12.657">       else if (header)</span>
<a href="#l12.658"></a><span id="l12.658" class="difflineminus">-        urlSpec = PR_smprintf(&quot;mailbox://%s?number=%lu&amp;%s&quot;, buf.get(), msgKey, header);</span>
<a href="#l12.659"></a><span id="l12.659" class="difflineplus">+        urlSpec = PR_smprintf(&quot;mailbox://%s?number=%lu&amp;%s&quot;, buf.get(), msgKey,</span>
<a href="#l12.660"></a><span id="l12.660" class="difflineplus">+                              header);</span>
<a href="#l12.661"></a><span id="l12.661">       else</span>
<a href="#l12.662"></a><span id="l12.662">         urlSpec = PR_smprintf(&quot;mailbox://%s?number=%lu&quot;, buf.get(), msgKey);</span>
<a href="#l12.663"></a><span id="l12.663"> </span>
<a href="#l12.664"></a><span id="l12.664" class="difflineminus">-      nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(*aMailboxUrl);</span>
<a href="#l12.665"></a><span id="l12.665" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(*aMailboxUrl);</span>
<a href="#l12.666"></a><span id="l12.666">       rv = url-&gt;SetSpecInternal(nsDependentCString(urlSpec));</span>
<a href="#l12.667"></a><span id="l12.667">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.668"></a><span id="l12.668"> </span>
<a href="#l12.669"></a><span id="l12.669">       PR_smprintf_free(urlSpec);</span>
<a href="#l12.670"></a><span id="l12.670"> </span>
<a href="#l12.671"></a><span id="l12.671">       (*aMailboxUrl)-&gt;SetMailboxAction(aMailboxAction);</span>
<a href="#l12.672"></a><span id="l12.672"> </span>
<a href="#l12.673"></a><span id="l12.673">       // set up the url listener</span>
<a href="#l12.674"></a><span id="l12.674" class="difflineminus">-      if (aUrlListener)</span>
<a href="#l12.675"></a><span id="l12.675" class="difflineminus">-        rv = url-&gt;RegisterListener(aUrlListener);</span>
<a href="#l12.676"></a><span id="l12.676" class="difflineplus">+      if (aUrlListener) rv = url-&gt;RegisterListener(aUrlListener);</span>
<a href="#l12.677"></a><span id="l12.677"> </span>
<a href="#l12.678"></a><span id="l12.678">       url-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l12.679"></a><span id="l12.679">       nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(url);</span>
<a href="#l12.680"></a><span id="l12.680" class="difflineminus">-      if (msgUrl)</span>
<a href="#l12.681"></a><span id="l12.681" class="difflineminus">-      {</span>
<a href="#l12.682"></a><span id="l12.682" class="difflineplus">+      if (msgUrl) {</span>
<a href="#l12.683"></a><span id="l12.683">         msgUrl-&gt;SetOriginalSpec(aSrcMsgMailboxURI);</span>
<a href="#l12.684"></a><span id="l12.684">         msgUrl-&gt;SetUri(aSrcMsgMailboxURI);</span>
<a href="#l12.685"></a><span id="l12.685">       }</span>
<a href="#l12.686"></a><span id="l12.686"> </span>
<a href="#l12.687"></a><span id="l12.687" class="difflineminus">-    } // if we got a url</span>
<a href="#l12.688"></a><span id="l12.688" class="difflineminus">-  } // if we got a url</span>
<a href="#l12.689"></a><span id="l12.689" class="difflineplus">+    }  // if we got a url</span>
<a href="#l12.690"></a><span id="l12.690" class="difflineplus">+  }    // if we got a url</span>
<a href="#l12.691"></a><span id="l12.691"> </span>
<a href="#l12.692"></a><span id="l12.692">   return rv;</span>
<a href="#l12.693"></a><span id="l12.693"> }</span>
<a href="#l12.694"></a><span id="l12.694"> </span>
<a href="#l12.695"></a><span id="l12.695" class="difflineminus">-NS_IMETHODIMP nsMailboxService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l12.696"></a><span id="l12.696" class="difflineminus">-{</span>
<a href="#l12.697"></a><span id="l12.697" class="difflineplus">+NS_IMETHODIMP nsMailboxService::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l12.698"></a><span id="l12.698">   aScheme = &quot;mailbox&quot;;</span>
<a href="#l12.699"></a><span id="l12.699">   return NS_OK;</span>
<a href="#l12.700"></a><span id="l12.700"> }</span>
<a href="#l12.701"></a><span id="l12.701"> </span>
<a href="#l12.702"></a><span id="l12.702" class="difflineminus">-NS_IMETHODIMP nsMailboxService::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l12.703"></a><span id="l12.703" class="difflineminus">-{</span>
<a href="#l12.704"></a><span id="l12.704" class="difflineplus">+NS_IMETHODIMP nsMailboxService::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l12.705"></a><span id="l12.705">   NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l12.706"></a><span id="l12.706">   *aDefaultPort = -1;  // mailbox doesn't use a port!!!!!</span>
<a href="#l12.707"></a><span id="l12.707">   return NS_OK;</span>
<a href="#l12.708"></a><span id="l12.708"> }</span>
<a href="#l12.709"></a><span id="l12.709"> </span>
<a href="#l12.710"></a><span id="l12.710" class="difflineminus">-NS_IMETHODIMP nsMailboxService::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l12.711"></a><span id="l12.711" class="difflineminus">-{</span>
<a href="#l12.712"></a><span id="l12.712" class="difflineplus">+NS_IMETHODIMP nsMailboxService::AllowPort(int32_t port, const char *scheme,</span>
<a href="#l12.713"></a><span id="l12.713" class="difflineplus">+                                          bool *_retval) {</span>
<a href="#l12.714"></a><span id="l12.714">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.715"></a><span id="l12.715">   // don't override anything.</span>
<a href="#l12.716"></a><span id="l12.716">   *_retval = false;</span>
<a href="#l12.717"></a><span id="l12.717">   return NS_OK;</span>
<a href="#l12.718"></a><span id="l12.718"> }</span>
<a href="#l12.719"></a><span id="l12.719"> </span>
<a href="#l12.720"></a><span id="l12.720" class="difflineminus">-NS_IMETHODIMP nsMailboxService::GetProtocolFlags(uint32_t *result)</span>
<a href="#l12.721"></a><span id="l12.721" class="difflineminus">-{</span>
<a href="#l12.722"></a><span id="l12.722" class="difflineplus">+NS_IMETHODIMP nsMailboxService::GetProtocolFlags(uint32_t *result) {</span>
<a href="#l12.723"></a><span id="l12.723">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l12.724"></a><span id="l12.724">   *result = URI_NORELATIVE | URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT |</span>
<a href="#l12.725"></a><span id="l12.725">             URI_DANGEROUS_TO_LOAD</span>
<a href="#l12.726"></a><span id="l12.726"> #ifdef IS_ORIGIN_IS_FULL_SPEC_DEFINED</span>
<a href="#l12.727"></a><span id="l12.727">             | ORIGIN_IS_FULL_SPEC</span>
<a href="#l12.728"></a><span id="l12.728"> #endif</span>
<a href="#l12.729"></a><span id="l12.729" class="difflineminus">-  ;</span>
<a href="#l12.730"></a><span id="l12.730" class="difflineplus">+      ;</span>
<a href="#l12.731"></a><span id="l12.731">   return NS_OK;</span>
<a href="#l12.732"></a><span id="l12.732"> }</span>
<a href="#l12.733"></a><span id="l12.733"> </span>
<a href="#l12.734"></a><span id="l12.734"> NS_IMETHODIMP nsMailboxService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l12.735"></a><span id="l12.735">                                        const char *aOriginCharset,</span>
<a href="#l12.736"></a><span id="l12.736" class="difflineminus">-                                       nsIURI *aBaseURI,</span>
<a href="#l12.737"></a><span id="l12.737" class="difflineminus">-                                       nsIURI **_retval)</span>
<a href="#l12.738"></a><span id="l12.738" class="difflineminus">-{</span>
<a href="#l12.739"></a><span id="l12.739" class="difflineplus">+                                       nsIURI *aBaseURI, nsIURI **_retval) {</span>
<a href="#l12.740"></a><span id="l12.740">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.741"></a><span id="l12.741">   *_retval = 0;</span>
<a href="#l12.742"></a><span id="l12.742">   nsresult rv;</span>
<a href="#l12.743"></a><span id="l12.743" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; aMsgUri = do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l12.744"></a><span id="l12.744" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; aMsgUri =</span>
<a href="#l12.745"></a><span id="l12.745" class="difflineplus">+      do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l12.746"></a><span id="l12.746">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.747"></a><span id="l12.747" class="difflineminus">-  // SetSpecInternal must not fail, or else the URL won't have a base URL and we'll crash later.</span>
<a href="#l12.748"></a><span id="l12.748" class="difflineminus">-  if (aBaseURI)</span>
<a href="#l12.749"></a><span id="l12.749" class="difflineminus">-  {</span>
<a href="#l12.750"></a><span id="l12.750" class="difflineplus">+  // SetSpecInternal must not fail, or else the URL won't have a base URL and</span>
<a href="#l12.751"></a><span id="l12.751" class="difflineplus">+  // we'll crash later.</span>
<a href="#l12.752"></a><span id="l12.752" class="difflineplus">+  if (aBaseURI) {</span>
<a href="#l12.753"></a><span id="l12.753">     nsAutoCString newSpec;</span>
<a href="#l12.754"></a><span id="l12.754">     rv = aBaseURI-&gt;Resolve(aSpec, newSpec);</span>
<a href="#l12.755"></a><span id="l12.755">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.756"></a><span id="l12.756">     rv = aMsgUri-&gt;SetSpecInternal(newSpec);</span>
<a href="#l12.757"></a><span id="l12.757">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.758"></a><span id="l12.758" class="difflineminus">-  }</span>
<a href="#l12.759"></a><span id="l12.759" class="difflineminus">-  else</span>
<a href="#l12.760"></a><span id="l12.760" class="difflineminus">-  {</span>
<a href="#l12.761"></a><span id="l12.761" class="difflineplus">+  } else {</span>
<a href="#l12.762"></a><span id="l12.762">     rv = aMsgUri-&gt;SetSpecInternal(aSpec);</span>
<a href="#l12.763"></a><span id="l12.763">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.764"></a><span id="l12.764">   }</span>
<a href="#l12.765"></a><span id="l12.765">   aMsgUri.forget(_retval);</span>
<a href="#l12.766"></a><span id="l12.766"> </span>
<a href="#l12.767"></a><span id="l12.767">   return rv;</span>
<a href="#l12.768"></a><span id="l12.768"> }</span>
<a href="#l12.769"></a><span id="l12.769"> </span>
<a href="#l12.770"></a><span id="l12.770" class="difflineminus">-NS_IMETHODIMP nsMailboxService::NewChannel(nsIURI *aURI,</span>
<a href="#l12.771"></a><span id="l12.771" class="difflineminus">-                                           nsILoadInfo *aLoadInfo,</span>
<a href="#l12.772"></a><span id="l12.772" class="difflineminus">-                                           nsIChannel **_retval)</span>
<a href="#l12.773"></a><span id="l12.773" class="difflineminus">-{</span>
<a href="#l12.774"></a><span id="l12.774" class="difflineplus">+NS_IMETHODIMP nsMailboxService::NewChannel(nsIURI *aURI, nsILoadInfo *aLoadInfo,</span>
<a href="#l12.775"></a><span id="l12.775" class="difflineplus">+                                           nsIChannel **_retval) {</span>
<a href="#l12.776"></a><span id="l12.776">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l12.777"></a><span id="l12.777">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.778"></a><span id="l12.778">   nsresult rv = NS_OK;</span>
<a href="#l12.779"></a><span id="l12.779">   nsAutoCString spec;</span>
<a href="#l12.780"></a><span id="l12.780">   rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l12.781"></a><span id="l12.781">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.782"></a><span id="l12.782"> </span>
<a href="#l12.783"></a><span id="l12.783" class="difflineminus">-  if (spec.Find(&quot;?uidl=&quot;) &gt;= 0 || spec.Find(&quot;&amp;uidl=&quot;) &gt;= 0)</span>
<a href="#l12.784"></a><span id="l12.784" class="difflineminus">-  {</span>
<a href="#l12.785"></a><span id="l12.785" class="difflineplus">+  if (spec.Find(&quot;?uidl=&quot;) &gt;= 0 || spec.Find(&quot;&amp;uidl=&quot;) &gt;= 0) {</span>
<a href="#l12.786"></a><span id="l12.786">     nsCOMPtr&lt;nsIProtocolHandler&gt; handler =</span>
<a href="#l12.787"></a><span id="l12.787" class="difflineminus">-             do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv);</span>
<a href="#l12.788"></a><span id="l12.788" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l12.789"></a><span id="l12.789" class="difflineminus">-    {</span>
<a href="#l12.790"></a><span id="l12.790" class="difflineminus">-      nsCOMPtr &lt;nsIURI&gt; pop3Uri;</span>
<a href="#l12.791"></a><span id="l12.791" class="difflineplus">+        do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv);</span>
<a href="#l12.792"></a><span id="l12.792" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l12.793"></a><span id="l12.793" class="difflineplus">+      nsCOMPtr&lt;nsIURI&gt; pop3Uri;</span>
<a href="#l12.794"></a><span id="l12.794"> </span>
<a href="#l12.795"></a><span id="l12.795" class="difflineminus">-      rv = handler-&gt;NewURI(spec, &quot;&quot; /* ignored */, aURI, getter_AddRefs(pop3Uri));</span>
<a href="#l12.796"></a><span id="l12.796" class="difflineplus">+      rv = handler-&gt;NewURI(spec, &quot;&quot; /* ignored */, aURI,</span>
<a href="#l12.797"></a><span id="l12.797" class="difflineplus">+                           getter_AddRefs(pop3Uri));</span>
<a href="#l12.798"></a><span id="l12.798">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.799"></a><span id="l12.799">       return handler-&gt;NewChannel(pop3Uri, aLoadInfo, _retval);</span>
<a href="#l12.800"></a><span id="l12.800">     }</span>
<a href="#l12.801"></a><span id="l12.801">   }</span>
<a href="#l12.802"></a><span id="l12.802"> </span>
<a href="#l12.803"></a><span id="l12.803">   RefPtr&lt;nsMailboxProtocol&gt; protocol = new nsMailboxProtocol(aURI);</span>
<a href="#l12.804"></a><span id="l12.804">   if (!protocol) {</span>
<a href="#l12.805"></a><span id="l12.805">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.806"></a><span id="l12.806" class="difflineat">@@ -610,59 +560,58 @@ NS_IMETHODIMP nsMailboxService::NewChann</span>
<a href="#l12.807"></a><span id="l12.807"> </span>
<a href="#l12.808"></a><span id="l12.808">   rv = protocol-&gt;SetLoadInfo(aLoadInfo);</span>
<a href="#l12.809"></a><span id="l12.809">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.810"></a><span id="l12.810"> </span>
<a href="#l12.811"></a><span id="l12.811">   protocol.forget(_retval);</span>
<a href="#l12.812"></a><span id="l12.812">   return NS_OK;</span>
<a href="#l12.813"></a><span id="l12.813"> }</span>
<a href="#l12.814"></a><span id="l12.814"> </span>
<a href="#l12.815"></a><span id="l12.815" class="difflineminus">-nsresult nsMailboxService::DisplayMessageForPrinting(const char* aMessageURI,</span>
<a href="#l12.816"></a><span id="l12.816" class="difflineminus">-                                                     nsISupports * aDisplayConsumer,</span>
<a href="#l12.817"></a><span id="l12.817" class="difflineminus">-                                                     nsIMsgWindow * aMsgWindow,</span>
<a href="#l12.818"></a><span id="l12.818" class="difflineminus">-                                                     nsIUrlListener * aUrlListener,</span>
<a href="#l12.819"></a><span id="l12.819" class="difflineminus">-                                                     nsIURI ** aURL)</span>
<a href="#l12.820"></a><span id="l12.820" class="difflineminus">-{</span>
<a href="#l12.821"></a><span id="l12.821" class="difflineplus">+nsresult nsMailboxService::DisplayMessageForPrinting(</span>
<a href="#l12.822"></a><span id="l12.822" class="difflineplus">+    const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l12.823"></a><span id="l12.823" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l12.824"></a><span id="l12.824">   mPrintingOperation = true;</span>
<a href="#l12.825"></a><span id="l12.825" class="difflineminus">-  nsresult rv = FetchMessage(aMessageURI, aDisplayConsumer, aMsgWindow,aUrlListener, nullptr,</span>
<a href="#l12.826"></a><span id="l12.826" class="difflineminus">-    nsIMailboxUrl::ActionFetchMessage, nullptr, aURL);</span>
<a href="#l12.827"></a><span id="l12.827" class="difflineplus">+  nsresult rv =</span>
<a href="#l12.828"></a><span id="l12.828" class="difflineplus">+      FetchMessage(aMessageURI, aDisplayConsumer, aMsgWindow, aUrlListener,</span>
<a href="#l12.829"></a><span id="l12.829" class="difflineplus">+                   nullptr, nsIMailboxUrl::ActionFetchMessage, nullptr, aURL);</span>
<a href="#l12.830"></a><span id="l12.830">   mPrintingOperation = false;</span>
<a href="#l12.831"></a><span id="l12.831">   return rv;</span>
<a href="#l12.832"></a><span id="l12.832"> }</span>
<a href="#l12.833"></a><span id="l12.833"> </span>
<a href="#l12.834"></a><span id="l12.834" class="difflineminus">-NS_IMETHODIMP nsMailboxService::Search(nsIMsgSearchSession *aSearchSession, nsIMsgWindow *aMsgWindow, nsIMsgFolder *aMsgFolder, const char *aMessageUri)</span>
<a href="#l12.835"></a><span id="l12.835" class="difflineminus">-{</span>
<a href="#l12.836"></a><span id="l12.836" class="difflineplus">+NS_IMETHODIMP nsMailboxService::Search(nsIMsgSearchSession *aSearchSession,</span>
<a href="#l12.837"></a><span id="l12.837" class="difflineplus">+                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l12.838"></a><span id="l12.838" class="difflineplus">+                                       nsIMsgFolder *aMsgFolder,</span>
<a href="#l12.839"></a><span id="l12.839" class="difflineplus">+                                       const char *aMessageUri) {</span>
<a href="#l12.840"></a><span id="l12.840">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l12.841"></a><span id="l12.841"> }</span>
<a href="#l12.842"></a><span id="l12.842"> </span>
<a href="#l12.843"></a><span id="l12.843" class="difflineminus">-nsresult</span>
<a href="#l12.844"></a><span id="l12.844" class="difflineminus">-nsMailboxService::DecomposeMailboxURI(const char * aMessageURI, nsIMsgFolder ** aFolder, nsMsgKey *aMsgKey)</span>
<a href="#l12.845"></a><span id="l12.845" class="difflineminus">-{</span>
<a href="#l12.846"></a><span id="l12.846" class="difflineplus">+nsresult nsMailboxService::DecomposeMailboxURI(const char *aMessageURI,</span>
<a href="#l12.847"></a><span id="l12.847" class="difflineplus">+                                               nsIMsgFolder **aFolder,</span>
<a href="#l12.848"></a><span id="l12.848" class="difflineplus">+                                               nsMsgKey *aMsgKey) {</span>
<a href="#l12.849"></a><span id="l12.849">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l12.850"></a><span id="l12.850">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l12.851"></a><span id="l12.851">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l12.852"></a><span id="l12.852"> </span>
<a href="#l12.853"></a><span id="l12.853">   nsresult rv = NS_OK;</span>
<a href="#l12.854"></a><span id="l12.854">   nsAutoCString folderURI;</span>
<a href="#l12.855"></a><span id="l12.855">   rv = nsParseLocalMessageURI(aMessageURI, folderURI, aMsgKey);</span>
<a href="#l12.856"></a><span id="l12.856" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.857"></a><span id="l12.857" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.858"></a><span id="l12.858"> </span>
<a href="#l12.859"></a><span id="l12.859">   return GetOrCreateFolder(folderURI, aFolder);</span>
<a href="#l12.860"></a><span id="l12.860"> }</span>
<a href="#l12.861"></a><span id="l12.861"> </span>
<a href="#l12.862"></a><span id="l12.862"> NS_IMETHODIMP</span>
<a href="#l12.863"></a><span id="l12.863" class="difflineminus">-nsMailboxService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **_retval)</span>
<a href="#l12.864"></a><span id="l12.864" class="difflineminus">-{</span>
<a href="#l12.865"></a><span id="l12.865" class="difflineplus">+nsMailboxService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **_retval) {</span>
<a href="#l12.866"></a><span id="l12.866">   NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l12.867"></a><span id="l12.867">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l12.868"></a><span id="l12.868"> </span>
<a href="#l12.869"></a><span id="l12.869">   nsresult rv = NS_OK;</span>
<a href="#l12.870"></a><span id="l12.870"> </span>
<a href="#l12.871"></a><span id="l12.871">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l12.872"></a><span id="l12.872">   nsMsgKey msgKey;</span>
<a href="#l12.873"></a><span id="l12.873"> </span>
<a href="#l12.874"></a><span id="l12.874">   rv = DecomposeMailboxURI(uri, getter_AddRefs(folder), &amp;msgKey);</span>
<a href="#l12.875"></a><span id="l12.875" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.876"></a><span id="l12.876" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.877"></a><span id="l12.877"> </span>
<a href="#l12.878"></a><span id="l12.878">   rv = folder-&gt;GetMessageHeader(msgKey, _retval);</span>
<a href="#l12.879"></a><span id="l12.879" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.880"></a><span id="l12.880" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.881"></a><span id="l12.881">   return NS_OK;</span>
<a href="#l12.882"></a><span id="l12.882"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -13,44 +13,47 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIURI.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-class nsMailboxService : public nsIMailboxService, public nsIMsgMessageService, public nsIMsgMessageFetchPartService, public nsIProtocolHandler</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-public:</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+class nsMailboxService : public nsIMailboxService,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+                         public nsIMsgMessageService,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+                         public nsIMsgMessageFetchPartService,</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+                         public nsIProtocolHandler {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ public:</span>
<a href="#l13.21"></a><span id="l13.21">   nsMailboxService();</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   NS_DECL_ISUPPORTS</span>
<a href="#l13.24"></a><span id="l13.24">   NS_DECL_NSIMAILBOXSERVICE</span>
<a href="#l13.25"></a><span id="l13.25">   NS_DECL_NSIMSGMESSAGESERVICE</span>
<a href="#l13.26"></a><span id="l13.26">   NS_DECL_NSIMSGMESSAGEFETCHPARTSERVICE</span>
<a href="#l13.27"></a><span id="l13.27">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-protected:</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ protected:</span>
<a href="#l13.31"></a><span id="l13.31">   virtual ~nsMailboxService();</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  bool          mPrintingOperation;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  bool mPrintingOperation;</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35">   // helper functions used by the service</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  nsresult PrepareMessageUrl(const char * aSrcMsgMailboxURI, nsIUrlListener * aUrlListener,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-                 nsMailboxAction aMailboxAction, nsIMailboxUrl ** aMailboxUrl,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-                 nsIMsgWindow *msgWindow);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  nsresult PrepareMessageUrl(const char *aSrcMsgMailboxURI,</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+                             nsIUrlListener *aUrlListener,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+                             nsMailboxAction aMailboxAction,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+                             nsIMailboxUrl **aMailboxUrl,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+                             nsIMsgWindow *msgWindow);</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  nsresult RunMailboxUrl(nsIURI * aMailboxUrl, nsISupports * aDisplayConsumer = nullptr);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  nsresult RunMailboxUrl(nsIURI *aMailboxUrl,</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+                         nsISupports *aDisplayConsumer = nullptr);</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  nsresult FetchMessage(const char* aMessageURI,</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-                        nsISupports * aDisplayConsumer,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-                        nsIMsgWindow * aMsgWindow,</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-                        nsIUrlListener * aUrlListener,</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-                        const char * aFileName, /* only used by open attachment */</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-                        nsMailboxAction mailboxAction,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-                        const char * aCharsetOverride,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-                        nsIURI ** aURL);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+  nsresult FetchMessage(</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+      const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+      nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      const char *aFileName, /* only used by open attachment */</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      nsMailboxAction mailboxAction, const char *aCharsetOverride,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      nsIURI **aURL);</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-  nsresult DecomposeMailboxURI(const char * aMessageURI, nsIMsgFolder ** aFolder, nsMsgKey *aMsgKey);</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+  nsresult DecomposeMailboxURI(const char *aMessageURI, nsIMsgFolder **aFolder,</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+                               nsMsgKey *aMsgKey);</span>
<a href="#l13.67"></a><span id="l13.67"> };</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69"> #endif /* nsMailboxService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l14.5"></a><span id="l14.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12"> #include &quot;nsIURI.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsMailboxUrl.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsString.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsLocalUtils.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineat">@@ -29,561 +29,512 @@</span>
<a href="#l14.20"></a><span id="l14.20"> // then grab it and use it on the other side</span>
<a href="#l14.21"></a><span id="l14.21"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l14.22"></a><span id="l14.22"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l14.23"></a><span id="l14.23"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l14.24"></a><span id="l14.24"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l14.25"></a><span id="l14.25"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27"> // helper function for parsing the search field of a url</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-char * extractAttributeValue(const char * searchString, const char * attributeName);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+char *extractAttributeValue(const char *searchString,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+                            const char *attributeName);</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-nsMailboxUrl::nsMailboxUrl()</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-{</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+nsMailboxUrl::nsMailboxUrl() {</span>
<a href="#l14.35"></a><span id="l14.35">   m_mailboxAction = nsIMailboxUrl::ActionParseMailbox;</span>
<a href="#l14.36"></a><span id="l14.36">   m_filePath = nullptr;</span>
<a href="#l14.37"></a><span id="l14.37">   m_messageID = nullptr;</span>
<a href="#l14.38"></a><span id="l14.38">   m_messageKey = nsMsgKey_None;</span>
<a href="#l14.39"></a><span id="l14.39">   m_messageSize = 0;</span>
<a href="#l14.40"></a><span id="l14.40">   m_messageFile = nullptr;</span>
<a href="#l14.41"></a><span id="l14.41">   m_addDummyEnvelope = false;</span>
<a href="#l14.42"></a><span id="l14.42">   m_canonicalLineEnding = false;</span>
<a href="#l14.43"></a><span id="l14.43">   m_curMsgIndex = 0;</span>
<a href="#l14.44"></a><span id="l14.44"> }</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-nsMailboxUrl::~nsMailboxUrl()</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-{</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-    PR_Free(m_messageID);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-}</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+nsMailboxUrl::~nsMailboxUrl() { PR_Free(m_messageID); }</span>
<a href="#l14.51"></a><span id="l14.51"> </span>
<a href="#l14.52"></a><span id="l14.52"> NS_IMPL_ADDREF_INHERITED(nsMailboxUrl, nsMsgMailNewsUrl)</span>
<a href="#l14.53"></a><span id="l14.53"> NS_IMPL_RELEASE_INHERITED(nsMailboxUrl, nsMsgMailNewsUrl)</span>
<a href="#l14.54"></a><span id="l14.54"> </span>
<a href="#l14.55"></a><span id="l14.55"> NS_INTERFACE_MAP_BEGIN(nsMailboxUrl)</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMailboxUrl)</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMailboxUrl)</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMsgMessageUrl)</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMsgI18NUrl)</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMailboxUrl)</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMailboxUrl)</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMsgMessageUrl)</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMsgI18NUrl)</span>
<a href="#l14.64"></a><span id="l14.64"> NS_INTERFACE_MAP_END_INHERITING(nsMsgMailNewsUrl)</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.67"></a><span id="l14.67"> // Begin nsIMailboxUrl specific support</span>
<a href="#l14.68"></a><span id="l14.68"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-nsresult nsMailboxUrl::SetMailboxParser(nsIStreamListener * aMailboxParser)</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-{</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-  if (aMailboxParser)</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-    m_mailboxParser = aMailboxParser;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+nsresult nsMailboxUrl::SetMailboxParser(nsIStreamListener *aMailboxParser) {</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  if (aMailboxParser) m_mailboxParser = aMailboxParser;</span>
<a href="#l14.75"></a><span id="l14.75">   return NS_OK;</span>
<a href="#l14.76"></a><span id="l14.76"> }</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-nsresult nsMailboxUrl::GetMailboxParser(nsIStreamListener ** aConsumer)</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-{</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+nsresult nsMailboxUrl::GetMailboxParser(nsIStreamListener **aConsumer) {</span>
<a href="#l14.81"></a><span id="l14.81">   NS_ENSURE_ARG_POINTER(aConsumer);</span>
<a href="#l14.82"></a><span id="l14.82"> </span>
<a href="#l14.83"></a><span id="l14.83">   NS_IF_ADDREF(*aConsumer = m_mailboxParser);</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-  return  NS_OK;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.86"></a><span id="l14.86"> }</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-nsresult nsMailboxUrl::SetMailboxCopyHandler(nsIStreamListener * aMailboxCopyHandler)</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-{</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineminus">-  if (aMailboxCopyHandler)</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineminus">-    m_mailboxCopyHandler = aMailboxCopyHandler;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+nsresult nsMailboxUrl::SetMailboxCopyHandler(</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+    nsIStreamListener *aMailboxCopyHandler) {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+  if (aMailboxCopyHandler) m_mailboxCopyHandler = aMailboxCopyHandler;</span>
<a href="#l14.95"></a><span id="l14.95">   return NS_OK;</span>
<a href="#l14.96"></a><span id="l14.96"> }</span>
<a href="#l14.97"></a><span id="l14.97"> </span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-nsresult nsMailboxUrl::GetMailboxCopyHandler(nsIStreamListener ** aMailboxCopyHandler)</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineminus">-{</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+nsresult nsMailboxUrl::GetMailboxCopyHandler(</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+    nsIStreamListener **aMailboxCopyHandler) {</span>
<a href="#l14.102"></a><span id="l14.102">   NS_ENSURE_ARG_POINTER(aMailboxCopyHandler);</span>
<a href="#l14.103"></a><span id="l14.103"> </span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  if (aMailboxCopyHandler)</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-  {</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  if (aMailboxCopyHandler) {</span>
<a href="#l14.107"></a><span id="l14.107">     NS_IF_ADDREF(*aMailboxCopyHandler = m_mailboxCopyHandler);</span>
<a href="#l14.108"></a><span id="l14.108">   }</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-  return  NS_OK;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.112"></a><span id="l14.112"> }</span>
<a href="#l14.113"></a><span id="l14.113"> </span>
<a href="#l14.114"></a><span id="l14.114" class="difflineminus">-nsresult nsMailboxUrl::GetMessageKey(nsMsgKey* aMessageKey)</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-{</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+nsresult nsMailboxUrl::GetMessageKey(nsMsgKey *aMessageKey) {</span>
<a href="#l14.117"></a><span id="l14.117">   *aMessageKey = m_messageKey;</span>
<a href="#l14.118"></a><span id="l14.118">   return NS_OK;</span>
<a href="#l14.119"></a><span id="l14.119"> }</span>
<a href="#l14.120"></a><span id="l14.120"> </span>
<a href="#l14.121"></a><span id="l14.121" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetMessageSize(uint32_t * aMessageSize)</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineminus">-{</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineminus">-  if (aMessageSize)</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  {</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetMessageSize(uint32_t *aMessageSize) {</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+  if (aMessageSize) {</span>
<a href="#l14.127"></a><span id="l14.127">     *aMessageSize = m_messageSize;</span>
<a href="#l14.128"></a><span id="l14.128">     return NS_OK;</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-  }</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineminus">-  else</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+  } else</span>
<a href="#l14.132"></a><span id="l14.132">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l14.133"></a><span id="l14.133"> }</span>
<a href="#l14.134"></a><span id="l14.134"> </span>
<a href="#l14.135"></a><span id="l14.135" class="difflineminus">-nsresult nsMailboxUrl::SetMessageSize(uint32_t aMessageSize)</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineminus">-{</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+nsresult nsMailboxUrl::SetMessageSize(uint32_t aMessageSize) {</span>
<a href="#l14.138"></a><span id="l14.138">   m_messageSize = aMessageSize;</span>
<a href="#l14.139"></a><span id="l14.139">   return NS_OK;</span>
<a href="#l14.140"></a><span id="l14.140"> }</span>
<a href="#l14.141"></a><span id="l14.141"> </span>
<a href="#l14.142"></a><span id="l14.142" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetNormalizedSpec(nsACString&amp; aPrincipalSpec)</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-{</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetNormalizedSpec(nsACString &amp;aPrincipalSpec) {</span>
<a href="#l14.145"></a><span id="l14.145">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsURL;</span>
<a href="#l14.146"></a><span id="l14.146">   QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(mailnewsURL));</span>
<a href="#l14.147"></a><span id="l14.147"> </span>
<a href="#l14.148"></a><span id="l14.148">   nsAutoCString spec;</span>
<a href="#l14.149"></a><span id="l14.149">   mailnewsURL-&gt;GetSpecIgnoringRef(spec);</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151">   // mailbox: URLs contain a lot of query parts. We want need a normalized form:</span>
<a href="#l14.152"></a><span id="l14.152">   // mailbox:///path/to/folder?number=nn.</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-  // We also need to translate the second form mailbox://user@domain@server/folder?number=nn.</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+  // We also need to translate the second form</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+  // mailbox://user@domain@server/folder?number=nn.</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-  char* messageKey = extractAttributeValue(spec.get(), &quot;number=&quot;);</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+  char *messageKey = extractAttributeValue(spec.get(), &quot;number=&quot;);</span>
<a href="#l14.159"></a><span id="l14.159"> </span>
<a href="#l14.160"></a><span id="l14.160">   // Strip any query part beginning with ? or /;</span>
<a href="#l14.161"></a><span id="l14.161">   int32_t ind = spec.Find(&quot;/;&quot;);</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineminus">-  if (ind != kNotFound)</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-    spec.SetLength(ind);</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+  if (ind != kNotFound) spec.SetLength(ind);</span>
<a href="#l14.165"></a><span id="l14.165"> </span>
<a href="#l14.166"></a><span id="l14.166">   ind = spec.FindChar('?');</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineminus">-  if (ind != kNotFound)</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineminus">-    spec.SetLength(ind);</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+  if (ind != kNotFound) spec.SetLength(ind);</span>
<a href="#l14.170"></a><span id="l14.170"> </span>
<a href="#l14.171"></a><span id="l14.171">   // Check for format lacking absolute path.</span>
<a href="#l14.172"></a><span id="l14.172">   if (spec.Find(&quot;///&quot;) == kNotFound) {</span>
<a href="#l14.173"></a><span id="l14.173">     nsCString folderPath;</span>
<a href="#l14.174"></a><span id="l14.174">     nsresult rv = nsLocalURI2Path(kMailboxRootURI, spec.get(), folderPath);</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-    if (NS_SUCCEEDED (rv)) {</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l14.177"></a><span id="l14.177">       nsAutoCString buf;</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineminus">-      MsgEscapeURL(folderPath,</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineminus">-                   nsINetUtil::ESCAPE_URL_DIRECTORY | nsINetUtil::ESCAPE_URL_FORCED, buf);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+      MsgEscapeURL(</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+          folderPath,</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+          nsINetUtil::ESCAPE_URL_DIRECTORY | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+          buf);</span>
<a href="#l14.184"></a><span id="l14.184">       spec = NS_LITERAL_CSTRING(&quot;mailbox://&quot;) + buf;</span>
<a href="#l14.185"></a><span id="l14.185">     }</span>
<a href="#l14.186"></a><span id="l14.186">   }</span>
<a href="#l14.187"></a><span id="l14.187"> </span>
<a href="#l14.188"></a><span id="l14.188">   if (messageKey) {</span>
<a href="#l14.189"></a><span id="l14.189">     spec += NS_LITERAL_CSTRING(&quot;?number=&quot;);</span>
<a href="#l14.190"></a><span id="l14.190">     spec.Append(messageKey);</span>
<a href="#l14.191"></a><span id="l14.191">     PR_Free(messageKey);</span>
<a href="#l14.192"></a><span id="l14.192">   }</span>
<a href="#l14.193"></a><span id="l14.193"> </span>
<a href="#l14.194"></a><span id="l14.194">   aPrincipalSpec.Assign(spec);</span>
<a href="#l14.195"></a><span id="l14.195">   return NS_OK;</span>
<a href="#l14.196"></a><span id="l14.196"> }</span>
<a href="#l14.197"></a><span id="l14.197"> </span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-nsresult nsMailboxUrl::CreateURL(const nsACString&amp; aSpec, nsIURL **aURL)</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-{</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+nsresult nsMailboxUrl::CreateURL(const nsACString &amp;aSpec, nsIURL **aURL) {</span>
<a href="#l14.201"></a><span id="l14.201">   nsresult rv;</span>
<a href="#l14.202"></a><span id="l14.202">   nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l14.203"></a><span id="l14.203">   // Check whether the URL is of the form</span>
<a href="#l14.204"></a><span id="l14.204">   // mailbox://user@domain@server/folder?number=nn and contains a hostname.</span>
<a href="#l14.205"></a><span id="l14.205">   // Check for format lacking absolute path.</span>
<a href="#l14.206"></a><span id="l14.206">   if (PromiseFlatCString(aSpec).Find(&quot;///&quot;) == kNotFound) {</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineminus">-    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(aSpec).Finalize(url);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+             .SetSpec(aSpec)</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+             .Finalize(url);</span>
<a href="#l14.211"></a><span id="l14.211">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.212"></a><span id="l14.212">   } else {</span>
<a href="#l14.213"></a><span id="l14.213">     // The URL is more like a file URL without a hostname.</span>
<a href="#l14.214"></a><span id="l14.214">     rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-      .Apply(NS_MutatorMethod(&amp;nsIStandardURLMutator::Init,</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-                              nsIStandardURL::URLTYPE_NO_AUTHORITY, -1,</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-                              PromiseFlatCString(aSpec),</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-                              nullptr, nullptr, nullptr))</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-      .Finalize(url);</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+             .Apply(NS_MutatorMethod(&amp;nsIStandardURLMutator::Init,</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+                                     nsIStandardURL::URLTYPE_NO_AUTHORITY, -1,</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+                                     PromiseFlatCString(aSpec), nullptr,</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+                                     nullptr, nullptr))</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+             .Finalize(url);</span>
<a href="#l14.225"></a><span id="l14.225">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.226"></a><span id="l14.226">   }</span>
<a href="#l14.227"></a><span id="l14.227">   url.forget(aURL);</span>
<a href="#l14.228"></a><span id="l14.228">   return NS_OK;</span>
<a href="#l14.229"></a><span id="l14.229"> }</span>
<a href="#l14.230"></a><span id="l14.230"> </span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::SetUri(const char * aURI)</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-{</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-  mURI= aURI;</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::SetUri(const char *aURI) {</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+  mURI = aURI;</span>
<a href="#l14.236"></a><span id="l14.236">   return NS_OK;</span>
<a href="#l14.237"></a><span id="l14.237"> }</span>
<a href="#l14.238"></a><span id="l14.238"> </span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-nsresult nsMailboxUrl::Clone(nsIURI **_retval)</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-{</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+nsresult nsMailboxUrl::Clone(nsIURI **_retval) {</span>
<a href="#l14.242"></a><span id="l14.242">   nsresult rv = nsMsgMailNewsUrl::Clone(_retval);</span>
<a href="#l14.243"></a><span id="l14.243">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.244"></a><span id="l14.244">   // also clone the mURI member, because GetUri below won't work if</span>
<a href="#l14.245"></a><span id="l14.245">   // mURI isn't set due to nsIFile fun.</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageUrl&gt; clonedUrl = do_QueryInterface(*_retval);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-  if (clonedUrl)</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-    clonedUrl-&gt;SetUri(mURI.get());</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; clonedUrl = do_QueryInterface(*_retval);</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+  if (clonedUrl) clonedUrl-&gt;SetUri(mURI.get());</span>
<a href="#l14.251"></a><span id="l14.251">   return rv;</span>
<a href="#l14.252"></a><span id="l14.252"> }</span>
<a href="#l14.253"></a><span id="l14.253"> </span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetUri(char ** aURI)</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-{</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetUri(char **aURI) {</span>
<a href="#l14.257"></a><span id="l14.257">   // if we have been given a uri to associate with this url, then use it</span>
<a href="#l14.258"></a><span id="l14.258">   // otherwise try to reconstruct a URI on the fly....</span>
<a href="#l14.259"></a><span id="l14.259"> </span>
<a href="#l14.260"></a><span id="l14.260">   if (!mURI.IsEmpty())</span>
<a href="#l14.261"></a><span id="l14.261">     *aURI = ToNewCString(mURI);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-  else</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-  {</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-    if (m_filePath)</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-    {</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+  else {</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+    if (m_filePath) {</span>
<a href="#l14.268"></a><span id="l14.268">       nsAutoCString baseUri;</span>
<a href="#l14.269"></a><span id="l14.269">       nsresult rv;</span>
<a href="#l14.270"></a><span id="l14.270">       nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineminus">-        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l14.273"></a><span id="l14.273">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.274"></a><span id="l14.274"> </span>
<a href="#l14.275"></a><span id="l14.275">       // we blow off errors here so that we can open attachments</span>
<a href="#l14.276"></a><span id="l14.276">       // in .eml files.</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineminus">-      (void) accountManager-&gt;FolderUriForPath(m_filePath, baseUri);</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+      (void)accountManager-&gt;FolderUriForPath(m_filePath, baseUri);</span>
<a href="#l14.279"></a><span id="l14.279">       if (baseUri.IsEmpty()) {</span>
<a href="#l14.280"></a><span id="l14.280">         rv = m_baseURL-&gt;GetSpec(baseUri);</span>
<a href="#l14.281"></a><span id="l14.281">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.282"></a><span id="l14.282">       }</span>
<a href="#l14.283"></a><span id="l14.283">       nsCString baseMessageURI;</span>
<a href="#l14.284"></a><span id="l14.284">       nsCreateLocalBaseMessageURI(baseUri, baseMessageURI);</span>
<a href="#l14.285"></a><span id="l14.285">       nsAutoCString uriStr;</span>
<a href="#l14.286"></a><span id="l14.286">       nsBuildLocalMessageURI(baseMessageURI.get(), m_messageKey, uriStr);</span>
<a href="#l14.287"></a><span id="l14.287">       *aURI = ToNewCString(uriStr);</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineminus">-    }</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineminus">-    else</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+    } else</span>
<a href="#l14.291"></a><span id="l14.291">       *aURI = nullptr;</span>
<a href="#l14.292"></a><span id="l14.292">   }</span>
<a href="#l14.293"></a><span id="l14.293"> </span>
<a href="#l14.294"></a><span id="l14.294">   return NS_OK;</span>
<a href="#l14.295"></a><span id="l14.295"> }</span>
<a href="#l14.296"></a><span id="l14.296"> </span>
<a href="#l14.297"></a><span id="l14.297" class="difflineminus">-nsresult nsMailboxUrl::GetMsgHdrForKey(nsMsgKey  msgKey, nsIMsgDBHdr ** aMsgHdr)</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineminus">-{</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+nsresult nsMailboxUrl::GetMsgHdrForKey(nsMsgKey msgKey, nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l14.300"></a><span id="l14.300">   nsresult rv = NS_OK;</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineminus">-  if (aMsgHdr &amp;&amp; m_filePath)</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-  {</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+  if (aMsgHdr &amp;&amp; m_filePath) {</span>
<a href="#l14.304"></a><span id="l14.304">     nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l14.305"></a><span id="l14.305">     nsCOMPtr&lt;nsIMsgDatabase&gt; mailDB;</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l14.309"></a><span id="l14.309"> </span>
<a href="#l14.310"></a><span id="l14.310">     if (msgDBService)</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineminus">-      rv = msgDBService-&gt;OpenMailDBFromFile(m_filePath, nullptr, false,</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-                                            false, getter_AddRefs(mailDB));</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; mailDB) // did we get a db back?</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+      rv = msgDBService-&gt;OpenMailDBFromFile(m_filePath, nullptr, false, false,</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+                                            getter_AddRefs(mailDB));</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mailDB)  // did we get a db back?</span>
<a href="#l14.317"></a><span id="l14.317">       rv = mailDB-&gt;GetMsgHdrForKey(msgKey, aMsgHdr);</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineminus">-    else</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineminus">-    {</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+    else {</span>
<a href="#l14.321"></a><span id="l14.321">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineminus">-      if (!msgWindow)</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineminus">-      {</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+      if (!msgWindow) {</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+            do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l14.328"></a><span id="l14.328">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.329"></a><span id="l14.329">         mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l14.330"></a><span id="l14.330">       }</span>
<a href="#l14.331"></a><span id="l14.331"> </span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-      // maybe this is .eml file we're trying to read. See if we can get a header from the header sink.</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-      if (msgWindow)</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineminus">-      {</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+      // maybe this is .eml file we're trying to read. See if we can get a</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+      // header from the header sink.</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+      if (msgWindow) {</span>
<a href="#l14.338"></a><span id="l14.338">         nsCOMPtr&lt;nsIMsgHeaderSink&gt; headerSink;</span>
<a href="#l14.339"></a><span id="l14.339">         msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(headerSink));</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineminus">-        if (headerSink)</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineminus">-        {</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+        if (headerSink) {</span>
<a href="#l14.343"></a><span id="l14.343">           rv = headerSink-&gt;GetDummyMsgHeader(aMsgHdr);</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineminus">-          {</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l14.347"></a><span id="l14.347">             int64_t fileSize = 0;</span>
<a href="#l14.348"></a><span id="l14.348">             m_filePath-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l14.349"></a><span id="l14.349">             (*aMsgHdr)-&gt;SetMessageSize(fileSize);</span>
<a href="#l14.350"></a><span id="l14.350">           }</span>
<a href="#l14.351"></a><span id="l14.351">         }</span>
<a href="#l14.352"></a><span id="l14.352">       }</span>
<a href="#l14.353"></a><span id="l14.353">     }</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineminus">-  }</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineminus">-  else</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+  } else</span>
<a href="#l14.357"></a><span id="l14.357">     rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l14.358"></a><span id="l14.358"> </span>
<a href="#l14.359"></a><span id="l14.359">   return rv;</span>
<a href="#l14.360"></a><span id="l14.360"> }</span>
<a href="#l14.361"></a><span id="l14.361"> </span>
<a href="#l14.362"></a><span id="l14.362" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetMessageHeader(nsIMsgDBHdr ** aMsgHdr)</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineminus">-{</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineminus">-  if (m_dummyHdr)</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineminus">-  {</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetMessageHeader(nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+  if (m_dummyHdr) {</span>
<a href="#l14.368"></a><span id="l14.368">     NS_IF_ADDREF(*aMsgHdr = m_dummyHdr);</span>
<a href="#l14.369"></a><span id="l14.369">     return NS_OK;</span>
<a href="#l14.370"></a><span id="l14.370">   }</span>
<a href="#l14.371"></a><span id="l14.371">   return GetMsgHdrForKey(m_messageKey, aMsgHdr);</span>
<a href="#l14.372"></a><span id="l14.372"> }</span>
<a href="#l14.373"></a><span id="l14.373"> </span>
<a href="#l14.374"></a><span id="l14.374" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::SetMessageHeader(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineminus">-{</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::SetMessageHeader(nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l14.377"></a><span id="l14.377">   m_dummyHdr = aMsgHdr;</span>
<a href="#l14.378"></a><span id="l14.378">   return NS_OK;</span>
<a href="#l14.379"></a><span id="l14.379"> }</span>
<a href="#l14.380"></a><span id="l14.380"> </span>
<a href="#l14.381"></a><span id="l14.381"> NS_IMPL_GETSET(nsMailboxUrl, AddDummyEnvelope, bool, m_addDummyEnvelope)</span>
<a href="#l14.382"></a><span id="l14.382"> NS_IMPL_GETSET(nsMailboxUrl, CanonicalLineEnding, bool, m_canonicalLineEnding)</span>
<a href="#l14.383"></a><span id="l14.383"> </span>
<a href="#l14.384"></a><span id="l14.384"> NS_IMETHODIMP</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineminus">-nsMailboxUrl::GetOriginalSpec(char **aSpec)</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineminus">-{</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineminus">-  if (!aSpec || m_originalSpec.IsEmpty())</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+nsMailboxUrl::GetOriginalSpec(char **aSpec) {</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+  if (!aSpec || m_originalSpec.IsEmpty()) return NS_ERROR_NULL_POINTER;</span>
<a href="#l14.391"></a><span id="l14.391">   *aSpec = ToNewCString(m_originalSpec);</span>
<a href="#l14.392"></a><span id="l14.392">   return NS_OK;</span>
<a href="#l14.393"></a><span id="l14.393"> }</span>
<a href="#l14.394"></a><span id="l14.394"> </span>
<a href="#l14.395"></a><span id="l14.395"> NS_IMETHODIMP</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-nsMailboxUrl::SetOriginalSpec(const char *aSpec)</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-{</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineplus">+nsMailboxUrl::SetOriginalSpec(const char *aSpec) {</span>
<a href="#l14.399"></a><span id="l14.399">   m_originalSpec = aSpec;</span>
<a href="#l14.400"></a><span id="l14.400">   return NS_OK;</span>
<a href="#l14.401"></a><span id="l14.401"> }</span>
<a href="#l14.402"></a><span id="l14.402"> </span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::SetMessageFile(nsIFile * aFile)</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineminus">-{</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::SetMessageFile(nsIFile *aFile) {</span>
<a href="#l14.406"></a><span id="l14.406">   m_messageFile = aFile;</span>
<a href="#l14.407"></a><span id="l14.407">   return NS_OK;</span>
<a href="#l14.408"></a><span id="l14.408"> }</span>
<a href="#l14.409"></a><span id="l14.409"> </span>
<a href="#l14.410"></a><span id="l14.410" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetMessageFile(nsIFile ** aFile)</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineminus">-{</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetMessageFile(nsIFile **aFile) {</span>
<a href="#l14.413"></a><span id="l14.413">   // why don't we return an error for null aFile?</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineminus">-  if (aFile)</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineminus">-    NS_IF_ADDREF(*aFile = m_messageFile);</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+  if (aFile) NS_IF_ADDREF(*aFile = m_messageFile);</span>
<a href="#l14.417"></a><span id="l14.417">   return NS_OK;</span>
<a href="#l14.418"></a><span id="l14.418"> }</span>
<a href="#l14.419"></a><span id="l14.419"> </span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::IsUrlType(uint32_t type, bool *isType)</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineminus">-{</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::IsUrlType(uint32_t type, bool *isType) {</span>
<a href="#l14.423"></a><span id="l14.423">   NS_ENSURE_ARG(isType);</span>
<a href="#l14.424"></a><span id="l14.424"> </span>
<a href="#l14.425"></a><span id="l14.425" class="difflineminus">-  switch(type)</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineminus">-  {</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+  switch (type) {</span>
<a href="#l14.428"></a><span id="l14.428">     case nsIMsgMailNewsUrl::eCopy:</span>
<a href="#l14.429"></a><span id="l14.429">       *isType = (m_mailboxAction == nsIMailboxUrl::ActionCopyMessage);</span>
<a href="#l14.430"></a><span id="l14.430">       break;</span>
<a href="#l14.431"></a><span id="l14.431">     case nsIMsgMailNewsUrl::eMove:</span>
<a href="#l14.432"></a><span id="l14.432">       *isType = (m_mailboxAction == nsIMailboxUrl::ActionMoveMessage);</span>
<a href="#l14.433"></a><span id="l14.433">       break;</span>
<a href="#l14.434"></a><span id="l14.434">     case nsIMsgMailNewsUrl::eDisplay:</span>
<a href="#l14.435"></a><span id="l14.435">       *isType = (m_mailboxAction == nsIMailboxUrl::ActionFetchMessage ||</span>
<a href="#l14.436"></a><span id="l14.436">                  m_mailboxAction == nsIMailboxUrl::ActionFetchPart);</span>
<a href="#l14.437"></a><span id="l14.437">       break;</span>
<a href="#l14.438"></a><span id="l14.438">     default:</span>
<a href="#l14.439"></a><span id="l14.439">       *isType = false;</span>
<a href="#l14.440"></a><span id="l14.440">   };</span>
<a href="#l14.441"></a><span id="l14.441"> </span>
<a href="#l14.442"></a><span id="l14.442">   return NS_OK;</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineminus">-</span>
<a href="#l14.444"></a><span id="l14.444"> }</span>
<a href="#l14.445"></a><span id="l14.445"> </span>
<a href="#l14.446"></a><span id="l14.446"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.447"></a><span id="l14.447"> // End nsIMailboxUrl specific support</span>
<a href="#l14.448"></a><span id="l14.448"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.449"></a><span id="l14.449"> </span>
<a href="#l14.450"></a><span id="l14.450"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l14.451"></a><span id="l14.451"> // possible search part phrases include: MessageID=id&amp;number=MessageKey</span>
<a href="#l14.452"></a><span id="l14.452"> </span>
<a href="#l14.453"></a><span id="l14.453" class="difflineminus">-nsresult nsMailboxUrl::ParseSearchPart()</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineminus">-{</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+nsresult nsMailboxUrl::ParseSearchPart() {</span>
<a href="#l14.456"></a><span id="l14.456">   nsAutoCString searchPart;</span>
<a href="#l14.457"></a><span id="l14.457">   nsresult rv = GetQuery(searchPart);</span>
<a href="#l14.458"></a><span id="l14.458">   // add code to this function to decompose everything past the '?'.....</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !searchPart.IsEmpty())</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineminus">-  {</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !searchPart.IsEmpty()) {</span>
<a href="#l14.462"></a><span id="l14.462">     // the action for this mailbox must be a display message...</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineminus">-    char * msgPart = extractAttributeValue(searchPart.get(), &quot;part=&quot;);</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineminus">-    if (msgPart)  // if we have a part in the url then we must be fetching just the part.</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+    char *msgPart = extractAttributeValue(searchPart.get(), &quot;part=&quot;);</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineplus">+    if (msgPart)  // if we have a part in the url then we must be fetching just</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+                  // the part.</span>
<a href="#l14.468"></a><span id="l14.468">       m_mailboxAction = nsIMailboxUrl::ActionFetchPart;</span>
<a href="#l14.469"></a><span id="l14.469">     else</span>
<a href="#l14.470"></a><span id="l14.470">       m_mailboxAction = nsIMailboxUrl::ActionFetchMessage;</span>
<a href="#l14.471"></a><span id="l14.471"> </span>
<a href="#l14.472"></a><span id="l14.472" class="difflineminus">-    char * messageKey = extractAttributeValue(searchPart.get(), &quot;number=&quot;);</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineminus">-    m_messageID = extractAttributeValue(searchPart.get(),&quot;messageid=&quot;);</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+    char *messageKey = extractAttributeValue(searchPart.get(), &quot;number=&quot;);</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+    m_messageID = extractAttributeValue(searchPart.get(), &quot;messageid=&quot;);</span>
<a href="#l14.476"></a><span id="l14.476">     if (messageKey)</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineminus">-      m_messageKey = (nsMsgKey) ParseUint64Str(messageKey); // convert to a uint32_t...</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+      m_messageKey =</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineplus">+          (nsMsgKey)ParseUint64Str(messageKey);  // convert to a uint32_t...</span>
<a href="#l14.480"></a><span id="l14.480"> </span>
<a href="#l14.481"></a><span id="l14.481">     PR_Free(msgPart);</span>
<a href="#l14.482"></a><span id="l14.482">     PR_Free(messageKey);</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineminus">-  }</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineminus">-  else</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+  } else</span>
<a href="#l14.486"></a><span id="l14.486">     m_mailboxAction = nsIMailboxUrl::ActionParseMailbox;</span>
<a href="#l14.487"></a><span id="l14.487"> </span>
<a href="#l14.488"></a><span id="l14.488">   return rv;</span>
<a href="#l14.489"></a><span id="l14.489"> }</span>
<a href="#l14.490"></a><span id="l14.490"> </span>
<a href="#l14.491"></a><span id="l14.491" class="difflineminus">-// warning: don't assume when parsing the url that the protocol part is &quot;news&quot;...</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineminus">-nsresult nsMailboxUrl::ParseUrl()</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineminus">-{</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+// warning: don't assume when parsing the url that the protocol part is</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+// &quot;news&quot;...</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+nsresult nsMailboxUrl::ParseUrl() {</span>
<a href="#l14.497"></a><span id="l14.497">   GetFilePath(m_file);</span>
<a href="#l14.498"></a><span id="l14.498"> </span>
<a href="#l14.499"></a><span id="l14.499">   ParseSearchPart();</span>
<a href="#l14.500"></a><span id="l14.500">   // ### fix me.</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineminus">-  // this hack is to avoid asserting on every local message loaded because the security manager</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineminus">-  // is creating an empty &quot;mailbox://&quot; uri for every message.</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineplus">+  // this hack is to avoid asserting on every local message loaded because the</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+  // security manager is creating an empty &quot;mailbox://&quot; uri for every message.</span>
<a href="#l14.505"></a><span id="l14.505">   if (m_file.Length() &lt; 2)</span>
<a href="#l14.506"></a><span id="l14.506">     m_filePath = nullptr;</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-  else</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineminus">-  {</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+  else {</span>
<a href="#l14.510"></a><span id="l14.510">     nsCString fileUri(&quot;file://&quot;);</span>
<a href="#l14.511"></a><span id="l14.511">     fileUri.Append(m_file);</span>
<a href="#l14.512"></a><span id="l14.512">     nsresult rv;</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineminus">-    nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineminus">-      mozilla::services::GetIOService();</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+    nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l14.516"></a><span id="l14.516">     NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineminus">-    nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l14.519"></a><span id="l14.519">     rv = ioService-&gt;NewURI(fileUri, nullptr, nullptr, getter_AddRefs(uri));</span>
<a href="#l14.520"></a><span id="l14.520">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineminus">-    nsCOMPtr &lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineplus">+    nsCOMPtr&lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l14.523"></a><span id="l14.523">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; fileURLFile;</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; fileURLFile;</span>
<a href="#l14.526"></a><span id="l14.526">     fileURL-&gt;GetFile(getter_AddRefs(fileURLFile));</span>
<a href="#l14.527"></a><span id="l14.527">     NS_ENSURE_TRUE(fileURLFile, NS_ERROR_NULL_POINTER);</span>
<a href="#l14.528"></a><span id="l14.528">     m_filePath = fileURLFile;</span>
<a href="#l14.529"></a><span id="l14.529">   }</span>
<a href="#l14.530"></a><span id="l14.530"> </span>
<a href="#l14.531"></a><span id="l14.531">   GetPathQueryRef(m_file);</span>
<a href="#l14.532"></a><span id="l14.532">   return NS_OK;</span>
<a href="#l14.533"></a><span id="l14.533"> }</span>
<a href="#l14.534"></a><span id="l14.534"> </span>
<a href="#l14.535"></a><span id="l14.535" class="difflineminus">-nsresult nsMailboxUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineminus">-{</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineplus">+nsresult nsMailboxUrl::SetSpecInternal(const nsACString &amp;aSpec) {</span>
<a href="#l14.538"></a><span id="l14.538">   nsresult rv = nsMsgMailNewsUrl::SetSpecInternal(aSpec);</span>
<a href="#l14.539"></a><span id="l14.539">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l14.540"></a><span id="l14.540">     // Do not try to parse URLs of the form</span>
<a href="#l14.541"></a><span id="l14.541">     // mailbox://user@domain@server/folder?number=nn since this will fail.</span>
<a href="#l14.542"></a><span id="l14.542">     // Check for format lacking absolute path.</span>
<a href="#l14.543"></a><span id="l14.543">     if (PromiseFlatCString(aSpec).Find(&quot;///&quot;) != kNotFound) {</span>
<a href="#l14.544"></a><span id="l14.544">       rv = ParseUrl();</span>
<a href="#l14.545"></a><span id="l14.545">     } else {</span>
<a href="#l14.546"></a><span id="l14.546">       // We still need to parse the search part to populate</span>
<a href="#l14.547"></a><span id="l14.547">       // m_messageKey etc.</span>
<a href="#l14.548"></a><span id="l14.548">       ParseSearchPart();</span>
<a href="#l14.549"></a><span id="l14.549">     }</span>
<a href="#l14.550"></a><span id="l14.550">   }</span>
<a href="#l14.551"></a><span id="l14.551">   return rv;</span>
<a href="#l14.552"></a><span id="l14.552"> }</span>
<a href="#l14.553"></a><span id="l14.553"> </span>
<a href="#l14.554"></a><span id="l14.554" class="difflineminus">-nsresult nsMailboxUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineminus">-{</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+nsresult nsMailboxUrl::SetQuery(const nsACString &amp;aQuery) {</span>
<a href="#l14.557"></a><span id="l14.557">   nsresult rv = nsMsgMailNewsUrl::SetQuery(aQuery);</span>
<a href="#l14.558"></a><span id="l14.558" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineminus">-    rv = ParseUrl();</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = ParseUrl();</span>
<a href="#l14.561"></a><span id="l14.561">   return rv;</span>
<a href="#l14.562"></a><span id="l14.562"> }</span>
<a href="#l14.563"></a><span id="l14.563"> </span>
<a href="#l14.564"></a><span id="l14.564"> // takes a string like ?messageID=fooo&amp;number=MsgKey and returns a new string</span>
<a href="#l14.565"></a><span id="l14.565"> // containing just the attribute value. i.e you could pass in this string with</span>
<a href="#l14.566"></a><span id="l14.566"> // an attribute name of messageID and I'll return fooo. Use PR_Free to delete</span>
<a href="#l14.567"></a><span id="l14.567"> // this string...</span>
<a href="#l14.568"></a><span id="l14.568"> </span>
<a href="#l14.569"></a><span id="l14.569"> // Assumption: attribute pairs in the string are separated by '&amp;'.</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineminus">-char * extractAttributeValue(const char * searchString, const char * attributeName)</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineminus">-{</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineminus">-  char * attributeValue = nullptr;</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineplus">+char *extractAttributeValue(const char *searchString,</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+                            const char *attributeName) {</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+  char *attributeValue = nullptr;</span>
<a href="#l14.576"></a><span id="l14.576"> </span>
<a href="#l14.577"></a><span id="l14.577" class="difflineminus">-  if (searchString &amp;&amp; attributeName)</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineminus">-  {</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+  if (searchString &amp;&amp; attributeName) {</span>
<a href="#l14.580"></a><span id="l14.580">     // search the string for attributeName</span>
<a href="#l14.581"></a><span id="l14.581">     uint32_t attributeNameSize = PL_strlen(attributeName);</span>
<a href="#l14.582"></a><span id="l14.582" class="difflineminus">-    char * startOfAttribute = PL_strcasestr(searchString, attributeName);</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineminus">-    if (startOfAttribute)</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineminus">-    {</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineminus">-      startOfAttribute += attributeNameSize; // skip over the attributeName</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineminus">-      if (startOfAttribute) // is there something after the attribute name</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+    char *startOfAttribute = PL_strcasestr(searchString, attributeName);</span>
<a href="#l14.588"></a><span id="l14.588" class="difflineplus">+    if (startOfAttribute) {</span>
<a href="#l14.589"></a><span id="l14.589" class="difflineplus">+      startOfAttribute += attributeNameSize;  // skip over the attributeName</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineplus">+      if (startOfAttribute)  // is there something after the attribute name</span>
<a href="#l14.591"></a><span id="l14.591">       {</span>
<a href="#l14.592"></a><span id="l14.592" class="difflineminus">-        char * endOfAttribute = startOfAttribute ? PL_strchr(startOfAttribute, '&amp;') : nullptr;</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+        char *endOfAttribute =</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineplus">+            startOfAttribute ? PL_strchr(startOfAttribute, '&amp;') : nullptr;</span>
<a href="#l14.595"></a><span id="l14.595">         nsDependentCString attributeValueStr;</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-        if (startOfAttribute &amp;&amp; endOfAttribute) // is there text after attribute value</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineminus">-          attributeValueStr.Assign(startOfAttribute, endOfAttribute - startOfAttribute);</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineminus">-        else // there is nothing left so eat up rest of line.</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+        if (startOfAttribute &amp;&amp;</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+            endOfAttribute)  // is there text after attribute value</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineplus">+          attributeValueStr.Assign(startOfAttribute,</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineplus">+                                   endOfAttribute - startOfAttribute);</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineplus">+        else  // there is nothing left so eat up rest of line.</span>
<a href="#l14.604"></a><span id="l14.604">           attributeValueStr.Assign(startOfAttribute);</span>
<a href="#l14.605"></a><span id="l14.605"> </span>
<a href="#l14.606"></a><span id="l14.606">         // now unescape the string...</span>
<a href="#l14.607"></a><span id="l14.607">         nsCString unescapedValue;</span>
<a href="#l14.608"></a><span id="l14.608">         MsgUnescapeString(attributeValueStr, 0, unescapedValue);</span>
<a href="#l14.609"></a><span id="l14.609">         attributeValue = PL_strdup(unescapedValue.get());</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineminus">-      } // if we have a attribute value</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+      }  // if we have a attribute value</span>
<a href="#l14.612"></a><span id="l14.612"> </span>
<a href="#l14.613"></a><span id="l14.613" class="difflineminus">-    } // if we have a attribute name</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineminus">-  } // if we got non-null search string and attribute name values</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineplus">+    }  // if we have a attribute name</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+  }    // if we got non-null search string and attribute name values</span>
<a href="#l14.617"></a><span id="l14.617"> </span>
<a href="#l14.618"></a><span id="l14.618">   return attributeValue;</span>
<a href="#l14.619"></a><span id="l14.619"> }</span>
<a href="#l14.620"></a><span id="l14.620"> </span>
<a href="#l14.621"></a><span id="l14.621"> // nsIMsgI18NUrl support</span>
<a href="#l14.622"></a><span id="l14.622"> </span>
<a href="#l14.623"></a><span id="l14.623" class="difflineminus">-nsresult nsMailboxUrl::GetFolder(nsIMsgFolder **msgFolder)</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineminus">-{</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineminus">-  // if we have a RDF URI, then try to get the folder for that URI and then ask the folder</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineminus">-  // for it's charset....</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+nsresult nsMailboxUrl::GetFolder(nsIMsgFolder **msgFolder) {</span>
<a href="#l14.628"></a><span id="l14.628" class="difflineplus">+  // if we have a RDF URI, then try to get the folder for that URI and then ask</span>
<a href="#l14.629"></a><span id="l14.629" class="difflineplus">+  // the folder for it's charset....</span>
<a href="#l14.630"></a><span id="l14.630">   nsCString uri;</span>
<a href="#l14.631"></a><span id="l14.631">   GetUri(getter_Copies(uri));</span>
<a href="#l14.632"></a><span id="l14.632">   NS_ENSURE_TRUE(!uri.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l14.633"></a><span id="l14.633">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l14.634"></a><span id="l14.634">   GetMsgDBHdrFromURI(uri.get(), getter_AddRefs(msg));</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineminus">-  if (!msg)</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+  if (!msg) return NS_ERROR_FAILURE;</span>
<a href="#l14.638"></a><span id="l14.638">   return msg-&gt;GetFolder(msgFolder);</span>
<a href="#l14.639"></a><span id="l14.639"> }</span>
<a href="#l14.640"></a><span id="l14.640"> </span>
<a href="#l14.641"></a><span id="l14.641" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetFolderCharset(char ** aCharacterSet)</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineminus">-{</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetFolderCharset(char **aCharacterSet) {</span>
<a href="#l14.644"></a><span id="l14.644">   NS_ENSURE_ARG_POINTER(aCharacterSet);</span>
<a href="#l14.645"></a><span id="l14.645">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l14.646"></a><span id="l14.646">   nsresult rv = GetFolder(getter_AddRefs(folder));</span>
<a href="#l14.647"></a><span id="l14.647"> </span>
<a href="#l14.648"></a><span id="l14.648">   // In cases where a file is not associated with a folder, for</span>
<a href="#l14.649"></a><span id="l14.649">   // example standalone .eml files, failure is normal.</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineminus">-    return rv;</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.653"></a><span id="l14.653">   nsCString tmpStr;</span>
<a href="#l14.654"></a><span id="l14.654">   folder-&gt;GetCharset(tmpStr);</span>
<a href="#l14.655"></a><span id="l14.655">   *aCharacterSet = ToNewCString(tmpStr);</span>
<a href="#l14.656"></a><span id="l14.656">   return NS_OK;</span>
<a href="#l14.657"></a><span id="l14.657"> }</span>
<a href="#l14.658"></a><span id="l14.658"> </span>
<a href="#l14.659"></a><span id="l14.659" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetFolderCharsetOverride(bool * aCharacterSetOverride)</span>
<a href="#l14.660"></a><span id="l14.660" class="difflineminus">-{</span>
<a href="#l14.661"></a><span id="l14.661" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetFolderCharsetOverride(</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineplus">+    bool *aCharacterSetOverride) {</span>
<a href="#l14.663"></a><span id="l14.663">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l14.664"></a><span id="l14.664">   nsresult rv = GetFolder(getter_AddRefs(folder));</span>
<a href="#l14.665"></a><span id="l14.665" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.667"></a><span id="l14.667">   NS_ENSURE_TRUE(folder, NS_ERROR_FAILURE);</span>
<a href="#l14.668"></a><span id="l14.668">   folder-&gt;GetCharsetOverride(aCharacterSetOverride);</span>
<a href="#l14.669"></a><span id="l14.669"> </span>
<a href="#l14.670"></a><span id="l14.670">   return NS_OK;</span>
<a href="#l14.671"></a><span id="l14.671"> }</span>
<a href="#l14.672"></a><span id="l14.672"> </span>
<a href="#l14.673"></a><span id="l14.673" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetCharsetOverRide(char ** aCharacterSet)</span>
<a href="#l14.674"></a><span id="l14.674" class="difflineminus">-{</span>
<a href="#l14.675"></a><span id="l14.675" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetCharsetOverRide(char **aCharacterSet) {</span>
<a href="#l14.676"></a><span id="l14.676">   if (!mCharsetOverride.IsEmpty())</span>
<a href="#l14.677"></a><span id="l14.677">     *aCharacterSet = ToNewCString(mCharsetOverride);</span>
<a href="#l14.678"></a><span id="l14.678">   else</span>
<a href="#l14.679"></a><span id="l14.679">     *aCharacterSet = nullptr;</span>
<a href="#l14.680"></a><span id="l14.680">   return NS_OK;</span>
<a href="#l14.681"></a><span id="l14.681"> }</span>
<a href="#l14.682"></a><span id="l14.682"> </span>
<a href="#l14.683"></a><span id="l14.683" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::SetCharsetOverRide(const char * aCharacterSet)</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineminus">-{</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::SetCharsetOverRide(const char *aCharacterSet) {</span>
<a href="#l14.686"></a><span id="l14.686">   mCharsetOverride = aCharacterSet;</span>
<a href="#l14.687"></a><span id="l14.687">   return NS_OK;</span>
<a href="#l14.688"></a><span id="l14.688"> }</span>
<a href="#l14.689"></a><span id="l14.689"> </span>
<a href="#l14.690"></a><span id="l14.690"> /* void setMoveCopyMsgKeys (out nsMsgKey keysToFlag, in long numKeys); */</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::SetMoveCopyMsgKeys(nsMsgKey *keysToFlag, int32_t numKeys)</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineminus">-{</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::SetMoveCopyMsgKeys(nsMsgKey *keysToFlag,</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineplus">+                                               int32_t numKeys) {</span>
<a href="#l14.695"></a><span id="l14.695">   m_keys.ReplaceElementsAt(0, m_keys.Length(), keysToFlag, numKeys);</span>
<a href="#l14.696"></a><span id="l14.696">   if (!m_keys.IsEmpty() &amp;&amp; m_messageKey == nsMsgKey_None)</span>
<a href="#l14.697"></a><span id="l14.697">     m_messageKey = m_keys[0];</span>
<a href="#l14.698"></a><span id="l14.698">   return NS_OK;</span>
<a href="#l14.699"></a><span id="l14.699"> }</span>
<a href="#l14.700"></a><span id="l14.700"> </span>
<a href="#l14.701"></a><span id="l14.701" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetMoveCopyMsgHdrForIndex(uint32_t msgIndex, nsIMsgDBHdr **msgHdr)</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineminus">-{</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetMoveCopyMsgHdrForIndex(uint32_t msgIndex,</span>
<a href="#l14.704"></a><span id="l14.704" class="difflineplus">+                                                      nsIMsgDBHdr **msgHdr) {</span>
<a href="#l14.705"></a><span id="l14.705">   NS_ENSURE_ARG(msgHdr);</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineminus">-  if (msgIndex &lt; m_keys.Length())</span>
<a href="#l14.707"></a><span id="l14.707" class="difflineminus">-  {</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineplus">+  if (msgIndex &lt; m_keys.Length()) {</span>
<a href="#l14.709"></a><span id="l14.709">     nsMsgKey nextKey = m_keys[msgIndex];</span>
<a href="#l14.710"></a><span id="l14.710">     return GetMsgHdrForKey(nextKey, msgHdr);</span>
<a href="#l14.711"></a><span id="l14.711">   }</span>
<a href="#l14.712"></a><span id="l14.712">   return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l14.713"></a><span id="l14.713"> }</span>
<a href="#l14.714"></a><span id="l14.714"> </span>
<a href="#l14.715"></a><span id="l14.715" class="difflineminus">-NS_IMETHODIMP nsMailboxUrl::GetNumMoveCopyMsgs(uint32_t *numMsgs)</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineminus">-{</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+NS_IMETHODIMP nsMailboxUrl::GetNumMoveCopyMsgs(uint32_t *numMsgs) {</span>
<a href="#l14.718"></a><span id="l14.718">   NS_ENSURE_ARG(numMsgs);</span>
<a href="#l14.719"></a><span id="l14.719">   *numMsgs = m_keys.Length();</span>
<a href="#l14.720"></a><span id="l14.720">   return NS_OK;</span>
<a href="#l14.721"></a><span id="l14.721"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxUrl.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxUrl.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -10,100 +10,100 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsMsgMailNewsUrl.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-class nsMailboxUrl : public nsIMailboxUrl, public nsMsgMailNewsUrl, public nsIMsgMessageUrl, public nsIMsgI18NUrl</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-public:</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+class nsMailboxUrl : public nsIMailboxUrl,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+                     public nsMsgMailNewsUrl,</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+                     public nsIMsgMessageUrl,</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+                     public nsIMsgI18NUrl {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+ public:</span>
<a href="#l15.20"></a><span id="l15.20">   // nsIMsgMailNewsUrl override</span>
<a href="#l15.21"></a><span id="l15.21">   nsresult SetSpecInternal(const nsACString &amp;aSpec) override;</span>
<a href="#l15.22"></a><span id="l15.22">   nsresult SetQuery(const nsACString &amp;aQuery) override;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  nsresult CreateURL(const nsACString&amp; aSpec, nsIURL **aURL) override;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  nsresult CreateURL(const nsACString &amp;aSpec, nsIURL **aURL) override;</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">   // from nsIMailboxUrl:</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  NS_IMETHOD SetMailboxParser(nsIStreamListener * aConsumer) override;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-  NS_IMETHOD GetMailboxParser(nsIStreamListener ** aConsumer) override;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-  NS_IMETHOD SetMailboxCopyHandler(nsIStreamListener *  aConsumer) override;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-  NS_IMETHOD GetMailboxCopyHandler(nsIStreamListener ** aConsumer) override;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+  NS_IMETHOD SetMailboxParser(nsIStreamListener *aConsumer) override;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  NS_IMETHOD GetMailboxParser(nsIStreamListener **aConsumer) override;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  NS_IMETHOD SetMailboxCopyHandler(nsIStreamListener *aConsumer) override;</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  NS_IMETHOD GetMailboxCopyHandler(nsIStreamListener **aConsumer) override;</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  NS_IMETHOD GetMessageKey(nsMsgKey* aMessageKey) override;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  NS_IMETHOD GetMessageKey(nsMsgKey *aMessageKey) override;</span>
<a href="#l15.38"></a><span id="l15.38">   NS_IMETHOD GetMessageSize(uint32_t *aMessageSize) override;</span>
<a href="#l15.39"></a><span id="l15.39">   NS_IMETHOD SetMessageSize(uint32_t aMessageSize) override;</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-  NS_IMETHOD GetMailboxAction(nsMailboxAction *result) override</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  NS_IMETHOD GetMailboxAction(nsMailboxAction *result) override {</span>
<a href="#l15.43"></a><span id="l15.43">     NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l15.44"></a><span id="l15.44">     *result = m_mailboxAction;</span>
<a href="#l15.45"></a><span id="l15.45">     return NS_OK;</span>
<a href="#l15.46"></a><span id="l15.46">   }</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  NS_IMETHOD SetMailboxAction(nsMailboxAction aAction) override</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  {</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  NS_IMETHOD SetMailboxAction(nsMailboxAction aAction) override {</span>
<a href="#l15.50"></a><span id="l15.50">     m_mailboxAction = aAction;</span>
<a href="#l15.51"></a><span id="l15.51">     return NS_OK;</span>
<a href="#l15.52"></a><span id="l15.52">   }</span>
<a href="#l15.53"></a><span id="l15.53">   NS_IMETHOD IsUrlType(uint32_t type, bool *isType) override;</span>
<a href="#l15.54"></a><span id="l15.54">   NS_IMETHOD SetMoveCopyMsgKeys(nsMsgKey *keysToFlag, int32_t numKeys) override;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  NS_IMETHOD GetMoveCopyMsgHdrForIndex(uint32_t msgIndex, nsIMsgDBHdr **msgHdr) override;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  NS_IMETHOD GetMoveCopyMsgHdrForIndex(uint32_t msgIndex,</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+                                       nsIMsgDBHdr **msgHdr) override;</span>
<a href="#l15.58"></a><span id="l15.58">   NS_IMETHOD GetNumMoveCopyMsgs(uint32_t *numMsgs) override;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  NS_IMETHOD GetCurMoveCopyMsgIndex(uint32_t *result) override</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  NS_IMETHOD GetCurMoveCopyMsgIndex(uint32_t *result) override {</span>
<a href="#l15.62"></a><span id="l15.62">     NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l15.63"></a><span id="l15.63">     *result = m_curMsgIndex;</span>
<a href="#l15.64"></a><span id="l15.64">     return NS_OK;</span>
<a href="#l15.65"></a><span id="l15.65">   }</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-  NS_IMETHOD SetCurMoveCopyMsgIndex(uint32_t aIndex) override</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-  {</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  NS_IMETHOD SetCurMoveCopyMsgIndex(uint32_t aIndex) override {</span>
<a href="#l15.69"></a><span id="l15.69">     m_curMsgIndex = aIndex;</span>
<a href="#l15.70"></a><span id="l15.70">     return NS_OK;</span>
<a href="#l15.71"></a><span id="l15.71">   }</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73">   NS_IMETHOD GetFolder(nsIMsgFolder **msgFolder) override;</span>
<a href="#l15.74"></a><span id="l15.74"> </span>
<a href="#l15.75"></a><span id="l15.75">   // nsMsgMailNewsUrl override</span>
<a href="#l15.76"></a><span id="l15.76">   nsresult Clone(nsIURI **_retval) override;</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78">   // nsMailboxUrl</span>
<a href="#l15.79"></a><span id="l15.79">   nsMailboxUrl();</span>
<a href="#l15.80"></a><span id="l15.80">   NS_DECL_NSIMSGMESSAGEURL</span>
<a href="#l15.81"></a><span id="l15.81">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l15.82"></a><span id="l15.82">   NS_DECL_NSIMSGI18NURL</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-protected:</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+ protected:</span>
<a href="#l15.86"></a><span id="l15.86">   virtual ~nsMailboxUrl();</span>
<a href="#l15.87"></a><span id="l15.87">   // protocol specific code to parse a url...</span>
<a href="#l15.88"></a><span id="l15.88">   virtual nsresult ParseUrl();</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-  nsresult GetMsgHdrForKey(nsMsgKey  msgKey, nsIMsgDBHdr ** aMsgHdr);</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+  nsresult GetMsgHdrForKey(nsMsgKey msgKey, nsIMsgDBHdr **aMsgHdr);</span>
<a href="#l15.91"></a><span id="l15.91"> </span>
<a href="#l15.92"></a><span id="l15.92">   // mailboxurl specific state</span>
<a href="#l15.93"></a><span id="l15.93">   nsCOMPtr&lt;nsIStreamListener&gt; m_mailboxParser;</span>
<a href="#l15.94"></a><span id="l15.94">   nsCOMPtr&lt;nsIStreamListener&gt; m_mailboxCopyHandler;</span>
<a href="#l15.95"></a><span id="l15.95"> </span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-  nsMailboxAction m_mailboxAction; // the action this url represents...parse mailbox, display messages, etc.</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;  m_filePath;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+  nsMailboxAction m_mailboxAction;  // the action this url represents...parse</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+                                    // mailbox, display messages, etc.</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_filePath;</span>
<a href="#l15.101"></a><span id="l15.101">   char *m_messageID;</span>
<a href="#l15.102"></a><span id="l15.102">   uint32_t m_messageSize;</span>
<a href="#l15.103"></a><span id="l15.103">   nsMsgKey m_messageKey;</span>
<a href="#l15.104"></a><span id="l15.104">   nsCString m_file;</span>
<a href="#l15.105"></a><span id="l15.105">   // This is currently only set when we're doing something with a .eml file.</span>
<a href="#l15.106"></a><span id="l15.106">   // If that changes, we should change the name of this var.</span>
<a href="#l15.107"></a><span id="l15.107">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_dummyHdr;</span>
<a href="#l15.108"></a><span id="l15.108"> </span>
<a href="#l15.109"></a><span id="l15.109">   // used by save message to disk</span>
<a href="#l15.110"></a><span id="l15.110">   nsCOMPtr&lt;nsIFile&gt; m_messageFile;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-  bool                  m_addDummyEnvelope;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-  bool                  m_canonicalLineEnding;</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  bool m_addDummyEnvelope;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+  bool m_canonicalLineEnding;</span>
<a href="#l15.115"></a><span id="l15.115">   nsresult ParseSearchPart();</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117">   // for multiple msg move/copy</span>
<a href="#l15.118"></a><span id="l15.118">   nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l15.119"></a><span id="l15.119">   int32_t m_curMsgIndex;</span>
<a href="#l15.120"></a><span id="l15.120"> </span>
<a href="#l15.121"></a><span id="l15.121">   // truncated message support</span>
<a href="#l15.122"></a><span id="l15.122">   nsCString m_originalSpec;</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-  nsCString mURI; // the RDF URI associated with this url.</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-  nsCString mCharsetOverride; // used by nsIMsgI18NUrl...</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+  nsCString mURI;              // the RDF URI associated with this url.</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+  nsCString mCharsetOverride;  // used by nsIMsgI18NUrl...</span>
<a href="#l15.127"></a><span id="l15.127"> };</span>
<a href="#l15.128"></a><span id="l15.128"> </span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-#endif // nsMailboxUrl_h__</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+#endif  // nsMailboxUrl_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailIncomingServer.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailIncomingServer.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -2,175 +2,148 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsIMovemailService.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;msgCore.h&quot; // pre-compiled headers</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+#include &quot;msgCore.h&quot;  // pre-compiled headers</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsMovemailIncomingServer.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-</span>
<a href="#l16.18"></a><span id="l16.18"> static NS_DEFINE_CID(kCMovemailServiceCID, NS_MOVEMAILSERVICE_CID);</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsMovemailIncomingServer, nsMsgIncomingServer,</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+                            nsIMovemailIncomingServer,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+                            nsILocalMailIncomingServer)</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsMovemailIncomingServer,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-                             nsMsgIncomingServer,</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-                             nsIMovemailIncomingServer,</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-                             nsILocalMailIncomingServer)</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-nsMovemailIncomingServer::nsMovemailIncomingServer()</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-{</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-    m_canHaveFilters = true;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+nsMovemailIncomingServer::nsMovemailIncomingServer() {</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+  m_canHaveFilters = true;</span>
<a href="#l16.35"></a><span id="l16.35"> }</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-nsMovemailIncomingServer::~nsMovemailIncomingServer()</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-{</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+nsMovemailIncomingServer::~nsMovemailIncomingServer() {}</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+nsMovemailIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  nsCOMPtr&lt;nsIMovemailService&gt; movemailService(</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+      do_GetService(kCMovemailServiceCID, &amp;rv));</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; rootMsgFolder) {</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+    rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+                                      getter_AddRefs(inbox));</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+    if (!inbox) return NS_ERROR_FAILURE;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+  }</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+  SetPerformingBiff(true);</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  urlListener = do_QueryInterface(inbox);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+  bool downloadOnBiff = false;</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+  rv = GetDownloadOnBiff(&amp;downloadOnBiff);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  if (downloadOnBiff) {</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localInbox = do_QueryInterface(inbox, &amp;rv);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    if (localInbox &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+      bool valid = false;</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+      rv = inbox-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; db) {</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+        rv = db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+      }</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; valid) {</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+        rv = movemailService-&gt;GetNewMail(aMsgWindow, urlListener, inbox, this,</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+                                         nullptr);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+      } else {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+        bool isLocked;</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+        inbox-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+        if (!isLocked) {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+          rv = localInbox-&gt;ParseFolder(aMsgWindow, urlListener);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+        }</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+          rv = localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+        }</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+      }</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+    }</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+  } else {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+    movemailService-&gt;CheckForNewMail(urlListener, inbox, this, nullptr);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+  }</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.90"></a><span id="l16.90"> }</span>
<a href="#l16.91"></a><span id="l16.91"> </span>
<a href="#l16.92"></a><span id="l16.92"> NS_IMETHODIMP</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-nsMovemailIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow)</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-{</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-    nsresult rv;</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-    nsCOMPtr&lt;nsIMovemailService&gt; movemailService(do_GetService(</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-                                                 kCMovemailServiceCID, &amp;rv));</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-    nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-    rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-    if(NS_SUCCEEDED(rv) &amp;&amp; rootMsgFolder)</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-    {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-         rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-                                           getter_AddRefs(inbox));</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-         if (!inbox) return NS_ERROR_FAILURE;</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-    }</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-    SetPerformingBiff(true);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-    urlListener = do_QueryInterface(inbox);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+nsMovemailIncomingServer::SetFlagsOnDefaultMailboxes() {</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+  nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.116"></a><span id="l16.116"> </span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-    bool downloadOnBiff = false;</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-    rv = GetDownloadOnBiff(&amp;downloadOnBiff);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-    if (downloadOnBiff)</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-    {</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-       nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localInbox = do_QueryInterface(inbox,</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-                                                                       &amp;rv);</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-       if (localInbox &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-       {</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-           bool valid = false;</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-           nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineminus">-           rv = inbox-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-           if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-           {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-               rv = db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-           }</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-           if (NS_SUCCEEDED(rv) &amp;&amp; valid)</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-           {</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-               rv = movemailService-&gt;GetNewMail(aMsgWindow, urlListener, inbox,</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineminus">-                                                this, nullptr);</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-           }</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-           else</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-           {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-              bool isLocked;</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-              inbox-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-              if (!isLocked)</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-              {</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineminus">-                 rv = localInbox-&gt;ParseFolder(aMsgWindow, urlListener);</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-              }</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-              {</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineminus">-                 rv = localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-              }</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineminus">-           }</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineminus">-       }</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineminus">-    }</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-    else</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-    {</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-        movemailService-&gt;CheckForNewMail(urlListener, inbox, this, nullptr);</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-    }</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+      do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.159"></a><span id="l16.159"> </span>
<a href="#l16.160"></a><span id="l16.160" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+  return localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::SpecialUse);</span>
<a href="#l16.162"></a><span id="l16.162"> }</span>
<a href="#l16.163"></a><span id="l16.163"> </span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineminus">-nsMovemailIncomingServer::SetFlagsOnDefaultMailboxes()</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineminus">-{</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-    nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineminus">-    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-        do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineminus">-</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineminus">-    return localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::SpecialUse);</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-}</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineminus">-</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">-NS_IMETHODIMP nsMovemailIncomingServer::CreateDefaultMailboxes()</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-{</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+NS_IMETHODIMP nsMovemailIncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l16.181"></a><span id="l16.181">   nsresult rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l16.182"></a><span id="l16.182">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.183"></a><span id="l16.183"> </span>
<a href="#l16.184"></a><span id="l16.184">   return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l16.185"></a><span id="l16.185"> }</span>
<a href="#l16.186"></a><span id="l16.186"> </span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-</span>
<a href="#l16.188"></a><span id="l16.188"> NS_IMETHODIMP</span>
<a href="#l16.189"></a><span id="l16.189"> nsMovemailIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l16.190"></a><span id="l16.190">                                      nsIUrlListener *aUrlListener,</span>
<a href="#l16.191"></a><span id="l16.191">                                      nsIMsgFolder *aMsgFolder,</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineminus">-                                     nsIURI **aResult)</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineminus">-{</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineminus">-    nsresult rv;</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+                                     nsIURI **aResult) {</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.197"></a><span id="l16.197"> </span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-    nsCOMPtr&lt;nsIMovemailService&gt; movemailService =</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-             do_GetService(kCMovemailServiceCID, &amp;rv);</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+  nsCOMPtr&lt;nsIMovemailService&gt; movemailService =</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+      do_GetService(kCMovemailServiceCID, &amp;rv);</span>
<a href="#l16.202"></a><span id="l16.202"> </span>
<a href="#l16.203"></a><span id="l16.203" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.205"></a><span id="l16.205"> </span>
<a href="#l16.206"></a><span id="l16.206" class="difflineminus">-    rv = movemailService-&gt;GetNewMail(aMsgWindow, aUrlListener,</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineminus">-                                     aMsgFolder, this, aResult);</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+  rv = movemailService-&gt;GetNewMail(aMsgWindow, aUrlListener, aMsgFolder, this,</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+                                   aResult);</span>
<a href="#l16.210"></a><span id="l16.210"> </span>
<a href="#l16.211"></a><span id="l16.211" class="difflineminus">-    return rv;</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+  return rv;</span>
<a href="#l16.213"></a><span id="l16.213"> }</span>
<a href="#l16.214"></a><span id="l16.214"> </span>
<a href="#l16.215"></a><span id="l16.215"> NS_IMETHODIMP</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-nsMovemailIncomingServer::GetDownloadMessagesAtStartup(bool *getMessagesAtStartup)</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-{</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-    NS_ENSURE_ARG_POINTER(getMessagesAtStartup);</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineminus">-    *getMessagesAtStartup = true;</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+nsMovemailIncomingServer::GetDownloadMessagesAtStartup(</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+    bool *getMessagesAtStartup) {</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+  NS_ENSURE_ARG_POINTER(getMessagesAtStartup);</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+  *getMessagesAtStartup = true;</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.226"></a><span id="l16.226"> }</span>
<a href="#l16.227"></a><span id="l16.227"> </span>
<a href="#l16.228"></a><span id="l16.228"> NS_IMETHODIMP</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineminus">-nsMovemailIncomingServer::GetCanBeDefaultServer(bool *aCanBeDefaultServer)</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-{</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+nsMovemailIncomingServer::GetCanBeDefaultServer(bool *aCanBeDefaultServer) {</span>
<a href="#l16.232"></a><span id="l16.232">   NS_ENSURE_ARG_POINTER(aCanBeDefaultServer);</span>
<a href="#l16.233"></a><span id="l16.233">   *aCanBeDefaultServer = true;</span>
<a href="#l16.234"></a><span id="l16.234">   return NS_OK;</span>
<a href="#l16.235"></a><span id="l16.235"> }</span>
<a href="#l16.236"></a><span id="l16.236"> </span>
<a href="#l16.237"></a><span id="l16.237"> NS_IMETHODIMP</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineminus">-nsMovemailIncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineminus">-{</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-    NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-    *canSearchMessages = true;</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+nsMovemailIncomingServer::GetCanSearchMessages(bool *canSearchMessages) {</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+  NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+  *canSearchMessages = true;</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.247"></a><span id="l16.247"> }</span>
<a href="#l16.248"></a><span id="l16.248"> </span>
<a href="#l16.249"></a><span id="l16.249"> NS_IMETHODIMP</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineminus">-nsMovemailIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineminus">-{</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineminus">-    *aServerRequiresPasswordForBiff = false;</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+nsMovemailIncomingServer::GetServerRequiresPasswordForBiff(</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+    bool *aServerRequiresPasswordForBiff) {</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+  *aServerRequiresPasswordForBiff = false;</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.260"></a><span id="l16.260"> }</span>
<a href="#l16.261"></a><span id="l16.261"> </span>
<a href="#l16.262"></a><span id="l16.262"> NS_IMETHODIMP</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineminus">-nsMovemailIncomingServer::GetAccountManagerChrome(nsAString&amp; aResult)</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineminus">-{</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineminus">-    aResult.AssignLiteral(&quot;am-main.xul&quot;);</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineminus">-    return NS_OK;</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+nsMovemailIncomingServer::GetAccountManagerChrome(nsAString &amp;aResult) {</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+  aResult.AssignLiteral(&quot;am-main.xul&quot;);</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+  return NS_OK;</span>
<a href="#l16.270"></a><span id="l16.270"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailIncomingServer.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailIncomingServer.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -13,28 +13,28 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsMailboxServer.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> /* get some implementation from nsMsgIncomingServer */</span>
<a href="#l17.7"></a><span id="l17.7"> class nsMovemailIncomingServer : public nsMailboxServer,</span>
<a href="#l17.8"></a><span id="l17.8">                                  public nsIMovemailIncomingServer,</span>
<a href="#l17.9"></a><span id="l17.9">                                  public nsILocalMailIncomingServer</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-public:</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-    NS_DECL_NSIMOVEMAILINCOMINGSERVER</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-    NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ public:</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  NS_DECL_NSIMOVEMAILINCOMINGSERVER</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-    nsMovemailIncomingServer();</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+  nsMovemailIncomingServer();</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-    NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-    NS_IMETHOD GetDownloadMessagesAtStartup(bool *getMessages) override;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-    NS_IMETHOD GetCanBeDefaultServer(bool *canBeDefaultServer) override;</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-    NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-    NS_IMETHOD GetAccountManagerChrome(nsAString&amp; aResult) override;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  NS_IMETHOD GetDownloadMessagesAtStartup(bool *getMessages) override;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  NS_IMETHOD GetCanBeDefaultServer(bool *canBeDefaultServer) override;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  NS_IMETHOD GetServerRequiresPasswordForBiff(</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+      bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  NS_IMETHOD GetAccountManagerChrome(nsAString &amp;aResult) override;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-private:</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-    virtual ~nsMovemailIncomingServer();</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+ private:</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+  virtual ~nsMovemailIncomingServer();</span>
<a href="#l17.42"></a><span id="l17.42"> };</span>
<a href="#l17.43"></a><span id="l17.43"> </span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-</span>
<a href="#l17.45"></a><span id="l17.45"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,20 +1,20 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-#include &lt;unistd.h&gt;    // for link(), used in spool-file locking</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+#include &lt;unistd.h&gt;  // for link(), used in spool-file locking</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12"> #include &quot;prenv.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-#include &quot;private/pprio.h&quot;     // for our kernel-based locking</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+#include &quot;private/pprio.h&quot;  // for our kernel-based locking</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nspr.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> #include &quot;nsMovemailService.h&quot;</span>
<a href="#l18.21"></a><span id="l18.21"> #include &quot;nsIMovemailService.h&quot;</span>
<a href="#l18.22"></a><span id="l18.22"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l18.23"></a><span id="l18.23"> #include &quot;nsIMovemailIncomingServer.h&quot;</span>
<a href="#l18.24"></a><span id="l18.24"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l18.25"></a><span id="l18.25"> #include &quot;nsParseMailbox.h&quot;</span>
<a href="#l18.26"></a><span id="l18.26"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineat">@@ -36,171 +36,149 @@</span>
<a href="#l18.28"></a><span id="l18.28"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l18.29"></a><span id="l18.29"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l18.32"></a><span id="l18.32"> // export MOZ_LOG_MODULES=Movemail:5</span>
<a href="#l18.33"></a><span id="l18.33"> static mozilla::LazyLogModule gMovemailLog(&quot;Movemail&quot;);</span>
<a href="#l18.34"></a><span id="l18.34"> #define LOG(args) MOZ_LOG(gMovemailLog, mozilla::LogLevel::Debug, args)</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-#define PREF_MAIL_ROOT_MOVEMAIL &quot;mail.root.movemail&quot;            // old - for backward compatibility only</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+#define PREF_MAIL_ROOT_MOVEMAIL \</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  &quot;mail.root.movemail&quot;  // old - for backward compatibility only</span>
<a href="#l18.39"></a><span id="l18.39"> #define PREF_MAIL_ROOT_MOVEMAIL_REL &quot;mail.root.movemail-rel&quot;</span>
<a href="#l18.40"></a><span id="l18.40"> </span>
<a href="#l18.41"></a><span id="l18.41"> #define LOCK_SUFFIX &quot;.lock&quot;</span>
<a href="#l18.42"></a><span id="l18.42"> #define MOZLOCK_SUFFIX &quot;.mozlock&quot;</span>
<a href="#l18.43"></a><span id="l18.43"> </span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-const char * gDefaultSpoolPaths[] = {</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-  &quot;/var/spool/mail/&quot;,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-  &quot;/usr/spool/mail/&quot;,</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-  &quot;/var/mail/&quot;,</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-  &quot;/usr/mail/&quot;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-};</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-#define NUM_DEFAULT_SPOOL_PATHS (sizeof(gDefaultSpoolPaths)/sizeof(gDefaultSpoolPaths[0]))</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+const char *gDefaultSpoolPaths[] = {&quot;/var/spool/mail/&quot;, &quot;/usr/spool/mail/&quot;,</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+                                    &quot;/var/mail/&quot;, &quot;/usr/mail/&quot;};</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+#define NUM_DEFAULT_SPOOL_PATHS \</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+  (sizeof(gDefaultSpoolPaths) / sizeof(gDefaultSpoolPaths[0]))</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56"> namespace {</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-class MOZ_STACK_CLASS SpoolLock</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-{</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-public:</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+class MOZ_STACK_CLASS SpoolLock {</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+ public:</span>
<a href="#l18.62"></a><span id="l18.62">   /**</span>
<a href="#l18.63"></a><span id="l18.63">    * Try to create a lock for the spool file while we operate on it.</span>
<a href="#l18.64"></a><span id="l18.64">    *</span>
<a href="#l18.65"></a><span id="l18.65">    * @param aSpoolName  The path to the spool file.</span>
<a href="#l18.66"></a><span id="l18.66">    * @param aSeconds    The number of seconds to retry the locking.</span>
<a href="#l18.67"></a><span id="l18.67">    * @param aMovemail   The movemail service requesting the lock.</span>
<a href="#l18.68"></a><span id="l18.68">    * @param aServer     The nsIMsgIncomingServer requesting the lock.</span>
<a href="#l18.69"></a><span id="l18.69">    */</span>
<a href="#l18.70"></a><span id="l18.70">   SpoolLock(nsACString *aSpoolPath, int aSeconds, nsMovemailService &amp;aMovemail,</span>
<a href="#l18.71"></a><span id="l18.71">             nsIMsgIncomingServer *aServer);</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73">   ~SpoolLock();</span>
<a href="#l18.74"></a><span id="l18.74"> </span>
<a href="#l18.75"></a><span id="l18.75">   bool isLocked();</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-private:</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+ private:</span>
<a href="#l18.79"></a><span id="l18.79">   bool mLocked;</span>
<a href="#l18.80"></a><span id="l18.80">   nsCString mSpoolName;</span>
<a href="#l18.81"></a><span id="l18.81">   bool mUsingLockFile;</span>
<a href="#l18.82"></a><span id="l18.82">   RefPtr&lt;nsMovemailService&gt; mOwningService;</span>
<a href="#l18.83"></a><span id="l18.83">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; mServer;</span>
<a href="#l18.84"></a><span id="l18.84"> </span>
<a href="#l18.85"></a><span id="l18.85">   bool ObtainSpoolLock(unsigned int aSeconds);</span>
<a href="#l18.86"></a><span id="l18.86">   bool YieldSpoolLock();</span>
<a href="#l18.87"></a><span id="l18.87"> };</span>
<a href="#l18.88"></a><span id="l18.88"> </span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-}</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+}  // namespace</span>
<a href="#l18.91"></a><span id="l18.91"> </span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-nsMovemailService::nsMovemailService()</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-{</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+nsMovemailService::nsMovemailService() {</span>
<a href="#l18.95"></a><span id="l18.95">   LOG((&quot;nsMovemailService created: 0x%p\n&quot;, this));</span>
<a href="#l18.96"></a><span id="l18.96"> }</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-nsMovemailService::~nsMovemailService()</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-{}</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+nsMovemailService::~nsMovemailService() {}</span>
<a href="#l18.102"></a><span id="l18.102"> </span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMovemailService,</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-                   nsIMovemailService,</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-                   nsIMsgProtocolInfo)</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMovemailService, nsIMovemailService, nsIMsgProtocolInfo)</span>
<a href="#l18.108"></a><span id="l18.108"> </span>
<a href="#l18.109"></a><span id="l18.109"> NS_IMETHODIMP</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-nsMovemailService::CheckForNewMail(nsIUrlListener * aUrlListener,</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+nsMovemailService::CheckForNewMail(nsIUrlListener *aUrlListener,</span>
<a href="#l18.112"></a><span id="l18.112">                                    nsIMsgFolder *inbox,</span>
<a href="#l18.113"></a><span id="l18.113">                                    nsIMovemailIncomingServer *movemailServer,</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-                                   nsIURI ** aURL)</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-{</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+                                   nsIURI **aURL) {</span>
<a href="#l18.117"></a><span id="l18.117">   nsresult rv = NS_OK;</span>
<a href="#l18.118"></a><span id="l18.118">   LOG((&quot;nsMovemailService::CheckForNewMail\n&quot;));</span>
<a href="#l18.119"></a><span id="l18.119">   return rv;</span>
<a href="#l18.120"></a><span id="l18.120"> }</span>
<a href="#l18.121"></a><span id="l18.121"> </span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-void</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-nsMovemailService::Error(const char* errorCode,</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-                         const char16_t **params,</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-                         uint32_t length)</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-{</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+void nsMovemailService::Error(const char *errorCode, const char16_t **params,</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+                              uint32_t length) {</span>
<a href="#l18.129"></a><span id="l18.129">   if (!mMsgWindow) return;</span>
<a href="#l18.130"></a><span id="l18.130"> </span>
<a href="#l18.131"></a><span id="l18.131">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l18.132"></a><span id="l18.132">   nsresult rv = mMsgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-    return;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l18.136"></a><span id="l18.136"> </span>
<a href="#l18.137"></a><span id="l18.137">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-  if (!bundleService)</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-    return;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+  if (!bundleService) return;</span>
<a href="#l18.143"></a><span id="l18.143">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-    return;</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+      &quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l18.150"></a><span id="l18.150"> </span>
<a href="#l18.151"></a><span id="l18.151">   nsString errStr;</span>
<a href="#l18.152"></a><span id="l18.152">   // Format the error string if necessary</span>
<a href="#l18.153"></a><span id="l18.153">   if (params)</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-    bundle-&gt;FormatStringFromName(errorCode,</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-                                 params, length, errStr);</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+    bundle-&gt;FormatStringFromName(errorCode, params, length, errStr);</span>
<a href="#l18.157"></a><span id="l18.157">   else</span>
<a href="#l18.158"></a><span id="l18.158">     bundle-&gt;GetStringFromName(errorCode, errStr);</span>
<a href="#l18.159"></a><span id="l18.159"> </span>
<a href="#l18.160"></a><span id="l18.160">   if (!errStr.IsEmpty()) {</span>
<a href="#l18.161"></a><span id="l18.161">     dialog-&gt;Alert(nullptr, errStr.get());</span>
<a href="#l18.162"></a><span id="l18.162">   }</span>
<a href="#l18.163"></a><span id="l18.163"> }</span>
<a href="#l18.164"></a><span id="l18.164"> </span>
<a href="#l18.165"></a><span id="l18.165"> SpoolLock::SpoolLock(nsACString *aSpoolName, int aSeconds,</span>
<a href="#l18.166"></a><span id="l18.166">                      nsMovemailService &amp;aMovemail,</span>
<a href="#l18.167"></a><span id="l18.167">                      nsIMsgIncomingServer *aServer)</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-: mLocked(false),</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-  mSpoolName(*aSpoolName),</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-  mOwningService(&amp;aMovemail),</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-  mServer(aServer)</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-{</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+    : mLocked(false),</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+      mSpoolName(*aSpoolName),</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+      mOwningService(&amp;aMovemail),</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+      mServer(aServer) {</span>
<a href="#l18.177"></a><span id="l18.177">   if (!ObtainSpoolLock(aSeconds)) {</span>
<a href="#l18.178"></a><span id="l18.178">     NS_ConvertUTF8toUTF16 lockFile(mSpoolName);</span>
<a href="#l18.179"></a><span id="l18.179">     lockFile.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-    const char16_t* params[] = { lockFile.get() };</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineplus">+    const char16_t *params[] = {lockFile.get()};</span>
<a href="#l18.182"></a><span id="l18.182">     mOwningService-&gt;Error(&quot;movemailCantCreateLock&quot;, params, 1);</span>
<a href="#l18.183"></a><span id="l18.183">     return;</span>
<a href="#l18.184"></a><span id="l18.184">   }</span>
<a href="#l18.185"></a><span id="l18.185">   mServer-&gt;SetServerBusy(true);</span>
<a href="#l18.186"></a><span id="l18.186">   mLocked = true;</span>
<a href="#l18.187"></a><span id="l18.187"> }</span>
<a href="#l18.188"></a><span id="l18.188"> </span>
<a href="#l18.189"></a><span id="l18.189"> SpoolLock::~SpoolLock() {</span>
<a href="#l18.190"></a><span id="l18.190">   if (mLocked &amp;&amp; !YieldSpoolLock()) {</span>
<a href="#l18.191"></a><span id="l18.191">     NS_ConvertUTF8toUTF16 lockFile(mSpoolName);</span>
<a href="#l18.192"></a><span id="l18.192">     lockFile.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-    const char16_t* params[] = { lockFile.get() };</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+    const char16_t *params[] = {lockFile.get()};</span>
<a href="#l18.195"></a><span id="l18.195">     mOwningService-&gt;Error(&quot;movemailCantDeleteLock&quot;, params, 1);</span>
<a href="#l18.196"></a><span id="l18.196">   }</span>
<a href="#l18.197"></a><span id="l18.197">   mServer-&gt;SetServerBusy(false);</span>
<a href="#l18.198"></a><span id="l18.198"> }</span>
<a href="#l18.199"></a><span id="l18.199"> </span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-bool</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-SpoolLock::isLocked() {</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineminus">-  return mLocked;</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-}</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+bool SpoolLock::isLocked() { return mLocked; }</span>
<a href="#l18.205"></a><span id="l18.205"> </span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-bool</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-SpoolLock::ObtainSpoolLock(unsigned int aSeconds /* number of seconds to retry */)</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineminus">-{</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+bool SpoolLock::ObtainSpoolLock(</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+    unsigned int aSeconds /* number of seconds to retry */) {</span>
<a href="#l18.211"></a><span id="l18.211">   /*</span>
<a href="#l18.212"></a><span id="l18.212">    * Locking procedures:</span>
<a href="#l18.213"></a><span id="l18.213">    * If the directory is not writable, we want to use the appropriate system</span>
<a href="#l18.214"></a><span id="l18.214">    * utilities to lock the file.</span>
<a href="#l18.215"></a><span id="l18.215">    * If the directory is writable, we want to go through the create-and-link</span>
<a href="#l18.216"></a><span id="l18.216">    * locking procedures to make it atomic for certain networked file systems.</span>
<a href="#l18.217"></a><span id="l18.217">    * This involves creating a .mozlock file and attempting to hard-link it to</span>
<a href="#l18.218"></a><span id="l18.218">    * the customary .lock file.</span>
<a href="#l18.219"></a><span id="l18.219">    */</span>
<a href="#l18.220"></a><span id="l18.220">   nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-  nsresult rv = NS_NewNativeLocalFile(mSpoolName,</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-                                      true,</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-                                      getter_AddRefs(spoolFile));</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+  nsresult rv =</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+      NS_NewNativeLocalFile(mSpoolName, true, getter_AddRefs(spoolFile));</span>
<a href="#l18.226"></a><span id="l18.226">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l18.227"></a><span id="l18.227"> </span>
<a href="#l18.228"></a><span id="l18.228">   nsCOMPtr&lt;nsIFile&gt; directory;</span>
<a href="#l18.229"></a><span id="l18.229">   rv = spoolFile-&gt;GetParent(getter_AddRefs(directory));</span>
<a href="#l18.230"></a><span id="l18.230">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l18.231"></a><span id="l18.231"> </span>
<a href="#l18.232"></a><span id="l18.232">   rv = directory-&gt;IsWritable(&amp;mUsingLockFile);</span>
<a href="#l18.233"></a><span id="l18.233">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineat">@@ -215,17 +193,17 @@ SpoolLock::ObtainSpoolLock(unsigned int </span>
<a href="#l18.235"></a><span id="l18.235"> </span>
<a href="#l18.236"></a><span id="l18.236">     do {</span>
<a href="#l18.237"></a><span id="l18.237">       lock_result = PR_TLockFile(fd);</span>
<a href="#l18.238"></a><span id="l18.238"> </span>
<a href="#l18.239"></a><span id="l18.239">       retry_count++;</span>
<a href="#l18.240"></a><span id="l18.240">       LOG((&quot;Attempt %d of %d to lock file&quot;, retry_count, aSeconds));</span>
<a href="#l18.241"></a><span id="l18.241">       if (aSeconds &gt; 0 &amp;&amp; lock_result == PR_FAILURE) {</span>
<a href="#l18.242"></a><span id="l18.242">         // pause 1sec, waiting for .lock to go away</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-        PRIntervalTime sleepTime = 1000; // 1 second</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+        PRIntervalTime sleepTime = 1000;  // 1 second</span>
<a href="#l18.245"></a><span id="l18.245">         PR_Sleep(sleepTime);</span>
<a href="#l18.246"></a><span id="l18.246">       }</span>
<a href="#l18.247"></a><span id="l18.247">     } while (lock_result == PR_FAILURE &amp;&amp; retry_count &lt; aSeconds);</span>
<a href="#l18.248"></a><span id="l18.248">     LOG((&quot;Lock result: %d&quot;, lock_result));</span>
<a href="#l18.249"></a><span id="l18.249">     PR_Close(fd);</span>
<a href="#l18.250"></a><span id="l18.250">     return lock_result == PR_SUCCESS;</span>
<a href="#l18.251"></a><span id="l18.251">   }</span>
<a href="#l18.252"></a><span id="l18.252">   // How to lock using files:</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineat">@@ -271,17 +249,17 @@ SpoolLock::ObtainSpoolLock(unsigned int </span>
<a href="#l18.254"></a><span id="l18.254">   do {</span>
<a href="#l18.255"></a><span id="l18.255">     link_result = link(mozlockstr.get(), lockstr.get());</span>
<a href="#l18.256"></a><span id="l18.256"> </span>
<a href="#l18.257"></a><span id="l18.257">     retry_count++;</span>
<a href="#l18.258"></a><span id="l18.258">     LOG((&quot;Attempt %d of %d to create lock file&quot;, retry_count, aSeconds));</span>
<a href="#l18.259"></a><span id="l18.259"> </span>
<a href="#l18.260"></a><span id="l18.260">     if (aSeconds &gt; 0 &amp;&amp; link_result == -1) {</span>
<a href="#l18.261"></a><span id="l18.261">       // pause 1sec, waiting for .lock to go away</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineminus">-      PRIntervalTime sleepTime = 1000; // 1 second</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+      PRIntervalTime sleepTime = 1000;  // 1 second</span>
<a href="#l18.264"></a><span id="l18.264">       PR_Sleep(sleepTime);</span>
<a href="#l18.265"></a><span id="l18.265">     }</span>
<a href="#l18.266"></a><span id="l18.266">   } while (link_result == -1 &amp;&amp; retry_count &lt; aSeconds);</span>
<a href="#l18.267"></a><span id="l18.267">   LOG((&quot;Link result: %d&quot;, link_result));</span>
<a href="#l18.268"></a><span id="l18.268"> </span>
<a href="#l18.269"></a><span id="l18.269">   // step 3: remove .mozlock file, in any case</span>
<a href="#l18.270"></a><span id="l18.270">   rv = tmplocfile-&gt;Remove(false /* non-recursive */);</span>
<a href="#l18.271"></a><span id="l18.271">   if (NS_FAILED(rv)) {</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineat">@@ -289,41 +267,37 @@ SpoolLock::ObtainSpoolLock(unsigned int </span>
<a href="#l18.273"></a><span id="l18.273">     // not fatal.</span>
<a href="#l18.274"></a><span id="l18.274">     LOG((&quot;Unable to delete %s&quot;, mozlockstr.get()));</span>
<a href="#l18.275"></a><span id="l18.275">   }</span>
<a href="#l18.276"></a><span id="l18.276"> </span>
<a href="#l18.277"></a><span id="l18.277">   // step 4: now we know whether we succeeded or failed</span>
<a href="#l18.278"></a><span id="l18.278">   return link_result == 0;</span>
<a href="#l18.279"></a><span id="l18.279"> }</span>
<a href="#l18.280"></a><span id="l18.280"> </span>
<a href="#l18.281"></a><span id="l18.281" class="difflineminus">-</span>
<a href="#l18.282"></a><span id="l18.282"> /**</span>
<a href="#l18.283"></a><span id="l18.283">  * Remove our mail-spool-file lock (n.b. we should only try this if</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">- * we're the ones who made the lock in the first place! I.e. if mLocked is true.)</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+ * we're the ones who made the lock in the first place! I.e. if mLocked is</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineplus">+ * true.)</span>
<a href="#l18.287"></a><span id="l18.287">  */</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-bool</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-SpoolLock::YieldSpoolLock()</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-{</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+bool SpoolLock::YieldSpoolLock() {</span>
<a href="#l18.292"></a><span id="l18.292">   LOG((&quot;YieldSpoolLock(%s)&quot;, mSpoolName.get()));</span>
<a href="#l18.293"></a><span id="l18.293"> </span>
<a href="#l18.294"></a><span id="l18.294">   if (!mUsingLockFile) {</span>
<a href="#l18.295"></a><span id="l18.295">     nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineminus">-    nsresult rv = NS_NewNativeLocalFile(mSpoolName,</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-                                        true,</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineminus">-                                        getter_AddRefs(spoolFile));</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineplus">+    nsresult rv =</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineplus">+        NS_NewNativeLocalFile(mSpoolName, true, getter_AddRefs(spoolFile));</span>
<a href="#l18.301"></a><span id="l18.301">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l18.302"></a><span id="l18.302"> </span>
<a href="#l18.303"></a><span id="l18.303">     PRFileDesc *fd;</span>
<a href="#l18.304"></a><span id="l18.304">     rv = spoolFile-&gt;OpenNSPRFileDesc(PR_RDWR, 0, &amp;fd);</span>
<a href="#l18.305"></a><span id="l18.305">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l18.306"></a><span id="l18.306"> </span>
<a href="#l18.307"></a><span id="l18.307">     bool unlockSucceeded = PR_UnlockFile(fd) == PR_SUCCESS;</span>
<a href="#l18.308"></a><span id="l18.308">     PR_Close(fd);</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineminus">-    if (unlockSucceeded)</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-      LOG((&quot;YieldSpoolLock was successful.&quot;));</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineplus">+    if (unlockSucceeded) LOG((&quot;YieldSpoolLock was successful.&quot;));</span>
<a href="#l18.312"></a><span id="l18.312">     return unlockSucceeded;</span>
<a href="#l18.313"></a><span id="l18.313">   }</span>
<a href="#l18.314"></a><span id="l18.314"> </span>
<a href="#l18.315"></a><span id="l18.315">   nsAutoCString lockstr(mSpoolName);</span>
<a href="#l18.316"></a><span id="l18.316">   lockstr.AppendLiteral(LOCK_SUFFIX);</span>
<a href="#l18.317"></a><span id="l18.317"> </span>
<a href="#l18.318"></a><span id="l18.318">   nsresult rv;</span>
<a href="#l18.319"></a><span id="l18.319"> </span>
<a href="#l18.320"></a><span id="l18.320" class="difflineat">@@ -344,39 +318,34 @@ SpoolLock::YieldSpoolLock()</span>
<a href="#l18.321"></a><span id="l18.321">   }</span>
<a href="#l18.322"></a><span id="l18.322"> </span>
<a href="#l18.323"></a><span id="l18.323">   LOG((&quot;YieldSpoolLock was successful.&quot;));</span>
<a href="#l18.324"></a><span id="l18.324"> </span>
<a href="#l18.325"></a><span id="l18.325">   // Success.</span>
<a href="#l18.326"></a><span id="l18.326">   return true;</span>
<a href="#l18.327"></a><span id="l18.327"> }</span>
<a href="#l18.328"></a><span id="l18.328"> </span>
<a href="#l18.329"></a><span id="l18.329" class="difflineminus">-static nsresult</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineminus">-LocateSpoolFile(nsACString &amp; spoolPath)</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineminus">-{</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineplus">+static nsresult LocateSpoolFile(nsACString &amp;spoolPath) {</span>
<a href="#l18.333"></a><span id="l18.333">   bool isFile;</span>
<a href="#l18.334"></a><span id="l18.334">   nsresult rv;</span>
<a href="#l18.335"></a><span id="l18.335"> </span>
<a href="#l18.336"></a><span id="l18.336">   nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l18.337"></a><span id="l18.337">   rv = NS_NewNativeLocalFile(EmptyCString(), true, getter_AddRefs(spoolFile));</span>
<a href="#l18.338"></a><span id="l18.338">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.339"></a><span id="l18.339"> </span>
<a href="#l18.340"></a><span id="l18.340" class="difflineminus">-  char * mailEnv = PR_GetEnv(&quot;MAIL&quot;);</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineminus">-  char * userEnv = PR_GetEnv(&quot;USER&quot;);</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineminus">-  if (!userEnv)</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineminus">-    userEnv = PR_GetEnv(&quot;USERNAME&quot;);</span>
<a href="#l18.344"></a><span id="l18.344" class="difflineplus">+  char *mailEnv = PR_GetEnv(&quot;MAIL&quot;);</span>
<a href="#l18.345"></a><span id="l18.345" class="difflineplus">+  char *userEnv = PR_GetEnv(&quot;USER&quot;);</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineplus">+  if (!userEnv) userEnv = PR_GetEnv(&quot;USERNAME&quot;);</span>
<a href="#l18.347"></a><span id="l18.347"> </span>
<a href="#l18.348"></a><span id="l18.348">   if (mailEnv) {</span>
<a href="#l18.349"></a><span id="l18.349">     rv = spoolFile-&gt;InitWithNativePath(nsDependentCString(mailEnv));</span>
<a href="#l18.350"></a><span id="l18.350">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.351"></a><span id="l18.351">     rv = spoolFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isFile)</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-      spoolPath = mailEnv;</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-  }</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-  else if (userEnv) {</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isFile) spoolPath = mailEnv;</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineplus">+  } else if (userEnv) {</span>
<a href="#l18.358"></a><span id="l18.358">     // Try to build the mailbox path from the username and a number</span>
<a href="#l18.359"></a><span id="l18.359">     // of guessed spool directory paths.</span>
<a href="#l18.360"></a><span id="l18.360">     nsAutoCString tmpPath;</span>
<a href="#l18.361"></a><span id="l18.361">     uint32_t i;</span>
<a href="#l18.362"></a><span id="l18.362">     for (i = 0; i &lt; NUM_DEFAULT_SPOOL_PATHS; i++) {</span>
<a href="#l18.363"></a><span id="l18.363">       tmpPath = gDefaultSpoolPaths[i];</span>
<a href="#l18.364"></a><span id="l18.364">       tmpPath += userEnv;</span>
<a href="#l18.365"></a><span id="l18.365">       rv = spoolFile-&gt;InitWithNativePath(tmpPath);</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineat">@@ -387,63 +356,59 @@ LocateSpoolFile(nsACString &amp; spoolPath)</span>
<a href="#l18.367"></a><span id="l18.367">         break;</span>
<a href="#l18.368"></a><span id="l18.368">       }</span>
<a href="#l18.369"></a><span id="l18.369">     }</span>
<a href="#l18.370"></a><span id="l18.370">   }</span>
<a href="#l18.371"></a><span id="l18.371"> </span>
<a href="#l18.372"></a><span id="l18.372">   return rv;</span>
<a href="#l18.373"></a><span id="l18.373"> }</span>
<a href="#l18.374"></a><span id="l18.374"> </span>
<a href="#l18.375"></a><span id="l18.375" class="difflineminus">-nsresult</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineminus">-nsMovemailService::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-                              nsIUrlListener* /* aUrlListener */,</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-                              nsIMsgFolder* /* aMsgFolder */,</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-                              nsIMovemailIncomingServer *aMovemailServer,</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-                              nsIURI ** /* aURL */)</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-{</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineplus">+nsresult nsMovemailService::GetNewMail(</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener * /* aUrlListener */,</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineplus">+    nsIMsgFolder * /* aMsgFolder */, nsIMovemailIncomingServer *aMovemailServer,</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineplus">+    nsIURI ** /* aURL */) {</span>
<a href="#l18.386"></a><span id="l18.386">   LOG((&quot;nsMovemailService::GetNewMail&quot;));</span>
<a href="#l18.387"></a><span id="l18.387"> </span>
<a href="#l18.388"></a><span id="l18.388">   NS_ENSURE_ARG_POINTER(aMovemailServer);</span>
<a href="#l18.389"></a><span id="l18.389">   // It is OK if aMsgWindow is null.</span>
<a href="#l18.390"></a><span id="l18.390">   mMsgWindow = aMsgWindow;</span>
<a href="#l18.391"></a><span id="l18.391"> </span>
<a href="#l18.392"></a><span id="l18.392">   nsresult rv;</span>
<a href="#l18.393"></a><span id="l18.393"> </span>
<a href="#l18.394"></a><span id="l18.394">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in_server =</span>
<a href="#l18.395"></a><span id="l18.395">       do_QueryInterface(aMovemailServer, &amp;rv);</span>
<a href="#l18.396"></a><span id="l18.396">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; in_server,</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineminus">-    NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineplus">+                 NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l18.399"></a><span id="l18.399"> </span>
<a href="#l18.400"></a><span id="l18.400">   // Attempt to locate the mail spool file</span>
<a href="#l18.401"></a><span id="l18.401">   nsAutoCString spoolPath;</span>
<a href="#l18.402"></a><span id="l18.402">   rv = in_server-&gt;GetCharValue(&quot;spoolDir&quot;, spoolPath);</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineminus">-  if (NS_FAILED(rv) || spoolPath.IsEmpty())</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineminus">-    rv = LocateSpoolFile(spoolPath);</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineplus">+  if (NS_FAILED(rv) || spoolPath.IsEmpty()) rv = LocateSpoolFile(spoolPath);</span>
<a href="#l18.406"></a><span id="l18.406">   if (NS_FAILED(rv) || spoolPath.IsEmpty()) {</span>
<a href="#l18.407"></a><span id="l18.407">     Error(&quot;movemailSpoolFileNotFound&quot;, nullptr, 0);</span>
<a href="#l18.408"></a><span id="l18.408">     return NS_ERROR_FAILURE;</span>
<a href="#l18.409"></a><span id="l18.409">   }</span>
<a href="#l18.410"></a><span id="l18.410"> </span>
<a href="#l18.411"></a><span id="l18.411">   NS_ConvertUTF8toUTF16 wideSpoolPath(spoolPath);</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineminus">-  const char16_t* spoolPathString[] = { wideSpoolPath.get() };</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineplus">+  const char16_t *spoolPathString[] = {wideSpoolPath.get()};</span>
<a href="#l18.414"></a><span id="l18.414"> </span>
<a href="#l18.415"></a><span id="l18.415">   // Create an input stream for the spool file</span>
<a href="#l18.416"></a><span id="l18.416">   nsCOMPtr&lt;nsIFile&gt; spoolFile;</span>
<a href="#l18.417"></a><span id="l18.417">   rv = NS_NewNativeLocalFile(spoolPath, true, getter_AddRefs(spoolFile));</span>
<a href="#l18.418"></a><span id="l18.418">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.419"></a><span id="l18.419">   nsCOMPtr&lt;nsIInputStream&gt; spoolInputStream;</span>
<a href="#l18.420"></a><span id="l18.420">   rv = NS_NewLocalFileInputStream(getter_AddRefs(spoolInputStream), spoolFile);</span>
<a href="#l18.421"></a><span id="l18.421">   if (NS_FAILED(rv)) {</span>
<a href="#l18.422"></a><span id="l18.422">     Error(&quot;movemailCantOpenSpoolFile&quot;, spoolPathString, 1);</span>
<a href="#l18.423"></a><span id="l18.423">     return rv;</span>
<a href="#l18.424"></a><span id="l18.424">   }</span>
<a href="#l18.425"></a><span id="l18.425"> </span>
<a href="#l18.426"></a><span id="l18.426">   // Get a line input interface for the spool file</span>
<a href="#l18.427"></a><span id="l18.427">   nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream =</span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-    do_QueryInterface(spoolInputStream, &amp;rv);</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineplus">+      do_QueryInterface(spoolInputStream, &amp;rv);</span>
<a href="#l18.430"></a><span id="l18.430">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; lineInputStream, rv);</span>
<a href="#l18.431"></a><span id="l18.431"> </span>
<a href="#l18.432"></a><span id="l18.432">   nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l18.433"></a><span id="l18.433">   nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l18.434"></a><span id="l18.434"> </span>
<a href="#l18.435"></a><span id="l18.435">   rv = in_server-&gt;GetRootFolder(getter_AddRefs(serverFolder));</span>
<a href="#l18.436"></a><span id="l18.436">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.437"></a><span id="l18.437"> </span>
<a href="#l18.438"></a><span id="l18.438" class="difflineat">@@ -455,29 +420,26 @@ nsMovemailService::GetNewMail(nsIMsgWind</span>
<a href="#l18.439"></a><span id="l18.439">   rv = in_server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l18.440"></a><span id="l18.440">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.441"></a><span id="l18.441"> </span>
<a href="#l18.442"></a><span id="l18.442">   // create a new mail parser</span>
<a href="#l18.443"></a><span id="l18.443">   RefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l18.444"></a><span id="l18.444"> </span>
<a href="#l18.445"></a><span id="l18.445">   // Try and obtain the lock for the spool file.</span>
<a href="#l18.446"></a><span id="l18.446">   SpoolLock lock(&amp;spoolPath, 5, *this, in_server);</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineminus">-  if (!lock.isLocked())</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineplus">+  if (!lock.isLocked()) return NS_ERROR_FAILURE;</span>
<a href="#l18.450"></a><span id="l18.450"> </span>
<a href="#l18.451"></a><span id="l18.451">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l18.452"></a><span id="l18.452">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l18.453"></a><span id="l18.453"> </span>
<a href="#l18.454"></a><span id="l18.454">   // MIDDLE of the FUN : consume the mailbox data.</span>
<a href="#l18.455"></a><span id="l18.455">   bool isMore = true;</span>
<a href="#l18.456"></a><span id="l18.456">   nsAutoCString buffer;</span>
<a href="#l18.457"></a><span id="l18.457">   uint32_t bytesWritten = 0;</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-  while (isMore &amp;&amp;</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-         NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore)))</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-  {</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineplus">+  while (isMore &amp;&amp; NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore))) {</span>
<a href="#l18.462"></a><span id="l18.462">     // If first string is empty and we're now at EOF then abort parsing.</span>
<a href="#l18.463"></a><span id="l18.463">     if (buffer.IsEmpty() &amp;&amp; !isMore &amp;&amp; !bytesWritten) {</span>
<a href="#l18.464"></a><span id="l18.464">       LOG((&quot;Empty spool file&quot;));</span>
<a href="#l18.465"></a><span id="l18.465">       break;</span>
<a href="#l18.466"></a><span id="l18.466">     }</span>
<a href="#l18.467"></a><span id="l18.467"> </span>
<a href="#l18.468"></a><span id="l18.468">     buffer.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l18.469"></a><span id="l18.469"> </span>
<a href="#l18.470"></a><span id="l18.470" class="difflineat">@@ -487,21 +449,22 @@ nsMovemailService::GetNewMail(nsIMsgWind</span>
<a href="#l18.471"></a><span id="l18.471">         outputStream-&gt;Flush();</span>
<a href="#l18.472"></a><span id="l18.472">         newMailParser-&gt;PublishMsgHeader(nullptr);</span>
<a href="#l18.473"></a><span id="l18.473">         rv = msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l18.474"></a><span id="l18.474">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.475"></a><span id="l18.475">         newMailParser-&gt;Clear();</span>
<a href="#l18.476"></a><span id="l18.476">       }</span>
<a href="#l18.477"></a><span id="l18.477">       bool reusable;</span>
<a href="#l18.478"></a><span id="l18.478">       rv = msgStore-&gt;GetNewMsgOutputStream(inbox, getter_AddRefs(newHdr),</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-                                           &amp;reusable, getter_AddRefs(outputStream));</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineplus">+                                           &amp;reusable,</span>
<a href="#l18.481"></a><span id="l18.481" class="difflineplus">+                                           getter_AddRefs(outputStream));</span>
<a href="#l18.482"></a><span id="l18.482">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.483"></a><span id="l18.483"> </span>
<a href="#l18.484"></a><span id="l18.484" class="difflineminus">-      rv = newMailParser-&gt;Init(serverFolder, inbox,</span>
<a href="#l18.485"></a><span id="l18.485" class="difflineminus">-                               nullptr, newHdr, outputStream);</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineplus">+      rv = newMailParser-&gt;Init(serverFolder, inbox, nullptr, newHdr,</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineplus">+                               outputStream);</span>
<a href="#l18.488"></a><span id="l18.488">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.489"></a><span id="l18.489">     }</span>
<a href="#l18.490"></a><span id="l18.490">     if (!outputStream) {</span>
<a href="#l18.491"></a><span id="l18.491">       // If we do not have outputStream here, something bad happened.</span>
<a href="#l18.492"></a><span id="l18.492">       // We probably didn't find the proper message start delimiter &quot;From &quot;</span>
<a href="#l18.493"></a><span id="l18.493">       // and are now reading in the middle of a message. Bail out.</span>
<a href="#l18.494"></a><span id="l18.494">       Error(&quot;movemailCantParseSpool&quot;, spoolPathString, 1);</span>
<a href="#l18.495"></a><span id="l18.495">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l18.496"></a><span id="l18.496" class="difflineat">@@ -540,143 +503,128 @@ nsMovemailService::GetNewMail(nsIMsgWind</span>
<a href="#l18.497"></a><span id="l18.497">   if (NS_FAILED(rv)) {</span>
<a href="#l18.498"></a><span id="l18.498">     Error(&quot;movemailCantTruncateSpoolFile&quot;, spoolPathString, 1);</span>
<a href="#l18.499"></a><span id="l18.499">   }</span>
<a href="#l18.500"></a><span id="l18.500"> </span>
<a href="#l18.501"></a><span id="l18.501">   LOG((&quot;GetNewMail returning rv=%&quot; PRIx32, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l18.502"></a><span id="l18.502">   return rv;</span>
<a href="#l18.503"></a><span id="l18.503"> }</span>
<a href="#l18.504"></a><span id="l18.504"> </span>
<a href="#l18.505"></a><span id="l18.505" class="difflineminus">-</span>
<a href="#l18.506"></a><span id="l18.506"> NS_IMETHODIMP</span>
<a href="#l18.507"></a><span id="l18.507" class="difflineminus">-nsMovemailService::SetDefaultLocalPath(nsIFile *aPath)</span>
<a href="#l18.508"></a><span id="l18.508" class="difflineminus">-{</span>
<a href="#l18.509"></a><span id="l18.509" class="difflineplus">+nsMovemailService::SetDefaultLocalPath(nsIFile *aPath) {</span>
<a href="#l18.510"></a><span id="l18.510">   NS_ENSURE_ARG(aPath);</span>
<a href="#l18.511"></a><span id="l18.511" class="difflineminus">-  return NS_SetPersistentFile(PREF_MAIL_ROOT_MOVEMAIL_REL, PREF_MAIL_ROOT_MOVEMAIL, aPath);</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineplus">+  return NS_SetPersistentFile(PREF_MAIL_ROOT_MOVEMAIL_REL,</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineplus">+                              PREF_MAIL_ROOT_MOVEMAIL, aPath);</span>
<a href="#l18.514"></a><span id="l18.514"> }</span>
<a href="#l18.515"></a><span id="l18.515"> </span>
<a href="#l18.516"></a><span id="l18.516"> NS_IMETHODIMP</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineminus">-nsMovemailService::GetDefaultLocalPath(nsIFile ** aResult)</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-{</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineplus">+nsMovemailService::GetDefaultLocalPath(nsIFile **aResult) {</span>
<a href="#l18.520"></a><span id="l18.520">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l18.521"></a><span id="l18.521">   *aResult = nullptr;</span>
<a href="#l18.522"></a><span id="l18.522"> </span>
<a href="#l18.523"></a><span id="l18.523">   nsresult rv;</span>
<a href="#l18.524"></a><span id="l18.524">   bool havePref;</span>
<a href="#l18.525"></a><span id="l18.525">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l18.526"></a><span id="l18.526">   rv = NS_GetPersistentFile(PREF_MAIL_ROOT_MOVEMAIL_REL,</span>
<a href="#l18.527"></a><span id="l18.527" class="difflineminus">-                            PREF_MAIL_ROOT_MOVEMAIL,</span>
<a href="#l18.528"></a><span id="l18.528" class="difflineminus">-                            NS_APP_MAIL_50_DIR,</span>
<a href="#l18.529"></a><span id="l18.529" class="difflineminus">-                            havePref,</span>
<a href="#l18.530"></a><span id="l18.530" class="difflineminus">-                            getter_AddRefs(localFile));</span>
<a href="#l18.531"></a><span id="l18.531" class="difflineplus">+                            PREF_MAIL_ROOT_MOVEMAIL, NS_APP_MAIL_50_DIR,</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineplus">+                            havePref, getter_AddRefs(localFile));</span>
<a href="#l18.533"></a><span id="l18.533">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.534"></a><span id="l18.534"> </span>
<a href="#l18.535"></a><span id="l18.535">   bool exists;</span>
<a href="#l18.536"></a><span id="l18.536">   rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l18.537"></a><span id="l18.537">   if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l18.538"></a><span id="l18.538">     rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l18.539"></a><span id="l18.539">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.540"></a><span id="l18.540"> </span>
<a href="#l18.541"></a><span id="l18.541">   if (!havePref || !exists) {</span>
<a href="#l18.542"></a><span id="l18.542" class="difflineminus">-    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_MOVEMAIL_REL, PREF_MAIL_ROOT_MOVEMAIL, localFile);</span>
<a href="#l18.543"></a><span id="l18.543" class="difflineplus">+    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_MOVEMAIL_REL,</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineplus">+                              PREF_MAIL_ROOT_MOVEMAIL, localFile);</span>
<a href="#l18.545"></a><span id="l18.545">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l18.546"></a><span id="l18.546">   }</span>
<a href="#l18.547"></a><span id="l18.547"> </span>
<a href="#l18.548"></a><span id="l18.548">   localFile.forget(aResult);</span>
<a href="#l18.549"></a><span id="l18.549">   return NS_OK;</span>
<a href="#l18.550"></a><span id="l18.550"> }</span>
<a href="#l18.551"></a><span id="l18.551"> </span>
<a href="#l18.552"></a><span id="l18.552" class="difflineminus">-</span>
<a href="#l18.553"></a><span id="l18.553"> NS_IMETHODIMP</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineminus">-nsMovemailService::GetServerIID(nsIID* *aServerIID)</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineminus">-{</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineplus">+nsMovemailService::GetServerIID(nsIID **aServerIID) {</span>
<a href="#l18.557"></a><span id="l18.557">   *aServerIID = new nsIID(NS_GET_IID(nsIMovemailIncomingServer));</span>
<a href="#l18.558"></a><span id="l18.558">   return NS_OK;</span>
<a href="#l18.559"></a><span id="l18.559"> }</span>
<a href="#l18.560"></a><span id="l18.560"> </span>
<a href="#l18.561"></a><span id="l18.561"> NS_IMETHODIMP</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineminus">-nsMovemailService::GetRequiresUsername(bool *aRequiresUsername)</span>
<a href="#l18.563"></a><span id="l18.563" class="difflineminus">-{</span>
<a href="#l18.564"></a><span id="l18.564" class="difflineplus">+nsMovemailService::GetRequiresUsername(bool *aRequiresUsername) {</span>
<a href="#l18.565"></a><span id="l18.565">   NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l18.566"></a><span id="l18.566">   *aRequiresUsername = false;</span>
<a href="#l18.567"></a><span id="l18.567">   return NS_OK;</span>
<a href="#l18.568"></a><span id="l18.568"> }</span>
<a href="#l18.569"></a><span id="l18.569"> </span>
<a href="#l18.570"></a><span id="l18.570"> NS_IMETHODIMP</span>
<a href="#l18.571"></a><span id="l18.571" class="difflineminus">-nsMovemailService::GetPreflightPrettyNameWithEmailAddress(bool *aPreflightPrettyNameWithEmailAddress)</span>
<a href="#l18.572"></a><span id="l18.572" class="difflineminus">-{</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineplus">+nsMovemailService::GetPreflightPrettyNameWithEmailAddress(</span>
<a href="#l18.574"></a><span id="l18.574" class="difflineplus">+    bool *aPreflightPrettyNameWithEmailAddress) {</span>
<a href="#l18.575"></a><span id="l18.575">   NS_ENSURE_ARG_POINTER(aPreflightPrettyNameWithEmailAddress);</span>
<a href="#l18.576"></a><span id="l18.576">   *aPreflightPrettyNameWithEmailAddress = true;</span>
<a href="#l18.577"></a><span id="l18.577">   return NS_OK;</span>
<a href="#l18.578"></a><span id="l18.578"> }</span>
<a href="#l18.579"></a><span id="l18.579"> </span>
<a href="#l18.580"></a><span id="l18.580"> NS_IMETHODIMP</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineminus">-nsMovemailService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp)</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineminus">-{</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineplus">+nsMovemailService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp) {</span>
<a href="#l18.584"></a><span id="l18.584">   NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l18.585"></a><span id="l18.585">   *aCanLoginAtStartUp = true;</span>
<a href="#l18.586"></a><span id="l18.586">   return NS_OK;</span>
<a href="#l18.587"></a><span id="l18.587"> }</span>
<a href="#l18.588"></a><span id="l18.588"> </span>
<a href="#l18.589"></a><span id="l18.589"> NS_IMETHODIMP</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineminus">-nsMovemailService::GetCanDelete(bool *aCanDelete)</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineminus">-{</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineplus">+nsMovemailService::GetCanDelete(bool *aCanDelete) {</span>
<a href="#l18.593"></a><span id="l18.593">   NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l18.594"></a><span id="l18.594">   *aCanDelete = true;</span>
<a href="#l18.595"></a><span id="l18.595">   return NS_OK;</span>
<a href="#l18.596"></a><span id="l18.596"> }</span>
<a href="#l18.597"></a><span id="l18.597"> </span>
<a href="#l18.598"></a><span id="l18.598"> NS_IMETHODIMP</span>
<a href="#l18.599"></a><span id="l18.599" class="difflineminus">-nsMovemailService::GetCanGetMessages(bool *aCanGetMessages)</span>
<a href="#l18.600"></a><span id="l18.600" class="difflineminus">-{</span>
<a href="#l18.601"></a><span id="l18.601" class="difflineplus">+nsMovemailService::GetCanGetMessages(bool *aCanGetMessages) {</span>
<a href="#l18.602"></a><span id="l18.602">   NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l18.603"></a><span id="l18.603">   *aCanGetMessages = true;</span>
<a href="#l18.604"></a><span id="l18.604">   return NS_OK;</span>
<a href="#l18.605"></a><span id="l18.605"> }</span>
<a href="#l18.606"></a><span id="l18.606"> </span>
<a href="#l18.607"></a><span id="l18.607"> NS_IMETHODIMP</span>
<a href="#l18.608"></a><span id="l18.608" class="difflineminus">-nsMovemailService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages)</span>
<a href="#l18.609"></a><span id="l18.609" class="difflineminus">-{</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineplus">+nsMovemailService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages) {</span>
<a href="#l18.611"></a><span id="l18.611">   NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l18.612"></a><span id="l18.612">   *aCanGetIncomingMessages = true;</span>
<a href="#l18.613"></a><span id="l18.613">   return NS_OK;</span>
<a href="#l18.614"></a><span id="l18.614"> }</span>
<a href="#l18.615"></a><span id="l18.615"> </span>
<a href="#l18.616"></a><span id="l18.616"> NS_IMETHODIMP</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineminus">-nsMovemailService::GetCanDuplicate(bool *aCanDuplicate)</span>
<a href="#l18.618"></a><span id="l18.618" class="difflineminus">-{</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineplus">+nsMovemailService::GetCanDuplicate(bool *aCanDuplicate) {</span>
<a href="#l18.620"></a><span id="l18.620">   NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l18.621"></a><span id="l18.621">   *aCanDuplicate = false;</span>
<a href="#l18.622"></a><span id="l18.622">   return NS_OK;</span>
<a href="#l18.623"></a><span id="l18.623"> }</span>
<a href="#l18.624"></a><span id="l18.624"> </span>
<a href="#l18.625"></a><span id="l18.625"> NS_IMETHODIMP</span>
<a href="#l18.626"></a><span id="l18.626" class="difflineminus">-nsMovemailService::GetDefaultDoBiff(bool *aDoBiff)</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineminus">-{</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineplus">+nsMovemailService::GetDefaultDoBiff(bool *aDoBiff) {</span>
<a href="#l18.629"></a><span id="l18.629">   NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l18.630"></a><span id="l18.630">   // by default, do biff for movemail</span>
<a href="#l18.631"></a><span id="l18.631">   *aDoBiff = true;</span>
<a href="#l18.632"></a><span id="l18.632">   return NS_OK;</span>
<a href="#l18.633"></a><span id="l18.633"> }</span>
<a href="#l18.634"></a><span id="l18.634"> </span>
<a href="#l18.635"></a><span id="l18.635"> NS_IMETHODIMP</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineminus">-nsMovemailService::GetDefaultServerPort(bool isSecure, int32_t *aDefaultPort)</span>
<a href="#l18.637"></a><span id="l18.637" class="difflineminus">-{</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineplus">+nsMovemailService::GetDefaultServerPort(bool isSecure, int32_t *aDefaultPort) {</span>
<a href="#l18.639"></a><span id="l18.639">   NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l18.640"></a><span id="l18.640">   *aDefaultPort = -1;</span>
<a href="#l18.641"></a><span id="l18.641">   return NS_OK;</span>
<a href="#l18.642"></a><span id="l18.642"> }</span>
<a href="#l18.643"></a><span id="l18.643"> </span>
<a href="#l18.644"></a><span id="l18.644"> NS_IMETHODIMP</span>
<a href="#l18.645"></a><span id="l18.645" class="difflineminus">-nsMovemailService::GetShowComposeMsgLink(bool *showComposeMsgLink)</span>
<a href="#l18.646"></a><span id="l18.646" class="difflineminus">-{</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineplus">+nsMovemailService::GetShowComposeMsgLink(bool *showComposeMsgLink) {</span>
<a href="#l18.648"></a><span id="l18.648">   NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l18.649"></a><span id="l18.649">   *showComposeMsgLink = true;</span>
<a href="#l18.650"></a><span id="l18.650">   return NS_OK;</span>
<a href="#l18.651"></a><span id="l18.651"> }</span>
<a href="#l18.652"></a><span id="l18.652"> </span>
<a href="#l18.653"></a><span id="l18.653"> NS_IMETHODIMP</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineminus">-nsMovemailService::GetFoldersCreatedAsync(bool *aAsyncCreation)</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineminus">-{</span>
<a href="#l18.656"></a><span id="l18.656" class="difflineplus">+nsMovemailService::GetFoldersCreatedAsync(bool *aAsyncCreation) {</span>
<a href="#l18.657"></a><span id="l18.657">   NS_ENSURE_ARG_POINTER(aAsyncCreation);</span>
<a href="#l18.658"></a><span id="l18.658">   *aAsyncCreation = false;</span>
<a href="#l18.659"></a><span id="l18.659">   return NS_OK;</span>
<a href="#l18.660"></a><span id="l18.660"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -8,25 +8,24 @@</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nscore.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIMovemailService.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-class nsMovemailService : public nsIMsgProtocolInfo, public nsIMovemailService</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-public:</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+class nsMovemailService : public nsIMsgProtocolInfo, public nsIMovemailService {</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+ public:</span>
<a href="#l19.17"></a><span id="l19.17">   nsMovemailService();</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">   NS_DECL_ISUPPORTS</span>
<a href="#l19.20"></a><span id="l19.20">   NS_DECL_NSIMOVEMAILSERVICE</span>
<a href="#l19.21"></a><span id="l19.21">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-  void Error(const char* errorCode, const char16_t **params, uint32_t length);</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+  void Error(const char* errorCode, const char16_t** params, uint32_t length);</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-private:</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+ private:</span>
<a href="#l19.28"></a><span id="l19.28">   virtual ~nsMovemailService();</span>
<a href="#l19.29"></a><span id="l19.29">   nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l19.30"></a><span id="l19.30"> };</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32"> #endif /* nsMovemailService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/local/src/nsMsgBrkMBoxStore.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgBrkMBoxStore.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -31,190 +31,170 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsParseMailbox.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsIMailboxService.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsIMsgFolderCompactor.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;prprf.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#include &lt;cstdlib&gt; // for std::abs(int/long)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-#include &lt;cmath&gt; // for std::abs(float/double)</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+#include &lt;cstdlib&gt;  // for std::abs(int/long)</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+#include &lt;cmath&gt;    // for std::abs(float/double)</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-nsMsgBrkMBoxStore::nsMsgBrkMBoxStore()</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-{</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-}</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+nsMsgBrkMBoxStore::nsMsgBrkMBoxStore() {}</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-nsMsgBrkMBoxStore::~nsMsgBrkMBoxStore()</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-{</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-}</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+nsMsgBrkMBoxStore::~nsMsgBrkMBoxStore() {}</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27"> NS_IMPL_ISUPPORTS(nsMsgBrkMBoxStore, nsIMsgPluggableStore)</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29"> NS_IMETHODIMP nsMsgBrkMBoxStore::DiscoverSubFolders(nsIMsgFolder *aParentFolder,</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-                                                    bool aDeep)</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-{</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+                                                    bool aDeep) {</span>
<a href="#l20.33"></a><span id="l20.33">   NS_ENSURE_ARG_POINTER(aParentFolder);</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l20.36"></a><span id="l20.36">   nsresult rv = aParentFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-    return rv;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41">   bool exists;</span>
<a href="#l20.42"></a><span id="l20.42">   path-&gt;Exists(&amp;exists);</span>
<a href="#l20.43"></a><span id="l20.43">   if (!exists) {</span>
<a href="#l20.44"></a><span id="l20.44">     rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l20.45"></a><span id="l20.45">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.46"></a><span id="l20.46">   }</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48">   return AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l20.49"></a><span id="l20.49"> }</span>
<a href="#l20.50"></a><span id="l20.50"> </span>
<a href="#l20.51"></a><span id="l20.51"> NS_IMETHODIMP nsMsgBrkMBoxStore::CreateFolder(nsIMsgFolder *aParent,</span>
<a href="#l20.52"></a><span id="l20.52">                                               const nsAString &amp;aFolderName,</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-                                              nsIMsgFolder **aResult)</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-{</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+                                              nsIMsgFolder **aResult) {</span>
<a href="#l20.56"></a><span id="l20.56">   NS_ENSURE_ARG_POINTER(aParent);</span>
<a href="#l20.57"></a><span id="l20.57">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-  if (aFolderName.IsEmpty())</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-    return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+  if (aFolderName.IsEmpty()) return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l20.63"></a><span id="l20.63">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l20.64"></a><span id="l20.64">   nsresult rv = aParent-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-    return rv;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-  //Get a directory based on our current path.</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+  // Get a directory based on our current path.</span>
<a href="#l20.70"></a><span id="l20.70">   rv = CreateDirectoryForFolder(path);</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-    return rv;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.74"></a><span id="l20.74"> </span>
<a href="#l20.75"></a><span id="l20.75">   // Now we have a valid directory or we have returned.</span>
<a href="#l20.76"></a><span id="l20.76">   // Make sure the new folder name is valid</span>
<a href="#l20.77"></a><span id="l20.77">   nsAutoString safeFolderName(aFolderName);</span>
<a href="#l20.78"></a><span id="l20.78">   NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l20.79"></a><span id="l20.79"> </span>
<a href="#l20.80"></a><span id="l20.80">   path-&gt;Append(safeFolderName);</span>
<a href="#l20.81"></a><span id="l20.81">   bool exists;</span>
<a href="#l20.82"></a><span id="l20.82">   path-&gt;Exists(&amp;exists);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-  if (exists) //check this because localized names are different from disk names</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+  if (exists)  // check this because localized names are different from disk</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+               // names</span>
<a href="#l20.86"></a><span id="l20.86">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l20.87"></a><span id="l20.87"> </span>
<a href="#l20.88"></a><span id="l20.88">   rv = path-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l20.89"></a><span id="l20.89">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.90"></a><span id="l20.90"> </span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-  //GetFlags and SetFlags in AddSubfolder will fail because we have no db at</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+  // GetFlags and SetFlags in AddSubfolder will fail because we have no db at</span>
<a href="#l20.93"></a><span id="l20.93">   // this point but mFlags is set.</span>
<a href="#l20.94"></a><span id="l20.94">   rv = aParent-&gt;AddSubfolder(safeFolderName, getter_AddRefs(child));</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-  if (!child || NS_FAILED(rv))</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-  {</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+  if (!child || NS_FAILED(rv)) {</span>
<a href="#l20.98"></a><span id="l20.98">     path-&gt;Remove(false);</span>
<a href="#l20.99"></a><span id="l20.99">     return rv;</span>
<a href="#l20.100"></a><span id="l20.100">   }</span>
<a href="#l20.101"></a><span id="l20.101">   // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l20.102"></a><span id="l20.102">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-    do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-  if (msgDBService)</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-  {</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+  if (msgDBService) {</span>
<a href="#l20.108"></a><span id="l20.108">     nsCOMPtr&lt;nsIMsgDatabase&gt; unusedDB;</span>
<a href="#l20.109"></a><span id="l20.109">     rv = msgDBService-&gt;OpenFolderDB(child, true, getter_AddRefs(unusedDB));</span>
<a href="#l20.110"></a><span id="l20.110">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l20.111"></a><span id="l20.111">       rv = msgDBService-&gt;CreateNewDB(child, getter_AddRefs(unusedDB));</span>
<a href="#l20.112"></a><span id="l20.112"> </span>
<a href="#l20.113"></a><span id="l20.113">     if ((NS_SUCCEEDED(rv) || rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) &amp;&amp;</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-        unusedDB)</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineminus">-    {</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineminus">-      //need to set the folder name</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+        unusedDB) {</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+      // need to set the folder name</span>
<a href="#l20.119"></a><span id="l20.119">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l20.120"></a><span id="l20.120">       rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-        folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+      if (NS_SUCCEEDED(rv)) folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l20.124"></a><span id="l20.124"> </span>
<a href="#l20.125"></a><span id="l20.125">       unusedDB-&gt;SetSummaryValid(true);</span>
<a href="#l20.126"></a><span id="l20.126">       unusedDB-&gt;Close(true);</span>
<a href="#l20.127"></a><span id="l20.127">       aParent-&gt;UpdateSummaryTotals(true);</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineminus">-    }</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-    else</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-    {</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+    } else {</span>
<a href="#l20.132"></a><span id="l20.132">       path-&gt;Remove(false);</span>
<a href="#l20.133"></a><span id="l20.133">       rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l20.134"></a><span id="l20.134">     }</span>
<a href="#l20.135"></a><span id="l20.135">   }</span>
<a href="#l20.136"></a><span id="l20.136">   child.forget(aResult);</span>
<a href="#l20.137"></a><span id="l20.137">   return rv;</span>
<a href="#l20.138"></a><span id="l20.138"> }</span>
<a href="#l20.139"></a><span id="l20.139"> </span>
<a href="#l20.140"></a><span id="l20.140"> // Get the current attributes of the mbox file, corrected for caching</span>
<a href="#l20.141"></a><span id="l20.141"> void nsMsgBrkMBoxStore::GetMailboxModProperties(nsIMsgFolder *aFolder,</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-                                                int64_t *aSize, uint32_t *aDate)</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-{</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+                                                int64_t *aSize,</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+                                                uint32_t *aDate) {</span>
<a href="#l20.146"></a><span id="l20.146">   // We'll simply return 0 on errors.</span>
<a href="#l20.147"></a><span id="l20.147">   *aDate = 0;</span>
<a href="#l20.148"></a><span id="l20.148">   *aSize = 0;</span>
<a href="#l20.149"></a><span id="l20.149">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l20.150"></a><span id="l20.150">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l20.151"></a><span id="l20.151">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l20.152"></a><span id="l20.152"> </span>
<a href="#l20.153"></a><span id="l20.153">   rv = pathFile-&gt;GetFileSize(aSize);</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-    return; // expected result for virtual folders</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+  if (NS_FAILED(rv)) return;  // expected result for virtual folders</span>
<a href="#l20.157"></a><span id="l20.157"> </span>
<a href="#l20.158"></a><span id="l20.158">   PRTime lastModTime;</span>
<a href="#l20.159"></a><span id="l20.159">   rv = pathFile-&gt;GetLastModifiedTime(&amp;lastModTime);</span>
<a href="#l20.160"></a><span id="l20.160">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l20.161"></a><span id="l20.161"> </span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  *aDate = (uint32_t) (lastModTime / PR_MSEC_PER_SEC);</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+  *aDate = (uint32_t)(lastModTime / PR_MSEC_PER_SEC);</span>
<a href="#l20.164"></a><span id="l20.164"> }</span>
<a href="#l20.165"></a><span id="l20.165"> </span>
<a href="#l20.166"></a><span id="l20.166"> NS_IMETHODIMP nsMsgBrkMBoxStore::HasSpaceAvailable(nsIMsgFolder *aFolder,</span>
<a href="#l20.167"></a><span id="l20.167">                                                    int64_t aSpaceRequested,</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-                                                   bool *aResult)</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineminus">-{</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+                                                   bool *aResult) {</span>
<a href="#l20.171"></a><span id="l20.171">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.172"></a><span id="l20.172">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.173"></a><span id="l20.173"> </span>
<a href="#l20.174"></a><span id="l20.174">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l20.175"></a><span id="l20.175">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l20.176"></a><span id="l20.176">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.177"></a><span id="l20.177"> </span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-  bool allow4GBfolders = mozilla::Preferences::GetBool(&quot;mailnews.allowMboxOver4GB&quot;, true);</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+  bool allow4GBfolders =</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+      mozilla::Preferences::GetBool(&quot;mailnews.allowMboxOver4GB&quot;, true);</span>
<a href="#l20.181"></a><span id="l20.181"> </span>
<a href="#l20.182"></a><span id="l20.182">   if (!allow4GBfolders) {</span>
<a href="#l20.183"></a><span id="l20.183">     // Allow the mbox to only reach 0xFFC00000 = 4 GiB - 4 MiB.</span>
<a href="#l20.184"></a><span id="l20.184">     int64_t fileSize;</span>
<a href="#l20.185"></a><span id="l20.185">     rv = pathFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l20.186"></a><span id="l20.186">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.187"></a><span id="l20.187"> </span>
<a href="#l20.188"></a><span id="l20.188">     *aResult = ((fileSize + aSpaceRequested) &lt; 0xFFC00000LL);</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineminus">-    if (!*aResult)</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineminus">-      return NS_ERROR_FILE_TOO_BIG;</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+    if (!*aResult) return NS_ERROR_FILE_TOO_BIG;</span>
<a href="#l20.192"></a><span id="l20.192">   }</span>
<a href="#l20.193"></a><span id="l20.193"> </span>
<a href="#l20.194"></a><span id="l20.194">   *aResult = DiskSpaceAvailableInStore(pathFile, aSpaceRequested);</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineminus">-  if (!*aResult)</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineminus">-    return NS_ERROR_FILE_DISK_FULL;</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+  if (!*aResult) return NS_ERROR_FILE_DISK_FULL;</span>
<a href="#l20.198"></a><span id="l20.198"> </span>
<a href="#l20.199"></a><span id="l20.199">   return NS_OK;</span>
<a href="#l20.200"></a><span id="l20.200"> }</span>
<a href="#l20.201"></a><span id="l20.201"> </span>
<a href="#l20.202"></a><span id="l20.202"> static bool gGotGlobalPrefs = false;</span>
<a href="#l20.203"></a><span id="l20.203"> static int32_t gTimeStampLeeway = 60;</span>
<a href="#l20.204"></a><span id="l20.204"> </span>
<a href="#l20.205"></a><span id="l20.205"> NS_IMETHODIMP nsMsgBrkMBoxStore::IsSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l20.206"></a><span id="l20.206">                                                     nsIMsgDatabase *aDB,</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-                                                    bool *aResult)</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-{</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+                                                    bool *aResult) {</span>
<a href="#l20.210"></a><span id="l20.210">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.211"></a><span id="l20.211">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l20.212"></a><span id="l20.212">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.213"></a><span id="l20.213">   // We only check local folders for db validity.</span>
<a href="#l20.214"></a><span id="l20.214">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder(do_QueryInterface(aFolder));</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-  if (!localFolder)</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-  {</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineplus">+  if (!localFolder) {</span>
<a href="#l20.218"></a><span id="l20.218">     *aResult = true;</span>
<a href="#l20.219"></a><span id="l20.219">     return NS_OK;</span>
<a href="#l20.220"></a><span id="l20.220">   }</span>
<a href="#l20.221"></a><span id="l20.221"> </span>
<a href="#l20.222"></a><span id="l20.222">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l20.223"></a><span id="l20.223">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l20.224"></a><span id="l20.224">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.225"></a><span id="l20.225">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineat">@@ -229,81 +209,73 @@ NS_IMETHODIMP nsMsgBrkMBoxStore::IsSumma</span>
<a href="#l20.227"></a><span id="l20.227">   folderInfo-&gt;GetNumUnreadMessages(&amp;numUnreadMessages);</span>
<a href="#l20.228"></a><span id="l20.228">   folderInfo-&gt;GetFolderSize(&amp;folderSize);</span>
<a href="#l20.229"></a><span id="l20.229">   folderInfo-&gt;GetFolderDate(&amp;folderDate);</span>
<a href="#l20.230"></a><span id="l20.230"> </span>
<a href="#l20.231"></a><span id="l20.231">   int64_t fileSize = 0;</span>
<a href="#l20.232"></a><span id="l20.232">   uint32_t actualFolderTimeStamp = 0;</span>
<a href="#l20.233"></a><span id="l20.233">   GetMailboxModProperties(aFolder, &amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l20.234"></a><span id="l20.234"> </span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-  if (folderSize == fileSize &amp;&amp; numUnreadMessages &gt;= 0)</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-  {</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-    if (!folderSize)</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-    {</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+  if (folderSize == fileSize &amp;&amp; numUnreadMessages &gt;= 0) {</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+    if (!folderSize) {</span>
<a href="#l20.241"></a><span id="l20.241">       *aResult = true;</span>
<a href="#l20.242"></a><span id="l20.242">       return NS_OK;</span>
<a href="#l20.243"></a><span id="l20.243">     }</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-    if (!gGotGlobalPrefs)</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineminus">-    {</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-      if (pPrefBranch)</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-      {</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-        rv = pPrefBranch-&gt;GetIntPref(&quot;mail.db_timestamp_leeway&quot;, &amp;gTimeStampLeeway);</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineplus">+    if (!gGotGlobalPrefs) {</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+          do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+      if (pPrefBranch) {</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+        rv = pPrefBranch-&gt;GetIntPref(&quot;mail.db_timestamp_leeway&quot;,</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+                                     &amp;gTimeStampLeeway);</span>
<a href="#l20.256"></a><span id="l20.256">         gGotGlobalPrefs = true;</span>
<a href="#l20.257"></a><span id="l20.257">       }</span>
<a href="#l20.258"></a><span id="l20.258">     }</span>
<a href="#l20.259"></a><span id="l20.259">     // if those values are ok, check time stamp</span>
<a href="#l20.260"></a><span id="l20.260">     if (gTimeStampLeeway == 0)</span>
<a href="#l20.261"></a><span id="l20.261">       *aResult = folderDate == actualFolderTimeStamp;</span>
<a href="#l20.262"></a><span id="l20.262">     else</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-      *aResult = std::abs((int32_t) (actualFolderTimeStamp - folderDate)) &lt;= gTimeStampLeeway;</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+      *aResult = std::abs((int32_t)(actualFolderTimeStamp - folderDate)) &lt;=</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+                 gTimeStampLeeway;</span>
<a href="#l20.266"></a><span id="l20.266">   }</span>
<a href="#l20.267"></a><span id="l20.267">   return NS_OK;</span>
<a href="#l20.268"></a><span id="l20.268"> }</span>
<a href="#l20.269"></a><span id="l20.269"> </span>
<a href="#l20.270"></a><span id="l20.270"> NS_IMETHODIMP nsMsgBrkMBoxStore::SetSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l20.271"></a><span id="l20.271">                                                      nsIMsgDatabase *aDB,</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineminus">-                                                     bool aValid)</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-{</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+                                                     bool aValid) {</span>
<a href="#l20.275"></a><span id="l20.275">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.276"></a><span id="l20.276">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l20.277"></a><span id="l20.277">   // We only need to do this for local folders.</span>
<a href="#l20.278"></a><span id="l20.278">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder(do_QueryInterface(aFolder));</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-  if (!localFolder)</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+  if (!localFolder) return NS_OK;</span>
<a href="#l20.282"></a><span id="l20.282"> </span>
<a href="#l20.283"></a><span id="l20.283">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l20.284"></a><span id="l20.284">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l20.285"></a><span id="l20.285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.286"></a><span id="l20.286">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l20.287"></a><span id="l20.287">   rv = aDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l20.288"></a><span id="l20.288">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.289"></a><span id="l20.289">   bool exists;</span>
<a href="#l20.290"></a><span id="l20.290">   pathFile-&gt;Exists(&amp;exists);</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-  if (!exists)</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-    return NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineplus">+  if (!exists) return NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l20.294"></a><span id="l20.294"> </span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-  if (aValid)</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-  {</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+  if (aValid) {</span>
<a href="#l20.298"></a><span id="l20.298">     uint32_t actualFolderTimeStamp;</span>
<a href="#l20.299"></a><span id="l20.299">     int64_t fileSize;</span>
<a href="#l20.300"></a><span id="l20.300">     GetMailboxModProperties(aFolder, &amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l20.301"></a><span id="l20.301">     folderInfo-&gt;SetFolderSize(fileSize);</span>
<a href="#l20.302"></a><span id="l20.302">     folderInfo-&gt;SetFolderDate(actualFolderTimeStamp);</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineminus">-  }</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-  else</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-  {</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-    folderInfo-&gt;SetVersion(0); // that ought to do the trick.</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineplus">+  } else {</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+    folderInfo-&gt;SetVersion(0);  // that ought to do the trick.</span>
<a href="#l20.309"></a><span id="l20.309">   }</span>
<a href="#l20.310"></a><span id="l20.310">   aDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l20.311"></a><span id="l20.311">   return rv;</span>
<a href="#l20.312"></a><span id="l20.312"> }</span>
<a href="#l20.313"></a><span id="l20.313"> </span>
<a href="#l20.314"></a><span id="l20.314" class="difflineminus">-NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteFolder(nsIMsgFolder *aFolder)</span>
<a href="#l20.315"></a><span id="l20.315" class="difflineminus">-{</span>
<a href="#l20.316"></a><span id="l20.316" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteFolder(nsIMsgFolder *aFolder) {</span>
<a href="#l20.317"></a><span id="l20.317">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.318"></a><span id="l20.318">   bool exists;</span>
<a href="#l20.319"></a><span id="l20.319"> </span>
<a href="#l20.320"></a><span id="l20.320">   // Delete mbox file.</span>
<a href="#l20.321"></a><span id="l20.321">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l20.322"></a><span id="l20.322">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l20.323"></a><span id="l20.323">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.324"></a><span id="l20.324"> </span>
<a href="#l20.325"></a><span id="l20.325" class="difflineat">@@ -322,99 +294,89 @@ NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteF</span>
<a href="#l20.326"></a><span id="l20.326">     rv = pathFile-&gt;Remove(true);</span>
<a href="#l20.327"></a><span id="l20.327">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.328"></a><span id="l20.328">   }</span>
<a href="#l20.329"></a><span id="l20.329"> </span>
<a href="#l20.330"></a><span id="l20.330">   return NS_OK;</span>
<a href="#l20.331"></a><span id="l20.331"> }</span>
<a href="#l20.332"></a><span id="l20.332"> </span>
<a href="#l20.333"></a><span id="l20.333"> NS_IMETHODIMP nsMsgBrkMBoxStore::RenameFolder(nsIMsgFolder *aFolder,</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-                                              const nsAString &amp; aNewName,</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineminus">-                                              nsIMsgFolder **aNewFolder)</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineminus">-{</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineplus">+                                              const nsAString &amp;aNewName,</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineplus">+                                              nsIMsgFolder **aNewFolder) {</span>
<a href="#l20.339"></a><span id="l20.339">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.340"></a><span id="l20.340">   NS_ENSURE_ARG_POINTER(aNewFolder);</span>
<a href="#l20.341"></a><span id="l20.341"> </span>
<a href="#l20.342"></a><span id="l20.342">   uint32_t numChildren;</span>
<a href="#l20.343"></a><span id="l20.343">   aFolder-&gt;GetNumSubFolders(&amp;numChildren);</span>
<a href="#l20.344"></a><span id="l20.344">   nsString existingName;</span>
<a href="#l20.345"></a><span id="l20.345">   aFolder-&gt;GetName(existingName);</span>
<a href="#l20.346"></a><span id="l20.346"> </span>
<a href="#l20.347"></a><span id="l20.347">   nsCOMPtr&lt;nsIFile&gt; oldPathFile;</span>
<a href="#l20.348"></a><span id="l20.348">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineminus">-    return rv;</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.352"></a><span id="l20.352"> </span>
<a href="#l20.353"></a><span id="l20.353">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l20.354"></a><span id="l20.354">   rv = aFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineminus">-  if (!parentFolder)</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineplus">+  if (!parentFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.358"></a><span id="l20.358"> </span>
<a href="#l20.359"></a><span id="l20.359">   nsCOMPtr&lt;nsIFile&gt; oldSummaryFile;</span>
<a href="#l20.360"></a><span id="l20.360">   rv = aFolder-&gt;GetSummaryFile(getter_AddRefs(oldSummaryFile));</span>
<a href="#l20.361"></a><span id="l20.361">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.362"></a><span id="l20.362"> </span>
<a href="#l20.363"></a><span id="l20.363">   nsCOMPtr&lt;nsIFile&gt; dirFile;</span>
<a href="#l20.364"></a><span id="l20.364">   oldPathFile-&gt;Clone(getter_AddRefs(dirFile));</span>
<a href="#l20.365"></a><span id="l20.365"> </span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-  if (numChildren &gt; 0)</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-  {</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineplus">+  if (numChildren &gt; 0) {</span>
<a href="#l20.369"></a><span id="l20.369">     rv = CreateDirectoryForFolder(dirFile);</span>
<a href="#l20.370"></a><span id="l20.370">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.371"></a><span id="l20.371">   }</span>
<a href="#l20.372"></a><span id="l20.372"> </span>
<a href="#l20.373"></a><span id="l20.373">   nsAutoString safeName(aNewName);</span>
<a href="#l20.374"></a><span id="l20.374">   NS_MsgHashIfNecessary(safeName);</span>
<a href="#l20.375"></a><span id="l20.375"> </span>
<a href="#l20.376"></a><span id="l20.376">   nsAutoCString oldLeafName;</span>
<a href="#l20.377"></a><span id="l20.377">   oldPathFile-&gt;GetNativeLeafName(oldLeafName);</span>
<a href="#l20.378"></a><span id="l20.378"> </span>
<a href="#l20.379"></a><span id="l20.379">   nsCOMPtr&lt;nsIFile&gt; parentPathFile;</span>
<a href="#l20.380"></a><span id="l20.380">   parentFolder-&gt;GetFilePath(getter_AddRefs(parentPathFile));</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.383"></a><span id="l20.383"> </span>
<a href="#l20.384"></a><span id="l20.384">   bool isDirectory = false;</span>
<a href="#l20.385"></a><span id="l20.385">   parentPathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineminus">-  {</span>
<a href="#l20.388"></a><span id="l20.388" class="difflineplus">+  if (!isDirectory) {</span>
<a href="#l20.389"></a><span id="l20.389">     nsAutoString leafName;</span>
<a href="#l20.390"></a><span id="l20.390">     parentPathFile-&gt;GetLeafName(leafName);</span>
<a href="#l20.391"></a><span id="l20.391">     leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l20.392"></a><span id="l20.392">     rv = parentPathFile-&gt;SetLeafName(leafName);</span>
<a href="#l20.393"></a><span id="l20.393">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.394"></a><span id="l20.394">   }</span>
<a href="#l20.395"></a><span id="l20.395"> </span>
<a href="#l20.396"></a><span id="l20.396">   aFolder-&gt;ForceDBClosed();</span>
<a href="#l20.397"></a><span id="l20.397" class="difflineminus">-  //save off dir name before appending .msf</span>
<a href="#l20.398"></a><span id="l20.398" class="difflineplus">+  // save off dir name before appending .msf</span>
<a href="#l20.399"></a><span id="l20.399">   rv = oldPathFile-&gt;MoveTo(nullptr, safeName);</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineminus">-    return rv;</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.403"></a><span id="l20.403"> </span>
<a href="#l20.404"></a><span id="l20.404">   nsString dbName(safeName);</span>
<a href="#l20.405"></a><span id="l20.405">   dbName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l20.406"></a><span id="l20.406">   oldSummaryFile-&gt;MoveTo(nullptr, dbName);</span>
<a href="#l20.407"></a><span id="l20.407"> </span>
<a href="#l20.408"></a><span id="l20.408" class="difflineminus">-  if (numChildren &gt; 0)</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineminus">-  {</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineplus">+  if (numChildren &gt; 0) {</span>
<a href="#l20.411"></a><span id="l20.411">     // rename &quot;*.sbd&quot; directory</span>
<a href="#l20.412"></a><span id="l20.412">     nsAutoString newNameDirStr(safeName);</span>
<a href="#l20.413"></a><span id="l20.413">     newNameDirStr.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l20.414"></a><span id="l20.414">     dirFile-&gt;MoveTo(nullptr, newNameDirStr);</span>
<a href="#l20.415"></a><span id="l20.415">   }</span>
<a href="#l20.416"></a><span id="l20.416"> </span>
<a href="#l20.417"></a><span id="l20.417">   return parentFolder-&gt;AddSubfolder(safeName, aNewFolder);</span>
<a href="#l20.418"></a><span id="l20.418"> }</span>
<a href="#l20.419"></a><span id="l20.419"> </span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-NS_IMETHODIMP nsMsgBrkMBoxStore::CopyFolder(nsIMsgFolder *aSrcFolder,</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineminus">-                                            nsIMsgFolder *aDstFolder,</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-                                            bool aIsMoveFolder,</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineminus">-                                            nsIMsgCopyServiceListener *aListener,</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineminus">-                                            const nsAString &amp;aNewName)</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineminus">-{</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::CopyFolder(</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineplus">+    nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDstFolder, bool aIsMoveFolder,</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIMsgCopyServiceListener *aListener,</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineplus">+    const nsAString &amp;aNewName) {</span>
<a href="#l20.431"></a><span id="l20.431">   NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l20.432"></a><span id="l20.432">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l20.433"></a><span id="l20.433"> </span>
<a href="#l20.434"></a><span id="l20.434">   nsAutoString folderName;</span>
<a href="#l20.435"></a><span id="l20.435">   if (aNewName.IsEmpty())</span>
<a href="#l20.436"></a><span id="l20.436">     aSrcFolder-&gt;GetName(folderName);</span>
<a href="#l20.437"></a><span id="l20.437">   else</span>
<a href="#l20.438"></a><span id="l20.438">     folderName.Assign(aNewName);</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineat">@@ -426,272 +388,249 @@ NS_IMETHODIMP nsMsgBrkMBoxStore::CopyFol</span>
<a href="#l20.440"></a><span id="l20.440">   if (localSrcFolder)</span>
<a href="#l20.441"></a><span id="l20.441">     localSrcFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(srcDB));</span>
<a href="#l20.442"></a><span id="l20.442">   bool summaryValid = !!srcDB;</span>
<a href="#l20.443"></a><span id="l20.443">   srcDB = nullptr;</span>
<a href="#l20.444"></a><span id="l20.444">   aSrcFolder-&gt;ForceDBClosed();</span>
<a href="#l20.445"></a><span id="l20.445"> </span>
<a href="#l20.446"></a><span id="l20.446">   nsCOMPtr&lt;nsIFile&gt; oldPath;</span>
<a href="#l20.447"></a><span id="l20.447">   nsresult rv = aSrcFolder-&gt;GetFilePath(getter_AddRefs(oldPath));</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.450"></a><span id="l20.450"> </span>
<a href="#l20.451"></a><span id="l20.451">   nsCOMPtr&lt;nsIFile&gt; summaryFile;</span>
<a href="#l20.452"></a><span id="l20.452">   GetSummaryFileLocation(oldPath, getter_AddRefs(summaryFile));</span>
<a href="#l20.453"></a><span id="l20.453"> </span>
<a href="#l20.454"></a><span id="l20.454">   nsCOMPtr&lt;nsIFile&gt; newPath;</span>
<a href="#l20.455"></a><span id="l20.455">   rv = aDstFolder-&gt;GetFilePath(getter_AddRefs(newPath));</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.458"></a><span id="l20.458"> </span>
<a href="#l20.459"></a><span id="l20.459">   bool newPathIsDirectory = false;</span>
<a href="#l20.460"></a><span id="l20.460">   newPath-&gt;IsDirectory(&amp;newPathIsDirectory);</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineminus">-  if (!newPathIsDirectory)</span>
<a href="#l20.462"></a><span id="l20.462" class="difflineminus">-  {</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineplus">+  if (!newPathIsDirectory) {</span>
<a href="#l20.464"></a><span id="l20.464">     AddDirectorySeparator(newPath);</span>
<a href="#l20.465"></a><span id="l20.465">     rv = newPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-    if (rv == NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineminus">-      rv = NS_OK;</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineplus">+    if (rv == NS_ERROR_FILE_ALREADY_EXISTS) rv = NS_OK;</span>
<a href="#l20.469"></a><span id="l20.469">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.470"></a><span id="l20.470">   }</span>
<a href="#l20.471"></a><span id="l20.471"> </span>
<a href="#l20.472"></a><span id="l20.472">   nsCOMPtr&lt;nsIFile&gt; origPath;</span>
<a href="#l20.473"></a><span id="l20.473">   oldPath-&gt;Clone(getter_AddRefs(origPath));</span>
<a href="#l20.474"></a><span id="l20.474"> </span>
<a href="#l20.475"></a><span id="l20.475" class="difflineminus">-   //copying necessary for aborting.... if failure return</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineplus">+  // copying necessary for aborting.... if failure return</span>
<a href="#l20.477"></a><span id="l20.477">   rv = oldPath-&gt;CopyTo(newPath, safeFolderName);</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); // Will fail if a file by that name exists</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);  // Will fail if a file by that name exists</span>
<a href="#l20.480"></a><span id="l20.480"> </span>
<a href="#l20.481"></a><span id="l20.481">   // Copy to dir can fail if filespec does not exist. If copy fails, we test</span>
<a href="#l20.482"></a><span id="l20.482">   // if the filespec exist or not, if it does not that's ok, we continue</span>
<a href="#l20.483"></a><span id="l20.483">   // without copying it. If it fails and filespec exist and is not zero sized</span>
<a href="#l20.484"></a><span id="l20.484">   // there is real problem</span>
<a href="#l20.485"></a><span id="l20.485">   // Copy the file to the new dir</span>
<a href="#l20.486"></a><span id="l20.486">   nsAutoString dbName(safeFolderName);</span>
<a href="#l20.487"></a><span id="l20.487">   dbName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l20.488"></a><span id="l20.488">   rv = summaryFile-&gt;CopyTo(newPath, dbName);</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineminus">-  if (NS_FAILED(rv)) // Test if the copy is successful</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+  if (NS_FAILED(rv))  // Test if the copy is successful</span>
<a href="#l20.491"></a><span id="l20.491">   {</span>
<a href="#l20.492"></a><span id="l20.492">     // Test if the filespec has data</span>
<a href="#l20.493"></a><span id="l20.493">     bool exists;</span>
<a href="#l20.494"></a><span id="l20.494">     int64_t fileSize;</span>
<a href="#l20.495"></a><span id="l20.495">     summaryFile-&gt;Exists(&amp;exists);</span>
<a href="#l20.496"></a><span id="l20.496">     summaryFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l20.497"></a><span id="l20.497">     if (exists &amp;&amp; fileSize &gt; 0)</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv); // Yes, it should have worked !</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);  // Yes, it should have worked !</span>
<a href="#l20.500"></a><span id="l20.500">     // else case is filespec is zero sized, no need to copy it,</span>
<a href="#l20.501"></a><span id="l20.501">     // not an error</span>
<a href="#l20.502"></a><span id="l20.502">   }</span>
<a href="#l20.503"></a><span id="l20.503"> </span>
<a href="#l20.504"></a><span id="l20.504">   nsCOMPtr&lt;nsIMsgFolder&gt; newMsgFolder;</span>
<a href="#l20.505"></a><span id="l20.505">   rv = aDstFolder-&gt;AddSubfolder(safeFolderName, getter_AddRefs(newMsgFolder));</span>
<a href="#l20.506"></a><span id="l20.506">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.507"></a><span id="l20.507"> </span>
<a href="#l20.508"></a><span id="l20.508">   // linux and mac are not good about maintaining the file stamp when copying</span>
<a href="#l20.509"></a><span id="l20.509">   // folders around. So if the source folder db is good, set the dest db as</span>
<a href="#l20.510"></a><span id="l20.510">   // good too.</span>
<a href="#l20.511"></a><span id="l20.511">   nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-  if (summaryValid)</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-  {</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineplus">+  if (summaryValid) {</span>
<a href="#l20.515"></a><span id="l20.515">     nsAutoString folderLeafName;</span>
<a href="#l20.516"></a><span id="l20.516">     origPath-&gt;GetLeafName(folderLeafName);</span>
<a href="#l20.517"></a><span id="l20.517">     newPath-&gt;Append(folderLeafName);</span>
<a href="#l20.518"></a><span id="l20.518">     nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineminus">-      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l20.521"></a><span id="l20.521">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineminus">-    rv = msgDBService-&gt;OpenMailDBFromFile(newPath, newMsgFolder, false,</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineminus">-                                          true, getter_AddRefs(destDB));</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineplus">+    rv = msgDBService-&gt;OpenMailDBFromFile(newPath, newMsgFolder, false, true,</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineplus">+                                          getter_AddRefs(destDB));</span>
<a href="#l20.526"></a><span id="l20.526">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE &amp;&amp; destDB)</span>
<a href="#l20.527"></a><span id="l20.527">       destDB-&gt;SetSummaryValid(true);</span>
<a href="#l20.528"></a><span id="l20.528">   }</span>
<a href="#l20.529"></a><span id="l20.529">   newMsgFolder-&gt;SetPrettyName(folderName);</span>
<a href="#l20.530"></a><span id="l20.530">   uint32_t flags;</span>
<a href="#l20.531"></a><span id="l20.531">   aSrcFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l20.532"></a><span id="l20.532">   newMsgFolder-&gt;SetFlags(flags);</span>
<a href="#l20.533"></a><span id="l20.533">   bool changed = false;</span>
<a href="#l20.534"></a><span id="l20.534">   rv = aSrcFolder-&gt;MatchOrChangeFilterDestination(newMsgFolder, true, &amp;changed);</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-  if (changed)</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-    aSrcFolder-&gt;AlertFilterChanged(aMsgWindow);</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineplus">+  if (changed) aSrcFolder-&gt;AlertFilterChanged(aMsgWindow);</span>
<a href="#l20.538"></a><span id="l20.538"> </span>
<a href="#l20.539"></a><span id="l20.539">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l20.540"></a><span id="l20.540">   rv = aSrcFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l20.541"></a><span id="l20.541">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.542"></a><span id="l20.542"> </span>
<a href="#l20.543"></a><span id="l20.543">   // Copy subfolders to the new location</span>
<a href="#l20.544"></a><span id="l20.544">   nsresult copyStatus = NS_OK;</span>
<a href="#l20.545"></a><span id="l20.545" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l20.546"></a><span id="l20.546" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineminus">-  {</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineplus">+      do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l20.551"></a><span id="l20.551">     bool hasMore;</span>
<a href="#l20.552"></a><span id="l20.552">     while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp;</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineminus">-           NS_SUCCEEDED(copyStatus))</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineminus">-    {</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineplus">+           NS_SUCCEEDED(copyStatus)) {</span>
<a href="#l20.556"></a><span id="l20.556">       nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l20.557"></a><span id="l20.557">       enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l20.558"></a><span id="l20.558"> </span>
<a href="#l20.559"></a><span id="l20.559">       nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineminus">-      if (!folder)</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineminus">-        continue;</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineplus">+      if (!folder) continue;</span>
<a href="#l20.563"></a><span id="l20.563"> </span>
<a href="#l20.564"></a><span id="l20.564" class="difflineminus">-      copyStatus = localNewFolder-&gt;CopyFolderLocal(folder, false,</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineminus">-                                                   aMsgWindow, aListener);</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineplus">+      copyStatus =</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineplus">+          localNewFolder-&gt;CopyFolderLocal(folder, false, aMsgWindow, aListener);</span>
<a href="#l20.568"></a><span id="l20.568">       // Test if the call succeeded, if not we have to stop recursive call</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineminus">-      if (NS_FAILED(copyStatus))</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineminus">-      {</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineplus">+      if (NS_FAILED(copyStatus)) {</span>
<a href="#l20.572"></a><span id="l20.572">         // Copy failed we have to notify caller to handle the error and stop</span>
<a href="#l20.573"></a><span id="l20.573">         // moving the folders. In case this happens to the topmost level of</span>
<a href="#l20.574"></a><span id="l20.574">         // recursive call, then we just need to break from the while loop and</span>
<a href="#l20.575"></a><span id="l20.575">         // go to error handling code.</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineminus">-        if (!aIsMoveFolder)</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-          return copyStatus;</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineplus">+        if (!aIsMoveFolder) return copyStatus;</span>
<a href="#l20.579"></a><span id="l20.579">         break;</span>
<a href="#l20.580"></a><span id="l20.580">       }</span>
<a href="#l20.581"></a><span id="l20.581">     }</span>
<a href="#l20.582"></a><span id="l20.582">   }</span>
<a href="#l20.583"></a><span id="l20.583"> </span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-  if (aIsMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus))</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineminus">-  {</span>
<a href="#l20.586"></a><span id="l20.586" class="difflineminus">-    if (localNewFolder)</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineminus">-    {</span>
<a href="#l20.588"></a><span id="l20.588" class="difflineplus">+  if (aIsMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus)) {</span>
<a href="#l20.589"></a><span id="l20.589" class="difflineplus">+    if (localNewFolder) {</span>
<a href="#l20.590"></a><span id="l20.590">       nsCOMPtr&lt;nsISupports&gt; srcSupport(do_QueryInterface(aSrcFolder));</span>
<a href="#l20.591"></a><span id="l20.591">       localNewFolder-&gt;OnCopyCompleted(srcSupport, true);</span>
<a href="#l20.592"></a><span id="l20.592">     }</span>
<a href="#l20.593"></a><span id="l20.593"> </span>
<a href="#l20.594"></a><span id="l20.594">     // Notify the &quot;folder&quot; that was dragged and dropped has been created. No</span>
<a href="#l20.595"></a><span id="l20.595">     // need to do this for its subfolders. isMoveFolder will be true for folder.</span>
<a href="#l20.596"></a><span id="l20.596">     aDstFolder-&gt;NotifyItemAdded(newMsgFolder);</span>
<a href="#l20.597"></a><span id="l20.597"> </span>
<a href="#l20.598"></a><span id="l20.598">     nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l20.599"></a><span id="l20.599">     aSrcFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l20.600"></a><span id="l20.600">     aSrcFolder-&gt;SetParent(nullptr);</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineminus">-    if (msgParent)</span>
<a href="#l20.602"></a><span id="l20.602" class="difflineminus">-    {</span>
<a href="#l20.603"></a><span id="l20.603" class="difflineplus">+    if (msgParent) {</span>
<a href="#l20.604"></a><span id="l20.604">       // The files have already been moved, so delete storage false</span>
<a href="#l20.605"></a><span id="l20.605">       msgParent-&gt;PropagateDelete(aSrcFolder, false, aMsgWindow);</span>
<a href="#l20.606"></a><span id="l20.606" class="difflineminus">-      oldPath-&gt;Remove(false);  //berkeley mailbox</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineminus">-     // We need to force closed the source db</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineplus">+      oldPath-&gt;Remove(false);  // berkeley mailbox</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineplus">+      // We need to force closed the source db</span>
<a href="#l20.610"></a><span id="l20.610">       nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l20.611"></a><span id="l20.611">       aSrcFolder-&gt;Delete();</span>
<a href="#l20.612"></a><span id="l20.612"> </span>
<a href="#l20.613"></a><span id="l20.613">       nsCOMPtr&lt;nsIFile&gt; parentPath;</span>
<a href="#l20.614"></a><span id="l20.614">       rv = msgParent-&gt;GetFilePath(getter_AddRefs(parentPath));</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l20.616"></a><span id="l20.616" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.617"></a><span id="l20.617"> </span>
<a href="#l20.618"></a><span id="l20.618">       AddDirectorySeparator(parentPath);</span>
<a href="#l20.619"></a><span id="l20.619">       nsCOMPtr&lt;nsIDirectoryEnumerator&gt; children;</span>
<a href="#l20.620"></a><span id="l20.620">       parentPath-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l20.621"></a><span id="l20.621">       bool more;</span>
<a href="#l20.622"></a><span id="l20.622">       // checks if the directory is empty or not</span>
<a href="#l20.623"></a><span id="l20.623">       if (children &amp;&amp; NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; !more)</span>
<a href="#l20.624"></a><span id="l20.624">         parentPath-&gt;Remove(true);</span>
<a href="#l20.625"></a><span id="l20.625">     }</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineminus">-  }</span>
<a href="#l20.627"></a><span id="l20.627" class="difflineminus">-  else</span>
<a href="#l20.628"></a><span id="l20.628" class="difflineminus">-  {</span>
<a href="#l20.629"></a><span id="l20.629" class="difflineplus">+  } else {</span>
<a href="#l20.630"></a><span id="l20.630">     // This is the case where the copy of a subfolder failed.</span>
<a href="#l20.631"></a><span id="l20.631">     // We have to delete the newDirectory tree to make a &quot;rollback&quot;.</span>
<a href="#l20.632"></a><span id="l20.632">     // Someone should add a popup to warn the user that the move was not</span>
<a href="#l20.633"></a><span id="l20.633">     // possible.</span>
<a href="#l20.634"></a><span id="l20.634" class="difflineminus">-    if (aIsMoveFolder &amp;&amp; NS_FAILED(copyStatus))</span>
<a href="#l20.635"></a><span id="l20.635" class="difflineminus">-    {</span>
<a href="#l20.636"></a><span id="l20.636" class="difflineplus">+    if (aIsMoveFolder &amp;&amp; NS_FAILED(copyStatus)) {</span>
<a href="#l20.637"></a><span id="l20.637">       nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l20.638"></a><span id="l20.638">       newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l20.639"></a><span id="l20.639">       newMsgFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l20.640"></a><span id="l20.640">       newMsgFolder-&gt;SetParent(nullptr);</span>
<a href="#l20.641"></a><span id="l20.641" class="difflineminus">-      if (msgParent)</span>
<a href="#l20.642"></a><span id="l20.642" class="difflineminus">-      {</span>
<a href="#l20.643"></a><span id="l20.643" class="difflineplus">+      if (msgParent) {</span>
<a href="#l20.644"></a><span id="l20.644">         msgParent-&gt;PropagateDelete(newMsgFolder, false, aMsgWindow);</span>
<a href="#l20.645"></a><span id="l20.645">         newMsgFolder-&gt;Delete();</span>
<a href="#l20.646"></a><span id="l20.646">         newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l20.647"></a><span id="l20.647">         AddDirectorySeparator(newPath);</span>
<a href="#l20.648"></a><span id="l20.648" class="difflineminus">-        newPath-&gt;Remove(true);  //berkeley mailbox</span>
<a href="#l20.649"></a><span id="l20.649" class="difflineplus">+        newPath-&gt;Remove(true);  // berkeley mailbox</span>
<a href="#l20.650"></a><span id="l20.650">       }</span>
<a href="#l20.651"></a><span id="l20.651">       return NS_ERROR_FAILURE;</span>
<a href="#l20.652"></a><span id="l20.652">     }</span>
<a href="#l20.653"></a><span id="l20.653">   }</span>
<a href="#l20.654"></a><span id="l20.654">   return NS_OK;</span>
<a href="#l20.655"></a><span id="l20.655"> }</span>
<a href="#l20.656"></a><span id="l20.656"> </span>
<a href="#l20.657"></a><span id="l20.657"> NS_IMETHODIMP</span>
<a href="#l20.658"></a><span id="l20.658"> nsMsgBrkMBoxStore::GetNewMsgOutputStream(nsIMsgFolder *aFolder,</span>
<a href="#l20.659"></a><span id="l20.659">                                          nsIMsgDBHdr **aNewMsgHdr,</span>
<a href="#l20.660"></a><span id="l20.660">                                          bool *aReusable,</span>
<a href="#l20.661"></a><span id="l20.661" class="difflineminus">-                                         nsIOutputStream **aResult)</span>
<a href="#l20.662"></a><span id="l20.662" class="difflineminus">-{</span>
<a href="#l20.663"></a><span id="l20.663" class="difflineplus">+                                         nsIOutputStream **aResult) {</span>
<a href="#l20.664"></a><span id="l20.664">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.665"></a><span id="l20.665">   NS_ENSURE_ARG_POINTER(aNewMsgHdr);</span>
<a href="#l20.666"></a><span id="l20.666">   NS_ENSURE_ARG_POINTER(aReusable);</span>
<a href="#l20.667"></a><span id="l20.667">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.668"></a><span id="l20.668"> </span>
<a href="#l20.669"></a><span id="l20.669"> #ifdef _DEBUG</span>
<a href="#l20.670"></a><span id="l20.670">   NS_ASSERTION(m_streamOutstandingFolder != aFolder, &quot;didn't finish prev msg&quot;);</span>
<a href="#l20.671"></a><span id="l20.671">   m_streamOutstandingFolder = aFolder;</span>
<a href="#l20.672"></a><span id="l20.672"> #endif</span>
<a href="#l20.673"></a><span id="l20.673">   *aReusable = true;</span>
<a href="#l20.674"></a><span id="l20.674">   nsCOMPtr&lt;nsIFile&gt; mboxFile;</span>
<a href="#l20.675"></a><span id="l20.675">   aFolder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l20.676"></a><span id="l20.676">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l20.677"></a><span id="l20.677">   aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineminus">-  if (!db &amp;&amp; !*aNewMsgHdr)</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineminus">-    NS_WARNING(&quot;no db, and no message header&quot;);</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineplus">+  if (!db &amp;&amp; !*aNewMsgHdr) NS_WARNING(&quot;no db, and no message header&quot;);</span>
<a href="#l20.681"></a><span id="l20.681">   bool exists;</span>
<a href="#l20.682"></a><span id="l20.682">   nsresult rv;</span>
<a href="#l20.683"></a><span id="l20.683">   mboxFile-&gt;Exists(&amp;exists);</span>
<a href="#l20.684"></a><span id="l20.684">   if (!exists) {</span>
<a href="#l20.685"></a><span id="l20.685">     rv = mboxFile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l20.686"></a><span id="l20.686">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.687"></a><span id="l20.687">   }</span>
<a href="#l20.688"></a><span id="l20.688"> </span>
<a href="#l20.689"></a><span id="l20.689">   nsCString URI;</span>
<a href="#l20.690"></a><span id="l20.690">   aFolder-&gt;GetURI(URI);</span>
<a href="#l20.691"></a><span id="l20.691">   nsCOMPtr&lt;nsISeekableStream&gt; seekable;</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineminus">-  if (m_outputStreams.Get(URI, aResult))</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineminus">-  {</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineplus">+  if (m_outputStreams.Get(URI, aResult)) {</span>
<a href="#l20.695"></a><span id="l20.695">     seekable = do_QueryInterface(*aResult, &amp;rv);</span>
<a href="#l20.696"></a><span id="l20.696">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.697"></a><span id="l20.697">     rv = seekable-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-    {</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l20.701"></a><span id="l20.701">       m_outputStreams.Remove(URI);</span>
<a href="#l20.702"></a><span id="l20.702">       NS_RELEASE(*aResult);</span>
<a href="#l20.703"></a><span id="l20.703">     }</span>
<a href="#l20.704"></a><span id="l20.704">   }</span>
<a href="#l20.705"></a><span id="l20.705" class="difflineminus">-  if (!*aResult)</span>
<a href="#l20.706"></a><span id="l20.706" class="difflineminus">-  {</span>
<a href="#l20.707"></a><span id="l20.707" class="difflineplus">+  if (!*aResult) {</span>
<a href="#l20.708"></a><span id="l20.708">     rv = MsgGetFileStream(mboxFile, aResult);</span>
<a href="#l20.709"></a><span id="l20.709">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed opening offline store for output&quot;);</span>
<a href="#l20.710"></a><span id="l20.710">     if (NS_FAILED(rv))</span>
<a href="#l20.711"></a><span id="l20.711">       printf(&quot;failed opening offline store for %s\n&quot;, URI.get());</span>
<a href="#l20.712"></a><span id="l20.712">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.713"></a><span id="l20.713">     seekable = do_QueryInterface(*aResult, &amp;rv);</span>
<a href="#l20.714"></a><span id="l20.714">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.715"></a><span id="l20.715">     rv = seekable-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l20.716"></a><span id="l20.716">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.717"></a><span id="l20.717">     m_outputStreams.Put(URI, *aResult);</span>
<a href="#l20.718"></a><span id="l20.718">   }</span>
<a href="#l20.719"></a><span id="l20.719">   int64_t filePos;</span>
<a href="#l20.720"></a><span id="l20.720">   seekable-&gt;Tell(&amp;filePos);</span>
<a href="#l20.721"></a><span id="l20.721"> </span>
<a href="#l20.722"></a><span id="l20.722" class="difflineminus">-  if (db &amp;&amp; !*aNewMsgHdr)</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineminus">-  {</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineplus">+  if (db &amp;&amp; !*aNewMsgHdr) {</span>
<a href="#l20.725"></a><span id="l20.725">     db-&gt;CreateNewHdr(nsMsgKey_None, aNewMsgHdr);</span>
<a href="#l20.726"></a><span id="l20.726">   }</span>
<a href="#l20.727"></a><span id="l20.727"> </span>
<a href="#l20.728"></a><span id="l20.728" class="difflineminus">-  if (*aNewMsgHdr)</span>
<a href="#l20.729"></a><span id="l20.729" class="difflineminus">-  {</span>
<a href="#l20.730"></a><span id="l20.730" class="difflineplus">+  if (*aNewMsgHdr) {</span>
<a href="#l20.731"></a><span id="l20.731">     char storeToken[100];</span>
<a href="#l20.732"></a><span id="l20.732">     PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, filePos);</span>
<a href="#l20.733"></a><span id="l20.733">     (*aNewMsgHdr)-&gt;SetMessageOffset(filePos);</span>
<a href="#l20.734"></a><span id="l20.734">     (*aNewMsgHdr)-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l20.735"></a><span id="l20.735">   }</span>
<a href="#l20.736"></a><span id="l20.736">   return rv;</span>
<a href="#l20.737"></a><span id="l20.737"> }</span>
<a href="#l20.738"></a><span id="l20.738"> </span>
<a href="#l20.739"></a><span id="l20.739"> NS_IMETHODIMP</span>
<a href="#l20.740"></a><span id="l20.740"> nsMsgBrkMBoxStore::DiscardNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l20.741"></a><span id="l20.741" class="difflineminus">-                                     nsIMsgDBHdr *aNewHdr)</span>
<a href="#l20.742"></a><span id="l20.742" class="difflineminus">-{</span>
<a href="#l20.743"></a><span id="l20.743" class="difflineplus">+                                     nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l20.744"></a><span id="l20.744">   NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l20.745"></a><span id="l20.745">   NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l20.746"></a><span id="l20.746"> #ifdef _DEBUG</span>
<a href="#l20.747"></a><span id="l20.747">   m_streamOutstandingFolder = nullptr;</span>
<a href="#l20.748"></a><span id="l20.748"> #endif</span>
<a href="#l20.749"></a><span id="l20.749">   uint64_t hdrOffset;</span>
<a href="#l20.750"></a><span id="l20.750">   aNewHdr-&gt;GetMessageOffset(&amp;hdrOffset);</span>
<a href="#l20.751"></a><span id="l20.751">   aOutputStream-&gt;Close();</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineat">@@ -700,260 +639,227 @@ nsMsgBrkMBoxStore::DiscardNewMessage(nsI</span>
<a href="#l20.753"></a><span id="l20.753">   nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l20.754"></a><span id="l20.754">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.755"></a><span id="l20.755">   folder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l20.756"></a><span id="l20.756">   return mboxFile-&gt;SetFileSize(hdrOffset);</span>
<a href="#l20.757"></a><span id="l20.757"> }</span>
<a href="#l20.758"></a><span id="l20.758"> </span>
<a href="#l20.759"></a><span id="l20.759"> NS_IMETHODIMP</span>
<a href="#l20.760"></a><span id="l20.760"> nsMsgBrkMBoxStore::FinishNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineminus">-                                     nsIMsgDBHdr *aNewHdr)</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineminus">-{</span>
<a href="#l20.763"></a><span id="l20.763" class="difflineplus">+                                    nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l20.764"></a><span id="l20.764"> #ifdef _DEBUG</span>
<a href="#l20.765"></a><span id="l20.765">   m_streamOutstandingFolder = nullptr;</span>
<a href="#l20.766"></a><span id="l20.766"> #endif</span>
<a href="#l20.767"></a><span id="l20.767">   NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l20.768"></a><span id="l20.768" class="difflineminus">-//  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l20.769"></a><span id="l20.769" class="difflineplus">+  //  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l20.770"></a><span id="l20.770">   return NS_OK;</span>
<a href="#l20.771"></a><span id="l20.771"> }</span>
<a href="#l20.772"></a><span id="l20.772"> </span>
<a href="#l20.773"></a><span id="l20.773"> NS_IMETHODIMP</span>
<a href="#l20.774"></a><span id="l20.774"> nsMsgBrkMBoxStore::MoveNewlyDownloadedMessage(nsIMsgDBHdr *aNewHdr,</span>
<a href="#l20.775"></a><span id="l20.775">                                               nsIMsgFolder *aDestFolder,</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineminus">-                                              bool *aResult)</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineminus">-{</span>
<a href="#l20.778"></a><span id="l20.778" class="difflineplus">+                                              bool *aResult) {</span>
<a href="#l20.779"></a><span id="l20.779">   NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l20.780"></a><span id="l20.780">   NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l20.781"></a><span id="l20.781">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.782"></a><span id="l20.782">   *aResult = false;</span>
<a href="#l20.783"></a><span id="l20.783">   return NS_OK;</span>
<a href="#l20.784"></a><span id="l20.784"> }</span>
<a href="#l20.785"></a><span id="l20.785"> </span>
<a href="#l20.786"></a><span id="l20.786"> NS_IMETHODIMP</span>
<a href="#l20.787"></a><span id="l20.787"> nsMsgBrkMBoxStore::GetMsgInputStream(nsIMsgFolder *aMsgFolder,</span>
<a href="#l20.788"></a><span id="l20.788">                                      const nsACString &amp;aMsgToken,</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineminus">-                                     int64_t *aOffset,</span>
<a href="#l20.790"></a><span id="l20.790" class="difflineminus">-                                     nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l20.791"></a><span id="l20.791" class="difflineplus">+                                     int64_t *aOffset, nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l20.792"></a><span id="l20.792">                                      bool *aReusable,</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-                                     nsIInputStream **aResult)</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineminus">-{</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineplus">+                                     nsIInputStream **aResult) {</span>
<a href="#l20.796"></a><span id="l20.796">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l20.797"></a><span id="l20.797">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l20.798"></a><span id="l20.798">   NS_ENSURE_ARG_POINTER(aOffset);</span>
<a href="#l20.799"></a><span id="l20.799"> </span>
<a href="#l20.800"></a><span id="l20.800">   // If there is no store token, then we set it to the existing message offset.</span>
<a href="#l20.801"></a><span id="l20.801" class="difflineminus">-  if (aMsgToken.IsEmpty())</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineminus">-  {</span>
<a href="#l20.803"></a><span id="l20.803" class="difflineplus">+  if (aMsgToken.IsEmpty()) {</span>
<a href="#l20.804"></a><span id="l20.804">     uint64_t offset;</span>
<a href="#l20.805"></a><span id="l20.805">     NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l20.806"></a><span id="l20.806">     aMsgHdr-&gt;GetMessageOffset(&amp;offset);</span>
<a href="#l20.807"></a><span id="l20.807">     *aOffset = int64_t(offset);</span>
<a href="#l20.808"></a><span id="l20.808">     char storeToken[100];</span>
<a href="#l20.809"></a><span id="l20.809">     PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, *aOffset);</span>
<a href="#l20.810"></a><span id="l20.810">     aMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l20.811"></a><span id="l20.811" class="difflineminus">-  }</span>
<a href="#l20.812"></a><span id="l20.812" class="difflineminus">-  else</span>
<a href="#l20.813"></a><span id="l20.813" class="difflineplus">+  } else</span>
<a href="#l20.814"></a><span id="l20.814">     *aOffset = ParseUint64Str(PromiseFlatCString(aMsgToken).get());</span>
<a href="#l20.815"></a><span id="l20.815">   *aReusable = true;</span>
<a href="#l20.816"></a><span id="l20.816">   nsCOMPtr&lt;nsIFile&gt; mboxFile;</span>
<a href="#l20.817"></a><span id="l20.817">   aMsgFolder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l20.818"></a><span id="l20.818">   return NS_NewLocalFileInputStream(aResult, mboxFile);</span>
<a href="#l20.819"></a><span id="l20.819"> }</span>
<a href="#l20.820"></a><span id="l20.820"> </span>
<a href="#l20.821"></a><span id="l20.821" class="difflineminus">-NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteMessages(nsIArray *aHdrArray)</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineminus">-{</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteMessages(nsIArray *aHdrArray) {</span>
<a href="#l20.824"></a><span id="l20.824">   return ChangeFlags(aHdrArray, nsMsgMessageFlags::Expunged, true);</span>
<a href="#l20.825"></a><span id="l20.825"> }</span>
<a href="#l20.826"></a><span id="l20.826"> </span>
<a href="#l20.827"></a><span id="l20.827"> NS_IMETHODIMP</span>
<a href="#l20.828"></a><span id="l20.828"> nsMsgBrkMBoxStore::CopyMessages(bool isMove, nsIArray *aHdrArray,</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineminus">-                               nsIMsgFolder *aDstFolder,</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineminus">-                               nsIMsgCopyServiceListener *aListener,</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineminus">-                               nsIArray **aDstHdrs,</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineminus">-                               nsITransaction **aUndoAction,</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineminus">-                               bool *aCopyDone)</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineminus">-{</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineplus">+                                nsIMsgFolder *aDstFolder,</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineplus">+                                nsIMsgCopyServiceListener *aListener,</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineplus">+                                nsIArray **aDstHdrs,</span>
<a href="#l20.838"></a><span id="l20.838" class="difflineplus">+                                nsITransaction **aUndoAction, bool *aCopyDone) {</span>
<a href="#l20.839"></a><span id="l20.839">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l20.840"></a><span id="l20.840">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l20.841"></a><span id="l20.841">   NS_ENSURE_ARG_POINTER(aDstHdrs);</span>
<a href="#l20.842"></a><span id="l20.842">   NS_ENSURE_ARG_POINTER(aCopyDone);</span>
<a href="#l20.843"></a><span id="l20.843">   *aDstHdrs = nullptr;</span>
<a href="#l20.844"></a><span id="l20.844">   *aUndoAction = nullptr;</span>
<a href="#l20.845"></a><span id="l20.845">   *aCopyDone = false;</span>
<a href="#l20.846"></a><span id="l20.846">   return NS_OK;</span>
<a href="#l20.847"></a><span id="l20.847"> }</span>
<a href="#l20.848"></a><span id="l20.848"> </span>
<a href="#l20.849"></a><span id="l20.849"> NS_IMETHODIMP</span>
<a href="#l20.850"></a><span id="l20.850" class="difflineminus">-nsMsgBrkMBoxStore::GetSupportsCompaction(bool *aSupportsCompaction)</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineminus">-{</span>
<a href="#l20.852"></a><span id="l20.852" class="difflineplus">+nsMsgBrkMBoxStore::GetSupportsCompaction(bool *aSupportsCompaction) {</span>
<a href="#l20.853"></a><span id="l20.853">   NS_ENSURE_ARG_POINTER(aSupportsCompaction);</span>
<a href="#l20.854"></a><span id="l20.854">   *aSupportsCompaction = true;</span>
<a href="#l20.855"></a><span id="l20.855">   return NS_OK;</span>
<a href="#l20.856"></a><span id="l20.856"> }</span>
<a href="#l20.857"></a><span id="l20.857"> </span>
<a href="#l20.858"></a><span id="l20.858"> NS_IMETHODIMP nsMsgBrkMBoxStore::CompactFolder(nsIMsgFolder *aFolder,</span>
<a href="#l20.859"></a><span id="l20.859">                                                nsIUrlListener *aListener,</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineminus">-                                               nsIMsgWindow *aMsgWindow)</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineminus">-{</span>
<a href="#l20.862"></a><span id="l20.862" class="difflineplus">+                                               nsIMsgWindow *aMsgWindow) {</span>
<a href="#l20.863"></a><span id="l20.863">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.864"></a><span id="l20.864">   nsresult rv;</span>
<a href="#l20.865"></a><span id="l20.865">   nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l20.866"></a><span id="l20.866" class="difflineminus">-    do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l20.867"></a><span id="l20.867" class="difflineplus">+      do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l20.868"></a><span id="l20.868">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.869"></a><span id="l20.869"> </span>
<a href="#l20.870"></a><span id="l20.870">   int64_t expungedBytes = 0;</span>
<a href="#l20.871"></a><span id="l20.871">   aFolder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l20.872"></a><span id="l20.872">   // check if we need to compact the folder</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineminus">-  return (expungedBytes &gt; 0) ?</span>
<a href="#l20.874"></a><span id="l20.874" class="difflineminus">-    folderCompactor-&gt;Compact(aFolder, false, aListener, aMsgWindow) :</span>
<a href="#l20.875"></a><span id="l20.875" class="difflineminus">-    aFolder-&gt;NotifyCompactCompleted();</span>
<a href="#l20.876"></a><span id="l20.876" class="difflineplus">+  return (expungedBytes &gt; 0)</span>
<a href="#l20.877"></a><span id="l20.877" class="difflineplus">+             ? folderCompactor-&gt;Compact(aFolder, false, aListener, aMsgWindow)</span>
<a href="#l20.878"></a><span id="l20.878" class="difflineplus">+             : aFolder-&gt;NotifyCompactCompleted();</span>
<a href="#l20.879"></a><span id="l20.879"> }</span>
<a href="#l20.880"></a><span id="l20.880"> </span>
<a href="#l20.881"></a><span id="l20.881"> NS_IMETHODIMP nsMsgBrkMBoxStore::RebuildIndex(nsIMsgFolder *aFolder,</span>
<a href="#l20.882"></a><span id="l20.882">                                               nsIMsgDatabase *aMsgDB,</span>
<a href="#l20.883"></a><span id="l20.883">                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l20.884"></a><span id="l20.884" class="difflineminus">-                                              nsIUrlListener *aListener)</span>
<a href="#l20.885"></a><span id="l20.885" class="difflineminus">-{</span>
<a href="#l20.886"></a><span id="l20.886" class="difflineplus">+                                              nsIUrlListener *aListener) {</span>
<a href="#l20.887"></a><span id="l20.887">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l20.888"></a><span id="l20.888">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l20.889"></a><span id="l20.889">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l20.890"></a><span id="l20.890" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l20.891"></a><span id="l20.891" class="difflineminus">-    return rv;</span>
<a href="#l20.892"></a><span id="l20.892" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.893"></a><span id="l20.893"> </span>
<a href="#l20.894"></a><span id="l20.894">   bool isLocked;</span>
<a href="#l20.895"></a><span id="l20.895">   aFolder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l20.896"></a><span id="l20.896" class="difflineminus">-  if (isLocked)</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineminus">-  {</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineplus">+  if (isLocked) {</span>
<a href="#l20.899"></a><span id="l20.899">     NS_ASSERTION(false, &quot;Could not get folder lock&quot;);</span>
<a href="#l20.900"></a><span id="l20.900">     return NS_MSG_FOLDER_BUSY;</span>
<a href="#l20.901"></a><span id="l20.901">   }</span>
<a href="#l20.902"></a><span id="l20.902"> </span>
<a href="#l20.903"></a><span id="l20.903">   nsCOMPtr&lt;nsIMailboxService&gt; mailboxService =</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineminus">-    do_GetService(NS_MAILBOXSERVICE_CONTRACTID1, &amp;rv);</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineplus">+      do_GetService(NS_MAILBOXSERVICE_CONTRACTID1, &amp;rv);</span>
<a href="#l20.906"></a><span id="l20.906">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.907"></a><span id="l20.907"> </span>
<a href="#l20.908"></a><span id="l20.908">   RefPtr&lt;nsMsgMailboxParser&gt; parser = new nsMsgMailboxParser(aFolder);</span>
<a href="#l20.909"></a><span id="l20.909">   NS_ENSURE_TRUE(parser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l20.910"></a><span id="l20.910">   rv = parser-&gt;Init();</span>
<a href="#l20.911"></a><span id="l20.911">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.912"></a><span id="l20.912"> </span>
<a href="#l20.913"></a><span id="l20.913">   rv = mailboxService-&gt;ParseMailbox(aMsgWindow, pathFile, parser, aListener,</span>
<a href="#l20.914"></a><span id="l20.914">                                     nullptr);</span>
<a href="#l20.915"></a><span id="l20.915" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineminus">-    ResetForceReparse(aMsgDB);</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineplus">+  if (NS_SUCCEEDED(rv)) ResetForceReparse(aMsgDB);</span>
<a href="#l20.918"></a><span id="l20.918">   return rv;</span>
<a href="#l20.919"></a><span id="l20.919"> }</span>
<a href="#l20.920"></a><span id="l20.920"> </span>
<a href="#l20.921"></a><span id="l20.921" class="difflineminus">-nsresult</span>
<a href="#l20.922"></a><span id="l20.922" class="difflineminus">-nsMsgBrkMBoxStore::GetOutputStream(nsIArray *aHdrArray,</span>
<a href="#l20.923"></a><span id="l20.923" class="difflineminus">-                                   nsCOMPtr&lt;nsIOutputStream&gt; &amp;outputStream,</span>
<a href="#l20.924"></a><span id="l20.924" class="difflineminus">-                                   nsCOMPtr&lt;nsISeekableStream&gt; &amp;seekableStream,</span>
<a href="#l20.925"></a><span id="l20.925" class="difflineminus">-                                   int64_t &amp;restorePos)</span>
<a href="#l20.926"></a><span id="l20.926" class="difflineminus">-{</span>
<a href="#l20.927"></a><span id="l20.927" class="difflineplus">+nsresult nsMsgBrkMBoxStore::GetOutputStream(</span>
<a href="#l20.928"></a><span id="l20.928" class="difflineplus">+    nsIArray *aHdrArray, nsCOMPtr&lt;nsIOutputStream&gt; &amp;outputStream,</span>
<a href="#l20.929"></a><span id="l20.929" class="difflineplus">+    nsCOMPtr&lt;nsISeekableStream&gt; &amp;seekableStream, int64_t &amp;restorePos) {</span>
<a href="#l20.930"></a><span id="l20.930">   nsresult rv;</span>
<a href="#l20.931"></a><span id="l20.931">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, 0, &amp;rv);</span>
<a href="#l20.932"></a><span id="l20.932">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.933"></a><span id="l20.933">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l20.934"></a><span id="l20.934">   msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l20.935"></a><span id="l20.935">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.936"></a><span id="l20.936">   nsCString URI;</span>
<a href="#l20.937"></a><span id="l20.937">   folder-&gt;GetURI(URI);</span>
<a href="#l20.938"></a><span id="l20.938">   restorePos = -1;</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineminus">-  if (m_outputStreams.Get(URI, getter_AddRefs(outputStream)))</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineminus">-  {</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineplus">+  if (m_outputStreams.Get(URI, getter_AddRefs(outputStream))) {</span>
<a href="#l20.942"></a><span id="l20.942">     seekableStream = do_QueryInterface(outputStream);</span>
<a href="#l20.943"></a><span id="l20.943">     rv = seekableStream-&gt;Tell(&amp;restorePos);</span>
<a href="#l20.944"></a><span id="l20.944" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l20.945"></a><span id="l20.945" class="difflineminus">-    {</span>
<a href="#l20.946"></a><span id="l20.946" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l20.947"></a><span id="l20.947">       outputStream = nullptr;</span>
<a href="#l20.948"></a><span id="l20.948">       m_outputStreams.Remove(URI);</span>
<a href="#l20.949"></a><span id="l20.949">     }</span>
<a href="#l20.950"></a><span id="l20.950">   }</span>
<a href="#l20.951"></a><span id="l20.951">   nsCOMPtr&lt;nsIFile&gt; mboxFile;</span>
<a href="#l20.952"></a><span id="l20.952">   folder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l20.953"></a><span id="l20.953" class="difflineminus">-  if (!outputStream)</span>
<a href="#l20.954"></a><span id="l20.954" class="difflineminus">-  {</span>
<a href="#l20.955"></a><span id="l20.955" class="difflineplus">+  if (!outputStream) {</span>
<a href="#l20.956"></a><span id="l20.956">     rv = MsgGetFileStream(mboxFile, getter_AddRefs(outputStream));</span>
<a href="#l20.957"></a><span id="l20.957">     seekableStream = do_QueryInterface(outputStream);</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineminus">-      m_outputStreams.Put(URI, outputStream);</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineplus">+    if (NS_SUCCEEDED(rv)) m_outputStreams.Put(URI, outputStream);</span>
<a href="#l20.961"></a><span id="l20.961">   }</span>
<a href="#l20.962"></a><span id="l20.962">   return rv;</span>
<a href="#l20.963"></a><span id="l20.963"> }</span>
<a href="#l20.964"></a><span id="l20.964"> </span>
<a href="#l20.965"></a><span id="l20.965" class="difflineminus">-void nsMsgBrkMBoxStore::SetDBValid(nsIMsgDBHdr *aHdr)</span>
<a href="#l20.966"></a><span id="l20.966" class="difflineminus">-{</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineplus">+void nsMsgBrkMBoxStore::SetDBValid(nsIMsgDBHdr *aHdr) {</span>
<a href="#l20.968"></a><span id="l20.968">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l20.969"></a><span id="l20.969">   aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l20.970"></a><span id="l20.970" class="difflineminus">-  if (folder)</span>
<a href="#l20.971"></a><span id="l20.971" class="difflineminus">-  {</span>
<a href="#l20.972"></a><span id="l20.972" class="difflineplus">+  if (folder) {</span>
<a href="#l20.973"></a><span id="l20.973">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l20.974"></a><span id="l20.974">     folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l20.975"></a><span id="l20.975" class="difflineminus">-    if (db)</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineminus">-      SetSummaryFileValid(folder, db, true);</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineplus">+    if (db) SetSummaryFileValid(folder, db, true);</span>
<a href="#l20.978"></a><span id="l20.978">   }</span>
<a href="#l20.979"></a><span id="l20.979"> }</span>
<a href="#l20.980"></a><span id="l20.980"> </span>
<a href="#l20.981"></a><span id="l20.981"> NS_IMETHODIMP nsMsgBrkMBoxStore::ChangeFlags(nsIArray *aHdrArray,</span>
<a href="#l20.982"></a><span id="l20.982" class="difflineminus">-                                             uint32_t aFlags,</span>
<a href="#l20.983"></a><span id="l20.983" class="difflineminus">-                                             bool aSet)</span>
<a href="#l20.984"></a><span id="l20.984" class="difflineminus">-{</span>
<a href="#l20.985"></a><span id="l20.985" class="difflineplus">+                                             uint32_t aFlags, bool aSet) {</span>
<a href="#l20.986"></a><span id="l20.986">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l20.987"></a><span id="l20.987">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l20.988"></a><span id="l20.988">   nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l20.989"></a><span id="l20.989">   int64_t restoreStreamPos;</span>
<a href="#l20.990"></a><span id="l20.990"> </span>
<a href="#l20.991"></a><span id="l20.991">   uint32_t messageCount;</span>
<a href="#l20.992"></a><span id="l20.992">   nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l20.993"></a><span id="l20.993">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.994"></a><span id="l20.994" class="difflineminus">-  if (!messageCount)</span>
<a href="#l20.995"></a><span id="l20.995" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l20.996"></a><span id="l20.996" class="difflineplus">+  if (!messageCount) return NS_ERROR_INVALID_ARG;</span>
<a href="#l20.997"></a><span id="l20.997"> </span>
<a href="#l20.998"></a><span id="l20.998">   rv = GetOutputStream(aHdrArray, outputStream, seekableStream,</span>
<a href="#l20.999"></a><span id="l20.999">                        restoreStreamPos);</span>
<a href="#l20.1000"></a><span id="l20.1000">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1001"></a><span id="l20.1001"> </span>
<a href="#l20.1002"></a><span id="l20.1002">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l20.1003"></a><span id="l20.1003" class="difflineminus">-  for (uint32_t i = 0; i &lt; messageCount; i++)</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineminus">-  {</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineplus">+  for (uint32_t i = 0; i &lt; messageCount; i++) {</span>
<a href="#l20.1006"></a><span id="l20.1006">     msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l20.1007"></a><span id="l20.1007">     // Seek to x-mozilla-status offset and rewrite value.</span>
<a href="#l20.1008"></a><span id="l20.1008">     rv = UpdateFolderFlag(msgHdr, aSet, aFlags, outputStream);</span>
<a href="#l20.1009"></a><span id="l20.1009" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l20.1010"></a><span id="l20.1010" class="difflineminus">-    {</span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l20.1012"></a><span id="l20.1012">       NS_WARNING(&quot;updateFolderFlag failed&quot;);</span>
<a href="#l20.1013"></a><span id="l20.1013">       break;</span>
<a href="#l20.1014"></a><span id="l20.1014">     }</span>
<a href="#l20.1015"></a><span id="l20.1015">   }</span>
<a href="#l20.1016"></a><span id="l20.1016">   if (restoreStreamPos != -1)</span>
<a href="#l20.1017"></a><span id="l20.1017">     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, restoreStreamPos);</span>
<a href="#l20.1018"></a><span id="l20.1018">   else if (outputStream)</span>
<a href="#l20.1019"></a><span id="l20.1019">     outputStream-&gt;Close();</span>
<a href="#l20.1020"></a><span id="l20.1020" class="difflineminus">-  if (messageCount &gt; 0)</span>
<a href="#l20.1021"></a><span id="l20.1021" class="difflineminus">-  {</span>
<a href="#l20.1022"></a><span id="l20.1022" class="difflineplus">+  if (messageCount &gt; 0) {</span>
<a href="#l20.1023"></a><span id="l20.1023">     msgHdr = do_QueryElementAt(aHdrArray, 0);</span>
<a href="#l20.1024"></a><span id="l20.1024">     SetDBValid(msgHdr);</span>
<a href="#l20.1025"></a><span id="l20.1025">   }</span>
<a href="#l20.1026"></a><span id="l20.1026">   return NS_OK;</span>
<a href="#l20.1027"></a><span id="l20.1027"> }</span>
<a href="#l20.1028"></a><span id="l20.1028"> </span>
<a href="#l20.1029"></a><span id="l20.1029"> NS_IMETHODIMP nsMsgBrkMBoxStore::ChangeKeywords(nsIArray *aHdrArray,</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineminus">-                                             const nsACString &amp;aKeywords,</span>
<a href="#l20.1031"></a><span id="l20.1031" class="difflineminus">-                                             bool aAdd)</span>
<a href="#l20.1032"></a><span id="l20.1032" class="difflineminus">-{</span>
<a href="#l20.1033"></a><span id="l20.1033" class="difflineplus">+                                                const nsACString &amp;aKeywords,</span>
<a href="#l20.1034"></a><span id="l20.1034" class="difflineplus">+                                                bool aAdd) {</span>
<a href="#l20.1035"></a><span id="l20.1035">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l20.1036"></a><span id="l20.1036">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l20.1037"></a><span id="l20.1037">   nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l20.1038"></a><span id="l20.1038">   int64_t restoreStreamPos;</span>
<a href="#l20.1039"></a><span id="l20.1039"> </span>
<a href="#l20.1040"></a><span id="l20.1040">   uint32_t messageCount;</span>
<a href="#l20.1041"></a><span id="l20.1041">   nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l20.1042"></a><span id="l20.1042">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1043"></a><span id="l20.1043" class="difflineminus">-  if (!messageCount)</span>
<a href="#l20.1044"></a><span id="l20.1044" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l20.1045"></a><span id="l20.1045" class="difflineplus">+  if (!messageCount) return NS_ERROR_INVALID_ARG;</span>
<a href="#l20.1046"></a><span id="l20.1046"> </span>
<a href="#l20.1047"></a><span id="l20.1047">   rv = GetOutputStream(aHdrArray, outputStream, seekableStream,</span>
<a href="#l20.1048"></a><span id="l20.1048">                        restoreStreamPos);</span>
<a href="#l20.1049"></a><span id="l20.1049">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1050"></a><span id="l20.1050"> </span>
<a href="#l20.1051"></a><span id="l20.1051">   nsCOMPtr&lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream, &amp;rv);</span>
<a href="#l20.1052"></a><span id="l20.1052">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1053"></a><span id="l20.1053"> </span>
<a href="#l20.1054"></a><span id="l20.1054" class="difflineat">@@ -972,151 +878,133 @@ NS_IMETHODIMP nsMsgBrkMBoxStore::ChangeK</span>
<a href="#l20.1055"></a><span id="l20.1055">   // we can't do anything until the folder is compacted and another</span>
<a href="#l20.1056"></a><span id="l20.1056">   // x-mozilla-keys header is added. In that case, we set a property</span>
<a href="#l20.1057"></a><span id="l20.1057">   // on the header, which the compaction code will check.</span>
<a href="#l20.1058"></a><span id="l20.1058"> </span>
<a href="#l20.1059"></a><span id="l20.1059">   nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l20.1060"></a><span id="l20.1060">   ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l20.1061"></a><span id="l20.1061"> </span>
<a href="#l20.1062"></a><span id="l20.1062">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l20.1063"></a><span id="l20.1063" class="difflineminus">-  for (uint32_t i = 0; i &lt; messageCount; ++i) // for each message</span>
<a href="#l20.1064"></a><span id="l20.1064" class="difflineplus">+  for (uint32_t i = 0; i &lt; messageCount; ++i)  // for each message</span>
<a href="#l20.1065"></a><span id="l20.1065">   {</span>
<a href="#l20.1066"></a><span id="l20.1066">     msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l20.1067"></a><span id="l20.1067">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1068"></a><span id="l20.1068">     uint64_t messageOffset;</span>
<a href="#l20.1069"></a><span id="l20.1069">     msgHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l20.1070"></a><span id="l20.1070">     uint32_t statusOffset = 0;</span>
<a href="#l20.1071"></a><span id="l20.1071">     (void)msgHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l20.1072"></a><span id="l20.1072">     uint64_t desiredOffset = messageOffset + statusOffset;</span>
<a href="#l20.1073"></a><span id="l20.1073"> </span>
<a href="#l20.1074"></a><span id="l20.1074" class="difflineminus">-    ChangeKeywordsHelper(msgHdr, desiredOffset, lineBuffer, keywordArray,</span>
<a href="#l20.1075"></a><span id="l20.1075" class="difflineminus">-                         aAdd, outputStream, seekableStream, inputStream);</span>
<a href="#l20.1076"></a><span id="l20.1076" class="difflineplus">+    ChangeKeywordsHelper(msgHdr, desiredOffset, lineBuffer, keywordArray, aAdd,</span>
<a href="#l20.1077"></a><span id="l20.1077" class="difflineplus">+                         outputStream, seekableStream, inputStream);</span>
<a href="#l20.1078"></a><span id="l20.1078">   }</span>
<a href="#l20.1079"></a><span id="l20.1079">   lineBuffer = nullptr;</span>
<a href="#l20.1080"></a><span id="l20.1080">   if (restoreStreamPos != -1)</span>
<a href="#l20.1081"></a><span id="l20.1081">     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, restoreStreamPos);</span>
<a href="#l20.1082"></a><span id="l20.1082">   else if (outputStream)</span>
<a href="#l20.1083"></a><span id="l20.1083">     outputStream-&gt;Close();</span>
<a href="#l20.1084"></a><span id="l20.1084" class="difflineminus">-  if (messageCount &gt; 0)</span>
<a href="#l20.1085"></a><span id="l20.1085" class="difflineminus">-  {</span>
<a href="#l20.1086"></a><span id="l20.1086" class="difflineplus">+  if (messageCount &gt; 0) {</span>
<a href="#l20.1087"></a><span id="l20.1087">     msgHdr = do_QueryElementAt(aHdrArray, 0);</span>
<a href="#l20.1088"></a><span id="l20.1088">     SetDBValid(msgHdr);</span>
<a href="#l20.1089"></a><span id="l20.1089">   }</span>
<a href="#l20.1090"></a><span id="l20.1090">   return NS_OK;</span>
<a href="#l20.1091"></a><span id="l20.1091"> }</span>
<a href="#l20.1092"></a><span id="l20.1092"> </span>
<a href="#l20.1093"></a><span id="l20.1093" class="difflineminus">-NS_IMETHODIMP nsMsgBrkMBoxStore::GetStoreType(nsACString&amp; aType)</span>
<a href="#l20.1094"></a><span id="l20.1094" class="difflineminus">-{</span>
<a href="#l20.1095"></a><span id="l20.1095" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::GetStoreType(nsACString &amp;aType) {</span>
<a href="#l20.1096"></a><span id="l20.1096">   aType.AssignLiteral(&quot;mbox&quot;);</span>
<a href="#l20.1097"></a><span id="l20.1097">   return NS_OK;</span>
<a href="#l20.1098"></a><span id="l20.1098"> }</span>
<a href="#l20.1099"></a><span id="l20.1099"> </span>
<a href="#l20.1100"></a><span id="l20.1100"> // Iterates over the files in the &quot;path&quot; directory, and adds subfolders to</span>
<a href="#l20.1101"></a><span id="l20.1101"> // parent for each mailbox file found.</span>
<a href="#l20.1102"></a><span id="l20.1102" class="difflineminus">-nsresult</span>
<a href="#l20.1103"></a><span id="l20.1103" class="difflineminus">-nsMsgBrkMBoxStore::AddSubFolders(nsIMsgFolder *parent, nsCOMPtr&lt;nsIFile&gt; &amp;path,</span>
<a href="#l20.1104"></a><span id="l20.1104" class="difflineminus">-                                 bool deep)</span>
<a href="#l20.1105"></a><span id="l20.1105" class="difflineminus">-{</span>
<a href="#l20.1106"></a><span id="l20.1106" class="difflineplus">+nsresult nsMsgBrkMBoxStore::AddSubFolders(nsIMsgFolder *parent,</span>
<a href="#l20.1107"></a><span id="l20.1107" class="difflineplus">+                                          nsCOMPtr&lt;nsIFile&gt; &amp;path, bool deep) {</span>
<a href="#l20.1108"></a><span id="l20.1108">   nsresult rv;</span>
<a href="#l20.1109"></a><span id="l20.1109" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; tmp; // at top level so we can safely assign to path</span>
<a href="#l20.1110"></a><span id="l20.1110" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmp;  // at top level so we can safely assign to path</span>
<a href="#l20.1111"></a><span id="l20.1111">   bool isDirectory;</span>
<a href="#l20.1112"></a><span id="l20.1112">   path-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l20.1113"></a><span id="l20.1113" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l20.1114"></a><span id="l20.1114" class="difflineminus">-  {</span>
<a href="#l20.1115"></a><span id="l20.1115" class="difflineplus">+  if (!isDirectory) {</span>
<a href="#l20.1116"></a><span id="l20.1116">     rv = path-&gt;Clone(getter_AddRefs(tmp));</span>
<a href="#l20.1117"></a><span id="l20.1117">     path = tmp;</span>
<a href="#l20.1118"></a><span id="l20.1118">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1119"></a><span id="l20.1119">     nsAutoString leafName;</span>
<a href="#l20.1120"></a><span id="l20.1120">     path-&gt;GetLeafName(leafName);</span>
<a href="#l20.1121"></a><span id="l20.1121">     leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l20.1122"></a><span id="l20.1122">     path-&gt;SetLeafName(leafName);</span>
<a href="#l20.1123"></a><span id="l20.1123">     path-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l20.1124"></a><span id="l20.1124">   }</span>
<a href="#l20.1125"></a><span id="l20.1125" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l20.1126"></a><span id="l20.1126" class="difflineminus">-    return NS_OK;</span>
<a href="#l20.1127"></a><span id="l20.1127" class="difflineplus">+  if (!isDirectory) return NS_OK;</span>
<a href="#l20.1128"></a><span id="l20.1128">   // first find out all the current subfolders and files, before using them</span>
<a href="#l20.1129"></a><span id="l20.1129">   // while creating new subfolders; we don't want to modify and iterate the same</span>
<a href="#l20.1130"></a><span id="l20.1130">   // directory at once.</span>
<a href="#l20.1131"></a><span id="l20.1131">   nsCOMArray&lt;nsIFile&gt; currentDirEntries;</span>
<a href="#l20.1132"></a><span id="l20.1132">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l20.1133"></a><span id="l20.1133">   rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l20.1134"></a><span id="l20.1134">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l20.1135"></a><span id="l20.1135"> </span>
<a href="#l20.1136"></a><span id="l20.1136">   bool hasMore;</span>
<a href="#l20.1137"></a><span id="l20.1137">   while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l20.1138"></a><span id="l20.1138" class="difflineminus">-         hasMore)</span>
<a href="#l20.1139"></a><span id="l20.1139" class="difflineminus">-  {</span>
<a href="#l20.1140"></a><span id="l20.1140" class="difflineplus">+         hasMore) {</span>
<a href="#l20.1141"></a><span id="l20.1141">     nsCOMPtr&lt;nsIFile&gt; currentFile;</span>
<a href="#l20.1142"></a><span id="l20.1142">     directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile));</span>
<a href="#l20.1143"></a><span id="l20.1143" class="difflineminus">-    if (currentFile)</span>
<a href="#l20.1144"></a><span id="l20.1144" class="difflineminus">-      currentDirEntries.AppendObject(currentFile);</span>
<a href="#l20.1145"></a><span id="l20.1145" class="difflineplus">+    if (currentFile) currentDirEntries.AppendObject(currentFile);</span>
<a href="#l20.1146"></a><span id="l20.1146">   }</span>
<a href="#l20.1147"></a><span id="l20.1147"> </span>
<a href="#l20.1148"></a><span id="l20.1148">   // add the folders</span>
<a href="#l20.1149"></a><span id="l20.1149">   int32_t count = currentDirEntries.Count();</span>
<a href="#l20.1150"></a><span id="l20.1150" class="difflineminus">-  for (int32_t i = 0; i &lt; count; ++i)</span>
<a href="#l20.1151"></a><span id="l20.1151" class="difflineminus">-  {</span>
<a href="#l20.1152"></a><span id="l20.1152" class="difflineplus">+  for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l20.1153"></a><span id="l20.1153">     nsCOMPtr&lt;nsIFile&gt; currentFile(currentDirEntries[i]);</span>
<a href="#l20.1154"></a><span id="l20.1154"> </span>
<a href="#l20.1155"></a><span id="l20.1155">     nsAutoString leafName;</span>
<a href="#l20.1156"></a><span id="l20.1156">     currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l20.1157"></a><span id="l20.1157">     directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l20.1158"></a><span id="l20.1158">     // here we should handle the case where the current file is a .sbd directory</span>
<a href="#l20.1159"></a><span id="l20.1159">     // w/o a matching folder file, or a directory w/o the name .sbd</span>
<a href="#l20.1160"></a><span id="l20.1160" class="difflineminus">-    if (nsShouldIgnoreFile(leafName))</span>
<a href="#l20.1161"></a><span id="l20.1161" class="difflineminus">-      continue;</span>
<a href="#l20.1162"></a><span id="l20.1162" class="difflineplus">+    if (nsShouldIgnoreFile(leafName)) continue;</span>
<a href="#l20.1163"></a><span id="l20.1163"> </span>
<a href="#l20.1164"></a><span id="l20.1164">     nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l20.1165"></a><span id="l20.1165">     rv = parent-&gt;AddSubfolder(leafName, getter_AddRefs(child));</span>
<a href="#l20.1166"></a><span id="l20.1166" class="difflineminus">-    if (child)</span>
<a href="#l20.1167"></a><span id="l20.1167" class="difflineminus">-    {</span>
<a href="#l20.1168"></a><span id="l20.1168" class="difflineplus">+    if (child) {</span>
<a href="#l20.1169"></a><span id="l20.1169">       nsString folderName;</span>
<a href="#l20.1170"></a><span id="l20.1170">       child-&gt;GetName(folderName);  // try to get it from cache/db</span>
<a href="#l20.1171"></a><span id="l20.1171" class="difflineminus">-      if (folderName.IsEmpty())</span>
<a href="#l20.1172"></a><span id="l20.1172" class="difflineminus">-        child-&gt;SetPrettyName(leafName);</span>
<a href="#l20.1173"></a><span id="l20.1173" class="difflineminus">-      if (deep)</span>
<a href="#l20.1174"></a><span id="l20.1174" class="difflineminus">-      {</span>
<a href="#l20.1175"></a><span id="l20.1175" class="difflineplus">+      if (folderName.IsEmpty()) child-&gt;SetPrettyName(leafName);</span>
<a href="#l20.1176"></a><span id="l20.1176" class="difflineplus">+      if (deep) {</span>
<a href="#l20.1177"></a><span id="l20.1177">         nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l20.1178"></a><span id="l20.1178">         rv = child-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l20.1179"></a><span id="l20.1179">         AddSubFolders(child, path, true);</span>
<a href="#l20.1180"></a><span id="l20.1180">       }</span>
<a href="#l20.1181"></a><span id="l20.1181">     }</span>
<a href="#l20.1182"></a><span id="l20.1182">   }</span>
<a href="#l20.1183"></a><span id="l20.1183">   return rv == NS_MSG_FOLDER_EXISTS ? NS_OK : rv;</span>
<a href="#l20.1184"></a><span id="l20.1184"> }</span>
<a href="#l20.1185"></a><span id="l20.1185"> </span>
<a href="#l20.1186"></a><span id="l20.1186"> /* Finds the directory associated with this folder.  That is if the path is</span>
<a href="#l20.1187"></a><span id="l20.1187">    c:\Inbox, it will return c:\Inbox.sbd if it succeeds.  If that path doesn't</span>
<a href="#l20.1188"></a><span id="l20.1188">    currently exist then it will create it. Path is strictly an out parameter.</span>
<a href="#l20.1189"></a><span id="l20.1189">   */</span>
<a href="#l20.1190"></a><span id="l20.1190" class="difflineminus">-nsresult nsMsgBrkMBoxStore::CreateDirectoryForFolder(nsIFile *path)</span>
<a href="#l20.1191"></a><span id="l20.1191" class="difflineminus">-{</span>
<a href="#l20.1192"></a><span id="l20.1192" class="difflineplus">+nsresult nsMsgBrkMBoxStore::CreateDirectoryForFolder(nsIFile *path) {</span>
<a href="#l20.1193"></a><span id="l20.1193">   nsresult rv = NS_OK;</span>
<a href="#l20.1194"></a><span id="l20.1194"> </span>
<a href="#l20.1195"></a><span id="l20.1195">   bool pathIsDirectory = false;</span>
<a href="#l20.1196"></a><span id="l20.1196">   path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l20.1197"></a><span id="l20.1197" class="difflineminus">-  if (!pathIsDirectory)</span>
<a href="#l20.1198"></a><span id="l20.1198" class="difflineminus">-  {</span>
<a href="#l20.1199"></a><span id="l20.1199" class="difflineplus">+  if (!pathIsDirectory) {</span>
<a href="#l20.1200"></a><span id="l20.1200">     // If the current path isn't a directory, add directory separator</span>
<a href="#l20.1201"></a><span id="l20.1201">     // and test it out.</span>
<a href="#l20.1202"></a><span id="l20.1202">     nsAutoString leafName;</span>
<a href="#l20.1203"></a><span id="l20.1203">     path-&gt;GetLeafName(leafName);</span>
<a href="#l20.1204"></a><span id="l20.1204">     leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l20.1205"></a><span id="l20.1205">     rv = path-&gt;SetLeafName(leafName);</span>
<a href="#l20.1206"></a><span id="l20.1206" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l20.1207"></a><span id="l20.1207" class="difflineminus">-      return rv;</span>
<a href="#l20.1208"></a><span id="l20.1208" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.1209"></a><span id="l20.1209"> </span>
<a href="#l20.1210"></a><span id="l20.1210" class="difflineminus">-    //If that doesn't exist, then we have to create this directory</span>
<a href="#l20.1211"></a><span id="l20.1211" class="difflineplus">+    // If that doesn't exist, then we have to create this directory</span>
<a href="#l20.1212"></a><span id="l20.1212">     pathIsDirectory = false;</span>
<a href="#l20.1213"></a><span id="l20.1213">     path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l20.1214"></a><span id="l20.1214" class="difflineminus">-    if (!pathIsDirectory)</span>
<a href="#l20.1215"></a><span id="l20.1215" class="difflineminus">-    {</span>
<a href="#l20.1216"></a><span id="l20.1216" class="difflineplus">+    if (!pathIsDirectory) {</span>
<a href="#l20.1217"></a><span id="l20.1217">       bool pathExists;</span>
<a href="#l20.1218"></a><span id="l20.1218">       path-&gt;Exists(&amp;pathExists);</span>
<a href="#l20.1219"></a><span id="l20.1219" class="difflineminus">-      //If for some reason there's a file with the directory separator</span>
<a href="#l20.1220"></a><span id="l20.1220" class="difflineminus">-      //then we are going to fail.</span>
<a href="#l20.1221"></a><span id="l20.1221" class="difflineminus">-      rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY :</span>
<a href="#l20.1222"></a><span id="l20.1222" class="difflineminus">-             path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l20.1223"></a><span id="l20.1223" class="difflineplus">+      // If for some reason there's a file with the directory separator</span>
<a href="#l20.1224"></a><span id="l20.1224" class="difflineplus">+      // then we are going to fail.</span>
<a href="#l20.1225"></a><span id="l20.1225" class="difflineplus">+      rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY</span>
<a href="#l20.1226"></a><span id="l20.1226" class="difflineplus">+                      : path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l20.1227"></a><span id="l20.1227">     }</span>
<a href="#l20.1228"></a><span id="l20.1228">   }</span>
<a href="#l20.1229"></a><span id="l20.1229">   return rv;</span>
<a href="#l20.1230"></a><span id="l20.1230"> }</span>
<a href="#l20.1231"></a><span id="l20.1231" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/local/src/nsMsgBrkMBoxStore.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgBrkMBoxStore.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -11,36 +11,37 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #define nsMsgBrkMboxStore_h__</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsMsgLocalStoreUtils.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIFile.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-class nsMsgBrkMBoxStore final : public nsMsgLocalStoreUtils, nsIMsgPluggableStore</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-{</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-public:</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+class nsMsgBrkMBoxStore final : public nsMsgLocalStoreUtils,</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+                                nsIMsgPluggableStore {</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+ public:</span>
<a href="#l21.18"></a><span id="l21.18">   NS_DECL_ISUPPORTS</span>
<a href="#l21.19"></a><span id="l21.19">   NS_DECL_NSIMSGPLUGGABLESTORE</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21">   nsMsgBrkMBoxStore();</span>
<a href="#l21.22"></a><span id="l21.22"> </span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-private:</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+ private:</span>
<a href="#l21.25"></a><span id="l21.25">   ~nsMsgBrkMBoxStore();</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-protected:</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-  nsresult AddSubFolders(nsIMsgFolder *parent, nsCOMPtr&lt;nsIFile&gt; &amp;path, bool deep);</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+ protected:</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+  nsresult AddSubFolders(nsIMsgFolder *parent, nsCOMPtr&lt;nsIFile&gt; &amp;path,</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+                         bool deep);</span>
<a href="#l21.32"></a><span id="l21.32">   nsresult CreateDirectoryForFolder(nsIFile *path);</span>
<a href="#l21.33"></a><span id="l21.33">   nsresult GetOutputStream(nsIArray *aHdrArray,</span>
<a href="#l21.34"></a><span id="l21.34">                            nsCOMPtr&lt;nsIOutputStream&gt; &amp;outputStream,</span>
<a href="#l21.35"></a><span id="l21.35">                            nsCOMPtr&lt;nsISeekableStream&gt; &amp;seekableStream,</span>
<a href="#l21.36"></a><span id="l21.36">                            int64_t &amp;restorePos);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  void GetMailboxModProperties(nsIMsgFolder *aFolder,</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-                               int64_t *aSize, uint32_t *aDate);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+  void GetMailboxModProperties(nsIMsgFolder *aFolder, int64_t *aSize,</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+                               uint32_t *aDate);</span>
<a href="#l21.41"></a><span id="l21.41">   void SetDBValid(nsIMsgDBHdr *aHdr);</span>
<a href="#l21.42"></a><span id="l21.42">   // We don't want to keep re-opening an output stream when downloading</span>
<a href="#l21.43"></a><span id="l21.43">   // multiple pop3 messages, or adjusting x-mozilla-status headers, so</span>
<a href="#l21.44"></a><span id="l21.44">   // we cache output streams based on folder uri's. If the caller has closed</span>
<a href="#l21.45"></a><span id="l21.45">   // the stream, we'll get a new one.</span>
<a href="#l21.46"></a><span id="l21.46">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIOutputStream&gt; m_outputStreams;</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48"> #ifdef _DEBUG</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,40 +1,33 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.5"></a><span id="l22.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsMsgLocalStoreUtils.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12"> #include &quot;nsIFile.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;prprf.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-#define EXTRA_SAFETY_SPACE 0x400000 // (4MiB)</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+#define EXTRA_SAFETY_SPACE 0x400000  // (4MiB)</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-nsMsgLocalStoreUtils::nsMsgLocalStoreUtils()</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-{</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-}</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+nsMsgLocalStoreUtils::nsMsgLocalStoreUtils() {}</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-nsresult</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-nsMsgLocalStoreUtils::AddDirectorySeparator(nsIFile *path)</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-{</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+nsresult nsMsgLocalStoreUtils::AddDirectorySeparator(nsIFile *path) {</span>
<a href="#l22.29"></a><span id="l22.29">   nsAutoString leafName;</span>
<a href="#l22.30"></a><span id="l22.30">   path-&gt;GetLeafName(leafName);</span>
<a href="#l22.31"></a><span id="l22.31">   leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l22.32"></a><span id="l22.32">   return path-&gt;SetLeafName(leafName);</span>
<a href="#l22.33"></a><span id="l22.33"> }</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-bool</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-nsMsgLocalStoreUtils::nsShouldIgnoreFile(nsAString&amp; name)</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-{</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-  if (name.IsEmpty())</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-    return true;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+bool nsMsgLocalStoreUtils::nsShouldIgnoreFile(nsAString &amp;name) {</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+  if (name.IsEmpty()) return true;</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43">   char16_t firstChar = name.First();</span>
<a href="#l22.44"></a><span id="l22.44">   if (firstChar == '.' || firstChar == '#' ||</span>
<a href="#l22.45"></a><span id="l22.45">       name.CharAt(name.Length() - 1) == '~')</span>
<a href="#l22.46"></a><span id="l22.46">     return true;</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48">   if (name.LowerCaseEqualsLiteral(&quot;msgfilterrules.dat&quot;) ||</span>
<a href="#l22.49"></a><span id="l22.49">       name.LowerCaseEqualsLiteral(&quot;rules.dat&quot;) ||</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineat">@@ -55,294 +48,267 @@ nsMsgLocalStoreUtils::nsShouldIgnoreFile</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52">   // ignore RSS data source files</span>
<a href="#l22.53"></a><span id="l22.53">   if (name.LowerCaseEqualsLiteral(&quot;feeds.rdf&quot;) ||</span>
<a href="#l22.54"></a><span id="l22.54">       name.LowerCaseEqualsLiteral(&quot;feeditems.rdf&quot;) ||</span>
<a href="#l22.55"></a><span id="l22.55">       StringBeginsWith(name, NS_LITERAL_STRING(&quot;feeditems_error&quot;)))</span>
<a href="#l22.56"></a><span id="l22.56">     return true;</span>
<a href="#l22.57"></a><span id="l22.57"> </span>
<a href="#l22.58"></a><span id="l22.58">   // The .mozmsgs dir is for spotlight support</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-    return (StringEndsWith(name, NS_LITERAL_STRING(&quot;.mozmsgs&quot;)) ||</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-            StringEndsWith(name, NS_LITERAL_STRING(FOLDER_SUFFIX)) ||</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-            StringEndsWith(name, NS_LITERAL_STRING(SUMMARY_SUFFIX)));</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+  return (StringEndsWith(name, NS_LITERAL_STRING(&quot;.mozmsgs&quot;)) ||</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+          StringEndsWith(name, NS_LITERAL_STRING(FOLDER_SUFFIX)) ||</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+          StringEndsWith(name, NS_LITERAL_STRING(SUMMARY_SUFFIX)));</span>
<a href="#l22.65"></a><span id="l22.65"> }</span>
<a href="#l22.66"></a><span id="l22.66"> </span>
<a href="#l22.67"></a><span id="l22.67"> /**</span>
<a href="#l22.68"></a><span id="l22.68">  * We're passed a stream positioned at the start of the message.</span>
<a href="#l22.69"></a><span id="l22.69">  * We start reading lines, looking for x-mozilla-keys: headers; If we're</span>
<a href="#l22.70"></a><span id="l22.70">  * adding the keyword and we find a header with the desired keyword already</span>
<a href="#l22.71"></a><span id="l22.71">  * in it, we don't need to do anything. Likewise, if removing keyword and we</span>
<a href="#l22.72"></a><span id="l22.72">  * don't find it,we don't need to do anything. Otherwise, if adding, we need</span>
<a href="#l22.73"></a><span id="l22.73">  * to see if there's an x-mozilla-keys header with room for the new keyword.</span>
<a href="#l22.74"></a><span id="l22.74">  *  If so, we replace the corresponding number of spaces with the keyword.</span>
<a href="#l22.75"></a><span id="l22.75">  * If no room, we can't do anything until the folder is compacted and another</span>
<a href="#l22.76"></a><span id="l22.76">  * x-mozilla-keys header is added. In that case, we set a property</span>
<a href="#l22.77"></a><span id="l22.77">  * on the header, which the compaction code will check.</span>
<a href="#l22.78"></a><span id="l22.78">  * This is not true for maildir, however, since it won't require compaction.</span>
<a href="#l22.79"></a><span id="l22.79">  */</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-void</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-nsMsgLocalStoreUtils::ChangeKeywordsHelper(nsIMsgDBHdr *message,</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-                                           uint64_t desiredOffset,</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-                                           nsLineBuffer&lt;char&gt; *lineBuffer,</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-                                           nsTArray&lt;nsCString&gt; &amp;keywordArray,</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-                                           bool aAdd,</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-                                           nsIOutputStream *outputStream,</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-                                           nsISeekableStream *seekableStream,</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-                                           nsIInputStream *inputStream)</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-{</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+void nsMsgLocalStoreUtils::ChangeKeywordsHelper(</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+    nsIMsgDBHdr *message, uint64_t desiredOffset,</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+    nsLineBuffer&lt;char&gt; *lineBuffer, nsTArray&lt;nsCString&gt; &amp;keywordArray,</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+    bool aAdd, nsIOutputStream *outputStream, nsISeekableStream *seekableStream,</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineplus">+    nsIInputStream *inputStream) {</span>
<a href="#l22.96"></a><span id="l22.96">   uint32_t bytesWritten;</span>
<a href="#l22.97"></a><span id="l22.97"> </span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-  for (uint32_t i = 0; i &lt; keywordArray.Length(); i++)</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-  {</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+  for (uint32_t i = 0; i &lt; keywordArray.Length(); i++) {</span>
<a href="#l22.101"></a><span id="l22.101">     nsAutoCString header;</span>
<a href="#l22.102"></a><span id="l22.102">     nsAutoCString keywords;</span>
<a href="#l22.103"></a><span id="l22.103">     bool done = false;</span>
<a href="#l22.104"></a><span id="l22.104">     uint32_t len = 0;</span>
<a href="#l22.105"></a><span id="l22.105">     nsAutoCString keywordToWrite(&quot; &quot;);</span>
<a href="#l22.106"></a><span id="l22.106"> </span>
<a href="#l22.107"></a><span id="l22.107">     keywordToWrite.Append(keywordArray[i]);</span>
<a href="#l22.108"></a><span id="l22.108">     seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, desiredOffset);</span>
<a href="#l22.109"></a><span id="l22.109">     // need to reset lineBuffer, which is cheaper than creating a new one.</span>
<a href="#l22.110"></a><span id="l22.110">     lineBuffer-&gt;start = lineBuffer-&gt;end = lineBuffer-&gt;buf;</span>
<a href="#l22.111"></a><span id="l22.111">     bool inKeywordHeader = false;</span>
<a href="#l22.112"></a><span id="l22.112">     bool foundKeyword = false;</span>
<a href="#l22.113"></a><span id="l22.113">     int64_t offsetToAddKeyword = 0;</span>
<a href="#l22.114"></a><span id="l22.114">     bool more;</span>
<a href="#l22.115"></a><span id="l22.115">     message-&gt;GetMessageSize(&amp;len);</span>
<a href="#l22.116"></a><span id="l22.116">     // loop through</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-    while (!done)</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-    {</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+    while (!done) {</span>
<a href="#l22.120"></a><span id="l22.120">       int64_t lineStartPos;</span>
<a href="#l22.121"></a><span id="l22.121">       seekableStream-&gt;Tell(&amp;lineStartPos);</span>
<a href="#l22.122"></a><span id="l22.122">       // we need to adjust the linestart pos by how much extra the line</span>
<a href="#l22.123"></a><span id="l22.123">       // buffer has read from the stream.</span>
<a href="#l22.124"></a><span id="l22.124">       lineStartPos -= (lineBuffer-&gt;end - lineBuffer-&gt;start);</span>
<a href="#l22.125"></a><span id="l22.125">       // NS_ReadLine doesn't return line termination chars.</span>
<a href="#l22.126"></a><span id="l22.126">       nsCString keywordHeaders;</span>
<a href="#l22.127"></a><span id="l22.127">       nsresult rv = NS_ReadLine(inputStream, lineBuffer, keywordHeaders, &amp;more);</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-      {</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.131"></a><span id="l22.131">         if (keywordHeaders.IsEmpty())</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-          break; // passed headers; no x-mozilla-keywords header; give up.</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+          break;  // passed headers; no x-mozilla-keywords header; give up.</span>
<a href="#l22.134"></a><span id="l22.134">         if (StringBeginsWith(keywordHeaders,</span>
<a href="#l22.135"></a><span id="l22.135">                              NS_LITERAL_CSTRING(HEADER_X_MOZILLA_KEYWORDS)))</span>
<a href="#l22.136"></a><span id="l22.136">           inKeywordHeader = true;</span>
<a href="#l22.137"></a><span id="l22.137">         else if (inKeywordHeader &amp;&amp; (keywordHeaders.CharAt(0) == ' ' ||</span>
<a href="#l22.138"></a><span id="l22.138">                                      keywordHeaders.CharAt(0) == '\t'))</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-          ; // continuation header line</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+          ;  // continuation header line</span>
<a href="#l22.141"></a><span id="l22.141">         else if (inKeywordHeader)</span>
<a href="#l22.142"></a><span id="l22.142">           break;</span>
<a href="#l22.143"></a><span id="l22.143">         else</span>
<a href="#l22.144"></a><span id="l22.144">           continue;</span>
<a href="#l22.145"></a><span id="l22.145">         uint32_t keywordHdrLength = keywordHeaders.Length();</span>
<a href="#l22.146"></a><span id="l22.146">         int32_t startOffset, keywordLength;</span>
<a href="#l22.147"></a><span id="l22.147">         // check if we have the keyword</span>
<a href="#l22.148"></a><span id="l22.148">         if (MsgFindKeyword(keywordArray[i], keywordHeaders, &amp;startOffset,</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-                           &amp;keywordLength))</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-        {</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+                           &amp;keywordLength)) {</span>
<a href="#l22.152"></a><span id="l22.152">           foundKeyword = true;</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-          if (!aAdd) // if we're removing, remove it, and break;</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+          if (!aAdd)  // if we're removing, remove it, and break;</span>
<a href="#l22.155"></a><span id="l22.155">           {</span>
<a href="#l22.156"></a><span id="l22.156">             keywordHeaders.Cut(startOffset, keywordLength);</span>
<a href="#l22.157"></a><span id="l22.157">             for (int32_t j = keywordLength; j &gt; 0; j--)</span>
<a href="#l22.158"></a><span id="l22.158">               keywordHeaders.Append(' ');</span>
<a href="#l22.159"></a><span id="l22.159">             seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, lineStartPos);</span>
<a href="#l22.160"></a><span id="l22.160">             outputStream-&gt;Write(keywordHeaders.get(), keywordHeaders.Length(),</span>
<a href="#l22.161"></a><span id="l22.161">                                 &amp;bytesWritten);</span>
<a href="#l22.162"></a><span id="l22.162">           }</span>
<a href="#l22.163"></a><span id="l22.163">           offsetToAddKeyword = 0;</span>
<a href="#l22.164"></a><span id="l22.164">           // if adding and we already have the keyword, done</span>
<a href="#l22.165"></a><span id="l22.165">           done = true;</span>
<a href="#l22.166"></a><span id="l22.166">           break;</span>
<a href="#l22.167"></a><span id="l22.167">         }</span>
<a href="#l22.168"></a><span id="l22.168">         // argh, we need to check all the lines to see if we already have the</span>
<a href="#l22.169"></a><span id="l22.169">         // keyword, but if we don't find it, we want to remember the line and</span>
<a href="#l22.170"></a><span id="l22.170">         // position where we have room to add the keyword.</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-        if (aAdd)</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-        {</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+        if (aAdd) {</span>
<a href="#l22.174"></a><span id="l22.174">           nsAutoCString curKeywordHdr(keywordHeaders);</span>
<a href="#l22.175"></a><span id="l22.175">           // strip off line ending spaces.</span>
<a href="#l22.176"></a><span id="l22.176">           curKeywordHdr.Trim(&quot; &quot;, false, true);</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-          if (!offsetToAddKeyword &amp;&amp; curKeywordHdr.Length() +</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-                keywordToWrite.Length() &lt; keywordHdrLength)</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+          if (!offsetToAddKeyword &amp;&amp;</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+              curKeywordHdr.Length() + keywordToWrite.Length() &lt;</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+                  keywordHdrLength)</span>
<a href="#l22.182"></a><span id="l22.182">             offsetToAddKeyword = lineStartPos + curKeywordHdr.Length();</span>
<a href="#l22.183"></a><span id="l22.183">         }</span>
<a href="#l22.184"></a><span id="l22.184">       }</span>
<a href="#l22.185"></a><span id="l22.185">     }</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-    if (aAdd &amp;&amp; !foundKeyword)</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineminus">-    {</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+    if (aAdd &amp;&amp; !foundKeyword) {</span>
<a href="#l22.189"></a><span id="l22.189">       if (!offsetToAddKeyword)</span>
<a href="#l22.190"></a><span id="l22.190">         message-&gt;SetUint32Property(&quot;growKeywords&quot;, 1);</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-      else</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-      {</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+      else {</span>
<a href="#l22.194"></a><span id="l22.194">         seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET,</span>
<a href="#l22.195"></a><span id="l22.195">                              offsetToAddKeyword);</span>
<a href="#l22.196"></a><span id="l22.196">         outputStream-&gt;Write(keywordToWrite.get(), keywordToWrite.Length(),</span>
<a href="#l22.197"></a><span id="l22.197">                             &amp;bytesWritten);</span>
<a href="#l22.198"></a><span id="l22.198">       }</span>
<a href="#l22.199"></a><span id="l22.199">     }</span>
<a href="#l22.200"></a><span id="l22.200">   }</span>
<a href="#l22.201"></a><span id="l22.201"> }</span>
<a href="#l22.202"></a><span id="l22.202"> </span>
<a href="#l22.203"></a><span id="l22.203" class="difflineminus">-nsresult</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineminus">-nsMsgLocalStoreUtils::UpdateFolderFlag(nsIMsgDBHdr *mailHdr, bool bSet,</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-                                       nsMsgMessageFlagType flag,</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineminus">-                                       nsIOutputStream *fileStream)</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-{</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+nsresult nsMsgLocalStoreUtils::UpdateFolderFlag(nsIMsgDBHdr *mailHdr, bool bSet,</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+                                                nsMsgMessageFlagType flag,</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+                                                nsIOutputStream *fileStream) {</span>
<a href="#l22.211"></a><span id="l22.211">   uint32_t statusOffset;</span>
<a href="#l22.212"></a><span id="l22.212">   uint64_t msgOffset;</span>
<a href="#l22.213"></a><span id="l22.213">   nsresult rv = mailHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l22.214"></a><span id="l22.214">   // This probably means there's no x-mozilla-status header, so</span>
<a href="#l22.215"></a><span id="l22.215">   // we just ignore this.</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineminus">-  if (NS_FAILED(rv) || (statusOffset == 0))</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineminus">-    return NS_OK;</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+  if (NS_FAILED(rv) || (statusOffset == 0)) return NS_OK;</span>
<a href="#l22.219"></a><span id="l22.219">   rv = mailHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l22.220"></a><span id="l22.220">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.221"></a><span id="l22.221">   uint64_t statusPos = msgOffset + statusOffset;</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineplus">+      do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l22.225"></a><span id="l22.225">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.226"></a><span id="l22.226">   rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l22.227"></a><span id="l22.227">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.228"></a><span id="l22.228">   char buf[50];</span>
<a href="#l22.229"></a><span id="l22.229">   buf[0] = '\0';</span>
<a href="#l22.230"></a><span id="l22.230">   nsCOMPtr&lt;nsIInputStream&gt; inputStream = do_QueryInterface(fileStream, &amp;rv);</span>
<a href="#l22.231"></a><span id="l22.231">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.232"></a><span id="l22.232">   uint32_t bytesRead;</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-  if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS_LEN + 6,</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-                                     &amp;bytesRead)))</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-  {</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+  if (NS_SUCCEEDED(</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+          inputStream-&gt;Read(buf, X_MOZILLA_STATUS_LEN + 6, &amp;bytesRead))) {</span>
<a href="#l22.238"></a><span id="l22.238">     buf[bytesRead] = '\0';</span>
<a href="#l22.239"></a><span id="l22.239">     if (strncmp(buf, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN) == 0 &amp;&amp;</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineminus">-      strncmp(buf + X_MOZILLA_STATUS_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l22.241"></a><span id="l22.241" class="difflineminus">-      strlen(buf) &gt;= X_MOZILLA_STATUS_LEN + 6)</span>
<a href="#l22.242"></a><span id="l22.242" class="difflineminus">-    {</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineplus">+        strncmp(buf + X_MOZILLA_STATUS_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+        strlen(buf) &gt;= X_MOZILLA_STATUS_LEN + 6) {</span>
<a href="#l22.245"></a><span id="l22.245">       uint32_t flags;</span>
<a href="#l22.246"></a><span id="l22.246">       uint32_t bytesWritten;</span>
<a href="#l22.247"></a><span id="l22.247">       (void)mailHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineminus">-      if (!(flags &amp; nsMsgMessageFlags::Expunged))</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-      {</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+      if (!(flags &amp; nsMsgMessageFlags::Expunged)) {</span>
<a href="#l22.251"></a><span id="l22.251">         char *p = buf + X_MOZILLA_STATUS_LEN + 2;</span>
<a href="#l22.252"></a><span id="l22.252"> </span>
<a href="#l22.253"></a><span id="l22.253">         nsresult errorCode = NS_OK;</span>
<a href="#l22.254"></a><span id="l22.254">         flags = nsDependentCString(p).ToInteger(&amp;errorCode, 16);</span>
<a href="#l22.255"></a><span id="l22.255"> </span>
<a href="#l22.256"></a><span id="l22.256">         uint32_t curFlags;</span>
<a href="#l22.257"></a><span id="l22.257">         (void)mailHdr-&gt;GetFlags(&amp;curFlags);</span>
<a href="#l22.258"></a><span id="l22.258">         flags = (flags &amp; nsMsgMessageFlags::Queued) |</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineminus">-          (curFlags &amp; ~nsMsgMessageFlags::RuntimeOnly);</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+                (curFlags &amp; ~nsMsgMessageFlags::RuntimeOnly);</span>
<a href="#l22.261"></a><span id="l22.261">         if (bSet)</span>
<a href="#l22.262"></a><span id="l22.262">           flags |= flag;</span>
<a href="#l22.263"></a><span id="l22.263">         else</span>
<a href="#l22.264"></a><span id="l22.264">           flags &amp;= ~flag;</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineminus">-      }</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineminus">-      else</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineminus">-      {</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineplus">+      } else {</span>
<a href="#l22.269"></a><span id="l22.269">         flags &amp;= ~nsMsgMessageFlags::RuntimeOnly;</span>
<a href="#l22.270"></a><span id="l22.270">       }</span>
<a href="#l22.271"></a><span id="l22.271">       seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l22.272"></a><span id="l22.272">       // We are filing out x-mozilla-status flags here</span>
<a href="#l22.273"></a><span id="l22.273">       PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS_FORMAT,</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineminus">-        flags &amp; 0x0000FFFF);</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineplus">+                  flags &amp; 0x0000FFFF);</span>
<a href="#l22.276"></a><span id="l22.276">       int32_t lineLen = PL_strlen(buf);</span>
<a href="#l22.277"></a><span id="l22.277">       uint64_t status2Pos = statusPos + lineLen;</span>
<a href="#l22.278"></a><span id="l22.278">       fileStream-&gt;Write(buf, lineLen, &amp;bytesWritten);</span>
<a href="#l22.279"></a><span id="l22.279"> </span>
<a href="#l22.280"></a><span id="l22.280" class="difflineminus">-      if (flag &amp; 0xFFFF0000)</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineminus">-      {</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineplus">+      if (flag &amp; 0xFFFF0000) {</span>
<a href="#l22.283"></a><span id="l22.283">         // Time to update x-mozilla-status2,</span>
<a href="#l22.284"></a><span id="l22.284">         // first find it by finding end of previous line, see bug 234935.</span>
<a href="#l22.285"></a><span id="l22.285">         seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineminus">-        do</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineminus">-        {</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+        do {</span>
<a href="#l22.289"></a><span id="l22.289">           rv = inputStream-&gt;Read(buf, 1, &amp;bytesRead);</span>
<a href="#l22.290"></a><span id="l22.290">           status2Pos++;</span>
<a href="#l22.291"></a><span id="l22.291">         } while (NS_SUCCEEDED(rv) &amp;&amp; (*buf == '\n' || *buf == '\r'));</span>
<a href="#l22.292"></a><span id="l22.292">         status2Pos--;</span>
<a href="#l22.293"></a><span id="l22.293">         seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l22.294"></a><span id="l22.294">         if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS2_LEN + 10,</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineminus">-                                           &amp;bytesRead)))</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineminus">-        {</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+                                           &amp;bytesRead))) {</span>
<a href="#l22.298"></a><span id="l22.298">           if (strncmp(buf, X_MOZILLA_STATUS2, X_MOZILLA_STATUS2_LEN) == 0 &amp;&amp;</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineminus">-            strncmp(buf + X_MOZILLA_STATUS2_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineminus">-            strlen(buf) &gt;= X_MOZILLA_STATUS2_LEN + 10)</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineminus">-          {</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+              strncmp(buf + X_MOZILLA_STATUS2_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+              strlen(buf) &gt;= X_MOZILLA_STATUS2_LEN + 10) {</span>
<a href="#l22.304"></a><span id="l22.304">             uint32_t dbFlags;</span>
<a href="#l22.305"></a><span id="l22.305">             (void)mailHdr-&gt;GetFlags(&amp;dbFlags);</span>
<a href="#l22.306"></a><span id="l22.306">             dbFlags &amp;= 0xFFFF0000;</span>
<a href="#l22.307"></a><span id="l22.307">             seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l22.308"></a><span id="l22.308">             PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS2_FORMAT, dbFlags);</span>
<a href="#l22.309"></a><span id="l22.309">             fileStream-&gt;Write(buf, PL_strlen(buf), &amp;bytesWritten);</span>
<a href="#l22.310"></a><span id="l22.310">           }</span>
<a href="#l22.311"></a><span id="l22.311">         }</span>
<a href="#l22.312"></a><span id="l22.312">       }</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineminus">-    }</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineminus">-    else</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineminus">-    {</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineplus">+    } else {</span>
<a href="#l22.317"></a><span id="l22.317"> #ifdef DEBUG</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineminus">-      printf(&quot;Didn't find %s where expected at position %ld\n&quot;</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineminus">-        &quot;instead, found %s.\n&quot;,</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineminus">-        X_MOZILLA_STATUS, (long) statusPos, buf);</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineplus">+      printf(</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineplus">+          &quot;Didn't find %s where expected at position %ld\n&quot;</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineplus">+          &quot;instead, found %s.\n&quot;,</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineplus">+          X_MOZILLA_STATUS, (long)statusPos, buf);</span>
<a href="#l22.325"></a><span id="l22.325"> #endif</span>
<a href="#l22.326"></a><span id="l22.326">       rv = NS_ERROR_FAILURE;</span>
<a href="#l22.327"></a><span id="l22.327">     }</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-  }</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineminus">-  else</span>
<a href="#l22.330"></a><span id="l22.330" class="difflineplus">+  } else</span>
<a href="#l22.331"></a><span id="l22.331">     rv = NS_ERROR_FAILURE;</span>
<a href="#l22.332"></a><span id="l22.332">   return rv;</span>
<a href="#l22.333"></a><span id="l22.333"> }</span>
<a href="#l22.334"></a><span id="l22.334"> </span>
<a href="#l22.335"></a><span id="l22.335"> /**</span>
<a href="#l22.336"></a><span id="l22.336">  * Returns true if there is enough space on disk.</span>
<a href="#l22.337"></a><span id="l22.337">  *</span>
<a href="#l22.338"></a><span id="l22.338">  * @param aFile  Any file in the message store that is on a logical</span>
<a href="#l22.339"></a><span id="l22.339">  *               disk volume so that it can be queried for disk space.</span>
<a href="#l22.340"></a><span id="l22.340">  * @param aSpaceRequested  The size of free space there must be on the disk</span>
<a href="#l22.341"></a><span id="l22.341">  *                         to return true.</span>
<a href="#l22.342"></a><span id="l22.342">  */</span>
<a href="#l22.343"></a><span id="l22.343" class="difflineminus">-bool</span>
<a href="#l22.344"></a><span id="l22.344" class="difflineminus">-nsMsgLocalStoreUtils::DiskSpaceAvailableInStore(nsIFile *aFile, uint64_t aSpaceRequested)</span>
<a href="#l22.345"></a><span id="l22.345" class="difflineminus">-{</span>
<a href="#l22.346"></a><span id="l22.346" class="difflineplus">+bool nsMsgLocalStoreUtils::DiskSpaceAvailableInStore(nsIFile *aFile,</span>
<a href="#l22.347"></a><span id="l22.347" class="difflineplus">+                                                     uint64_t aSpaceRequested) {</span>
<a href="#l22.348"></a><span id="l22.348">   int64_t diskFree;</span>
<a href="#l22.349"></a><span id="l22.349">   nsresult rv = aFile-&gt;GetDiskSpaceAvailable(&amp;diskFree);</span>
<a href="#l22.350"></a><span id="l22.350">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l22.351"></a><span id="l22.351"> #ifdef DEBUG</span>
<a href="#l22.352"></a><span id="l22.352">     printf(&quot;GetDiskSpaceAvailable returned: %lld bytes\n&quot;, (long long)diskFree);</span>
<a href="#l22.353"></a><span id="l22.353"> #endif</span>
<a href="#l22.354"></a><span id="l22.354">     // When checking for disk space available, take into consideration</span>
<a href="#l22.355"></a><span id="l22.355">     // possible database changes, therefore ask for a little more</span>
<a href="#l22.356"></a><span id="l22.356">     // (EXTRA_SAFETY_SPACE) than what the requested size is. Also, due to disk</span>
<a href="#l22.357"></a><span id="l22.357" class="difflineminus">-    // sector sizes, allocation blocks, etc. The space &quot;available&quot; may be greater</span>
<a href="#l22.358"></a><span id="l22.358" class="difflineminus">-    // than the actual space usable.</span>
<a href="#l22.359"></a><span id="l22.359" class="difflineminus">-    return ((aSpaceRequested + EXTRA_SAFETY_SPACE) &lt; (uint64_t) diskFree);</span>
<a href="#l22.360"></a><span id="l22.360" class="difflineplus">+    // sector sizes, allocation blocks, etc. The space &quot;available&quot; may be</span>
<a href="#l22.361"></a><span id="l22.361" class="difflineplus">+    // greater than the actual space usable.</span>
<a href="#l22.362"></a><span id="l22.362" class="difflineplus">+    return ((aSpaceRequested + EXTRA_SAFETY_SPACE) &lt; (uint64_t)diskFree);</span>
<a href="#l22.363"></a><span id="l22.363">   } else if (rv == NS_ERROR_NOT_IMPLEMENTED) {</span>
<a href="#l22.364"></a><span id="l22.364">     // The call to GetDiskSpaceAvailable is not implemented!</span>
<a href="#l22.365"></a><span id="l22.365">     // This will happen on certain platforms where GetDiskSpaceAvailable</span>
<a href="#l22.366"></a><span id="l22.366">     // is not implemented. Since people on those platforms still need</span>
<a href="#l22.367"></a><span id="l22.367">     // to download mail, we will simply bypass the disk-space check.</span>
<a href="#l22.368"></a><span id="l22.368">     //</span>
<a href="#l22.369"></a><span id="l22.369">     // We'll leave a debug message to warn people.</span>
<a href="#l22.370"></a><span id="l22.370"> #ifdef DEBUG</span>
<a href="#l22.371"></a><span id="l22.371" class="difflineminus">-    printf(&quot;Call to GetDiskSpaceAvailable FAILED because it is not implemented!\n&quot;);</span>
<a href="#l22.372"></a><span id="l22.372" class="difflineplus">+    printf(</span>
<a href="#l22.373"></a><span id="l22.373" class="difflineplus">+        &quot;Call to GetDiskSpaceAvailable FAILED because it is not &quot;</span>
<a href="#l22.374"></a><span id="l22.374" class="difflineplus">+        &quot;implemented!\n&quot;);</span>
<a href="#l22.375"></a><span id="l22.375"> #endif</span>
<a href="#l22.376"></a><span id="l22.376">     return true;</span>
<a href="#l22.377"></a><span id="l22.377">   } else {</span>
<a href="#l22.378"></a><span id="l22.378">     printf(&quot;Call to GetDiskSpaceAvailable FAILED!\n&quot;);</span>
<a href="#l22.379"></a><span id="l22.379">     return false;</span>
<a href="#l22.380"></a><span id="l22.380">   }</span>
<a href="#l22.381"></a><span id="l22.381"> }</span>
<a href="#l22.382"></a><span id="l22.382"> </span>
<a href="#l22.383"></a><span id="l22.383"> /**</span>
<a href="#l22.384"></a><span id="l22.384">  * Resets forceReparse in the database.</span>
<a href="#l22.385"></a><span id="l22.385">  *</span>
<a href="#l22.386"></a><span id="l22.386">  * @param aMsgDb The database to reset.</span>
<a href="#l22.387"></a><span id="l22.387">  */</span>
<a href="#l22.388"></a><span id="l22.388" class="difflineminus">-void</span>
<a href="#l22.389"></a><span id="l22.389" class="difflineminus">-nsMsgLocalStoreUtils::ResetForceReparse(nsIMsgDatabase *aMsgDB)</span>
<a href="#l22.390"></a><span id="l22.390" class="difflineminus">-{</span>
<a href="#l22.391"></a><span id="l22.391" class="difflineminus">-  if (aMsgDB)</span>
<a href="#l22.392"></a><span id="l22.392" class="difflineminus">-  {</span>
<a href="#l22.393"></a><span id="l22.393" class="difflineplus">+void nsMsgLocalStoreUtils::ResetForceReparse(nsIMsgDatabase *aMsgDB) {</span>
<a href="#l22.394"></a><span id="l22.394" class="difflineplus">+  if (aMsgDB) {</span>
<a href="#l22.395"></a><span id="l22.395">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l22.396"></a><span id="l22.396">     aMsgDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l22.397"></a><span id="l22.397" class="difflineminus">-    if (folderInfo)</span>
<a href="#l22.398"></a><span id="l22.398" class="difflineminus">-      folderInfo-&gt;SetBooleanProperty(&quot;forceReparse&quot;, false);</span>
<a href="#l22.399"></a><span id="l22.399" class="difflineplus">+    if (folderInfo) folderInfo-&gt;SetBooleanProperty(&quot;forceReparse&quot;, false);</span>
<a href="#l22.400"></a><span id="l22.400">   }</span>
<a href="#l22.401"></a><span id="l22.401"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/src/nsMsgLocalStoreUtils.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgLocalStoreUtils.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -14,35 +14,31 @@</span>
<a href="#l23.4"></a><span id="l23.4"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l23.5"></a><span id="l23.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l23.6"></a><span id="l23.6"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> /**</span>
<a href="#l23.10"></a><span id="l23.10">  * Utility Class for handling local mail stores. Berkeley Mailbox</span>
<a href="#l23.11"></a><span id="l23.11">  * and MailDir stores inherit from this class to share some code.</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-*/</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+ */</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-class nsMsgLocalStoreUtils</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-{</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-public:</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+class nsMsgLocalStoreUtils {</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+ public:</span>
<a href="#l23.20"></a><span id="l23.20">   nsMsgLocalStoreUtils();</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22">   static nsresult AddDirectorySeparator(nsIFile *path);</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-  static bool nsShouldIgnoreFile(nsAString&amp; name);</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-  static void ChangeKeywordsHelper(nsIMsgDBHdr *message,</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-                            uint64_t desiredOffset,</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-                            nsLineBuffer&lt;char&gt; *lineBuffer,</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-                            nsTArray&lt;nsCString&gt; &amp;keywordArray,</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-                            bool aAdd,</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-                            nsIOutputStream *outputStream,</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-                            nsISeekableStream *seekableStream,</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-                            nsIInputStream *inputStream);</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+  static bool nsShouldIgnoreFile(nsAString &amp;name);</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+  static void ChangeKeywordsHelper(nsIMsgDBHdr *message, uint64_t desiredOffset,</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+                                   nsLineBuffer&lt;char&gt; *lineBuffer,</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+                                   nsTArray&lt;nsCString&gt; &amp;keywordArray, bool aAdd,</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+                                   nsIOutputStream *outputStream,</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+                                   nsISeekableStream *seekableStream,</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+                                   nsIInputStream *inputStream);</span>
<a href="#l23.39"></a><span id="l23.39">   static void ResetForceReparse(nsIMsgDatabase *aMsgDB);</span>
<a href="#l23.40"></a><span id="l23.40"> </span>
<a href="#l23.41"></a><span id="l23.41">   nsresult UpdateFolderFlag(nsIMsgDBHdr *mailHdr, bool bSet,</span>
<a href="#l23.42"></a><span id="l23.42">                             nsMsgMessageFlagType flag,</span>
<a href="#l23.43"></a><span id="l23.43">                             nsIOutputStream *fileStream);</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  bool DiskSpaceAvailableInStore(nsIFile *aFile,</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-                                 uint64_t aSpaceRequested);</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+  bool DiskSpaceAvailableInStore(nsIFile *aFile, uint64_t aSpaceRequested);</span>
<a href="#l23.47"></a><span id="l23.47"> };</span>
<a href="#l23.48"></a><span id="l23.48"> </span>
<a href="#l23.49"></a><span id="l23.49"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -42,318 +42,283 @@ static mozilla::LazyLogModule MailDirLog</span>
<a href="#l24.4"></a><span id="l24.4"> // Helper function to produce a safe filename from a Message-ID value.</span>
<a href="#l24.5"></a><span id="l24.5"> // We'll percent-encode anything not in this set: [-+.%=@_0-9a-zA-Z]</span>
<a href="#l24.6"></a><span id="l24.6"> // This is an overly-picky set, but should:</span>
<a href="#l24.7"></a><span id="l24.7"> //  - leave most sane Message-IDs unchanged</span>
<a href="#l24.8"></a><span id="l24.8"> //  - be safe on windows (the pickiest case)</span>
<a href="#l24.9"></a><span id="l24.9"> //  - avoid chars that can trip up shell scripts (spaces, semicolons etc)</span>
<a href="#l24.10"></a><span id="l24.10"> // If input contains malicious binary (or multibyte chars) it'll be</span>
<a href="#l24.11"></a><span id="l24.11"> // safely encoded as individual bytes.</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-static void percentEncode(nsACString const&amp; in, nsACString&amp; out)</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-{</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-  const char* end = in.EndReading();</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  const char* cur;</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+static void percentEncode(nsACString const &amp;in, nsACString &amp;out) {</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+  const char *end = in.EndReading();</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  const char *cur;</span>
<a href="#l24.19"></a><span id="l24.19">   // We know the output will be at least as long as the input.</span>
<a href="#l24.20"></a><span id="l24.20">   out.SetLength(0);</span>
<a href="#l24.21"></a><span id="l24.21">   out.SetCapacity(in.Length());</span>
<a href="#l24.22"></a><span id="l24.22">   for (cur = in.BeginReading(); cur &lt; end; ++cur) {</span>
<a href="#l24.23"></a><span id="l24.23">     const char c = *cur;</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-    bool whitelisted = (c &gt;= '0' &amp;&amp; c &lt;= '9') ||</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-      (c &gt;= 'A' &amp;&amp; c &lt;= 'Z') ||</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-      (c &gt;= 'a' &amp;&amp; c &lt;= 'z') ||</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-      c == '-' || c == '+' || c == '.' || c == '%' || c == '=' || c == '@' || c == '_';</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+    bool whitelisted = (c &gt;= '0' &amp;&amp; c &lt;= '9') || (c &gt;= 'A' &amp;&amp; c &lt;= 'Z') ||</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+                       (c &gt;= 'a' &amp;&amp; c &lt;= 'z') || c == '-' || c == '+' ||</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+                       c == '.' || c == '%' || c == '=' || c == '@' || c == '_';</span>
<a href="#l24.31"></a><span id="l24.31">     if (whitelisted) {</span>
<a href="#l24.32"></a><span id="l24.32">       out.Append(c);</span>
<a href="#l24.33"></a><span id="l24.33">     } else {</span>
<a href="#l24.34"></a><span id="l24.34">       out.AppendPrintf(&quot;%%%02x&quot;, (unsigned char)c);</span>
<a href="#l24.35"></a><span id="l24.35">     }</span>
<a href="#l24.36"></a><span id="l24.36">   }</span>
<a href="#l24.37"></a><span id="l24.37"> }</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-nsMsgMaildirStore::nsMsgMaildirStore()</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-{</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-}</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+nsMsgMaildirStore::nsMsgMaildirStore() {}</span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-nsMsgMaildirStore::~nsMsgMaildirStore()</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-{</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-}</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+nsMsgMaildirStore::~nsMsgMaildirStore() {}</span>
<a href="#l24.48"></a><span id="l24.48"> </span>
<a href="#l24.49"></a><span id="l24.49"> NS_IMPL_ISUPPORTS(nsMsgMaildirStore, nsIMsgPluggableStore)</span>
<a href="#l24.50"></a><span id="l24.50"> </span>
<a href="#l24.51"></a><span id="l24.51"> // Iterates over the folders in the &quot;path&quot; directory, and adds subfolders to</span>
<a href="#l24.52"></a><span id="l24.52"> // parent for each Maildir folder found.</span>
<a href="#l24.53"></a><span id="l24.53"> nsresult nsMsgMaildirStore::AddSubFolders(nsIMsgFolder *parent, nsIFile *path,</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-                                          bool deep)</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-{</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+                                          bool deep) {</span>
<a href="#l24.57"></a><span id="l24.57">   nsCOMArray&lt;nsIFile&gt; currentDirEntries;</span>
<a href="#l24.58"></a><span id="l24.58"> </span>
<a href="#l24.59"></a><span id="l24.59">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l24.60"></a><span id="l24.60">   nsresult rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l24.61"></a><span id="l24.61">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.62"></a><span id="l24.62"> </span>
<a href="#l24.63"></a><span id="l24.63">   bool hasMore;</span>
<a href="#l24.64"></a><span id="l24.64">   while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-         hasMore)</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-  {</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+         hasMore) {</span>
<a href="#l24.68"></a><span id="l24.68">     nsCOMPtr&lt;nsIFile&gt; currentFile;</span>
<a href="#l24.69"></a><span id="l24.69">     rv = directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile));</span>
<a href="#l24.70"></a><span id="l24.70">     if (NS_SUCCEEDED(rv) &amp;&amp; currentFile) {</span>
<a href="#l24.71"></a><span id="l24.71">       nsAutoString leafName;</span>
<a href="#l24.72"></a><span id="l24.72">       currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l24.73"></a><span id="l24.73">       bool isDirectory = false;</span>
<a href="#l24.74"></a><span id="l24.74">       currentFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l24.75"></a><span id="l24.75">       // Make sure this really is a mail folder dir (i.e., a directory that</span>
<a href="#l24.76"></a><span id="l24.76">       // contains cur and tmp sub-dirs, and not a .sbd or .mozmsgs dir).</span>
<a href="#l24.77"></a><span id="l24.77">       if (isDirectory &amp;&amp; !nsShouldIgnoreFile(leafName))</span>
<a href="#l24.78"></a><span id="l24.78">         currentDirEntries.AppendObject(currentFile);</span>
<a href="#l24.79"></a><span id="l24.79">     }</span>
<a href="#l24.80"></a><span id="l24.80">   }</span>
<a href="#l24.81"></a><span id="l24.81"> </span>
<a href="#l24.82"></a><span id="l24.82">   // add the folders</span>
<a href="#l24.83"></a><span id="l24.83">   int32_t count = currentDirEntries.Count();</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-  for (int32_t i = 0; i &lt; count; ++i)</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-  {</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+  for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l24.87"></a><span id="l24.87">     nsCOMPtr&lt;nsIFile&gt; currentFile(currentDirEntries[i]);</span>
<a href="#l24.88"></a><span id="l24.88"> </span>
<a href="#l24.89"></a><span id="l24.89">     nsAutoString leafName;</span>
<a href="#l24.90"></a><span id="l24.90">     currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l24.91"></a><span id="l24.91"> </span>
<a href="#l24.92"></a><span id="l24.92">     nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l24.93"></a><span id="l24.93">     rv = parent-&gt;AddSubfolder(leafName, getter_AddRefs(child));</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineminus">-    if (child)</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineminus">-    {</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+    if (child) {</span>
<a href="#l24.97"></a><span id="l24.97">       nsString folderName;</span>
<a href="#l24.98"></a><span id="l24.98">       child-&gt;GetName(folderName);  // try to get it from cache/db</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-      if (folderName.IsEmpty())</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-        child-&gt;SetPrettyName(leafName);</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-      if (deep)</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-      {</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+      if (folderName.IsEmpty()) child-&gt;SetPrettyName(leafName);</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+      if (deep) {</span>
<a href="#l24.105"></a><span id="l24.105">         nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.106"></a><span id="l24.106">         rv = child-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.107"></a><span id="l24.107">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.108"></a><span id="l24.108"> </span>
<a href="#l24.109"></a><span id="l24.109">         // Construct the .sbd directory path for the possible children of the</span>
<a href="#l24.110"></a><span id="l24.110">         // folder.</span>
<a href="#l24.111"></a><span id="l24.111">         GetDirectoryForFolder(path);</span>
<a href="#l24.112"></a><span id="l24.112">         bool directory = false;</span>
<a href="#l24.113"></a><span id="l24.113">         // Check that &lt;folder&gt;.sbd really is a directory.</span>
<a href="#l24.114"></a><span id="l24.114">         path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-        if (directory)</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineminus">-          AddSubFolders(child, path, true);</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+        if (directory) AddSubFolders(child, path, true);</span>
<a href="#l24.118"></a><span id="l24.118">       }</span>
<a href="#l24.119"></a><span id="l24.119">     }</span>
<a href="#l24.120"></a><span id="l24.120">   }</span>
<a href="#l24.121"></a><span id="l24.121">   return rv == NS_MSG_FOLDER_EXISTS ? NS_OK : rv;</span>
<a href="#l24.122"></a><span id="l24.122"> }</span>
<a href="#l24.123"></a><span id="l24.123"> </span>
<a href="#l24.124"></a><span id="l24.124"> NS_IMETHODIMP nsMsgMaildirStore::DiscoverSubFolders(nsIMsgFolder *aParentFolder,</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-                                                    bool aDeep)</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineminus">-{</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+                                                    bool aDeep) {</span>
<a href="#l24.128"></a><span id="l24.128">   NS_ENSURE_ARG_POINTER(aParentFolder);</span>
<a href="#l24.129"></a><span id="l24.129"> </span>
<a href="#l24.130"></a><span id="l24.130">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.131"></a><span id="l24.131">   nsresult rv = aParentFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.132"></a><span id="l24.132">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.133"></a><span id="l24.133"> </span>
<a href="#l24.134"></a><span id="l24.134">   bool isServer, directory = false;</span>
<a href="#l24.135"></a><span id="l24.135">   aParentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-  if (!isServer)</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineminus">-    GetDirectoryForFolder(path);</span>
<a href="#l24.138"></a><span id="l24.138" class="difflineplus">+  if (!isServer) GetDirectoryForFolder(path);</span>
<a href="#l24.139"></a><span id="l24.139"> </span>
<a href="#l24.140"></a><span id="l24.140">   path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-  if (directory)</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-    rv = AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+  if (directory) rv = AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l24.144"></a><span id="l24.144"> </span>
<a href="#l24.145"></a><span id="l24.145">   return (rv == NS_MSG_FOLDER_EXISTS) ? NS_OK : rv;</span>
<a href="#l24.146"></a><span id="l24.146"> }</span>
<a href="#l24.147"></a><span id="l24.147"> </span>
<a href="#l24.148"></a><span id="l24.148"> /**</span>
<a href="#l24.149"></a><span id="l24.149">  * Create if missing a Maildir-style folder with &quot;tmp&quot; and &quot;cur&quot; subfolders</span>
<a href="#l24.150"></a><span id="l24.150">  * but no &quot;new&quot; subfolder, because it doesn't make sense in the mail client</span>
<a href="#l24.151"></a><span id="l24.151">  * context. (&quot;new&quot; directory is for messages on the server that haven't been</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-*  seen by a mail client).</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+ *  seen by a mail client).</span>
<a href="#l24.154"></a><span id="l24.154">  * aFolderName is already &quot;safe&quot; - it has been through NS_MsgHashIfNecessary.</span>
<a href="#l24.155"></a><span id="l24.155">  */</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineminus">-nsresult nsMsgMaildirStore::CreateMaildir(nsIFile *path)</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-{</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+nsresult nsMsgMaildirStore::CreateMaildir(nsIFile *path) {</span>
<a href="#l24.159"></a><span id="l24.159">   nsresult rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-  {</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS) {</span>
<a href="#l24.163"></a><span id="l24.163">     NS_WARNING(&quot;Could not create root directory for message folder&quot;);</span>
<a href="#l24.164"></a><span id="l24.164">     return rv;</span>
<a href="#l24.165"></a><span id="l24.165">   }</span>
<a href="#l24.166"></a><span id="l24.166"> </span>
<a href="#l24.167"></a><span id="l24.167">   // Create tmp, cur leaves</span>
<a href="#l24.168"></a><span id="l24.168">   nsCOMPtr&lt;nsIFile&gt; leaf(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l24.169"></a><span id="l24.169">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.170"></a><span id="l24.170"> </span>
<a href="#l24.171"></a><span id="l24.171">   leaf-&gt;InitWithFile(path);</span>
<a href="#l24.172"></a><span id="l24.172"> </span>
<a href="#l24.173"></a><span id="l24.173">   leaf-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;tmp&quot;));</span>
<a href="#l24.174"></a><span id="l24.174">   rv = leaf-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-  {</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS) {</span>
<a href="#l24.178"></a><span id="l24.178">     NS_WARNING(&quot;Could not create tmp directory for message folder&quot;);</span>
<a href="#l24.179"></a><span id="l24.179">     return rv;</span>
<a href="#l24.180"></a><span id="l24.180">   }</span>
<a href="#l24.181"></a><span id="l24.181"> </span>
<a href="#l24.182"></a><span id="l24.182">   leaf-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;cur&quot;));</span>
<a href="#l24.183"></a><span id="l24.183">   rv = leaf-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l24.184"></a><span id="l24.184" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS)</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-  {</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_FILE_ALREADY_EXISTS) {</span>
<a href="#l24.187"></a><span id="l24.187">     NS_WARNING(&quot;Could not create cur directory for message folder&quot;);</span>
<a href="#l24.188"></a><span id="l24.188">     return rv;</span>
<a href="#l24.189"></a><span id="l24.189">   }</span>
<a href="#l24.190"></a><span id="l24.190"> </span>
<a href="#l24.191"></a><span id="l24.191">   return NS_OK;</span>
<a href="#l24.192"></a><span id="l24.192"> }</span>
<a href="#l24.193"></a><span id="l24.193"> </span>
<a href="#l24.194"></a><span id="l24.194"> NS_IMETHODIMP nsMsgMaildirStore::CreateFolder(nsIMsgFolder *aParent,</span>
<a href="#l24.195"></a><span id="l24.195">                                               const nsAString &amp;aFolderName,</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-                                              nsIMsgFolder **aResult)</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-{</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineplus">+                                              nsIMsgFolder **aResult) {</span>
<a href="#l24.199"></a><span id="l24.199">   NS_ENSURE_ARG_POINTER(aParent);</span>
<a href="#l24.200"></a><span id="l24.200">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-  if (aFolderName.IsEmpty())</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-    return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+  if (aFolderName.IsEmpty()) return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l24.204"></a><span id="l24.204"> </span>
<a href="#l24.205"></a><span id="l24.205" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; path;</span>
<a href="#l24.206"></a><span id="l24.206" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.207"></a><span id="l24.207">   nsresult rv = aParent-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.208"></a><span id="l24.208">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.209"></a><span id="l24.209"> </span>
<a href="#l24.210"></a><span id="l24.210">   // Get a directory based on our current path</span>
<a href="#l24.211"></a><span id="l24.211">   bool isServer;</span>
<a href="#l24.212"></a><span id="l24.212">   aParent-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l24.213"></a><span id="l24.213">   rv = CreateDirectoryForFolder(path, isServer);</span>
<a href="#l24.214"></a><span id="l24.214">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.215"></a><span id="l24.215"> </span>
<a href="#l24.216"></a><span id="l24.216">   // Make sure the new folder name is valid</span>
<a href="#l24.217"></a><span id="l24.217">   nsAutoString safeFolderName(aFolderName);</span>
<a href="#l24.218"></a><span id="l24.218">   NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l24.219"></a><span id="l24.219"> </span>
<a href="#l24.220"></a><span id="l24.220">   path-&gt;Append(safeFolderName);</span>
<a href="#l24.221"></a><span id="l24.221">   bool exists;</span>
<a href="#l24.222"></a><span id="l24.222">   path-&gt;Exists(&amp;exists);</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-  if (exists) //check this because localized names are different from disk names</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineplus">+  if (exists)  // check this because localized names are different from disk</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+               // names</span>
<a href="#l24.226"></a><span id="l24.226">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l24.227"></a><span id="l24.227"> </span>
<a href="#l24.228"></a><span id="l24.228">   rv = CreateMaildir(path);</span>
<a href="#l24.229"></a><span id="l24.229">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.230"></a><span id="l24.230"> </span>
<a href="#l24.231"></a><span id="l24.231">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l24.232"></a><span id="l24.232">   // GetFlags and SetFlags in AddSubfolder will fail because we have no db at</span>
<a href="#l24.233"></a><span id="l24.233">   // this point but mFlags is set.</span>
<a href="#l24.234"></a><span id="l24.234">   rv = aParent-&gt;AddSubfolder(safeFolderName, getter_AddRefs(child));</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-  if (!child || NS_FAILED(rv))</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineminus">-  {</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-    path-&gt;Remove(true); // recursive</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineplus">+  if (!child || NS_FAILED(rv)) {</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineplus">+    path-&gt;Remove(true);  // recursive</span>
<a href="#l24.240"></a><span id="l24.240">     return rv;</span>
<a href="#l24.241"></a><span id="l24.241">   }</span>
<a href="#l24.242"></a><span id="l24.242"> </span>
<a href="#l24.243"></a><span id="l24.243">   // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l24.244"></a><span id="l24.244">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineminus">-    do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l24.246"></a><span id="l24.246" class="difflineminus">-  if (msgDBService)</span>
<a href="#l24.247"></a><span id="l24.247" class="difflineminus">-  {</span>
<a href="#l24.248"></a><span id="l24.248" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineplus">+  if (msgDBService) {</span>
<a href="#l24.250"></a><span id="l24.250">     nsCOMPtr&lt;nsIMsgDatabase&gt; unusedDB;</span>
<a href="#l24.251"></a><span id="l24.251">     rv = msgDBService-&gt;OpenFolderDB(child, true, getter_AddRefs(unusedDB));</span>
<a href="#l24.252"></a><span id="l24.252">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l24.253"></a><span id="l24.253">       rv = msgDBService-&gt;CreateNewDB(child, getter_AddRefs(unusedDB));</span>
<a href="#l24.254"></a><span id="l24.254"> </span>
<a href="#l24.255"></a><span id="l24.255">     if ((NS_SUCCEEDED(rv) || rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) &amp;&amp;</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-        unusedDB)</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-    {</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-      //need to set the folder name</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineplus">+        unusedDB) {</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineplus">+      // need to set the folder name</span>
<a href="#l24.261"></a><span id="l24.261">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l24.262"></a><span id="l24.262">       rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineminus">-        folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineplus">+      if (NS_SUCCEEDED(rv)) folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l24.266"></a><span id="l24.266"> </span>
<a href="#l24.267"></a><span id="l24.267">       unusedDB-&gt;SetSummaryValid(true);</span>
<a href="#l24.268"></a><span id="l24.268">       unusedDB-&gt;Close(true);</span>
<a href="#l24.269"></a><span id="l24.269">       aParent-&gt;UpdateSummaryTotals(true);</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-    }</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-    else</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineminus">-    {</span>
<a href="#l24.273"></a><span id="l24.273" class="difflineplus">+    } else {</span>
<a href="#l24.274"></a><span id="l24.274">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-            (&quot;CreateFolder - failed creating db for new folder\n&quot;));</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-      path-&gt;Remove(true); // recursive</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineplus">+              (&quot;CreateFolder - failed creating db for new folder\n&quot;));</span>
<a href="#l24.278"></a><span id="l24.278" class="difflineplus">+      path-&gt;Remove(true);  // recursive</span>
<a href="#l24.279"></a><span id="l24.279">       rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l24.280"></a><span id="l24.280">     }</span>
<a href="#l24.281"></a><span id="l24.281">   }</span>
<a href="#l24.282"></a><span id="l24.282">   child.forget(aResult);</span>
<a href="#l24.283"></a><span id="l24.283">   return rv;</span>
<a href="#l24.284"></a><span id="l24.284"> }</span>
<a href="#l24.285"></a><span id="l24.285"> </span>
<a href="#l24.286"></a><span id="l24.286"> NS_IMETHODIMP nsMsgMaildirStore::HasSpaceAvailable(nsIMsgFolder *aFolder,</span>
<a href="#l24.287"></a><span id="l24.287">                                                    int64_t aSpaceRequested,</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineminus">-                                                   bool *aResult)</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-{</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineplus">+                                                   bool *aResult) {</span>
<a href="#l24.291"></a><span id="l24.291">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.292"></a><span id="l24.292">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.293"></a><span id="l24.293"> </span>
<a href="#l24.294"></a><span id="l24.294">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l24.295"></a><span id="l24.295">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l24.296"></a><span id="l24.296">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.297"></a><span id="l24.297"> </span>
<a href="#l24.298"></a><span id="l24.298">   *aResult = DiskSpaceAvailableInStore(pathFile, aSpaceRequested);</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineminus">-  if (!*aResult)</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-    return NS_ERROR_FILE_DISK_FULL;</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineplus">+  if (!*aResult) return NS_ERROR_FILE_DISK_FULL;</span>
<a href="#l24.302"></a><span id="l24.302"> </span>
<a href="#l24.303"></a><span id="l24.303">   return NS_OK;</span>
<a href="#l24.304"></a><span id="l24.304"> }</span>
<a href="#l24.305"></a><span id="l24.305"> </span>
<a href="#l24.306"></a><span id="l24.306"> NS_IMETHODIMP nsMsgMaildirStore::IsSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l24.307"></a><span id="l24.307">                                                     nsIMsgDatabase *aDB,</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-                                                    bool *aResult)</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineminus">-{</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineplus">+                                                    bool *aResult) {</span>
<a href="#l24.311"></a><span id="l24.311">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.312"></a><span id="l24.312">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l24.313"></a><span id="l24.313">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.314"></a><span id="l24.314">   *aResult = true;</span>
<a href="#l24.315"></a><span id="l24.315">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l24.316"></a><span id="l24.316">   aDB-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineminus">-  nsresult rv = dbFolderInfo-&gt;GetBooleanProperty(&quot;maildirValid&quot;, false,</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-                                                 aResult);</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-  if (!*aResult)</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineminus">-  {</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineplus">+  nsresult rv =</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineplus">+      dbFolderInfo-&gt;GetBooleanProperty(&quot;maildirValid&quot;, false, aResult);</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineplus">+  if (!*aResult) {</span>
<a href="#l24.324"></a><span id="l24.324">     nsCOMPtr&lt;nsIFile&gt; newFile;</span>
<a href="#l24.325"></a><span id="l24.325">     rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l24.326"></a><span id="l24.326">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.327"></a><span id="l24.327">     newFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.328"></a><span id="l24.328"> </span>
<a href="#l24.329"></a><span id="l24.329">     // If the &quot;cur&quot; sub-dir doesn't exist, and there are no messages</span>
<a href="#l24.330"></a><span id="l24.330">     // in the db, then the folder is probably new and the db is valid.</span>
<a href="#l24.331"></a><span id="l24.331">     bool exists;</span>
<a href="#l24.332"></a><span id="l24.332">     newFile-&gt;Exists(&amp;exists);</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineminus">-    if (!exists)</span>
<a href="#l24.334"></a><span id="l24.334" class="difflineminus">-    {</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineplus">+    if (!exists) {</span>
<a href="#l24.336"></a><span id="l24.336">       int32_t numMessages;</span>
<a href="#l24.337"></a><span id="l24.337">       dbFolderInfo-&gt;GetNumMessages(&amp;numMessages);</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineminus">-      if (!numMessages)</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineminus">-        *aResult = true;</span>
<a href="#l24.340"></a><span id="l24.340" class="difflineplus">+      if (!numMessages) *aResult = true;</span>
<a href="#l24.341"></a><span id="l24.341">     }</span>
<a href="#l24.342"></a><span id="l24.342">   }</span>
<a href="#l24.343"></a><span id="l24.343">   return rv;</span>
<a href="#l24.344"></a><span id="l24.344"> }</span>
<a href="#l24.345"></a><span id="l24.345"> </span>
<a href="#l24.346"></a><span id="l24.346"> NS_IMETHODIMP nsMsgMaildirStore::SetSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l24.347"></a><span id="l24.347">                                                      nsIMsgDatabase *aDB,</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineminus">-                                                     bool aValid)</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineminus">-{</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineplus">+                                                     bool aValid) {</span>
<a href="#l24.351"></a><span id="l24.351">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.352"></a><span id="l24.352">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l24.353"></a><span id="l24.353">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l24.354"></a><span id="l24.354">   aDB-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l24.355"></a><span id="l24.355">   NS_ENSURE_STATE(dbFolderInfo);</span>
<a href="#l24.356"></a><span id="l24.356">   return dbFolderInfo-&gt;SetBooleanProperty(&quot;maildirValid&quot;, aValid);</span>
<a href="#l24.357"></a><span id="l24.357"> }</span>
<a href="#l24.358"></a><span id="l24.358"> </span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-NS_IMETHODIMP nsMsgMaildirStore::DeleteFolder(nsIMsgFolder *aFolder)</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineminus">-{</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::DeleteFolder(nsIMsgFolder *aFolder) {</span>
<a href="#l24.362"></a><span id="l24.362">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.363"></a><span id="l24.363">   bool exists;</span>
<a href="#l24.364"></a><span id="l24.364"> </span>
<a href="#l24.365"></a><span id="l24.365">   // Delete the Maildir itself.</span>
<a href="#l24.366"></a><span id="l24.366">   nsCOMPtr&lt;nsIFile&gt; pathFile;</span>
<a href="#l24.367"></a><span id="l24.367">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l24.368"></a><span id="l24.368">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.369"></a><span id="l24.369"> </span>
<a href="#l24.370"></a><span id="l24.370" class="difflineat">@@ -372,33 +337,31 @@ NS_IMETHODIMP nsMsgMaildirStore::DeleteF</span>
<a href="#l24.371"></a><span id="l24.371">     rv = pathFile-&gt;Remove(true);</span>
<a href="#l24.372"></a><span id="l24.372">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.373"></a><span id="l24.373">   }</span>
<a href="#l24.374"></a><span id="l24.374"> </span>
<a href="#l24.375"></a><span id="l24.375">   return NS_OK;</span>
<a href="#l24.376"></a><span id="l24.376"> }</span>
<a href="#l24.377"></a><span id="l24.377"> </span>
<a href="#l24.378"></a><span id="l24.378"> NS_IMETHODIMP nsMsgMaildirStore::RenameFolder(nsIMsgFolder *aFolder,</span>
<a href="#l24.379"></a><span id="l24.379" class="difflineminus">-                                              const nsAString &amp; aNewName,</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">-                                              nsIMsgFolder **aNewFolder)</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineminus">-{</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineplus">+                                              const nsAString &amp;aNewName,</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineplus">+                                              nsIMsgFolder **aNewFolder) {</span>
<a href="#l24.384"></a><span id="l24.384">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.385"></a><span id="l24.385">   NS_ENSURE_ARG_POINTER(aNewFolder);</span>
<a href="#l24.386"></a><span id="l24.386"> </span>
<a href="#l24.387"></a><span id="l24.387">   // old path</span>
<a href="#l24.388"></a><span id="l24.388">   nsCOMPtr&lt;nsIFile&gt; oldPathFile;</span>
<a href="#l24.389"></a><span id="l24.389">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l24.390"></a><span id="l24.390">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.391"></a><span id="l24.391"> </span>
<a href="#l24.392"></a><span id="l24.392">   // old sbd directory</span>
<a href="#l24.393"></a><span id="l24.393">   nsCOMPtr&lt;nsIFile&gt; sbdPathFile;</span>
<a href="#l24.394"></a><span id="l24.394">   uint32_t numChildren;</span>
<a href="#l24.395"></a><span id="l24.395">   aFolder-&gt;GetNumSubFolders(&amp;numChildren);</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineminus">-  if (numChildren &gt; 0)</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineminus">-  {</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+  if (numChildren &gt; 0) {</span>
<a href="#l24.399"></a><span id="l24.399">     sbdPathFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l24.400"></a><span id="l24.400">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.401"></a><span id="l24.401">     rv = sbdPathFile-&gt;InitWithFile(oldPathFile);</span>
<a href="#l24.402"></a><span id="l24.402">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.403"></a><span id="l24.403">     GetDirectoryForFolder(sbdPathFile);</span>
<a href="#l24.404"></a><span id="l24.404">   }</span>
<a href="#l24.405"></a><span id="l24.405"> </span>
<a href="#l24.406"></a><span id="l24.406">   // old summary</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineat">@@ -411,60 +374,55 @@ NS_IMETHODIMP nsMsgMaildirStore::RenameF</span>
<a href="#l24.408"></a><span id="l24.408">   NS_MsgHashIfNecessary(safeName);</span>
<a href="#l24.409"></a><span id="l24.409"> </span>
<a href="#l24.410"></a><span id="l24.410">   aFolder-&gt;ForceDBClosed();</span>
<a href="#l24.411"></a><span id="l24.411"> </span>
<a href="#l24.412"></a><span id="l24.412">   // rename folder</span>
<a href="#l24.413"></a><span id="l24.413">   rv = oldPathFile-&gt;MoveTo(nullptr, safeName);</span>
<a href="#l24.414"></a><span id="l24.414">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.415"></a><span id="l24.415"> </span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-  if (numChildren &gt; 0)</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineminus">-  {</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineplus">+  if (numChildren &gt; 0) {</span>
<a href="#l24.419"></a><span id="l24.419">     // rename &quot;*.sbd&quot; directory</span>
<a href="#l24.420"></a><span id="l24.420">     nsAutoString sbdName = safeName;</span>
<a href="#l24.421"></a><span id="l24.421">     sbdName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l24.422"></a><span id="l24.422">     sbdPathFile-&gt;MoveTo(nullptr, sbdName);</span>
<a href="#l24.423"></a><span id="l24.423">   }</span>
<a href="#l24.424"></a><span id="l24.424"> </span>
<a href="#l24.425"></a><span id="l24.425">   // rename summary</span>
<a href="#l24.426"></a><span id="l24.426">   nsAutoString summaryName(safeName);</span>
<a href="#l24.427"></a><span id="l24.427">   summaryName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l24.428"></a><span id="l24.428">   oldSummaryFile-&gt;MoveTo(nullptr, summaryName);</span>
<a href="#l24.429"></a><span id="l24.429"> </span>
<a href="#l24.430"></a><span id="l24.430">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l24.431"></a><span id="l24.431">   rv = aFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-  if (!parentFolder)</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l24.434"></a><span id="l24.434" class="difflineplus">+  if (!parentFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l24.435"></a><span id="l24.435"> </span>
<a href="#l24.436"></a><span id="l24.436">   return parentFolder-&gt;AddSubfolder(safeName, aNewFolder);</span>
<a href="#l24.437"></a><span id="l24.437"> }</span>
<a href="#l24.438"></a><span id="l24.438"> </span>
<a href="#l24.439"></a><span id="l24.439" class="difflineminus">-NS_IMETHODIMP nsMsgMaildirStore::CopyFolder(nsIMsgFolder *aSrcFolder,</span>
<a href="#l24.440"></a><span id="l24.440" class="difflineminus">-                                            nsIMsgFolder *aDstFolder,</span>
<a href="#l24.441"></a><span id="l24.441" class="difflineminus">-                                            bool aIsMoveFolder,</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineminus">-                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineminus">-                                            nsIMsgCopyServiceListener *aListener,</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineminus">-                                            const nsAString &amp;aNewName)</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineminus">-{</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::CopyFolder(</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+    nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDstFolder, bool aIsMoveFolder,</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIMsgCopyServiceListener *aListener,</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineplus">+    const nsAString &amp;aNewName) {</span>
<a href="#l24.450"></a><span id="l24.450">   NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l24.451"></a><span id="l24.451">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l24.452"></a><span id="l24.452"> </span>
<a href="#l24.453"></a><span id="l24.453">   nsAutoString folderName;</span>
<a href="#l24.454"></a><span id="l24.454">   if (aNewName.IsEmpty())</span>
<a href="#l24.455"></a><span id="l24.455">     aSrcFolder-&gt;GetName(folderName);</span>
<a href="#l24.456"></a><span id="l24.456">   else</span>
<a href="#l24.457"></a><span id="l24.457">     folderName.Assign(aNewName);</span>
<a href="#l24.458"></a><span id="l24.458"> </span>
<a href="#l24.459"></a><span id="l24.459">   nsAutoString safeFolderName(folderName);</span>
<a href="#l24.460"></a><span id="l24.460">   NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l24.461"></a><span id="l24.461">   aSrcFolder-&gt;ForceDBClosed();</span>
<a href="#l24.462"></a><span id="l24.462"> </span>
<a href="#l24.463"></a><span id="l24.463">   nsCOMPtr&lt;nsIFile&gt; oldPath;</span>
<a href="#l24.464"></a><span id="l24.464">   nsresult rv = aSrcFolder-&gt;GetFilePath(getter_AddRefs(oldPath));</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l24.466"></a><span id="l24.466" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.467"></a><span id="l24.467"> </span>
<a href="#l24.468"></a><span id="l24.468">   nsCOMPtr&lt;nsIFile&gt; summaryFile;</span>
<a href="#l24.469"></a><span id="l24.469">   GetSummaryFileLocation(oldPath, getter_AddRefs(summaryFile));</span>
<a href="#l24.470"></a><span id="l24.470"> </span>
<a href="#l24.471"></a><span id="l24.471">   nsCOMPtr&lt;nsIFile&gt; newPath;</span>
<a href="#l24.472"></a><span id="l24.472">   rv = aDstFolder-&gt;GetFilePath(getter_AddRefs(newPath));</span>
<a href="#l24.473"></a><span id="l24.473">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.474"></a><span id="l24.474"> </span>
<a href="#l24.475"></a><span id="l24.475" class="difflineat">@@ -473,172 +431,157 @@ NS_IMETHODIMP nsMsgMaildirStore::CopyFol</span>
<a href="#l24.476"></a><span id="l24.476">   aDstFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l24.477"></a><span id="l24.477">   rv = CreateDirectoryForFolder(newPath, isServer);</span>
<a href="#l24.478"></a><span id="l24.478">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.479"></a><span id="l24.479"> </span>
<a href="#l24.480"></a><span id="l24.480">   nsCOMPtr&lt;nsIFile&gt; origPath;</span>
<a href="#l24.481"></a><span id="l24.481">   oldPath-&gt;Clone(getter_AddRefs(origPath));</span>
<a href="#l24.482"></a><span id="l24.482"> </span>
<a href="#l24.483"></a><span id="l24.483">   rv = oldPath-&gt;CopyTo(newPath, safeFolderName);</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv); //will fail if a file by that name exists</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);  // will fail if a file by that name exists</span>
<a href="#l24.486"></a><span id="l24.486"> </span>
<a href="#l24.487"></a><span id="l24.487">   // Copy to dir can fail if file does not exist. If copy fails, we test</span>
<a href="#l24.488"></a><span id="l24.488">   // if the file exists or not, if it does not that's ok, we continue</span>
<a href="#l24.489"></a><span id="l24.489">   // without copying it. If it fails and file exist and is not zero sized</span>
<a href="#l24.490"></a><span id="l24.490">   // there is real problem.</span>
<a href="#l24.491"></a><span id="l24.491">   nsAutoString dbName(safeFolderName);</span>
<a href="#l24.492"></a><span id="l24.492">   dbName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l24.493"></a><span id="l24.493">   rv = summaryFile-&gt;CopyTo(newPath, dbName);</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineminus">-  if (!NS_SUCCEEDED(rv))</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineminus">-  {</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineplus">+  if (!NS_SUCCEEDED(rv)) {</span>
<a href="#l24.497"></a><span id="l24.497">     // Test if the file is not empty</span>
<a href="#l24.498"></a><span id="l24.498">     bool exists;</span>
<a href="#l24.499"></a><span id="l24.499">     int64_t fileSize;</span>
<a href="#l24.500"></a><span id="l24.500">     summaryFile-&gt;Exists(&amp;exists);</span>
<a href="#l24.501"></a><span id="l24.501">     summaryFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l24.502"></a><span id="l24.502">     if (exists &amp;&amp; fileSize &gt; 0)</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv); // Yes, it should have worked!</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);  // Yes, it should have worked!</span>
<a href="#l24.505"></a><span id="l24.505">     // else case is file is zero sized, no need to copy it,</span>
<a href="#l24.506"></a><span id="l24.506">     // not an error</span>
<a href="#l24.507"></a><span id="l24.507">     // else case is file does not exist - not an error</span>
<a href="#l24.508"></a><span id="l24.508">   }</span>
<a href="#l24.509"></a><span id="l24.509"> </span>
<a href="#l24.510"></a><span id="l24.510">   nsCOMPtr&lt;nsIMsgFolder&gt; newMsgFolder;</span>
<a href="#l24.511"></a><span id="l24.511">   rv = aDstFolder-&gt;AddSubfolder(safeFolderName, getter_AddRefs(newMsgFolder));</span>
<a href="#l24.512"></a><span id="l24.512">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.513"></a><span id="l24.513"> </span>
<a href="#l24.514"></a><span id="l24.514">   newMsgFolder-&gt;SetPrettyName(folderName);</span>
<a href="#l24.515"></a><span id="l24.515">   uint32_t flags;</span>
<a href="#l24.516"></a><span id="l24.516">   aSrcFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l24.517"></a><span id="l24.517">   newMsgFolder-&gt;SetFlags(flags);</span>
<a href="#l24.518"></a><span id="l24.518">   bool changed = false;</span>
<a href="#l24.519"></a><span id="l24.519">   rv = aSrcFolder-&gt;MatchOrChangeFilterDestination(newMsgFolder, true, &amp;changed);</span>
<a href="#l24.520"></a><span id="l24.520" class="difflineminus">-  if (changed)</span>
<a href="#l24.521"></a><span id="l24.521" class="difflineminus">-    aSrcFolder-&gt;AlertFilterChanged(aMsgWindow);</span>
<a href="#l24.522"></a><span id="l24.522" class="difflineplus">+  if (changed) aSrcFolder-&gt;AlertFilterChanged(aMsgWindow);</span>
<a href="#l24.523"></a><span id="l24.523"> </span>
<a href="#l24.524"></a><span id="l24.524">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l24.525"></a><span id="l24.525">   rv = aSrcFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l24.526"></a><span id="l24.526">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.527"></a><span id="l24.527"> </span>
<a href="#l24.528"></a><span id="l24.528">   // Copy subfolders to the new location</span>
<a href="#l24.529"></a><span id="l24.529">   nsresult copyStatus = NS_OK;</span>
<a href="#l24.530"></a><span id="l24.530" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l24.531"></a><span id="l24.531" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l24.532"></a><span id="l24.532" class="difflineminus">-  {</span>
<a href="#l24.533"></a><span id="l24.533" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(</span>
<a href="#l24.534"></a><span id="l24.534" class="difflineplus">+      do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l24.535"></a><span id="l24.535" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l24.536"></a><span id="l24.536">     bool hasMore;</span>
<a href="#l24.537"></a><span id="l24.537">     while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp;</span>
<a href="#l24.538"></a><span id="l24.538" class="difflineminus">-           NS_SUCCEEDED(copyStatus))</span>
<a href="#l24.539"></a><span id="l24.539" class="difflineminus">-    {</span>
<a href="#l24.540"></a><span id="l24.540" class="difflineplus">+           NS_SUCCEEDED(copyStatus)) {</span>
<a href="#l24.541"></a><span id="l24.541">       nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l24.542"></a><span id="l24.542">       enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l24.543"></a><span id="l24.543"> </span>
<a href="#l24.544"></a><span id="l24.544">       nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l24.545"></a><span id="l24.545" class="difflineminus">-      if (!folder)</span>
<a href="#l24.546"></a><span id="l24.546" class="difflineminus">-        continue;</span>
<a href="#l24.547"></a><span id="l24.547" class="difflineplus">+      if (!folder) continue;</span>
<a href="#l24.548"></a><span id="l24.548"> </span>
<a href="#l24.549"></a><span id="l24.549" class="difflineminus">-      copyStatus = localNewFolder-&gt;CopyFolderLocal(folder, false, aMsgWindow,</span>
<a href="#l24.550"></a><span id="l24.550" class="difflineminus">-                                                   aListener);</span>
<a href="#l24.551"></a><span id="l24.551" class="difflineplus">+      copyStatus =</span>
<a href="#l24.552"></a><span id="l24.552" class="difflineplus">+          localNewFolder-&gt;CopyFolderLocal(folder, false, aMsgWindow, aListener);</span>
<a href="#l24.553"></a><span id="l24.553">       // Test if the call succeeded, if not we have to stop recursive call</span>
<a href="#l24.554"></a><span id="l24.554" class="difflineminus">-      if (NS_FAILED(copyStatus))</span>
<a href="#l24.555"></a><span id="l24.555" class="difflineminus">-      {</span>
<a href="#l24.556"></a><span id="l24.556" class="difflineplus">+      if (NS_FAILED(copyStatus)) {</span>
<a href="#l24.557"></a><span id="l24.557">         // Copy failed we have to notify caller to handle the error and stop</span>
<a href="#l24.558"></a><span id="l24.558">         // moving the folders. In case this happens to the topmost level of</span>
<a href="#l24.559"></a><span id="l24.559">         // recursive call, then we just need to break from the while loop and</span>
<a href="#l24.560"></a><span id="l24.560">         // go to error handling code.</span>
<a href="#l24.561"></a><span id="l24.561" class="difflineminus">-        if (!aIsMoveFolder)</span>
<a href="#l24.562"></a><span id="l24.562" class="difflineminus">-          return copyStatus;</span>
<a href="#l24.563"></a><span id="l24.563" class="difflineplus">+        if (!aIsMoveFolder) return copyStatus;</span>
<a href="#l24.564"></a><span id="l24.564">         break;</span>
<a href="#l24.565"></a><span id="l24.565">       }</span>
<a href="#l24.566"></a><span id="l24.566">     }</span>
<a href="#l24.567"></a><span id="l24.567">   }</span>
<a href="#l24.568"></a><span id="l24.568"> </span>
<a href="#l24.569"></a><span id="l24.569" class="difflineminus">-  if (aIsMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus))</span>
<a href="#l24.570"></a><span id="l24.570" class="difflineminus">-  {</span>
<a href="#l24.571"></a><span id="l24.571" class="difflineminus">-    if (localNewFolder)</span>
<a href="#l24.572"></a><span id="l24.572" class="difflineminus">-    {</span>
<a href="#l24.573"></a><span id="l24.573" class="difflineplus">+  if (aIsMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus)) {</span>
<a href="#l24.574"></a><span id="l24.574" class="difflineplus">+    if (localNewFolder) {</span>
<a href="#l24.575"></a><span id="l24.575">       nsCOMPtr&lt;nsISupports&gt; srcSupport(do_QueryInterface(aSrcFolder));</span>
<a href="#l24.576"></a><span id="l24.576">       localNewFolder-&gt;OnCopyCompleted(srcSupport, true);</span>
<a href="#l24.577"></a><span id="l24.577">     }</span>
<a href="#l24.578"></a><span id="l24.578"> </span>
<a href="#l24.579"></a><span id="l24.579">     // Notify that the folder that was dragged and dropped has been created.</span>
<a href="#l24.580"></a><span id="l24.580" class="difflineminus">-    // No need to do this for its subfolders - isMoveFolder will be true for folder.</span>
<a href="#l24.581"></a><span id="l24.581" class="difflineplus">+    // No need to do this for its subfolders - isMoveFolder will be true for</span>
<a href="#l24.582"></a><span id="l24.582" class="difflineplus">+    // folder.</span>
<a href="#l24.583"></a><span id="l24.583">     aDstFolder-&gt;NotifyItemAdded(newMsgFolder);</span>
<a href="#l24.584"></a><span id="l24.584"> </span>
<a href="#l24.585"></a><span id="l24.585">     nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l24.586"></a><span id="l24.586">     aSrcFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l24.587"></a><span id="l24.587">     aSrcFolder-&gt;SetParent(nullptr);</span>
<a href="#l24.588"></a><span id="l24.588" class="difflineminus">-    if (msgParent)</span>
<a href="#l24.589"></a><span id="l24.589" class="difflineminus">-    {</span>
<a href="#l24.590"></a><span id="l24.590" class="difflineplus">+    if (msgParent) {</span>
<a href="#l24.591"></a><span id="l24.591">       // The files have already been moved, so delete storage false</span>
<a href="#l24.592"></a><span id="l24.592">       msgParent-&gt;PropagateDelete(aSrcFolder, false, aMsgWindow);</span>
<a href="#l24.593"></a><span id="l24.593">       oldPath-&gt;Remove(true);</span>
<a href="#l24.594"></a><span id="l24.594" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB; // we need to force closed the source db</span>
<a href="#l24.595"></a><span id="l24.595" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;  // we need to force closed the source db</span>
<a href="#l24.596"></a><span id="l24.596">       aSrcFolder-&gt;Delete();</span>
<a href="#l24.597"></a><span id="l24.597"> </span>
<a href="#l24.598"></a><span id="l24.598">       nsCOMPtr&lt;nsIFile&gt; parentPath;</span>
<a href="#l24.599"></a><span id="l24.599">       rv = msgParent-&gt;GetFilePath(getter_AddRefs(parentPath));</span>
<a href="#l24.600"></a><span id="l24.600" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l24.601"></a><span id="l24.601" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.602"></a><span id="l24.602"> </span>
<a href="#l24.603"></a><span id="l24.603">       AddDirectorySeparator(parentPath);</span>
<a href="#l24.604"></a><span id="l24.604">       nsCOMPtr&lt;nsIDirectoryEnumerator&gt; children;</span>
<a href="#l24.605"></a><span id="l24.605">       parentPath-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l24.606"></a><span id="l24.606">       bool more;</span>
<a href="#l24.607"></a><span id="l24.607">       // checks if the directory is empty or not</span>
<a href="#l24.608"></a><span id="l24.608">       if (children &amp;&amp; NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; !more)</span>
<a href="#l24.609"></a><span id="l24.609">         parentPath-&gt;Remove(true);</span>
<a href="#l24.610"></a><span id="l24.610">     }</span>
<a href="#l24.611"></a><span id="l24.611" class="difflineminus">-  }</span>
<a href="#l24.612"></a><span id="l24.612" class="difflineminus">-  else</span>
<a href="#l24.613"></a><span id="l24.613" class="difflineminus">-  {</span>
<a href="#l24.614"></a><span id="l24.614" class="difflineplus">+  } else {</span>
<a href="#l24.615"></a><span id="l24.615">     // This is the case where the copy of a subfolder failed.</span>
<a href="#l24.616"></a><span id="l24.616">     // We have to delete the newDirectory tree to make a &quot;rollback&quot;.</span>
<a href="#l24.617"></a><span id="l24.617">     // Someone should add a popup to warn the user that the move was not</span>
<a href="#l24.618"></a><span id="l24.618">     // possible.</span>
<a href="#l24.619"></a><span id="l24.619" class="difflineminus">-    if (aIsMoveFolder &amp;&amp; NS_FAILED(copyStatus))</span>
<a href="#l24.620"></a><span id="l24.620" class="difflineminus">-    {</span>
<a href="#l24.621"></a><span id="l24.621" class="difflineplus">+    if (aIsMoveFolder &amp;&amp; NS_FAILED(copyStatus)) {</span>
<a href="#l24.622"></a><span id="l24.622">       nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l24.623"></a><span id="l24.623">       newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l24.624"></a><span id="l24.624">       newMsgFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l24.625"></a><span id="l24.625">       newMsgFolder-&gt;SetParent(nullptr);</span>
<a href="#l24.626"></a><span id="l24.626" class="difflineminus">-      if (msgParent)</span>
<a href="#l24.627"></a><span id="l24.627" class="difflineminus">-      {</span>
<a href="#l24.628"></a><span id="l24.628" class="difflineplus">+      if (msgParent) {</span>
<a href="#l24.629"></a><span id="l24.629">         msgParent-&gt;PropagateDelete(newMsgFolder, false, aMsgWindow);</span>
<a href="#l24.630"></a><span id="l24.630">         newMsgFolder-&gt;Delete();</span>
<a href="#l24.631"></a><span id="l24.631">         newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l24.632"></a><span id="l24.632">         AddDirectorySeparator(newPath);</span>
<a href="#l24.633"></a><span id="l24.633" class="difflineminus">-        newPath-&gt;Remove(true); //berkeley mailbox</span>
<a href="#l24.634"></a><span id="l24.634" class="difflineplus">+        newPath-&gt;Remove(true);  // berkeley mailbox</span>
<a href="#l24.635"></a><span id="l24.635">       }</span>
<a href="#l24.636"></a><span id="l24.636">       return NS_ERROR_FAILURE;</span>
<a href="#l24.637"></a><span id="l24.637">     }</span>
<a href="#l24.638"></a><span id="l24.638">   }</span>
<a href="#l24.639"></a><span id="l24.639">   return NS_OK;</span>
<a href="#l24.640"></a><span id="l24.640"> }</span>
<a href="#l24.641"></a><span id="l24.641"> </span>
<a href="#l24.642"></a><span id="l24.642"> NS_IMETHODIMP</span>
<a href="#l24.643"></a><span id="l24.643"> nsMsgMaildirStore::GetNewMsgOutputStream(nsIMsgFolder *aFolder,</span>
<a href="#l24.644"></a><span id="l24.644">                                          nsIMsgDBHdr **aNewMsgHdr,</span>
<a href="#l24.645"></a><span id="l24.645">                                          bool *aReusable,</span>
<a href="#l24.646"></a><span id="l24.646" class="difflineminus">-                                         nsIOutputStream **aResult)</span>
<a href="#l24.647"></a><span id="l24.647" class="difflineminus">-{</span>
<a href="#l24.648"></a><span id="l24.648" class="difflineplus">+                                         nsIOutputStream **aResult) {</span>
<a href="#l24.649"></a><span id="l24.649">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.650"></a><span id="l24.650">   NS_ENSURE_ARG_POINTER(aNewMsgHdr);</span>
<a href="#l24.651"></a><span id="l24.651">   NS_ENSURE_ARG_POINTER(aReusable);</span>
<a href="#l24.652"></a><span id="l24.652">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.653"></a><span id="l24.653"> </span>
<a href="#l24.654"></a><span id="l24.654" class="difflineminus">-  *aReusable = false; // message per file</span>
<a href="#l24.655"></a><span id="l24.655" class="difflineplus">+  *aReusable = false;  // message per file</span>
<a href="#l24.656"></a><span id="l24.656"> </span>
<a href="#l24.657"></a><span id="l24.657">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l24.658"></a><span id="l24.658">   nsresult rv = aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l24.659"></a><span id="l24.659">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.660"></a><span id="l24.660"> </span>
<a href="#l24.661"></a><span id="l24.661" class="difflineminus">-  if (!*aNewMsgHdr)</span>
<a href="#l24.662"></a><span id="l24.662" class="difflineminus">-  {</span>
<a href="#l24.663"></a><span id="l24.663" class="difflineplus">+  if (!*aNewMsgHdr) {</span>
<a href="#l24.664"></a><span id="l24.664">     rv = db-&gt;CreateNewHdr(nsMsgKey_None, aNewMsgHdr);</span>
<a href="#l24.665"></a><span id="l24.665">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.666"></a><span id="l24.666" class="difflineminus">-</span>
<a href="#l24.667"></a><span id="l24.667">   }</span>
<a href="#l24.668"></a><span id="l24.668">   // With maildir, messages have whole file to themselves.</span>
<a href="#l24.669"></a><span id="l24.669">   (*aNewMsgHdr)-&gt;SetMessageOffset(0);</span>
<a href="#l24.670"></a><span id="l24.670"> </span>
<a href="#l24.671"></a><span id="l24.671">   // We're going to save the new message into the maildir 'tmp' folder.</span>
<a href="#l24.672"></a><span id="l24.672">   // When the message is completed, it can be moved to 'cur'.</span>
<a href="#l24.673"></a><span id="l24.673">   nsCOMPtr&lt;nsIFile&gt; newFile;</span>
<a href="#l24.674"></a><span id="l24.674">   rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l24.675"></a><span id="l24.675" class="difflineat">@@ -646,17 +589,17 @@ nsMsgMaildirStore::GetNewMsgOutputStream</span>
<a href="#l24.676"></a><span id="l24.676">   newFile-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l24.677"></a><span id="l24.677"> </span>
<a href="#l24.678"></a><span id="l24.678">   // let's check if the folder exists</span>
<a href="#l24.679"></a><span id="l24.679">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l24.680"></a><span id="l24.680">   bool exists;</span>
<a href="#l24.681"></a><span id="l24.681">   newFile-&gt;Exists(&amp;exists);</span>
<a href="#l24.682"></a><span id="l24.682">   if (!exists) {</span>
<a href="#l24.683"></a><span id="l24.683">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.684"></a><span id="l24.684" class="difflineminus">-           (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!\n&quot;));</span>
<a href="#l24.685"></a><span id="l24.685" class="difflineplus">+            (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!\n&quot;));</span>
<a href="#l24.686"></a><span id="l24.686">     rv = newFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l24.687"></a><span id="l24.687">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.688"></a><span id="l24.688">   }</span>
<a href="#l24.689"></a><span id="l24.689"> </span>
<a href="#l24.690"></a><span id="l24.690">   // Generate the 'tmp' file name based on timestamp.</span>
<a href="#l24.691"></a><span id="l24.691">   // (We'll use the Message-ID as the basis for the final filename,</span>
<a href="#l24.692"></a><span id="l24.692">   // but we don't have headers at this point).</span>
<a href="#l24.693"></a><span id="l24.693">   nsAutoCString newName;</span>
<a href="#l24.694"></a><span id="l24.694" class="difflineat">@@ -670,27 +613,25 @@ nsMsgMaildirStore::GetNewMsgOutputStream</span>
<a href="#l24.695"></a><span id="l24.695">   // save the file name in the message header - otherwise no way to retrieve it</span>
<a href="#l24.696"></a><span id="l24.696">   (*aNewMsgHdr)-&gt;SetStringProperty(&quot;storeToken&quot;, newName.get());</span>
<a href="#l24.697"></a><span id="l24.697">   return MsgNewBufferedFileOutputStream(aResult, newFile,</span>
<a href="#l24.698"></a><span id="l24.698">                                         PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l24.699"></a><span id="l24.699"> }</span>
<a href="#l24.700"></a><span id="l24.700"> </span>
<a href="#l24.701"></a><span id="l24.701"> NS_IMETHODIMP</span>
<a href="#l24.702"></a><span id="l24.702"> nsMsgMaildirStore::DiscardNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l24.703"></a><span id="l24.703" class="difflineminus">-                                     nsIMsgDBHdr *aNewHdr)</span>
<a href="#l24.704"></a><span id="l24.704" class="difflineminus">-{</span>
<a href="#l24.705"></a><span id="l24.705" class="difflineplus">+                                     nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l24.706"></a><span id="l24.706">   NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l24.707"></a><span id="l24.707">   NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l24.708"></a><span id="l24.708"> </span>
<a href="#l24.709"></a><span id="l24.709">   aOutputStream-&gt;Close();</span>
<a href="#l24.710"></a><span id="l24.710">   // file path is stored in message header property &quot;storeToken&quot;</span>
<a href="#l24.711"></a><span id="l24.711">   nsAutoCString fileName;</span>
<a href="#l24.712"></a><span id="l24.712">   aNewHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l24.713"></a><span id="l24.713" class="difflineminus">-  if (fileName.IsEmpty())</span>
<a href="#l24.714"></a><span id="l24.714" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l24.715"></a><span id="l24.715" class="difflineplus">+  if (fileName.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l24.716"></a><span id="l24.716"> </span>
<a href="#l24.717"></a><span id="l24.717">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.718"></a><span id="l24.718">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l24.719"></a><span id="l24.719">   nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l24.720"></a><span id="l24.720">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.721"></a><span id="l24.721">   rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.722"></a><span id="l24.722">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.723"></a><span id="l24.723"> </span>
<a href="#l24.724"></a><span id="l24.724" class="difflineat">@@ -698,51 +639,48 @@ nsMsgMaildirStore::DiscardNewMessage(nsI</span>
<a href="#l24.725"></a><span id="l24.725">   path-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l24.726"></a><span id="l24.726">   path-&gt;AppendNative(fileName);</span>
<a href="#l24.727"></a><span id="l24.727"> </span>
<a href="#l24.728"></a><span id="l24.728">   return path-&gt;Remove(false);</span>
<a href="#l24.729"></a><span id="l24.729"> }</span>
<a href="#l24.730"></a><span id="l24.730"> </span>
<a href="#l24.731"></a><span id="l24.731"> NS_IMETHODIMP</span>
<a href="#l24.732"></a><span id="l24.732"> nsMsgMaildirStore::FinishNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l24.733"></a><span id="l24.733" class="difflineminus">-                                    nsIMsgDBHdr *aNewHdr)</span>
<a href="#l24.734"></a><span id="l24.734" class="difflineminus">-{</span>
<a href="#l24.735"></a><span id="l24.735" class="difflineplus">+                                    nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l24.736"></a><span id="l24.736">   NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l24.737"></a><span id="l24.737">   NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l24.738"></a><span id="l24.738"> </span>
<a href="#l24.739"></a><span id="l24.739">   aOutputStream-&gt;Close();</span>
<a href="#l24.740"></a><span id="l24.740"> </span>
<a href="#l24.741"></a><span id="l24.741">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l24.742"></a><span id="l24.742">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l24.743"></a><span id="l24.743">   nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l24.744"></a><span id="l24.744">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.745"></a><span id="l24.745">   rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l24.746"></a><span id="l24.746">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.747"></a><span id="l24.747"> </span>
<a href="#l24.748"></a><span id="l24.748">   // tmp filename is stored in &quot;storeToken&quot;.</span>
<a href="#l24.749"></a><span id="l24.749">   // By now we'll have the Message-ID, which we'll base the final filename on.</span>
<a href="#l24.750"></a><span id="l24.750">   nsAutoCString tmpName;</span>
<a href="#l24.751"></a><span id="l24.751">   aNewHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(tmpName));</span>
<a href="#l24.752"></a><span id="l24.752" class="difflineminus">-  if (tmpName.IsEmpty())</span>
<a href="#l24.753"></a><span id="l24.753" class="difflineminus">-  {</span>
<a href="#l24.754"></a><span id="l24.754" class="difflineplus">+  if (tmpName.IsEmpty()) {</span>
<a href="#l24.755"></a><span id="l24.755">     NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!\n&quot;);</span>
<a href="#l24.756"></a><span id="l24.756">     return NS_ERROR_FAILURE;</span>
<a href="#l24.757"></a><span id="l24.757">   }</span>
<a href="#l24.758"></a><span id="l24.758"> </span>
<a href="#l24.759"></a><span id="l24.759">   // path to the new destination</span>
<a href="#l24.760"></a><span id="l24.760">   nsCOMPtr&lt;nsIFile&gt; curPath;</span>
<a href="#l24.761"></a><span id="l24.761">   folderPath-&gt;Clone(getter_AddRefs(curPath));</span>
<a href="#l24.762"></a><span id="l24.762">   curPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.763"></a><span id="l24.763"> </span>
<a href="#l24.764"></a><span id="l24.764">   // let's check if the folder exists</span>
<a href="#l24.765"></a><span id="l24.765">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l24.766"></a><span id="l24.766">   bool exists;</span>
<a href="#l24.767"></a><span id="l24.767">   curPath-&gt;Exists(&amp;exists);</span>
<a href="#l24.768"></a><span id="l24.768" class="difflineminus">-  if (!exists)</span>
<a href="#l24.769"></a><span id="l24.769" class="difflineminus">-  {</span>
<a href="#l24.770"></a><span id="l24.770" class="difflineplus">+  if (!exists) {</span>
<a href="#l24.771"></a><span id="l24.771">     rv = curPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l24.772"></a><span id="l24.772">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.773"></a><span id="l24.773">   }</span>
<a href="#l24.774"></a><span id="l24.774"> </span>
<a href="#l24.775"></a><span id="l24.775">   // path to the downloaded message</span>
<a href="#l24.776"></a><span id="l24.776">   nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l24.777"></a><span id="l24.777">   folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l24.778"></a><span id="l24.778">   fromPath-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l24.779"></a><span id="l24.779" class="difflineat">@@ -751,24 +689,23 @@ nsMsgMaildirStore::FinishNewMessage(nsIO</span>
<a href="#l24.780"></a><span id="l24.780">   // Check that the message is still in tmp.</span>
<a href="#l24.781"></a><span id="l24.781">   // XXX TODO: revisit this. I think it's needed because the</span>
<a href="#l24.782"></a><span id="l24.782">   // pairing rules for:</span>
<a href="#l24.783"></a><span id="l24.783">   // GetNewMsgOutputStream(), FinishNewMessage(),</span>
<a href="#l24.784"></a><span id="l24.784">   // MoveNewlyDownloadedMessage() and DiscardNewMessage()</span>
<a href="#l24.785"></a><span id="l24.785">   // are not well defined.</span>
<a href="#l24.786"></a><span id="l24.786">   // If they are sorted out, this code can be removed.</span>
<a href="#l24.787"></a><span id="l24.787">   fromPath-&gt;Exists(&amp;exists);</span>
<a href="#l24.788"></a><span id="l24.788" class="difflineminus">-  if (!exists)</span>
<a href="#l24.789"></a><span id="l24.789" class="difflineminus">-  {</span>
<a href="#l24.790"></a><span id="l24.790" class="difflineplus">+  if (!exists) {</span>
<a href="#l24.791"></a><span id="l24.791">     // Perhaps the message has already moved. See bug 1028372 to fix this.</span>
<a href="#l24.792"></a><span id="l24.792">     nsCOMPtr&lt;nsIFile&gt; existingPath;</span>
<a href="#l24.793"></a><span id="l24.793">     curPath-&gt;Clone(getter_AddRefs(existingPath));</span>
<a href="#l24.794"></a><span id="l24.794">     existingPath-&gt;AppendNative(tmpName);</span>
<a href="#l24.795"></a><span id="l24.795">     existingPath-&gt;Exists(&amp;exists);</span>
<a href="#l24.796"></a><span id="l24.796" class="difflineminus">-    if (exists) // then there is nothing to do</span>
<a href="#l24.797"></a><span id="l24.797" class="difflineplus">+    if (exists)  // then there is nothing to do</span>
<a href="#l24.798"></a><span id="l24.798">       return NS_OK;</span>
<a href="#l24.799"></a><span id="l24.799"> </span>
<a href="#l24.800"></a><span id="l24.800">     NS_ERROR(&quot;FinishNewMessage - oops! file does not exist!&quot;);</span>
<a href="#l24.801"></a><span id="l24.801">     return NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l24.802"></a><span id="l24.802">   }</span>
<a href="#l24.803"></a><span id="l24.803"> </span>
<a href="#l24.804"></a><span id="l24.804">   nsCString msgID;</span>
<a href="#l24.805"></a><span id="l24.805">   aNewHdr-&gt;GetMessageId(getter_Copies(msgID));</span>
<a href="#l24.806"></a><span id="l24.806" class="difflineat">@@ -781,17 +718,17 @@ nsMsgMaildirStore::FinishNewMessage(nsIO</span>
<a href="#l24.807"></a><span id="l24.807">   // below 9 chars.</span>
<a href="#l24.808"></a><span id="l24.808">   if (msgID.Length() &lt; 9) {</span>
<a href="#l24.809"></a><span id="l24.809">     baseName.AppendInt(static_cast&lt;int64_t&gt;(PR_Now()));</span>
<a href="#l24.810"></a><span id="l24.810">   } else {</span>
<a href="#l24.811"></a><span id="l24.811">     percentEncode(msgID, baseName);</span>
<a href="#l24.812"></a><span id="l24.812">     // No length limit on Message-Id header, but lets clip our filenames</span>
<a href="#l24.813"></a><span id="l24.813">     // well below any MAX_PATH limits.</span>
<a href="#l24.814"></a><span id="l24.814">     if (baseName.Length() &gt; (128 - 4)) {</span>
<a href="#l24.815"></a><span id="l24.815" class="difflineminus">-      baseName.SetLength(128 - 4);   // (4 for &quot;.eml&quot;)</span>
<a href="#l24.816"></a><span id="l24.816" class="difflineplus">+      baseName.SetLength(128 - 4);  // (4 for &quot;.eml&quot;)</span>
<a href="#l24.817"></a><span id="l24.817">     }</span>
<a href="#l24.818"></a><span id="l24.818">   }</span>
<a href="#l24.819"></a><span id="l24.819"> </span>
<a href="#l24.820"></a><span id="l24.820">   nsCOMPtr&lt;nsIFile&gt; toPath;</span>
<a href="#l24.821"></a><span id="l24.821">   curPath-&gt;Clone(getter_AddRefs(toPath));</span>
<a href="#l24.822"></a><span id="l24.822">   nsCString toName(baseName);</span>
<a href="#l24.823"></a><span id="l24.823">   toName.Append(&quot;.eml&quot;);</span>
<a href="#l24.824"></a><span id="l24.824">   toPath-&gt;AppendNative(toName);</span>
<a href="#l24.825"></a><span id="l24.825" class="difflineat">@@ -819,79 +756,74 @@ nsMsgMaildirStore::FinishNewMessage(nsIO</span>
<a href="#l24.826"></a><span id="l24.826">   // Update the db to reflect the final filename.</span>
<a href="#l24.827"></a><span id="l24.827">   aNewHdr-&gt;SetStringProperty(&quot;storeToken&quot;, toName.get());</span>
<a href="#l24.828"></a><span id="l24.828">   return NS_OK;</span>
<a href="#l24.829"></a><span id="l24.829"> }</span>
<a href="#l24.830"></a><span id="l24.830"> </span>
<a href="#l24.831"></a><span id="l24.831"> NS_IMETHODIMP</span>
<a href="#l24.832"></a><span id="l24.832"> nsMsgMaildirStore::MoveNewlyDownloadedMessage(nsIMsgDBHdr *aHdr,</span>
<a href="#l24.833"></a><span id="l24.833">                                               nsIMsgFolder *aDestFolder,</span>
<a href="#l24.834"></a><span id="l24.834" class="difflineminus">-                                              bool *aResult)</span>
<a href="#l24.835"></a><span id="l24.835" class="difflineminus">-{</span>
<a href="#l24.836"></a><span id="l24.836" class="difflineplus">+                                              bool *aResult) {</span>
<a href="#l24.837"></a><span id="l24.837">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l24.838"></a><span id="l24.838">   NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l24.839"></a><span id="l24.839">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.840"></a><span id="l24.840"> </span>
<a href="#l24.841"></a><span id="l24.841">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l24.842"></a><span id="l24.842">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l24.843"></a><span id="l24.843">   nsresult rv = aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l24.844"></a><span id="l24.844">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.845"></a><span id="l24.845">   rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l24.846"></a><span id="l24.846">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.847"></a><span id="l24.847"> </span>
<a href="#l24.848"></a><span id="l24.848">   // file path is stored in message header property</span>
<a href="#l24.849"></a><span id="l24.849">   nsAutoCString fileName;</span>
<a href="#l24.850"></a><span id="l24.850">   aHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l24.851"></a><span id="l24.851" class="difflineminus">-  if (fileName.IsEmpty())</span>
<a href="#l24.852"></a><span id="l24.852" class="difflineminus">-  {</span>
<a href="#l24.853"></a><span id="l24.853" class="difflineplus">+  if (fileName.IsEmpty()) {</span>
<a href="#l24.854"></a><span id="l24.854">     NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!\n&quot;);</span>
<a href="#l24.855"></a><span id="l24.855">     return NS_ERROR_FAILURE;</span>
<a href="#l24.856"></a><span id="l24.856">   }</span>
<a href="#l24.857"></a><span id="l24.857"> </span>
<a href="#l24.858"></a><span id="l24.858">   // path to the downloaded message</span>
<a href="#l24.859"></a><span id="l24.859">   nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l24.860"></a><span id="l24.860">   folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l24.861"></a><span id="l24.861">   fromPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.862"></a><span id="l24.862">   fromPath-&gt;AppendNative(fileName);</span>
<a href="#l24.863"></a><span id="l24.863"> </span>
<a href="#l24.864"></a><span id="l24.864">   // let's check if the tmp file exists</span>
<a href="#l24.865"></a><span id="l24.865">   bool exists;</span>
<a href="#l24.866"></a><span id="l24.866">   fromPath-&gt;Exists(&amp;exists);</span>
<a href="#l24.867"></a><span id="l24.867" class="difflineminus">-  if (!exists)</span>
<a href="#l24.868"></a><span id="l24.868" class="difflineminus">-  {</span>
<a href="#l24.869"></a><span id="l24.869" class="difflineplus">+  if (!exists) {</span>
<a href="#l24.870"></a><span id="l24.870">     NS_ERROR(&quot;FinishNewMessage - oops! file does not exist!&quot;);</span>
<a href="#l24.871"></a><span id="l24.871">     return NS_ERROR_FAILURE;</span>
<a href="#l24.872"></a><span id="l24.872">   }</span>
<a href="#l24.873"></a><span id="l24.873"> </span>
<a href="#l24.874"></a><span id="l24.874">   // move to the &quot;cur&quot; subfolder</span>
<a href="#l24.875"></a><span id="l24.875">   nsCOMPtr&lt;nsIFile&gt; toPath;</span>
<a href="#l24.876"></a><span id="l24.876">   aDestFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l24.877"></a><span id="l24.877">   folderPath-&gt;Clone(getter_AddRefs(toPath));</span>
<a href="#l24.878"></a><span id="l24.878">   toPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.879"></a><span id="l24.879"> </span>
<a href="#l24.880"></a><span id="l24.880">   // let's check if the folder exists</span>
<a href="#l24.881"></a><span id="l24.881">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l24.882"></a><span id="l24.882">   toPath-&gt;Exists(&amp;exists);</span>
<a href="#l24.883"></a><span id="l24.883" class="difflineminus">-  if (!exists)</span>
<a href="#l24.884"></a><span id="l24.884" class="difflineminus">-  {</span>
<a href="#l24.885"></a><span id="l24.885" class="difflineplus">+  if (!exists) {</span>
<a href="#l24.886"></a><span id="l24.886">     rv = toPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l24.887"></a><span id="l24.887">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.888"></a><span id="l24.888">   }</span>
<a href="#l24.889"></a><span id="l24.889"> </span>
<a href="#l24.890"></a><span id="l24.890">   nsCOMPtr&lt;nsIMsgDatabase&gt; destMailDB;</span>
<a href="#l24.891"></a><span id="l24.891">   rv = aDestFolder-&gt;GetMsgDatabase(getter_AddRefs(destMailDB));</span>
<a href="#l24.892"></a><span id="l24.892">   NS_WARNING_ASSERTION(destMailDB &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l24.893"></a><span id="l24.893">                        &quot;failed to open mail db moving message&quot;);</span>
<a href="#l24.894"></a><span id="l24.894"> </span>
<a href="#l24.895"></a><span id="l24.895">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l24.896"></a><span id="l24.896">   if (destMailDB)</span>
<a href="#l24.897"></a><span id="l24.897">     rv = destMailDB-&gt;CopyHdrFromExistingHdr(nsMsgKey_None, aHdr, true,</span>
<a href="#l24.898"></a><span id="l24.898">                                             getter_AddRefs(newHdr));</span>
<a href="#l24.899"></a><span id="l24.899" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !newHdr)</span>
<a href="#l24.900"></a><span id="l24.900" class="difflineminus">-    rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l24.901"></a><span id="l24.901" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !newHdr) rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l24.902"></a><span id="l24.902"> </span>
<a href="#l24.903"></a><span id="l24.903">   if (NS_FAILED(rv)) {</span>
<a href="#l24.904"></a><span id="l24.904">     aDestFolder-&gt;ThrowAlertMsg(&quot;filterFolderHdrAddFailed&quot;, nullptr);</span>
<a href="#l24.905"></a><span id="l24.905">     return rv;</span>
<a href="#l24.906"></a><span id="l24.906">   }</span>
<a href="#l24.907"></a><span id="l24.907"> </span>
<a href="#l24.908"></a><span id="l24.908">   nsCOMPtr&lt;nsIFile&gt; existingPath;</span>
<a href="#l24.909"></a><span id="l24.909">   toPath-&gt;Clone(getter_AddRefs(existingPath));</span>
<a href="#l24.910"></a><span id="l24.910" class="difflineat">@@ -906,167 +838,152 @@ nsMsgMaildirStore::MoveNewlyDownloadedMe</span>
<a href="#l24.911"></a><span id="l24.911">   }</span>
<a href="#l24.912"></a><span id="l24.912"> </span>
<a href="#l24.913"></a><span id="l24.913">   rv = fromPath-&gt;MoveToNative(toPath, fileName);</span>
<a href="#l24.914"></a><span id="l24.914">   *aResult = NS_SUCCEEDED(rv);</span>
<a href="#l24.915"></a><span id="l24.915">   if (NS_FAILED(rv))</span>
<a href="#l24.916"></a><span id="l24.916">     aDestFolder-&gt;ThrowAlertMsg(&quot;filterFolderWriteFailed&quot;, nullptr);</span>
<a href="#l24.917"></a><span id="l24.917"> </span>
<a href="#l24.918"></a><span id="l24.918">   if (NS_FAILED(rv)) {</span>
<a href="#l24.919"></a><span id="l24.919" class="difflineminus">-    if (destMailDB)</span>
<a href="#l24.920"></a><span id="l24.920" class="difflineminus">-      destMailDB-&gt;Close(true);</span>
<a href="#l24.921"></a><span id="l24.921" class="difflineplus">+    if (destMailDB) destMailDB-&gt;Close(true);</span>
<a href="#l24.922"></a><span id="l24.922"> </span>
<a href="#l24.923"></a><span id="l24.923">     return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l24.924"></a><span id="l24.924">   }</span>
<a href="#l24.925"></a><span id="l24.925"> </span>
<a href="#l24.926"></a><span id="l24.926">   bool movedMsgIsNew = false;</span>
<a href="#l24.927"></a><span id="l24.927">   // if we have made it this far then the message has successfully been</span>
<a href="#l24.928"></a><span id="l24.928">   // written to the new folder now add the header to the destMailDB.</span>
<a href="#l24.929"></a><span id="l24.929"> </span>
<a href="#l24.930"></a><span id="l24.930">   uint32_t newFlags;</span>
<a href="#l24.931"></a><span id="l24.931">   newHdr-&gt;GetFlags(&amp;newFlags);</span>
<a href="#l24.932"></a><span id="l24.932">   nsMsgKey msgKey;</span>
<a href="#l24.933"></a><span id="l24.933">   newHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l24.934"></a><span id="l24.934" class="difflineminus">-  if (!(newFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l24.935"></a><span id="l24.935" class="difflineminus">-  {</span>
<a href="#l24.936"></a><span id="l24.936" class="difflineplus">+  if (!(newFlags &amp; nsMsgMessageFlags::Read)) {</span>
<a href="#l24.937"></a><span id="l24.937">     nsCString junkScoreStr;</span>
<a href="#l24.938"></a><span id="l24.938" class="difflineminus">-    (void) newHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l24.939"></a><span id="l24.939" class="difflineplus">+    (void)newHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l24.940"></a><span id="l24.940">     if (atoi(junkScoreStr.get()) != nsIJunkMailPlugin::IS_SPAM_SCORE) {</span>
<a href="#l24.941"></a><span id="l24.941">       newHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l24.942"></a><span id="l24.942">       destMailDB-&gt;AddToNewList(msgKey);</span>
<a href="#l24.943"></a><span id="l24.943">       movedMsgIsNew = true;</span>
<a href="#l24.944"></a><span id="l24.944">     }</span>
<a href="#l24.945"></a><span id="l24.945">   }</span>
<a href="#l24.946"></a><span id="l24.946"> </span>
<a href="#l24.947"></a><span id="l24.947">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l24.948"></a><span id="l24.948" class="difflineminus">-    do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l24.949"></a><span id="l24.949" class="difflineminus">-  if (notifier)</span>
<a href="#l24.950"></a><span id="l24.950" class="difflineminus">-    notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l24.951"></a><span id="l24.951" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l24.952"></a><span id="l24.952" class="difflineplus">+  if (notifier) notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l24.953"></a><span id="l24.953"> </span>
<a href="#l24.954"></a><span id="l24.954">   if (movedMsgIsNew) {</span>
<a href="#l24.955"></a><span id="l24.955">     aDestFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l24.956"></a><span id="l24.956"> </span>
<a href="#l24.957"></a><span id="l24.957">     // Notify the message was moved.</span>
<a href="#l24.958"></a><span id="l24.958">     if (notifier) {</span>
<a href="#l24.959"></a><span id="l24.959" class="difflineminus">-      notifier-&gt;NotifyItemEvent(folder,</span>
<a href="#l24.960"></a><span id="l24.960" class="difflineminus">-                                NS_LITERAL_CSTRING(&quot;UnincorporatedMessageMoved&quot;),</span>
<a href="#l24.961"></a><span id="l24.961" class="difflineminus">-                                newHdr,</span>
<a href="#l24.962"></a><span id="l24.962" class="difflineminus">-                                EmptyCString());</span>
<a href="#l24.963"></a><span id="l24.963" class="difflineplus">+      notifier-&gt;NotifyItemEvent(</span>
<a href="#l24.964"></a><span id="l24.964" class="difflineplus">+          folder, NS_LITERAL_CSTRING(&quot;UnincorporatedMessageMoved&quot;), newHdr,</span>
<a href="#l24.965"></a><span id="l24.965" class="difflineplus">+          EmptyCString());</span>
<a href="#l24.966"></a><span id="l24.966">     }</span>
<a href="#l24.967"></a><span id="l24.967">   }</span>
<a href="#l24.968"></a><span id="l24.968"> </span>
<a href="#l24.969"></a><span id="l24.969">   nsCOMPtr&lt;nsIMsgDatabase&gt; sourceDB;</span>
<a href="#l24.970"></a><span id="l24.970">   rv = folder-&gt;GetMsgDatabase(getter_AddRefs(sourceDB));</span>
<a href="#l24.971"></a><span id="l24.971"> </span>
<a href="#l24.972"></a><span id="l24.972" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; sourceDB)</span>
<a href="#l24.973"></a><span id="l24.973" class="difflineminus">-    sourceDB-&gt;RemoveHeaderMdbRow(aHdr);</span>
<a href="#l24.974"></a><span id="l24.974" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; sourceDB) sourceDB-&gt;RemoveHeaderMdbRow(aHdr);</span>
<a href="#l24.975"></a><span id="l24.975"> </span>
<a href="#l24.976"></a><span id="l24.976">   destMailDB-&gt;SetSummaryValid(true);</span>
<a href="#l24.977"></a><span id="l24.977">   aDestFolder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l24.978"></a><span id="l24.978">   destMailDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l24.979"></a><span id="l24.979">   return rv;</span>
<a href="#l24.980"></a><span id="l24.980"> }</span>
<a href="#l24.981"></a><span id="l24.981"> </span>
<a href="#l24.982"></a><span id="l24.982"> NS_IMETHODIMP</span>
<a href="#l24.983"></a><span id="l24.983"> nsMsgMaildirStore::GetMsgInputStream(nsIMsgFolder *aMsgFolder,</span>
<a href="#l24.984"></a><span id="l24.984">                                      const nsACString &amp;aMsgToken,</span>
<a href="#l24.985"></a><span id="l24.985" class="difflineminus">-                                     int64_t *aOffset,</span>
<a href="#l24.986"></a><span id="l24.986" class="difflineminus">-                                     nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l24.987"></a><span id="l24.987" class="difflineplus">+                                     int64_t *aOffset, nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l24.988"></a><span id="l24.988">                                      bool *aReusable,</span>
<a href="#l24.989"></a><span id="l24.989" class="difflineminus">-                                     nsIInputStream **aResult)</span>
<a href="#l24.990"></a><span id="l24.990" class="difflineminus">-{</span>
<a href="#l24.991"></a><span id="l24.991" class="difflineplus">+                                     nsIInputStream **aResult) {</span>
<a href="#l24.992"></a><span id="l24.992">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l24.993"></a><span id="l24.993">   NS_ENSURE_ARG_POINTER(aOffset);</span>
<a href="#l24.994"></a><span id="l24.994">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l24.995"></a><span id="l24.995"> </span>
<a href="#l24.996"></a><span id="l24.996" class="difflineminus">-  *aReusable = false; // message per file</span>
<a href="#l24.997"></a><span id="l24.997" class="difflineplus">+  *aReusable = false;  // message per file</span>
<a href="#l24.998"></a><span id="l24.998">   *aOffset = 0;</span>
<a href="#l24.999"></a><span id="l24.999"> </span>
<a href="#l24.1000"></a><span id="l24.1000">   // construct path to file</span>
<a href="#l24.1001"></a><span id="l24.1001">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.1002"></a><span id="l24.1002">   nsresult rv = aMsgFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.1003"></a><span id="l24.1003">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1004"></a><span id="l24.1004"> </span>
<a href="#l24.1005"></a><span id="l24.1005" class="difflineminus">-  if (aMsgToken.IsEmpty())</span>
<a href="#l24.1006"></a><span id="l24.1006" class="difflineminus">-  {</span>
<a href="#l24.1007"></a><span id="l24.1007" class="difflineplus">+  if (aMsgToken.IsEmpty()) {</span>
<a href="#l24.1008"></a><span id="l24.1008">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.1009"></a><span id="l24.1009" class="difflineminus">-           (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l24.1010"></a><span id="l24.1010" class="difflineplus">+            (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l24.1011"></a><span id="l24.1011">     return NS_ERROR_FAILURE;</span>
<a href="#l24.1012"></a><span id="l24.1012">   }</span>
<a href="#l24.1013"></a><span id="l24.1013"> </span>
<a href="#l24.1014"></a><span id="l24.1014">   path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.1015"></a><span id="l24.1015"> </span>
<a href="#l24.1016"></a><span id="l24.1016">   // let's check if the folder exists</span>
<a href="#l24.1017"></a><span id="l24.1017">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l24.1018"></a><span id="l24.1018">   bool exists;</span>
<a href="#l24.1019"></a><span id="l24.1019">   path-&gt;Exists(&amp;exists);</span>
<a href="#l24.1020"></a><span id="l24.1020">   if (!exists) {</span>
<a href="#l24.1021"></a><span id="l24.1021">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.1022"></a><span id="l24.1022" class="difflineminus">-           (&quot;GetMsgInputStream - oops! cur subfolder does not exist!\n&quot;));</span>
<a href="#l24.1023"></a><span id="l24.1023" class="difflineplus">+            (&quot;GetMsgInputStream - oops! cur subfolder does not exist!\n&quot;));</span>
<a href="#l24.1024"></a><span id="l24.1024">     rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l24.1025"></a><span id="l24.1025">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1026"></a><span id="l24.1026">   }</span>
<a href="#l24.1027"></a><span id="l24.1027"> </span>
<a href="#l24.1028"></a><span id="l24.1028">   path-&gt;AppendNative(aMsgToken);</span>
<a href="#l24.1029"></a><span id="l24.1029">   return NS_NewLocalFileInputStream(aResult, path);</span>
<a href="#l24.1030"></a><span id="l24.1030"> }</span>
<a href="#l24.1031"></a><span id="l24.1031"> </span>
<a href="#l24.1032"></a><span id="l24.1032" class="difflineminus">-NS_IMETHODIMP nsMsgMaildirStore::DeleteMessages(nsIArray *aHdrArray)</span>
<a href="#l24.1033"></a><span id="l24.1033" class="difflineminus">-{</span>
<a href="#l24.1034"></a><span id="l24.1034" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::DeleteMessages(nsIArray *aHdrArray) {</span>
<a href="#l24.1035"></a><span id="l24.1035">   uint32_t messageCount;</span>
<a href="#l24.1036"></a><span id="l24.1036">   nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l24.1037"></a><span id="l24.1037">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1038"></a><span id="l24.1038">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l24.1039"></a><span id="l24.1039"> </span>
<a href="#l24.1040"></a><span id="l24.1040" class="difflineminus">-  for (uint32_t i = 0; i &lt; messageCount; i++)</span>
<a href="#l24.1041"></a><span id="l24.1041" class="difflineminus">-  {</span>
<a href="#l24.1042"></a><span id="l24.1042" class="difflineplus">+  for (uint32_t i = 0; i &lt; messageCount; i++) {</span>
<a href="#l24.1043"></a><span id="l24.1043">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l24.1044"></a><span id="l24.1044" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.1045"></a><span id="l24.1045" class="difflineminus">-      continue;</span>
<a href="#l24.1046"></a><span id="l24.1046" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l24.1047"></a><span id="l24.1047">     msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l24.1048"></a><span id="l24.1048">     nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.1049"></a><span id="l24.1049">     rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.1050"></a><span id="l24.1050">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1051"></a><span id="l24.1051">     nsAutoCString fileName;</span>
<a href="#l24.1052"></a><span id="l24.1052">     msgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l24.1053"></a><span id="l24.1053"> </span>
<a href="#l24.1054"></a><span id="l24.1054" class="difflineminus">-    if (fileName.IsEmpty())</span>
<a href="#l24.1055"></a><span id="l24.1055" class="difflineminus">-    {</span>
<a href="#l24.1056"></a><span id="l24.1056" class="difflineplus">+    if (fileName.IsEmpty()) {</span>
<a href="#l24.1057"></a><span id="l24.1057">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.1058"></a><span id="l24.1058" class="difflineminus">-             (&quot;DeleteMessages - empty storeToken!!\n&quot;));</span>
<a href="#l24.1059"></a><span id="l24.1059" class="difflineplus">+              (&quot;DeleteMessages - empty storeToken!!\n&quot;));</span>
<a href="#l24.1060"></a><span id="l24.1060">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l24.1061"></a><span id="l24.1061">       continue;</span>
<a href="#l24.1062"></a><span id="l24.1062">     }</span>
<a href="#l24.1063"></a><span id="l24.1063"> </span>
<a href="#l24.1064"></a><span id="l24.1064">     path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.1065"></a><span id="l24.1065">     path-&gt;AppendNative(fileName);</span>
<a href="#l24.1066"></a><span id="l24.1066"> </span>
<a href="#l24.1067"></a><span id="l24.1067">     // Let's check if the message exists.</span>
<a href="#l24.1068"></a><span id="l24.1068">     bool exists;</span>
<a href="#l24.1069"></a><span id="l24.1069">     path-&gt;Exists(&amp;exists);</span>
<a href="#l24.1070"></a><span id="l24.1070" class="difflineminus">-    if (!exists)</span>
<a href="#l24.1071"></a><span id="l24.1071" class="difflineminus">-    {</span>
<a href="#l24.1072"></a><span id="l24.1072" class="difflineplus">+    if (!exists) {</span>
<a href="#l24.1073"></a><span id="l24.1073">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.1074"></a><span id="l24.1074" class="difflineminus">-             (&quot;DeleteMessages - file does not exist !!\n&quot;));</span>
<a href="#l24.1075"></a><span id="l24.1075" class="difflineplus">+              (&quot;DeleteMessages - file does not exist !!\n&quot;));</span>
<a href="#l24.1076"></a><span id="l24.1076">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l24.1077"></a><span id="l24.1077">       continue;</span>
<a href="#l24.1078"></a><span id="l24.1078">     }</span>
<a href="#l24.1079"></a><span id="l24.1079">     path-&gt;Remove(false);</span>
<a href="#l24.1080"></a><span id="l24.1080">   }</span>
<a href="#l24.1081"></a><span id="l24.1081">   return NS_OK;</span>
<a href="#l24.1082"></a><span id="l24.1082"> }</span>
<a href="#l24.1083"></a><span id="l24.1083"> </span>
<a href="#l24.1084"></a><span id="l24.1084"> NS_IMETHODIMP</span>
<a href="#l24.1085"></a><span id="l24.1085"> nsMsgMaildirStore::CopyMessages(bool aIsMove, nsIArray *aHdrArray,</span>
<a href="#l24.1086"></a><span id="l24.1086" class="difflineminus">-                               nsIMsgFolder *aDstFolder,</span>
<a href="#l24.1087"></a><span id="l24.1087" class="difflineminus">-                               nsIMsgCopyServiceListener *aListener,</span>
<a href="#l24.1088"></a><span id="l24.1088" class="difflineminus">-                               nsIArray **aDstHdrs,</span>
<a href="#l24.1089"></a><span id="l24.1089" class="difflineminus">-                               nsITransaction **aUndoAction,</span>
<a href="#l24.1090"></a><span id="l24.1090" class="difflineminus">-                               bool *aCopyDone)</span>
<a href="#l24.1091"></a><span id="l24.1091" class="difflineminus">-{</span>
<a href="#l24.1092"></a><span id="l24.1092" class="difflineplus">+                                nsIMsgFolder *aDstFolder,</span>
<a href="#l24.1093"></a><span id="l24.1093" class="difflineplus">+                                nsIMsgCopyServiceListener *aListener,</span>
<a href="#l24.1094"></a><span id="l24.1094" class="difflineplus">+                                nsIArray **aDstHdrs,</span>
<a href="#l24.1095"></a><span id="l24.1095" class="difflineplus">+                                nsITransaction **aUndoAction, bool *aCopyDone) {</span>
<a href="#l24.1096"></a><span id="l24.1096">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l24.1097"></a><span id="l24.1097">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l24.1098"></a><span id="l24.1098">   NS_ENSURE_ARG_POINTER(aCopyDone);</span>
<a href="#l24.1099"></a><span id="l24.1099">   NS_ENSURE_ARG_POINTER(aUndoAction);</span>
<a href="#l24.1100"></a><span id="l24.1100"> </span>
<a href="#l24.1101"></a><span id="l24.1101">   *aCopyDone = false;</span>
<a href="#l24.1102"></a><span id="l24.1102"> </span>
<a href="#l24.1103"></a><span id="l24.1103">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder;</span>
<a href="#l24.1104"></a><span id="l24.1104" class="difflineat">@@ -1075,36 +992,33 @@ nsMsgMaildirStore::CopyMessages(bool aIs</span>
<a href="#l24.1105"></a><span id="l24.1105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1106"></a><span id="l24.1106">   rv = msgHdr-&gt;GetFolder(getter_AddRefs(srcFolder));</span>
<a href="#l24.1107"></a><span id="l24.1107">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1108"></a><span id="l24.1108"> </span>
<a href="#l24.1109"></a><span id="l24.1109">   // Both source and destination folders must use maildir type store.</span>
<a href="#l24.1110"></a><span id="l24.1110">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; srcStore;</span>
<a href="#l24.1111"></a><span id="l24.1111">   nsAutoCString srcType;</span>
<a href="#l24.1112"></a><span id="l24.1112">   srcFolder-&gt;GetMsgStore(getter_AddRefs(srcStore));</span>
<a href="#l24.1113"></a><span id="l24.1113" class="difflineminus">-  if (srcStore)</span>
<a href="#l24.1114"></a><span id="l24.1114" class="difflineminus">-    srcStore-&gt;GetStoreType(srcType);</span>
<a href="#l24.1115"></a><span id="l24.1115" class="difflineplus">+  if (srcStore) srcStore-&gt;GetStoreType(srcType);</span>
<a href="#l24.1116"></a><span id="l24.1116">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; dstStore;</span>
<a href="#l24.1117"></a><span id="l24.1117">   nsAutoCString dstType;</span>
<a href="#l24.1118"></a><span id="l24.1118">   aDstFolder-&gt;GetMsgStore(getter_AddRefs(dstStore));</span>
<a href="#l24.1119"></a><span id="l24.1119" class="difflineminus">-  if (dstStore)</span>
<a href="#l24.1120"></a><span id="l24.1120" class="difflineminus">-    dstStore-&gt;GetStoreType(dstType);</span>
<a href="#l24.1121"></a><span id="l24.1121" class="difflineplus">+  if (dstStore) dstStore-&gt;GetStoreType(dstType);</span>
<a href="#l24.1122"></a><span id="l24.1122">   if (!srcType.EqualsLiteral(&quot;maildir&quot;) || !dstType.EqualsLiteral(&quot;maildir&quot;))</span>
<a href="#l24.1123"></a><span id="l24.1123">     return NS_OK;</span>
<a href="#l24.1124"></a><span id="l24.1124"> </span>
<a href="#l24.1125"></a><span id="l24.1125">   // Both source and destination must be local folders. In theory we could</span>
<a href="#l24.1126"></a><span id="l24.1126">   //   do efficient copies of the offline store of IMAP, but this is not</span>
<a href="#l24.1127"></a><span id="l24.1127">   //   supported yet. For that, we need to deal with both correct handling</span>
<a href="#l24.1128"></a><span id="l24.1128">   //   of deletes from the src server, and msgKey = UIDL in the dst folder.</span>
<a href="#l24.1129"></a><span id="l24.1129" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; destLocalFolder(do_QueryInterface(aDstFolder));</span>
<a href="#l24.1130"></a><span id="l24.1130" class="difflineminus">-  if (!destLocalFolder)</span>
<a href="#l24.1131"></a><span id="l24.1131" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.1132"></a><span id="l24.1132" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; destLocalFolder(</span>
<a href="#l24.1133"></a><span id="l24.1133" class="difflineplus">+      do_QueryInterface(aDstFolder));</span>
<a href="#l24.1134"></a><span id="l24.1134" class="difflineplus">+  if (!destLocalFolder) return NS_OK;</span>
<a href="#l24.1135"></a><span id="l24.1135">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; srcLocalFolder(do_QueryInterface(srcFolder));</span>
<a href="#l24.1136"></a><span id="l24.1136" class="difflineminus">-  if (!srcLocalFolder)</span>
<a href="#l24.1137"></a><span id="l24.1137" class="difflineminus">-    return NS_OK;</span>
<a href="#l24.1138"></a><span id="l24.1138" class="difflineplus">+  if (!srcLocalFolder) return NS_OK;</span>
<a href="#l24.1139"></a><span id="l24.1139"> </span>
<a href="#l24.1140"></a><span id="l24.1140">   // We should be able to use a file move for an efficient copy.</span>
<a href="#l24.1141"></a><span id="l24.1141"> </span>
<a href="#l24.1142"></a><span id="l24.1142">   nsCOMPtr&lt;nsIFile&gt; destFolderPath;</span>
<a href="#l24.1143"></a><span id="l24.1143">   nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l24.1144"></a><span id="l24.1144">   aDstFolder-&gt;GetMsgDatabase(getter_AddRefs(destDB));</span>
<a href="#l24.1145"></a><span id="l24.1145">   rv = aDstFolder-&gt;GetFilePath(getter_AddRefs(destFolderPath));</span>
<a href="#l24.1146"></a><span id="l24.1146">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1147"></a><span id="l24.1147" class="difflineat">@@ -1114,136 +1028,123 @@ nsMsgMaildirStore::CopyMessages(bool aIs</span>
<a href="#l24.1148"></a><span id="l24.1148">   rv = srcFolder-&gt;GetFilePath(getter_AddRefs(srcFolderPath));</span>
<a href="#l24.1149"></a><span id="l24.1149">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1150"></a><span id="l24.1150">   srcFolderPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.1151"></a><span id="l24.1151"> </span>
<a href="#l24.1152"></a><span id="l24.1152">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l24.1153"></a><span id="l24.1153">   srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l24.1154"></a><span id="l24.1154">   RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; msgTxn = new nsLocalMoveCopyMsgTxn;</span>
<a href="#l24.1155"></a><span id="l24.1155">   NS_ENSURE_TRUE(msgTxn, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l24.1156"></a><span id="l24.1156" class="difflineminus">-  if (NS_SUCCEEDED(msgTxn-&gt;Init(srcFolder, aDstFolder, aIsMove)))</span>
<a href="#l24.1157"></a><span id="l24.1157" class="difflineminus">-  {</span>
<a href="#l24.1158"></a><span id="l24.1158" class="difflineplus">+  if (NS_SUCCEEDED(msgTxn-&gt;Init(srcFolder, aDstFolder, aIsMove))) {</span>
<a href="#l24.1159"></a><span id="l24.1159">     if (aIsMove)</span>
<a href="#l24.1160"></a><span id="l24.1160">       msgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l24.1161"></a><span id="l24.1161">     else</span>
<a href="#l24.1162"></a><span id="l24.1162">       msgTxn-&gt;SetTransactionType(nsIMessenger::eCopyMsg);</span>
<a href="#l24.1163"></a><span id="l24.1163">   }</span>
<a href="#l24.1164"></a><span id="l24.1164"> </span>
<a href="#l24.1165"></a><span id="l24.1165" class="difflineminus">-  if (aListener)</span>
<a href="#l24.1166"></a><span id="l24.1166" class="difflineminus">-    aListener-&gt;OnStartCopy();</span>
<a href="#l24.1167"></a><span id="l24.1167" class="difflineplus">+  if (aListener) aListener-&gt;OnStartCopy();</span>
<a href="#l24.1168"></a><span id="l24.1168"> </span>
<a href="#l24.1169"></a><span id="l24.1169" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; dstHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l24.1170"></a><span id="l24.1170" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; dstHdrs(</span>
<a href="#l24.1171"></a><span id="l24.1171" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l24.1172"></a><span id="l24.1172">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1173"></a><span id="l24.1173">   uint32_t messageCount;</span>
<a href="#l24.1174"></a><span id="l24.1174">   rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l24.1175"></a><span id="l24.1175">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1176"></a><span id="l24.1176"> </span>
<a href="#l24.1177"></a><span id="l24.1177" class="difflineminus">-  for (uint32_t i = 0; i &lt; messageCount; i++)</span>
<a href="#l24.1178"></a><span id="l24.1178" class="difflineminus">-  {</span>
<a href="#l24.1179"></a><span id="l24.1179" class="difflineplus">+  for (uint32_t i = 0; i &lt; messageCount; i++) {</span>
<a href="#l24.1180"></a><span id="l24.1180">     nsCOMPtr&lt;nsIMsgDBHdr&gt; srcHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l24.1181"></a><span id="l24.1181" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.1182"></a><span id="l24.1182" class="difflineminus">-    {</span>
<a href="#l24.1183"></a><span id="l24.1183" class="difflineminus">-      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.1184"></a><span id="l24.1184" class="difflineminus">-             (&quot;srcHdr null\n&quot;));</span>
<a href="#l24.1185"></a><span id="l24.1185" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l24.1186"></a><span id="l24.1186" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info, (&quot;srcHdr null\n&quot;));</span>
<a href="#l24.1187"></a><span id="l24.1187">       continue;</span>
<a href="#l24.1188"></a><span id="l24.1188">     }</span>
<a href="#l24.1189"></a><span id="l24.1189">     nsMsgKey srcKey;</span>
<a href="#l24.1190"></a><span id="l24.1190">     srcHdr-&gt;GetMessageKey(&amp;srcKey);</span>
<a href="#l24.1191"></a><span id="l24.1191">     msgTxn-&gt;AddSrcKey(srcKey);</span>
<a href="#l24.1192"></a><span id="l24.1192">     nsAutoCString fileName;</span>
<a href="#l24.1193"></a><span id="l24.1193">     srcHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l24.1194"></a><span id="l24.1194" class="difflineminus">-    if (fileName.IsEmpty())</span>
<a href="#l24.1195"></a><span id="l24.1195" class="difflineminus">-    {</span>
<a href="#l24.1196"></a><span id="l24.1196" class="difflineplus">+    if (fileName.IsEmpty()) {</span>
<a href="#l24.1197"></a><span id="l24.1197">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l24.1198"></a><span id="l24.1198" class="difflineminus">-             (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l24.1199"></a><span id="l24.1199" class="difflineplus">+              (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l24.1200"></a><span id="l24.1200">       return NS_ERROR_FAILURE;</span>
<a href="#l24.1201"></a><span id="l24.1201">     }</span>
<a href="#l24.1202"></a><span id="l24.1202"> </span>
<a href="#l24.1203"></a><span id="l24.1203">     nsCOMPtr&lt;nsIFile&gt; srcFile;</span>
<a href="#l24.1204"></a><span id="l24.1204">     rv = srcFolderPath-&gt;Clone(getter_AddRefs(srcFile));</span>
<a href="#l24.1205"></a><span id="l24.1205">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1206"></a><span id="l24.1206">     srcFile-&gt;AppendNative(fileName);</span>
<a href="#l24.1207"></a><span id="l24.1207"> </span>
<a href="#l24.1208"></a><span id="l24.1208">     nsCOMPtr&lt;nsIFile&gt; destFile;</span>
<a href="#l24.1209"></a><span id="l24.1209">     destFolderPath-&gt;Clone(getter_AddRefs(destFile));</span>
<a href="#l24.1210"></a><span id="l24.1210">     destFile-&gt;AppendNative(fileName);</span>
<a href="#l24.1211"></a><span id="l24.1211">     bool exists;</span>
<a href="#l24.1212"></a><span id="l24.1212">     destFile-&gt;Exists(&amp;exists);</span>
<a href="#l24.1213"></a><span id="l24.1213" class="difflineminus">-    if (exists)</span>
<a href="#l24.1214"></a><span id="l24.1214" class="difflineminus">-    {</span>
<a href="#l24.1215"></a><span id="l24.1215" class="difflineplus">+    if (exists) {</span>
<a href="#l24.1216"></a><span id="l24.1216">       rv = destFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l24.1217"></a><span id="l24.1217">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1218"></a><span id="l24.1218">       destFile-&gt;GetNativeLeafName(fileName);</span>
<a href="#l24.1219"></a><span id="l24.1219">     }</span>
<a href="#l24.1220"></a><span id="l24.1220">     if (aIsMove)</span>
<a href="#l24.1221"></a><span id="l24.1221">       rv = srcFile-&gt;MoveToNative(destFolderPath, fileName);</span>
<a href="#l24.1222"></a><span id="l24.1222">     else</span>
<a href="#l24.1223"></a><span id="l24.1223">       rv = srcFile-&gt;CopyToNative(destFolderPath, fileName);</span>
<a href="#l24.1224"></a><span id="l24.1224">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1225"></a><span id="l24.1225"> </span>
<a href="#l24.1226"></a><span id="l24.1226">     nsCOMPtr&lt;nsIMsgDBHdr&gt; destHdr;</span>
<a href="#l24.1227"></a><span id="l24.1227" class="difflineminus">-    if (destDB)</span>
<a href="#l24.1228"></a><span id="l24.1228" class="difflineminus">-    {</span>
<a href="#l24.1229"></a><span id="l24.1229" class="difflineminus">-      rv = destDB-&gt;CopyHdrFromExistingHdr(nsMsgKey_None, srcHdr, true, getter_AddRefs(destHdr));</span>
<a href="#l24.1230"></a><span id="l24.1230" class="difflineplus">+    if (destDB) {</span>
<a href="#l24.1231"></a><span id="l24.1231" class="difflineplus">+      rv = destDB-&gt;CopyHdrFromExistingHdr(nsMsgKey_None, srcHdr, true,</span>
<a href="#l24.1232"></a><span id="l24.1232" class="difflineplus">+                                          getter_AddRefs(destHdr));</span>
<a href="#l24.1233"></a><span id="l24.1233">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1234"></a><span id="l24.1234">       destHdr-&gt;SetStringProperty(&quot;storeToken&quot;, fileName.get());</span>
<a href="#l24.1235"></a><span id="l24.1235">       dstHdrs-&gt;AppendElement(destHdr);</span>
<a href="#l24.1236"></a><span id="l24.1236">       nsMsgKey dstKey;</span>
<a href="#l24.1237"></a><span id="l24.1237">       destHdr-&gt;GetMessageKey(&amp;dstKey);</span>
<a href="#l24.1238"></a><span id="l24.1238">       msgTxn-&gt;AddDstKey(dstKey);</span>
<a href="#l24.1239"></a><span id="l24.1239" class="difflineminus">-      if (aListener)</span>
<a href="#l24.1240"></a><span id="l24.1240" class="difflineminus">-        aListener-&gt;SetMessageKey(dstKey);</span>
<a href="#l24.1241"></a><span id="l24.1241" class="difflineplus">+      if (aListener) aListener-&gt;SetMessageKey(dstKey);</span>
<a href="#l24.1242"></a><span id="l24.1242">     }</span>
<a href="#l24.1243"></a><span id="l24.1243">   }</span>
<a href="#l24.1244"></a><span id="l24.1244" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l24.1245"></a><span id="l24.1245" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l24.1246"></a><span id="l24.1246" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l24.1247"></a><span id="l24.1247">   if (notifier)</span>
<a href="#l24.1248"></a><span id="l24.1248">     notifier-&gt;NotifyMsgsMoveCopyCompleted(aIsMove, aHdrArray, aDstFolder,</span>
<a href="#l24.1249"></a><span id="l24.1249">                                           dstHdrs);</span>
<a href="#l24.1250"></a><span id="l24.1250"> </span>
<a href="#l24.1251"></a><span id="l24.1251">   // For now, we only support local dest folders, and for those we are done and</span>
<a href="#l24.1252"></a><span id="l24.1252">   // can delete the messages. Perhaps this should be moved into the folder</span>
<a href="#l24.1253"></a><span id="l24.1253">   // when we try to support other folder types.</span>
<a href="#l24.1254"></a><span id="l24.1254" class="difflineminus">-  if (aIsMove)</span>
<a href="#l24.1255"></a><span id="l24.1255" class="difflineminus">-  {</span>
<a href="#l24.1256"></a><span id="l24.1256" class="difflineminus">-    for (uint32_t i = 0; i &lt; messageCount; ++i)</span>
<a href="#l24.1257"></a><span id="l24.1257" class="difflineminus">-    {</span>
<a href="#l24.1258"></a><span id="l24.1258" class="difflineplus">+  if (aIsMove) {</span>
<a href="#l24.1259"></a><span id="l24.1259" class="difflineplus">+    for (uint32_t i = 0; i &lt; messageCount; ++i) {</span>
<a href="#l24.1260"></a><span id="l24.1260">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryElementAt(aHdrArray, i, &amp;rv));</span>
<a href="#l24.1261"></a><span id="l24.1261">       rv = srcDB-&gt;DeleteHeader(msgDBHdr, nullptr, false, true);</span>
<a href="#l24.1262"></a><span id="l24.1262">     }</span>
<a href="#l24.1263"></a><span id="l24.1263">   }</span>
<a href="#l24.1264"></a><span id="l24.1264"> </span>
<a href="#l24.1265"></a><span id="l24.1265">   *aCopyDone = true;</span>
<a href="#l24.1266"></a><span id="l24.1266">   nsCOMPtr&lt;nsISupports&gt; srcSupports(do_QueryInterface(srcFolder));</span>
<a href="#l24.1267"></a><span id="l24.1267" class="difflineminus">-  if (destLocalFolder)</span>
<a href="#l24.1268"></a><span id="l24.1268" class="difflineminus">-    destLocalFolder-&gt;OnCopyCompleted(srcSupports, true);</span>
<a href="#l24.1269"></a><span id="l24.1269" class="difflineminus">-  if (aListener)</span>
<a href="#l24.1270"></a><span id="l24.1270" class="difflineminus">-    aListener-&gt;OnStopCopy(NS_OK);</span>
<a href="#l24.1271"></a><span id="l24.1271" class="difflineplus">+  if (destLocalFolder) destLocalFolder-&gt;OnCopyCompleted(srcSupports, true);</span>
<a href="#l24.1272"></a><span id="l24.1272" class="difflineplus">+  if (aListener) aListener-&gt;OnStopCopy(NS_OK);</span>
<a href="#l24.1273"></a><span id="l24.1273">   msgTxn.forget(aUndoAction);</span>
<a href="#l24.1274"></a><span id="l24.1274">   dstHdrs.forget(aDstHdrs);</span>
<a href="#l24.1275"></a><span id="l24.1275">   return NS_OK;</span>
<a href="#l24.1276"></a><span id="l24.1276"> }</span>
<a href="#l24.1277"></a><span id="l24.1277"> </span>
<a href="#l24.1278"></a><span id="l24.1278"> NS_IMETHODIMP</span>
<a href="#l24.1279"></a><span id="l24.1279" class="difflineminus">-nsMsgMaildirStore::GetSupportsCompaction(bool *aSupportsCompaction)</span>
<a href="#l24.1280"></a><span id="l24.1280" class="difflineminus">-{</span>
<a href="#l24.1281"></a><span id="l24.1281" class="difflineplus">+nsMsgMaildirStore::GetSupportsCompaction(bool *aSupportsCompaction) {</span>
<a href="#l24.1282"></a><span id="l24.1282">   NS_ENSURE_ARG_POINTER(aSupportsCompaction);</span>
<a href="#l24.1283"></a><span id="l24.1283">   *aSupportsCompaction = false;</span>
<a href="#l24.1284"></a><span id="l24.1284">   return NS_OK;</span>
<a href="#l24.1285"></a><span id="l24.1285"> }</span>
<a href="#l24.1286"></a><span id="l24.1286"> </span>
<a href="#l24.1287"></a><span id="l24.1287"> NS_IMETHODIMP nsMsgMaildirStore::CompactFolder(nsIMsgFolder *aFolder,</span>
<a href="#l24.1288"></a><span id="l24.1288">                                                nsIUrlListener *aListener,</span>
<a href="#l24.1289"></a><span id="l24.1289" class="difflineminus">-                                               nsIMsgWindow *aMsgWindow)</span>
<a href="#l24.1290"></a><span id="l24.1290" class="difflineminus">-{</span>
<a href="#l24.1291"></a><span id="l24.1291" class="difflineplus">+                                               nsIMsgWindow *aMsgWindow) {</span>
<a href="#l24.1292"></a><span id="l24.1292">   return NS_OK;</span>
<a href="#l24.1293"></a><span id="l24.1293"> }</span>
<a href="#l24.1294"></a><span id="l24.1294"> </span>
<a href="#l24.1295"></a><span id="l24.1295" class="difflineminus">-class MaildirStoreParser</span>
<a href="#l24.1296"></a><span id="l24.1296" class="difflineminus">-{</span>
<a href="#l24.1297"></a><span id="l24.1297" class="difflineminus">-public:</span>
<a href="#l24.1298"></a><span id="l24.1298" class="difflineplus">+class MaildirStoreParser {</span>
<a href="#l24.1299"></a><span id="l24.1299" class="difflineplus">+ public:</span>
<a href="#l24.1300"></a><span id="l24.1300">   MaildirStoreParser(nsIMsgFolder *aFolder, nsIMsgDatabase *aMsgDB,</span>
<a href="#l24.1301"></a><span id="l24.1301">                      nsIDirectoryEnumerator *aDirectoryEnumerator,</span>
<a href="#l24.1302"></a><span id="l24.1302">                      nsIUrlListener *aUrlListener);</span>
<a href="#l24.1303"></a><span id="l24.1303">   virtual ~MaildirStoreParser();</span>
<a href="#l24.1304"></a><span id="l24.1304"> </span>
<a href="#l24.1305"></a><span id="l24.1305">   nsresult ParseNextMessage(nsIFile *aFile);</span>
<a href="#l24.1306"></a><span id="l24.1306">   static void TimerCallback(nsITimer *aTimer, void *aClosure);</span>
<a href="#l24.1307"></a><span id="l24.1307">   nsresult StartTimer();</span>
<a href="#l24.1308"></a><span id="l24.1308" class="difflineat">@@ -1253,192 +1154,171 @@ public:</span>
<a href="#l24.1309"></a><span id="l24.1309">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l24.1310"></a><span id="l24.1310">   nsCOMPtr&lt;nsITimer&gt; m_timer;</span>
<a href="#l24.1311"></a><span id="l24.1311">   nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l24.1312"></a><span id="l24.1312"> };</span>
<a href="#l24.1313"></a><span id="l24.1313"> </span>
<a href="#l24.1314"></a><span id="l24.1314"> MaildirStoreParser::MaildirStoreParser(nsIMsgFolder *aFolder,</span>
<a href="#l24.1315"></a><span id="l24.1315">                                        nsIMsgDatabase *aMsgDB,</span>
<a href="#l24.1316"></a><span id="l24.1316">                                        nsIDirectoryEnumerator *aDirEnum,</span>
<a href="#l24.1317"></a><span id="l24.1317" class="difflineminus">-                                       nsIUrlListener *aUrlListener)</span>
<a href="#l24.1318"></a><span id="l24.1318" class="difflineminus">-{</span>
<a href="#l24.1319"></a><span id="l24.1319" class="difflineplus">+                                       nsIUrlListener *aUrlListener) {</span>
<a href="#l24.1320"></a><span id="l24.1320">   m_folder = aFolder;</span>
<a href="#l24.1321"></a><span id="l24.1321">   m_db = aMsgDB;</span>
<a href="#l24.1322"></a><span id="l24.1322">   m_directoryEnumerator = aDirEnum;</span>
<a href="#l24.1323"></a><span id="l24.1323">   m_listener = aUrlListener;</span>
<a href="#l24.1324"></a><span id="l24.1324"> }</span>
<a href="#l24.1325"></a><span id="l24.1325"> </span>
<a href="#l24.1326"></a><span id="l24.1326" class="difflineminus">-MaildirStoreParser::~MaildirStoreParser()</span>
<a href="#l24.1327"></a><span id="l24.1327" class="difflineminus">-{</span>
<a href="#l24.1328"></a><span id="l24.1328" class="difflineminus">-}</span>
<a href="#l24.1329"></a><span id="l24.1329" class="difflineplus">+MaildirStoreParser::~MaildirStoreParser() {}</span>
<a href="#l24.1330"></a><span id="l24.1330"> </span>
<a href="#l24.1331"></a><span id="l24.1331" class="difflineminus">-nsresult MaildirStoreParser::ParseNextMessage(nsIFile *aFile)</span>
<a href="#l24.1332"></a><span id="l24.1332" class="difflineminus">-{</span>
<a href="#l24.1333"></a><span id="l24.1333" class="difflineplus">+nsresult MaildirStoreParser::ParseNextMessage(nsIFile *aFile) {</span>
<a href="#l24.1334"></a><span id="l24.1334">   nsresult rv;</span>
<a href="#l24.1335"></a><span id="l24.1335">   NS_ENSURE_TRUE(m_db, NS_ERROR_NULL_POINTER);</span>
<a href="#l24.1336"></a><span id="l24.1336">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l24.1337"></a><span id="l24.1337">   nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; msgParser =</span>
<a href="#l24.1338"></a><span id="l24.1338" class="difflineminus">-    do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l24.1339"></a><span id="l24.1339" class="difflineplus">+      do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l24.1340"></a><span id="l24.1340">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1341"></a><span id="l24.1341">   msgParser-&gt;SetMailDB(m_db);</span>
<a href="#l24.1342"></a><span id="l24.1342">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l24.1343"></a><span id="l24.1343">   rv = m_db-&gt;CreateNewHdr(nsMsgKey_None, getter_AddRefs(newMsgHdr));</span>
<a href="#l24.1344"></a><span id="l24.1344">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1345"></a><span id="l24.1345"> </span>
<a href="#l24.1346"></a><span id="l24.1346">   newMsgHdr-&gt;SetMessageOffset(0);</span>
<a href="#l24.1347"></a><span id="l24.1347"> </span>
<a href="#l24.1348"></a><span id="l24.1348">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l24.1349"></a><span id="l24.1349" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l24.1350"></a><span id="l24.1350" class="difflineminus">-  {</span>
<a href="#l24.1351"></a><span id="l24.1351" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; inputStream) {</span>
<a href="#l24.1352"></a><span id="l24.1352">     RefPtr&lt;nsMsgLineStreamBuffer&gt; inputStreamBuffer =</span>
<a href="#l24.1353"></a><span id="l24.1353" class="difflineminus">-      new nsMsgLineStreamBuffer(FILE_IO_BUFFER_SIZE, true, false);</span>
<a href="#l24.1354"></a><span id="l24.1354" class="difflineplus">+        new nsMsgLineStreamBuffer(FILE_IO_BUFFER_SIZE, true, false);</span>
<a href="#l24.1355"></a><span id="l24.1355">     int64_t fileSize;</span>
<a href="#l24.1356"></a><span id="l24.1356">     aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l24.1357"></a><span id="l24.1357">     msgParser-&gt;SetNewMsgHdr(newMsgHdr);</span>
<a href="#l24.1358"></a><span id="l24.1358">     msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l24.1359"></a><span id="l24.1359">     msgParser-&gt;SetEnvelopePos(0);</span>
<a href="#l24.1360"></a><span id="l24.1360">     bool needMoreData = false;</span>
<a href="#l24.1361"></a><span id="l24.1361" class="difflineminus">-    char * newLine = nullptr;</span>
<a href="#l24.1362"></a><span id="l24.1362" class="difflineplus">+    char *newLine = nullptr;</span>
<a href="#l24.1363"></a><span id="l24.1363">     uint32_t numBytesInLine = 0;</span>
<a href="#l24.1364"></a><span id="l24.1364">     // we only have to read the headers, because we know the message size</span>
<a href="#l24.1365"></a><span id="l24.1365">     // from the file size. So we can do this in one time slice.</span>
<a href="#l24.1366"></a><span id="l24.1366" class="difflineminus">-    do</span>
<a href="#l24.1367"></a><span id="l24.1367" class="difflineminus">-    {</span>
<a href="#l24.1368"></a><span id="l24.1368" class="difflineplus">+    do {</span>
<a href="#l24.1369"></a><span id="l24.1369">       newLine = inputStreamBuffer-&gt;ReadNextLine(inputStream, numBytesInLine,</span>
<a href="#l24.1370"></a><span id="l24.1370">                                                 needMoreData);</span>
<a href="#l24.1371"></a><span id="l24.1371" class="difflineminus">-      if (newLine)</span>
<a href="#l24.1372"></a><span id="l24.1372" class="difflineminus">-      {</span>
<a href="#l24.1373"></a><span id="l24.1373" class="difflineplus">+      if (newLine) {</span>
<a href="#l24.1374"></a><span id="l24.1374">         msgParser-&gt;ParseAFolderLine(newLine, numBytesInLine);</span>
<a href="#l24.1375"></a><span id="l24.1375">         free(newLine);</span>
<a href="#l24.1376"></a><span id="l24.1376">       }</span>
<a href="#l24.1377"></a><span id="l24.1377">     } while (newLine &amp;&amp; numBytesInLine &gt; 0);</span>
<a href="#l24.1378"></a><span id="l24.1378"> </span>
<a href="#l24.1379"></a><span id="l24.1379">     msgParser-&gt;FinishHeader();</span>
<a href="#l24.1380"></a><span id="l24.1380">     // A single message needs to be less than 4GB</span>
<a href="#l24.1381"></a><span id="l24.1381" class="difflineminus">-    newMsgHdr-&gt;SetMessageSize((uint32_t) fileSize);</span>
<a href="#l24.1382"></a><span id="l24.1382" class="difflineplus">+    newMsgHdr-&gt;SetMessageSize((uint32_t)fileSize);</span>
<a href="#l24.1383"></a><span id="l24.1383">     m_db-&gt;AddNewHdrToDB(newMsgHdr, true);</span>
<a href="#l24.1384"></a><span id="l24.1384">     nsAutoCString storeToken;</span>
<a href="#l24.1385"></a><span id="l24.1385">     aFile-&gt;GetNativeLeafName(storeToken);</span>
<a href="#l24.1386"></a><span id="l24.1386">     newMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken.get());</span>
<a href="#l24.1387"></a><span id="l24.1387">   }</span>
<a href="#l24.1388"></a><span id="l24.1388">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1389"></a><span id="l24.1389">   return rv;</span>
<a href="#l24.1390"></a><span id="l24.1390"> }</span>
<a href="#l24.1391"></a><span id="l24.1391"> </span>
<a href="#l24.1392"></a><span id="l24.1392" class="difflineminus">-void MaildirStoreParser::TimerCallback(nsITimer *aTimer, void *aClosure)</span>
<a href="#l24.1393"></a><span id="l24.1393" class="difflineminus">-{</span>
<a href="#l24.1394"></a><span id="l24.1394" class="difflineminus">-  MaildirStoreParser *parser = (MaildirStoreParser *) aClosure;</span>
<a href="#l24.1395"></a><span id="l24.1395" class="difflineplus">+void MaildirStoreParser::TimerCallback(nsITimer *aTimer, void *aClosure) {</span>
<a href="#l24.1396"></a><span id="l24.1396" class="difflineplus">+  MaildirStoreParser *parser = (MaildirStoreParser *)aClosure;</span>
<a href="#l24.1397"></a><span id="l24.1397">   bool hasMore;</span>
<a href="#l24.1398"></a><span id="l24.1398">   parser-&gt;m_directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l24.1399"></a><span id="l24.1399" class="difflineminus">-  if (!hasMore)</span>
<a href="#l24.1400"></a><span id="l24.1400" class="difflineminus">-  {</span>
<a href="#l24.1401"></a><span id="l24.1401" class="difflineplus">+  if (!hasMore) {</span>
<a href="#l24.1402"></a><span id="l24.1402">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; store;</span>
<a href="#l24.1403"></a><span id="l24.1403">     parser-&gt;m_folder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l24.1404"></a><span id="l24.1404">     parser-&gt;m_timer-&gt;Cancel();</span>
<a href="#l24.1405"></a><span id="l24.1405">     parser-&gt;m_db-&gt;SetSummaryValid(true);</span>
<a href="#l24.1406"></a><span id="l24.1406" class="difflineminus">-//    store-&gt;SetSummaryFileValid(parser-&gt;m_folder, parser-&gt;m_db, true);</span>
<a href="#l24.1407"></a><span id="l24.1407" class="difflineminus">-    if (parser-&gt;m_listener)</span>
<a href="#l24.1408"></a><span id="l24.1408" class="difflineminus">-    {</span>
<a href="#l24.1409"></a><span id="l24.1409" class="difflineplus">+    //    store-&gt;SetSummaryFileValid(parser-&gt;m_folder, parser-&gt;m_db, true);</span>
<a href="#l24.1410"></a><span id="l24.1410" class="difflineplus">+    if (parser-&gt;m_listener) {</span>
<a href="#l24.1411"></a><span id="l24.1411">       nsresult rv;</span>
<a href="#l24.1412"></a><span id="l24.1412">       nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl =</span>
<a href="#l24.1413"></a><span id="l24.1413" class="difflineminus">-        do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l24.1414"></a><span id="l24.1414" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl)</span>
<a href="#l24.1415"></a><span id="l24.1415" class="difflineminus">-      {</span>
<a href="#l24.1416"></a><span id="l24.1416" class="difflineplus">+          do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l24.1417"></a><span id="l24.1417" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl) {</span>
<a href="#l24.1418"></a><span id="l24.1418">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(mailboxurl);</span>
<a href="#l24.1419"></a><span id="l24.1419">         url-&gt;SetUpdatingFolder(true);</span>
<a href="#l24.1420"></a><span id="l24.1420">         nsAutoCString uriSpec(&quot;mailbox://&quot;);</span>
<a href="#l24.1421"></a><span id="l24.1421">         // ### TODO - what if SetSpec fails?</span>
<a href="#l24.1422"></a><span id="l24.1422">         (void)url-&gt;SetSpecInternal(uriSpec);</span>
<a href="#l24.1423"></a><span id="l24.1423">         parser-&gt;m_listener-&gt;OnStopRunningUrl(url, NS_OK);</span>
<a href="#l24.1424"></a><span id="l24.1424">       }</span>
<a href="#l24.1425"></a><span id="l24.1425">     }</span>
<a href="#l24.1426"></a><span id="l24.1426">     // Parsing complete and timer cancelled, so we release the parser object.</span>
<a href="#l24.1427"></a><span id="l24.1427">     delete parser;</span>
<a href="#l24.1428"></a><span id="l24.1428">     return;</span>
<a href="#l24.1429"></a><span id="l24.1429">   }</span>
<a href="#l24.1430"></a><span id="l24.1430">   nsCOMPtr&lt;nsIFile&gt; currentFile;</span>
<a href="#l24.1431"></a><span id="l24.1431" class="difflineminus">-  nsresult rv = parser-&gt;m_directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile));</span>
<a href="#l24.1432"></a><span id="l24.1432" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l24.1433"></a><span id="l24.1433" class="difflineminus">-    rv = parser-&gt;ParseNextMessage(currentFile);</span>
<a href="#l24.1434"></a><span id="l24.1434" class="difflineplus">+  nsresult rv =</span>
<a href="#l24.1435"></a><span id="l24.1435" class="difflineplus">+      parser-&gt;m_directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile));</span>
<a href="#l24.1436"></a><span id="l24.1436" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = parser-&gt;ParseNextMessage(currentFile);</span>
<a href="#l24.1437"></a><span id="l24.1437">   if (NS_FAILED(rv) &amp;&amp; parser-&gt;m_listener)</span>
<a href="#l24.1438"></a><span id="l24.1438">     parser-&gt;m_listener-&gt;OnStopRunningUrl(nullptr, NS_ERROR_FAILURE);</span>
<a href="#l24.1439"></a><span id="l24.1439"> }</span>
<a href="#l24.1440"></a><span id="l24.1440"> </span>
<a href="#l24.1441"></a><span id="l24.1441" class="difflineminus">-nsresult MaildirStoreParser::StartTimer()</span>
<a href="#l24.1442"></a><span id="l24.1442" class="difflineminus">-{</span>
<a href="#l24.1443"></a><span id="l24.1443" class="difflineplus">+nsresult MaildirStoreParser::StartTimer() {</span>
<a href="#l24.1444"></a><span id="l24.1444">   nsresult rv;</span>
<a href="#l24.1445"></a><span id="l24.1445">   m_timer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l24.1446"></a><span id="l24.1446">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1447"></a><span id="l24.1447" class="difflineminus">-  m_timer-&gt;InitWithNamedFuncCallback(TimerCallback, (void *) this, 0,</span>
<a href="#l24.1448"></a><span id="l24.1448" class="difflineplus">+  m_timer-&gt;InitWithNamedFuncCallback(TimerCallback, (void *)this, 0,</span>
<a href="#l24.1449"></a><span id="l24.1449">                                      nsITimer::TYPE_REPEATING_SLACK,</span>
<a href="#l24.1450"></a><span id="l24.1450">                                      &quot;MaildirStoreParser::TimerCallback&quot;);</span>
<a href="#l24.1451"></a><span id="l24.1451">   return NS_OK;</span>
<a href="#l24.1452"></a><span id="l24.1452"> }</span>
<a href="#l24.1453"></a><span id="l24.1453"> </span>
<a href="#l24.1454"></a><span id="l24.1454"> NS_IMETHODIMP nsMsgMaildirStore::RebuildIndex(nsIMsgFolder *aFolder,</span>
<a href="#l24.1455"></a><span id="l24.1455">                                               nsIMsgDatabase *aMsgDB,</span>
<a href="#l24.1456"></a><span id="l24.1456">                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l24.1457"></a><span id="l24.1457" class="difflineminus">-                                              nsIUrlListener *aListener)</span>
<a href="#l24.1458"></a><span id="l24.1458" class="difflineminus">-{</span>
<a href="#l24.1459"></a><span id="l24.1459" class="difflineplus">+                                              nsIUrlListener *aListener) {</span>
<a href="#l24.1460"></a><span id="l24.1460">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l24.1461"></a><span id="l24.1461">   // This code needs to iterate over the maildir files, and parse each</span>
<a href="#l24.1462"></a><span id="l24.1462">   // file and add a msg hdr to the db for the file.</span>
<a href="#l24.1463"></a><span id="l24.1463">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.1464"></a><span id="l24.1464">   nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l24.1465"></a><span id="l24.1465">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1466"></a><span id="l24.1466">   path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.1467"></a><span id="l24.1467"> </span>
<a href="#l24.1468"></a><span id="l24.1468">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l24.1469"></a><span id="l24.1469">   rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l24.1470"></a><span id="l24.1470">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1471"></a><span id="l24.1471"> </span>
<a href="#l24.1472"></a><span id="l24.1472" class="difflineminus">-  MaildirStoreParser *fileParser = new MaildirStoreParser(aFolder, aMsgDB,</span>
<a href="#l24.1473"></a><span id="l24.1473" class="difflineminus">-                                                          directoryEnumerator,</span>
<a href="#l24.1474"></a><span id="l24.1474" class="difflineminus">-                                                          aListener);</span>
<a href="#l24.1475"></a><span id="l24.1475" class="difflineplus">+  MaildirStoreParser *fileParser =</span>
<a href="#l24.1476"></a><span id="l24.1476" class="difflineplus">+      new MaildirStoreParser(aFolder, aMsgDB, directoryEnumerator, aListener);</span>
<a href="#l24.1477"></a><span id="l24.1477">   NS_ENSURE_TRUE(fileParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l24.1478"></a><span id="l24.1478">   fileParser-&gt;StartTimer();</span>
<a href="#l24.1479"></a><span id="l24.1479">   ResetForceReparse(aMsgDB);</span>
<a href="#l24.1480"></a><span id="l24.1480">   return NS_OK;</span>
<a href="#l24.1481"></a><span id="l24.1481"> }</span>
<a href="#l24.1482"></a><span id="l24.1482"> </span>
<a href="#l24.1483"></a><span id="l24.1483"> NS_IMETHODIMP nsMsgMaildirStore::ChangeFlags(nsIArray *aHdrArray,</span>
<a href="#l24.1484"></a><span id="l24.1484" class="difflineminus">-                                             uint32_t aFlags,</span>
<a href="#l24.1485"></a><span id="l24.1485" class="difflineminus">-                                             bool aSet)</span>
<a href="#l24.1486"></a><span id="l24.1486" class="difflineminus">-{</span>
<a href="#l24.1487"></a><span id="l24.1487" class="difflineplus">+                                             uint32_t aFlags, bool aSet) {</span>
<a href="#l24.1488"></a><span id="l24.1488">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l24.1489"></a><span id="l24.1489"> </span>
<a href="#l24.1490"></a><span id="l24.1490">   uint32_t messageCount;</span>
<a href="#l24.1491"></a><span id="l24.1491">   nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l24.1492"></a><span id="l24.1492">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1493"></a><span id="l24.1493"> </span>
<a href="#l24.1494"></a><span id="l24.1494" class="difflineminus">-  for (uint32_t i = 0; i &lt; messageCount; i++)</span>
<a href="#l24.1495"></a><span id="l24.1495" class="difflineminus">-  {</span>
<a href="#l24.1496"></a><span id="l24.1496" class="difflineplus">+  for (uint32_t i = 0; i &lt; messageCount; i++) {</span>
<a href="#l24.1497"></a><span id="l24.1497">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l24.1498"></a><span id="l24.1498">     // get output stream for header</span>
<a href="#l24.1499"></a><span id="l24.1499">     nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l24.1500"></a><span id="l24.1500">     rv = GetOutputStream(msgHdr, outputStream);</span>
<a href="#l24.1501"></a><span id="l24.1501">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1502"></a><span id="l24.1502">     // Seek to x-mozilla-status offset and rewrite value.</span>
<a href="#l24.1503"></a><span id="l24.1503">     rv = UpdateFolderFlag(msgHdr, aSet, aFlags, outputStream);</span>
<a href="#l24.1504"></a><span id="l24.1504" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l24.1505"></a><span id="l24.1505" class="difflineminus">-      NS_WARNING(&quot;updateFolderFlag failed&quot;);</span>
<a href="#l24.1506"></a><span id="l24.1506" class="difflineplus">+    if (NS_FAILED(rv)) NS_WARNING(&quot;updateFolderFlag failed&quot;);</span>
<a href="#l24.1507"></a><span id="l24.1507">   }</span>
<a href="#l24.1508"></a><span id="l24.1508">   return NS_OK;</span>
<a href="#l24.1509"></a><span id="l24.1509"> }</span>
<a href="#l24.1510"></a><span id="l24.1510"> </span>
<a href="#l24.1511"></a><span id="l24.1511"> // get output stream from header</span>
<a href="#l24.1512"></a><span id="l24.1512" class="difflineminus">-nsresult</span>
<a href="#l24.1513"></a><span id="l24.1513" class="difflineminus">-nsMsgMaildirStore::GetOutputStream(nsIMsgDBHdr *aHdr,</span>
<a href="#l24.1514"></a><span id="l24.1514" class="difflineminus">-                                   nsCOMPtr&lt;nsIOutputStream&gt; &amp;aOutputStream)</span>
<a href="#l24.1515"></a><span id="l24.1515" class="difflineminus">-{</span>
<a href="#l24.1516"></a><span id="l24.1516" class="difflineplus">+nsresult nsMsgMaildirStore::GetOutputStream(</span>
<a href="#l24.1517"></a><span id="l24.1517" class="difflineplus">+    nsIMsgDBHdr *aHdr, nsCOMPtr&lt;nsIOutputStream&gt; &amp;aOutputStream) {</span>
<a href="#l24.1518"></a><span id="l24.1518">   // file name is stored in message header property &quot;storeToken&quot;</span>
<a href="#l24.1519"></a><span id="l24.1519">   nsAutoCString fileName;</span>
<a href="#l24.1520"></a><span id="l24.1520">   aHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l24.1521"></a><span id="l24.1521" class="difflineminus">-  if (fileName.IsEmpty())</span>
<a href="#l24.1522"></a><span id="l24.1522" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l24.1523"></a><span id="l24.1523" class="difflineplus">+  if (fileName.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l24.1524"></a><span id="l24.1524"> </span>
<a href="#l24.1525"></a><span id="l24.1525">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l24.1526"></a><span id="l24.1526">   nsresult rv = aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l24.1527"></a><span id="l24.1527">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1528"></a><span id="l24.1528"> </span>
<a href="#l24.1529"></a><span id="l24.1529">   nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l24.1530"></a><span id="l24.1530">   rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l24.1531"></a><span id="l24.1531">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1532"></a><span id="l24.1532" class="difflineat">@@ -1447,98 +1327,91 @@ nsMsgMaildirStore::GetOutputStream(nsIMs</span>
<a href="#l24.1533"></a><span id="l24.1533">   folderPath-&gt;Clone(getter_AddRefs(maildirFile));</span>
<a href="#l24.1534"></a><span id="l24.1534">   maildirFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l24.1535"></a><span id="l24.1535">   maildirFile-&gt;AppendNative(fileName);</span>
<a href="#l24.1536"></a><span id="l24.1536"> </span>
<a href="#l24.1537"></a><span id="l24.1537">   return MsgGetFileStream(maildirFile, getter_AddRefs(aOutputStream));</span>
<a href="#l24.1538"></a><span id="l24.1538"> }</span>
<a href="#l24.1539"></a><span id="l24.1539"> </span>
<a href="#l24.1540"></a><span id="l24.1540"> NS_IMETHODIMP nsMsgMaildirStore::ChangeKeywords(nsIArray *aHdrArray,</span>
<a href="#l24.1541"></a><span id="l24.1541" class="difflineminus">-                                             const nsACString &amp;aKeywords,</span>
<a href="#l24.1542"></a><span id="l24.1542" class="difflineminus">-                                             bool aAdd)</span>
<a href="#l24.1543"></a><span id="l24.1543" class="difflineminus">-{</span>
<a href="#l24.1544"></a><span id="l24.1544" class="difflineplus">+                                                const nsACString &amp;aKeywords,</span>
<a href="#l24.1545"></a><span id="l24.1545" class="difflineplus">+                                                bool aAdd) {</span>
<a href="#l24.1546"></a><span id="l24.1546">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l24.1547"></a><span id="l24.1547">   NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l24.1548"></a><span id="l24.1548">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l24.1549"></a><span id="l24.1549">   nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l24.1550"></a><span id="l24.1550"> </span>
<a href="#l24.1551"></a><span id="l24.1551">   uint32_t messageCount;</span>
<a href="#l24.1552"></a><span id="l24.1552">   nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l24.1553"></a><span id="l24.1553">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1554"></a><span id="l24.1554" class="difflineminus">-  if (!messageCount)</span>
<a href="#l24.1555"></a><span id="l24.1555" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l24.1556"></a><span id="l24.1556" class="difflineplus">+  if (!messageCount) return NS_ERROR_INVALID_ARG;</span>
<a href="#l24.1557"></a><span id="l24.1557"> </span>
<a href="#l24.1558"></a><span id="l24.1558">   nsAutoPtr&lt;nsLineBuffer&lt;char&gt; &gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l24.1559"></a><span id="l24.1559">   NS_ENSURE_TRUE(lineBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l24.1560"></a><span id="l24.1560"> </span>
<a href="#l24.1561"></a><span id="l24.1561">   nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l24.1562"></a><span id="l24.1562">   ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l24.1563"></a><span id="l24.1563"> </span>
<a href="#l24.1564"></a><span id="l24.1564" class="difflineminus">-  for (uint32_t i = 0; i &lt; messageCount; ++i) // for each message</span>
<a href="#l24.1565"></a><span id="l24.1565" class="difflineplus">+  for (uint32_t i = 0; i &lt; messageCount; ++i)  // for each message</span>
<a href="#l24.1566"></a><span id="l24.1566">   {</span>
<a href="#l24.1567"></a><span id="l24.1567">     nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l24.1568"></a><span id="l24.1568">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1569"></a><span id="l24.1569">     // get output stream for header</span>
<a href="#l24.1570"></a><span id="l24.1570">     nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l24.1571"></a><span id="l24.1571">     rv = GetOutputStream(message, outputStream);</span>
<a href="#l24.1572"></a><span id="l24.1572">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1573"></a><span id="l24.1573" class="difflineminus">-    nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream, &amp;rv);</span>
<a href="#l24.1574"></a><span id="l24.1574" class="difflineplus">+    nsCOMPtr&lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream, &amp;rv);</span>
<a href="#l24.1575"></a><span id="l24.1575">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1576"></a><span id="l24.1576" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l24.1577"></a><span id="l24.1577" class="difflineplus">+    nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(</span>
<a href="#l24.1578"></a><span id="l24.1578" class="difflineplus">+        do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l24.1579"></a><span id="l24.1579">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1580"></a><span id="l24.1580">     uint32_t statusOffset = 0;</span>
<a href="#l24.1581"></a><span id="l24.1581">     (void)message-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l24.1582"></a><span id="l24.1582">     uint64_t desiredOffset = statusOffset;</span>
<a href="#l24.1583"></a><span id="l24.1583"> </span>
<a href="#l24.1584"></a><span id="l24.1584" class="difflineminus">-    ChangeKeywordsHelper(message, desiredOffset, lineBuffer, keywordArray,</span>
<a href="#l24.1585"></a><span id="l24.1585" class="difflineminus">-                         aAdd, outputStream, seekableStream, inputStream);</span>
<a href="#l24.1586"></a><span id="l24.1586" class="difflineminus">-    if (inputStream)</span>
<a href="#l24.1587"></a><span id="l24.1587" class="difflineminus">-      inputStream-&gt;Close();</span>
<a href="#l24.1588"></a><span id="l24.1588" class="difflineplus">+    ChangeKeywordsHelper(message, desiredOffset, lineBuffer, keywordArray, aAdd,</span>
<a href="#l24.1589"></a><span id="l24.1589" class="difflineplus">+                         outputStream, seekableStream, inputStream);</span>
<a href="#l24.1590"></a><span id="l24.1590" class="difflineplus">+    if (inputStream) inputStream-&gt;Close();</span>
<a href="#l24.1591"></a><span id="l24.1591">     // ### TODO - if growKeywords property is set on the message header,</span>
<a href="#l24.1592"></a><span id="l24.1592">     // we need to rewrite the message file with extra room for the keywords,</span>
<a href="#l24.1593"></a><span id="l24.1593">     // or schedule some sort of background task to do this.</span>
<a href="#l24.1594"></a><span id="l24.1594">   }</span>
<a href="#l24.1595"></a><span id="l24.1595">   lineBuffer = nullptr;</span>
<a href="#l24.1596"></a><span id="l24.1596">   return NS_OK;</span>
<a href="#l24.1597"></a><span id="l24.1597"> }</span>
<a href="#l24.1598"></a><span id="l24.1598"> </span>
<a href="#l24.1599"></a><span id="l24.1599" class="difflineminus">-NS_IMETHODIMP nsMsgMaildirStore::GetStoreType(nsACString&amp; aType)</span>
<a href="#l24.1600"></a><span id="l24.1600" class="difflineminus">-{</span>
<a href="#l24.1601"></a><span id="l24.1601" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::GetStoreType(nsACString &amp;aType) {</span>
<a href="#l24.1602"></a><span id="l24.1602">   aType.AssignLiteral(&quot;maildir&quot;);</span>
<a href="#l24.1603"></a><span id="l24.1603">   return NS_OK;</span>
<a href="#l24.1604"></a><span id="l24.1604"> }</span>
<a href="#l24.1605"></a><span id="l24.1605"> </span>
<a href="#l24.1606"></a><span id="l24.1606"> /**</span>
<a href="#l24.1607"></a><span id="l24.1607">  * Finds the directory associated with this folder. That is if the path is</span>
<a href="#l24.1608"></a><span id="l24.1608">  * c:\Inbox, it will return c:\Inbox.sbd if it succeeds. Path is strictly</span>
<a href="#l24.1609"></a><span id="l24.1609">  * an out parameter.</span>
<a href="#l24.1610"></a><span id="l24.1610">  */</span>
<a href="#l24.1611"></a><span id="l24.1611" class="difflineminus">-nsresult nsMsgMaildirStore::GetDirectoryForFolder(nsIFile *path)</span>
<a href="#l24.1612"></a><span id="l24.1612" class="difflineminus">-{</span>
<a href="#l24.1613"></a><span id="l24.1613" class="difflineplus">+nsresult nsMsgMaildirStore::GetDirectoryForFolder(nsIFile *path) {</span>
<a href="#l24.1614"></a><span id="l24.1614">   // add directory separator to the path</span>
<a href="#l24.1615"></a><span id="l24.1615">   nsAutoString leafName;</span>
<a href="#l24.1616"></a><span id="l24.1616">   path-&gt;GetLeafName(leafName);</span>
<a href="#l24.1617"></a><span id="l24.1617">   leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l24.1618"></a><span id="l24.1618">   return path-&gt;SetLeafName(leafName);</span>
<a href="#l24.1619"></a><span id="l24.1619"> }</span>
<a href="#l24.1620"></a><span id="l24.1620"> </span>
<a href="#l24.1621"></a><span id="l24.1621"> nsresult nsMsgMaildirStore::CreateDirectoryForFolder(nsIFile *path,</span>
<a href="#l24.1622"></a><span id="l24.1622" class="difflineminus">-                                                     bool aIsServer)</span>
<a href="#l24.1623"></a><span id="l24.1623" class="difflineminus">-{</span>
<a href="#l24.1624"></a><span id="l24.1624" class="difflineplus">+                                                     bool aIsServer) {</span>
<a href="#l24.1625"></a><span id="l24.1625">   nsresult rv = NS_OK;</span>
<a href="#l24.1626"></a><span id="l24.1626" class="difflineminus">-  if (!aIsServer)</span>
<a href="#l24.1627"></a><span id="l24.1627" class="difflineminus">-  {</span>
<a href="#l24.1628"></a><span id="l24.1628" class="difflineplus">+  if (!aIsServer) {</span>
<a href="#l24.1629"></a><span id="l24.1629">     rv = GetDirectoryForFolder(path);</span>
<a href="#l24.1630"></a><span id="l24.1630">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.1631"></a><span id="l24.1631">   }</span>
<a href="#l24.1632"></a><span id="l24.1632">   bool pathIsDirectory = false;</span>
<a href="#l24.1633"></a><span id="l24.1633">   path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l24.1634"></a><span id="l24.1634" class="difflineminus">-  if (!pathIsDirectory)</span>
<a href="#l24.1635"></a><span id="l24.1635" class="difflineminus">-  {</span>
<a href="#l24.1636"></a><span id="l24.1636" class="difflineplus">+  if (!pathIsDirectory) {</span>
<a href="#l24.1637"></a><span id="l24.1637">     bool pathExists;</span>
<a href="#l24.1638"></a><span id="l24.1638">     path-&gt;Exists(&amp;pathExists);</span>
<a href="#l24.1639"></a><span id="l24.1639" class="difflineminus">-    //If for some reason there's a file with the directory separator</span>
<a href="#l24.1640"></a><span id="l24.1640" class="difflineminus">-    //then we are going to fail.</span>
<a href="#l24.1641"></a><span id="l24.1641" class="difflineminus">-    rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY :</span>
<a href="#l24.1642"></a><span id="l24.1642" class="difflineminus">-         path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l24.1643"></a><span id="l24.1643" class="difflineplus">+    // If for some reason there's a file with the directory separator</span>
<a href="#l24.1644"></a><span id="l24.1644" class="difflineplus">+    // then we are going to fail.</span>
<a href="#l24.1645"></a><span id="l24.1645" class="difflineplus">+    rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY</span>
<a href="#l24.1646"></a><span id="l24.1646" class="difflineplus">+                    : path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l24.1647"></a><span id="l24.1647">   }</span>
<a href="#l24.1648"></a><span id="l24.1648">   return rv;</span>
<a href="#l24.1649"></a><span id="l24.1649"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -10,30 +10,29 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #ifndef nsMsgMaildirStore_h__</span>
<a href="#l25.5"></a><span id="l25.5"> #define nsMsgMaildirStore_h__</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsMsgLocalStoreUtils.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-class nsMsgMaildirStore final : public nsMsgLocalStoreUtils, nsIMsgPluggableStore</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-{</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-public:</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+class nsMsgMaildirStore final : public nsMsgLocalStoreUtils,</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+                                nsIMsgPluggableStore {</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+ public:</span>
<a href="#l25.18"></a><span id="l25.18">   NS_DECL_ISUPPORTS</span>
<a href="#l25.19"></a><span id="l25.19">   NS_DECL_NSIMSGPLUGGABLESTORE</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">   nsMsgMaildirStore();</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-private:</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+ private:</span>
<a href="#l25.25"></a><span id="l25.25">   ~nsMsgMaildirStore();</span>
<a href="#l25.26"></a><span id="l25.26"> </span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-protected:</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+ protected:</span>
<a href="#l25.29"></a><span id="l25.29">   nsresult GetDirectoryForFolder(nsIFile *path);</span>
<a href="#l25.30"></a><span id="l25.30">   nsresult CreateDirectoryForFolder(nsIFile *path, bool aIsServer);</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32">   nsresult CreateMaildir(nsIFile *path);</span>
<a href="#l25.33"></a><span id="l25.33">   nsresult AddSubFolders(nsIMsgFolder *parent, nsIFile *path, bool deep);</span>
<a href="#l25.34"></a><span id="l25.34">   nsresult GetOutputStream(nsIMsgDBHdr *aHdr,</span>
<a href="#l25.35"></a><span id="l25.35">                            nsCOMPtr&lt;nsIOutputStream&gt; &amp;aOutputStream);</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-</span>
<a href="#l25.37"></a><span id="l25.37"> };</span>
<a href="#l25.38"></a><span id="l25.38"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/src/nsNoIncomingServer.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/src/nsNoIncomingServer.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,106 +1,98 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l26.5"></a><span id="l26.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.6"></a><span id="l26.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.7"></a><span id="l26.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-#include &quot;msgCore.h&quot; // pre-compiled headers</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // pre-compiled headers</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12"> #include &quot;prmem.h&quot;</span>
<a href="#l26.13"></a><span id="l26.13"> #include &quot;plstr.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;prprf.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15"> #include &quot;nsNoIncomingServer.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l26.20"></a><span id="l26.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l26.21"></a><span id="l26.21"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l26.22"></a><span id="l26.22"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l26.23"></a><span id="l26.23"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsNoIncomingServer,</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-                            nsMsgIncomingServer,</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-                            nsINoIncomingServer,</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-                            nsILocalMailIncomingServer)</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsNoIncomingServer, nsMsgIncomingServer,</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+                            nsINoIncomingServer, nsILocalMailIncomingServer)</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-nsNoIncomingServer::nsNoIncomingServer()</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-{</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-}</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+nsNoIncomingServer::nsNoIncomingServer() {}</span>
<a href="#l26.36"></a><span id="l26.36"> </span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-nsNoIncomingServer::~nsNoIncomingServer()</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-{</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-}</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+nsNoIncomingServer::~nsNoIncomingServer() {}</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42"> NS_IMETHODIMP</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-nsNoIncomingServer::GetLocalStoreType(nsACString&amp; type)</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-{</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+nsNoIncomingServer::GetLocalStoreType(nsACString &amp;type) {</span>
<a href="#l26.46"></a><span id="l26.46">   type.AssignLiteral(&quot;mailbox&quot;);</span>
<a href="#l26.47"></a><span id="l26.47">   return NS_OK;</span>
<a href="#l26.48"></a><span id="l26.48"> }</span>
<a href="#l26.49"></a><span id="l26.49"> </span>
<a href="#l26.50"></a><span id="l26.50"> NS_IMETHODIMP</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-nsNoIncomingServer::GetLocalDatabaseType(nsACString&amp; type)</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-{</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+nsNoIncomingServer::GetLocalDatabaseType(nsACString &amp;type) {</span>
<a href="#l26.54"></a><span id="l26.54">   type.AssignLiteral(&quot;mailbox&quot;);</span>
<a href="#l26.55"></a><span id="l26.55">   return NS_OK;</span>
<a href="#l26.56"></a><span id="l26.56"> }</span>
<a href="#l26.57"></a><span id="l26.57"> </span>
<a href="#l26.58"></a><span id="l26.58"> NS_IMETHODIMP</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-nsNoIncomingServer::GetAccountManagerChrome(nsAString&amp; aResult)</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-{</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+nsNoIncomingServer::GetAccountManagerChrome(nsAString &amp;aResult) {</span>
<a href="#l26.62"></a><span id="l26.62">   aResult.AssignLiteral(&quot;am-serverwithnoidentities.xul&quot;);</span>
<a href="#l26.63"></a><span id="l26.63">   return NS_OK;</span>
<a href="#l26.64"></a><span id="l26.64"> }</span>
<a href="#l26.65"></a><span id="l26.65"> </span>
<a href="#l26.66"></a><span id="l26.66"> NS_IMETHODIMP</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-nsNoIncomingServer::SetFlagsOnDefaultMailboxes()</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-{</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+nsNoIncomingServer::SetFlagsOnDefaultMailboxes() {</span>
<a href="#l26.70"></a><span id="l26.70">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l26.71"></a><span id="l26.71">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l26.72"></a><span id="l26.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.73"></a><span id="l26.73"> </span>
<a href="#l26.74"></a><span id="l26.74">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l26.75"></a><span id="l26.75">       do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l26.76"></a><span id="l26.76">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.77"></a><span id="l26.77"> </span>
<a href="#l26.78"></a><span id="l26.78">   // None server may have an inbox if it's deferred to,</span>
<a href="#l26.79"></a><span id="l26.79">   // or if it's the smart mailboxes account.</span>
<a href="#l26.80"></a><span id="l26.80">   localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::SpecialUse);</span>
<a href="#l26.81"></a><span id="l26.81"> </span>
<a href="#l26.82"></a><span id="l26.82">   return NS_OK;</span>
<a href="#l26.83"></a><span id="l26.83"> }</span>
<a href="#l26.84"></a><span id="l26.84"> </span>
<a href="#l26.85"></a><span id="l26.85"> // TODO: make this work with maildir message store, bug 890742.</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-NS_IMETHODIMP nsNoIncomingServer::CopyDefaultMessages(const char *folderNameOnDisk)</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-{</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+NS_IMETHODIMP nsNoIncomingServer::CopyDefaultMessages(</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+    const char *folderNameOnDisk) {</span>
<a href="#l26.90"></a><span id="l26.90">   NS_ENSURE_ARG(folderNameOnDisk);</span>
<a href="#l26.91"></a><span id="l26.91"> </span>
<a href="#l26.92"></a><span id="l26.92">   nsresult rv;</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l26.96"></a><span id="l26.96">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.97"></a><span id="l26.97"> </span>
<a href="#l26.98"></a><span id="l26.98" class="difflineminus">-  // Get defaults directory for messenger files. MailSession service appends 'messenger' to the</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineminus">-  // the app defaults folder and returns it. Locale will be added to the path, if there is one.</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+  // Get defaults directory for messenger files. MailSession service appends</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+  // 'messenger' to the the app defaults folder and returns it. Locale will be</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+  // added to the path, if there is one.</span>
<a href="#l26.103"></a><span id="l26.103">   nsCOMPtr&lt;nsIFile&gt; defaultMessagesFile;</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-  rv = mailSession-&gt;GetDataFilesDir(&quot;messenger&quot;, getter_AddRefs(defaultMessagesFile));</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+  rv = mailSession-&gt;GetDataFilesDir(&quot;messenger&quot;,</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+                                    getter_AddRefs(defaultMessagesFile));</span>
<a href="#l26.107"></a><span id="l26.107">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.108"></a><span id="l26.108"> </span>
<a href="#l26.109"></a><span id="l26.109">   // check if bin/defaults/messenger/&lt;folderNameOnDisk&gt;</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-  // (or bin/defaults/messenger/&lt;locale&gt;/&lt;folderNameOnDisk&gt; if we had a locale provide) exists.</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineminus">-  // it doesn't have to exist.  if it doesn't, return</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+  // (or bin/defaults/messenger/&lt;locale&gt;/&lt;folderNameOnDisk&gt; if we had a locale</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+  // provide) exists. it doesn't have to exist.  if it doesn't, return</span>
<a href="#l26.114"></a><span id="l26.114">   rv = defaultMessagesFile-&gt;AppendNative(nsDependentCString(folderNameOnDisk));</span>
<a href="#l26.115"></a><span id="l26.115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.116"></a><span id="l26.116"> </span>
<a href="#l26.117"></a><span id="l26.117">   bool exists;</span>
<a href="#l26.118"></a><span id="l26.118">   rv = defaultMessagesFile-&gt;Exists(&amp;exists);</span>
<a href="#l26.119"></a><span id="l26.119">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineminus">-  if (!exists)</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineminus">-    return NS_OK;</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+  if (!exists) return NS_OK;</span>
<a href="#l26.123"></a><span id="l26.123"> </span>
<a href="#l26.124"></a><span id="l26.124">   nsCOMPtr&lt;nsIFile&gt; parentDir;</span>
<a href="#l26.125"></a><span id="l26.125">   rv = GetLocalPath(getter_AddRefs(parentDir));</span>
<a href="#l26.126"></a><span id="l26.126">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.127"></a><span id="l26.127"> </span>
<a href="#l26.128"></a><span id="l26.128">   // check if parentDir/&lt;folderNameOnDisk&gt; exists</span>
<a href="#l26.129"></a><span id="l26.129">   {</span>
<a href="#l26.130"></a><span id="l26.130">     nsCOMPtr&lt;nsIFile&gt; testDir;</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineat">@@ -110,96 +102,88 @@ NS_IMETHODIMP nsNoIncomingServer::CopyDe</span>
<a href="#l26.132"></a><span id="l26.132">     rv = testDir-&gt;AppendNative(nsDependentCString(folderNameOnDisk));</span>
<a href="#l26.133"></a><span id="l26.133">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.134"></a><span id="l26.134"> </span>
<a href="#l26.135"></a><span id="l26.135">     rv = testDir-&gt;Exists(&amp;exists);</span>
<a href="#l26.136"></a><span id="l26.136">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.137"></a><span id="l26.137">   }</span>
<a href="#l26.138"></a><span id="l26.138"> </span>
<a href="#l26.139"></a><span id="l26.139">   // if it exists add to the end, else copy</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineminus">-  if (exists)</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-  {</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineplus">+  if (exists) {</span>
<a href="#l26.143"></a><span id="l26.143"> #ifdef DEBUG</span>
<a href="#l26.144"></a><span id="l26.144">     printf(&quot;append default %s (unimplemented)\n&quot;, folderNameOnDisk);</span>
<a href="#l26.145"></a><span id="l26.145"> #endif</span>
<a href="#l26.146"></a><span id="l26.146">     // todo for bug #1181 (the bug ID seems wrong...)</span>
<a href="#l26.147"></a><span id="l26.147">     // open folderFile, seek to end</span>
<a href="#l26.148"></a><span id="l26.148">     // read defaultMessagesFile, write to folderFile</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineminus">-  }</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineminus">-  else {</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+  } else {</span>
<a href="#l26.152"></a><span id="l26.152"> #ifdef DEBUG</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineminus">-    printf(&quot;copy default %s\n&quot;,folderNameOnDisk);</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+    printf(&quot;copy default %s\n&quot;, folderNameOnDisk);</span>
<a href="#l26.155"></a><span id="l26.155"> #endif</span>
<a href="#l26.156"></a><span id="l26.156">     rv = defaultMessagesFile-&gt;CopyTo(parentDir, EmptyString());</span>
<a href="#l26.157"></a><span id="l26.157">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.158"></a><span id="l26.158">   }</span>
<a href="#l26.159"></a><span id="l26.159">   return NS_OK;</span>
<a href="#l26.160"></a><span id="l26.160"> }</span>
<a href="#l26.161"></a><span id="l26.161"> </span>
<a href="#l26.162"></a><span id="l26.162" class="difflineminus">-</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-NS_IMETHODIMP nsNoIncomingServer::CreateDefaultMailboxes()</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineminus">-{</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+NS_IMETHODIMP nsNoIncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l26.166"></a><span id="l26.166">   nsresult rv;</span>
<a href="#l26.167"></a><span id="l26.167">   bool isHidden = false;</span>
<a href="#l26.168"></a><span id="l26.168">   GetHidden(&amp;isHidden);</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineminus">-  if (isHidden)</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineminus">-    return NS_OK;</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineplus">+  if (isHidden) return NS_OK;</span>
<a href="#l26.172"></a><span id="l26.172"> </span>
<a href="#l26.173"></a><span id="l26.173">   // notice, no Inbox, unless we're deferred to...</span>
<a href="#l26.174"></a><span id="l26.174">   bool isDeferredTo;</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineminus">-  if (NS_SUCCEEDED(GetIsDeferredTo(&amp;isDeferredTo)) &amp;&amp; isDeferredTo)</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineminus">-  {</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+  if (NS_SUCCEEDED(GetIsDeferredTo(&amp;isDeferredTo)) &amp;&amp; isDeferredTo) {</span>
<a href="#l26.178"></a><span id="l26.178">     rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l26.179"></a><span id="l26.179">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.180"></a><span id="l26.180">   }</span>
<a href="#l26.181"></a><span id="l26.181"> </span>
<a href="#l26.182"></a><span id="l26.182">   rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l26.183"></a><span id="l26.183">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.184"></a><span id="l26.184"> </span>
<a href="#l26.185"></a><span id="l26.185">   // copy the default templates into the Templates folder</span>
<a href="#l26.186"></a><span id="l26.186">   rv = CopyDefaultMessages(&quot;Templates&quot;);</span>
<a href="#l26.187"></a><span id="l26.187">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.188"></a><span id="l26.188"> </span>
<a href="#l26.189"></a><span id="l26.189">   return CreateLocalFolder(NS_LITERAL_STRING(&quot;Unsent Messages&quot;));</span>
<a href="#l26.190"></a><span id="l26.190"> }</span>
<a href="#l26.191"></a><span id="l26.191"> </span>
<a href="#l26.192"></a><span id="l26.192"> NS_IMETHODIMP</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineminus">-nsNoIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIMsgFolder *aInbox, nsIURI **aResult)</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineminus">-{</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineplus">+nsNoIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+                               nsIUrlListener *aUrlListener,</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+                               nsIMsgFolder *aInbox, nsIURI **aResult) {</span>
<a href="#l26.198"></a><span id="l26.198">   nsCOMArray&lt;nsIPop3IncomingServer&gt; deferredServers;</span>
<a href="#l26.199"></a><span id="l26.199">   nsresult rv = GetDeferredServers(this, deferredServers);</span>
<a href="#l26.200"></a><span id="l26.200">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineminus">-  if (!deferredServers.IsEmpty())</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineminus">-  {</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-    rv = deferredServers[0]-&gt;DownloadMailFromServers(deferredServers.Elements(),</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineminus">-       deferredServers.Length(), aMsgWindow, aInbox, aUrlListener);</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineplus">+  if (!deferredServers.IsEmpty()) {</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineplus">+    rv = deferredServers[0]-&gt;DownloadMailFromServers(</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineplus">+        deferredServers.Elements(), deferredServers.Length(), aMsgWindow,</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineplus">+        aInbox, aUrlListener);</span>
<a href="#l26.209"></a><span id="l26.209">   }</span>
<a href="#l26.210"></a><span id="l26.210">   // listener might be counting on us to send a notification.</span>
<a href="#l26.211"></a><span id="l26.211">   else if (aUrlListener)</span>
<a href="#l26.212"></a><span id="l26.212">     aUrlListener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l26.213"></a><span id="l26.213">   return rv;</span>
<a href="#l26.214"></a><span id="l26.214"> }</span>
<a href="#l26.215"></a><span id="l26.215"> </span>
<a href="#l26.216"></a><span id="l26.216" class="difflineminus">-</span>
<a href="#l26.217"></a><span id="l26.217"> NS_IMETHODIMP</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineminus">-nsNoIncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineminus">-{</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineplus">+nsNoIncomingServer::GetCanSearchMessages(bool *canSearchMessages) {</span>
<a href="#l26.221"></a><span id="l26.221">   NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l26.222"></a><span id="l26.222">   *canSearchMessages = true;</span>
<a href="#l26.223"></a><span id="l26.223">   return NS_OK;</span>
<a href="#l26.224"></a><span id="l26.224"> }</span>
<a href="#l26.225"></a><span id="l26.225"> </span>
<a href="#l26.226"></a><span id="l26.226"> NS_IMETHODIMP</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-nsNoIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineminus">-{</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineplus">+nsNoIncomingServer::GetServerRequiresPasswordForBiff(</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineplus">+    bool *aServerRequiresPasswordForBiff) {</span>
<a href="#l26.231"></a><span id="l26.231">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineminus">-  *aServerRequiresPasswordForBiff = false;  // for local folders, we don't require a password</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineplus">+  *aServerRequiresPasswordForBiff =</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineplus">+      false;  // for local folders, we don't require a password</span>
<a href="#l26.235"></a><span id="l26.235">   return NS_OK;</span>
<a href="#l26.236"></a><span id="l26.236"> }</span>
<a href="#l26.237"></a><span id="l26.237"> </span>
<a href="#l26.238"></a><span id="l26.238"> NS_IMETHODIMP</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineminus">-nsNoIncomingServer::GetSortOrder(int32_t* aSortOrder)</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-{</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineplus">+nsNoIncomingServer::GetSortOrder(int32_t *aSortOrder) {</span>
<a href="#l26.242"></a><span id="l26.242">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l26.243"></a><span id="l26.243">   *aSortOrder = 200000000;</span>
<a href="#l26.244"></a><span id="l26.244">   return NS_OK;</span>
<a href="#l26.245"></a><span id="l26.245"> }</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/src/nsNoIncomingServer.h</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/src/nsNoIncomingServer.h</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -14,28 +14,28 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #include &quot;nsMailboxServer.h&quot;</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> /* get some implementation from nsMsgIncomingServer */</span>
<a href="#l27.7"></a><span id="l27.7"> class nsNoIncomingServer : public nsMailboxServer,</span>
<a href="#l27.8"></a><span id="l27.8">                            public nsINoIncomingServer,</span>
<a href="#l27.9"></a><span id="l27.9">                            public nsILocalMailIncomingServer</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> {</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-public:</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+ public:</span>
<a href="#l27.14"></a><span id="l27.14">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l27.15"></a><span id="l27.15">   NS_DECL_NSINOINCOMINGSERVER</span>
<a href="#l27.16"></a><span id="l27.16">   NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18">   nsNoIncomingServer();</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   NS_IMETHOD GetLocalStoreType(nsACString&amp; type) override;</span>
<a href="#l27.21"></a><span id="l27.21">   NS_IMETHOD GetLocalDatabaseType(nsACString&amp; type) override;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-  NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-  NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+  NS_IMETHOD GetCanSearchMessages(bool* canSearchMessages) override;</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+  NS_IMETHOD GetServerRequiresPasswordForBiff(</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+      bool* aServerRequiresPasswordForBiff) override;</span>
<a href="#l27.27"></a><span id="l27.27">   NS_IMETHOD GetAccountManagerChrome(nsAString&amp; aResult) override;</span>
<a href="#l27.28"></a><span id="l27.28">   NS_IMETHOD GetSortOrder(int32_t* aSortOrder) override;</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-private:</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+ private:</span>
<a href="#l27.32"></a><span id="l27.32">   virtual ~nsNoIncomingServer();</span>
<a href="#l27.33"></a><span id="l27.33"> };</span>
<a href="#l27.34"></a><span id="l27.34"> </span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-</span>
<a href="#l27.36"></a><span id="l27.36"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/src/nsNoneService.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/src/nsNoneService.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,165 +1,149 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l28.5"></a><span id="l28.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12"> #include &quot;nsNoneService.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13"> #include &quot;nsINoIncomingServer.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsINoneService.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19"> #include &quot;nsIFile.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">-#define PREF_MAIL_ROOT_NONE &quot;mail.root.none&quot;        // old - for backward compatibility only</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+#define PREF_MAIL_ROOT_NONE \</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+  &quot;mail.root.none&quot;  // old - for backward compatibility only</span>
<a href="#l28.28"></a><span id="l28.28"> #define PREF_MAIL_ROOT_NONE_REL &quot;mail.root.none-rel&quot;</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-nsNoneService::nsNoneService()</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-{</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">-}</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+nsNoneService::nsNoneService() {}</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-nsNoneService::~nsNoneService()</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-{}</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+nsNoneService::~nsNoneService() {}</span>
<a href="#l28.38"></a><span id="l28.38"> </span>
<a href="#l28.39"></a><span id="l28.39"> NS_IMPL_ISUPPORTS(nsNoneService, nsINoneService, nsIMsgProtocolInfo)</span>
<a href="#l28.40"></a><span id="l28.40"> </span>
<a href="#l28.41"></a><span id="l28.41"> NS_IMETHODIMP</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-nsNoneService::SetDefaultLocalPath(nsIFile *aPath)</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-{</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-    NS_ENSURE_ARG(aPath);</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-    return NS_SetPersistentFile(PREF_MAIL_ROOT_NONE_REL, PREF_MAIL_ROOT_NONE, aPath);</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+nsNoneService::SetDefaultLocalPath(nsIFile *aPath) {</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+  NS_ENSURE_ARG(aPath);</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+  return NS_SetPersistentFile(PREF_MAIL_ROOT_NONE_REL, PREF_MAIL_ROOT_NONE,</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+                              aPath);</span>
<a href="#l28.50"></a><span id="l28.50"> }</span>
<a href="#l28.51"></a><span id="l28.51"> </span>
<a href="#l28.52"></a><span id="l28.52"> NS_IMETHODIMP</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-nsNoneService::GetDefaultLocalPath(nsIFile ** aResult)</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-{</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-    *aResult = nullptr;</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+nsNoneService::GetDefaultLocalPath(nsIFile **aResult) {</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+  *aResult = nullptr;</span>
<a href="#l28.60"></a><span id="l28.60"> </span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-    bool havePref;</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-    nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_NONE_REL,</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-                              PREF_MAIL_ROOT_NONE,</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-                              NS_APP_MAIL_50_DIR,</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-                              havePref,</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-                              getter_AddRefs(localFile));</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+  bool havePref;</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+  nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_NONE_REL,</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+                                     PREF_MAIL_ROOT_NONE, NS_APP_MAIL_50_DIR,</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+                                     havePref, getter_AddRefs(localFile));</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.75"></a><span id="l28.75"> </span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-    bool exists;</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-    rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-        rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+  bool exists;</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+  rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+    rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l28.86"></a><span id="l28.86"> </span>
<a href="#l28.87"></a><span id="l28.87" class="difflineminus">-    if (!havePref || !exists)</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineminus">-    {</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineminus">-        rv = NS_SetPersistentFile(PREF_MAIL_ROOT_NONE_REL, PREF_MAIL_ROOT_NONE, localFile);</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-    }</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+  if (!havePref || !exists) {</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_NONE_REL, PREF_MAIL_ROOT_NONE,</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+                              localFile);</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+  }</span>
<a href="#l28.97"></a><span id="l28.97"> </span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-    localFile.forget(aResult);</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineplus">+  localFile.forget(aResult);</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.102"></a><span id="l28.102"> }</span>
<a href="#l28.103"></a><span id="l28.103"> </span>
<a href="#l28.104"></a><span id="l28.104"> NS_IMETHODIMP</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineminus">-nsNoneService::GetServerIID(nsIID* *aServerIID)</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineminus">-{</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineminus">-    *aServerIID = new nsIID(NS_GET_IID(nsINoIncomingServer));</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+nsNoneService::GetServerIID(nsIID **aServerIID) {</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+  *aServerIID = new nsIID(NS_GET_IID(nsINoIncomingServer));</span>
<a href="#l28.111"></a><span id="l28.111" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.112"></a><span id="l28.112"> }</span>
<a href="#l28.113"></a><span id="l28.113"> </span>
<a href="#l28.114"></a><span id="l28.114"> NS_IMETHODIMP</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineminus">-nsNoneService::GetRequiresUsername(bool *aRequiresUsername)</span>
<a href="#l28.116"></a><span id="l28.116" class="difflineminus">-{</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineplus">+nsNoneService::GetRequiresUsername(bool *aRequiresUsername) {</span>
<a href="#l28.118"></a><span id="l28.118">   NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l28.119"></a><span id="l28.119">   *aRequiresUsername = true;</span>
<a href="#l28.120"></a><span id="l28.120">   return NS_OK;</span>
<a href="#l28.121"></a><span id="l28.121"> }</span>
<a href="#l28.122"></a><span id="l28.122"> </span>
<a href="#l28.123"></a><span id="l28.123"> NS_IMETHODIMP</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-nsNoneService::GetPreflightPrettyNameWithEmailAddress(bool *aPreflightPrettyNameWithEmailAddress)</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineminus">-{</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+nsNoneService::GetPreflightPrettyNameWithEmailAddress(</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+    bool *aPreflightPrettyNameWithEmailAddress) {</span>
<a href="#l28.128"></a><span id="l28.128">   NS_ENSURE_ARG_POINTER(aPreflightPrettyNameWithEmailAddress);</span>
<a href="#l28.129"></a><span id="l28.129">   *aPreflightPrettyNameWithEmailAddress = true;</span>
<a href="#l28.130"></a><span id="l28.130">   return NS_OK;</span>
<a href="#l28.131"></a><span id="l28.131"> }</span>
<a href="#l28.132"></a><span id="l28.132"> </span>
<a href="#l28.133"></a><span id="l28.133"> NS_IMETHODIMP</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-nsNoneService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp)</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineminus">-{</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+nsNoneService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp) {</span>
<a href="#l28.137"></a><span id="l28.137">   NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l28.138"></a><span id="l28.138">   *aCanLoginAtStartUp = false;</span>
<a href="#l28.139"></a><span id="l28.139">   return NS_OK;</span>
<a href="#l28.140"></a><span id="l28.140"> }</span>
<a href="#l28.141"></a><span id="l28.141"> </span>
<a href="#l28.142"></a><span id="l28.142"> NS_IMETHODIMP</span>
<a href="#l28.143"></a><span id="l28.143" class="difflineminus">-nsNoneService::GetCanDelete(bool *aCanDelete)</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-{</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineplus">+nsNoneService::GetCanDelete(bool *aCanDelete) {</span>
<a href="#l28.146"></a><span id="l28.146">   NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l28.147"></a><span id="l28.147">   *aCanDelete = false;</span>
<a href="#l28.148"></a><span id="l28.148">   return NS_OK;</span>
<a href="#l28.149"></a><span id="l28.149"> }</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151"> NS_IMETHODIMP</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-nsNoneService::GetCanDuplicate(bool *aCanDuplicate)</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineminus">-{</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineplus">+nsNoneService::GetCanDuplicate(bool *aCanDuplicate) {</span>
<a href="#l28.155"></a><span id="l28.155">   NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l28.156"></a><span id="l28.156">   *aCanDuplicate = false;</span>
<a href="#l28.157"></a><span id="l28.157">   return NS_OK;</span>
<a href="#l28.158"></a><span id="l28.158"> }</span>
<a href="#l28.159"></a><span id="l28.159"> </span>
<a href="#l28.160"></a><span id="l28.160"> NS_IMETHODIMP</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineminus">-nsNoneService::GetCanGetMessages(bool *aCanGetMessages)</span>
<a href="#l28.162"></a><span id="l28.162" class="difflineminus">-{</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineminus">-    *aCanGetMessages = false;</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.166"></a><span id="l28.166" class="difflineplus">+nsNoneService::GetCanGetMessages(bool *aCanGetMessages) {</span>
<a href="#l28.167"></a><span id="l28.167" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l28.168"></a><span id="l28.168" class="difflineplus">+  *aCanGetMessages = false;</span>
<a href="#l28.169"></a><span id="l28.169" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.170"></a><span id="l28.170"> }</span>
<a href="#l28.171"></a><span id="l28.171"> </span>
<a href="#l28.172"></a><span id="l28.172"> NS_IMETHODIMP</span>
<a href="#l28.173"></a><span id="l28.173" class="difflineminus">-nsNoneService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages)</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineminus">-{</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-    *aCanGetIncomingMessages = false;</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineplus">+nsNoneService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages) {</span>
<a href="#l28.179"></a><span id="l28.179" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l28.180"></a><span id="l28.180" class="difflineplus">+  *aCanGetIncomingMessages = false;</span>
<a href="#l28.181"></a><span id="l28.181" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.182"></a><span id="l28.182"> }</span>
<a href="#l28.183"></a><span id="l28.183"> </span>
<a href="#l28.184"></a><span id="l28.184"> NS_IMETHODIMP</span>
<a href="#l28.185"></a><span id="l28.185" class="difflineminus">-nsNoneService::GetDefaultDoBiff(bool *aDoBiff)</span>
<a href="#l28.186"></a><span id="l28.186" class="difflineminus">-{</span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineminus">-    // by default, don't do biff for &quot;none&quot; servers</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineminus">-    *aDoBiff = false;</span>
<a href="#l28.190"></a><span id="l28.190" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.191"></a><span id="l28.191" class="difflineplus">+nsNoneService::GetDefaultDoBiff(bool *aDoBiff) {</span>
<a href="#l28.192"></a><span id="l28.192" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l28.193"></a><span id="l28.193" class="difflineplus">+  // by default, don't do biff for &quot;none&quot; servers</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineplus">+  *aDoBiff = false;</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.196"></a><span id="l28.196"> }</span>
<a href="#l28.197"></a><span id="l28.197"> </span>
<a href="#l28.198"></a><span id="l28.198"> NS_IMETHODIMP</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-nsNoneService::GetDefaultServerPort(bool isSecure, int32_t *aDefaultPort)</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-{</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineminus">-    *aDefaultPort = -1;</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.204"></a><span id="l28.204" class="difflineplus">+nsNoneService::GetDefaultServerPort(bool isSecure, int32_t *aDefaultPort) {</span>
<a href="#l28.205"></a><span id="l28.205" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l28.206"></a><span id="l28.206" class="difflineplus">+  *aDefaultPort = -1;</span>
<a href="#l28.207"></a><span id="l28.207" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.208"></a><span id="l28.208"> }</span>
<a href="#l28.209"></a><span id="l28.209"> </span>
<a href="#l28.210"></a><span id="l28.210"> NS_IMETHODIMP</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineminus">-nsNoneService::GetShowComposeMsgLink(bool *showComposeMsgLink)</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineminus">-{</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineminus">-    NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineminus">-    *showComposeMsgLink = false;</span>
<a href="#l28.215"></a><span id="l28.215" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineplus">+nsNoneService::GetShowComposeMsgLink(bool *showComposeMsgLink) {</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineplus">+  NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineplus">+  *showComposeMsgLink = false;</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineplus">+  return NS_OK;</span>
<a href="#l28.220"></a><span id="l28.220"> }</span>
<a href="#l28.221"></a><span id="l28.221"> </span>
<a href="#l28.222"></a><span id="l28.222"> NS_IMETHODIMP</span>
<a href="#l28.223"></a><span id="l28.223" class="difflineminus">-nsNoneService::GetFoldersCreatedAsync(bool *aAsyncCreation)</span>
<a href="#l28.224"></a><span id="l28.224" class="difflineminus">-{</span>
<a href="#l28.225"></a><span id="l28.225" class="difflineplus">+nsNoneService::GetFoldersCreatedAsync(bool *aAsyncCreation) {</span>
<a href="#l28.226"></a><span id="l28.226">   NS_ENSURE_ARG_POINTER(aAsyncCreation);</span>
<a href="#l28.227"></a><span id="l28.227">   *aAsyncCreation = false;</span>
<a href="#l28.228"></a><span id="l28.228">   return NS_OK;</span>
<a href="#l28.229"></a><span id="l28.229"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/local/src/nsNoneService.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/local/src/nsNoneService.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -6,23 +6,21 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #ifndef nsNoneService_h___</span>
<a href="#l29.5"></a><span id="l29.5"> #define nsNoneService_h___</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> #include &quot;nscore.h&quot;</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l29.10"></a><span id="l29.10"> #include &quot;nsINoneService.h&quot;</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-class nsNoneService : public nsIMsgProtocolInfo, public nsINoneService</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-{</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-public:</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+class nsNoneService : public nsIMsgProtocolInfo, public nsINoneService {</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+ public:</span>
<a href="#l29.18"></a><span id="l29.18">   nsNoneService();</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20">   NS_DECL_ISUPPORTS</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-    NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+  NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l29.23"></a><span id="l29.23">   NS_DECL_NSINONESERVICE</span>
<a href="#l29.24"></a><span id="l29.24"> </span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-private:</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+ private:</span>
<a href="#l29.27"></a><span id="l29.27">   virtual ~nsNoneService();</span>
<a href="#l29.28"></a><span id="l29.28"> };</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30"> #endif /* nsNoneService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -48,530 +48,477 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l30.5"></a><span id="l30.5"> #include &lt;ctype.h&gt;</span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l30.8"></a><span id="l30.8"> #include &quot;nsQueryObject.h&quot;</span>
<a href="#l30.9"></a><span id="l30.9"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l30.10"></a><span id="l30.10"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-/* the following macros actually implement addref, release and query interface for our component. */</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsMsgMailboxParser,</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-                             nsParseMailMessageState,</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-                             nsIStreamListener,</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-                             nsIRequestObserver)</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+/* the following macros actually implement addref, release and query interface</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+ * for our component. */</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsMsgMailboxParser, nsParseMailMessageState,</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+                            nsIStreamListener, nsIRequestObserver)</span>
<a href="#l30.21"></a><span id="l30.21"> </span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-// Whenever data arrives from the connection, core netlib notifices the protocol by calling</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-// OnDataAvailable. We then read and process the incoming data from the input stream.</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-NS_IMETHODIMP nsMsgMailboxParser::OnDataAvailable(nsIRequest *request, nsIInputStream *aIStream, uint64_t sourceOffset, uint32_t aLength)</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-{</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-    return ProcessMailboxInputStream(aIStream, aLength);</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+// Whenever data arrives from the connection, core netlib notifices the protocol</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+// by calling OnDataAvailable. We then read and process the incoming data from</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+// the input stream.</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+NS_IMETHODIMP nsMsgMailboxParser::OnDataAvailable(nsIRequest *request,</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+                                                  nsIInputStream *aIStream,</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+                                                  uint64_t sourceOffset,</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+                                                  uint32_t aLength) {</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+  return ProcessMailboxInputStream(aIStream, aLength);</span>
<a href="#l30.35"></a><span id="l30.35"> }</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-NS_IMETHODIMP nsMsgMailboxParser::OnStartRequest(nsIRequest *request)</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-{</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-    m_startTime = PR_Now();</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+NS_IMETHODIMP nsMsgMailboxParser::OnStartRequest(nsIRequest *request) {</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+  m_startTime = PR_Now();</span>
<a href="#l30.43"></a><span id="l30.43"> </span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-    // extract the appropriate event sinks from the url and initialize them in our protocol data</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-    // the URL should be queried for a nsIMailboxURL. If it doesn't support a mailbox URL interface then</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-    // we have an error.</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+  // extract the appropriate event sinks from the url and initialize them in our</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+  // protocol data the URL should be queried for a nsIMailboxURL. If it doesn't</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+  // support a mailbox URL interface then we have an error.</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l30.52"></a><span id="l30.52"> </span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-    nsCOMPtr&lt;nsIIOService&gt; ioServ =</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-      mozilla::services::GetIOService();</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-    NS_ENSURE_TRUE(ioServ, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ioServ = mozilla::services::GetIOService();</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+  NS_ENSURE_TRUE(ioServ, NS_ERROR_UNEXPECTED);</span>
<a href="#l30.58"></a><span id="l30.58"> </span>
<a href="#l30.59"></a><span id="l30.59" class="difflineminus">-    // We know the request is an nsIChannel we can get a URI from, but this is</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-    // probably bad form. See Bug 1528662.</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-    nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineminus">-    NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineminus">-    rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+  // We know the request is an nsIChannel we can get a URI from, but this is</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+  // probably bad form. See Bug 1528662.</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+                       &quot;error QI nsIRequest to nsIChannel failed&quot;);</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+  rv = channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.76"></a><span id="l30.76"> </span>
<a href="#l30.77"></a><span id="l30.77" class="difflineminus">-    nsCOMPtr&lt;nsIMailboxUrl&gt; runningUrl = do_QueryInterface(uri, &amp;rv);</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+  nsCOMPtr&lt;nsIMailboxUrl&gt; runningUrl = do_QueryInterface(uri, &amp;rv);</span>
<a href="#l30.79"></a><span id="l30.79"> </span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(uri);</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(uri);</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l30.84"></a><span id="l30.84"> </span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; runningUrl &amp;&amp; folder)</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineminus">-    {</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-        url-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; runningUrl &amp;&amp; folder) {</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+    url-&gt;GetStatusFeedback(getter_AddRefs(m_statusFeedback));</span>
<a href="#l30.90"></a><span id="l30.90"> </span>
<a href="#l30.91"></a><span id="l30.91" class="difflineminus">-        // okay, now fill in our event sinks...Note that each getter ref counts before</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-        // it returns the interface to us...we'll release when we are done</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+    // okay, now fill in our event sinks...Note that each getter ref counts</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+    // before it returns the interface to us...we'll release when we are done</span>
<a href="#l30.95"></a><span id="l30.95"> </span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-        folder-&gt;GetName(m_folderName);</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+    folder-&gt;GetName(m_folderName);</span>
<a href="#l30.98"></a><span id="l30.98"> </span>
<a href="#l30.99"></a><span id="l30.99" class="difflineminus">-        nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-        folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+    folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l30.103"></a><span id="l30.103"> </span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-        if (path)</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-        {</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-          int64_t fileSize;</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-          path-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-            // the size of the mailbox file is our total base line for measuring progress</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-            m_graph_progress_total = fileSize;</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineminus">-            UpdateStatusText(&quot;buildingSummary&quot;);</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-            nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-            if (msgDBService)</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-            {</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-                // Use OpenFolderDB to always open the db so that db's m_folder</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-                // is set correctly.</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-                rv = msgDBService-&gt;OpenFolderDB(folder, true,</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineminus">-                                                getter_AddRefs(m_mailDB));</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineminus">-                if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-                  rv = msgDBService-&gt;CreateNewDB(folder,</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineminus">-                                                 getter_AddRefs(m_mailDB));</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-                if (m_mailDB)</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-                    m_mailDB-&gt;AddListener(this);</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-            }</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-            NS_ASSERTION(m_mailDB, &quot;failed to open mail db parsing folder&quot;);</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+    if (path) {</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+      int64_t fileSize;</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+      path-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+      // the size of the mailbox file is our total base line for measuring</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+      // progress</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+      m_graph_progress_total = fileSize;</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+      UpdateStatusText(&quot;buildingSummary&quot;);</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+          do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+      if (msgDBService) {</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+        // Use OpenFolderDB to always open the db so that db's m_folder</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+        // is set correctly.</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+        rv = msgDBService-&gt;OpenFolderDB(folder, true, getter_AddRefs(m_mailDB));</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+        if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+          rv = msgDBService-&gt;CreateNewDB(folder, getter_AddRefs(m_mailDB));</span>
<a href="#l30.141"></a><span id="l30.141"> </span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-            // try to get a backup message database</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-            nsresult rvignore = folder-&gt;GetBackupMsgDatabase(</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-                getter_AddRefs(m_backupMailDB));</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+        if (m_mailDB) m_mailDB-&gt;AddListener(this);</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+      }</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+      NS_ASSERTION(m_mailDB, &quot;failed to open mail db parsing folder&quot;);</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+      // try to get a backup message database</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+      nsresult rvignore =</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+          folder-&gt;GetBackupMsgDatabase(getter_AddRefs(m_backupMailDB));</span>
<a href="#l30.152"></a><span id="l30.152"> </span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-            // We'll accept failures and move on, as we're dealing with some</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineminus">-            // sort of unknown problem to begin with.</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineminus">-            if (NS_FAILED(rvignore))</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-            {</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-              if (m_backupMailDB)</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">-                m_backupMailDB-&gt;RemoveListener(this);</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineminus">-              m_backupMailDB = nullptr;</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-            }</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineminus">-            else if (m_backupMailDB)</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineminus">-            {</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-              m_backupMailDB-&gt;AddListener(this);</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-            }</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-        }</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineplus">+      // We'll accept failures and move on, as we're dealing with some</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+      // sort of unknown problem to begin with.</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+      if (NS_FAILED(rvignore)) {</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+        if (m_backupMailDB) m_backupMailDB-&gt;RemoveListener(this);</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+        m_backupMailDB = nullptr;</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+      } else if (m_backupMailDB) {</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+        m_backupMailDB-&gt;AddListener(this);</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+      }</span>
<a href="#l30.174"></a><span id="l30.174">     }</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+  }</span>
<a href="#l30.176"></a><span id="l30.176"> </span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-    // need to get the mailbox name out of the url and call SetMailboxName with it.</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-    // then, we need to open the mail db for this parser.</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-    return rv;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+  // need to get the mailbox name out of the url and call SetMailboxName with</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+  // it. then, we need to open the mail db for this parser.</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+  return rv;</span>
<a href="#l30.183"></a><span id="l30.183"> }</span>
<a href="#l30.184"></a><span id="l30.184"> </span>
<a href="#l30.185"></a><span id="l30.185" class="difflineminus">-// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-NS_IMETHODIMP nsMsgMailboxParser::OnStopRequest(nsIRequest *request, nsresult aStatus)</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-{</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineminus">-    DoneParsingFolder(aStatus);</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineminus">-    // what can we do? we can close the stream?</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-    m_urlInProgress = false;  // don't close the connection...we may be re-using it.</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+// stop binding is a &quot;notification&quot; informing us that the stream associated with</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+// aURL is going away.</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+NS_IMETHODIMP nsMsgMailboxParser::OnStopRequest(nsIRequest *request,</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+                                                nsresult aStatus) {</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+  DoneParsingFolder(aStatus);</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+  // what can we do? we can close the stream?</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+  m_urlInProgress =</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+      false;  // don't close the connection...we may be re-using it.</span>
<a href="#l30.199"></a><span id="l30.199"> </span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-    if (m_mailDB)</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineminus">-        m_mailDB-&gt;RemoveListener(this);</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineminus">-    // and we want to mark ourselves for deletion or some how inform our protocol manager that we are</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-    // available for another url if there is one....</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+  if (m_mailDB) m_mailDB-&gt;RemoveListener(this);</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+  // and we want to mark ourselves for deletion or some how inform our protocol</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+  // manager that we are available for another url if there is one....</span>
<a href="#l30.207"></a><span id="l30.207"> </span>
<a href="#l30.208"></a><span id="l30.208" class="difflineminus">-    ReleaseFolderLock();</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineminus">-    // be sure to clear any status text and progress info..</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineminus">-    m_graph_progress_received = 0;</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineminus">-    UpdateProgressPercent();</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-    UpdateStatusText(&quot;localStatusDocumentDone&quot;);</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+  ReleaseFolderLock();</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+  // be sure to clear any status text and progress info..</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+  m_graph_progress_received = 0;</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+  UpdateProgressPercent();</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+  UpdateStatusText(&quot;localStatusDocumentDone&quot;);</span>
<a href="#l30.218"></a><span id="l30.218"> </span>
<a href="#l30.219"></a><span id="l30.219" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.221"></a><span id="l30.221"> }</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223"> NS_IMETHODIMP</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-nsParseMailMessageState::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange,</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineminus">-    bool aPreChange, uint32_t *aStatus, nsIDBChangeListener * aInstigator)</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineminus">-{</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+nsParseMailMessageState::OnHdrPropertyChanged(</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineplus">+    nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l30.230"></a><span id="l30.230">   return NS_OK;</span>
<a href="#l30.231"></a><span id="l30.231"> }</span>
<a href="#l30.232"></a><span id="l30.232"> </span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-</span>
<a href="#l30.234"></a><span id="l30.234"> NS_IMETHODIMP</span>
<a href="#l30.235"></a><span id="l30.235"> nsParseMailMessageState::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">-    uint32_t aOldFlags, uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">-{</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+                                           uint32_t aOldFlags,</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+                                           uint32_t aNewFlags,</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+                                           nsIDBChangeListener *aInstigator) {</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.243"></a><span id="l30.243"> }</span>
<a href="#l30.244"></a><span id="l30.244"> </span>
<a href="#l30.245"></a><span id="l30.245"> NS_IMETHODIMP</span>
<a href="#l30.246"></a><span id="l30.246"> nsParseMailMessageState::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineminus">-    nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineminus">-{</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+                                      nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+                                      nsIDBChangeListener *aInstigator) {</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.253"></a><span id="l30.253"> }</span>
<a href="#l30.254"></a><span id="l30.254"> </span>
<a href="#l30.255"></a><span id="l30.255"> NS_IMETHODIMP</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineminus">-nsParseMailMessageState::OnHdrAdded(nsIMsgDBHdr *aHdrAdded,</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineminus">-    nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineminus">-{</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+nsParseMailMessageState::OnHdrAdded(nsIMsgDBHdr *aHdrAdded, nsMsgKey aParentKey,</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+                                    int32_t aFlags,</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+                                    nsIDBChangeListener *aInstigator) {</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.264"></a><span id="l30.264"> }</span>
<a href="#l30.265"></a><span id="l30.265"> </span>
<a href="#l30.266"></a><span id="l30.266" class="difflineminus">-/* void OnParentChanged (in nsMsgKey aKeyChanged, in nsMsgKey oldParent, in nsMsgKey newParent, in nsIDBChangeListener aInstigator); */</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+/* void OnParentChanged (in nsMsgKey aKeyChanged, in nsMsgKey oldParent, in</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+ * nsMsgKey newParent, in nsIDBChangeListener aInstigator); */</span>
<a href="#l30.269"></a><span id="l30.269"> NS_IMETHODIMP</span>
<a href="#l30.270"></a><span id="l30.270"> nsParseMailMessageState::OnParentChanged(nsMsgKey aKeyChanged,</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-    nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeListener *aInstigator)</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">-{</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+                                         nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+                                         nsIDBChangeListener *aInstigator) {</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.277"></a><span id="l30.277"> }</span>
<a href="#l30.278"></a><span id="l30.278"> </span>
<a href="#l30.279"></a><span id="l30.279"> /* void OnAnnouncerGoingAway (in nsIDBChangeAnnouncer instigator); */</span>
<a href="#l30.280"></a><span id="l30.280"> NS_IMETHODIMP</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-nsParseMailMessageState::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-{</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-  if (m_backupMailDB &amp;&amp; m_backupMailDB == instigator)</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-  {</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+nsParseMailMessageState::OnAnnouncerGoingAway(</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+    nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+  if (m_backupMailDB &amp;&amp; m_backupMailDB == instigator) {</span>
<a href="#l30.288"></a><span id="l30.288">     m_backupMailDB-&gt;RemoveListener(this);</span>
<a href="#l30.289"></a><span id="l30.289">     m_backupMailDB = nullptr;</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-  }</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-  else if (m_mailDB)</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-  {</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineplus">+  } else if (m_mailDB) {</span>
<a href="#l30.294"></a><span id="l30.294">     m_mailDB-&gt;RemoveListener(this);</span>
<a href="#l30.295"></a><span id="l30.295">     m_mailDB = nullptr;</span>
<a href="#l30.296"></a><span id="l30.296">     m_newMsgHdr = nullptr;</span>
<a href="#l30.297"></a><span id="l30.297">   }</span>
<a href="#l30.298"></a><span id="l30.298">   return NS_OK;</span>
<a href="#l30.299"></a><span id="l30.299"> }</span>
<a href="#l30.300"></a><span id="l30.300"> </span>
<a href="#l30.301"></a><span id="l30.301" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::OnEvent(nsIMsgDatabase *aDB, const char *aEvent)</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineminus">-{</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::OnEvent(nsIMsgDatabase *aDB,</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+                                               const char *aEvent) {</span>
<a href="#l30.305"></a><span id="l30.305">   return NS_OK;</span>
<a href="#l30.306"></a><span id="l30.306"> }</span>
<a href="#l30.307"></a><span id="l30.307"> </span>
<a href="#l30.308"></a><span id="l30.308"> /* void OnReadChanged (in nsIDBChangeListener instigator); */</span>
<a href="#l30.309"></a><span id="l30.309"> NS_IMETHODIMP</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineminus">-nsParseMailMessageState::OnReadChanged(nsIDBChangeListener *instigator)</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineminus">-{</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineplus">+nsParseMailMessageState::OnReadChanged(nsIDBChangeListener *instigator) {</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.315"></a><span id="l30.315"> }</span>
<a href="#l30.316"></a><span id="l30.316"> </span>
<a href="#l30.317"></a><span id="l30.317"> /* void OnJunkScoreChanged (in nsIDBChangeListener instigator); */</span>
<a href="#l30.318"></a><span id="l30.318"> NS_IMETHODIMP</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-nsParseMailMessageState::OnJunkScoreChanged(nsIDBChangeListener *instigator)</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineminus">-{</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+nsParseMailMessageState::OnJunkScoreChanged(nsIDBChangeListener *instigator) {</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineplus">+  return NS_OK;</span>
<a href="#l30.324"></a><span id="l30.324"> }</span>
<a href="#l30.325"></a><span id="l30.325"> </span>
<a href="#l30.326"></a><span id="l30.326" class="difflineminus">-nsMsgMailboxParser::nsMsgMailboxParser() : nsMsgLineBuffer(nullptr, false)</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineminus">-{</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineplus">+nsMsgMailboxParser::nsMsgMailboxParser() : nsMsgLineBuffer(nullptr, false) {</span>
<a href="#l30.329"></a><span id="l30.329">   Init();</span>
<a href="#l30.330"></a><span id="l30.330"> }</span>
<a href="#l30.331"></a><span id="l30.331"> </span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-nsMsgMailboxParser::nsMsgMailboxParser(nsIMsgFolder *aFolder) : nsMsgLineBuffer(nullptr, false)</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-{</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineplus">+nsMsgMailboxParser::nsMsgMailboxParser(nsIMsgFolder *aFolder)</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineplus">+    : nsMsgLineBuffer(nullptr, false) {</span>
<a href="#l30.336"></a><span id="l30.336">   m_folder = do_GetWeakReference(aFolder);</span>
<a href="#l30.337"></a><span id="l30.337"> }</span>
<a href="#l30.338"></a><span id="l30.338"> </span>
<a href="#l30.339"></a><span id="l30.339" class="difflineminus">-nsMsgMailboxParser::~nsMsgMailboxParser()</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineminus">-{</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineminus">-  ReleaseFolderLock();</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-}</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+nsMsgMailboxParser::~nsMsgMailboxParser() { ReleaseFolderLock(); }</span>
<a href="#l30.344"></a><span id="l30.344"> </span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-nsresult nsMsgMailboxParser::Init()</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-{</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineplus">+nsresult nsMsgMailboxParser::Init() {</span>
<a href="#l30.348"></a><span id="l30.348">   m_obuffer = nullptr;</span>
<a href="#l30.349"></a><span id="l30.349">   m_obuffer_size = 0;</span>
<a href="#l30.350"></a><span id="l30.350">   m_graph_progress_total = 0;</span>
<a href="#l30.351"></a><span id="l30.351">   m_graph_progress_received = 0;</span>
<a href="#l30.352"></a><span id="l30.352">   return AcquireFolderLock();</span>
<a href="#l30.353"></a><span id="l30.353"> }</span>
<a href="#l30.354"></a><span id="l30.354"> </span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-void nsMsgMailboxParser::UpdateStatusText (const char* stringName)</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">-{</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-  if (m_statusFeedback)</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineminus">-  {</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+void nsMsgMailboxParser::UpdateStatusText(const char *stringName) {</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+  if (m_statusFeedback) {</span>
<a href="#l30.361"></a><span id="l30.361">     nsresult rv;</span>
<a href="#l30.362"></a><span id="l30.362">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineminus">-    if (!bundleService)</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineminus">-      return;</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineplus">+    if (!bundleService) return;</span>
<a href="#l30.368"></a><span id="l30.368">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-      return;</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineplus">+        &quot;chrome://messenger/locale/localMsgs.properties&quot;,</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineplus">+        getter_AddRefs(bundle));</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+    if (NS_FAILED(rv)) return;</span>
<a href="#l30.376"></a><span id="l30.376">     nsString finalString;</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineminus">-    const char16_t * stringArray[] = { m_folderName.get() };</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(stringName,</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineminus">-                                      stringArray, 1, finalString);</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineplus">+    const char16_t *stringArray[] = {m_folderName.get()};</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(stringName, stringArray, 1, finalString);</span>
<a href="#l30.382"></a><span id="l30.382">     m_statusFeedback-&gt;ShowStatusString(finalString);</span>
<a href="#l30.383"></a><span id="l30.383">   }</span>
<a href="#l30.384"></a><span id="l30.384"> }</span>
<a href="#l30.385"></a><span id="l30.385"> </span>
<a href="#l30.386"></a><span id="l30.386" class="difflineminus">-void nsMsgMailboxParser::UpdateProgressPercent ()</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineminus">-{</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineminus">-  if (m_statusFeedback &amp;&amp; m_graph_progress_total != 0)</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineminus">-  {</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineplus">+void nsMsgMailboxParser::UpdateProgressPercent() {</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineplus">+  if (m_statusFeedback &amp;&amp; m_graph_progress_total != 0) {</span>
<a href="#l30.392"></a><span id="l30.392">     // prevent overflow by dividing both by 100</span>
<a href="#l30.393"></a><span id="l30.393">     int64_t progressTotal = m_graph_progress_total / 100;</span>
<a href="#l30.394"></a><span id="l30.394">     int64_t progressReceived = m_graph_progress_received / 100;</span>
<a href="#l30.395"></a><span id="l30.395">     if (progressTotal &gt; 0)</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineminus">-      m_statusFeedback-&gt;ShowProgress((100 *(progressReceived))  / progressTotal);</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineplus">+      m_statusFeedback-&gt;ShowProgress((100 * (progressReceived)) /</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineplus">+                                     progressTotal);</span>
<a href="#l30.399"></a><span id="l30.399">   }</span>
<a href="#l30.400"></a><span id="l30.400"> }</span>
<a href="#l30.401"></a><span id="l30.401"> </span>
<a href="#l30.402"></a><span id="l30.402" class="difflineminus">-nsresult nsMsgMailboxParser::ProcessMailboxInputStream(nsIInputStream *aIStream, uint32_t aLength)</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineminus">-{</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineplus">+nsresult nsMsgMailboxParser::ProcessMailboxInputStream(nsIInputStream *aIStream,</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineplus">+                                                       uint32_t aLength) {</span>
<a href="#l30.406"></a><span id="l30.406">   nsresult ret = NS_OK;</span>
<a href="#l30.407"></a><span id="l30.407"> </span>
<a href="#l30.408"></a><span id="l30.408">   uint32_t bytesRead = 0;</span>
<a href="#l30.409"></a><span id="l30.409"> </span>
<a href="#l30.410"></a><span id="l30.410" class="difflineminus">-  if (NS_SUCCEEDED(m_inputStream.GrowBuffer(aLength)))</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineminus">-  {</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineplus">+  if (NS_SUCCEEDED(m_inputStream.GrowBuffer(aLength))) {</span>
<a href="#l30.413"></a><span id="l30.413">     // OK, this sucks, but we're going to have to copy into our</span>
<a href="#l30.414"></a><span id="l30.414">     // own byte buffer, and then pass that to the line buffering code,</span>
<a href="#l30.415"></a><span id="l30.415">     // which means a couple buffer copies.</span>
<a href="#l30.416"></a><span id="l30.416">     ret = aIStream-&gt;Read(m_inputStream.GetBuffer(), aLength, &amp;bytesRead);</span>
<a href="#l30.417"></a><span id="l30.417">     if (NS_SUCCEEDED(ret))</span>
<a href="#l30.418"></a><span id="l30.418">       ret = BufferInput(m_inputStream.GetBuffer(), bytesRead);</span>
<a href="#l30.419"></a><span id="l30.419">   }</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineminus">-  if (m_graph_progress_total &gt; 0)</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineminus">-  {</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineminus">-    if (NS_SUCCEEDED(ret))</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineminus">-      m_graph_progress_received += bytesRead;</span>
<a href="#l30.424"></a><span id="l30.424" class="difflineplus">+  if (m_graph_progress_total &gt; 0) {</span>
<a href="#l30.425"></a><span id="l30.425" class="difflineplus">+    if (NS_SUCCEEDED(ret)) m_graph_progress_received += bytesRead;</span>
<a href="#l30.426"></a><span id="l30.426">   }</span>
<a href="#l30.427"></a><span id="l30.427">   return (ret);</span>
<a href="#l30.428"></a><span id="l30.428"> }</span>
<a href="#l30.429"></a><span id="l30.429"> </span>
<a href="#l30.430"></a><span id="l30.430" class="difflineminus">-void nsMsgMailboxParser::DoneParsingFolder(nsresult status)</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineminus">-{</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineplus">+void nsMsgMailboxParser::DoneParsingFolder(nsresult status) {</span>
<a href="#l30.433"></a><span id="l30.433">   /* End of file.  Flush out any partial line remaining in the buffer. */</span>
<a href="#l30.434"></a><span id="l30.434">   FlushLastLine();</span>
<a href="#l30.435"></a><span id="l30.435">   PublishMsgHeader(nullptr);</span>
<a href="#l30.436"></a><span id="l30.436"> </span>
<a href="#l30.437"></a><span id="l30.437">   // only mark the db valid if we've succeeded.</span>
<a href="#l30.438"></a><span id="l30.438" class="difflineminus">-  if (NS_SUCCEEDED(status) &amp;&amp; m_mailDB)  // finished parsing, so flush db folder info</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineplus">+  if (NS_SUCCEEDED(status) &amp;&amp;</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineplus">+      m_mailDB)  // finished parsing, so flush db folder info</span>
<a href="#l30.441"></a><span id="l30.441">     UpdateDBFolderInfo();</span>
<a href="#l30.442"></a><span id="l30.442">   else if (m_mailDB)</span>
<a href="#l30.443"></a><span id="l30.443">     m_mailDB-&gt;SetSummaryValid(false);</span>
<a href="#l30.444"></a><span id="l30.444"> </span>
<a href="#l30.445"></a><span id="l30.445">   // remove the backup database</span>
<a href="#l30.446"></a><span id="l30.446" class="difflineminus">-  if (m_backupMailDB)</span>
<a href="#l30.447"></a><span id="l30.447" class="difflineminus">-  {</span>
<a href="#l30.448"></a><span id="l30.448" class="difflineplus">+  if (m_backupMailDB) {</span>
<a href="#l30.449"></a><span id="l30.449">     nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineminus">-    if (folder)</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineminus">-      folder-&gt;RemoveBackupMsgDatabase();</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineplus">+    if (folder) folder-&gt;RemoveBackupMsgDatabase();</span>
<a href="#l30.453"></a><span id="l30.453">     m_backupMailDB = nullptr;</span>
<a href="#l30.454"></a><span id="l30.454">   }</span>
<a href="#l30.455"></a><span id="l30.455"> </span>
<a href="#l30.456"></a><span id="l30.456">   //  if (m_folder != nullptr)</span>
<a href="#l30.457"></a><span id="l30.457">   //    m_folder-&gt;SummaryChanged();</span>
<a href="#l30.458"></a><span id="l30.458">   FreeBuffers();</span>
<a href="#l30.459"></a><span id="l30.459"> }</span>
<a href="#l30.460"></a><span id="l30.460"> </span>
<a href="#l30.461"></a><span id="l30.461" class="difflineminus">-void nsMsgMailboxParser::FreeBuffers()</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineminus">-{</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineplus">+void nsMsgMailboxParser::FreeBuffers() {</span>
<a href="#l30.464"></a><span id="l30.464">   /* We're done reading the folder - we don't need these things</span>
<a href="#l30.465"></a><span id="l30.465">    any more. */</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineminus">-  PR_FREEIF (m_obuffer);</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineplus">+  PR_FREEIF(m_obuffer);</span>
<a href="#l30.468"></a><span id="l30.468">   m_obuffer_size = 0;</span>
<a href="#l30.469"></a><span id="l30.469"> }</span>
<a href="#l30.470"></a><span id="l30.470"> </span>
<a href="#l30.471"></a><span id="l30.471" class="difflineminus">-void nsMsgMailboxParser::UpdateDBFolderInfo()</span>
<a href="#l30.472"></a><span id="l30.472" class="difflineminus">-{</span>
<a href="#l30.473"></a><span id="l30.473" class="difflineminus">-  UpdateDBFolderInfo(m_mailDB);</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineminus">-}</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineplus">+void nsMsgMailboxParser::UpdateDBFolderInfo() { UpdateDBFolderInfo(m_mailDB); }</span>
<a href="#l30.476"></a><span id="l30.476"> </span>
<a href="#l30.477"></a><span id="l30.477"> // update folder info in db so we know not to reparse.</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineminus">-void nsMsgMailboxParser::UpdateDBFolderInfo(nsIMsgDatabase *mailDB)</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineminus">-{</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineplus">+void nsMsgMailboxParser::UpdateDBFolderInfo(nsIMsgDatabase *mailDB) {</span>
<a href="#l30.481"></a><span id="l30.481">   mailDB-&gt;SetSummaryValid(true);</span>
<a href="#l30.482"></a><span id="l30.482"> }</span>
<a href="#l30.483"></a><span id="l30.483"> </span>
<a href="#l30.484"></a><span id="l30.484"> // Tell the world about the message header (add to db, and view, if any)</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineminus">-int32_t nsMsgMailboxParser::PublishMsgHeader(nsIMsgWindow *msgWindow)</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineminus">-{</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineplus">+int32_t nsMsgMailboxParser::PublishMsgHeader(nsIMsgWindow *msgWindow) {</span>
<a href="#l30.488"></a><span id="l30.488">   FinishHeader();</span>
<a href="#l30.489"></a><span id="l30.489" class="difflineminus">-  if (m_newMsgHdr)</span>
<a href="#l30.490"></a><span id="l30.490" class="difflineminus">-  {</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineplus">+  if (m_newMsgHdr) {</span>
<a href="#l30.492"></a><span id="l30.492">     char storeToken[100];</span>
<a href="#l30.493"></a><span id="l30.493">     PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, m_envelope_pos);</span>
<a href="#l30.494"></a><span id="l30.494">     m_newMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l30.495"></a><span id="l30.495"> </span>
<a href="#l30.496"></a><span id="l30.496">     uint32_t flags;</span>
<a href="#l30.497"></a><span id="l30.497">     (void)m_newMsgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::Expunged)</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineminus">-    {</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::Expunged) {</span>
<a href="#l30.501"></a><span id="l30.501">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l30.502"></a><span id="l30.502">       m_mailDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l30.503"></a><span id="l30.503">       uint32_t size;</span>
<a href="#l30.504"></a><span id="l30.504">       (void)m_newMsgHdr-&gt;GetMessageSize(&amp;size);</span>
<a href="#l30.505"></a><span id="l30.505">       folderInfo-&gt;ChangeExpungedBytes(size);</span>
<a href="#l30.506"></a><span id="l30.506">       m_newMsgHdr = nullptr;</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineminus">-    }</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineminus">-    else if (m_mailDB)</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineminus">-    {</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineplus">+    } else if (m_mailDB) {</span>
<a href="#l30.511"></a><span id="l30.511">       // add hdr but don't notify - shouldn't be requiring notifications</span>
<a href="#l30.512"></a><span id="l30.512">       // during summary file rebuilding</span>
<a href="#l30.513"></a><span id="l30.513">       m_mailDB-&gt;AddNewHdrToDB(m_newMsgHdr, false);</span>
<a href="#l30.514"></a><span id="l30.514">       m_newMsgHdr = nullptr;</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineminus">-    }</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineminus">-    else</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineminus">-      NS_ASSERTION(false, &quot;no database while parsing local folder&quot;);  // should have a DB, no?</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineminus">-  }</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineminus">-  else if (m_mailDB)</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineminus">-  {</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineplus">+    } else</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineplus">+      NS_ASSERTION(</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineplus">+          false,</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+          &quot;no database while parsing local folder&quot;);  // should have a DB, no?</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineplus">+  } else if (m_mailDB) {</span>
<a href="#l30.526"></a><span id="l30.526">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l30.527"></a><span id="l30.527">     m_mailDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l30.528"></a><span id="l30.528">     if (folderInfo)</span>
<a href="#l30.529"></a><span id="l30.529">       folderInfo-&gt;ChangeExpungedBytes(m_position - m_envelope_pos);</span>
<a href="#l30.530"></a><span id="l30.530">   }</span>
<a href="#l30.531"></a><span id="l30.531">   return 0;</span>
<a href="#l30.532"></a><span id="l30.532"> }</span>
<a href="#l30.533"></a><span id="l30.533"> </span>
<a href="#l30.534"></a><span id="l30.534" class="difflineminus">-void nsMsgMailboxParser::AbortNewHeader()</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineminus">-{</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineminus">-  if (m_newMsgHdr &amp;&amp; m_mailDB)</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineminus">-    m_newMsgHdr = nullptr;</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineplus">+void nsMsgMailboxParser::AbortNewHeader() {</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineplus">+  if (m_newMsgHdr &amp;&amp; m_mailDB) m_newMsgHdr = nullptr;</span>
<a href="#l30.540"></a><span id="l30.540"> }</span>
<a href="#l30.541"></a><span id="l30.541"> </span>
<a href="#l30.542"></a><span id="l30.542" class="difflineminus">-void nsMsgMailboxParser::OnNewMessage(nsIMsgWindow *msgWindow)</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineminus">-{</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineplus">+void nsMsgMailboxParser::OnNewMessage(nsIMsgWindow *msgWindow) {</span>
<a href="#l30.545"></a><span id="l30.545">   PublishMsgHeader(msgWindow);</span>
<a href="#l30.546"></a><span id="l30.546">   Clear();</span>
<a href="#l30.547"></a><span id="l30.547"> }</span>
<a href="#l30.548"></a><span id="l30.548"> </span>
<a href="#l30.549"></a><span id="l30.549" class="difflineminus">-nsresult nsMsgMailboxParser::HandleLine(const char *line, uint32_t lineLength)</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineminus">-{</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineminus">-  /* If this is the very first line of a non-empty folder, make sure it's an envelope */</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineminus">-  if (m_graph_progress_received == 0)</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineminus">-  {</span>
<a href="#l30.554"></a><span id="l30.554" class="difflineplus">+nsresult nsMsgMailboxParser::HandleLine(const char *line, uint32_t lineLength) {</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineplus">+  /* If this is the very first line of a non-empty folder, make sure it's an</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineplus">+   * envelope */</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineplus">+  if (m_graph_progress_received == 0) {</span>
<a href="#l30.558"></a><span id="l30.558">     /* This is the first block from the file.  Check to see if this</span>
<a href="#l30.559"></a><span id="l30.559">        looks like a mail file. */</span>
<a href="#l30.560"></a><span id="l30.560">     const char *s = line;</span>
<a href="#l30.561"></a><span id="l30.561">     const char *end = s + lineLength;</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineminus">-    while (s &lt; end &amp;&amp; IS_SPACE(*s))</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineminus">-      s++;</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineminus">-    if ((end - s) &lt; 20 || !IsEnvelopeLine(s, end - s))</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineminus">-    {</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineminus">-//      char buf[500];</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineminus">-//      PR_snprintf (buf, sizeof(buf),</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineminus">-//             XP_GetString(MK_MSG_NON_MAIL_FILE_READ_QUESTION),</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineminus">-//             folder_name);</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineminus">-//      else if (!FE_Confirm (m_context, buf))</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineminus">-//        return NS_MSG_NOT_A_MAIL_FOLDER; /* #### NOT_A_MAIL_FILE */</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineplus">+    while (s &lt; end &amp;&amp; IS_SPACE(*s)) s++;</span>
<a href="#l30.573"></a><span id="l30.573" class="difflineplus">+    if ((end - s) &lt; 20 || !IsEnvelopeLine(s, end - s)) {</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineplus">+      //      char buf[500];</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineplus">+      //      PR_snprintf (buf, sizeof(buf),</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineplus">+      //             XP_GetString(MK_MSG_NON_MAIL_FILE_READ_QUESTION),</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineplus">+      //             folder_name);</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineplus">+      //      else if (!FE_Confirm (m_context, buf))</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineplus">+      //        return NS_MSG_NOT_A_MAIL_FOLDER; /* #### NOT_A_MAIL_FILE */</span>
<a href="#l30.580"></a><span id="l30.580">     }</span>
<a href="#l30.581"></a><span id="l30.581">   }</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineminus">-//  m_graph_progress_received += lineLength;</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineplus">+  //  m_graph_progress_received += lineLength;</span>
<a href="#l30.584"></a><span id="l30.584"> </span>
<a href="#l30.585"></a><span id="l30.585">   // mailbox parser needs to do special stuff when it finds an envelope</span>
<a href="#l30.586"></a><span id="l30.586">   // after parsing a message body. So do that.</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineminus">-  if (line[0] == 'F' &amp;&amp; IsEnvelopeLine(line, lineLength))</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineminus">-  {</span>
<a href="#l30.589"></a><span id="l30.589" class="difflineplus">+  if (line[0] == 'F' &amp;&amp; IsEnvelopeLine(line, lineLength)) {</span>
<a href="#l30.590"></a><span id="l30.590">     // **** This used to be</span>
<a href="#l30.591"></a><span id="l30.591">     // PR_ASSERT (m_parseMsgState-&gt;m_state == nsMailboxParseBodyState);</span>
<a href="#l30.592"></a><span id="l30.592">     // **** I am not sure this is a right thing to do. This happens when</span>
<a href="#l30.593"></a><span id="l30.593">     // going online, downloading a message while playing back append</span>
<a href="#l30.594"></a><span id="l30.594">     // draft/template offline operation. We are mixing</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineminus">-        // nsMailboxParseBodyState &amp;&amp;</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineplus">+    // nsMailboxParseBodyState &amp;&amp;</span>
<a href="#l30.597"></a><span id="l30.597">     // nsMailboxParseHeadersState. David I need your help here too. **** jt</span>
<a href="#l30.598"></a><span id="l30.598"> </span>
<a href="#l30.599"></a><span id="l30.599" class="difflineminus">-    NS_ASSERTION (m_state == nsIMsgParseMailMsgState::ParseBodyState ||</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineminus">-           m_state == nsIMsgParseMailMsgState::ParseHeadersState, &quot;invalid parse state&quot;); /* else folder corrupted */</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineplus">+    NS_ASSERTION(m_state == nsIMsgParseMailMsgState::ParseBodyState ||</span>
<a href="#l30.602"></a><span id="l30.602" class="difflineplus">+                     m_state == nsIMsgParseMailMsgState::ParseHeadersState,</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineplus">+                 &quot;invalid parse state&quot;); /* else folder corrupted */</span>
<a href="#l30.604"></a><span id="l30.604">     OnNewMessage(nullptr);</span>
<a href="#l30.605"></a><span id="l30.605">     nsresult rv = StartNewEnvelope(line, lineLength);</span>
<a href="#l30.606"></a><span id="l30.606">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot; error starting envelope parsing mailbox&quot;);</span>
<a href="#l30.607"></a><span id="l30.607">     // at the start of each new message, update the progress bar</span>
<a href="#l30.608"></a><span id="l30.608">     UpdateProgressPercent();</span>
<a href="#l30.609"></a><span id="l30.609">     return rv;</span>
<a href="#l30.610"></a><span id="l30.610">   }</span>
<a href="#l30.611"></a><span id="l30.611"> </span>
<a href="#l30.612"></a><span id="l30.612">   // otherwise, the message parser can handle it completely.</span>
<a href="#l30.613"></a><span id="l30.613">   if (m_mailDB != nullptr)  // if no DB, do we need to parse at all?</span>
<a href="#l30.614"></a><span id="l30.614">     return ParseFolderLine(line, lineLength);</span>
<a href="#l30.615"></a><span id="l30.615"> </span>
<a href="#l30.616"></a><span id="l30.616" class="difflineminus">-  return NS_ERROR_NULL_POINTER; // need to error out if we don't have a db.</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineplus">+  return NS_ERROR_NULL_POINTER;  // need to error out if we don't have a db.</span>
<a href="#l30.618"></a><span id="l30.618"> }</span>
<a href="#l30.619"></a><span id="l30.619"> </span>
<a href="#l30.620"></a><span id="l30.620" class="difflineminus">-void</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineminus">-nsMsgMailboxParser::ReleaseFolderLock()</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineminus">-{</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineplus">+void nsMsgMailboxParser::ReleaseFolderLock() {</span>
<a href="#l30.624"></a><span id="l30.624">   nsresult result;</span>
<a href="#l30.625"></a><span id="l30.625">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineminus">-  if (!folder)</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineminus">-    return;</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineplus">+  if (!folder) return;</span>
<a href="#l30.629"></a><span id="l30.629">   bool haveSemaphore;</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState*&gt;(this));</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l30.632"></a><span id="l30.632" class="difflineplus">+      do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState *&gt;(this));</span>
<a href="#l30.633"></a><span id="l30.633">   result = folder-&gt;TestSemaphore(supports, &amp;haveSemaphore);</span>
<a href="#l30.634"></a><span id="l30.634">   if (NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineminus">-    (void) folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineplus">+    (void)folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l30.637"></a><span id="l30.637"> }</span>
<a href="#l30.638"></a><span id="l30.638"> </span>
<a href="#l30.639"></a><span id="l30.639" class="difflineminus">-nsresult</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineminus">-nsMsgMailboxParser::AcquireFolderLock()</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineminus">-{</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineplus">+nsresult nsMsgMailboxParser::AcquireFolderLock() {</span>
<a href="#l30.643"></a><span id="l30.643">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineminus">-  if (!folder)</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineplus">+  if (!folder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.647"></a><span id="l30.647">   nsCOMPtr&lt;nsISupports&gt; supports = do_QueryObject(this);</span>
<a href="#l30.648"></a><span id="l30.648">   return folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l30.649"></a><span id="l30.649"> }</span>
<a href="#l30.650"></a><span id="l30.650"> </span>
<a href="#l30.651"></a><span id="l30.651" class="difflineminus">-NS_IMPL_ISUPPORTS(nsParseMailMessageState, nsIMsgParseMailMsgState, nsIDBChangeListener)</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineplus">+NS_IMPL_ISUPPORTS(nsParseMailMessageState, nsIMsgParseMailMsgState,</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineplus">+                  nsIDBChangeListener)</span>
<a href="#l30.654"></a><span id="l30.654"> </span>
<a href="#l30.655"></a><span id="l30.655" class="difflineminus">-nsParseMailMessageState::nsParseMailMessageState()</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineminus">-{</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineplus">+nsParseMailMessageState::nsParseMailMessageState() {</span>
<a href="#l30.658"></a><span id="l30.658">   m_position = 0;</span>
<a href="#l30.659"></a><span id="l30.659">   m_new_key = nsMsgKey_None;</span>
<a href="#l30.660"></a><span id="l30.660">   m_IgnoreXMozillaStatus = false;</span>
<a href="#l30.661"></a><span id="l30.661">   m_state = nsIMsgParseMailMsgState::ParseBodyState;</span>
<a href="#l30.662"></a><span id="l30.662"> </span>
<a href="#l30.663"></a><span id="l30.663">   // setup handling of custom db headers, headers that are added to .msf files</span>
<a href="#l30.664"></a><span id="l30.664">   // as properties of the nsMsgHdr objects, controlled by the</span>
<a href="#l30.665"></a><span id="l30.665">   // pref mailnews.customDBHeaders, a space-delimited list of headers.</span>
<a href="#l30.666"></a><span id="l30.666">   // E.g., if mailnews.customDBHeaders is &quot;X-Spam-Score&quot;, and we're parsing</span>
<a href="#l30.667"></a><span id="l30.667">   // a mail message with the X-Spam-Score header, we'll set the</span>
<a href="#l30.668"></a><span id="l30.668">   // &quot;x-spam-score&quot; property of nsMsgHdr to the value of the header.</span>
<a href="#l30.669"></a><span id="l30.669">   m_customDBHeaderValues = nullptr;</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineminus">-  nsCString customDBHeaders; // not shown in search UI</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineplus">+  nsCString customDBHeaders;  // not shown in search UI</span>
<a href="#l30.672"></a><span id="l30.672">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineminus">-  {</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineminus">-     pPrefBranch-&gt;GetCharPref(&quot;mailnews.customDBHeaders&quot;, customDBHeaders);</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineminus">-     ToLowerCase(customDBHeaders);</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineminus">-     if (customDBHeaders.Find(&quot;content-base&quot;) == -1)</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineplus">+    pPrefBranch-&gt;GetCharPref(&quot;mailnews.customDBHeaders&quot;, customDBHeaders);</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineplus">+    ToLowerCase(customDBHeaders);</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineplus">+    if (customDBHeaders.Find(&quot;content-base&quot;) == -1)</span>
<a href="#l30.682"></a><span id="l30.682">       customDBHeaders.InsertLiteral(&quot;content-base &quot;, 0);</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineminus">-     ParseString(customDBHeaders, ' ', m_customDBHeaders);</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineplus">+    ParseString(customDBHeaders, ' ', m_customDBHeaders);</span>
<a href="#l30.685"></a><span id="l30.685"> </span>
<a href="#l30.686"></a><span id="l30.686" class="difflineminus">-     // now add customHeaders</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineminus">-     nsCString customHeadersString; // shown in search UI</span>
<a href="#l30.688"></a><span id="l30.688" class="difflineminus">-     nsTArray&lt;nsCString&gt; customHeadersArray;</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineminus">-     pPrefBranch-&gt;GetCharPref(&quot;mailnews.customHeaders&quot;, customHeadersString);</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineminus">-     ToLowerCase(customHeadersString);</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineminus">-     customHeadersString.StripWhitespace();</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineminus">-     ParseString(customHeadersString, ':', customHeadersArray);</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineminus">-     for (uint32_t i = 0; i &lt; customHeadersArray.Length(); i++)</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineminus">-     {</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineminus">-       if (!m_customDBHeaders.Contains(customHeadersArray[i]))</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineminus">-         m_customDBHeaders.AppendElement(customHeadersArray[i]);</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineminus">-     }</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineplus">+    // now add customHeaders</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineplus">+    nsCString customHeadersString;  // shown in search UI</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineplus">+    nsTArray&lt;nsCString&gt; customHeadersArray;</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineplus">+    pPrefBranch-&gt;GetCharPref(&quot;mailnews.customHeaders&quot;, customHeadersString);</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineplus">+    ToLowerCase(customHeadersString);</span>
<a href="#l30.703"></a><span id="l30.703" class="difflineplus">+    customHeadersString.StripWhitespace();</span>
<a href="#l30.704"></a><span id="l30.704" class="difflineplus">+    ParseString(customHeadersString, ':', customHeadersArray);</span>
<a href="#l30.705"></a><span id="l30.705" class="difflineplus">+    for (uint32_t i = 0; i &lt; customHeadersArray.Length(); i++) {</span>
<a href="#l30.706"></a><span id="l30.706" class="difflineplus">+      if (!m_customDBHeaders.Contains(customHeadersArray[i]))</span>
<a href="#l30.707"></a><span id="l30.707" class="difflineplus">+        m_customDBHeaders.AppendElement(customHeadersArray[i]);</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineplus">+    }</span>
<a href="#l30.709"></a><span id="l30.709"> </span>
<a href="#l30.710"></a><span id="l30.710" class="difflineminus">-     if (m_customDBHeaders.Length())</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineminus">-     {</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineminus">-       m_customDBHeaderValues = new struct message_header [m_customDBHeaders.Length()];</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineminus">-       if (!m_customDBHeaderValues)</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineminus">-         m_customDBHeaders.Clear();</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineminus">-     }</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineplus">+    if (m_customDBHeaders.Length()) {</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineplus">+      m_customDBHeaderValues =</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineplus">+          new struct message_header[m_customDBHeaders.Length()];</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineplus">+      if (!m_customDBHeaderValues) m_customDBHeaders.Clear();</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineplus">+    }</span>
<a href="#l30.721"></a><span id="l30.721">   }</span>
<a href="#l30.722"></a><span id="l30.722">   Clear();</span>
<a href="#l30.723"></a><span id="l30.723"> }</span>
<a href="#l30.724"></a><span id="l30.724"> </span>
<a href="#l30.725"></a><span id="l30.725" class="difflineminus">-nsParseMailMessageState::~nsParseMailMessageState()</span>
<a href="#l30.726"></a><span id="l30.726" class="difflineminus">-{</span>
<a href="#l30.727"></a><span id="l30.727" class="difflineminus">-  ClearAggregateHeader (m_toList);</span>
<a href="#l30.728"></a><span id="l30.728" class="difflineminus">-  ClearAggregateHeader (m_ccList);</span>
<a href="#l30.729"></a><span id="l30.729" class="difflineminus">-  delete [] m_customDBHeaderValues;</span>
<a href="#l30.730"></a><span id="l30.730" class="difflineplus">+nsParseMailMessageState::~nsParseMailMessageState() {</span>
<a href="#l30.731"></a><span id="l30.731" class="difflineplus">+  ClearAggregateHeader(m_toList);</span>
<a href="#l30.732"></a><span id="l30.732" class="difflineplus">+  ClearAggregateHeader(m_ccList);</span>
<a href="#l30.733"></a><span id="l30.733" class="difflineplus">+  delete[] m_customDBHeaderValues;</span>
<a href="#l30.734"></a><span id="l30.734"> }</span>
<a href="#l30.735"></a><span id="l30.735"> </span>
<a href="#l30.736"></a><span id="l30.736" class="difflineminus">-void nsParseMailMessageState::Init(uint64_t fileposition)</span>
<a href="#l30.737"></a><span id="l30.737" class="difflineminus">-{</span>
<a href="#l30.738"></a><span id="l30.738" class="difflineplus">+void nsParseMailMessageState::Init(uint64_t fileposition) {</span>
<a href="#l30.739"></a><span id="l30.739">   m_state = nsIMsgParseMailMsgState::ParseBodyState;</span>
<a href="#l30.740"></a><span id="l30.740">   m_position = fileposition;</span>
<a href="#l30.741"></a><span id="l30.741">   m_newMsgHdr = nullptr;</span>
<a href="#l30.742"></a><span id="l30.742"> }</span>
<a href="#l30.743"></a><span id="l30.743"> </span>
<a href="#l30.744"></a><span id="l30.744" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::Clear()</span>
<a href="#l30.745"></a><span id="l30.745" class="difflineminus">-{</span>
<a href="#l30.746"></a><span id="l30.746" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::Clear() {</span>
<a href="#l30.747"></a><span id="l30.747">   m_message_id.length = 0;</span>
<a href="#l30.748"></a><span id="l30.748">   m_references.length = 0;</span>
<a href="#l30.749"></a><span id="l30.749">   m_date.length = 0;</span>
<a href="#l30.750"></a><span id="l30.750">   m_delivery_date.length = 0;</span>
<a href="#l30.751"></a><span id="l30.751">   m_from.length = 0;</span>
<a href="#l30.752"></a><span id="l30.752">   m_sender.length = 0;</span>
<a href="#l30.753"></a><span id="l30.753">   m_newsgroups.length = 0;</span>
<a href="#l30.754"></a><span id="l30.754">   m_subject.length = 0;</span>
<a href="#l30.755"></a><span id="l30.755" class="difflineat">@@ -590,144 +537,128 @@ NS_IMETHODIMP nsParseMailMessageState::C</span>
<a href="#l30.756"></a><span id="l30.756">   m_content_type.length = 0;</span>
<a href="#l30.757"></a><span id="l30.757">   m_mdn_original_recipient.length = 0;</span>
<a href="#l30.758"></a><span id="l30.758">   m_bccList.length = 0;</span>
<a href="#l30.759"></a><span id="l30.759">   m_body_lines = 0;</span>
<a href="#l30.760"></a><span id="l30.760">   m_lastLineBlank = 0;</span>
<a href="#l30.761"></a><span id="l30.761">   m_newMsgHdr = nullptr;</span>
<a href="#l30.762"></a><span id="l30.762">   m_envelope_pos = 0;</span>
<a href="#l30.763"></a><span id="l30.763">   m_new_key = nsMsgKey_None;</span>
<a href="#l30.764"></a><span id="l30.764" class="difflineminus">-  ClearAggregateHeader (m_toList);</span>
<a href="#l30.765"></a><span id="l30.765" class="difflineminus">-  ClearAggregateHeader (m_ccList);</span>
<a href="#l30.766"></a><span id="l30.766" class="difflineplus">+  ClearAggregateHeader(m_toList);</span>
<a href="#l30.767"></a><span id="l30.767" class="difflineplus">+  ClearAggregateHeader(m_ccList);</span>
<a href="#l30.768"></a><span id="l30.768">   m_headers.ResetWritePos();</span>
<a href="#l30.769"></a><span id="l30.769">   m_envelope.ResetWritePos();</span>
<a href="#l30.770"></a><span id="l30.770">   m_receivedTime = 0;</span>
<a href="#l30.771"></a><span id="l30.771">   m_receivedValue.Truncate();</span>
<a href="#l30.772"></a><span id="l30.772">   for (uint32_t i = 0; i &lt; m_customDBHeaders.Length(); i++)</span>
<a href="#l30.773"></a><span id="l30.773">     m_customDBHeaderValues[i].length = 0;</span>
<a href="#l30.774"></a><span id="l30.774"> </span>
<a href="#l30.775"></a><span id="l30.775">   return NS_OK;</span>
<a href="#l30.776"></a><span id="l30.776"> }</span>
<a href="#l30.777"></a><span id="l30.777"> </span>
<a href="#l30.778"></a><span id="l30.778" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetState(nsMailboxParseState aState)</span>
<a href="#l30.779"></a><span id="l30.779" class="difflineminus">-{</span>
<a href="#l30.780"></a><span id="l30.780" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetState(nsMailboxParseState aState) {</span>
<a href="#l30.781"></a><span id="l30.781">   m_state = aState;</span>
<a href="#l30.782"></a><span id="l30.782">   return NS_OK;</span>
<a href="#l30.783"></a><span id="l30.783"> }</span>
<a href="#l30.784"></a><span id="l30.784"> </span>
<a href="#l30.785"></a><span id="l30.785" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::GetState(nsMailboxParseState *aState)</span>
<a href="#l30.786"></a><span id="l30.786" class="difflineminus">-{</span>
<a href="#l30.787"></a><span id="l30.787" class="difflineminus">-  if (!aState)</span>
<a href="#l30.788"></a><span id="l30.788" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.789"></a><span id="l30.789" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::GetState(nsMailboxParseState *aState) {</span>
<a href="#l30.790"></a><span id="l30.790" class="difflineplus">+  if (!aState) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.791"></a><span id="l30.791"> </span>
<a href="#l30.792"></a><span id="l30.792">   *aState = m_state;</span>
<a href="#l30.793"></a><span id="l30.793">   return NS_OK;</span>
<a href="#l30.794"></a><span id="l30.794"> }</span>
<a href="#l30.795"></a><span id="l30.795"> </span>
<a href="#l30.796"></a><span id="l30.796"> NS_IMETHODIMP</span>
<a href="#l30.797"></a><span id="l30.797" class="difflineminus">-nsParseMailMessageState::GetEnvelopePos(uint64_t *aEnvelopePos)</span>
<a href="#l30.798"></a><span id="l30.798" class="difflineminus">-{</span>
<a href="#l30.799"></a><span id="l30.799" class="difflineplus">+nsParseMailMessageState::GetEnvelopePos(uint64_t *aEnvelopePos) {</span>
<a href="#l30.800"></a><span id="l30.800">   NS_ENSURE_ARG_POINTER(aEnvelopePos);</span>
<a href="#l30.801"></a><span id="l30.801"> </span>
<a href="#l30.802"></a><span id="l30.802">   *aEnvelopePos = m_envelope_pos;</span>
<a href="#l30.803"></a><span id="l30.803">   return NS_OK;</span>
<a href="#l30.804"></a><span id="l30.804"> }</span>
<a href="#l30.805"></a><span id="l30.805"> </span>
<a href="#l30.806"></a><span id="l30.806" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetEnvelopePos(uint64_t aEnvelopePos)</span>
<a href="#l30.807"></a><span id="l30.807" class="difflineminus">-{</span>
<a href="#l30.808"></a><span id="l30.808" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetEnvelopePos(uint64_t aEnvelopePos) {</span>
<a href="#l30.809"></a><span id="l30.809">   m_envelope_pos = aEnvelopePos;</span>
<a href="#l30.810"></a><span id="l30.810">   m_position = m_envelope_pos;</span>
<a href="#l30.811"></a><span id="l30.811">   m_headerstartpos = m_position;</span>
<a href="#l30.812"></a><span id="l30.812">   return NS_OK;</span>
<a href="#l30.813"></a><span id="l30.813"> }</span>
<a href="#l30.814"></a><span id="l30.814"> </span>
<a href="#l30.815"></a><span id="l30.815" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::GetNewMsgHdr(nsIMsgDBHdr ** aMsgHeader)</span>
<a href="#l30.816"></a><span id="l30.816" class="difflineminus">-{</span>
<a href="#l30.817"></a><span id="l30.817" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::GetNewMsgHdr(nsIMsgDBHdr **aMsgHeader) {</span>
<a href="#l30.818"></a><span id="l30.818">   NS_ENSURE_ARG_POINTER(aMsgHeader);</span>
<a href="#l30.819"></a><span id="l30.819">   NS_IF_ADDREF(*aMsgHeader = m_newMsgHdr);</span>
<a href="#l30.820"></a><span id="l30.820">   return m_newMsgHdr ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l30.821"></a><span id="l30.821"> }</span>
<a href="#l30.822"></a><span id="l30.822"> </span>
<a href="#l30.823"></a><span id="l30.823" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetNewMsgHdr(nsIMsgDBHdr *aMsgHeader)</span>
<a href="#l30.824"></a><span id="l30.824" class="difflineminus">-{</span>
<a href="#l30.825"></a><span id="l30.825" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetNewMsgHdr(nsIMsgDBHdr *aMsgHeader) {</span>
<a href="#l30.826"></a><span id="l30.826">   m_newMsgHdr = aMsgHeader;</span>
<a href="#l30.827"></a><span id="l30.827">   return NS_OK;</span>
<a href="#l30.828"></a><span id="l30.828"> }</span>
<a href="#l30.829"></a><span id="l30.829"> </span>
<a href="#l30.830"></a><span id="l30.830" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::ParseAFolderLine(const char *line, uint32_t lineLength)</span>
<a href="#l30.831"></a><span id="l30.831" class="difflineminus">-{</span>
<a href="#l30.832"></a><span id="l30.832" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::ParseAFolderLine(const char *line,</span>
<a href="#l30.833"></a><span id="l30.833" class="difflineplus">+                                                        uint32_t lineLength) {</span>
<a href="#l30.834"></a><span id="l30.834">   ParseFolderLine(line, lineLength);</span>
<a href="#l30.835"></a><span id="l30.835">   return NS_OK;</span>
<a href="#l30.836"></a><span id="l30.836"> }</span>
<a href="#l30.837"></a><span id="l30.837"> </span>
<a href="#l30.838"></a><span id="l30.838" class="difflineminus">-nsresult nsParseMailMessageState::ParseFolderLine(const char *line, uint32_t lineLength)</span>
<a href="#l30.839"></a><span id="l30.839" class="difflineminus">-{</span>
<a href="#l30.840"></a><span id="l30.840" class="difflineplus">+nsresult nsParseMailMessageState::ParseFolderLine(const char *line,</span>
<a href="#l30.841"></a><span id="l30.841" class="difflineplus">+                                                  uint32_t lineLength) {</span>
<a href="#l30.842"></a><span id="l30.842">   nsresult rv;</span>
<a href="#l30.843"></a><span id="l30.843"> </span>
<a href="#l30.844"></a><span id="l30.844" class="difflineminus">-  if (m_state == nsIMsgParseMailMsgState::ParseHeadersState)</span>
<a href="#l30.845"></a><span id="l30.845" class="difflineminus">-  {</span>
<a href="#l30.846"></a><span id="l30.846" class="difflineminus">-    if (EMPTY_MESSAGE_LINE(line))</span>
<a href="#l30.847"></a><span id="l30.847" class="difflineminus">-    {</span>
<a href="#l30.848"></a><span id="l30.848" class="difflineplus">+  if (m_state == nsIMsgParseMailMsgState::ParseHeadersState) {</span>
<a href="#l30.849"></a><span id="l30.849" class="difflineplus">+    if (EMPTY_MESSAGE_LINE(line)) {</span>
<a href="#l30.850"></a><span id="l30.850">       /* End of headers.  Now parse them. */</span>
<a href="#l30.851"></a><span id="l30.851">       rv = ParseHeaders();</span>
<a href="#l30.852"></a><span id="l30.852">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;error parsing headers parsing mailbox&quot;);</span>
<a href="#l30.853"></a><span id="l30.853">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.854"></a><span id="l30.854"> </span>
<a href="#l30.855"></a><span id="l30.855">       rv = FinalizeHeaders();</span>
<a href="#l30.856"></a><span id="l30.856" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;error finalizing headers parsing mailbox&quot;);</span>
<a href="#l30.857"></a><span id="l30.857" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l30.858"></a><span id="l30.858" class="difflineplus">+                   &quot;error finalizing headers parsing mailbox&quot;);</span>
<a href="#l30.859"></a><span id="l30.859">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.860"></a><span id="l30.860"> </span>
<a href="#l30.861"></a><span id="l30.861">       m_state = nsIMsgParseMailMsgState::ParseBodyState;</span>
<a href="#l30.862"></a><span id="l30.862" class="difflineminus">-    }</span>
<a href="#l30.863"></a><span id="l30.863" class="difflineminus">-    else</span>
<a href="#l30.864"></a><span id="l30.864" class="difflineminus">-    {</span>
<a href="#l30.865"></a><span id="l30.865" class="difflineplus">+    } else {</span>
<a href="#l30.866"></a><span id="l30.866">       /* Otherwise, this line belongs to a header.  So append it to the</span>
<a href="#l30.867"></a><span id="l30.867">          header data, and stay in MBOX `MIME_PARSE_HEADERS' state.</span>
<a href="#l30.868"></a><span id="l30.868">       */</span>
<a href="#l30.869"></a><span id="l30.869">       m_headers.AppendBuffer(line, lineLength);</span>
<a href="#l30.870"></a><span id="l30.870">     }</span>
<a href="#l30.871"></a><span id="l30.871" class="difflineminus">-  }</span>
<a href="#l30.872"></a><span id="l30.872" class="difflineminus">-  else if ( m_state == nsIMsgParseMailMsgState::ParseBodyState)</span>
<a href="#l30.873"></a><span id="l30.873" class="difflineminus">-  {</span>
<a href="#l30.874"></a><span id="l30.874" class="difflineplus">+  } else if (m_state == nsIMsgParseMailMsgState::ParseBodyState) {</span>
<a href="#l30.875"></a><span id="l30.875">     m_body_lines++;</span>
<a href="#l30.876"></a><span id="l30.876">     // See comment in msgCore.h for why we use `IS_MSG_LINEBREAK` rather than</span>
<a href="#l30.877"></a><span id="l30.877">     // just comparing `line` to `MSG_LINEBREAK`.</span>
<a href="#l30.878"></a><span id="l30.878">     m_lastLineBlank = IS_MSG_LINEBREAK(line);</span>
<a href="#l30.879"></a><span id="l30.879">   }</span>
<a href="#l30.880"></a><span id="l30.880"> </span>
<a href="#l30.881"></a><span id="l30.881">   m_position += lineLength;</span>
<a href="#l30.882"></a><span id="l30.882"> </span>
<a href="#l30.883"></a><span id="l30.883">   return NS_OK;</span>
<a href="#l30.884"></a><span id="l30.884"> }</span>
<a href="#l30.885"></a><span id="l30.885"> </span>
<a href="#l30.886"></a><span id="l30.886" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetMailDB(nsIMsgDatabase *mailDB)</span>
<a href="#l30.887"></a><span id="l30.887" class="difflineminus">-{</span>
<a href="#l30.888"></a><span id="l30.888" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetMailDB(nsIMsgDatabase *mailDB) {</span>
<a href="#l30.889"></a><span id="l30.889">   m_mailDB = mailDB;</span>
<a href="#l30.890"></a><span id="l30.890">   return NS_OK;</span>
<a href="#l30.891"></a><span id="l30.891"> }</span>
<a href="#l30.892"></a><span id="l30.892"> </span>
<a href="#l30.893"></a><span id="l30.893" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetBackupMailDB(nsIMsgDatabase *aBackupMailDB)</span>
<a href="#l30.894"></a><span id="l30.894" class="difflineminus">-{</span>
<a href="#l30.895"></a><span id="l30.895" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetBackupMailDB(</span>
<a href="#l30.896"></a><span id="l30.896" class="difflineplus">+    nsIMsgDatabase *aBackupMailDB) {</span>
<a href="#l30.897"></a><span id="l30.897">   m_backupMailDB = aBackupMailDB;</span>
<a href="#l30.898"></a><span id="l30.898" class="difflineminus">-  if (m_backupMailDB)</span>
<a href="#l30.899"></a><span id="l30.899" class="difflineminus">-    m_backupMailDB-&gt;AddListener(this);</span>
<a href="#l30.900"></a><span id="l30.900" class="difflineplus">+  if (m_backupMailDB) m_backupMailDB-&gt;AddListener(this);</span>
<a href="#l30.901"></a><span id="l30.901">   return NS_OK;</span>
<a href="#l30.902"></a><span id="l30.902"> }</span>
<a href="#l30.903"></a><span id="l30.903"> </span>
<a href="#l30.904"></a><span id="l30.904" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetNewKey(nsMsgKey aKey)</span>
<a href="#l30.905"></a><span id="l30.905" class="difflineminus">-{</span>
<a href="#l30.906"></a><span id="l30.906" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetNewKey(nsMsgKey aKey) {</span>
<a href="#l30.907"></a><span id="l30.907">   m_new_key = aKey;</span>
<a href="#l30.908"></a><span id="l30.908">   return NS_OK;</span>
<a href="#l30.909"></a><span id="l30.909"> }</span>
<a href="#l30.910"></a><span id="l30.910"> </span>
<a href="#l30.911"></a><span id="l30.911"> /* #define STRICT_ENVELOPE */</span>
<a href="#l30.912"></a><span id="l30.912"> </span>
<a href="#l30.913"></a><span id="l30.913" class="difflineminus">-bool</span>
<a href="#l30.914"></a><span id="l30.914" class="difflineminus">-nsParseMailMessageState::IsEnvelopeLine(const char *buf, int32_t buf_size)</span>
<a href="#l30.915"></a><span id="l30.915" class="difflineminus">-{</span>
<a href="#l30.916"></a><span id="l30.916" class="difflineplus">+bool nsParseMailMessageState::IsEnvelopeLine(const char *buf,</span>
<a href="#l30.917"></a><span id="l30.917" class="difflineplus">+                                             int32_t buf_size) {</span>
<a href="#l30.918"></a><span id="l30.918"> #ifdef STRICT_ENVELOPE</span>
<a href="#l30.919"></a><span id="l30.919">   /* The required format is</span>
<a href="#l30.920"></a><span id="l30.920">      From jwz  Fri Jul  1 09:13:09 1994</span>
<a href="#l30.921"></a><span id="l30.921">    But we should also allow at least:</span>
<a href="#l30.922"></a><span id="l30.922">      From jwz  Fri, Jul 01 09:13:09 1994</span>
<a href="#l30.923"></a><span id="l30.923">      From jwz  Fri Jul  1 09:13:09 1994 PST</span>
<a href="#l30.924"></a><span id="l30.924">      From jwz  Fri Jul  1 09:13:09 1994 (+0700)</span>
<a href="#l30.925"></a><span id="l30.925"> </span>
<a href="#l30.926"></a><span id="l30.926" class="difflineat">@@ -744,486 +675,442 @@ nsParseMailMessageState::IsEnvelopeLine(</span>
<a href="#l30.927"></a><span id="l30.927">   if (buf_size &lt; 29) return false;</span>
<a href="#l30.928"></a><span id="l30.928">   if (*buf != 'F') return false;</span>
<a href="#l30.929"></a><span id="l30.929">   if (strncmp(buf, &quot;From &quot;, 5)) return false;</span>
<a href="#l30.930"></a><span id="l30.930"> </span>
<a href="#l30.931"></a><span id="l30.931">   end = buf + buf_size;</span>
<a href="#l30.932"></a><span id="l30.932">   date = buf + 5;</span>
<a href="#l30.933"></a><span id="l30.933"> </span>
<a href="#l30.934"></a><span id="l30.934">   /* Skip horizontal whitespace between &quot;From &quot; and user name. */</span>
<a href="#l30.935"></a><span id="l30.935" class="difflineminus">-  while ((*date == ' ' || *date == '\t') &amp;&amp; date &lt; end)</span>
<a href="#l30.936"></a><span id="l30.936" class="difflineminus">-  date++;</span>
<a href="#l30.937"></a><span id="l30.937" class="difflineplus">+  while ((*date == ' ' || *date == '\t') &amp;&amp; date &lt; end) date++;</span>
<a href="#l30.938"></a><span id="l30.938"> </span>
<a href="#l30.939"></a><span id="l30.939">   /* If at the end, it doesn't match. */</span>
<a href="#l30.940"></a><span id="l30.940" class="difflineminus">-  if (IS_SPACE(*date) || date == end)</span>
<a href="#l30.941"></a><span id="l30.941" class="difflineminus">-  return false;</span>
<a href="#l30.942"></a><span id="l30.942" class="difflineplus">+  if (IS_SPACE(*date) || date == end) return false;</span>
<a href="#l30.943"></a><span id="l30.943"> </span>
<a href="#l30.944"></a><span id="l30.944">   /* Skip over user name. */</span>
<a href="#l30.945"></a><span id="l30.945" class="difflineminus">-  while (!IS_SPACE(*date) &amp;&amp; date &lt; end)</span>
<a href="#l30.946"></a><span id="l30.946" class="difflineminus">-  date++;</span>
<a href="#l30.947"></a><span id="l30.947" class="difflineplus">+  while (!IS_SPACE(*date) &amp;&amp; date &lt; end) date++;</span>
<a href="#l30.948"></a><span id="l30.948"> </span>
<a href="#l30.949"></a><span id="l30.949">   /* Skip horizontal whitespace between user name and date. */</span>
<a href="#l30.950"></a><span id="l30.950" class="difflineminus">-  while ((*date == ' ' || *date == '\t') &amp;&amp; date &lt; end)</span>
<a href="#l30.951"></a><span id="l30.951" class="difflineminus">-  date++;</span>
<a href="#l30.952"></a><span id="l30.952" class="difflineplus">+  while ((*date == ' ' || *date == '\t') &amp;&amp; date &lt; end) date++;</span>
<a href="#l30.953"></a><span id="l30.953"> </span>
<a href="#l30.954"></a><span id="l30.954" class="difflineminus">-  /* Don't want this to be localized. */</span>
<a href="#l30.955"></a><span id="l30.955" class="difflineminus">-# define TMP_ISALPHA(x) (((x) &gt;= 'A' &amp;&amp; (x) &lt;= 'Z') || \</span>
<a href="#l30.956"></a><span id="l30.956" class="difflineminus">-             ((x) &gt;= 'a' &amp;&amp; (x) &lt;= 'z'))</span>
<a href="#l30.957"></a><span id="l30.957" class="difflineplus">+    /* Don't want this to be localized. */</span>
<a href="#l30.958"></a><span id="l30.958" class="difflineplus">+#  define TMP_ISALPHA(x) \</span>
<a href="#l30.959"></a><span id="l30.959" class="difflineplus">+    (((x) &gt;= 'A' &amp;&amp; (x) &lt;= 'Z') || ((x) &gt;= 'a' &amp;&amp; (x) &lt;= 'z'))</span>
<a href="#l30.960"></a><span id="l30.960"> </span>
<a href="#l30.961"></a><span id="l30.961">   /* take off day-of-the-week. */</span>
<a href="#l30.962"></a><span id="l30.962" class="difflineminus">-  if (date &gt;= end - 3)</span>
<a href="#l30.963"></a><span id="l30.963" class="difflineminus">-  return false;</span>
<a href="#l30.964"></a><span id="l30.964" class="difflineplus">+  if (date &gt;= end - 3) return false;</span>
<a href="#l30.965"></a><span id="l30.965">   if (!TMP_ISALPHA(date[0]) || !TMP_ISALPHA(date[1]) || !TMP_ISALPHA(date[2]))</span>
<a href="#l30.966"></a><span id="l30.966" class="difflineminus">-  return false;</span>
<a href="#l30.967"></a><span id="l30.967" class="difflineplus">+    return false;</span>
<a href="#l30.968"></a><span id="l30.968">   date += 3;</span>
<a href="#l30.969"></a><span id="l30.969">   /* Skip horizontal whitespace (and commas) between dotw and month. */</span>
<a href="#l30.970"></a><span id="l30.970" class="difflineminus">-  if (*date != ' ' &amp;&amp; *date != '\t' &amp;&amp; *date != ',')</span>
<a href="#l30.971"></a><span id="l30.971" class="difflineminus">-  return false;</span>
<a href="#l30.972"></a><span id="l30.972" class="difflineminus">-  while ((*date == ' ' || *date == '\t' || *date == ',') &amp;&amp; date &lt; end)</span>
<a href="#l30.973"></a><span id="l30.973" class="difflineminus">-  date++;</span>
<a href="#l30.974"></a><span id="l30.974" class="difflineplus">+  if (*date != ' ' &amp;&amp; *date != '\t' &amp;&amp; *date != ',') return false;</span>
<a href="#l30.975"></a><span id="l30.975" class="difflineplus">+  while ((*date == ' ' || *date == '\t' || *date == ',') &amp;&amp; date &lt; end) date++;</span>
<a href="#l30.976"></a><span id="l30.976"> </span>
<a href="#l30.977"></a><span id="l30.977">   /* take off month. */</span>
<a href="#l30.978"></a><span id="l30.978" class="difflineminus">-  if (date &gt;= end - 3)</span>
<a href="#l30.979"></a><span id="l30.979" class="difflineminus">-  return false;</span>
<a href="#l30.980"></a><span id="l30.980" class="difflineplus">+  if (date &gt;= end - 3) return false;</span>
<a href="#l30.981"></a><span id="l30.981">   if (!TMP_ISALPHA(date[0]) || !TMP_ISALPHA(date[1]) || !TMP_ISALPHA(date[2]))</span>
<a href="#l30.982"></a><span id="l30.982" class="difflineminus">-  return false;</span>
<a href="#l30.983"></a><span id="l30.983" class="difflineplus">+    return false;</span>
<a href="#l30.984"></a><span id="l30.984">   date += 3;</span>
<a href="#l30.985"></a><span id="l30.985">   /* Skip horizontal whitespace between month and dotm. */</span>
<a href="#l30.986"></a><span id="l30.986" class="difflineminus">-  if (date == end || (*date != ' ' &amp;&amp; *date != '\t'))</span>
<a href="#l30.987"></a><span id="l30.987" class="difflineminus">-  return false;</span>
<a href="#l30.988"></a><span id="l30.988" class="difflineminus">-  while ((*date == ' ' || *date == '\t') &amp;&amp; date &lt; end)</span>
<a href="#l30.989"></a><span id="l30.989" class="difflineminus">-  date++;</span>
<a href="#l30.990"></a><span id="l30.990" class="difflineplus">+  if (date == end || (*date != ' ' &amp;&amp; *date != '\t')) return false;</span>
<a href="#l30.991"></a><span id="l30.991" class="difflineplus">+  while ((*date == ' ' || *date == '\t') &amp;&amp; date &lt; end) date++;</span>
<a href="#l30.992"></a><span id="l30.992"> </span>
<a href="#l30.993"></a><span id="l30.993">   /* Skip over digits and whitespace. */</span>
<a href="#l30.994"></a><span id="l30.994">   while (((*date &gt;= '0' &amp;&amp; *date &lt;= '9') || *date == ' ' || *date == '\t') &amp;&amp;</span>
<a href="#l30.995"></a><span id="l30.995" class="difflineminus">-     date &lt; end)</span>
<a href="#l30.996"></a><span id="l30.996" class="difflineminus">-  date++;</span>
<a href="#l30.997"></a><span id="l30.997" class="difflineplus">+         date &lt; end)</span>
<a href="#l30.998"></a><span id="l30.998" class="difflineplus">+    date++;</span>
<a href="#l30.999"></a><span id="l30.999">   /* Next character should be a colon. */</span>
<a href="#l30.1000"></a><span id="l30.1000" class="difflineminus">-  if (date &gt;= end || *date != ':')</span>
<a href="#l30.1001"></a><span id="l30.1001" class="difflineminus">-  return false;</span>
<a href="#l30.1002"></a><span id="l30.1002" class="difflineplus">+  if (date &gt;= end || *date != ':') return false;</span>
<a href="#l30.1003"></a><span id="l30.1003"> </span>
<a href="#l30.1004"></a><span id="l30.1004" class="difflineminus">-  /* Ok, that ought to be enough... */</span>
<a href="#l30.1005"></a><span id="l30.1005" class="difflineplus">+    /* Ok, that ought to be enough... */</span>
<a href="#l30.1006"></a><span id="l30.1006"> </span>
<a href="#l30.1007"></a><span id="l30.1007" class="difflineminus">-# undef TMP_ISALPHA</span>
<a href="#l30.1008"></a><span id="l30.1008" class="difflineplus">+#  undef TMP_ISALPHA</span>
<a href="#l30.1009"></a><span id="l30.1009"> </span>
<a href="#l30.1010"></a><span id="l30.1010" class="difflineminus">-#else  /* !STRICT_ENVELOPE */</span>
<a href="#l30.1011"></a><span id="l30.1011" class="difflineplus">+#else /* !STRICT_ENVELOPE */</span>
<a href="#l30.1012"></a><span id="l30.1012"> </span>
<a href="#l30.1013"></a><span id="l30.1013">   if (buf_size &lt; 5) return false;</span>
<a href="#l30.1014"></a><span id="l30.1014">   if (*buf != 'F') return false;</span>
<a href="#l30.1015"></a><span id="l30.1015">   if (strncmp(buf, &quot;From &quot;, 5)) return false;</span>
<a href="#l30.1016"></a><span id="l30.1016"> </span>
<a href="#l30.1017"></a><span id="l30.1017"> #endif /* !STRICT_ENVELOPE */</span>
<a href="#l30.1018"></a><span id="l30.1018"> </span>
<a href="#l30.1019"></a><span id="l30.1019">   return true;</span>
<a href="#l30.1020"></a><span id="l30.1020"> }</span>
<a href="#l30.1021"></a><span id="l30.1021"> </span>
<a href="#l30.1022"></a><span id="l30.1022"> // We've found the start of the next message, so finish this one off.</span>
<a href="#l30.1023"></a><span id="l30.1023" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::FinishHeader()</span>
<a href="#l30.1024"></a><span id="l30.1024" class="difflineminus">-{</span>
<a href="#l30.1025"></a><span id="l30.1025" class="difflineminus">-  if (m_newMsgHdr)</span>
<a href="#l30.1026"></a><span id="l30.1026" class="difflineminus">-  {</span>
<a href="#l30.1027"></a><span id="l30.1027" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::FinishHeader() {</span>
<a href="#l30.1028"></a><span id="l30.1028" class="difflineplus">+  if (m_newMsgHdr) {</span>
<a href="#l30.1029"></a><span id="l30.1029">     m_newMsgHdr-&gt;SetMessageOffset(m_envelope_pos);</span>
<a href="#l30.1030"></a><span id="l30.1030" class="difflineminus">-    if (m_lastLineBlank)</span>
<a href="#l30.1031"></a><span id="l30.1031" class="difflineminus">-      m_body_lines--;</span>
<a href="#l30.1032"></a><span id="l30.1032" class="difflineplus">+    if (m_lastLineBlank) m_body_lines--;</span>
<a href="#l30.1033"></a><span id="l30.1033">     m_newMsgHdr-&gt;SetMessageSize(m_position - m_envelope_pos - m_lastLineBlank);</span>
<a href="#l30.1034"></a><span id="l30.1034">     m_newMsgHdr-&gt;SetLineCount(m_body_lines);</span>
<a href="#l30.1035"></a><span id="l30.1035">   }</span>
<a href="#l30.1036"></a><span id="l30.1036">   return NS_OK;</span>
<a href="#l30.1037"></a><span id="l30.1037"> }</span>
<a href="#l30.1038"></a><span id="l30.1038"> </span>
<a href="#l30.1039"></a><span id="l30.1039" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::GetAllHeaders(char ** pHeaders, int32_t *pHeadersSize)</span>
<a href="#l30.1040"></a><span id="l30.1040" class="difflineminus">-{</span>
<a href="#l30.1041"></a><span id="l30.1041" class="difflineminus">-  if (!pHeaders || !pHeadersSize)</span>
<a href="#l30.1042"></a><span id="l30.1042" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.1043"></a><span id="l30.1043" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::GetAllHeaders(char **pHeaders,</span>
<a href="#l30.1044"></a><span id="l30.1044" class="difflineplus">+                                                     int32_t *pHeadersSize) {</span>
<a href="#l30.1045"></a><span id="l30.1045" class="difflineplus">+  if (!pHeaders || !pHeadersSize) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.1046"></a><span id="l30.1046">   *pHeaders = m_headers.GetBuffer();</span>
<a href="#l30.1047"></a><span id="l30.1047">   *pHeadersSize = m_headers.GetBufferPos();</span>
<a href="#l30.1048"></a><span id="l30.1048">   return NS_OK;</span>
<a href="#l30.1049"></a><span id="l30.1049"> }</span>
<a href="#l30.1050"></a><span id="l30.1050"> </span>
<a href="#l30.1051"></a><span id="l30.1051"> // generate headers as a string, with CRLF between the headers</span>
<a href="#l30.1052"></a><span id="l30.1052" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::GetHeaders(char ** pHeaders)</span>
<a href="#l30.1053"></a><span id="l30.1053" class="difflineminus">-{</span>
<a href="#l30.1054"></a><span id="l30.1054" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::GetHeaders(char **pHeaders) {</span>
<a href="#l30.1055"></a><span id="l30.1055">   NS_ENSURE_ARG_POINTER(pHeaders);</span>
<a href="#l30.1056"></a><span id="l30.1056">   nsCString crlfHeaders;</span>
<a href="#l30.1057"></a><span id="l30.1057">   char *curHeader = m_headers.GetBuffer();</span>
<a href="#l30.1058"></a><span id="l30.1058" class="difflineminus">-  for (uint32_t headerPos = 0; headerPos &lt; m_headers.GetBufferPos();)</span>
<a href="#l30.1059"></a><span id="l30.1059" class="difflineminus">-  {</span>
<a href="#l30.1060"></a><span id="l30.1060" class="difflineplus">+  for (uint32_t headerPos = 0; headerPos &lt; m_headers.GetBufferPos();) {</span>
<a href="#l30.1061"></a><span id="l30.1061">     crlfHeaders.Append(curHeader);</span>
<a href="#l30.1062"></a><span id="l30.1062">     crlfHeaders.Append(CRLF);</span>
<a href="#l30.1063"></a><span id="l30.1063">     int32_t headerLen = strlen(curHeader);</span>
<a href="#l30.1064"></a><span id="l30.1064">     curHeader += headerLen + 1;</span>
<a href="#l30.1065"></a><span id="l30.1065">     headerPos += headerLen + 1;</span>
<a href="#l30.1066"></a><span id="l30.1066">   }</span>
<a href="#l30.1067"></a><span id="l30.1067">   *pHeaders = ToNewCString(crlfHeaders);</span>
<a href="#l30.1068"></a><span id="l30.1068">   return NS_OK;</span>
<a href="#l30.1069"></a><span id="l30.1069"> }</span>
<a href="#l30.1070"></a><span id="l30.1070"> </span>
<a href="#l30.1071"></a><span id="l30.1071" class="difflineminus">-struct message_header *nsParseMailMessageState::GetNextHeaderInAggregate (nsTArray&lt;struct message_header*&gt; &amp;list)</span>
<a href="#l30.1072"></a><span id="l30.1072" class="difflineminus">-{</span>
<a href="#l30.1073"></a><span id="l30.1073" class="difflineminus">-  // When parsing a message with multiple To or CC header lines, we're storing each line in a</span>
<a href="#l30.1074"></a><span id="l30.1074" class="difflineminus">-  // list, where the list represents the &quot;aggregate&quot; total of all the header. Here we get a new</span>
<a href="#l30.1075"></a><span id="l30.1075" class="difflineminus">-  // line for the list</span>
<a href="#l30.1076"></a><span id="l30.1076" class="difflineplus">+struct message_header *nsParseMailMessageState::GetNextHeaderInAggregate(</span>
<a href="#l30.1077"></a><span id="l30.1077" class="difflineplus">+    nsTArray&lt;struct message_header *&gt; &amp;list) {</span>
<a href="#l30.1078"></a><span id="l30.1078" class="difflineplus">+  // When parsing a message with multiple To or CC header lines, we're storing</span>
<a href="#l30.1079"></a><span id="l30.1079" class="difflineplus">+  // each line in a list, where the list represents the &quot;aggregate&quot; total of all</span>
<a href="#l30.1080"></a><span id="l30.1080" class="difflineplus">+  // the header. Here we get a new line for the list</span>
<a href="#l30.1081"></a><span id="l30.1081"> </span>
<a href="#l30.1082"></a><span id="l30.1082" class="difflineminus">-  struct message_header *header = (struct message_header*) PR_Calloc (1, sizeof(struct message_header));</span>
<a href="#l30.1083"></a><span id="l30.1083" class="difflineminus">-  list.AppendElement (header);</span>
<a href="#l30.1084"></a><span id="l30.1084" class="difflineplus">+  struct message_header *header =</span>
<a href="#l30.1085"></a><span id="l30.1085" class="difflineplus">+      (struct message_header *)PR_Calloc(1, sizeof(struct message_header));</span>
<a href="#l30.1086"></a><span id="l30.1086" class="difflineplus">+  list.AppendElement(header);</span>
<a href="#l30.1087"></a><span id="l30.1087">   return header;</span>
<a href="#l30.1088"></a><span id="l30.1088"> }</span>
<a href="#l30.1089"></a><span id="l30.1089"> </span>
<a href="#l30.1090"></a><span id="l30.1090" class="difflineminus">-void nsParseMailMessageState::GetAggregateHeader (nsTArray&lt;struct message_header*&gt; &amp;list, struct message_header *outHeader)</span>
<a href="#l30.1091"></a><span id="l30.1091" class="difflineminus">-{</span>
<a href="#l30.1092"></a><span id="l30.1092" class="difflineminus">-  // When parsing a message with multiple To or CC header lines, we're storing each line in a</span>
<a href="#l30.1093"></a><span id="l30.1093" class="difflineminus">-  // list, where the list represents the &quot;aggregate&quot; total of all the header. Here we combine</span>
<a href="#l30.1094"></a><span id="l30.1094" class="difflineminus">-  // all the lines together, as though they were really all found on the same line</span>
<a href="#l30.1095"></a><span id="l30.1095" class="difflineplus">+void nsParseMailMessageState::GetAggregateHeader(</span>
<a href="#l30.1096"></a><span id="l30.1096" class="difflineplus">+    nsTArray&lt;struct message_header *&gt; &amp;list, struct message_header *outHeader) {</span>
<a href="#l30.1097"></a><span id="l30.1097" class="difflineplus">+  // When parsing a message with multiple To or CC header lines, we're storing</span>
<a href="#l30.1098"></a><span id="l30.1098" class="difflineplus">+  // each line in a list, where the list represents the &quot;aggregate&quot; total of all</span>
<a href="#l30.1099"></a><span id="l30.1099" class="difflineplus">+  // the header. Here we combine all the lines together, as though they were</span>
<a href="#l30.1100"></a><span id="l30.1100" class="difflineplus">+  // really all found on the same line</span>
<a href="#l30.1101"></a><span id="l30.1101"> </span>
<a href="#l30.1102"></a><span id="l30.1102">   struct message_header *header = nullptr;</span>
<a href="#l30.1103"></a><span id="l30.1103">   int length = 0;</span>
<a href="#l30.1104"></a><span id="l30.1104">   size_t i;</span>
<a href="#l30.1105"></a><span id="l30.1105"> </span>
<a href="#l30.1106"></a><span id="l30.1106">   // Count up the bytes required to allocate the aggregated header</span>
<a href="#l30.1107"></a><span id="l30.1107" class="difflineminus">-  for (i = 0; i &lt; list.Length(); i++)</span>
<a href="#l30.1108"></a><span id="l30.1108" class="difflineminus">-  {</span>
<a href="#l30.1109"></a><span id="l30.1109" class="difflineplus">+  for (i = 0; i &lt; list.Length(); i++) {</span>
<a href="#l30.1110"></a><span id="l30.1110">     header = list.ElementAt(i);</span>
<a href="#l30.1111"></a><span id="l30.1111" class="difflineminus">-    length += (header-&gt;length + 1); //+ for &quot;,&quot;</span>
<a href="#l30.1112"></a><span id="l30.1112" class="difflineplus">+    length += (header-&gt;length + 1);  //+ for &quot;,&quot;</span>
<a href="#l30.1113"></a><span id="l30.1113">   }</span>
<a href="#l30.1114"></a><span id="l30.1114"> </span>
<a href="#l30.1115"></a><span id="l30.1115" class="difflineminus">-  if (length &gt; 0)</span>
<a href="#l30.1116"></a><span id="l30.1116" class="difflineminus">-  {</span>
<a href="#l30.1117"></a><span id="l30.1117" class="difflineminus">-    char *value = (char*) PR_CALLOC (length + 1); //+1 for null term</span>
<a href="#l30.1118"></a><span id="l30.1118" class="difflineminus">-    if (value)</span>
<a href="#l30.1119"></a><span id="l30.1119" class="difflineminus">-    {</span>
<a href="#l30.1120"></a><span id="l30.1120" class="difflineplus">+  if (length &gt; 0) {</span>
<a href="#l30.1121"></a><span id="l30.1121" class="difflineplus">+    char *value = (char *)PR_CALLOC(length + 1);  //+1 for null term</span>
<a href="#l30.1122"></a><span id="l30.1122" class="difflineplus">+    if (value) {</span>
<a href="#l30.1123"></a><span id="l30.1123">       // Catenate all the To lines together, separated by commas</span>
<a href="#l30.1124"></a><span id="l30.1124">       value[0] = '\0';</span>
<a href="#l30.1125"></a><span id="l30.1125">       size_t size = list.Length();</span>
<a href="#l30.1126"></a><span id="l30.1126" class="difflineminus">-      for (i = 0; i &lt; size; i++)</span>
<a href="#l30.1127"></a><span id="l30.1127" class="difflineminus">-      {</span>
<a href="#l30.1128"></a><span id="l30.1128" class="difflineplus">+      for (i = 0; i &lt; size; i++) {</span>
<a href="#l30.1129"></a><span id="l30.1129">         header = list.ElementAt(i);</span>
<a href="#l30.1130"></a><span id="l30.1130" class="difflineminus">-        PL_strncat (value, header-&gt;value, header-&gt;length);</span>
<a href="#l30.1131"></a><span id="l30.1131" class="difflineminus">-        if (i + 1 &lt; size)</span>
<a href="#l30.1132"></a><span id="l30.1132" class="difflineminus">-          PL_strcat (value, &quot;,&quot;);</span>
<a href="#l30.1133"></a><span id="l30.1133" class="difflineplus">+        PL_strncat(value, header-&gt;value, header-&gt;length);</span>
<a href="#l30.1134"></a><span id="l30.1134" class="difflineplus">+        if (i + 1 &lt; size) PL_strcat(value, &quot;,&quot;);</span>
<a href="#l30.1135"></a><span id="l30.1135">       }</span>
<a href="#l30.1136"></a><span id="l30.1136">       outHeader-&gt;length = length;</span>
<a href="#l30.1137"></a><span id="l30.1137">       outHeader-&gt;value = value;</span>
<a href="#l30.1138"></a><span id="l30.1138">     }</span>
<a href="#l30.1139"></a><span id="l30.1139" class="difflineminus">-  }</span>
<a href="#l30.1140"></a><span id="l30.1140" class="difflineminus">-  else</span>
<a href="#l30.1141"></a><span id="l30.1141" class="difflineminus">-  {</span>
<a href="#l30.1142"></a><span id="l30.1142" class="difflineplus">+  } else {</span>
<a href="#l30.1143"></a><span id="l30.1143">     outHeader-&gt;length = 0;</span>
<a href="#l30.1144"></a><span id="l30.1144">     outHeader-&gt;value = nullptr;</span>
<a href="#l30.1145"></a><span id="l30.1145">   }</span>
<a href="#l30.1146"></a><span id="l30.1146"> }</span>
<a href="#l30.1147"></a><span id="l30.1147"> </span>
<a href="#l30.1148"></a><span id="l30.1148" class="difflineminus">-void nsParseMailMessageState::ClearAggregateHeader (nsTArray&lt;struct message_header*&gt; &amp;list)</span>
<a href="#l30.1149"></a><span id="l30.1149" class="difflineminus">-{</span>
<a href="#l30.1150"></a><span id="l30.1150" class="difflineplus">+void nsParseMailMessageState::ClearAggregateHeader(</span>
<a href="#l30.1151"></a><span id="l30.1151" class="difflineplus">+    nsTArray&lt;struct message_header *&gt; &amp;list) {</span>
<a href="#l30.1152"></a><span id="l30.1152">   // Reset the aggregate headers. Free only the message_header struct since</span>
<a href="#l30.1153"></a><span id="l30.1153">   // we don't own the value pointer</span>
<a href="#l30.1154"></a><span id="l30.1154"> </span>
<a href="#l30.1155"></a><span id="l30.1155" class="difflineminus">-  for (size_t i = 0; i &lt; list.Length(); i++)</span>
<a href="#l30.1156"></a><span id="l30.1156" class="difflineminus">-    PR_Free (list.ElementAt(i));</span>
<a href="#l30.1157"></a><span id="l30.1157" class="difflineplus">+  for (size_t i = 0; i &lt; list.Length(); i++) PR_Free(list.ElementAt(i));</span>
<a href="#l30.1158"></a><span id="l30.1158">   list.Clear();</span>
<a href="#l30.1159"></a><span id="l30.1159"> }</span>
<a href="#l30.1160"></a><span id="l30.1160"> </span>
<a href="#l30.1161"></a><span id="l30.1161"> // We've found a new envelope to parse.</span>
<a href="#l30.1162"></a><span id="l30.1162" class="difflineminus">-nsresult nsParseMailMessageState::StartNewEnvelope(const char *line, uint32_t lineLength)</span>
<a href="#l30.1163"></a><span id="l30.1163" class="difflineminus">-{</span>
<a href="#l30.1164"></a><span id="l30.1164" class="difflineplus">+nsresult nsParseMailMessageState::StartNewEnvelope(const char *line,</span>
<a href="#l30.1165"></a><span id="l30.1165" class="difflineplus">+                                                   uint32_t lineLength) {</span>
<a href="#l30.1166"></a><span id="l30.1166">   m_envelope_pos = m_position;</span>
<a href="#l30.1167"></a><span id="l30.1167">   m_state = nsIMsgParseMailMsgState::ParseHeadersState;</span>
<a href="#l30.1168"></a><span id="l30.1168">   m_position += lineLength;</span>
<a href="#l30.1169"></a><span id="l30.1169">   m_headerstartpos = m_position;</span>
<a href="#l30.1170"></a><span id="l30.1170" class="difflineminus">-  return ParseEnvelope (line, lineLength);</span>
<a href="#l30.1171"></a><span id="l30.1171" class="difflineplus">+  return ParseEnvelope(line, lineLength);</span>
<a href="#l30.1172"></a><span id="l30.1172"> }</span>
<a href="#l30.1173"></a><span id="l30.1173"> </span>
<a href="#l30.1174"></a><span id="l30.1174"> /* largely lifted from mimehtml.c, which does similar parsing, sigh...</span>
<a href="#l30.1175"></a><span id="l30.1175" class="difflineminus">-*/</span>
<a href="#l30.1176"></a><span id="l30.1176" class="difflineminus">-nsresult nsParseMailMessageState::ParseHeaders ()</span>
<a href="#l30.1177"></a><span id="l30.1177" class="difflineminus">-{</span>
<a href="#l30.1178"></a><span id="l30.1178" class="difflineplus">+ */</span>
<a href="#l30.1179"></a><span id="l30.1179" class="difflineplus">+nsresult nsParseMailMessageState::ParseHeaders() {</span>
<a href="#l30.1180"></a><span id="l30.1180">   char *buf = m_headers.GetBuffer();</span>
<a href="#l30.1181"></a><span id="l30.1181">   uint32_t buf_length = m_headers.GetBufferPos();</span>
<a href="#l30.1182"></a><span id="l30.1182" class="difflineminus">-  if (buf_length == 0)</span>
<a href="#l30.1183"></a><span id="l30.1183" class="difflineminus">-  {</span>
<a href="#l30.1184"></a><span id="l30.1184" class="difflineplus">+  if (buf_length == 0) {</span>
<a href="#l30.1185"></a><span id="l30.1185">     // No header of an expected type is present. Consider this a successful</span>
<a href="#l30.1186"></a><span id="l30.1186">     // parse so email still shows on summary and can be accessed and deleted.</span>
<a href="#l30.1187"></a><span id="l30.1187">     return NS_OK;</span>
<a href="#l30.1188"></a><span id="l30.1188">   }</span>
<a href="#l30.1189"></a><span id="l30.1189">   char *buf_end = buf + buf_length;</span>
<a href="#l30.1190"></a><span id="l30.1190" class="difflineminus">-  if (!(buf_length &gt; 1 &amp;&amp; (buf[buf_length - 1] == '\r' ||</span>
<a href="#l30.1191"></a><span id="l30.1191" class="difflineminus">-        buf[buf_length - 1] == '\n')))</span>
<a href="#l30.1192"></a><span id="l30.1192" class="difflineminus">-  {</span>
<a href="#l30.1193"></a><span id="l30.1193" class="difflineplus">+  if (!(buf_length &gt; 1 &amp;&amp;</span>
<a href="#l30.1194"></a><span id="l30.1194" class="difflineplus">+        (buf[buf_length - 1] == '\r' || buf[buf_length - 1] == '\n'))) {</span>
<a href="#l30.1195"></a><span id="l30.1195">     NS_WARNING(&quot;Header text should always end in a newline&quot;);</span>
<a href="#l30.1196"></a><span id="l30.1196">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l30.1197"></a><span id="l30.1197">   }</span>
<a href="#l30.1198"></a><span id="l30.1198" class="difflineminus">-  while (buf &lt; buf_end)</span>
<a href="#l30.1199"></a><span id="l30.1199" class="difflineminus">-  {</span>
<a href="#l30.1200"></a><span id="l30.1200" class="difflineplus">+  while (buf &lt; buf_end) {</span>
<a href="#l30.1201"></a><span id="l30.1201">     char *colon = PL_strnchr(buf, ':', buf_end - buf);</span>
<a href="#l30.1202"></a><span id="l30.1202">     char *end;</span>
<a href="#l30.1203"></a><span id="l30.1203">     char *value = 0;</span>
<a href="#l30.1204"></a><span id="l30.1204">     struct message_header *header = 0;</span>
<a href="#l30.1205"></a><span id="l30.1205">     struct message_header receivedBy;</span>
<a href="#l30.1206"></a><span id="l30.1206"> </span>
<a href="#l30.1207"></a><span id="l30.1207" class="difflineminus">-    if (!colon)</span>
<a href="#l30.1208"></a><span id="l30.1208" class="difflineminus">-      break;</span>
<a href="#l30.1209"></a><span id="l30.1209" class="difflineplus">+    if (!colon) break;</span>
<a href="#l30.1210"></a><span id="l30.1210"> </span>
<a href="#l30.1211"></a><span id="l30.1211">     end = colon;</span>
<a href="#l30.1212"></a><span id="l30.1212"> </span>
<a href="#l30.1213"></a><span id="l30.1213" class="difflineminus">-    switch (buf [0])</span>
<a href="#l30.1214"></a><span id="l30.1214" class="difflineminus">-    {</span>
<a href="#l30.1215"></a><span id="l30.1215" class="difflineminus">-    case 'B': case 'b':</span>
<a href="#l30.1216"></a><span id="l30.1216" class="difflineminus">-      if (!PL_strncasecmp (&quot;BCC&quot;, buf, end - buf))</span>
<a href="#l30.1217"></a><span id="l30.1217" class="difflineminus">-        header = &amp;m_bccList;</span>
<a href="#l30.1218"></a><span id="l30.1218" class="difflineminus">-      break;</span>
<a href="#l30.1219"></a><span id="l30.1219" class="difflineminus">-    case 'C': case 'c':</span>
<a href="#l30.1220"></a><span id="l30.1220" class="difflineminus">-      if (!PL_strncasecmp (&quot;CC&quot;, buf, end - buf))</span>
<a href="#l30.1221"></a><span id="l30.1221" class="difflineminus">-        header = GetNextHeaderInAggregate(m_ccList);</span>
<a href="#l30.1222"></a><span id="l30.1222" class="difflineminus">-      else if (!PL_strncasecmp (&quot;Content-Type&quot;, buf, end - buf))</span>
<a href="#l30.1223"></a><span id="l30.1223" class="difflineminus">-        header = &amp;m_content_type;</span>
<a href="#l30.1224"></a><span id="l30.1224" class="difflineminus">-      break;</span>
<a href="#l30.1225"></a><span id="l30.1225" class="difflineminus">-    case 'D': case 'd':</span>
<a href="#l30.1226"></a><span id="l30.1226" class="difflineminus">-      if (!PL_strncasecmp (&quot;Date&quot;, buf, end - buf))</span>
<a href="#l30.1227"></a><span id="l30.1227" class="difflineminus">-        header = &amp;m_date;</span>
<a href="#l30.1228"></a><span id="l30.1228" class="difflineminus">-      else if (!PL_strncasecmp(&quot;Disposition-Notification-To&quot;, buf, end - buf))</span>
<a href="#l30.1229"></a><span id="l30.1229" class="difflineminus">-        header = &amp;m_mdn_dnt;</span>
<a href="#l30.1230"></a><span id="l30.1230" class="difflineminus">-      else if (!PL_strncasecmp(&quot;Delivery-date&quot;, buf, end - buf))</span>
<a href="#l30.1231"></a><span id="l30.1231" class="difflineminus">-        header = &amp;m_delivery_date;</span>
<a href="#l30.1232"></a><span id="l30.1232" class="difflineminus">-      break;</span>
<a href="#l30.1233"></a><span id="l30.1233" class="difflineminus">-    case 'F': case 'f':</span>
<a href="#l30.1234"></a><span id="l30.1234" class="difflineminus">-      if (!PL_strncasecmp (&quot;From&quot;, buf, end - buf))</span>
<a href="#l30.1235"></a><span id="l30.1235" class="difflineminus">-        header = &amp;m_from;</span>
<a href="#l30.1236"></a><span id="l30.1236" class="difflineminus">-      break;</span>
<a href="#l30.1237"></a><span id="l30.1237" class="difflineminus">-    case 'I' : case 'i':</span>
<a href="#l30.1238"></a><span id="l30.1238" class="difflineminus">-      if (!PL_strncasecmp (&quot;In-Reply-To&quot;, buf, end - buf))</span>
<a href="#l30.1239"></a><span id="l30.1239" class="difflineminus">-        header = &amp;m_in_reply_to;</span>
<a href="#l30.1240"></a><span id="l30.1240" class="difflineminus">-      break;</span>
<a href="#l30.1241"></a><span id="l30.1241" class="difflineminus">-    case 'M': case 'm':</span>
<a href="#l30.1242"></a><span id="l30.1242" class="difflineminus">-      if (!PL_strncasecmp (&quot;Message-ID&quot;, buf, end - buf))</span>
<a href="#l30.1243"></a><span id="l30.1243" class="difflineminus">-        header = &amp;m_message_id;</span>
<a href="#l30.1244"></a><span id="l30.1244" class="difflineminus">-      break;</span>
<a href="#l30.1245"></a><span id="l30.1245" class="difflineminus">-    case 'N': case 'n':</span>
<a href="#l30.1246"></a><span id="l30.1246" class="difflineminus">-      if (!PL_strncasecmp (&quot;Newsgroups&quot;, buf, end - buf))</span>
<a href="#l30.1247"></a><span id="l30.1247" class="difflineminus">-        header = &amp;m_newsgroups;</span>
<a href="#l30.1248"></a><span id="l30.1248" class="difflineminus">-      break;</span>
<a href="#l30.1249"></a><span id="l30.1249" class="difflineminus">-    case 'O': case 'o':</span>
<a href="#l30.1250"></a><span id="l30.1250" class="difflineminus">-      if (!PL_strncasecmp (&quot;Original-Recipient&quot;, buf, end - buf))</span>
<a href="#l30.1251"></a><span id="l30.1251" class="difflineminus">-        header = &amp;m_mdn_original_recipient;</span>
<a href="#l30.1252"></a><span id="l30.1252" class="difflineminus">-      break;</span>
<a href="#l30.1253"></a><span id="l30.1253" class="difflineminus">-    case 'R': case 'r':</span>
<a href="#l30.1254"></a><span id="l30.1254" class="difflineminus">-      if (!PL_strncasecmp (&quot;References&quot;, buf, end - buf))</span>
<a href="#l30.1255"></a><span id="l30.1255" class="difflineminus">-        header = &amp;m_references;</span>
<a href="#l30.1256"></a><span id="l30.1256" class="difflineminus">-      else if (!PL_strncasecmp (&quot;Return-Path&quot;, buf, end - buf))</span>
<a href="#l30.1257"></a><span id="l30.1257" class="difflineminus">-        header = &amp;m_return_path;</span>
<a href="#l30.1258"></a><span id="l30.1258" class="difflineminus">-      // treat conventional Return-Receipt-To as MDN</span>
<a href="#l30.1259"></a><span id="l30.1259" class="difflineminus">-      // Disposition-Notification-To</span>
<a href="#l30.1260"></a><span id="l30.1260" class="difflineminus">-      else if (!PL_strncasecmp (&quot;Return-Receipt-To&quot;, buf, end - buf))</span>
<a href="#l30.1261"></a><span id="l30.1261" class="difflineminus">-        header = &amp;m_mdn_dnt;</span>
<a href="#l30.1262"></a><span id="l30.1262" class="difflineminus">-      else if (!PL_strncasecmp(&quot;Reply-To&quot;, buf, end - buf))</span>
<a href="#l30.1263"></a><span id="l30.1263" class="difflineminus">-        header = &amp;m_replyTo;</span>
<a href="#l30.1264"></a><span id="l30.1264" class="difflineminus">-      else if (!PL_strncasecmp(&quot;Received&quot;, buf, end - buf))</span>
<a href="#l30.1265"></a><span id="l30.1265" class="difflineminus">-      {</span>
<a href="#l30.1266"></a><span id="l30.1266" class="difflineminus">-        header = &amp;receivedBy;</span>
<a href="#l30.1267"></a><span id="l30.1267" class="difflineminus">-        header-&gt;length = 0;</span>
<a href="#l30.1268"></a><span id="l30.1268" class="difflineminus">-      }</span>
<a href="#l30.1269"></a><span id="l30.1269" class="difflineminus">-      break;</span>
<a href="#l30.1270"></a><span id="l30.1270" class="difflineminus">-    case 'S': case 's':</span>
<a href="#l30.1271"></a><span id="l30.1271" class="difflineminus">-      if (!PL_strncasecmp (&quot;Subject&quot;, buf, end - buf) &amp;&amp; !m_subject.length)</span>
<a href="#l30.1272"></a><span id="l30.1272" class="difflineminus">-        header = &amp;m_subject;</span>
<a href="#l30.1273"></a><span id="l30.1273" class="difflineminus">-      else if (!PL_strncasecmp (&quot;Sender&quot;, buf, end - buf))</span>
<a href="#l30.1274"></a><span id="l30.1274" class="difflineminus">-        header = &amp;m_sender;</span>
<a href="#l30.1275"></a><span id="l30.1275" class="difflineminus">-      else if (!PL_strncasecmp (&quot;Status&quot;, buf, end - buf))</span>
<a href="#l30.1276"></a><span id="l30.1276" class="difflineminus">-        header = &amp;m_status;</span>
<a href="#l30.1277"></a><span id="l30.1277" class="difflineminus">-      break;</span>
<a href="#l30.1278"></a><span id="l30.1278" class="difflineminus">-    case 'T': case 't':</span>
<a href="#l30.1279"></a><span id="l30.1279" class="difflineminus">-      if (!PL_strncasecmp (&quot;To&quot;, buf, end - buf))</span>
<a href="#l30.1280"></a><span id="l30.1280" class="difflineminus">-        header = GetNextHeaderInAggregate(m_toList);</span>
<a href="#l30.1281"></a><span id="l30.1281" class="difflineminus">-      break;</span>
<a href="#l30.1282"></a><span id="l30.1282" class="difflineminus">-    case 'X':</span>
<a href="#l30.1283"></a><span id="l30.1283" class="difflineminus">-      if (X_MOZILLA_STATUS2_LEN == end - buf &amp;&amp;</span>
<a href="#l30.1284"></a><span id="l30.1284" class="difflineminus">-        !PL_strncasecmp(X_MOZILLA_STATUS2, buf, end - buf) &amp;&amp;</span>
<a href="#l30.1285"></a><span id="l30.1285" class="difflineminus">-        !m_IgnoreXMozillaStatus &amp;&amp; !m_mozstatus2.length)</span>
<a href="#l30.1286"></a><span id="l30.1286" class="difflineminus">-        header = &amp;m_mozstatus2;</span>
<a href="#l30.1287"></a><span id="l30.1287" class="difflineminus">-      else if ( X_MOZILLA_STATUS_LEN == end - buf &amp;&amp;</span>
<a href="#l30.1288"></a><span id="l30.1288" class="difflineminus">-        !PL_strncasecmp(X_MOZILLA_STATUS, buf, end - buf) &amp;&amp; !m_IgnoreXMozillaStatus</span>
<a href="#l30.1289"></a><span id="l30.1289" class="difflineminus">-        &amp;&amp; !m_mozstatus.length)</span>
<a href="#l30.1290"></a><span id="l30.1290" class="difflineminus">-        header = &amp;m_mozstatus;</span>
<a href="#l30.1291"></a><span id="l30.1291" class="difflineminus">-      else if (!PL_strncasecmp(HEADER_X_MOZILLA_ACCOUNT_KEY, buf, end - buf)</span>
<a href="#l30.1292"></a><span id="l30.1292" class="difflineminus">-        &amp;&amp; !m_account_key.length)</span>
<a href="#l30.1293"></a><span id="l30.1293" class="difflineminus">-        header = &amp;m_account_key;</span>
<a href="#l30.1294"></a><span id="l30.1294" class="difflineminus">-      // we could very well care what the priority header was when we</span>
<a href="#l30.1295"></a><span id="l30.1295" class="difflineminus">-      // remember its value. If so, need to remember it here. Also,</span>
<a href="#l30.1296"></a><span id="l30.1296" class="difflineminus">-      // different priority headers can appear in the same message,</span>
<a href="#l30.1297"></a><span id="l30.1297" class="difflineminus">-      // but we only remember the last one that we see.</span>
<a href="#l30.1298"></a><span id="l30.1298" class="difflineminus">-      else if (!PL_strncasecmp(&quot;X-Priority&quot;, buf, end - buf)</span>
<a href="#l30.1299"></a><span id="l30.1299" class="difflineminus">-        || !PL_strncasecmp(&quot;Priority&quot;, buf, end - buf))</span>
<a href="#l30.1300"></a><span id="l30.1300" class="difflineminus">-        header = &amp;m_priority;</span>
<a href="#l30.1301"></a><span id="l30.1301" class="difflineminus">-      else if (!PL_strncasecmp(HEADER_X_MOZILLA_KEYWORDS, buf, end - buf)</span>
<a href="#l30.1302"></a><span id="l30.1302" class="difflineminus">-        &amp;&amp; !m_keywords.length)</span>
<a href="#l30.1303"></a><span id="l30.1303" class="difflineminus">-        header = &amp;m_keywords;</span>
<a href="#l30.1304"></a><span id="l30.1304" class="difflineminus">-      break;</span>
<a href="#l30.1305"></a><span id="l30.1305" class="difflineplus">+    switch (buf[0]) {</span>
<a href="#l30.1306"></a><span id="l30.1306" class="difflineplus">+      case 'B':</span>
<a href="#l30.1307"></a><span id="l30.1307" class="difflineplus">+      case 'b':</span>
<a href="#l30.1308"></a><span id="l30.1308" class="difflineplus">+        if (!PL_strncasecmp(&quot;BCC&quot;, buf, end - buf)) header = &amp;m_bccList;</span>
<a href="#l30.1309"></a><span id="l30.1309" class="difflineplus">+        break;</span>
<a href="#l30.1310"></a><span id="l30.1310" class="difflineplus">+      case 'C':</span>
<a href="#l30.1311"></a><span id="l30.1311" class="difflineplus">+      case 'c':</span>
<a href="#l30.1312"></a><span id="l30.1312" class="difflineplus">+        if (!PL_strncasecmp(&quot;CC&quot;, buf, end - buf))</span>
<a href="#l30.1313"></a><span id="l30.1313" class="difflineplus">+          header = GetNextHeaderInAggregate(m_ccList);</span>
<a href="#l30.1314"></a><span id="l30.1314" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Content-Type&quot;, buf, end - buf))</span>
<a href="#l30.1315"></a><span id="l30.1315" class="difflineplus">+          header = &amp;m_content_type;</span>
<a href="#l30.1316"></a><span id="l30.1316" class="difflineplus">+        break;</span>
<a href="#l30.1317"></a><span id="l30.1317" class="difflineplus">+      case 'D':</span>
<a href="#l30.1318"></a><span id="l30.1318" class="difflineplus">+      case 'd':</span>
<a href="#l30.1319"></a><span id="l30.1319" class="difflineplus">+        if (!PL_strncasecmp(&quot;Date&quot;, buf, end - buf))</span>
<a href="#l30.1320"></a><span id="l30.1320" class="difflineplus">+          header = &amp;m_date;</span>
<a href="#l30.1321"></a><span id="l30.1321" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Disposition-Notification-To&quot;, buf, end - buf))</span>
<a href="#l30.1322"></a><span id="l30.1322" class="difflineplus">+          header = &amp;m_mdn_dnt;</span>
<a href="#l30.1323"></a><span id="l30.1323" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Delivery-date&quot;, buf, end - buf))</span>
<a href="#l30.1324"></a><span id="l30.1324" class="difflineplus">+          header = &amp;m_delivery_date;</span>
<a href="#l30.1325"></a><span id="l30.1325" class="difflineplus">+        break;</span>
<a href="#l30.1326"></a><span id="l30.1326" class="difflineplus">+      case 'F':</span>
<a href="#l30.1327"></a><span id="l30.1327" class="difflineplus">+      case 'f':</span>
<a href="#l30.1328"></a><span id="l30.1328" class="difflineplus">+        if (!PL_strncasecmp(&quot;From&quot;, buf, end - buf)) header = &amp;m_from;</span>
<a href="#l30.1329"></a><span id="l30.1329" class="difflineplus">+        break;</span>
<a href="#l30.1330"></a><span id="l30.1330" class="difflineplus">+      case 'I':</span>
<a href="#l30.1331"></a><span id="l30.1331" class="difflineplus">+      case 'i':</span>
<a href="#l30.1332"></a><span id="l30.1332" class="difflineplus">+        if (!PL_strncasecmp(&quot;In-Reply-To&quot;, buf, end - buf))</span>
<a href="#l30.1333"></a><span id="l30.1333" class="difflineplus">+          header = &amp;m_in_reply_to;</span>
<a href="#l30.1334"></a><span id="l30.1334" class="difflineplus">+        break;</span>
<a href="#l30.1335"></a><span id="l30.1335" class="difflineplus">+      case 'M':</span>
<a href="#l30.1336"></a><span id="l30.1336" class="difflineplus">+      case 'm':</span>
<a href="#l30.1337"></a><span id="l30.1337" class="difflineplus">+        if (!PL_strncasecmp(&quot;Message-ID&quot;, buf, end - buf))</span>
<a href="#l30.1338"></a><span id="l30.1338" class="difflineplus">+          header = &amp;m_message_id;</span>
<a href="#l30.1339"></a><span id="l30.1339" class="difflineplus">+        break;</span>
<a href="#l30.1340"></a><span id="l30.1340" class="difflineplus">+      case 'N':</span>
<a href="#l30.1341"></a><span id="l30.1341" class="difflineplus">+      case 'n':</span>
<a href="#l30.1342"></a><span id="l30.1342" class="difflineplus">+        if (!PL_strncasecmp(&quot;Newsgroups&quot;, buf, end - buf))</span>
<a href="#l30.1343"></a><span id="l30.1343" class="difflineplus">+          header = &amp;m_newsgroups;</span>
<a href="#l30.1344"></a><span id="l30.1344" class="difflineplus">+        break;</span>
<a href="#l30.1345"></a><span id="l30.1345" class="difflineplus">+      case 'O':</span>
<a href="#l30.1346"></a><span id="l30.1346" class="difflineplus">+      case 'o':</span>
<a href="#l30.1347"></a><span id="l30.1347" class="difflineplus">+        if (!PL_strncasecmp(&quot;Original-Recipient&quot;, buf, end - buf))</span>
<a href="#l30.1348"></a><span id="l30.1348" class="difflineplus">+          header = &amp;m_mdn_original_recipient;</span>
<a href="#l30.1349"></a><span id="l30.1349" class="difflineplus">+        break;</span>
<a href="#l30.1350"></a><span id="l30.1350" class="difflineplus">+      case 'R':</span>
<a href="#l30.1351"></a><span id="l30.1351" class="difflineplus">+      case 'r':</span>
<a href="#l30.1352"></a><span id="l30.1352" class="difflineplus">+        if (!PL_strncasecmp(&quot;References&quot;, buf, end - buf))</span>
<a href="#l30.1353"></a><span id="l30.1353" class="difflineplus">+          header = &amp;m_references;</span>
<a href="#l30.1354"></a><span id="l30.1354" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Return-Path&quot;, buf, end - buf))</span>
<a href="#l30.1355"></a><span id="l30.1355" class="difflineplus">+          header = &amp;m_return_path;</span>
<a href="#l30.1356"></a><span id="l30.1356" class="difflineplus">+        // treat conventional Return-Receipt-To as MDN</span>
<a href="#l30.1357"></a><span id="l30.1357" class="difflineplus">+        // Disposition-Notification-To</span>
<a href="#l30.1358"></a><span id="l30.1358" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Return-Receipt-To&quot;, buf, end - buf))</span>
<a href="#l30.1359"></a><span id="l30.1359" class="difflineplus">+          header = &amp;m_mdn_dnt;</span>
<a href="#l30.1360"></a><span id="l30.1360" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Reply-To&quot;, buf, end - buf))</span>
<a href="#l30.1361"></a><span id="l30.1361" class="difflineplus">+          header = &amp;m_replyTo;</span>
<a href="#l30.1362"></a><span id="l30.1362" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Received&quot;, buf, end - buf)) {</span>
<a href="#l30.1363"></a><span id="l30.1363" class="difflineplus">+          header = &amp;receivedBy;</span>
<a href="#l30.1364"></a><span id="l30.1364" class="difflineplus">+          header-&gt;length = 0;</span>
<a href="#l30.1365"></a><span id="l30.1365" class="difflineplus">+        }</span>
<a href="#l30.1366"></a><span id="l30.1366" class="difflineplus">+        break;</span>
<a href="#l30.1367"></a><span id="l30.1367" class="difflineplus">+      case 'S':</span>
<a href="#l30.1368"></a><span id="l30.1368" class="difflineplus">+      case 's':</span>
<a href="#l30.1369"></a><span id="l30.1369" class="difflineplus">+        if (!PL_strncasecmp(&quot;Subject&quot;, buf, end - buf) &amp;&amp; !m_subject.length)</span>
<a href="#l30.1370"></a><span id="l30.1370" class="difflineplus">+          header = &amp;m_subject;</span>
<a href="#l30.1371"></a><span id="l30.1371" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Sender&quot;, buf, end - buf))</span>
<a href="#l30.1372"></a><span id="l30.1372" class="difflineplus">+          header = &amp;m_sender;</span>
<a href="#l30.1373"></a><span id="l30.1373" class="difflineplus">+        else if (!PL_strncasecmp(&quot;Status&quot;, buf, end - buf))</span>
<a href="#l30.1374"></a><span id="l30.1374" class="difflineplus">+          header = &amp;m_status;</span>
<a href="#l30.1375"></a><span id="l30.1375" class="difflineplus">+        break;</span>
<a href="#l30.1376"></a><span id="l30.1376" class="difflineplus">+      case 'T':</span>
<a href="#l30.1377"></a><span id="l30.1377" class="difflineplus">+      case 't':</span>
<a href="#l30.1378"></a><span id="l30.1378" class="difflineplus">+        if (!PL_strncasecmp(&quot;To&quot;, buf, end - buf))</span>
<a href="#l30.1379"></a><span id="l30.1379" class="difflineplus">+          header = GetNextHeaderInAggregate(m_toList);</span>
<a href="#l30.1380"></a><span id="l30.1380" class="difflineplus">+        break;</span>
<a href="#l30.1381"></a><span id="l30.1381" class="difflineplus">+      case 'X':</span>
<a href="#l30.1382"></a><span id="l30.1382" class="difflineplus">+        if (X_MOZILLA_STATUS2_LEN == end - buf &amp;&amp;</span>
<a href="#l30.1383"></a><span id="l30.1383" class="difflineplus">+            !PL_strncasecmp(X_MOZILLA_STATUS2, buf, end - buf) &amp;&amp;</span>
<a href="#l30.1384"></a><span id="l30.1384" class="difflineplus">+            !m_IgnoreXMozillaStatus &amp;&amp; !m_mozstatus2.length)</span>
<a href="#l30.1385"></a><span id="l30.1385" class="difflineplus">+          header = &amp;m_mozstatus2;</span>
<a href="#l30.1386"></a><span id="l30.1386" class="difflineplus">+        else if (X_MOZILLA_STATUS_LEN == end - buf &amp;&amp;</span>
<a href="#l30.1387"></a><span id="l30.1387" class="difflineplus">+                 !PL_strncasecmp(X_MOZILLA_STATUS, buf, end - buf) &amp;&amp;</span>
<a href="#l30.1388"></a><span id="l30.1388" class="difflineplus">+                 !m_IgnoreXMozillaStatus &amp;&amp; !m_mozstatus.length)</span>
<a href="#l30.1389"></a><span id="l30.1389" class="difflineplus">+          header = &amp;m_mozstatus;</span>
<a href="#l30.1390"></a><span id="l30.1390" class="difflineplus">+        else if (!PL_strncasecmp(HEADER_X_MOZILLA_ACCOUNT_KEY, buf,</span>
<a href="#l30.1391"></a><span id="l30.1391" class="difflineplus">+                                 end - buf) &amp;&amp;</span>
<a href="#l30.1392"></a><span id="l30.1392" class="difflineplus">+                 !m_account_key.length)</span>
<a href="#l30.1393"></a><span id="l30.1393" class="difflineplus">+          header = &amp;m_account_key;</span>
<a href="#l30.1394"></a><span id="l30.1394" class="difflineplus">+        // we could very well care what the priority header was when we</span>
<a href="#l30.1395"></a><span id="l30.1395" class="difflineplus">+        // remember its value. If so, need to remember it here. Also,</span>
<a href="#l30.1396"></a><span id="l30.1396" class="difflineplus">+        // different priority headers can appear in the same message,</span>
<a href="#l30.1397"></a><span id="l30.1397" class="difflineplus">+        // but we only remember the last one that we see.</span>
<a href="#l30.1398"></a><span id="l30.1398" class="difflineplus">+        else if (!PL_strncasecmp(&quot;X-Priority&quot;, buf, end - buf) ||</span>
<a href="#l30.1399"></a><span id="l30.1399" class="difflineplus">+                 !PL_strncasecmp(&quot;Priority&quot;, buf, end - buf))</span>
<a href="#l30.1400"></a><span id="l30.1400" class="difflineplus">+          header = &amp;m_priority;</span>
<a href="#l30.1401"></a><span id="l30.1401" class="difflineplus">+        else if (!PL_strncasecmp(HEADER_X_MOZILLA_KEYWORDS, buf, end - buf) &amp;&amp;</span>
<a href="#l30.1402"></a><span id="l30.1402" class="difflineplus">+                 !m_keywords.length)</span>
<a href="#l30.1403"></a><span id="l30.1403" class="difflineplus">+          header = &amp;m_keywords;</span>
<a href="#l30.1404"></a><span id="l30.1404" class="difflineplus">+        break;</span>
<a href="#l30.1405"></a><span id="l30.1405">     }</span>
<a href="#l30.1406"></a><span id="l30.1406" class="difflineminus">-    if (!header &amp;&amp; m_customDBHeaders.Length())</span>
<a href="#l30.1407"></a><span id="l30.1407" class="difflineminus">-    {</span>
<a href="#l30.1408"></a><span id="l30.1408" class="difflineplus">+    if (!header &amp;&amp; m_customDBHeaders.Length()) {</span>
<a href="#l30.1409"></a><span id="l30.1409">       nsDependentCSubstring headerStr(buf, end);</span>
<a href="#l30.1410"></a><span id="l30.1410"> </span>
<a href="#l30.1411"></a><span id="l30.1411">       ToLowerCase(headerStr);</span>
<a href="#l30.1412"></a><span id="l30.1412">       size_t customHeaderIndex = m_customDBHeaders.IndexOf(headerStr);</span>
<a href="#l30.1413"></a><span id="l30.1413">       if (customHeaderIndex != m_customDBHeaders.NoIndex)</span>
<a href="#l30.1414"></a><span id="l30.1414" class="difflineminus">-        header = &amp; m_customDBHeaderValues[customHeaderIndex];</span>
<a href="#l30.1415"></a><span id="l30.1415" class="difflineplus">+        header = &amp;m_customDBHeaderValues[customHeaderIndex];</span>
<a href="#l30.1416"></a><span id="l30.1416">     }</span>
<a href="#l30.1417"></a><span id="l30.1417"> </span>
<a href="#l30.1418"></a><span id="l30.1418">     buf = colon + 1;</span>
<a href="#l30.1419"></a><span id="l30.1419">     // We will be shuffling downwards, so this is our insertion point.</span>
<a href="#l30.1420"></a><span id="l30.1420">     char *bufWrite = buf;</span>
<a href="#l30.1421"></a><span id="l30.1421"> </span>
<a href="#l30.1422"></a><span id="l30.1422" class="difflineminus">-SEARCH_NEWLINE:</span>
<a href="#l30.1423"></a><span id="l30.1423" class="difflineminus">-    // move past any non terminating characters, rewriting them if folding white space</span>
<a href="#l30.1424"></a><span id="l30.1424" class="difflineminus">-    // exists</span>
<a href="#l30.1425"></a><span id="l30.1425" class="difflineminus">-    while (buf &lt; buf_end &amp;&amp; *buf != '\r' &amp;&amp; *buf != '\n')</span>
<a href="#l30.1426"></a><span id="l30.1426" class="difflineminus">-    {</span>
<a href="#l30.1427"></a><span id="l30.1427" class="difflineminus">-      if (buf != bufWrite)</span>
<a href="#l30.1428"></a><span id="l30.1428" class="difflineminus">-        *bufWrite = *buf;</span>
<a href="#l30.1429"></a><span id="l30.1429" class="difflineplus">+  SEARCH_NEWLINE:</span>
<a href="#l30.1430"></a><span id="l30.1430" class="difflineplus">+    // move past any non terminating characters, rewriting them if folding white</span>
<a href="#l30.1431"></a><span id="l30.1431" class="difflineplus">+    // space exists</span>
<a href="#l30.1432"></a><span id="l30.1432" class="difflineplus">+    while (buf &lt; buf_end &amp;&amp; *buf != '\r' &amp;&amp; *buf != '\n') {</span>
<a href="#l30.1433"></a><span id="l30.1433" class="difflineplus">+      if (buf != bufWrite) *bufWrite = *buf;</span>
<a href="#l30.1434"></a><span id="l30.1434">       buf++;</span>
<a href="#l30.1435"></a><span id="l30.1435">       bufWrite++;</span>
<a href="#l30.1436"></a><span id="l30.1436">     }</span>
<a href="#l30.1437"></a><span id="l30.1437"> </span>
<a href="#l30.1438"></a><span id="l30.1438">     // Look for folding, so CRLF, CR or LF followed by space or tab.</span>
<a href="#l30.1439"></a><span id="l30.1439">     if ((buf + 2 &lt; buf_end &amp;&amp; (buf[0] == '\r' &amp;&amp; buf[1] == '\n') &amp;&amp;</span>
<a href="#l30.1440"></a><span id="l30.1440" class="difflineminus">-                              (buf[2] == ' ' || buf[2] == '\t')) ||</span>
<a href="#l30.1441"></a><span id="l30.1441" class="difflineplus">+         (buf[2] == ' ' || buf[2] == '\t')) ||</span>
<a href="#l30.1442"></a><span id="l30.1442">         (buf + 1 &lt; buf_end &amp;&amp; (buf[0] == '\r' || buf[0] == '\n') &amp;&amp;</span>
<a href="#l30.1443"></a><span id="l30.1443" class="difflineminus">-                              (buf[1] == ' ' || buf[1] == '\t')))</span>
<a href="#l30.1444"></a><span id="l30.1444" class="difflineminus">-    {</span>
<a href="#l30.1445"></a><span id="l30.1445" class="difflineplus">+         (buf[1] == ' ' || buf[1] == '\t'))) {</span>
<a href="#l30.1446"></a><span id="l30.1446">       // Remove trailing spaces at the &quot;write position&quot; and add a single</span>
<a href="#l30.1447"></a><span id="l30.1447">       // folding space.</span>
<a href="#l30.1448"></a><span id="l30.1448" class="difflineminus">-      while (*(bufWrite - 1) == ' ' || *(bufWrite - 1) == '\t')</span>
<a href="#l30.1449"></a><span id="l30.1449" class="difflineminus">-        bufWrite--;</span>
<a href="#l30.1450"></a><span id="l30.1450" class="difflineplus">+      while (*(bufWrite - 1) == ' ' || *(bufWrite - 1) == '\t') bufWrite--;</span>
<a href="#l30.1451"></a><span id="l30.1451">       *(bufWrite++) = ' ';</span>
<a href="#l30.1452"></a><span id="l30.1452"> </span>
<a href="#l30.1453"></a><span id="l30.1453">       // Skip CRLF, CR+space or LF+space ...</span>
<a href="#l30.1454"></a><span id="l30.1454">       buf += 2;</span>
<a href="#l30.1455"></a><span id="l30.1455"> </span>
<a href="#l30.1456"></a><span id="l30.1456">       // ... and skip leading spaces in that line.</span>
<a href="#l30.1457"></a><span id="l30.1457" class="difflineminus">-      while (buf &lt; buf_end &amp;&amp; (*buf == ' ' || *buf == '\t'))</span>
<a href="#l30.1458"></a><span id="l30.1458" class="difflineminus">-        buf++;</span>
<a href="#l30.1459"></a><span id="l30.1459" class="difflineplus">+      while (buf &lt; buf_end &amp;&amp; (*buf == ' ' || *buf == '\t')) buf++;</span>
<a href="#l30.1460"></a><span id="l30.1460"> </span>
<a href="#l30.1461"></a><span id="l30.1461">       // If we get here, the message headers ended in an empty line, like:</span>
<a href="#l30.1462"></a><span id="l30.1462">       // To: blah blah blah&lt;CR&gt;&lt;LF&gt;  &lt;CR&gt;&lt;LF&gt;[end of buffer]. The code below</span>
<a href="#l30.1463"></a><span id="l30.1463">       // requires buf to land on a newline to properly null-terminate the</span>
<a href="#l30.1464"></a><span id="l30.1464">       // string, so back up a tad so that it is pointing to one.</span>
<a href="#l30.1465"></a><span id="l30.1465" class="difflineminus">-      if (buf == buf_end)</span>
<a href="#l30.1466"></a><span id="l30.1466" class="difflineminus">-      {</span>
<a href="#l30.1467"></a><span id="l30.1467" class="difflineplus">+      if (buf == buf_end) {</span>
<a href="#l30.1468"></a><span id="l30.1468">         --buf;</span>
<a href="#l30.1469"></a><span id="l30.1469">         MOZ_ASSERT(*buf == '\n' || *buf == '\r',</span>
<a href="#l30.1470"></a><span id="l30.1470" class="difflineminus">-          &quot;Header text should always end in a newline.&quot;);</span>
<a href="#l30.1471"></a><span id="l30.1471" class="difflineplus">+                   &quot;Header text should always end in a newline.&quot;);</span>
<a href="#l30.1472"></a><span id="l30.1472">       }</span>
<a href="#l30.1473"></a><span id="l30.1473">       goto SEARCH_NEWLINE;</span>
<a href="#l30.1474"></a><span id="l30.1474">     }</span>
<a href="#l30.1475"></a><span id="l30.1475"> </span>
<a href="#l30.1476"></a><span id="l30.1476" class="difflineminus">-    if (header)</span>
<a href="#l30.1477"></a><span id="l30.1477" class="difflineminus">-    {</span>
<a href="#l30.1478"></a><span id="l30.1478" class="difflineplus">+    if (header) {</span>
<a href="#l30.1479"></a><span id="l30.1479">       value = colon + 1;</span>
<a href="#l30.1480"></a><span id="l30.1480">       // eliminate trailing blanks after the colon</span>
<a href="#l30.1481"></a><span id="l30.1481" class="difflineminus">-      while (value &lt; bufWrite &amp;&amp; (*value == ' ' || *value == '\t'))</span>
<a href="#l30.1482"></a><span id="l30.1482" class="difflineminus">-        value++;</span>
<a href="#l30.1483"></a><span id="l30.1483" class="difflineplus">+      while (value &lt; bufWrite &amp;&amp; (*value == ' ' || *value == '\t')) value++;</span>
<a href="#l30.1484"></a><span id="l30.1484"> </span>
<a href="#l30.1485"></a><span id="l30.1485">       header-&gt;value = value;</span>
<a href="#l30.1486"></a><span id="l30.1486">       header-&gt;length = bufWrite - value;</span>
<a href="#l30.1487"></a><span id="l30.1487" class="difflineminus">-      if (header-&gt;length &lt; 0)</span>
<a href="#l30.1488"></a><span id="l30.1488" class="difflineminus">-        header-&gt;length = 0;</span>
<a href="#l30.1489"></a><span id="l30.1489" class="difflineplus">+      if (header-&gt;length &lt; 0) header-&gt;length = 0;</span>
<a href="#l30.1490"></a><span id="l30.1490">     }</span>
<a href="#l30.1491"></a><span id="l30.1491" class="difflineminus">-    if (*buf == '\r' || *buf == '\n')</span>
<a href="#l30.1492"></a><span id="l30.1492" class="difflineminus">-    {</span>
<a href="#l30.1493"></a><span id="l30.1493" class="difflineplus">+    if (*buf == '\r' || *buf == '\n') {</span>
<a href="#l30.1494"></a><span id="l30.1494">       char *last = bufWrite;</span>
<a href="#l30.1495"></a><span id="l30.1495">       char *saveBuf = buf;</span>
<a href="#l30.1496"></a><span id="l30.1496" class="difflineminus">-      if (*buf == '\r' &amp;&amp; buf + 1 &lt; buf_end &amp;&amp; buf[1] == '\n')</span>
<a href="#l30.1497"></a><span id="l30.1497" class="difflineminus">-        buf++;</span>
<a href="#l30.1498"></a><span id="l30.1498" class="difflineplus">+      if (*buf == '\r' &amp;&amp; buf + 1 &lt; buf_end &amp;&amp; buf[1] == '\n') buf++;</span>
<a href="#l30.1499"></a><span id="l30.1499">       buf++;</span>
<a href="#l30.1500"></a><span id="l30.1500">       // null terminate the left-over slop so we don't confuse msg filters.</span>
<a href="#l30.1501"></a><span id="l30.1501">       *saveBuf = 0;</span>
<a href="#l30.1502"></a><span id="l30.1502" class="difflineminus">-      *last = 0;  /* short-circuit const, and null-terminate header. */</span>
<a href="#l30.1503"></a><span id="l30.1503" class="difflineplus">+      *last = 0; /* short-circuit const, and null-terminate header. */</span>
<a href="#l30.1504"></a><span id="l30.1504">     }</span>
<a href="#l30.1505"></a><span id="l30.1505"> </span>
<a href="#l30.1506"></a><span id="l30.1506" class="difflineminus">-    if (header)</span>
<a href="#l30.1507"></a><span id="l30.1507" class="difflineminus">-    {</span>
<a href="#l30.1508"></a><span id="l30.1508" class="difflineplus">+    if (header) {</span>
<a href="#l30.1509"></a><span id="l30.1509">       /* More const short-circuitry... */</span>
<a href="#l30.1510"></a><span id="l30.1510">       /* strip trailing whitespace */</span>
<a href="#l30.1511"></a><span id="l30.1511" class="difflineminus">-      while (header-&gt;length &gt; 0 &amp;&amp;</span>
<a href="#l30.1512"></a><span id="l30.1512" class="difflineminus">-        IS_SPACE (header-&gt;value [header-&gt;length - 1]))</span>
<a href="#l30.1513"></a><span id="l30.1513" class="difflineminus">-        ((char *) header-&gt;value) [--header-&gt;length] = 0;</span>
<a href="#l30.1514"></a><span id="l30.1514" class="difflineminus">-      if (header == &amp;receivedBy)</span>
<a href="#l30.1515"></a><span id="l30.1515" class="difflineminus">-      {</span>
<a href="#l30.1516"></a><span id="l30.1516" class="difflineminus">-        if (m_receivedTime == 0)</span>
<a href="#l30.1517"></a><span id="l30.1517" class="difflineminus">-        {</span>
<a href="#l30.1518"></a><span id="l30.1518" class="difflineplus">+      while (header-&gt;length &gt; 0 &amp;&amp; IS_SPACE(header-&gt;value[header-&gt;length - 1]))</span>
<a href="#l30.1519"></a><span id="l30.1519" class="difflineplus">+        ((char *)header-&gt;value)[--header-&gt;length] = 0;</span>
<a href="#l30.1520"></a><span id="l30.1520" class="difflineplus">+      if (header == &amp;receivedBy) {</span>
<a href="#l30.1521"></a><span id="l30.1521" class="difflineplus">+        if (m_receivedTime == 0) {</span>
<a href="#l30.1522"></a><span id="l30.1522">           // parse Received: header for date.</span>
<a href="#l30.1523"></a><span id="l30.1523">           // We trust the first header as that is closest to recipient,</span>
<a href="#l30.1524"></a><span id="l30.1524">           // and less likely to be spoofed.</span>
<a href="#l30.1525"></a><span id="l30.1525">           nsAutoCString receivedHdr(header-&gt;value, header-&gt;length);</span>
<a href="#l30.1526"></a><span id="l30.1526">           int32_t lastSemicolon = receivedHdr.RFindChar(';');</span>
<a href="#l30.1527"></a><span id="l30.1527" class="difflineminus">-          if (lastSemicolon != -1)</span>
<a href="#l30.1528"></a><span id="l30.1528" class="difflineminus">-          {</span>
<a href="#l30.1529"></a><span id="l30.1529" class="difflineplus">+          if (lastSemicolon != -1) {</span>
<a href="#l30.1530"></a><span id="l30.1530">             nsAutoCString receivedDate;</span>
<a href="#l30.1531"></a><span id="l30.1531">             receivedDate = Substring(receivedHdr, lastSemicolon + 1);</span>
<a href="#l30.1532"></a><span id="l30.1532">             receivedDate.Trim(&quot; \t\b\r\n&quot;);</span>
<a href="#l30.1533"></a><span id="l30.1533">             PRTime resultTime;</span>
<a href="#l30.1534"></a><span id="l30.1534" class="difflineminus">-            if (PR_ParseTimeString (receivedDate.get(), false, &amp;resultTime) == PR_SUCCESS)</span>
<a href="#l30.1535"></a><span id="l30.1535" class="difflineplus">+            if (PR_ParseTimeString(receivedDate.get(), false, &amp;resultTime) ==</span>
<a href="#l30.1536"></a><span id="l30.1536" class="difflineplus">+                PR_SUCCESS)</span>
<a href="#l30.1537"></a><span id="l30.1537">               m_receivedTime = resultTime;</span>
<a href="#l30.1538"></a><span id="l30.1538">             else</span>
<a href="#l30.1539"></a><span id="l30.1539">               NS_WARNING(&quot;PR_ParseTimeString failed in ParseHeaders().&quot;);</span>
<a href="#l30.1540"></a><span id="l30.1540">           }</span>
<a href="#l30.1541"></a><span id="l30.1541">         }</span>
<a href="#l30.1542"></a><span id="l30.1542">         // Someone might want the received header saved.</span>
<a href="#l30.1543"></a><span id="l30.1543" class="difflineminus">-        if (m_customDBHeaders.Length())</span>
<a href="#l30.1544"></a><span id="l30.1544" class="difflineminus">-        {</span>
<a href="#l30.1545"></a><span id="l30.1545" class="difflineminus">-          if (m_customDBHeaders.Contains(NS_LITERAL_CSTRING(&quot;received&quot;)))</span>
<a href="#l30.1546"></a><span id="l30.1546" class="difflineminus">-          {</span>
<a href="#l30.1547"></a><span id="l30.1547" class="difflineminus">-            if (!m_receivedValue.IsEmpty())</span>
<a href="#l30.1548"></a><span id="l30.1548" class="difflineminus">-              m_receivedValue.Append(' ');</span>
<a href="#l30.1549"></a><span id="l30.1549" class="difflineplus">+        if (m_customDBHeaders.Length()) {</span>
<a href="#l30.1550"></a><span id="l30.1550" class="difflineplus">+          if (m_customDBHeaders.Contains(NS_LITERAL_CSTRING(&quot;received&quot;))) {</span>
<a href="#l30.1551"></a><span id="l30.1551" class="difflineplus">+            if (!m_receivedValue.IsEmpty()) m_receivedValue.Append(' ');</span>
<a href="#l30.1552"></a><span id="l30.1552">             m_receivedValue.Append(header-&gt;value, header-&gt;length);</span>
<a href="#l30.1553"></a><span id="l30.1553">           }</span>
<a href="#l30.1554"></a><span id="l30.1554">         }</span>
<a href="#l30.1555"></a><span id="l30.1555">       }</span>
<a href="#l30.1556"></a><span id="l30.1556"> </span>
<a href="#l30.1557"></a><span id="l30.1557">       MOZ_ASSERT(header-&gt;value[header-&gt;length] == 0,</span>
<a href="#l30.1558"></a><span id="l30.1558" class="difflineminus">-        &quot;Non-null-terminated strings cause very, very bad problems&quot;);</span>
<a href="#l30.1559"></a><span id="l30.1559" class="difflineplus">+                 &quot;Non-null-terminated strings cause very, very bad problems&quot;);</span>
<a href="#l30.1560"></a><span id="l30.1560">     }</span>
<a href="#l30.1561"></a><span id="l30.1561">   }</span>
<a href="#l30.1562"></a><span id="l30.1562">   return NS_OK;</span>
<a href="#l30.1563"></a><span id="l30.1563"> }</span>
<a href="#l30.1564"></a><span id="l30.1564"> </span>
<a href="#l30.1565"></a><span id="l30.1565" class="difflineminus">-nsresult nsParseMailMessageState::ParseEnvelope (const char *line, uint32_t line_size)</span>
<a href="#l30.1566"></a><span id="l30.1566" class="difflineminus">-{</span>
<a href="#l30.1567"></a><span id="l30.1567" class="difflineplus">+nsresult nsParseMailMessageState::ParseEnvelope(const char *line,</span>
<a href="#l30.1568"></a><span id="l30.1568" class="difflineplus">+                                                uint32_t line_size) {</span>
<a href="#l30.1569"></a><span id="l30.1569">   const char *end;</span>
<a href="#l30.1570"></a><span id="l30.1570">   char *s;</span>
<a href="#l30.1571"></a><span id="l30.1571"> </span>
<a href="#l30.1572"></a><span id="l30.1572">   m_envelope.AppendBuffer(line, line_size);</span>
<a href="#l30.1573"></a><span id="l30.1573">   end = m_envelope.GetBuffer() + line_size;</span>
<a href="#l30.1574"></a><span id="l30.1574">   s = m_envelope.GetBuffer() + 5;</span>
<a href="#l30.1575"></a><span id="l30.1575"> </span>
<a href="#l30.1576"></a><span id="l30.1576" class="difflineminus">-  while (s &lt; end &amp;&amp; IS_SPACE (*s))</span>
<a href="#l30.1577"></a><span id="l30.1577" class="difflineminus">-    s++;</span>
<a href="#l30.1578"></a><span id="l30.1578" class="difflineplus">+  while (s &lt; end &amp;&amp; IS_SPACE(*s)) s++;</span>
<a href="#l30.1579"></a><span id="l30.1579">   m_envelope_from.value = s;</span>
<a href="#l30.1580"></a><span id="l30.1580" class="difflineminus">-  while (s &lt; end &amp;&amp; !IS_SPACE (*s))</span>
<a href="#l30.1581"></a><span id="l30.1581" class="difflineminus">-    s++;</span>
<a href="#l30.1582"></a><span id="l30.1582" class="difflineplus">+  while (s &lt; end &amp;&amp; !IS_SPACE(*s)) s++;</span>
<a href="#l30.1583"></a><span id="l30.1583">   m_envelope_from.length = s - m_envelope_from.value;</span>
<a href="#l30.1584"></a><span id="l30.1584"> </span>
<a href="#l30.1585"></a><span id="l30.1585" class="difflineminus">-  while (s &lt; end &amp;&amp; IS_SPACE (*s))</span>
<a href="#l30.1586"></a><span id="l30.1586" class="difflineminus">-    s++;</span>
<a href="#l30.1587"></a><span id="l30.1587" class="difflineplus">+  while (s &lt; end &amp;&amp; IS_SPACE(*s)) s++;</span>
<a href="#l30.1588"></a><span id="l30.1588">   m_envelope_date.value = s;</span>
<a href="#l30.1589"></a><span id="l30.1589" class="difflineminus">-  m_envelope_date.length = (uint16_t) (line_size - (s - m_envelope.GetBuffer()));</span>
<a href="#l30.1590"></a><span id="l30.1590" class="difflineplus">+  m_envelope_date.length = (uint16_t)(line_size - (s - m_envelope.GetBuffer()));</span>
<a href="#l30.1591"></a><span id="l30.1591"> </span>
<a href="#l30.1592"></a><span id="l30.1592">   while (m_envelope_date.length &gt; 0 &amp;&amp;</span>
<a href="#l30.1593"></a><span id="l30.1593" class="difflineminus">-         IS_SPACE (m_envelope_date.value [m_envelope_date.length - 1]))</span>
<a href="#l30.1594"></a><span id="l30.1594" class="difflineplus">+         IS_SPACE(m_envelope_date.value[m_envelope_date.length - 1]))</span>
<a href="#l30.1595"></a><span id="l30.1595">     m_envelope_date.length--;</span>
<a href="#l30.1596"></a><span id="l30.1596"> </span>
<a href="#l30.1597"></a><span id="l30.1597">   /* #### short-circuit const */</span>
<a href="#l30.1598"></a><span id="l30.1598" class="difflineminus">-  ((char *) m_envelope_from.value) [m_envelope_from.length] = 0;</span>
<a href="#l30.1599"></a><span id="l30.1599" class="difflineminus">-  ((char *) m_envelope_date.value) [m_envelope_date.length] = 0;</span>
<a href="#l30.1600"></a><span id="l30.1600" class="difflineplus">+  ((char *)m_envelope_from.value)[m_envelope_from.length] = 0;</span>
<a href="#l30.1601"></a><span id="l30.1601" class="difflineplus">+  ((char *)m_envelope_date.value)[m_envelope_date.length] = 0;</span>
<a href="#l30.1602"></a><span id="l30.1602"> </span>
<a href="#l30.1603"></a><span id="l30.1603">   return NS_OK;</span>
<a href="#l30.1604"></a><span id="l30.1604"> }</span>
<a href="#l30.1605"></a><span id="l30.1605"> </span>
<a href="#l30.1606"></a><span id="l30.1606" class="difflineminus">-nsresult nsParseMailMessageState::InternSubject (struct message_header *header)</span>
<a href="#l30.1607"></a><span id="l30.1607" class="difflineminus">-{</span>
<a href="#l30.1608"></a><span id="l30.1608" class="difflineminus">-  if (!header || header-&gt;length == 0)</span>
<a href="#l30.1609"></a><span id="l30.1609" class="difflineminus">-  {</span>
<a href="#l30.1610"></a><span id="l30.1610" class="difflineplus">+nsresult nsParseMailMessageState::InternSubject(struct message_header *header) {</span>
<a href="#l30.1611"></a><span id="l30.1611" class="difflineplus">+  if (!header || header-&gt;length == 0) {</span>
<a href="#l30.1612"></a><span id="l30.1612">     m_newMsgHdr-&gt;SetSubject(&quot;&quot;);</span>
<a href="#l30.1613"></a><span id="l30.1613">     return NS_OK;</span>
<a href="#l30.1614"></a><span id="l30.1614">   }</span>
<a href="#l30.1615"></a><span id="l30.1615"> </span>
<a href="#l30.1616"></a><span id="l30.1616">   const char *key = header-&gt;value;</span>
<a href="#l30.1617"></a><span id="l30.1617"> </span>
<a href="#l30.1618"></a><span id="l30.1618">   uint32_t flags;</span>
<a href="#l30.1619"></a><span id="l30.1619">   (void)m_newMsgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l30.1620"></a><span id="l30.1620" class="difflineat">@@ -1236,27 +1123,27 @@ nsresult nsParseMailMessageState::Intern</span>
<a href="#l30.1621"></a><span id="l30.1621">         edited the subject line by hand?)</span>
<a href="#l30.1622"></a><span id="l30.1622">      */</span>
<a href="#l30.1623"></a><span id="l30.1623">   nsCString modifiedSubject;</span>
<a href="#l30.1624"></a><span id="l30.1624">   bool strippedRE = NS_MsgStripRE(nsDependentCString(key), modifiedSubject);</span>
<a href="#l30.1625"></a><span id="l30.1625">   if (strippedRE)</span>
<a href="#l30.1626"></a><span id="l30.1626">     flags |= nsMsgMessageFlags::HasRe;</span>
<a href="#l30.1627"></a><span id="l30.1627">   else</span>
<a href="#l30.1628"></a><span id="l30.1628">     flags &amp;= ~nsMsgMessageFlags::HasRe;</span>
<a href="#l30.1629"></a><span id="l30.1629" class="difflineminus">-  m_newMsgHdr-&gt;SetFlags(flags); // this *does not* update the mozilla-status header in the local folder</span>
<a href="#l30.1630"></a><span id="l30.1630" class="difflineplus">+  m_newMsgHdr-&gt;SetFlags(flags);  // this *does not* update the mozilla-status</span>
<a href="#l30.1631"></a><span id="l30.1631" class="difflineplus">+                                 // header in the local folder</span>
<a href="#l30.1632"></a><span id="l30.1632"> </span>
<a href="#l30.1633"></a><span id="l30.1633">   m_newMsgHdr-&gt;SetSubject(strippedRE ? modifiedSubject.get() : key);</span>
<a href="#l30.1634"></a><span id="l30.1634"> </span>
<a href="#l30.1635"></a><span id="l30.1635">   return NS_OK;</span>
<a href="#l30.1636"></a><span id="l30.1636"> }</span>
<a href="#l30.1637"></a><span id="l30.1637"> </span>
<a href="#l30.1638"></a><span id="l30.1638" class="difflineminus">-// we've reached the end of the envelope, and need to turn all our accumulated message_headers</span>
<a href="#l30.1639"></a><span id="l30.1639" class="difflineminus">-// into a single nsIMsgDBHdr to store in a database.</span>
<a href="#l30.1640"></a><span id="l30.1640" class="difflineminus">-nsresult nsParseMailMessageState::FinalizeHeaders()</span>
<a href="#l30.1641"></a><span id="l30.1641" class="difflineminus">-{</span>
<a href="#l30.1642"></a><span id="l30.1642" class="difflineplus">+// we've reached the end of the envelope, and need to turn all our accumulated</span>
<a href="#l30.1643"></a><span id="l30.1643" class="difflineplus">+// message_headers into a single nsIMsgDBHdr to store in a database.</span>
<a href="#l30.1644"></a><span id="l30.1644" class="difflineplus">+nsresult nsParseMailMessageState::FinalizeHeaders() {</span>
<a href="#l30.1645"></a><span id="l30.1645">   nsresult rv;</span>
<a href="#l30.1646"></a><span id="l30.1646">   struct message_header *sender;</span>
<a href="#l30.1647"></a><span id="l30.1647">   struct message_header *recipient;</span>
<a href="#l30.1648"></a><span id="l30.1648">   struct message_header *subject;</span>
<a href="#l30.1649"></a><span id="l30.1649">   struct message_header *id;</span>
<a href="#l30.1650"></a><span id="l30.1650">   struct message_header *inReplyTo;</span>
<a href="#l30.1651"></a><span id="l30.1651">   struct message_header *replyTo;</span>
<a href="#l30.1652"></a><span id="l30.1652">   struct message_header *references;</span>
<a href="#l30.1653"></a><span id="l30.1653" class="difflineat">@@ -1268,252 +1155,252 @@ nsresult nsParseMailMessageState::Finali</span>
<a href="#l30.1654"></a><span id="l30.1654">   struct message_header *priority;</span>
<a href="#l30.1655"></a><span id="l30.1655">   struct message_header *keywords;</span>
<a href="#l30.1656"></a><span id="l30.1656">   struct message_header *account_key;</span>
<a href="#l30.1657"></a><span id="l30.1657">   struct message_header *ccList;</span>
<a href="#l30.1658"></a><span id="l30.1658">   struct message_header *bccList;</span>
<a href="#l30.1659"></a><span id="l30.1659">   struct message_header *mdn_dnt;</span>
<a href="#l30.1660"></a><span id="l30.1660">   struct message_header md5_header;</span>
<a href="#l30.1661"></a><span id="l30.1661">   struct message_header *content_type;</span>
<a href="#l30.1662"></a><span id="l30.1662" class="difflineminus">-  char md5_data [50];</span>
<a href="#l30.1663"></a><span id="l30.1663" class="difflineplus">+  char md5_data[50];</span>
<a href="#l30.1664"></a><span id="l30.1664"> </span>
<a href="#l30.1665"></a><span id="l30.1665">   uint32_t flags = 0;</span>
<a href="#l30.1666"></a><span id="l30.1666">   uint32_t delta = 0;</span>
<a href="#l30.1667"></a><span id="l30.1667">   nsMsgPriorityValue priorityFlags = nsMsgPriority::notSet;</span>
<a href="#l30.1668"></a><span id="l30.1668">   uint32_t labelFlags = 0;</span>
<a href="#l30.1669"></a><span id="l30.1669"> </span>
<a href="#l30.1670"></a><span id="l30.1670" class="difflineminus">-  if (!m_mailDB)    // if we don't have a valid db, skip the header.</span>
<a href="#l30.1671"></a><span id="l30.1671" class="difflineplus">+  if (!m_mailDB)  // if we don't have a valid db, skip the header.</span>
<a href="#l30.1672"></a><span id="l30.1672">     return NS_OK;</span>
<a href="#l30.1673"></a><span id="l30.1673"> </span>
<a href="#l30.1674"></a><span id="l30.1674">   struct message_header to;</span>
<a href="#l30.1675"></a><span id="l30.1675" class="difflineminus">-  GetAggregateHeader (m_toList, &amp;to);</span>
<a href="#l30.1676"></a><span id="l30.1676" class="difflineplus">+  GetAggregateHeader(m_toList, &amp;to);</span>
<a href="#l30.1677"></a><span id="l30.1677">   struct message_header cc;</span>
<a href="#l30.1678"></a><span id="l30.1678" class="difflineminus">-  GetAggregateHeader (m_ccList, &amp;cc);</span>
<a href="#l30.1679"></a><span id="l30.1679" class="difflineplus">+  GetAggregateHeader(m_ccList, &amp;cc);</span>
<a href="#l30.1680"></a><span id="l30.1680">   // we don't aggregate bcc, as we only generate it locally,</span>
<a href="#l30.1681"></a><span id="l30.1681">   // and we don't use multiple lines</span>
<a href="#l30.1682"></a><span id="l30.1682"> </span>
<a href="#l30.1683"></a><span id="l30.1683" class="difflineminus">-  sender       = (m_from.length          ? &amp;m_from          :</span>
<a href="#l30.1684"></a><span id="l30.1684" class="difflineminus">-                  m_sender.length        ? &amp;m_sender        :</span>
<a href="#l30.1685"></a><span id="l30.1685" class="difflineminus">-                  m_envelope_from.length ? &amp;m_envelope_from : 0);</span>
<a href="#l30.1686"></a><span id="l30.1686" class="difflineminus">-  recipient    = (to.length              ? &amp;to              :</span>
<a href="#l30.1687"></a><span id="l30.1687" class="difflineminus">-                  cc.length              ? &amp;cc              :</span>
<a href="#l30.1688"></a><span id="l30.1688" class="difflineminus">-                  m_newsgroups.length    ? &amp;m_newsgroups    : 0);</span>
<a href="#l30.1689"></a><span id="l30.1689" class="difflineminus">-  ccList       = (cc.length              ? &amp;cc              : 0);</span>
<a href="#l30.1690"></a><span id="l30.1690" class="difflineminus">-  bccList      = (m_bccList.length       ? &amp;m_bccList       : 0);</span>
<a href="#l30.1691"></a><span id="l30.1691" class="difflineminus">-  subject      = (m_subject.length       ? &amp;m_subject       : 0);</span>
<a href="#l30.1692"></a><span id="l30.1692" class="difflineminus">-  id           = (m_message_id.length    ? &amp;m_message_id    : 0);</span>
<a href="#l30.1693"></a><span id="l30.1693" class="difflineminus">-  references   = (m_references.length    ? &amp;m_references    : 0);</span>
<a href="#l30.1694"></a><span id="l30.1694" class="difflineminus">-  statush      = (m_status.length        ? &amp;m_status        : 0);</span>
<a href="#l30.1695"></a><span id="l30.1695" class="difflineminus">-  mozstatus    = (m_mozstatus.length     ? &amp;m_mozstatus     : 0);</span>
<a href="#l30.1696"></a><span id="l30.1696" class="difflineminus">-  mozstatus2   = (m_mozstatus2.length    ? &amp;m_mozstatus2    : 0);</span>
<a href="#l30.1697"></a><span id="l30.1697" class="difflineminus">-  date         = (m_date.length          ? &amp;m_date          :</span>
<a href="#l30.1698"></a><span id="l30.1698" class="difflineminus">-                  m_envelope_date.length ? &amp;m_envelope_date : 0);</span>
<a href="#l30.1699"></a><span id="l30.1699" class="difflineplus">+  sender =</span>
<a href="#l30.1700"></a><span id="l30.1700" class="difflineplus">+      (m_from.length</span>
<a href="#l30.1701"></a><span id="l30.1701" class="difflineplus">+           ? &amp;m_from</span>
<a href="#l30.1702"></a><span id="l30.1702" class="difflineplus">+           : m_sender.length ? &amp;m_sender</span>
<a href="#l30.1703"></a><span id="l30.1703" class="difflineplus">+                             : m_envelope_from.length ? &amp;m_envelope_from : 0);</span>
<a href="#l30.1704"></a><span id="l30.1704" class="difflineplus">+  recipient =</span>
<a href="#l30.1705"></a><span id="l30.1705" class="difflineplus">+      (to.length ? &amp;to</span>
<a href="#l30.1706"></a><span id="l30.1706" class="difflineplus">+                 : cc.length ? &amp;cc : m_newsgroups.length ? &amp;m_newsgroups : 0);</span>
<a href="#l30.1707"></a><span id="l30.1707" class="difflineplus">+  ccList = (cc.length ? &amp;cc : 0);</span>
<a href="#l30.1708"></a><span id="l30.1708" class="difflineplus">+  bccList = (m_bccList.length ? &amp;m_bccList : 0);</span>
<a href="#l30.1709"></a><span id="l30.1709" class="difflineplus">+  subject = (m_subject.length ? &amp;m_subject : 0);</span>
<a href="#l30.1710"></a><span id="l30.1710" class="difflineplus">+  id = (m_message_id.length ? &amp;m_message_id : 0);</span>
<a href="#l30.1711"></a><span id="l30.1711" class="difflineplus">+  references = (m_references.length ? &amp;m_references : 0);</span>
<a href="#l30.1712"></a><span id="l30.1712" class="difflineplus">+  statush = (m_status.length ? &amp;m_status : 0);</span>
<a href="#l30.1713"></a><span id="l30.1713" class="difflineplus">+  mozstatus = (m_mozstatus.length ? &amp;m_mozstatus : 0);</span>
<a href="#l30.1714"></a><span id="l30.1714" class="difflineplus">+  mozstatus2 = (m_mozstatus2.length ? &amp;m_mozstatus2 : 0);</span>
<a href="#l30.1715"></a><span id="l30.1715" class="difflineplus">+  date =</span>
<a href="#l30.1716"></a><span id="l30.1716" class="difflineplus">+      (m_date.length ? &amp;m_date : m_envelope_date.length ? &amp;m_envelope_date : 0);</span>
<a href="#l30.1717"></a><span id="l30.1717">   deliveryDate = (m_delivery_date.length ? &amp;m_delivery_date : 0);</span>
<a href="#l30.1718"></a><span id="l30.1718" class="difflineminus">-  priority     = (m_priority.length      ? &amp;m_priority      : 0);</span>
<a href="#l30.1719"></a><span id="l30.1719" class="difflineminus">-  keywords     = (m_keywords.length      ? &amp;m_keywords      : 0);</span>
<a href="#l30.1720"></a><span id="l30.1720" class="difflineminus">-  mdn_dnt      = (m_mdn_dnt.length       ? &amp;m_mdn_dnt       : 0);</span>
<a href="#l30.1721"></a><span id="l30.1721" class="difflineminus">-  inReplyTo    = (m_in_reply_to.length   ? &amp;m_in_reply_to   : 0);</span>
<a href="#l30.1722"></a><span id="l30.1722" class="difflineminus">-  replyTo      = (m_replyTo.length       ? &amp;m_replyTo       : 0);</span>
<a href="#l30.1723"></a><span id="l30.1723" class="difflineminus">-  content_type = (m_content_type.length  ? &amp;m_content_type  : 0);</span>
<a href="#l30.1724"></a><span id="l30.1724" class="difflineminus">-  account_key  = (m_account_key.length   ? &amp;m_account_key   : 0);</span>
<a href="#l30.1725"></a><span id="l30.1725" class="difflineplus">+  priority = (m_priority.length ? &amp;m_priority : 0);</span>
<a href="#l30.1726"></a><span id="l30.1726" class="difflineplus">+  keywords = (m_keywords.length ? &amp;m_keywords : 0);</span>
<a href="#l30.1727"></a><span id="l30.1727" class="difflineplus">+  mdn_dnt = (m_mdn_dnt.length ? &amp;m_mdn_dnt : 0);</span>
<a href="#l30.1728"></a><span id="l30.1728" class="difflineplus">+  inReplyTo = (m_in_reply_to.length ? &amp;m_in_reply_to : 0);</span>
<a href="#l30.1729"></a><span id="l30.1729" class="difflineplus">+  replyTo = (m_replyTo.length ? &amp;m_replyTo : 0);</span>
<a href="#l30.1730"></a><span id="l30.1730" class="difflineplus">+  content_type = (m_content_type.length ? &amp;m_content_type : 0);</span>
<a href="#l30.1731"></a><span id="l30.1731" class="difflineplus">+  account_key = (m_account_key.length ? &amp;m_account_key : 0);</span>
<a href="#l30.1732"></a><span id="l30.1732"> </span>
<a href="#l30.1733"></a><span id="l30.1733" class="difflineminus">-  if (mozstatus)</span>
<a href="#l30.1734"></a><span id="l30.1734" class="difflineminus">-  {</span>
<a href="#l30.1735"></a><span id="l30.1735" class="difflineminus">-    if (mozstatus-&gt;length == 4)</span>
<a href="#l30.1736"></a><span id="l30.1736" class="difflineminus">-    {</span>
<a href="#l30.1737"></a><span id="l30.1737" class="difflineminus">-      NS_ASSERTION(MsgIsHex(mozstatus-&gt;value, 4), &quot;Expected 4 hex digits for flags.&quot;);</span>
<a href="#l30.1738"></a><span id="l30.1738" class="difflineplus">+  if (mozstatus) {</span>
<a href="#l30.1739"></a><span id="l30.1739" class="difflineplus">+    if (mozstatus-&gt;length == 4) {</span>
<a href="#l30.1740"></a><span id="l30.1740" class="difflineplus">+      NS_ASSERTION(MsgIsHex(mozstatus-&gt;value, 4),</span>
<a href="#l30.1741"></a><span id="l30.1741" class="difflineplus">+                   &quot;Expected 4 hex digits for flags.&quot;);</span>
<a href="#l30.1742"></a><span id="l30.1742">       flags = MsgUnhex(mozstatus-&gt;value, 4);</span>
<a href="#l30.1743"></a><span id="l30.1743">       // strip off and remember priority bits.</span>
<a href="#l30.1744"></a><span id="l30.1744">       flags &amp;= ~nsMsgMessageFlags::RuntimeOnly;</span>
<a href="#l30.1745"></a><span id="l30.1745" class="difflineminus">-      priorityFlags = (nsMsgPriorityValue) ((flags &amp; nsMsgMessageFlags::Priorities) &gt;&gt; 13);</span>
<a href="#l30.1746"></a><span id="l30.1746" class="difflineplus">+      priorityFlags =</span>
<a href="#l30.1747"></a><span id="l30.1747" class="difflineplus">+          (nsMsgPriorityValue)((flags &amp; nsMsgMessageFlags::Priorities) &gt;&gt; 13);</span>
<a href="#l30.1748"></a><span id="l30.1748">       flags &amp;= ~nsMsgMessageFlags::Priorities;</span>
<a href="#l30.1749"></a><span id="l30.1749">     }</span>
<a href="#l30.1750"></a><span id="l30.1750" class="difflineminus">-    delta = (m_headerstartpos +</span>
<a href="#l30.1751"></a><span id="l30.1751" class="difflineminus">-      (mozstatus-&gt;value - m_headers.GetBuffer()) -</span>
<a href="#l30.1752"></a><span id="l30.1752" class="difflineminus">-      (2 + X_MOZILLA_STATUS_LEN)    /* 2 extra bytes for &quot;: &quot;. */</span>
<a href="#l30.1753"></a><span id="l30.1753" class="difflineminus">-      ) - m_envelope_pos;</span>
<a href="#l30.1754"></a><span id="l30.1754" class="difflineplus">+    delta = (m_headerstartpos + (mozstatus-&gt;value - m_headers.GetBuffer()) -</span>
<a href="#l30.1755"></a><span id="l30.1755" class="difflineplus">+             (2 + X_MOZILLA_STATUS_LEN) /* 2 extra bytes for &quot;: &quot;. */</span>
<a href="#l30.1756"></a><span id="l30.1756" class="difflineplus">+             ) -</span>
<a href="#l30.1757"></a><span id="l30.1757" class="difflineplus">+            m_envelope_pos;</span>
<a href="#l30.1758"></a><span id="l30.1758">   }</span>
<a href="#l30.1759"></a><span id="l30.1759"> </span>
<a href="#l30.1760"></a><span id="l30.1760" class="difflineminus">-  if (mozstatus2)</span>
<a href="#l30.1761"></a><span id="l30.1761" class="difflineminus">-  {</span>
<a href="#l30.1762"></a><span id="l30.1762" class="difflineplus">+  if (mozstatus2) {</span>
<a href="#l30.1763"></a><span id="l30.1763">     uint32_t flags2 = 0;</span>
<a href="#l30.1764"></a><span id="l30.1764">     sscanf(mozstatus2-&gt;value, &quot; %x &quot;, &amp;flags2);</span>
<a href="#l30.1765"></a><span id="l30.1765">     flags |= flags2;</span>
<a href="#l30.1766"></a><span id="l30.1766">   }</span>
<a href="#l30.1767"></a><span id="l30.1767"> </span>
<a href="#l30.1768"></a><span id="l30.1768" class="difflineminus">-  if (!(flags &amp; nsMsgMessageFlags::Expunged))  // message was deleted, don't bother creating a hdr.</span>
<a href="#l30.1769"></a><span id="l30.1769" class="difflineplus">+  if (!(flags &amp; nsMsgMessageFlags::Expunged))  // message was deleted, don't</span>
<a href="#l30.1770"></a><span id="l30.1770" class="difflineplus">+                                               // bother creating a hdr.</span>
<a href="#l30.1771"></a><span id="l30.1771">   {</span>
<a href="#l30.1772"></a><span id="l30.1772">     // We'll need the message id first to recover data from the backup database</span>
<a href="#l30.1773"></a><span id="l30.1773">     nsAutoCString rawMsgId;</span>
<a href="#l30.1774"></a><span id="l30.1774">     /* Take off &lt;&gt; around message ID. */</span>
<a href="#l30.1775"></a><span id="l30.1775" class="difflineminus">-    if (id)</span>
<a href="#l30.1776"></a><span id="l30.1776" class="difflineminus">-    {</span>
<a href="#l30.1777"></a><span id="l30.1777" class="difflineplus">+    if (id) {</span>
<a href="#l30.1778"></a><span id="l30.1778">       if (id-&gt;length &gt; 0 &amp;&amp; id-&gt;value[0] == '&lt;') {</span>
<a href="#l30.1779"></a><span id="l30.1779">         id-&gt;length--;</span>
<a href="#l30.1780"></a><span id="l30.1780">         id-&gt;value++;</span>
<a href="#l30.1781"></a><span id="l30.1781">       }</span>
<a href="#l30.1782"></a><span id="l30.1782"> </span>
<a href="#l30.1783"></a><span id="l30.1783" class="difflineminus">-      NS_WARNING_ASSERTION(id-&gt;length &gt; 0, &quot;id-&gt;length failure in FinalizeHeaders().&quot;);</span>
<a href="#l30.1784"></a><span id="l30.1784" class="difflineplus">+      NS_WARNING_ASSERTION(id-&gt;length &gt; 0,</span>
<a href="#l30.1785"></a><span id="l30.1785" class="difflineplus">+                           &quot;id-&gt;length failure in FinalizeHeaders().&quot;);</span>
<a href="#l30.1786"></a><span id="l30.1786"> </span>
<a href="#l30.1787"></a><span id="l30.1787">       if (id-&gt;length &gt; 0 &amp;&amp; id-&gt;value[id-&gt;length - 1] == '&gt;')</span>
<a href="#l30.1788"></a><span id="l30.1788">         /* generate a new null-terminated string without the final &gt; */</span>
<a href="#l30.1789"></a><span id="l30.1789">         rawMsgId.Assign(id-&gt;value, id-&gt;length - 1);</span>
<a href="#l30.1790"></a><span id="l30.1790">       else</span>
<a href="#l30.1791"></a><span id="l30.1791">         rawMsgId.Assign(id-&gt;value);</span>
<a href="#l30.1792"></a><span id="l30.1792">     }</span>
<a href="#l30.1793"></a><span id="l30.1793"> </span>
<a href="#l30.1794"></a><span id="l30.1794">     /*</span>
<a href="#l30.1795"></a><span id="l30.1795">      * Try to copy the data from the backup database, referencing the MessageID</span>
<a href="#l30.1796"></a><span id="l30.1796">      * If that fails, just create a new header</span>
<a href="#l30.1797"></a><span id="l30.1797">      */</span>
<a href="#l30.1798"></a><span id="l30.1798">     nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHeader;</span>
<a href="#l30.1799"></a><span id="l30.1799">     nsresult ret = NS_OK;</span>
<a href="#l30.1800"></a><span id="l30.1800"> </span>
<a href="#l30.1801"></a><span id="l30.1801">     if (m_backupMailDB &amp;&amp; !rawMsgId.IsEmpty())</span>
<a href="#l30.1802"></a><span id="l30.1802" class="difflineminus">-      ret = m_backupMailDB-&gt;GetMsgHdrForMessageID(</span>
<a href="#l30.1803"></a><span id="l30.1803" class="difflineminus">-              rawMsgId.get(), getter_AddRefs(oldHeader));</span>
<a href="#l30.1804"></a><span id="l30.1804" class="difflineplus">+      ret = m_backupMailDB-&gt;GetMsgHdrForMessageID(rawMsgId.get(),</span>
<a href="#l30.1805"></a><span id="l30.1805" class="difflineplus">+                                                  getter_AddRefs(oldHeader));</span>
<a href="#l30.1806"></a><span id="l30.1806"> </span>
<a href="#l30.1807"></a><span id="l30.1807">     // m_new_key is set in nsImapMailFolder::ParseAdoptedHeaderLine to be</span>
<a href="#l30.1808"></a><span id="l30.1808">     // the UID of the message, so that the key can get created as UID. That of</span>
<a href="#l30.1809"></a><span id="l30.1809">     // course is extremely confusing, and we really need to clean that up. We</span>
<a href="#l30.1810"></a><span id="l30.1810">     // really should not conflate the meaning of envelope position, key, and</span>
<a href="#l30.1811"></a><span id="l30.1811">     // UID.</span>
<a href="#l30.1812"></a><span id="l30.1812">     if (NS_SUCCEEDED(ret) &amp;&amp; oldHeader)</span>
<a href="#l30.1813"></a><span id="l30.1813" class="difflineminus">-        ret = m_mailDB-&gt;CopyHdrFromExistingHdr(m_new_key,</span>
<a href="#l30.1814"></a><span id="l30.1814" class="difflineminus">-                oldHeader, false, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l30.1815"></a><span id="l30.1815" class="difflineminus">-    else if (!m_newMsgHdr)</span>
<a href="#l30.1816"></a><span id="l30.1816" class="difflineminus">-    {</span>
<a href="#l30.1817"></a><span id="l30.1817" class="difflineplus">+      ret = m_mailDB-&gt;CopyHdrFromExistingHdr(m_new_key, oldHeader, false,</span>
<a href="#l30.1818"></a><span id="l30.1818" class="difflineplus">+                                             getter_AddRefs(m_newMsgHdr));</span>
<a href="#l30.1819"></a><span id="l30.1819" class="difflineplus">+    else if (!m_newMsgHdr) {</span>
<a href="#l30.1820"></a><span id="l30.1820">       // Should assert that this is not a local message</span>
<a href="#l30.1821"></a><span id="l30.1821">       ret = m_mailDB-&gt;CreateNewHdr(m_new_key, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l30.1822"></a><span id="l30.1822">     }</span>
<a href="#l30.1823"></a><span id="l30.1823"> </span>
<a href="#l30.1824"></a><span id="l30.1824" class="difflineminus">-    if (NS_SUCCEEDED(ret) &amp;&amp; m_newMsgHdr)</span>
<a href="#l30.1825"></a><span id="l30.1825" class="difflineminus">-    {</span>
<a href="#l30.1826"></a><span id="l30.1826" class="difflineplus">+    if (NS_SUCCEEDED(ret) &amp;&amp; m_newMsgHdr) {</span>
<a href="#l30.1827"></a><span id="l30.1827">       uint32_t origFlags;</span>
<a href="#l30.1828"></a><span id="l30.1828">       (void)m_newMsgHdr-&gt;GetFlags(&amp;origFlags);</span>
<a href="#l30.1829"></a><span id="l30.1829">       if (origFlags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l30.1830"></a><span id="l30.1830">         flags |= nsMsgMessageFlags::HasRe;</span>
<a href="#l30.1831"></a><span id="l30.1831">       else</span>
<a href="#l30.1832"></a><span id="l30.1832">         flags &amp;= ~nsMsgMessageFlags::HasRe;</span>
<a href="#l30.1833"></a><span id="l30.1833"> </span>
<a href="#l30.1834"></a><span id="l30.1834" class="difflineminus">-      flags &amp;= ~nsMsgMessageFlags::Offline; // don't keep nsMsgMessageFlags::Offline for local msgs</span>
<a href="#l30.1835"></a><span id="l30.1835" class="difflineplus">+      flags &amp;=</span>
<a href="#l30.1836"></a><span id="l30.1836" class="difflineplus">+          ~nsMsgMessageFlags::Offline;  // don't keep nsMsgMessageFlags::Offline</span>
<a href="#l30.1837"></a><span id="l30.1837" class="difflineplus">+                                        // for local msgs</span>
<a href="#l30.1838"></a><span id="l30.1838">       if (mdn_dnt &amp;&amp; !(origFlags &amp; nsMsgMessageFlags::Read) &amp;&amp;</span>
<a href="#l30.1839"></a><span id="l30.1839">           !(origFlags &amp; nsMsgMessageFlags::MDNReportSent) &amp;&amp;</span>
<a href="#l30.1840"></a><span id="l30.1840">           !(flags &amp; nsMsgMessageFlags::MDNReportSent))</span>
<a href="#l30.1841"></a><span id="l30.1841">         flags |= nsMsgMessageFlags::MDNReportNeeded;</span>
<a href="#l30.1842"></a><span id="l30.1842"> </span>
<a href="#l30.1843"></a><span id="l30.1843">       m_newMsgHdr-&gt;SetFlags(flags);</span>
<a href="#l30.1844"></a><span id="l30.1844">       if (priorityFlags != nsMsgPriority::notSet)</span>
<a href="#l30.1845"></a><span id="l30.1845">         m_newMsgHdr-&gt;SetPriority(priorityFlags);</span>
<a href="#l30.1846"></a><span id="l30.1846"> </span>
<a href="#l30.1847"></a><span id="l30.1847">       // if we have a reply to header, and it's different from the from: header,</span>
<a href="#l30.1848"></a><span id="l30.1848">       // set the &quot;replyTo&quot; attribute on the msg hdr.</span>
<a href="#l30.1849"></a><span id="l30.1849" class="difflineminus">-      if (replyTo &amp;&amp; (!sender || replyTo-&gt;length != sender-&gt;length || strncmp(replyTo-&gt;value, sender-&gt;value, sender-&gt;length)))</span>
<a href="#l30.1850"></a><span id="l30.1850" class="difflineplus">+      if (replyTo &amp;&amp; (!sender || replyTo-&gt;length != sender-&gt;length ||</span>
<a href="#l30.1851"></a><span id="l30.1851" class="difflineplus">+                      strncmp(replyTo-&gt;value, sender-&gt;value, sender-&gt;length)))</span>
<a href="#l30.1852"></a><span id="l30.1852">         m_newMsgHdr-&gt;SetStringProperty(&quot;replyTo&quot;, replyTo-&gt;value);</span>
<a href="#l30.1853"></a><span id="l30.1853">       // convert the flag values (0xE000000) to label values (0-5)</span>
<a href="#l30.1854"></a><span id="l30.1854" class="difflineminus">-      if (mozstatus2) // only do this if we have a mozstatus2 header</span>
<a href="#l30.1855"></a><span id="l30.1855" class="difflineplus">+      if (mozstatus2)  // only do this if we have a mozstatus2 header</span>
<a href="#l30.1856"></a><span id="l30.1856">       {</span>
<a href="#l30.1857"></a><span id="l30.1857">         labelFlags = ((flags &amp; nsMsgMessageFlags::Labels) &gt;&gt; 25);</span>
<a href="#l30.1858"></a><span id="l30.1858">         m_newMsgHdr-&gt;SetLabel(labelFlags);</span>
<a href="#l30.1859"></a><span id="l30.1859">       }</span>
<a href="#l30.1860"></a><span id="l30.1860" class="difflineminus">-      if (delta &lt; 0xffff)</span>
<a href="#l30.1861"></a><span id="l30.1861" class="difflineminus">-      {    /* Only use if fits in 16 bits. */</span>
<a href="#l30.1862"></a><span id="l30.1862" class="difflineminus">-        m_newMsgHdr-&gt;SetStatusOffset((uint16_t) delta);</span>
<a href="#l30.1863"></a><span id="l30.1863" class="difflineminus">-        if (!m_IgnoreXMozillaStatus) {  // imap doesn't care about X-MozillaStatus</span>
<a href="#l30.1864"></a><span id="l30.1864" class="difflineplus">+      if (delta &lt; 0xffff) { /* Only use if fits in 16 bits. */</span>
<a href="#l30.1865"></a><span id="l30.1865" class="difflineplus">+        m_newMsgHdr-&gt;SetStatusOffset((uint16_t)delta);</span>
<a href="#l30.1866"></a><span id="l30.1866" class="difflineplus">+        if (!m_IgnoreXMozillaStatus) {  // imap doesn't care about</span>
<a href="#l30.1867"></a><span id="l30.1867" class="difflineplus">+                                        // X-MozillaStatus</span>
<a href="#l30.1868"></a><span id="l30.1868">           uint32_t offset;</span>
<a href="#l30.1869"></a><span id="l30.1869">           (void)m_newMsgHdr-&gt;GetStatusOffset(&amp;offset);</span>
<a href="#l30.1870"></a><span id="l30.1870" class="difflineminus">-          NS_ASSERTION(offset &lt; 10000, &quot;invalid status offset&quot;); /* ### Debugging hack */</span>
<a href="#l30.1871"></a><span id="l30.1871" class="difflineplus">+          NS_ASSERTION(offset &lt; 10000,</span>
<a href="#l30.1872"></a><span id="l30.1872" class="difflineplus">+                       &quot;invalid status offset&quot;); /* ### Debugging hack */</span>
<a href="#l30.1873"></a><span id="l30.1873">         }</span>
<a href="#l30.1874"></a><span id="l30.1874">       }</span>
<a href="#l30.1875"></a><span id="l30.1875" class="difflineminus">-      if (sender)</span>
<a href="#l30.1876"></a><span id="l30.1876" class="difflineminus">-        m_newMsgHdr-&gt;SetAuthor(sender-&gt;value);</span>
<a href="#l30.1877"></a><span id="l30.1877" class="difflineminus">-      if (recipient == &amp;m_newsgroups)</span>
<a href="#l30.1878"></a><span id="l30.1878" class="difflineminus">-      {</span>
<a href="#l30.1879"></a><span id="l30.1879" class="difflineminus">-      /* In the case where the recipient is a newsgroup, truncate the string</span>
<a href="#l30.1880"></a><span id="l30.1880" class="difflineminus">-      at the first comma.  This is used only for presenting the thread list,</span>
<a href="#l30.1881"></a><span id="l30.1881" class="difflineminus">-      and newsgroup lines tend to be long and non-shared, and tend to bloat</span>
<a href="#l30.1882"></a><span id="l30.1882" class="difflineminus">-      the string table.  So, by only showing the first newsgroup, we can</span>
<a href="#l30.1883"></a><span id="l30.1883" class="difflineminus">-      reduce memory and file usage at the expense of only showing the one</span>
<a href="#l30.1884"></a><span id="l30.1884" class="difflineminus">-      group in the summary list, and only being able to sort on the first</span>
<a href="#l30.1885"></a><span id="l30.1885" class="difflineminus">-        group rather than the whole list.  It's worth it. */</span>
<a href="#l30.1886"></a><span id="l30.1886" class="difflineminus">-        char * ch;</span>
<a href="#l30.1887"></a><span id="l30.1887" class="difflineplus">+      if (sender) m_newMsgHdr-&gt;SetAuthor(sender-&gt;value);</span>
<a href="#l30.1888"></a><span id="l30.1888" class="difflineplus">+      if (recipient == &amp;m_newsgroups) {</span>
<a href="#l30.1889"></a><span id="l30.1889" class="difflineplus">+        /* In the case where the recipient is a newsgroup, truncate the string</span>
<a href="#l30.1890"></a><span id="l30.1890" class="difflineplus">+        at the first comma.  This is used only for presenting the thread list,</span>
<a href="#l30.1891"></a><span id="l30.1891" class="difflineplus">+        and newsgroup lines tend to be long and non-shared, and tend to bloat</span>
<a href="#l30.1892"></a><span id="l30.1892" class="difflineplus">+        the string table.  So, by only showing the first newsgroup, we can</span>
<a href="#l30.1893"></a><span id="l30.1893" class="difflineplus">+        reduce memory and file usage at the expense of only showing the one</span>
<a href="#l30.1894"></a><span id="l30.1894" class="difflineplus">+        group in the summary list, and only being able to sort on the first</span>
<a href="#l30.1895"></a><span id="l30.1895" class="difflineplus">+          group rather than the whole list.  It's worth it. */</span>
<a href="#l30.1896"></a><span id="l30.1896" class="difflineplus">+        char *ch;</span>
<a href="#l30.1897"></a><span id="l30.1897">         ch = PL_strchr(recipient-&gt;value, ',');</span>
<a href="#l30.1898"></a><span id="l30.1898" class="difflineminus">-        if (ch)</span>
<a href="#l30.1899"></a><span id="l30.1899" class="difflineminus">-        {</span>
<a href="#l30.1900"></a><span id="l30.1900" class="difflineplus">+        if (ch) {</span>
<a href="#l30.1901"></a><span id="l30.1901">           /* generate a new string that terminates before the , */</span>
<a href="#l30.1902"></a><span id="l30.1902">           nsAutoCString firstGroup;</span>
<a href="#l30.1903"></a><span id="l30.1903">           firstGroup.Assign(recipient-&gt;value, ch - recipient-&gt;value);</span>
<a href="#l30.1904"></a><span id="l30.1904">           m_newMsgHdr-&gt;SetRecipients(firstGroup.get());</span>
<a href="#l30.1905"></a><span id="l30.1905">         }</span>
<a href="#l30.1906"></a><span id="l30.1906">         m_newMsgHdr-&gt;SetRecipients(recipient-&gt;value);</span>
<a href="#l30.1907"></a><span id="l30.1907" class="difflineminus">-      }</span>
<a href="#l30.1908"></a><span id="l30.1908" class="difflineminus">-      else if (recipient)</span>
<a href="#l30.1909"></a><span id="l30.1909" class="difflineminus">-      {</span>
<a href="#l30.1910"></a><span id="l30.1910" class="difflineplus">+      } else if (recipient) {</span>
<a href="#l30.1911"></a><span id="l30.1911">         m_newMsgHdr-&gt;SetRecipients(recipient-&gt;value);</span>
<a href="#l30.1912"></a><span id="l30.1912">       }</span>
<a href="#l30.1913"></a><span id="l30.1913" class="difflineminus">-      if (ccList)</span>
<a href="#l30.1914"></a><span id="l30.1914" class="difflineminus">-      {</span>
<a href="#l30.1915"></a><span id="l30.1915" class="difflineplus">+      if (ccList) {</span>
<a href="#l30.1916"></a><span id="l30.1916">         m_newMsgHdr-&gt;SetCcList(ccList-&gt;value);</span>
<a href="#l30.1917"></a><span id="l30.1917">       }</span>
<a href="#l30.1918"></a><span id="l30.1918"> </span>
<a href="#l30.1919"></a><span id="l30.1919" class="difflineminus">-      if (bccList)</span>
<a href="#l30.1920"></a><span id="l30.1920" class="difflineminus">-      {</span>
<a href="#l30.1921"></a><span id="l30.1921" class="difflineplus">+      if (bccList) {</span>
<a href="#l30.1922"></a><span id="l30.1922">         m_newMsgHdr-&gt;SetBccList(bccList-&gt;value);</span>
<a href="#l30.1923"></a><span id="l30.1923">       }</span>
<a href="#l30.1924"></a><span id="l30.1924"> </span>
<a href="#l30.1925"></a><span id="l30.1925" class="difflineminus">-      rv = InternSubject (subject);</span>
<a href="#l30.1926"></a><span id="l30.1926" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1927"></a><span id="l30.1927" class="difflineminus">-      {</span>
<a href="#l30.1928"></a><span id="l30.1928" class="difflineminus">-        if (!id)</span>
<a href="#l30.1929"></a><span id="l30.1929" class="difflineminus">-        {</span>
<a href="#l30.1930"></a><span id="l30.1930" class="difflineplus">+      rv = InternSubject(subject);</span>
<a href="#l30.1931"></a><span id="l30.1931" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.1932"></a><span id="l30.1932" class="difflineplus">+        if (!id) {</span>
<a href="#l30.1933"></a><span id="l30.1933">           // what to do about this? we used to do a hash of all the headers...</span>
<a href="#l30.1934"></a><span id="l30.1934">           nsAutoCString hash;</span>
<a href="#l30.1935"></a><span id="l30.1935">           const char *md5_b64 = &quot;dummy.message.id&quot;;</span>
<a href="#l30.1936"></a><span id="l30.1936">           nsresult rv;</span>
<a href="#l30.1937"></a><span id="l30.1937" class="difflineminus">-          nsCOMPtr&lt;nsICryptoHash&gt; hasher = do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l30.1938"></a><span id="l30.1938" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l30.1939"></a><span id="l30.1939" class="difflineminus">-          {</span>
<a href="#l30.1940"></a><span id="l30.1940" class="difflineplus">+          nsCOMPtr&lt;nsICryptoHash&gt; hasher =</span>
<a href="#l30.1941"></a><span id="l30.1941" class="difflineplus">+              do_CreateInstance(&quot;@mozilla.org/security/hash;1&quot;, &amp;rv);</span>
<a href="#l30.1942"></a><span id="l30.1942" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.1943"></a><span id="l30.1943">             if (NS_SUCCEEDED(hasher-&gt;Init(nsICryptoHash::MD5)) &amp;&amp;</span>
<a href="#l30.1944"></a><span id="l30.1944" class="difflineminus">-                NS_SUCCEEDED(hasher-&gt;Update((const uint8_t*) m_headers.GetBuffer(), m_headers.GetSize())) &amp;&amp;</span>
<a href="#l30.1945"></a><span id="l30.1945" class="difflineplus">+                NS_SUCCEEDED(</span>
<a href="#l30.1946"></a><span id="l30.1946" class="difflineplus">+                    hasher-&gt;Update((const uint8_t *)m_headers.GetBuffer(),</span>
<a href="#l30.1947"></a><span id="l30.1947" class="difflineplus">+                                   m_headers.GetSize())) &amp;&amp;</span>
<a href="#l30.1948"></a><span id="l30.1948">                 NS_SUCCEEDED(hasher-&gt;Finish(true, hash)))</span>
<a href="#l30.1949"></a><span id="l30.1949">               md5_b64 = hash.get();</span>
<a href="#l30.1950"></a><span id="l30.1950">           }</span>
<a href="#l30.1951"></a><span id="l30.1951" class="difflineminus">-          PR_snprintf (md5_data, sizeof(md5_data), &quot;&lt;md5:%s&gt;&quot;, md5_b64);</span>
<a href="#l30.1952"></a><span id="l30.1952" class="difflineplus">+          PR_snprintf(md5_data, sizeof(md5_data), &quot;&lt;md5:%s&gt;&quot;, md5_b64);</span>
<a href="#l30.1953"></a><span id="l30.1953">           md5_header.value = md5_data;</span>
<a href="#l30.1954"></a><span id="l30.1954">           md5_header.length = strlen(md5_data);</span>
<a href="#l30.1955"></a><span id="l30.1955">           id = &amp;md5_header;</span>
<a href="#l30.1956"></a><span id="l30.1956">         }</span>
<a href="#l30.1957"></a><span id="l30.1957"> </span>
<a href="#l30.1958"></a><span id="l30.1958">         if (!rawMsgId.IsEmpty())</span>
<a href="#l30.1959"></a><span id="l30.1959">           m_newMsgHdr-&gt;SetMessageId(rawMsgId.get());</span>
<a href="#l30.1960"></a><span id="l30.1960">         else</span>
<a href="#l30.1961"></a><span id="l30.1961">           m_newMsgHdr-&gt;SetMessageId(id-&gt;value);</span>
<a href="#l30.1962"></a><span id="l30.1962">         m_mailDB-&gt;UpdatePendingAttributes(m_newMsgHdr);</span>
<a href="#l30.1963"></a><span id="l30.1963"> </span>
<a href="#l30.1964"></a><span id="l30.1964" class="difflineminus">-        if (!mozstatus &amp;&amp; statush)</span>
<a href="#l30.1965"></a><span id="l30.1965" class="difflineminus">-        {</span>
<a href="#l30.1966"></a><span id="l30.1966" class="difflineplus">+        if (!mozstatus &amp;&amp; statush) {</span>
<a href="#l30.1967"></a><span id="l30.1967">           /* Parse a little bit of the Berkeley Mail status header. */</span>
<a href="#l30.1968"></a><span id="l30.1968">           for (const char *s = statush-&gt;value; *s; s++) {</span>
<a href="#l30.1969"></a><span id="l30.1969">             uint32_t msgFlags = 0;</span>
<a href="#l30.1970"></a><span id="l30.1970">             (void)m_newMsgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l30.1971"></a><span id="l30.1971" class="difflineminus">-            switch (*s)</span>
<a href="#l30.1972"></a><span id="l30.1972" class="difflineminus">-            {</span>
<a href="#l30.1973"></a><span id="l30.1973" class="difflineminus">-            case 'R': case 'r':</span>
<a href="#l30.1974"></a><span id="l30.1974" class="difflineminus">-              m_newMsgHdr-&gt;SetFlags(msgFlags | nsMsgMessageFlags::Read);</span>
<a href="#l30.1975"></a><span id="l30.1975" class="difflineminus">-              break;</span>
<a href="#l30.1976"></a><span id="l30.1976" class="difflineminus">-            case 'D': case 'd':</span>
<a href="#l30.1977"></a><span id="l30.1977" class="difflineminus">-              /* msg-&gt;flags |= nsMsgMessageFlags::Expunged;  ### Is this reasonable? */</span>
<a href="#l30.1978"></a><span id="l30.1978" class="difflineminus">-              break;</span>
<a href="#l30.1979"></a><span id="l30.1979" class="difflineminus">-            case 'N': case 'n':</span>
<a href="#l30.1980"></a><span id="l30.1980" class="difflineminus">-            case 'U': case 'u':</span>
<a href="#l30.1981"></a><span id="l30.1981" class="difflineminus">-              m_newMsgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::Read);</span>
<a href="#l30.1982"></a><span id="l30.1982" class="difflineminus">-              break;</span>
<a href="#l30.1983"></a><span id="l30.1983" class="difflineminus">-            default:            // Should check for corrupt file.</span>
<a href="#l30.1984"></a><span id="l30.1984" class="difflineminus">-              NS_ERROR(&quot;Corrupt file. Should not happen.&quot;);</span>
<a href="#l30.1985"></a><span id="l30.1985" class="difflineminus">-              break;</span>
<a href="#l30.1986"></a><span id="l30.1986" class="difflineplus">+            switch (*s) {</span>
<a href="#l30.1987"></a><span id="l30.1987" class="difflineplus">+              case 'R':</span>
<a href="#l30.1988"></a><span id="l30.1988" class="difflineplus">+              case 'r':</span>
<a href="#l30.1989"></a><span id="l30.1989" class="difflineplus">+                m_newMsgHdr-&gt;SetFlags(msgFlags | nsMsgMessageFlags::Read);</span>
<a href="#l30.1990"></a><span id="l30.1990" class="difflineplus">+                break;</span>
<a href="#l30.1991"></a><span id="l30.1991" class="difflineplus">+              case 'D':</span>
<a href="#l30.1992"></a><span id="l30.1992" class="difflineplus">+              case 'd':</span>
<a href="#l30.1993"></a><span id="l30.1993" class="difflineplus">+                /* msg-&gt;flags |= nsMsgMessageFlags::Expunged;  ### Is this</span>
<a href="#l30.1994"></a><span id="l30.1994" class="difflineplus">+                 * reasonable? */</span>
<a href="#l30.1995"></a><span id="l30.1995" class="difflineplus">+                break;</span>
<a href="#l30.1996"></a><span id="l30.1996" class="difflineplus">+              case 'N':</span>
<a href="#l30.1997"></a><span id="l30.1997" class="difflineplus">+              case 'n':</span>
<a href="#l30.1998"></a><span id="l30.1998" class="difflineplus">+              case 'U':</span>
<a href="#l30.1999"></a><span id="l30.1999" class="difflineplus">+              case 'u':</span>
<a href="#l30.2000"></a><span id="l30.2000" class="difflineplus">+                m_newMsgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::Read);</span>
<a href="#l30.2001"></a><span id="l30.2001" class="difflineplus">+                break;</span>
<a href="#l30.2002"></a><span id="l30.2002" class="difflineplus">+              default:  // Should check for corrupt file.</span>
<a href="#l30.2003"></a><span id="l30.2003" class="difflineplus">+                NS_ERROR(&quot;Corrupt file. Should not happen.&quot;);</span>
<a href="#l30.2004"></a><span id="l30.2004" class="difflineplus">+                break;</span>
<a href="#l30.2005"></a><span id="l30.2005">             }</span>
<a href="#l30.2006"></a><span id="l30.2006">           }</span>
<a href="#l30.2007"></a><span id="l30.2007">         }</span>
<a href="#l30.2008"></a><span id="l30.2008"> </span>
<a href="#l30.2009"></a><span id="l30.2009">         if (account_key != nullptr)</span>
<a href="#l30.2010"></a><span id="l30.2010">           m_newMsgHdr-&gt;SetAccountKey(account_key-&gt;value);</span>
<a href="#l30.2011"></a><span id="l30.2011">         // use in-reply-to header as references, if there's no references header</span>
<a href="#l30.2012"></a><span id="l30.2012">         if (references != nullptr)</span>
<a href="#l30.2013"></a><span id="l30.2013" class="difflineat">@@ -1529,436 +1416,390 @@ nsresult nsParseMailMessageState::Finali</span>
<a href="#l30.2014"></a><span id="l30.2014">         // 'Date' uses:</span>
<a href="#l30.2015"></a><span id="l30.2015">         // date -&gt; 'Received' -&gt; PR_Now()</span>
<a href="#l30.2016"></a><span id="l30.2016">         //</span>
<a href="#l30.2017"></a><span id="l30.2017">         // date is:</span>
<a href="#l30.2018"></a><span id="l30.2018">         // Date: -&gt; m_envelope_date</span>
<a href="#l30.2019"></a><span id="l30.2019"> </span>
<a href="#l30.2020"></a><span id="l30.2020">         uint32_t rcvTimeSecs = 0;</span>
<a href="#l30.2021"></a><span id="l30.2021">         PRTime datePRTime = 0;</span>
<a href="#l30.2022"></a><span id="l30.2022" class="difflineminus">-        if (date)</span>
<a href="#l30.2023"></a><span id="l30.2023" class="difflineminus">-        {</span>
<a href="#l30.2024"></a><span id="l30.2024" class="difflineplus">+        if (date) {</span>
<a href="#l30.2025"></a><span id="l30.2025">           // Date:</span>
<a href="#l30.2026"></a><span id="l30.2026" class="difflineminus">-          if (PR_ParseTimeString(date-&gt;value, false, &amp;datePRTime) == PR_SUCCESS)</span>
<a href="#l30.2027"></a><span id="l30.2027" class="difflineminus">-          {</span>
<a href="#l30.2028"></a><span id="l30.2028" class="difflineplus">+          if (PR_ParseTimeString(date-&gt;value, false, &amp;datePRTime) ==</span>
<a href="#l30.2029"></a><span id="l30.2029" class="difflineplus">+              PR_SUCCESS) {</span>
<a href="#l30.2030"></a><span id="l30.2030">             // Convert to seconds as default value for 'Received'.</span>
<a href="#l30.2031"></a><span id="l30.2031">             PRTime2Seconds(datePRTime, &amp;rcvTimeSecs);</span>
<a href="#l30.2032"></a><span id="l30.2032" class="difflineminus">-          }</span>
<a href="#l30.2033"></a><span id="l30.2033" class="difflineminus">-          else</span>
<a href="#l30.2034"></a><span id="l30.2034" class="difflineminus">-          {</span>
<a href="#l30.2035"></a><span id="l30.2035" class="difflineminus">-            NS_WARNING(&quot;PR_ParseTimeString of date failed in FinalizeHeader().&quot;);</span>
<a href="#l30.2036"></a><span id="l30.2036" class="difflineplus">+          } else {</span>
<a href="#l30.2037"></a><span id="l30.2037" class="difflineplus">+            NS_WARNING(</span>
<a href="#l30.2038"></a><span id="l30.2038" class="difflineplus">+                &quot;PR_ParseTimeString of date failed in FinalizeHeader().&quot;);</span>
<a href="#l30.2039"></a><span id="l30.2039">           }</span>
<a href="#l30.2040"></a><span id="l30.2040">         }</span>
<a href="#l30.2041"></a><span id="l30.2041" class="difflineminus">-        if (m_receivedTime)</span>
<a href="#l30.2042"></a><span id="l30.2042" class="difflineminus">-        {</span>
<a href="#l30.2043"></a><span id="l30.2043" class="difflineplus">+        if (m_receivedTime) {</span>
<a href="#l30.2044"></a><span id="l30.2044">           // Upgrade 'Received' to Received: ?</span>
<a href="#l30.2045"></a><span id="l30.2045">           PRTime2Seconds(m_receivedTime, &amp;rcvTimeSecs);</span>
<a href="#l30.2046"></a><span id="l30.2046" class="difflineminus">-          if (datePRTime == 0)</span>
<a href="#l30.2047"></a><span id="l30.2047" class="difflineminus">-            datePRTime = m_receivedTime;</span>
<a href="#l30.2048"></a><span id="l30.2048" class="difflineminus">-        }</span>
<a href="#l30.2049"></a><span id="l30.2049" class="difflineminus">-        else if (deliveryDate)</span>
<a href="#l30.2050"></a><span id="l30.2050" class="difflineminus">-        {</span>
<a href="#l30.2051"></a><span id="l30.2051" class="difflineplus">+          if (datePRTime == 0) datePRTime = m_receivedTime;</span>
<a href="#l30.2052"></a><span id="l30.2052" class="difflineplus">+        } else if (deliveryDate) {</span>
<a href="#l30.2053"></a><span id="l30.2053">           // Upgrade 'Received' to Delivery-date: ?</span>
<a href="#l30.2054"></a><span id="l30.2054">           PRTime resultTime;</span>
<a href="#l30.2055"></a><span id="l30.2055" class="difflineminus">-          if (PR_ParseTimeString(deliveryDate-&gt;value, false, &amp;resultTime) == PR_SUCCESS)</span>
<a href="#l30.2056"></a><span id="l30.2056" class="difflineminus">-          {</span>
<a href="#l30.2057"></a><span id="l30.2057" class="difflineplus">+          if (PR_ParseTimeString(deliveryDate-&gt;value, false, &amp;resultTime) ==</span>
<a href="#l30.2058"></a><span id="l30.2058" class="difflineplus">+              PR_SUCCESS) {</span>
<a href="#l30.2059"></a><span id="l30.2059">             PRTime2Seconds(resultTime, &amp;rcvTimeSecs);</span>
<a href="#l30.2060"></a><span id="l30.2060" class="difflineminus">-            if (datePRTime == 0)</span>
<a href="#l30.2061"></a><span id="l30.2061" class="difflineminus">-              datePRTime = resultTime;</span>
<a href="#l30.2062"></a><span id="l30.2062" class="difflineminus">-          }</span>
<a href="#l30.2063"></a><span id="l30.2063" class="difflineminus">-          else</span>
<a href="#l30.2064"></a><span id="l30.2064" class="difflineminus">-          {</span>
<a href="#l30.2065"></a><span id="l30.2065" class="difflineplus">+            if (datePRTime == 0) datePRTime = resultTime;</span>
<a href="#l30.2066"></a><span id="l30.2066" class="difflineplus">+          } else {</span>
<a href="#l30.2067"></a><span id="l30.2067">             // TODO/FIXME: We need to figure out what to do in this case!</span>
<a href="#l30.2068"></a><span id="l30.2068" class="difflineminus">-            NS_WARNING(&quot;PR_ParseTimeString of delivery date failed in FinalizeHeader().&quot;);</span>
<a href="#l30.2069"></a><span id="l30.2069" class="difflineplus">+            NS_WARNING(</span>
<a href="#l30.2070"></a><span id="l30.2070" class="difflineplus">+                &quot;PR_ParseTimeString of delivery date failed in &quot;</span>
<a href="#l30.2071"></a><span id="l30.2071" class="difflineplus">+                &quot;FinalizeHeader().&quot;);</span>
<a href="#l30.2072"></a><span id="l30.2072">           }</span>
<a href="#l30.2073"></a><span id="l30.2073">         }</span>
<a href="#l30.2074"></a><span id="l30.2074">         m_newMsgHdr-&gt;SetUint32Property(&quot;dateReceived&quot;, rcvTimeSecs);</span>
<a href="#l30.2075"></a><span id="l30.2075"> </span>
<a href="#l30.2076"></a><span id="l30.2076" class="difflineminus">-        if (datePRTime == 0)</span>
<a href="#l30.2077"></a><span id="l30.2077" class="difflineminus">-        {</span>
<a href="#l30.2078"></a><span id="l30.2078" class="difflineplus">+        if (datePRTime == 0) {</span>
<a href="#l30.2079"></a><span id="l30.2079">           // If there was some problem parsing the Date header *AND* we</span>
<a href="#l30.2080"></a><span id="l30.2080">           // couldn't get a valid envelope date *AND* we couldn't get a valid</span>
<a href="#l30.2081"></a><span id="l30.2081">           // Received: header date, use now as the time.</span>
<a href="#l30.2082"></a><span id="l30.2082">           // This doesn't affect local (POP3) messages, because we use the</span>
<a href="#l30.2083"></a><span id="l30.2083">           // envelope date if there's no Date: header, but it will affect IMAP</span>
<a href="#l30.2084"></a><span id="l30.2084">           // msgs w/o a Date: header or Received: headers.</span>
<a href="#l30.2085"></a><span id="l30.2085">           datePRTime = PR_Now();</span>
<a href="#l30.2086"></a><span id="l30.2086">         }</span>
<a href="#l30.2087"></a><span id="l30.2087">         m_newMsgHdr-&gt;SetDate(datePRTime);</span>
<a href="#l30.2088"></a><span id="l30.2088"> </span>
<a href="#l30.2089"></a><span id="l30.2089">         if (priority)</span>
<a href="#l30.2090"></a><span id="l30.2090">           m_newMsgHdr-&gt;SetPriorityString(priority-&gt;value);</span>
<a href="#l30.2091"></a><span id="l30.2091">         else if (priorityFlags == nsMsgPriority::notSet)</span>
<a href="#l30.2092"></a><span id="l30.2092">           m_newMsgHdr-&gt;SetPriority(nsMsgPriority::none);</span>
<a href="#l30.2093"></a><span id="l30.2093" class="difflineminus">-        if (keywords)</span>
<a href="#l30.2094"></a><span id="l30.2094" class="difflineminus">-        {</span>
<a href="#l30.2095"></a><span id="l30.2095" class="difflineplus">+        if (keywords) {</span>
<a href="#l30.2096"></a><span id="l30.2096">           // When there are many keywords, some may not have been written</span>
<a href="#l30.2097"></a><span id="l30.2097">           // to the message file, so add extra keywords from the backup</span>
<a href="#l30.2098"></a><span id="l30.2098">           nsAutoCString oldKeywords;</span>
<a href="#l30.2099"></a><span id="l30.2099" class="difflineminus">-          m_newMsgHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(oldKeywords));</span>
<a href="#l30.2100"></a><span id="l30.2100" class="difflineplus">+          m_newMsgHdr-&gt;GetStringProperty(&quot;keywords&quot;,</span>
<a href="#l30.2101"></a><span id="l30.2101" class="difflineplus">+                                         getter_Copies(oldKeywords));</span>
<a href="#l30.2102"></a><span id="l30.2102">           nsTArray&lt;nsCString&gt; newKeywordArray, oldKeywordArray;</span>
<a href="#l30.2103"></a><span id="l30.2103" class="difflineminus">-          ParseString(Substring(keywords-&gt;value, keywords-&gt;value + keywords-&gt;length), ' ', newKeywordArray);</span>
<a href="#l30.2104"></a><span id="l30.2104" class="difflineplus">+          ParseString(</span>
<a href="#l30.2105"></a><span id="l30.2105" class="difflineplus">+              Substring(keywords-&gt;value, keywords-&gt;value + keywords-&gt;length),</span>
<a href="#l30.2106"></a><span id="l30.2106" class="difflineplus">+              ' ', newKeywordArray);</span>
<a href="#l30.2107"></a><span id="l30.2107">           ParseString(oldKeywords, ' ', oldKeywordArray);</span>
<a href="#l30.2108"></a><span id="l30.2108">           for (uint32_t i = 0; i &lt; oldKeywordArray.Length(); i++)</span>
<a href="#l30.2109"></a><span id="l30.2109">             if (!newKeywordArray.Contains(oldKeywordArray[i]))</span>
<a href="#l30.2110"></a><span id="l30.2110">               newKeywordArray.AppendElement(oldKeywordArray[i]);</span>
<a href="#l30.2111"></a><span id="l30.2111">           nsAutoCString newKeywords;</span>
<a href="#l30.2112"></a><span id="l30.2112" class="difflineminus">-          for (uint32_t i = 0; i &lt; newKeywordArray.Length(); i++)</span>
<a href="#l30.2113"></a><span id="l30.2113" class="difflineminus">-          {</span>
<a href="#l30.2114"></a><span id="l30.2114" class="difflineminus">-            if (i)</span>
<a href="#l30.2115"></a><span id="l30.2115" class="difflineminus">-              newKeywords.Append(' ');</span>
<a href="#l30.2116"></a><span id="l30.2116" class="difflineplus">+          for (uint32_t i = 0; i &lt; newKeywordArray.Length(); i++) {</span>
<a href="#l30.2117"></a><span id="l30.2117" class="difflineplus">+            if (i) newKeywords.Append(' ');</span>
<a href="#l30.2118"></a><span id="l30.2118">             newKeywords.Append(newKeywordArray[i]);</span>
<a href="#l30.2119"></a><span id="l30.2119">           }</span>
<a href="#l30.2120"></a><span id="l30.2120">           m_newMsgHdr-&gt;SetStringProperty(&quot;keywords&quot;, newKeywords.get());</span>
<a href="#l30.2121"></a><span id="l30.2121">         }</span>
<a href="#l30.2122"></a><span id="l30.2122" class="difflineminus">-        for (uint32_t i = 0; i &lt; m_customDBHeaders.Length(); i++)</span>
<a href="#l30.2123"></a><span id="l30.2123" class="difflineminus">-        {</span>
<a href="#l30.2124"></a><span id="l30.2124" class="difflineplus">+        for (uint32_t i = 0; i &lt; m_customDBHeaders.Length(); i++) {</span>
<a href="#l30.2125"></a><span id="l30.2125">           if (m_customDBHeaderValues[i].length)</span>
<a href="#l30.2126"></a><span id="l30.2126" class="difflineminus">-            m_newMsgHdr-&gt;SetStringProperty(m_customDBHeaders[i].get(), m_customDBHeaderValues[i].value);</span>
<a href="#l30.2127"></a><span id="l30.2127" class="difflineplus">+            m_newMsgHdr-&gt;SetStringProperty(m_customDBHeaders[i].get(),</span>
<a href="#l30.2128"></a><span id="l30.2128" class="difflineplus">+                                           m_customDBHeaderValues[i].value);</span>
<a href="#l30.2129"></a><span id="l30.2129">           // The received header is accumulated separately</span>
<a href="#l30.2130"></a><span id="l30.2130" class="difflineminus">-          if (m_customDBHeaders[i].EqualsLiteral(&quot;received&quot;) &amp;&amp; !m_receivedValue.IsEmpty())</span>
<a href="#l30.2131"></a><span id="l30.2131" class="difflineplus">+          if (m_customDBHeaders[i].EqualsLiteral(&quot;received&quot;) &amp;&amp;</span>
<a href="#l30.2132"></a><span id="l30.2132" class="difflineplus">+              !m_receivedValue.IsEmpty())</span>
<a href="#l30.2133"></a><span id="l30.2133">             m_newMsgHdr-&gt;SetStringProperty(&quot;received&quot;, m_receivedValue.get());</span>
<a href="#l30.2134"></a><span id="l30.2134">         }</span>
<a href="#l30.2135"></a><span id="l30.2135" class="difflineminus">-        if (content_type)</span>
<a href="#l30.2136"></a><span id="l30.2136" class="difflineminus">-        {</span>
<a href="#l30.2137"></a><span id="l30.2137" class="difflineplus">+        if (content_type) {</span>
<a href="#l30.2138"></a><span id="l30.2138">           char *substring = PL_strstr(content_type-&gt;value, &quot;charset&quot;);</span>
<a href="#l30.2139"></a><span id="l30.2139" class="difflineminus">-          if (substring)</span>
<a href="#l30.2140"></a><span id="l30.2140" class="difflineminus">-          {</span>
<a href="#l30.2141"></a><span id="l30.2141" class="difflineminus">-            char *charset = PL_strchr (substring, '=');</span>
<a href="#l30.2142"></a><span id="l30.2142" class="difflineminus">-            if (charset)</span>
<a href="#l30.2143"></a><span id="l30.2143" class="difflineminus">-            {</span>
<a href="#l30.2144"></a><span id="l30.2144" class="difflineplus">+          if (substring) {</span>
<a href="#l30.2145"></a><span id="l30.2145" class="difflineplus">+            char *charset = PL_strchr(substring, '=');</span>
<a href="#l30.2146"></a><span id="l30.2146" class="difflineplus">+            if (charset) {</span>
<a href="#l30.2147"></a><span id="l30.2147">               charset++;</span>
<a href="#l30.2148"></a><span id="l30.2148">               /* strip leading whitespace and double-quote */</span>
<a href="#l30.2149"></a><span id="l30.2149" class="difflineminus">-              while (*charset &amp;&amp; (IS_SPACE (*charset) || '\&quot;' == *charset))</span>
<a href="#l30.2150"></a><span id="l30.2150" class="difflineplus">+              while (*charset &amp;&amp; (IS_SPACE(*charset) || '\&quot;' == *charset))</span>
<a href="#l30.2151"></a><span id="l30.2151">                 charset++;</span>
<a href="#l30.2152"></a><span id="l30.2152">               /* strip trailing whitespace and double-quote */</span>
<a href="#l30.2153"></a><span id="l30.2153">               char *end = charset;</span>
<a href="#l30.2154"></a><span id="l30.2154" class="difflineminus">-              while (*end &amp;&amp; !IS_SPACE (*end) &amp;&amp; '\&quot;' != *end &amp;&amp; ';' != *end)</span>
<a href="#l30.2155"></a><span id="l30.2155" class="difflineplus">+              while (*end &amp;&amp; !IS_SPACE(*end) &amp;&amp; '\&quot;' != *end &amp;&amp; ';' != *end)</span>
<a href="#l30.2156"></a><span id="l30.2156">                 end++;</span>
<a href="#l30.2157"></a><span id="l30.2157" class="difflineminus">-              if (*charset)</span>
<a href="#l30.2158"></a><span id="l30.2158" class="difflineminus">-              {</span>
<a href="#l30.2159"></a><span id="l30.2159" class="difflineplus">+              if (*charset) {</span>
<a href="#l30.2160"></a><span id="l30.2160">                 if (*end != '\0') {</span>
<a href="#l30.2161"></a><span id="l30.2161">                   // if we're not at the very end of the line, we need</span>
<a href="#l30.2162"></a><span id="l30.2162">                   // to generate a new string without the trailing crud</span>
<a href="#l30.2163"></a><span id="l30.2163">                   nsAutoCString rawCharSet;</span>
<a href="#l30.2164"></a><span id="l30.2164">                   rawCharSet.Assign(charset, end - charset);</span>
<a href="#l30.2165"></a><span id="l30.2165">                   m_newMsgHdr-&gt;SetCharset(rawCharSet.get());</span>
<a href="#l30.2166"></a><span id="l30.2166">                 } else {</span>
<a href="#l30.2167"></a><span id="l30.2167">                   m_newMsgHdr-&gt;SetCharset(charset);</span>
<a href="#l30.2168"></a><span id="l30.2168">                 }</span>
<a href="#l30.2169"></a><span id="l30.2169">               }</span>
<a href="#l30.2170"></a><span id="l30.2170">             }</span>
<a href="#l30.2171"></a><span id="l30.2171">           }</span>
<a href="#l30.2172"></a><span id="l30.2172">           substring = PL_strcasestr(content_type-&gt;value, &quot;multipart/mixed&quot;);</span>
<a href="#l30.2173"></a><span id="l30.2173" class="difflineminus">-          if (substring)</span>
<a href="#l30.2174"></a><span id="l30.2174" class="difflineminus">-          {</span>
<a href="#l30.2175"></a><span id="l30.2175" class="difflineplus">+          if (substring) {</span>
<a href="#l30.2176"></a><span id="l30.2176">             uint32_t newFlags;</span>
<a href="#l30.2177"></a><span id="l30.2177">             m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::Attachment, &amp;newFlags);</span>
<a href="#l30.2178"></a><span id="l30.2178">           }</span>
<a href="#l30.2179"></a><span id="l30.2179">         }</span>
<a href="#l30.2180"></a><span id="l30.2180">       }</span>
<a href="#l30.2181"></a><span id="l30.2181" class="difflineminus">-    }</span>
<a href="#l30.2182"></a><span id="l30.2182" class="difflineminus">-    else</span>
<a href="#l30.2183"></a><span id="l30.2183" class="difflineminus">-    {</span>
<a href="#l30.2184"></a><span id="l30.2184" class="difflineplus">+    } else {</span>
<a href="#l30.2185"></a><span id="l30.2185">       NS_ASSERTION(false, &quot;error creating message header&quot;);</span>
<a href="#l30.2186"></a><span id="l30.2186">       rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l30.2187"></a><span id="l30.2187">     }</span>
<a href="#l30.2188"></a><span id="l30.2188" class="difflineminus">-  }</span>
<a href="#l30.2189"></a><span id="l30.2189" class="difflineminus">-  else</span>
<a href="#l30.2190"></a><span id="l30.2190" class="difflineplus">+  } else</span>
<a href="#l30.2191"></a><span id="l30.2191">     rv = NS_OK;</span>
<a href="#l30.2192"></a><span id="l30.2192"> </span>
<a href="#l30.2193"></a><span id="l30.2193">   //### why is this stuff const?</span>
<a href="#l30.2194"></a><span id="l30.2194" class="difflineminus">-  char *tmp = (char*) to.value;</span>
<a href="#l30.2195"></a><span id="l30.2195" class="difflineplus">+  char *tmp = (char *)to.value;</span>
<a href="#l30.2196"></a><span id="l30.2196">   PR_Free(tmp);</span>
<a href="#l30.2197"></a><span id="l30.2197" class="difflineminus">-  tmp = (char*) cc.value;</span>
<a href="#l30.2198"></a><span id="l30.2198" class="difflineplus">+  tmp = (char *)cc.value;</span>
<a href="#l30.2199"></a><span id="l30.2199">   PR_Free(tmp);</span>
<a href="#l30.2200"></a><span id="l30.2200"> </span>
<a href="#l30.2201"></a><span id="l30.2201">   return rv;</span>
<a href="#l30.2202"></a><span id="l30.2202"> }</span>
<a href="#l30.2203"></a><span id="l30.2203"> </span>
<a href="#l30.2204"></a><span id="l30.2204" class="difflineminus">-nsParseNewMailState::nsParseNewMailState()</span>
<a href="#l30.2205"></a><span id="l30.2205" class="difflineminus">-    : m_disableFilters(false)</span>
<a href="#l30.2206"></a><span id="l30.2206" class="difflineminus">-{</span>
<a href="#l30.2207"></a><span id="l30.2207" class="difflineplus">+nsParseNewMailState::nsParseNewMailState() : m_disableFilters(false) {</span>
<a href="#l30.2208"></a><span id="l30.2208">   m_ibuffer = nullptr;</span>
<a href="#l30.2209"></a><span id="l30.2209">   m_ibuffer_size = 0;</span>
<a href="#l30.2210"></a><span id="l30.2210">   m_ibuffer_fp = 0;</span>
<a href="#l30.2211"></a><span id="l30.2211">   m_numNotNewMessages = 0;</span>
<a href="#l30.2212"></a><span id="l30.2212" class="difflineminus">- }</span>
<a href="#l30.2213"></a><span id="l30.2213" class="difflineplus">+}</span>
<a href="#l30.2214"></a><span id="l30.2214"> </span>
<a href="#l30.2215"></a><span id="l30.2215" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsParseNewMailState, nsMsgMailboxParser, nsIMsgFilterHitNotify)</span>
<a href="#l30.2216"></a><span id="l30.2216" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsParseNewMailState, nsMsgMailboxParser,</span>
<a href="#l30.2217"></a><span id="l30.2217" class="difflineplus">+                            nsIMsgFilterHitNotify)</span>
<a href="#l30.2218"></a><span id="l30.2218"> </span>
<a href="#l30.2219"></a><span id="l30.2219" class="difflineminus">-nsresult</span>
<a href="#l30.2220"></a><span id="l30.2220" class="difflineminus">-nsParseNewMailState::Init(nsIMsgFolder *serverFolder, nsIMsgFolder *downloadFolder,</span>
<a href="#l30.2221"></a><span id="l30.2221" class="difflineminus">-                          nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aHdr,</span>
<a href="#l30.2222"></a><span id="l30.2222" class="difflineminus">-                          nsIOutputStream *aOutputStream)</span>
<a href="#l30.2223"></a><span id="l30.2223" class="difflineminus">-{</span>
<a href="#l30.2224"></a><span id="l30.2224" class="difflineplus">+nsresult nsParseNewMailState::Init(nsIMsgFolder *serverFolder,</span>
<a href="#l30.2225"></a><span id="l30.2225" class="difflineplus">+                                   nsIMsgFolder *downloadFolder,</span>
<a href="#l30.2226"></a><span id="l30.2226" class="difflineplus">+                                   nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aHdr,</span>
<a href="#l30.2227"></a><span id="l30.2227" class="difflineplus">+                                   nsIOutputStream *aOutputStream) {</span>
<a href="#l30.2228"></a><span id="l30.2228">   NS_ENSURE_ARG_POINTER(serverFolder);</span>
<a href="#l30.2229"></a><span id="l30.2229">   nsresult rv;</span>
<a href="#l30.2230"></a><span id="l30.2230">   Clear();</span>
<a href="#l30.2231"></a><span id="l30.2231">   m_rootFolder = serverFolder;</span>
<a href="#l30.2232"></a><span id="l30.2232">   m_msgWindow = aMsgWindow;</span>
<a href="#l30.2233"></a><span id="l30.2233">   m_downloadFolder = downloadFolder;</span>
<a href="#l30.2234"></a><span id="l30.2234"> </span>
<a href="#l30.2235"></a><span id="l30.2235">   m_newMsgHdr = aHdr;</span>
<a href="#l30.2236"></a><span id="l30.2236">   m_outputStream = aOutputStream;</span>
<a href="#l30.2237"></a><span id="l30.2237" class="difflineminus">-  // the new mail parser isn't going to get the stream input, it seems, so we can't use</span>
<a href="#l30.2238"></a><span id="l30.2238" class="difflineminus">-  // the OnStartRequest mechanism the mailbox parser uses. So, let's open the db right now.</span>
<a href="#l30.2239"></a><span id="l30.2239" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.2240"></a><span id="l30.2240" class="difflineplus">+  // the new mail parser isn't going to get the stream input, it seems, so we</span>
<a href="#l30.2241"></a><span id="l30.2241" class="difflineplus">+  // can't use the OnStartRequest mechanism the mailbox parser uses. So, let's</span>
<a href="#l30.2242"></a><span id="l30.2242" class="difflineplus">+  // open the db right now.</span>
<a href="#l30.2243"></a><span id="l30.2243" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l30.2244"></a><span id="l30.2244" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.2245"></a><span id="l30.2245">   if (msgDBService &amp;&amp; !m_mailDB)</span>
<a href="#l30.2246"></a><span id="l30.2246">     rv = msgDBService-&gt;OpenFolderDB(downloadFolder, false,</span>
<a href="#l30.2247"></a><span id="l30.2247">                                     getter_AddRefs(m_mailDB));</span>
<a href="#l30.2248"></a><span id="l30.2248">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.2249"></a><span id="l30.2249"> </span>
<a href="#l30.2250"></a><span id="l30.2250">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l30.2251"></a><span id="l30.2251">   rv = serverFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l30.2252"></a><span id="l30.2252" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l30.2253"></a><span id="l30.2253" class="difflineminus">-  {</span>
<a href="#l30.2254"></a><span id="l30.2254" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.2255"></a><span id="l30.2255">     rv = server-&gt;GetFilterList(aMsgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l30.2256"></a><span id="l30.2256"> </span>
<a href="#l30.2257"></a><span id="l30.2257" class="difflineminus">-    if (m_filterList)</span>
<a href="#l30.2258"></a><span id="l30.2258" class="difflineminus">-      rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l30.2259"></a><span id="l30.2259" class="difflineplus">+    if (m_filterList) rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l30.2260"></a><span id="l30.2260">     // check if this server defers to another server, in which case</span>
<a href="#l30.2261"></a><span id="l30.2261">     // we'll use that server's filters as well.</span>
<a href="#l30.2262"></a><span id="l30.2262" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l30.2263"></a><span id="l30.2263" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l30.2264"></a><span id="l30.2264">     server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l30.2265"></a><span id="l30.2265" class="difflineminus">-    if (serverFolder != deferredToRootFolder)</span>
<a href="#l30.2266"></a><span id="l30.2266" class="difflineminus">-    {</span>
<a href="#l30.2267"></a><span id="l30.2267" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; deferredToServer;</span>
<a href="#l30.2268"></a><span id="l30.2268" class="difflineplus">+    if (serverFolder != deferredToRootFolder) {</span>
<a href="#l30.2269"></a><span id="l30.2269" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; deferredToServer;</span>
<a href="#l30.2270"></a><span id="l30.2270">       deferredToRootFolder-&gt;GetServer(getter_AddRefs(deferredToServer));</span>
<a href="#l30.2271"></a><span id="l30.2271">       if (deferredToServer)</span>
<a href="#l30.2272"></a><span id="l30.2272" class="difflineminus">-        deferredToServer-&gt;GetFilterList(aMsgWindow, getter_AddRefs(m_deferredToServerFilterList));</span>
<a href="#l30.2273"></a><span id="l30.2273" class="difflineplus">+        deferredToServer-&gt;GetFilterList(</span>
<a href="#l30.2274"></a><span id="l30.2274" class="difflineplus">+            aMsgWindow, getter_AddRefs(m_deferredToServerFilterList));</span>
<a href="#l30.2275"></a><span id="l30.2275">     }</span>
<a href="#l30.2276"></a><span id="l30.2276">   }</span>
<a href="#l30.2277"></a><span id="l30.2277">   m_disableFilters = false;</span>
<a href="#l30.2278"></a><span id="l30.2278">   return NS_OK;</span>
<a href="#l30.2279"></a><span id="l30.2279"> }</span>
<a href="#l30.2280"></a><span id="l30.2280"> </span>
<a href="#l30.2281"></a><span id="l30.2281" class="difflineminus">-nsParseNewMailState::~nsParseNewMailState()</span>
<a href="#l30.2282"></a><span id="l30.2282" class="difflineminus">-{</span>
<a href="#l30.2283"></a><span id="l30.2283" class="difflineminus">-  if (m_mailDB)</span>
<a href="#l30.2284"></a><span id="l30.2284" class="difflineminus">-    m_mailDB-&gt;Close(true);</span>
<a href="#l30.2285"></a><span id="l30.2285" class="difflineminus">-  if (m_backupMailDB)</span>
<a href="#l30.2286"></a><span id="l30.2286" class="difflineminus">-    m_backupMailDB-&gt;ForceClosed();</span>
<a href="#l30.2287"></a><span id="l30.2287" class="difflineplus">+nsParseNewMailState::~nsParseNewMailState() {</span>
<a href="#l30.2288"></a><span id="l30.2288" class="difflineplus">+  if (m_mailDB) m_mailDB-&gt;Close(true);</span>
<a href="#l30.2289"></a><span id="l30.2289" class="difflineplus">+  if (m_backupMailDB) m_backupMailDB-&gt;ForceClosed();</span>
<a href="#l30.2290"></a><span id="l30.2290"> #ifdef DOING_JSFILTERS</span>
<a href="#l30.2291"></a><span id="l30.2291">   JSFilter_cleanup();</span>
<a href="#l30.2292"></a><span id="l30.2292"> #endif</span>
<a href="#l30.2293"></a><span id="l30.2293"> }</span>
<a href="#l30.2294"></a><span id="l30.2294"> </span>
<a href="#l30.2295"></a><span id="l30.2295"> // not an IMETHOD so we don't need to do error checking or return an error.</span>
<a href="#l30.2296"></a><span id="l30.2296"> // We only have one caller.</span>
<a href="#l30.2297"></a><span id="l30.2297" class="difflineminus">-void nsParseNewMailState::GetMsgWindow(nsIMsgWindow **aMsgWindow)</span>
<a href="#l30.2298"></a><span id="l30.2298" class="difflineminus">-{</span>
<a href="#l30.2299"></a><span id="l30.2299" class="difflineplus">+void nsParseNewMailState::GetMsgWindow(nsIMsgWindow **aMsgWindow) {</span>
<a href="#l30.2300"></a><span id="l30.2300">   NS_IF_ADDREF(*aMsgWindow = m_msgWindow);</span>
<a href="#l30.2301"></a><span id="l30.2301"> }</span>
<a href="#l30.2302"></a><span id="l30.2302"> </span>
<a href="#l30.2303"></a><span id="l30.2303" class="difflineminus">-</span>
<a href="#l30.2304"></a><span id="l30.2304"> // This gets called for every message because libnet calls IncorporateBegin,</span>
<a href="#l30.2305"></a><span id="l30.2305"> // IncorporateWrite (once or more), and IncorporateComplete for every message.</span>
<a href="#l30.2306"></a><span id="l30.2306" class="difflineminus">-void nsParseNewMailState::DoneParsingFolder(nsresult status)</span>
<a href="#l30.2307"></a><span id="l30.2307" class="difflineminus">-{</span>
<a href="#l30.2308"></a><span id="l30.2308" class="difflineplus">+void nsParseNewMailState::DoneParsingFolder(nsresult status) {</span>
<a href="#l30.2309"></a><span id="l30.2309">   /* End of file.  Flush out any partial line remaining in the buffer. */</span>
<a href="#l30.2310"></a><span id="l30.2310" class="difflineminus">-  if (m_ibuffer_fp &gt; 0)</span>
<a href="#l30.2311"></a><span id="l30.2311" class="difflineminus">-  {</span>
<a href="#l30.2312"></a><span id="l30.2312" class="difflineplus">+  if (m_ibuffer_fp &gt; 0) {</span>
<a href="#l30.2313"></a><span id="l30.2313">     ParseFolderLine(m_ibuffer, m_ibuffer_fp);</span>
<a href="#l30.2314"></a><span id="l30.2314">     m_ibuffer_fp = 0;</span>
<a href="#l30.2315"></a><span id="l30.2315">   }</span>
<a href="#l30.2316"></a><span id="l30.2316">   PublishMsgHeader(nullptr);</span>
<a href="#l30.2317"></a><span id="l30.2317">   if (m_mailDB)  // finished parsing, so flush db folder info</span>
<a href="#l30.2318"></a><span id="l30.2318">     UpdateDBFolderInfo();</span>
<a href="#l30.2319"></a><span id="l30.2319"> </span>
<a href="#l30.2320"></a><span id="l30.2320" class="difflineminus">-    /* We're done reading the folder - we don't need these things</span>
<a href="#l30.2321"></a><span id="l30.2321" class="difflineminus">-   any more. */</span>
<a href="#l30.2322"></a><span id="l30.2322" class="difflineminus">-  PR_FREEIF (m_ibuffer);</span>
<a href="#l30.2323"></a><span id="l30.2323" class="difflineplus">+  /* We're done reading the folder - we don't need these things</span>
<a href="#l30.2324"></a><span id="l30.2324" class="difflineplus">+ any more. */</span>
<a href="#l30.2325"></a><span id="l30.2325" class="difflineplus">+  PR_FREEIF(m_ibuffer);</span>
<a href="#l30.2326"></a><span id="l30.2326">   m_ibuffer_size = 0;</span>
<a href="#l30.2327"></a><span id="l30.2327" class="difflineminus">-  PR_FREEIF (m_obuffer);</span>
<a href="#l30.2328"></a><span id="l30.2328" class="difflineplus">+  PR_FREEIF(m_obuffer);</span>
<a href="#l30.2329"></a><span id="l30.2329">   m_obuffer_size = 0;</span>
<a href="#l30.2330"></a><span id="l30.2330"> }</span>
<a href="#l30.2331"></a><span id="l30.2331"> </span>
<a href="#l30.2332"></a><span id="l30.2332" class="difflineminus">-void nsParseNewMailState::OnNewMessage(nsIMsgWindow *msgWindow)</span>
<a href="#l30.2333"></a><span id="l30.2333" class="difflineminus">-{</span>
<a href="#l30.2334"></a><span id="l30.2334" class="difflineminus">-}</span>
<a href="#l30.2335"></a><span id="l30.2335" class="difflineplus">+void nsParseNewMailState::OnNewMessage(nsIMsgWindow *msgWindow) {}</span>
<a href="#l30.2336"></a><span id="l30.2336"> </span>
<a href="#l30.2337"></a><span id="l30.2337" class="difflineminus">-int32_t nsParseNewMailState::PublishMsgHeader(nsIMsgWindow *msgWindow)</span>
<a href="#l30.2338"></a><span id="l30.2338" class="difflineminus">-{</span>
<a href="#l30.2339"></a><span id="l30.2339" class="difflineplus">+int32_t nsParseNewMailState::PublishMsgHeader(nsIMsgWindow *msgWindow) {</span>
<a href="#l30.2340"></a><span id="l30.2340">   bool moved = false;</span>
<a href="#l30.2341"></a><span id="l30.2341">   FinishHeader();</span>
<a href="#l30.2342"></a><span id="l30.2342"> </span>
<a href="#l30.2343"></a><span id="l30.2343" class="difflineminus">-  if (m_newMsgHdr)</span>
<a href="#l30.2344"></a><span id="l30.2344" class="difflineminus">-  {</span>
<a href="#l30.2345"></a><span id="l30.2345" class="difflineplus">+  if (m_newMsgHdr) {</span>
<a href="#l30.2346"></a><span id="l30.2346">     uint32_t newFlags, oldFlags;</span>
<a href="#l30.2347"></a><span id="l30.2347">     m_newMsgHdr-&gt;GetFlags(&amp;oldFlags);</span>
<a href="#l30.2348"></a><span id="l30.2348" class="difflineminus">-    if (!(oldFlags &amp; nsMsgMessageFlags::Read)) // don't mark read messages as new.</span>
<a href="#l30.2349"></a><span id="l30.2349" class="difflineplus">+    if (!(oldFlags &amp;</span>
<a href="#l30.2350"></a><span id="l30.2350" class="difflineplus">+          nsMsgMessageFlags::Read))  // don't mark read messages as new.</span>
<a href="#l30.2351"></a><span id="l30.2351">       m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l30.2352"></a><span id="l30.2352"> </span>
<a href="#l30.2353"></a><span id="l30.2353" class="difflineminus">-    if (!m_disableFilters)</span>
<a href="#l30.2354"></a><span id="l30.2354" class="difflineminus">-    {</span>
<a href="#l30.2355"></a><span id="l30.2355" class="difflineplus">+    if (!m_disableFilters) {</span>
<a href="#l30.2356"></a><span id="l30.2356">       uint64_t msgOffset;</span>
<a href="#l30.2357"></a><span id="l30.2357" class="difflineminus">-      (void) m_newMsgHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l30.2358"></a><span id="l30.2358" class="difflineplus">+      (void)m_newMsgHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l30.2359"></a><span id="l30.2359">       m_curHdrOffset = msgOffset;</span>
<a href="#l30.2360"></a><span id="l30.2360"> </span>
<a href="#l30.2361"></a><span id="l30.2361">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l30.2362"></a><span id="l30.2362">       nsresult rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l30.2363"></a><span id="l30.2363">       NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l30.2364"></a><span id="l30.2364">       int32_t duplicateAction;</span>
<a href="#l30.2365"></a><span id="l30.2365">       server-&gt;GetIncomingDuplicateAction(&amp;duplicateAction);</span>
<a href="#l30.2366"></a><span id="l30.2366" class="difflineminus">-      if (duplicateAction != nsIMsgIncomingServer::keepDups)</span>
<a href="#l30.2367"></a><span id="l30.2367" class="difflineminus">-      {</span>
<a href="#l30.2368"></a><span id="l30.2368" class="difflineplus">+      if (duplicateAction != nsIMsgIncomingServer::keepDups) {</span>
<a href="#l30.2369"></a><span id="l30.2369">         bool isDup;</span>
<a href="#l30.2370"></a><span id="l30.2370">         server-&gt;IsNewHdrDuplicate(m_newMsgHdr, &amp;isDup);</span>
<a href="#l30.2371"></a><span id="l30.2371" class="difflineminus">-        if (isDup)</span>
<a href="#l30.2372"></a><span id="l30.2372" class="difflineminus">-        {</span>
<a href="#l30.2373"></a><span id="l30.2373" class="difflineplus">+        if (isDup) {</span>
<a href="#l30.2374"></a><span id="l30.2374">           // we want to do something similar to applying filter hits.</span>
<a href="#l30.2375"></a><span id="l30.2375">           // if a dup is marked read, it shouldn't trigger biff.</span>
<a href="#l30.2376"></a><span id="l30.2376">           // Same for deleting it or moving it to trash.</span>
<a href="#l30.2377"></a><span id="l30.2377" class="difflineminus">-          switch (duplicateAction)</span>
<a href="#l30.2378"></a><span id="l30.2378" class="difflineminus">-          {</span>
<a href="#l30.2379"></a><span id="l30.2379" class="difflineminus">-            case nsIMsgIncomingServer::deleteDups:</span>
<a href="#l30.2380"></a><span id="l30.2380" class="difflineminus">-              {</span>
<a href="#l30.2381"></a><span id="l30.2381" class="difflineplus">+          switch (duplicateAction) {</span>
<a href="#l30.2382"></a><span id="l30.2382" class="difflineplus">+            case nsIMsgIncomingServer::deleteDups: {</span>
<a href="#l30.2383"></a><span id="l30.2383">               nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l30.2384"></a><span id="l30.2384">               nsresult rv =</span>
<a href="#l30.2385"></a><span id="l30.2385" class="difflineminus">-                m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l30.2386"></a><span id="l30.2386" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l30.2387"></a><span id="l30.2387" class="difflineminus">-              {</span>
<a href="#l30.2388"></a><span id="l30.2388" class="difflineplus">+                  m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l30.2389"></a><span id="l30.2389" class="difflineplus">+              if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.2390"></a><span id="l30.2390">                 rv = msgStore-&gt;DiscardNewMessage(m_outputStream, m_newMsgHdr);</span>
<a href="#l30.2391"></a><span id="l30.2391">                 if (NS_FAILED(rv))</span>
<a href="#l30.2392"></a><span id="l30.2392" class="difflineminus">-                  m_rootFolder-&gt;ThrowAlertMsg(&quot;dupDeleteFolderTruncateFailed&quot;, msgWindow);</span>
<a href="#l30.2393"></a><span id="l30.2393" class="difflineplus">+                  m_rootFolder-&gt;ThrowAlertMsg(&quot;dupDeleteFolderTruncateFailed&quot;,</span>
<a href="#l30.2394"></a><span id="l30.2394" class="difflineplus">+                                              msgWindow);</span>
<a href="#l30.2395"></a><span id="l30.2395">               }</span>
<a href="#l30.2396"></a><span id="l30.2396" class="difflineminus">-                m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l30.2397"></a><span id="l30.2397" class="difflineminus">-              }</span>
<a href="#l30.2398"></a><span id="l30.2398" class="difflineminus">-              break;</span>
<a href="#l30.2399"></a><span id="l30.2399" class="difflineplus">+              m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l30.2400"></a><span id="l30.2400" class="difflineplus">+            } break;</span>
<a href="#l30.2401"></a><span id="l30.2401"> </span>
<a href="#l30.2402"></a><span id="l30.2402" class="difflineminus">-            case nsIMsgIncomingServer::moveDupsToTrash:</span>
<a href="#l30.2403"></a><span id="l30.2403" class="difflineminus">-              {</span>
<a href="#l30.2404"></a><span id="l30.2404" class="difflineminus">-                nsCOMPtr &lt;nsIMsgFolder&gt; trash;</span>
<a href="#l30.2405"></a><span id="l30.2405" class="difflineminus">-                GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l30.2406"></a><span id="l30.2406" class="difflineminus">-                if (trash) {</span>
<a href="#l30.2407"></a><span id="l30.2407" class="difflineminus">-                  uint32_t newFlags;</span>
<a href="#l30.2408"></a><span id="l30.2408" class="difflineminus">-                  bool msgMoved;</span>
<a href="#l30.2409"></a><span id="l30.2409" class="difflineminus">-                  m_newMsgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l30.2410"></a><span id="l30.2410" class="difflineminus">-                  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l30.2411"></a><span id="l30.2411" class="difflineminus">-                  rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l30.2412"></a><span id="l30.2412" class="difflineplus">+            case nsIMsgIncomingServer::moveDupsToTrash: {</span>
<a href="#l30.2413"></a><span id="l30.2413" class="difflineplus">+              nsCOMPtr&lt;nsIMsgFolder&gt; trash;</span>
<a href="#l30.2414"></a><span id="l30.2414" class="difflineplus">+              GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l30.2415"></a><span id="l30.2415" class="difflineplus">+              if (trash) {</span>
<a href="#l30.2416"></a><span id="l30.2416" class="difflineplus">+                uint32_t newFlags;</span>
<a href="#l30.2417"></a><span id="l30.2417" class="difflineplus">+                bool msgMoved;</span>
<a href="#l30.2418"></a><span id="l30.2418" class="difflineplus">+                m_newMsgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l30.2419"></a><span id="l30.2419" class="difflineplus">+                nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l30.2420"></a><span id="l30.2420" class="difflineplus">+                rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l30.2421"></a><span id="l30.2421" class="difflineplus">+                if (NS_SUCCEEDED(rv))</span>
<a href="#l30.2422"></a><span id="l30.2422" class="difflineplus">+                  rv = msgStore-&gt;MoveNewlyDownloadedMessage(m_newMsgHdr, trash,</span>
<a href="#l30.2423"></a><span id="l30.2423" class="difflineplus">+                                                            &amp;msgMoved);</span>
<a href="#l30.2424"></a><span id="l30.2424" class="difflineplus">+                if (NS_SUCCEEDED(rv) &amp;&amp; !msgMoved) {</span>
<a href="#l30.2425"></a><span id="l30.2425" class="difflineplus">+                  rv = MoveIncorporatedMessage(m_newMsgHdr, m_mailDB, trash,</span>
<a href="#l30.2426"></a><span id="l30.2426" class="difflineplus">+                                               nullptr, msgWindow);</span>
<a href="#l30.2427"></a><span id="l30.2427">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l30.2428"></a><span id="l30.2428" class="difflineminus">-                    rv = msgStore-&gt;MoveNewlyDownloadedMessage(m_newMsgHdr, trash, &amp;msgMoved);</span>
<a href="#l30.2429"></a><span id="l30.2429" class="difflineminus">-                  if (NS_SUCCEEDED(rv) &amp;&amp; !msgMoved) {</span>
<a href="#l30.2430"></a><span id="l30.2430" class="difflineminus">-                    rv = MoveIncorporatedMessage(m_newMsgHdr, m_mailDB, trash,</span>
<a href="#l30.2431"></a><span id="l30.2431" class="difflineminus">-                                            nullptr, msgWindow);</span>
<a href="#l30.2432"></a><span id="l30.2432" class="difflineminus">-                    if (NS_SUCCEEDED(rv))</span>
<a href="#l30.2433"></a><span id="l30.2433" class="difflineminus">-                      rv = m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l30.2434"></a><span id="l30.2434" class="difflineminus">-                  }</span>
<a href="#l30.2435"></a><span id="l30.2435" class="difflineminus">-                  if (NS_FAILED(rv))</span>
<a href="#l30.2436"></a><span id="l30.2436" class="difflineminus">-                    NS_WARNING(&quot;moveDupsToTrash failed for some reason.&quot;);</span>
<a href="#l30.2437"></a><span id="l30.2437" class="difflineplus">+                    rv = m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l30.2438"></a><span id="l30.2438">                 }</span>
<a href="#l30.2439"></a><span id="l30.2439" class="difflineplus">+                if (NS_FAILED(rv))</span>
<a href="#l30.2440"></a><span id="l30.2440" class="difflineplus">+                  NS_WARNING(&quot;moveDupsToTrash failed for some reason.&quot;);</span>
<a href="#l30.2441"></a><span id="l30.2441">               }</span>
<a href="#l30.2442"></a><span id="l30.2442" class="difflineminus">-              break;</span>
<a href="#l30.2443"></a><span id="l30.2443" class="difflineplus">+            } break;</span>
<a href="#l30.2444"></a><span id="l30.2444">             case nsIMsgIncomingServer::markDupsRead:</span>
<a href="#l30.2445"></a><span id="l30.2445">               MarkFilteredMessageRead(m_newMsgHdr);</span>
<a href="#l30.2446"></a><span id="l30.2446">               break;</span>
<a href="#l30.2447"></a><span id="l30.2447">           }</span>
<a href="#l30.2448"></a><span id="l30.2448">           int32_t numNewMessages;</span>
<a href="#l30.2449"></a><span id="l30.2449">           m_downloadFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l30.2450"></a><span id="l30.2450">           m_downloadFolder-&gt;SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l30.2451"></a><span id="l30.2451"> </span>
<a href="#l30.2452"></a><span id="l30.2452">           m_newMsgHdr = nullptr;</span>
<a href="#l30.2453"></a><span id="l30.2453">           return 0;</span>
<a href="#l30.2454"></a><span id="l30.2454">         }</span>
<a href="#l30.2455"></a><span id="l30.2455">       }</span>
<a href="#l30.2456"></a><span id="l30.2456"> </span>
<a href="#l30.2457"></a><span id="l30.2457">       ApplyFilters(&amp;moved, msgWindow, msgOffset);</span>
<a href="#l30.2458"></a><span id="l30.2458">     }</span>
<a href="#l30.2459"></a><span id="l30.2459" class="difflineminus">-    if (!moved)</span>
<a href="#l30.2460"></a><span id="l30.2460" class="difflineminus">-    {</span>
<a href="#l30.2461"></a><span id="l30.2461" class="difflineminus">-      if (m_mailDB)</span>
<a href="#l30.2462"></a><span id="l30.2462" class="difflineminus">-      {</span>
<a href="#l30.2463"></a><span id="l30.2463" class="difflineplus">+    if (!moved) {</span>
<a href="#l30.2464"></a><span id="l30.2464" class="difflineplus">+      if (m_mailDB) {</span>
<a href="#l30.2465"></a><span id="l30.2465">         m_mailDB-&gt;AddNewHdrToDB(m_newMsgHdr, true);</span>
<a href="#l30.2466"></a><span id="l30.2466" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l30.2467"></a><span id="l30.2467" class="difflineminus">-        if (notifier)</span>
<a href="#l30.2468"></a><span id="l30.2468" class="difflineminus">-          notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l30.2469"></a><span id="l30.2469" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l30.2470"></a><span id="l30.2470" class="difflineplus">+            do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l30.2471"></a><span id="l30.2471" class="difflineplus">+        if (notifier) notifier-&gt;NotifyMsgAdded(m_newMsgHdr);</span>
<a href="#l30.2472"></a><span id="l30.2472">         // mark the header as not yet reported classified</span>
<a href="#l30.2473"></a><span id="l30.2473">         nsMsgKey msgKey;</span>
<a href="#l30.2474"></a><span id="l30.2474">         m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2475"></a><span id="l30.2475">         m_downloadFolder-&gt;OrProcessingFlags(</span>
<a href="#l30.2476"></a><span id="l30.2476" class="difflineminus">-           msgKey, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l30.2477"></a><span id="l30.2477" class="difflineplus">+            msgKey, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l30.2478"></a><span id="l30.2478">       }</span>
<a href="#l30.2479"></a><span id="l30.2479" class="difflineminus">-    } // if it was moved by imap filter, m_parseMsgState-&gt;m_newMsgHdr == nullptr</span>
<a href="#l30.2480"></a><span id="l30.2480" class="difflineplus">+    }  // if it was moved by imap filter, m_parseMsgState-&gt;m_newMsgHdr ==</span>
<a href="#l30.2481"></a><span id="l30.2481" class="difflineplus">+       // nullptr</span>
<a href="#l30.2482"></a><span id="l30.2482">     m_newMsgHdr = nullptr;</span>
<a href="#l30.2483"></a><span id="l30.2483">   }</span>
<a href="#l30.2484"></a><span id="l30.2484">   return 0;</span>
<a href="#l30.2485"></a><span id="l30.2485"> }</span>
<a href="#l30.2486"></a><span id="l30.2486"> </span>
<a href="#l30.2487"></a><span id="l30.2487"> // We've found the start of the next message, so finish this one off.</span>
<a href="#l30.2488"></a><span id="l30.2488" class="difflineminus">-NS_IMETHODIMP nsParseNewMailState::FinishHeader()</span>
<a href="#l30.2489"></a><span id="l30.2489" class="difflineminus">-{</span>
<a href="#l30.2490"></a><span id="l30.2490" class="difflineminus">-  if (m_newMsgHdr)</span>
<a href="#l30.2491"></a><span id="l30.2491" class="difflineminus">-  {</span>
<a href="#l30.2492"></a><span id="l30.2492" class="difflineminus">-    if (m_lastLineBlank)</span>
<a href="#l30.2493"></a><span id="l30.2493" class="difflineminus">-      m_body_lines--;</span>
<a href="#l30.2494"></a><span id="l30.2494" class="difflineplus">+NS_IMETHODIMP nsParseNewMailState::FinishHeader() {</span>
<a href="#l30.2495"></a><span id="l30.2495" class="difflineplus">+  if (m_newMsgHdr) {</span>
<a href="#l30.2496"></a><span id="l30.2496" class="difflineplus">+    if (m_lastLineBlank) m_body_lines--;</span>
<a href="#l30.2497"></a><span id="l30.2497">     m_newMsgHdr-&gt;SetMessageSize(m_position - m_envelope_pos - m_lastLineBlank);</span>
<a href="#l30.2498"></a><span id="l30.2498">     m_newMsgHdr-&gt;SetLineCount(m_body_lines);</span>
<a href="#l30.2499"></a><span id="l30.2499">   }</span>
<a href="#l30.2500"></a><span id="l30.2500">   return NS_OK;</span>
<a href="#l30.2501"></a><span id="l30.2501"> }</span>
<a href="#l30.2502"></a><span id="l30.2502"> </span>
<a href="#l30.2503"></a><span id="l30.2503" class="difflineminus">-nsresult nsParseNewMailState::GetTrashFolder(nsIMsgFolder **pTrashFolder)</span>
<a href="#l30.2504"></a><span id="l30.2504" class="difflineminus">-{</span>
<a href="#l30.2505"></a><span id="l30.2505" class="difflineminus">-  nsresult rv=NS_ERROR_UNEXPECTED;</span>
<a href="#l30.2506"></a><span id="l30.2506" class="difflineminus">-  if (!pTrashFolder)</span>
<a href="#l30.2507"></a><span id="l30.2507" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.2508"></a><span id="l30.2508" class="difflineplus">+nsresult nsParseNewMailState::GetTrashFolder(nsIMsgFolder **pTrashFolder) {</span>
<a href="#l30.2509"></a><span id="l30.2509" class="difflineplus">+  nsresult rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l30.2510"></a><span id="l30.2510" class="difflineplus">+  if (!pTrashFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.2511"></a><span id="l30.2511"> </span>
<a href="#l30.2512"></a><span id="l30.2512" class="difflineminus">-  if (m_downloadFolder)</span>
<a href="#l30.2513"></a><span id="l30.2513" class="difflineminus">-  {</span>
<a href="#l30.2514"></a><span id="l30.2514" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l30.2515"></a><span id="l30.2515" class="difflineplus">+  if (m_downloadFolder) {</span>
<a href="#l30.2516"></a><span id="l30.2516" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l30.2517"></a><span id="l30.2517">     m_downloadFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l30.2518"></a><span id="l30.2518" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l30.2519"></a><span id="l30.2519" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l30.2520"></a><span id="l30.2520">     incomingServer-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l30.2521"></a><span id="l30.2521" class="difflineminus">-    if (rootMsgFolder)</span>
<a href="#l30.2522"></a><span id="l30.2522" class="difflineminus">-    {</span>
<a href="#l30.2523"></a><span id="l30.2523" class="difflineminus">-      rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Trash, pTrashFolder);</span>
<a href="#l30.2524"></a><span id="l30.2524" class="difflineminus">-      if (!*pTrashFolder)</span>
<a href="#l30.2525"></a><span id="l30.2525" class="difflineminus">-        rv = NS_ERROR_FAILURE;</span>
<a href="#l30.2526"></a><span id="l30.2526" class="difflineplus">+    if (rootMsgFolder) {</span>
<a href="#l30.2527"></a><span id="l30.2527" class="difflineplus">+      rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Trash,</span>
<a href="#l30.2528"></a><span id="l30.2528" class="difflineplus">+                                             pTrashFolder);</span>
<a href="#l30.2529"></a><span id="l30.2529" class="difflineplus">+      if (!*pTrashFolder) rv = NS_ERROR_FAILURE;</span>
<a href="#l30.2530"></a><span id="l30.2530">     }</span>
<a href="#l30.2531"></a><span id="l30.2531">   }</span>
<a href="#l30.2532"></a><span id="l30.2532">   return rv;</span>
<a href="#l30.2533"></a><span id="l30.2533"> }</span>
<a href="#l30.2534"></a><span id="l30.2534"> </span>
<a href="#l30.2535"></a><span id="l30.2535" class="difflineminus">-void nsParseNewMailState::ApplyFilters(bool *pMoved, nsIMsgWindow *msgWindow, uint64_t msgOffset)</span>
<a href="#l30.2536"></a><span id="l30.2536" class="difflineminus">-{</span>
<a href="#l30.2537"></a><span id="l30.2537" class="difflineplus">+void nsParseNewMailState::ApplyFilters(bool *pMoved, nsIMsgWindow *msgWindow,</span>
<a href="#l30.2538"></a><span id="l30.2538" class="difflineplus">+                                       uint64_t msgOffset) {</span>
<a href="#l30.2539"></a><span id="l30.2539">   m_msgMovedByFilter = m_msgCopiedByFilter = false;</span>
<a href="#l30.2540"></a><span id="l30.2540">   m_curHdrOffset = msgOffset;</span>
<a href="#l30.2541"></a><span id="l30.2541"> </span>
<a href="#l30.2542"></a><span id="l30.2542" class="difflineminus">-  if (!m_disableFilters)</span>
<a href="#l30.2543"></a><span id="l30.2543" class="difflineminus">-  {</span>
<a href="#l30.2544"></a><span id="l30.2544" class="difflineplus">+  if (!m_disableFilters) {</span>
<a href="#l30.2545"></a><span id="l30.2545">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_newMsgHdr;</span>
<a href="#l30.2546"></a><span id="l30.2546">     nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder = m_downloadFolder;</span>
<a href="#l30.2547"></a><span id="l30.2547" class="difflineminus">-    if (m_rootFolder)</span>
<a href="#l30.2548"></a><span id="l30.2548" class="difflineminus">-    {</span>
<a href="#l30.2549"></a><span id="l30.2549" class="difflineplus">+    if (m_rootFolder) {</span>
<a href="#l30.2550"></a><span id="l30.2550">       if (!downloadFolder)</span>
<a href="#l30.2551"></a><span id="l30.2551">         m_rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l30.2552"></a><span id="l30.2552" class="difflineminus">-                                          getter_AddRefs(downloadFolder));</span>
<a href="#l30.2553"></a><span id="l30.2553" class="difflineminus">-      if (downloadFolder)</span>
<a href="#l30.2554"></a><span id="l30.2554" class="difflineminus">-        downloadFolder-&gt;GetURI(m_inboxUri);</span>
<a href="#l30.2555"></a><span id="l30.2555" class="difflineminus">-      char * headers = m_headers.GetBuffer();</span>
<a href="#l30.2556"></a><span id="l30.2556" class="difflineplus">+                                         getter_AddRefs(downloadFolder));</span>
<a href="#l30.2557"></a><span id="l30.2557" class="difflineplus">+      if (downloadFolder) downloadFolder-&gt;GetURI(m_inboxUri);</span>
<a href="#l30.2558"></a><span id="l30.2558" class="difflineplus">+      char *headers = m_headers.GetBuffer();</span>
<a href="#l30.2559"></a><span id="l30.2559">       uint32_t headersSize = m_headers.GetBufferPos();</span>
<a href="#l30.2560"></a><span id="l30.2560">       if (m_filterList)</span>
<a href="#l30.2561"></a><span id="l30.2561" class="difflineminus">-        (void) m_filterList-&gt;</span>
<a href="#l30.2562"></a><span id="l30.2562" class="difflineminus">-          ApplyFiltersToHdr(nsMsgFilterType::InboxRule, msgHdr, downloadFolder,</span>
<a href="#l30.2563"></a><span id="l30.2563" class="difflineminus">-                            m_mailDB, nsDependentCSubstring(headers, headersSize), this, msgWindow);</span>
<a href="#l30.2564"></a><span id="l30.2564" class="difflineminus">-      if (!m_msgMovedByFilter &amp;&amp; m_deferredToServerFilterList)</span>
<a href="#l30.2565"></a><span id="l30.2565" class="difflineminus">-      {</span>
<a href="#l30.2566"></a><span id="l30.2566" class="difflineminus">-        (void) m_deferredToServerFilterList-&gt;</span>
<a href="#l30.2567"></a><span id="l30.2567" class="difflineminus">-          ApplyFiltersToHdr(nsMsgFilterType::InboxRule, msgHdr, downloadFolder,</span>
<a href="#l30.2568"></a><span id="l30.2568" class="difflineminus">-                            m_mailDB, nsDependentCSubstring(headers, headersSize), this, msgWindow);</span>
<a href="#l30.2569"></a><span id="l30.2569" class="difflineplus">+        (void)m_filterList-&gt;ApplyFiltersToHdr(</span>
<a href="#l30.2570"></a><span id="l30.2570" class="difflineplus">+            nsMsgFilterType::InboxRule, msgHdr, downloadFolder, m_mailDB,</span>
<a href="#l30.2571"></a><span id="l30.2571" class="difflineplus">+            nsDependentCSubstring(headers, headersSize), this, msgWindow);</span>
<a href="#l30.2572"></a><span id="l30.2572" class="difflineplus">+      if (!m_msgMovedByFilter &amp;&amp; m_deferredToServerFilterList) {</span>
<a href="#l30.2573"></a><span id="l30.2573" class="difflineplus">+        (void)m_deferredToServerFilterList-&gt;ApplyFiltersToHdr(</span>
<a href="#l30.2574"></a><span id="l30.2574" class="difflineplus">+            nsMsgFilterType::InboxRule, msgHdr, downloadFolder, m_mailDB,</span>
<a href="#l30.2575"></a><span id="l30.2575" class="difflineplus">+            nsDependentCSubstring(headers, headersSize), this, msgWindow);</span>
<a href="#l30.2576"></a><span id="l30.2576">       }</span>
<a href="#l30.2577"></a><span id="l30.2577">     }</span>
<a href="#l30.2578"></a><span id="l30.2578">   }</span>
<a href="#l30.2579"></a><span id="l30.2579" class="difflineminus">-  if (pMoved)</span>
<a href="#l30.2580"></a><span id="l30.2580" class="difflineminus">-    *pMoved = m_msgMovedByFilter;</span>
<a href="#l30.2581"></a><span id="l30.2581" class="difflineplus">+  if (pMoved) *pMoved = m_msgMovedByFilter;</span>
<a href="#l30.2582"></a><span id="l30.2582"> }</span>
<a href="#l30.2583"></a><span id="l30.2583"> </span>
<a href="#l30.2584"></a><span id="l30.2584" class="difflineminus">-NS_IMETHODIMP nsParseNewMailState::ApplyFilterHit(nsIMsgFilter *filter, nsIMsgWindow *msgWindow, bool *applyMore)</span>
<a href="#l30.2585"></a><span id="l30.2585" class="difflineminus">-{</span>
<a href="#l30.2586"></a><span id="l30.2586" class="difflineplus">+NS_IMETHODIMP nsParseNewMailState::ApplyFilterHit(nsIMsgFilter *filter,</span>
<a href="#l30.2587"></a><span id="l30.2587" class="difflineplus">+                                                  nsIMsgWindow *msgWindow,</span>
<a href="#l30.2588"></a><span id="l30.2588" class="difflineplus">+                                                  bool *applyMore) {</span>
<a href="#l30.2589"></a><span id="l30.2589">   NS_ENSURE_ARG_POINTER(filter);</span>
<a href="#l30.2590"></a><span id="l30.2590">   NS_ENSURE_ARG_POINTER(applyMore);</span>
<a href="#l30.2591"></a><span id="l30.2591"> </span>
<a href="#l30.2592"></a><span id="l30.2592">   uint32_t newFlags;</span>
<a href="#l30.2593"></a><span id="l30.2593">   nsresult rv = NS_OK;</span>
<a href="#l30.2594"></a><span id="l30.2594"> </span>
<a href="#l30.2595"></a><span id="l30.2595">   *applyMore = true;</span>
<a href="#l30.2596"></a><span id="l30.2596"> </span>
<a href="#l30.2597"></a><span id="l30.2597" class="difflineat">@@ -1973,521 +1814,482 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l30.2598"></a><span id="l30.2598">   rv = filterActionList-&gt;GetLength(&amp;numActions);</span>
<a href="#l30.2599"></a><span id="l30.2599">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.2600"></a><span id="l30.2600"> </span>
<a href="#l30.2601"></a><span id="l30.2601">   bool loggingEnabled = false;</span>
<a href="#l30.2602"></a><span id="l30.2602">   if (m_filterList &amp;&amp; numActions)</span>
<a href="#l30.2603"></a><span id="l30.2603">     m_filterList-&gt;GetLoggingEnabled(&amp;loggingEnabled);</span>
<a href="#l30.2604"></a><span id="l30.2604"> </span>
<a href="#l30.2605"></a><span id="l30.2605">   bool msgIsNew = true;</span>
<a href="#l30.2606"></a><span id="l30.2606" class="difflineminus">-  for (uint32_t actionIndex = 0; actionIndex &lt; numActions &amp;&amp; *applyMore; actionIndex++)</span>
<a href="#l30.2607"></a><span id="l30.2607" class="difflineminus">-  {</span>
<a href="#l30.2608"></a><span id="l30.2608" class="difflineplus">+  for (uint32_t actionIndex = 0; actionIndex &lt; numActions &amp;&amp; *applyMore;</span>
<a href="#l30.2609"></a><span id="l30.2609" class="difflineplus">+       actionIndex++) {</span>
<a href="#l30.2610"></a><span id="l30.2610">     nsCOMPtr&lt;nsIMsgRuleAction&gt; filterAction =</span>
<a href="#l30.2611"></a><span id="l30.2611" class="difflineminus">-      do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l30.2612"></a><span id="l30.2612" class="difflineminus">-    if (NS_FAILED(rv) || !filterAction)</span>
<a href="#l30.2613"></a><span id="l30.2613" class="difflineminus">-      continue;</span>
<a href="#l30.2614"></a><span id="l30.2614" class="difflineplus">+        do_QueryElementAt(filterActionList, actionIndex, &amp;rv);</span>
<a href="#l30.2615"></a><span id="l30.2615" class="difflineplus">+    if (NS_FAILED(rv) || !filterAction) continue;</span>
<a href="#l30.2616"></a><span id="l30.2616"> </span>
<a href="#l30.2617"></a><span id="l30.2617">     nsMsgRuleActionType actionType;</span>
<a href="#l30.2618"></a><span id="l30.2618" class="difflineminus">-    if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType)))</span>
<a href="#l30.2619"></a><span id="l30.2619" class="difflineminus">-    {</span>
<a href="#l30.2620"></a><span id="l30.2620" class="difflineminus">-      if (loggingEnabled)</span>
<a href="#l30.2621"></a><span id="l30.2621" class="difflineminus">-        (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l30.2622"></a><span id="l30.2622" class="difflineplus">+    if (NS_SUCCEEDED(filterAction-&gt;GetType(&amp;actionType))) {</span>
<a href="#l30.2623"></a><span id="l30.2623" class="difflineplus">+      if (loggingEnabled) (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l30.2624"></a><span id="l30.2624"> </span>
<a href="#l30.2625"></a><span id="l30.2625">       nsCString actionTargetFolderUri;</span>
<a href="#l30.2626"></a><span id="l30.2626">       if (actionType == nsMsgFilterAction::MoveToFolder ||</span>
<a href="#l30.2627"></a><span id="l30.2627" class="difflineminus">-          actionType == nsMsgFilterAction::CopyToFolder)</span>
<a href="#l30.2628"></a><span id="l30.2628" class="difflineminus">-      {</span>
<a href="#l30.2629"></a><span id="l30.2629" class="difflineminus">-</span>
<a href="#l30.2630"></a><span id="l30.2630" class="difflineplus">+          actionType == nsMsgFilterAction::CopyToFolder) {</span>
<a href="#l30.2631"></a><span id="l30.2631">         rv = filterAction-&gt;GetTargetFolderUri(actionTargetFolderUri);</span>
<a href="#l30.2632"></a><span id="l30.2632" class="difflineminus">-        if (NS_FAILED(rv) || actionTargetFolderUri.IsEmpty())</span>
<a href="#l30.2633"></a><span id="l30.2633" class="difflineminus">-        {</span>
<a href="#l30.2634"></a><span id="l30.2634" class="difflineplus">+        if (NS_FAILED(rv) || actionTargetFolderUri.IsEmpty()) {</span>
<a href="#l30.2635"></a><span id="l30.2635">           NS_ASSERTION(false, &quot;actionTargetFolderUri is empty&quot;);</span>
<a href="#l30.2636"></a><span id="l30.2636">           continue;</span>
<a href="#l30.2637"></a><span id="l30.2637">         }</span>
<a href="#l30.2638"></a><span id="l30.2638">       }</span>
<a href="#l30.2639"></a><span id="l30.2639" class="difflineminus">-      switch (actionType)</span>
<a href="#l30.2640"></a><span id="l30.2640" class="difflineminus">-      {</span>
<a href="#l30.2641"></a><span id="l30.2641" class="difflineminus">-      case nsMsgFilterAction::Delete:</span>
<a href="#l30.2642"></a><span id="l30.2642" class="difflineminus">-        {</span>
<a href="#l30.2643"></a><span id="l30.2643" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; trash;</span>
<a href="#l30.2644"></a><span id="l30.2644" class="difflineplus">+      switch (actionType) {</span>
<a href="#l30.2645"></a><span id="l30.2645" class="difflineplus">+        case nsMsgFilterAction::Delete: {</span>
<a href="#l30.2646"></a><span id="l30.2646" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; trash;</span>
<a href="#l30.2647"></a><span id="l30.2647">           // set value to trash folder</span>
<a href="#l30.2648"></a><span id="l30.2648">           rv = GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l30.2649"></a><span id="l30.2649">           if (NS_SUCCEEDED(rv) &amp;&amp; trash)</span>
<a href="#l30.2650"></a><span id="l30.2650">             rv = trash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l30.2651"></a><span id="l30.2651"> </span>
<a href="#l30.2652"></a><span id="l30.2652" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags); // mark read in trash.</span>
<a href="#l30.2653"></a><span id="l30.2653" class="difflineplus">+          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read,</span>
<a href="#l30.2654"></a><span id="l30.2654" class="difflineplus">+                          &amp;newFlags);  // mark read in trash.</span>
<a href="#l30.2655"></a><span id="l30.2655">           msgIsNew = false;</span>
<a href="#l30.2656"></a><span id="l30.2656">         }</span>
<a href="#l30.2657"></a><span id="l30.2657"> </span>
<a href="#l30.2658"></a><span id="l30.2658" class="difflineminus">-        // FALLTHROUGH</span>
<a href="#l30.2659"></a><span id="l30.2659" class="difflineminus">-        MOZ_FALLTHROUGH;</span>
<a href="#l30.2660"></a><span id="l30.2660" class="difflineminus">-      case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l30.2661"></a><span id="l30.2661" class="difflineminus">-        // if moving to a different file, do it.</span>
<a href="#l30.2662"></a><span id="l30.2662" class="difflineminus">-        if (actionTargetFolderUri.get() &amp;&amp; !m_inboxUri.Equals(actionTargetFolderUri,</span>
<a href="#l30.2663"></a><span id="l30.2663" class="difflineminus">-                                                              nsCaseInsensitiveCStringComparator()))</span>
<a href="#l30.2664"></a><span id="l30.2664" class="difflineminus">-        {</span>
<a href="#l30.2665"></a><span id="l30.2665" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l30.2666"></a><span id="l30.2666" class="difflineminus">-          nsresult err = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l30.2667"></a><span id="l30.2667" class="difflineminus">-            getter_AddRefs(destIFolder));</span>
<a href="#l30.2668"></a><span id="l30.2668" class="difflineminus">-          NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l30.2669"></a><span id="l30.2669" class="difflineminus">-          bool msgMoved = false;</span>
<a href="#l30.2670"></a><span id="l30.2670" class="difflineminus">-          // If we're moving to an imap folder, or this message has already</span>
<a href="#l30.2671"></a><span id="l30.2671" class="difflineminus">-          // has a pending copy action, use the imap coalescer so that</span>
<a href="#l30.2672"></a><span id="l30.2672" class="difflineminus">-          // we won't truncate the inbox before the copy fires.</span>
<a href="#l30.2673"></a><span id="l30.2673" class="difflineminus">-          if (m_msgCopiedByFilter ||</span>
<a href="#l30.2674"></a><span id="l30.2674" class="difflineminus">-              StringBeginsWith(actionTargetFolderUri, NS_LITERAL_CSTRING(&quot;imap:&quot;)))</span>
<a href="#l30.2675"></a><span id="l30.2675" class="difflineminus">-          {</span>
<a href="#l30.2676"></a><span id="l30.2676" class="difflineminus">-            if (!m_moveCoalescer)</span>
<a href="#l30.2677"></a><span id="l30.2677" class="difflineminus">-              m_moveCoalescer = new nsImapMoveCoalescer(m_downloadFolder, m_msgWindow);</span>
<a href="#l30.2678"></a><span id="l30.2678" class="difflineminus">-            NS_ENSURE_TRUE(m_moveCoalescer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l30.2679"></a><span id="l30.2679" class="difflineminus">-            nsMsgKey msgKey;</span>
<a href="#l30.2680"></a><span id="l30.2680" class="difflineminus">-            (void) msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2681"></a><span id="l30.2681" class="difflineminus">-            m_moveCoalescer-&gt;AddMove(destIFolder, msgKey);</span>
<a href="#l30.2682"></a><span id="l30.2682" class="difflineminus">-            err = NS_OK;</span>
<a href="#l30.2683"></a><span id="l30.2683" class="difflineminus">-            msgIsNew = false;</span>
<a href="#l30.2684"></a><span id="l30.2684" class="difflineminus">-          }</span>
<a href="#l30.2685"></a><span id="l30.2685" class="difflineminus">-          else</span>
<a href="#l30.2686"></a><span id="l30.2686" class="difflineminus">-          {</span>
<a href="#l30.2687"></a><span id="l30.2687" class="difflineminus">-            nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l30.2688"></a><span id="l30.2688" class="difflineminus">-            err = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l30.2689"></a><span id="l30.2689" class="difflineminus">-            if (NS_SUCCEEDED(err))</span>
<a href="#l30.2690"></a><span id="l30.2690" class="difflineminus">-              err = msgStore-&gt;MoveNewlyDownloadedMessage(msgHdr, destIFolder, &amp;msgMoved);</span>
<a href="#l30.2691"></a><span id="l30.2691" class="difflineminus">-            if (NS_SUCCEEDED(err) &amp;&amp; !msgMoved)</span>
<a href="#l30.2692"></a><span id="l30.2692" class="difflineminus">-              err = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l30.2693"></a><span id="l30.2693" class="difflineminus">-                                            filter, msgWindow);</span>
<a href="#l30.2694"></a><span id="l30.2694" class="difflineminus">-            m_msgMovedByFilter = NS_SUCCEEDED(err);</span>
<a href="#l30.2695"></a><span id="l30.2695" class="difflineminus">-            if (!m_msgMovedByFilter /* == NS_FAILED(err) */)</span>
<a href="#l30.2696"></a><span id="l30.2696" class="difflineminus">-            {</span>
<a href="#l30.2697"></a><span id="l30.2697" class="difflineminus">-              // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l30.2698"></a><span id="l30.2698" class="difflineminus">-              if (loggingEnabled) {</span>
<a href="#l30.2699"></a><span id="l30.2699" class="difflineminus">-                (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, err,</span>
<a href="#l30.2700"></a><span id="l30.2700" class="difflineminus">-                                              NS_LITERAL_CSTRING(&quot;filterFailureMoveFailed&quot;));</span>
<a href="#l30.2701"></a><span id="l30.2701" class="difflineplus">+          // FALLTHROUGH</span>
<a href="#l30.2702"></a><span id="l30.2702" class="difflineplus">+          MOZ_FALLTHROUGH;</span>
<a href="#l30.2703"></a><span id="l30.2703" class="difflineplus">+        case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l30.2704"></a><span id="l30.2704" class="difflineplus">+          // if moving to a different file, do it.</span>
<a href="#l30.2705"></a><span id="l30.2705" class="difflineplus">+          if (actionTargetFolderUri.get() &amp;&amp;</span>
<a href="#l30.2706"></a><span id="l30.2706" class="difflineplus">+              !m_inboxUri.Equals(actionTargetFolderUri,</span>
<a href="#l30.2707"></a><span id="l30.2707" class="difflineplus">+                                 nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l30.2708"></a><span id="l30.2708" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder;</span>
<a href="#l30.2709"></a><span id="l30.2709" class="difflineplus">+            nsresult err = GetOrCreateFolder(actionTargetFolderUri,</span>
<a href="#l30.2710"></a><span id="l30.2710" class="difflineplus">+                                             getter_AddRefs(destIFolder));</span>
<a href="#l30.2711"></a><span id="l30.2711" class="difflineplus">+            NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l30.2712"></a><span id="l30.2712" class="difflineplus">+            bool msgMoved = false;</span>
<a href="#l30.2713"></a><span id="l30.2713" class="difflineplus">+            // If we're moving to an imap folder, or this message has already</span>
<a href="#l30.2714"></a><span id="l30.2714" class="difflineplus">+            // has a pending copy action, use the imap coalescer so that</span>
<a href="#l30.2715"></a><span id="l30.2715" class="difflineplus">+            // we won't truncate the inbox before the copy fires.</span>
<a href="#l30.2716"></a><span id="l30.2716" class="difflineplus">+            if (m_msgCopiedByFilter ||</span>
<a href="#l30.2717"></a><span id="l30.2717" class="difflineplus">+                StringBeginsWith(actionTargetFolderUri,</span>
<a href="#l30.2718"></a><span id="l30.2718" class="difflineplus">+                                 NS_LITERAL_CSTRING(&quot;imap:&quot;))) {</span>
<a href="#l30.2719"></a><span id="l30.2719" class="difflineplus">+              if (!m_moveCoalescer)</span>
<a href="#l30.2720"></a><span id="l30.2720" class="difflineplus">+                m_moveCoalescer =</span>
<a href="#l30.2721"></a><span id="l30.2721" class="difflineplus">+                    new nsImapMoveCoalescer(m_downloadFolder, m_msgWindow);</span>
<a href="#l30.2722"></a><span id="l30.2722" class="difflineplus">+              NS_ENSURE_TRUE(m_moveCoalescer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l30.2723"></a><span id="l30.2723" class="difflineplus">+              nsMsgKey msgKey;</span>
<a href="#l30.2724"></a><span id="l30.2724" class="difflineplus">+              (void)msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2725"></a><span id="l30.2725" class="difflineplus">+              m_moveCoalescer-&gt;AddMove(destIFolder, msgKey);</span>
<a href="#l30.2726"></a><span id="l30.2726" class="difflineplus">+              err = NS_OK;</span>
<a href="#l30.2727"></a><span id="l30.2727" class="difflineplus">+              msgIsNew = false;</span>
<a href="#l30.2728"></a><span id="l30.2728" class="difflineplus">+            } else {</span>
<a href="#l30.2729"></a><span id="l30.2729" class="difflineplus">+              nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l30.2730"></a><span id="l30.2730" class="difflineplus">+              err = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l30.2731"></a><span id="l30.2731" class="difflineplus">+              if (NS_SUCCEEDED(err))</span>
<a href="#l30.2732"></a><span id="l30.2732" class="difflineplus">+                err = msgStore-&gt;MoveNewlyDownloadedMessage(msgHdr, destIFolder,</span>
<a href="#l30.2733"></a><span id="l30.2733" class="difflineplus">+                                                           &amp;msgMoved);</span>
<a href="#l30.2734"></a><span id="l30.2734" class="difflineplus">+              if (NS_SUCCEEDED(err) &amp;&amp; !msgMoved)</span>
<a href="#l30.2735"></a><span id="l30.2735" class="difflineplus">+                err = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l30.2736"></a><span id="l30.2736" class="difflineplus">+                                              filter, msgWindow);</span>
<a href="#l30.2737"></a><span id="l30.2737" class="difflineplus">+              m_msgMovedByFilter = NS_SUCCEEDED(err);</span>
<a href="#l30.2738"></a><span id="l30.2738" class="difflineplus">+              if (!m_msgMovedByFilter /* == NS_FAILED(err) */) {</span>
<a href="#l30.2739"></a><span id="l30.2739" class="difflineplus">+                // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l30.2740"></a><span id="l30.2740" class="difflineplus">+                if (loggingEnabled) {</span>
<a href="#l30.2741"></a><span id="l30.2741" class="difflineplus">+                  (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l30.2742"></a><span id="l30.2742" class="difflineplus">+                      filterAction, msgHdr, err,</span>
<a href="#l30.2743"></a><span id="l30.2743" class="difflineplus">+                      NS_LITERAL_CSTRING(&quot;filterFailureMoveFailed&quot;));</span>
<a href="#l30.2744"></a><span id="l30.2744" class="difflineplus">+                }</span>
<a href="#l30.2745"></a><span id="l30.2745">               }</span>
<a href="#l30.2746"></a><span id="l30.2746">             }</span>
<a href="#l30.2747"></a><span id="l30.2747">           }</span>
<a href="#l30.2748"></a><span id="l30.2748" class="difflineminus">-        }</span>
<a href="#l30.2749"></a><span id="l30.2749" class="difflineminus">-        *applyMore = false;</span>
<a href="#l30.2750"></a><span id="l30.2750" class="difflineminus">-        break;</span>
<a href="#l30.2751"></a><span id="l30.2751" class="difflineplus">+          *applyMore = false;</span>
<a href="#l30.2752"></a><span id="l30.2752" class="difflineplus">+          break;</span>
<a href="#l30.2753"></a><span id="l30.2753"> </span>
<a href="#l30.2754"></a><span id="l30.2754" class="difflineminus">-        case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l30.2755"></a><span id="l30.2755" class="difflineminus">-        {</span>
<a href="#l30.2756"></a><span id="l30.2756" class="difflineplus">+        case nsMsgFilterAction::CopyToFolder: {</span>
<a href="#l30.2757"></a><span id="l30.2757">           nsCString uri;</span>
<a href="#l30.2758"></a><span id="l30.2758">           rv = m_rootFolder-&gt;GetURI(uri);</span>
<a href="#l30.2759"></a><span id="l30.2759"> </span>
<a href="#l30.2760"></a><span id="l30.2760" class="difflineminus">-          if (!actionTargetFolderUri.IsEmpty() &amp;&amp; !actionTargetFolderUri.Equals(uri))</span>
<a href="#l30.2761"></a><span id="l30.2761" class="difflineminus">-          {</span>
<a href="#l30.2762"></a><span id="l30.2762" class="difflineminus">-            nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.2763"></a><span id="l30.2763" class="difflineplus">+          if (!actionTargetFolderUri.IsEmpty() &amp;&amp;</span>
<a href="#l30.2764"></a><span id="l30.2764" class="difflineplus">+              !actionTargetFolderUri.Equals(uri)) {</span>
<a href="#l30.2765"></a><span id="l30.2765" class="difflineplus">+            nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.2766"></a><span id="l30.2766" class="difflineplus">+                do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.2767"></a><span id="l30.2767">             messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.2768"></a><span id="l30.2768"> </span>
<a href="#l30.2769"></a><span id="l30.2769">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l30.2770"></a><span id="l30.2770">             nsCOMPtr&lt;nsIMsgCopyService&gt; copyService;</span>
<a href="#l30.2771"></a><span id="l30.2771">             rv = GetExistingFolder(actionTargetFolderUri,</span>
<a href="#l30.2772"></a><span id="l30.2772">                                    getter_AddRefs(dstFolder));</span>
<a href="#l30.2773"></a><span id="l30.2773">             if (NS_FAILED(rv)) {</span>
<a href="#l30.2774"></a><span id="l30.2774">               // Let's show a more specific warning.</span>
<a href="#l30.2775"></a><span id="l30.2775">               NS_WARNING(&quot;Target Folder does not exist.&quot;);</span>
<a href="#l30.2776"></a><span id="l30.2776">               return rv;</span>
<a href="#l30.2777"></a><span id="l30.2777">             }</span>
<a href="#l30.2778"></a><span id="l30.2778"> </span>
<a href="#l30.2779"></a><span id="l30.2779">             copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.2780"></a><span id="l30.2780">             if (NS_SUCCEEDED(rv))</span>
<a href="#l30.2781"></a><span id="l30.2781" class="difflineminus">-              rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray, dstFolder,</span>
<a href="#l30.2782"></a><span id="l30.2782" class="difflineminus">-                                             false, nullptr, msgWindow, false);</span>
<a href="#l30.2783"></a><span id="l30.2783" class="difflineplus">+              rv = copyService-&gt;CopyMessages(m_downloadFolder, messageArray,</span>
<a href="#l30.2784"></a><span id="l30.2784" class="difflineplus">+                                             dstFolder, false, nullptr,</span>
<a href="#l30.2785"></a><span id="l30.2785" class="difflineplus">+                                             msgWindow, false);</span>
<a href="#l30.2786"></a><span id="l30.2786"> </span>
<a href="#l30.2787"></a><span id="l30.2787">             if (NS_FAILED(rv)) {</span>
<a href="#l30.2788"></a><span id="l30.2788">               // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l30.2789"></a><span id="l30.2789">               if (loggingEnabled) {</span>
<a href="#l30.2790"></a><span id="l30.2790" class="difflineminus">-                (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l30.2791"></a><span id="l30.2791" class="difflineminus">-                                              NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l30.2792"></a><span id="l30.2792" class="difflineplus">+                (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l30.2793"></a><span id="l30.2793" class="difflineplus">+                    filterAction, msgHdr, rv,</span>
<a href="#l30.2794"></a><span id="l30.2794" class="difflineplus">+                    NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l30.2795"></a><span id="l30.2795">               }</span>
<a href="#l30.2796"></a><span id="l30.2796" class="difflineminus">-            }</span>
<a href="#l30.2797"></a><span id="l30.2797" class="difflineminus">-            else</span>
<a href="#l30.2798"></a><span id="l30.2798" class="difflineplus">+            } else</span>
<a href="#l30.2799"></a><span id="l30.2799">               m_msgCopiedByFilter = true;</span>
<a href="#l30.2800"></a><span id="l30.2800">           }</span>
<a href="#l30.2801"></a><span id="l30.2801" class="difflineminus">-        }</span>
<a href="#l30.2802"></a><span id="l30.2802" class="difflineminus">-        break;</span>
<a href="#l30.2803"></a><span id="l30.2803" class="difflineminus">-      case nsMsgFilterAction::MarkRead:</span>
<a href="#l30.2804"></a><span id="l30.2804" class="difflineminus">-        msgIsNew = false;</span>
<a href="#l30.2805"></a><span id="l30.2805" class="difflineminus">-        MarkFilteredMessageRead(msgHdr);</span>
<a href="#l30.2806"></a><span id="l30.2806" class="difflineminus">-        break;</span>
<a href="#l30.2807"></a><span id="l30.2807" class="difflineminus">-      case nsMsgFilterAction::MarkUnread:</span>
<a href="#l30.2808"></a><span id="l30.2808" class="difflineminus">-        msgIsNew = true;</span>
<a href="#l30.2809"></a><span id="l30.2809" class="difflineminus">-        MarkFilteredMessageUnread(msgHdr);</span>
<a href="#l30.2810"></a><span id="l30.2810" class="difflineminus">-        break;</span>
<a href="#l30.2811"></a><span id="l30.2811" class="difflineminus">-      case nsMsgFilterAction::KillThread:</span>
<a href="#l30.2812"></a><span id="l30.2812" class="difflineminus">-        msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l30.2813"></a><span id="l30.2813" class="difflineminus">-        break;</span>
<a href="#l30.2814"></a><span id="l30.2814" class="difflineminus">-      case nsMsgFilterAction::KillSubthread:</span>
<a href="#l30.2815"></a><span id="l30.2815" class="difflineminus">-        msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l30.2816"></a><span id="l30.2816" class="difflineminus">-        break;</span>
<a href="#l30.2817"></a><span id="l30.2817" class="difflineminus">-      case nsMsgFilterAction::WatchThread:</span>
<a href="#l30.2818"></a><span id="l30.2818" class="difflineminus">-        msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l30.2819"></a><span id="l30.2819" class="difflineminus">-        break;</span>
<a href="#l30.2820"></a><span id="l30.2820" class="difflineminus">-      case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l30.2821"></a><span id="l30.2821" class="difflineminus">-        {</span>
<a href="#l30.2822"></a><span id="l30.2822" class="difflineminus">-          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.2823"></a><span id="l30.2823" class="difflineplus">+        } break;</span>
<a href="#l30.2824"></a><span id="l30.2824" class="difflineplus">+        case nsMsgFilterAction::MarkRead:</span>
<a href="#l30.2825"></a><span id="l30.2825" class="difflineplus">+          msgIsNew = false;</span>
<a href="#l30.2826"></a><span id="l30.2826" class="difflineplus">+          MarkFilteredMessageRead(msgHdr);</span>
<a href="#l30.2827"></a><span id="l30.2827" class="difflineplus">+          break;</span>
<a href="#l30.2828"></a><span id="l30.2828" class="difflineplus">+        case nsMsgFilterAction::MarkUnread:</span>
<a href="#l30.2829"></a><span id="l30.2829" class="difflineplus">+          msgIsNew = true;</span>
<a href="#l30.2830"></a><span id="l30.2830" class="difflineplus">+          MarkFilteredMessageUnread(msgHdr);</span>
<a href="#l30.2831"></a><span id="l30.2831" class="difflineplus">+          break;</span>
<a href="#l30.2832"></a><span id="l30.2832" class="difflineplus">+        case nsMsgFilterAction::KillThread:</span>
<a href="#l30.2833"></a><span id="l30.2833" class="difflineplus">+          msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;,</span>
<a href="#l30.2834"></a><span id="l30.2834" class="difflineplus">+                                    nsMsgMessageFlags::Ignored);</span>
<a href="#l30.2835"></a><span id="l30.2835" class="difflineplus">+          break;</span>
<a href="#l30.2836"></a><span id="l30.2836" class="difflineplus">+        case nsMsgFilterAction::KillSubthread:</span>
<a href="#l30.2837"></a><span id="l30.2837" class="difflineplus">+          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l30.2838"></a><span id="l30.2838" class="difflineplus">+          break;</span>
<a href="#l30.2839"></a><span id="l30.2839" class="difflineplus">+        case nsMsgFilterAction::WatchThread:</span>
<a href="#l30.2840"></a><span id="l30.2840" class="difflineplus">+          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l30.2841"></a><span id="l30.2841" class="difflineplus">+          break;</span>
<a href="#l30.2842"></a><span id="l30.2842" class="difflineplus">+        case nsMsgFilterAction::MarkFlagged: {</span>
<a href="#l30.2843"></a><span id="l30.2843" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.2844"></a><span id="l30.2844" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.2845"></a><span id="l30.2845">           messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.2846"></a><span id="l30.2846">           m_downloadFolder-&gt;MarkMessagesFlagged(messageArray, true);</span>
<a href="#l30.2847"></a><span id="l30.2847" class="difflineplus">+        } break;</span>
<a href="#l30.2848"></a><span id="l30.2848" class="difflineplus">+        case nsMsgFilterAction::ChangePriority:</span>
<a href="#l30.2849"></a><span id="l30.2849" class="difflineplus">+          nsMsgPriorityValue filterPriority;</span>
<a href="#l30.2850"></a><span id="l30.2850" class="difflineplus">+          filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l30.2851"></a><span id="l30.2851" class="difflineplus">+          msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l30.2852"></a><span id="l30.2852" class="difflineplus">+          break;</span>
<a href="#l30.2853"></a><span id="l30.2853" class="difflineplus">+        case nsMsgFilterAction::AddTag: {</span>
<a href="#l30.2854"></a><span id="l30.2854" class="difflineplus">+          nsCString keyword;</span>
<a href="#l30.2855"></a><span id="l30.2855" class="difflineplus">+          filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l30.2856"></a><span id="l30.2856" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.2857"></a><span id="l30.2857" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.2858"></a><span id="l30.2858" class="difflineplus">+          messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.2859"></a><span id="l30.2859" class="difflineplus">+          m_downloadFolder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l30.2860"></a><span id="l30.2860" class="difflineplus">+          break;</span>
<a href="#l30.2861"></a><span id="l30.2861">         }</span>
<a href="#l30.2862"></a><span id="l30.2862" class="difflineminus">-        break;</span>
<a href="#l30.2863"></a><span id="l30.2863" class="difflineminus">-      case nsMsgFilterAction::ChangePriority:</span>
<a href="#l30.2864"></a><span id="l30.2864" class="difflineminus">-        nsMsgPriorityValue filterPriority;</span>
<a href="#l30.2865"></a><span id="l30.2865" class="difflineminus">-        filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l30.2866"></a><span id="l30.2866" class="difflineminus">-        msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l30.2867"></a><span id="l30.2867" class="difflineminus">-        break;</span>
<a href="#l30.2868"></a><span id="l30.2868" class="difflineminus">-      case nsMsgFilterAction::AddTag:</span>
<a href="#l30.2869"></a><span id="l30.2869" class="difflineminus">-      {</span>
<a href="#l30.2870"></a><span id="l30.2870" class="difflineminus">-        nsCString keyword;</span>
<a href="#l30.2871"></a><span id="l30.2871" class="difflineminus">-        filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l30.2872"></a><span id="l30.2872" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.2873"></a><span id="l30.2873" class="difflineminus">-        messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.2874"></a><span id="l30.2874" class="difflineminus">-        m_downloadFolder-&gt;AddKeywordsToMessages(messageArray, keyword);</span>
<a href="#l30.2875"></a><span id="l30.2875" class="difflineminus">-        break;</span>
<a href="#l30.2876"></a><span id="l30.2876" class="difflineminus">-      }</span>
<a href="#l30.2877"></a><span id="l30.2877" class="difflineminus">-      case nsMsgFilterAction::Label:</span>
<a href="#l30.2878"></a><span id="l30.2878" class="difflineminus">-        nsMsgLabelValue filterLabel;</span>
<a href="#l30.2879"></a><span id="l30.2879" class="difflineminus">-        filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l30.2880"></a><span id="l30.2880" class="difflineminus">-        nsMsgKey msgKey;</span>
<a href="#l30.2881"></a><span id="l30.2881" class="difflineminus">-        msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2882"></a><span id="l30.2882" class="difflineminus">-        m_mailDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l30.2883"></a><span id="l30.2883" class="difflineminus">-        break;</span>
<a href="#l30.2884"></a><span id="l30.2884" class="difflineminus">-      case nsMsgFilterAction::JunkScore:</span>
<a href="#l30.2885"></a><span id="l30.2885" class="difflineminus">-      {</span>
<a href="#l30.2886"></a><span id="l30.2886" class="difflineminus">-        nsAutoCString junkScoreStr;</span>
<a href="#l30.2887"></a><span id="l30.2887" class="difflineminus">-        int32_t junkScore;</span>
<a href="#l30.2888"></a><span id="l30.2888" class="difflineminus">-        filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l30.2889"></a><span id="l30.2889" class="difflineminus">-        junkScoreStr.AppendInt(junkScore);</span>
<a href="#l30.2890"></a><span id="l30.2890" class="difflineminus">-        if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l30.2891"></a><span id="l30.2891" class="difflineminus">-          msgIsNew = false;</span>
<a href="#l30.2892"></a><span id="l30.2892" class="difflineminus">-        nsMsgKey msgKey;</span>
<a href="#l30.2893"></a><span id="l30.2893" class="difflineminus">-        msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2894"></a><span id="l30.2894" class="difflineminus">-        msgHdr-&gt;SetStringProperty(&quot;junkscore&quot;, junkScoreStr.get());</span>
<a href="#l30.2895"></a><span id="l30.2895" class="difflineminus">-        msgHdr-&gt;SetStringProperty(&quot;junkscoreorigin&quot;, &quot;filter&quot;);</span>
<a href="#l30.2896"></a><span id="l30.2896" class="difflineminus">-        break;</span>
<a href="#l30.2897"></a><span id="l30.2897" class="difflineminus">-      }</span>
<a href="#l30.2898"></a><span id="l30.2898" class="difflineminus">-      case nsMsgFilterAction::Forward:</span>
<a href="#l30.2899"></a><span id="l30.2899" class="difflineminus">-        {</span>
<a href="#l30.2900"></a><span id="l30.2900" class="difflineplus">+        case nsMsgFilterAction::Label:</span>
<a href="#l30.2901"></a><span id="l30.2901" class="difflineplus">+          nsMsgLabelValue filterLabel;</span>
<a href="#l30.2902"></a><span id="l30.2902" class="difflineplus">+          filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l30.2903"></a><span id="l30.2903" class="difflineplus">+          nsMsgKey msgKey;</span>
<a href="#l30.2904"></a><span id="l30.2904" class="difflineplus">+          msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2905"></a><span id="l30.2905" class="difflineplus">+          m_mailDB-&gt;SetLabel(msgKey, filterLabel);</span>
<a href="#l30.2906"></a><span id="l30.2906" class="difflineplus">+          break;</span>
<a href="#l30.2907"></a><span id="l30.2907" class="difflineplus">+        case nsMsgFilterAction::JunkScore: {</span>
<a href="#l30.2908"></a><span id="l30.2908" class="difflineplus">+          nsAutoCString junkScoreStr;</span>
<a href="#l30.2909"></a><span id="l30.2909" class="difflineplus">+          int32_t junkScore;</span>
<a href="#l30.2910"></a><span id="l30.2910" class="difflineplus">+          filterAction-&gt;GetJunkScore(&amp;junkScore);</span>
<a href="#l30.2911"></a><span id="l30.2911" class="difflineplus">+          junkScoreStr.AppendInt(junkScore);</span>
<a href="#l30.2912"></a><span id="l30.2912" class="difflineplus">+          if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE) msgIsNew = false;</span>
<a href="#l30.2913"></a><span id="l30.2913" class="difflineplus">+          nsMsgKey msgKey;</span>
<a href="#l30.2914"></a><span id="l30.2914" class="difflineplus">+          msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.2915"></a><span id="l30.2915" class="difflineplus">+          msgHdr-&gt;SetStringProperty(&quot;junkscore&quot;, junkScoreStr.get());</span>
<a href="#l30.2916"></a><span id="l30.2916" class="difflineplus">+          msgHdr-&gt;SetStringProperty(&quot;junkscoreorigin&quot;, &quot;filter&quot;);</span>
<a href="#l30.2917"></a><span id="l30.2917" class="difflineplus">+          break;</span>
<a href="#l30.2918"></a><span id="l30.2918" class="difflineplus">+        }</span>
<a href="#l30.2919"></a><span id="l30.2919" class="difflineplus">+        case nsMsgFilterAction::Forward: {</span>
<a href="#l30.2920"></a><span id="l30.2920">           nsCString forwardTo;</span>
<a href="#l30.2921"></a><span id="l30.2921">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l30.2922"></a><span id="l30.2922">           m_forwardTo.AppendElement(forwardTo);</span>
<a href="#l30.2923"></a><span id="l30.2923">           m_msgToForwardOrReply = msgHdr;</span>
<a href="#l30.2924"></a><span id="l30.2924" class="difflineminus">-        }</span>
<a href="#l30.2925"></a><span id="l30.2925" class="difflineminus">-        break;</span>
<a href="#l30.2926"></a><span id="l30.2926" class="difflineminus">-      case nsMsgFilterAction::Reply:</span>
<a href="#l30.2927"></a><span id="l30.2927" class="difflineminus">-        {</span>
<a href="#l30.2928"></a><span id="l30.2928" class="difflineplus">+        } break;</span>
<a href="#l30.2929"></a><span id="l30.2929" class="difflineplus">+        case nsMsgFilterAction::Reply: {</span>
<a href="#l30.2930"></a><span id="l30.2930">           nsCString replyTemplateUri;</span>
<a href="#l30.2931"></a><span id="l30.2931">           filterAction-&gt;GetStrValue(replyTemplateUri);</span>
<a href="#l30.2932"></a><span id="l30.2932">           m_replyTemplateUri.AppendElement(replyTemplateUri);</span>
<a href="#l30.2933"></a><span id="l30.2933">           m_msgToForwardOrReply = msgHdr;</span>
<a href="#l30.2934"></a><span id="l30.2934">           m_ruleAction = filterAction;</span>
<a href="#l30.2935"></a><span id="l30.2935">           m_filter = filter;</span>
<a href="#l30.2936"></a><span id="l30.2936" class="difflineminus">-        }</span>
<a href="#l30.2937"></a><span id="l30.2937" class="difflineminus">-        break;</span>
<a href="#l30.2938"></a><span id="l30.2938" class="difflineminus">-      case nsMsgFilterAction::DeleteFromPop3Server:</span>
<a href="#l30.2939"></a><span id="l30.2939" class="difflineminus">-        {</span>
<a href="#l30.2940"></a><span id="l30.2940" class="difflineplus">+        } break;</span>
<a href="#l30.2941"></a><span id="l30.2941" class="difflineplus">+        case nsMsgFilterAction::DeleteFromPop3Server: {</span>
<a href="#l30.2942"></a><span id="l30.2942">           uint32_t flags = 0;</span>
<a href="#l30.2943"></a><span id="l30.2943" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; downloadFolder;</span>
<a href="#l30.2944"></a><span id="l30.2944" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder;</span>
<a href="#l30.2945"></a><span id="l30.2945">           msgHdr-&gt;GetFolder(getter_AddRefs(downloadFolder));</span>
<a href="#l30.2946"></a><span id="l30.2946" class="difflineminus">-          nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(downloadFolder);</span>
<a href="#l30.2947"></a><span id="l30.2947" class="difflineplus">+          nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l30.2948"></a><span id="l30.2948" class="difflineplus">+              do_QueryInterface(downloadFolder);</span>
<a href="#l30.2949"></a><span id="l30.2949">           msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l30.2950"></a><span id="l30.2950" class="difflineminus">-          if (localFolder)</span>
<a href="#l30.2951"></a><span id="l30.2951" class="difflineminus">-          {</span>
<a href="#l30.2952"></a><span id="l30.2952" class="difflineminus">-            nsCOMPtr&lt;nsIMutableArray&gt; messages = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l30.2953"></a><span id="l30.2953" class="difflineplus">+          if (localFolder) {</span>
<a href="#l30.2954"></a><span id="l30.2954" class="difflineplus">+            nsCOMPtr&lt;nsIMutableArray&gt; messages =</span>
<a href="#l30.2955"></a><span id="l30.2955" class="difflineplus">+                do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l30.2956"></a><span id="l30.2956">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.2957"></a><span id="l30.2957">             messages-&gt;AppendElement(msgHdr);</span>
<a href="#l30.2958"></a><span id="l30.2958">             // This action ignores the deleteMailLeftOnServer preference</span>
<a href="#l30.2959"></a><span id="l30.2959">             localFolder-&gt;MarkMsgsOnPop3Server(messages, POP3_FORCE_DEL);</span>
<a href="#l30.2960"></a><span id="l30.2960"> </span>
<a href="#l30.2961"></a><span id="l30.2961">             // If this is just a header, throw it away. It's useless now</span>
<a href="#l30.2962"></a><span id="l30.2962">             // that the server copy is being deleted.</span>
<a href="#l30.2963"></a><span id="l30.2963" class="difflineminus">-            if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l30.2964"></a><span id="l30.2964" class="difflineminus">-            {</span>
<a href="#l30.2965"></a><span id="l30.2965" class="difflineplus">+            if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l30.2966"></a><span id="l30.2966">               m_msgMovedByFilter = true;</span>
<a href="#l30.2967"></a><span id="l30.2967">               msgIsNew = false;</span>
<a href="#l30.2968"></a><span id="l30.2968">             }</span>
<a href="#l30.2969"></a><span id="l30.2969">           }</span>
<a href="#l30.2970"></a><span id="l30.2970" class="difflineminus">-        }</span>
<a href="#l30.2971"></a><span id="l30.2971" class="difflineminus">-        break;</span>
<a href="#l30.2972"></a><span id="l30.2972" class="difflineminus">-      case nsMsgFilterAction::FetchBodyFromPop3Server:</span>
<a href="#l30.2973"></a><span id="l30.2973" class="difflineminus">-        {</span>
<a href="#l30.2974"></a><span id="l30.2974" class="difflineplus">+        } break;</span>
<a href="#l30.2975"></a><span id="l30.2975" class="difflineplus">+        case nsMsgFilterAction::FetchBodyFromPop3Server: {</span>
<a href="#l30.2976"></a><span id="l30.2976">           uint32_t flags = 0;</span>
<a href="#l30.2977"></a><span id="l30.2977" class="difflineminus">-          nsCOMPtr &lt;nsIMsgFolder&gt; downloadFolder;</span>
<a href="#l30.2978"></a><span id="l30.2978" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder;</span>
<a href="#l30.2979"></a><span id="l30.2979">           msgHdr-&gt;GetFolder(getter_AddRefs(downloadFolder));</span>
<a href="#l30.2980"></a><span id="l30.2980" class="difflineminus">-          nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(downloadFolder);</span>
<a href="#l30.2981"></a><span id="l30.2981" class="difflineplus">+          nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l30.2982"></a><span id="l30.2982" class="difflineplus">+              do_QueryInterface(downloadFolder);</span>
<a href="#l30.2983"></a><span id="l30.2983">           msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l30.2984"></a><span id="l30.2984" class="difflineminus">-          if (localFolder &amp;&amp; (flags &amp; nsMsgMessageFlags::Partial))</span>
<a href="#l30.2985"></a><span id="l30.2985" class="difflineminus">-          {</span>
<a href="#l30.2986"></a><span id="l30.2986" class="difflineminus">-            nsCOMPtr&lt;nsIMutableArray&gt; messages = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l30.2987"></a><span id="l30.2987" class="difflineplus">+          if (localFolder &amp;&amp; (flags &amp; nsMsgMessageFlags::Partial)) {</span>
<a href="#l30.2988"></a><span id="l30.2988" class="difflineplus">+            nsCOMPtr&lt;nsIMutableArray&gt; messages =</span>
<a href="#l30.2989"></a><span id="l30.2989" class="difflineplus">+                do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l30.2990"></a><span id="l30.2990">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.2991"></a><span id="l30.2991">             messages-&gt;AppendElement(msgHdr);</span>
<a href="#l30.2992"></a><span id="l30.2992">             localFolder-&gt;MarkMsgsOnPop3Server(messages, POP3_FETCH_BODY);</span>
<a href="#l30.2993"></a><span id="l30.2993">             // Don't add this header to the DB, we're going to replace it</span>
<a href="#l30.2994"></a><span id="l30.2994">             // with the full message.</span>
<a href="#l30.2995"></a><span id="l30.2995">             m_msgMovedByFilter = true;</span>
<a href="#l30.2996"></a><span id="l30.2996">             msgIsNew = false;</span>
<a href="#l30.2997"></a><span id="l30.2997">             // Don't do anything else in this filter, wait until we</span>
<a href="#l30.2998"></a><span id="l30.2998">             // have the full message.</span>
<a href="#l30.2999"></a><span id="l30.2999">             *applyMore = false;</span>
<a href="#l30.3000"></a><span id="l30.3000">           }</span>
<a href="#l30.3001"></a><span id="l30.3001" class="difflineminus">-        }</span>
<a href="#l30.3002"></a><span id="l30.3002" class="difflineminus">-        break;</span>
<a href="#l30.3003"></a><span id="l30.3003" class="difflineplus">+        } break;</span>
<a href="#l30.3004"></a><span id="l30.3004" class="difflineplus">+</span>
<a href="#l30.3005"></a><span id="l30.3005" class="difflineplus">+        case nsMsgFilterAction::StopExecution: {</span>
<a href="#l30.3006"></a><span id="l30.3006" class="difflineplus">+          // don't apply any more filters</span>
<a href="#l30.3007"></a><span id="l30.3007" class="difflineplus">+          *applyMore = false;</span>
<a href="#l30.3008"></a><span id="l30.3008" class="difflineplus">+        } break;</span>
<a href="#l30.3009"></a><span id="l30.3009"> </span>
<a href="#l30.3010"></a><span id="l30.3010" class="difflineminus">-      case nsMsgFilterAction::StopExecution:</span>
<a href="#l30.3011"></a><span id="l30.3011" class="difflineminus">-      {</span>
<a href="#l30.3012"></a><span id="l30.3012" class="difflineminus">-        // don't apply any more filters</span>
<a href="#l30.3013"></a><span id="l30.3013" class="difflineminus">-        *applyMore = false;</span>
<a href="#l30.3014"></a><span id="l30.3014" class="difflineminus">-      }</span>
<a href="#l30.3015"></a><span id="l30.3015" class="difflineminus">-      break;</span>
<a href="#l30.3016"></a><span id="l30.3016" class="difflineplus">+        case nsMsgFilterAction::Custom: {</span>
<a href="#l30.3017"></a><span id="l30.3017" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l30.3018"></a><span id="l30.3018" class="difflineplus">+          rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l30.3019"></a><span id="l30.3019" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.3020"></a><span id="l30.3020"> </span>
<a href="#l30.3021"></a><span id="l30.3021" class="difflineminus">-      case nsMsgFilterAction::Custom:</span>
<a href="#l30.3022"></a><span id="l30.3022" class="difflineminus">-      {</span>
<a href="#l30.3023"></a><span id="l30.3023" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFilterCustomAction&gt; customAction;</span>
<a href="#l30.3024"></a><span id="l30.3024" class="difflineminus">-        rv = filterAction-&gt;GetCustomAction(getter_AddRefs(customAction));</span>
<a href="#l30.3025"></a><span id="l30.3025" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.3026"></a><span id="l30.3026" class="difflineminus">-</span>
<a href="#l30.3027"></a><span id="l30.3027" class="difflineminus">-        nsAutoCString value;</span>
<a href="#l30.3028"></a><span id="l30.3028" class="difflineminus">-        filterAction-&gt;GetStrValue(value);</span>
<a href="#l30.3029"></a><span id="l30.3029" class="difflineplus">+          nsAutoCString value;</span>
<a href="#l30.3030"></a><span id="l30.3030" class="difflineplus">+          filterAction-&gt;GetStrValue(value);</span>
<a href="#l30.3031"></a><span id="l30.3031"> </span>
<a href="#l30.3032"></a><span id="l30.3032" class="difflineminus">-        nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.3033"></a><span id="l30.3033" class="difflineminus">-            do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l30.3034"></a><span id="l30.3034" class="difflineminus">-        NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l30.3035"></a><span id="l30.3035" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l30.3036"></a><span id="l30.3036" class="difflineminus">-          rv = messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.3037"></a><span id="l30.3037" class="difflineplus">+          nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.3038"></a><span id="l30.3038" class="difflineplus">+              do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l30.3039"></a><span id="l30.3039" class="difflineplus">+          NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l30.3040"></a><span id="l30.3040" class="difflineplus">+          if (NS_SUCCEEDED(rv)) rv = messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.3041"></a><span id="l30.3041"> </span>
<a href="#l30.3042"></a><span id="l30.3042" class="difflineminus">-</span>
<a href="#l30.3043"></a><span id="l30.3043" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l30.3044"></a><span id="l30.3044" class="difflineminus">-          rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l30.3045"></a><span id="l30.3045" class="difflineminus">-                                   nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l30.3046"></a><span id="l30.3046" class="difflineminus">-        if (NS_FAILED(rv)) {</span>
<a href="#l30.3047"></a><span id="l30.3047" class="difflineplus">+          if (NS_SUCCEEDED(rv))</span>
<a href="#l30.3048"></a><span id="l30.3048" class="difflineplus">+            rv = customAction-&gt;Apply(messageArray, value, nullptr,</span>
<a href="#l30.3049"></a><span id="l30.3049" class="difflineplus">+                                     nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l30.3050"></a><span id="l30.3050" class="difflineplus">+          if (NS_FAILED(rv)) {</span>
<a href="#l30.3051"></a><span id="l30.3051">             // XXX: Invoke MSG_LOG_TO_CONSOLE once bug 1135265 lands.</span>
<a href="#l30.3052"></a><span id="l30.3052" class="difflineminus">-          if (loggingEnabled) {</span>
<a href="#l30.3053"></a><span id="l30.3053" class="difflineminus">-            (void) filter-&gt;LogRuleHitFail(filterAction, msgHdr, rv,</span>
<a href="#l30.3054"></a><span id="l30.3054" class="difflineminus">-                                          NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l30.3055"></a><span id="l30.3055" class="difflineplus">+            if (loggingEnabled) {</span>
<a href="#l30.3056"></a><span id="l30.3056" class="difflineplus">+              (void)filter-&gt;LogRuleHitFail(</span>
<a href="#l30.3057"></a><span id="l30.3057" class="difflineplus">+                  filterAction, msgHdr, rv,</span>
<a href="#l30.3058"></a><span id="l30.3058" class="difflineplus">+                  NS_LITERAL_CSTRING(&quot;filterFailureCopyFailed&quot;));</span>
<a href="#l30.3059"></a><span id="l30.3059" class="difflineplus">+            }</span>
<a href="#l30.3060"></a><span id="l30.3060">           }</span>
<a href="#l30.3061"></a><span id="l30.3061" class="difflineminus">-        }</span>
<a href="#l30.3062"></a><span id="l30.3062" class="difflineminus">-      }</span>
<a href="#l30.3063"></a><span id="l30.3063" class="difflineminus">-      break;</span>
<a href="#l30.3064"></a><span id="l30.3064" class="difflineminus">-</span>
<a href="#l30.3065"></a><span id="l30.3065" class="difflineplus">+        } break;</span>
<a href="#l30.3066"></a><span id="l30.3066"> </span>
<a href="#l30.3067"></a><span id="l30.3067" class="difflineminus">-      default:</span>
<a href="#l30.3068"></a><span id="l30.3068" class="difflineminus">-        // XXX should not be reached. Check in debug build.</span>
<a href="#l30.3069"></a><span id="l30.3069" class="difflineminus">-        NS_ERROR(&quot;This default should not be reached.&quot;);</span>
<a href="#l30.3070"></a><span id="l30.3070" class="difflineminus">-        break;</span>
<a href="#l30.3071"></a><span id="l30.3071" class="difflineplus">+        default:</span>
<a href="#l30.3072"></a><span id="l30.3072" class="difflineplus">+          // XXX should not be reached. Check in debug build.</span>
<a href="#l30.3073"></a><span id="l30.3073" class="difflineplus">+          NS_ERROR(&quot;This default should not be reached.&quot;);</span>
<a href="#l30.3074"></a><span id="l30.3074" class="difflineplus">+          break;</span>
<a href="#l30.3075"></a><span id="l30.3075">       }</span>
<a href="#l30.3076"></a><span id="l30.3076">     }</span>
<a href="#l30.3077"></a><span id="l30.3077">   }</span>
<a href="#l30.3078"></a><span id="l30.3078" class="difflineminus">-  if (!msgIsNew)</span>
<a href="#l30.3079"></a><span id="l30.3079" class="difflineminus">-  {</span>
<a href="#l30.3080"></a><span id="l30.3080" class="difflineplus">+  if (!msgIsNew) {</span>
<a href="#l30.3081"></a><span id="l30.3081">     int32_t numNewMessages;</span>
<a href="#l30.3082"></a><span id="l30.3082">     m_downloadFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l30.3083"></a><span id="l30.3083">     if (numNewMessages &gt; 0)</span>
<a href="#l30.3084"></a><span id="l30.3084">       m_downloadFolder-&gt;SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l30.3085"></a><span id="l30.3085">     m_numNotNewMessages++;</span>
<a href="#l30.3086"></a><span id="l30.3086">   }</span>
<a href="#l30.3087"></a><span id="l30.3087">   return rv;</span>
<a href="#l30.3088"></a><span id="l30.3088"> }</span>
<a href="#l30.3089"></a><span id="l30.3089"> </span>
<a href="#l30.3090"></a><span id="l30.3090"> // this gets run in a second pass, after apply filters to a header.</span>
<a href="#l30.3091"></a><span id="l30.3091" class="difflineminus">-nsresult nsParseNewMailState::ApplyForwardAndReplyFilter(nsIMsgWindow *msgWindow)</span>
<a href="#l30.3092"></a><span id="l30.3092" class="difflineminus">-{</span>
<a href="#l30.3093"></a><span id="l30.3093" class="difflineplus">+nsresult nsParseNewMailState::ApplyForwardAndReplyFilter(</span>
<a href="#l30.3094"></a><span id="l30.3094" class="difflineplus">+    nsIMsgWindow *msgWindow) {</span>
<a href="#l30.3095"></a><span id="l30.3095">   nsresult rv = NS_OK;</span>
<a href="#l30.3096"></a><span id="l30.3096" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l30.3097"></a><span id="l30.3097" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l30.3098"></a><span id="l30.3098"> </span>
<a href="#l30.3099"></a><span id="l30.3099">   uint32_t i;</span>
<a href="#l30.3100"></a><span id="l30.3100">   uint32_t count = m_forwardTo.Length();</span>
<a href="#l30.3101"></a><span id="l30.3101" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l30.3102"></a><span id="l30.3102" class="difflineminus">-  {</span>
<a href="#l30.3103"></a><span id="l30.3103" class="difflineminus">-    if (!m_forwardTo[i].IsEmpty())</span>
<a href="#l30.3104"></a><span id="l30.3104" class="difflineminus">-    {</span>
<a href="#l30.3105"></a><span id="l30.3105" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l30.3106"></a><span id="l30.3106" class="difflineplus">+    if (!m_forwardTo[i].IsEmpty()) {</span>
<a href="#l30.3107"></a><span id="l30.3107">       nsAutoString forwardStr;</span>
<a href="#l30.3108"></a><span id="l30.3108">       CopyASCIItoUTF16(m_forwardTo[i], forwardStr);</span>
<a href="#l30.3109"></a><span id="l30.3109">       rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l30.3110"></a><span id="l30.3110">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.3111"></a><span id="l30.3111">       {</span>
<a href="#l30.3112"></a><span id="l30.3112">         nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l30.3113"></a><span id="l30.3113" class="difflineminus">-          do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.3114"></a><span id="l30.3114" class="difflineplus">+            do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l30.3115"></a><span id="l30.3115">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.3116"></a><span id="l30.3116" class="difflineminus">-        rv = compService-&gt;ForwardMessage(forwardStr, m_msgToForwardOrReply,</span>
<a href="#l30.3117"></a><span id="l30.3117" class="difflineminus">-                                         msgWindow, server,</span>
<a href="#l30.3118"></a><span id="l30.3118" class="difflineminus">-                                         nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l30.3119"></a><span id="l30.3119" class="difflineplus">+        rv = compService-&gt;ForwardMessage(</span>
<a href="#l30.3120"></a><span id="l30.3120" class="difflineplus">+            forwardStr, m_msgToForwardOrReply, msgWindow, server,</span>
<a href="#l30.3121"></a><span id="l30.3121" class="difflineplus">+            nsIMsgComposeService::kForwardAsDefault);</span>
<a href="#l30.3122"></a><span id="l30.3122">       }</span>
<a href="#l30.3123"></a><span id="l30.3123">     }</span>
<a href="#l30.3124"></a><span id="l30.3124">   }</span>
<a href="#l30.3125"></a><span id="l30.3125">   m_forwardTo.Clear();</span>
<a href="#l30.3126"></a><span id="l30.3126"> </span>
<a href="#l30.3127"></a><span id="l30.3127">   count = m_replyTemplateUri.Length();</span>
<a href="#l30.3128"></a><span id="l30.3128" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l30.3129"></a><span id="l30.3129" class="difflineminus">-  {</span>
<a href="#l30.3130"></a><span id="l30.3130" class="difflineminus">-    if (!m_replyTemplateUri[i].IsEmpty())</span>
<a href="#l30.3131"></a><span id="l30.3131" class="difflineminus">-    {</span>
<a href="#l30.3132"></a><span id="l30.3132" class="difflineminus">-      // copy this and truncate the original, so we don't accidentally re-use it on the next hdr.</span>
<a href="#l30.3133"></a><span id="l30.3133" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l30.3134"></a><span id="l30.3134" class="difflineplus">+    if (!m_replyTemplateUri[i].IsEmpty()) {</span>
<a href="#l30.3135"></a><span id="l30.3135" class="difflineplus">+      // copy this and truncate the original, so we don't accidentally re-use it</span>
<a href="#l30.3136"></a><span id="l30.3136" class="difflineplus">+      // on the next hdr.</span>
<a href="#l30.3137"></a><span id="l30.3137">       rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l30.3138"></a><span id="l30.3138" class="difflineminus">-      if (server)</span>
<a href="#l30.3139"></a><span id="l30.3139" class="difflineminus">-      {</span>
<a href="#l30.3140"></a><span id="l30.3140" class="difflineminus">-        nsCOMPtr &lt;nsIMsgComposeService&gt; compService = do_GetService (NS_MSGCOMPOSESERVICE_CONTRACTID) ;</span>
<a href="#l30.3141"></a><span id="l30.3141" class="difflineplus">+      if (server) {</span>
<a href="#l30.3142"></a><span id="l30.3142" class="difflineplus">+        nsCOMPtr&lt;nsIMsgComposeService&gt; compService =</span>
<a href="#l30.3143"></a><span id="l30.3143" class="difflineplus">+            do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID);</span>
<a href="#l30.3144"></a><span id="l30.3144">         if (compService) {</span>
<a href="#l30.3145"></a><span id="l30.3145">           rv = compService-&gt;ReplyWithTemplate(m_msgToForwardOrReply,</span>
<a href="#l30.3146"></a><span id="l30.3146">                                               m_replyTemplateUri[i].get(),</span>
<a href="#l30.3147"></a><span id="l30.3147">                                               msgWindow, server);</span>
<a href="#l30.3148"></a><span id="l30.3148">           if (NS_FAILED(rv)) {</span>
<a href="#l30.3149"></a><span id="l30.3149">             NS_WARNING(&quot;ReplyWithTemplate failed&quot;);</span>
<a href="#l30.3150"></a><span id="l30.3150">             if (rv == NS_ERROR_ABORT) {</span>
<a href="#l30.3151"></a><span id="l30.3151" class="difflineminus">-              (void) m_filter-&gt;LogRuleHitFail(m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l30.3152"></a><span id="l30.3152" class="difflineminus">-                                              NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l30.3153"></a><span id="l30.3153" class="difflineplus">+              (void)m_filter-&gt;LogRuleHitFail(</span>
<a href="#l30.3154"></a><span id="l30.3154" class="difflineplus">+                  m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l30.3155"></a><span id="l30.3155" class="difflineplus">+                  NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyAborted&quot;));</span>
<a href="#l30.3156"></a><span id="l30.3156">             } else {</span>
<a href="#l30.3157"></a><span id="l30.3157" class="difflineminus">-              (void) m_filter-&gt;LogRuleHitFail(m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l30.3158"></a><span id="l30.3158" class="difflineminus">-                                              NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l30.3159"></a><span id="l30.3159" class="difflineplus">+              (void)m_filter-&gt;LogRuleHitFail(</span>
<a href="#l30.3160"></a><span id="l30.3160" class="difflineplus">+                  m_ruleAction, m_msgToForwardOrReply, rv,</span>
<a href="#l30.3161"></a><span id="l30.3161" class="difflineplus">+                  NS_LITERAL_CSTRING(&quot;filterFailureSendingReplyError&quot;));</span>
<a href="#l30.3162"></a><span id="l30.3162">             }</span>
<a href="#l30.3163"></a><span id="l30.3163">           }</span>
<a href="#l30.3164"></a><span id="l30.3164">         }</span>
<a href="#l30.3165"></a><span id="l30.3165">       }</span>
<a href="#l30.3166"></a><span id="l30.3166">     }</span>
<a href="#l30.3167"></a><span id="l30.3167">   }</span>
<a href="#l30.3168"></a><span id="l30.3168">   m_replyTemplateUri.Clear();</span>
<a href="#l30.3169"></a><span id="l30.3169">   m_msgToForwardOrReply = nullptr;</span>
<a href="#l30.3170"></a><span id="l30.3170">   return rv;</span>
<a href="#l30.3171"></a><span id="l30.3171"> }</span>
<a href="#l30.3172"></a><span id="l30.3172"> </span>
<a href="#l30.3173"></a><span id="l30.3173" class="difflineminus">-void nsParseNewMailState::MarkFilteredMessageRead(nsIMsgDBHdr *msgHdr)</span>
<a href="#l30.3174"></a><span id="l30.3174" class="difflineminus">-{</span>
<a href="#l30.3175"></a><span id="l30.3175" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.3176"></a><span id="l30.3176" class="difflineplus">+void nsParseNewMailState::MarkFilteredMessageRead(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l30.3177"></a><span id="l30.3177" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.3178"></a><span id="l30.3178" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.3179"></a><span id="l30.3179">   messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.3180"></a><span id="l30.3180">   m_downloadFolder-&gt;MarkMessagesRead(messageArray, true);</span>
<a href="#l30.3181"></a><span id="l30.3181"> }</span>
<a href="#l30.3182"></a><span id="l30.3182"> </span>
<a href="#l30.3183"></a><span id="l30.3183" class="difflineminus">-void nsParseNewMailState::MarkFilteredMessageUnread(nsIMsgDBHdr *msgHdr)</span>
<a href="#l30.3184"></a><span id="l30.3184" class="difflineminus">-{</span>
<a href="#l30.3185"></a><span id="l30.3185" class="difflineplus">+void nsParseNewMailState::MarkFilteredMessageUnread(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l30.3186"></a><span id="l30.3186">   uint32_t newFlags;</span>
<a href="#l30.3187"></a><span id="l30.3187" class="difflineminus">-  if (m_mailDB)</span>
<a href="#l30.3188"></a><span id="l30.3188" class="difflineminus">-  {</span>
<a href="#l30.3189"></a><span id="l30.3189" class="difflineplus">+  if (m_mailDB) {</span>
<a href="#l30.3190"></a><span id="l30.3190">     nsMsgKey msgKey;</span>
<a href="#l30.3191"></a><span id="l30.3191">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.3192"></a><span id="l30.3192">     m_mailDB-&gt;AddToNewList(msgKey);</span>
<a href="#l30.3193"></a><span id="l30.3193" class="difflineminus">-  }</span>
<a href="#l30.3194"></a><span id="l30.3194" class="difflineminus">-  else</span>
<a href="#l30.3195"></a><span id="l30.3195" class="difflineminus">-  {</span>
<a href="#l30.3196"></a><span id="l30.3196" class="difflineplus">+  } else {</span>
<a href="#l30.3197"></a><span id="l30.3197">     msgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l30.3198"></a><span id="l30.3198">   }</span>
<a href="#l30.3199"></a><span id="l30.3199" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.3200"></a><span id="l30.3200" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l30.3201"></a><span id="l30.3201" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l30.3202"></a><span id="l30.3202">   messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l30.3203"></a><span id="l30.3203">   m_downloadFolder-&gt;MarkMessagesRead(messageArray, false);</span>
<a href="#l30.3204"></a><span id="l30.3204"> }</span>
<a href="#l30.3205"></a><span id="l30.3205"> </span>
<a href="#l30.3206"></a><span id="l30.3206" class="difflineminus">-nsresult nsParseNewMailState::EndMsgDownload()</span>
<a href="#l30.3207"></a><span id="l30.3207" class="difflineminus">-{</span>
<a href="#l30.3208"></a><span id="l30.3208" class="difflineminus">-  if (m_moveCoalescer)</span>
<a href="#l30.3209"></a><span id="l30.3209" class="difflineminus">-    m_moveCoalescer-&gt;PlaybackMoves();</span>
<a href="#l30.3210"></a><span id="l30.3210" class="difflineplus">+nsresult nsParseNewMailState::EndMsgDownload() {</span>
<a href="#l30.3211"></a><span id="l30.3211" class="difflineplus">+  if (m_moveCoalescer) m_moveCoalescer-&gt;PlaybackMoves();</span>
<a href="#l30.3212"></a><span id="l30.3212"> </span>
<a href="#l30.3213"></a><span id="l30.3213">   // need to do this for all folders that had messages filtered into them</span>
<a href="#l30.3214"></a><span id="l30.3214">   uint32_t serverCount = m_filterTargetFolders.Count();</span>
<a href="#l30.3215"></a><span id="l30.3215">   nsresult rv;</span>
<a href="#l30.3216"></a><span id="l30.3216">   nsCOMPtr&lt;nsIMsgMailSession&gt; session =</span>
<a href="#l30.3217"></a><span id="l30.3217" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l30.3218"></a><span id="l30.3218" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; session) // don't use NS_ENSURE_SUCCESS here - we need to release semaphore below</span>
<a href="#l30.3219"></a><span id="l30.3219" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l30.3220"></a><span id="l30.3220" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; session)  // don't use NS_ENSURE_SUCCESS here - we</span>
<a href="#l30.3221"></a><span id="l30.3221" class="difflineplus">+                                    // need to release semaphore below</span>
<a href="#l30.3222"></a><span id="l30.3222">   {</span>
<a href="#l30.3223"></a><span id="l30.3223" class="difflineminus">-    for (uint32_t index = 0; index &lt; serverCount; index++)</span>
<a href="#l30.3224"></a><span id="l30.3224" class="difflineminus">-    {</span>
<a href="#l30.3225"></a><span id="l30.3225" class="difflineplus">+    for (uint32_t index = 0; index &lt; serverCount; index++) {</span>
<a href="#l30.3226"></a><span id="l30.3226">       bool folderOpen;</span>
<a href="#l30.3227"></a><span id="l30.3227">       session-&gt;IsFolderOpenInWindow(m_filterTargetFolders[index], &amp;folderOpen);</span>
<a href="#l30.3228"></a><span id="l30.3228" class="difflineminus">-      if (!folderOpen)</span>
<a href="#l30.3229"></a><span id="l30.3229" class="difflineminus">-      {</span>
<a href="#l30.3230"></a><span id="l30.3230" class="difflineplus">+      if (!folderOpen) {</span>
<a href="#l30.3231"></a><span id="l30.3231">         uint32_t folderFlags;</span>
<a href="#l30.3232"></a><span id="l30.3232">         m_filterTargetFolders[index]-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l30.3233"></a><span id="l30.3233" class="difflineminus">-        if (! (folderFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Inbox)))</span>
<a href="#l30.3234"></a><span id="l30.3234" class="difflineminus">-        {</span>
<a href="#l30.3235"></a><span id="l30.3235" class="difflineplus">+        if (!(folderFlags &amp;</span>
<a href="#l30.3236"></a><span id="l30.3236" class="difflineplus">+              (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Inbox))) {</span>
<a href="#l30.3237"></a><span id="l30.3237">           bool filtersRun;</span>
<a href="#l30.3238"></a><span id="l30.3238">           m_filterTargetFolders[index]-&gt;CallFilterPlugins(nullptr, &amp;filtersRun);</span>
<a href="#l30.3239"></a><span id="l30.3239">           if (!filtersRun)</span>
<a href="#l30.3240"></a><span id="l30.3240">             m_filterTargetFolders[index]-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l30.3241"></a><span id="l30.3241">         }</span>
<a href="#l30.3242"></a><span id="l30.3242">       }</span>
<a href="#l30.3243"></a><span id="l30.3243">     }</span>
<a href="#l30.3244"></a><span id="l30.3244">   }</span>
<a href="#l30.3245"></a><span id="l30.3245">   m_filterTargetFolders.Clear();</span>
<a href="#l30.3246"></a><span id="l30.3246">   return rv;</span>
<a href="#l30.3247"></a><span id="l30.3247"> }</span>
<a href="#l30.3248"></a><span id="l30.3248"> </span>
<a href="#l30.3249"></a><span id="l30.3249"> nsresult nsParseNewMailState::AppendMsgFromStream(nsIInputStream *fileStream,</span>
<a href="#l30.3250"></a><span id="l30.3250">                                                   nsIMsgDBHdr *aHdr,</span>
<a href="#l30.3251"></a><span id="l30.3251">                                                   uint32_t length,</span>
<a href="#l30.3252"></a><span id="l30.3252" class="difflineminus">-                                                  nsIMsgFolder *destFolder)</span>
<a href="#l30.3253"></a><span id="l30.3253" class="difflineminus">-{</span>
<a href="#l30.3254"></a><span id="l30.3254" class="difflineplus">+                                                  nsIMsgFolder *destFolder) {</span>
<a href="#l30.3255"></a><span id="l30.3255">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; store;</span>
<a href="#l30.3256"></a><span id="l30.3256">   nsCOMPtr&lt;nsIOutputStream&gt; destOutputStream;</span>
<a href="#l30.3257"></a><span id="l30.3257">   nsresult rv = destFolder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l30.3258"></a><span id="l30.3258">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.3259"></a><span id="l30.3259">   bool reusable;</span>
<a href="#l30.3260"></a><span id="l30.3260">   rv = store-&gt;GetNewMsgOutputStream(destFolder, &amp;aHdr, &amp;reusable,</span>
<a href="#l30.3261"></a><span id="l30.3261">                                     getter_AddRefs(destOutputStream));</span>
<a href="#l30.3262"></a><span id="l30.3262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.3263"></a><span id="l30.3263"> </span>
<a href="#l30.3264"></a><span id="l30.3264" class="difflineminus">-  if (!m_ibuffer)</span>
<a href="#l30.3265"></a><span id="l30.3265" class="difflineminus">-  {</span>
<a href="#l30.3266"></a><span id="l30.3266" class="difflineplus">+  if (!m_ibuffer) {</span>
<a href="#l30.3267"></a><span id="l30.3267">     m_ibuffer_size = FILE_IO_BUFFER_SIZE;</span>
<a href="#l30.3268"></a><span id="l30.3268" class="difflineminus">-    m_ibuffer = (char *) PR_Malloc(m_ibuffer_size);</span>
<a href="#l30.3269"></a><span id="l30.3269" class="difflineplus">+    m_ibuffer = (char *)PR_Malloc(m_ibuffer_size);</span>
<a href="#l30.3270"></a><span id="l30.3270">     NS_ASSERTION(m_ibuffer != nullptr, &quot;couldn't get memory to move msg&quot;);</span>
<a href="#l30.3271"></a><span id="l30.3271">   }</span>
<a href="#l30.3272"></a><span id="l30.3272">   m_ibuffer_fp = 0;</span>
<a href="#l30.3273"></a><span id="l30.3273"> </span>
<a href="#l30.3274"></a><span id="l30.3274" class="difflineminus">-  while (length &gt; 0 &amp;&amp; m_ibuffer)</span>
<a href="#l30.3275"></a><span id="l30.3275" class="difflineminus">-  {</span>
<a href="#l30.3276"></a><span id="l30.3276" class="difflineplus">+  while (length &gt; 0 &amp;&amp; m_ibuffer) {</span>
<a href="#l30.3277"></a><span id="l30.3277">     uint32_t nRead;</span>
<a href="#l30.3278"></a><span id="l30.3278" class="difflineminus">-    fileStream-&gt;Read (m_ibuffer, length &gt; m_ibuffer_size ? m_ibuffer_size  : length, &amp;nRead);</span>
<a href="#l30.3279"></a><span id="l30.3279" class="difflineminus">-    if (nRead == 0)</span>
<a href="#l30.3280"></a><span id="l30.3280" class="difflineminus">-      break;</span>
<a href="#l30.3281"></a><span id="l30.3281" class="difflineplus">+    fileStream-&gt;Read(m_ibuffer,</span>
<a href="#l30.3282"></a><span id="l30.3282" class="difflineplus">+                     length &gt; m_ibuffer_size ? m_ibuffer_size : length, &amp;nRead);</span>
<a href="#l30.3283"></a><span id="l30.3283" class="difflineplus">+    if (nRead == 0) break;</span>
<a href="#l30.3284"></a><span id="l30.3284"> </span>
<a href="#l30.3285"></a><span id="l30.3285">     uint32_t bytesWritten;</span>
<a href="#l30.3286"></a><span id="l30.3286">     // Check the number of bytes actually written to the stream.</span>
<a href="#l30.3287"></a><span id="l30.3287">     destOutputStream-&gt;Write(m_ibuffer, nRead, &amp;bytesWritten);</span>
<a href="#l30.3288"></a><span id="l30.3288" class="difflineminus">-    if (bytesWritten != nRead)</span>
<a href="#l30.3289"></a><span id="l30.3289" class="difflineminus">-    {</span>
<a href="#l30.3290"></a><span id="l30.3290" class="difflineplus">+    if (bytesWritten != nRead) {</span>
<a href="#l30.3291"></a><span id="l30.3291">       destOutputStream-&gt;Close();</span>
<a href="#l30.3292"></a><span id="l30.3292">       return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l30.3293"></a><span id="l30.3293">     }</span>
<a href="#l30.3294"></a><span id="l30.3294"> </span>
<a href="#l30.3295"></a><span id="l30.3295">     length -= nRead;</span>
<a href="#l30.3296"></a><span id="l30.3296">   }</span>
<a href="#l30.3297"></a><span id="l30.3297"> </span>
<a href="#l30.3298"></a><span id="l30.3298" class="difflineminus">-  NS_ASSERTION(length == 0, &quot;didn't read all of original message in filter move&quot;);</span>
<a href="#l30.3299"></a><span id="l30.3299" class="difflineplus">+  NS_ASSERTION(length == 0,</span>
<a href="#l30.3300"></a><span id="l30.3300" class="difflineplus">+               &quot;didn't read all of original message in filter move&quot;);</span>
<a href="#l30.3301"></a><span id="l30.3301"> </span>
<a href="#l30.3302"></a><span id="l30.3302">   // non-reusable streams will get closed by the store.</span>
<a href="#l30.3303"></a><span id="l30.3303" class="difflineminus">-  if (reusable)</span>
<a href="#l30.3304"></a><span id="l30.3304" class="difflineminus">-    destOutputStream-&gt;Close();</span>
<a href="#l30.3305"></a><span id="l30.3305" class="difflineplus">+  if (reusable) destOutputStream-&gt;Close();</span>
<a href="#l30.3306"></a><span id="l30.3306">   return store-&gt;FinishNewMessage(destOutputStream, aHdr);</span>
<a href="#l30.3307"></a><span id="l30.3307"> }</span>
<a href="#l30.3308"></a><span id="l30.3308"> </span>
<a href="#l30.3309"></a><span id="l30.3309"> /*</span>
<a href="#l30.3310"></a><span id="l30.3310">  * Moves message pointed to by mailHdr into folder destIFolder.</span>
<a href="#l30.3311"></a><span id="l30.3311">  * After successful move mailHdr is no longer usable by the caller.</span>
<a href="#l30.3312"></a><span id="l30.3312">  */</span>
<a href="#l30.3313"></a><span id="l30.3313"> nsresult nsParseNewMailState::MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l30.3314"></a><span id="l30.3314">                                                       nsIMsgDatabase *sourceDB,</span>
<a href="#l30.3315"></a><span id="l30.3315">                                                       nsIMsgFolder *destIFolder,</span>
<a href="#l30.3316"></a><span id="l30.3316">                                                       nsIMsgFilter *filter,</span>
<a href="#l30.3317"></a><span id="l30.3317" class="difflineminus">-                                                      nsIMsgWindow *msgWindow)</span>
<a href="#l30.3318"></a><span id="l30.3318" class="difflineminus">-{</span>
<a href="#l30.3319"></a><span id="l30.3319" class="difflineplus">+                                                      nsIMsgWindow *msgWindow) {</span>
<a href="#l30.3320"></a><span id="l30.3320">   NS_ENSURE_ARG_POINTER(destIFolder);</span>
<a href="#l30.3321"></a><span id="l30.3321">   nsresult rv = NS_OK;</span>
<a href="#l30.3322"></a><span id="l30.3322"> </span>
<a href="#l30.3323"></a><span id="l30.3323">   // check if the destination is a real folder (by checking for null parent)</span>
<a href="#l30.3324"></a><span id="l30.3324" class="difflineminus">-  // and if it can file messages (e.g., servers or news folders can't file messages).</span>
<a href="#l30.3325"></a><span id="l30.3325" class="difflineminus">-  // Or read only imap folders...</span>
<a href="#l30.3326"></a><span id="l30.3326" class="difflineplus">+  // and if it can file messages (e.g., servers or news folders can't file</span>
<a href="#l30.3327"></a><span id="l30.3327" class="difflineplus">+  // messages). Or read only imap folders...</span>
<a href="#l30.3328"></a><span id="l30.3328">   bool canFileMessages = true;</span>
<a href="#l30.3329"></a><span id="l30.3329">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l30.3330"></a><span id="l30.3330">   destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l30.3331"></a><span id="l30.3331" class="difflineminus">-  if (parentFolder)</span>
<a href="#l30.3332"></a><span id="l30.3332" class="difflineminus">-    destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l30.3333"></a><span id="l30.3333" class="difflineminus">-  if (!parentFolder || !canFileMessages)</span>
<a href="#l30.3334"></a><span id="l30.3334" class="difflineminus">-  {</span>
<a href="#l30.3335"></a><span id="l30.3335" class="difflineminus">-    if (filter)</span>
<a href="#l30.3336"></a><span id="l30.3336" class="difflineminus">-    {</span>
<a href="#l30.3337"></a><span id="l30.3337" class="difflineplus">+  if (parentFolder) destIFolder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l30.3338"></a><span id="l30.3338" class="difflineplus">+  if (!parentFolder || !canFileMessages) {</span>
<a href="#l30.3339"></a><span id="l30.3339" class="difflineplus">+    if (filter) {</span>
<a href="#l30.3340"></a><span id="l30.3340">       filter-&gt;SetEnabled(false);</span>
<a href="#l30.3341"></a><span id="l30.3341">       // we need to explicitly save the filter file.</span>
<a href="#l30.3342"></a><span id="l30.3342" class="difflineminus">-      if (m_filterList)</span>
<a href="#l30.3343"></a><span id="l30.3343" class="difflineminus">-        m_filterList-&gt;SaveToDefaultFile();</span>
<a href="#l30.3344"></a><span id="l30.3344" class="difflineplus">+      if (m_filterList) m_filterList-&gt;SaveToDefaultFile();</span>
<a href="#l30.3345"></a><span id="l30.3345">       destIFolder-&gt;ThrowAlertMsg(&quot;filterDisabled&quot;, msgWindow);</span>
<a href="#l30.3346"></a><span id="l30.3346">     }</span>
<a href="#l30.3347"></a><span id="l30.3347">     return NS_MSG_NOT_A_MAIL_FOLDER;</span>
<a href="#l30.3348"></a><span id="l30.3348">   }</span>
<a href="#l30.3349"></a><span id="l30.3349"> </span>
<a href="#l30.3350"></a><span id="l30.3350">   uint32_t messageLength;</span>
<a href="#l30.3351"></a><span id="l30.3351">   mailHdr-&gt;GetMessageSize(&amp;messageLength);</span>
<a href="#l30.3352"></a><span id="l30.3352"> </span>
<a href="#l30.3353"></a><span id="l30.3353" class="difflineat">@@ -2496,127 +2298,116 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l30.3354"></a><span id="l30.3354">     bool destFolderTooBig = true;</span>
<a href="#l30.3355"></a><span id="l30.3355">     rv = localFolder-&gt;WarnIfLocalFileTooBig(msgWindow, messageLength,</span>
<a href="#l30.3356"></a><span id="l30.3356">                                             &amp;destFolderTooBig);</span>
<a href="#l30.3357"></a><span id="l30.3357">     if (NS_FAILED(rv) || destFolderTooBig)</span>
<a href="#l30.3358"></a><span id="l30.3358">       return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l30.3359"></a><span id="l30.3359">   }</span>
<a href="#l30.3360"></a><span id="l30.3360"> </span>
<a href="#l30.3361"></a><span id="l30.3361">   nsCOMPtr&lt;nsISupports&gt; myISupports =</span>
<a href="#l30.3362"></a><span id="l30.3362" class="difflineminus">-    do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState*&gt;(this));</span>
<a href="#l30.3363"></a><span id="l30.3363" class="difflineplus">+      do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState *&gt;(this));</span>
<a href="#l30.3364"></a><span id="l30.3364"> </span>
<a href="#l30.3365"></a><span id="l30.3365">   // Make sure no one else is writing into this folder</span>
<a href="#l30.3366"></a><span id="l30.3366" class="difflineminus">-  if (NS_FAILED(rv = destIFolder-&gt;AcquireSemaphore (myISupports)))</span>
<a href="#l30.3367"></a><span id="l30.3367" class="difflineminus">-  {</span>
<a href="#l30.3368"></a><span id="l30.3368" class="difflineplus">+  if (NS_FAILED(rv = destIFolder-&gt;AcquireSemaphore(myISupports))) {</span>
<a href="#l30.3369"></a><span id="l30.3369">     destIFolder-&gt;ThrowAlertMsg(&quot;filterFolderDeniedLocked&quot;, msgWindow);</span>
<a href="#l30.3370"></a><span id="l30.3370">     return rv;</span>
<a href="#l30.3371"></a><span id="l30.3371">   }</span>
<a href="#l30.3372"></a><span id="l30.3372">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l30.3373"></a><span id="l30.3373">   bool reusable;</span>
<a href="#l30.3374"></a><span id="l30.3374" class="difflineminus">-  rv = m_downloadFolder-&gt;GetMsgInputStream(mailHdr, &amp;reusable, getter_AddRefs(inputStream));</span>
<a href="#l30.3375"></a><span id="l30.3375" class="difflineminus">-  if (!inputStream)</span>
<a href="#l30.3376"></a><span id="l30.3376" class="difflineminus">-  {</span>
<a href="#l30.3377"></a><span id="l30.3377" class="difflineplus">+  rv = m_downloadFolder-&gt;GetMsgInputStream(mailHdr, &amp;reusable,</span>
<a href="#l30.3378"></a><span id="l30.3378" class="difflineplus">+                                           getter_AddRefs(inputStream));</span>
<a href="#l30.3379"></a><span id="l30.3379" class="difflineplus">+  if (!inputStream) {</span>
<a href="#l30.3380"></a><span id="l30.3380">     NS_ERROR(&quot;couldn't get source msg input stream in move filter&quot;);</span>
<a href="#l30.3381"></a><span id="l30.3381" class="difflineminus">-    destIFolder-&gt;ReleaseSemaphore (myISupports);</span>
<a href="#l30.3382"></a><span id="l30.3382" class="difflineplus">+    destIFolder-&gt;ReleaseSemaphore(myISupports);</span>
<a href="#l30.3383"></a><span id="l30.3383">     return NS_MSG_FOLDER_UNREADABLE;  // ### dmb</span>
<a href="#l30.3384"></a><span id="l30.3384">   }</span>
<a href="#l30.3385"></a><span id="l30.3385"> </span>
<a href="#l30.3386"></a><span id="l30.3386">   nsCOMPtr&lt;nsIMsgDatabase&gt; destMailDB;</span>
<a href="#l30.3387"></a><span id="l30.3387"> </span>
<a href="#l30.3388"></a><span id="l30.3388" class="difflineminus">-  if (!localFolder)</span>
<a href="#l30.3389"></a><span id="l30.3389" class="difflineminus">-    return NS_MSG_POP_FILTER_TARGET_ERROR;</span>
<a href="#l30.3390"></a><span id="l30.3390" class="difflineplus">+  if (!localFolder) return NS_MSG_POP_FILTER_TARGET_ERROR;</span>
<a href="#l30.3391"></a><span id="l30.3391"> </span>
<a href="#l30.3392"></a><span id="l30.3392" class="difflineminus">-  // don't force upgrade in place - open the db here before we start writing to the</span>
<a href="#l30.3393"></a><span id="l30.3393" class="difflineminus">-  // destination file because XP_Stat can return file size including bytes written...</span>
<a href="#l30.3394"></a><span id="l30.3394" class="difflineplus">+  // don't force upgrade in place - open the db here before we start writing to</span>
<a href="#l30.3395"></a><span id="l30.3395" class="difflineplus">+  // the destination file because XP_Stat can return file size including bytes</span>
<a href="#l30.3396"></a><span id="l30.3396" class="difflineplus">+  // written...</span>
<a href="#l30.3397"></a><span id="l30.3397">   rv = localFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(destMailDB));</span>
<a href="#l30.3398"></a><span id="l30.3398">   NS_WARNING_ASSERTION(destMailDB &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l30.3399"></a><span id="l30.3399">                        &quot;failed to open mail db parsing folder&quot;);</span>
<a href="#l30.3400"></a><span id="l30.3400">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l30.3401"></a><span id="l30.3401"> </span>
<a href="#l30.3402"></a><span id="l30.3402">   if (destMailDB)</span>
<a href="#l30.3403"></a><span id="l30.3403">     rv = destMailDB-&gt;CopyHdrFromExistingHdr(m_new_key, mailHdr, true,</span>
<a href="#l30.3404"></a><span id="l30.3404">                                             getter_AddRefs(newHdr));</span>
<a href="#l30.3405"></a><span id="l30.3405" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !newHdr)</span>
<a href="#l30.3406"></a><span id="l30.3406" class="difflineminus">-    rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l30.3407"></a><span id="l30.3407" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !newHdr) rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l30.3408"></a><span id="l30.3408"> </span>
<a href="#l30.3409"></a><span id="l30.3409" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.3410"></a><span id="l30.3410" class="difflineminus">-  {</span>
<a href="#l30.3411"></a><span id="l30.3411" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l30.3412"></a><span id="l30.3412">     destIFolder-&gt;ThrowAlertMsg(&quot;filterFolderHdrAddFailed&quot;, msgWindow);</span>
<a href="#l30.3413"></a><span id="l30.3413">   } else {</span>
<a href="#l30.3414"></a><span id="l30.3414">     rv = AppendMsgFromStream(inputStream, newHdr, messageLength, destIFolder);</span>
<a href="#l30.3415"></a><span id="l30.3415">     if (NS_FAILED(rv))</span>
<a href="#l30.3416"></a><span id="l30.3416">       destIFolder-&gt;ThrowAlertMsg(&quot;filterFolderWriteFailed&quot;, msgWindow);</span>
<a href="#l30.3417"></a><span id="l30.3417">   }</span>
<a href="#l30.3418"></a><span id="l30.3418"> </span>
<a href="#l30.3419"></a><span id="l30.3419" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.3420"></a><span id="l30.3420" class="difflineminus">-  {</span>
<a href="#l30.3421"></a><span id="l30.3421" class="difflineminus">-    if (destMailDB)</span>
<a href="#l30.3422"></a><span id="l30.3422" class="difflineminus">-      destMailDB-&gt;Close(true);</span>
<a href="#l30.3423"></a><span id="l30.3423" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l30.3424"></a><span id="l30.3424" class="difflineplus">+    if (destMailDB) destMailDB-&gt;Close(true);</span>
<a href="#l30.3425"></a><span id="l30.3425"> </span>
<a href="#l30.3426"></a><span id="l30.3426">     destIFolder-&gt;ReleaseSemaphore(myISupports);</span>
<a href="#l30.3427"></a><span id="l30.3427"> </span>
<a href="#l30.3428"></a><span id="l30.3428">     return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l30.3429"></a><span id="l30.3429">   }</span>
<a href="#l30.3430"></a><span id="l30.3430"> </span>
<a href="#l30.3431"></a><span id="l30.3431">   bool movedMsgIsNew = false;</span>
<a href="#l30.3432"></a><span id="l30.3432" class="difflineminus">-  // if we have made it this far then the message has successfully been written to the new folder</span>
<a href="#l30.3433"></a><span id="l30.3433" class="difflineminus">-  // now add the header to the destMailDB.</span>
<a href="#l30.3434"></a><span id="l30.3434" class="difflineplus">+  // if we have made it this far then the message has successfully been written</span>
<a href="#l30.3435"></a><span id="l30.3435" class="difflineplus">+  // to the new folder now add the header to the destMailDB.</span>
<a href="#l30.3436"></a><span id="l30.3436"> </span>
<a href="#l30.3437"></a><span id="l30.3437">   uint32_t newFlags;</span>
<a href="#l30.3438"></a><span id="l30.3438">   newHdr-&gt;GetFlags(&amp;newFlags);</span>
<a href="#l30.3439"></a><span id="l30.3439">   nsMsgKey msgKey;</span>
<a href="#l30.3440"></a><span id="l30.3440">   newHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l30.3441"></a><span id="l30.3441" class="difflineminus">-  if (!(newFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l30.3442"></a><span id="l30.3442" class="difflineminus">-  {</span>
<a href="#l30.3443"></a><span id="l30.3443" class="difflineplus">+  if (!(newFlags &amp; nsMsgMessageFlags::Read)) {</span>
<a href="#l30.3444"></a><span id="l30.3444">     nsCString junkScoreStr;</span>
<a href="#l30.3445"></a><span id="l30.3445" class="difflineminus">-    (void) newHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l30.3446"></a><span id="l30.3446" class="difflineminus">-    if (atoi(junkScoreStr.get()) == nsIJunkMailPlugin::IS_HAM_SCORE)</span>
<a href="#l30.3447"></a><span id="l30.3447" class="difflineminus">-    {</span>
<a href="#l30.3448"></a><span id="l30.3448" class="difflineplus">+    (void)newHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l30.3449"></a><span id="l30.3449" class="difflineplus">+    if (atoi(junkScoreStr.get()) == nsIJunkMailPlugin::IS_HAM_SCORE) {</span>
<a href="#l30.3450"></a><span id="l30.3450">       newHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l30.3451"></a><span id="l30.3451">       destMailDB-&gt;AddToNewList(msgKey);</span>
<a href="#l30.3452"></a><span id="l30.3452">       movedMsgIsNew = true;</span>
<a href="#l30.3453"></a><span id="l30.3453">     }</span>
<a href="#l30.3454"></a><span id="l30.3454">   }</span>
<a href="#l30.3455"></a><span id="l30.3455" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l30.3456"></a><span id="l30.3456" class="difflineminus">-  if (notifier)</span>
<a href="#l30.3457"></a><span id="l30.3457" class="difflineminus">-    notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l30.3458"></a><span id="l30.3458" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l30.3459"></a><span id="l30.3459" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l30.3460"></a><span id="l30.3460" class="difflineplus">+  if (notifier) notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l30.3461"></a><span id="l30.3461">   // mark the header as not yet reported classified</span>
<a href="#l30.3462"></a><span id="l30.3462" class="difflineminus">-  destIFolder-&gt;OrProcessingFlags(</span>
<a href="#l30.3463"></a><span id="l30.3463" class="difflineminus">-    msgKey, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l30.3464"></a><span id="l30.3464" class="difflineplus">+  destIFolder-&gt;OrProcessingFlags(msgKey,</span>
<a href="#l30.3465"></a><span id="l30.3465" class="difflineplus">+                                 nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l30.3466"></a><span id="l30.3466">   m_msgToForwardOrReply = newHdr;</span>
<a href="#l30.3467"></a><span id="l30.3467"> </span>
<a href="#l30.3468"></a><span id="l30.3468" class="difflineminus">-  if (movedMsgIsNew)</span>
<a href="#l30.3469"></a><span id="l30.3469" class="difflineminus">-    destIFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l30.3470"></a><span id="l30.3470" class="difflineplus">+  if (movedMsgIsNew) destIFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l30.3471"></a><span id="l30.3471">   if (!m_filterTargetFolders.Contains(destIFolder))</span>
<a href="#l30.3472"></a><span id="l30.3472">     m_filterTargetFolders.AppendObject(destIFolder);</span>
<a href="#l30.3473"></a><span id="l30.3473"> </span>
<a href="#l30.3474"></a><span id="l30.3474" class="difflineminus">-  destIFolder-&gt;ReleaseSemaphore (myISupports);</span>
<a href="#l30.3475"></a><span id="l30.3475" class="difflineplus">+  destIFolder-&gt;ReleaseSemaphore(myISupports);</span>
<a href="#l30.3476"></a><span id="l30.3476"> </span>
<a href="#l30.3477"></a><span id="l30.3477" class="difflineminus">-  (void) localFolder-&gt;RefreshSizeOnDisk();</span>
<a href="#l30.3478"></a><span id="l30.3478" class="difflineplus">+  (void)localFolder-&gt;RefreshSizeOnDisk();</span>
<a href="#l30.3479"></a><span id="l30.3479"> </span>
<a href="#l30.3480"></a><span id="l30.3480">   // Notify the message was moved.</span>
<a href="#l30.3481"></a><span id="l30.3481">   if (notifier) {</span>
<a href="#l30.3482"></a><span id="l30.3482">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l30.3483"></a><span id="l30.3483">     nsresult rv = mailHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l30.3484"></a><span id="l30.3484">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.3485"></a><span id="l30.3485" class="difflineminus">-      notifier-&gt;NotifyItemEvent(folder,</span>
<a href="#l30.3486"></a><span id="l30.3486" class="difflineminus">-                                NS_LITERAL_CSTRING(&quot;UnincorporatedMessageMoved&quot;),</span>
<a href="#l30.3487"></a><span id="l30.3487" class="difflineminus">-                                newHdr,</span>
<a href="#l30.3488"></a><span id="l30.3488" class="difflineminus">-                                EmptyCString());</span>
<a href="#l30.3489"></a><span id="l30.3489" class="difflineplus">+      notifier-&gt;NotifyItemEvent(</span>
<a href="#l30.3490"></a><span id="l30.3490" class="difflineplus">+          folder, NS_LITERAL_CSTRING(&quot;UnincorporatedMessageMoved&quot;), newHdr,</span>
<a href="#l30.3491"></a><span id="l30.3491" class="difflineplus">+          EmptyCString());</span>
<a href="#l30.3492"></a><span id="l30.3492">     } else {</span>
<a href="#l30.3493"></a><span id="l30.3493">       NS_WARNING(&quot;Can't get folder for message that was moved.&quot;);</span>
<a href="#l30.3494"></a><span id="l30.3494">     }</span>
<a href="#l30.3495"></a><span id="l30.3495">   }</span>
<a href="#l30.3496"></a><span id="l30.3496"> </span>
<a href="#l30.3497"></a><span id="l30.3497">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; store;</span>
<a href="#l30.3498"></a><span id="l30.3498">   rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l30.3499"></a><span id="l30.3499" class="difflineminus">-  if (store)</span>
<a href="#l30.3500"></a><span id="l30.3500" class="difflineminus">-    store-&gt;DiscardNewMessage(m_outputStream, mailHdr);</span>
<a href="#l30.3501"></a><span id="l30.3501" class="difflineminus">-  if (sourceDB)</span>
<a href="#l30.3502"></a><span id="l30.3502" class="difflineminus">-    sourceDB-&gt;RemoveHeaderMdbRow(mailHdr);</span>
<a href="#l30.3503"></a><span id="l30.3503" class="difflineplus">+  if (store) store-&gt;DiscardNewMessage(m_outputStream, mailHdr);</span>
<a href="#l30.3504"></a><span id="l30.3504" class="difflineplus">+  if (sourceDB) sourceDB-&gt;RemoveHeaderMdbRow(mailHdr);</span>
<a href="#l30.3505"></a><span id="l30.3505"> </span>
<a href="#l30.3506"></a><span id="l30.3506">   // update the folder size so we won't reparse.</span>
<a href="#l30.3507"></a><span id="l30.3507">   UpdateDBFolderInfo(destMailDB);</span>
<a href="#l30.3508"></a><span id="l30.3508">   destIFolder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l30.3509"></a><span id="l30.3509"> </span>
<a href="#l30.3510"></a><span id="l30.3510">   destMailDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l30.3511"></a><span id="l30.3511">   return rv;</span>
<a href="#l30.3512"></a><span id="l30.3512"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -28,55 +28,54 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> class nsByteArray;</span>
<a href="#l31.7"></a><span id="l31.7"> class nsOutputFileStream;</span>
<a href="#l31.8"></a><span id="l31.8"> class nsIMsgFolder;</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10"> /* Used for the various things that parse RFC822 headers...</span>
<a href="#l31.11"></a><span id="l31.11">  */</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-typedef struct message_header</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-{</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+typedef struct message_header {</span>
<a href="#l31.15"></a><span id="l31.15">   const char *value; /* The contents of a header (after &quot;: &quot;) */</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-  int32_t length;      /* The length of the data (it is not NULL-terminated.) */</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+  int32_t length;    /* The length of the data (it is not NULL-terminated.) */</span>
<a href="#l31.18"></a><span id="l31.18"> } message_header;</span>
<a href="#l31.19"></a><span id="l31.19"> </span>
<a href="#l31.20"></a><span id="l31.20"> // This object maintains the parse state for a single mail message.</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-class nsParseMailMessageState : public nsIMsgParseMailMsgState, public nsIDBChangeListener</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-{</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineminus">-public:</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+class nsParseMailMessageState : public nsIMsgParseMailMsgState,</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+                                public nsIDBChangeListener {</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+ public:</span>
<a href="#l31.27"></a><span id="l31.27">   NS_DECL_ISUPPORTS</span>
<a href="#l31.28"></a><span id="l31.28">   NS_DECL_NSIMSGPARSEMAILMSGSTATE</span>
<a href="#l31.29"></a><span id="l31.29">   NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l31.30"></a><span id="l31.30"> </span>
<a href="#l31.31"></a><span id="l31.31">   nsParseMailMessageState();</span>
<a href="#l31.32"></a><span id="l31.32"> </span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-  void                  Init(uint64_t fileposition);</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-  virtual nsresult      ParseFolderLine(const char *line, uint32_t lineLength);</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-  virtual nsresult      StartNewEnvelope(const char *line, uint32_t lineLength);</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-  nsresult              ParseHeaders();</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-  nsresult              FinalizeHeaders();</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-  nsresult              ParseEnvelope (const char *line, uint32_t line_size);</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-  nsresult              InternSubject (struct message_header *header);</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+  void Init(uint64_t fileposition);</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+  virtual nsresult ParseFolderLine(const char *line, uint32_t lineLength);</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+  virtual nsresult StartNewEnvelope(const char *line, uint32_t lineLength);</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+  nsresult ParseHeaders();</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+  nsresult FinalizeHeaders();</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+  nsresult ParseEnvelope(const char *line, uint32_t line_size);</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+  nsresult InternSubject(struct message_header *header);</span>
<a href="#l31.47"></a><span id="l31.47"> </span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-  static bool    IsEnvelopeLine(const char *buf, int32_t buf_size);</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+  static bool IsEnvelopeLine(const char *buf, int32_t buf_size);</span>
<a href="#l31.50"></a><span id="l31.50"> </span>
<a href="#l31.51"></a><span id="l31.51">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newMsgHdr; /* current message header we're building */</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDatabase&gt;  m_mailDB;</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_mailDB;</span>
<a href="#l31.54"></a><span id="l31.54">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_backupMailDB;</span>
<a href="#l31.55"></a><span id="l31.55"> </span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-  nsMailboxParseState   m_state;</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineminus">-  int64_t              m_position;</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineminus">-  uint64_t              m_envelope_pos;</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-  uint64_t              m_headerstartpos;</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-  nsMsgKey              m_new_key;    // DB key for the new header.</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+  nsMailboxParseState m_state;</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+  int64_t m_position;</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+  uint64_t m_envelope_pos;</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+  uint64_t m_headerstartpos;</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+  nsMsgKey m_new_key;  // DB key for the new header.</span>
<a href="#l31.66"></a><span id="l31.66"> </span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-  nsByteArray           m_headers;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+  nsByteArray m_headers;</span>
<a href="#l31.69"></a><span id="l31.69"> </span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-  nsByteArray           m_envelope;</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+  nsByteArray m_envelope;</span>
<a href="#l31.72"></a><span id="l31.72"> </span>
<a href="#l31.73"></a><span id="l31.73">   struct message_header m_message_id;</span>
<a href="#l31.74"></a><span id="l31.74">   struct message_header m_references;</span>
<a href="#l31.75"></a><span id="l31.75">   struct message_header m_date;</span>
<a href="#l31.76"></a><span id="l31.76">   struct message_header m_delivery_date;</span>
<a href="#l31.77"></a><span id="l31.77">   struct message_header m_from;</span>
<a href="#l31.78"></a><span id="l31.78">   struct message_header m_sender;</span>
<a href="#l31.79"></a><span id="l31.79">   struct message_header m_newsgroups;</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineat">@@ -85,176 +84,183 @@ public:</span>
<a href="#l31.81"></a><span id="l31.81">   struct message_header m_mozstatus;</span>
<a href="#l31.82"></a><span id="l31.82">   struct message_header m_mozstatus2;</span>
<a href="#l31.83"></a><span id="l31.83">   struct message_header m_in_reply_to;</span>
<a href="#l31.84"></a><span id="l31.84">   struct message_header m_replyTo;</span>
<a href="#l31.85"></a><span id="l31.85">   struct message_header m_content_type;</span>
<a href="#l31.86"></a><span id="l31.86">   struct message_header m_bccList;</span>
<a href="#l31.87"></a><span id="l31.87"> </span>
<a href="#l31.88"></a><span id="l31.88">   // Support for having multiple To or Cc header lines in a message</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-  nsTArray&lt;struct message_header*&gt; m_toList;</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-  nsTArray&lt;struct message_header*&gt; m_ccList;</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineminus">-  struct message_header *GetNextHeaderInAggregate (nsTArray&lt;struct message_header*&gt; &amp;list);</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineminus">-  void GetAggregateHeader (nsTArray&lt;struct message_header*&gt; &amp;list, struct message_header *);</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineminus">-  void ClearAggregateHeader (nsTArray&lt;struct message_header*&gt; &amp;list);</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+  nsTArray&lt;struct message_header *&gt; m_toList;</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+  nsTArray&lt;struct message_header *&gt; m_ccList;</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+  struct message_header *GetNextHeaderInAggregate(</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+      nsTArray&lt;struct message_header *&gt; &amp;list);</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+  void GetAggregateHeader(nsTArray&lt;struct message_header *&gt; &amp;list,</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+                          struct message_header *);</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+  void ClearAggregateHeader(nsTArray&lt;struct message_header *&gt; &amp;list);</span>
<a href="#l31.101"></a><span id="l31.101"> </span>
<a href="#l31.102"></a><span id="l31.102">   struct message_header m_envelope_from;</span>
<a href="#l31.103"></a><span id="l31.103">   struct message_header m_envelope_date;</span>
<a href="#l31.104"></a><span id="l31.104">   struct message_header m_priority;</span>
<a href="#l31.105"></a><span id="l31.105">   struct message_header m_account_key;</span>
<a href="#l31.106"></a><span id="l31.106">   struct message_header m_keywords;</span>
<a href="#l31.107"></a><span id="l31.107">   // Mdn support</span>
<a href="#l31.108"></a><span id="l31.108">   struct message_header m_mdn_original_recipient;</span>
<a href="#l31.109"></a><span id="l31.109">   struct message_header m_return_path;</span>
<a href="#l31.110"></a><span id="l31.110">   struct message_header m_mdn_dnt; /* MDN Disposition-Notification-To: header */</span>
<a href="#l31.111"></a><span id="l31.111"> </span>
<a href="#l31.112"></a><span id="l31.112">   PRTime m_receivedTime;</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-  uint16_t              m_body_lines;</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-  uint16_t              m_lastLineBlank;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+  uint16_t m_body_lines;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+  uint16_t m_lastLineBlank;</span>
<a href="#l31.117"></a><span id="l31.117"> </span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-  bool                  m_IgnoreXMozillaStatus;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+  bool m_IgnoreXMozillaStatus;</span>
<a href="#l31.120"></a><span id="l31.120"> </span>
<a href="#l31.121"></a><span id="l31.121">   // this enables extensions to add the values of particular headers to</span>
<a href="#l31.122"></a><span id="l31.122">   // the .msf file as properties of nsIMsgHdr. It is initialized from a</span>
<a href="#l31.123"></a><span id="l31.123">   // pref, mailnews.customDBHeaders</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-  nsTArray&lt;nsCString&gt;   m_customDBHeaders;</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_customDBHeaders;</span>
<a href="#l31.126"></a><span id="l31.126">   struct message_header *m_customDBHeaderValues;</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-  nsCString m_receivedValue; // accumulated received header</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineminus">-protected:</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+  nsCString m_receivedValue;  // accumulated received header</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+ protected:</span>
<a href="#l31.131"></a><span id="l31.131">   virtual ~nsParseMailMessageState();</span>
<a href="#l31.132"></a><span id="l31.132"> };</span>
<a href="#l31.133"></a><span id="l31.133"> </span>
<a href="#l31.134"></a><span id="l31.134"> // This class is part of the mailbox parsing state machine</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-class nsMsgMailboxParser : public nsIStreamListener, public nsParseMailMessageState, public nsMsgLineBuffer</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-{</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-public:</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+class nsMsgMailboxParser : public nsIStreamListener,</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+                           public nsParseMailMessageState,</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+                           public nsMsgLineBuffer {</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+ public:</span>
<a href="#l31.142"></a><span id="l31.142">   explicit nsMsgMailboxParser(nsIMsgFolder *);</span>
<a href="#l31.143"></a><span id="l31.143">   nsMsgMailboxParser();</span>
<a href="#l31.144"></a><span id="l31.144">   nsresult Init();</span>
<a href="#l31.145"></a><span id="l31.145"> </span>
<a href="#l31.146"></a><span id="l31.146" class="difflineminus">-  bool    IsRunningUrl() { return m_urlInProgress;} // returns true if we are currently running a url and false otherwise...</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+  bool IsRunningUrl() {</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+    return m_urlInProgress;</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+  }  // returns true if we are currently running a url and false otherwise...</span>
<a href="#l31.150"></a><span id="l31.150">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l31.151"></a><span id="l31.151"> </span>
<a href="#l31.152"></a><span id="l31.152">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.153"></a><span id="l31.153">   // we support the nsIStreamListener interface</span>
<a href="#l31.154"></a><span id="l31.154">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.155"></a><span id="l31.155">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l31.156"></a><span id="l31.156">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l31.157"></a><span id="l31.157"> </span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-  void    SetDB (nsIMsgDatabase *mailDB) {m_mailDB = mailDB; }</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+  void SetDB(nsIMsgDatabase *mailDB) { m_mailDB = mailDB; }</span>
<a href="#l31.160"></a><span id="l31.160"> </span>
<a href="#l31.161"></a><span id="l31.161">   // message socket libnet callbacks, which come through folder pane</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-  nsresult ProcessMailboxInputStream(nsIInputStream *aIStream, uint32_t aLength);</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+  nsresult ProcessMailboxInputStream(nsIInputStream *aIStream,</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineplus">+                                     uint32_t aLength);</span>
<a href="#l31.165"></a><span id="l31.165"> </span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-  virtual void  DoneParsingFolder(nsresult status);</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-  virtual void  AbortNewHeader();</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+  virtual void DoneParsingFolder(nsresult status);</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+  virtual void AbortNewHeader();</span>
<a href="#l31.170"></a><span id="l31.170"> </span>
<a href="#l31.171"></a><span id="l31.171">   // for nsMsgLineBuffer</span>
<a href="#l31.172"></a><span id="l31.172">   virtual nsresult HandleLine(const char *line, uint32_t line_length) override;</span>
<a href="#l31.173"></a><span id="l31.173"> </span>
<a href="#l31.174"></a><span id="l31.174" class="difflineminus">-  void  UpdateDBFolderInfo();</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-  void  UpdateDBFolderInfo(nsIMsgDatabase *mailDB);</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineminus">-  void  UpdateStatusText(const char* stringName);</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineplus">+  void UpdateDBFolderInfo();</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineplus">+  void UpdateDBFolderInfo(nsIMsgDatabase *mailDB);</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineplus">+  void UpdateStatusText(const char *stringName);</span>
<a href="#l31.180"></a><span id="l31.180"> </span>
<a href="#l31.181"></a><span id="l31.181">   // Update the progress bar based on what we know.</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineminus">-  virtual void    UpdateProgressPercent ();</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineplus">+  virtual void UpdateProgressPercent();</span>
<a href="#l31.184"></a><span id="l31.184">   virtual void OnNewMessage(nsIMsgWindow *msgWindow);</span>
<a href="#l31.185"></a><span id="l31.185"> </span>
<a href="#l31.186"></a><span id="l31.186" class="difflineminus">-protected:</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+ protected:</span>
<a href="#l31.188"></a><span id="l31.188">   virtual ~nsMsgMailboxParser();</span>
<a href="#l31.189"></a><span id="l31.189">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l31.190"></a><span id="l31.190"> </span>
<a href="#l31.191"></a><span id="l31.191" class="difflineminus">-  virtual int32_t     PublishMsgHeader(nsIMsgWindow *msgWindow);</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineminus">-  void                FreeBuffers();</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+  virtual int32_t PublishMsgHeader(nsIMsgWindow *msgWindow);</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineplus">+  void FreeBuffers();</span>
<a href="#l31.195"></a><span id="l31.195"> </span>
<a href="#l31.196"></a><span id="l31.196">   // data</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineminus">-  nsString        m_folderName;</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineminus">-  nsCString       m_inboxUri;</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineminus">-  nsByteArray     m_inputStream;</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineminus">-  int32_t         m_obuffer_size;</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineminus">-  char            *m_obuffer;</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineminus">-  uint64_t        m_graph_progress_total;</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineminus">-  uint64_t        m_graph_progress_received;</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineminus">-  bool            m_parsingDone;</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineminus">-  PRTime          m_startTime;</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineminus">-private:</span>
<a href="#l31.207"></a><span id="l31.207" class="difflineminus">-  // the following flag is used to determine when a url is currently being run. It is cleared on calls</span>
<a href="#l31.208"></a><span id="l31.208" class="difflineminus">-  // to ::StopBinding and it is set whenever we call Load on a url</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineminus">-  bool      m_urlInProgress;</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineplus">+  nsString m_folderName;</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineplus">+  nsCString m_inboxUri;</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+  nsByteArray m_inputStream;</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineplus">+  int32_t m_obuffer_size;</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineplus">+  char *m_obuffer;</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineplus">+  uint64_t m_graph_progress_total;</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineplus">+  uint64_t m_graph_progress_received;</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineplus">+  bool m_parsingDone;</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineplus">+  PRTime m_startTime;</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineplus">+</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineplus">+ private:</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineplus">+  // the following flag is used to determine when a url is currently being run.</span>
<a href="#l31.222"></a><span id="l31.222" class="difflineplus">+  // It is cleared on calls to ::StopBinding and it is set whenever we call Load</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineplus">+  // on a url</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineplus">+  bool m_urlInProgress;</span>
<a href="#l31.225"></a><span id="l31.225">   nsWeakPtr m_folder;</span>
<a href="#l31.226"></a><span id="l31.226">   void ReleaseFolderLock();</span>
<a href="#l31.227"></a><span id="l31.227">   nsresult AcquireFolderLock();</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineminus">-</span>
<a href="#l31.229"></a><span id="l31.229"> };</span>
<a href="#l31.230"></a><span id="l31.230"> </span>
<a href="#l31.231"></a><span id="l31.231" class="difflineminus">-class nsParseNewMailState : public nsMsgMailboxParser</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineminus">-, public nsIMsgFilterHitNotify</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineminus">-{</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineminus">-public:</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineplus">+class nsParseNewMailState : public nsMsgMailboxParser,</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineplus">+                            public nsIMsgFilterHitNotify {</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineplus">+ public:</span>
<a href="#l31.238"></a><span id="l31.238">   nsParseNewMailState();</span>
<a href="#l31.239"></a><span id="l31.239">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l31.240"></a><span id="l31.240"> </span>
<a href="#l31.241"></a><span id="l31.241">   NS_IMETHOD FinishHeader() override;</span>
<a href="#l31.242"></a><span id="l31.242"> </span>
<a href="#l31.243"></a><span id="l31.243">   nsresult Init(nsIMsgFolder *rootFolder, nsIMsgFolder *downloadFolder,</span>
<a href="#l31.244"></a><span id="l31.244">                 nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aHdr,</span>
<a href="#l31.245"></a><span id="l31.245">                 nsIOutputStream *aOutputStream);</span>
<a href="#l31.246"></a><span id="l31.246"> </span>
<a href="#l31.247"></a><span id="l31.247" class="difflineminus">-  virtual void  DoneParsingFolder(nsresult status) override;</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineplus">+  virtual void DoneParsingFolder(nsresult status) override;</span>
<a href="#l31.249"></a><span id="l31.249"> </span>
<a href="#l31.250"></a><span id="l31.250" class="difflineminus">-  void DisableFilters() {m_disableFilters = true;}</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineplus">+  void DisableFilters() { m_disableFilters = true; }</span>
<a href="#l31.252"></a><span id="l31.252"> </span>
<a href="#l31.253"></a><span id="l31.253">   NS_DECL_NSIMSGFILTERHITNOTIFY</span>
<a href="#l31.254"></a><span id="l31.254"> </span>
<a href="#l31.255"></a><span id="l31.255">   nsOutputFileStream *GetLogFile();</span>
<a href="#l31.256"></a><span id="l31.256">   virtual int32_t PublishMsgHeader(nsIMsgWindow *msgWindow) override;</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineminus">-  void            GetMsgWindow(nsIMsgWindow **aMsgWindow);</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+  void GetMsgWindow(nsIMsgWindow **aMsgWindow);</span>
<a href="#l31.259"></a><span id="l31.259">   nsresult EndMsgDownload();</span>
<a href="#l31.260"></a><span id="l31.260"> </span>
<a href="#l31.261"></a><span id="l31.261">   nsresult AppendMsgFromStream(nsIInputStream *fileStream, nsIMsgDBHdr *aHdr,</span>
<a href="#l31.262"></a><span id="l31.262">                                uint32_t length, nsIMsgFolder *destFolder);</span>
<a href="#l31.263"></a><span id="l31.263"> </span>
<a href="#l31.264"></a><span id="l31.264">   virtual void ApplyFilters(bool *pMoved, nsIMsgWindow *msgWindow,</span>
<a href="#l31.265"></a><span id="l31.265">                             uint64_t msgOffset);</span>
<a href="#l31.266"></a><span id="l31.266" class="difflineminus">-  nsresult    ApplyForwardAndReplyFilter(nsIMsgWindow *msgWindow);</span>
<a href="#l31.267"></a><span id="l31.267" class="difflineplus">+  nsresult ApplyForwardAndReplyFilter(nsIMsgWindow *msgWindow);</span>
<a href="#l31.268"></a><span id="l31.268">   virtual void OnNewMessage(nsIMsgWindow *msgWindow) override;</span>
<a href="#l31.269"></a><span id="l31.269"> </span>
<a href="#l31.270"></a><span id="l31.270">   // this keeps track of how many messages we downloaded that</span>
<a href="#l31.271"></a><span id="l31.271">   // aren't new - e.g., marked read, or moved to an other server.</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineminus">-  int32_t     m_numNotNewMessages;</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineminus">-protected:</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineplus">+  int32_t m_numNotNewMessages;</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineplus">+</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+ protected:</span>
<a href="#l31.277"></a><span id="l31.277">   virtual ~nsParseNewMailState();</span>
<a href="#l31.278"></a><span id="l31.278">   virtual nsresult GetTrashFolder(nsIMsgFolder **pTrashFolder);</span>
<a href="#l31.279"></a><span id="l31.279">   virtual nsresult MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineminus">-                                          nsIMsgDatabase *sourceDB,</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineminus">-                                          nsIMsgFolder *destIFolder,</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineminus">-                                          nsIMsgFilter *filter,</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineminus">-                                          nsIMsgWindow *msgWindow);</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineminus">-  virtual void     MarkFilteredMessageRead(nsIMsgDBHdr *msgHdr);</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineminus">-  virtual void     MarkFilteredMessageUnread(nsIMsgDBHdr *msgHdr);</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineplus">+                                           nsIMsgDatabase *sourceDB,</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineplus">+                                           nsIMsgFolder *destIFolder,</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineplus">+                                           nsIMsgFilter *filter,</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineplus">+                                           nsIMsgWindow *msgWindow);</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineplus">+  virtual void MarkFilteredMessageRead(nsIMsgDBHdr *msgHdr);</span>
<a href="#l31.291"></a><span id="l31.291" class="difflineplus">+  virtual void MarkFilteredMessageUnread(nsIMsgDBHdr *msgHdr);</span>
<a href="#l31.292"></a><span id="l31.292"> </span>
<a href="#l31.293"></a><span id="l31.293" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; m_deferredToServerFilterList;</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_rootFolder;</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_downloadFolder;</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; m_deferredToServerFilterList;</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_rootFolder;</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_downloadFolder;</span>
<a href="#l31.303"></a><span id="l31.303">   nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l31.304"></a><span id="l31.304" class="difflineminus">-  nsCOMArray &lt;nsIMsgFolder&gt; m_filterTargetFolders;</span>
<a href="#l31.305"></a><span id="l31.305" class="difflineplus">+  nsCOMArray&lt;nsIMsgFolder&gt; m_filterTargetFolders;</span>
<a href="#l31.306"></a><span id="l31.306"> </span>
<a href="#l31.307"></a><span id="l31.307">   RefPtr&lt;nsImapMoveCoalescer&gt; m_moveCoalescer;</span>
<a href="#l31.308"></a><span id="l31.308"> </span>
<a href="#l31.309"></a><span id="l31.309" class="difflineminus">-  bool          m_msgMovedByFilter;</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineminus">-  bool          m_msgCopiedByFilter;</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineminus">-  bool          m_disableFilters;</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineminus">-  uint32_t      m_ibuffer_fp;</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineminus">-  char          *m_ibuffer;</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineminus">-  uint32_t      m_ibuffer_size;</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineplus">+  bool m_msgMovedByFilter;</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineplus">+  bool m_msgCopiedByFilter;</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineplus">+  bool m_disableFilters;</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineplus">+  uint32_t m_ibuffer_fp;</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineplus">+  char *m_ibuffer;</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineplus">+  uint32_t m_ibuffer_size;</span>
<a href="#l31.321"></a><span id="l31.321">   // used for applying move filters, because in the case of using a temporary</span>
<a href="#l31.322"></a><span id="l31.322">   // download file, the offset/key in the msg hdr is not right.</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineminus">-  uint64_t      m_curHdrOffset;</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineplus">+  uint64_t m_curHdrOffset;</span>
<a href="#l31.325"></a><span id="l31.325"> </span>
<a href="#l31.326"></a><span id="l31.326">   // we have to apply the reply/forward filters in a second pass, after</span>
<a href="#l31.327"></a><span id="l31.327">   // msg quarantining and moving to other local folders, so we remember the</span>
<a href="#l31.328"></a><span id="l31.328">   // info we'll need to apply them with these vars.</span>
<a href="#l31.329"></a><span id="l31.329">   // these need to be arrays in case we have multiple reply/forward filters.</span>
<a href="#l31.330"></a><span id="l31.330">   nsTArray&lt;nsCString&gt; m_forwardTo;</span>
<a href="#l31.331"></a><span id="l31.331">   nsTArray&lt;nsCString&gt; m_replyTemplateUri;</span>
<a href="#l31.332"></a><span id="l31.332">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_msgToForwardOrReply;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -23,714 +23,637 @@</span>
<a href="#l32.4"></a><span id="l32.4"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l32.5"></a><span id="l32.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l32.6"></a><span id="l32.6"> #include &quot;nsMsgDBFolder.h&quot;</span>
<a href="#l32.7"></a><span id="l32.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l32.8"></a><span id="l32.8"> #include &quot;mozilla/Likely.h&quot;</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> static NS_DEFINE_CID(kCPop3ServiceCID, NS_POP3SERVICE_CID);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-class nsPop3GetMailChainer final : public nsIUrlListener</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-{</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-public:</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+class nsPop3GetMailChainer final : public nsIUrlListener {</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ public:</span>
<a href="#l32.17"></a><span id="l32.17">   NS_DECL_ISUPPORTS</span>
<a href="#l32.18"></a><span id="l32.18">   NS_DECL_NSIURLLISTENER</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20">   nsPop3GetMailChainer();</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-  nsresult GetNewMailForServers(nsIPop3IncomingServer** servers, uint32_t count,</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+  nsresult GetNewMailForServers(nsIPop3IncomingServer **servers, uint32_t count,</span>
<a href="#l32.23"></a><span id="l32.23">                                 nsIMsgWindow *msgWindow,</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-                                nsIMsgFolder *folderToDownloadTo, nsIUrlListener *listener);</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+                                nsIMsgFolder *folderToDownloadTo,</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+                                nsIUrlListener *listener);</span>
<a href="#l32.27"></a><span id="l32.27">   nsresult RunNextGetNewMail();</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-protected:</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+ protected:</span>
<a href="#l32.31"></a><span id="l32.31">   ~nsPop3GetMailChainer();</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_folderToDownloadTo;</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; m_downloadingMsgWindow;</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folderToDownloadTo;</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_downloadingMsgWindow;</span>
<a href="#l32.36"></a><span id="l32.36">   nsCOMArray&lt;nsIPop3IncomingServer&gt; m_serversToGetNewMailFor;</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-  nsCOMPtr &lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l32.39"></a><span id="l32.39"> };</span>
<a href="#l32.40"></a><span id="l32.40"> </span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsPop3IncomingServer,</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-                             nsMsgIncomingServer,</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-                             nsIPop3IncomingServer,</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-                             nsILocalMailIncomingServer)</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsPop3IncomingServer, nsMsgIncomingServer,</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+                            nsIPop3IncomingServer, nsILocalMailIncomingServer)</span>
<a href="#l32.49"></a><span id="l32.49"> </span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-nsPop3IncomingServer::nsPop3IncomingServer()</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-{</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-  m_capabilityFlags =</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-  POP3_AUTH_MECH_UNDEFINED |</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-  POP3_HAS_AUTH_USER |               // should be always there</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-  POP3_GURL_UNDEFINED |</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-  POP3_UIDL_UNDEFINED |</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-  POP3_TOP_UNDEFINED |</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-  POP3_XTND_XLST_UNDEFINED;</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+nsPop3IncomingServer::nsPop3IncomingServer() {</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+  m_capabilityFlags = POP3_AUTH_MECH_UNDEFINED |</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+                      POP3_HAS_AUTH_USER |  // should be always there</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+                      POP3_GURL_UNDEFINED | POP3_UIDL_UNDEFINED |</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+                      POP3_TOP_UNDEFINED | POP3_XTND_XLST_UNDEFINED;</span>
<a href="#l32.64"></a><span id="l32.64"> </span>
<a href="#l32.65"></a><span id="l32.65">   m_canHaveFilters = true;</span>
<a href="#l32.66"></a><span id="l32.66">   m_authenticated = false;</span>
<a href="#l32.67"></a><span id="l32.67"> }</span>
<a href="#l32.68"></a><span id="l32.68"> </span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-nsPop3IncomingServer::~nsPop3IncomingServer()</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-{</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-}</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+nsPop3IncomingServer::~nsPop3IncomingServer() {}</span>
<a href="#l32.73"></a><span id="l32.73"> </span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-                        LeaveMessagesOnServer,</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer, LeaveMessagesOnServer,</span>
<a href="#l32.77"></a><span id="l32.77">                         &quot;leave_on_server&quot;)</span>
<a href="#l32.78"></a><span id="l32.78"> </span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-                        HeadersOnly,</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-                        &quot;headers_only&quot;)</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer, HeadersOnly, &quot;headers_only&quot;)</span>
<a href="#l32.83"></a><span id="l32.83"> </span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-                        DeleteMailLeftOnServer,</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer, DeleteMailLeftOnServer,</span>
<a href="#l32.87"></a><span id="l32.87">                         &quot;delete_mail_left_on_server&quot;)</span>
<a href="#l32.88"></a><span id="l32.88"> </span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-                        DotFix,</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-                        &quot;dot_fix&quot;)</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer, DotFix, &quot;dot_fix&quot;)</span>
<a href="#l32.93"></a><span id="l32.93"> </span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-                        DeleteByAgeFromServer,</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer, DeleteByAgeFromServer,</span>
<a href="#l32.97"></a><span id="l32.97">                         &quot;delete_by_age_from_server&quot;)</span>
<a href="#l32.98"></a><span id="l32.98"> </span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-NS_IMPL_SERVERPREF_INT(nsPop3IncomingServer,</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-                        NumDaysToLeaveOnServer,</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-                        &quot;num_days_to_leave_on_server&quot;)</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+NS_IMPL_SERVERPREF_INT(nsPop3IncomingServer, NumDaysToLeaveOnServer,</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+                       &quot;num_days_to_leave_on_server&quot;)</span>
<a href="#l32.105"></a><span id="l32.105"> </span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer,</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-                            DeferGetNewMail,</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-                            &quot;defer_get_new_mail&quot;)</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+NS_IMPL_SERVERPREF_BOOL(nsPop3IncomingServer, DeferGetNewMail,</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+                        &quot;defer_get_new_mail&quot;)</span>
<a href="#l32.111"></a><span id="l32.111"> </span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::GetDeferredToAccount(nsACString&amp; aRetVal)</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-{</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::GetDeferredToAccount(nsACString &amp;aRetVal) {</span>
<a href="#l32.115"></a><span id="l32.115">   nsresult rv = GetCharValue(&quot;deferred_to_account&quot;, aRetVal);</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-  if (aRetVal.IsEmpty())</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-    return rv;</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+  if (aRetVal.IsEmpty()) return rv;</span>
<a href="#l32.119"></a><span id="l32.119">   // We need to repair broken profiles that defer to hidden or invalid servers,</span>
<a href="#l32.120"></a><span id="l32.120">   // so find out if the deferred to account has a valid non-hidden server, and</span>
<a href="#l32.121"></a><span id="l32.121">   // if not, defer to the local folders inbox.</span>
<a href="#l32.122"></a><span id="l32.122">   nsCOMPtr&lt;nsIMsgAccountManager&gt; acctMgr =</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-                      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l32.125"></a><span id="l32.125">   bool invalidAccount = true;</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineminus">-  if (acctMgr)</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineminus">-  {</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+  if (acctMgr) {</span>
<a href="#l32.129"></a><span id="l32.129">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l32.130"></a><span id="l32.130">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.131"></a><span id="l32.131">     rv = acctMgr-&gt;GetAccount(aRetVal, getter_AddRefs(account));</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineminus">-    if (account)</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineminus">-    {</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+    if (account) {</span>
<a href="#l32.135"></a><span id="l32.135">       account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineminus">-      if (server)</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineminus">-        server-&gt;GetHidden(&amp;invalidAccount);</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+      if (server) server-&gt;GetHidden(&amp;invalidAccount);</span>
<a href="#l32.139"></a><span id="l32.139">     }</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-    if (invalidAccount)</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineminus">-    {</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+    if (invalidAccount) {</span>
<a href="#l32.143"></a><span id="l32.143">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; localServer;</span>
<a href="#l32.144"></a><span id="l32.144">       nsCOMPtr&lt;nsIMsgAccount&gt; localAccount;</span>
<a href="#l32.145"></a><span id="l32.145"> </span>
<a href="#l32.146"></a><span id="l32.146">       rv = acctMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localServer));</span>
<a href="#l32.147"></a><span id="l32.147">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.148"></a><span id="l32.148">       // Try to copy any folders that have been stranded in the hidden account</span>
<a href="#l32.149"></a><span id="l32.149">       // into the local folders account.</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineminus">-      if (server)</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineminus">-      {</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+      if (server) {</span>
<a href="#l32.153"></a><span id="l32.153">         nsCOMPtr&lt;nsIMsgFolder&gt; hiddenRootFolder;</span>
<a href="#l32.154"></a><span id="l32.154">         nsCOMPtr&lt;nsIMsgFolder&gt; localFoldersRoot;</span>
<a href="#l32.155"></a><span id="l32.155">         server-&gt;GetRootFolder(getter_AddRefs(hiddenRootFolder));</span>
<a href="#l32.156"></a><span id="l32.156">         localServer-&gt;GetRootFolder(getter_AddRefs(localFoldersRoot));</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineminus">-        if (hiddenRootFolder &amp;&amp; localFoldersRoot)</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineminus">-        {</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineplus">+        if (hiddenRootFolder &amp;&amp; localFoldersRoot) {</span>
<a href="#l32.160"></a><span id="l32.160">           // We're going to iterate over the folders in Local Folders-1,</span>
<a href="#l32.161"></a><span id="l32.161">           // though I suspect only the Inbox will have messages. I don't</span>
<a href="#l32.162"></a><span id="l32.162">           // think Sent Mail could end up here, but if any folders have</span>
<a href="#l32.163"></a><span id="l32.163">           // messages, might as well copy them to the real Local Folders</span>
<a href="#l32.164"></a><span id="l32.164">           // account.</span>
<a href="#l32.165"></a><span id="l32.165">           nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l32.166"></a><span id="l32.166">           rv = hiddenRootFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-          {</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.170"></a><span id="l32.170">             bool hasMore;</span>
<a href="#l32.171"></a><span id="l32.171">             while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineminus">-                   hasMore)</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-            {</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineplus">+                   hasMore) {</span>
<a href="#l32.175"></a><span id="l32.175">               nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l32.176"></a><span id="l32.176">               enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l32.177"></a><span id="l32.177">               nsCOMPtr&lt;nsIMsgFolder&gt; subFolder(do_QueryInterface(item));</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineminus">-              if (subFolder)</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-              {</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+              if (subFolder) {</span>
<a href="#l32.181"></a><span id="l32.181">                 nsCOMPtr&lt;nsIMsgDatabase&gt; subFolderDB;</span>
<a href="#l32.182"></a><span id="l32.182">                 subFolder-&gt;GetMsgDatabase(getter_AddRefs(subFolderDB));</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineminus">-                if (subFolderDB)</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineminus">-                {</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+                if (subFolderDB) {</span>
<a href="#l32.186"></a><span id="l32.186">                   // Copy any messages in this sub-folder of the hidden</span>
<a href="#l32.187"></a><span id="l32.187">                   // account to the corresponding folder in Local Folders.</span>
<a href="#l32.188"></a><span id="l32.188">                   RefPtr&lt;nsMsgKeyArray&gt; keys = new nsMsgKeyArray;</span>
<a href="#l32.189"></a><span id="l32.189">                   rv = subFolderDB-&gt;ListAllKeys(keys);</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineminus">-                  nsCOMPtr&lt;nsIMutableArray&gt; hdrsToCopy(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineplus">+                  nsCOMPtr&lt;nsIMutableArray&gt; hdrsToCopy(</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineplus">+                      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l32.193"></a><span id="l32.193">                   MsgGetHeadersFromKeys(subFolderDB, keys-&gt;m_keys, hdrsToCopy);</span>
<a href="#l32.194"></a><span id="l32.194">                   uint32_t numHdrs = 0;</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineminus">-                  if (hdrsToCopy)</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineminus">-                    hdrsToCopy-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineminus">-                  if (numHdrs)</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-                  {</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+                  if (hdrsToCopy) hdrsToCopy-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineplus">+                  if (numHdrs) {</span>
<a href="#l32.201"></a><span id="l32.201">                     // Look for a folder with the same name in Local Folders.</span>
<a href="#l32.202"></a><span id="l32.202">                     nsCOMPtr&lt;nsIMsgFolder&gt; dest;</span>
<a href="#l32.203"></a><span id="l32.203">                     nsString folderName;</span>
<a href="#l32.204"></a><span id="l32.204">                     subFolder-&gt;GetName(folderName);</span>
<a href="#l32.205"></a><span id="l32.205">                     localFoldersRoot-&gt;GetChildNamed(folderName,</span>
<a href="#l32.206"></a><span id="l32.206">                                                     getter_AddRefs(dest));</span>
<a href="#l32.207"></a><span id="l32.207">                     if (dest)</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineminus">-                      dest-&gt;CopyMessages(subFolder, hdrsToCopy, false,</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineminus">-                                         nullptr, nullptr, false,false);</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineplus">+                      dest-&gt;CopyMessages(subFolder, hdrsToCopy, false, nullptr,</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineplus">+                                         nullptr, false, false);</span>
<a href="#l32.212"></a><span id="l32.212">                     // Should we copy the folder if the dest doesn't exist?</span>
<a href="#l32.213"></a><span id="l32.213">                   }</span>
<a href="#l32.214"></a><span id="l32.214">                 }</span>
<a href="#l32.215"></a><span id="l32.215">               }</span>
<a href="#l32.216"></a><span id="l32.216">             }</span>
<a href="#l32.217"></a><span id="l32.217">           }</span>
<a href="#l32.218"></a><span id="l32.218">         }</span>
<a href="#l32.219"></a><span id="l32.219">       }</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineminus">-      rv = acctMgr-&gt;FindAccountForServer(localServer, getter_AddRefs(localAccount));</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineplus">+      rv = acctMgr-&gt;FindAccountForServer(localServer,</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineplus">+                                         getter_AddRefs(localAccount));</span>
<a href="#l32.223"></a><span id="l32.223">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineminus">-      if (!localAccount)</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineminus">-        return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineplus">+      if (!localAccount) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.227"></a><span id="l32.227"> </span>
<a href="#l32.228"></a><span id="l32.228">       localAccount-&gt;GetKey(aRetVal);</span>
<a href="#l32.229"></a><span id="l32.229">       // Can't call SetDeferredToAccount because it calls GetDeferredToAccount.</span>
<a href="#l32.230"></a><span id="l32.230">       return SetCharValue(&quot;deferred_to_account&quot;, aRetVal);</span>
<a href="#l32.231"></a><span id="l32.231">     }</span>
<a href="#l32.232"></a><span id="l32.232">   }</span>
<a href="#l32.233"></a><span id="l32.233">   return rv;</span>
<a href="#l32.234"></a><span id="l32.234"> }</span>
<a href="#l32.235"></a><span id="l32.235"> </span>
<a href="#l32.236"></a><span id="l32.236" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::SetDeferredToAccount(const nsACString&amp; aAccountKey)</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineminus">-{</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::SetDeferredToAccount(</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineplus">+    const nsACString &amp;aAccountKey) {</span>
<a href="#l32.240"></a><span id="l32.240">   nsCString deferredToAccount;</span>
<a href="#l32.241"></a><span id="l32.241">   GetDeferredToAccount(deferredToAccount);</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineminus">-  m_rootMsgFolder = nullptr; // clear this so we'll recalculate it on demand.</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineminus">-  //Notify listeners who listen to every folder</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineplus">+  m_rootMsgFolder = nullptr;  // clear this so we'll recalculate it on demand.</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineplus">+  // Notify listeners who listen to every folder</span>
<a href="#l32.246"></a><span id="l32.246"> </span>
<a href="#l32.247"></a><span id="l32.247" class="difflineminus">-  nsresult rv =  SetCharValue(&quot;deferred_to_account&quot;, aAccountKey);</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineplus">+  nsresult rv = SetCharValue(&quot;deferred_to_account&quot;, aAccountKey);</span>
<a href="#l32.249"></a><span id="l32.249">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.250"></a><span id="l32.250">   nsCOMPtr&lt;nsIFolderListener&gt; folderListenerManager =</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineminus">-  {</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineminus">-</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.257"></a><span id="l32.257">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l32.258"></a><span id="l32.258">     // use GetRootFolder, because that returns the real</span>
<a href="#l32.259"></a><span id="l32.259">     // root, not the deferred to root.</span>
<a href="#l32.260"></a><span id="l32.260">     rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineminus">-    if (rootFolder)</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineminus">-    {</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineplus">+    if (rootFolder) {</span>
<a href="#l32.264"></a><span id="l32.264">       // if isDeferred state has changed, send notification</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineminus">-      if (aAccountKey.IsEmpty() != deferredToAccount.IsEmpty())</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-      {</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-        folderListenerManager-&gt;OnItemBoolPropertyChanged(rootFolder, kIsDeferred,</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-                  !deferredToAccount.IsEmpty(), deferredToAccount.IsEmpty());</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineminus">-        folderListenerManager-&gt;OnItemBoolPropertyChanged(rootFolder, kCanFileMessages,</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineminus">-                  deferredToAccount.IsEmpty(), !deferredToAccount.IsEmpty());</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineplus">+      if (aAccountKey.IsEmpty() != deferredToAccount.IsEmpty()) {</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineplus">+        folderListenerManager-&gt;OnItemBoolPropertyChanged(</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineplus">+            rootFolder, kIsDeferred, !deferredToAccount.IsEmpty(),</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineplus">+            deferredToAccount.IsEmpty());</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineplus">+        folderListenerManager-&gt;OnItemBoolPropertyChanged(</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineplus">+            rootFolder, kCanFileMessages, deferredToAccount.IsEmpty(),</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineplus">+            !deferredToAccount.IsEmpty());</span>
<a href="#l32.278"></a><span id="l32.278"> </span>
<a href="#l32.279"></a><span id="l32.279">         // this hack causes the account manager ds to send notifications to the</span>
<a href="#l32.280"></a><span id="l32.280">         // xul content builder that make the changed acct appear or disappear</span>
<a href="#l32.281"></a><span id="l32.281">         // from the folder pane and related menus.</span>
<a href="#l32.282"></a><span id="l32.282">         nsCOMPtr&lt;nsIMsgAccountManager&gt; acctMgr =</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineminus">-                            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineminus">-        if (acctMgr)</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineminus">-        {</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineplus">+            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineplus">+        if (acctMgr) {</span>
<a href="#l32.288"></a><span id="l32.288">           acctMgr-&gt;NotifyServerUnloaded(this);</span>
<a href="#l32.289"></a><span id="l32.289">           acctMgr-&gt;NotifyServerLoaded(this);</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineminus">-          // check if this newly deferred to account is the local folders account</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineminus">-          // and needs to have a newly created INBOX.</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineminus">-          if (!aAccountKey.IsEmpty())</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineminus">-          {</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineminus">-            nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineplus">+          // check if this newly deferred to account is the local folders</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineplus">+          // account and needs to have a newly created INBOX.</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineplus">+          if (!aAccountKey.IsEmpty()) {</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineplus">+            nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l32.299"></a><span id="l32.299">             acctMgr-&gt;GetAccount(aAccountKey, getter_AddRefs(account));</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineminus">-            if (account)</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineminus">-            {</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineminus">-              nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineplus">+            if (account) {</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineplus">+              nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.305"></a><span id="l32.305">               account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineminus">-              if (server)</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineminus">-              {</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineminus">-                nsCOMPtr &lt;nsILocalMailIncomingServer&gt; incomingLocalServer = do_QueryInterface(server);</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineminus">-                if (incomingLocalServer)</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-                {</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineminus">-                  nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineplus">+              if (server) {</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineplus">+                nsCOMPtr&lt;nsILocalMailIncomingServer&gt; incomingLocalServer =</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineplus">+                    do_QueryInterface(server);</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineplus">+                if (incomingLocalServer) {</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineplus">+                  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l32.317"></a><span id="l32.317">                   rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l32.318"></a><span id="l32.318">                   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.319"></a><span id="l32.319">                   // this will fail if it already exists, which is fine.</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineminus">-                  rootFolder-&gt;CreateSubfolder(NS_LITERAL_STRING(&quot;Inbox&quot;), nullptr);</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineplus">+                  rootFolder-&gt;CreateSubfolder(NS_LITERAL_STRING(&quot;Inbox&quot;),</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineplus">+                                              nullptr);</span>
<a href="#l32.323"></a><span id="l32.323">                 }</span>
<a href="#l32.324"></a><span id="l32.324">               }</span>
<a href="#l32.325"></a><span id="l32.325">             }</span>
<a href="#l32.326"></a><span id="l32.326">           }</span>
<a href="#l32.327"></a><span id="l32.327">         }</span>
<a href="#l32.328"></a><span id="l32.328">       }</span>
<a href="#l32.329"></a><span id="l32.329">     }</span>
<a href="#l32.330"></a><span id="l32.330">   }</span>
<a href="#l32.331"></a><span id="l32.331">   return rv;</span>
<a href="#l32.332"></a><span id="l32.332"> }</span>
<a href="#l32.333"></a><span id="l32.333"> </span>
<a href="#l32.334"></a><span id="l32.334" class="difflineminus">-//NS_IMPL_GETSET(nsPop3IncomingServer, Authenticated, bool, m_authenticated);</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineplus">+// NS_IMPL_GETSET(nsPop3IncomingServer, Authenticated, bool, m_authenticated);</span>
<a href="#l32.336"></a><span id="l32.336"> </span>
<a href="#l32.337"></a><span id="l32.337" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::GetAuthenticated(bool *aAuthenticated)</span>
<a href="#l32.338"></a><span id="l32.338" class="difflineminus">-{</span>
<a href="#l32.339"></a><span id="l32.339" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::GetAuthenticated(bool *aAuthenticated) {</span>
<a href="#l32.340"></a><span id="l32.340">   NS_ENSURE_ARG_POINTER(aAuthenticated);</span>
<a href="#l32.341"></a><span id="l32.341">   *aAuthenticated = m_authenticated;</span>
<a href="#l32.342"></a><span id="l32.342">   return NS_OK;</span>
<a href="#l32.343"></a><span id="l32.343"> }</span>
<a href="#l32.344"></a><span id="l32.344"> </span>
<a href="#l32.345"></a><span id="l32.345" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::SetAuthenticated(bool aAuthenticated)</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-{</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::SetAuthenticated(bool aAuthenticated) {</span>
<a href="#l32.348"></a><span id="l32.348">   m_authenticated = aAuthenticated;</span>
<a href="#l32.349"></a><span id="l32.349">   return NS_OK;</span>
<a href="#l32.350"></a><span id="l32.350"> }</span>
<a href="#l32.351"></a><span id="l32.351"> </span>
<a href="#l32.352"></a><span id="l32.352" class="difflineminus">-nsresult</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineminus">-nsPop3IncomingServer::GetPop3CapabilityFlags(uint32_t *flags)</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineminus">-{</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineplus">+nsresult nsPop3IncomingServer::GetPop3CapabilityFlags(uint32_t *flags) {</span>
<a href="#l32.356"></a><span id="l32.356">   *flags = m_capabilityFlags;</span>
<a href="#l32.357"></a><span id="l32.357">   return NS_OK;</span>
<a href="#l32.358"></a><span id="l32.358"> }</span>
<a href="#l32.359"></a><span id="l32.359"> </span>
<a href="#l32.360"></a><span id="l32.360" class="difflineminus">-nsresult</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineminus">-nsPop3IncomingServer::SetPop3CapabilityFlags(uint32_t flags)</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineminus">-{</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineplus">+nsresult nsPop3IncomingServer::SetPop3CapabilityFlags(uint32_t flags) {</span>
<a href="#l32.364"></a><span id="l32.364">   m_capabilityFlags = flags;</span>
<a href="#l32.365"></a><span id="l32.365">   return NS_OK;</span>
<a href="#l32.366"></a><span id="l32.366"> }</span>
<a href="#l32.367"></a><span id="l32.367"> </span>
<a href="#l32.368"></a><span id="l32.368"> NS_IMETHODIMP</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineminus">-nsPop3IncomingServer::GetRootMsgFolder(nsIMsgFolder **aRootMsgFolder)</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineminus">-{</span>
<a href="#l32.371"></a><span id="l32.371" class="difflineplus">+nsPop3IncomingServer::GetRootMsgFolder(nsIMsgFolder **aRootMsgFolder) {</span>
<a href="#l32.372"></a><span id="l32.372">   NS_ENSURE_ARG_POINTER(aRootMsgFolder);</span>
<a href="#l32.373"></a><span id="l32.373">   nsresult rv = NS_OK;</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineminus">-  if (!m_rootMsgFolder)</span>
<a href="#l32.375"></a><span id="l32.375" class="difflineminus">-  {</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineplus">+  if (!m_rootMsgFolder) {</span>
<a href="#l32.377"></a><span id="l32.377">     nsCString deferredToAccount;</span>
<a href="#l32.378"></a><span id="l32.378">     GetDeferredToAccount(deferredToAccount);</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineminus">-    if (deferredToAccount.IsEmpty())</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineminus">-    {</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineplus">+    if (deferredToAccount.IsEmpty()) {</span>
<a href="#l32.382"></a><span id="l32.382">       rv = CreateRootFolder();</span>
<a href="#l32.383"></a><span id="l32.383">       m_rootMsgFolder = m_rootFolder;</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineminus">-    }</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineminus">-    else</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineminus">-    {</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineminus">-      nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.389"></a><span id="l32.389" class="difflineminus">-      nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineminus">-      rv = accountManager-&gt;GetAccount(deferredToAccount, getter_AddRefs(account));</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineminus">-      if (account)</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineminus">-      {</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineminus">-        nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineplus">+    } else {</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineplus">+      rv = accountManager-&gt;GetAccount(deferredToAccount,</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineplus">+                                      getter_AddRefs(account));</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineplus">+      if (account) {</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l32.405"></a><span id="l32.405">         rv = account-&gt;GetIncomingServer(getter_AddRefs(incomingServer));</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.408"></a><span id="l32.408">         // make sure we're not deferred to ourself...</span>
<a href="#l32.409"></a><span id="l32.409">         if (incomingServer &amp;&amp; incomingServer != this)</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineminus">-          rv = incomingServer-&gt;GetRootMsgFolder(getter_AddRefs(m_rootMsgFolder));</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineplus">+          rv =</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineplus">+              incomingServer-&gt;GetRootMsgFolder(getter_AddRefs(m_rootMsgFolder));</span>
<a href="#l32.413"></a><span id="l32.413">         else</span>
<a href="#l32.414"></a><span id="l32.414">           rv = NS_ERROR_FAILURE;</span>
<a href="#l32.415"></a><span id="l32.415">       }</span>
<a href="#l32.416"></a><span id="l32.416">     }</span>
<a href="#l32.417"></a><span id="l32.417">   }</span>
<a href="#l32.418"></a><span id="l32.418"> </span>
<a href="#l32.419"></a><span id="l32.419">   NS_IF_ADDREF(*aRootMsgFolder = m_rootMsgFolder);</span>
<a href="#l32.420"></a><span id="l32.420">   return m_rootMsgFolder ? rv : NS_ERROR_FAILURE;</span>
<a href="#l32.421"></a><span id="l32.421"> }</span>
<a href="#l32.422"></a><span id="l32.422"> </span>
<a href="#l32.423"></a><span id="l32.423" class="difflineminus">-nsresult nsPop3IncomingServer::GetInbox(nsIMsgWindow *msgWindow, nsIMsgFolder **inbox)</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineminus">-{</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineplus">+nsresult nsPop3IncomingServer::GetInbox(nsIMsgWindow *msgWindow,</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineplus">+                                        nsIMsgFolder **inbox) {</span>
<a href="#l32.427"></a><span id="l32.427">   NS_ENSURE_ARG_POINTER(inbox);</span>
<a href="#l32.428"></a><span id="l32.428">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l32.429"></a><span id="l32.429">   nsresult rv = GetRootMsgFolder(getter_AddRefs(rootFolder));</span>
<a href="#l32.430"></a><span id="l32.430" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l32.431"></a><span id="l32.431" class="difflineminus">-  {</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l32.433"></a><span id="l32.433">     rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox, inbox);</span>
<a href="#l32.434"></a><span id="l32.434">   }</span>
<a href="#l32.435"></a><span id="l32.435"> </span>
<a href="#l32.436"></a><span id="l32.436">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localInbox = do_QueryInterface(*inbox, &amp;rv);</span>
<a href="#l32.437"></a><span id="l32.437" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; localInbox)</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineminus">-  {</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; localInbox) {</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l32.442"></a><span id="l32.442">     rv = (*inbox)-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineminus">-    {</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l32.446"></a><span id="l32.446">       (*inbox)-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineminus">-      (void) localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineplus">+      (void)localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l32.449"></a><span id="l32.449">       // this will cause a reparse of the mail folder.</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineminus">-      localInbox-&gt;GetDatabaseWithReparse(nullptr, msgWindow, getter_AddRefs(db));</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineplus">+      localInbox-&gt;GetDatabaseWithReparse(nullptr, msgWindow,</span>
<a href="#l32.452"></a><span id="l32.452" class="difflineplus">+                                         getter_AddRefs(db));</span>
<a href="#l32.453"></a><span id="l32.453">       rv = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l32.454"></a><span id="l32.454">     }</span>
<a href="#l32.455"></a><span id="l32.455">   }</span>
<a href="#l32.456"></a><span id="l32.456">   return rv;</span>
<a href="#l32.457"></a><span id="l32.457"> }</span>
<a href="#l32.458"></a><span id="l32.458"> </span>
<a href="#l32.459"></a><span id="l32.459" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow)</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineminus">-{</span>
<a href="#l32.461"></a><span id="l32.461" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l32.462"></a><span id="l32.462">   nsresult rv;</span>
<a href="#l32.463"></a><span id="l32.463">   nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(kCPop3ServiceCID, &amp;rv));</span>
<a href="#l32.464"></a><span id="l32.464">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.465"></a><span id="l32.465"> </span>
<a href="#l32.466"></a><span id="l32.466">   nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l32.467"></a><span id="l32.467">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l32.468"></a><span id="l32.468">   nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l32.469"></a><span id="l32.469">   rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l32.470"></a><span id="l32.470">   NS_ENSURE_TRUE(rootMsgFolder, NS_ERROR_FAILURE);</span>
<a href="#l32.471"></a><span id="l32.471"> </span>
<a href="#l32.472"></a><span id="l32.472">   rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l32.473"></a><span id="l32.473">                                     getter_AddRefs(inbox));</span>
<a href="#l32.474"></a><span id="l32.474" class="difflineminus">-  if (!inbox)</span>
<a href="#l32.475"></a><span id="l32.475" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.476"></a><span id="l32.476" class="difflineplus">+  if (!inbox) return NS_ERROR_FAILURE;</span>
<a href="#l32.477"></a><span id="l32.477"> </span>
<a href="#l32.478"></a><span id="l32.478" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.479"></a><span id="l32.479" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.480"></a><span id="l32.480">   inbox-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l32.481"></a><span id="l32.481"> </span>
<a href="#l32.482"></a><span id="l32.482">   server-&gt;SetPerformingBiff(true);</span>
<a href="#l32.483"></a><span id="l32.483"> </span>
<a href="#l32.484"></a><span id="l32.484">   urlListener = do_QueryInterface(inbox);</span>
<a href="#l32.485"></a><span id="l32.485"> </span>
<a href="#l32.486"></a><span id="l32.486">   bool downloadOnBiff = false;</span>
<a href="#l32.487"></a><span id="l32.487">   rv = GetDownloadOnBiff(&amp;downloadOnBiff);</span>
<a href="#l32.488"></a><span id="l32.488" class="difflineminus">-  if (downloadOnBiff)</span>
<a href="#l32.489"></a><span id="l32.489" class="difflineminus">-  {</span>
<a href="#l32.490"></a><span id="l32.490" class="difflineminus">-    nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localInbox = do_QueryInterface(inbox, &amp;rv);</span>
<a href="#l32.491"></a><span id="l32.491" class="difflineminus">-    if (localInbox &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l32.492"></a><span id="l32.492" class="difflineminus">-    {</span>
<a href="#l32.493"></a><span id="l32.493" class="difflineplus">+  if (downloadOnBiff) {</span>
<a href="#l32.494"></a><span id="l32.494" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localInbox = do_QueryInterface(inbox, &amp;rv);</span>
<a href="#l32.495"></a><span id="l32.495" class="difflineplus">+    if (localInbox &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l32.496"></a><span id="l32.496">       bool valid = false;</span>
<a href="#l32.497"></a><span id="l32.497" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l32.498"></a><span id="l32.498" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l32.499"></a><span id="l32.499">       rv = inbox-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l32.500"></a><span id="l32.500" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; db)</span>
<a href="#l32.501"></a><span id="l32.501" class="difflineminus">-        rv = db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; db) rv = db-&gt;GetSummaryValid(&amp;valid);</span>
<a href="#l32.503"></a><span id="l32.503">       if (NS_SUCCEEDED(rv) &amp;&amp; valid)</span>
<a href="#l32.504"></a><span id="l32.504" class="difflineminus">-        rv = pop3Service-&gt;GetNewMail(aMsgWindow, urlListener, inbox, this, nullptr);</span>
<a href="#l32.505"></a><span id="l32.505" class="difflineminus">-      else</span>
<a href="#l32.506"></a><span id="l32.506" class="difflineminus">-      {</span>
<a href="#l32.507"></a><span id="l32.507" class="difflineplus">+        rv = pop3Service-&gt;GetNewMail(aMsgWindow, urlListener, inbox, this,</span>
<a href="#l32.508"></a><span id="l32.508" class="difflineplus">+                                     nullptr);</span>
<a href="#l32.509"></a><span id="l32.509" class="difflineplus">+      else {</span>
<a href="#l32.510"></a><span id="l32.510">         bool isLocked;</span>
<a href="#l32.511"></a><span id="l32.511">         inbox-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l32.512"></a><span id="l32.512">         if (!isLocked)</span>
<a href="#l32.513"></a><span id="l32.513" class="difflineminus">-          rv = localInbox-&gt;GetDatabaseWithReparse(urlListener, aMsgWindow, getter_AddRefs(db));</span>
<a href="#l32.514"></a><span id="l32.514" class="difflineplus">+          rv = localInbox-&gt;GetDatabaseWithReparse(urlListener, aMsgWindow,</span>
<a href="#l32.515"></a><span id="l32.515" class="difflineplus">+                                                  getter_AddRefs(db));</span>
<a href="#l32.516"></a><span id="l32.516">         if (NS_SUCCEEDED(rv))</span>
<a href="#l32.517"></a><span id="l32.517">           rv = localInbox-&gt;SetCheckForNewMessagesAfterParsing(true);</span>
<a href="#l32.518"></a><span id="l32.518">       }</span>
<a href="#l32.519"></a><span id="l32.519">     }</span>
<a href="#l32.520"></a><span id="l32.520" class="difflineminus">-  }</span>
<a href="#l32.521"></a><span id="l32.521" class="difflineminus">-  else</span>
<a href="#l32.522"></a><span id="l32.522" class="difflineminus">-    rv = pop3Service-&gt;CheckForNewMail(aMsgWindow, urlListener, inbox, this, nullptr);</span>
<a href="#l32.523"></a><span id="l32.523" class="difflineplus">+  } else</span>
<a href="#l32.524"></a><span id="l32.524" class="difflineplus">+    rv = pop3Service-&gt;CheckForNewMail(aMsgWindow, urlListener, inbox, this,</span>
<a href="#l32.525"></a><span id="l32.525" class="difflineplus">+                                      nullptr);</span>
<a href="#l32.526"></a><span id="l32.526">   return NS_OK;</span>
<a href="#l32.527"></a><span id="l32.527"> }</span>
<a href="#l32.528"></a><span id="l32.528"> </span>
<a href="#l32.529"></a><span id="l32.529"> NS_IMETHODIMP</span>
<a href="#l32.530"></a><span id="l32.530" class="difflineminus">-nsPop3IncomingServer::SetFlagsOnDefaultMailboxes()</span>
<a href="#l32.531"></a><span id="l32.531" class="difflineminus">-{</span>
<a href="#l32.532"></a><span id="l32.532" class="difflineplus">+nsPop3IncomingServer::SetFlagsOnDefaultMailboxes() {</span>
<a href="#l32.533"></a><span id="l32.533">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l32.534"></a><span id="l32.534">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l32.535"></a><span id="l32.535">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.536"></a><span id="l32.536"> </span>
<a href="#l32.537"></a><span id="l32.537" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l32.538"></a><span id="l32.538" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l32.539"></a><span id="l32.539" class="difflineplus">+      do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l32.540"></a><span id="l32.540">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.541"></a><span id="l32.541"> </span>
<a href="#l32.542"></a><span id="l32.542">   // pop3 gets an inbox, but no queue (unsent messages)</span>
<a href="#l32.543"></a><span id="l32.543">   localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::SpecialUse &amp;</span>
<a href="#l32.544"></a><span id="l32.544" class="difflineminus">-                                         ~nsMsgFolderFlags::Queue);</span>
<a href="#l32.545"></a><span id="l32.545" class="difflineplus">+                                          ~nsMsgFolderFlags::Queue);</span>
<a href="#l32.546"></a><span id="l32.546">   return NS_OK;</span>
<a href="#l32.547"></a><span id="l32.547"> }</span>
<a href="#l32.548"></a><span id="l32.548"> </span>
<a href="#l32.549"></a><span id="l32.549" class="difflineminus">-</span>
<a href="#l32.550"></a><span id="l32.550" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::CreateDefaultMailboxes()</span>
<a href="#l32.551"></a><span id="l32.551" class="difflineminus">-{</span>
<a href="#l32.552"></a><span id="l32.552" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l32.553"></a><span id="l32.553">   nsresult rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l32.554"></a><span id="l32.554">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.555"></a><span id="l32.555"> </span>
<a href="#l32.556"></a><span id="l32.556">   return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l32.557"></a><span id="l32.557"> }</span>
<a href="#l32.558"></a><span id="l32.558"> </span>
<a href="#l32.559"></a><span id="l32.559"> // override this so we can say that deferred accounts can't have messages</span>
<a href="#l32.560"></a><span id="l32.560"> // filed to them, which will remove them as targets of all the move/copy</span>
<a href="#l32.561"></a><span id="l32.561"> // menu items.</span>
<a href="#l32.562"></a><span id="l32.562"> NS_IMETHODIMP</span>
<a href="#l32.563"></a><span id="l32.563" class="difflineminus">-nsPop3IncomingServer::GetCanFileMessagesOnServer(bool *aCanFileMessagesOnServer)</span>
<a href="#l32.564"></a><span id="l32.564" class="difflineminus">-{</span>
<a href="#l32.565"></a><span id="l32.565" class="difflineplus">+nsPop3IncomingServer::GetCanFileMessagesOnServer(</span>
<a href="#l32.566"></a><span id="l32.566" class="difflineplus">+    bool *aCanFileMessagesOnServer) {</span>
<a href="#l32.567"></a><span id="l32.567">   NS_ENSURE_ARG_POINTER(aCanFileMessagesOnServer);</span>
<a href="#l32.568"></a><span id="l32.568"> </span>
<a href="#l32.569"></a><span id="l32.569">   nsCString deferredToAccount;</span>
<a href="#l32.570"></a><span id="l32.570">   GetDeferredToAccount(deferredToAccount);</span>
<a href="#l32.571"></a><span id="l32.571">   *aCanFileMessagesOnServer = deferredToAccount.IsEmpty();</span>
<a href="#l32.572"></a><span id="l32.572">   return NS_OK;</span>
<a href="#l32.573"></a><span id="l32.573"> }</span>
<a href="#l32.574"></a><span id="l32.574"> </span>
<a href="#l32.575"></a><span id="l32.575" class="difflineminus">-</span>
<a href="#l32.576"></a><span id="l32.576"> NS_IMETHODIMP</span>
<a href="#l32.577"></a><span id="l32.577" class="difflineminus">-nsPop3IncomingServer::GetCanCreateFoldersOnServer(bool *aCanCreateFoldersOnServer)</span>
<a href="#l32.578"></a><span id="l32.578" class="difflineminus">-{</span>
<a href="#l32.579"></a><span id="l32.579" class="difflineplus">+nsPop3IncomingServer::GetCanCreateFoldersOnServer(</span>
<a href="#l32.580"></a><span id="l32.580" class="difflineplus">+    bool *aCanCreateFoldersOnServer) {</span>
<a href="#l32.581"></a><span id="l32.581">   NS_ENSURE_ARG_POINTER(aCanCreateFoldersOnServer);</span>
<a href="#l32.582"></a><span id="l32.582"> </span>
<a href="#l32.583"></a><span id="l32.583">   nsCString deferredToAccount;</span>
<a href="#l32.584"></a><span id="l32.584">   GetDeferredToAccount(deferredToAccount);</span>
<a href="#l32.585"></a><span id="l32.585">   *aCanCreateFoldersOnServer = deferredToAccount.IsEmpty();</span>
<a href="#l32.586"></a><span id="l32.586">   return NS_OK;</span>
<a href="#l32.587"></a><span id="l32.587"> }</span>
<a href="#l32.588"></a><span id="l32.588"> </span>
<a href="#l32.589"></a><span id="l32.589"> NS_IMETHODIMP</span>
<a href="#l32.590"></a><span id="l32.590"> nsPop3IncomingServer::VerifyLogon(nsIUrlListener *aUrlListener,</span>
<a href="#l32.591"></a><span id="l32.591" class="difflineminus">-                                  nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l32.592"></a><span id="l32.592" class="difflineminus">-{</span>
<a href="#l32.593"></a><span id="l32.593" class="difflineplus">+                                  nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l32.594"></a><span id="l32.594">   nsresult rv;</span>
<a href="#l32.595"></a><span id="l32.595">   nsCOMPtr&lt;nsIPop3Service&gt; pop3Service = do_GetService(kCPop3ServiceCID, &amp;rv);</span>
<a href="#l32.596"></a><span id="l32.596" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.597"></a><span id="l32.597" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.598"></a><span id="l32.598">   return pop3Service-&gt;VerifyLogon(this, aUrlListener, aMsgWindow, aURL);</span>
<a href="#l32.599"></a><span id="l32.599"> }</span>
<a href="#l32.600"></a><span id="l32.600"> </span>
<a href="#l32.601"></a><span id="l32.601" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::DownloadMailFromServers(nsIPop3IncomingServer** aServers,</span>
<a href="#l32.602"></a><span id="l32.602" class="difflineminus">-                              uint32_t aCount,</span>
<a href="#l32.603"></a><span id="l32.603" class="difflineminus">-                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l32.604"></a><span id="l32.604" class="difflineminus">-                              nsIMsgFolder *aFolder,</span>
<a href="#l32.605"></a><span id="l32.605" class="difflineminus">-                              nsIUrlListener *aUrlListener)</span>
<a href="#l32.606"></a><span id="l32.606" class="difflineminus">-{</span>
<a href="#l32.607"></a><span id="l32.607" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::DownloadMailFromServers(</span>
<a href="#l32.608"></a><span id="l32.608" class="difflineplus">+    nsIPop3IncomingServer **aServers, uint32_t aCount, nsIMsgWindow *aMsgWindow,</span>
<a href="#l32.609"></a><span id="l32.609" class="difflineplus">+    nsIMsgFolder *aFolder, nsIUrlListener *aUrlListener) {</span>
<a href="#l32.610"></a><span id="l32.610">   RefPtr&lt;nsPop3GetMailChainer&gt; getMailChainer = new nsPop3GetMailChainer;</span>
<a href="#l32.611"></a><span id="l32.611" class="difflineminus">-  return getMailChainer-&gt;GetNewMailForServers(aServers, aCount, aMsgWindow, aFolder, aUrlListener);</span>
<a href="#l32.612"></a><span id="l32.612" class="difflineplus">+  return getMailChainer-&gt;GetNewMailForServers(aServers, aCount, aMsgWindow,</span>
<a href="#l32.613"></a><span id="l32.613" class="difflineplus">+                                              aFolder, aUrlListener);</span>
<a href="#l32.614"></a><span id="l32.614"> }</span>
<a href="#l32.615"></a><span id="l32.615"> </span>
<a href="#l32.616"></a><span id="l32.616"> NS_IMETHODIMP nsPop3IncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l32.617"></a><span id="l32.617">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l32.618"></a><span id="l32.618">                                                nsIMsgFolder *aInbox,</span>
<a href="#l32.619"></a><span id="l32.619" class="difflineminus">-                                               nsIURI **aResult)</span>
<a href="#l32.620"></a><span id="l32.620" class="difflineminus">-{</span>
<a href="#l32.621"></a><span id="l32.621" class="difflineplus">+                                               nsIURI **aResult) {</span>
<a href="#l32.622"></a><span id="l32.622">   nsresult rv;</span>
<a href="#l32.623"></a><span id="l32.623">   nsCOMPtr&lt;nsIPop3Service&gt; pop3Service = do_GetService(kCPop3ServiceCID, &amp;rv);</span>
<a href="#l32.624"></a><span id="l32.624" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.625"></a><span id="l32.625" class="difflineminus">-  return pop3Service-&gt;GetNewMail(aMsgWindow, aUrlListener, aInbox, this, aResult);</span>
<a href="#l32.626"></a><span id="l32.626" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.627"></a><span id="l32.627" class="difflineplus">+  return pop3Service-&gt;GetNewMail(aMsgWindow, aUrlListener, aInbox, this,</span>
<a href="#l32.628"></a><span id="l32.628" class="difflineplus">+                                 aResult);</span>
<a href="#l32.629"></a><span id="l32.629"> }</span>
<a href="#l32.630"></a><span id="l32.630"> </span>
<a href="#l32.631"></a><span id="l32.631" class="difflineminus">-// user has clicked get new messages on this server. If other servers defer to this server,</span>
<a href="#l32.632"></a><span id="l32.632" class="difflineminus">-// we need to get new mail for them. But if this server defers to an other server,</span>
<a href="#l32.633"></a><span id="l32.633" class="difflineminus">-// I think we only get new mail for this server.</span>
<a href="#l32.634"></a><span id="l32.634" class="difflineplus">+// user has clicked get new messages on this server. If other servers defer to</span>
<a href="#l32.635"></a><span id="l32.635" class="difflineplus">+// this server, we need to get new mail for them. But if this server defers to</span>
<a href="#l32.636"></a><span id="l32.636" class="difflineplus">+// an other server, I think we only get new mail for this server.</span>
<a href="#l32.637"></a><span id="l32.637"> NS_IMETHODIMP</span>
<a href="#l32.638"></a><span id="l32.638" class="difflineminus">-nsPop3IncomingServer::GetNewMessages(nsIMsgFolder *aFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l32.639"></a><span id="l32.639" class="difflineminus">-                      nsIUrlListener *aUrlListener)</span>
<a href="#l32.640"></a><span id="l32.640" class="difflineminus">-{</span>
<a href="#l32.641"></a><span id="l32.641" class="difflineplus">+nsPop3IncomingServer::GetNewMessages(nsIMsgFolder *aFolder,</span>
<a href="#l32.642"></a><span id="l32.642" class="difflineplus">+                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l32.643"></a><span id="l32.643" class="difflineplus">+                                     nsIUrlListener *aUrlListener) {</span>
<a href="#l32.644"></a><span id="l32.644">   nsresult rv;</span>
<a href="#l32.645"></a><span id="l32.645"> </span>
<a href="#l32.646"></a><span id="l32.646">   nsCOMPtr&lt;nsIPop3Service&gt; pop3Service = do_GetService(kCPop3ServiceCID, &amp;rv);</span>
<a href="#l32.647"></a><span id="l32.647" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.648"></a><span id="l32.648" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.649"></a><span id="l32.649"> </span>
<a href="#l32.650"></a><span id="l32.650" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l32.651"></a><span id="l32.651" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l32.652"></a><span id="l32.652">   rv = GetInbox(aMsgWindow, getter_AddRefs(inbox));</span>
<a href="#l32.653"></a><span id="l32.653">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.654"></a><span id="l32.654" class="difflineminus">-  nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l32.655"></a><span id="l32.655" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.656"></a><span id="l32.656" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l32.657"></a><span id="l32.657" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l32.658"></a><span id="l32.658">   nsCOMArray&lt;nsIPop3IncomingServer&gt; deferredServers;</span>
<a href="#l32.659"></a><span id="l32.659">   nsCString deferredToAccount;</span>
<a href="#l32.660"></a><span id="l32.660">   GetDeferredToAccount(deferredToAccount);</span>
<a href="#l32.661"></a><span id="l32.661"> </span>
<a href="#l32.662"></a><span id="l32.662" class="difflineminus">-  if (deferredToAccount.IsEmpty())</span>
<a href="#l32.663"></a><span id="l32.663" class="difflineminus">-  {</span>
<a href="#l32.664"></a><span id="l32.664" class="difflineplus">+  if (deferredToAccount.IsEmpty()) {</span>
<a href="#l32.665"></a><span id="l32.665">     aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l32.666"></a><span id="l32.666">     GetDeferredServers(server, deferredServers);</span>
<a href="#l32.667"></a><span id="l32.667">   }</span>
<a href="#l32.668"></a><span id="l32.668" class="difflineminus">-  if (deferredToAccount.IsEmpty() &amp;&amp; !deferredServers.IsEmpty())</span>
<a href="#l32.669"></a><span id="l32.669" class="difflineminus">-  {</span>
<a href="#l32.670"></a><span id="l32.670" class="difflineplus">+  if (deferredToAccount.IsEmpty() &amp;&amp; !deferredServers.IsEmpty()) {</span>
<a href="#l32.671"></a><span id="l32.671">     RefPtr&lt;nsPop3GetMailChainer&gt; getMailChainer = new nsPop3GetMailChainer;</span>
<a href="#l32.672"></a><span id="l32.672">     deferredServers.InsertElementAt(0, this);</span>
<a href="#l32.673"></a><span id="l32.673" class="difflineminus">-    return getMailChainer-&gt;GetNewMailForServers(deferredServers.Elements(),</span>
<a href="#l32.674"></a><span id="l32.674" class="difflineminus">-          deferredServers.Length(), aMsgWindow, inbox, aUrlListener);</span>
<a href="#l32.675"></a><span id="l32.675" class="difflineplus">+    return getMailChainer-&gt;GetNewMailForServers(</span>
<a href="#l32.676"></a><span id="l32.676" class="difflineplus">+        deferredServers.Elements(), deferredServers.Length(), aMsgWindow, inbox,</span>
<a href="#l32.677"></a><span id="l32.677" class="difflineplus">+        aUrlListener);</span>
<a href="#l32.678"></a><span id="l32.678">   }</span>
<a href="#l32.679"></a><span id="l32.679" class="difflineminus">-  if (m_runningProtocol)</span>
<a href="#l32.680"></a><span id="l32.680" class="difflineminus">-    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l32.681"></a><span id="l32.681" class="difflineplus">+  if (m_runningProtocol) return NS_MSG_FOLDER_BUSY;</span>
<a href="#l32.682"></a><span id="l32.682"> </span>
<a href="#l32.683"></a><span id="l32.683" class="difflineminus">-  return pop3Service-&gt;GetNewMail(aMsgWindow, aUrlListener, inbox, this, getter_AddRefs(url));</span>
<a href="#l32.684"></a><span id="l32.684" class="difflineplus">+  return pop3Service-&gt;GetNewMail(aMsgWindow, aUrlListener, inbox, this,</span>
<a href="#l32.685"></a><span id="l32.685" class="difflineplus">+                                 getter_AddRefs(url));</span>
<a href="#l32.686"></a><span id="l32.686"> }</span>
<a href="#l32.687"></a><span id="l32.687"> </span>
<a href="#l32.688"></a><span id="l32.688"> NS_IMETHODIMP</span>
<a href="#l32.689"></a><span id="l32.689" class="difflineminus">-nsPop3IncomingServer::GetDownloadMessagesAtStartup(bool *getMessagesAtStartup)</span>
<a href="#l32.690"></a><span id="l32.690" class="difflineminus">-{</span>
<a href="#l32.691"></a><span id="l32.691" class="difflineplus">+nsPop3IncomingServer::GetDownloadMessagesAtStartup(bool *getMessagesAtStartup) {</span>
<a href="#l32.692"></a><span id="l32.692">   NS_ENSURE_ARG_POINTER(getMessagesAtStartup);</span>
<a href="#l32.693"></a><span id="l32.693">   // GetMessages is not automatically done for pop servers at startup.</span>
<a href="#l32.694"></a><span id="l32.694">   // We need to trigger that action. Return true.</span>
<a href="#l32.695"></a><span id="l32.695">   *getMessagesAtStartup = true;</span>
<a href="#l32.696"></a><span id="l32.696">   return NS_OK;</span>
<a href="#l32.697"></a><span id="l32.697"> }</span>
<a href="#l32.698"></a><span id="l32.698"> </span>
<a href="#l32.699"></a><span id="l32.699"> NS_IMETHODIMP</span>
<a href="#l32.700"></a><span id="l32.700" class="difflineminus">-nsPop3IncomingServer::GetCanBeDefaultServer(bool *canBeDefaultServer)</span>
<a href="#l32.701"></a><span id="l32.701" class="difflineminus">-{</span>
<a href="#l32.702"></a><span id="l32.702" class="difflineplus">+nsPop3IncomingServer::GetCanBeDefaultServer(bool *canBeDefaultServer) {</span>
<a href="#l32.703"></a><span id="l32.703">   NS_ENSURE_ARG_POINTER(canBeDefaultServer);</span>
<a href="#l32.704"></a><span id="l32.704">   *canBeDefaultServer = true;</span>
<a href="#l32.705"></a><span id="l32.705">   return NS_OK;</span>
<a href="#l32.706"></a><span id="l32.706"> }</span>
<a href="#l32.707"></a><span id="l32.707"> </span>
<a href="#l32.708"></a><span id="l32.708"> NS_IMETHODIMP</span>
<a href="#l32.709"></a><span id="l32.709" class="difflineminus">-nsPop3IncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l32.710"></a><span id="l32.710" class="difflineminus">-{</span>
<a href="#l32.711"></a><span id="l32.711" class="difflineplus">+nsPop3IncomingServer::GetCanSearchMessages(bool *canSearchMessages) {</span>
<a href="#l32.712"></a><span id="l32.712">   // this will return false if this server is deferred, which is what we want.</span>
<a href="#l32.713"></a><span id="l32.713">   return GetCanFileMessagesOnServer(canSearchMessages);</span>
<a href="#l32.714"></a><span id="l32.714"> }</span>
<a href="#l32.715"></a><span id="l32.715"> </span>
<a href="#l32.716"></a><span id="l32.716"> NS_IMETHODIMP</span>
<a href="#l32.717"></a><span id="l32.717" class="difflineminus">-nsPop3IncomingServer::CloseCachedConnections()</span>
<a href="#l32.718"></a><span id="l32.718" class="difflineminus">-{</span>
<a href="#l32.719"></a><span id="l32.719" class="difflineplus">+nsPop3IncomingServer::CloseCachedConnections() {</span>
<a href="#l32.720"></a><span id="l32.720">   nsCOMPtr&lt;nsIRequest&gt; channel = do_QueryInterface(m_runningProtocol);</span>
<a href="#l32.721"></a><span id="l32.721" class="difflineminus">-  if (channel)</span>
<a href="#l32.722"></a><span id="l32.722" class="difflineminus">-    channel-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l32.723"></a><span id="l32.723" class="difflineplus">+  if (channel) channel-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l32.724"></a><span id="l32.724">   return NS_OK;</span>
<a href="#l32.725"></a><span id="l32.725"> }</span>
<a href="#l32.726"></a><span id="l32.726"> </span>
<a href="#l32.727"></a><span id="l32.727"> NS_IMETHODIMP</span>
<a href="#l32.728"></a><span id="l32.728" class="difflineminus">-nsPop3IncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel)</span>
<a href="#l32.729"></a><span id="l32.729" class="difflineminus">-{</span>
<a href="#l32.730"></a><span id="l32.730" class="difflineplus">+nsPop3IncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel) {</span>
<a href="#l32.731"></a><span id="l32.731">   NS_ENSURE_ARG_POINTER(aSupportLevel);</span>
<a href="#l32.732"></a><span id="l32.732"> </span>
<a href="#l32.733"></a><span id="l32.733">   nsresult rv;</span>
<a href="#l32.734"></a><span id="l32.734">   rv = GetIntValue(&quot;offline_support_level&quot;, aSupportLevel);</span>
<a href="#l32.735"></a><span id="l32.735">   if (*aSupportLevel != OFFLINE_SUPPORT_LEVEL_UNDEFINED) return rv;</span>
<a href="#l32.736"></a><span id="l32.736"> </span>
<a href="#l32.737"></a><span id="l32.737">   // set default value</span>
<a href="#l32.738"></a><span id="l32.738">   *aSupportLevel = OFFLINE_SUPPORT_LEVEL_NONE;</span>
<a href="#l32.739"></a><span id="l32.739">   return NS_OK;</span>
<a href="#l32.740"></a><span id="l32.740"> }</span>
<a href="#l32.741"></a><span id="l32.741"> </span>
<a href="#l32.742"></a><span id="l32.742"> NS_IMETHODIMP</span>
<a href="#l32.743"></a><span id="l32.743" class="difflineminus">-nsPop3IncomingServer::SetRunningProtocol(nsIPop3Protocol *aProtocol)</span>
<a href="#l32.744"></a><span id="l32.744" class="difflineminus">-{</span>
<a href="#l32.745"></a><span id="l32.745" class="difflineplus">+nsPop3IncomingServer::SetRunningProtocol(nsIPop3Protocol *aProtocol) {</span>
<a href="#l32.746"></a><span id="l32.746">   NS_ASSERTION(!aProtocol || !m_runningProtocol, &quot;overriding running protocol&quot;);</span>
<a href="#l32.747"></a><span id="l32.747">   m_runningProtocol = aProtocol;</span>
<a href="#l32.748"></a><span id="l32.748">   return NS_OK;</span>
<a href="#l32.749"></a><span id="l32.749"> }</span>
<a href="#l32.750"></a><span id="l32.750"> </span>
<a href="#l32.751"></a><span id="l32.751" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::GetRunningProtocol(nsIPop3Protocol **aProtocol)</span>
<a href="#l32.752"></a><span id="l32.752" class="difflineminus">-{</span>
<a href="#l32.753"></a><span id="l32.753" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::GetRunningProtocol(</span>
<a href="#l32.754"></a><span id="l32.754" class="difflineplus">+    nsIPop3Protocol **aProtocol) {</span>
<a href="#l32.755"></a><span id="l32.755">   NS_ENSURE_ARG_POINTER(aProtocol);</span>
<a href="#l32.756"></a><span id="l32.756">   NS_IF_ADDREF(*aProtocol = m_runningProtocol);</span>
<a href="#l32.757"></a><span id="l32.757">   return NS_OK;</span>
<a href="#l32.758"></a><span id="l32.758"> }</span>
<a href="#l32.759"></a><span id="l32.759"> </span>
<a href="#l32.760"></a><span id="l32.760" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::AddUidlToMark(const char *aUidl, int32_t aMark)</span>
<a href="#l32.761"></a><span id="l32.761" class="difflineminus">-{</span>
<a href="#l32.762"></a><span id="l32.762" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::AddUidlToMark(const char *aUidl,</span>
<a href="#l32.763"></a><span id="l32.763" class="difflineplus">+                                                  int32_t aMark) {</span>
<a href="#l32.764"></a><span id="l32.764">   NS_ENSURE_ARG_POINTER(aUidl);</span>
<a href="#l32.765"></a><span id="l32.765"> </span>
<a href="#l32.766"></a><span id="l32.766">   Pop3UidlEntry *uidlEntry = PR_NEWZAP(Pop3UidlEntry);</span>
<a href="#l32.767"></a><span id="l32.767">   NS_ENSURE_TRUE(uidlEntry, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l32.768"></a><span id="l32.768"> </span>
<a href="#l32.769"></a><span id="l32.769">   uidlEntry-&gt;uidl = strdup(aUidl);</span>
<a href="#l32.770"></a><span id="l32.770">   if (MOZ_UNLIKELY(!uidlEntry-&gt;uidl)) {</span>
<a href="#l32.771"></a><span id="l32.771">     PR_Free(uidlEntry);</span>
<a href="#l32.772"></a><span id="l32.772">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.773"></a><span id="l32.773">   }</span>
<a href="#l32.774"></a><span id="l32.774"> </span>
<a href="#l32.775"></a><span id="l32.775" class="difflineminus">-  uidlEntry-&gt;status = (aMark == POP3_DELETE) ? DELETE_CHAR :</span>
<a href="#l32.776"></a><span id="l32.776" class="difflineminus">-                      (aMark == POP3_FETCH_BODY) ? FETCH_BODY : KEEP;</span>
<a href="#l32.777"></a><span id="l32.777" class="difflineplus">+  uidlEntry-&gt;status = (aMark == POP3_DELETE)</span>
<a href="#l32.778"></a><span id="l32.778" class="difflineplus">+                          ? DELETE_CHAR</span>
<a href="#l32.779"></a><span id="l32.779" class="difflineplus">+                          : (aMark == POP3_FETCH_BODY) ? FETCH_BODY : KEEP;</span>
<a href="#l32.780"></a><span id="l32.780">   m_uidlsToMark.AppendElement(uidlEntry);</span>
<a href="#l32.781"></a><span id="l32.781">   return NS_OK;</span>
<a href="#l32.782"></a><span id="l32.782"> }</span>
<a href="#l32.783"></a><span id="l32.783"> </span>
<a href="#l32.784"></a><span id="l32.784" class="difflineminus">-NS_IMETHODIMP nsPop3IncomingServer::MarkMessages()</span>
<a href="#l32.785"></a><span id="l32.785" class="difflineminus">-{</span>
<a href="#l32.786"></a><span id="l32.786" class="difflineplus">+NS_IMETHODIMP nsPop3IncomingServer::MarkMessages() {</span>
<a href="#l32.787"></a><span id="l32.787">   nsresult rv;</span>
<a href="#l32.788"></a><span id="l32.788">   if (m_runningProtocol)</span>
<a href="#l32.789"></a><span id="l32.789">     rv = m_runningProtocol-&gt;MarkMessages(&amp;m_uidlsToMark);</span>
<a href="#l32.790"></a><span id="l32.790" class="difflineminus">-  else</span>
<a href="#l32.791"></a><span id="l32.791" class="difflineminus">-  {</span>
<a href="#l32.792"></a><span id="l32.792" class="difflineplus">+  else {</span>
<a href="#l32.793"></a><span id="l32.793">     nsCString hostName;</span>
<a href="#l32.794"></a><span id="l32.794">     nsCString userName;</span>
<a href="#l32.795"></a><span id="l32.795">     nsCOMPtr&lt;nsIFile&gt; localPath;</span>
<a href="#l32.796"></a><span id="l32.796"> </span>
<a href="#l32.797"></a><span id="l32.797">     GetLocalPath(getter_AddRefs(localPath));</span>
<a href="#l32.798"></a><span id="l32.798"> </span>
<a href="#l32.799"></a><span id="l32.799">     GetHostName(hostName);</span>
<a href="#l32.800"></a><span id="l32.800">     GetUsername(userName);</span>
<a href="#l32.801"></a><span id="l32.801">     // do it all in one fell swoop</span>
<a href="#l32.802"></a><span id="l32.802" class="difflineminus">-    rv = nsPop3Protocol::MarkMsgForHost(hostName.get(), userName.get(), localPath, m_uidlsToMark);</span>
<a href="#l32.803"></a><span id="l32.803" class="difflineplus">+    rv = nsPop3Protocol::MarkMsgForHost(hostName.get(), userName.get(),</span>
<a href="#l32.804"></a><span id="l32.804" class="difflineplus">+                                        localPath, m_uidlsToMark);</span>
<a href="#l32.805"></a><span id="l32.805">   }</span>
<a href="#l32.806"></a><span id="l32.806">   uint32_t count = m_uidlsToMark.Length();</span>
<a href="#l32.807"></a><span id="l32.807" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l32.808"></a><span id="l32.808" class="difflineminus">-  {</span>
<a href="#l32.809"></a><span id="l32.809" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l32.810"></a><span id="l32.810">     Pop3UidlEntry *ue = m_uidlsToMark[i];</span>
<a href="#l32.811"></a><span id="l32.811">     PR_Free(ue-&gt;uidl);</span>
<a href="#l32.812"></a><span id="l32.812">     PR_Free(ue);</span>
<a href="#l32.813"></a><span id="l32.813">   }</span>
<a href="#l32.814"></a><span id="l32.814">   m_uidlsToMark.Clear();</span>
<a href="#l32.815"></a><span id="l32.815">   return rv;</span>
<a href="#l32.816"></a><span id="l32.816"> }</span>
<a href="#l32.817"></a><span id="l32.817"> </span>
<a href="#l32.818"></a><span id="l32.818"> NS_IMPL_ISUPPORTS(nsPop3GetMailChainer, nsIUrlListener)</span>
<a href="#l32.819"></a><span id="l32.819"> </span>
<a href="#l32.820"></a><span id="l32.820" class="difflineminus">-nsPop3GetMailChainer::nsPop3GetMailChainer()</span>
<a href="#l32.821"></a><span id="l32.821" class="difflineminus">-{</span>
<a href="#l32.822"></a><span id="l32.822" class="difflineminus">-}</span>
<a href="#l32.823"></a><span id="l32.823" class="difflineminus">-nsPop3GetMailChainer::~nsPop3GetMailChainer()</span>
<a href="#l32.824"></a><span id="l32.824" class="difflineminus">-{</span>
<a href="#l32.825"></a><span id="l32.825" class="difflineminus">-}</span>
<a href="#l32.826"></a><span id="l32.826" class="difflineplus">+nsPop3GetMailChainer::nsPop3GetMailChainer() {}</span>
<a href="#l32.827"></a><span id="l32.827" class="difflineplus">+nsPop3GetMailChainer::~nsPop3GetMailChainer() {}</span>
<a href="#l32.828"></a><span id="l32.828"> </span>
<a href="#l32.829"></a><span id="l32.829" class="difflineminus">-nsresult nsPop3GetMailChainer::GetNewMailForServers(nsIPop3IncomingServer** servers,</span>
<a href="#l32.830"></a><span id="l32.830" class="difflineminus">-                                uint32_t count, nsIMsgWindow *msgWindow,</span>
<a href="#l32.831"></a><span id="l32.831" class="difflineminus">-                                nsIMsgFolder *folderToDownloadTo, nsIUrlListener *listener)</span>
<a href="#l32.832"></a><span id="l32.832" class="difflineminus">-{</span>
<a href="#l32.833"></a><span id="l32.833" class="difflineplus">+nsresult nsPop3GetMailChainer::GetNewMailForServers(</span>
<a href="#l32.834"></a><span id="l32.834" class="difflineplus">+    nsIPop3IncomingServer **servers, uint32_t count, nsIMsgWindow *msgWindow,</span>
<a href="#l32.835"></a><span id="l32.835" class="difflineplus">+    nsIMsgFolder *folderToDownloadTo, nsIUrlListener *listener) {</span>
<a href="#l32.836"></a><span id="l32.836">   NS_ENSURE_ARG_POINTER(folderToDownloadTo);</span>
<a href="#l32.837"></a><span id="l32.837"> </span>
<a href="#l32.838"></a><span id="l32.838">   m_serversToGetNewMailFor.AppendElements(servers, count);</span>
<a href="#l32.839"></a><span id="l32.839">   m_folderToDownloadTo = folderToDownloadTo;</span>
<a href="#l32.840"></a><span id="l32.840">   m_downloadingMsgWindow = msgWindow;</span>
<a href="#l32.841"></a><span id="l32.841">   m_listener = listener;</span>
<a href="#l32.842"></a><span id="l32.842" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; destFolderDB;</span>
<a href="#l32.843"></a><span id="l32.843" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; destFolderDB;</span>
<a href="#l32.844"></a><span id="l32.844"> </span>
<a href="#l32.845"></a><span id="l32.845" class="difflineminus">-  nsresult rv = folderToDownloadTo-&gt;GetMsgDatabase(getter_AddRefs(destFolderDB));</span>
<a href="#l32.846"></a><span id="l32.846" class="difflineminus">-  if (NS_FAILED(rv) || !destFolderDB)</span>
<a href="#l32.847"></a><span id="l32.847" class="difflineminus">-  {</span>
<a href="#l32.848"></a><span id="l32.848" class="difflineminus">-    nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folderToDownloadTo);</span>
<a href="#l32.849"></a><span id="l32.849" class="difflineminus">-    if (localFolder)</span>
<a href="#l32.850"></a><span id="l32.850" class="difflineminus">-    {</span>
<a href="#l32.851"></a><span id="l32.851" class="difflineminus">-      localFolder-&gt;GetDatabaseWithReparse(this, msgWindow, getter_AddRefs(destFolderDB));</span>
<a href="#l32.852"></a><span id="l32.852" class="difflineplus">+  nsresult rv =</span>
<a href="#l32.853"></a><span id="l32.853" class="difflineplus">+      folderToDownloadTo-&gt;GetMsgDatabase(getter_AddRefs(destFolderDB));</span>
<a href="#l32.854"></a><span id="l32.854" class="difflineplus">+  if (NS_FAILED(rv) || !destFolderDB) {</span>
<a href="#l32.855"></a><span id="l32.855" class="difflineplus">+    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l32.856"></a><span id="l32.856" class="difflineplus">+        do_QueryInterface(folderToDownloadTo);</span>
<a href="#l32.857"></a><span id="l32.857" class="difflineplus">+    if (localFolder) {</span>
<a href="#l32.858"></a><span id="l32.858" class="difflineplus">+      localFolder-&gt;GetDatabaseWithReparse(this, msgWindow,</span>
<a href="#l32.859"></a><span id="l32.859" class="difflineplus">+                                          getter_AddRefs(destFolderDB));</span>
<a href="#l32.860"></a><span id="l32.860">       return NS_OK;</span>
<a href="#l32.861"></a><span id="l32.861">     }</span>
<a href="#l32.862"></a><span id="l32.862">   }</span>
<a href="#l32.863"></a><span id="l32.863">   return RunNextGetNewMail();</span>
<a href="#l32.864"></a><span id="l32.864"> }</span>
<a href="#l32.865"></a><span id="l32.865"> </span>
<a href="#l32.866"></a><span id="l32.866"> NS_IMETHODIMP</span>
<a href="#l32.867"></a><span id="l32.867" class="difflineminus">-nsPop3GetMailChainer::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l32.868"></a><span id="l32.868" class="difflineminus">-{</span>
<a href="#l32.869"></a><span id="l32.869" class="difflineminus">-  return NS_OK;</span>
<a href="#l32.870"></a><span id="l32.870" class="difflineminus">-}</span>
<a href="#l32.871"></a><span id="l32.871" class="difflineplus">+nsPop3GetMailChainer::OnStartRunningUrl(nsIURI *url) { return NS_OK; }</span>
<a href="#l32.872"></a><span id="l32.872"> </span>
<a href="#l32.873"></a><span id="l32.873"> NS_IMETHODIMP</span>
<a href="#l32.874"></a><span id="l32.874" class="difflineminus">-nsPop3GetMailChainer::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l32.875"></a><span id="l32.875" class="difflineminus">-{</span>
<a href="#l32.876"></a><span id="l32.876" class="difflineplus">+nsPop3GetMailChainer::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l32.877"></a><span id="l32.877">   return RunNextGetNewMail();</span>
<a href="#l32.878"></a><span id="l32.878"> }</span>
<a href="#l32.879"></a><span id="l32.879"> </span>
<a href="#l32.880"></a><span id="l32.880" class="difflineminus">-nsresult nsPop3GetMailChainer::RunNextGetNewMail()</span>
<a href="#l32.881"></a><span id="l32.881" class="difflineminus">-{</span>
<a href="#l32.882"></a><span id="l32.882" class="difflineplus">+nsresult nsPop3GetMailChainer::RunNextGetNewMail() {</span>
<a href="#l32.883"></a><span id="l32.883">   nsresult rv;</span>
<a href="#l32.884"></a><span id="l32.884">   uint32_t numServersLeft = m_serversToGetNewMailFor.Count();</span>
<a href="#l32.885"></a><span id="l32.885"> </span>
<a href="#l32.886"></a><span id="l32.886" class="difflineminus">-  for (; numServersLeft &gt; 0;)</span>
<a href="#l32.887"></a><span id="l32.887" class="difflineminus">-  {</span>
<a href="#l32.888"></a><span id="l32.888" class="difflineplus">+  for (; numServersLeft &gt; 0;) {</span>
<a href="#l32.889"></a><span id="l32.889">     nsCOMPtr&lt;nsIPop3IncomingServer&gt; popServer(m_serversToGetNewMailFor[0]);</span>
<a href="#l32.890"></a><span id="l32.890">     m_serversToGetNewMailFor.RemoveObjectAt(0);</span>
<a href="#l32.891"></a><span id="l32.891">     numServersLeft--;</span>
<a href="#l32.892"></a><span id="l32.892" class="difflineminus">-    if (popServer)</span>
<a href="#l32.893"></a><span id="l32.893" class="difflineminus">-    {</span>
<a href="#l32.894"></a><span id="l32.894" class="difflineplus">+    if (popServer) {</span>
<a href="#l32.895"></a><span id="l32.895">       bool deferGetNewMail = false;</span>
<a href="#l32.896"></a><span id="l32.896" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; downloadingToServer;</span>
<a href="#l32.897"></a><span id="l32.897" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; downloadingToServer;</span>
<a href="#l32.898"></a><span id="l32.898">       m_folderToDownloadTo-&gt;GetServer(getter_AddRefs(downloadingToServer));</span>
<a href="#l32.899"></a><span id="l32.899">       popServer-&gt;GetDeferGetNewMail(&amp;deferGetNewMail);</span>
<a href="#l32.900"></a><span id="l32.900">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(popServer);</span>
<a href="#l32.901"></a><span id="l32.901">       nsCOMPtr&lt;nsIPop3Protocol&gt; protocol;</span>
<a href="#l32.902"></a><span id="l32.902">       popServer-&gt;GetRunningProtocol(getter_AddRefs(protocol));</span>
<a href="#l32.903"></a><span id="l32.903" class="difflineminus">-      if ((deferGetNewMail || downloadingToServer == server) &amp;&amp; !protocol)</span>
<a href="#l32.904"></a><span id="l32.904" class="difflineminus">-      {</span>
<a href="#l32.905"></a><span id="l32.905" class="difflineplus">+      if ((deferGetNewMail || downloadingToServer == server) &amp;&amp; !protocol) {</span>
<a href="#l32.906"></a><span id="l32.906">         // have to call routine that just gets mail for one server,</span>
<a href="#l32.907"></a><span id="l32.907">         // and ignores deferred servers...</span>
<a href="#l32.908"></a><span id="l32.908" class="difflineminus">-        if (server)</span>
<a href="#l32.909"></a><span id="l32.909" class="difflineminus">-        {</span>
<a href="#l32.910"></a><span id="l32.910" class="difflineminus">-          nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l32.911"></a><span id="l32.911" class="difflineminus">-          nsCOMPtr&lt;nsIPop3Service&gt; pop3Service = do_GetService(kCPop3ServiceCID, &amp;rv);</span>
<a href="#l32.912"></a><span id="l32.912" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l32.913"></a><span id="l32.913" class="difflineminus">-          return pop3Service-&gt;GetNewMail(m_downloadingMsgWindow, this, m_folderToDownloadTo, popServer, getter_AddRefs(url));</span>
<a href="#l32.914"></a><span id="l32.914" class="difflineplus">+        if (server) {</span>
<a href="#l32.915"></a><span id="l32.915" class="difflineplus">+          nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l32.916"></a><span id="l32.916" class="difflineplus">+          nsCOMPtr&lt;nsIPop3Service&gt; pop3Service =</span>
<a href="#l32.917"></a><span id="l32.917" class="difflineplus">+              do_GetService(kCPop3ServiceCID, &amp;rv);</span>
<a href="#l32.918"></a><span id="l32.918" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.919"></a><span id="l32.919" class="difflineplus">+          return pop3Service-&gt;GetNewMail(m_downloadingMsgWindow, this,</span>
<a href="#l32.920"></a><span id="l32.920" class="difflineplus">+                                         m_folderToDownloadTo, popServer,</span>
<a href="#l32.921"></a><span id="l32.921" class="difflineplus">+                                         getter_AddRefs(url));</span>
<a href="#l32.922"></a><span id="l32.922">         }</span>
<a href="#l32.923"></a><span id="l32.923">       }</span>
<a href="#l32.924"></a><span id="l32.924">     }</span>
<a href="#l32.925"></a><span id="l32.925">   }</span>
<a href="#l32.926"></a><span id="l32.926">   rv = m_listener ? m_listener-&gt;OnStopRunningUrl(nullptr, NS_OK) : NS_OK;</span>
<a href="#l32.927"></a><span id="l32.927">   return rv;</span>
<a href="#l32.928"></a><span id="l32.928"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -18,42 +18,44 @@</span>
<a href="#l33.4"></a><span id="l33.4"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6"> /* get some implementation from nsMsgIncomingServer */</span>
<a href="#l33.7"></a><span id="l33.7"> class nsPop3IncomingServer : public nsMailboxServer,</span>
<a href="#l33.8"></a><span id="l33.8">                              public nsIPop3IncomingServer,</span>
<a href="#l33.9"></a><span id="l33.9">                              public nsILocalMailIncomingServer</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> {</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-public:</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ public:</span>
<a href="#l33.14"></a><span id="l33.14">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l33.15"></a><span id="l33.15">   NS_DECL_NSIPOP3INCOMINGSERVER</span>
<a href="#l33.16"></a><span id="l33.16">   NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l33.17"></a><span id="l33.17"> </span>
<a href="#l33.18"></a><span id="l33.18">   nsPop3IncomingServer();</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20">   NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l33.21"></a><span id="l33.21">   NS_IMETHOD GetDownloadMessagesAtStartup(bool *getMessages) override;</span>
<a href="#l33.22"></a><span id="l33.22">   NS_IMETHOD GetCanBeDefaultServer(bool *canBeDefaultServer) override;</span>
<a href="#l33.23"></a><span id="l33.23">   NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l33.24"></a><span id="l33.24">   NS_IMETHOD GetOfflineSupportLevel(int32_t *aSupportLevel) override;</span>
<a href="#l33.25"></a><span id="l33.25">   NS_IMETHOD CloseCachedConnections() override;</span>
<a href="#l33.26"></a><span id="l33.26">   NS_IMETHOD GetRootMsgFolder(nsIMsgFolder **aRootMsgFolder) override;</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-  NS_IMETHOD GetCanFileMessagesOnServer(bool *aCanFileMessagesOnServer) override;</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-  NS_IMETHOD GetCanCreateFoldersOnServer(bool *aCanCreateFoldersOnServer) override;</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+  NS_IMETHOD GetCanFileMessagesOnServer(</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+      bool *aCanFileMessagesOnServer) override;</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+  NS_IMETHOD GetCanCreateFoldersOnServer(</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+      bool *aCanCreateFoldersOnServer) override;</span>
<a href="#l33.33"></a><span id="l33.33">   NS_IMETHOD VerifyLogon(nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow,</span>
<a href="#l33.34"></a><span id="l33.34">                          nsIURI **aURL) override;</span>
<a href="#l33.35"></a><span id="l33.35">   NS_IMETHOD GetNewMessages(nsIMsgFolder *aFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l33.36"></a><span id="l33.36">                             nsIUrlListener *aUrlListener) override;</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-protected:</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+ protected:</span>
<a href="#l33.40"></a><span id="l33.40">   virtual ~nsPop3IncomingServer();</span>
<a href="#l33.41"></a><span id="l33.41">   nsresult GetInbox(nsIMsgWindow *msgWindow, nsIMsgFolder **inbox);</span>
<a href="#l33.42"></a><span id="l33.42"> </span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-private:</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+ private:</span>
<a href="#l33.45"></a><span id="l33.45">   uint32_t m_capabilityFlags;</span>
<a href="#l33.46"></a><span id="l33.46">   bool m_authenticated;</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-  nsCOMPtr &lt;nsIPop3Protocol&gt; m_runningProtocol;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_rootMsgFolder;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-  nsTArray&lt;Pop3UidlEntry*&gt; m_uidlsToMark;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Protocol&gt; m_runningProtocol;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_rootMsgFolder;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+  nsTArray&lt;Pop3UidlEntry *&gt; m_uidlsToMark;</span>
<a href="#l33.53"></a><span id="l33.53"> };</span>
<a href="#l33.54"></a><span id="l33.54"> </span>
<a href="#l33.55"></a><span id="l33.55"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,42 +1,43 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l34.5"></a><span id="l34.5">  *</span>
<a href="#l34.6"></a><span id="l34.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.7"></a><span id="l34.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.8"></a><span id="l34.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l34.9"></a><span id="l34.9">  *</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l34.17"></a><span id="l34.17">  *</span>
<a href="#l34.18"></a><span id="l34.18">  * Jason Eager &lt;jce2@po.cwru.edu&gt;</span>
<a href="#l34.19"></a><span id="l34.19">  *</span>
<a href="#l34.20"></a><span id="l34.20">  * Date             Modified by     Description of modification</span>
<a href="#l34.21"></a><span id="l34.21">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l34.22"></a><span id="l34.22">  * 06/07/2000       Jason Eager    Added check for out of disk space</span>
<a href="#l34.23"></a><span id="l34.23">  */</span>
<a href="#l34.24"></a><span id="l34.24"> </span>
<a href="#l34.25"></a><span id="l34.25"> #include &quot;nscore.h&quot;</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l34.28"></a><span id="l34.28"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l34.29"></a><span id="l34.29"> #include &quot;nspr.h&quot;</span>
<a href="#l34.30"></a><span id="l34.30"> #include &quot;plbase64.h&quot;</span>
<a href="#l34.31"></a><span id="l34.31"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l34.32"></a><span id="l34.32"> #include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l34.33"></a><span id="l34.33"> #include &quot;nsPop3Protocol.h&quot;</span>
<a href="#l34.34"></a><span id="l34.34"> #include &quot;nsIPop3URL.h&quot;</span>
<a href="#l34.35"></a><span id="l34.35"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l34.36"></a><span id="l34.36"> #include &quot;nsString.h&quot;</span>
<a href="#l34.37"></a><span id="l34.37"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l34.38"></a><span id="l34.38"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l34.39"></a><span id="l34.39"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l34.40"></a><span id="l34.40"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l34.41"></a><span id="l34.41"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot; // TO include biffState enum. Change to bool later...</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;  // TO include biffState enum. Change to bool later...</span>
<a href="#l34.44"></a><span id="l34.44"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l34.45"></a><span id="l34.45"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l34.46"></a><span id="l34.46"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l34.47"></a><span id="l34.47"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l34.48"></a><span id="l34.48"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l34.49"></a><span id="l34.49"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l34.50"></a><span id="l34.50"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l34.51"></a><span id="l34.51"> #include &quot;nsICancelable.h&quot;</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineat">@@ -49,432 +50,360 @@</span>
<a href="#l34.53"></a><span id="l34.53"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l34.54"></a><span id="l34.54"> #include &quot;mozilla/Preferences.h&quot;</span>
<a href="#l34.55"></a><span id="l34.55"> </span>
<a href="#l34.56"></a><span id="l34.56"> using namespace mozilla;</span>
<a href="#l34.57"></a><span id="l34.57"> </span>
<a href="#l34.58"></a><span id="l34.58"> LazyLogModule POP3LOGMODULE(&quot;POP3&quot;);</span>
<a href="#l34.59"></a><span id="l34.59"> #define POP3LOG(str) &quot;[this=%p] &quot; str, this</span>
<a href="#l34.60"></a><span id="l34.60"> </span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-static int</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-net_pop3_remove_messages_marked_delete(PLHashEntry* he,</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-                                       int msgindex,</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-                                       void *arg)</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-{</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineminus">-  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-  return (uidlEntry-&gt;status == DELETE_CHAR)</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-    ? HT_ENUMERATE_REMOVE : HT_ENUMERATE_NEXT;</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+static int net_pop3_remove_messages_marked_delete(PLHashEntry *he, int msgindex,</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+                                                  void *arg) {</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)he-&gt;value;</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+  return (uidlEntry-&gt;status == DELETE_CHAR) ? HT_ENUMERATE_REMOVE</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+                                            : HT_ENUMERATE_NEXT;</span>
<a href="#l34.74"></a><span id="l34.74"> }</span>
<a href="#l34.75"></a><span id="l34.75"> </span>
<a href="#l34.76"></a><span id="l34.76" class="difflineminus">-uint32_t TimeInSecondsFromPRTime(PRTime prTime)</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-{</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+uint32_t TimeInSecondsFromPRTime(PRTime prTime) {</span>
<a href="#l34.79"></a><span id="l34.79">   return (uint32_t)(prTime / PR_USEC_PER_SEC);</span>
<a href="#l34.80"></a><span id="l34.80"> }</span>
<a href="#l34.81"></a><span id="l34.81"> </span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-static void</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-put_hash(PLHashTable* table, const char* key, char value, uint32_t dateReceived)</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-{</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+static void put_hash(PLHashTable *table, const char *key, char value,</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+                     uint32_t dateReceived) {</span>
<a href="#l34.87"></a><span id="l34.87">   // don't put not used slots or empty uid into hash</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineminus">-  if (key &amp;&amp; *key)</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-  {</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineminus">-    Pop3UidlEntry* tmp = PR_NEWZAP(Pop3UidlEntry);</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-    if (tmp)</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineminus">-    {</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+  if (key &amp;&amp; *key) {</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+    Pop3UidlEntry *tmp = PR_NEWZAP(Pop3UidlEntry);</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+    if (tmp) {</span>
<a href="#l34.96"></a><span id="l34.96">       tmp-&gt;uidl = PL_strdup(key);</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-      if (tmp-&gt;uidl)</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-      {</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+      if (tmp-&gt;uidl) {</span>
<a href="#l34.100"></a><span id="l34.100">         tmp-&gt;dateReceived = dateReceived;</span>
<a href="#l34.101"></a><span id="l34.101">         tmp-&gt;status = value;</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-        PL_HashTableAdd(table, (const void *)tmp-&gt;uidl, (void*) tmp);</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineminus">-      }</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineminus">-      else</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+        PL_HashTableAdd(table, (const void *)tmp-&gt;uidl, (void *)tmp);</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+      } else</span>
<a href="#l34.107"></a><span id="l34.107">         PR_Free(tmp);</span>
<a href="#l34.108"></a><span id="l34.108">     }</span>
<a href="#l34.109"></a><span id="l34.109">   }</span>
<a href="#l34.110"></a><span id="l34.110"> }</span>
<a href="#l34.111"></a><span id="l34.111"> </span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-static int</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-net_pop3_copy_hash_entries(PLHashEntry* he, int msgindex, void *arg)</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-{</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-  put_hash((PLHashTable *) arg, uidlEntry-&gt;uidl, uidlEntry-&gt;status, uidlEntry-&gt;dateReceived);</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+static int net_pop3_copy_hash_entries(PLHashEntry *he, int msgindex,</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+                                      void *arg) {</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)he-&gt;value;</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+  put_hash((PLHashTable *)arg, uidlEntry-&gt;uidl, uidlEntry-&gt;status,</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+           uidlEntry-&gt;dateReceived);</span>
<a href="#l34.122"></a><span id="l34.122">   return HT_ENUMERATE_NEXT;</span>
<a href="#l34.123"></a><span id="l34.123"> }</span>
<a href="#l34.124"></a><span id="l34.124"> </span>
<a href="#l34.125"></a><span id="l34.125" class="difflineminus">-static void *</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-AllocUidlTable(void * /* pool */, size_t size)</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineminus">-{</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineplus">+static void *AllocUidlTable(void * /* pool */, size_t size) {</span>
<a href="#l34.129"></a><span id="l34.129">   return PR_MALLOC(size);</span>
<a href="#l34.130"></a><span id="l34.130"> }</span>
<a href="#l34.131"></a><span id="l34.131"> </span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-static void</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-FreeUidlTable(void * /* pool */, void *item)</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-{</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineminus">-    PR_Free(item);</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineplus">+static void FreeUidlTable(void * /* pool */, void *item) { PR_Free(item); }</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineplus">+static PLHashEntry *AllocUidlInfo(void *pool, const void *key) {</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineplus">+  return PR_NEWZAP(PLHashEntry);</span>
<a href="#l34.140"></a><span id="l34.140"> }</span>
<a href="#l34.141"></a><span id="l34.141"> </span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-static PLHashEntry *</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineminus">-AllocUidlInfo(void *pool, const void *key)</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineminus">-{</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-    return PR_NEWZAP(PLHashEntry);</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineminus">-}</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineminus">-</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-static void</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-FreeUidlInfo(void * /* pool */, PLHashEntry *he, unsigned flag)</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-{</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-  if (flag == HT_FREE_ENTRY)</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-  {</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-    Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-    if (uidlEntry)</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-    {</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineplus">+static void FreeUidlInfo(void * /* pool */, PLHashEntry *he, unsigned flag) {</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineplus">+  if (flag == HT_FREE_ENTRY) {</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+    Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)he-&gt;value;</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineplus">+    if (uidlEntry) {</span>
<a href="#l34.160"></a><span id="l34.160">       PR_Free(uidlEntry-&gt;uidl);</span>
<a href="#l34.161"></a><span id="l34.161">       PR_Free(uidlEntry);</span>
<a href="#l34.162"></a><span id="l34.162">     }</span>
<a href="#l34.163"></a><span id="l34.163">     PR_Free(he);</span>
<a href="#l34.164"></a><span id="l34.164">   }</span>
<a href="#l34.165"></a><span id="l34.165"> }</span>
<a href="#l34.166"></a><span id="l34.166"> </span>
<a href="#l34.167"></a><span id="l34.167" class="difflineminus">-static PLHashAllocOps gHashAllocOps = {</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineminus">-    AllocUidlTable, FreeUidlTable,</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineminus">-    AllocUidlInfo, FreeUidlInfo</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineminus">-};</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineminus">-</span>
<a href="#l34.173"></a><span id="l34.173" class="difflineminus">-static Pop3UidlHost*</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineminus">-net_pop3_load_state(const char* searchhost,</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-                    const char* searchuser,</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-                    nsIFile *mailDirectory)</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineminus">-{</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineminus">-  Pop3UidlHost* result = nullptr;</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineminus">-  Pop3UidlHost* current = nullptr;</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineminus">-  Pop3UidlHost* tmp;</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineplus">+static PLHashAllocOps gHashAllocOps = {AllocUidlTable, FreeUidlTable,</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineplus">+                                       AllocUidlInfo, FreeUidlInfo};</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineplus">+</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineplus">+static Pop3UidlHost *net_pop3_load_state(const char *searchhost,</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineplus">+                                         const char *searchuser,</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineplus">+                                         nsIFile *mailDirectory) {</span>
<a href="#l34.187"></a><span id="l34.187" class="difflineplus">+  Pop3UidlHost *result = nullptr;</span>
<a href="#l34.188"></a><span id="l34.188" class="difflineplus">+  Pop3UidlHost *current = nullptr;</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineplus">+  Pop3UidlHost *tmp;</span>
<a href="#l34.190"></a><span id="l34.190"> </span>
<a href="#l34.191"></a><span id="l34.191">   result = PR_NEWZAP(Pop3UidlHost);</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-  if (!result)</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-    return nullptr;</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineplus">+  if (!result) return nullptr;</span>
<a href="#l34.195"></a><span id="l34.195">   result-&gt;host = PL_strdup(searchhost);</span>
<a href="#l34.196"></a><span id="l34.196">   result-&gt;user = PL_strdup(searchuser);</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineminus">-  result-&gt;hash = PL_NewHashTable(20, PL_HashString, PL_CompareStrings, PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-  if (!result-&gt;host || !result-&gt;user || !result-&gt;hash)</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-  {</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineplus">+  result-&gt;hash = PL_NewHashTable(20, PL_HashString, PL_CompareStrings,</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineplus">+                                 PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineplus">+</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineplus">+  if (!result-&gt;host || !result-&gt;user || !result-&gt;hash) {</span>
<a href="#l34.205"></a><span id="l34.205">     PR_Free(result-&gt;host);</span>
<a href="#l34.206"></a><span id="l34.206">     PR_Free(result-&gt;user);</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineminus">-    if (result-&gt;hash)</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineminus">-      PL_HashTableDestroy(result-&gt;hash);</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineplus">+    if (result-&gt;hash) PL_HashTableDestroy(result-&gt;hash);</span>
<a href="#l34.210"></a><span id="l34.210">     PR_Free(result);</span>
<a href="#l34.211"></a><span id="l34.211">     return nullptr;</span>
<a href="#l34.212"></a><span id="l34.212">   }</span>
<a href="#l34.213"></a><span id="l34.213"> </span>
<a href="#l34.214"></a><span id="l34.214">   nsCOMPtr&lt;nsIFile&gt; popState;</span>
<a href="#l34.215"></a><span id="l34.215">   mailDirectory-&gt;Clone(getter_AddRefs(popState));</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-  if (!popState)</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-    return nullptr;</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineplus">+  if (!popState) return nullptr;</span>
<a href="#l34.219"></a><span id="l34.219">   popState-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;popstate.dat&quot;));</span>
<a href="#l34.220"></a><span id="l34.220"> </span>
<a href="#l34.221"></a><span id="l34.221">   nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(fileStream), popState);</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineplus">+  nsresult rv =</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineplus">+      NS_NewLocalFileInputStream(getter_AddRefs(fileStream), popState);</span>
<a href="#l34.225"></a><span id="l34.225">   // It is OK if the file doesn't exist. No state is stored yet.</span>
<a href="#l34.226"></a><span id="l34.226">   // Return empty list without warning.</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineminus">-  if (rv == NS_ERROR_FILE_NOT_FOUND)</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineminus">-    return result;</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineplus">+  if (rv == NS_ERROR_FILE_NOT_FOUND) return result;</span>
<a href="#l34.230"></a><span id="l34.230">   // Warn for other errors.</span>
<a href="#l34.231"></a><span id="l34.231">   NS_ENSURE_SUCCESS(rv, result);</span>
<a href="#l34.232"></a><span id="l34.232"> </span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineplus">+  nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+      do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l34.236"></a><span id="l34.236">   NS_ENSURE_SUCCESS(rv, result);</span>
<a href="#l34.237"></a><span id="l34.237"> </span>
<a href="#l34.238"></a><span id="l34.238">   bool more = true;</span>
<a href="#l34.239"></a><span id="l34.239">   nsCString line;</span>
<a href="#l34.240"></a><span id="l34.240"> </span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-  while (more &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-  {</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineplus">+  while (more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l34.244"></a><span id="l34.244">     lineInputStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineminus">-    if (line.IsEmpty())</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineminus">-      continue;</span>
<a href="#l34.247"></a><span id="l34.247" class="difflineplus">+    if (line.IsEmpty()) continue;</span>
<a href="#l34.248"></a><span id="l34.248">     char firstChar = line.CharAt(0);</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineminus">-    if (firstChar == '#')</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineminus">-      continue;</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineplus">+    if (firstChar == '#') continue;</span>
<a href="#l34.252"></a><span id="l34.252">     if (firstChar == '*') {</span>
<a href="#l34.253"></a><span id="l34.253">       /* It's a host&amp;user line. */</span>
<a href="#l34.254"></a><span id="l34.254">       current = nullptr;</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-      char *lineBuf = line.BeginWriting() + 1; // ok because we know the line isn't empty</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineplus">+      char *lineBuf =</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineplus">+          line.BeginWriting() + 1;  // ok because we know the line isn't empty</span>
<a href="#l34.258"></a><span id="l34.258">       char *host = NS_strtok(&quot; \t\r\n&quot;, &amp;lineBuf);</span>
<a href="#l34.259"></a><span id="l34.259">       /* without space to also get realnames - see bug 225332 */</span>
<a href="#l34.260"></a><span id="l34.260">       char *user = NS_strtok(&quot;\t\r\n&quot;, &amp;lineBuf);</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineminus">-      if (!host || !user)</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineminus">-        continue;</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-      for (tmp = result ; tmp ; tmp = tmp-&gt;next)</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineminus">-      {</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineminus">-        if (!strcmp(host, tmp-&gt;host) &amp;&amp; !strcmp(user, tmp-&gt;user))</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineminus">-        {</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineplus">+      if (!host || !user) continue;</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineplus">+      for (tmp = result; tmp; tmp = tmp-&gt;next) {</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineplus">+        if (!strcmp(host, tmp-&gt;host) &amp;&amp; !strcmp(user, tmp-&gt;user)) {</span>
<a href="#l34.270"></a><span id="l34.270">           current = tmp;</span>
<a href="#l34.271"></a><span id="l34.271">           break;</span>
<a href="#l34.272"></a><span id="l34.272">         }</span>
<a href="#l34.273"></a><span id="l34.273">       }</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-      if (!current)</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineminus">-      {</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineplus">+      if (!current) {</span>
<a href="#l34.277"></a><span id="l34.277">         current = PR_NEWZAP(Pop3UidlHost);</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineminus">-        if (current)</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineminus">-        {</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineplus">+        if (current) {</span>
<a href="#l34.281"></a><span id="l34.281">           current-&gt;host = strdup(host);</span>
<a href="#l34.282"></a><span id="l34.282">           current-&gt;user = strdup(user);</span>
<a href="#l34.283"></a><span id="l34.283" class="difflineminus">-          current-&gt;hash = PL_NewHashTable(20, PL_HashString, PL_CompareStrings, PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineminus">-          if (!current-&gt;host || !current-&gt;user || !current-&gt;hash)</span>
<a href="#l34.285"></a><span id="l34.285" class="difflineminus">-          {</span>
<a href="#l34.286"></a><span id="l34.286" class="difflineplus">+          current-&gt;hash =</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineplus">+              PL_NewHashTable(20, PL_HashString, PL_CompareStrings,</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineplus">+                              PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineplus">+          if (!current-&gt;host || !current-&gt;user || !current-&gt;hash) {</span>
<a href="#l34.290"></a><span id="l34.290">             PR_Free(current-&gt;host);</span>
<a href="#l34.291"></a><span id="l34.291">             PR_Free(current-&gt;user);</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineminus">-            if (current-&gt;hash)</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineminus">-              PL_HashTableDestroy(current-&gt;hash);</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineplus">+            if (current-&gt;hash) PL_HashTableDestroy(current-&gt;hash);</span>
<a href="#l34.295"></a><span id="l34.295">             PR_Free(current);</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineminus">-          }</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineminus">-          else</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineminus">-          {</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineplus">+          } else {</span>
<a href="#l34.300"></a><span id="l34.300">             current-&gt;next = result-&gt;next;</span>
<a href="#l34.301"></a><span id="l34.301">             result-&gt;next = current;</span>
<a href="#l34.302"></a><span id="l34.302">           }</span>
<a href="#l34.303"></a><span id="l34.303">         }</span>
<a href="#l34.304"></a><span id="l34.304">       }</span>
<a href="#l34.305"></a><span id="l34.305" class="difflineminus">-    }</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineminus">-    else</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineminus">-    {</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineplus">+    } else {</span>
<a href="#l34.309"></a><span id="l34.309">       /* It's a line with a UIDL on it. */</span>
<a href="#l34.310"></a><span id="l34.310" class="difflineminus">-      if (current)</span>
<a href="#l34.311"></a><span id="l34.311" class="difflineminus">-      {</span>
<a href="#l34.312"></a><span id="l34.312" class="difflineminus">-        for (int32_t pos = line.FindChar('\t'); pos != -1; pos = line.FindChar('\t', pos))</span>
<a href="#l34.313"></a><span id="l34.313" class="difflineplus">+      if (current) {</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineplus">+        for (int32_t pos = line.FindChar('\t'); pos != -1;</span>
<a href="#l34.315"></a><span id="l34.315" class="difflineplus">+             pos = line.FindChar('\t', pos))</span>
<a href="#l34.316"></a><span id="l34.316">           line.Replace(pos, 1, ' ');</span>
<a href="#l34.317"></a><span id="l34.317"> </span>
<a href="#l34.318"></a><span id="l34.318">         nsTArray&lt;nsCString&gt; lineElems;</span>
<a href="#l34.319"></a><span id="l34.319">         ParseString(line, ' ', lineElems);</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineminus">-        if (lineElems.Length() &lt; 2)</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineminus">-          continue;</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineplus">+        if (lineElems.Length() &lt; 2) continue;</span>
<a href="#l34.323"></a><span id="l34.323">         nsCString *flags = &amp;lineElems[0];</span>
<a href="#l34.324"></a><span id="l34.324">         nsCString *uidl = &amp;lineElems[1];</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineminus">-        uint32_t dateReceived = TimeInSecondsFromPRTime(PR_Now()); // if we don't find a date str, assume now.</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineminus">-        if (lineElems.Length() &gt; 2)</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineminus">-          dateReceived = atoi(lineElems[2].get());</span>
<a href="#l34.328"></a><span id="l34.328" class="difflineminus">-        if (!flags-&gt;IsEmpty() &amp;&amp; !uidl-&gt;IsEmpty())</span>
<a href="#l34.329"></a><span id="l34.329" class="difflineminus">-        {</span>
<a href="#l34.330"></a><span id="l34.330" class="difflineplus">+        uint32_t dateReceived = TimeInSecondsFromPRTime(</span>
<a href="#l34.331"></a><span id="l34.331" class="difflineplus">+            PR_Now());  // if we don't find a date str, assume now.</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineplus">+        if (lineElems.Length() &gt; 2) dateReceived = atoi(lineElems[2].get());</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineplus">+        if (!flags-&gt;IsEmpty() &amp;&amp; !uidl-&gt;IsEmpty()) {</span>
<a href="#l34.334"></a><span id="l34.334">           char flag = flags-&gt;CharAt(0);</span>
<a href="#l34.335"></a><span id="l34.335" class="difflineminus">-          if ((flag == KEEP) || (flag == DELETE_CHAR) ||</span>
<a href="#l34.336"></a><span id="l34.336" class="difflineminus">-            (flag == TOO_BIG) || (flag == FETCH_BODY))</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineminus">-          {</span>
<a href="#l34.338"></a><span id="l34.338" class="difflineplus">+          if ((flag == KEEP) || (flag == DELETE_CHAR) || (flag == TOO_BIG) ||</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineplus">+              (flag == FETCH_BODY)) {</span>
<a href="#l34.340"></a><span id="l34.340">             put_hash(current-&gt;hash, uidl-&gt;get(), flag, dateReceived);</span>
<a href="#l34.341"></a><span id="l34.341" class="difflineminus">-          }</span>
<a href="#l34.342"></a><span id="l34.342" class="difflineminus">-          else</span>
<a href="#l34.343"></a><span id="l34.343" class="difflineminus">-          {</span>
<a href="#l34.344"></a><span id="l34.344" class="difflineplus">+          } else {</span>
<a href="#l34.345"></a><span id="l34.345">             NS_ASSERTION(false, &quot;invalid flag in popstate.dat&quot;);</span>
<a href="#l34.346"></a><span id="l34.346">           }</span>
<a href="#l34.347"></a><span id="l34.347">         }</span>
<a href="#l34.348"></a><span id="l34.348">       }</span>
<a href="#l34.349"></a><span id="l34.349">     }</span>
<a href="#l34.350"></a><span id="l34.350">   }</span>
<a href="#l34.351"></a><span id="l34.351">   fileStream-&gt;Close();</span>
<a href="#l34.352"></a><span id="l34.352"> </span>
<a href="#l34.353"></a><span id="l34.353">   return result;</span>
<a href="#l34.354"></a><span id="l34.354"> }</span>
<a href="#l34.355"></a><span id="l34.355"> </span>
<a href="#l34.356"></a><span id="l34.356" class="difflineminus">-static int</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineminus">-hash_clear_mapper(PLHashEntry* he, int msgindex, void* arg)</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineminus">-{</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineminus">-  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineplus">+static int hash_clear_mapper(PLHashEntry *he, int msgindex, void *arg) {</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineplus">+  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)he-&gt;value;</span>
<a href="#l34.362"></a><span id="l34.362">   PR_Free(uidlEntry-&gt;uidl);</span>
<a href="#l34.363"></a><span id="l34.363">   PR_Free(uidlEntry);</span>
<a href="#l34.364"></a><span id="l34.364">   he-&gt;value = nullptr;</span>
<a href="#l34.365"></a><span id="l34.365"> </span>
<a href="#l34.366"></a><span id="l34.366">   return HT_ENUMERATE_REMOVE;</span>
<a href="#l34.367"></a><span id="l34.367"> }</span>
<a href="#l34.368"></a><span id="l34.368"> </span>
<a href="#l34.369"></a><span id="l34.369" class="difflineminus">-static int</span>
<a href="#l34.370"></a><span id="l34.370" class="difflineminus">-hash_empty_mapper(PLHashEntry* he, int msgindex, void* arg)</span>
<a href="#l34.371"></a><span id="l34.371" class="difflineminus">-{</span>
<a href="#l34.372"></a><span id="l34.372" class="difflineminus">-  *((bool*) arg) = false;</span>
<a href="#l34.373"></a><span id="l34.373" class="difflineplus">+static int hash_empty_mapper(PLHashEntry *he, int msgindex, void *arg) {</span>
<a href="#l34.374"></a><span id="l34.374" class="difflineplus">+  *((bool *)arg) = false;</span>
<a href="#l34.375"></a><span id="l34.375">   return HT_ENUMERATE_STOP;</span>
<a href="#l34.376"></a><span id="l34.376"> }</span>
<a href="#l34.377"></a><span id="l34.377"> </span>
<a href="#l34.378"></a><span id="l34.378" class="difflineminus">-static bool</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineminus">-hash_empty(PLHashTable* hash)</span>
<a href="#l34.380"></a><span id="l34.380" class="difflineminus">-{</span>
<a href="#l34.381"></a><span id="l34.381" class="difflineplus">+static bool hash_empty(PLHashTable *hash) {</span>
<a href="#l34.382"></a><span id="l34.382">   bool result = true;</span>
<a href="#l34.383"></a><span id="l34.383">   PL_HashTableEnumerateEntries(hash, hash_empty_mapper, (void *)&amp;result);</span>
<a href="#l34.384"></a><span id="l34.384">   return result;</span>
<a href="#l34.385"></a><span id="l34.385"> }</span>
<a href="#l34.386"></a><span id="l34.386"> </span>
<a href="#l34.387"></a><span id="l34.387" class="difflineminus">-</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineminus">-static int</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineminus">-net_pop3_write_mapper(PLHashEntry* he, int msgindex, void* arg)</span>
<a href="#l34.390"></a><span id="l34.390" class="difflineminus">-{</span>
<a href="#l34.391"></a><span id="l34.391" class="difflineminus">-  nsIOutputStream* file = (nsIOutputStream*) arg;</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineminus">-  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineminus">-  NS_ASSERTION((uidlEntry-&gt;status == KEEP) ||</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineminus">-    (uidlEntry-&gt;status == DELETE_CHAR) ||</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineminus">-    (uidlEntry-&gt;status == FETCH_BODY) ||</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineminus">-    (uidlEntry-&gt;status == TOO_BIG), &quot;invalid status&quot;);</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineminus">-  char* tmpBuffer = PR_smprintf(&quot;%c %s %d&quot; MSG_LINEBREAK, uidlEntry-&gt;status, (char*)</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineminus">-    uidlEntry-&gt;uidl, uidlEntry-&gt;dateReceived);</span>
<a href="#l34.399"></a><span id="l34.399" class="difflineplus">+static int net_pop3_write_mapper(PLHashEntry *he, int msgindex, void *arg) {</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineplus">+  nsIOutputStream *file = (nsIOutputStream *)arg;</span>
<a href="#l34.401"></a><span id="l34.401" class="difflineplus">+  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)he-&gt;value;</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l34.403"></a><span id="l34.403" class="difflineplus">+      (uidlEntry-&gt;status == KEEP) || (uidlEntry-&gt;status == DELETE_CHAR) ||</span>
<a href="#l34.404"></a><span id="l34.404" class="difflineplus">+          (uidlEntry-&gt;status == FETCH_BODY) || (uidlEntry-&gt;status == TOO_BIG),</span>
<a href="#l34.405"></a><span id="l34.405" class="difflineplus">+      &quot;invalid status&quot;);</span>
<a href="#l34.406"></a><span id="l34.406" class="difflineplus">+  char *tmpBuffer =</span>
<a href="#l34.407"></a><span id="l34.407" class="difflineplus">+      PR_smprintf(&quot;%c %s %d&quot; MSG_LINEBREAK, uidlEntry-&gt;status,</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineplus">+                  (char *)uidlEntry-&gt;uidl, uidlEntry-&gt;dateReceived);</span>
<a href="#l34.409"></a><span id="l34.409">   PR_ASSERT(tmpBuffer);</span>
<a href="#l34.410"></a><span id="l34.410">   uint32_t numBytesWritten;</span>
<a href="#l34.411"></a><span id="l34.411">   file-&gt;Write(tmpBuffer, strlen(tmpBuffer), &amp;numBytesWritten);</span>
<a href="#l34.412"></a><span id="l34.412">   PR_Free(tmpBuffer);</span>
<a href="#l34.413"></a><span id="l34.413">   return HT_ENUMERATE_NEXT;</span>
<a href="#l34.414"></a><span id="l34.414"> }</span>
<a href="#l34.415"></a><span id="l34.415"> </span>
<a href="#l34.416"></a><span id="l34.416" class="difflineminus">-static int</span>
<a href="#l34.417"></a><span id="l34.417" class="difflineminus">-net_pop3_delete_old_msgs_mapper(PLHashEntry* he, int msgindex, void* arg)</span>
<a href="#l34.418"></a><span id="l34.418" class="difflineminus">-{</span>
<a href="#l34.419"></a><span id="l34.419" class="difflineminus">-  PRTime cutOffDate = (PRTime) arg;</span>
<a href="#l34.420"></a><span id="l34.420" class="difflineminus">-  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) he-&gt;value;</span>
<a href="#l34.421"></a><span id="l34.421" class="difflineplus">+static int net_pop3_delete_old_msgs_mapper(PLHashEntry *he, int msgindex,</span>
<a href="#l34.422"></a><span id="l34.422" class="difflineplus">+                                           void *arg) {</span>
<a href="#l34.423"></a><span id="l34.423" class="difflineplus">+  PRTime cutOffDate = (PRTime)arg;</span>
<a href="#l34.424"></a><span id="l34.424" class="difflineplus">+  Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)he-&gt;value;</span>
<a href="#l34.425"></a><span id="l34.425">   if (uidlEntry-&gt;dateReceived &lt; cutOffDate)</span>
<a href="#l34.426"></a><span id="l34.426" class="difflineminus">-    uidlEntry-&gt;status = DELETE_CHAR; // mark for deletion</span>
<a href="#l34.427"></a><span id="l34.427" class="difflineplus">+    uidlEntry-&gt;status = DELETE_CHAR;  // mark for deletion</span>
<a href="#l34.428"></a><span id="l34.428">   return HT_ENUMERATE_NEXT;</span>
<a href="#l34.429"></a><span id="l34.429"> }</span>
<a href="#l34.430"></a><span id="l34.430"> </span>
<a href="#l34.431"></a><span id="l34.431" class="difflineminus">-static void</span>
<a href="#l34.432"></a><span id="l34.432" class="difflineminus">-net_pop3_write_state(Pop3UidlHost* host, nsIFile *mailDirectory)</span>
<a href="#l34.433"></a><span id="l34.433" class="difflineminus">-{</span>
<a href="#l34.434"></a><span id="l34.434" class="difflineplus">+static void net_pop3_write_state(Pop3UidlHost *host, nsIFile *mailDirectory) {</span>
<a href="#l34.435"></a><span id="l34.435">   int32_t len = 0;</span>
<a href="#l34.436"></a><span id="l34.436" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; popState;</span>
<a href="#l34.437"></a><span id="l34.437" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; popState;</span>
<a href="#l34.438"></a><span id="l34.438"> </span>
<a href="#l34.439"></a><span id="l34.439">   mailDirectory-&gt;Clone(getter_AddRefs(popState));</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineminus">-  if (!popState)</span>
<a href="#l34.441"></a><span id="l34.441" class="difflineminus">-    return;</span>
<a href="#l34.442"></a><span id="l34.442" class="difflineplus">+  if (!popState) return;</span>
<a href="#l34.443"></a><span id="l34.443">   popState-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;popstate.dat&quot;));</span>
<a href="#l34.444"></a><span id="l34.444"> </span>
<a href="#l34.445"></a><span id="l34.445">   nsCOMPtr&lt;nsIOutputStream&gt; fileOutputStream;</span>
<a href="#l34.446"></a><span id="l34.446" class="difflineminus">-  nsresult rv = MsgNewSafeBufferedFileOutputStream(getter_AddRefs(fileOutputStream), popState, -1, 00600);</span>
<a href="#l34.447"></a><span id="l34.447" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.448"></a><span id="l34.448" class="difflineminus">-    return;</span>
<a href="#l34.449"></a><span id="l34.449" class="difflineplus">+  nsresult rv = MsgNewSafeBufferedFileOutputStream(</span>
<a href="#l34.450"></a><span id="l34.450" class="difflineplus">+      getter_AddRefs(fileOutputStream), popState, -1, 00600);</span>
<a href="#l34.451"></a><span id="l34.451" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l34.452"></a><span id="l34.452"> </span>
<a href="#l34.453"></a><span id="l34.453">   const char tmpBuffer[] =</span>
<a href="#l34.454"></a><span id="l34.454" class="difflineminus">-    &quot;# POP3 State File&quot; MSG_LINEBREAK</span>
<a href="#l34.455"></a><span id="l34.455" class="difflineminus">-    &quot;# This is a generated file!  Do not edit.&quot; MSG_LINEBREAK</span>
<a href="#l34.456"></a><span id="l34.456" class="difflineminus">-    MSG_LINEBREAK;</span>
<a href="#l34.457"></a><span id="l34.457" class="difflineplus">+      &quot;# POP3 State File&quot; MSG_LINEBREAK</span>
<a href="#l34.458"></a><span id="l34.458" class="difflineplus">+      &quot;# This is a generated file!  Do not edit.&quot; MSG_LINEBREAK MSG_LINEBREAK;</span>
<a href="#l34.459"></a><span id="l34.459"> </span>
<a href="#l34.460"></a><span id="l34.460">   uint32_t numBytesWritten;</span>
<a href="#l34.461"></a><span id="l34.461">   fileOutputStream-&gt;Write(tmpBuffer, strlen(tmpBuffer), &amp;numBytesWritten);</span>
<a href="#l34.462"></a><span id="l34.462"> </span>
<a href="#l34.463"></a><span id="l34.463" class="difflineminus">-  for (; host &amp;&amp; (len &gt;= 0); host = host-&gt;next)</span>
<a href="#l34.464"></a><span id="l34.464" class="difflineminus">-  {</span>
<a href="#l34.465"></a><span id="l34.465" class="difflineminus">-    if (!hash_empty(host-&gt;hash))</span>
<a href="#l34.466"></a><span id="l34.466" class="difflineminus">-    {</span>
<a href="#l34.467"></a><span id="l34.467" class="difflineplus">+  for (; host &amp;&amp; (len &gt;= 0); host = host-&gt;next) {</span>
<a href="#l34.468"></a><span id="l34.468" class="difflineplus">+    if (!hash_empty(host-&gt;hash)) {</span>
<a href="#l34.469"></a><span id="l34.469">       fileOutputStream-&gt;Write(&quot;*&quot;, 1, &amp;numBytesWritten);</span>
<a href="#l34.470"></a><span id="l34.470">       fileOutputStream-&gt;Write(host-&gt;host, strlen(host-&gt;host), &amp;numBytesWritten);</span>
<a href="#l34.471"></a><span id="l34.471">       fileOutputStream-&gt;Write(&quot; &quot;, 1, &amp;numBytesWritten);</span>
<a href="#l34.472"></a><span id="l34.472">       fileOutputStream-&gt;Write(host-&gt;user, strlen(host-&gt;user), &amp;numBytesWritten);</span>
<a href="#l34.473"></a><span id="l34.473" class="difflineminus">-      fileOutputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;numBytesWritten);</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineminus">-      PL_HashTableEnumerateEntries(host-&gt;hash, net_pop3_write_mapper, (void *)fileOutputStream);</span>
<a href="#l34.475"></a><span id="l34.475" class="difflineplus">+      fileOutputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l34.476"></a><span id="l34.476" class="difflineplus">+                              &amp;numBytesWritten);</span>
<a href="#l34.477"></a><span id="l34.477" class="difflineplus">+      PL_HashTableEnumerateEntries(host-&gt;hash, net_pop3_write_mapper,</span>
<a href="#l34.478"></a><span id="l34.478" class="difflineplus">+                                   (void *)fileOutputStream);</span>
<a href="#l34.479"></a><span id="l34.479">     }</span>
<a href="#l34.480"></a><span id="l34.480">   }</span>
<a href="#l34.481"></a><span id="l34.481" class="difflineminus">-  nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(fileOutputStream);</span>
<a href="#l34.482"></a><span id="l34.482" class="difflineplus">+  nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream =</span>
<a href="#l34.483"></a><span id="l34.483" class="difflineplus">+      do_QueryInterface(fileOutputStream);</span>
<a href="#l34.484"></a><span id="l34.484">   NS_ASSERTION(safeStream, &quot;expected a safe output stream!&quot;);</span>
<a href="#l34.485"></a><span id="l34.485">   if (safeStream) {</span>
<a href="#l34.486"></a><span id="l34.486">     rv = safeStream-&gt;Finish();</span>
<a href="#l34.487"></a><span id="l34.487">     if (NS_FAILED(rv)) {</span>
<a href="#l34.488"></a><span id="l34.488">       NS_WARNING(&quot;failed to save pop state! possible data loss&quot;);</span>
<a href="#l34.489"></a><span id="l34.489">     }</span>
<a href="#l34.490"></a><span id="l34.490">   }</span>
<a href="#l34.491"></a><span id="l34.491"> }</span>
<a href="#l34.492"></a><span id="l34.492"> </span>
<a href="#l34.493"></a><span id="l34.493" class="difflineminus">-static void</span>
<a href="#l34.494"></a><span id="l34.494" class="difflineminus">-net_pop3_free_state(Pop3UidlHost* host)</span>
<a href="#l34.495"></a><span id="l34.495" class="difflineminus">-{</span>
<a href="#l34.496"></a><span id="l34.496" class="difflineminus">-  Pop3UidlHost* h;</span>
<a href="#l34.497"></a><span id="l34.497" class="difflineminus">-  while (host)</span>
<a href="#l34.498"></a><span id="l34.498" class="difflineminus">-  {</span>
<a href="#l34.499"></a><span id="l34.499" class="difflineplus">+static void net_pop3_free_state(Pop3UidlHost *host) {</span>
<a href="#l34.500"></a><span id="l34.500" class="difflineplus">+  Pop3UidlHost *h;</span>
<a href="#l34.501"></a><span id="l34.501" class="difflineplus">+  while (host) {</span>
<a href="#l34.502"></a><span id="l34.502">     h = host-&gt;next;</span>
<a href="#l34.503"></a><span id="l34.503">     PR_Free(host-&gt;host);</span>
<a href="#l34.504"></a><span id="l34.504">     PR_Free(host-&gt;user);</span>
<a href="#l34.505"></a><span id="l34.505">     PL_HashTableDestroy(host-&gt;hash);</span>
<a href="#l34.506"></a><span id="l34.506">     PR_Free(host);</span>
<a href="#l34.507"></a><span id="l34.507">     host = h;</span>
<a href="#l34.508"></a><span id="l34.508">   }</span>
<a href="#l34.509"></a><span id="l34.509"> }</span>
<a href="#l34.510"></a><span id="l34.510"> </span>
<a href="#l34.511"></a><span id="l34.511"> /*</span>
<a href="#l34.512"></a><span id="l34.512"> Look for a specific UIDL string in our hash tables, if we have it then we need</span>
<a href="#l34.513"></a><span id="l34.513" class="difflineminus">-to mark the message for deletion so that it can be deleted later. If the uidl of the</span>
<a href="#l34.514"></a><span id="l34.514" class="difflineminus">-message is not found, then the message was downloaded completely and already deleted</span>
<a href="#l34.515"></a><span id="l34.515" class="difflineminus">-from the server. So this only applies to messages kept on the server or too big</span>
<a href="#l34.516"></a><span id="l34.516" class="difflineminus">-for download. */</span>
<a href="#l34.517"></a><span id="l34.517" class="difflineplus">+to mark the message for deletion so that it can be deleted later. If the uidl of</span>
<a href="#l34.518"></a><span id="l34.518" class="difflineplus">+the message is not found, then the message was downloaded completely and already</span>
<a href="#l34.519"></a><span id="l34.519" class="difflineplus">+deleted from the server. So this only applies to messages kept on the server or</span>
<a href="#l34.520"></a><span id="l34.520" class="difflineplus">+too big for download. */</span>
<a href="#l34.521"></a><span id="l34.521"> /* static */</span>
<a href="#l34.522"></a><span id="l34.522" class="difflineminus">-void nsPop3Protocol::MarkMsgInHashTable(PLHashTable *hashTable, const Pop3UidlEntry *uidlE, bool *changed)</span>
<a href="#l34.523"></a><span id="l34.523" class="difflineminus">-{</span>
<a href="#l34.524"></a><span id="l34.524" class="difflineminus">-  if (uidlE-&gt;uidl)</span>
<a href="#l34.525"></a><span id="l34.525" class="difflineminus">-  {</span>
<a href="#l34.526"></a><span id="l34.526" class="difflineminus">-    Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) PL_HashTableLookup(hashTable, uidlE-&gt;uidl);</span>
<a href="#l34.527"></a><span id="l34.527" class="difflineminus">-    if (uidlEntry)</span>
<a href="#l34.528"></a><span id="l34.528" class="difflineminus">-    {</span>
<a href="#l34.529"></a><span id="l34.529" class="difflineminus">-      if (uidlEntry-&gt;status != uidlE-&gt;status)</span>
<a href="#l34.530"></a><span id="l34.530" class="difflineminus">-      {</span>
<a href="#l34.531"></a><span id="l34.531" class="difflineplus">+void nsPop3Protocol::MarkMsgInHashTable(PLHashTable *hashTable,</span>
<a href="#l34.532"></a><span id="l34.532" class="difflineplus">+                                        const Pop3UidlEntry *uidlE,</span>
<a href="#l34.533"></a><span id="l34.533" class="difflineplus">+                                        bool *changed) {</span>
<a href="#l34.534"></a><span id="l34.534" class="difflineplus">+  if (uidlE-&gt;uidl) {</span>
<a href="#l34.535"></a><span id="l34.535" class="difflineplus">+    Pop3UidlEntry *uidlEntry =</span>
<a href="#l34.536"></a><span id="l34.536" class="difflineplus">+        (Pop3UidlEntry *)PL_HashTableLookup(hashTable, uidlE-&gt;uidl);</span>
<a href="#l34.537"></a><span id="l34.537" class="difflineplus">+    if (uidlEntry) {</span>
<a href="#l34.538"></a><span id="l34.538" class="difflineplus">+      if (uidlEntry-&gt;status != uidlE-&gt;status) {</span>
<a href="#l34.539"></a><span id="l34.539">         uidlEntry-&gt;status = uidlE-&gt;status;</span>
<a href="#l34.540"></a><span id="l34.540">         *changed = true;</span>
<a href="#l34.541"></a><span id="l34.541">       }</span>
<a href="#l34.542"></a><span id="l34.542">     }</span>
<a href="#l34.543"></a><span id="l34.543">   }</span>
<a href="#l34.544"></a><span id="l34.544"> }</span>
<a href="#l34.545"></a><span id="l34.545"> </span>
<a href="#l34.546"></a><span id="l34.546"> /* static */</span>
<a href="#l34.547"></a><span id="l34.547" class="difflineminus">-nsresult</span>
<a href="#l34.548"></a><span id="l34.548" class="difflineminus">-nsPop3Protocol::MarkMsgForHost(const char *hostName, const char *userName,</span>
<a href="#l34.549"></a><span id="l34.549" class="difflineminus">-                                      nsIFile *mailDirectory,</span>
<a href="#l34.550"></a><span id="l34.550" class="difflineminus">-                                       nsTArray&lt;Pop3UidlEntry*&gt; &amp;UIDLArray)</span>
<a href="#l34.551"></a><span id="l34.551" class="difflineminus">-{</span>
<a href="#l34.552"></a><span id="l34.552" class="difflineminus">-  if (!hostName || !userName || !mailDirectory)</span>
<a href="#l34.553"></a><span id="l34.553" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.554"></a><span id="l34.554" class="difflineminus">-</span>
<a href="#l34.555"></a><span id="l34.555" class="difflineminus">-  Pop3UidlHost *uidlHost = net_pop3_load_state(hostName, userName, mailDirectory);</span>
<a href="#l34.556"></a><span id="l34.556" class="difflineminus">-  if (!uidlHost)</span>
<a href="#l34.557"></a><span id="l34.557" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.558"></a><span id="l34.558" class="difflineplus">+nsresult nsPop3Protocol::MarkMsgForHost(const char *hostName,</span>
<a href="#l34.559"></a><span id="l34.559" class="difflineplus">+                                        const char *userName,</span>
<a href="#l34.560"></a><span id="l34.560" class="difflineplus">+                                        nsIFile *mailDirectory,</span>
<a href="#l34.561"></a><span id="l34.561" class="difflineplus">+                                        nsTArray&lt;Pop3UidlEntry *&gt; &amp;UIDLArray) {</span>
<a href="#l34.562"></a><span id="l34.562" class="difflineplus">+  if (!hostName || !userName || !mailDirectory) return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.563"></a><span id="l34.563" class="difflineplus">+</span>
<a href="#l34.564"></a><span id="l34.564" class="difflineplus">+  Pop3UidlHost *uidlHost =</span>
<a href="#l34.565"></a><span id="l34.565" class="difflineplus">+      net_pop3_load_state(hostName, userName, mailDirectory);</span>
<a href="#l34.566"></a><span id="l34.566" class="difflineplus">+  if (!uidlHost) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.567"></a><span id="l34.567"> </span>
<a href="#l34.568"></a><span id="l34.568">   bool changed = false;</span>
<a href="#l34.569"></a><span id="l34.569"> </span>
<a href="#l34.570"></a><span id="l34.570">   uint32_t count = UIDLArray.Length();</span>
<a href="#l34.571"></a><span id="l34.571" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l34.572"></a><span id="l34.572" class="difflineminus">-  {</span>
<a href="#l34.573"></a><span id="l34.573" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l34.574"></a><span id="l34.574">     MarkMsgInHashTable(uidlHost-&gt;hash, UIDLArray[i], &amp;changed);</span>
<a href="#l34.575"></a><span id="l34.575">   }</span>
<a href="#l34.576"></a><span id="l34.576"> </span>
<a href="#l34.577"></a><span id="l34.577" class="difflineminus">-  if (changed)</span>
<a href="#l34.578"></a><span id="l34.578" class="difflineminus">-    net_pop3_write_state(uidlHost, mailDirectory);</span>
<a href="#l34.579"></a><span id="l34.579" class="difflineplus">+  if (changed) net_pop3_write_state(uidlHost, mailDirectory);</span>
<a href="#l34.580"></a><span id="l34.580">   net_pop3_free_state(uidlHost);</span>
<a href="#l34.581"></a><span id="l34.581">   return NS_OK;</span>
<a href="#l34.582"></a><span id="l34.582"> }</span>
<a href="#l34.583"></a><span id="l34.583"> </span>
<a href="#l34.584"></a><span id="l34.584" class="difflineminus">-</span>
<a href="#l34.585"></a><span id="l34.585" class="difflineminus">-</span>
<a href="#l34.586"></a><span id="l34.586"> NS_IMPL_ADDREF_INHERITED(nsPop3Protocol, nsMsgProtocol)</span>
<a href="#l34.587"></a><span id="l34.587"> NS_IMPL_RELEASE_INHERITED(nsPop3Protocol, nsMsgProtocol)</span>
<a href="#l34.588"></a><span id="l34.588"> </span>
<a href="#l34.589"></a><span id="l34.589" class="difflineminus">-</span>
<a href="#l34.590"></a><span id="l34.590" class="difflineminus">-</span>
<a href="#l34.591"></a><span id="l34.591"> NS_INTERFACE_MAP_BEGIN(nsPop3Protocol)</span>
<a href="#l34.592"></a><span id="l34.592">   NS_INTERFACE_MAP_ENTRY(nsIPop3Protocol)</span>
<a href="#l34.593"></a><span id="l34.593">   NS_INTERFACE_MAP_ENTRY(nsIMsgAsyncPromptListener)</span>
<a href="#l34.594"></a><span id="l34.594">   NS_INTERFACE_MAP_ENTRY(nsIProtocolProxyCallback)</span>
<a href="#l34.595"></a><span id="l34.595"> NS_INTERFACE_MAP_END_INHERITING(nsMsgProtocol)</span>
<a href="#l34.596"></a><span id="l34.596"> </span>
<a href="#l34.597"></a><span id="l34.597"> // nsPop3Protocol class implementation</span>
<a href="#l34.598"></a><span id="l34.598"> </span>
<a href="#l34.599"></a><span id="l34.599" class="difflineminus">-nsPop3Protocol::nsPop3Protocol(nsIURI* aURL)</span>
<a href="#l34.600"></a><span id="l34.600" class="difflineminus">-: nsMsgProtocol(aURL),</span>
<a href="#l34.601"></a><span id="l34.601" class="difflineminus">-  m_bytesInMsgReceived(0),</span>
<a href="#l34.602"></a><span id="l34.602" class="difflineminus">-  m_totalFolderSize(0),</span>
<a href="#l34.603"></a><span id="l34.603" class="difflineminus">-  m_totalDownloadSize(0),</span>
<a href="#l34.604"></a><span id="l34.604" class="difflineminus">-  m_totalBytesReceived(0),</span>
<a href="#l34.605"></a><span id="l34.605" class="difflineminus">-  m_pop3ConData(nullptr)</span>
<a href="#l34.606"></a><span id="l34.606" class="difflineminus">-{</span>
<a href="#l34.607"></a><span id="l34.607" class="difflineminus">-}</span>
<a href="#l34.608"></a><span id="l34.608" class="difflineminus">-</span>
<a href="#l34.609"></a><span id="l34.609" class="difflineminus">-nsresult nsPop3Protocol::Initialize(nsIURI * aURL)</span>
<a href="#l34.610"></a><span id="l34.610" class="difflineminus">-{</span>
<a href="#l34.611"></a><span id="l34.611" class="difflineplus">+nsPop3Protocol::nsPop3Protocol(nsIURI *aURL)</span>
<a href="#l34.612"></a><span id="l34.612" class="difflineplus">+    : nsMsgProtocol(aURL),</span>
<a href="#l34.613"></a><span id="l34.613" class="difflineplus">+      m_bytesInMsgReceived(0),</span>
<a href="#l34.614"></a><span id="l34.614" class="difflineplus">+      m_totalFolderSize(0),</span>
<a href="#l34.615"></a><span id="l34.615" class="difflineplus">+      m_totalDownloadSize(0),</span>
<a href="#l34.616"></a><span id="l34.616" class="difflineplus">+      m_totalBytesReceived(0),</span>
<a href="#l34.617"></a><span id="l34.617" class="difflineplus">+      m_pop3ConData(nullptr) {}</span>
<a href="#l34.618"></a><span id="l34.618" class="difflineplus">+</span>
<a href="#l34.619"></a><span id="l34.619" class="difflineplus">+nsresult nsPop3Protocol::Initialize(nsIURI *aURL) {</span>
<a href="#l34.620"></a><span id="l34.620">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;Initialize()&quot;)));</span>
<a href="#l34.621"></a><span id="l34.621"> </span>
<a href="#l34.622"></a><span id="l34.622">   m_pop3ConData = (Pop3ConData *)PR_NEWZAP(Pop3ConData);</span>
<a href="#l34.623"></a><span id="l34.623" class="difflineminus">-  if(!m_pop3ConData)</span>
<a href="#l34.624"></a><span id="l34.624" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.625"></a><span id="l34.625" class="difflineplus">+  if (!m_pop3ConData) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.626"></a><span id="l34.626"> </span>
<a href="#l34.627"></a><span id="l34.627">   m_totalBytesReceived = 0;</span>
<a href="#l34.628"></a><span id="l34.628">   m_bytesInMsgReceived = 0;</span>
<a href="#l34.629"></a><span id="l34.629">   m_totalFolderSize = 0;</span>
<a href="#l34.630"></a><span id="l34.630">   m_totalDownloadSize = 0;</span>
<a href="#l34.631"></a><span id="l34.631">   m_totalBytesReceived = 0;</span>
<a href="#l34.632"></a><span id="l34.632">   m_tlsEnabled = false;</span>
<a href="#l34.633"></a><span id="l34.633">   m_socketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l34.634"></a><span id="l34.634" class="difflineat">@@ -484,58 +413,56 @@ nsresult nsPop3Protocol::Initialize(nsIU</span>
<a href="#l34.635"></a><span id="l34.635">   m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l34.636"></a><span id="l34.636">   m_needToRerunUrl = false;</span>
<a href="#l34.637"></a><span id="l34.637"> </span>
<a href="#l34.638"></a><span id="l34.638">   m_url = aURL;</span>
<a href="#l34.639"></a><span id="l34.639"> </span>
<a href="#l34.640"></a><span id="l34.640">   m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true);</span>
<a href="#l34.641"></a><span id="l34.641"> </span>
<a href="#l34.642"></a><span id="l34.642">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l34.643"></a><span id="l34.643" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l34.644"></a><span id="l34.644" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l34.645"></a><span id="l34.645">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l34.646"></a><span id="l34.646" class="difflineminus">-  return bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(mLocalBundle));</span>
<a href="#l34.647"></a><span id="l34.647" class="difflineplus">+  return bundleService-&gt;CreateBundle(</span>
<a href="#l34.648"></a><span id="l34.648" class="difflineplus">+      &quot;chrome://messenger/locale/localMsgs.properties&quot;,</span>
<a href="#l34.649"></a><span id="l34.649" class="difflineplus">+      getter_AddRefs(mLocalBundle));</span>
<a href="#l34.650"></a><span id="l34.650"> }</span>
<a href="#l34.651"></a><span id="l34.651"> </span>
<a href="#l34.652"></a><span id="l34.652"> // nsIProtocolProxyCallback</span>
<a href="#l34.653"></a><span id="l34.653"> NS_IMETHODIMP</span>
<a href="#l34.654"></a><span id="l34.654"> nsPop3Protocol::OnProxyAvailable(nsICancelable *aRequest, nsIChannel *aChannel,</span>
<a href="#l34.655"></a><span id="l34.655" class="difflineminus">-                                 nsIProxyInfo *aProxyInfo, nsresult aStatus)</span>
<a href="#l34.656"></a><span id="l34.656" class="difflineminus">-{</span>
<a href="#l34.657"></a><span id="l34.657" class="difflineplus">+                                 nsIProxyInfo *aProxyInfo, nsresult aStatus) {</span>
<a href="#l34.658"></a><span id="l34.658">   // If we're called with NS_BINDING_ABORTED, we came here via Cancel().</span>
<a href="#l34.659"></a><span id="l34.659">   // Otherwise, no checking of 'aStatus' here, see</span>
<a href="#l34.660"></a><span id="l34.660">   // nsHttpChannel::OnProxyAvailable(). Status is non-fatal and we just kick on.</span>
<a href="#l34.661"></a><span id="l34.661" class="difflineminus">-  if (aStatus == NS_BINDING_ABORTED)</span>
<a href="#l34.662"></a><span id="l34.662" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l34.663"></a><span id="l34.663" class="difflineplus">+  if (aStatus == NS_BINDING_ABORTED) return NS_ERROR_FAILURE;</span>
<a href="#l34.664"></a><span id="l34.664"> </span>
<a href="#l34.665"></a><span id="l34.665">   nsresult rv = InitializeInternal(aProxyInfo);</span>
<a href="#l34.666"></a><span id="l34.666">   if (NS_FAILED(rv)) {</span>
<a href="#l34.667"></a><span id="l34.667">     Cancel(rv);</span>
<a href="#l34.668"></a><span id="l34.668">     return rv;</span>
<a href="#l34.669"></a><span id="l34.669">   }</span>
<a href="#l34.670"></a><span id="l34.670"> </span>
<a href="#l34.671"></a><span id="l34.671">   rv = LoadUrlInternal(m_url);</span>
<a href="#l34.672"></a><span id="l34.672">   if (NS_FAILED(rv)) {</span>
<a href="#l34.673"></a><span id="l34.673">     Cancel(rv);</span>
<a href="#l34.674"></a><span id="l34.674">   }</span>
<a href="#l34.675"></a><span id="l34.675"> </span>
<a href="#l34.676"></a><span id="l34.676">   return rv;</span>
<a href="#l34.677"></a><span id="l34.677"> }</span>
<a href="#l34.678"></a><span id="l34.678"> </span>
<a href="#l34.679"></a><span id="l34.679" class="difflineminus">-nsresult nsPop3Protocol::InitializeInternal(nsIProxyInfo* aProxyInfo)</span>
<a href="#l34.680"></a><span id="l34.680" class="difflineminus">-{</span>
<a href="#l34.681"></a><span id="l34.681" class="difflineplus">+nsresult nsPop3Protocol::InitializeInternal(nsIProxyInfo *aProxyInfo) {</span>
<a href="#l34.682"></a><span id="l34.682">   nsresult rv;</span>
<a href="#l34.683"></a><span id="l34.683"> </span>
<a href="#l34.684"></a><span id="l34.684">   m_proxyRequest = nullptr;</span>
<a href="#l34.685"></a><span id="l34.685"> </span>
<a href="#l34.686"></a><span id="l34.686">   NS_ENSURE_TRUE(m_url, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l34.687"></a><span id="l34.687"> </span>
<a href="#l34.688"></a><span id="l34.688">   // extract out message feedback if there is any.</span>
<a href="#l34.689"></a><span id="l34.689">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l34.690"></a><span id="l34.690" class="difflineminus">-  if (mailnewsUrl)</span>
<a href="#l34.691"></a><span id="l34.691" class="difflineminus">-  {</span>
<a href="#l34.692"></a><span id="l34.692" class="difflineplus">+  if (mailnewsUrl) {</span>
<a href="#l34.693"></a><span id="l34.693">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l34.694"></a><span id="l34.694">     mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l34.695"></a><span id="l34.695">     NS_ENSURE_TRUE(server, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l34.696"></a><span id="l34.696"> </span>
<a href="#l34.697"></a><span id="l34.697">     rv = server-&gt;GetSocketType(&amp;m_socketType);</span>
<a href="#l34.698"></a><span id="l34.698">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.699"></a><span id="l34.699"> </span>
<a href="#l34.700"></a><span id="l34.700">     int32_t authMethod = 0;</span>
<a href="#l34.701"></a><span id="l34.701" class="difflineat">@@ -547,213 +474,184 @@ nsresult nsPop3Protocol::InitializeInter</span>
<a href="#l34.702"></a><span id="l34.702">     if (m_pop3Server)</span>
<a href="#l34.703"></a><span id="l34.703">       m_pop3Server-&gt;GetPop3CapabilityFlags(&amp;m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.704"></a><span id="l34.704">   }</span>
<a href="#l34.705"></a><span id="l34.705"> </span>
<a href="#l34.706"></a><span id="l34.706">   // When we are making a secure connection, we need to make sure that we</span>
<a href="#l34.707"></a><span id="l34.707">   // pass an interface requestor down to the socket transport so that PSM can</span>
<a href="#l34.708"></a><span id="l34.708">   // retrieve a nsIPrompt instance if needed.</span>
<a href="#l34.709"></a><span id="l34.709">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir;</span>
<a href="#l34.710"></a><span id="l34.710" class="difflineminus">-  if (m_socketType != nsMsgSocketType::plain)</span>
<a href="#l34.711"></a><span id="l34.711" class="difflineminus">-  {</span>
<a href="#l34.712"></a><span id="l34.712" class="difflineplus">+  if (m_socketType != nsMsgSocketType::plain) {</span>
<a href="#l34.713"></a><span id="l34.713">     nsCOMPtr&lt;nsIMsgWindow&gt; msgwin;</span>
<a href="#l34.714"></a><span id="l34.714" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l34.715"></a><span id="l34.715" class="difflineminus">-      mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l34.716"></a><span id="l34.716" class="difflineminus">-    if (!msgwin)</span>
<a href="#l34.717"></a><span id="l34.717" class="difflineminus">-      GetTopmostMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l34.718"></a><span id="l34.718" class="difflineminus">-    if (msgwin)</span>
<a href="#l34.719"></a><span id="l34.719" class="difflineminus">-    {</span>
<a href="#l34.720"></a><span id="l34.720" class="difflineplus">+    if (mailnewsUrl) mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l34.721"></a><span id="l34.721" class="difflineplus">+    if (!msgwin) GetTopmostMsgWindow(getter_AddRefs(msgwin));</span>
<a href="#l34.722"></a><span id="l34.722" class="difflineplus">+    if (msgwin) {</span>
<a href="#l34.723"></a><span id="l34.723">       nsCOMPtr&lt;nsIDocShell&gt; docshell;</span>
<a href="#l34.724"></a><span id="l34.724">       msgwin-&gt;GetRootDocShell(getter_AddRefs(docshell));</span>
<a href="#l34.725"></a><span id="l34.725">       ir = do_QueryInterface(docshell);</span>
<a href="#l34.726"></a><span id="l34.726">       nsCOMPtr&lt;nsIInterfaceRequestor&gt; notificationCallbacks;</span>
<a href="#l34.727"></a><span id="l34.727">       msgwin-&gt;GetNotificationCallbacks(getter_AddRefs(notificationCallbacks));</span>
<a href="#l34.728"></a><span id="l34.728" class="difflineminus">-      if (notificationCallbacks)</span>
<a href="#l34.729"></a><span id="l34.729" class="difflineminus">-      {</span>
<a href="#l34.730"></a><span id="l34.730" class="difflineplus">+      if (notificationCallbacks) {</span>
<a href="#l34.731"></a><span id="l34.731">         nsCOMPtr&lt;nsIInterfaceRequestor&gt; aggregrateIR;</span>
<a href="#l34.732"></a><span id="l34.732" class="difflineminus">-        MsgNewInterfaceRequestorAggregation(notificationCallbacks, ir, getter_AddRefs(aggregrateIR));</span>
<a href="#l34.733"></a><span id="l34.733" class="difflineplus">+        MsgNewInterfaceRequestorAggregation(notificationCallbacks, ir,</span>
<a href="#l34.734"></a><span id="l34.734" class="difflineplus">+                                            getter_AddRefs(aggregrateIR));</span>
<a href="#l34.735"></a><span id="l34.735">         ir = aggregrateIR;</span>
<a href="#l34.736"></a><span id="l34.736">       }</span>
<a href="#l34.737"></a><span id="l34.737">     }</span>
<a href="#l34.738"></a><span id="l34.738">   }</span>
<a href="#l34.739"></a><span id="l34.739"> </span>
<a href="#l34.740"></a><span id="l34.740">   int32_t port = 0;</span>
<a href="#l34.741"></a><span id="l34.741">   m_url-&gt;GetPort(&amp;port);</span>
<a href="#l34.742"></a><span id="l34.742"> </span>
<a href="#l34.743"></a><span id="l34.743">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.744"></a><span id="l34.744">   nsAutoCString hostName;</span>
<a href="#l34.745"></a><span id="l34.745" class="difflineminus">-  if (server)</span>
<a href="#l34.746"></a><span id="l34.746" class="difflineminus">-    server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.747"></a><span id="l34.747" class="difflineplus">+  if (server) server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.748"></a><span id="l34.748"> </span>
<a href="#l34.749"></a><span id="l34.749">   const char *connectionType = nullptr;</span>
<a href="#l34.750"></a><span id="l34.750">   if (m_socketType == nsMsgSocketType::SSL)</span>
<a href="#l34.751"></a><span id="l34.751">     connectionType = &quot;ssl&quot;;</span>
<a href="#l34.752"></a><span id="l34.752">   else if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l34.753"></a><span id="l34.753" class="difflineminus">-    m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l34.754"></a><span id="l34.754" class="difflineplus">+           m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l34.755"></a><span id="l34.755">     connectionType = &quot;starttls&quot;;</span>
<a href="#l34.756"></a><span id="l34.756"> </span>
<a href="#l34.757"></a><span id="l34.757" class="difflineminus">-  rv = OpenNetworkSocketWithInfo(hostName.get(), port, connectionType, aProxyInfo, ir);</span>
<a href="#l34.758"></a><span id="l34.758" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l34.759"></a><span id="l34.759" class="difflineminus">-  {</span>
<a href="#l34.760"></a><span id="l34.760" class="difflineplus">+  rv = OpenNetworkSocketWithInfo(hostName.get(), port, connectionType,</span>
<a href="#l34.761"></a><span id="l34.761" class="difflineplus">+                                 aProxyInfo, ir);</span>
<a href="#l34.762"></a><span id="l34.762" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; m_socketType == nsMsgSocketType::trySTARTTLS) {</span>
<a href="#l34.763"></a><span id="l34.763">     m_socketType = nsMsgSocketType::plain;</span>
<a href="#l34.764"></a><span id="l34.764" class="difflineminus">-    rv = OpenNetworkSocketWithInfo(hostName.get(), port, nullptr, aProxyInfo, ir);</span>
<a href="#l34.765"></a><span id="l34.765" class="difflineplus">+    rv = OpenNetworkSocketWithInfo(hostName.get(), port, nullptr, aProxyInfo,</span>
<a href="#l34.766"></a><span id="l34.766" class="difflineplus">+                                   ir);</span>
<a href="#l34.767"></a><span id="l34.767">   }</span>
<a href="#l34.768"></a><span id="l34.768"> </span>
<a href="#l34.769"></a><span id="l34.769">   return rv;</span>
<a href="#l34.770"></a><span id="l34.770"> }</span>
<a href="#l34.771"></a><span id="l34.771"> </span>
<a href="#l34.772"></a><span id="l34.772" class="difflineminus">-nsPop3Protocol::~nsPop3Protocol()</span>
<a href="#l34.773"></a><span id="l34.773" class="difflineminus">-{</span>
<a href="#l34.774"></a><span id="l34.774" class="difflineplus">+nsPop3Protocol::~nsPop3Protocol() {</span>
<a href="#l34.775"></a><span id="l34.775">   Cleanup();</span>
<a href="#l34.776"></a><span id="l34.776">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;~nsPop3Protocol()&quot;)));</span>
<a href="#l34.777"></a><span id="l34.777"> }</span>
<a href="#l34.778"></a><span id="l34.778"> </span>
<a href="#l34.779"></a><span id="l34.779" class="difflineminus">-void nsPop3Protocol::Cleanup()</span>
<a href="#l34.780"></a><span id="l34.780" class="difflineminus">-{</span>
<a href="#l34.781"></a><span id="l34.781" class="difflineminus">-  if (m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.782"></a><span id="l34.782" class="difflineminus">-  {</span>
<a href="#l34.783"></a><span id="l34.783" class="difflineplus">+void nsPop3Protocol::Cleanup() {</span>
<a href="#l34.784"></a><span id="l34.784" class="difflineplus">+  if (m_pop3ConData-&gt;newuidl) {</span>
<a href="#l34.785"></a><span id="l34.785">     PL_HashTableDestroy(m_pop3ConData-&gt;newuidl);</span>
<a href="#l34.786"></a><span id="l34.786">     m_pop3ConData-&gt;newuidl = nullptr;</span>
<a href="#l34.787"></a><span id="l34.787">   }</span>
<a href="#l34.788"></a><span id="l34.788"> </span>
<a href="#l34.789"></a><span id="l34.789">   net_pop3_free_state(m_pop3ConData-&gt;uidlinfo);</span>
<a href="#l34.790"></a><span id="l34.790"> </span>
<a href="#l34.791"></a><span id="l34.791">   FreeMsgInfo();</span>
<a href="#l34.792"></a><span id="l34.792">   PR_Free(m_pop3ConData-&gt;only_uidl);</span>
<a href="#l34.793"></a><span id="l34.793">   PR_Free(m_pop3ConData);</span>
<a href="#l34.794"></a><span id="l34.794"> }</span>
<a href="#l34.795"></a><span id="l34.795"> </span>
<a href="#l34.796"></a><span id="l34.796" class="difflineminus">-void nsPop3Protocol::SetCapFlag(uint32_t flag)</span>
<a href="#l34.797"></a><span id="l34.797" class="difflineminus">-{</span>
<a href="#l34.798"></a><span id="l34.798" class="difflineminus">-    m_pop3ConData-&gt;capability_flags |= flag;</span>
<a href="#l34.799"></a><span id="l34.799" class="difflineplus">+void nsPop3Protocol::SetCapFlag(uint32_t flag) {</span>
<a href="#l34.800"></a><span id="l34.800" class="difflineplus">+  m_pop3ConData-&gt;capability_flags |= flag;</span>
<a href="#l34.801"></a><span id="l34.801"> }</span>
<a href="#l34.802"></a><span id="l34.802"> </span>
<a href="#l34.803"></a><span id="l34.803" class="difflineminus">-void nsPop3Protocol::ClearCapFlag(uint32_t flag)</span>
<a href="#l34.804"></a><span id="l34.804" class="difflineminus">-{</span>
<a href="#l34.805"></a><span id="l34.805" class="difflineminus">-    m_pop3ConData-&gt;capability_flags &amp;= ~flag;</span>
<a href="#l34.806"></a><span id="l34.806" class="difflineplus">+void nsPop3Protocol::ClearCapFlag(uint32_t flag) {</span>
<a href="#l34.807"></a><span id="l34.807" class="difflineplus">+  m_pop3ConData-&gt;capability_flags &amp;= ~flag;</span>
<a href="#l34.808"></a><span id="l34.808"> }</span>
<a href="#l34.809"></a><span id="l34.809"> </span>
<a href="#l34.810"></a><span id="l34.810" class="difflineminus">-bool nsPop3Protocol::TestCapFlag(uint32_t flag)</span>
<a href="#l34.811"></a><span id="l34.811" class="difflineminus">-{</span>
<a href="#l34.812"></a><span id="l34.812" class="difflineminus">-    return m_pop3ConData-&gt;capability_flags &amp; flag;</span>
<a href="#l34.813"></a><span id="l34.813" class="difflineplus">+bool nsPop3Protocol::TestCapFlag(uint32_t flag) {</span>
<a href="#l34.814"></a><span id="l34.814" class="difflineplus">+  return m_pop3ConData-&gt;capability_flags &amp; flag;</span>
<a href="#l34.815"></a><span id="l34.815"> }</span>
<a href="#l34.816"></a><span id="l34.816"> </span>
<a href="#l34.817"></a><span id="l34.817" class="difflineminus">-uint32_t nsPop3Protocol::GetCapFlags()</span>
<a href="#l34.818"></a><span id="l34.818" class="difflineminus">-{</span>
<a href="#l34.819"></a><span id="l34.819" class="difflineminus">-    return m_pop3ConData-&gt;capability_flags;</span>
<a href="#l34.820"></a><span id="l34.820" class="difflineplus">+uint32_t nsPop3Protocol::GetCapFlags() {</span>
<a href="#l34.821"></a><span id="l34.821" class="difflineplus">+  return m_pop3ConData-&gt;capability_flags;</span>
<a href="#l34.822"></a><span id="l34.822"> }</span>
<a href="#l34.823"></a><span id="l34.823"> </span>
<a href="#l34.824"></a><span id="l34.824"> nsresult nsPop3Protocol::FormatCounterString(const nsString &amp;stringName,</span>
<a href="#l34.825"></a><span id="l34.825" class="difflineminus">-                                             uint32_t count1,</span>
<a href="#l34.826"></a><span id="l34.826" class="difflineminus">-                                             uint32_t count2,</span>
<a href="#l34.827"></a><span id="l34.827" class="difflineminus">-                                             nsString &amp;resultString)</span>
<a href="#l34.828"></a><span id="l34.828" class="difflineminus">-{</span>
<a href="#l34.829"></a><span id="l34.829" class="difflineplus">+                                             uint32_t count1, uint32_t count2,</span>
<a href="#l34.830"></a><span id="l34.830" class="difflineplus">+                                             nsString &amp;resultString) {</span>
<a href="#l34.831"></a><span id="l34.831">   nsAutoString count1String;</span>
<a href="#l34.832"></a><span id="l34.832">   count1String.AppendInt(count1);</span>
<a href="#l34.833"></a><span id="l34.833"> </span>
<a href="#l34.834"></a><span id="l34.834">   nsAutoString count2String;</span>
<a href="#l34.835"></a><span id="l34.835">   count2String.AppendInt(count2);</span>
<a href="#l34.836"></a><span id="l34.836"> </span>
<a href="#l34.837"></a><span id="l34.837" class="difflineminus">-  const char16_t *formatStrings[] = {</span>
<a href="#l34.838"></a><span id="l34.838" class="difflineminus">-    count1String.get(),</span>
<a href="#l34.839"></a><span id="l34.839" class="difflineminus">-    count2String.get()</span>
<a href="#l34.840"></a><span id="l34.840" class="difflineminus">-  };</span>
<a href="#l34.841"></a><span id="l34.841" class="difflineminus">-</span>
<a href="#l34.842"></a><span id="l34.842" class="difflineminus">-  return mLocalBundle-&gt;FormatStringFromName(NS_ConvertUTF16toUTF8(stringName).get(),</span>
<a href="#l34.843"></a><span id="l34.843" class="difflineminus">-                                            formatStrings, 2,</span>
<a href="#l34.844"></a><span id="l34.844" class="difflineminus">-                                            resultString);</span>
<a href="#l34.845"></a><span id="l34.845" class="difflineplus">+  const char16_t *formatStrings[] = {count1String.get(), count2String.get()};</span>
<a href="#l34.846"></a><span id="l34.846" class="difflineplus">+</span>
<a href="#l34.847"></a><span id="l34.847" class="difflineplus">+  return mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l34.848"></a><span id="l34.848" class="difflineplus">+      NS_ConvertUTF16toUTF8(stringName).get(), formatStrings, 2, resultString);</span>
<a href="#l34.849"></a><span id="l34.849"> }</span>
<a href="#l34.850"></a><span id="l34.850"> </span>
<a href="#l34.851"></a><span id="l34.851" class="difflineminus">-void nsPop3Protocol::UpdateStatus(const char *aStatusName)</span>
<a href="#l34.852"></a><span id="l34.852" class="difflineminus">-{</span>
<a href="#l34.853"></a><span id="l34.853" class="difflineplus">+void nsPop3Protocol::UpdateStatus(const char *aStatusName) {</span>
<a href="#l34.854"></a><span id="l34.854">   nsString statusMessage;</span>
<a href="#l34.855"></a><span id="l34.855">   mLocalBundle-&gt;GetStringFromName(aStatusName, statusMessage);</span>
<a href="#l34.856"></a><span id="l34.856">   UpdateStatusWithString(statusMessage.get());</span>
<a href="#l34.857"></a><span id="l34.857"> }</span>
<a href="#l34.858"></a><span id="l34.858"> </span>
<a href="#l34.859"></a><span id="l34.859" class="difflineminus">-void nsPop3Protocol::UpdateStatusWithString(const char16_t *aStatusString)</span>
<a href="#l34.860"></a><span id="l34.860" class="difflineminus">-{</span>
<a href="#l34.861"></a><span id="l34.861" class="difflineminus">-    if (mProgressEventSink)</span>
<a href="#l34.862"></a><span id="l34.862" class="difflineminus">-    {</span>
<a href="#l34.863"></a><span id="l34.863" class="difflineminus">-      mozilla::DebugOnly&lt;nsresult&gt; rv =</span>
<a href="#l34.864"></a><span id="l34.864" class="difflineminus">-        mProgressEventSink-&gt;OnStatus(this, m_channelContext,</span>
<a href="#l34.865"></a><span id="l34.865" class="difflineminus">-                                     NS_OK, aStatusString); // XXX i18n message</span>
<a href="#l34.866"></a><span id="l34.866" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;dropping error result&quot;);</span>
<a href="#l34.867"></a><span id="l34.867" class="difflineminus">-    }</span>
<a href="#l34.868"></a><span id="l34.868" class="difflineplus">+void nsPop3Protocol::UpdateStatusWithString(const char16_t *aStatusString) {</span>
<a href="#l34.869"></a><span id="l34.869" class="difflineplus">+  if (mProgressEventSink) {</span>
<a href="#l34.870"></a><span id="l34.870" class="difflineplus">+    mozilla::DebugOnly&lt;nsresult&gt; rv = mProgressEventSink-&gt;OnStatus(</span>
<a href="#l34.871"></a><span id="l34.871" class="difflineplus">+        this, m_channelContext, NS_OK, aStatusString);  // XXX i18n message</span>
<a href="#l34.872"></a><span id="l34.872" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;dropping error result&quot;);</span>
<a href="#l34.873"></a><span id="l34.873" class="difflineplus">+  }</span>
<a href="#l34.874"></a><span id="l34.874"> }</span>
<a href="#l34.875"></a><span id="l34.875"> </span>
<a href="#l34.876"></a><span id="l34.876" class="difflineminus">-void nsPop3Protocol::UpdateProgressPercent(int64_t totalDone, int64_t total)</span>
<a href="#l34.877"></a><span id="l34.877" class="difflineminus">-{</span>
<a href="#l34.878"></a><span id="l34.878" class="difflineplus">+void nsPop3Protocol::UpdateProgressPercent(int64_t totalDone, int64_t total) {</span>
<a href="#l34.879"></a><span id="l34.879">   if (mProgressEventSink)</span>
<a href="#l34.880"></a><span id="l34.880">     mProgressEventSink-&gt;OnProgress(this, m_channelContext, totalDone, total);</span>
<a href="#l34.881"></a><span id="l34.881"> }</span>
<a href="#l34.882"></a><span id="l34.882"> </span>
<a href="#l34.883"></a><span id="l34.883"> // note:  SetUsername() expects an unescaped string</span>
<a href="#l34.884"></a><span id="l34.884"> // do not pass in an escaped string</span>
<a href="#l34.885"></a><span id="l34.885" class="difflineminus">-void nsPop3Protocol::SetUsername(const char* name)</span>
<a href="#l34.886"></a><span id="l34.886" class="difflineminus">-{</span>
<a href="#l34.887"></a><span id="l34.887" class="difflineplus">+void nsPop3Protocol::SetUsername(const char *name) {</span>
<a href="#l34.888"></a><span id="l34.888">   NS_ASSERTION(name, &quot;no name specified!&quot;);</span>
<a href="#l34.889"></a><span id="l34.889" class="difflineminus">-    if (name)</span>
<a href="#l34.890"></a><span id="l34.890" class="difflineminus">-      m_username = name;</span>
<a href="#l34.891"></a><span id="l34.891" class="difflineplus">+  if (name) m_username = name;</span>
<a href="#l34.892"></a><span id="l34.892"> }</span>
<a href="#l34.893"></a><span id="l34.893"> </span>
<a href="#l34.894"></a><span id="l34.894" class="difflineminus">-nsresult nsPop3Protocol::RerunUrl()</span>
<a href="#l34.895"></a><span id="l34.895" class="difflineminus">-{</span>
<a href="#l34.896"></a><span id="l34.896" class="difflineplus">+nsresult nsPop3Protocol::RerunUrl() {</span>
<a href="#l34.897"></a><span id="l34.897">   ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.898"></a><span id="l34.898">   m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l34.899"></a><span id="l34.899">   Cleanup();</span>
<a href="#l34.900"></a><span id="l34.900">   return LoadUrl(m_url, nullptr);</span>
<a href="#l34.901"></a><span id="l34.901"> }</span>
<a href="#l34.902"></a><span id="l34.902"> </span>
<a href="#l34.903"></a><span id="l34.903" class="difflineminus">-Pop3StatesEnum nsPop3Protocol::GetNextPasswordObtainState()</span>
<a href="#l34.904"></a><span id="l34.904" class="difflineminus">-{</span>
<a href="#l34.905"></a><span id="l34.905" class="difflineminus">-  switch (m_pop3ConData-&gt;next_state)</span>
<a href="#l34.906"></a><span id="l34.906" class="difflineminus">-  {</span>
<a href="#l34.907"></a><span id="l34.907" class="difflineminus">-  case POP3_OBTAIN_PASSWORD_EARLY:</span>
<a href="#l34.908"></a><span id="l34.908" class="difflineminus">-    return POP3_FINISH_OBTAIN_PASSWORD_EARLY;</span>
<a href="#l34.909"></a><span id="l34.909" class="difflineminus">-  case POP3_SEND_USERNAME:</span>
<a href="#l34.910"></a><span id="l34.910" class="difflineminus">-  case POP3_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l34.911"></a><span id="l34.911" class="difflineminus">-    return POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME;</span>
<a href="#l34.912"></a><span id="l34.912" class="difflineminus">-  case POP3_SEND_PASSWORD:</span>
<a href="#l34.913"></a><span id="l34.913" class="difflineminus">-  case POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD:</span>
<a href="#l34.914"></a><span id="l34.914" class="difflineminus">-    return POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD;</span>
<a href="#l34.915"></a><span id="l34.915" class="difflineminus">-  default:</span>
<a href="#l34.916"></a><span id="l34.916" class="difflineminus">-    // Should never get here.</span>
<a href="#l34.917"></a><span id="l34.917" class="difflineminus">-    MOZ_ASSERT_UNREACHABLE(&quot;Invalid next_state in GetNextPasswordObtainState&quot;);</span>
<a href="#l34.918"></a><span id="l34.918" class="difflineplus">+Pop3StatesEnum nsPop3Protocol::GetNextPasswordObtainState() {</span>
<a href="#l34.919"></a><span id="l34.919" class="difflineplus">+  switch (m_pop3ConData-&gt;next_state) {</span>
<a href="#l34.920"></a><span id="l34.920" class="difflineplus">+    case POP3_OBTAIN_PASSWORD_EARLY:</span>
<a href="#l34.921"></a><span id="l34.921" class="difflineplus">+      return POP3_FINISH_OBTAIN_PASSWORD_EARLY;</span>
<a href="#l34.922"></a><span id="l34.922" class="difflineplus">+    case POP3_SEND_USERNAME:</span>
<a href="#l34.923"></a><span id="l34.923" class="difflineplus">+    case POP3_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l34.924"></a><span id="l34.924" class="difflineplus">+      return POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME;</span>
<a href="#l34.925"></a><span id="l34.925" class="difflineplus">+    case POP3_SEND_PASSWORD:</span>
<a href="#l34.926"></a><span id="l34.926" class="difflineplus">+    case POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD:</span>
<a href="#l34.927"></a><span id="l34.927" class="difflineplus">+      return POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD;</span>
<a href="#l34.928"></a><span id="l34.928" class="difflineplus">+    default:</span>
<a href="#l34.929"></a><span id="l34.929" class="difflineplus">+      // Should never get here.</span>
<a href="#l34.930"></a><span id="l34.930" class="difflineplus">+      MOZ_ASSERT_UNREACHABLE(</span>
<a href="#l34.931"></a><span id="l34.931" class="difflineplus">+          &quot;Invalid next_state in GetNextPasswordObtainState&quot;);</span>
<a href="#l34.932"></a><span id="l34.932">   }</span>
<a href="#l34.933"></a><span id="l34.933">   return POP3_ERROR_DONE;</span>
<a href="#l34.934"></a><span id="l34.934"> }</span>
<a href="#l34.935"></a><span id="l34.935"> </span>
<a href="#l34.936"></a><span id="l34.936" class="difflineminus">-nsresult nsPop3Protocol::StartGetAsyncPassword(Pop3StatesEnum aNextState)</span>
<a href="#l34.937"></a><span id="l34.937" class="difflineminus">-{</span>
<a href="#l34.938"></a><span id="l34.938" class="difflineplus">+nsresult nsPop3Protocol::StartGetAsyncPassword(Pop3StatesEnum aNextState) {</span>
<a href="#l34.939"></a><span id="l34.939">   nsresult rv;</span>
<a href="#l34.940"></a><span id="l34.940"> </span>
<a href="#l34.941"></a><span id="l34.941">   // Try and avoid going async if possible - if we haven't got into a password</span>
<a href="#l34.942"></a><span id="l34.942">   // failure state and the server has a password stored for this session, then</span>
<a href="#l34.943"></a><span id="l34.943">   // use it.</span>
<a href="#l34.944"></a><span id="l34.944" class="difflineminus">-  if (!TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l34.945"></a><span id="l34.945" class="difflineminus">-  {</span>
<a href="#l34.946"></a><span id="l34.946" class="difflineplus">+  if (!TestFlag(POP3_PASSWORD_FAILED)) {</span>
<a href="#l34.947"></a><span id="l34.947">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l34.948"></a><span id="l34.948" class="difflineminus">-      do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l34.949"></a><span id="l34.949" class="difflineplus">+        do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l34.950"></a><span id="l34.950">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.951"></a><span id="l34.951"> </span>
<a href="#l34.952"></a><span id="l34.952">     rv = server-&gt;GetPassword(m_passwordResult);</span>
<a href="#l34.953"></a><span id="l34.953" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !m_passwordResult.IsEmpty())</span>
<a href="#l34.954"></a><span id="l34.954" class="difflineminus">-    {</span>
<a href="#l34.955"></a><span id="l34.955" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !m_passwordResult.IsEmpty()) {</span>
<a href="#l34.956"></a><span id="l34.956">       m_pop3ConData-&gt;next_state = GetNextPasswordObtainState();</span>
<a href="#l34.957"></a><span id="l34.957">       return NS_OK;</span>
<a href="#l34.958"></a><span id="l34.958">     }</span>
<a href="#l34.959"></a><span id="l34.959">   }</span>
<a href="#l34.960"></a><span id="l34.960"> </span>
<a href="#l34.961"></a><span id="l34.961">   // We're now going to need to do something that will end up with us either</span>
<a href="#l34.962"></a><span id="l34.962">   // poking the login manager or prompting the user. We need to ensure we only</span>
<a href="#l34.963"></a><span id="l34.963">   // do one prompt at a time (and login manager could cause a master password</span>
<a href="#l34.964"></a><span id="l34.964">   // prompt), so we need to use the async prompter.</span>
<a href="#l34.965"></a><span id="l34.965">   nsCOMPtr&lt;nsIMsgAsyncPrompter&gt; asyncPrompter =</span>
<a href="#l34.966"></a><span id="l34.966" class="difflineminus">-    do_GetService(NS_MSGASYNCPROMPTER_CONTRACTID, &amp;rv);</span>
<a href="#l34.967"></a><span id="l34.967" class="difflineplus">+      do_GetService(NS_MSGASYNCPROMPTER_CONTRACTID, &amp;rv);</span>
<a href="#l34.968"></a><span id="l34.968">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.969"></a><span id="l34.969"> </span>
<a href="#l34.970"></a><span id="l34.970">   m_pop3ConData-&gt;next_state = aNextState;</span>
<a href="#l34.971"></a><span id="l34.971"> </span>
<a href="#l34.972"></a><span id="l34.972">   // Although we're not actually pausing for a read, we'll do so anyway to let</span>
<a href="#l34.973"></a><span id="l34.973">   // the async prompt run. Once it is our turn again we'll call back into</span>
<a href="#l34.974"></a><span id="l34.974">   // ProcessProtocolState.</span>
<a href="#l34.975"></a><span id="l34.975">   m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.976"></a><span id="l34.976" class="difflineat">@@ -763,977 +661,896 @@ nsresult nsPop3Protocol::StartGetAsyncPa</span>
<a href="#l34.977"></a><span id="l34.977"> </span>
<a href="#l34.978"></a><span id="l34.978">   rv = asyncPrompter-&gt;QueueAsyncAuthPrompt(server, false, this);</span>
<a href="#l34.979"></a><span id="l34.979">   // Explicit NS_ENSURE_SUCCESS for debug purposes as errors tend to get</span>
<a href="#l34.980"></a><span id="l34.980">   // hidden.</span>
<a href="#l34.981"></a><span id="l34.981">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.982"></a><span id="l34.982">   return rv;</span>
<a href="#l34.983"></a><span id="l34.983"> }</span>
<a href="#l34.984"></a><span id="l34.984"> </span>
<a href="#l34.985"></a><span id="l34.985" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::OnPromptStartAsync(nsIMsgAsyncPromptCallback *aCallback)</span>
<a href="#l34.986"></a><span id="l34.986" class="difflineminus">-{</span>
<a href="#l34.987"></a><span id="l34.987" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::OnPromptStartAsync(</span>
<a href="#l34.988"></a><span id="l34.988" class="difflineplus">+    nsIMsgAsyncPromptCallback *aCallback) {</span>
<a href="#l34.989"></a><span id="l34.989">   bool result = false;</span>
<a href="#l34.990"></a><span id="l34.990">   OnPromptStart(&amp;result);</span>
<a href="#l34.991"></a><span id="l34.991">   return aCallback-&gt;OnAuthResult(result);</span>
<a href="#l34.992"></a><span id="l34.992"> }</span>
<a href="#l34.993"></a><span id="l34.993"> </span>
<a href="#l34.994"></a><span id="l34.994" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::OnPromptStart(bool *aResult)</span>
<a href="#l34.995"></a><span id="l34.995" class="difflineminus">-{</span>
<a href="#l34.996"></a><span id="l34.996" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::OnPromptStart(bool *aResult) {</span>
<a href="#l34.997"></a><span id="l34.997">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;OnPromptStart()&quot;)));</span>
<a href="#l34.998"></a><span id="l34.998"> </span>
<a href="#l34.999"></a><span id="l34.999">   *aResult = false;</span>
<a href="#l34.1000"></a><span id="l34.1000"> </span>
<a href="#l34.1001"></a><span id="l34.1001">   nsresult rv;</span>
<a href="#l34.1002"></a><span id="l34.1002">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l34.1003"></a><span id="l34.1003">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1004"></a><span id="l34.1004"> </span>
<a href="#l34.1005"></a><span id="l34.1005">   nsAutoString passwordResult;</span>
<a href="#l34.1006"></a><span id="l34.1006"> </span>
<a href="#l34.1007"></a><span id="l34.1007">   // pass the failed password into the password prompt so that</span>
<a href="#l34.1008"></a><span id="l34.1008">   // it will be pre-filled, in case it failed because of a</span>
<a href="#l34.1009"></a><span id="l34.1009">   // server problem and not because it was wrong.</span>
<a href="#l34.1010"></a><span id="l34.1010" class="difflineminus">-  if (!m_lastPasswordSent.IsEmpty())</span>
<a href="#l34.1011"></a><span id="l34.1011" class="difflineminus">-    passwordResult = m_lastPasswordSent;</span>
<a href="#l34.1012"></a><span id="l34.1012" class="difflineplus">+  if (!m_lastPasswordSent.IsEmpty()) passwordResult = m_lastPasswordSent;</span>
<a href="#l34.1013"></a><span id="l34.1013"> </span>
<a href="#l34.1014"></a><span id="l34.1014">   // Set up some items that we're going to need for the prompting.</span>
<a href="#l34.1015"></a><span id="l34.1015">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.1016"></a><span id="l34.1016">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.1017"></a><span id="l34.1017" class="difflineminus">-  if (mailnewsUrl)</span>
<a href="#l34.1018"></a><span id="l34.1018" class="difflineminus">-    mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.1019"></a><span id="l34.1019" class="difflineplus">+  if (mailnewsUrl) mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.1020"></a><span id="l34.1020"> </span>
<a href="#l34.1021"></a><span id="l34.1021">   nsCString userName;</span>
<a href="#l34.1022"></a><span id="l34.1022">   server-&gt;GetRealUsername(userName);</span>
<a href="#l34.1023"></a><span id="l34.1023"> </span>
<a href="#l34.1024"></a><span id="l34.1024">   nsCString hostName;</span>
<a href="#l34.1025"></a><span id="l34.1025">   server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.1026"></a><span id="l34.1026"> </span>
<a href="#l34.1027"></a><span id="l34.1027">   nsString accountName;</span>
<a href="#l34.1028"></a><span id="l34.1028">   server-&gt;GetPrettyName(accountName);</span>
<a href="#l34.1029"></a><span id="l34.1029"> </span>
<a href="#l34.1030"></a><span id="l34.1030">   nsString passwordPrompt;</span>
<a href="#l34.1031"></a><span id="l34.1031">   NS_ConvertUTF8toUTF16 userNameUTF16(userName);</span>
<a href="#l34.1032"></a><span id="l34.1032">   NS_ConvertUTF8toUTF16 hostNameUTF16(hostName);</span>
<a href="#l34.1033"></a><span id="l34.1033" class="difflineminus">-  const char16_t* passwordParams[] = { userNameUTF16.get(),</span>
<a href="#l34.1034"></a><span id="l34.1034" class="difflineminus">-                                       hostNameUTF16.get() };</span>
<a href="#l34.1035"></a><span id="l34.1035" class="difflineplus">+  const char16_t *passwordParams[] = {userNameUTF16.get(), hostNameUTF16.get()};</span>
<a href="#l34.1036"></a><span id="l34.1036"> </span>
<a href="#l34.1037"></a><span id="l34.1037">   // if the last prompt got us a bad password then show a special dialog</span>
<a href="#l34.1038"></a><span id="l34.1038" class="difflineminus">-  if (TestFlag(POP3_PASSWORD_FAILED))</span>
<a href="#l34.1039"></a><span id="l34.1039" class="difflineminus">-  {</span>
<a href="#l34.1040"></a><span id="l34.1040" class="difflineminus">-    // Biff case (no msgWindow) shouldn't cause prompts or passwords to get forgotten at all</span>
<a href="#l34.1041"></a><span id="l34.1041" class="difflineminus">-    // TODO shouldn't we skip the new password prompt below as well for biff? Just exit here?</span>
<a href="#l34.1042"></a><span id="l34.1042" class="difflineminus">-    if (msgWindow)</span>
<a href="#l34.1043"></a><span id="l34.1043" class="difflineminus">-    {</span>
<a href="#l34.1044"></a><span id="l34.1044" class="difflineplus">+  if (TestFlag(POP3_PASSWORD_FAILED)) {</span>
<a href="#l34.1045"></a><span id="l34.1045" class="difflineplus">+    // Biff case (no msgWindow) shouldn't cause prompts or passwords to get</span>
<a href="#l34.1046"></a><span id="l34.1046" class="difflineplus">+    // forgotten at all</span>
<a href="#l34.1047"></a><span id="l34.1047" class="difflineplus">+    // TODO shouldn't we skip the new password prompt below as well for biff?</span>
<a href="#l34.1048"></a><span id="l34.1048" class="difflineplus">+    // Just exit here?</span>
<a href="#l34.1049"></a><span id="l34.1049" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l34.1050"></a><span id="l34.1050">       MOZ_LOG(POP3LOGMODULE, LogLevel::Warning,</span>
<a href="#l34.1051"></a><span id="l34.1051" class="difflineminus">-              (POP3LOG(&quot;POP: ask user what to do (after password failed): new password, retry or cancel&quot;)));</span>
<a href="#l34.1052"></a><span id="l34.1052" class="difflineplus">+              (POP3LOG(&quot;POP: ask user what to do (after password failed): new &quot;</span>
<a href="#l34.1053"></a><span id="l34.1053" class="difflineplus">+                       &quot;password, retry or cancel&quot;)));</span>
<a href="#l34.1054"></a><span id="l34.1054"> </span>
<a href="#l34.1055"></a><span id="l34.1055">       int32_t buttonPressed = 0;</span>
<a href="#l34.1056"></a><span id="l34.1056" class="difflineminus">-      if (NS_SUCCEEDED(MsgPromptLoginFailed(msgWindow, hostName, userName, accountName,</span>
<a href="#l34.1057"></a><span id="l34.1057" class="difflineminus">-                                            &amp;buttonPressed)))</span>
<a href="#l34.1058"></a><span id="l34.1058" class="difflineminus">-      {</span>
<a href="#l34.1059"></a><span id="l34.1059" class="difflineminus">-        if (buttonPressed == 1) // Cancel button</span>
<a href="#l34.1060"></a><span id="l34.1060" class="difflineplus">+      if (NS_SUCCEEDED(MsgPromptLoginFailed(msgWindow, hostName, userName,</span>
<a href="#l34.1061"></a><span id="l34.1061" class="difflineplus">+                                            accountName, &amp;buttonPressed))) {</span>
<a href="#l34.1062"></a><span id="l34.1062" class="difflineplus">+        if (buttonPressed == 1)  // Cancel button</span>
<a href="#l34.1063"></a><span id="l34.1063">         {</span>
<a href="#l34.1064"></a><span id="l34.1064" class="difflineminus">-          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning, (POP3LOG(&quot;cancel button pressed&quot;)));</span>
<a href="#l34.1065"></a><span id="l34.1065" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning,</span>
<a href="#l34.1066"></a><span id="l34.1066" class="difflineplus">+                  (POP3LOG(&quot;cancel button pressed&quot;)));</span>
<a href="#l34.1067"></a><span id="l34.1067">           // Abort quickly and stop trying for now.</span>
<a href="#l34.1068"></a><span id="l34.1068"> </span>
<a href="#l34.1069"></a><span id="l34.1069">           // If we haven't actually connected yet (i.e. we're doing an early</span>
<a href="#l34.1070"></a><span id="l34.1070">           // attempt to get the username/password but we've previously failed</span>
<a href="#l34.1071"></a><span id="l34.1071">           // for some reason), then skip straight to POP3_FREE as it isn't an</span>
<a href="#l34.1072"></a><span id="l34.1072">           // error in this connection, and just ends up with us closing the</span>
<a href="#l34.1073"></a><span id="l34.1073">           // socket and saying we've aborted the bind. Otherwise, pretend this</span>
<a href="#l34.1074"></a><span id="l34.1074">           // is an error and move on.</span>
<a href="#l34.1075"></a><span id="l34.1075">           m_pop3ConData-&gt;next_state =</span>
<a href="#l34.1076"></a><span id="l34.1076" class="difflineminus">-            m_pop3ConData-&gt;next_state == POP3_OBTAIN_PASSWORD_EARLY ?</span>
<a href="#l34.1077"></a><span id="l34.1077" class="difflineminus">-                                         POP3_FREE : POP3_ERROR_DONE;</span>
<a href="#l34.1078"></a><span id="l34.1078" class="difflineplus">+              m_pop3ConData-&gt;next_state == POP3_OBTAIN_PASSWORD_EARLY</span>
<a href="#l34.1079"></a><span id="l34.1079" class="difflineplus">+                  ? POP3_FREE</span>
<a href="#l34.1080"></a><span id="l34.1080" class="difflineplus">+                  : POP3_ERROR_DONE;</span>
<a href="#l34.1081"></a><span id="l34.1081"> </span>
<a href="#l34.1082"></a><span id="l34.1082">           // Clear the password we're going to return to force failure in</span>
<a href="#l34.1083"></a><span id="l34.1083">           // the get mail instance.</span>
<a href="#l34.1084"></a><span id="l34.1084">           passwordResult.Truncate();</span>
<a href="#l34.1085"></a><span id="l34.1085"> </span>
<a href="#l34.1086"></a><span id="l34.1086">           // We also have to clear the password failed flag, otherwise we'll</span>
<a href="#l34.1087"></a><span id="l34.1087">           // automatically try again.</span>
<a href="#l34.1088"></a><span id="l34.1088">           ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.1089"></a><span id="l34.1089"> </span>
<a href="#l34.1090"></a><span id="l34.1090">           // As we're async, calling ProcessProtocolState gets things going</span>
<a href="#l34.1091"></a><span id="l34.1091">           // again.</span>
<a href="#l34.1092"></a><span id="l34.1092">           ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l34.1093"></a><span id="l34.1093">           return NS_OK;</span>
<a href="#l34.1094"></a><span id="l34.1094" class="difflineminus">-        }</span>
<a href="#l34.1095"></a><span id="l34.1095" class="difflineminus">-        else if (buttonPressed == 2) // &quot;New password&quot; button</span>
<a href="#l34.1096"></a><span id="l34.1096" class="difflineplus">+        } else if (buttonPressed == 2)  // &quot;New password&quot; button</span>
<a href="#l34.1097"></a><span id="l34.1097">         {</span>
<a href="#l34.1098"></a><span id="l34.1098" class="difflineminus">-          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning, (POP3LOG(&quot;new password button pressed&quot;)));</span>
<a href="#l34.1099"></a><span id="l34.1099" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning,</span>
<a href="#l34.1100"></a><span id="l34.1100" class="difflineplus">+                  (POP3LOG(&quot;new password button pressed&quot;)));</span>
<a href="#l34.1101"></a><span id="l34.1101">           // Forget the stored password</span>
<a href="#l34.1102"></a><span id="l34.1102">           // and we'll prompt for a new one next time around.</span>
<a href="#l34.1103"></a><span id="l34.1103">           rv = server-&gt;ForgetPassword();</span>
<a href="#l34.1104"></a><span id="l34.1104">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1105"></a><span id="l34.1105"> </span>
<a href="#l34.1106"></a><span id="l34.1106">           // try all methods again with new password</span>
<a href="#l34.1107"></a><span id="l34.1107">           ResetAuthMethods();</span>
<a href="#l34.1108"></a><span id="l34.1108">           // ... apart from GSSAPI, which doesn't care about passwords</span>
<a href="#l34.1109"></a><span id="l34.1109">           MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.1110"></a><span id="l34.1110" class="difflineminus">-          if (m_needToRerunUrl)</span>
<a href="#l34.1111"></a><span id="l34.1111" class="difflineminus">-            return RerunUrl();</span>
<a href="#l34.1112"></a><span id="l34.1112" class="difflineminus">-        }</span>
<a href="#l34.1113"></a><span id="l34.1113" class="difflineminus">-        else if (buttonPressed == 0) // &quot;Retry&quot; button</span>
<a href="#l34.1114"></a><span id="l34.1114" class="difflineplus">+          if (m_needToRerunUrl) return RerunUrl();</span>
<a href="#l34.1115"></a><span id="l34.1115" class="difflineplus">+        } else if (buttonPressed == 0)  // &quot;Retry&quot; button</span>
<a href="#l34.1116"></a><span id="l34.1116">         {</span>
<a href="#l34.1117"></a><span id="l34.1117" class="difflineminus">-          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning, (POP3LOG(&quot;retry button pressed&quot;)));</span>
<a href="#l34.1118"></a><span id="l34.1118" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Warning,</span>
<a href="#l34.1119"></a><span id="l34.1119" class="difflineplus">+                  (POP3LOG(&quot;retry button pressed&quot;)));</span>
<a href="#l34.1120"></a><span id="l34.1120">           // try all methods again, including GSSAPI</span>
<a href="#l34.1121"></a><span id="l34.1121">           ResetAuthMethods();</span>
<a href="#l34.1122"></a><span id="l34.1122" class="difflineminus">-          ClearFlag(POP3_PASSWORD_FAILED|POP3_AUTH_FAILURE);</span>
<a href="#l34.1123"></a><span id="l34.1123" class="difflineminus">-</span>
<a href="#l34.1124"></a><span id="l34.1124" class="difflineminus">-          if (m_needToRerunUrl)</span>
<a href="#l34.1125"></a><span id="l34.1125" class="difflineminus">-            return RerunUrl();</span>
<a href="#l34.1126"></a><span id="l34.1126" class="difflineplus">+          ClearFlag(POP3_PASSWORD_FAILED | POP3_AUTH_FAILURE);</span>
<a href="#l34.1127"></a><span id="l34.1127" class="difflineplus">+</span>
<a href="#l34.1128"></a><span id="l34.1128" class="difflineplus">+          if (m_needToRerunUrl) return RerunUrl();</span>
<a href="#l34.1129"></a><span id="l34.1129"> </span>
<a href="#l34.1130"></a><span id="l34.1130">           // It is a bit strange that we're going onto the next state that</span>
<a href="#l34.1131"></a><span id="l34.1131">           // would essentially send the password. However in resetting the</span>
<a href="#l34.1132"></a><span id="l34.1132">           // auth methods above, we're setting up SendUsername, SendPassword</span>
<a href="#l34.1133"></a><span id="l34.1133">           // and friends to abort and return to the POP3_SEND_CAPA state.</span>
<a href="#l34.1134"></a><span id="l34.1134">           // Hence we can do this safely.</span>
<a href="#l34.1135"></a><span id="l34.1135">           m_pop3ConData-&gt;next_state = GetNextPasswordObtainState();</span>
<a href="#l34.1136"></a><span id="l34.1136">           // As we're async, calling ProcessProtocolState gets things going</span>
<a href="#l34.1137"></a><span id="l34.1137">           // again.</span>
<a href="#l34.1138"></a><span id="l34.1138">           ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l34.1139"></a><span id="l34.1139">           return NS_OK;</span>
<a href="#l34.1140"></a><span id="l34.1140">         }</span>
<a href="#l34.1141"></a><span id="l34.1141">       }</span>
<a href="#l34.1142"></a><span id="l34.1142">     }</span>
<a href="#l34.1143"></a><span id="l34.1143">     mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l34.1144"></a><span id="l34.1144" class="difflineminus">-      &quot;pop3PreviouslyEnteredPasswordIsInvalidPrompt&quot;,</span>
<a href="#l34.1145"></a><span id="l34.1145" class="difflineminus">-      passwordParams, 2, passwordPrompt);</span>
<a href="#l34.1146"></a><span id="l34.1146" class="difflineminus">-  }</span>
<a href="#l34.1147"></a><span id="l34.1147" class="difflineminus">-  else</span>
<a href="#l34.1148"></a><span id="l34.1148" class="difflineplus">+        &quot;pop3PreviouslyEnteredPasswordIsInvalidPrompt&quot;, passwordParams, 2,</span>
<a href="#l34.1149"></a><span id="l34.1149" class="difflineplus">+        passwordPrompt);</span>
<a href="#l34.1150"></a><span id="l34.1150" class="difflineplus">+  } else</span>
<a href="#l34.1151"></a><span id="l34.1151">     // Otherwise this is the first time we've asked about the server's</span>
<a href="#l34.1152"></a><span id="l34.1152">     // password so show a first time prompt.</span>
<a href="#l34.1153"></a><span id="l34.1153" class="difflineminus">-    mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l34.1154"></a><span id="l34.1154" class="difflineminus">-      &quot;pop3EnterPasswordPrompt&quot;,</span>
<a href="#l34.1155"></a><span id="l34.1155" class="difflineminus">-      passwordParams, 2, passwordPrompt);</span>
<a href="#l34.1156"></a><span id="l34.1156" class="difflineplus">+    mLocalBundle-&gt;FormatStringFromName(&quot;pop3EnterPasswordPrompt&quot;,</span>
<a href="#l34.1157"></a><span id="l34.1157" class="difflineplus">+                                       passwordParams, 2, passwordPrompt);</span>
<a href="#l34.1158"></a><span id="l34.1158"> </span>
<a href="#l34.1159"></a><span id="l34.1159">   nsString passwordTitle;</span>
<a href="#l34.1160"></a><span id="l34.1160" class="difflineminus">-  mLocalBundle-&gt;GetStringFromName(</span>
<a href="#l34.1161"></a><span id="l34.1161" class="difflineminus">-    &quot;pop3EnterPasswordPromptTitle&quot;,</span>
<a href="#l34.1162"></a><span id="l34.1162" class="difflineminus">-    passwordTitle);</span>
<a href="#l34.1163"></a><span id="l34.1163" class="difflineplus">+  mLocalBundle-&gt;GetStringFromName(&quot;pop3EnterPasswordPromptTitle&quot;,</span>
<a href="#l34.1164"></a><span id="l34.1164" class="difflineplus">+                                  passwordTitle);</span>
<a href="#l34.1165"></a><span id="l34.1165"> </span>
<a href="#l34.1166"></a><span id="l34.1166">   // Now go and get the password.</span>
<a href="#l34.1167"></a><span id="l34.1167">   if (!passwordPrompt.IsEmpty() &amp;&amp; !passwordTitle.IsEmpty())</span>
<a href="#l34.1168"></a><span id="l34.1168" class="difflineminus">-    rv = server-&gt;GetPasswordWithUI(passwordPrompt, passwordTitle,</span>
<a href="#l34.1169"></a><span id="l34.1169" class="difflineminus">-                                    msgWindow, passwordResult);</span>
<a href="#l34.1170"></a><span id="l34.1170" class="difflineminus">-  ClearFlag(POP3_PASSWORD_FAILED|POP3_AUTH_FAILURE);</span>
<a href="#l34.1171"></a><span id="l34.1171" class="difflineplus">+    rv = server-&gt;GetPasswordWithUI(passwordPrompt, passwordTitle, msgWindow,</span>
<a href="#l34.1172"></a><span id="l34.1172" class="difflineplus">+                                   passwordResult);</span>
<a href="#l34.1173"></a><span id="l34.1173" class="difflineplus">+  ClearFlag(POP3_PASSWORD_FAILED | POP3_AUTH_FAILURE);</span>
<a href="#l34.1174"></a><span id="l34.1174"> </span>
<a href="#l34.1175"></a><span id="l34.1175">   // If it failed or the user cancelled the prompt, just abort the</span>
<a href="#l34.1176"></a><span id="l34.1176">   // connection.</span>
<a href="#l34.1177"></a><span id="l34.1177" class="difflineminus">-  if (NS_FAILED(rv) ||</span>
<a href="#l34.1178"></a><span id="l34.1178" class="difflineminus">-      rv == NS_MSG_PASSWORD_PROMPT_CANCELLED)</span>
<a href="#l34.1179"></a><span id="l34.1179" class="difflineminus">-  {</span>
<a href="#l34.1180"></a><span id="l34.1180" class="difflineplus">+  if (NS_FAILED(rv) || rv == NS_MSG_PASSWORD_PROMPT_CANCELLED) {</span>
<a href="#l34.1181"></a><span id="l34.1181">     m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.1182"></a><span id="l34.1182">     m_passwordResult.Truncate();</span>
<a href="#l34.1183"></a><span id="l34.1183">     *aResult = false;</span>
<a href="#l34.1184"></a><span id="l34.1184" class="difflineminus">-  }</span>
<a href="#l34.1185"></a><span id="l34.1185" class="difflineminus">-  else</span>
<a href="#l34.1186"></a><span id="l34.1186" class="difflineminus">-  {</span>
<a href="#l34.1187"></a><span id="l34.1187" class="difflineplus">+  } else {</span>
<a href="#l34.1188"></a><span id="l34.1188">     m_passwordResult = passwordResult;</span>
<a href="#l34.1189"></a><span id="l34.1189">     m_pop3ConData-&gt;next_state = GetNextPasswordObtainState();</span>
<a href="#l34.1190"></a><span id="l34.1190">     *aResult = true;</span>
<a href="#l34.1191"></a><span id="l34.1191">   }</span>
<a href="#l34.1192"></a><span id="l34.1192">   // Because this was done asynchronously, now call back into</span>
<a href="#l34.1193"></a><span id="l34.1193">   // ProcessProtocolState to get the protocol going again.</span>
<a href="#l34.1194"></a><span id="l34.1194">   ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l34.1195"></a><span id="l34.1195">   return NS_OK;</span>
<a href="#l34.1196"></a><span id="l34.1196"> }</span>
<a href="#l34.1197"></a><span id="l34.1197"> </span>
<a href="#l34.1198"></a><span id="l34.1198" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::OnPromptAuthAvailable()</span>
<a href="#l34.1199"></a><span id="l34.1199" class="difflineminus">-{</span>
<a href="#l34.1200"></a><span id="l34.1200" class="difflineminus">-  MOZ_ASSERT_UNREACHABLE(&quot;Did not expect to get POP3 protocol queuing up auth &quot;</span>
<a href="#l34.1201"></a><span id="l34.1201" class="difflineminus">-                &quot;connections for same server&quot;);</span>
<a href="#l34.1202"></a><span id="l34.1202" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::OnPromptAuthAvailable() {</span>
<a href="#l34.1203"></a><span id="l34.1203" class="difflineplus">+  MOZ_ASSERT_UNREACHABLE(</span>
<a href="#l34.1204"></a><span id="l34.1204" class="difflineplus">+      &quot;Did not expect to get POP3 protocol queuing up auth &quot;</span>
<a href="#l34.1205"></a><span id="l34.1205" class="difflineplus">+      &quot;connections for same server&quot;);</span>
<a href="#l34.1206"></a><span id="l34.1206">   return NS_OK;</span>
<a href="#l34.1207"></a><span id="l34.1207"> }</span>
<a href="#l34.1208"></a><span id="l34.1208"> </span>
<a href="#l34.1209"></a><span id="l34.1209" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::OnPromptCanceled()</span>
<a href="#l34.1210"></a><span id="l34.1210" class="difflineminus">-{</span>
<a href="#l34.1211"></a><span id="l34.1211" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::OnPromptCanceled() {</span>
<a href="#l34.1212"></a><span id="l34.1212">   // A prompt was cancelled, so just abort out the connection</span>
<a href="#l34.1213"></a><span id="l34.1213">   m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.1214"></a><span id="l34.1214">   // As we're async, calling ProcessProtocolState gets things going again.</span>
<a href="#l34.1215"></a><span id="l34.1215">   ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l34.1216"></a><span id="l34.1216">   return NS_OK;</span>
<a href="#l34.1217"></a><span id="l34.1217"> }</span>
<a href="#l34.1218"></a><span id="l34.1218"> </span>
<a href="#l34.1219"></a><span id="l34.1219" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::OnTransportStatus(nsITransport *aTransport, nsresult aStatus, int64_t aProgress, int64_t aProgressMax)</span>
<a href="#l34.1220"></a><span id="l34.1220" class="difflineminus">-{</span>
<a href="#l34.1221"></a><span id="l34.1221" class="difflineminus">-  return nsMsgProtocol::OnTransportStatus(aTransport, aStatus, aProgress, aProgressMax);</span>
<a href="#l34.1222"></a><span id="l34.1222" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::OnTransportStatus(nsITransport *aTransport,</span>
<a href="#l34.1223"></a><span id="l34.1223" class="difflineplus">+                                                nsresult aStatus,</span>
<a href="#l34.1224"></a><span id="l34.1224" class="difflineplus">+                                                int64_t aProgress,</span>
<a href="#l34.1225"></a><span id="l34.1225" class="difflineplus">+                                                int64_t aProgressMax) {</span>
<a href="#l34.1226"></a><span id="l34.1226" class="difflineplus">+  return nsMsgProtocol::OnTransportStatus(aTransport, aStatus, aProgress,</span>
<a href="#l34.1227"></a><span id="l34.1227" class="difflineplus">+                                          aProgressMax);</span>
<a href="#l34.1228"></a><span id="l34.1228"> }</span>
<a href="#l34.1229"></a><span id="l34.1229"> </span>
<a href="#l34.1230"></a><span id="l34.1230" class="difflineminus">-// stop binding is a &quot;notification&quot; informing us that the stream associated with aURL is going away.</span>
<a href="#l34.1231"></a><span id="l34.1231" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::OnStopRequest(nsIRequest *aRequest, nsresult aStatus)</span>
<a href="#l34.1232"></a><span id="l34.1232" class="difflineminus">-{</span>
<a href="#l34.1233"></a><span id="l34.1233" class="difflineplus">+// stop binding is a &quot;notification&quot; informing us that the stream associated with</span>
<a href="#l34.1234"></a><span id="l34.1234" class="difflineplus">+// aURL is going away.</span>
<a href="#l34.1235"></a><span id="l34.1235" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::OnStopRequest(nsIRequest *aRequest,</span>
<a href="#l34.1236"></a><span id="l34.1236" class="difflineplus">+                                            nsresult aStatus) {</span>
<a href="#l34.1237"></a><span id="l34.1237">   // If the server dropped the connection, m_socketIsOpen will be true, before</span>
<a href="#l34.1238"></a><span id="l34.1238">   // we call nsMsgProtocol::OnStopRequest. The call will force a close socket,</span>
<a href="#l34.1239"></a><span id="l34.1239">   // but we still want to go through the state machine one more time to cleanup</span>
<a href="#l34.1240"></a><span id="l34.1240">   // the protocol object.</span>
<a href="#l34.1241"></a><span id="l34.1241" class="difflineminus">-  if (m_socketIsOpen)</span>
<a href="#l34.1242"></a><span id="l34.1242" class="difflineminus">-  {</span>
<a href="#l34.1243"></a><span id="l34.1243" class="difflineplus">+  if (m_socketIsOpen) {</span>
<a href="#l34.1244"></a><span id="l34.1244">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(m_url);</span>
<a href="#l34.1245"></a><span id="l34.1245"> </span>
<a href="#l34.1246"></a><span id="l34.1246">     // Check if the connection was dropped before getting back an auth error.</span>
<a href="#l34.1247"></a><span id="l34.1247">     // If we got the auth error, the next state would be</span>
<a href="#l34.1248"></a><span id="l34.1248">     // POP3_OBTAIN_PASSWORD_EARLY.</span>
<a href="#l34.1249"></a><span id="l34.1249">     if ((m_pop3ConData-&gt;next_state_after_response == POP3_NEXT_AUTH_STEP ||</span>
<a href="#l34.1250"></a><span id="l34.1250" class="difflineminus">-         m_pop3ConData-&gt;next_state_after_response == POP3_AUTH_LOGIN_RESPONSE) &amp;&amp;</span>
<a href="#l34.1251"></a><span id="l34.1251" class="difflineminus">-        m_pop3ConData-&gt;next_state != POP3_OBTAIN_PASSWORD_EARLY)</span>
<a href="#l34.1252"></a><span id="l34.1252" class="difflineminus">-    {</span>
<a href="#l34.1253"></a><span id="l34.1253" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;dropped connection before auth error&quot;)));</span>
<a href="#l34.1254"></a><span id="l34.1254" class="difflineplus">+         m_pop3ConData-&gt;next_state_after_response ==</span>
<a href="#l34.1255"></a><span id="l34.1255" class="difflineplus">+             POP3_AUTH_LOGIN_RESPONSE) &amp;&amp;</span>
<a href="#l34.1256"></a><span id="l34.1256" class="difflineplus">+        m_pop3ConData-&gt;next_state != POP3_OBTAIN_PASSWORD_EARLY) {</span>
<a href="#l34.1257"></a><span id="l34.1257" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.1258"></a><span id="l34.1258" class="difflineplus">+              (POP3LOG(&quot;dropped connection before auth error&quot;)));</span>
<a href="#l34.1259"></a><span id="l34.1259">       SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l34.1260"></a><span id="l34.1260">       m_pop3ConData-&gt;command_succeeded = false;</span>
<a href="#l34.1261"></a><span id="l34.1261">       m_needToRerunUrl = true;</span>
<a href="#l34.1262"></a><span id="l34.1262">       m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.1263"></a><span id="l34.1263">       ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l34.1264"></a><span id="l34.1264">     }</span>
<a href="#l34.1265"></a><span id="l34.1265">     // We can't call nsMsgProtocol::OnStopRequest because it calls SetUrlState,</span>
<a href="#l34.1266"></a><span id="l34.1266">     // which notifies the URLListeners, but we need to do a bit of cleanup</span>
<a href="#l34.1267"></a><span id="l34.1267">     // before running the url again.</span>
<a href="#l34.1268"></a><span id="l34.1268">     CloseSocket();</span>
<a href="#l34.1269"></a><span id="l34.1269">     if (m_loadGroup)</span>
<a href="#l34.1270"></a><span id="l34.1270" class="difflineminus">-      m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr, aStatus);</span>
<a href="#l34.1271"></a><span id="l34.1271" class="difflineplus">+      m_loadGroup-&gt;RemoveRequest(static_cast&lt;nsIRequest *&gt;(this), nullptr,</span>
<a href="#l34.1272"></a><span id="l34.1272" class="difflineplus">+                                 aStatus);</span>
<a href="#l34.1273"></a><span id="l34.1273">     m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.1274"></a><span id="l34.1274">     ProcessProtocolState(nullptr, nullptr, 0, 0);</span>
<a href="#l34.1275"></a><span id="l34.1275"> </span>
<a href="#l34.1276"></a><span id="l34.1276">     if (NS_FAILED(aStatus) &amp;&amp; aStatus != NS_BINDING_ABORTED)</span>
<a href="#l34.1277"></a><span id="l34.1277">       nsMsgProtocol::ShowAlertMessage(msgUrl, aStatus);</span>
<a href="#l34.1278"></a><span id="l34.1278"> </span>
<a href="#l34.1279"></a><span id="l34.1279">     return NS_OK;</span>
<a href="#l34.1280"></a><span id="l34.1280">   }</span>
<a href="#l34.1281"></a><span id="l34.1281">   nsresult rv = nsMsgProtocol::OnStopRequest(aRequest, aStatus);</span>
<a href="#l34.1282"></a><span id="l34.1282"> </span>
<a href="#l34.1283"></a><span id="l34.1283">   // turn off the server busy flag on stop request - we know we're done, right?</span>
<a href="#l34.1284"></a><span id="l34.1284">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1285"></a><span id="l34.1285" class="difflineminus">-  if (server)</span>
<a href="#l34.1286"></a><span id="l34.1286" class="difflineminus">-  {</span>
<a href="#l34.1287"></a><span id="l34.1287" class="difflineplus">+  if (server) {</span>
<a href="#l34.1288"></a><span id="l34.1288">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.1289"></a><span id="l34.1289">             (POP3LOG(&quot;Clearing server busy in nsPop3Protocol::OnStopRequest&quot;)));</span>
<a href="#l34.1290"></a><span id="l34.1290" class="difflineminus">-    server-&gt;SetServerBusy(false); // the server is not busy</span>
<a href="#l34.1291"></a><span id="l34.1291" class="difflineplus">+    server-&gt;SetServerBusy(false);  // the server is not busy</span>
<a href="#l34.1292"></a><span id="l34.1292">   }</span>
<a href="#l34.1293"></a><span id="l34.1293" class="difflineminus">-  if(m_pop3ConData-&gt;list_done)</span>
<a href="#l34.1294"></a><span id="l34.1294" class="difflineminus">-    CommitState(true);</span>
<a href="#l34.1295"></a><span id="l34.1295" class="difflineminus">-  if (NS_FAILED(aStatus) &amp;&amp; aStatus != NS_BINDING_ABORTED)</span>
<a href="#l34.1296"></a><span id="l34.1296" class="difflineminus">-    Abort();</span>
<a href="#l34.1297"></a><span id="l34.1297" class="difflineplus">+  if (m_pop3ConData-&gt;list_done) CommitState(true);</span>
<a href="#l34.1298"></a><span id="l34.1298" class="difflineplus">+  if (NS_FAILED(aStatus) &amp;&amp; aStatus != NS_BINDING_ABORTED) Abort();</span>
<a href="#l34.1299"></a><span id="l34.1299">   return rv;</span>
<a href="#l34.1300"></a><span id="l34.1300"> }</span>
<a href="#l34.1301"></a><span id="l34.1301"> </span>
<a href="#l34.1302"></a><span id="l34.1302" class="difflineminus">-void nsPop3Protocol::Abort()</span>
<a href="#l34.1303"></a><span id="l34.1303" class="difflineminus">-{</span>
<a href="#l34.1304"></a><span id="l34.1304" class="difflineplus">+void nsPop3Protocol::Abort() {</span>
<a href="#l34.1305"></a><span id="l34.1305">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;Abort&quot;)));</span>
<a href="#l34.1306"></a><span id="l34.1306"> </span>
<a href="#l34.1307"></a><span id="l34.1307" class="difflineminus">-  if(m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.1308"></a><span id="l34.1308" class="difflineminus">-  {</span>
<a href="#l34.1309"></a><span id="l34.1309" class="difflineminus">-      m_nsIPop3Sink-&gt;IncorporateAbort(m_pop3ConData-&gt;only_uidl != nullptr);</span>
<a href="#l34.1310"></a><span id="l34.1310" class="difflineminus">-      m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l34.1311"></a><span id="l34.1311" class="difflineplus">+  if (m_pop3ConData-&gt;msg_closure) {</span>
<a href="#l34.1312"></a><span id="l34.1312" class="difflineplus">+    m_nsIPop3Sink-&gt;IncorporateAbort(m_pop3ConData-&gt;only_uidl != nullptr);</span>
<a href="#l34.1313"></a><span id="l34.1313" class="difflineplus">+    m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l34.1314"></a><span id="l34.1314">   }</span>
<a href="#l34.1315"></a><span id="l34.1315">   // Need this to close the stream on the inbox. It's possible that</span>
<a href="#l34.1316"></a><span id="l34.1316">   // we abort before the POP3 sink was set.</span>
<a href="#l34.1317"></a><span id="l34.1317" class="difflineminus">-  if (m_nsIPop3Sink)</span>
<a href="#l34.1318"></a><span id="l34.1318" class="difflineminus">-    m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.1319"></a><span id="l34.1319" class="difflineplus">+  if (m_nsIPop3Sink) m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.1320"></a><span id="l34.1320">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.1321"></a><span id="l34.1321">           (POP3LOG(&quot;Clearing running protocol in nsPop3Protocol::Abort()&quot;)));</span>
<a href="#l34.1322"></a><span id="l34.1322" class="difflineminus">-  if (m_pop3Server)</span>
<a href="#l34.1323"></a><span id="l34.1323" class="difflineminus">-    m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l34.1324"></a><span id="l34.1324" class="difflineplus">+  if (m_pop3Server) m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l34.1325"></a><span id="l34.1325"> }</span>
<a href="#l34.1326"></a><span id="l34.1326"> </span>
<a href="#l34.1327"></a><span id="l34.1327"> NS_IMETHODIMP nsPop3Protocol::Cancel(nsresult status)  // handle stop button</span>
<a href="#l34.1328"></a><span id="l34.1328"> {</span>
<a href="#l34.1329"></a><span id="l34.1329" class="difflineminus">-  if (m_proxyRequest)</span>
<a href="#l34.1330"></a><span id="l34.1330" class="difflineminus">-  {</span>
<a href="#l34.1331"></a><span id="l34.1331" class="difflineplus">+  if (m_proxyRequest) {</span>
<a href="#l34.1332"></a><span id="l34.1332">     m_proxyRequest-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l34.1333"></a><span id="l34.1333"> </span>
<a href="#l34.1334"></a><span id="l34.1334">     // Note that nsMsgProtocol::Cancel() also calls</span>
<a href="#l34.1335"></a><span id="l34.1335">     // nsProtocolProxyService::Cancel(), so no need to call it twice</span>
<a href="#l34.1336"></a><span id="l34.1336">     // (although it self-protects against multiple calls).</span>
<a href="#l34.1337"></a><span id="l34.1337">     m_proxyRequest = nullptr;</span>
<a href="#l34.1338"></a><span id="l34.1338">   }</span>
<a href="#l34.1339"></a><span id="l34.1339"> </span>
<a href="#l34.1340"></a><span id="l34.1340">   Abort();</span>
<a href="#l34.1341"></a><span id="l34.1341">   return nsMsgProtocol::Cancel(NS_BINDING_ABORTED);</span>
<a href="#l34.1342"></a><span id="l34.1342"> }</span>
<a href="#l34.1343"></a><span id="l34.1343"> </span>
<a href="#l34.1344"></a><span id="l34.1344" class="difflineminus">-</span>
<a href="#l34.1345"></a><span id="l34.1345" class="difflineminus">-nsresult nsPop3Protocol::LoadUrl(nsIURI* aURL, nsISupports * /* aConsumer */)</span>
<a href="#l34.1346"></a><span id="l34.1346" class="difflineminus">-{</span>
<a href="#l34.1347"></a><span id="l34.1347" class="difflineplus">+nsresult nsPop3Protocol::LoadUrl(nsIURI *aURL, nsISupports * /* aConsumer */) {</span>
<a href="#l34.1348"></a><span id="l34.1348">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;LoadUrl()&quot;)));</span>
<a href="#l34.1349"></a><span id="l34.1349"> </span>
<a href="#l34.1350"></a><span id="l34.1350">   nsresult rv = Initialize(aURL);</span>
<a href="#l34.1351"></a><span id="l34.1351">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1352"></a><span id="l34.1352"> </span>
<a href="#l34.1353"></a><span id="l34.1353" class="difflineminus">-  if (aURL)</span>
<a href="#l34.1354"></a><span id="l34.1354" class="difflineminus">-  {</span>
<a href="#l34.1355"></a><span id="l34.1355" class="difflineplus">+  if (aURL) {</span>
<a href="#l34.1356"></a><span id="l34.1356">     rv = MsgExamineForProxyAsync(this, this, getter_AddRefs(m_proxyRequest));</span>
<a href="#l34.1357"></a><span id="l34.1357" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.1358"></a><span id="l34.1358" class="difflineminus">-    {</span>
<a href="#l34.1359"></a><span id="l34.1359" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l34.1360"></a><span id="l34.1360">       rv = InitializeInternal(nullptr);</span>
<a href="#l34.1361"></a><span id="l34.1361">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1362"></a><span id="l34.1362"> </span>
<a href="#l34.1363"></a><span id="l34.1363">       rv = LoadUrlInternal(m_url);</span>
<a href="#l34.1364"></a><span id="l34.1364">     }</span>
<a href="#l34.1365"></a><span id="l34.1365">   }</span>
<a href="#l34.1366"></a><span id="l34.1366"> </span>
<a href="#l34.1367"></a><span id="l34.1367">   return rv;</span>
<a href="#l34.1368"></a><span id="l34.1368"> }</span>
<a href="#l34.1369"></a><span id="l34.1369"> </span>
<a href="#l34.1370"></a><span id="l34.1370" class="difflineminus">-nsresult nsPop3Protocol::LoadUrlInternal(nsIURI* aURL)</span>
<a href="#l34.1371"></a><span id="l34.1371" class="difflineminus">-{</span>
<a href="#l34.1372"></a><span id="l34.1372" class="difflineplus">+nsresult nsPop3Protocol::LoadUrlInternal(nsIURI *aURL) {</span>
<a href="#l34.1373"></a><span id="l34.1373">   nsresult rv;</span>
<a href="#l34.1374"></a><span id="l34.1374"> </span>
<a href="#l34.1375"></a><span id="l34.1375">   nsCOMPtr&lt;nsIURL&gt; url = do_QueryInterface(aURL, &amp;rv);</span>
<a href="#l34.1376"></a><span id="l34.1376">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.1377"></a><span id="l34.1377"> </span>
<a href="#l34.1378"></a><span id="l34.1378">   int32_t port;</span>
<a href="#l34.1379"></a><span id="l34.1379">   rv = url-&gt;GetPort(&amp;port);</span>
<a href="#l34.1380"></a><span id="l34.1380">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1381"></a><span id="l34.1381"> </span>
<a href="#l34.1382"></a><span id="l34.1382">   rv = NS_CheckPortSafety(port, &quot;pop&quot;);</span>
<a href="#l34.1383"></a><span id="l34.1383">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1384"></a><span id="l34.1384"> </span>
<a href="#l34.1385"></a><span id="l34.1385">   nsAutoCString queryPart;</span>
<a href="#l34.1386"></a><span id="l34.1386">   rv = url-&gt;GetQuery(queryPart);</span>
<a href="#l34.1387"></a><span id="l34.1387">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get the url spect&quot;);</span>
<a href="#l34.1388"></a><span id="l34.1388"> </span>
<a href="#l34.1389"></a><span id="l34.1389" class="difflineminus">-  m_pop3ConData-&gt;only_check_for_new_mail = (PL_strcasestr(queryPart.get(), &quot;check&quot;) != nullptr);</span>
<a href="#l34.1390"></a><span id="l34.1390" class="difflineminus">-  m_pop3ConData-&gt;verify_logon = (PL_strcasestr(queryPart.get(), &quot;verifyLogon&quot;) != nullptr);</span>
<a href="#l34.1391"></a><span id="l34.1391" class="difflineplus">+  m_pop3ConData-&gt;only_check_for_new_mail =</span>
<a href="#l34.1392"></a><span id="l34.1392" class="difflineplus">+      (PL_strcasestr(queryPart.get(), &quot;check&quot;) != nullptr);</span>
<a href="#l34.1393"></a><span id="l34.1393" class="difflineplus">+  m_pop3ConData-&gt;verify_logon =</span>
<a href="#l34.1394"></a><span id="l34.1394" class="difflineplus">+      (PL_strcasestr(queryPart.get(), &quot;verifyLogon&quot;) != nullptr);</span>
<a href="#l34.1395"></a><span id="l34.1395">   m_pop3ConData-&gt;get_url = (PL_strcasestr(queryPart.get(), &quot;gurl&quot;) != nullptr);</span>
<a href="#l34.1396"></a><span id="l34.1396"> </span>
<a href="#l34.1397"></a><span id="l34.1397">   bool deleteByAgeFromServer = false;</span>
<a href="#l34.1398"></a><span id="l34.1398">   int32_t numDaysToLeaveOnServer = -1;</span>
<a href="#l34.1399"></a><span id="l34.1399" class="difflineminus">-  if (!m_pop3ConData-&gt;verify_logon)</span>
<a href="#l34.1400"></a><span id="l34.1400" class="difflineminus">-  {</span>
<a href="#l34.1401"></a><span id="l34.1401" class="difflineminus">-    // Pick up pref setting regarding leave messages on server, message size limit</span>
<a href="#l34.1402"></a><span id="l34.1402" class="difflineplus">+  if (!m_pop3ConData-&gt;verify_logon) {</span>
<a href="#l34.1403"></a><span id="l34.1403" class="difflineplus">+    // Pick up pref setting regarding leave messages on server, message size</span>
<a href="#l34.1404"></a><span id="l34.1404" class="difflineplus">+    // limit</span>
<a href="#l34.1405"></a><span id="l34.1405"> </span>
<a href="#l34.1406"></a><span id="l34.1406">     m_pop3Server-&gt;GetLeaveMessagesOnServer(&amp;m_pop3ConData-&gt;leave_on_server);</span>
<a href="#l34.1407"></a><span id="l34.1407">     m_pop3Server-&gt;GetHeadersOnly(&amp;m_pop3ConData-&gt;headers_only);</span>
<a href="#l34.1408"></a><span id="l34.1408">     bool limitMessageSize = false;</span>
<a href="#l34.1409"></a><span id="l34.1409"> </span>
<a href="#l34.1410"></a><span id="l34.1410">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1411"></a><span id="l34.1411" class="difflineminus">-    if (server)</span>
<a href="#l34.1412"></a><span id="l34.1412" class="difflineminus">-    {</span>
<a href="#l34.1413"></a><span id="l34.1413" class="difflineplus">+    if (server) {</span>
<a href="#l34.1414"></a><span id="l34.1414">       // size limits are superseded by headers_only mode</span>
<a href="#l34.1415"></a><span id="l34.1415" class="difflineminus">-      if (!m_pop3ConData-&gt;headers_only)</span>
<a href="#l34.1416"></a><span id="l34.1416" class="difflineminus">-      {</span>
<a href="#l34.1417"></a><span id="l34.1417" class="difflineplus">+      if (!m_pop3ConData-&gt;headers_only) {</span>
<a href="#l34.1418"></a><span id="l34.1418">         server-&gt;GetLimitOfflineMessageSize(&amp;limitMessageSize);</span>
<a href="#l34.1419"></a><span id="l34.1419" class="difflineminus">-        if (limitMessageSize)</span>
<a href="#l34.1420"></a><span id="l34.1420" class="difflineminus">-        {</span>
<a href="#l34.1421"></a><span id="l34.1421" class="difflineminus">-          int32_t max_size = 0; // default size</span>
<a href="#l34.1422"></a><span id="l34.1422" class="difflineplus">+        if (limitMessageSize) {</span>
<a href="#l34.1423"></a><span id="l34.1423" class="difflineplus">+          int32_t max_size = 0;  // default size</span>
<a href="#l34.1424"></a><span id="l34.1424">           server-&gt;GetMaxMessageSize(&amp;max_size);</span>
<a href="#l34.1425"></a><span id="l34.1425">           m_pop3ConData-&gt;size_limit = (max_size) ? max_size * 1024 : 50 * 1024;</span>
<a href="#l34.1426"></a><span id="l34.1426" class="difflineminus">-       }</span>
<a href="#l34.1427"></a><span id="l34.1427" class="difflineplus">+        }</span>
<a href="#l34.1428"></a><span id="l34.1428">       }</span>
<a href="#l34.1429"></a><span id="l34.1429">       m_pop3Server-&gt;GetDeleteByAgeFromServer(&amp;deleteByAgeFromServer);</span>
<a href="#l34.1430"></a><span id="l34.1430">       if (deleteByAgeFromServer)</span>
<a href="#l34.1431"></a><span id="l34.1431">         m_pop3Server-&gt;GetNumDaysToLeaveOnServer(&amp;numDaysToLeaveOnServer);</span>
<a href="#l34.1432"></a><span id="l34.1432">     }</span>
<a href="#l34.1433"></a><span id="l34.1433">   }</span>
<a href="#l34.1434"></a><span id="l34.1434"> </span>
<a href="#l34.1435"></a><span id="l34.1435">   // UIDL stuff</span>
<a href="#l34.1436"></a><span id="l34.1436">   nsCOMPtr&lt;nsIPop3URL&gt; pop3Url = do_QueryInterface(m_url);</span>
<a href="#l34.1437"></a><span id="l34.1437" class="difflineminus">-  if (pop3Url)</span>
<a href="#l34.1438"></a><span id="l34.1438" class="difflineminus">-    pop3Url-&gt;GetPop3Sink(getter_AddRefs(m_nsIPop3Sink));</span>
<a href="#l34.1439"></a><span id="l34.1439" class="difflineplus">+  if (pop3Url) pop3Url-&gt;GetPop3Sink(getter_AddRefs(m_nsIPop3Sink));</span>
<a href="#l34.1440"></a><span id="l34.1440"> </span>
<a href="#l34.1441"></a><span id="l34.1441">   nsCOMPtr&lt;nsIFile&gt; mailDirectory;</span>
<a href="#l34.1442"></a><span id="l34.1442"> </span>
<a href="#l34.1443"></a><span id="l34.1443">   nsCString hostName;</span>
<a href="#l34.1444"></a><span id="l34.1444">   nsCString userName;</span>
<a href="#l34.1445"></a><span id="l34.1445"> </span>
<a href="#l34.1446"></a><span id="l34.1446">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1447"></a><span id="l34.1447" class="difflineminus">-  if (server)</span>
<a href="#l34.1448"></a><span id="l34.1448" class="difflineminus">-  {</span>
<a href="#l34.1449"></a><span id="l34.1449" class="difflineplus">+  if (server) {</span>
<a href="#l34.1450"></a><span id="l34.1450">     rv = server-&gt;GetLocalPath(getter_AddRefs(mailDirectory));</span>
<a href="#l34.1451"></a><span id="l34.1451">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.1452"></a><span id="l34.1452" class="difflineminus">-    server-&gt;SetServerBusy(true); // the server is now busy</span>
<a href="#l34.1453"></a><span id="l34.1453" class="difflineplus">+    server-&gt;SetServerBusy(true);  // the server is now busy</span>
<a href="#l34.1454"></a><span id="l34.1454">     server-&gt;GetHostName(hostName);</span>
<a href="#l34.1455"></a><span id="l34.1455">     server-&gt;GetUsername(userName);</span>
<a href="#l34.1456"></a><span id="l34.1456">     MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.1457"></a><span id="l34.1457">             (POP3LOG(&quot;Connecting to server %s:%d&quot;), hostName.get(), port));</span>
<a href="#l34.1458"></a><span id="l34.1458"> </span>
<a href="#l34.1459"></a><span id="l34.1459">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.1460"></a><span id="l34.1460">             (POP3LOG(&quot;Setting server busy in nsPop3Protocol::LoadUrl()&quot;)));</span>
<a href="#l34.1461"></a><span id="l34.1461">   }</span>
<a href="#l34.1462"></a><span id="l34.1462"> </span>
<a href="#l34.1463"></a><span id="l34.1463">   if (!m_pop3ConData-&gt;verify_logon)</span>
<a href="#l34.1464"></a><span id="l34.1464" class="difflineminus">-    m_pop3ConData-&gt;uidlinfo = net_pop3_load_state(hostName.get(), userName.get(), mailDirectory);</span>
<a href="#l34.1465"></a><span id="l34.1465" class="difflineplus">+    m_pop3ConData-&gt;uidlinfo =</span>
<a href="#l34.1466"></a><span id="l34.1466" class="difflineplus">+        net_pop3_load_state(hostName.get(), userName.get(), mailDirectory);</span>
<a href="#l34.1467"></a><span id="l34.1467"> </span>
<a href="#l34.1468"></a><span id="l34.1468">   m_pop3ConData-&gt;biffstate = nsIMsgFolder::nsMsgBiffState_NoMail;</span>
<a href="#l34.1469"></a><span id="l34.1469"> </span>
<a href="#l34.1470"></a><span id="l34.1470" class="difflineminus">-  if (m_pop3ConData-&gt;uidlinfo &amp;&amp; numDaysToLeaveOnServer &gt; 0)</span>
<a href="#l34.1471"></a><span id="l34.1471" class="difflineminus">-  {</span>
<a href="#l34.1472"></a><span id="l34.1472" class="difflineplus">+  if (m_pop3ConData-&gt;uidlinfo &amp;&amp; numDaysToLeaveOnServer &gt; 0) {</span>
<a href="#l34.1473"></a><span id="l34.1473">     uint32_t nowInSeconds = TimeInSecondsFromPRTime(PR_Now());</span>
<a href="#l34.1474"></a><span id="l34.1474">     uint32_t cutOffDay = nowInSeconds - (60 * 60 * 24 * numDaysToLeaveOnServer);</span>
<a href="#l34.1475"></a><span id="l34.1475"> </span>
<a href="#l34.1476"></a><span id="l34.1476" class="difflineminus">-    PL_HashTableEnumerateEntries(m_pop3ConData-&gt;uidlinfo-&gt;hash, net_pop3_delete_old_msgs_mapper, (void *)(uintptr_t) cutOffDay);</span>
<a href="#l34.1477"></a><span id="l34.1477" class="difflineplus">+    PL_HashTableEnumerateEntries(m_pop3ConData-&gt;uidlinfo-&gt;hash,</span>
<a href="#l34.1478"></a><span id="l34.1478" class="difflineplus">+                                 net_pop3_delete_old_msgs_mapper,</span>
<a href="#l34.1479"></a><span id="l34.1479" class="difflineplus">+                                 (void *)(uintptr_t)cutOffDay);</span>
<a href="#l34.1480"></a><span id="l34.1480">   }</span>
<a href="#l34.1481"></a><span id="l34.1481" class="difflineminus">-  const char* uidl = PL_strcasestr(queryPart.get(), &quot;uidl=&quot;);</span>
<a href="#l34.1482"></a><span id="l34.1482" class="difflineplus">+  const char *uidl = PL_strcasestr(queryPart.get(), &quot;uidl=&quot;);</span>
<a href="#l34.1483"></a><span id="l34.1483">   PR_FREEIF(m_pop3ConData-&gt;only_uidl);</span>
<a href="#l34.1484"></a><span id="l34.1484"> </span>
<a href="#l34.1485"></a><span id="l34.1485" class="difflineminus">-  if (uidl)</span>
<a href="#l34.1486"></a><span id="l34.1486" class="difflineminus">-  {</span>
<a href="#l34.1487"></a><span id="l34.1487" class="difflineplus">+  if (uidl) {</span>
<a href="#l34.1488"></a><span id="l34.1488">     uidl += 5;</span>
<a href="#l34.1489"></a><span id="l34.1489">     nsCString unescapedData;</span>
<a href="#l34.1490"></a><span id="l34.1490">     MsgUnescapeString(nsDependentCString(uidl), 0, unescapedData);</span>
<a href="#l34.1491"></a><span id="l34.1491">     m_pop3ConData-&gt;only_uidl = PL_strdup(unescapedData.get());</span>
<a href="#l34.1492"></a><span id="l34.1492"> </span>
<a href="#l34.1493"></a><span id="l34.1493" class="difflineminus">-    mSuppressListenerNotifications = true; // suppress on start and on stop because this url won't have any content to display</span>
<a href="#l34.1494"></a><span id="l34.1494" class="difflineplus">+    mSuppressListenerNotifications =</span>
<a href="#l34.1495"></a><span id="l34.1495" class="difflineplus">+        true;  // suppress on start and on stop because this url won't have any</span>
<a href="#l34.1496"></a><span id="l34.1496" class="difflineplus">+               // content to display</span>
<a href="#l34.1497"></a><span id="l34.1497">   }</span>
<a href="#l34.1498"></a><span id="l34.1498"> </span>
<a href="#l34.1499"></a><span id="l34.1499">   m_pop3ConData-&gt;next_state = POP3_START_CONNECT;</span>
<a href="#l34.1500"></a><span id="l34.1500">   m_pop3ConData-&gt;next_state_after_response = POP3_FINISH_CONNECT;</span>
<a href="#l34.1501"></a><span id="l34.1501" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1502"></a><span id="l34.1502" class="difflineminus">-  {</span>
<a href="#l34.1503"></a><span id="l34.1503" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.1504"></a><span id="l34.1504">     m_pop3Server-&gt;SetRunningProtocol(this);</span>
<a href="#l34.1505"></a><span id="l34.1505">     return nsMsgProtocol::LoadUrl(aURL);</span>
<a href="#l34.1506"></a><span id="l34.1506" class="difflineminus">-  }</span>
<a href="#l34.1507"></a><span id="l34.1507" class="difflineminus">-  else</span>
<a href="#l34.1508"></a><span id="l34.1508" class="difflineplus">+  } else</span>
<a href="#l34.1509"></a><span id="l34.1509">     return rv;</span>
<a href="#l34.1510"></a><span id="l34.1510"> }</span>
<a href="#l34.1511"></a><span id="l34.1511"> </span>
<a href="#l34.1512"></a><span id="l34.1512" class="difflineminus">-void</span>
<a href="#l34.1513"></a><span id="l34.1513" class="difflineminus">-nsPop3Protocol::FreeMsgInfo()</span>
<a href="#l34.1514"></a><span id="l34.1514" class="difflineminus">-{</span>
<a href="#l34.1515"></a><span id="l34.1515" class="difflineplus">+void nsPop3Protocol::FreeMsgInfo() {</span>
<a href="#l34.1516"></a><span id="l34.1516">   int i;</span>
<a href="#l34.1517"></a><span id="l34.1517" class="difflineminus">-  if (m_pop3ConData-&gt;msg_info)</span>
<a href="#l34.1518"></a><span id="l34.1518" class="difflineminus">-  {</span>
<a href="#l34.1519"></a><span id="l34.1519" class="difflineminus">-    for (i=0 ; i&lt;m_pop3ConData-&gt;number_of_messages ; i++)</span>
<a href="#l34.1520"></a><span id="l34.1520" class="difflineminus">-    {</span>
<a href="#l34.1521"></a><span id="l34.1521" class="difflineplus">+  if (m_pop3ConData-&gt;msg_info) {</span>
<a href="#l34.1522"></a><span id="l34.1522" class="difflineplus">+    for (i = 0; i &lt; m_pop3ConData-&gt;number_of_messages; i++) {</span>
<a href="#l34.1523"></a><span id="l34.1523">       if (m_pop3ConData-&gt;msg_info[i].uidl)</span>
<a href="#l34.1524"></a><span id="l34.1524">         PR_Free(m_pop3ConData-&gt;msg_info[i].uidl);</span>
<a href="#l34.1525"></a><span id="l34.1525">       m_pop3ConData-&gt;msg_info[i].uidl = nullptr;</span>
<a href="#l34.1526"></a><span id="l34.1526">     }</span>
<a href="#l34.1527"></a><span id="l34.1527">     PR_Free(m_pop3ConData-&gt;msg_info);</span>
<a href="#l34.1528"></a><span id="l34.1528">     m_pop3ConData-&gt;msg_info = nullptr;</span>
<a href="#l34.1529"></a><span id="l34.1529">   }</span>
<a href="#l34.1530"></a><span id="l34.1530"> }</span>
<a href="#l34.1531"></a><span id="l34.1531"> </span>
<a href="#l34.1532"></a><span id="l34.1532" class="difflineminus">-int32_t</span>
<a href="#l34.1533"></a><span id="l34.1533" class="difflineminus">-nsPop3Protocol::WaitForStartOfConnectionResponse(nsIInputStream* aInputStream,</span>
<a href="#l34.1534"></a><span id="l34.1534" class="difflineminus">-                                                 uint32_t length)</span>
<a href="#l34.1535"></a><span id="l34.1535" class="difflineminus">-{</span>
<a href="#l34.1536"></a><span id="l34.1536" class="difflineminus">-  char * line = nullptr;</span>
<a href="#l34.1537"></a><span id="l34.1537" class="difflineplus">+int32_t nsPop3Protocol::WaitForStartOfConnectionResponse(</span>
<a href="#l34.1538"></a><span id="l34.1538" class="difflineplus">+    nsIInputStream *aInputStream, uint32_t length) {</span>
<a href="#l34.1539"></a><span id="l34.1539" class="difflineplus">+  char *line = nullptr;</span>
<a href="#l34.1540"></a><span id="l34.1540">   uint32_t line_length = 0;</span>
<a href="#l34.1541"></a><span id="l34.1541">   bool pauseForMoreData = false;</span>
<a href="#l34.1542"></a><span id="l34.1542">   nsresult rv;</span>
<a href="#l34.1543"></a><span id="l34.1543" class="difflineminus">-  line = m_lineStreamBuffer-&gt;ReadNextLine(aInputStream, line_length, pauseForMoreData, &amp;rv);</span>
<a href="#l34.1544"></a><span id="l34.1544" class="difflineplus">+  line = m_lineStreamBuffer-&gt;ReadNextLine(aInputStream, line_length,</span>
<a href="#l34.1545"></a><span id="l34.1545" class="difflineplus">+                                          pauseForMoreData, &amp;rv);</span>
<a href="#l34.1546"></a><span id="l34.1546"> </span>
<a href="#l34.1547"></a><span id="l34.1547">   MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.1548"></a><span id="l34.1548" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.1549"></a><span id="l34.1549" class="difflineminus">-    return -1;</span>
<a href="#l34.1550"></a><span id="l34.1550" class="difflineminus">-</span>
<a href="#l34.1551"></a><span id="l34.1551" class="difflineminus">-  if(pauseForMoreData || !line)</span>
<a href="#l34.1552"></a><span id="l34.1552" class="difflineminus">-  {</span>
<a href="#l34.1553"></a><span id="l34.1553" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.1554"></a><span id="l34.1554" class="difflineplus">+</span>
<a href="#l34.1555"></a><span id="l34.1555" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.1556"></a><span id="l34.1556">     m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l34.1557"></a><span id="l34.1557">     PR_Free(line);</span>
<a href="#l34.1558"></a><span id="l34.1558" class="difflineminus">-    return(line_length);</span>
<a href="#l34.1559"></a><span id="l34.1559" class="difflineplus">+    return (line_length);</span>
<a href="#l34.1560"></a><span id="l34.1560">   }</span>
<a href="#l34.1561"></a><span id="l34.1561"> </span>
<a href="#l34.1562"></a><span id="l34.1562" class="difflineminus">-  if(*line == '+')</span>
<a href="#l34.1563"></a><span id="l34.1563" class="difflineminus">-  {</span>
<a href="#l34.1564"></a><span id="l34.1564" class="difflineplus">+  if (*line == '+') {</span>
<a href="#l34.1565"></a><span id="l34.1565">     m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.1566"></a><span id="l34.1566" class="difflineminus">-    if(PL_strlen(line) &gt; 4)</span>
<a href="#l34.1567"></a><span id="l34.1567" class="difflineplus">+    if (PL_strlen(line) &gt; 4)</span>
<a href="#l34.1568"></a><span id="l34.1568">       m_commandResponse = line + 4;</span>
<a href="#l34.1569"></a><span id="l34.1569">     else</span>
<a href="#l34.1570"></a><span id="l34.1570">       m_commandResponse = line;</span>
<a href="#l34.1571"></a><span id="l34.1571"> </span>
<a href="#l34.1572"></a><span id="l34.1572" class="difflineminus">-    if (m_prefAuthMethods &amp; POP3_HAS_AUTH_APOP)</span>
<a href="#l34.1573"></a><span id="l34.1573" class="difflineminus">-    {</span>
<a href="#l34.1574"></a><span id="l34.1574" class="difflineminus">-      if (NS_SUCCEEDED(GetApopTimestamp()))</span>
<a href="#l34.1575"></a><span id="l34.1575" class="difflineminus">-        SetCapFlag(POP3_HAS_AUTH_APOP);</span>
<a href="#l34.1576"></a><span id="l34.1576" class="difflineminus">-    }</span>
<a href="#l34.1577"></a><span id="l34.1577" class="difflineminus">-    else</span>
<a href="#l34.1578"></a><span id="l34.1578" class="difflineplus">+    if (m_prefAuthMethods &amp; POP3_HAS_AUTH_APOP) {</span>
<a href="#l34.1579"></a><span id="l34.1579" class="difflineplus">+      if (NS_SUCCEEDED(GetApopTimestamp())) SetCapFlag(POP3_HAS_AUTH_APOP);</span>
<a href="#l34.1580"></a><span id="l34.1580" class="difflineplus">+    } else</span>
<a href="#l34.1581"></a><span id="l34.1581">       ClearCapFlag(POP3_HAS_AUTH_APOP);</span>
<a href="#l34.1582"></a><span id="l34.1582"> </span>
<a href="#l34.1583"></a><span id="l34.1583">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1584"></a><span id="l34.1584"> </span>
<a href="#l34.1585"></a><span id="l34.1585">     m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.1586"></a><span id="l34.1586">     m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l34.1587"></a><span id="l34.1587">   }</span>
<a href="#l34.1588"></a><span id="l34.1588"> </span>
<a href="#l34.1589"></a><span id="l34.1589">   PR_Free(line);</span>
<a href="#l34.1590"></a><span id="l34.1590" class="difflineminus">-  return(1);  /* everything ok */</span>
<a href="#l34.1591"></a><span id="l34.1591" class="difflineplus">+  return (1); /* everything ok */</span>
<a href="#l34.1592"></a><span id="l34.1592"> }</span>
<a href="#l34.1593"></a><span id="l34.1593"> </span>
<a href="#l34.1594"></a><span id="l34.1594" class="difflineminus">-int32_t</span>
<a href="#l34.1595"></a><span id="l34.1595" class="difflineminus">-nsPop3Protocol::WaitForResponse(nsIInputStream* inputStream, uint32_t length)</span>
<a href="#l34.1596"></a><span id="l34.1596" class="difflineminus">-{</span>
<a href="#l34.1597"></a><span id="l34.1597" class="difflineminus">-  char * line;</span>
<a href="#l34.1598"></a><span id="l34.1598" class="difflineplus">+int32_t nsPop3Protocol::WaitForResponse(nsIInputStream *inputStream,</span>
<a href="#l34.1599"></a><span id="l34.1599" class="difflineplus">+                                        uint32_t length) {</span>
<a href="#l34.1600"></a><span id="l34.1600" class="difflineplus">+  char *line;</span>
<a href="#l34.1601"></a><span id="l34.1601">   uint32_t ln = 0;</span>
<a href="#l34.1602"></a><span id="l34.1602">   bool pauseForMoreData = false;</span>
<a href="#l34.1603"></a><span id="l34.1603">   nsresult rv;</span>
<a href="#l34.1604"></a><span id="l34.1604" class="difflineminus">-  line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.1605"></a><span id="l34.1605" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.1606"></a><span id="l34.1606" class="difflineminus">-    return -1;</span>
<a href="#l34.1607"></a><span id="l34.1607" class="difflineminus">-</span>
<a href="#l34.1608"></a><span id="l34.1608" class="difflineminus">-  if(pauseForMoreData || !line)</span>
<a href="#l34.1609"></a><span id="l34.1609" class="difflineminus">-  {</span>
<a href="#l34.1610"></a><span id="l34.1610" class="difflineplus">+  line =</span>
<a href="#l34.1611"></a><span id="l34.1611" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.1612"></a><span id="l34.1612" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.1613"></a><span id="l34.1613" class="difflineplus">+</span>
<a href="#l34.1614"></a><span id="l34.1614" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.1615"></a><span id="l34.1615">     m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l34.1616"></a><span id="l34.1616"> </span>
<a href="#l34.1617"></a><span id="l34.1617">     PR_Free(line);</span>
<a href="#l34.1618"></a><span id="l34.1618" class="difflineminus">-    return(ln);</span>
<a href="#l34.1619"></a><span id="l34.1619" class="difflineplus">+    return (ln);</span>
<a href="#l34.1620"></a><span id="l34.1620">   }</span>
<a href="#l34.1621"></a><span id="l34.1621"> </span>
<a href="#l34.1622"></a><span id="l34.1622">   MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.1623"></a><span id="l34.1623"> </span>
<a href="#l34.1624"></a><span id="l34.1624" class="difflineminus">-  if(*line == '+')</span>
<a href="#l34.1625"></a><span id="l34.1625" class="difflineminus">-  {</span>
<a href="#l34.1626"></a><span id="l34.1626" class="difflineplus">+  if (*line == '+') {</span>
<a href="#l34.1627"></a><span id="l34.1627">     m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.1628"></a><span id="l34.1628" class="difflineminus">-    if(PL_strlen(line) &gt; 4)</span>
<a href="#l34.1629"></a><span id="l34.1629" class="difflineminus">-    {</span>
<a href="#l34.1630"></a><span id="l34.1630" class="difflineminus">-      if(!PL_strncasecmp(line, &quot;+OK&quot;, 3))</span>
<a href="#l34.1631"></a><span id="l34.1631" class="difflineplus">+    if (PL_strlen(line) &gt; 4) {</span>
<a href="#l34.1632"></a><span id="l34.1632" class="difflineplus">+      if (!PL_strncasecmp(line, &quot;+OK&quot;, 3))</span>
<a href="#l34.1633"></a><span id="l34.1633">         m_commandResponse = line + 4;</span>
<a href="#l34.1634"></a><span id="l34.1634">       else  // challenge answer to AUTH CRAM-MD5 and LOGIN username/password</span>
<a href="#l34.1635"></a><span id="l34.1635">         m_commandResponse = line + 2;</span>
<a href="#l34.1636"></a><span id="l34.1636" class="difflineminus">-    }</span>
<a href="#l34.1637"></a><span id="l34.1637" class="difflineplus">+    } else</span>
<a href="#l34.1638"></a><span id="l34.1638" class="difflineplus">+      m_commandResponse = line;</span>
<a href="#l34.1639"></a><span id="l34.1639" class="difflineplus">+  } else {</span>
<a href="#l34.1640"></a><span id="l34.1640" class="difflineplus">+    m_pop3ConData-&gt;command_succeeded = false;</span>
<a href="#l34.1641"></a><span id="l34.1641" class="difflineplus">+    if (PL_strlen(line) &gt; 5)</span>
<a href="#l34.1642"></a><span id="l34.1642" class="difflineplus">+      m_commandResponse = line + 5;</span>
<a href="#l34.1643"></a><span id="l34.1643">     else</span>
<a href="#l34.1644"></a><span id="l34.1644">       m_commandResponse = line;</span>
<a href="#l34.1645"></a><span id="l34.1645" class="difflineminus">-  }</span>
<a href="#l34.1646"></a><span id="l34.1646" class="difflineminus">-  else</span>
<a href="#l34.1647"></a><span id="l34.1647" class="difflineminus">-  {</span>
<a href="#l34.1648"></a><span id="l34.1648" class="difflineminus">-    m_pop3ConData-&gt;command_succeeded = false;</span>
<a href="#l34.1649"></a><span id="l34.1649" class="difflineminus">-    if(PL_strlen(line) &gt; 5)</span>
<a href="#l34.1650"></a><span id="l34.1650" class="difflineminus">-      m_commandResponse = line + 5;</span>
<a href="#l34.1651"></a><span id="l34.1651" class="difflineminus">-    else</span>
<a href="#l34.1652"></a><span id="l34.1652" class="difflineminus">-      m_commandResponse  = line;</span>
<a href="#l34.1653"></a><span id="l34.1653"> </span>
<a href="#l34.1654"></a><span id="l34.1654">     // search for the response codes (RFC 2449, chapter 8 and RFC 3206)</span>
<a href="#l34.1655"></a><span id="l34.1655" class="difflineminus">-    if(TestCapFlag(POP3_HAS_RESP_CODES | POP3_HAS_AUTH_RESP_CODE))</span>
<a href="#l34.1656"></a><span id="l34.1656" class="difflineminus">-    {</span>
<a href="#l34.1657"></a><span id="l34.1657" class="difflineminus">-        // code for authentication failure due to the user's credentials</span>
<a href="#l34.1658"></a><span id="l34.1658" class="difflineminus">-        if(m_commandResponse.Find(&quot;[AUTH&quot;, true) &gt;= 0)</span>
<a href="#l34.1659"></a><span id="l34.1659" class="difflineminus">-        {</span>
<a href="#l34.1660"></a><span id="l34.1660" class="difflineminus">-          MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;setting auth failure&quot;)));</span>
<a href="#l34.1661"></a><span id="l34.1661" class="difflineminus">-          SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l34.1662"></a><span id="l34.1662" class="difflineminus">-        }</span>
<a href="#l34.1663"></a><span id="l34.1663" class="difflineminus">-</span>
<a href="#l34.1664"></a><span id="l34.1664" class="difflineminus">-        // codes for failures due to other reasons</span>
<a href="#l34.1665"></a><span id="l34.1665" class="difflineminus">-        if(m_commandResponse.Find(&quot;[LOGIN-DELAY&quot;, true) &gt;= 0 ||</span>
<a href="#l34.1666"></a><span id="l34.1666" class="difflineminus">-           m_commandResponse.Find(&quot;[IN-USE&quot;, true) &gt;= 0 ||</span>
<a href="#l34.1667"></a><span id="l34.1667" class="difflineminus">-           m_commandResponse.Find(&quot;[SYS&quot;, true) &gt;= 0)</span>
<a href="#l34.1668"></a><span id="l34.1668" class="difflineminus">-      SetFlag(POP3_STOPLOGIN);</span>
<a href="#l34.1669"></a><span id="l34.1669" class="difflineplus">+    if (TestCapFlag(POP3_HAS_RESP_CODES | POP3_HAS_AUTH_RESP_CODE)) {</span>
<a href="#l34.1670"></a><span id="l34.1670" class="difflineplus">+      // code for authentication failure due to the user's credentials</span>
<a href="#l34.1671"></a><span id="l34.1671" class="difflineplus">+      if (m_commandResponse.Find(&quot;[AUTH&quot;, true) &gt;= 0) {</span>
<a href="#l34.1672"></a><span id="l34.1672" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.1673"></a><span id="l34.1673" class="difflineplus">+                (POP3LOG(&quot;setting auth failure&quot;)));</span>
<a href="#l34.1674"></a><span id="l34.1674" class="difflineplus">+        SetFlag(POP3_AUTH_FAILURE);</span>
<a href="#l34.1675"></a><span id="l34.1675" class="difflineplus">+      }</span>
<a href="#l34.1676"></a><span id="l34.1676" class="difflineplus">+</span>
<a href="#l34.1677"></a><span id="l34.1677" class="difflineplus">+      // codes for failures due to other reasons</span>
<a href="#l34.1678"></a><span id="l34.1678" class="difflineplus">+      if (m_commandResponse.Find(&quot;[LOGIN-DELAY&quot;, true) &gt;= 0 ||</span>
<a href="#l34.1679"></a><span id="l34.1679" class="difflineplus">+          m_commandResponse.Find(&quot;[IN-USE&quot;, true) &gt;= 0 ||</span>
<a href="#l34.1680"></a><span id="l34.1680" class="difflineplus">+          m_commandResponse.Find(&quot;[SYS&quot;, true) &gt;= 0)</span>
<a href="#l34.1681"></a><span id="l34.1681" class="difflineplus">+        SetFlag(POP3_STOPLOGIN);</span>
<a href="#l34.1682"></a><span id="l34.1682"> </span>
<a href="#l34.1683"></a><span id="l34.1683">       // remove the codes from the response string presented to the user</span>
<a href="#l34.1684"></a><span id="l34.1684">       int32_t i = m_commandResponse.FindChar(']');</span>
<a href="#l34.1685"></a><span id="l34.1685" class="difflineminus">-      if(i &gt;= 0)</span>
<a href="#l34.1686"></a><span id="l34.1686" class="difflineminus">-        m_commandResponse.Cut(0, i + 2);</span>
<a href="#l34.1687"></a><span id="l34.1687" class="difflineplus">+      if (i &gt;= 0) m_commandResponse.Cut(0, i + 2);</span>
<a href="#l34.1688"></a><span id="l34.1688">     }</span>
<a href="#l34.1689"></a><span id="l34.1689">   }</span>
<a href="#l34.1690"></a><span id="l34.1690"> </span>
<a href="#l34.1691"></a><span id="l34.1691">   m_pop3ConData-&gt;next_state = m_pop3ConData-&gt;next_state_after_response;</span>
<a href="#l34.1692"></a><span id="l34.1692">   m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l34.1693"></a><span id="l34.1693"> </span>
<a href="#l34.1694"></a><span id="l34.1694">   PR_Free(line);</span>
<a href="#l34.1695"></a><span id="l34.1695" class="difflineminus">-  return(1);  /* everything ok */</span>
<a href="#l34.1696"></a><span id="l34.1696" class="difflineplus">+  return (1); /* everything ok */</span>
<a href="#l34.1697"></a><span id="l34.1697"> }</span>
<a href="#l34.1698"></a><span id="l34.1698"> </span>
<a href="#l34.1699"></a><span id="l34.1699" class="difflineminus">-int32_t</span>
<a href="#l34.1700"></a><span id="l34.1700" class="difflineminus">-nsPop3Protocol::Error(const char* err_code,</span>
<a href="#l34.1701"></a><span id="l34.1701" class="difflineminus">-                      const char16_t **params,</span>
<a href="#l34.1702"></a><span id="l34.1702" class="difflineminus">-                      uint32_t length)</span>
<a href="#l34.1703"></a><span id="l34.1703" class="difflineminus">-{</span>
<a href="#l34.1704"></a><span id="l34.1704" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;ERROR: %s&quot;), err_code));</span>
<a href="#l34.1705"></a><span id="l34.1705" class="difflineminus">-</span>
<a href="#l34.1706"></a><span id="l34.1706" class="difflineminus">-    // the error code is just the resource name for the error string...</span>
<a href="#l34.1707"></a><span id="l34.1707" class="difflineminus">-    // so print out that error message!</span>
<a href="#l34.1708"></a><span id="l34.1708" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1709"></a><span id="l34.1709" class="difflineminus">-    nsString accountName;</span>
<a href="#l34.1710"></a><span id="l34.1710" class="difflineminus">-    nsresult rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l34.1711"></a><span id="l34.1711" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.1712"></a><span id="l34.1712" class="difflineminus">-    const char16_t *titleParams[] = { accountName.get() };</span>
<a href="#l34.1713"></a><span id="l34.1713" class="difflineminus">-    nsString dialogTitle;</span>
<a href="#l34.1714"></a><span id="l34.1714" class="difflineminus">-    mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l34.1715"></a><span id="l34.1715" class="difflineminus">-      &quot;pop3ErrorDialogTitle&quot;,</span>
<a href="#l34.1716"></a><span id="l34.1716" class="difflineminus">-      titleParams, 1, dialogTitle);</span>
<a href="#l34.1717"></a><span id="l34.1717" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.1718"></a><span id="l34.1718" class="difflineminus">-    // we handle &quot;pop3TmpDownloadError&quot; earlier...</span>
<a href="#l34.1719"></a><span id="l34.1719" class="difflineminus">-    if (strcmp(err_code, &quot;pop3TmpDownloadError&quot;) &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l34.1720"></a><span id="l34.1720" class="difflineminus">-    {</span>
<a href="#l34.1721"></a><span id="l34.1721" class="difflineminus">-        nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.1722"></a><span id="l34.1722" class="difflineminus">-        nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l34.1723"></a><span id="l34.1723" class="difflineminus">-        rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow)); //it is ok to have null msgWindow, for example when biffing</span>
<a href="#l34.1724"></a><span id="l34.1724" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow)</span>
<a href="#l34.1725"></a><span id="l34.1725" class="difflineminus">-        {</span>
<a href="#l34.1726"></a><span id="l34.1726" class="difflineminus">-            rv = msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l34.1727"></a><span id="l34.1727" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1728"></a><span id="l34.1728" class="difflineminus">-            {</span>
<a href="#l34.1729"></a><span id="l34.1729" class="difflineminus">-              nsString alertString;</span>
<a href="#l34.1730"></a><span id="l34.1730" class="difflineminus">-              // Format the alert string if parameter list isn't empty</span>
<a href="#l34.1731"></a><span id="l34.1731" class="difflineminus">-              if (params)</span>
<a href="#l34.1732"></a><span id="l34.1732" class="difflineminus">-                mLocalBundle-&gt;FormatStringFromName(err_code,</span>
<a href="#l34.1733"></a><span id="l34.1733" class="difflineminus">-                                                   params, length, alertString);</span>
<a href="#l34.1734"></a><span id="l34.1734" class="difflineminus">-              else</span>
<a href="#l34.1735"></a><span id="l34.1735" class="difflineminus">-                mLocalBundle-&gt;GetStringFromName(err_code, alertString);</span>
<a href="#l34.1736"></a><span id="l34.1736" class="difflineminus">-              if (m_pop3ConData-&gt;command_succeeded)  //not a server error message</span>
<a href="#l34.1737"></a><span id="l34.1737" class="difflineminus">-                dialog-&gt;Alert(dialogTitle.get(), alertString.get());</span>
<a href="#l34.1738"></a><span id="l34.1738" class="difflineminus">-              else</span>
<a href="#l34.1739"></a><span id="l34.1739" class="difflineminus">-              {</span>
<a href="#l34.1740"></a><span id="l34.1740" class="difflineminus">-                nsString serverSaidPrefix;</span>
<a href="#l34.1741"></a><span id="l34.1741" class="difflineminus">-                nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1742"></a><span id="l34.1742" class="difflineminus">-                nsCString hostName;</span>
<a href="#l34.1743"></a><span id="l34.1743" class="difflineminus">-                // Fomat string with hostname.</span>
<a href="#l34.1744"></a><span id="l34.1744" class="difflineminus">-                if (server)</span>
<a href="#l34.1745"></a><span id="l34.1745" class="difflineminus">-                  rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.1746"></a><span id="l34.1746" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l34.1747"></a><span id="l34.1747" class="difflineminus">-                {</span>
<a href="#l34.1748"></a><span id="l34.1748" class="difflineminus">-                  nsAutoString hostStr;</span>
<a href="#l34.1749"></a><span id="l34.1749" class="difflineminus">-                  CopyASCIItoUTF16(hostName, hostStr);</span>
<a href="#l34.1750"></a><span id="l34.1750" class="difflineminus">-                  const char16_t *params[] = { hostStr.get() };</span>
<a href="#l34.1751"></a><span id="l34.1751" class="difflineminus">-                  mLocalBundle-&gt;FormatStringFromName(</span>
<a href="#l34.1752"></a><span id="l34.1752" class="difflineminus">-                    &quot;pop3ServerSaid&quot;,</span>
<a href="#l34.1753"></a><span id="l34.1753" class="difflineminus">-                    params, 1, serverSaidPrefix);</span>
<a href="#l34.1754"></a><span id="l34.1754" class="difflineminus">-                }</span>
<a href="#l34.1755"></a><span id="l34.1755" class="difflineminus">-</span>
<a href="#l34.1756"></a><span id="l34.1756" class="difflineminus">-                nsAutoString message(alertString);</span>
<a href="#l34.1757"></a><span id="l34.1757" class="difflineminus">-                message.Append(' ');</span>
<a href="#l34.1758"></a><span id="l34.1758" class="difflineminus">-                message.Append(serverSaidPrefix);</span>
<a href="#l34.1759"></a><span id="l34.1759" class="difflineminus">-                message.Append(' ');</span>
<a href="#l34.1760"></a><span id="l34.1760" class="difflineminus">-                message.Append(NS_ConvertASCIItoUTF16(m_commandResponse));</span>
<a href="#l34.1761"></a><span id="l34.1761" class="difflineminus">-                dialog-&gt;Alert(dialogTitle.get(), message.get());</span>
<a href="#l34.1762"></a><span id="l34.1762" class="difflineminus">-              }</span>
<a href="#l34.1763"></a><span id="l34.1763" class="difflineminus">-            }</span>
<a href="#l34.1764"></a><span id="l34.1764" class="difflineplus">+int32_t nsPop3Protocol::Error(const char *err_code, const char16_t **params,</span>
<a href="#l34.1765"></a><span id="l34.1765" class="difflineplus">+                              uint32_t length) {</span>
<a href="#l34.1766"></a><span id="l34.1766" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;ERROR: %s&quot;), err_code));</span>
<a href="#l34.1767"></a><span id="l34.1767" class="difflineplus">+</span>
<a href="#l34.1768"></a><span id="l34.1768" class="difflineplus">+  // the error code is just the resource name for the error string...</span>
<a href="#l34.1769"></a><span id="l34.1769" class="difflineplus">+  // so print out that error message!</span>
<a href="#l34.1770"></a><span id="l34.1770" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1771"></a><span id="l34.1771" class="difflineplus">+  nsString accountName;</span>
<a href="#l34.1772"></a><span id="l34.1772" class="difflineplus">+  nsresult rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l34.1773"></a><span id="l34.1773" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.1774"></a><span id="l34.1774" class="difflineplus">+  const char16_t *titleParams[] = {accountName.get()};</span>
<a href="#l34.1775"></a><span id="l34.1775" class="difflineplus">+  nsString dialogTitle;</span>
<a href="#l34.1776"></a><span id="l34.1776" class="difflineplus">+  mLocalBundle-&gt;FormatStringFromName(&quot;pop3ErrorDialogTitle&quot;, titleParams, 1,</span>
<a href="#l34.1777"></a><span id="l34.1777" class="difflineplus">+                                     dialogTitle);</span>
<a href="#l34.1778"></a><span id="l34.1778" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.1779"></a><span id="l34.1779" class="difflineplus">+  // we handle &quot;pop3TmpDownloadError&quot; earlier...</span>
<a href="#l34.1780"></a><span id="l34.1780" class="difflineplus">+  if (strcmp(err_code, &quot;pop3TmpDownloadError&quot;) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l34.1781"></a><span id="l34.1781" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.1782"></a><span id="l34.1782" class="difflineplus">+    nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l34.1783"></a><span id="l34.1783" class="difflineplus">+    rv = mailnewsUrl-&gt;GetMsgWindow(</span>
<a href="#l34.1784"></a><span id="l34.1784" class="difflineplus">+        getter_AddRefs(msgWindow));  // it is ok to have null msgWindow, for</span>
<a href="#l34.1785"></a><span id="l34.1785" class="difflineplus">+                                     // example when biffing</span>
<a href="#l34.1786"></a><span id="l34.1786" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow) {</span>
<a href="#l34.1787"></a><span id="l34.1787" class="difflineplus">+      rv = msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l34.1788"></a><span id="l34.1788" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.1789"></a><span id="l34.1789" class="difflineplus">+        nsString alertString;</span>
<a href="#l34.1790"></a><span id="l34.1790" class="difflineplus">+        // Format the alert string if parameter list isn't empty</span>
<a href="#l34.1791"></a><span id="l34.1791" class="difflineplus">+        if (params)</span>
<a href="#l34.1792"></a><span id="l34.1792" class="difflineplus">+          mLocalBundle-&gt;FormatStringFromName(err_code, params, length,</span>
<a href="#l34.1793"></a><span id="l34.1793" class="difflineplus">+                                             alertString);</span>
<a href="#l34.1794"></a><span id="l34.1794" class="difflineplus">+        else</span>
<a href="#l34.1795"></a><span id="l34.1795" class="difflineplus">+          mLocalBundle-&gt;GetStringFromName(err_code, alertString);</span>
<a href="#l34.1796"></a><span id="l34.1796" class="difflineplus">+        if (m_pop3ConData-&gt;command_succeeded)  // not a server error message</span>
<a href="#l34.1797"></a><span id="l34.1797" class="difflineplus">+          dialog-&gt;Alert(dialogTitle.get(), alertString.get());</span>
<a href="#l34.1798"></a><span id="l34.1798" class="difflineplus">+        else {</span>
<a href="#l34.1799"></a><span id="l34.1799" class="difflineplus">+          nsString serverSaidPrefix;</span>
<a href="#l34.1800"></a><span id="l34.1800" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l34.1801"></a><span id="l34.1801" class="difflineplus">+              do_QueryInterface(m_pop3Server);</span>
<a href="#l34.1802"></a><span id="l34.1802" class="difflineplus">+          nsCString hostName;</span>
<a href="#l34.1803"></a><span id="l34.1803" class="difflineplus">+          // Fomat string with hostname.</span>
<a href="#l34.1804"></a><span id="l34.1804" class="difflineplus">+          if (server) rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.1805"></a><span id="l34.1805" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.1806"></a><span id="l34.1806" class="difflineplus">+            nsAutoString hostStr;</span>
<a href="#l34.1807"></a><span id="l34.1807" class="difflineplus">+            CopyASCIItoUTF16(hostName, hostStr);</span>
<a href="#l34.1808"></a><span id="l34.1808" class="difflineplus">+            const char16_t *params[] = {hostStr.get()};</span>
<a href="#l34.1809"></a><span id="l34.1809" class="difflineplus">+            mLocalBundle-&gt;FormatStringFromName(&quot;pop3ServerSaid&quot;, params, 1,</span>
<a href="#l34.1810"></a><span id="l34.1810" class="difflineplus">+                                               serverSaidPrefix);</span>
<a href="#l34.1811"></a><span id="l34.1811" class="difflineplus">+          }</span>
<a href="#l34.1812"></a><span id="l34.1812" class="difflineplus">+</span>
<a href="#l34.1813"></a><span id="l34.1813" class="difflineplus">+          nsAutoString message(alertString);</span>
<a href="#l34.1814"></a><span id="l34.1814" class="difflineplus">+          message.Append(' ');</span>
<a href="#l34.1815"></a><span id="l34.1815" class="difflineplus">+          message.Append(serverSaidPrefix);</span>
<a href="#l34.1816"></a><span id="l34.1816" class="difflineplus">+          message.Append(' ');</span>
<a href="#l34.1817"></a><span id="l34.1817" class="difflineplus">+          message.Append(NS_ConvertASCIItoUTF16(m_commandResponse));</span>
<a href="#l34.1818"></a><span id="l34.1818" class="difflineplus">+          dialog-&gt;Alert(dialogTitle.get(), message.get());</span>
<a href="#l34.1819"></a><span id="l34.1819">         }</span>
<a href="#l34.1820"></a><span id="l34.1820" class="difflineplus">+      }</span>
<a href="#l34.1821"></a><span id="l34.1821">     }</span>
<a href="#l34.1822"></a><span id="l34.1822" class="difflineminus">-    m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.1823"></a><span id="l34.1823" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.1824"></a><span id="l34.1824" class="difflineminus">-    return -1;</span>
<a href="#l34.1825"></a><span id="l34.1825" class="difflineplus">+  }</span>
<a href="#l34.1826"></a><span id="l34.1826" class="difflineplus">+  m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.1827"></a><span id="l34.1827" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.1828"></a><span id="l34.1828" class="difflineplus">+  return -1;</span>
<a href="#l34.1829"></a><span id="l34.1829"> }</span>
<a href="#l34.1830"></a><span id="l34.1830"> </span>
<a href="#l34.1831"></a><span id="l34.1831" class="difflineminus">-int32_t nsPop3Protocol::Pop3SendData(const char * dataBuffer, bool aSuppressLogging)</span>
<a href="#l34.1832"></a><span id="l34.1832" class="difflineminus">-{</span>
<a href="#l34.1833"></a><span id="l34.1833" class="difflineplus">+int32_t nsPop3Protocol::Pop3SendData(const char *dataBuffer,</span>
<a href="#l34.1834"></a><span id="l34.1834" class="difflineplus">+                                     bool aSuppressLogging) {</span>
<a href="#l34.1835"></a><span id="l34.1835">   // remove any leftover bytes in the line buffer</span>
<a href="#l34.1836"></a><span id="l34.1836">   // this can happen if the last message line doesn't end with a (CR)LF</span>
<a href="#l34.1837"></a><span id="l34.1837">   // or a server sent two reply lines</span>
<a href="#l34.1838"></a><span id="l34.1838">   m_lineStreamBuffer-&gt;ClearBuffer();</span>
<a href="#l34.1839"></a><span id="l34.1839"> </span>
<a href="#l34.1840"></a><span id="l34.1840">   nsresult result = nsMsgProtocol::SendData(dataBuffer);</span>
<a href="#l34.1841"></a><span id="l34.1841"> </span>
<a href="#l34.1842"></a><span id="l34.1842">   if (!aSuppressLogging)</span>
<a href="#l34.1843"></a><span id="l34.1843" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;SEND: %s&quot;), dataBuffer));</span>
<a href="#l34.1844"></a><span id="l34.1844" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;SEND: %s&quot;), dataBuffer));</span>
<a href="#l34.1845"></a><span id="l34.1845">   else</span>
<a href="#l34.1846"></a><span id="l34.1846" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.1847"></a><span id="l34.1847" class="difflineminus">-              (POP3LOG(&quot;Logging suppressed for this command (it probably contained authentication information)&quot;)));</span>
<a href="#l34.1848"></a><span id="l34.1848" class="difflineminus">-</span>
<a href="#l34.1849"></a><span id="l34.1849" class="difflineminus">-  if (NS_SUCCEEDED(result))</span>
<a href="#l34.1850"></a><span id="l34.1850" class="difflineminus">-  {</span>
<a href="#l34.1851"></a><span id="l34.1851" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.1852"></a><span id="l34.1852" class="difflineplus">+            (POP3LOG(&quot;Logging suppressed for this command (it probably &quot;</span>
<a href="#l34.1853"></a><span id="l34.1853" class="difflineplus">+                     &quot;contained authentication information)&quot;)));</span>
<a href="#l34.1854"></a><span id="l34.1854" class="difflineplus">+</span>
<a href="#l34.1855"></a><span id="l34.1855" class="difflineplus">+  if (NS_SUCCEEDED(result)) {</span>
<a href="#l34.1856"></a><span id="l34.1856">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.1857"></a><span id="l34.1857">     m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l34.1858"></a><span id="l34.1858">     return 0;</span>
<a href="#l34.1859"></a><span id="l34.1859">   }</span>
<a href="#l34.1860"></a><span id="l34.1860"> </span>
<a href="#l34.1861"></a><span id="l34.1861">   m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.1862"></a><span id="l34.1862" class="difflineminus">-  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;Pop3SendData failed: %&quot; PRIx32), static_cast&lt;uint32_t&gt;(result)));</span>
<a href="#l34.1863"></a><span id="l34.1863" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.1864"></a><span id="l34.1864" class="difflineplus">+          (POP3LOG(&quot;Pop3SendData failed: %&quot; PRIx32),</span>
<a href="#l34.1865"></a><span id="l34.1865" class="difflineplus">+           static_cast&lt;uint32_t&gt;(result)));</span>
<a href="#l34.1866"></a><span id="l34.1866">   return -1;</span>
<a href="#l34.1867"></a><span id="l34.1867"> }</span>
<a href="#l34.1868"></a><span id="l34.1868"> </span>
<a href="#l34.1869"></a><span id="l34.1869"> /*</span>
<a href="#l34.1870"></a><span id="l34.1870">  * POP3 AUTH extension</span>
<a href="#l34.1871"></a><span id="l34.1871">  */</span>
<a href="#l34.1872"></a><span id="l34.1872"> </span>
<a href="#l34.1873"></a><span id="l34.1873" class="difflineminus">-int32_t nsPop3Protocol::SendAuth()</span>
<a href="#l34.1874"></a><span id="l34.1874" class="difflineminus">-{</span>
<a href="#l34.1875"></a><span id="l34.1875" class="difflineplus">+int32_t nsPop3Protocol::SendAuth() {</span>
<a href="#l34.1876"></a><span id="l34.1876">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendAuth()&quot;)));</span>
<a href="#l34.1877"></a><span id="l34.1877"> </span>
<a href="#l34.1878"></a><span id="l34.1878" class="difflineminus">-  if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.1879"></a><span id="l34.1879" class="difflineminus">-    return Error(&quot;pop3ServerError&quot;);</span>
<a href="#l34.1880"></a><span id="l34.1880" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3ServerError&quot;);</span>
<a href="#l34.1881"></a><span id="l34.1881"> </span>
<a href="#l34.1882"></a><span id="l34.1882">   nsAutoCString command(&quot;AUTH&quot; CRLF);</span>
<a href="#l34.1883"></a><span id="l34.1883"> </span>
<a href="#l34.1884"></a><span id="l34.1884">   m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_RESPONSE;</span>
<a href="#l34.1885"></a><span id="l34.1885">   return Pop3SendData(command.get());</span>
<a href="#l34.1886"></a><span id="l34.1886"> }</span>
<a href="#l34.1887"></a><span id="l34.1887"> </span>
<a href="#l34.1888"></a><span id="l34.1888" class="difflineminus">-int32_t nsPop3Protocol::AuthResponse(nsIInputStream* inputStream,</span>
<a href="#l34.1889"></a><span id="l34.1889" class="difflineminus">-                             uint32_t length)</span>
<a href="#l34.1890"></a><span id="l34.1890" class="difflineminus">-{</span>
<a href="#l34.1891"></a><span id="l34.1891" class="difflineminus">-    char * line;</span>
<a href="#l34.1892"></a><span id="l34.1892" class="difflineminus">-    uint32_t ln = 0;</span>
<a href="#l34.1893"></a><span id="l34.1893" class="difflineminus">-    nsresult rv;</span>
<a href="#l34.1894"></a><span id="l34.1894" class="difflineminus">-</span>
<a href="#l34.1895"></a><span id="l34.1895" class="difflineminus">-    if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l34.1896"></a><span id="l34.1896" class="difflineminus">-    {</span>
<a href="#l34.1897"></a><span id="l34.1897" class="difflineminus">-        ClearCapFlag(POP3_AUTH_MECH_UNDEFINED);</span>
<a href="#l34.1898"></a><span id="l34.1898" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1899"></a><span id="l34.1899" class="difflineminus">-    }</span>
<a href="#l34.1900"></a><span id="l34.1900" class="difflineminus">-</span>
<a href="#l34.1901"></a><span id="l34.1901" class="difflineminus">-    if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.1902"></a><span id="l34.1902" class="difflineminus">-    {</span>
<a href="#l34.1903"></a><span id="l34.1903" class="difflineminus">-        /* AUTH command not implemented</span>
<a href="#l34.1904"></a><span id="l34.1904" class="difflineminus">-         * so no secure mechanisms available</span>
<a href="#l34.1905"></a><span id="l34.1905" class="difflineminus">-         */</span>
<a href="#l34.1906"></a><span id="l34.1906" class="difflineminus">-        m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.1907"></a><span id="l34.1907" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1908"></a><span id="l34.1908" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l34.1909"></a><span id="l34.1909" class="difflineminus">-        return 0;</span>
<a href="#l34.1910"></a><span id="l34.1910" class="difflineminus">-    }</span>
<a href="#l34.1911"></a><span id="l34.1911" class="difflineminus">-</span>
<a href="#l34.1912"></a><span id="l34.1912" class="difflineminus">-    bool pauseForMoreData = false;</span>
<a href="#l34.1913"></a><span id="l34.1913" class="difflineminus">-    line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.1914"></a><span id="l34.1914" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.1915"></a><span id="l34.1915" class="difflineminus">-      return -1;</span>
<a href="#l34.1916"></a><span id="l34.1916" class="difflineminus">-</span>
<a href="#l34.1917"></a><span id="l34.1917" class="difflineminus">-    if(pauseForMoreData || !line)</span>
<a href="#l34.1918"></a><span id="l34.1918" class="difflineminus">-    {</span>
<a href="#l34.1919"></a><span id="l34.1919" class="difflineminus">-        m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l34.1920"></a><span id="l34.1920" class="difflineminus">-        PR_Free(line);</span>
<a href="#l34.1921"></a><span id="l34.1921" class="difflineminus">-        return(0);</span>
<a href="#l34.1922"></a><span id="l34.1922" class="difflineminus">-    }</span>
<a href="#l34.1923"></a><span id="l34.1923" class="difflineminus">-</span>
<a href="#l34.1924"></a><span id="l34.1924" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.1925"></a><span id="l34.1925" class="difflineminus">-</span>
<a href="#l34.1926"></a><span id="l34.1926" class="difflineminus">-    if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l34.1927"></a><span id="l34.1927" class="difflineminus">-    {</span>
<a href="#l34.1928"></a><span id="l34.1928" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1929"></a><span id="l34.1929" class="difflineminus">-</span>
<a href="#l34.1930"></a><span id="l34.1930" class="difflineminus">-        // now that we've read all the AUTH responses, go for it</span>
<a href="#l34.1931"></a><span id="l34.1931" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l34.1932"></a><span id="l34.1932" class="difflineminus">-        m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l34.1933"></a><span id="l34.1933" class="difflineminus">-    }</span>
<a href="#l34.1934"></a><span id="l34.1934" class="difflineminus">-    else if (!PL_strcasecmp (line, &quot;CRAM-MD5&quot;))</span>
<a href="#l34.1935"></a><span id="l34.1935" class="difflineminus">-      SetCapFlag(POP3_HAS_AUTH_CRAM_MD5);</span>
<a href="#l34.1936"></a><span id="l34.1936" class="difflineminus">-    else if (!PL_strcasecmp (line, &quot;NTLM&quot;))</span>
<a href="#l34.1937"></a><span id="l34.1937" class="difflineminus">-      SetCapFlag(POP3_HAS_AUTH_NTLM);</span>
<a href="#l34.1938"></a><span id="l34.1938" class="difflineminus">-    else if (!PL_strcasecmp (line, &quot;MSN&quot;))</span>
<a href="#l34.1939"></a><span id="l34.1939" class="difflineminus">-      SetCapFlag(POP3_HAS_AUTH_NTLM|POP3_HAS_AUTH_MSN);</span>
<a href="#l34.1940"></a><span id="l34.1940" class="difflineminus">-    else if (!PL_strcasecmp (line, &quot;GSSAPI&quot;))</span>
<a href="#l34.1941"></a><span id="l34.1941" class="difflineminus">-        SetCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.1942"></a><span id="l34.1942" class="difflineminus">-    else if (!PL_strcasecmp (line, &quot;PLAIN&quot;))</span>
<a href="#l34.1943"></a><span id="l34.1943" class="difflineminus">-        SetCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l34.1944"></a><span id="l34.1944" class="difflineminus">-    else if (!PL_strcasecmp (line, &quot;LOGIN&quot;))</span>
<a href="#l34.1945"></a><span id="l34.1945" class="difflineminus">-        SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.1946"></a><span id="l34.1946" class="difflineminus">-</span>
<a href="#l34.1947"></a><span id="l34.1947" class="difflineplus">+int32_t nsPop3Protocol::AuthResponse(nsIInputStream *inputStream,</span>
<a href="#l34.1948"></a><span id="l34.1948" class="difflineplus">+                                     uint32_t length) {</span>
<a href="#l34.1949"></a><span id="l34.1949" class="difflineplus">+  char *line;</span>
<a href="#l34.1950"></a><span id="l34.1950" class="difflineplus">+  uint32_t ln = 0;</span>
<a href="#l34.1951"></a><span id="l34.1951" class="difflineplus">+  nsresult rv;</span>
<a href="#l34.1952"></a><span id="l34.1952" class="difflineplus">+</span>
<a href="#l34.1953"></a><span id="l34.1953" class="difflineplus">+  if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED)) {</span>
<a href="#l34.1954"></a><span id="l34.1954" class="difflineplus">+    ClearCapFlag(POP3_AUTH_MECH_UNDEFINED);</span>
<a href="#l34.1955"></a><span id="l34.1955" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1956"></a><span id="l34.1956" class="difflineplus">+  }</span>
<a href="#l34.1957"></a><span id="l34.1957" class="difflineplus">+</span>
<a href="#l34.1958"></a><span id="l34.1958" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.1959"></a><span id="l34.1959" class="difflineplus">+    /* AUTH command not implemented</span>
<a href="#l34.1960"></a><span id="l34.1960" class="difflineplus">+     * so no secure mechanisms available</span>
<a href="#l34.1961"></a><span id="l34.1961" class="difflineplus">+     */</span>
<a href="#l34.1962"></a><span id="l34.1962" class="difflineplus">+    m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.1963"></a><span id="l34.1963" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1964"></a><span id="l34.1964" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l34.1965"></a><span id="l34.1965" class="difflineplus">+    return 0;</span>
<a href="#l34.1966"></a><span id="l34.1966" class="difflineplus">+  }</span>
<a href="#l34.1967"></a><span id="l34.1967" class="difflineplus">+</span>
<a href="#l34.1968"></a><span id="l34.1968" class="difflineplus">+  bool pauseForMoreData = false;</span>
<a href="#l34.1969"></a><span id="l34.1969" class="difflineplus">+  line =</span>
<a href="#l34.1970"></a><span id="l34.1970" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.1971"></a><span id="l34.1971" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.1972"></a><span id="l34.1972" class="difflineplus">+</span>
<a href="#l34.1973"></a><span id="l34.1973" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.1974"></a><span id="l34.1974" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l34.1975"></a><span id="l34.1975">     PR_Free(line);</span>
<a href="#l34.1976"></a><span id="l34.1976" class="difflineminus">-    return 0;</span>
<a href="#l34.1977"></a><span id="l34.1977" class="difflineplus">+    return (0);</span>
<a href="#l34.1978"></a><span id="l34.1978" class="difflineplus">+  }</span>
<a href="#l34.1979"></a><span id="l34.1979" class="difflineplus">+</span>
<a href="#l34.1980"></a><span id="l34.1980" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.1981"></a><span id="l34.1981" class="difflineplus">+</span>
<a href="#l34.1982"></a><span id="l34.1982" class="difflineplus">+  if (!PL_strcmp(line, &quot;.&quot;)) {</span>
<a href="#l34.1983"></a><span id="l34.1983" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.1984"></a><span id="l34.1984" class="difflineplus">+</span>
<a href="#l34.1985"></a><span id="l34.1985" class="difflineplus">+    // now that we've read all the AUTH responses, go for it</span>
<a href="#l34.1986"></a><span id="l34.1986" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l34.1987"></a><span id="l34.1987" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l34.1988"></a><span id="l34.1988" class="difflineplus">+  } else if (!PL_strcasecmp(line, &quot;CRAM-MD5&quot;))</span>
<a href="#l34.1989"></a><span id="l34.1989" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_CRAM_MD5);</span>
<a href="#l34.1990"></a><span id="l34.1990" class="difflineplus">+  else if (!PL_strcasecmp(line, &quot;NTLM&quot;))</span>
<a href="#l34.1991"></a><span id="l34.1991" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_NTLM);</span>
<a href="#l34.1992"></a><span id="l34.1992" class="difflineplus">+  else if (!PL_strcasecmp(line, &quot;MSN&quot;))</span>
<a href="#l34.1993"></a><span id="l34.1993" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN);</span>
<a href="#l34.1994"></a><span id="l34.1994" class="difflineplus">+  else if (!PL_strcasecmp(line, &quot;GSSAPI&quot;))</span>
<a href="#l34.1995"></a><span id="l34.1995" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.1996"></a><span id="l34.1996" class="difflineplus">+  else if (!PL_strcasecmp(line, &quot;PLAIN&quot;))</span>
<a href="#l34.1997"></a><span id="l34.1997" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l34.1998"></a><span id="l34.1998" class="difflineplus">+  else if (!PL_strcasecmp(line, &quot;LOGIN&quot;))</span>
<a href="#l34.1999"></a><span id="l34.1999" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.2000"></a><span id="l34.2000" class="difflineplus">+</span>
<a href="#l34.2001"></a><span id="l34.2001" class="difflineplus">+  PR_Free(line);</span>
<a href="#l34.2002"></a><span id="l34.2002" class="difflineplus">+  return 0;</span>
<a href="#l34.2003"></a><span id="l34.2003"> }</span>
<a href="#l34.2004"></a><span id="l34.2004"> </span>
<a href="#l34.2005"></a><span id="l34.2005"> /*</span>
<a href="#l34.2006"></a><span id="l34.2006">  * POP3 CAPA extension, see RFC 2449, chapter 5</span>
<a href="#l34.2007"></a><span id="l34.2007">  */</span>
<a href="#l34.2008"></a><span id="l34.2008"> </span>
<a href="#l34.2009"></a><span id="l34.2009" class="difflineminus">-int32_t nsPop3Protocol::SendCapa()</span>
<a href="#l34.2010"></a><span id="l34.2010" class="difflineminus">-{</span>
<a href="#l34.2011"></a><span id="l34.2011" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendCapa()&quot;)));</span>
<a href="#l34.2012"></a><span id="l34.2012" class="difflineminus">-    if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.2013"></a><span id="l34.2013" class="difflineminus">-        return Error(&quot;pop3ServerError&quot;);</span>
<a href="#l34.2014"></a><span id="l34.2014" class="difflineminus">-</span>
<a href="#l34.2015"></a><span id="l34.2015" class="difflineminus">-    nsAutoCString command(&quot;CAPA&quot; CRLF);</span>
<a href="#l34.2016"></a><span id="l34.2016" class="difflineminus">-</span>
<a href="#l34.2017"></a><span id="l34.2017" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_CAPA_RESPONSE;</span>
<a href="#l34.2018"></a><span id="l34.2018" class="difflineminus">-    return Pop3SendData(command.get());</span>
<a href="#l34.2019"></a><span id="l34.2019" class="difflineplus">+int32_t nsPop3Protocol::SendCapa() {</span>
<a href="#l34.2020"></a><span id="l34.2020" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendCapa()&quot;)));</span>
<a href="#l34.2021"></a><span id="l34.2021" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3ServerError&quot;);</span>
<a href="#l34.2022"></a><span id="l34.2022" class="difflineplus">+</span>
<a href="#l34.2023"></a><span id="l34.2023" class="difflineplus">+  nsAutoCString command(&quot;CAPA&quot; CRLF);</span>
<a href="#l34.2024"></a><span id="l34.2024" class="difflineplus">+</span>
<a href="#l34.2025"></a><span id="l34.2025" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_CAPA_RESPONSE;</span>
<a href="#l34.2026"></a><span id="l34.2026" class="difflineplus">+  return Pop3SendData(command.get());</span>
<a href="#l34.2027"></a><span id="l34.2027"> }</span>
<a href="#l34.2028"></a><span id="l34.2028"> </span>
<a href="#l34.2029"></a><span id="l34.2029" class="difflineminus">-int32_t nsPop3Protocol::CapaResponse(nsIInputStream* inputStream,</span>
<a href="#l34.2030"></a><span id="l34.2030" class="difflineminus">-                             uint32_t length)</span>
<a href="#l34.2031"></a><span id="l34.2031" class="difflineminus">-{</span>
<a href="#l34.2032"></a><span id="l34.2032" class="difflineminus">-    char * line;</span>
<a href="#l34.2033"></a><span id="l34.2033" class="difflineminus">-    uint32_t ln = 0;</span>
<a href="#l34.2034"></a><span id="l34.2034" class="difflineminus">-</span>
<a href="#l34.2035"></a><span id="l34.2035" class="difflineminus">-    if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.2036"></a><span id="l34.2036" class="difflineminus">-    {</span>
<a href="#l34.2037"></a><span id="l34.2037" class="difflineminus">-        /* CAPA command not implemented */</span>
<a href="#l34.2038"></a><span id="l34.2038" class="difflineminus">-        m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.2039"></a><span id="l34.2039" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2040"></a><span id="l34.2040" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2041"></a><span id="l34.2041" class="difflineminus">-        return 0;</span>
<a href="#l34.2042"></a><span id="l34.2042" class="difflineminus">-    }</span>
<a href="#l34.2043"></a><span id="l34.2043" class="difflineminus">-</span>
<a href="#l34.2044"></a><span id="l34.2044" class="difflineminus">-    bool pauseForMoreData = false;</span>
<a href="#l34.2045"></a><span id="l34.2045" class="difflineminus">-    nsresult rv;</span>
<a href="#l34.2046"></a><span id="l34.2046" class="difflineminus">-    line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.2047"></a><span id="l34.2047" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.2048"></a><span id="l34.2048" class="difflineminus">-      return -1;</span>
<a href="#l34.2049"></a><span id="l34.2049" class="difflineminus">-</span>
<a href="#l34.2050"></a><span id="l34.2050" class="difflineminus">-    if(pauseForMoreData || !line)</span>
<a href="#l34.2051"></a><span id="l34.2051" class="difflineminus">-    {</span>
<a href="#l34.2052"></a><span id="l34.2052" class="difflineminus">-        m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l34.2053"></a><span id="l34.2053" class="difflineminus">-        PR_Free(line);</span>
<a href="#l34.2054"></a><span id="l34.2054" class="difflineminus">-        return(0);</span>
<a href="#l34.2055"></a><span id="l34.2055" class="difflineminus">-    }</span>
<a href="#l34.2056"></a><span id="l34.2056" class="difflineminus">-</span>
<a href="#l34.2057"></a><span id="l34.2057" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.2058"></a><span id="l34.2058" class="difflineminus">-</span>
<a href="#l34.2059"></a><span id="l34.2059" class="difflineminus">-    if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l34.2060"></a><span id="l34.2060" class="difflineminus">-    {</span>
<a href="#l34.2061"></a><span id="l34.2061" class="difflineminus">-        // now that we've read all the CAPA responses, go for it</span>
<a href="#l34.2062"></a><span id="l34.2062" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2063"></a><span id="l34.2063" class="difflineminus">-        m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l34.2064"></a><span id="l34.2064" class="difflineminus">-    }</span>
<a href="#l34.2065"></a><span id="l34.2065" class="difflineminus">-    else</span>
<a href="#l34.2066"></a><span id="l34.2066" class="difflineminus">-    if (!PL_strcasecmp(line, &quot;XSENDER&quot;))</span>
<a href="#l34.2067"></a><span id="l34.2067" class="difflineminus">-    {</span>
<a href="#l34.2068"></a><span id="l34.2068" class="difflineminus">-        SetCapFlag(POP3_HAS_XSENDER);</span>
<a href="#l34.2069"></a><span id="l34.2069" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2070"></a><span id="l34.2070" class="difflineminus">-    }</span>
<a href="#l34.2071"></a><span id="l34.2071" class="difflineminus">-    else</span>
<a href="#l34.2072"></a><span id="l34.2072" class="difflineminus">-    // see RFC 2449, chapter 6.4</span>
<a href="#l34.2073"></a><span id="l34.2073" class="difflineminus">-    if (!PL_strcasecmp(line, &quot;RESP-CODES&quot;))</span>
<a href="#l34.2074"></a><span id="l34.2074" class="difflineminus">-    {</span>
<a href="#l34.2075"></a><span id="l34.2075" class="difflineminus">-        SetCapFlag(POP3_HAS_RESP_CODES);</span>
<a href="#l34.2076"></a><span id="l34.2076" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2077"></a><span id="l34.2077" class="difflineminus">-    }</span>
<a href="#l34.2078"></a><span id="l34.2078" class="difflineminus">-    else</span>
<a href="#l34.2079"></a><span id="l34.2079" class="difflineminus">-    // see RFC 3206, chapter 6</span>
<a href="#l34.2080"></a><span id="l34.2080" class="difflineminus">-    if (!PL_strcasecmp(line, &quot;AUTH-RESP-CODE&quot;))</span>
<a href="#l34.2081"></a><span id="l34.2081" class="difflineminus">-    {</span>
<a href="#l34.2082"></a><span id="l34.2082" class="difflineminus">-        SetCapFlag(POP3_HAS_AUTH_RESP_CODE);</span>
<a href="#l34.2083"></a><span id="l34.2083" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2084"></a><span id="l34.2084" class="difflineminus">-    }</span>
<a href="#l34.2085"></a><span id="l34.2085" class="difflineminus">-    else</span>
<a href="#l34.2086"></a><span id="l34.2086" class="difflineminus">-    // see RFC 2595, chapter 4</span>
<a href="#l34.2087"></a><span id="l34.2087" class="difflineminus">-    if (!PL_strcasecmp(line, &quot;STLS&quot;))</span>
<a href="#l34.2088"></a><span id="l34.2088" class="difflineminus">-    {</span>
<a href="#l34.2089"></a><span id="l34.2089" class="difflineminus">-      SetCapFlag(POP3_HAS_STLS);</span>
<a href="#l34.2090"></a><span id="l34.2090" class="difflineminus">-      m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2091"></a><span id="l34.2091" class="difflineminus">-    }</span>
<a href="#l34.2092"></a><span id="l34.2092" class="difflineminus">-    else</span>
<a href="#l34.2093"></a><span id="l34.2093" class="difflineminus">-    // see RFC 2449, chapter 6.3</span>
<a href="#l34.2094"></a><span id="l34.2094" class="difflineminus">-    if (!PL_strncasecmp(line, &quot;SASL&quot;, 4) &amp;&amp; strlen(line) &gt; 6)</span>
<a href="#l34.2095"></a><span id="l34.2095" class="difflineminus">-    {</span>
<a href="#l34.2096"></a><span id="l34.2096" class="difflineminus">-        nsAutoCString responseLine;</span>
<a href="#l34.2097"></a><span id="l34.2097" class="difflineminus">-        responseLine.Assign(line + 5);</span>
<a href="#l34.2098"></a><span id="l34.2098" class="difflineminus">-</span>
<a href="#l34.2099"></a><span id="l34.2099" class="difflineminus">-        if (responseLine.Find(&quot;PLAIN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2100"></a><span id="l34.2100" class="difflineminus">-            SetCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l34.2101"></a><span id="l34.2101" class="difflineminus">-</span>
<a href="#l34.2102"></a><span id="l34.2102" class="difflineminus">-        if (responseLine.Find(&quot;LOGIN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2103"></a><span id="l34.2103" class="difflineminus">-            SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.2104"></a><span id="l34.2104" class="difflineminus">-</span>
<a href="#l34.2105"></a><span id="l34.2105" class="difflineminus">-        if (responseLine.Find(&quot;GSSAPI&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2106"></a><span id="l34.2106" class="difflineminus">-            SetCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.2107"></a><span id="l34.2107" class="difflineminus">-</span>
<a href="#l34.2108"></a><span id="l34.2108" class="difflineminus">-        if (responseLine.Find(&quot;CRAM-MD5&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2109"></a><span id="l34.2109" class="difflineminus">-          SetCapFlag(POP3_HAS_AUTH_CRAM_MD5);</span>
<a href="#l34.2110"></a><span id="l34.2110" class="difflineminus">-</span>
<a href="#l34.2111"></a><span id="l34.2111" class="difflineminus">-        if (responseLine.Find(&quot;NTLM&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2112"></a><span id="l34.2112" class="difflineminus">-          SetCapFlag(POP3_HAS_AUTH_NTLM);</span>
<a href="#l34.2113"></a><span id="l34.2113" class="difflineminus">-</span>
<a href="#l34.2114"></a><span id="l34.2114" class="difflineminus">-        if (responseLine.Find(&quot;MSN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2115"></a><span id="l34.2115" class="difflineminus">-          SetCapFlag(POP3_HAS_AUTH_NTLM|POP3_HAS_AUTH_MSN);</span>
<a href="#l34.2116"></a><span id="l34.2116" class="difflineminus">-</span>
<a href="#l34.2117"></a><span id="l34.2117" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2118"></a><span id="l34.2118" class="difflineminus">-    }</span>
<a href="#l34.2119"></a><span id="l34.2119" class="difflineminus">-</span>
<a href="#l34.2120"></a><span id="l34.2120" class="difflineplus">+int32_t nsPop3Protocol::CapaResponse(nsIInputStream *inputStream,</span>
<a href="#l34.2121"></a><span id="l34.2121" class="difflineplus">+                                     uint32_t length) {</span>
<a href="#l34.2122"></a><span id="l34.2122" class="difflineplus">+  char *line;</span>
<a href="#l34.2123"></a><span id="l34.2123" class="difflineplus">+  uint32_t ln = 0;</span>
<a href="#l34.2124"></a><span id="l34.2124" class="difflineplus">+</span>
<a href="#l34.2125"></a><span id="l34.2125" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.2126"></a><span id="l34.2126" class="difflineplus">+    /* CAPA command not implemented */</span>
<a href="#l34.2127"></a><span id="l34.2127" class="difflineplus">+    m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.2128"></a><span id="l34.2128" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2129"></a><span id="l34.2129" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2130"></a><span id="l34.2130" class="difflineplus">+    return 0;</span>
<a href="#l34.2131"></a><span id="l34.2131" class="difflineplus">+  }</span>
<a href="#l34.2132"></a><span id="l34.2132" class="difflineplus">+</span>
<a href="#l34.2133"></a><span id="l34.2133" class="difflineplus">+  bool pauseForMoreData = false;</span>
<a href="#l34.2134"></a><span id="l34.2134" class="difflineplus">+  nsresult rv;</span>
<a href="#l34.2135"></a><span id="l34.2135" class="difflineplus">+  line =</span>
<a href="#l34.2136"></a><span id="l34.2136" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.2137"></a><span id="l34.2137" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.2138"></a><span id="l34.2138" class="difflineplus">+</span>
<a href="#l34.2139"></a><span id="l34.2139" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.2140"></a><span id="l34.2140" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = true; /* pause */</span>
<a href="#l34.2141"></a><span id="l34.2141">     PR_Free(line);</span>
<a href="#l34.2142"></a><span id="l34.2142" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;Capability entry processed&quot;)));</span>
<a href="#l34.2143"></a><span id="l34.2143" class="difflineminus">-    return 0;</span>
<a href="#l34.2144"></a><span id="l34.2144" class="difflineplus">+    return (0);</span>
<a href="#l34.2145"></a><span id="l34.2145" class="difflineplus">+  }</span>
<a href="#l34.2146"></a><span id="l34.2146" class="difflineplus">+</span>
<a href="#l34.2147"></a><span id="l34.2147" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.2148"></a><span id="l34.2148" class="difflineplus">+</span>
<a href="#l34.2149"></a><span id="l34.2149" class="difflineplus">+  if (!PL_strcmp(line, &quot;.&quot;)) {</span>
<a href="#l34.2150"></a><span id="l34.2150" class="difflineplus">+    // now that we've read all the CAPA responses, go for it</span>
<a href="#l34.2151"></a><span id="l34.2151" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2152"></a><span id="l34.2152" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = false; /* don't pause */</span>
<a href="#l34.2153"></a><span id="l34.2153" class="difflineplus">+  } else if (!PL_strcasecmp(line, &quot;XSENDER&quot;)) {</span>
<a href="#l34.2154"></a><span id="l34.2154" class="difflineplus">+    SetCapFlag(POP3_HAS_XSENDER);</span>
<a href="#l34.2155"></a><span id="l34.2155" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2156"></a><span id="l34.2156" class="difflineplus">+  } else</span>
<a href="#l34.2157"></a><span id="l34.2157" class="difflineplus">+      // see RFC 2449, chapter 6.4</span>
<a href="#l34.2158"></a><span id="l34.2158" class="difflineplus">+      if (!PL_strcasecmp(line, &quot;RESP-CODES&quot;)) {</span>
<a href="#l34.2159"></a><span id="l34.2159" class="difflineplus">+    SetCapFlag(POP3_HAS_RESP_CODES);</span>
<a href="#l34.2160"></a><span id="l34.2160" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2161"></a><span id="l34.2161" class="difflineplus">+  } else</span>
<a href="#l34.2162"></a><span id="l34.2162" class="difflineplus">+      // see RFC 3206, chapter 6</span>
<a href="#l34.2163"></a><span id="l34.2163" class="difflineplus">+      if (!PL_strcasecmp(line, &quot;AUTH-RESP-CODE&quot;)) {</span>
<a href="#l34.2164"></a><span id="l34.2164" class="difflineplus">+    SetCapFlag(POP3_HAS_AUTH_RESP_CODE);</span>
<a href="#l34.2165"></a><span id="l34.2165" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2166"></a><span id="l34.2166" class="difflineplus">+  } else</span>
<a href="#l34.2167"></a><span id="l34.2167" class="difflineplus">+      // see RFC 2595, chapter 4</span>
<a href="#l34.2168"></a><span id="l34.2168" class="difflineplus">+      if (!PL_strcasecmp(line, &quot;STLS&quot;)) {</span>
<a href="#l34.2169"></a><span id="l34.2169" class="difflineplus">+    SetCapFlag(POP3_HAS_STLS);</span>
<a href="#l34.2170"></a><span id="l34.2170" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2171"></a><span id="l34.2171" class="difflineplus">+  } else</span>
<a href="#l34.2172"></a><span id="l34.2172" class="difflineplus">+      // see RFC 2449, chapter 6.3</span>
<a href="#l34.2173"></a><span id="l34.2173" class="difflineplus">+      if (!PL_strncasecmp(line, &quot;SASL&quot;, 4) &amp;&amp; strlen(line) &gt; 6) {</span>
<a href="#l34.2174"></a><span id="l34.2174" class="difflineplus">+    nsAutoCString responseLine;</span>
<a href="#l34.2175"></a><span id="l34.2175" class="difflineplus">+    responseLine.Assign(line + 5);</span>
<a href="#l34.2176"></a><span id="l34.2176" class="difflineplus">+</span>
<a href="#l34.2177"></a><span id="l34.2177" class="difflineplus">+    if (responseLine.Find(&quot;PLAIN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2178"></a><span id="l34.2178" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l34.2179"></a><span id="l34.2179" class="difflineplus">+</span>
<a href="#l34.2180"></a><span id="l34.2180" class="difflineplus">+    if (responseLine.Find(&quot;LOGIN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2181"></a><span id="l34.2181" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.2182"></a><span id="l34.2182" class="difflineplus">+</span>
<a href="#l34.2183"></a><span id="l34.2183" class="difflineplus">+    if (responseLine.Find(&quot;GSSAPI&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2184"></a><span id="l34.2184" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.2185"></a><span id="l34.2185" class="difflineplus">+</span>
<a href="#l34.2186"></a><span id="l34.2186" class="difflineplus">+    if (responseLine.Find(&quot;CRAM-MD5&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2187"></a><span id="l34.2187" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_CRAM_MD5);</span>
<a href="#l34.2188"></a><span id="l34.2188" class="difflineplus">+</span>
<a href="#l34.2189"></a><span id="l34.2189" class="difflineplus">+    if (responseLine.Find(&quot;NTLM&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2190"></a><span id="l34.2190" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_NTLM);</span>
<a href="#l34.2191"></a><span id="l34.2191" class="difflineplus">+</span>
<a href="#l34.2192"></a><span id="l34.2192" class="difflineplus">+    if (responseLine.Find(&quot;MSN&quot;, /* ignoreCase = */ true) &gt;= 0)</span>
<a href="#l34.2193"></a><span id="l34.2193" class="difflineplus">+      SetCapFlag(POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN);</span>
<a href="#l34.2194"></a><span id="l34.2194" class="difflineplus">+</span>
<a href="#l34.2195"></a><span id="l34.2195" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2196"></a><span id="l34.2196" class="difflineplus">+  }</span>
<a href="#l34.2197"></a><span id="l34.2197" class="difflineplus">+</span>
<a href="#l34.2198"></a><span id="l34.2198" class="difflineplus">+  PR_Free(line);</span>
<a href="#l34.2199"></a><span id="l34.2199" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2200"></a><span id="l34.2200" class="difflineplus">+          (POP3LOG(&quot;Capability entry processed&quot;)));</span>
<a href="#l34.2201"></a><span id="l34.2201" class="difflineplus">+  return 0;</span>
<a href="#l34.2202"></a><span id="l34.2202"> }</span>
<a href="#l34.2203"></a><span id="l34.2203"> </span>
<a href="#l34.2204"></a><span id="l34.2204" class="difflineminus">-int32_t nsPop3Protocol::SendTLSResponse()</span>
<a href="#l34.2205"></a><span id="l34.2205" class="difflineminus">-{</span>
<a href="#l34.2206"></a><span id="l34.2206" class="difflineplus">+int32_t nsPop3Protocol::SendTLSResponse() {</span>
<a href="#l34.2207"></a><span id="l34.2207">   // only tear down our existing connection and open a new one if we received</span>
<a href="#l34.2208"></a><span id="l34.2208">   // a +OK response from the pop server after we issued the STLS command</span>
<a href="#l34.2209"></a><span id="l34.2209">   nsresult rv = NS_OK;</span>
<a href="#l34.2210"></a><span id="l34.2210" class="difflineminus">-  if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.2211"></a><span id="l34.2211" class="difflineminus">-  {</span>
<a href="#l34.2212"></a><span id="l34.2212" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; secInfo;</span>
<a href="#l34.2213"></a><span id="l34.2213" class="difflineminus">-      nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport, &amp;rv);</span>
<a href="#l34.2214"></a><span id="l34.2214" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l34.2215"></a><span id="l34.2215" class="difflineminus">-        return -1;</span>
<a href="#l34.2216"></a><span id="l34.2216" class="difflineminus">-</span>
<a href="#l34.2217"></a><span id="l34.2217" class="difflineminus">-      rv = strans-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<a href="#l34.2218"></a><span id="l34.2218" class="difflineminus">-</span>
<a href="#l34.2219"></a><span id="l34.2219" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; secInfo)</span>
<a href="#l34.2220"></a><span id="l34.2220" class="difflineminus">-      {</span>
<a href="#l34.2221"></a><span id="l34.2221" class="difflineminus">-          nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl = do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l34.2222"></a><span id="l34.2222" class="difflineminus">-</span>
<a href="#l34.2223"></a><span id="l34.2223" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; sslControl)</span>
<a href="#l34.2224"></a><span id="l34.2224" class="difflineminus">-              rv = sslControl-&gt;StartTLS();</span>
<a href="#l34.2225"></a><span id="l34.2225" class="difflineminus">-      }</span>
<a href="#l34.2226"></a><span id="l34.2226" class="difflineminus">-</span>
<a href="#l34.2227"></a><span id="l34.2227" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l34.2228"></a><span id="l34.2228" class="difflineminus">-    {</span>
<a href="#l34.2229"></a><span id="l34.2229" class="difflineplus">+  if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.2230"></a><span id="l34.2230" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; secInfo;</span>
<a href="#l34.2231"></a><span id="l34.2231" class="difflineplus">+    nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport, &amp;rv);</span>
<a href="#l34.2232"></a><span id="l34.2232" class="difflineplus">+    if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.2233"></a><span id="l34.2233" class="difflineplus">+</span>
<a href="#l34.2234"></a><span id="l34.2234" class="difflineplus">+    rv = strans-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<a href="#l34.2235"></a><span id="l34.2235" class="difflineplus">+</span>
<a href="#l34.2236"></a><span id="l34.2236" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; secInfo) {</span>
<a href="#l34.2237"></a><span id="l34.2237" class="difflineplus">+      nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl =</span>
<a href="#l34.2238"></a><span id="l34.2238" class="difflineplus">+          do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l34.2239"></a><span id="l34.2239" class="difflineplus">+</span>
<a href="#l34.2240"></a><span id="l34.2240" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; sslControl) rv = sslControl-&gt;StartTLS();</span>
<a href="#l34.2241"></a><span id="l34.2241" class="difflineplus">+    }</span>
<a href="#l34.2242"></a><span id="l34.2242" class="difflineplus">+</span>
<a href="#l34.2243"></a><span id="l34.2243" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.2244"></a><span id="l34.2244">       m_pop3ConData-&gt;next_state = POP3_SEND_AUTH;</span>
<a href="#l34.2245"></a><span id="l34.2245">       m_tlsEnabled = true;</span>
<a href="#l34.2246"></a><span id="l34.2246"> </span>
<a href="#l34.2247"></a><span id="l34.2247">       // certain capabilities like POP3_HAS_AUTH_APOP should be</span>
<a href="#l34.2248"></a><span id="l34.2248">       // preserved across the connections.</span>
<a href="#l34.2249"></a><span id="l34.2249" class="difflineminus">-      uint32_t preservedCapFlags = m_pop3ConData-&gt;capability_flags &amp; POP3_HAS_AUTH_APOP;</span>
<a href="#l34.2250"></a><span id="l34.2250" class="difflineminus">-      m_pop3ConData-&gt;capability_flags =     // resetting the flags</span>
<a href="#l34.2251"></a><span id="l34.2251" class="difflineminus">-        POP3_AUTH_MECH_UNDEFINED |</span>
<a href="#l34.2252"></a><span id="l34.2252" class="difflineminus">-        POP3_HAS_AUTH_USER |                // should be always there</span>
<a href="#l34.2253"></a><span id="l34.2253" class="difflineminus">-        POP3_GURL_UNDEFINED |</span>
<a href="#l34.2254"></a><span id="l34.2254" class="difflineminus">-        POP3_UIDL_UNDEFINED |</span>
<a href="#l34.2255"></a><span id="l34.2255" class="difflineminus">-        POP3_TOP_UNDEFINED |</span>
<a href="#l34.2256"></a><span id="l34.2256" class="difflineminus">-        POP3_XTND_XLST_UNDEFINED |</span>
<a href="#l34.2257"></a><span id="l34.2257" class="difflineminus">-        preservedCapFlags;</span>
<a href="#l34.2258"></a><span id="l34.2258" class="difflineplus">+      uint32_t preservedCapFlags =</span>
<a href="#l34.2259"></a><span id="l34.2259" class="difflineplus">+          m_pop3ConData-&gt;capability_flags &amp; POP3_HAS_AUTH_APOP;</span>
<a href="#l34.2260"></a><span id="l34.2260" class="difflineplus">+      m_pop3ConData-&gt;capability_flags =  // resetting the flags</span>
<a href="#l34.2261"></a><span id="l34.2261" class="difflineplus">+          POP3_AUTH_MECH_UNDEFINED |</span>
<a href="#l34.2262"></a><span id="l34.2262" class="difflineplus">+          POP3_HAS_AUTH_USER |  // should be always there</span>
<a href="#l34.2263"></a><span id="l34.2263" class="difflineplus">+          POP3_GURL_UNDEFINED | POP3_UIDL_UNDEFINED | POP3_TOP_UNDEFINED |</span>
<a href="#l34.2264"></a><span id="l34.2264" class="difflineplus">+          POP3_XTND_XLST_UNDEFINED | preservedCapFlags;</span>
<a href="#l34.2265"></a><span id="l34.2265">       m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2266"></a><span id="l34.2266">       return 0;</span>
<a href="#l34.2267"></a><span id="l34.2267">     }</span>
<a href="#l34.2268"></a><span id="l34.2268">   }</span>
<a href="#l34.2269"></a><span id="l34.2269"> </span>
<a href="#l34.2270"></a><span id="l34.2270">   ClearFlag(POP3_HAS_STLS);</span>
<a href="#l34.2271"></a><span id="l34.2271">   m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2272"></a><span id="l34.2272"> </span>
<a href="#l34.2273"></a><span id="l34.2273">   return (NS_SUCCEEDED(rv) ? 0 : -1);</span>
<a href="#l34.2274"></a><span id="l34.2274"> }</span>
<a href="#l34.2275"></a><span id="l34.2275"> </span>
<a href="#l34.2276"></a><span id="l34.2276" class="difflineminus">-void nsPop3Protocol::InitPrefAuthMethods(int32_t authMethodPrefValue)</span>
<a href="#l34.2277"></a><span id="l34.2277" class="difflineminus">-{</span>
<a href="#l34.2278"></a><span id="l34.2278" class="difflineplus">+void nsPop3Protocol::InitPrefAuthMethods(int32_t authMethodPrefValue) {</span>
<a href="#l34.2279"></a><span id="l34.2279">   // for m_prefAuthMethods, using the same flags as server capabilities.</span>
<a href="#l34.2280"></a><span id="l34.2280" class="difflineminus">-  switch (authMethodPrefValue)</span>
<a href="#l34.2281"></a><span id="l34.2281" class="difflineminus">-  {</span>
<a href="#l34.2282"></a><span id="l34.2282" class="difflineplus">+  switch (authMethodPrefValue) {</span>
<a href="#l34.2283"></a><span id="l34.2283">     case nsMsgAuthMethod::none:</span>
<a href="#l34.2284"></a><span id="l34.2284">       m_prefAuthMethods = POP3_HAS_AUTH_NONE;</span>
<a href="#l34.2285"></a><span id="l34.2285">       break;</span>
<a href="#l34.2286"></a><span id="l34.2286">     case nsMsgAuthMethod::old:</span>
<a href="#l34.2287"></a><span id="l34.2287">       m_prefAuthMethods = POP3_HAS_AUTH_USER;</span>
<a href="#l34.2288"></a><span id="l34.2288">       break;</span>
<a href="#l34.2289"></a><span id="l34.2289">     case nsMsgAuthMethod::passwordCleartext:</span>
<a href="#l34.2290"></a><span id="l34.2290" class="difflineminus">-      m_prefAuthMethods = POP3_HAS_AUTH_USER |</span>
<a href="#l34.2291"></a><span id="l34.2291" class="difflineminus">-          POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN;</span>
<a href="#l34.2292"></a><span id="l34.2292" class="difflineplus">+      m_prefAuthMethods =</span>
<a href="#l34.2293"></a><span id="l34.2293" class="difflineplus">+          POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN;</span>
<a href="#l34.2294"></a><span id="l34.2294">       break;</span>
<a href="#l34.2295"></a><span id="l34.2295">     case nsMsgAuthMethod::passwordEncrypted:</span>
<a href="#l34.2296"></a><span id="l34.2296" class="difflineminus">-      m_prefAuthMethods = POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l34.2297"></a><span id="l34.2297" class="difflineminus">-          POP3_HAS_AUTH_APOP;</span>
<a href="#l34.2298"></a><span id="l34.2298" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP;</span>
<a href="#l34.2299"></a><span id="l34.2299">       break;</span>
<a href="#l34.2300"></a><span id="l34.2300">     case nsMsgAuthMethod::NTLM:</span>
<a href="#l34.2301"></a><span id="l34.2301">       m_prefAuthMethods = POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l34.2302"></a><span id="l34.2302">       break;</span>
<a href="#l34.2303"></a><span id="l34.2303">     case nsMsgAuthMethod::GSSAPI:</span>
<a href="#l34.2304"></a><span id="l34.2304">       m_prefAuthMethods = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l34.2305"></a><span id="l34.2305">       break;</span>
<a href="#l34.2306"></a><span id="l34.2306">     case nsMsgAuthMethod::secure:</span>
<a href="#l34.2307"></a><span id="l34.2307" class="difflineminus">-      m_prefAuthMethods = POP3_HAS_AUTH_APOP |</span>
<a href="#l34.2308"></a><span id="l34.2308" class="difflineminus">-          POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l34.2309"></a><span id="l34.2309" class="difflineminus">-          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l34.2310"></a><span id="l34.2310" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_APOP | POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l34.2311"></a><span id="l34.2311" class="difflineplus">+                          POP3_HAS_AUTH_GSSAPI | POP3_HAS_AUTH_NTLM |</span>
<a href="#l34.2312"></a><span id="l34.2312" class="difflineplus">+                          POP3_HAS_AUTH_MSN;</span>
<a href="#l34.2313"></a><span id="l34.2313">       break;</span>
<a href="#l34.2314"></a><span id="l34.2314">     default:</span>
<a href="#l34.2315"></a><span id="l34.2315">       NS_ASSERTION(false, &quot;POP: authMethod pref invalid&quot;);</span>
<a href="#l34.2316"></a><span id="l34.2316">       // TODO log to error console</span>
<a href="#l34.2317"></a><span id="l34.2317" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.2318"></a><span id="l34.2318" class="difflineminus">-              (POP3LOG(&quot;POP: bad pref authMethod = %d\n&quot;), authMethodPrefValue));</span>
<a href="#l34.2319"></a><span id="l34.2319" class="difflineplus">+      MOZ_LOG(</span>
<a href="#l34.2320"></a><span id="l34.2320" class="difflineplus">+          POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.2321"></a><span id="l34.2321" class="difflineplus">+          (POP3LOG(&quot;POP: bad pref authMethod = %d\n&quot;), authMethodPrefValue));</span>
<a href="#l34.2322"></a><span id="l34.2322">       // fall to any</span>
<a href="#l34.2323"></a><span id="l34.2323">       MOZ_FALLTHROUGH;</span>
<a href="#l34.2324"></a><span id="l34.2324">     case nsMsgAuthMethod::anything:</span>
<a href="#l34.2325"></a><span id="l34.2325" class="difflineminus">-      m_prefAuthMethods = POP3_HAS_AUTH_USER |</span>
<a href="#l34.2326"></a><span id="l34.2326" class="difflineminus">-          POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN |</span>
<a href="#l34.2327"></a><span id="l34.2327" class="difflineminus">-          POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP |</span>
<a href="#l34.2328"></a><span id="l34.2328" class="difflineminus">-          POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l34.2329"></a><span id="l34.2329" class="difflineminus">-          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l34.2330"></a><span id="l34.2330" class="difflineplus">+      m_prefAuthMethods = POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l34.2331"></a><span id="l34.2331" class="difflineplus">+                          POP3_HAS_AUTH_PLAIN | POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l34.2332"></a><span id="l34.2332" class="difflineplus">+                          POP3_HAS_AUTH_APOP | POP3_HAS_AUTH_GSSAPI |</span>
<a href="#l34.2333"></a><span id="l34.2333" class="difflineplus">+                          POP3_HAS_AUTH_NTLM | POP3_HAS_AUTH_MSN;</span>
<a href="#l34.2334"></a><span id="l34.2334">       // TODO needed?</span>
<a href="#l34.2335"></a><span id="l34.2335">       break;</span>
<a href="#l34.2336"></a><span id="l34.2336">   }</span>
<a href="#l34.2337"></a><span id="l34.2337">   NS_ASSERTION(m_prefAuthMethods != POP3_AUTH_MECH_UNDEFINED,</span>
<a href="#l34.2338"></a><span id="l34.2338" class="difflineminus">-      &quot;POP: InitPrefAuthMethods() didn't work&quot;);</span>
<a href="#l34.2339"></a><span id="l34.2339" class="difflineplus">+               &quot;POP: InitPrefAuthMethods() didn't work&quot;);</span>
<a href="#l34.2340"></a><span id="l34.2340"> }</span>
<a href="#l34.2341"></a><span id="l34.2341"> </span>
<a href="#l34.2342"></a><span id="l34.2342"> /**</span>
<a href="#l34.2343"></a><span id="l34.2343">  * Changes m_currentAuthMethod to pick the best one</span>
<a href="#l34.2344"></a><span id="l34.2344">  * which is allowed by server and prefs and not marked failed.</span>
<a href="#l34.2345"></a><span id="l34.2345">  * The order of preference and trying of auth methods is encoded here.</span>
<a href="#l34.2346"></a><span id="l34.2346">  */</span>
<a href="#l34.2347"></a><span id="l34.2347" class="difflineminus">-nsresult nsPop3Protocol::ChooseAuthMethod()</span>
<a href="#l34.2348"></a><span id="l34.2348" class="difflineminus">-{</span>
<a href="#l34.2349"></a><span id="l34.2349" class="difflineplus">+nsresult nsPop3Protocol::ChooseAuthMethod() {</span>
<a href="#l34.2350"></a><span id="l34.2350">   int32_t availCaps = GetCapFlags() &amp; m_prefAuthMethods &amp; ~m_failedAuthMethods;</span>
<a href="#l34.2351"></a><span id="l34.2351"> </span>
<a href="#l34.2352"></a><span id="l34.2352">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2353"></a><span id="l34.2353" class="difflineminus">-          (POP3LOG(&quot;POP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail caps 0x%X&quot;),</span>
<a href="#l34.2354"></a><span id="l34.2354" class="difflineplus">+          (POP3LOG(&quot;POP auth: server caps 0x%X, pref 0x%X, failed 0x%X, avail &quot;</span>
<a href="#l34.2355"></a><span id="l34.2355" class="difflineplus">+                   &quot;caps 0x%X&quot;),</span>
<a href="#l34.2356"></a><span id="l34.2356">            GetCapFlags(), m_prefAuthMethods, m_failedAuthMethods, availCaps));</span>
<a href="#l34.2357"></a><span id="l34.2357" class="difflineminus">-  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2358"></a><span id="l34.2358" class="difflineminus">-          (POP3LOG(&quot;(GSSAPI = 0x%X, CRAM = 0x%X, APOP = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l34.2359"></a><span id="l34.2359" class="difflineminus">-           &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, USER/PASS = 0x%X)&quot;),</span>
<a href="#l34.2360"></a><span id="l34.2360" class="difflineminus">-           POP3_HAS_AUTH_GSSAPI, POP3_HAS_AUTH_CRAM_MD5, POP3_HAS_AUTH_APOP,</span>
<a href="#l34.2361"></a><span id="l34.2361" class="difflineminus">-           POP3_HAS_AUTH_NTLM, POP3_HAS_AUTH_MSN, POP3_HAS_AUTH_PLAIN,</span>
<a href="#l34.2362"></a><span id="l34.2362" class="difflineminus">-           POP3_HAS_AUTH_LOGIN, POP3_HAS_AUTH_USER));</span>
<a href="#l34.2363"></a><span id="l34.2363" class="difflineplus">+  MOZ_LOG(</span>
<a href="#l34.2364"></a><span id="l34.2364" class="difflineplus">+      POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2365"></a><span id="l34.2365" class="difflineplus">+      (POP3LOG(&quot;(GSSAPI = 0x%X, CRAM = 0x%X, APOP = 0x%X, NTLM = 0x%X, &quot;</span>
<a href="#l34.2366"></a><span id="l34.2366" class="difflineplus">+               &quot;MSN =  0x%X, PLAIN = 0x%X, LOGIN = 0x%X, USER/PASS = 0x%X)&quot;),</span>
<a href="#l34.2367"></a><span id="l34.2367" class="difflineplus">+       POP3_HAS_AUTH_GSSAPI, POP3_HAS_AUTH_CRAM_MD5, POP3_HAS_AUTH_APOP,</span>
<a href="#l34.2368"></a><span id="l34.2368" class="difflineplus">+       POP3_HAS_AUTH_NTLM, POP3_HAS_AUTH_MSN, POP3_HAS_AUTH_PLAIN,</span>
<a href="#l34.2369"></a><span id="l34.2369" class="difflineplus">+       POP3_HAS_AUTH_LOGIN, POP3_HAS_AUTH_USER));</span>
<a href="#l34.2370"></a><span id="l34.2370"> </span>
<a href="#l34.2371"></a><span id="l34.2371">   if (POP3_HAS_AUTH_GSSAPI &amp; availCaps)</span>
<a href="#l34.2372"></a><span id="l34.2372">     m_currentAuthMethod = POP3_HAS_AUTH_GSSAPI;</span>
<a href="#l34.2373"></a><span id="l34.2373">   else if (POP3_HAS_AUTH_CRAM_MD5 &amp; availCaps)</span>
<a href="#l34.2374"></a><span id="l34.2374">     m_currentAuthMethod = POP3_HAS_AUTH_CRAM_MD5;</span>
<a href="#l34.2375"></a><span id="l34.2375">   else if (POP3_HAS_AUTH_APOP &amp; availCaps)</span>
<a href="#l34.2376"></a><span id="l34.2376">     m_currentAuthMethod = POP3_HAS_AUTH_APOP;</span>
<a href="#l34.2377"></a><span id="l34.2377">   else if (POP3_HAS_AUTH_NTLM &amp; availCaps)</span>
<a href="#l34.2378"></a><span id="l34.2378" class="difflineat">@@ -1741,867 +1558,770 @@ nsresult nsPop3Protocol::ChooseAuthMetho</span>
<a href="#l34.2379"></a><span id="l34.2379">   else if (POP3_HAS_AUTH_MSN &amp; availCaps)</span>
<a href="#l34.2380"></a><span id="l34.2380">     m_currentAuthMethod = POP3_HAS_AUTH_MSN;</span>
<a href="#l34.2381"></a><span id="l34.2381">   else if (POP3_HAS_AUTH_PLAIN &amp; availCaps)</span>
<a href="#l34.2382"></a><span id="l34.2382">     m_currentAuthMethod = POP3_HAS_AUTH_PLAIN;</span>
<a href="#l34.2383"></a><span id="l34.2383">   else if (POP3_HAS_AUTH_LOGIN &amp; availCaps)</span>
<a href="#l34.2384"></a><span id="l34.2384">     m_currentAuthMethod = POP3_HAS_AUTH_LOGIN;</span>
<a href="#l34.2385"></a><span id="l34.2385">   else if (POP3_HAS_AUTH_USER &amp; availCaps)</span>
<a href="#l34.2386"></a><span id="l34.2386">     m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l34.2387"></a><span id="l34.2387" class="difflineminus">-  else</span>
<a href="#l34.2388"></a><span id="l34.2388" class="difflineminus">-  {</span>
<a href="#l34.2389"></a><span id="l34.2389" class="difflineplus">+  else {</span>
<a href="#l34.2390"></a><span id="l34.2390">     // there are no matching login schemes at all, per server and prefs</span>
<a href="#l34.2391"></a><span id="l34.2391">     m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l34.2392"></a><span id="l34.2392" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;no auth method remaining&quot;)));</span>
<a href="#l34.2393"></a><span id="l34.2393" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2394"></a><span id="l34.2394" class="difflineplus">+            (POP3LOG(&quot;no auth method remaining&quot;)));</span>
<a href="#l34.2395"></a><span id="l34.2395">     return NS_ERROR_FAILURE;</span>
<a href="#l34.2396"></a><span id="l34.2396">   }</span>
<a href="#l34.2397"></a><span id="l34.2397">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2398"></a><span id="l34.2398">           (POP3LOG(&quot;trying auth method 0x%X&quot;), m_currentAuthMethod));</span>
<a href="#l34.2399"></a><span id="l34.2399">   return NS_OK;</span>
<a href="#l34.2400"></a><span id="l34.2400"> }</span>
<a href="#l34.2401"></a><span id="l34.2401"> </span>
<a href="#l34.2402"></a><span id="l34.2402" class="difflineminus">-void nsPop3Protocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod)</span>
<a href="#l34.2403"></a><span id="l34.2403" class="difflineminus">-{</span>
<a href="#l34.2404"></a><span id="l34.2404" class="difflineplus">+void nsPop3Protocol::MarkAuthMethodAsFailed(int32_t failedAuthMethod) {</span>
<a href="#l34.2405"></a><span id="l34.2405">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2406"></a><span id="l34.2406">           (POP3LOG(&quot;marking auth method 0x%X failed&quot;), failedAuthMethod));</span>
<a href="#l34.2407"></a><span id="l34.2407">   m_failedAuthMethods |= failedAuthMethod;</span>
<a href="#l34.2408"></a><span id="l34.2408"> }</span>
<a href="#l34.2409"></a><span id="l34.2409"> </span>
<a href="#l34.2410"></a><span id="l34.2410"> /**</span>
<a href="#l34.2411"></a><span id="l34.2411">  * Start over, trying all auth methods again</span>
<a href="#l34.2412"></a><span id="l34.2412">  */</span>
<a href="#l34.2413"></a><span id="l34.2413" class="difflineminus">-void nsPop3Protocol::ResetAuthMethods()</span>
<a href="#l34.2414"></a><span id="l34.2414" class="difflineminus">-{</span>
<a href="#l34.2415"></a><span id="l34.2415" class="difflineminus">-  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;resetting (failed) auth methods&quot;)));</span>
<a href="#l34.2416"></a><span id="l34.2416" class="difflineplus">+void nsPop3Protocol::ResetAuthMethods() {</span>
<a href="#l34.2417"></a><span id="l34.2417" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2418"></a><span id="l34.2418" class="difflineplus">+          (POP3LOG(&quot;resetting (failed) auth methods&quot;)));</span>
<a href="#l34.2419"></a><span id="l34.2419">   m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l34.2420"></a><span id="l34.2420">   m_failedAuthMethods = 0;</span>
<a href="#l34.2421"></a><span id="l34.2421"> }</span>
<a href="#l34.2422"></a><span id="l34.2422"> </span>
<a href="#l34.2423"></a><span id="l34.2423"> /**</span>
<a href="#l34.2424"></a><span id="l34.2424">  * state POP3_PROCESS_AUTH</span>
<a href="#l34.2425"></a><span id="l34.2425">  * Called when we should try to authenticate to the server.</span>
<a href="#l34.2426"></a><span id="l34.2426">  * Also called when one auth method fails and we want to try and start</span>
<a href="#l34.2427"></a><span id="l34.2427">  * the next best auth method.</span>
<a href="#l34.2428"></a><span id="l34.2428">  */</span>
<a href="#l34.2429"></a><span id="l34.2429" class="difflineminus">-int32_t nsPop3Protocol::ProcessAuth()</span>
<a href="#l34.2430"></a><span id="l34.2430" class="difflineminus">-{</span>
<a href="#l34.2431"></a><span id="l34.2431" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;ProcessAuth()&quot;)));</span>
<a href="#l34.2432"></a><span id="l34.2432" class="difflineminus">-</span>
<a href="#l34.2433"></a><span id="l34.2433" class="difflineminus">-    // Try to upgrade to STARTTLS -- TODO move into its own function</span>
<a href="#l34.2434"></a><span id="l34.2434" class="difflineminus">-    if (!m_tlsEnabled)</span>
<a href="#l34.2435"></a><span id="l34.2435" class="difflineminus">-    {</span>
<a href="#l34.2436"></a><span id="l34.2436" class="difflineminus">-      if(TestCapFlag(POP3_HAS_STLS))</span>
<a href="#l34.2437"></a><span id="l34.2437" class="difflineminus">-      {</span>
<a href="#l34.2438"></a><span id="l34.2438" class="difflineminus">-        if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l34.2439"></a><span id="l34.2439" class="difflineminus">-            m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l34.2440"></a><span id="l34.2440" class="difflineminus">-        {</span>
<a href="#l34.2441"></a><span id="l34.2441" class="difflineminus">-            nsAutoCString command(&quot;STLS&quot; CRLF);</span>
<a href="#l34.2442"></a><span id="l34.2442" class="difflineminus">-</span>
<a href="#l34.2443"></a><span id="l34.2443" class="difflineminus">-            m_pop3ConData-&gt;next_state_after_response = POP3_TLS_RESPONSE;</span>
<a href="#l34.2444"></a><span id="l34.2444" class="difflineminus">-            return Pop3SendData(command.get());</span>
<a href="#l34.2445"></a><span id="l34.2445" class="difflineminus">-        }</span>
<a href="#l34.2446"></a><span id="l34.2446" class="difflineplus">+int32_t nsPop3Protocol::ProcessAuth() {</span>
<a href="#l34.2447"></a><span id="l34.2447" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;ProcessAuth()&quot;)));</span>
<a href="#l34.2448"></a><span id="l34.2448" class="difflineplus">+</span>
<a href="#l34.2449"></a><span id="l34.2449" class="difflineplus">+  // Try to upgrade to STARTTLS -- TODO move into its own function</span>
<a href="#l34.2450"></a><span id="l34.2450" class="difflineplus">+  if (!m_tlsEnabled) {</span>
<a href="#l34.2451"></a><span id="l34.2451" class="difflineplus">+    if (TestCapFlag(POP3_HAS_STLS)) {</span>
<a href="#l34.2452"></a><span id="l34.2452" class="difflineplus">+      if (m_socketType == nsMsgSocketType::trySTARTTLS ||</span>
<a href="#l34.2453"></a><span id="l34.2453" class="difflineplus">+          m_socketType == nsMsgSocketType::alwaysSTARTTLS) {</span>
<a href="#l34.2454"></a><span id="l34.2454" class="difflineplus">+        nsAutoCString command(&quot;STLS&quot; CRLF);</span>
<a href="#l34.2455"></a><span id="l34.2455" class="difflineplus">+</span>
<a href="#l34.2456"></a><span id="l34.2456" class="difflineplus">+        m_pop3ConData-&gt;next_state_after_response = POP3_TLS_RESPONSE;</span>
<a href="#l34.2457"></a><span id="l34.2457" class="difflineplus">+        return Pop3SendData(command.get());</span>
<a href="#l34.2458"></a><span id="l34.2458">       }</span>
<a href="#l34.2459"></a><span id="l34.2459" class="difflineminus">-      else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l34.2460"></a><span id="l34.2460" class="difflineminus">-      {</span>
<a href="#l34.2461"></a><span id="l34.2461" class="difflineminus">-          m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.2462"></a><span id="l34.2462" class="difflineminus">-          return Error(&quot;nsErrorCouldNotConnectViaTls&quot;);</span>
<a href="#l34.2463"></a><span id="l34.2463" class="difflineminus">-      }</span>
<a href="#l34.2464"></a><span id="l34.2464" class="difflineplus">+    } else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS) {</span>
<a href="#l34.2465"></a><span id="l34.2465" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.2466"></a><span id="l34.2466" class="difflineplus">+      return Error(&quot;nsErrorCouldNotConnectViaTls&quot;);</span>
<a href="#l34.2467"></a><span id="l34.2467">     }</span>
<a href="#l34.2468"></a><span id="l34.2468" class="difflineminus">-</span>
<a href="#l34.2469"></a><span id="l34.2469" class="difflineminus">-    m_password_already_sent = false;</span>
<a href="#l34.2470"></a><span id="l34.2470" class="difflineminus">-</span>
<a href="#l34.2471"></a><span id="l34.2471" class="difflineminus">-    nsresult rv = ChooseAuthMethod();</span>
<a href="#l34.2472"></a><span id="l34.2472" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.2473"></a><span id="l34.2473" class="difflineminus">-    {</span>
<a href="#l34.2474"></a><span id="l34.2474" class="difflineminus">-      // Pref doesn't match server. Now, find an appropriate error msg.</span>
<a href="#l34.2475"></a><span id="l34.2475" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2476"></a><span id="l34.2476" class="difflineminus">-              (POP3LOG(&quot;ProcessAuth() early exit because no auth methods&quot;)));</span>
<a href="#l34.2477"></a><span id="l34.2477" class="difflineminus">-</span>
<a href="#l34.2478"></a><span id="l34.2478" class="difflineminus">-      // AuthGSSAPI* falls in here in case of an auth failure.</span>
<a href="#l34.2479"></a><span id="l34.2479" class="difflineminus">-      // If Kerberos was the only method, assume that</span>
<a href="#l34.2480"></a><span id="l34.2480" class="difflineminus">-      // the user is just not logged in yet, and show an appropriate error.</span>
<a href="#l34.2481"></a><span id="l34.2481" class="difflineminus">-      if (m_prefAuthMethods == POP3_HAS_AUTH_GSSAPI &amp;&amp;</span>
<a href="#l34.2482"></a><span id="l34.2482" class="difflineminus">-          m_failedAuthMethods == POP3_HAS_AUTH_GSSAPI)</span>
<a href="#l34.2483"></a><span id="l34.2483" class="difflineminus">-        return Error(&quot;pop3GssapiFailure&quot;);</span>
<a href="#l34.2484"></a><span id="l34.2484" class="difflineminus">-</span>
<a href="#l34.2485"></a><span id="l34.2485" class="difflineminus">-      // pref has plaintext pw &amp; server claims to support encrypted pw</span>
<a href="#l34.2486"></a><span id="l34.2486" class="difflineminus">-      if (m_prefAuthMethods == (POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l34.2487"></a><span id="l34.2487" class="difflineminus">-              POP3_HAS_AUTH_PLAIN) &amp;&amp;</span>
<a href="#l34.2488"></a><span id="l34.2488" class="difflineminus">-          GetCapFlags() &amp; (POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP))</span>
<a href="#l34.2489"></a><span id="l34.2489" class="difflineminus">-        // tell user to change to encrypted pw</span>
<a href="#l34.2490"></a><span id="l34.2490" class="difflineminus">-        return Error(&quot;pop3AuthChangePlainToEncrypt&quot;);</span>
<a href="#l34.2491"></a><span id="l34.2491" class="difflineminus">-      // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l34.2492"></a><span id="l34.2492" class="difflineminus">-      else if (m_prefAuthMethods == (POP3_HAS_AUTH_CRAM_MD5 |</span>
<a href="#l34.2493"></a><span id="l34.2493" class="difflineminus">-                    POP3_HAS_AUTH_APOP) &amp;&amp;</span>
<a href="#l34.2494"></a><span id="l34.2494" class="difflineminus">-               GetCapFlags() &amp; (POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l34.2495"></a><span id="l34.2495" class="difflineminus">-                    POP3_HAS_AUTH_PLAIN))</span>
<a href="#l34.2496"></a><span id="l34.2496" class="difflineminus">-      {</span>
<a href="#l34.2497"></a><span id="l34.2497" class="difflineminus">-        // have SSL</span>
<a href="#l34.2498"></a><span id="l34.2498" class="difflineminus">-        if (m_socketType == nsMsgSocketType::SSL ||</span>
<a href="#l34.2499"></a><span id="l34.2499" class="difflineminus">-            m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l34.2500"></a><span id="l34.2500" class="difflineminus">-          // tell user to change to plaintext pw</span>
<a href="#l34.2501"></a><span id="l34.2501" class="difflineminus">-          return Error(&quot;pop3AuthChangeEncryptToPlainSSL&quot;);</span>
<a href="#l34.2502"></a><span id="l34.2502" class="difflineminus">-        else</span>
<a href="#l34.2503"></a><span id="l34.2503" class="difflineminus">-          // tell user to change to plaintext pw, with big warning</span>
<a href="#l34.2504"></a><span id="l34.2504" class="difflineminus">-          return Error(&quot;pop3AuthChangeEncryptToPlainNoSSL&quot;);</span>
<a href="#l34.2505"></a><span id="l34.2505" class="difflineminus">-      }</span>
<a href="#l34.2506"></a><span id="l34.2506" class="difflineplus">+  }</span>
<a href="#l34.2507"></a><span id="l34.2507" class="difflineplus">+</span>
<a href="#l34.2508"></a><span id="l34.2508" class="difflineplus">+  m_password_already_sent = false;</span>
<a href="#l34.2509"></a><span id="l34.2509" class="difflineplus">+</span>
<a href="#l34.2510"></a><span id="l34.2510" class="difflineplus">+  nsresult rv = ChooseAuthMethod();</span>
<a href="#l34.2511"></a><span id="l34.2511" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l34.2512"></a><span id="l34.2512" class="difflineplus">+    // Pref doesn't match server. Now, find an appropriate error msg.</span>
<a href="#l34.2513"></a><span id="l34.2513" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2514"></a><span id="l34.2514" class="difflineplus">+            (POP3LOG(&quot;ProcessAuth() early exit because no auth methods&quot;)));</span>
<a href="#l34.2515"></a><span id="l34.2515" class="difflineplus">+</span>
<a href="#l34.2516"></a><span id="l34.2516" class="difflineplus">+    // AuthGSSAPI* falls in here in case of an auth failure.</span>
<a href="#l34.2517"></a><span id="l34.2517" class="difflineplus">+    // If Kerberos was the only method, assume that</span>
<a href="#l34.2518"></a><span id="l34.2518" class="difflineplus">+    // the user is just not logged in yet, and show an appropriate error.</span>
<a href="#l34.2519"></a><span id="l34.2519" class="difflineplus">+    if (m_prefAuthMethods == POP3_HAS_AUTH_GSSAPI &amp;&amp;</span>
<a href="#l34.2520"></a><span id="l34.2520" class="difflineplus">+        m_failedAuthMethods == POP3_HAS_AUTH_GSSAPI)</span>
<a href="#l34.2521"></a><span id="l34.2521" class="difflineplus">+      return Error(&quot;pop3GssapiFailure&quot;);</span>
<a href="#l34.2522"></a><span id="l34.2522" class="difflineplus">+</span>
<a href="#l34.2523"></a><span id="l34.2523" class="difflineplus">+    // pref has plaintext pw &amp; server claims to support encrypted pw</span>
<a href="#l34.2524"></a><span id="l34.2524" class="difflineplus">+    if (m_prefAuthMethods ==</span>
<a href="#l34.2525"></a><span id="l34.2525" class="difflineplus">+            (POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN | POP3_HAS_AUTH_PLAIN) &amp;&amp;</span>
<a href="#l34.2526"></a><span id="l34.2526" class="difflineplus">+        GetCapFlags() &amp; (POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP))</span>
<a href="#l34.2527"></a><span id="l34.2527" class="difflineplus">+      // tell user to change to encrypted pw</span>
<a href="#l34.2528"></a><span id="l34.2528" class="difflineplus">+      return Error(&quot;pop3AuthChangePlainToEncrypt&quot;);</span>
<a href="#l34.2529"></a><span id="l34.2529" class="difflineplus">+    // pref has encrypted pw &amp; server claims to support plaintext pw</span>
<a href="#l34.2530"></a><span id="l34.2530" class="difflineplus">+    else if (m_prefAuthMethods ==</span>
<a href="#l34.2531"></a><span id="l34.2531" class="difflineplus">+                 (POP3_HAS_AUTH_CRAM_MD5 | POP3_HAS_AUTH_APOP) &amp;&amp;</span>
<a href="#l34.2532"></a><span id="l34.2532" class="difflineplus">+             GetCapFlags() &amp; (POP3_HAS_AUTH_USER | POP3_HAS_AUTH_LOGIN |</span>
<a href="#l34.2533"></a><span id="l34.2533" class="difflineplus">+                              POP3_HAS_AUTH_PLAIN)) {</span>
<a href="#l34.2534"></a><span id="l34.2534" class="difflineplus">+      // have SSL</span>
<a href="#l34.2535"></a><span id="l34.2535" class="difflineplus">+      if (m_socketType == nsMsgSocketType::SSL ||</span>
<a href="#l34.2536"></a><span id="l34.2536" class="difflineplus">+          m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l34.2537"></a><span id="l34.2537" class="difflineplus">+        // tell user to change to plaintext pw</span>
<a href="#l34.2538"></a><span id="l34.2538" class="difflineplus">+        return Error(&quot;pop3AuthChangeEncryptToPlainSSL&quot;);</span>
<a href="#l34.2539"></a><span id="l34.2539">       else</span>
<a href="#l34.2540"></a><span id="l34.2540" class="difflineminus">-        // just &quot;change auth method&quot;</span>
<a href="#l34.2541"></a><span id="l34.2541" class="difflineminus">-        return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l34.2542"></a><span id="l34.2542" class="difflineminus">-    }</span>
<a href="#l34.2543"></a><span id="l34.2543" class="difflineminus">-</span>
<a href="#l34.2544"></a><span id="l34.2544" class="difflineminus">-    switch (m_currentAuthMethod)</span>
<a href="#l34.2545"></a><span id="l34.2545" class="difflineminus">-    {</span>
<a href="#l34.2546"></a><span id="l34.2546" class="difflineminus">-      case POP3_HAS_AUTH_GSSAPI:</span>
<a href="#l34.2547"></a><span id="l34.2547" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP GSSAPI&quot;)));</span>
<a href="#l34.2548"></a><span id="l34.2548" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_AUTH_GSSAPI;</span>
<a href="#l34.2549"></a><span id="l34.2549" class="difflineminus">-        break;</span>
<a href="#l34.2550"></a><span id="l34.2550" class="difflineminus">-      case POP3_HAS_AUTH_APOP:</span>
<a href="#l34.2551"></a><span id="l34.2551" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP APOP&quot;)));</span>
<a href="#l34.2552"></a><span id="l34.2552" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l34.2553"></a><span id="l34.2553" class="difflineminus">-        break;</span>
<a href="#l34.2554"></a><span id="l34.2554" class="difflineminus">-      case POP3_HAS_AUTH_CRAM_MD5:</span>
<a href="#l34.2555"></a><span id="l34.2555" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP CRAM&quot;)));</span>
<a href="#l34.2556"></a><span id="l34.2556" class="difflineminus">-        MOZ_FALLTHROUGH;</span>
<a href="#l34.2557"></a><span id="l34.2557" class="difflineminus">-      case POP3_HAS_AUTH_PLAIN:</span>
<a href="#l34.2558"></a><span id="l34.2558" class="difflineminus">-      case POP3_HAS_AUTH_USER:</span>
<a href="#l34.2559"></a><span id="l34.2559" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP username&quot;)));</span>
<a href="#l34.2560"></a><span id="l34.2560" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.2561"></a><span id="l34.2561" class="difflineminus">-        break;</span>
<a href="#l34.2562"></a><span id="l34.2562" class="difflineminus">-      case POP3_HAS_AUTH_LOGIN:</span>
<a href="#l34.2563"></a><span id="l34.2563" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP AUTH=LOGIN&quot;)));</span>
<a href="#l34.2564"></a><span id="l34.2564" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN;</span>
<a href="#l34.2565"></a><span id="l34.2565" class="difflineminus">-        break;</span>
<a href="#l34.2566"></a><span id="l34.2566" class="difflineminus">-      case POP3_HAS_AUTH_NTLM:</span>
<a href="#l34.2567"></a><span id="l34.2567" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP NTLM&quot;)));</span>
<a href="#l34.2568"></a><span id="l34.2568" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_AUTH_NTLM;</span>
<a href="#l34.2569"></a><span id="l34.2569" class="difflineminus">-        break;</span>
<a href="#l34.2570"></a><span id="l34.2570" class="difflineminus">-      case POP3_HAS_AUTH_NONE:</span>
<a href="#l34.2571"></a><span id="l34.2571" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP no auth&quot;)));</span>
<a href="#l34.2572"></a><span id="l34.2572" class="difflineminus">-        m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.2573"></a><span id="l34.2573" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.2574"></a><span id="l34.2574" class="difflineminus">-        break;</span>
<a href="#l34.2575"></a><span id="l34.2575" class="difflineminus">-      default:</span>
<a href="#l34.2576"></a><span id="l34.2576" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.2577"></a><span id="l34.2577" class="difflineminus">-                (POP3LOG(&quot;POP: m_currentAuthMethod has unknown value&quot;)));</span>
<a href="#l34.2578"></a><span id="l34.2578" class="difflineminus">-        return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l34.2579"></a><span id="l34.2579" class="difflineminus">-    }</span>
<a href="#l34.2580"></a><span id="l34.2580" class="difflineminus">-</span>
<a href="#l34.2581"></a><span id="l34.2581" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2582"></a><span id="l34.2582" class="difflineminus">-</span>
<a href="#l34.2583"></a><span id="l34.2583" class="difflineminus">-    return 0;</span>
<a href="#l34.2584"></a><span id="l34.2584" class="difflineplus">+        // tell user to change to plaintext pw, with big warning</span>
<a href="#l34.2585"></a><span id="l34.2585" class="difflineplus">+        return Error(&quot;pop3AuthChangeEncryptToPlainNoSSL&quot;);</span>
<a href="#l34.2586"></a><span id="l34.2586" class="difflineplus">+    } else</span>
<a href="#l34.2587"></a><span id="l34.2587" class="difflineplus">+      // just &quot;change auth method&quot;</span>
<a href="#l34.2588"></a><span id="l34.2588" class="difflineplus">+      return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l34.2589"></a><span id="l34.2589" class="difflineplus">+  }</span>
<a href="#l34.2590"></a><span id="l34.2590" class="difflineplus">+</span>
<a href="#l34.2591"></a><span id="l34.2591" class="difflineplus">+  switch (m_currentAuthMethod) {</span>
<a href="#l34.2592"></a><span id="l34.2592" class="difflineplus">+    case POP3_HAS_AUTH_GSSAPI:</span>
<a href="#l34.2593"></a><span id="l34.2593" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP GSSAPI&quot;)));</span>
<a href="#l34.2594"></a><span id="l34.2594" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_AUTH_GSSAPI;</span>
<a href="#l34.2595"></a><span id="l34.2595" class="difflineplus">+      break;</span>
<a href="#l34.2596"></a><span id="l34.2596" class="difflineplus">+    case POP3_HAS_AUTH_APOP:</span>
<a href="#l34.2597"></a><span id="l34.2597" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP APOP&quot;)));</span>
<a href="#l34.2598"></a><span id="l34.2598" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l34.2599"></a><span id="l34.2599" class="difflineplus">+      break;</span>
<a href="#l34.2600"></a><span id="l34.2600" class="difflineplus">+    case POP3_HAS_AUTH_CRAM_MD5:</span>
<a href="#l34.2601"></a><span id="l34.2601" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP CRAM&quot;)));</span>
<a href="#l34.2602"></a><span id="l34.2602" class="difflineplus">+      MOZ_FALLTHROUGH;</span>
<a href="#l34.2603"></a><span id="l34.2603" class="difflineplus">+    case POP3_HAS_AUTH_PLAIN:</span>
<a href="#l34.2604"></a><span id="l34.2604" class="difflineplus">+    case POP3_HAS_AUTH_USER:</span>
<a href="#l34.2605"></a><span id="l34.2605" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP username&quot;)));</span>
<a href="#l34.2606"></a><span id="l34.2606" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.2607"></a><span id="l34.2607" class="difflineplus">+      break;</span>
<a href="#l34.2608"></a><span id="l34.2608" class="difflineplus">+    case POP3_HAS_AUTH_LOGIN:</span>
<a href="#l34.2609"></a><span id="l34.2609" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP AUTH=LOGIN&quot;)));</span>
<a href="#l34.2610"></a><span id="l34.2610" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN;</span>
<a href="#l34.2611"></a><span id="l34.2611" class="difflineplus">+      break;</span>
<a href="#l34.2612"></a><span id="l34.2612" class="difflineplus">+    case POP3_HAS_AUTH_NTLM:</span>
<a href="#l34.2613"></a><span id="l34.2613" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP NTLM&quot;)));</span>
<a href="#l34.2614"></a><span id="l34.2614" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_AUTH_NTLM;</span>
<a href="#l34.2615"></a><span id="l34.2615" class="difflineplus">+      break;</span>
<a href="#l34.2616"></a><span id="l34.2616" class="difflineplus">+    case POP3_HAS_AUTH_NONE:</span>
<a href="#l34.2617"></a><span id="l34.2617" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;POP no auth&quot;)));</span>
<a href="#l34.2618"></a><span id="l34.2618" class="difflineplus">+      m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.2619"></a><span id="l34.2619" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.2620"></a><span id="l34.2620" class="difflineplus">+      break;</span>
<a href="#l34.2621"></a><span id="l34.2621" class="difflineplus">+    default:</span>
<a href="#l34.2622"></a><span id="l34.2622" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.2623"></a><span id="l34.2623" class="difflineplus">+              (POP3LOG(&quot;POP: m_currentAuthMethod has unknown value&quot;)));</span>
<a href="#l34.2624"></a><span id="l34.2624" class="difflineplus">+      return Error(&quot;pop3AuthMechNotSupported&quot;);</span>
<a href="#l34.2625"></a><span id="l34.2625" class="difflineplus">+  }</span>
<a href="#l34.2626"></a><span id="l34.2626" class="difflineplus">+</span>
<a href="#l34.2627"></a><span id="l34.2627" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2628"></a><span id="l34.2628" class="difflineplus">+</span>
<a href="#l34.2629"></a><span id="l34.2629" class="difflineplus">+  return 0;</span>
<a href="#l34.2630"></a><span id="l34.2630"> }</span>
<a href="#l34.2631"></a><span id="l34.2631"> </span>
<a href="#l34.2632"></a><span id="l34.2632"> /**</span>
<a href="#l34.2633"></a><span id="l34.2633">  * state POP3_NEXT_AUTH_STEP</span>
<a href="#l34.2634"></a><span id="l34.2634">  * This is called when we finished one auth step (e.g. sending username</span>
<a href="#l34.2635"></a><span id="l34.2635">  * or password are separate steps, similarly for AUTH LOGIN, NTLM etc.)</span>
<a href="#l34.2636"></a><span id="l34.2636">  * and want to proceed to the next one.</span>
<a href="#l34.2637"></a><span id="l34.2637">  */</span>
<a href="#l34.2638"></a><span id="l34.2638" class="difflineminus">-int32_t nsPop3Protocol::NextAuthStep()</span>
<a href="#l34.2639"></a><span id="l34.2639" class="difflineminus">-{</span>
<a href="#l34.2640"></a><span id="l34.2640" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;NextAuthStep()&quot;)));</span>
<a href="#l34.2641"></a><span id="l34.2641" class="difflineminus">-    if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.2642"></a><span id="l34.2642" class="difflineminus">-    {</span>
<a href="#l34.2643"></a><span id="l34.2643" class="difflineminus">-        if (m_password_already_sent || // (also true for GSSAPI)</span>
<a href="#l34.2644"></a><span id="l34.2644" class="difflineminus">-            m_currentAuthMethod == POP3_HAS_AUTH_NONE)</span>
<a href="#l34.2645"></a><span id="l34.2645" class="difflineminus">-        {</span>
<a href="#l34.2646"></a><span id="l34.2646" class="difflineminus">-            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;login succeeded&quot;)));</span>
<a href="#l34.2647"></a><span id="l34.2647" class="difflineminus">-            m_nsIPop3Sink-&gt;SetUserAuthenticated(true);</span>
<a href="#l34.2648"></a><span id="l34.2648" class="difflineminus">-            ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.2649"></a><span id="l34.2649" class="difflineminus">-            if (m_pop3ConData-&gt;verify_logon)</span>
<a href="#l34.2650"></a><span id="l34.2650" class="difflineminus">-              m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.2651"></a><span id="l34.2651" class="difflineminus">-            else</span>
<a href="#l34.2652"></a><span id="l34.2652" class="difflineminus">-              m_pop3ConData-&gt;next_state = (m_pop3ConData-&gt;get_url)</span>
<a href="#l34.2653"></a><span id="l34.2653" class="difflineminus">-                                          ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l34.2654"></a><span id="l34.2654" class="difflineminus">-        }</span>
<a href="#l34.2655"></a><span id="l34.2655" class="difflineminus">-        else</span>
<a href="#l34.2656"></a><span id="l34.2656" class="difflineminus">-            m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l34.2657"></a><span id="l34.2657" class="difflineplus">+int32_t nsPop3Protocol::NextAuthStep() {</span>
<a href="#l34.2658"></a><span id="l34.2658" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;NextAuthStep()&quot;)));</span>
<a href="#l34.2659"></a><span id="l34.2659" class="difflineplus">+  if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.2660"></a><span id="l34.2660" class="difflineplus">+    if (m_password_already_sent ||  // (also true for GSSAPI)</span>
<a href="#l34.2661"></a><span id="l34.2661" class="difflineplus">+        m_currentAuthMethod == POP3_HAS_AUTH_NONE) {</span>
<a href="#l34.2662"></a><span id="l34.2662" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;login succeeded&quot;)));</span>
<a href="#l34.2663"></a><span id="l34.2663" class="difflineplus">+      m_nsIPop3Sink-&gt;SetUserAuthenticated(true);</span>
<a href="#l34.2664"></a><span id="l34.2664" class="difflineplus">+      ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.2665"></a><span id="l34.2665" class="difflineplus">+      if (m_pop3ConData-&gt;verify_logon)</span>
<a href="#l34.2666"></a><span id="l34.2666" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.2667"></a><span id="l34.2667" class="difflineplus">+      else</span>
<a href="#l34.2668"></a><span id="l34.2668" class="difflineplus">+        m_pop3ConData-&gt;next_state =</span>
<a href="#l34.2669"></a><span id="l34.2669" class="difflineplus">+            (m_pop3ConData-&gt;get_url) ? POP3_SEND_GURL : POP3_SEND_STAT;</span>
<a href="#l34.2670"></a><span id="l34.2670" class="difflineplus">+    } else</span>
<a href="#l34.2671"></a><span id="l34.2671" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_SEND_PASSWORD;</span>
<a href="#l34.2672"></a><span id="l34.2672" class="difflineplus">+  } else {</span>
<a href="#l34.2673"></a><span id="l34.2673" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2674"></a><span id="l34.2674" class="difflineplus">+            (POP3LOG(&quot;command did not succeed&quot;)));</span>
<a href="#l34.2675"></a><span id="l34.2675" class="difflineplus">+    // response code received shows that login failed not because of</span>
<a href="#l34.2676"></a><span id="l34.2676" class="difflineplus">+    // wrong credential -&gt; stop login without retry or pw dialog, only alert</span>
<a href="#l34.2677"></a><span id="l34.2677" class="difflineplus">+    // parameter list -&gt; user</span>
<a href="#l34.2678"></a><span id="l34.2678" class="difflineplus">+    nsCString userName;</span>
<a href="#l34.2679"></a><span id="l34.2679" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.2680"></a><span id="l34.2680" class="difflineplus">+    nsresult rv = server-&gt;GetRealUsername(userName);</span>
<a href="#l34.2681"></a><span id="l34.2681" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.2682"></a><span id="l34.2682" class="difflineplus">+    NS_ConvertUTF8toUTF16 userNameUTF16(userName);</span>
<a href="#l34.2683"></a><span id="l34.2683" class="difflineplus">+    const char16_t *params[] = {userNameUTF16.get()};</span>
<a href="#l34.2684"></a><span id="l34.2684" class="difflineplus">+    if (TestFlag(POP3_STOPLOGIN)) {</span>
<a href="#l34.2685"></a><span id="l34.2685" class="difflineplus">+      if (m_password_already_sent)</span>
<a href="#l34.2686"></a><span id="l34.2686" class="difflineplus">+        return Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l34.2687"></a><span id="l34.2687" class="difflineplus">+</span>
<a href="#l34.2688"></a><span id="l34.2688" class="difflineplus">+      return Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l34.2689"></a><span id="l34.2689" class="difflineplus">+    }</span>
<a href="#l34.2690"></a><span id="l34.2690" class="difflineplus">+    // response code received shows that server is certain about the</span>
<a href="#l34.2691"></a><span id="l34.2691" class="difflineplus">+    // credential was wrong -&gt; no fallback, show alert and pw dialog</span>
<a href="#l34.2692"></a><span id="l34.2692" class="difflineplus">+    if (TestFlag(POP3_AUTH_FAILURE)) {</span>
<a href="#l34.2693"></a><span id="l34.2693" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2694"></a><span id="l34.2694" class="difflineplus">+              (POP3LOG(&quot;auth failure, setting password failed&quot;)));</span>
<a href="#l34.2695"></a><span id="l34.2695" class="difflineplus">+      if (m_password_already_sent)</span>
<a href="#l34.2696"></a><span id="l34.2696" class="difflineplus">+        Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l34.2697"></a><span id="l34.2697" class="difflineplus">+      else</span>
<a href="#l34.2698"></a><span id="l34.2698" class="difflineplus">+        Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l34.2699"></a><span id="l34.2699" class="difflineplus">+      SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.2700"></a><span id="l34.2700" class="difflineplus">+      ClearFlag(POP3_AUTH_FAILURE);</span>
<a href="#l34.2701"></a><span id="l34.2701" class="difflineplus">+      return 0;</span>
<a href="#l34.2702"></a><span id="l34.2702">     }</span>
<a href="#l34.2703"></a><span id="l34.2703" class="difflineminus">-    else</span>
<a href="#l34.2704"></a><span id="l34.2704" class="difflineminus">-    {</span>
<a href="#l34.2705"></a><span id="l34.2705" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;command did not succeed&quot;)));</span>
<a href="#l34.2706"></a><span id="l34.2706" class="difflineminus">-        // response code received shows that login failed not because of</span>
<a href="#l34.2707"></a><span id="l34.2707" class="difflineminus">-        // wrong credential -&gt; stop login without retry or pw dialog, only alert</span>
<a href="#l34.2708"></a><span id="l34.2708" class="difflineminus">-        // parameter list -&gt; user</span>
<a href="#l34.2709"></a><span id="l34.2709" class="difflineminus">-        nsCString userName;</span>
<a href="#l34.2710"></a><span id="l34.2710" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.2711"></a><span id="l34.2711" class="difflineminus">-        nsresult rv = server-&gt;GetRealUsername(userName);</span>
<a href="#l34.2712"></a><span id="l34.2712" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.2713"></a><span id="l34.2713" class="difflineminus">-        NS_ConvertUTF8toUTF16 userNameUTF16(userName);</span>
<a href="#l34.2714"></a><span id="l34.2714" class="difflineminus">-        const char16_t* params[] = { userNameUTF16.get() };</span>
<a href="#l34.2715"></a><span id="l34.2715" class="difflineminus">-        if (TestFlag(POP3_STOPLOGIN))</span>
<a href="#l34.2716"></a><span id="l34.2716" class="difflineminus">-        {</span>
<a href="#l34.2717"></a><span id="l34.2717" class="difflineminus">-          if (m_password_already_sent)</span>
<a href="#l34.2718"></a><span id="l34.2718" class="difflineminus">-            return Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l34.2719"></a><span id="l34.2719" class="difflineminus">-</span>
<a href="#l34.2720"></a><span id="l34.2720" class="difflineminus">-          return Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l34.2721"></a><span id="l34.2721" class="difflineminus">-        }</span>
<a href="#l34.2722"></a><span id="l34.2722" class="difflineminus">-        // response code received shows that server is certain about the</span>
<a href="#l34.2723"></a><span id="l34.2723" class="difflineminus">-        // credential was wrong -&gt; no fallback, show alert and pw dialog</span>
<a href="#l34.2724"></a><span id="l34.2724" class="difflineminus">-        if (TestFlag(POP3_AUTH_FAILURE))</span>
<a href="#l34.2725"></a><span id="l34.2725" class="difflineminus">-        {</span>
<a href="#l34.2726"></a><span id="l34.2726" class="difflineminus">-            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2727"></a><span id="l34.2727" class="difflineminus">-                    (POP3LOG(&quot;auth failure, setting password failed&quot;)));</span>
<a href="#l34.2728"></a><span id="l34.2728" class="difflineminus">-            if (m_password_already_sent)</span>
<a href="#l34.2729"></a><span id="l34.2729" class="difflineminus">-              Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l34.2730"></a><span id="l34.2730" class="difflineminus">-            else</span>
<a href="#l34.2731"></a><span id="l34.2731" class="difflineminus">-              Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l34.2732"></a><span id="l34.2732" class="difflineminus">-            SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.2733"></a><span id="l34.2733" class="difflineminus">-            ClearFlag(POP3_AUTH_FAILURE);</span>
<a href="#l34.2734"></a><span id="l34.2734" class="difflineminus">-            return 0;</span>
<a href="#l34.2735"></a><span id="l34.2735" class="difflineminus">-        }</span>
<a href="#l34.2736"></a><span id="l34.2736" class="difflineminus">-</span>
<a href="#l34.2737"></a><span id="l34.2737" class="difflineminus">-        // We have no certain response code -&gt; fallback and try again.</span>
<a href="#l34.2738"></a><span id="l34.2738" class="difflineminus">-        // Mark the auth method failed, to use a different method next round.</span>
<a href="#l34.2739"></a><span id="l34.2739" class="difflineminus">-        MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l34.2740"></a><span id="l34.2740" class="difflineminus">-</span>
<a href="#l34.2741"></a><span id="l34.2741" class="difflineminus">-        if (m_currentAuthMethod == POP3_HAS_AUTH_USER &amp;&amp;</span>
<a href="#l34.2742"></a><span id="l34.2742" class="difflineminus">-            !m_password_already_sent)</span>
<a href="#l34.2743"></a><span id="l34.2743" class="difflineminus">-        {</span>
<a href="#l34.2744"></a><span id="l34.2744" class="difflineminus">-            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;USER username failed&quot;)));</span>
<a href="#l34.2745"></a><span id="l34.2745" class="difflineminus">-            // if USER auth method failed before sending the password,</span>
<a href="#l34.2746"></a><span id="l34.2746" class="difflineminus">-            // the username was wrong.</span>
<a href="#l34.2747"></a><span id="l34.2747" class="difflineminus">-            // no fallback but return error</span>
<a href="#l34.2748"></a><span id="l34.2748" class="difflineminus">-            return Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l34.2749"></a><span id="l34.2749" class="difflineminus">-        }</span>
<a href="#l34.2750"></a><span id="l34.2750" class="difflineminus">-</span>
<a href="#l34.2751"></a><span id="l34.2751" class="difflineminus">-        // If we have no auth method left, ask user to try with new password</span>
<a href="#l34.2752"></a><span id="l34.2752" class="difflineminus">-        rv = ChooseAuthMethod();</span>
<a href="#l34.2753"></a><span id="l34.2753" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l34.2754"></a><span id="l34.2754" class="difflineminus">-        {</span>
<a href="#l34.2755"></a><span id="l34.2755" class="difflineminus">-            MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.2756"></a><span id="l34.2756" class="difflineminus">-                    (POP3LOG(&quot;POP: no auth methods remaining, setting password failure&quot;)));</span>
<a href="#l34.2757"></a><span id="l34.2757" class="difflineminus">-            /* Sever the connection and go back to the `read password' state,</span>
<a href="#l34.2758"></a><span id="l34.2758" class="difflineminus">-               which, upon success, will re-open the connection.  Set a flag</span>
<a href="#l34.2759"></a><span id="l34.2759" class="difflineminus">-               which causes the prompt to be different that time (to indicate</span>
<a href="#l34.2760"></a><span id="l34.2760" class="difflineminus">-               that the old password was bogus.)</span>
<a href="#l34.2761"></a><span id="l34.2761" class="difflineminus">-</span>
<a href="#l34.2762"></a><span id="l34.2762" class="difflineminus">-               But if we're just checking for new mail (biff) then don't bother</span>
<a href="#l34.2763"></a><span id="l34.2763" class="difflineminus">-               prompting the user for a password: just fail silently.</span>
<a href="#l34.2764"></a><span id="l34.2764" class="difflineminus">-            */</span>
<a href="#l34.2765"></a><span id="l34.2765" class="difflineminus">-            SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.2766"></a><span id="l34.2766" class="difflineminus">-            Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l34.2767"></a><span id="l34.2767" class="difflineminus">-            return 0;</span>
<a href="#l34.2768"></a><span id="l34.2768" class="difflineminus">-        }</span>
<a href="#l34.2769"></a><span id="l34.2769" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2770"></a><span id="l34.2770" class="difflineminus">-                (POP3LOG(&quot;still have some auth methods to try&quot;)));</span>
<a href="#l34.2771"></a><span id="l34.2771" class="difflineminus">-</span>
<a href="#l34.2772"></a><span id="l34.2772" class="difflineminus">-        // TODO needed?</span>
<a href="#l34.2773"></a><span id="l34.2773" class="difflineminus">-        //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2774"></a><span id="l34.2774" class="difflineminus">-</span>
<a href="#l34.2775"></a><span id="l34.2775" class="difflineminus">-        m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.2776"></a><span id="l34.2776" class="difflineminus">-</span>
<a href="#l34.2777"></a><span id="l34.2777" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2778"></a><span id="l34.2778" class="difflineplus">+</span>
<a href="#l34.2779"></a><span id="l34.2779" class="difflineplus">+    // We have no certain response code -&gt; fallback and try again.</span>
<a href="#l34.2780"></a><span id="l34.2780" class="difflineplus">+    // Mark the auth method failed, to use a different method next round.</span>
<a href="#l34.2781"></a><span id="l34.2781" class="difflineplus">+    MarkAuthMethodAsFailed(m_currentAuthMethod);</span>
<a href="#l34.2782"></a><span id="l34.2782" class="difflineplus">+</span>
<a href="#l34.2783"></a><span id="l34.2783" class="difflineplus">+    if (m_currentAuthMethod == POP3_HAS_AUTH_USER &amp;&amp; !m_password_already_sent) {</span>
<a href="#l34.2784"></a><span id="l34.2784" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2785"></a><span id="l34.2785" class="difflineplus">+              (POP3LOG(&quot;USER username failed&quot;)));</span>
<a href="#l34.2786"></a><span id="l34.2786" class="difflineplus">+      // if USER auth method failed before sending the password,</span>
<a href="#l34.2787"></a><span id="l34.2787" class="difflineplus">+      // the username was wrong.</span>
<a href="#l34.2788"></a><span id="l34.2788" class="difflineplus">+      // no fallback but return error</span>
<a href="#l34.2789"></a><span id="l34.2789" class="difflineplus">+      return Error(&quot;pop3UsernameFailure&quot;);</span>
<a href="#l34.2790"></a><span id="l34.2790">     }</span>
<a href="#l34.2791"></a><span id="l34.2791"> </span>
<a href="#l34.2792"></a><span id="l34.2792" class="difflineminus">-    if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l34.2793"></a><span id="l34.2793" class="difflineminus">-    {</span>
<a href="#l34.2794"></a><span id="l34.2794" class="difflineminus">-        ClearCapFlag(POP3_AUTH_MECH_UNDEFINED);</span>
<a href="#l34.2795"></a><span id="l34.2795" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2796"></a><span id="l34.2796" class="difflineplus">+    // If we have no auth method left, ask user to try with new password</span>
<a href="#l34.2797"></a><span id="l34.2797" class="difflineplus">+    rv = ChooseAuthMethod();</span>
<a href="#l34.2798"></a><span id="l34.2798" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l34.2799"></a><span id="l34.2799" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.2800"></a><span id="l34.2800" class="difflineplus">+              (POP3LOG(</span>
<a href="#l34.2801"></a><span id="l34.2801" class="difflineplus">+                  &quot;POP: no auth methods remaining, setting password failure&quot;)));</span>
<a href="#l34.2802"></a><span id="l34.2802" class="difflineplus">+      /* Sever the connection and go back to the `read password' state,</span>
<a href="#l34.2803"></a><span id="l34.2803" class="difflineplus">+         which, upon success, will re-open the connection.  Set a flag</span>
<a href="#l34.2804"></a><span id="l34.2804" class="difflineplus">+         which causes the prompt to be different that time (to indicate</span>
<a href="#l34.2805"></a><span id="l34.2805" class="difflineplus">+         that the old password was bogus.)</span>
<a href="#l34.2806"></a><span id="l34.2806" class="difflineplus">+</span>
<a href="#l34.2807"></a><span id="l34.2807" class="difflineplus">+         But if we're just checking for new mail (biff) then don't bother</span>
<a href="#l34.2808"></a><span id="l34.2808" class="difflineplus">+         prompting the user for a password: just fail silently.</span>
<a href="#l34.2809"></a><span id="l34.2809" class="difflineplus">+      */</span>
<a href="#l34.2810"></a><span id="l34.2810" class="difflineplus">+      SetFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l34.2811"></a><span id="l34.2811" class="difflineplus">+      Error(&quot;pop3PasswordFailed&quot;, params, 1);</span>
<a href="#l34.2812"></a><span id="l34.2812" class="difflineplus">+      return 0;</span>
<a href="#l34.2813"></a><span id="l34.2813">     }</span>
<a href="#l34.2814"></a><span id="l34.2814" class="difflineminus">-</span>
<a href="#l34.2815"></a><span id="l34.2815" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2816"></a><span id="l34.2816" class="difflineminus">-</span>
<a href="#l34.2817"></a><span id="l34.2817" class="difflineminus">-    return 0;</span>
<a href="#l34.2818"></a><span id="l34.2818" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.2819"></a><span id="l34.2819" class="difflineplus">+            (POP3LOG(&quot;still have some auth methods to try&quot;)));</span>
<a href="#l34.2820"></a><span id="l34.2820" class="difflineplus">+</span>
<a href="#l34.2821"></a><span id="l34.2821" class="difflineplus">+    // TODO needed?</span>
<a href="#l34.2822"></a><span id="l34.2822" class="difflineplus">+    // m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2823"></a><span id="l34.2823" class="difflineplus">+</span>
<a href="#l34.2824"></a><span id="l34.2824" class="difflineplus">+    m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.2825"></a><span id="l34.2825" class="difflineplus">+</span>
<a href="#l34.2826"></a><span id="l34.2826" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2827"></a><span id="l34.2827" class="difflineplus">+  }</span>
<a href="#l34.2828"></a><span id="l34.2828" class="difflineplus">+</span>
<a href="#l34.2829"></a><span id="l34.2829" class="difflineplus">+  if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED)) {</span>
<a href="#l34.2830"></a><span id="l34.2830" class="difflineplus">+    ClearCapFlag(POP3_AUTH_MECH_UNDEFINED);</span>
<a href="#l34.2831"></a><span id="l34.2831" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.2832"></a><span id="l34.2832" class="difflineplus">+  }</span>
<a href="#l34.2833"></a><span id="l34.2833" class="difflineplus">+</span>
<a href="#l34.2834"></a><span id="l34.2834" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2835"></a><span id="l34.2835" class="difflineplus">+</span>
<a href="#l34.2836"></a><span id="l34.2836" class="difflineplus">+  return 0;</span>
<a href="#l34.2837"></a><span id="l34.2837"> }</span>
<a href="#l34.2838"></a><span id="l34.2838"> </span>
<a href="#l34.2839"></a><span id="l34.2839"> // LOGIN consists of three steps not two as USER/PASS or CRAM-MD5,</span>
<a href="#l34.2840"></a><span id="l34.2840"> // so we've to start here and continue in SendUsername if the server</span>
<a href="#l34.2841"></a><span id="l34.2841"> // responds + to &quot;AUTH LOGIN&quot;</span>
<a href="#l34.2842"></a><span id="l34.2842" class="difflineminus">-int32_t nsPop3Protocol::AuthLogin()</span>
<a href="#l34.2843"></a><span id="l34.2843" class="difflineminus">-{</span>
<a href="#l34.2844"></a><span id="l34.2844" class="difflineminus">-    nsAutoCString command(&quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l34.2845"></a><span id="l34.2845" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l34.2846"></a><span id="l34.2846" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.2847"></a><span id="l34.2847" class="difflineminus">-</span>
<a href="#l34.2848"></a><span id="l34.2848" class="difflineminus">-    return Pop3SendData(command.get());</span>
<a href="#l34.2849"></a><span id="l34.2849" class="difflineplus">+int32_t nsPop3Protocol::AuthLogin() {</span>
<a href="#l34.2850"></a><span id="l34.2850" class="difflineplus">+  nsAutoCString command(&quot;AUTH LOGIN&quot; CRLF);</span>
<a href="#l34.2851"></a><span id="l34.2851" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l34.2852"></a><span id="l34.2852" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.2853"></a><span id="l34.2853" class="difflineplus">+</span>
<a href="#l34.2854"></a><span id="l34.2854" class="difflineplus">+  return Pop3SendData(command.get());</span>
<a href="#l34.2855"></a><span id="l34.2855"> }</span>
<a href="#l34.2856"></a><span id="l34.2856"> </span>
<a href="#l34.2857"></a><span id="l34.2857" class="difflineminus">-int32_t nsPop3Protocol::AuthLoginResponse()</span>
<a href="#l34.2858"></a><span id="l34.2858" class="difflineminus">-{</span>
<a href="#l34.2859"></a><span id="l34.2859" class="difflineminus">-    // need the test to be here instead in NextAuthStep() to</span>
<a href="#l34.2860"></a><span id="l34.2860" class="difflineminus">-    // differentiate between command AUTH LOGIN failed and</span>
<a href="#l34.2861"></a><span id="l34.2861" class="difflineminus">-    // sending username using LOGIN mechanism failed.</span>
<a href="#l34.2862"></a><span id="l34.2862" class="difflineminus">-    if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.2863"></a><span id="l34.2863" class="difflineminus">-    {</span>
<a href="#l34.2864"></a><span id="l34.2864" class="difflineminus">-        // we failed with LOGIN, remove it</span>
<a href="#l34.2865"></a><span id="l34.2865" class="difflineminus">-        MarkAuthMethodAsFailed(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.2866"></a><span id="l34.2866" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2867"></a><span id="l34.2867" class="difflineminus">-    }</span>
<a href="#l34.2868"></a><span id="l34.2868" class="difflineminus">-    else</span>
<a href="#l34.2869"></a><span id="l34.2869" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.2870"></a><span id="l34.2870" class="difflineminus">-</span>
<a href="#l34.2871"></a><span id="l34.2871" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2872"></a><span id="l34.2872" class="difflineminus">-</span>
<a href="#l34.2873"></a><span id="l34.2873" class="difflineminus">-    return 0;</span>
<a href="#l34.2874"></a><span id="l34.2874" class="difflineplus">+int32_t nsPop3Protocol::AuthLoginResponse() {</span>
<a href="#l34.2875"></a><span id="l34.2875" class="difflineplus">+  // need the test to be here instead in NextAuthStep() to</span>
<a href="#l34.2876"></a><span id="l34.2876" class="difflineplus">+  // differentiate between command AUTH LOGIN failed and</span>
<a href="#l34.2877"></a><span id="l34.2877" class="difflineplus">+  // sending username using LOGIN mechanism failed.</span>
<a href="#l34.2878"></a><span id="l34.2878" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.2879"></a><span id="l34.2879" class="difflineplus">+    // we failed with LOGIN, remove it</span>
<a href="#l34.2880"></a><span id="l34.2880" class="difflineplus">+    MarkAuthMethodAsFailed(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.2881"></a><span id="l34.2881" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2882"></a><span id="l34.2882" class="difflineplus">+  } else</span>
<a href="#l34.2883"></a><span id="l34.2883" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.2884"></a><span id="l34.2884" class="difflineplus">+</span>
<a href="#l34.2885"></a><span id="l34.2885" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2886"></a><span id="l34.2886" class="difflineplus">+</span>
<a href="#l34.2887"></a><span id="l34.2887" class="difflineplus">+  return 0;</span>
<a href="#l34.2888"></a><span id="l34.2888"> }</span>
<a href="#l34.2889"></a><span id="l34.2889"> </span>
<a href="#l34.2890"></a><span id="l34.2890"> // NTLM, like LOGIN consists of three steps not two as USER/PASS or CRAM-MD5,</span>
<a href="#l34.2891"></a><span id="l34.2891"> // so we've to start here and continue in SendUsername if the server</span>
<a href="#l34.2892"></a><span id="l34.2892"> // responds + to &quot;AUTH NTLM&quot;</span>
<a href="#l34.2893"></a><span id="l34.2893" class="difflineminus">-int32_t nsPop3Protocol::AuthNtlm()</span>
<a href="#l34.2894"></a><span id="l34.2894" class="difflineminus">-{</span>
<a href="#l34.2895"></a><span id="l34.2895" class="difflineminus">-    nsAutoCString command (m_currentAuthMethod == POP3_HAS_AUTH_MSN</span>
<a href="#l34.2896"></a><span id="l34.2896" class="difflineminus">-          ? &quot;AUTH MSN&quot; CRLF : &quot;AUTH NTLM&quot; CRLF);</span>
<a href="#l34.2897"></a><span id="l34.2897" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_NTLM_RESPONSE;</span>
<a href="#l34.2898"></a><span id="l34.2898" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.2899"></a><span id="l34.2899" class="difflineminus">-</span>
<a href="#l34.2900"></a><span id="l34.2900" class="difflineminus">-    return Pop3SendData(command.get());</span>
<a href="#l34.2901"></a><span id="l34.2901" class="difflineplus">+int32_t nsPop3Protocol::AuthNtlm() {</span>
<a href="#l34.2902"></a><span id="l34.2902" class="difflineplus">+  nsAutoCString command(m_currentAuthMethod == POP3_HAS_AUTH_MSN</span>
<a href="#l34.2903"></a><span id="l34.2903" class="difflineplus">+                            ? &quot;AUTH MSN&quot; CRLF</span>
<a href="#l34.2904"></a><span id="l34.2904" class="difflineplus">+                            : &quot;AUTH NTLM&quot; CRLF);</span>
<a href="#l34.2905"></a><span id="l34.2905" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_NTLM_RESPONSE;</span>
<a href="#l34.2906"></a><span id="l34.2906" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.2907"></a><span id="l34.2907" class="difflineplus">+</span>
<a href="#l34.2908"></a><span id="l34.2908" class="difflineplus">+  return Pop3SendData(command.get());</span>
<a href="#l34.2909"></a><span id="l34.2909"> }</span>
<a href="#l34.2910"></a><span id="l34.2910"> </span>
<a href="#l34.2911"></a><span id="l34.2911" class="difflineminus">-int32_t nsPop3Protocol::AuthNtlmResponse()</span>
<a href="#l34.2912"></a><span id="l34.2912" class="difflineminus">-{</span>
<a href="#l34.2913"></a><span id="l34.2913" class="difflineminus">-    // need the test to be here instead in NextAuthStep() to</span>
<a href="#l34.2914"></a><span id="l34.2914" class="difflineminus">-    // differentiate between command AUTH NTLM failed and</span>
<a href="#l34.2915"></a><span id="l34.2915" class="difflineminus">-    // sending username using NTLM mechanism failed.</span>
<a href="#l34.2916"></a><span id="l34.2916" class="difflineminus">-    if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.2917"></a><span id="l34.2917" class="difflineminus">-    {</span>
<a href="#l34.2918"></a><span id="l34.2918" class="difflineminus">-        MarkAuthMethodAsFailed(POP3_HAS_AUTH_NTLM);</span>
<a href="#l34.2919"></a><span id="l34.2919" class="difflineminus">-        MarkAuthMethodAsFailed(POP3_HAS_AUTH_MSN);</span>
<a href="#l34.2920"></a><span id="l34.2920" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2921"></a><span id="l34.2921" class="difflineplus">+int32_t nsPop3Protocol::AuthNtlmResponse() {</span>
<a href="#l34.2922"></a><span id="l34.2922" class="difflineplus">+  // need the test to be here instead in NextAuthStep() to</span>
<a href="#l34.2923"></a><span id="l34.2923" class="difflineplus">+  // differentiate between command AUTH NTLM failed and</span>
<a href="#l34.2924"></a><span id="l34.2924" class="difflineplus">+  // sending username using NTLM mechanism failed.</span>
<a href="#l34.2925"></a><span id="l34.2925" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.2926"></a><span id="l34.2926" class="difflineplus">+    MarkAuthMethodAsFailed(POP3_HAS_AUTH_NTLM);</span>
<a href="#l34.2927"></a><span id="l34.2927" class="difflineplus">+    MarkAuthMethodAsFailed(POP3_HAS_AUTH_MSN);</span>
<a href="#l34.2928"></a><span id="l34.2928" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2929"></a><span id="l34.2929" class="difflineplus">+  } else</span>
<a href="#l34.2930"></a><span id="l34.2930" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.2931"></a><span id="l34.2931" class="difflineplus">+</span>
<a href="#l34.2932"></a><span id="l34.2932" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2933"></a><span id="l34.2933" class="difflineplus">+</span>
<a href="#l34.2934"></a><span id="l34.2934" class="difflineplus">+  return 0;</span>
<a href="#l34.2935"></a><span id="l34.2935" class="difflineplus">+}</span>
<a href="#l34.2936"></a><span id="l34.2936" class="difflineplus">+</span>
<a href="#l34.2937"></a><span id="l34.2937" class="difflineplus">+int32_t nsPop3Protocol::AuthGSSAPI() {</span>
<a href="#l34.2938"></a><span id="l34.2938" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;AuthGSSAPI()&quot;)));</span>
<a href="#l34.2939"></a><span id="l34.2939" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.2940"></a><span id="l34.2940" class="difflineplus">+  if (server) {</span>
<a href="#l34.2941"></a><span id="l34.2941" class="difflineplus">+    nsAutoCString cmd;</span>
<a href="#l34.2942"></a><span id="l34.2942" class="difflineplus">+    nsAutoCString service(&quot;pop@&quot;);</span>
<a href="#l34.2943"></a><span id="l34.2943" class="difflineplus">+    nsCString hostName;</span>
<a href="#l34.2944"></a><span id="l34.2944" class="difflineplus">+    nsresult rv;</span>
<a href="#l34.2945"></a><span id="l34.2945" class="difflineplus">+    server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.2946"></a><span id="l34.2946" class="difflineplus">+    service.Append(hostName);</span>
<a href="#l34.2947"></a><span id="l34.2947" class="difflineplus">+    rv = DoGSSAPIStep1(service.get(), m_username.get(), cmd);</span>
<a href="#l34.2948"></a><span id="l34.2948" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.2949"></a><span id="l34.2949" class="difflineplus">+      m_GSSAPICache.Assign(cmd);</span>
<a href="#l34.2950"></a><span id="l34.2950" class="difflineplus">+      m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_FIRST;</span>
<a href="#l34.2951"></a><span id="l34.2951" class="difflineplus">+      m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.2952"></a><span id="l34.2952" class="difflineplus">+      return Pop3SendData(&quot;AUTH GSSAPI&quot; CRLF);</span>
<a href="#l34.2953"></a><span id="l34.2953">     }</span>
<a href="#l34.2954"></a><span id="l34.2954" class="difflineminus">-    else</span>
<a href="#l34.2955"></a><span id="l34.2955" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.2956"></a><span id="l34.2956" class="difflineminus">-</span>
<a href="#l34.2957"></a><span id="l34.2957" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2958"></a><span id="l34.2958" class="difflineminus">-</span>
<a href="#l34.2959"></a><span id="l34.2959" class="difflineminus">-    return 0;</span>
<a href="#l34.2960"></a><span id="l34.2960" class="difflineplus">+  }</span>
<a href="#l34.2961"></a><span id="l34.2961" class="difflineplus">+</span>
<a href="#l34.2962"></a><span id="l34.2962" class="difflineplus">+  MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.2963"></a><span id="l34.2963" class="difflineplus">+  m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2964"></a><span id="l34.2964" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2965"></a><span id="l34.2965" class="difflineplus">+  return 0;</span>
<a href="#l34.2966"></a><span id="l34.2966"> }</span>
<a href="#l34.2967"></a><span id="l34.2967"> </span>
<a href="#l34.2968"></a><span id="l34.2968" class="difflineminus">-int32_t nsPop3Protocol::AuthGSSAPI()</span>
<a href="#l34.2969"></a><span id="l34.2969" class="difflineminus">-{</span>
<a href="#l34.2970"></a><span id="l34.2970" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;AuthGSSAPI()&quot;)));</span>
<a href="#l34.2971"></a><span id="l34.2971" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.2972"></a><span id="l34.2972" class="difflineminus">-    if (server) {</span>
<a href="#l34.2973"></a><span id="l34.2973" class="difflineminus">-        nsAutoCString cmd;</span>
<a href="#l34.2974"></a><span id="l34.2974" class="difflineminus">-        nsAutoCString service(&quot;pop@&quot;);</span>
<a href="#l34.2975"></a><span id="l34.2975" class="difflineminus">-        nsCString hostName;</span>
<a href="#l34.2976"></a><span id="l34.2976" class="difflineminus">-        nsresult rv;</span>
<a href="#l34.2977"></a><span id="l34.2977" class="difflineminus">-        server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.2978"></a><span id="l34.2978" class="difflineminus">-        service.Append(hostName);</span>
<a href="#l34.2979"></a><span id="l34.2979" class="difflineminus">-        rv = DoGSSAPIStep1(service.get(), m_username.get(), cmd);</span>
<a href="#l34.2980"></a><span id="l34.2980" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.2981"></a><span id="l34.2981" class="difflineminus">-            m_GSSAPICache.Assign(cmd);</span>
<a href="#l34.2982"></a><span id="l34.2982" class="difflineminus">-            m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_FIRST;</span>
<a href="#l34.2983"></a><span id="l34.2983" class="difflineminus">-            m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.2984"></a><span id="l34.2984" class="difflineminus">-            return Pop3SendData(&quot;AUTH GSSAPI&quot; CRLF);</span>
<a href="#l34.2985"></a><span id="l34.2985" class="difflineminus">-        }</span>
<a href="#l34.2986"></a><span id="l34.2986" class="difflineminus">-    }</span>
<a href="#l34.2987"></a><span id="l34.2987" class="difflineminus">-</span>
<a href="#l34.2988"></a><span id="l34.2988" class="difflineplus">+int32_t nsPop3Protocol::AuthGSSAPIResponse(bool first) {</span>
<a href="#l34.2989"></a><span id="l34.2989" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.2990"></a><span id="l34.2990" class="difflineplus">+    if (first) m_GSSAPICache.Truncate();</span>
<a href="#l34.2991"></a><span id="l34.2991">     MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.2992"></a><span id="l34.2992">     m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.2993"></a><span id="l34.2993">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.2994"></a><span id="l34.2994">     return 0;</span>
<a href="#l34.2995"></a><span id="l34.2995" class="difflineminus">-}</span>
<a href="#l34.2996"></a><span id="l34.2996" class="difflineminus">-</span>
<a href="#l34.2997"></a><span id="l34.2997" class="difflineminus">-int32_t nsPop3Protocol::AuthGSSAPIResponse(bool first)</span>
<a href="#l34.2998"></a><span id="l34.2998" class="difflineminus">-{</span>
<a href="#l34.2999"></a><span id="l34.2999" class="difflineminus">-    if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.3000"></a><span id="l34.3000" class="difflineminus">-    {</span>
<a href="#l34.3001"></a><span id="l34.3001" class="difflineminus">-        if (first)</span>
<a href="#l34.3002"></a><span id="l34.3002" class="difflineminus">-            m_GSSAPICache.Truncate();</span>
<a href="#l34.3003"></a><span id="l34.3003" class="difflineminus">-        MarkAuthMethodAsFailed(POP3_HAS_AUTH_GSSAPI);</span>
<a href="#l34.3004"></a><span id="l34.3004" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_PROCESS_AUTH;</span>
<a href="#l34.3005"></a><span id="l34.3005" class="difflineminus">-        m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.3006"></a><span id="l34.3006" class="difflineminus">-        return 0;</span>
<a href="#l34.3007"></a><span id="l34.3007" class="difflineplus">+  }</span>
<a href="#l34.3008"></a><span id="l34.3008" class="difflineplus">+</span>
<a href="#l34.3009"></a><span id="l34.3009" class="difflineplus">+  int32_t result;</span>
<a href="#l34.3010"></a><span id="l34.3010" class="difflineplus">+</span>
<a href="#l34.3011"></a><span id="l34.3011" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_STEP;</span>
<a href="#l34.3012"></a><span id="l34.3012" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3013"></a><span id="l34.3013" class="difflineplus">+</span>
<a href="#l34.3014"></a><span id="l34.3014" class="difflineplus">+  if (first) {</span>
<a href="#l34.3015"></a><span id="l34.3015" class="difflineplus">+    m_GSSAPICache += CRLF;</span>
<a href="#l34.3016"></a><span id="l34.3016" class="difflineplus">+    result = Pop3SendData(m_GSSAPICache.get());</span>
<a href="#l34.3017"></a><span id="l34.3017" class="difflineplus">+    m_GSSAPICache.Truncate();</span>
<a href="#l34.3018"></a><span id="l34.3018" class="difflineplus">+  } else {</span>
<a href="#l34.3019"></a><span id="l34.3019" class="difflineplus">+    nsAutoCString cmd;</span>
<a href="#l34.3020"></a><span id="l34.3020" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;GSSAPI step 2&quot;)));</span>
<a href="#l34.3021"></a><span id="l34.3021" class="difflineplus">+    nsresult rv = DoGSSAPIStep2(m_commandResponse, cmd);</span>
<a href="#l34.3022"></a><span id="l34.3022" class="difflineplus">+    if (NS_FAILED(rv)) cmd = &quot;*&quot;;</span>
<a href="#l34.3023"></a><span id="l34.3023" class="difflineplus">+    if (rv == NS_SUCCESS_AUTH_FINISHED) {</span>
<a href="#l34.3024"></a><span id="l34.3024" class="difflineplus">+      m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.3025"></a><span id="l34.3025" class="difflineplus">+      m_password_already_sent = true;</span>
<a href="#l34.3026"></a><span id="l34.3026">     }</span>
<a href="#l34.3027"></a><span id="l34.3027" class="difflineminus">-</span>
<a href="#l34.3028"></a><span id="l34.3028" class="difflineminus">-    int32_t result;</span>
<a href="#l34.3029"></a><span id="l34.3029" class="difflineminus">-</span>
<a href="#l34.3030"></a><span id="l34.3030" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_AUTH_GSSAPI_STEP;</span>
<a href="#l34.3031"></a><span id="l34.3031" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3032"></a><span id="l34.3032" class="difflineminus">-</span>
<a href="#l34.3033"></a><span id="l34.3033" class="difflineminus">-    if (first) {</span>
<a href="#l34.3034"></a><span id="l34.3034" class="difflineminus">-        m_GSSAPICache += CRLF;</span>
<a href="#l34.3035"></a><span id="l34.3035" class="difflineminus">-        result = Pop3SendData(m_GSSAPICache.get());</span>
<a href="#l34.3036"></a><span id="l34.3036" class="difflineminus">-        m_GSSAPICache.Truncate();</span>
<a href="#l34.3037"></a><span id="l34.3037" class="difflineminus">-    }</span>
<a href="#l34.3038"></a><span id="l34.3038" class="difflineminus">-    else {</span>
<a href="#l34.3039"></a><span id="l34.3039" class="difflineminus">-        nsAutoCString cmd;</span>
<a href="#l34.3040"></a><span id="l34.3040" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;GSSAPI step 2&quot;)));</span>
<a href="#l34.3041"></a><span id="l34.3041" class="difflineminus">-        nsresult rv = DoGSSAPIStep2(m_commandResponse, cmd);</span>
<a href="#l34.3042"></a><span id="l34.3042" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l34.3043"></a><span id="l34.3043" class="difflineminus">-            cmd = &quot;*&quot;;</span>
<a href="#l34.3044"></a><span id="l34.3044" class="difflineminus">-        if (rv == NS_SUCCESS_AUTH_FINISHED) {</span>
<a href="#l34.3045"></a><span id="l34.3045" class="difflineminus">-            m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.3046"></a><span id="l34.3046" class="difflineminus">-            m_password_already_sent = true;</span>
<a href="#l34.3047"></a><span id="l34.3047" class="difflineminus">-        }</span>
<a href="#l34.3048"></a><span id="l34.3048" class="difflineminus">-        cmd += CRLF;</span>
<a href="#l34.3049"></a><span id="l34.3049" class="difflineminus">-        result = Pop3SendData(cmd.get());</span>
<a href="#l34.3050"></a><span id="l34.3050" class="difflineminus">-    }</span>
<a href="#l34.3051"></a><span id="l34.3051" class="difflineminus">-</span>
<a href="#l34.3052"></a><span id="l34.3052" class="difflineminus">-    return result;</span>
<a href="#l34.3053"></a><span id="l34.3053" class="difflineplus">+    cmd += CRLF;</span>
<a href="#l34.3054"></a><span id="l34.3054" class="difflineplus">+    result = Pop3SendData(cmd.get());</span>
<a href="#l34.3055"></a><span id="l34.3055" class="difflineplus">+  }</span>
<a href="#l34.3056"></a><span id="l34.3056" class="difflineplus">+</span>
<a href="#l34.3057"></a><span id="l34.3057" class="difflineplus">+  return result;</span>
<a href="#l34.3058"></a><span id="l34.3058"> }</span>
<a href="#l34.3059"></a><span id="l34.3059"> </span>
<a href="#l34.3060"></a><span id="l34.3060" class="difflineminus">-int32_t nsPop3Protocol::SendUsername()</span>
<a href="#l34.3061"></a><span id="l34.3061" class="difflineminus">-{</span>
<a href="#l34.3062"></a><span id="l34.3062" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendUsername()&quot;)));</span>
<a href="#l34.3063"></a><span id="l34.3063" class="difflineminus">-    if(m_username.IsEmpty())</span>
<a href="#l34.3064"></a><span id="l34.3064" class="difflineminus">-      return Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l34.3065"></a><span id="l34.3065" class="difflineminus">-</span>
<a href="#l34.3066"></a><span id="l34.3066" class="difflineminus">-    // &lt;copied from=&quot;SendPassword()&quot;&gt;</span>
<a href="#l34.3067"></a><span id="l34.3067" class="difflineminus">-    // Needed for NTLM</span>
<a href="#l34.3068"></a><span id="l34.3068" class="difflineminus">-</span>
<a href="#l34.3069"></a><span id="l34.3069" class="difflineminus">-    // The POP3_SEND_PASSWORD/POP3_WAIT_SEND_PASSWORD states have already</span>
<a href="#l34.3070"></a><span id="l34.3070" class="difflineminus">-    // got the password - they will have cancelled if necessary.</span>
<a href="#l34.3071"></a><span id="l34.3071" class="difflineminus">-    // If the password is still empty here, don't try to go on.</span>
<a href="#l34.3072"></a><span id="l34.3072" class="difflineminus">-    if (m_passwordResult.IsEmpty())</span>
<a href="#l34.3073"></a><span id="l34.3073" class="difflineminus">-    {</span>
<a href="#l34.3074"></a><span id="l34.3074" class="difflineminus">-      m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.3075"></a><span id="l34.3075" class="difflineminus">-      return Error(&quot;pop3PasswordUndefined&quot;);</span>
<a href="#l34.3076"></a><span id="l34.3076" class="difflineminus">-    }</span>
<a href="#l34.3077"></a><span id="l34.3077" class="difflineminus">-    // &lt;/copied&gt;</span>
<a href="#l34.3078"></a><span id="l34.3078" class="difflineminus">-</span>
<a href="#l34.3079"></a><span id="l34.3079" class="difflineminus">-    nsAutoCString cmd;</span>
<a href="#l34.3080"></a><span id="l34.3080" class="difflineminus">-</span>
<a href="#l34.3081"></a><span id="l34.3081" class="difflineminus">-    if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l34.3082"></a><span id="l34.3082" class="difflineminus">-        (void) DoNtlmStep1(m_username, m_passwordResult, cmd);</span>
<a href="#l34.3083"></a><span id="l34.3083" class="difflineminus">-    else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l34.3084"></a><span id="l34.3084" class="difflineminus">-        cmd = &quot;AUTH CRAM-MD5&quot;;</span>
<a href="#l34.3085"></a><span id="l34.3085" class="difflineminus">-    else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l34.3086"></a><span id="l34.3086" class="difflineminus">-        cmd = &quot;AUTH PLAIN&quot;;</span>
<a href="#l34.3087"></a><span id="l34.3087" class="difflineminus">-    else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l34.3088"></a><span id="l34.3088" class="difflineminus">-    {</span>
<a href="#l34.3089"></a><span id="l34.3089" class="difflineminus">-        char *base64Str = PL_Base64Encode(m_username.get(), m_username.Length(), nullptr);</span>
<a href="#l34.3090"></a><span id="l34.3090" class="difflineminus">-        cmd = base64Str;</span>
<a href="#l34.3091"></a><span id="l34.3091" class="difflineminus">-        PR_Free(base64Str);</span>
<a href="#l34.3092"></a><span id="l34.3092" class="difflineminus">-    }</span>
<a href="#l34.3093"></a><span id="l34.3093" class="difflineminus">-    else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l34.3094"></a><span id="l34.3094" class="difflineminus">-    {</span>
<a href="#l34.3095"></a><span id="l34.3095" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;USER login&quot;)));</span>
<a href="#l34.3096"></a><span id="l34.3096" class="difflineminus">-        cmd = &quot;USER &quot;;</span>
<a href="#l34.3097"></a><span id="l34.3097" class="difflineminus">-        cmd += m_username;</span>
<a href="#l34.3098"></a><span id="l34.3098" class="difflineminus">-    }</span>
<a href="#l34.3099"></a><span id="l34.3099" class="difflineminus">-    else</span>
<a href="#l34.3100"></a><span id="l34.3100" class="difflineminus">-    {</span>
<a href="#l34.3101"></a><span id="l34.3101" class="difflineminus">-      MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.3102"></a><span id="l34.3102" class="difflineminus">-              (POP3LOG(&quot;In nsPop3Protocol::SendUsername(), m_currentAuthMethod is 0x%X, &quot;</span>
<a href="#l34.3103"></a><span id="l34.3103" class="difflineminus">-                       &quot;but that is unexpected&quot;), m_currentAuthMethod));</span>
<a href="#l34.3104"></a><span id="l34.3104" class="difflineminus">-      return Error(&quot;pop3AuthInternalError&quot;);</span>
<a href="#l34.3105"></a><span id="l34.3105" class="difflineminus">-    }</span>
<a href="#l34.3106"></a><span id="l34.3106" class="difflineminus">-</span>
<a href="#l34.3107"></a><span id="l34.3107" class="difflineminus">-    cmd += CRLF;</span>
<a href="#l34.3108"></a><span id="l34.3108" class="difflineminus">-</span>
<a href="#l34.3109"></a><span id="l34.3109" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.3110"></a><span id="l34.3110" class="difflineminus">-</span>
<a href="#l34.3111"></a><span id="l34.3111" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3112"></a><span id="l34.3112" class="difflineminus">-</span>
<a href="#l34.3113"></a><span id="l34.3113" class="difflineminus">-    return Pop3SendData(cmd.get());</span>
<a href="#l34.3114"></a><span id="l34.3114" class="difflineplus">+int32_t nsPop3Protocol::SendUsername() {</span>
<a href="#l34.3115"></a><span id="l34.3115" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendUsername()&quot;)));</span>
<a href="#l34.3116"></a><span id="l34.3116" class="difflineplus">+  if (m_username.IsEmpty()) return Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l34.3117"></a><span id="l34.3117" class="difflineplus">+</span>
<a href="#l34.3118"></a><span id="l34.3118" class="difflineplus">+  // &lt;copied from=&quot;SendPassword()&quot;&gt;</span>
<a href="#l34.3119"></a><span id="l34.3119" class="difflineplus">+  // Needed for NTLM</span>
<a href="#l34.3120"></a><span id="l34.3120" class="difflineplus">+</span>
<a href="#l34.3121"></a><span id="l34.3121" class="difflineplus">+  // The POP3_SEND_PASSWORD/POP3_WAIT_SEND_PASSWORD states have already</span>
<a href="#l34.3122"></a><span id="l34.3122" class="difflineplus">+  // got the password - they will have cancelled if necessary.</span>
<a href="#l34.3123"></a><span id="l34.3123" class="difflineplus">+  // If the password is still empty here, don't try to go on.</span>
<a href="#l34.3124"></a><span id="l34.3124" class="difflineplus">+  if (m_passwordResult.IsEmpty()) {</span>
<a href="#l34.3125"></a><span id="l34.3125" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.3126"></a><span id="l34.3126" class="difflineplus">+    return Error(&quot;pop3PasswordUndefined&quot;);</span>
<a href="#l34.3127"></a><span id="l34.3127" class="difflineplus">+  }</span>
<a href="#l34.3128"></a><span id="l34.3128" class="difflineplus">+  // &lt;/copied&gt;</span>
<a href="#l34.3129"></a><span id="l34.3129" class="difflineplus">+</span>
<a href="#l34.3130"></a><span id="l34.3130" class="difflineplus">+  nsAutoCString cmd;</span>
<a href="#l34.3131"></a><span id="l34.3131" class="difflineplus">+</span>
<a href="#l34.3132"></a><span id="l34.3132" class="difflineplus">+  if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l34.3133"></a><span id="l34.3133" class="difflineplus">+    (void)DoNtlmStep1(m_username, m_passwordResult, cmd);</span>
<a href="#l34.3134"></a><span id="l34.3134" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l34.3135"></a><span id="l34.3135" class="difflineplus">+    cmd = &quot;AUTH CRAM-MD5&quot;;</span>
<a href="#l34.3136"></a><span id="l34.3136" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l34.3137"></a><span id="l34.3137" class="difflineplus">+    cmd = &quot;AUTH PLAIN&quot;;</span>
<a href="#l34.3138"></a><span id="l34.3138" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN) {</span>
<a href="#l34.3139"></a><span id="l34.3139" class="difflineplus">+    char *base64Str =</span>
<a href="#l34.3140"></a><span id="l34.3140" class="difflineplus">+        PL_Base64Encode(m_username.get(), m_username.Length(), nullptr);</span>
<a href="#l34.3141"></a><span id="l34.3141" class="difflineplus">+    cmd = base64Str;</span>
<a href="#l34.3142"></a><span id="l34.3142" class="difflineplus">+    PR_Free(base64Str);</span>
<a href="#l34.3143"></a><span id="l34.3143" class="difflineplus">+  } else if (m_currentAuthMethod == POP3_HAS_AUTH_USER) {</span>
<a href="#l34.3144"></a><span id="l34.3144" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;USER login&quot;)));</span>
<a href="#l34.3145"></a><span id="l34.3145" class="difflineplus">+    cmd = &quot;USER &quot;;</span>
<a href="#l34.3146"></a><span id="l34.3146" class="difflineplus">+    cmd += m_username;</span>
<a href="#l34.3147"></a><span id="l34.3147" class="difflineplus">+  } else {</span>
<a href="#l34.3148"></a><span id="l34.3148" class="difflineplus">+    MOZ_LOG(</span>
<a href="#l34.3149"></a><span id="l34.3149" class="difflineplus">+        POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.3150"></a><span id="l34.3150" class="difflineplus">+        (POP3LOG(</span>
<a href="#l34.3151"></a><span id="l34.3151" class="difflineplus">+             &quot;In nsPop3Protocol::SendUsername(), m_currentAuthMethod is 0x%X, &quot;</span>
<a href="#l34.3152"></a><span id="l34.3152" class="difflineplus">+             &quot;but that is unexpected&quot;),</span>
<a href="#l34.3153"></a><span id="l34.3153" class="difflineplus">+         m_currentAuthMethod));</span>
<a href="#l34.3154"></a><span id="l34.3154" class="difflineplus">+    return Error(&quot;pop3AuthInternalError&quot;);</span>
<a href="#l34.3155"></a><span id="l34.3155" class="difflineplus">+  }</span>
<a href="#l34.3156"></a><span id="l34.3156" class="difflineplus">+</span>
<a href="#l34.3157"></a><span id="l34.3157" class="difflineplus">+  cmd += CRLF;</span>
<a href="#l34.3158"></a><span id="l34.3158" class="difflineplus">+</span>
<a href="#l34.3159"></a><span id="l34.3159" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.3160"></a><span id="l34.3160" class="difflineplus">+</span>
<a href="#l34.3161"></a><span id="l34.3161" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3162"></a><span id="l34.3162" class="difflineplus">+</span>
<a href="#l34.3163"></a><span id="l34.3163" class="difflineplus">+  return Pop3SendData(cmd.get());</span>
<a href="#l34.3164"></a><span id="l34.3164"> }</span>
<a href="#l34.3165"></a><span id="l34.3165"> </span>
<a href="#l34.3166"></a><span id="l34.3166" class="difflineminus">-int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l34.3167"></a><span id="l34.3167" class="difflineminus">-{</span>
<a href="#l34.3168"></a><span id="l34.3168" class="difflineplus">+int32_t nsPop3Protocol::SendPassword() {</span>
<a href="#l34.3169"></a><span id="l34.3169">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;SendPassword()&quot;)));</span>
<a href="#l34.3170"></a><span id="l34.3170" class="difflineminus">-  if (m_username.IsEmpty())</span>
<a href="#l34.3171"></a><span id="l34.3171" class="difflineminus">-    return Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l34.3172"></a><span id="l34.3172" class="difflineplus">+  if (m_username.IsEmpty()) return Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l34.3173"></a><span id="l34.3173"> </span>
<a href="#l34.3174"></a><span id="l34.3174">   // &lt;copied to=&quot;SendUsername()&quot;&gt;</span>
<a href="#l34.3175"></a><span id="l34.3175">   // Needed here, too, because APOP skips SendUsername()</span>
<a href="#l34.3176"></a><span id="l34.3176">   // The POP3_SEND_PASSWORD/POP3_WAIT_SEND_PASSWORD states have already</span>
<a href="#l34.3177"></a><span id="l34.3177">   // got the password - they will have cancelled if necessary.</span>
<a href="#l34.3178"></a><span id="l34.3178">   // If the password is still empty here, don't try to go on.</span>
<a href="#l34.3179"></a><span id="l34.3179" class="difflineminus">-  if (m_passwordResult.IsEmpty())</span>
<a href="#l34.3180"></a><span id="l34.3180" class="difflineminus">-  {</span>
<a href="#l34.3181"></a><span id="l34.3181" class="difflineplus">+  if (m_passwordResult.IsEmpty()) {</span>
<a href="#l34.3182"></a><span id="l34.3182">     m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.3183"></a><span id="l34.3183">     return Error(&quot;pop3PasswordUndefined&quot;);</span>
<a href="#l34.3184"></a><span id="l34.3184">   }</span>
<a href="#l34.3185"></a><span id="l34.3185">   // &lt;/copied&gt;</span>
<a href="#l34.3186"></a><span id="l34.3186"> </span>
<a href="#l34.3187"></a><span id="l34.3187">   nsAutoCString cmd;</span>
<a href="#l34.3188"></a><span id="l34.3188">   nsresult rv;</span>
<a href="#l34.3189"></a><span id="l34.3189">   NS_ConvertUTF16toUTF8 passwordUTF8(m_passwordResult);</span>
<a href="#l34.3190"></a><span id="l34.3190"> </span>
<a href="#l34.3191"></a><span id="l34.3191">   if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l34.3192"></a><span id="l34.3192">     rv = DoNtlmStep2(m_commandResponse, cmd);</span>
<a href="#l34.3193"></a><span id="l34.3193" class="difflineminus">-  else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l34.3194"></a><span id="l34.3194" class="difflineminus">-  {</span>
<a href="#l34.3195"></a><span id="l34.3195" class="difflineplus">+  else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5) {</span>
<a href="#l34.3196"></a><span id="l34.3196">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;CRAM login&quot;)));</span>
<a href="#l34.3197"></a><span id="l34.3197">     char buffer[255 + 1 + 2 * DIGEST_LENGTH + 1];</span>
<a href="#l34.3198"></a><span id="l34.3198">     unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l34.3199"></a><span id="l34.3199"> </span>
<a href="#l34.3200"></a><span id="l34.3200" class="difflineminus">-    char *decodedChallenge = PL_Base64Decode(m_commandResponse.get(),</span>
<a href="#l34.3201"></a><span id="l34.3201" class="difflineminus">-                                             m_commandResponse.Length(), nullptr);</span>
<a href="#l34.3202"></a><span id="l34.3202" class="difflineplus">+    char *decodedChallenge = PL_Base64Decode(</span>
<a href="#l34.3203"></a><span id="l34.3203" class="difflineplus">+        m_commandResponse.get(), m_commandResponse.Length(), nullptr);</span>
<a href="#l34.3204"></a><span id="l34.3204"> </span>
<a href="#l34.3205"></a><span id="l34.3205">     if (decodedChallenge)</span>
<a href="#l34.3206"></a><span id="l34.3206">       rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge),</span>
<a href="#l34.3207"></a><span id="l34.3207">                       passwordUTF8.get(), passwordUTF8.Length(), digest);</span>
<a href="#l34.3208"></a><span id="l34.3208">     else</span>
<a href="#l34.3209"></a><span id="l34.3209">       rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l34.3210"></a><span id="l34.3210"> </span>
<a href="#l34.3211"></a><span id="l34.3211" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l34.3212"></a><span id="l34.3212" class="difflineminus">-    {</span>
<a href="#l34.3213"></a><span id="l34.3213" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.3214"></a><span id="l34.3214">       // The encoded digest is the hexadecimal representation of</span>
<a href="#l34.3215"></a><span id="l34.3215">       // DIGEST_LENGTH characters, so it will be twice that length.</span>
<a href="#l34.3216"></a><span id="l34.3216">       nsAutoCStringN&lt;2 * DIGEST_LENGTH&gt; encodedDigest;</span>
<a href="#l34.3217"></a><span id="l34.3217"> </span>
<a href="#l34.3218"></a><span id="l34.3218" class="difflineminus">-      for (uint32_t j = 0; j &lt; DIGEST_LENGTH; j++)</span>
<a href="#l34.3219"></a><span id="l34.3219" class="difflineminus">-      {</span>
<a href="#l34.3220"></a><span id="l34.3220" class="difflineplus">+      for (uint32_t j = 0; j &lt; DIGEST_LENGTH; j++) {</span>
<a href="#l34.3221"></a><span id="l34.3221">         char hexVal[3];</span>
<a href="#l34.3222"></a><span id="l34.3222" class="difflineminus">-        PR_snprintf (hexVal, 3, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l34.3223"></a><span id="l34.3223" class="difflineplus">+        PR_snprintf(hexVal, 3, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l34.3224"></a><span id="l34.3224">         encodedDigest.Append(hexVal);</span>
<a href="#l34.3225"></a><span id="l34.3225">       }</span>
<a href="#l34.3226"></a><span id="l34.3226"> </span>
<a href="#l34.3227"></a><span id="l34.3227">       PR_snprintf(buffer, sizeof(buffer), &quot;%.255s %s&quot;, m_username.get(),</span>
<a href="#l34.3228"></a><span id="l34.3228">                   encodedDigest.get());</span>
<a href="#l34.3229"></a><span id="l34.3229">       char *base64Str = PL_Base64Encode(buffer, strlen(buffer), nullptr);</span>
<a href="#l34.3230"></a><span id="l34.3230">       cmd.Adopt(base64Str);</span>
<a href="#l34.3231"></a><span id="l34.3231">     }</span>
<a href="#l34.3232"></a><span id="l34.3232"> </span>
<a href="#l34.3233"></a><span id="l34.3233" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.3234"></a><span id="l34.3234" class="difflineminus">-      cmd = &quot;*&quot;;</span>
<a href="#l34.3235"></a><span id="l34.3235" class="difflineminus">-  }</span>
<a href="#l34.3236"></a><span id="l34.3236" class="difflineminus">-  else if (m_currentAuthMethod == POP3_HAS_AUTH_APOP)</span>
<a href="#l34.3237"></a><span id="l34.3237" class="difflineminus">-  {</span>
<a href="#l34.3238"></a><span id="l34.3238" class="difflineplus">+    if (NS_FAILED(rv)) cmd = &quot;*&quot;;</span>
<a href="#l34.3239"></a><span id="l34.3239" class="difflineplus">+  } else if (m_currentAuthMethod == POP3_HAS_AUTH_APOP) {</span>
<a href="#l34.3240"></a><span id="l34.3240">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;APOP login&quot;)));</span>
<a href="#l34.3241"></a><span id="l34.3241">     char buffer[5 + 255 + 1 + 2 * DIGEST_LENGTH + 1];</span>
<a href="#l34.3242"></a><span id="l34.3242">     unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l34.3243"></a><span id="l34.3243"> </span>
<a href="#l34.3244"></a><span id="l34.3244">     rv = MSGApopMD5(m_ApopTimestamp.get(), m_ApopTimestamp.Length(),</span>
<a href="#l34.3245"></a><span id="l34.3245">                     passwordUTF8.get(), passwordUTF8.Length(), digest);</span>
<a href="#l34.3246"></a><span id="l34.3246"> </span>
<a href="#l34.3247"></a><span id="l34.3247" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l34.3248"></a><span id="l34.3248" class="difflineminus">-    {</span>
<a href="#l34.3249"></a><span id="l34.3249" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.3250"></a><span id="l34.3250">       // The encoded digest is the hexadecimal representation of</span>
<a href="#l34.3251"></a><span id="l34.3251">       // DIGEST_LENGTH characters, so it will be twice that length.</span>
<a href="#l34.3252"></a><span id="l34.3252">       nsAutoCStringN&lt;2 * DIGEST_LENGTH&gt; encodedDigest;</span>
<a href="#l34.3253"></a><span id="l34.3253"> </span>
<a href="#l34.3254"></a><span id="l34.3254" class="difflineminus">-      for (uint32_t j = 0; j &lt; DIGEST_LENGTH; j++)</span>
<a href="#l34.3255"></a><span id="l34.3255" class="difflineminus">-      {</span>
<a href="#l34.3256"></a><span id="l34.3256" class="difflineplus">+      for (uint32_t j = 0; j &lt; DIGEST_LENGTH; j++) {</span>
<a href="#l34.3257"></a><span id="l34.3257">         char hexVal[3];</span>
<a href="#l34.3258"></a><span id="l34.3258" class="difflineminus">-        PR_snprintf (hexVal, 3, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l34.3259"></a><span id="l34.3259" class="difflineplus">+        PR_snprintf(hexVal, 3, &quot;%.2x&quot;, 0x0ff &amp; (unsigned short)digest[j]);</span>
<a href="#l34.3260"></a><span id="l34.3260">         encodedDigest.Append(hexVal);</span>
<a href="#l34.3261"></a><span id="l34.3261">       }</span>
<a href="#l34.3262"></a><span id="l34.3262"> </span>
<a href="#l34.3263"></a><span id="l34.3263">       PR_snprintf(buffer, sizeof(buffer), &quot;APOP %.255s %s&quot;, m_username.get(),</span>
<a href="#l34.3264"></a><span id="l34.3264">                   encodedDigest.get());</span>
<a href="#l34.3265"></a><span id="l34.3265">       cmd = buffer;</span>
<a href="#l34.3266"></a><span id="l34.3266">     }</span>
<a href="#l34.3267"></a><span id="l34.3267"> </span>
<a href="#l34.3268"></a><span id="l34.3268" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.3269"></a><span id="l34.3269" class="difflineminus">-      cmd = &quot;*&quot;;</span>
<a href="#l34.3270"></a><span id="l34.3270" class="difflineminus">-  }</span>
<a href="#l34.3271"></a><span id="l34.3271" class="difflineminus">-  else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l34.3272"></a><span id="l34.3272" class="difflineminus">-  {</span>
<a href="#l34.3273"></a><span id="l34.3273" class="difflineplus">+    if (NS_FAILED(rv)) cmd = &quot;*&quot;;</span>
<a href="#l34.3274"></a><span id="l34.3274" class="difflineplus">+  } else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN) {</span>
<a href="#l34.3275"></a><span id="l34.3275">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;PLAIN login&quot;)));</span>
<a href="#l34.3276"></a><span id="l34.3276">     // workaround for IPswitch's IMail server software</span>
<a href="#l34.3277"></a><span id="l34.3277">     // this server goes into LOGIN mode even if we send &quot;AUTH PLAIN&quot;</span>
<a href="#l34.3278"></a><span id="l34.3278" class="difflineminus">-    // &quot;VXNlc&quot; is the beginning of the base64 encoded prompt (&quot;Username:&quot;) for LOGIN</span>
<a href="#l34.3279"></a><span id="l34.3279" class="difflineminus">-    if (StringBeginsWith(m_commandResponse, NS_LITERAL_CSTRING(&quot;VXNlc&quot;)))</span>
<a href="#l34.3280"></a><span id="l34.3280" class="difflineminus">-    {</span>
<a href="#l34.3281"></a><span id="l34.3281" class="difflineplus">+    // &quot;VXNlc&quot; is the beginning of the base64 encoded prompt (&quot;Username:&quot;) for</span>
<a href="#l34.3282"></a><span id="l34.3282" class="difflineplus">+    // LOGIN</span>
<a href="#l34.3283"></a><span id="l34.3283" class="difflineplus">+    if (StringBeginsWith(m_commandResponse, NS_LITERAL_CSTRING(&quot;VXNlc&quot;))) {</span>
<a href="#l34.3284"></a><span id="l34.3284">       // disable PLAIN and enable LOGIN (in case it's not already enabled)</span>
<a href="#l34.3285"></a><span id="l34.3285">       ClearCapFlag(POP3_HAS_AUTH_PLAIN);</span>
<a href="#l34.3286"></a><span id="l34.3286">       SetCapFlag(POP3_HAS_AUTH_LOGIN);</span>
<a href="#l34.3287"></a><span id="l34.3287">       m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3288"></a><span id="l34.3288"> </span>
<a href="#l34.3289"></a><span id="l34.3289">       // reenter authentication again at LOGIN response handler</span>
<a href="#l34.3290"></a><span id="l34.3290">       m_pop3ConData-&gt;next_state = POP3_AUTH_LOGIN_RESPONSE;</span>
<a href="#l34.3291"></a><span id="l34.3291">       m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.3292"></a><span id="l34.3292">       return 0;</span>
<a href="#l34.3293"></a><span id="l34.3293">     }</span>
<a href="#l34.3294"></a><span id="l34.3294"> </span>
<a href="#l34.3295"></a><span id="l34.3295">     char plain_string[513];</span>
<a href="#l34.3296"></a><span id="l34.3296">     memset(plain_string, 0, 513);</span>
<a href="#l34.3297"></a><span id="l34.3297">     PR_snprintf(&amp;plain_string[1], 256, &quot;%.255s&quot;, m_username.get());</span>
<a href="#l34.3298"></a><span id="l34.3298" class="difflineminus">-    uint32_t len = std::min(m_username.Length(), 255u) + 2;  // We include two &lt;NUL&gt; characters.</span>
<a href="#l34.3299"></a><span id="l34.3299" class="difflineplus">+    uint32_t len = std::min(m_username.Length(), 255u) +</span>
<a href="#l34.3300"></a><span id="l34.3300" class="difflineplus">+                   2;                 // We include two &lt;NUL&gt; characters.</span>
<a href="#l34.3301"></a><span id="l34.3301">     if (passwordUTF8.Length() &gt; 255)  // RFC 4616: passwd; up to 255 octets</span>
<a href="#l34.3302"></a><span id="l34.3302">       passwordUTF8.Truncate(255);</span>
<a href="#l34.3303"></a><span id="l34.3303">     PR_snprintf(&amp;plain_string[len], 256, &quot;%s&quot;, passwordUTF8.get());</span>
<a href="#l34.3304"></a><span id="l34.3304">     len += passwordUTF8.Length();</span>
<a href="#l34.3305"></a><span id="l34.3305"> </span>
<a href="#l34.3306"></a><span id="l34.3306">     char *base64Str = PL_Base64Encode(plain_string, len, nullptr);</span>
<a href="#l34.3307"></a><span id="l34.3307">     cmd.Adopt(base64Str);</span>
<a href="#l34.3308"></a><span id="l34.3308" class="difflineminus">-  }</span>
<a href="#l34.3309"></a><span id="l34.3309" class="difflineminus">-  else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l34.3310"></a><span id="l34.3310" class="difflineminus">-  {</span>
<a href="#l34.3311"></a><span id="l34.3311" class="difflineplus">+  } else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN) {</span>
<a href="#l34.3312"></a><span id="l34.3312">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;LOGIN password&quot;)));</span>
<a href="#l34.3313"></a><span id="l34.3313" class="difflineminus">-    char *base64Str = PL_Base64Encode(passwordUTF8.get(),</span>
<a href="#l34.3314"></a><span id="l34.3314" class="difflineminus">-                                      passwordUTF8.Length(), nullptr);</span>
<a href="#l34.3315"></a><span id="l34.3315" class="difflineplus">+    char *base64Str =</span>
<a href="#l34.3316"></a><span id="l34.3316" class="difflineplus">+        PL_Base64Encode(passwordUTF8.get(), passwordUTF8.Length(), nullptr);</span>
<a href="#l34.3317"></a><span id="l34.3317">     cmd.Adopt(base64Str);</span>
<a href="#l34.3318"></a><span id="l34.3318" class="difflineminus">-  }</span>
<a href="#l34.3319"></a><span id="l34.3319" class="difflineminus">-  else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l34.3320"></a><span id="l34.3320" class="difflineminus">-  {</span>
<a href="#l34.3321"></a><span id="l34.3321" class="difflineplus">+  } else if (m_currentAuthMethod == POP3_HAS_AUTH_USER) {</span>
<a href="#l34.3322"></a><span id="l34.3322">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;PASS password&quot;)));</span>
<a href="#l34.3323"></a><span id="l34.3323">     cmd = &quot;PASS &quot;;</span>
<a href="#l34.3324"></a><span id="l34.3324" class="difflineminus">-    bool useLatin1 =</span>
<a href="#l34.3325"></a><span id="l34.3325" class="difflineminus">-      mozilla::Preferences::GetBool(&quot;mail.smtp_login_pop3_user_pass_auth_is_latin1&quot;, true);</span>
<a href="#l34.3326"></a><span id="l34.3326" class="difflineplus">+    bool useLatin1 = mozilla::Preferences::GetBool(</span>
<a href="#l34.3327"></a><span id="l34.3327" class="difflineplus">+        &quot;mail.smtp_login_pop3_user_pass_auth_is_latin1&quot;, true);</span>
<a href="#l34.3328"></a><span id="l34.3328">     if (useLatin1)</span>
<a href="#l34.3329"></a><span id="l34.3329">       cmd += NS_LossyConvertUTF16toASCII(m_passwordResult);</span>
<a href="#l34.3330"></a><span id="l34.3330">     else</span>
<a href="#l34.3331"></a><span id="l34.3331">       cmd += passwordUTF8;</span>
<a href="#l34.3332"></a><span id="l34.3332" class="difflineminus">-  }</span>
<a href="#l34.3333"></a><span id="l34.3333" class="difflineminus">-  else</span>
<a href="#l34.3334"></a><span id="l34.3334" class="difflineminus">-  {</span>
<a href="#l34.3335"></a><span id="l34.3335" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.3336"></a><span id="l34.3336" class="difflineminus">-            (POP3LOG(&quot;In nsPop3Protocol::SendPassword(), m_currentAuthMethod is %X, &quot;</span>
<a href="#l34.3337"></a><span id="l34.3337" class="difflineminus">-                     &quot;but that is unexpected&quot;), m_currentAuthMethod));</span>
<a href="#l34.3338"></a><span id="l34.3338" class="difflineplus">+  } else {</span>
<a href="#l34.3339"></a><span id="l34.3339" class="difflineplus">+    MOZ_LOG(</span>
<a href="#l34.3340"></a><span id="l34.3340" class="difflineplus">+        POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l34.3341"></a><span id="l34.3341" class="difflineplus">+        (POP3LOG(</span>
<a href="#l34.3342"></a><span id="l34.3342" class="difflineplus">+             &quot;In nsPop3Protocol::SendPassword(), m_currentAuthMethod is %X, &quot;</span>
<a href="#l34.3343"></a><span id="l34.3343" class="difflineplus">+             &quot;but that is unexpected&quot;),</span>
<a href="#l34.3344"></a><span id="l34.3344" class="difflineplus">+         m_currentAuthMethod));</span>
<a href="#l34.3345"></a><span id="l34.3345">     return Error(&quot;pop3AuthInternalError&quot;);</span>
<a href="#l34.3346"></a><span id="l34.3346">   }</span>
<a href="#l34.3347"></a><span id="l34.3347"> </span>
<a href="#l34.3348"></a><span id="l34.3348">   cmd += CRLF;</span>
<a href="#l34.3349"></a><span id="l34.3349"> </span>
<a href="#l34.3350"></a><span id="l34.3350">   // TODO needed?</span>
<a href="#l34.3351"></a><span id="l34.3351" class="difflineminus">-  //m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3352"></a><span id="l34.3352" class="difflineplus">+  // m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3353"></a><span id="l34.3353"> </span>
<a href="#l34.3354"></a><span id="l34.3354">   m_pop3ConData-&gt;next_state_after_response = POP3_NEXT_AUTH_STEP;</span>
<a href="#l34.3355"></a><span id="l34.3355"> </span>
<a href="#l34.3356"></a><span id="l34.3356">   m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3357"></a><span id="l34.3357"> </span>
<a href="#l34.3358"></a><span id="l34.3358">   m_password_already_sent = true;</span>
<a href="#l34.3359"></a><span id="l34.3359">   m_lastPasswordSent = m_passwordResult;</span>
<a href="#l34.3360"></a><span id="l34.3360">   return Pop3SendData(cmd.get(), true);</span>
<a href="#l34.3361"></a><span id="l34.3361"> }</span>
<a href="#l34.3362"></a><span id="l34.3362"> </span>
<a href="#l34.3363"></a><span id="l34.3363" class="difflineminus">-int32_t nsPop3Protocol::SendStatOrGurl(bool sendStat)</span>
<a href="#l34.3364"></a><span id="l34.3364" class="difflineminus">-{</span>
<a href="#l34.3365"></a><span id="l34.3365" class="difflineplus">+int32_t nsPop3Protocol::SendStatOrGurl(bool sendStat) {</span>
<a href="#l34.3366"></a><span id="l34.3366">   nsAutoCString cmd;</span>
<a href="#l34.3367"></a><span id="l34.3367" class="difflineminus">-  if (sendStat)</span>
<a href="#l34.3368"></a><span id="l34.3368" class="difflineminus">-  {</span>
<a href="#l34.3369"></a><span id="l34.3369" class="difflineminus">-    cmd  = &quot;STAT&quot; CRLF;</span>
<a href="#l34.3370"></a><span id="l34.3370" class="difflineplus">+  if (sendStat) {</span>
<a href="#l34.3371"></a><span id="l34.3371" class="difflineplus">+    cmd = &quot;STAT&quot; CRLF;</span>
<a href="#l34.3372"></a><span id="l34.3372">     m_pop3ConData-&gt;next_state_after_response = POP3_GET_STAT;</span>
<a href="#l34.3373"></a><span id="l34.3373" class="difflineminus">-  }</span>
<a href="#l34.3374"></a><span id="l34.3374" class="difflineminus">-  else</span>
<a href="#l34.3375"></a><span id="l34.3375" class="difflineminus">-  {</span>
<a href="#l34.3376"></a><span id="l34.3376" class="difflineplus">+  } else {</span>
<a href="#l34.3377"></a><span id="l34.3377">     cmd = &quot;GURL&quot; CRLF;</span>
<a href="#l34.3378"></a><span id="l34.3378">     m_pop3ConData-&gt;next_state_after_response = POP3_GURL_RESPONSE;</span>
<a href="#l34.3379"></a><span id="l34.3379">   }</span>
<a href="#l34.3380"></a><span id="l34.3380">   return Pop3SendData(cmd.get());</span>
<a href="#l34.3381"></a><span id="l34.3381"> }</span>
<a href="#l34.3382"></a><span id="l34.3382"> </span>
<a href="#l34.3383"></a><span id="l34.3383" class="difflineminus">-</span>
<a href="#l34.3384"></a><span id="l34.3384" class="difflineminus">-int32_t</span>
<a href="#l34.3385"></a><span id="l34.3385" class="difflineminus">-nsPop3Protocol::SendStat()</span>
<a href="#l34.3386"></a><span id="l34.3386" class="difflineminus">-{</span>
<a href="#l34.3387"></a><span id="l34.3387" class="difflineminus">-  return SendStatOrGurl(true);</span>
<a href="#l34.3388"></a><span id="l34.3388" class="difflineminus">-}</span>
<a href="#l34.3389"></a><span id="l34.3389" class="difflineminus">-</span>
<a href="#l34.3390"></a><span id="l34.3390" class="difflineminus">-</span>
<a href="#l34.3391"></a><span id="l34.3391" class="difflineminus">-int32_t</span>
<a href="#l34.3392"></a><span id="l34.3392" class="difflineminus">-nsPop3Protocol::GetStat()</span>
<a href="#l34.3393"></a><span id="l34.3393" class="difflineminus">-{</span>
<a href="#l34.3394"></a><span id="l34.3394" class="difflineplus">+int32_t nsPop3Protocol::SendStat() { return SendStatOrGurl(true); }</span>
<a href="#l34.3395"></a><span id="l34.3395" class="difflineplus">+</span>
<a href="#l34.3396"></a><span id="l34.3396" class="difflineplus">+int32_t nsPop3Protocol::GetStat() {</span>
<a href="#l34.3397"></a><span id="l34.3397">   // check stat response</span>
<a href="#l34.3398"></a><span id="l34.3398" class="difflineminus">-  if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.3399"></a><span id="l34.3399" class="difflineminus">-    return Error(&quot;pop3StatFail&quot;);</span>
<a href="#l34.3400"></a><span id="l34.3400" class="difflineminus">-</span>
<a href="#l34.3401"></a><span id="l34.3401" class="difflineminus">-    /* stat response looks like:  %d %d</span>
<a href="#l34.3402"></a><span id="l34.3402" class="difflineminus">-     * The first number is the number of articles</span>
<a href="#l34.3403"></a><span id="l34.3403" class="difflineminus">-     * The second number is the number of bytes</span>
<a href="#l34.3404"></a><span id="l34.3404" class="difflineminus">-     *</span>
<a href="#l34.3405"></a><span id="l34.3405" class="difflineminus">-     *  grab the first and second arg of stat response</span>
<a href="#l34.3406"></a><span id="l34.3406" class="difflineminus">-     */</span>
<a href="#l34.3407"></a><span id="l34.3407" class="difflineminus">-  nsCString oldStr (m_commandResponse);</span>
<a href="#l34.3408"></a><span id="l34.3408" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3StatFail&quot;);</span>
<a href="#l34.3409"></a><span id="l34.3409" class="difflineplus">+</span>
<a href="#l34.3410"></a><span id="l34.3410" class="difflineplus">+  /* stat response looks like:  %d %d</span>
<a href="#l34.3411"></a><span id="l34.3411" class="difflineplus">+   * The first number is the number of articles</span>
<a href="#l34.3412"></a><span id="l34.3412" class="difflineplus">+   * The second number is the number of bytes</span>
<a href="#l34.3413"></a><span id="l34.3413" class="difflineplus">+   *</span>
<a href="#l34.3414"></a><span id="l34.3414" class="difflineplus">+   *  grab the first and second arg of stat response</span>
<a href="#l34.3415"></a><span id="l34.3415" class="difflineplus">+   */</span>
<a href="#l34.3416"></a><span id="l34.3416" class="difflineplus">+  nsCString oldStr(m_commandResponse);</span>
<a href="#l34.3417"></a><span id="l34.3417">   char *newStr = oldStr.BeginWriting();</span>
<a href="#l34.3418"></a><span id="l34.3418">   char *num = NS_strtok(&quot; &quot;, &amp;newStr);  // msg num</span>
<a href="#l34.3419"></a><span id="l34.3419" class="difflineminus">-  if (num)</span>
<a href="#l34.3420"></a><span id="l34.3420" class="difflineminus">-  {</span>
<a href="#l34.3421"></a><span id="l34.3421" class="difflineplus">+  if (num) {</span>
<a href="#l34.3422"></a><span id="l34.3422">     m_pop3ConData-&gt;number_of_messages = atol(num);  // bytes</span>
<a href="#l34.3423"></a><span id="l34.3423">     num = NS_strtok(&quot; &quot;, &amp;newStr);</span>
<a href="#l34.3424"></a><span id="l34.3424">     m_commandResponse = newStr;</span>
<a href="#l34.3425"></a><span id="l34.3425">     if (num)</span>
<a href="#l34.3426"></a><span id="l34.3426" class="difflineminus">-      m_totalFolderSize = nsCRT::atoll(num);  //we always initialize m_totalFolderSize to 0</span>
<a href="#l34.3427"></a><span id="l34.3427" class="difflineminus">-  }</span>
<a href="#l34.3428"></a><span id="l34.3428" class="difflineminus">-  else</span>
<a href="#l34.3429"></a><span id="l34.3429" class="difflineplus">+      m_totalFolderSize =</span>
<a href="#l34.3430"></a><span id="l34.3430" class="difflineplus">+          nsCRT::atoll(num);  // we always initialize m_totalFolderSize to 0</span>
<a href="#l34.3431"></a><span id="l34.3431" class="difflineplus">+  } else</span>
<a href="#l34.3432"></a><span id="l34.3432">     m_pop3ConData-&gt;number_of_messages = 0;</span>
<a href="#l34.3433"></a><span id="l34.3433"> </span>
<a href="#l34.3434"></a><span id="l34.3434">   m_pop3ConData-&gt;really_new_messages = 0;</span>
<a href="#l34.3435"></a><span id="l34.3435">   m_pop3ConData-&gt;real_new_counter = 1;</span>
<a href="#l34.3436"></a><span id="l34.3436"> </span>
<a href="#l34.3437"></a><span id="l34.3437" class="difflineminus">-  m_totalDownloadSize = -1; // Means we need to calculate it, later.</span>
<a href="#l34.3438"></a><span id="l34.3438" class="difflineminus">-</span>
<a href="#l34.3439"></a><span id="l34.3439" class="difflineminus">-  if (m_pop3ConData-&gt;number_of_messages &lt;= 0)</span>
<a href="#l34.3440"></a><span id="l34.3440" class="difflineminus">-  {</span>
<a href="#l34.3441"></a><span id="l34.3441" class="difflineplus">+  m_totalDownloadSize = -1;  // Means we need to calculate it, later.</span>
<a href="#l34.3442"></a><span id="l34.3442" class="difflineplus">+</span>
<a href="#l34.3443"></a><span id="l34.3443" class="difflineplus">+  if (m_pop3ConData-&gt;number_of_messages &lt;= 0) {</span>
<a href="#l34.3444"></a><span id="l34.3444">     // We're all done. We know we have no mail.</span>
<a href="#l34.3445"></a><span id="l34.3445">     m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.3446"></a><span id="l34.3446" class="difflineminus">-    PL_HashTableEnumerateEntries(m_pop3ConData-&gt;uidlinfo-&gt;hash, hash_clear_mapper, nullptr);</span>
<a href="#l34.3447"></a><span id="l34.3447" class="difflineplus">+    PL_HashTableEnumerateEntries(m_pop3ConData-&gt;uidlinfo-&gt;hash,</span>
<a href="#l34.3448"></a><span id="l34.3448" class="difflineplus">+                                 hash_clear_mapper, nullptr);</span>
<a href="#l34.3449"></a><span id="l34.3449">     // Hack - use nsPop3Sink to wipe out any stale Partial messages</span>
<a href="#l34.3450"></a><span id="l34.3450">     m_nsIPop3Sink-&gt;BeginMailDelivery(false, nullptr, nullptr);</span>
<a href="#l34.3451"></a><span id="l34.3451">     m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.3452"></a><span id="l34.3452" class="difflineminus">-    return(0);</span>
<a href="#l34.3453"></a><span id="l34.3453" class="difflineplus">+    return (0);</span>
<a href="#l34.3454"></a><span id="l34.3454">   }</span>
<a href="#l34.3455"></a><span id="l34.3455"> </span>
<a href="#l34.3456"></a><span id="l34.3456">   /* We're just checking for new mail, and we're not playing any games that</span>
<a href="#l34.3457"></a><span id="l34.3457">      involve keeping messages on the server.  Therefore, we now know enough</span>
<a href="#l34.3458"></a><span id="l34.3458">      to finish up.  If we had no messages, that would have been handled</span>
<a href="#l34.3459"></a><span id="l34.3459">      above; therefore, we know we have some new messages.</span>
<a href="#l34.3460"></a><span id="l34.3460">   */</span>
<a href="#l34.3461"></a><span id="l34.3461" class="difflineminus">-  if (m_pop3ConData-&gt;only_check_for_new_mail &amp;&amp; !m_pop3ConData-&gt;leave_on_server)</span>
<a href="#l34.3462"></a><span id="l34.3462" class="difflineminus">-  {</span>
<a href="#l34.3463"></a><span id="l34.3463" class="difflineplus">+  if (m_pop3ConData-&gt;only_check_for_new_mail &amp;&amp;</span>
<a href="#l34.3464"></a><span id="l34.3464" class="difflineplus">+      !m_pop3ConData-&gt;leave_on_server) {</span>
<a href="#l34.3465"></a><span id="l34.3465">     m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(nsIMsgFolder::nsMsgBiffState_NewMail,</span>
<a href="#l34.3466"></a><span id="l34.3466">                                            m_pop3ConData-&gt;number_of_messages,</span>
<a href="#l34.3467"></a><span id="l34.3467">                                            true);</span>
<a href="#l34.3468"></a><span id="l34.3468">     m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.3469"></a><span id="l34.3469" class="difflineminus">-    return(0);</span>
<a href="#l34.3470"></a><span id="l34.3470" class="difflineplus">+    return (0);</span>
<a href="#l34.3471"></a><span id="l34.3471">   }</span>
<a href="#l34.3472"></a><span id="l34.3472"> </span>
<a href="#l34.3473"></a><span id="l34.3473" class="difflineminus">-</span>
<a href="#l34.3474"></a><span id="l34.3474" class="difflineminus">-  if (!m_pop3ConData-&gt;only_check_for_new_mail)</span>
<a href="#l34.3475"></a><span id="l34.3475" class="difflineminus">-  {</span>
<a href="#l34.3476"></a><span id="l34.3476" class="difflineminus">-      /* The following was added to prevent the loss of Data when we try and</span>
<a href="#l34.3477"></a><span id="l34.3477" class="difflineminus">-         write to somewhere we don't have write access error to (See bug 62480)</span>
<a href="#l34.3478"></a><span id="l34.3478" class="difflineminus">-         (Note: This is only a temp hack until the underlying XPCOM is fixed</span>
<a href="#l34.3479"></a><span id="l34.3479" class="difflineminus">-         to return errors) */</span>
<a href="#l34.3480"></a><span id="l34.3480" class="difflineminus">-</span>
<a href="#l34.3481"></a><span id="l34.3481" class="difflineminus">-      nsresult rv;</span>
<a href="#l34.3482"></a><span id="l34.3482" class="difflineminus">-      nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.3483"></a><span id="l34.3483" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l34.3484"></a><span id="l34.3484" class="difflineminus">-      if (mailnewsUrl)</span>
<a href="#l34.3485"></a><span id="l34.3485" class="difflineminus">-        rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.3486"></a><span id="l34.3486" class="difflineminus">-//      NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; msgWindow, &quot;no msg window&quot;);</span>
<a href="#l34.3487"></a><span id="l34.3487" class="difflineminus">-</span>
<a href="#l34.3488"></a><span id="l34.3488" class="difflineminus">-      rv = m_nsIPop3Sink-&gt;BeginMailDelivery(m_pop3ConData-&gt;only_uidl != nullptr, msgWindow,</span>
<a href="#l34.3489"></a><span id="l34.3489" class="difflineminus">-                                                    &amp;m_pop3ConData-&gt;msg_del_started);</span>
<a href="#l34.3490"></a><span id="l34.3490" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l34.3491"></a><span id="l34.3491" class="difflineminus">-      {</span>
<a href="#l34.3492"></a><span id="l34.3492" class="difflineminus">-        m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.3493"></a><span id="l34.3493" class="difflineminus">-        if (rv == NS_MSG_FOLDER_BUSY) {</span>
<a href="#l34.3494"></a><span id="l34.3494" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.3495"></a><span id="l34.3495" class="difflineminus">-          nsString accountName;</span>
<a href="#l34.3496"></a><span id="l34.3496" class="difflineminus">-          rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l34.3497"></a><span id="l34.3497" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.3498"></a><span id="l34.3498" class="difflineminus">-</span>
<a href="#l34.3499"></a><span id="l34.3499" class="difflineminus">-          const char16_t *params[] = { accountName.get() };</span>
<a href="#l34.3500"></a><span id="l34.3500" class="difflineminus">-          return Error(&quot;pop3ServerBusy&quot;, params, 1);</span>
<a href="#l34.3501"></a><span id="l34.3501" class="difflineminus">-        }</span>
<a href="#l34.3502"></a><span id="l34.3502" class="difflineminus">-</span>
<a href="#l34.3503"></a><span id="l34.3503" class="difflineminus">-        return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.3504"></a><span id="l34.3504" class="difflineplus">+  if (!m_pop3ConData-&gt;only_check_for_new_mail) {</span>
<a href="#l34.3505"></a><span id="l34.3505" class="difflineplus">+    /* The following was added to prevent the loss of Data when we try and</span>
<a href="#l34.3506"></a><span id="l34.3506" class="difflineplus">+       write to somewhere we don't have write access error to (See bug 62480)</span>
<a href="#l34.3507"></a><span id="l34.3507" class="difflineplus">+       (Note: This is only a temp hack until the underlying XPCOM is fixed</span>
<a href="#l34.3508"></a><span id="l34.3508" class="difflineplus">+       to return errors) */</span>
<a href="#l34.3509"></a><span id="l34.3509" class="difflineplus">+</span>
<a href="#l34.3510"></a><span id="l34.3510" class="difflineplus">+    nsresult rv;</span>
<a href="#l34.3511"></a><span id="l34.3511" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.3512"></a><span id="l34.3512" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url);</span>
<a href="#l34.3513"></a><span id="l34.3513" class="difflineplus">+    if (mailnewsUrl) rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.3514"></a><span id="l34.3514" class="difflineplus">+    //      NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; msgWindow, &quot;no msg window&quot;);</span>
<a href="#l34.3515"></a><span id="l34.3515" class="difflineplus">+</span>
<a href="#l34.3516"></a><span id="l34.3516" class="difflineplus">+    rv = m_nsIPop3Sink-&gt;BeginMailDelivery(m_pop3ConData-&gt;only_uidl != nullptr,</span>
<a href="#l34.3517"></a><span id="l34.3517" class="difflineplus">+                                          msgWindow,</span>
<a href="#l34.3518"></a><span id="l34.3518" class="difflineplus">+                                          &amp;m_pop3ConData-&gt;msg_del_started);</span>
<a href="#l34.3519"></a><span id="l34.3519" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l34.3520"></a><span id="l34.3520" class="difflineplus">+      m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.3521"></a><span id="l34.3521" class="difflineplus">+      if (rv == NS_MSG_FOLDER_BUSY) {</span>
<a href="#l34.3522"></a><span id="l34.3522" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.3523"></a><span id="l34.3523" class="difflineplus">+        nsString accountName;</span>
<a href="#l34.3524"></a><span id="l34.3524" class="difflineplus">+        rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l34.3525"></a><span id="l34.3525" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.3526"></a><span id="l34.3526" class="difflineplus">+</span>
<a href="#l34.3527"></a><span id="l34.3527" class="difflineplus">+        const char16_t *params[] = {accountName.get()};</span>
<a href="#l34.3528"></a><span id="l34.3528" class="difflineplus">+        return Error(&quot;pop3ServerBusy&quot;, params, 1);</span>
<a href="#l34.3529"></a><span id="l34.3529">       }</span>
<a href="#l34.3530"></a><span id="l34.3530"> </span>
<a href="#l34.3531"></a><span id="l34.3531" class="difflineminus">-      if(!m_pop3ConData-&gt;msg_del_started)</span>
<a href="#l34.3532"></a><span id="l34.3532" class="difflineminus">-        return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.3533"></a><span id="l34.3533" class="difflineplus">+      return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.3534"></a><span id="l34.3534" class="difflineplus">+    }</span>
<a href="#l34.3535"></a><span id="l34.3535" class="difflineplus">+</span>
<a href="#l34.3536"></a><span id="l34.3536" class="difflineplus">+    if (!m_pop3ConData-&gt;msg_del_started) return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.3537"></a><span id="l34.3537">   }</span>
<a href="#l34.3538"></a><span id="l34.3538"> </span>
<a href="#l34.3539"></a><span id="l34.3539">   m_pop3ConData-&gt;next_state = POP3_SEND_LIST;</span>
<a href="#l34.3540"></a><span id="l34.3540">   return 0;</span>
<a href="#l34.3541"></a><span id="l34.3541"> }</span>
<a href="#l34.3542"></a><span id="l34.3542"> </span>
<a href="#l34.3543"></a><span id="l34.3543" class="difflineminus">-</span>
<a href="#l34.3544"></a><span id="l34.3544" class="difflineminus">-</span>
<a href="#l34.3545"></a><span id="l34.3545" class="difflineminus">-int32_t</span>
<a href="#l34.3546"></a><span id="l34.3546" class="difflineminus">-nsPop3Protocol::SendGurl()</span>
<a href="#l34.3547"></a><span id="l34.3547" class="difflineminus">-{</span>
<a href="#l34.3548"></a><span id="l34.3548" class="difflineminus">-    if (m_pop3ConData-&gt;capability_flags == POP3_CAPABILITY_UNDEFINED ||</span>
<a href="#l34.3549"></a><span id="l34.3549" class="difflineminus">-        TestCapFlag(POP3_GURL_UNDEFINED | POP3_HAS_GURL))</span>
<a href="#l34.3550"></a><span id="l34.3550" class="difflineminus">-        return SendStatOrGurl(false);</span>
<a href="#l34.3551"></a><span id="l34.3551" class="difflineminus">-    else</span>
<a href="#l34.3552"></a><span id="l34.3552" class="difflineminus">-        return -1;</span>
<a href="#l34.3553"></a><span id="l34.3553" class="difflineplus">+int32_t nsPop3Protocol::SendGurl() {</span>
<a href="#l34.3554"></a><span id="l34.3554" class="difflineplus">+  if (m_pop3ConData-&gt;capability_flags == POP3_CAPABILITY_UNDEFINED ||</span>
<a href="#l34.3555"></a><span id="l34.3555" class="difflineplus">+      TestCapFlag(POP3_GURL_UNDEFINED | POP3_HAS_GURL))</span>
<a href="#l34.3556"></a><span id="l34.3556" class="difflineplus">+    return SendStatOrGurl(false);</span>
<a href="#l34.3557"></a><span id="l34.3557" class="difflineplus">+  else</span>
<a href="#l34.3558"></a><span id="l34.3558" class="difflineplus">+    return -1;</span>
<a href="#l34.3559"></a><span id="l34.3559"> }</span>
<a href="#l34.3560"></a><span id="l34.3560"> </span>
<a href="#l34.3561"></a><span id="l34.3561" class="difflineminus">-</span>
<a href="#l34.3562"></a><span id="l34.3562" class="difflineminus">-int32_t</span>
<a href="#l34.3563"></a><span id="l34.3563" class="difflineminus">-nsPop3Protocol::GurlResponse()</span>
<a href="#l34.3564"></a><span id="l34.3564" class="difflineminus">-{</span>
<a href="#l34.3565"></a><span id="l34.3565" class="difflineminus">-    ClearCapFlag(POP3_GURL_UNDEFINED);</span>
<a href="#l34.3566"></a><span id="l34.3566" class="difflineminus">-</span>
<a href="#l34.3567"></a><span id="l34.3567" class="difflineminus">-    if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.3568"></a><span id="l34.3568" class="difflineminus">-    {</span>
<a href="#l34.3569"></a><span id="l34.3569" class="difflineminus">-        SetCapFlag(POP3_HAS_GURL);</span>
<a href="#l34.3570"></a><span id="l34.3570" class="difflineminus">-        if (m_nsIPop3Sink)</span>
<a href="#l34.3571"></a><span id="l34.3571" class="difflineminus">-            m_nsIPop3Sink-&gt;SetMailAccountURL(m_commandResponse);</span>
<a href="#l34.3572"></a><span id="l34.3572" class="difflineminus">-    }</span>
<a href="#l34.3573"></a><span id="l34.3573" class="difflineminus">-    else</span>
<a href="#l34.3574"></a><span id="l34.3574" class="difflineminus">-    {</span>
<a href="#l34.3575"></a><span id="l34.3575" class="difflineminus">-        ClearCapFlag(POP3_HAS_GURL);</span>
<a href="#l34.3576"></a><span id="l34.3576" class="difflineminus">-    }</span>
<a href="#l34.3577"></a><span id="l34.3577" class="difflineminus">-    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3578"></a><span id="l34.3578" class="difflineminus">-    m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.3579"></a><span id="l34.3579" class="difflineminus">-</span>
<a href="#l34.3580"></a><span id="l34.3580" class="difflineminus">-    return 0;</span>
<a href="#l34.3581"></a><span id="l34.3581" class="difflineplus">+int32_t nsPop3Protocol::GurlResponse() {</span>
<a href="#l34.3582"></a><span id="l34.3582" class="difflineplus">+  ClearCapFlag(POP3_GURL_UNDEFINED);</span>
<a href="#l34.3583"></a><span id="l34.3583" class="difflineplus">+</span>
<a href="#l34.3584"></a><span id="l34.3584" class="difflineplus">+  if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.3585"></a><span id="l34.3585" class="difflineplus">+    SetCapFlag(POP3_HAS_GURL);</span>
<a href="#l34.3586"></a><span id="l34.3586" class="difflineplus">+    if (m_nsIPop3Sink) m_nsIPop3Sink-&gt;SetMailAccountURL(m_commandResponse);</span>
<a href="#l34.3587"></a><span id="l34.3587" class="difflineplus">+  } else {</span>
<a href="#l34.3588"></a><span id="l34.3588" class="difflineplus">+    ClearCapFlag(POP3_HAS_GURL);</span>
<a href="#l34.3589"></a><span id="l34.3589" class="difflineplus">+  }</span>
<a href="#l34.3590"></a><span id="l34.3590" class="difflineplus">+  m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3591"></a><span id="l34.3591" class="difflineplus">+  m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.3592"></a><span id="l34.3592" class="difflineplus">+</span>
<a href="#l34.3593"></a><span id="l34.3593" class="difflineplus">+  return 0;</span>
<a href="#l34.3594"></a><span id="l34.3594"> }</span>
<a href="#l34.3595"></a><span id="l34.3595"> </span>
<a href="#l34.3596"></a><span id="l34.3596" class="difflineminus">-int32_t nsPop3Protocol::SendList()</span>
<a href="#l34.3597"></a><span id="l34.3597" class="difflineminus">-{</span>
<a href="#l34.3598"></a><span id="l34.3598" class="difflineminus">-    // check for server returning number of messages that will cause the calculation</span>
<a href="#l34.3599"></a><span id="l34.3599" class="difflineminus">-    // of the size of the block for msg_info to</span>
<a href="#l34.3600"></a><span id="l34.3600" class="difflineminus">-    // overflow a 32 bit int, in turn causing us to allocate a block of memory much</span>
<a href="#l34.3601"></a><span id="l34.3601" class="difflineminus">-    // smaller than we think we're allocating, and</span>
<a href="#l34.3602"></a><span id="l34.3602" class="difflineminus">-    // potentially allowing the server to make us overwrite memory outside our heap</span>
<a href="#l34.3603"></a><span id="l34.3603" class="difflineminus">-    // block.</span>
<a href="#l34.3604"></a><span id="l34.3604" class="difflineminus">-</span>
<a href="#l34.3605"></a><span id="l34.3605" class="difflineminus">-    if (m_pop3ConData-&gt;number_of_messages &gt; (int) (0xFFFFF000 / sizeof(Pop3MsgInfo)))</span>
<a href="#l34.3606"></a><span id="l34.3606" class="difflineminus">-        return MK_OUT_OF_MEMORY;</span>
<a href="#l34.3607"></a><span id="l34.3607" class="difflineminus">-</span>
<a href="#l34.3608"></a><span id="l34.3608" class="difflineminus">-</span>
<a href="#l34.3609"></a><span id="l34.3609" class="difflineminus">-    m_pop3ConData-&gt;msg_info = (Pop3MsgInfo *)</span>
<a href="#l34.3610"></a><span id="l34.3610" class="difflineminus">-      PR_CALLOC(sizeof(Pop3MsgInfo) * m_pop3ConData-&gt;number_of_messages);</span>
<a href="#l34.3611"></a><span id="l34.3611" class="difflineminus">-    if (!m_pop3ConData-&gt;msg_info)</span>
<a href="#l34.3612"></a><span id="l34.3612" class="difflineminus">-        return(MK_OUT_OF_MEMORY);</span>
<a href="#l34.3613"></a><span id="l34.3613" class="difflineminus">-    m_pop3ConData-&gt;next_state_after_response = POP3_GET_LIST;</span>
<a href="#l34.3614"></a><span id="l34.3614" class="difflineminus">-    m_listpos = 0;</span>
<a href="#l34.3615"></a><span id="l34.3615" class="difflineminus">-    return Pop3SendData(&quot;LIST&quot; CRLF);</span>
<a href="#l34.3616"></a><span id="l34.3616" class="difflineplus">+int32_t nsPop3Protocol::SendList() {</span>
<a href="#l34.3617"></a><span id="l34.3617" class="difflineplus">+  // check for server returning number of messages that will cause the</span>
<a href="#l34.3618"></a><span id="l34.3618" class="difflineplus">+  // calculation of the size of the block for msg_info to overflow a 32 bit int,</span>
<a href="#l34.3619"></a><span id="l34.3619" class="difflineplus">+  // in turn causing us to allocate a block of memory much smaller than we think</span>
<a href="#l34.3620"></a><span id="l34.3620" class="difflineplus">+  // we're allocating, and potentially allowing the server to make us overwrite</span>
<a href="#l34.3621"></a><span id="l34.3621" class="difflineplus">+  // memory outside our heap block.</span>
<a href="#l34.3622"></a><span id="l34.3622" class="difflineplus">+</span>
<a href="#l34.3623"></a><span id="l34.3623" class="difflineplus">+  if (m_pop3ConData-&gt;number_of_messages &gt;</span>
<a href="#l34.3624"></a><span id="l34.3624" class="difflineplus">+      (int)(0xFFFFF000 / sizeof(Pop3MsgInfo)))</span>
<a href="#l34.3625"></a><span id="l34.3625" class="difflineplus">+    return MK_OUT_OF_MEMORY;</span>
<a href="#l34.3626"></a><span id="l34.3626" class="difflineplus">+</span>
<a href="#l34.3627"></a><span id="l34.3627" class="difflineplus">+  m_pop3ConData-&gt;msg_info = (Pop3MsgInfo *)PR_CALLOC(</span>
<a href="#l34.3628"></a><span id="l34.3628" class="difflineplus">+      sizeof(Pop3MsgInfo) * m_pop3ConData-&gt;number_of_messages);</span>
<a href="#l34.3629"></a><span id="l34.3629" class="difflineplus">+  if (!m_pop3ConData-&gt;msg_info) return (MK_OUT_OF_MEMORY);</span>
<a href="#l34.3630"></a><span id="l34.3630" class="difflineplus">+  m_pop3ConData-&gt;next_state_after_response = POP3_GET_LIST;</span>
<a href="#l34.3631"></a><span id="l34.3631" class="difflineplus">+  m_listpos = 0;</span>
<a href="#l34.3632"></a><span id="l34.3632" class="difflineplus">+  return Pop3SendData(&quot;LIST&quot; CRLF);</span>
<a href="#l34.3633"></a><span id="l34.3633"> }</span>
<a href="#l34.3634"></a><span id="l34.3634"> </span>
<a href="#l34.3635"></a><span id="l34.3635" class="difflineminus">-</span>
<a href="#l34.3636"></a><span id="l34.3636" class="difflineminus">-</span>
<a href="#l34.3637"></a><span id="l34.3637" class="difflineminus">-int32_t</span>
<a href="#l34.3638"></a><span id="l34.3638" class="difflineminus">-nsPop3Protocol::GetList(nsIInputStream* inputStream,</span>
<a href="#l34.3639"></a><span id="l34.3639" class="difflineminus">-                        uint32_t length)</span>
<a href="#l34.3640"></a><span id="l34.3640" class="difflineminus">-{</span>
<a href="#l34.3641"></a><span id="l34.3641" class="difflineplus">+int32_t nsPop3Protocol::GetList(nsIInputStream *inputStream, uint32_t length) {</span>
<a href="#l34.3642"></a><span id="l34.3642">   /* check list response</span>
<a href="#l34.3643"></a><span id="l34.3643" class="difflineminus">-  * This will get called multiple times</span>
<a href="#l34.3644"></a><span id="l34.3644" class="difflineminus">-  * but it's alright since command_succeeded</span>
<a href="#l34.3645"></a><span id="l34.3645" class="difflineminus">-  * will remain constant</span>
<a href="#l34.3646"></a><span id="l34.3646" class="difflineminus">-  */</span>
<a href="#l34.3647"></a><span id="l34.3647" class="difflineminus">-  if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.3648"></a><span id="l34.3648" class="difflineminus">-    return Error(&quot;pop3ListFailure&quot;);</span>
<a href="#l34.3649"></a><span id="l34.3649" class="difflineplus">+   * This will get called multiple times</span>
<a href="#l34.3650"></a><span id="l34.3650" class="difflineplus">+   * but it's alright since command_succeeded</span>
<a href="#l34.3651"></a><span id="l34.3651" class="difflineplus">+   * will remain constant</span>
<a href="#l34.3652"></a><span id="l34.3652" class="difflineplus">+   */</span>
<a href="#l34.3653"></a><span id="l34.3653" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3ListFailure&quot;);</span>
<a href="#l34.3654"></a><span id="l34.3654"> </span>
<a href="#l34.3655"></a><span id="l34.3655">   uint32_t ln = 0;</span>
<a href="#l34.3656"></a><span id="l34.3656">   bool pauseForMoreData = false;</span>
<a href="#l34.3657"></a><span id="l34.3657">   nsresult rv;</span>
<a href="#l34.3658"></a><span id="l34.3658" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.3659"></a><span id="l34.3659" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.3660"></a><span id="l34.3660" class="difflineminus">-    return -1;</span>
<a href="#l34.3661"></a><span id="l34.3661" class="difflineminus">-</span>
<a href="#l34.3662"></a><span id="l34.3662" class="difflineminus">-  if (pauseForMoreData || !line)</span>
<a href="#l34.3663"></a><span id="l34.3663" class="difflineminus">-  {</span>
<a href="#l34.3664"></a><span id="l34.3664" class="difflineplus">+  char *line =</span>
<a href="#l34.3665"></a><span id="l34.3665" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.3666"></a><span id="l34.3666" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.3667"></a><span id="l34.3667" class="difflineplus">+</span>
<a href="#l34.3668"></a><span id="l34.3668" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.3669"></a><span id="l34.3669">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3670"></a><span id="l34.3670">     PR_Free(line);</span>
<a href="#l34.3671"></a><span id="l34.3671" class="difflineminus">-    return(ln);</span>
<a href="#l34.3672"></a><span id="l34.3672" class="difflineplus">+    return (ln);</span>
<a href="#l34.3673"></a><span id="l34.3673">   }</span>
<a href="#l34.3674"></a><span id="l34.3674"> </span>
<a href="#l34.3675"></a><span id="l34.3675">   MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.3676"></a><span id="l34.3676"> </span>
<a href="#l34.3677"></a><span id="l34.3677">   /* parse the line returned from the list command</span>
<a href="#l34.3678"></a><span id="l34.3678" class="difflineminus">-  * it looks like</span>
<a href="#l34.3679"></a><span id="l34.3679" class="difflineminus">-  * #msg_number #bytes</span>
<a href="#l34.3680"></a><span id="l34.3680" class="difflineminus">-  *</span>
<a href="#l34.3681"></a><span id="l34.3681" class="difflineminus">-  * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l34.3682"></a><span id="l34.3682" class="difflineminus">-  */</span>
<a href="#l34.3683"></a><span id="l34.3683" class="difflineminus">-  if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l34.3684"></a><span id="l34.3684" class="difflineminus">-  {</span>
<a href="#l34.3685"></a><span id="l34.3685" class="difflineplus">+   * it looks like</span>
<a href="#l34.3686"></a><span id="l34.3686" class="difflineplus">+   * #msg_number #bytes</span>
<a href="#l34.3687"></a><span id="l34.3687" class="difflineplus">+   *</span>
<a href="#l34.3688"></a><span id="l34.3688" class="difflineplus">+   * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l34.3689"></a><span id="l34.3689" class="difflineplus">+   */</span>
<a href="#l34.3690"></a><span id="l34.3690" class="difflineplus">+  if (!PL_strcmp(line, &quot;.&quot;)) {</span>
<a href="#l34.3691"></a><span id="l34.3691">     // limit the list if fewer entries than given in STAT response</span>
<a href="#l34.3692"></a><span id="l34.3692" class="difflineminus">-    if(m_listpos &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3693"></a><span id="l34.3693" class="difflineplus">+    if (m_listpos &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3694"></a><span id="l34.3694">       m_pop3ConData-&gt;number_of_messages = m_listpos;</span>
<a href="#l34.3695"></a><span id="l34.3695">     m_pop3ConData-&gt;next_state = POP3_SEND_UIDL_LIST;</span>
<a href="#l34.3696"></a><span id="l34.3696">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.3697"></a><span id="l34.3697">     PR_Free(line);</span>
<a href="#l34.3698"></a><span id="l34.3698" class="difflineminus">-    return(0);</span>
<a href="#l34.3699"></a><span id="l34.3699" class="difflineplus">+    return (0);</span>
<a href="#l34.3700"></a><span id="l34.3700">   }</span>
<a href="#l34.3701"></a><span id="l34.3701"> </span>
<a href="#l34.3702"></a><span id="l34.3702">   char *newStr = line;</span>
<a href="#l34.3703"></a><span id="l34.3703">   char *token = NS_strtok(&quot; &quot;, &amp;newStr);</span>
<a href="#l34.3704"></a><span id="l34.3704" class="difflineminus">-  if (token)</span>
<a href="#l34.3705"></a><span id="l34.3705" class="difflineminus">-  {</span>
<a href="#l34.3706"></a><span id="l34.3706" class="difflineplus">+  if (token) {</span>
<a href="#l34.3707"></a><span id="l34.3707">     int32_t msg_num = atol(token);</span>
<a href="#l34.3708"></a><span id="l34.3708"> </span>
<a href="#l34.3709"></a><span id="l34.3709" class="difflineminus">-    if (++m_listpos &lt;= m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3710"></a><span id="l34.3710" class="difflineminus">-    {</span>
<a href="#l34.3711"></a><span id="l34.3711" class="difflineplus">+    if (++m_listpos &lt;= m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.3712"></a><span id="l34.3712">       token = NS_strtok(&quot; &quot;, &amp;newStr);</span>
<a href="#l34.3713"></a><span id="l34.3713" class="difflineminus">-      if (token)</span>
<a href="#l34.3714"></a><span id="l34.3714" class="difflineminus">-      {</span>
<a href="#l34.3715"></a><span id="l34.3715" class="difflineminus">-        m_pop3ConData-&gt;msg_info[m_listpos-1].size = atol(token);</span>
<a href="#l34.3716"></a><span id="l34.3716" class="difflineminus">-        m_pop3ConData-&gt;msg_info[m_listpos-1].msgnum = msg_num;</span>
<a href="#l34.3717"></a><span id="l34.3717" class="difflineplus">+      if (token) {</span>
<a href="#l34.3718"></a><span id="l34.3718" class="difflineplus">+        m_pop3ConData-&gt;msg_info[m_listpos - 1].size = atol(token);</span>
<a href="#l34.3719"></a><span id="l34.3719" class="difflineplus">+        m_pop3ConData-&gt;msg_info[m_listpos - 1].msgnum = msg_num;</span>
<a href="#l34.3720"></a><span id="l34.3720">       }</span>
<a href="#l34.3721"></a><span id="l34.3721">     }</span>
<a href="#l34.3722"></a><span id="l34.3722">   }</span>
<a href="#l34.3723"></a><span id="l34.3723"> </span>
<a href="#l34.3724"></a><span id="l34.3724">   PR_Free(line);</span>
<a href="#l34.3725"></a><span id="l34.3725" class="difflineminus">-  return(0);</span>
<a href="#l34.3726"></a><span id="l34.3726" class="difflineplus">+  return (0);</span>
<a href="#l34.3727"></a><span id="l34.3727"> }</span>
<a href="#l34.3728"></a><span id="l34.3728"> </span>
<a href="#l34.3729"></a><span id="l34.3729" class="difflineminus">-</span>
<a href="#l34.3730"></a><span id="l34.3730"> /* UIDL and XTND are both unsupported for this mail server.</span>
<a href="#l34.3731"></a><span id="l34.3731">    If not enabled any advanced features, we're able to live</span>
<a href="#l34.3732"></a><span id="l34.3732">    without them. We're simply downloading and deleting everything</span>
<a href="#l34.3733"></a><span id="l34.3733">    on the server.</span>
<a href="#l34.3734"></a><span id="l34.3734"> </span>
<a href="#l34.3735"></a><span id="l34.3735">    Advanced features are:</span>
<a href="#l34.3736"></a><span id="l34.3736">    *'Keep Mail on Server' with aging or deletion support</span>
<a href="#l34.3737"></a><span id="l34.3737">    *'Fetch Headers Only'</span>
<a href="#l34.3738"></a><span id="l34.3738" class="difflineat">@@ -2614,39 +2334,34 @@ nsPop3Protocol::GetList(nsIInputStream* </span>
<a href="#l34.3739"></a><span id="l34.3739">    without generating huge traffic and is mostly not supported at all</span>
<a href="#l34.3740"></a><span id="l34.3740">    if the server lacks UIDL and XTND XLST.</span>
<a href="#l34.3741"></a><span id="l34.3741"> </span>
<a href="#l34.3742"></a><span id="l34.3742">    In other cases the user has to join the 20th century.</span>
<a href="#l34.3743"></a><span id="l34.3743">    Tell the user this, and refuse to download any messages until</span>
<a href="#l34.3744"></a><span id="l34.3744">    they've gone into preferences and turned off any of the above</span>
<a href="#l34.3745"></a><span id="l34.3745">    prefs.</span>
<a href="#l34.3746"></a><span id="l34.3746"> */</span>
<a href="#l34.3747"></a><span id="l34.3747" class="difflineminus">-int32_t nsPop3Protocol::HandleNoUidListAvailable()</span>
<a href="#l34.3748"></a><span id="l34.3748" class="difflineminus">-{</span>
<a href="#l34.3749"></a><span id="l34.3749" class="difflineplus">+int32_t nsPop3Protocol::HandleNoUidListAvailable() {</span>
<a href="#l34.3750"></a><span id="l34.3750">   m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.3751"></a><span id="l34.3751"> </span>
<a href="#l34.3752"></a><span id="l34.3752" class="difflineminus">-  if(!m_pop3ConData-&gt;leave_on_server &amp;&amp;</span>
<a href="#l34.3753"></a><span id="l34.3753" class="difflineminus">-     !m_pop3ConData-&gt;headers_only &amp;&amp;</span>
<a href="#l34.3754"></a><span id="l34.3754" class="difflineminus">-     m_pop3ConData-&gt;size_limit &lt;= 0 &amp;&amp;</span>
<a href="#l34.3755"></a><span id="l34.3755" class="difflineminus">-     !m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.3756"></a><span id="l34.3756" class="difflineminus">-  {</span>
<a href="#l34.3757"></a><span id="l34.3757" class="difflineplus">+  if (!m_pop3ConData-&gt;leave_on_server &amp;&amp; !m_pop3ConData-&gt;headers_only &amp;&amp;</span>
<a href="#l34.3758"></a><span id="l34.3758" class="difflineplus">+      m_pop3ConData-&gt;size_limit &lt;= 0 &amp;&amp; !m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.3759"></a><span id="l34.3759">     m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.3760"></a><span id="l34.3760">     return 0;</span>
<a href="#l34.3761"></a><span id="l34.3761">   }</span>
<a href="#l34.3762"></a><span id="l34.3762">   m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.3763"></a><span id="l34.3763">   nsCString hostName;</span>
<a href="#l34.3764"></a><span id="l34.3764">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.3765"></a><span id="l34.3765">   nsresult rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l34.3766"></a><span id="l34.3766">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l34.3767"></a><span id="l34.3767">   NS_ConvertASCIItoUTF16 hostNameUnicode(hostName);</span>
<a href="#l34.3768"></a><span id="l34.3768" class="difflineminus">-  const char16_t *params[] = { hostNameUnicode.get() };</span>
<a href="#l34.3769"></a><span id="l34.3769" class="difflineplus">+  const char16_t *params[] = {hostNameUnicode.get()};</span>
<a href="#l34.3770"></a><span id="l34.3770">   return Error(&quot;pop3ServerDoesNotSupportUidlEtc&quot;, params, 1);</span>
<a href="#l34.3771"></a><span id="l34.3771"> }</span>
<a href="#l34.3772"></a><span id="l34.3772"> </span>
<a href="#l34.3773"></a><span id="l34.3773" class="difflineminus">-</span>
<a href="#l34.3774"></a><span id="l34.3774"> /* km</span>
<a href="#l34.3775"></a><span id="l34.3775">  *</span>
<a href="#l34.3776"></a><span id="l34.3776">  *  net_pop3_send_xtnd_xlst_msgid</span>
<a href="#l34.3777"></a><span id="l34.3777">  *</span>
<a href="#l34.3778"></a><span id="l34.3778">  *  Process state: POP3_SEND_XTND_XLST_MSGID</span>
<a href="#l34.3779"></a><span id="l34.3779">  *</span>
<a href="#l34.3780"></a><span id="l34.3780">  *  If we get here then UIDL is not supported by the mail server.</span>
<a href="#l34.3781"></a><span id="l34.3781">  *  Some mail servers support a similar command:</span>
<a href="#l34.3782"></a><span id="l34.3782" class="difflineat">@@ -2659,395 +2374,359 @@ int32_t nsPop3Protocol::HandleNoUidListA</span>
<a href="#l34.3783"></a><span id="l34.3783">  &lt;&lt;+OK xlst command accepted; headers coming.</span>
<a href="#l34.3784"></a><span id="l34.3784">  &lt;&lt;1 Message-ID: &lt;3117E4DC.2699@netscape.invalid&gt;</span>
<a href="#l34.3785"></a><span id="l34.3785">  &lt;&lt;2 Message-Id: &lt;199602062335.PAA19215@lemon.example.com&gt;</span>
<a href="#l34.3786"></a><span id="l34.3786"> </span>
<a href="#l34.3787"></a><span id="l34.3787">  * This function will send the xtnd command and put us into the</span>
<a href="#l34.3788"></a><span id="l34.3788">  * POP3_GET_XTND_XLST_MSGID state</span>
<a href="#l34.3789"></a><span id="l34.3789">  *</span>
<a href="#l34.3790"></a><span id="l34.3790"> */</span>
<a href="#l34.3791"></a><span id="l34.3791" class="difflineminus">-int32_t nsPop3Protocol::SendXtndXlstMsgid()</span>
<a href="#l34.3792"></a><span id="l34.3792" class="difflineminus">-{</span>
<a href="#l34.3793"></a><span id="l34.3793" class="difflineminus">-  if (TestCapFlag(POP3_HAS_XTND_XLST | POP3_XTND_XLST_UNDEFINED))</span>
<a href="#l34.3794"></a><span id="l34.3794" class="difflineminus">-  {</span>
<a href="#l34.3795"></a><span id="l34.3795" class="difflineplus">+int32_t nsPop3Protocol::SendXtndXlstMsgid() {</span>
<a href="#l34.3796"></a><span id="l34.3796" class="difflineplus">+  if (TestCapFlag(POP3_HAS_XTND_XLST | POP3_XTND_XLST_UNDEFINED)) {</span>
<a href="#l34.3797"></a><span id="l34.3797">     m_pop3ConData-&gt;next_state_after_response = POP3_GET_XTND_XLST_MSGID;</span>
<a href="#l34.3798"></a><span id="l34.3798">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3799"></a><span id="l34.3799">     m_listpos = 0;</span>
<a href="#l34.3800"></a><span id="l34.3800">     return Pop3SendData(&quot;XTND XLST Message-Id&quot; CRLF);</span>
<a href="#l34.3801"></a><span id="l34.3801" class="difflineminus">-  }</span>
<a href="#l34.3802"></a><span id="l34.3802" class="difflineminus">-  else</span>
<a href="#l34.3803"></a><span id="l34.3803" class="difflineplus">+  } else</span>
<a href="#l34.3804"></a><span id="l34.3804">     return HandleNoUidListAvailable();</span>
<a href="#l34.3805"></a><span id="l34.3805"> }</span>
<a href="#l34.3806"></a><span id="l34.3806"> </span>
<a href="#l34.3807"></a><span id="l34.3807" class="difflineminus">-</span>
<a href="#l34.3808"></a><span id="l34.3808"> /* km</span>
<a href="#l34.3809"></a><span id="l34.3809">  *</span>
<a href="#l34.3810"></a><span id="l34.3810">  *  net_pop3_get_xtnd_xlst_msgid</span>
<a href="#l34.3811"></a><span id="l34.3811">  *</span>
<a href="#l34.3812"></a><span id="l34.3812">  *  This code was created from the net_pop3_get_uidl_list boiler plate.</span>
<a href="#l34.3813"></a><span id="l34.3813">  *  The difference is that the XTND reply strings have one more token per</span>
<a href="#l34.3814"></a><span id="l34.3814">  *  string than the UIDL reply strings do.</span>
<a href="#l34.3815"></a><span id="l34.3815">  *</span>
<a href="#l34.3816"></a><span id="l34.3816">  */</span>
<a href="#l34.3817"></a><span id="l34.3817"> </span>
<a href="#l34.3818"></a><span id="l34.3818" class="difflineminus">-int32_t</span>
<a href="#l34.3819"></a><span id="l34.3819" class="difflineminus">-nsPop3Protocol::GetXtndXlstMsgid(nsIInputStream* inputStream,</span>
<a href="#l34.3820"></a><span id="l34.3820" class="difflineminus">-                                 uint32_t length)</span>
<a href="#l34.3821"></a><span id="l34.3821" class="difflineminus">-{</span>
<a href="#l34.3822"></a><span id="l34.3822" class="difflineplus">+int32_t nsPop3Protocol::GetXtndXlstMsgid(nsIInputStream *inputStream,</span>
<a href="#l34.3823"></a><span id="l34.3823" class="difflineplus">+                                         uint32_t length) {</span>
<a href="#l34.3824"></a><span id="l34.3824">   /* check list response</span>
<a href="#l34.3825"></a><span id="l34.3825" class="difflineminus">-  * This will get called multiple times</span>
<a href="#l34.3826"></a><span id="l34.3826" class="difflineminus">-  * but it's alright since command_succeeded</span>
<a href="#l34.3827"></a><span id="l34.3827" class="difflineminus">-  * will remain constant</span>
<a href="#l34.3828"></a><span id="l34.3828" class="difflineminus">-  */</span>
<a href="#l34.3829"></a><span id="l34.3829" class="difflineplus">+   * This will get called multiple times</span>
<a href="#l34.3830"></a><span id="l34.3830" class="difflineplus">+   * but it's alright since command_succeeded</span>
<a href="#l34.3831"></a><span id="l34.3831" class="difflineplus">+   * will remain constant</span>
<a href="#l34.3832"></a><span id="l34.3832" class="difflineplus">+   */</span>
<a href="#l34.3833"></a><span id="l34.3833">   ClearCapFlag(POP3_XTND_XLST_UNDEFINED);</span>
<a href="#l34.3834"></a><span id="l34.3834"> </span>
<a href="#l34.3835"></a><span id="l34.3835" class="difflineminus">-  if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.3836"></a><span id="l34.3836" class="difflineminus">-  {</span>
<a href="#l34.3837"></a><span id="l34.3837" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.3838"></a><span id="l34.3838">     ClearCapFlag(POP3_HAS_XTND_XLST);</span>
<a href="#l34.3839"></a><span id="l34.3839">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3840"></a><span id="l34.3840">     HandleNoUidListAvailable();</span>
<a href="#l34.3841"></a><span id="l34.3841" class="difflineminus">-    return(0);</span>
<a href="#l34.3842"></a><span id="l34.3842" class="difflineminus">-  }</span>
<a href="#l34.3843"></a><span id="l34.3843" class="difflineminus">-  else</span>
<a href="#l34.3844"></a><span id="l34.3844" class="difflineminus">-  {</span>
<a href="#l34.3845"></a><span id="l34.3845" class="difflineplus">+    return (0);</span>
<a href="#l34.3846"></a><span id="l34.3846" class="difflineplus">+  } else {</span>
<a href="#l34.3847"></a><span id="l34.3847">     SetCapFlag(POP3_HAS_XTND_XLST);</span>
<a href="#l34.3848"></a><span id="l34.3848">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3849"></a><span id="l34.3849">   }</span>
<a href="#l34.3850"></a><span id="l34.3850"> </span>
<a href="#l34.3851"></a><span id="l34.3851">   uint32_t ln = 0;</span>
<a href="#l34.3852"></a><span id="l34.3852">   bool pauseForMoreData = false;</span>
<a href="#l34.3853"></a><span id="l34.3853">   nsresult rv;</span>
<a href="#l34.3854"></a><span id="l34.3854" class="difflineminus">-  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.3855"></a><span id="l34.3855" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.3856"></a><span id="l34.3856" class="difflineminus">-    return -1;</span>
<a href="#l34.3857"></a><span id="l34.3857" class="difflineminus">-</span>
<a href="#l34.3858"></a><span id="l34.3858" class="difflineminus">-  if (pauseForMoreData || !line)</span>
<a href="#l34.3859"></a><span id="l34.3859" class="difflineminus">-  {</span>
<a href="#l34.3860"></a><span id="l34.3860" class="difflineplus">+  char *line =</span>
<a href="#l34.3861"></a><span id="l34.3861" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.3862"></a><span id="l34.3862" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.3863"></a><span id="l34.3863" class="difflineplus">+</span>
<a href="#l34.3864"></a><span id="l34.3864" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.3865"></a><span id="l34.3865">     m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3866"></a><span id="l34.3866">     PR_Free(line);</span>
<a href="#l34.3867"></a><span id="l34.3867">     return ln;</span>
<a href="#l34.3868"></a><span id="l34.3868">   }</span>
<a href="#l34.3869"></a><span id="l34.3869"> </span>
<a href="#l34.3870"></a><span id="l34.3870">   MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.3871"></a><span id="l34.3871"> </span>
<a href="#l34.3872"></a><span id="l34.3872">   /* parse the line returned from the list command</span>
<a href="#l34.3873"></a><span id="l34.3873" class="difflineminus">-  * it looks like</span>
<a href="#l34.3874"></a><span id="l34.3874" class="difflineminus">-  * 1 Message-ID: &lt;3117E4DC.2699@example.com&gt;</span>
<a href="#l34.3875"></a><span id="l34.3875" class="difflineminus">-  *</span>
<a href="#l34.3876"></a><span id="l34.3876" class="difflineminus">-  * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l34.3877"></a><span id="l34.3877" class="difflineminus">-  */</span>
<a href="#l34.3878"></a><span id="l34.3878" class="difflineminus">-  if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l34.3879"></a><span id="l34.3879" class="difflineminus">-  {</span>
<a href="#l34.3880"></a><span id="l34.3880" class="difflineplus">+   * it looks like</span>
<a href="#l34.3881"></a><span id="l34.3881" class="difflineplus">+   * 1 Message-ID: &lt;3117E4DC.2699@example.com&gt;</span>
<a href="#l34.3882"></a><span id="l34.3882" class="difflineplus">+   *</span>
<a href="#l34.3883"></a><span id="l34.3883" class="difflineplus">+   * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l34.3884"></a><span id="l34.3884" class="difflineplus">+   */</span>
<a href="#l34.3885"></a><span id="l34.3885" class="difflineplus">+  if (!PL_strcmp(line, &quot;.&quot;)) {</span>
<a href="#l34.3886"></a><span id="l34.3886">     // limit the list if fewer entries than given in STAT response</span>
<a href="#l34.3887"></a><span id="l34.3887" class="difflineminus">-    if(m_listpos &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3888"></a><span id="l34.3888" class="difflineplus">+    if (m_listpos &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3889"></a><span id="l34.3889">       m_pop3ConData-&gt;number_of_messages = m_listpos;</span>
<a href="#l34.3890"></a><span id="l34.3890">     m_pop3ConData-&gt;list_done = true;</span>
<a href="#l34.3891"></a><span id="l34.3891">     m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.3892"></a><span id="l34.3892">     m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.3893"></a><span id="l34.3893">     PR_Free(line);</span>
<a href="#l34.3894"></a><span id="l34.3894" class="difflineminus">-    return(0);</span>
<a href="#l34.3895"></a><span id="l34.3895" class="difflineplus">+    return (0);</span>
<a href="#l34.3896"></a><span id="l34.3896">   }</span>
<a href="#l34.3897"></a><span id="l34.3897"> </span>
<a href="#l34.3898"></a><span id="l34.3898">   char *newStr = line;</span>
<a href="#l34.3899"></a><span id="l34.3899">   char *token = NS_strtok(&quot; &quot;, &amp;newStr);  // msg num</span>
<a href="#l34.3900"></a><span id="l34.3900" class="difflineminus">-  if (token)</span>
<a href="#l34.3901"></a><span id="l34.3901" class="difflineminus">-  {</span>
<a href="#l34.3902"></a><span id="l34.3902" class="difflineplus">+  if (token) {</span>
<a href="#l34.3903"></a><span id="l34.3903">     int32_t msg_num = atol(token);</span>
<a href="#l34.3904"></a><span id="l34.3904" class="difflineminus">-    if (++m_listpos &lt;= m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3905"></a><span id="l34.3905" class="difflineminus">-    {</span>
<a href="#l34.3906"></a><span id="l34.3906" class="difflineplus">+    if (++m_listpos &lt;= m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.3907"></a><span id="l34.3907">       NS_strtok(&quot; &quot;, &amp;newStr);  // eat message ID token</span>
<a href="#l34.3908"></a><span id="l34.3908" class="difflineminus">-      const char *uid = NS_strtok(&quot; &quot;, &amp;newStr); // not really a UID but a unique token -km</span>
<a href="#l34.3909"></a><span id="l34.3909" class="difflineplus">+      const char *uid =</span>
<a href="#l34.3910"></a><span id="l34.3910" class="difflineplus">+          NS_strtok(&quot; &quot;, &amp;newStr);  // not really a UID but a unique token -km</span>
<a href="#l34.3911"></a><span id="l34.3911">       if (!uid)</span>
<a href="#l34.3912"></a><span id="l34.3912">         /* This is bad.  The server didn't give us a UIDL for this message.</span>
<a href="#l34.3913"></a><span id="l34.3913">         I've seen this happen when somehow the mail spool has a message</span>
<a href="#l34.3914"></a><span id="l34.3914">         that contains a header that reads &quot;X-UIDL: \n&quot;.  But how that got</span>
<a href="#l34.3915"></a><span id="l34.3915">         there, I have no idea; must be a server bug.  Or something. */</span>
<a href="#l34.3916"></a><span id="l34.3916">         uid = &quot;&quot;;</span>
<a href="#l34.3917"></a><span id="l34.3917"> </span>
<a href="#l34.3918"></a><span id="l34.3918">       // seeking right entry, but try the one that should it be first</span>
<a href="#l34.3919"></a><span id="l34.3919">       int32_t i;</span>
<a href="#l34.3920"></a><span id="l34.3920" class="difflineminus">-      if(m_pop3ConData-&gt;msg_info[m_listpos - 1].msgnum == msg_num)</span>
<a href="#l34.3921"></a><span id="l34.3921" class="difflineplus">+      if (m_pop3ConData-&gt;msg_info[m_listpos - 1].msgnum == msg_num)</span>
<a href="#l34.3922"></a><span id="l34.3922">         i = m_listpos - 1;</span>
<a href="#l34.3923"></a><span id="l34.3923">       else</span>
<a href="#l34.3924"></a><span id="l34.3924" class="difflineminus">-        for(i = 0; i &lt; m_pop3ConData-&gt;number_of_messages &amp;&amp;</span>
<a href="#l34.3925"></a><span id="l34.3925" class="difflineminus">-                   m_pop3ConData-&gt;msg_info[i].msgnum != msg_num; i++)</span>
<a href="#l34.3926"></a><span id="l34.3926" class="difflineplus">+        for (i = 0; i &lt; m_pop3ConData-&gt;number_of_messages &amp;&amp;</span>
<a href="#l34.3927"></a><span id="l34.3927" class="difflineplus">+                    m_pop3ConData-&gt;msg_info[i].msgnum != msg_num;</span>
<a href="#l34.3928"></a><span id="l34.3928" class="difflineplus">+             i++)</span>
<a href="#l34.3929"></a><span id="l34.3929">           ;</span>
<a href="#l34.3930"></a><span id="l34.3930"> </span>
<a href="#l34.3931"></a><span id="l34.3931">       // only if found a matching slot</span>
<a href="#l34.3932"></a><span id="l34.3932" class="difflineminus">-      if (i &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.3933"></a><span id="l34.3933" class="difflineminus">-      {</span>
<a href="#l34.3934"></a><span id="l34.3934" class="difflineplus">+      if (i &lt; m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.3935"></a><span id="l34.3935">         // to protect us from memory leak in case of getting a msg num twice</span>
<a href="#l34.3936"></a><span id="l34.3936">         m_pop3ConData-&gt;msg_info[i].uidl = PL_strdup(uid);</span>
<a href="#l34.3937"></a><span id="l34.3937" class="difflineminus">-        if (!m_pop3ConData-&gt;msg_info[i].uidl)</span>
<a href="#l34.3938"></a><span id="l34.3938" class="difflineminus">-        {</span>
<a href="#l34.3939"></a><span id="l34.3939" class="difflineplus">+        if (!m_pop3ConData-&gt;msg_info[i].uidl) {</span>
<a href="#l34.3940"></a><span id="l34.3940">           PR_Free(line);</span>
<a href="#l34.3941"></a><span id="l34.3941">           return MK_OUT_OF_MEMORY;</span>
<a href="#l34.3942"></a><span id="l34.3942">         }</span>
<a href="#l34.3943"></a><span id="l34.3943">       }</span>
<a href="#l34.3944"></a><span id="l34.3944">     }</span>
<a href="#l34.3945"></a><span id="l34.3945">   }</span>
<a href="#l34.3946"></a><span id="l34.3946"> </span>
<a href="#l34.3947"></a><span id="l34.3947">   PR_Free(line);</span>
<a href="#l34.3948"></a><span id="l34.3948" class="difflineminus">-  return(0);</span>
<a href="#l34.3949"></a><span id="l34.3949" class="difflineplus">+  return (0);</span>
<a href="#l34.3950"></a><span id="l34.3950"> }</span>
<a href="#l34.3951"></a><span id="l34.3951"> </span>
<a href="#l34.3952"></a><span id="l34.3952" class="difflineminus">-</span>
<a href="#l34.3953"></a><span id="l34.3953" class="difflineminus">-int32_t nsPop3Protocol::SendUidlList()</span>
<a href="#l34.3954"></a><span id="l34.3954" class="difflineminus">-{</span>
<a href="#l34.3955"></a><span id="l34.3955" class="difflineminus">-    if (TestCapFlag(POP3_HAS_UIDL | POP3_UIDL_UNDEFINED))</span>
<a href="#l34.3956"></a><span id="l34.3956" class="difflineminus">-    {</span>
<a href="#l34.3957"></a><span id="l34.3957" class="difflineminus">-      m_pop3ConData-&gt;next_state_after_response = POP3_GET_UIDL_LIST;</span>
<a href="#l34.3958"></a><span id="l34.3958" class="difflineminus">-      m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3959"></a><span id="l34.3959" class="difflineminus">-      m_listpos = 0;</span>
<a href="#l34.3960"></a><span id="l34.3960" class="difflineminus">-      return Pop3SendData(&quot;UIDL&quot; CRLF);</span>
<a href="#l34.3961"></a><span id="l34.3961" class="difflineminus">-    }</span>
<a href="#l34.3962"></a><span id="l34.3962" class="difflineminus">-    else</span>
<a href="#l34.3963"></a><span id="l34.3963" class="difflineminus">-      return SendXtndXlstMsgid();</span>
<a href="#l34.3964"></a><span id="l34.3964" class="difflineplus">+int32_t nsPop3Protocol::SendUidlList() {</span>
<a href="#l34.3965"></a><span id="l34.3965" class="difflineplus">+  if (TestCapFlag(POP3_HAS_UIDL | POP3_UIDL_UNDEFINED)) {</span>
<a href="#l34.3966"></a><span id="l34.3966" class="difflineplus">+    m_pop3ConData-&gt;next_state_after_response = POP3_GET_UIDL_LIST;</span>
<a href="#l34.3967"></a><span id="l34.3967" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.3968"></a><span id="l34.3968" class="difflineplus">+    m_listpos = 0;</span>
<a href="#l34.3969"></a><span id="l34.3969" class="difflineplus">+    return Pop3SendData(&quot;UIDL&quot; CRLF);</span>
<a href="#l34.3970"></a><span id="l34.3970" class="difflineplus">+  } else</span>
<a href="#l34.3971"></a><span id="l34.3971" class="difflineplus">+    return SendXtndXlstMsgid();</span>
<a href="#l34.3972"></a><span id="l34.3972"> }</span>
<a href="#l34.3973"></a><span id="l34.3973"> </span>
<a href="#l34.3974"></a><span id="l34.3974" class="difflineminus">-</span>
<a href="#l34.3975"></a><span id="l34.3975" class="difflineminus">-int32_t nsPop3Protocol::GetUidlList(nsIInputStream* inputStream,</span>
<a href="#l34.3976"></a><span id="l34.3976" class="difflineminus">-                            uint32_t length)</span>
<a href="#l34.3977"></a><span id="l34.3977" class="difflineminus">-{</span>
<a href="#l34.3978"></a><span id="l34.3978" class="difflineminus">-    /* check list response</span>
<a href="#l34.3979"></a><span id="l34.3979" class="difflineminus">-     * This will get called multiple times</span>
<a href="#l34.3980"></a><span id="l34.3980" class="difflineminus">-     * but it's alright since command_succeeded</span>
<a href="#l34.3981"></a><span id="l34.3981" class="difflineminus">-     * will remain constant</span>
<a href="#l34.3982"></a><span id="l34.3982" class="difflineminus">-     */</span>
<a href="#l34.3983"></a><span id="l34.3983" class="difflineminus">-    ClearCapFlag(POP3_UIDL_UNDEFINED);</span>
<a href="#l34.3984"></a><span id="l34.3984" class="difflineminus">-</span>
<a href="#l34.3985"></a><span id="l34.3985" class="difflineminus">-    if (!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.3986"></a><span id="l34.3986" class="difflineminus">-    {</span>
<a href="#l34.3987"></a><span id="l34.3987" class="difflineminus">-      m_pop3ConData-&gt;next_state = POP3_SEND_XTND_XLST_MSGID;</span>
<a href="#l34.3988"></a><span id="l34.3988" class="difflineminus">-      m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.3989"></a><span id="l34.3989" class="difflineminus">-      ClearCapFlag(POP3_HAS_UIDL);</span>
<a href="#l34.3990"></a><span id="l34.3990" class="difflineminus">-      m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3991"></a><span id="l34.3991" class="difflineminus">-      return(0);</span>
<a href="#l34.3992"></a><span id="l34.3992" class="difflineminus">-    }</span>
<a href="#l34.3993"></a><span id="l34.3993" class="difflineminus">-    else</span>
<a href="#l34.3994"></a><span id="l34.3994" class="difflineminus">-    {</span>
<a href="#l34.3995"></a><span id="l34.3995" class="difflineminus">-      SetCapFlag(POP3_HAS_UIDL);</span>
<a href="#l34.3996"></a><span id="l34.3996" class="difflineminus">-      m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.3997"></a><span id="l34.3997" class="difflineminus">-    }</span>
<a href="#l34.3998"></a><span id="l34.3998" class="difflineminus">-</span>
<a href="#l34.3999"></a><span id="l34.3999" class="difflineminus">-    uint32_t ln = 0;</span>
<a href="#l34.4000"></a><span id="l34.4000" class="difflineminus">-    bool pauseForMoreData = false;</span>
<a href="#l34.4001"></a><span id="l34.4001" class="difflineminus">-    nsresult rv;</span>
<a href="#l34.4002"></a><span id="l34.4002" class="difflineminus">-    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.4003"></a><span id="l34.4003" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.4004"></a><span id="l34.4004" class="difflineminus">-      return -1;</span>
<a href="#l34.4005"></a><span id="l34.4005" class="difflineminus">-</span>
<a href="#l34.4006"></a><span id="l34.4006" class="difflineminus">-    if (pauseForMoreData || !line)</span>
<a href="#l34.4007"></a><span id="l34.4007" class="difflineminus">-    {</span>
<a href="#l34.4008"></a><span id="l34.4008" class="difflineminus">-      PR_Free(line);</span>
<a href="#l34.4009"></a><span id="l34.4009" class="difflineminus">-      m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.4010"></a><span id="l34.4010" class="difflineminus">-      return ln;</span>
<a href="#l34.4011"></a><span id="l34.4011" class="difflineminus">-    }</span>
<a href="#l34.4012"></a><span id="l34.4012" class="difflineminus">-</span>
<a href="#l34.4013"></a><span id="l34.4013" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.4014"></a><span id="l34.4014" class="difflineminus">-</span>
<a href="#l34.4015"></a><span id="l34.4015" class="difflineminus">-    /* parse the line returned from the list command</span>
<a href="#l34.4016"></a><span id="l34.4016" class="difflineminus">-     * it looks like</span>
<a href="#l34.4017"></a><span id="l34.4017" class="difflineminus">-     * #msg_number uidl</span>
<a href="#l34.4018"></a><span id="l34.4018" class="difflineminus">-     *</span>
<a href="#l34.4019"></a><span id="l34.4019" class="difflineminus">-     * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l34.4020"></a><span id="l34.4020" class="difflineminus">-     */</span>
<a href="#l34.4021"></a><span id="l34.4021" class="difflineminus">-    if (!PL_strcmp(line, &quot;.&quot;))</span>
<a href="#l34.4022"></a><span id="l34.4022" class="difflineminus">-    {</span>
<a href="#l34.4023"></a><span id="l34.4023" class="difflineminus">-      // limit the list if fewer entries than given in STAT response</span>
<a href="#l34.4024"></a><span id="l34.4024" class="difflineminus">-      if (m_listpos &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.4025"></a><span id="l34.4025" class="difflineminus">-        m_pop3ConData-&gt;number_of_messages = m_listpos;</span>
<a href="#l34.4026"></a><span id="l34.4026" class="difflineminus">-      m_pop3ConData-&gt;list_done = true;</span>
<a href="#l34.4027"></a><span id="l34.4027" class="difflineminus">-      m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.4028"></a><span id="l34.4028" class="difflineminus">-      m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.4029"></a><span id="l34.4029" class="difflineminus">-      PR_Free(line);</span>
<a href="#l34.4030"></a><span id="l34.4030" class="difflineminus">-      return(0);</span>
<a href="#l34.4031"></a><span id="l34.4031" class="difflineminus">-    }</span>
<a href="#l34.4032"></a><span id="l34.4032" class="difflineminus">-</span>
<a href="#l34.4033"></a><span id="l34.4033" class="difflineminus">-    char *newStr = line;</span>
<a href="#l34.4034"></a><span id="l34.4034" class="difflineminus">-    char *token = NS_strtok(&quot; &quot;, &amp;newStr);  // msg num</span>
<a href="#l34.4035"></a><span id="l34.4035" class="difflineminus">-    if (token)</span>
<a href="#l34.4036"></a><span id="l34.4036" class="difflineminus">-    {</span>
<a href="#l34.4037"></a><span id="l34.4037" class="difflineminus">-      int32_t msg_num = atol(token);</span>
<a href="#l34.4038"></a><span id="l34.4038" class="difflineminus">-      if (++m_listpos &lt;= m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.4039"></a><span id="l34.4039" class="difflineminus">-      {</span>
<a href="#l34.4040"></a><span id="l34.4040" class="difflineminus">-        const char *uid = NS_strtok(&quot; &quot;, &amp;newStr); // UID</span>
<a href="#l34.4041"></a><span id="l34.4041" class="difflineminus">-        if (!uid)</span>
<a href="#l34.4042"></a><span id="l34.4042" class="difflineminus">-          /* This is bad.  The server didn't give us a UIDL for this message.</span>
<a href="#l34.4043"></a><span id="l34.4043" class="difflineminus">-             I've seen this happen when somehow the mail spool has a message</span>
<a href="#l34.4044"></a><span id="l34.4044" class="difflineminus">-             that contains a header that reads &quot;X-UIDL: \n&quot;.  But how that got</span>
<a href="#l34.4045"></a><span id="l34.4045" class="difflineminus">-             there, I have no idea; must be a server bug.  Or something. */</span>
<a href="#l34.4046"></a><span id="l34.4046" class="difflineminus">-          uid = &quot;&quot;;</span>
<a href="#l34.4047"></a><span id="l34.4047" class="difflineminus">-</span>
<a href="#l34.4048"></a><span id="l34.4048" class="difflineminus">-        // seeking right entry, but try the one that should it be first</span>
<a href="#l34.4049"></a><span id="l34.4049" class="difflineminus">-        int32_t i;</span>
<a href="#l34.4050"></a><span id="l34.4050" class="difflineminus">-        if(m_pop3ConData-&gt;msg_info[m_listpos - 1].msgnum == msg_num)</span>
<a href="#l34.4051"></a><span id="l34.4051" class="difflineminus">-          i = m_listpos - 1;</span>
<a href="#l34.4052"></a><span id="l34.4052" class="difflineminus">-        else</span>
<a href="#l34.4053"></a><span id="l34.4053" class="difflineminus">-          for(i = 0; i &lt; m_pop3ConData-&gt;number_of_messages &amp;&amp;</span>
<a href="#l34.4054"></a><span id="l34.4054" class="difflineminus">-                     m_pop3ConData-&gt;msg_info[i].msgnum != msg_num; i++)</span>
<a href="#l34.4055"></a><span id="l34.4055" class="difflineminus">-            ;</span>
<a href="#l34.4056"></a><span id="l34.4056" class="difflineminus">-</span>
<a href="#l34.4057"></a><span id="l34.4057" class="difflineminus">-        // only if found a matching slot</span>
<a href="#l34.4058"></a><span id="l34.4058" class="difflineminus">-        if (i &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.4059"></a><span id="l34.4059" class="difflineminus">-        {</span>
<a href="#l34.4060"></a><span id="l34.4060" class="difflineminus">-          // to protect us from memory leak in case of getting a msg num twice</span>
<a href="#l34.4061"></a><span id="l34.4061" class="difflineminus">-          m_pop3ConData-&gt;msg_info[i].uidl = PL_strdup(uid);</span>
<a href="#l34.4062"></a><span id="l34.4062" class="difflineminus">-          if (!m_pop3ConData-&gt;msg_info[i].uidl)</span>
<a href="#l34.4063"></a><span id="l34.4063" class="difflineminus">-          {</span>
<a href="#l34.4064"></a><span id="l34.4064" class="difflineminus">-            PR_Free(line);</span>
<a href="#l34.4065"></a><span id="l34.4065" class="difflineminus">-            return MK_OUT_OF_MEMORY;</span>
<a href="#l34.4066"></a><span id="l34.4066" class="difflineminus">-          }</span>
<a href="#l34.4067"></a><span id="l34.4067" class="difflineplus">+int32_t nsPop3Protocol::GetUidlList(nsIInputStream *inputStream,</span>
<a href="#l34.4068"></a><span id="l34.4068" class="difflineplus">+                                    uint32_t length) {</span>
<a href="#l34.4069"></a><span id="l34.4069" class="difflineplus">+  /* check list response</span>
<a href="#l34.4070"></a><span id="l34.4070" class="difflineplus">+   * This will get called multiple times</span>
<a href="#l34.4071"></a><span id="l34.4071" class="difflineplus">+   * but it's alright since command_succeeded</span>
<a href="#l34.4072"></a><span id="l34.4072" class="difflineplus">+   * will remain constant</span>
<a href="#l34.4073"></a><span id="l34.4073" class="difflineplus">+   */</span>
<a href="#l34.4074"></a><span id="l34.4074" class="difflineplus">+  ClearCapFlag(POP3_UIDL_UNDEFINED);</span>
<a href="#l34.4075"></a><span id="l34.4075" class="difflineplus">+</span>
<a href="#l34.4076"></a><span id="l34.4076" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.4077"></a><span id="l34.4077" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_XTND_XLST_MSGID;</span>
<a href="#l34.4078"></a><span id="l34.4078" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.4079"></a><span id="l34.4079" class="difflineplus">+    ClearCapFlag(POP3_HAS_UIDL);</span>
<a href="#l34.4080"></a><span id="l34.4080" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.4081"></a><span id="l34.4081" class="difflineplus">+    return (0);</span>
<a href="#l34.4082"></a><span id="l34.4082" class="difflineplus">+  } else {</span>
<a href="#l34.4083"></a><span id="l34.4083" class="difflineplus">+    SetCapFlag(POP3_HAS_UIDL);</span>
<a href="#l34.4084"></a><span id="l34.4084" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.4085"></a><span id="l34.4085" class="difflineplus">+  }</span>
<a href="#l34.4086"></a><span id="l34.4086" class="difflineplus">+</span>
<a href="#l34.4087"></a><span id="l34.4087" class="difflineplus">+  uint32_t ln = 0;</span>
<a href="#l34.4088"></a><span id="l34.4088" class="difflineplus">+  bool pauseForMoreData = false;</span>
<a href="#l34.4089"></a><span id="l34.4089" class="difflineplus">+  nsresult rv;</span>
<a href="#l34.4090"></a><span id="l34.4090" class="difflineplus">+  char *line =</span>
<a href="#l34.4091"></a><span id="l34.4091" class="difflineplus">+      m_lineStreamBuffer-&gt;ReadNextLine(inputStream, ln, pauseForMoreData, &amp;rv);</span>
<a href="#l34.4092"></a><span id="l34.4092" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.4093"></a><span id="l34.4093" class="difflineplus">+</span>
<a href="#l34.4094"></a><span id="l34.4094" class="difflineplus">+  if (pauseForMoreData || !line) {</span>
<a href="#l34.4095"></a><span id="l34.4095" class="difflineplus">+    PR_Free(line);</span>
<a href="#l34.4096"></a><span id="l34.4096" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.4097"></a><span id="l34.4097" class="difflineplus">+    return ln;</span>
<a href="#l34.4098"></a><span id="l34.4098" class="difflineplus">+  }</span>
<a href="#l34.4099"></a><span id="l34.4099" class="difflineplus">+</span>
<a href="#l34.4100"></a><span id="l34.4100" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.4101"></a><span id="l34.4101" class="difflineplus">+</span>
<a href="#l34.4102"></a><span id="l34.4102" class="difflineplus">+  /* parse the line returned from the list command</span>
<a href="#l34.4103"></a><span id="l34.4103" class="difflineplus">+   * it looks like</span>
<a href="#l34.4104"></a><span id="l34.4104" class="difflineplus">+   * #msg_number uidl</span>
<a href="#l34.4105"></a><span id="l34.4105" class="difflineplus">+   *</span>
<a href="#l34.4106"></a><span id="l34.4106" class="difflineplus">+   * list data is terminated by a &quot;.CRLF&quot; line</span>
<a href="#l34.4107"></a><span id="l34.4107" class="difflineplus">+   */</span>
<a href="#l34.4108"></a><span id="l34.4108" class="difflineplus">+  if (!PL_strcmp(line, &quot;.&quot;)) {</span>
<a href="#l34.4109"></a><span id="l34.4109" class="difflineplus">+    // limit the list if fewer entries than given in STAT response</span>
<a href="#l34.4110"></a><span id="l34.4110" class="difflineplus">+    if (m_listpos &lt; m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.4111"></a><span id="l34.4111" class="difflineplus">+      m_pop3ConData-&gt;number_of_messages = m_listpos;</span>
<a href="#l34.4112"></a><span id="l34.4112" class="difflineplus">+    m_pop3ConData-&gt;list_done = true;</span>
<a href="#l34.4113"></a><span id="l34.4113" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.4114"></a><span id="l34.4114" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.4115"></a><span id="l34.4115" class="difflineplus">+    PR_Free(line);</span>
<a href="#l34.4116"></a><span id="l34.4116" class="difflineplus">+    return (0);</span>
<a href="#l34.4117"></a><span id="l34.4117" class="difflineplus">+  }</span>
<a href="#l34.4118"></a><span id="l34.4118" class="difflineplus">+</span>
<a href="#l34.4119"></a><span id="l34.4119" class="difflineplus">+  char *newStr = line;</span>
<a href="#l34.4120"></a><span id="l34.4120" class="difflineplus">+  char *token = NS_strtok(&quot; &quot;, &amp;newStr);  // msg num</span>
<a href="#l34.4121"></a><span id="l34.4121" class="difflineplus">+  if (token) {</span>
<a href="#l34.4122"></a><span id="l34.4122" class="difflineplus">+    int32_t msg_num = atol(token);</span>
<a href="#l34.4123"></a><span id="l34.4123" class="difflineplus">+    if (++m_listpos &lt;= m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.4124"></a><span id="l34.4124" class="difflineplus">+      const char *uid = NS_strtok(&quot; &quot;, &amp;newStr);  // UID</span>
<a href="#l34.4125"></a><span id="l34.4125" class="difflineplus">+      if (!uid)</span>
<a href="#l34.4126"></a><span id="l34.4126" class="difflineplus">+        /* This is bad.  The server didn't give us a UIDL for this message.</span>
<a href="#l34.4127"></a><span id="l34.4127" class="difflineplus">+           I've seen this happen when somehow the mail spool has a message</span>
<a href="#l34.4128"></a><span id="l34.4128" class="difflineplus">+           that contains a header that reads &quot;X-UIDL: \n&quot;.  But how that got</span>
<a href="#l34.4129"></a><span id="l34.4129" class="difflineplus">+           there, I have no idea; must be a server bug.  Or something. */</span>
<a href="#l34.4130"></a><span id="l34.4130" class="difflineplus">+        uid = &quot;&quot;;</span>
<a href="#l34.4131"></a><span id="l34.4131" class="difflineplus">+</span>
<a href="#l34.4132"></a><span id="l34.4132" class="difflineplus">+      // seeking right entry, but try the one that should it be first</span>
<a href="#l34.4133"></a><span id="l34.4133" class="difflineplus">+      int32_t i;</span>
<a href="#l34.4134"></a><span id="l34.4134" class="difflineplus">+      if (m_pop3ConData-&gt;msg_info[m_listpos - 1].msgnum == msg_num)</span>
<a href="#l34.4135"></a><span id="l34.4135" class="difflineplus">+        i = m_listpos - 1;</span>
<a href="#l34.4136"></a><span id="l34.4136" class="difflineplus">+      else</span>
<a href="#l34.4137"></a><span id="l34.4137" class="difflineplus">+        for (i = 0; i &lt; m_pop3ConData-&gt;number_of_messages &amp;&amp;</span>
<a href="#l34.4138"></a><span id="l34.4138" class="difflineplus">+                    m_pop3ConData-&gt;msg_info[i].msgnum != msg_num;</span>
<a href="#l34.4139"></a><span id="l34.4139" class="difflineplus">+             i++)</span>
<a href="#l34.4140"></a><span id="l34.4140" class="difflineplus">+          ;</span>
<a href="#l34.4141"></a><span id="l34.4141" class="difflineplus">+</span>
<a href="#l34.4142"></a><span id="l34.4142" class="difflineplus">+      // only if found a matching slot</span>
<a href="#l34.4143"></a><span id="l34.4143" class="difflineplus">+      if (i &lt; m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.4144"></a><span id="l34.4144" class="difflineplus">+        // to protect us from memory leak in case of getting a msg num twice</span>
<a href="#l34.4145"></a><span id="l34.4145" class="difflineplus">+        m_pop3ConData-&gt;msg_info[i].uidl = PL_strdup(uid);</span>
<a href="#l34.4146"></a><span id="l34.4146" class="difflineplus">+        if (!m_pop3ConData-&gt;msg_info[i].uidl) {</span>
<a href="#l34.4147"></a><span id="l34.4147" class="difflineplus">+          PR_Free(line);</span>
<a href="#l34.4148"></a><span id="l34.4148" class="difflineplus">+          return MK_OUT_OF_MEMORY;</span>
<a href="#l34.4149"></a><span id="l34.4149">         }</span>
<a href="#l34.4150"></a><span id="l34.4150">       }</span>
<a href="#l34.4151"></a><span id="l34.4151">     }</span>
<a href="#l34.4152"></a><span id="l34.4152" class="difflineminus">-    PR_Free(line);</span>
<a href="#l34.4153"></a><span id="l34.4153" class="difflineminus">-    return(0);</span>
<a href="#l34.4154"></a><span id="l34.4154" class="difflineplus">+  }</span>
<a href="#l34.4155"></a><span id="l34.4155" class="difflineplus">+  PR_Free(line);</span>
<a href="#l34.4156"></a><span id="l34.4156" class="difflineplus">+  return (0);</span>
<a href="#l34.4157"></a><span id="l34.4157"> }</span>
<a href="#l34.4158"></a><span id="l34.4158"> </span>
<a href="#l34.4159"></a><span id="l34.4159" class="difflineminus">-</span>
<a href="#l34.4160"></a><span id="l34.4160" class="difflineminus">-</span>
<a href="#l34.4161"></a><span id="l34.4161"> /* this function decides if we are going to do a</span>
<a href="#l34.4162"></a><span id="l34.4162">  * normal RETR or a TOP.  The first time, it also decides the total number</span>
<a href="#l34.4163"></a><span id="l34.4163">  * of bytes we're probably going to get.</span>
<a href="#l34.4164"></a><span id="l34.4164">  */</span>
<a href="#l34.4165"></a><span id="l34.4165" class="difflineminus">-int32_t nsPop3Protocol::GetMsg()</span>
<a href="#l34.4166"></a><span id="l34.4166" class="difflineminus">-{</span>
<a href="#l34.4167"></a><span id="l34.4167" class="difflineplus">+int32_t nsPop3Protocol::GetMsg() {</span>
<a href="#l34.4168"></a><span id="l34.4168">   int32_t popstateTimestamp = TimeInSecondsFromPRTime(PR_Now());</span>
<a href="#l34.4169"></a><span id="l34.4169"> </span>
<a href="#l34.4170"></a><span id="l34.4170" class="difflineminus">-  if (m_pop3ConData-&gt;last_accessed_msg &gt;= m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.4171"></a><span id="l34.4171" class="difflineminus">-  {</span>
<a href="#l34.4172"></a><span id="l34.4172" class="difflineplus">+  if (m_pop3ConData-&gt;last_accessed_msg &gt;= m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.4173"></a><span id="l34.4173">     /* Oh, gee, we're all done. */</span>
<a href="#l34.4174"></a><span id="l34.4174" class="difflineminus">-    if(m_pop3ConData-&gt;msg_del_started)</span>
<a href="#l34.4175"></a><span id="l34.4175" class="difflineminus">-    {</span>
<a href="#l34.4176"></a><span id="l34.4176" class="difflineminus">-      if (!m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.4177"></a><span id="l34.4177" class="difflineminus">-      {</span>
<a href="#l34.4178"></a><span id="l34.4178" class="difflineplus">+    if (m_pop3ConData-&gt;msg_del_started) {</span>
<a href="#l34.4179"></a><span id="l34.4179" class="difflineplus">+      if (!m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.4180"></a><span id="l34.4180">         if (m_pop3ConData-&gt;only_check_for_new_mail)</span>
<a href="#l34.4181"></a><span id="l34.4181" class="difflineminus">-          m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(m_pop3ConData-&gt;biffstate, m_pop3ConData-&gt;really_new_messages, true);</span>
<a href="#l34.4182"></a><span id="l34.4182" class="difflineplus">+          m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(</span>
<a href="#l34.4183"></a><span id="l34.4183" class="difflineplus">+              m_pop3ConData-&gt;biffstate, m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l34.4184"></a><span id="l34.4184" class="difflineplus">+              true);</span>
<a href="#l34.4185"></a><span id="l34.4185">         /* update old style biff */</span>
<a href="#l34.4186"></a><span id="l34.4186">         else</span>
<a href="#l34.4187"></a><span id="l34.4187" class="difflineminus">-          m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(nsIMsgFolder::nsMsgBiffState_NewMail, m_pop3ConData-&gt;really_new_messages, false);</span>
<a href="#l34.4188"></a><span id="l34.4188" class="difflineplus">+          m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(</span>
<a href="#l34.4189"></a><span id="l34.4189" class="difflineplus">+              nsIMsgFolder::nsMsgBiffState_NewMail,</span>
<a href="#l34.4190"></a><span id="l34.4190" class="difflineplus">+              m_pop3ConData-&gt;really_new_messages, false);</span>
<a href="#l34.4191"></a><span id="l34.4191">       }</span>
<a href="#l34.4192"></a><span id="l34.4192">       m_nsIPop3Sink-&gt;EndMailDelivery(this);</span>
<a href="#l34.4193"></a><span id="l34.4193">     }</span>
<a href="#l34.4194"></a><span id="l34.4194"> </span>
<a href="#l34.4195"></a><span id="l34.4195">     m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.4196"></a><span id="l34.4196">     return 0;</span>
<a href="#l34.4197"></a><span id="l34.4197">   }</span>
<a href="#l34.4198"></a><span id="l34.4198"> </span>
<a href="#l34.4199"></a><span id="l34.4199" class="difflineminus">-  if (m_totalDownloadSize &lt; 0)</span>
<a href="#l34.4200"></a><span id="l34.4200" class="difflineminus">-  {</span>
<a href="#l34.4201"></a><span id="l34.4201" class="difflineplus">+  if (m_totalDownloadSize &lt; 0) {</span>
<a href="#l34.4202"></a><span id="l34.4202">     /* First time.  Figure out how many bytes we're about to get.</span>
<a href="#l34.4203"></a><span id="l34.4203">     If we didn't get any message info, then we are going to get</span>
<a href="#l34.4204"></a><span id="l34.4204">     everything, and it's easy.  Otherwise, if we only want one</span>
<a href="#l34.4205"></a><span id="l34.4205">     uidl, than that's the only one we'll get.  Otherwise, go</span>
<a href="#l34.4206"></a><span id="l34.4206">     through each message info, decide if we're going to get that</span>
<a href="#l34.4207"></a><span id="l34.4207">     message, and add the number of bytes for it. When a message is too</span>
<a href="#l34.4208"></a><span id="l34.4208">     large (per user's preferences) only add the size we are supposed</span>
<a href="#l34.4209"></a><span id="l34.4209">     to get. */</span>
<a href="#l34.4210"></a><span id="l34.4210">     m_pop3ConData-&gt;really_new_messages = 0;</span>
<a href="#l34.4211"></a><span id="l34.4211">     m_pop3ConData-&gt;real_new_counter = 1;</span>
<a href="#l34.4212"></a><span id="l34.4212" class="difflineminus">-    if (m_pop3ConData-&gt;msg_info)</span>
<a href="#l34.4213"></a><span id="l34.4213" class="difflineminus">-    {</span>
<a href="#l34.4214"></a><span id="l34.4214" class="difflineplus">+    if (m_pop3ConData-&gt;msg_info) {</span>
<a href="#l34.4215"></a><span id="l34.4215">       m_totalDownloadSize = 0;</span>
<a href="#l34.4216"></a><span id="l34.4216" class="difflineminus">-      for (int32_t i = 0; i &lt; m_pop3ConData-&gt;number_of_messages; i++)</span>
<a href="#l34.4217"></a><span id="l34.4217" class="difflineminus">-      {</span>
<a href="#l34.4218"></a><span id="l34.4218" class="difflineminus">-        if (m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.4219"></a><span id="l34.4219" class="difflineminus">-        {</span>
<a href="#l34.4220"></a><span id="l34.4220" class="difflineplus">+      for (int32_t i = 0; i &lt; m_pop3ConData-&gt;number_of_messages; i++) {</span>
<a href="#l34.4221"></a><span id="l34.4221" class="difflineplus">+        if (m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.4222"></a><span id="l34.4222">           if (m_pop3ConData-&gt;msg_info[i].uidl &amp;&amp;</span>
<a href="#l34.4223"></a><span id="l34.4223" class="difflineminus">-            !PL_strcmp(m_pop3ConData-&gt;msg_info[i].uidl, m_pop3ConData-&gt;only_uidl))</span>
<a href="#l34.4224"></a><span id="l34.4224" class="difflineminus">-          {</span>
<a href="#l34.4225"></a><span id="l34.4225" class="difflineplus">+              !PL_strcmp(m_pop3ConData-&gt;msg_info[i].uidl,</span>
<a href="#l34.4226"></a><span id="l34.4226" class="difflineplus">+                         m_pop3ConData-&gt;only_uidl)) {</span>
<a href="#l34.4227"></a><span id="l34.4227">             m_totalDownloadSize = m_pop3ConData-&gt;msg_info[i].size;</span>
<a href="#l34.4228"></a><span id="l34.4228">             m_pop3ConData-&gt;really_new_messages = 1;</span>
<a href="#l34.4229"></a><span id="l34.4229">             // we are only getting one message</span>
<a href="#l34.4230"></a><span id="l34.4230">             m_pop3ConData-&gt;real_new_counter = 1;</span>
<a href="#l34.4231"></a><span id="l34.4231">             break;</span>
<a href="#l34.4232"></a><span id="l34.4232">           }</span>
<a href="#l34.4233"></a><span id="l34.4233">           continue;</span>
<a href="#l34.4234"></a><span id="l34.4234">         }</span>
<a href="#l34.4235"></a><span id="l34.4235"> </span>
<a href="#l34.4236"></a><span id="l34.4236">         char c = 0;</span>
<a href="#l34.4237"></a><span id="l34.4237">         popstateTimestamp = TimeInSecondsFromPRTime(PR_Now());</span>
<a href="#l34.4238"></a><span id="l34.4238" class="difflineminus">-        if (m_pop3ConData-&gt;msg_info[i].uidl)</span>
<a href="#l34.4239"></a><span id="l34.4239" class="difflineminus">-        {</span>
<a href="#l34.4240"></a><span id="l34.4240" class="difflineminus">-          Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) PL_HashTableLookup(m_pop3ConData-&gt;uidlinfo-&gt;hash,</span>
<a href="#l34.4241"></a><span id="l34.4241" class="difflineminus">-            m_pop3ConData-&gt;msg_info[i].uidl);</span>
<a href="#l34.4242"></a><span id="l34.4242" class="difflineminus">-          if (uidlEntry)</span>
<a href="#l34.4243"></a><span id="l34.4243" class="difflineminus">-          {</span>
<a href="#l34.4244"></a><span id="l34.4244" class="difflineplus">+        if (m_pop3ConData-&gt;msg_info[i].uidl) {</span>
<a href="#l34.4245"></a><span id="l34.4245" class="difflineplus">+          Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(</span>
<a href="#l34.4246"></a><span id="l34.4246" class="difflineplus">+              m_pop3ConData-&gt;uidlinfo-&gt;hash, m_pop3ConData-&gt;msg_info[i].uidl);</span>
<a href="#l34.4247"></a><span id="l34.4247" class="difflineplus">+          if (uidlEntry) {</span>
<a href="#l34.4248"></a><span id="l34.4248">             c = uidlEntry-&gt;status;</span>
<a href="#l34.4249"></a><span id="l34.4249">             popstateTimestamp = uidlEntry-&gt;dateReceived;</span>
<a href="#l34.4250"></a><span id="l34.4250">           }</span>
<a href="#l34.4251"></a><span id="l34.4251">         }</span>
<a href="#l34.4252"></a><span id="l34.4252" class="difflineminus">-        if ((c == KEEP) &amp;&amp; !m_pop3ConData-&gt;leave_on_server)</span>
<a href="#l34.4253"></a><span id="l34.4253" class="difflineminus">-        { /* This message has been downloaded but kept on server, we</span>
<a href="#l34.4254"></a><span id="l34.4254" class="difflineminus">-           * no longer want to keep it there */</span>
<a href="#l34.4255"></a><span id="l34.4255" class="difflineminus">-          if (!m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.4256"></a><span id="l34.4256" class="difflineminus">-          {</span>
<a href="#l34.4257"></a><span id="l34.4257" class="difflineminus">-            m_pop3ConData-&gt;newuidl = PL_NewHashTable(20, PL_HashString, PL_CompareStrings,</span>
<a href="#l34.4258"></a><span id="l34.4258" class="difflineminus">-                                              PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.4259"></a><span id="l34.4259" class="difflineminus">-            if (!m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.4260"></a><span id="l34.4260" class="difflineminus">-              return MK_OUT_OF_MEMORY;</span>
<a href="#l34.4261"></a><span id="l34.4261" class="difflineplus">+        if ((c == KEEP) &amp;&amp;</span>
<a href="#l34.4262"></a><span id="l34.4262" class="difflineplus">+            !m_pop3ConData</span>
<a href="#l34.4263"></a><span id="l34.4263" class="difflineplus">+                 -&gt;leave_on_server) { /* This message has been downloaded but</span>
<a href="#l34.4264"></a><span id="l34.4264" class="difflineplus">+                                       * kept on server, we no longer want to</span>
<a href="#l34.4265"></a><span id="l34.4265" class="difflineplus">+                                       * keep it there */</span>
<a href="#l34.4266"></a><span id="l34.4266" class="difflineplus">+          if (!m_pop3ConData-&gt;newuidl) {</span>
<a href="#l34.4267"></a><span id="l34.4267" class="difflineplus">+            m_pop3ConData-&gt;newuidl =</span>
<a href="#l34.4268"></a><span id="l34.4268" class="difflineplus">+                PL_NewHashTable(20, PL_HashString, PL_CompareStrings,</span>
<a href="#l34.4269"></a><span id="l34.4269" class="difflineplus">+                                PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.4270"></a><span id="l34.4270" class="difflineplus">+            if (!m_pop3ConData-&gt;newuidl) return MK_OUT_OF_MEMORY;</span>
<a href="#l34.4271"></a><span id="l34.4271">           }</span>
<a href="#l34.4272"></a><span id="l34.4272">           c = DELETE_CHAR;</span>
<a href="#l34.4273"></a><span id="l34.4273">           // Mark message to be deleted in new table</span>
<a href="#l34.4274"></a><span id="l34.4274" class="difflineminus">-          put_hash(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.4275"></a><span id="l34.4275" class="difflineminus">-            m_pop3ConData-&gt;msg_info[i].uidl, DELETE_CHAR, popstateTimestamp);</span>
<a href="#l34.4276"></a><span id="l34.4276" class="difflineplus">+          put_hash(m_pop3ConData-&gt;newuidl, m_pop3ConData-&gt;msg_info[i].uidl,</span>
<a href="#l34.4277"></a><span id="l34.4277" class="difflineplus">+                   DELETE_CHAR, popstateTimestamp);</span>
<a href="#l34.4278"></a><span id="l34.4278">           // and old one too</span>
<a href="#l34.4279"></a><span id="l34.4279">           put_hash(m_pop3ConData-&gt;uidlinfo-&gt;hash,</span>
<a href="#l34.4280"></a><span id="l34.4280" class="difflineminus">-            m_pop3ConData-&gt;msg_info[i].uidl, DELETE_CHAR, popstateTimestamp);</span>
<a href="#l34.4281"></a><span id="l34.4281" class="difflineplus">+                   m_pop3ConData-&gt;msg_info[i].uidl, DELETE_CHAR,</span>
<a href="#l34.4282"></a><span id="l34.4282" class="difflineplus">+                   popstateTimestamp);</span>
<a href="#l34.4283"></a><span id="l34.4283">         }</span>
<a href="#l34.4284"></a><span id="l34.4284" class="difflineminus">-        if ((c != KEEP) &amp;&amp; (c != DELETE_CHAR) &amp;&amp; (c != TOO_BIG))</span>
<a href="#l34.4285"></a><span id="l34.4285" class="difflineminus">-        { // message left on server</span>
<a href="#l34.4286"></a><span id="l34.4286" class="difflineplus">+        if ((c != KEEP) &amp;&amp; (c != DELETE_CHAR) &amp;&amp;</span>
<a href="#l34.4287"></a><span id="l34.4287" class="difflineplus">+            (c != TOO_BIG)) {  // message left on server</span>
<a href="#l34.4288"></a><span id="l34.4288">           m_totalDownloadSize += m_pop3ConData-&gt;msg_info[i].size;</span>
<a href="#l34.4289"></a><span id="l34.4289">           m_pop3ConData-&gt;really_new_messages++;</span>
<a href="#l34.4290"></a><span id="l34.4290">           // a message we will really download</span>
<a href="#l34.4291"></a><span id="l34.4291">         }</span>
<a href="#l34.4292"></a><span id="l34.4292">       }</span>
<a href="#l34.4293"></a><span id="l34.4293" class="difflineminus">-    }</span>
<a href="#l34.4294"></a><span id="l34.4294" class="difflineminus">-    else</span>
<a href="#l34.4295"></a><span id="l34.4295" class="difflineminus">-    {</span>
<a href="#l34.4296"></a><span id="l34.4296" class="difflineplus">+    } else {</span>
<a href="#l34.4297"></a><span id="l34.4297">       m_totalDownloadSize = m_totalFolderSize;</span>
<a href="#l34.4298"></a><span id="l34.4298">     }</span>
<a href="#l34.4299"></a><span id="l34.4299" class="difflineminus">-    if (m_pop3ConData-&gt;only_check_for_new_mail)</span>
<a href="#l34.4300"></a><span id="l34.4300" class="difflineminus">-    {</span>
<a href="#l34.4301"></a><span id="l34.4301" class="difflineminus">-      if (m_totalDownloadSize &gt; 0)</span>
<a href="#l34.4302"></a><span id="l34.4302" class="difflineminus">-      {</span>
<a href="#l34.4303"></a><span id="l34.4303" class="difflineplus">+    if (m_pop3ConData-&gt;only_check_for_new_mail) {</span>
<a href="#l34.4304"></a><span id="l34.4304" class="difflineplus">+      if (m_totalDownloadSize &gt; 0) {</span>
<a href="#l34.4305"></a><span id="l34.4305">         m_pop3ConData-&gt;biffstate = nsIMsgFolder::nsMsgBiffState_NewMail;</span>
<a href="#l34.4306"></a><span id="l34.4306" class="difflineminus">-        m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(nsIMsgFolder::nsMsgBiffState_NewMail, m_pop3ConData-&gt;really_new_messages, true);</span>
<a href="#l34.4307"></a><span id="l34.4307" class="difflineplus">+        m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(</span>
<a href="#l34.4308"></a><span id="l34.4308" class="difflineplus">+            nsIMsgFolder::nsMsgBiffState_NewMail,</span>
<a href="#l34.4309"></a><span id="l34.4309" class="difflineplus">+            m_pop3ConData-&gt;really_new_messages, true);</span>
<a href="#l34.4310"></a><span id="l34.4310">       }</span>
<a href="#l34.4311"></a><span id="l34.4311">       m_pop3ConData-&gt;next_state = POP3_SEND_QUIT;</span>
<a href="#l34.4312"></a><span id="l34.4312" class="difflineminus">-      return(0);</span>
<a href="#l34.4313"></a><span id="l34.4313" class="difflineplus">+      return (0);</span>
<a href="#l34.4314"></a><span id="l34.4314">     }</span>
<a href="#l34.4315"></a><span id="l34.4315">     /* get the amount of available space on the drive</span>
<a href="#l34.4316"></a><span id="l34.4316">      * and make sure there is enough</span>
<a href="#l34.4317"></a><span id="l34.4317">      */</span>
<a href="#l34.4318"></a><span id="l34.4318" class="difflineminus">-    if (m_totalDownloadSize &gt; 0) // skip all this if there aren't any messages</span>
<a href="#l34.4319"></a><span id="l34.4319" class="difflineplus">+    if (m_totalDownloadSize &gt; 0)  // skip all this if there aren't any messages</span>
<a href="#l34.4320"></a><span id="l34.4320">     {</span>
<a href="#l34.4321"></a><span id="l34.4321">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l34.4322"></a><span id="l34.4322"> </span>
<a href="#l34.4323"></a><span id="l34.4323">       // Get the current mailbox folder</span>
<a href="#l34.4324"></a><span id="l34.4324">       NS_ENSURE_TRUE(m_nsIPop3Sink, -1);</span>
<a href="#l34.4325"></a><span id="l34.4325">       nsresult rv = m_nsIPop3Sink-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l34.4326"></a><span id="l34.4326" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l34.4327"></a><span id="l34.4327" class="difflineminus">-        return -1;</span>
<a href="#l34.4328"></a><span id="l34.4328" class="difflineplus">+      if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.4329"></a><span id="l34.4329"> </span>
<a href="#l34.4330"></a><span id="l34.4330">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.4331"></a><span id="l34.4331" class="difflineminus">-      if (NS_FAILED(rv) || !mailnewsUrl)</span>
<a href="#l34.4332"></a><span id="l34.4332" class="difflineminus">-        return -1;</span>
<a href="#l34.4333"></a><span id="l34.4333" class="difflineplus">+      if (NS_FAILED(rv) || !mailnewsUrl) return -1;</span>
<a href="#l34.4334"></a><span id="l34.4334"> </span>
<a href="#l34.4335"></a><span id="l34.4335">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.4336"></a><span id="l34.4336">       (void)mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.4337"></a><span id="l34.4337"> </span>
<a href="#l34.4338"></a><span id="l34.4338">       bool spaceNotAvailable = true;</span>
<a href="#l34.4339"></a><span id="l34.4339" class="difflineminus">-      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l34.4340"></a><span id="l34.4340" class="difflineminus">-      if (NS_FAILED(rv) || !localFolder)</span>
<a href="#l34.4341"></a><span id="l34.4341" class="difflineminus">-        return -1;</span>
<a href="#l34.4342"></a><span id="l34.4342" class="difflineplus">+      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder(</span>
<a href="#l34.4343"></a><span id="l34.4343" class="difflineplus">+          do_QueryInterface(folder, &amp;rv));</span>
<a href="#l34.4344"></a><span id="l34.4344" class="difflineplus">+      if (NS_FAILED(rv) || !localFolder) return -1;</span>
<a href="#l34.4345"></a><span id="l34.4345"> </span>
<a href="#l34.4346"></a><span id="l34.4346">       // check if we have a reasonable amount of space left</span>
<a href="#l34.4347"></a><span id="l34.4347" class="difflineminus">-      rv = localFolder-&gt;WarnIfLocalFileTooBig(msgWindow, m_totalDownloadSize, &amp;spaceNotAvailable);</span>
<a href="#l34.4348"></a><span id="l34.4348" class="difflineplus">+      rv = localFolder-&gt;WarnIfLocalFileTooBig(msgWindow, m_totalDownloadSize,</span>
<a href="#l34.4349"></a><span id="l34.4349" class="difflineplus">+                                              &amp;spaceNotAvailable);</span>
<a href="#l34.4350"></a><span id="l34.4350">       if (NS_FAILED(rv) || spaceNotAvailable) {</span>
<a href="#l34.4351"></a><span id="l34.4351"> #ifdef DEBUG</span>
<a href="#l34.4352"></a><span id="l34.4352">         printf(&quot;Not enough disk space! Raising error!\n&quot;);</span>
<a href="#l34.4353"></a><span id="l34.4353"> #endif</span>
<a href="#l34.4354"></a><span id="l34.4354">         return -1;</span>
<a href="#l34.4355"></a><span id="l34.4355">       }</span>
<a href="#l34.4356"></a><span id="l34.4356"> </span>
<a href="#l34.4357"></a><span id="l34.4357">       // Here we know how many messages we're going to download, so let</span>
<a href="#l34.4358"></a><span id="l34.4358" class="difflineat">@@ -3055,1189 +2734,1100 @@ int32_t nsPop3Protocol::GetMsg()</span>
<a href="#l34.4359"></a><span id="l34.4359">       rv = m_nsIPop3Sink-&gt;SetMsgsToDownload(m_pop3ConData-&gt;really_new_messages);</span>
<a href="#l34.4360"></a><span id="l34.4360">     }</span>
<a href="#l34.4361"></a><span id="l34.4361">   }</span>
<a href="#l34.4362"></a><span id="l34.4362"> </span>
<a href="#l34.4363"></a><span id="l34.4363">   /* Look at this message, and decide whether to ignore it, get it, just get</span>
<a href="#l34.4364"></a><span id="l34.4364">   the TOP of it, or delete it. */</span>
<a href="#l34.4365"></a><span id="l34.4365"> </span>
<a href="#l34.4366"></a><span id="l34.4366">   // if this is a message we've seen for the first time, we won't find it in</span>
<a href="#l34.4367"></a><span id="l34.4367" class="difflineminus">-  // m_pop3ConData-uidlinfo-&gt;hash.  By default, we retrieve messages, unless they have a status,</span>
<a href="#l34.4368"></a><span id="l34.4368" class="difflineminus">-  // or are too big, in which case we figure out what to do.</span>
<a href="#l34.4369"></a><span id="l34.4369" class="difflineplus">+  // m_pop3ConData-uidlinfo-&gt;hash.  By default, we retrieve messages, unless</span>
<a href="#l34.4370"></a><span id="l34.4370" class="difflineplus">+  // they have a status, or are too big, in which case we figure out what to do.</span>
<a href="#l34.4371"></a><span id="l34.4371">   if (m_prefAuthMethods != POP3_HAS_AUTH_USER &amp;&amp; TestCapFlag(POP3_HAS_XSENDER))</span>
<a href="#l34.4372"></a><span id="l34.4372">     m_pop3ConData-&gt;next_state = POP3_SEND_XSENDER;</span>
<a href="#l34.4373"></a><span id="l34.4373">   else</span>
<a href="#l34.4374"></a><span id="l34.4374">     m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l34.4375"></a><span id="l34.4375">   m_pop3ConData-&gt;truncating_cur_msg = false;</span>
<a href="#l34.4376"></a><span id="l34.4376">   m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.4377"></a><span id="l34.4377" class="difflineminus">-  if (m_pop3ConData-&gt;msg_info)</span>
<a href="#l34.4378"></a><span id="l34.4378" class="difflineminus">-  {</span>
<a href="#l34.4379"></a><span id="l34.4379" class="difflineminus">-    Pop3MsgInfo* info = m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l34.4380"></a><span id="l34.4380" class="difflineminus">-    if (m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.4381"></a><span id="l34.4381" class="difflineminus">-    {</span>
<a href="#l34.4382"></a><span id="l34.4382" class="difflineplus">+  if (m_pop3ConData-&gt;msg_info) {</span>
<a href="#l34.4383"></a><span id="l34.4383" class="difflineplus">+    Pop3MsgInfo *info =</span>
<a href="#l34.4384"></a><span id="l34.4384" class="difflineplus">+        m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l34.4385"></a><span id="l34.4385" class="difflineplus">+    if (m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.4386"></a><span id="l34.4386">       if (info-&gt;uidl == NULL || PL_strcmp(info-&gt;uidl, m_pop3ConData-&gt;only_uidl))</span>
<a href="#l34.4387"></a><span id="l34.4387">         m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.4388"></a><span id="l34.4388">       else</span>
<a href="#l34.4389"></a><span id="l34.4389">         m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l34.4390"></a><span id="l34.4390" class="difflineminus">-    }</span>
<a href="#l34.4391"></a><span id="l34.4391" class="difflineminus">-    else</span>
<a href="#l34.4392"></a><span id="l34.4392" class="difflineminus">-    {</span>
<a href="#l34.4393"></a><span id="l34.4393" class="difflineplus">+    } else {</span>
<a href="#l34.4394"></a><span id="l34.4394">       char c = 0;</span>
<a href="#l34.4395"></a><span id="l34.4395" class="difflineminus">-      if (!m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.4396"></a><span id="l34.4396" class="difflineminus">-      {</span>
<a href="#l34.4397"></a><span id="l34.4397" class="difflineminus">-        m_pop3ConData-&gt;newuidl = PL_NewHashTable(20, PL_HashString, PL_CompareStrings, PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.4398"></a><span id="l34.4398" class="difflineminus">-        if (!m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.4399"></a><span id="l34.4399" class="difflineminus">-          return MK_OUT_OF_MEMORY;</span>
<a href="#l34.4400"></a><span id="l34.4400" class="difflineplus">+      if (!m_pop3ConData-&gt;newuidl) {</span>
<a href="#l34.4401"></a><span id="l34.4401" class="difflineplus">+        m_pop3ConData-&gt;newuidl =</span>
<a href="#l34.4402"></a><span id="l34.4402" class="difflineplus">+            PL_NewHashTable(20, PL_HashString, PL_CompareStrings,</span>
<a href="#l34.4403"></a><span id="l34.4403" class="difflineplus">+                            PL_CompareValues, &amp;gHashAllocOps, nullptr);</span>
<a href="#l34.4404"></a><span id="l34.4404" class="difflineplus">+        if (!m_pop3ConData-&gt;newuidl) return MK_OUT_OF_MEMORY;</span>
<a href="#l34.4405"></a><span id="l34.4405">       }</span>
<a href="#l34.4406"></a><span id="l34.4406" class="difflineminus">-      if (info-&gt;uidl)</span>
<a href="#l34.4407"></a><span id="l34.4407" class="difflineminus">-      {</span>
<a href="#l34.4408"></a><span id="l34.4408" class="difflineminus">-        Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *) PL_HashTableLookup(m_pop3ConData-&gt;uidlinfo-&gt;hash, info-&gt;uidl);</span>
<a href="#l34.4409"></a><span id="l34.4409" class="difflineminus">-        if (uidlEntry)</span>
<a href="#l34.4410"></a><span id="l34.4410" class="difflineminus">-        {</span>
<a href="#l34.4411"></a><span id="l34.4411" class="difflineplus">+      if (info-&gt;uidl) {</span>
<a href="#l34.4412"></a><span id="l34.4412" class="difflineplus">+        Pop3UidlEntry *uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(</span>
<a href="#l34.4413"></a><span id="l34.4413" class="difflineplus">+            m_pop3ConData-&gt;uidlinfo-&gt;hash, info-&gt;uidl);</span>
<a href="#l34.4414"></a><span id="l34.4414" class="difflineplus">+        if (uidlEntry) {</span>
<a href="#l34.4415"></a><span id="l34.4415">           c = uidlEntry-&gt;status;</span>
<a href="#l34.4416"></a><span id="l34.4416">           popstateTimestamp = uidlEntry-&gt;dateReceived;</span>
<a href="#l34.4417"></a><span id="l34.4417">         }</span>
<a href="#l34.4418"></a><span id="l34.4418">       }</span>
<a href="#l34.4419"></a><span id="l34.4419" class="difflineminus">-      if (c == DELETE_CHAR)</span>
<a href="#l34.4420"></a><span id="l34.4420" class="difflineminus">-      {</span>
<a href="#l34.4421"></a><span id="l34.4421" class="difflineplus">+      if (c == DELETE_CHAR) {</span>
<a href="#l34.4422"></a><span id="l34.4422">         m_pop3ConData-&gt;next_state = POP3_SEND_DELE;</span>
<a href="#l34.4423"></a><span id="l34.4423" class="difflineminus">-      }</span>
<a href="#l34.4424"></a><span id="l34.4424" class="difflineminus">-      else if (c == KEEP)</span>
<a href="#l34.4425"></a><span id="l34.4425" class="difflineminus">-      {</span>
<a href="#l34.4426"></a><span id="l34.4426" class="difflineplus">+      } else if (c == KEEP) {</span>
<a href="#l34.4427"></a><span id="l34.4427">         // this is a message we've already downloaded and left on server;</span>
<a href="#l34.4428"></a><span id="l34.4428">         // Advance to next message.</span>
<a href="#l34.4429"></a><span id="l34.4429">         m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.4430"></a><span id="l34.4430" class="difflineminus">-      }</span>
<a href="#l34.4431"></a><span id="l34.4431" class="difflineminus">-      else if (c == FETCH_BODY)</span>
<a href="#l34.4432"></a><span id="l34.4432" class="difflineminus">-      {</span>
<a href="#l34.4433"></a><span id="l34.4433" class="difflineplus">+      } else if (c == FETCH_BODY) {</span>
<a href="#l34.4434"></a><span id="l34.4434">         m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l34.4435"></a><span id="l34.4435" class="difflineminus">-        PL_HashTableRemove (m_pop3ConData-&gt;uidlinfo-&gt;hash, (void*)info-&gt;uidl);</span>
<a href="#l34.4436"></a><span id="l34.4436" class="difflineminus">-      }</span>
<a href="#l34.4437"></a><span id="l34.4437" class="difflineminus">-      else if ((c != TOO_BIG) &amp;&amp;</span>
<a href="#l34.4438"></a><span id="l34.4438" class="difflineminus">-        (TestCapFlag(POP3_TOP_UNDEFINED | POP3_HAS_TOP)) &amp;&amp;</span>
<a href="#l34.4439"></a><span id="l34.4439" class="difflineminus">-        (m_pop3ConData-&gt;headers_only ||</span>
<a href="#l34.4440"></a><span id="l34.4440" class="difflineminus">-         ((m_pop3ConData-&gt;size_limit &gt; 0) &amp;&amp;</span>
<a href="#l34.4441"></a><span id="l34.4441" class="difflineminus">-          (info-&gt;size &gt; m_pop3ConData-&gt;size_limit) &amp;&amp;</span>
<a href="#l34.4442"></a><span id="l34.4442" class="difflineminus">-          !m_pop3ConData-&gt;only_uidl)) &amp;&amp;</span>
<a href="#l34.4443"></a><span id="l34.4443" class="difflineminus">-        info-&gt;uidl &amp;&amp; *info-&gt;uidl)</span>
<a href="#l34.4444"></a><span id="l34.4444" class="difflineminus">-      {</span>
<a href="#l34.4445"></a><span id="l34.4445" class="difflineplus">+        PL_HashTableRemove(m_pop3ConData-&gt;uidlinfo-&gt;hash, (void *)info-&gt;uidl);</span>
<a href="#l34.4446"></a><span id="l34.4446" class="difflineplus">+      } else if ((c != TOO_BIG) &amp;&amp;</span>
<a href="#l34.4447"></a><span id="l34.4447" class="difflineplus">+                 (TestCapFlag(POP3_TOP_UNDEFINED | POP3_HAS_TOP)) &amp;&amp;</span>
<a href="#l34.4448"></a><span id="l34.4448" class="difflineplus">+                 (m_pop3ConData-&gt;headers_only ||</span>
<a href="#l34.4449"></a><span id="l34.4449" class="difflineplus">+                  ((m_pop3ConData-&gt;size_limit &gt; 0) &amp;&amp;</span>
<a href="#l34.4450"></a><span id="l34.4450" class="difflineplus">+                   (info-&gt;size &gt; m_pop3ConData-&gt;size_limit) &amp;&amp;</span>
<a href="#l34.4451"></a><span id="l34.4451" class="difflineplus">+                   !m_pop3ConData-&gt;only_uidl)) &amp;&amp;</span>
<a href="#l34.4452"></a><span id="l34.4452" class="difflineplus">+                 info-&gt;uidl &amp;&amp; *info-&gt;uidl) {</span>
<a href="#l34.4453"></a><span id="l34.4453">         // message is too big</span>
<a href="#l34.4454"></a><span id="l34.4454">         m_pop3ConData-&gt;truncating_cur_msg = true;</span>
<a href="#l34.4455"></a><span id="l34.4455">         m_pop3ConData-&gt;next_state = POP3_SEND_TOP;</span>
<a href="#l34.4456"></a><span id="l34.4456" class="difflineminus">-        put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, TOO_BIG, popstateTimestamp);</span>
<a href="#l34.4457"></a><span id="l34.4457" class="difflineminus">-      }</span>
<a href="#l34.4458"></a><span id="l34.4458" class="difflineminus">-      else if (c == TOO_BIG)</span>
<a href="#l34.4459"></a><span id="l34.4459" class="difflineminus">-      {</span>
<a href="#l34.4460"></a><span id="l34.4460" class="difflineplus">+        put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, TOO_BIG,</span>
<a href="#l34.4461"></a><span id="l34.4461" class="difflineplus">+                 popstateTimestamp);</span>
<a href="#l34.4462"></a><span id="l34.4462" class="difflineplus">+      } else if (c == TOO_BIG) {</span>
<a href="#l34.4463"></a><span id="l34.4463">         /* message previously left on server, see if the max download size</span>
<a href="#l34.4464"></a><span id="l34.4464">         has changed, because we may want to download the message this time</span>
<a href="#l34.4465"></a><span id="l34.4465">         around. Otherwise ignore the message, we have the header. */</span>
<a href="#l34.4466"></a><span id="l34.4466" class="difflineminus">-        if ((m_pop3ConData-&gt;size_limit &gt; 0) &amp;&amp; (info-&gt;size &lt;=</span>
<a href="#l34.4467"></a><span id="l34.4467" class="difflineminus">-          m_pop3ConData-&gt;size_limit))</span>
<a href="#l34.4468"></a><span id="l34.4468" class="difflineminus">-          PL_HashTableRemove (m_pop3ConData-&gt;uidlinfo-&gt;hash, (void*)info-&gt;uidl);</span>
<a href="#l34.4469"></a><span id="l34.4469" class="difflineplus">+        if ((m_pop3ConData-&gt;size_limit &gt; 0) &amp;&amp;</span>
<a href="#l34.4470"></a><span id="l34.4470" class="difflineplus">+            (info-&gt;size &lt;= m_pop3ConData-&gt;size_limit))</span>
<a href="#l34.4471"></a><span id="l34.4471" class="difflineplus">+          PL_HashTableRemove(m_pop3ConData-&gt;uidlinfo-&gt;hash, (void *)info-&gt;uidl);</span>
<a href="#l34.4472"></a><span id="l34.4472">         // remove from our table, and download</span>
<a href="#l34.4473"></a><span id="l34.4473" class="difflineminus">-        else</span>
<a href="#l34.4474"></a><span id="l34.4474" class="difflineminus">-        {</span>
<a href="#l34.4475"></a><span id="l34.4475" class="difflineplus">+        else {</span>
<a href="#l34.4476"></a><span id="l34.4476">           m_pop3ConData-&gt;truncating_cur_msg = true;</span>
<a href="#l34.4477"></a><span id="l34.4477">           m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.4478"></a><span id="l34.4478">           // ignore this message and get next one</span>
<a href="#l34.4479"></a><span id="l34.4479" class="difflineminus">-          put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, TOO_BIG, popstateTimestamp);</span>
<a href="#l34.4480"></a><span id="l34.4480" class="difflineplus">+          put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, TOO_BIG,</span>
<a href="#l34.4481"></a><span id="l34.4481" class="difflineplus">+                   popstateTimestamp);</span>
<a href="#l34.4482"></a><span id="l34.4482">         }</span>
<a href="#l34.4483"></a><span id="l34.4483">       }</span>
<a href="#l34.4484"></a><span id="l34.4484"> </span>
<a href="#l34.4485"></a><span id="l34.4485" class="difflineminus">-      if (m_pop3ConData-&gt;next_state != POP3_SEND_DELE &amp;&amp;</span>
<a href="#l34.4486"></a><span id="l34.4486" class="difflineminus">-          info-&gt;uidl)</span>
<a href="#l34.4487"></a><span id="l34.4487" class="difflineminus">-      {</span>
<a href="#l34.4488"></a><span id="l34.4488" class="difflineplus">+      if (m_pop3ConData-&gt;next_state != POP3_SEND_DELE &amp;&amp; info-&gt;uidl) {</span>
<a href="#l34.4489"></a><span id="l34.4489">         /* This is a message we have decided to keep on the server. Notate</span>
<a href="#l34.4490"></a><span id="l34.4490">             that now for the future. (Don't change the popstate file at all</span>
<a href="#l34.4491"></a><span id="l34.4491">             if only_uidl is set; in that case, there might be brand new messages</span>
<a href="#l34.4492"></a><span id="l34.4492">             on the server that we *don't* want to mark KEEP; we just want to</span>
<a href="#l34.4493"></a><span id="l34.4493">             leave them around until the user next does a GetNewMail.) */</span>
<a href="#l34.4494"></a><span id="l34.4494"> </span>
<a href="#l34.4495"></a><span id="l34.4495">         /* If this is a message we already know about (i.e., it was</span>
<a href="#l34.4496"></a><span id="l34.4496">             in popstate.dat already), we need to maintain the original</span>
<a href="#l34.4497"></a><span id="l34.4497">             date the message was downloaded. */</span>
<a href="#l34.4498"></a><span id="l34.4498">         if (m_pop3ConData-&gt;truncating_cur_msg)</span>
<a href="#l34.4499"></a><span id="l34.4499" class="difflineminus">-          put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, TOO_BIG, popstateTimestamp);</span>
<a href="#l34.4500"></a><span id="l34.4500" class="difflineplus">+          put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, TOO_BIG,</span>
<a href="#l34.4501"></a><span id="l34.4501" class="difflineplus">+                   popstateTimestamp);</span>
<a href="#l34.4502"></a><span id="l34.4502">         else</span>
<a href="#l34.4503"></a><span id="l34.4503">           put_hash(m_pop3ConData-&gt;newuidl, info-&gt;uidl, KEEP, popstateTimestamp);</span>
<a href="#l34.4504"></a><span id="l34.4504">       }</span>
<a href="#l34.4505"></a><span id="l34.4505">     }</span>
<a href="#l34.4506"></a><span id="l34.4506">     if (m_pop3ConData-&gt;next_state == POP3_GET_MSG)</span>
<a href="#l34.4507"></a><span id="l34.4507">       m_pop3ConData-&gt;last_accessed_msg++;</span>
<a href="#l34.4508"></a><span id="l34.4508">     // Make sure we check the next message next time!</span>
<a href="#l34.4509"></a><span id="l34.4509">   }</span>
<a href="#l34.4510"></a><span id="l34.4510">   return 0;</span>
<a href="#l34.4511"></a><span id="l34.4511"> }</span>
<a href="#l34.4512"></a><span id="l34.4512"> </span>
<a href="#l34.4513"></a><span id="l34.4513" class="difflineminus">-</span>
<a href="#l34.4514"></a><span id="l34.4514"> /* start retrieving just the first 20 lines</span>
<a href="#l34.4515"></a><span id="l34.4515">  */</span>
<a href="#l34.4516"></a><span id="l34.4516" class="difflineminus">-int32_t nsPop3Protocol::SendTop()</span>
<a href="#l34.4517"></a><span id="l34.4517" class="difflineminus">-{</span>
<a href="#l34.4518"></a><span id="l34.4518" class="difflineminus">-   char * cmd = PR_smprintf( &quot;TOP %ld %d&quot; CRLF,</span>
<a href="#l34.4519"></a><span id="l34.4519" class="difflineminus">-     m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum,</span>
<a href="#l34.4520"></a><span id="l34.4520" class="difflineminus">-     m_pop3ConData-&gt;headers_only ? 0 : 20);</span>
<a href="#l34.4521"></a><span id="l34.4521" class="difflineminus">-   int32_t status = -1;</span>
<a href="#l34.4522"></a><span id="l34.4522" class="difflineminus">-   if (cmd)</span>
<a href="#l34.4523"></a><span id="l34.4523" class="difflineminus">-   {</span>
<a href="#l34.4524"></a><span id="l34.4524" class="difflineminus">-     m_pop3ConData-&gt;next_state_after_response = POP3_TOP_RESPONSE;</span>
<a href="#l34.4525"></a><span id="l34.4525" class="difflineminus">-     m_pop3ConData-&gt;cur_msg_size = -1;</span>
<a href="#l34.4526"></a><span id="l34.4526" class="difflineminus">-</span>
<a href="#l34.4527"></a><span id="l34.4527" class="difflineminus">-     /* zero the bytes received in message in preparation for</span>
<a href="#l34.4528"></a><span id="l34.4528" class="difflineplus">+int32_t nsPop3Protocol::SendTop() {</span>
<a href="#l34.4529"></a><span id="l34.4529" class="difflineplus">+  char *cmd = PR_smprintf(</span>
<a href="#l34.4530"></a><span id="l34.4530" class="difflineplus">+      &quot;TOP %ld %d&quot; CRLF,</span>
<a href="#l34.4531"></a><span id="l34.4531" class="difflineplus">+      m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum,</span>
<a href="#l34.4532"></a><span id="l34.4532" class="difflineplus">+      m_pop3ConData-&gt;headers_only ? 0 : 20);</span>
<a href="#l34.4533"></a><span id="l34.4533" class="difflineplus">+  int32_t status = -1;</span>
<a href="#l34.4534"></a><span id="l34.4534" class="difflineplus">+  if (cmd) {</span>
<a href="#l34.4535"></a><span id="l34.4535" class="difflineplus">+    m_pop3ConData-&gt;next_state_after_response = POP3_TOP_RESPONSE;</span>
<a href="#l34.4536"></a><span id="l34.4536" class="difflineplus">+    m_pop3ConData-&gt;cur_msg_size = -1;</span>
<a href="#l34.4537"></a><span id="l34.4537" class="difflineplus">+</span>
<a href="#l34.4538"></a><span id="l34.4538" class="difflineplus">+    /* zero the bytes received in message in preparation for</span>
<a href="#l34.4539"></a><span id="l34.4539">      * the next</span>
<a href="#l34.4540"></a><span id="l34.4540">      */</span>
<a href="#l34.4541"></a><span id="l34.4541" class="difflineminus">-     m_bytesInMsgReceived = 0;</span>
<a href="#l34.4542"></a><span id="l34.4542" class="difflineminus">-     status = Pop3SendData(cmd);</span>
<a href="#l34.4543"></a><span id="l34.4543" class="difflineminus">-   }</span>
<a href="#l34.4544"></a><span id="l34.4544" class="difflineminus">-   PR_Free(cmd);</span>
<a href="#l34.4545"></a><span id="l34.4545" class="difflineminus">-   return status;</span>
<a href="#l34.4546"></a><span id="l34.4546" class="difflineplus">+    m_bytesInMsgReceived = 0;</span>
<a href="#l34.4547"></a><span id="l34.4547" class="difflineplus">+    status = Pop3SendData(cmd);</span>
<a href="#l34.4548"></a><span id="l34.4548" class="difflineplus">+  }</span>
<a href="#l34.4549"></a><span id="l34.4549" class="difflineplus">+  PR_Free(cmd);</span>
<a href="#l34.4550"></a><span id="l34.4550" class="difflineplus">+  return status;</span>
<a href="#l34.4551"></a><span id="l34.4551"> }</span>
<a href="#l34.4552"></a><span id="l34.4552"> </span>
<a href="#l34.4553"></a><span id="l34.4553"> /* send the xsender command</span>
<a href="#l34.4554"></a><span id="l34.4554">  */</span>
<a href="#l34.4555"></a><span id="l34.4555" class="difflineminus">-int32_t nsPop3Protocol::SendXsender()</span>
<a href="#l34.4556"></a><span id="l34.4556" class="difflineminus">-{</span>
<a href="#l34.4557"></a><span id="l34.4557" class="difflineminus">-  char * cmd = PR_smprintf(&quot;XSENDER %ld&quot; CRLF, m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l34.4558"></a><span id="l34.4558" class="difflineplus">+int32_t nsPop3Protocol::SendXsender() {</span>
<a href="#l34.4559"></a><span id="l34.4559" class="difflineplus">+  char *cmd = PR_smprintf(</span>
<a href="#l34.4560"></a><span id="l34.4560" class="difflineplus">+      &quot;XSENDER %ld&quot; CRLF,</span>
<a href="#l34.4561"></a><span id="l34.4561" class="difflineplus">+      m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l34.4562"></a><span id="l34.4562">   int32_t status = -1;</span>
<a href="#l34.4563"></a><span id="l34.4563" class="difflineminus">-  if (cmd)</span>
<a href="#l34.4564"></a><span id="l34.4564" class="difflineminus">-  {</span>
<a href="#l34.4565"></a><span id="l34.4565" class="difflineplus">+  if (cmd) {</span>
<a href="#l34.4566"></a><span id="l34.4566">     m_pop3ConData-&gt;next_state_after_response = POP3_XSENDER_RESPONSE;</span>
<a href="#l34.4567"></a><span id="l34.4567">     status = Pop3SendData(cmd);</span>
<a href="#l34.4568"></a><span id="l34.4568">     PR_Free(cmd);</span>
<a href="#l34.4569"></a><span id="l34.4569">   }</span>
<a href="#l34.4570"></a><span id="l34.4570">   return status;</span>
<a href="#l34.4571"></a><span id="l34.4571"> }</span>
<a href="#l34.4572"></a><span id="l34.4572"> </span>
<a href="#l34.4573"></a><span id="l34.4573" class="difflineminus">-int32_t nsPop3Protocol::XsenderResponse()</span>
<a href="#l34.4574"></a><span id="l34.4574" class="difflineminus">-{</span>
<a href="#l34.4575"></a><span id="l34.4575" class="difflineminus">-    m_pop3ConData-&gt;seenFromHeader = false;</span>
<a href="#l34.4576"></a><span id="l34.4576" class="difflineminus">-    m_senderInfo = &quot;&quot;;</span>
<a href="#l34.4577"></a><span id="l34.4577" class="difflineminus">-</span>
<a href="#l34.4578"></a><span id="l34.4578" class="difflineminus">-    if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.4579"></a><span id="l34.4579" class="difflineminus">-        if (m_commandResponse.Length() &gt; 4)</span>
<a href="#l34.4580"></a><span id="l34.4580" class="difflineminus">-            m_senderInfo = m_commandResponse;</span>
<a href="#l34.4581"></a><span id="l34.4581" class="difflineminus">-    }</span>
<a href="#l34.4582"></a><span id="l34.4582" class="difflineminus">-    else {</span>
<a href="#l34.4583"></a><span id="l34.4583" class="difflineminus">-        ClearCapFlag(POP3_HAS_XSENDER);</span>
<a href="#l34.4584"></a><span id="l34.4584" class="difflineminus">-        m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.4585"></a><span id="l34.4585" class="difflineminus">-    }</span>
<a href="#l34.4586"></a><span id="l34.4586" class="difflineminus">-</span>
<a href="#l34.4587"></a><span id="l34.4587" class="difflineminus">-    if (m_pop3ConData-&gt;truncating_cur_msg)</span>
<a href="#l34.4588"></a><span id="l34.4588" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_TOP;</span>
<a href="#l34.4589"></a><span id="l34.4589" class="difflineminus">-    else</span>
<a href="#l34.4590"></a><span id="l34.4590" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l34.4591"></a><span id="l34.4591" class="difflineminus">-    return 0;</span>
<a href="#l34.4592"></a><span id="l34.4592" class="difflineplus">+int32_t nsPop3Protocol::XsenderResponse() {</span>
<a href="#l34.4593"></a><span id="l34.4593" class="difflineplus">+  m_pop3ConData-&gt;seenFromHeader = false;</span>
<a href="#l34.4594"></a><span id="l34.4594" class="difflineplus">+  m_senderInfo = &quot;&quot;;</span>
<a href="#l34.4595"></a><span id="l34.4595" class="difflineplus">+</span>
<a href="#l34.4596"></a><span id="l34.4596" class="difflineplus">+  if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.4597"></a><span id="l34.4597" class="difflineplus">+    if (m_commandResponse.Length() &gt; 4) m_senderInfo = m_commandResponse;</span>
<a href="#l34.4598"></a><span id="l34.4598" class="difflineplus">+  } else {</span>
<a href="#l34.4599"></a><span id="l34.4599" class="difflineplus">+    ClearCapFlag(POP3_HAS_XSENDER);</span>
<a href="#l34.4600"></a><span id="l34.4600" class="difflineplus">+    m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.4601"></a><span id="l34.4601" class="difflineplus">+  }</span>
<a href="#l34.4602"></a><span id="l34.4602" class="difflineplus">+</span>
<a href="#l34.4603"></a><span id="l34.4603" class="difflineplus">+  if (m_pop3ConData-&gt;truncating_cur_msg)</span>
<a href="#l34.4604"></a><span id="l34.4604" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_TOP;</span>
<a href="#l34.4605"></a><span id="l34.4605" class="difflineplus">+  else</span>
<a href="#l34.4606"></a><span id="l34.4606" class="difflineplus">+    m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l34.4607"></a><span id="l34.4607" class="difflineplus">+  return 0;</span>
<a href="#l34.4608"></a><span id="l34.4608"> }</span>
<a href="#l34.4609"></a><span id="l34.4609"> </span>
<a href="#l34.4610"></a><span id="l34.4610"> /* retrieve the whole message</span>
<a href="#l34.4611"></a><span id="l34.4611">  */</span>
<a href="#l34.4612"></a><span id="l34.4612" class="difflineminus">-int32_t</span>
<a href="#l34.4613"></a><span id="l34.4613" class="difflineminus">-nsPop3Protocol::SendRetr()</span>
<a href="#l34.4614"></a><span id="l34.4614" class="difflineminus">-{</span>
<a href="#l34.4615"></a><span id="l34.4615" class="difflineminus">-</span>
<a href="#l34.4616"></a><span id="l34.4616" class="difflineminus">-  char * cmd = PR_smprintf(&quot;RETR %ld&quot; CRLF, m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l34.4617"></a><span id="l34.4617" class="difflineplus">+int32_t nsPop3Protocol::SendRetr() {</span>
<a href="#l34.4618"></a><span id="l34.4618" class="difflineplus">+  char *cmd = PR_smprintf(</span>
<a href="#l34.4619"></a><span id="l34.4619" class="difflineplus">+      &quot;RETR %ld&quot; CRLF,</span>
<a href="#l34.4620"></a><span id="l34.4620" class="difflineplus">+      m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l34.4621"></a><span id="l34.4621">   int32_t status = -1;</span>
<a href="#l34.4622"></a><span id="l34.4622" class="difflineminus">-  if (cmd)</span>
<a href="#l34.4623"></a><span id="l34.4623" class="difflineminus">-  {</span>
<a href="#l34.4624"></a><span id="l34.4624" class="difflineplus">+  if (cmd) {</span>
<a href="#l34.4625"></a><span id="l34.4625">     m_pop3ConData-&gt;next_state_after_response = POP3_RETR_RESPONSE;</span>
<a href="#l34.4626"></a><span id="l34.4626">     m_pop3ConData-&gt;cur_msg_size = -1;</span>
<a href="#l34.4627"></a><span id="l34.4627"> </span>
<a href="#l34.4628"></a><span id="l34.4628" class="difflineminus">-</span>
<a href="#l34.4629"></a><span id="l34.4629">     /* zero the bytes received in message in preparation for</span>
<a href="#l34.4630"></a><span id="l34.4630" class="difflineminus">-    * the next</span>
<a href="#l34.4631"></a><span id="l34.4631" class="difflineminus">-    */</span>
<a href="#l34.4632"></a><span id="l34.4632" class="difflineplus">+     * the next</span>
<a href="#l34.4633"></a><span id="l34.4633" class="difflineplus">+     */</span>
<a href="#l34.4634"></a><span id="l34.4634">     m_bytesInMsgReceived = 0;</span>
<a href="#l34.4635"></a><span id="l34.4635"> </span>
<a href="#l34.4636"></a><span id="l34.4636" class="difflineminus">-    if (m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.4637"></a><span id="l34.4637" class="difflineminus">-    {</span>
<a href="#l34.4638"></a><span id="l34.4638" class="difflineplus">+    if (m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.4639"></a><span id="l34.4639">       /* Display bytes if we're only downloading one message. */</span>
<a href="#l34.4640"></a><span id="l34.4640">       PR_ASSERT(!m_pop3ConData-&gt;graph_progress_bytes_p);</span>
<a href="#l34.4641"></a><span id="l34.4641">       UpdateProgressPercent(0, m_totalDownloadSize);</span>
<a href="#l34.4642"></a><span id="l34.4642">       m_pop3ConData-&gt;graph_progress_bytes_p = true;</span>
<a href="#l34.4643"></a><span id="l34.4643" class="difflineminus">-    }</span>
<a href="#l34.4644"></a><span id="l34.4644" class="difflineminus">-    else</span>
<a href="#l34.4645"></a><span id="l34.4645" class="difflineminus">-    {</span>
<a href="#l34.4646"></a><span id="l34.4646" class="difflineplus">+    } else {</span>
<a href="#l34.4647"></a><span id="l34.4647">       nsString finalString;</span>
<a href="#l34.4648"></a><span id="l34.4648">       mozilla::DebugOnly&lt;nsresult&gt; rv =</span>
<a href="#l34.4649"></a><span id="l34.4649" class="difflineminus">-        FormatCounterString(NS_LITERAL_STRING(&quot;receivingMessages&quot;),</span>
<a href="#l34.4650"></a><span id="l34.4650" class="difflineminus">-                            m_pop3ConData-&gt;real_new_counter,</span>
<a href="#l34.4651"></a><span id="l34.4651" class="difflineminus">-                            m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l34.4652"></a><span id="l34.4652" class="difflineminus">-                            finalString);</span>
<a href="#l34.4653"></a><span id="l34.4653" class="difflineplus">+          FormatCounterString(NS_LITERAL_STRING(&quot;receivingMessages&quot;),</span>
<a href="#l34.4654"></a><span id="l34.4654" class="difflineplus">+                              m_pop3ConData-&gt;real_new_counter,</span>
<a href="#l34.4655"></a><span id="l34.4655" class="difflineplus">+                              m_pop3ConData-&gt;really_new_messages, finalString);</span>
<a href="#l34.4656"></a><span id="l34.4656">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't format string&quot;);</span>
<a href="#l34.4657"></a><span id="l34.4657">       if (mProgressEventSink) {</span>
<a href="#l34.4658"></a><span id="l34.4658">         rv = mProgressEventSink-&gt;OnStatus(this, m_channelContext, NS_OK,</span>
<a href="#l34.4659"></a><span id="l34.4659">                                           finalString.get());</span>
<a href="#l34.4660"></a><span id="l34.4660">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;dropping error result&quot;);</span>
<a href="#l34.4661"></a><span id="l34.4661">       }</span>
<a href="#l34.4662"></a><span id="l34.4662">     }</span>
<a href="#l34.4663"></a><span id="l34.4663"> </span>
<a href="#l34.4664"></a><span id="l34.4664">     status = Pop3SendData(cmd);</span>
<a href="#l34.4665"></a><span id="l34.4665" class="difflineminus">-  } // if cmd</span>
<a href="#l34.4666"></a><span id="l34.4666" class="difflineplus">+  }  // if cmd</span>
<a href="#l34.4667"></a><span id="l34.4667">   PR_Free(cmd);</span>
<a href="#l34.4668"></a><span id="l34.4668">   return status;</span>
<a href="#l34.4669"></a><span id="l34.4669"> }</span>
<a href="#l34.4670"></a><span id="l34.4670"> </span>
<a href="#l34.4671"></a><span id="l34.4671"> /* digest the message</span>
<a href="#l34.4672"></a><span id="l34.4672">  */</span>
<a href="#l34.4673"></a><span id="l34.4673" class="difflineminus">-int32_t</span>
<a href="#l34.4674"></a><span id="l34.4674" class="difflineminus">-nsPop3Protocol::RetrResponse(nsIInputStream* inputStream,</span>
<a href="#l34.4675"></a><span id="l34.4675" class="difflineminus">-                             uint32_t length)</span>
<a href="#l34.4676"></a><span id="l34.4676" class="difflineminus">-{</span>
<a href="#l34.4677"></a><span id="l34.4677" class="difflineminus">-    uint32_t buffer_size;</span>
<a href="#l34.4678"></a><span id="l34.4678" class="difflineminus">-    int32_t flags = 0;</span>
<a href="#l34.4679"></a><span id="l34.4679" class="difflineminus">-    char *uidl = NULL;</span>
<a href="#l34.4680"></a><span id="l34.4680" class="difflineminus">-    nsresult rv;</span>
<a href="#l34.4681"></a><span id="l34.4681" class="difflineminus">-    uint32_t status = 0;</span>
<a href="#l34.4682"></a><span id="l34.4682" class="difflineminus">-</span>
<a href="#l34.4683"></a><span id="l34.4683" class="difflineminus">-    if(m_pop3ConData-&gt;cur_msg_size == -1)</span>
<a href="#l34.4684"></a><span id="l34.4684" class="difflineminus">-    {</span>
<a href="#l34.4685"></a><span id="l34.4685" class="difflineminus">-        /* this is the beginning of a message</span>
<a href="#l34.4686"></a><span id="l34.4686" class="difflineminus">-         * get the response code and byte size</span>
<a href="#l34.4687"></a><span id="l34.4687" class="difflineminus">-         */</span>
<a href="#l34.4688"></a><span id="l34.4688" class="difflineminus">-        if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.4689"></a><span id="l34.4689" class="difflineminus">-            return Error(&quot;pop3RetrFailure&quot;);</span>
<a href="#l34.4690"></a><span id="l34.4690" class="difflineminus">-</span>
<a href="#l34.4691"></a><span id="l34.4691" class="difflineminus">-        /* a successful RETR response looks like: #num_bytes Junk</span>
<a href="#l34.4692"></a><span id="l34.4692" class="difflineminus">-           from TOP we only get the +OK and data</span>
<a href="#l34.4693"></a><span id="l34.4693" class="difflineminus">-           */</span>
<a href="#l34.4694"></a><span id="l34.4694" class="difflineminus">-        if (m_pop3ConData-&gt;truncating_cur_msg)</span>
<a href="#l34.4695"></a><span id="l34.4695" class="difflineminus">-        { /* TOP, truncated message */</span>
<a href="#l34.4696"></a><span id="l34.4696" class="difflineminus">-            flags |= nsMsgMessageFlags::Partial;</span>
<a href="#l34.4697"></a><span id="l34.4697" class="difflineminus">-        }</span>
<a href="#l34.4698"></a><span id="l34.4698" class="difflineminus">-        else</span>
<a href="#l34.4699"></a><span id="l34.4699" class="difflineminus">-        {</span>
<a href="#l34.4700"></a><span id="l34.4700" class="difflineminus">-          nsCString cmdResp(m_commandResponse);</span>
<a href="#l34.4701"></a><span id="l34.4701" class="difflineminus">-          char *newStr = cmdResp.BeginWriting();</span>
<a href="#l34.4702"></a><span id="l34.4702" class="difflineminus">-          char *num = NS_strtok( &quot; &quot;, &amp;newStr);</span>
<a href="#l34.4703"></a><span id="l34.4703" class="difflineminus">-          if (num)</span>
<a href="#l34.4704"></a><span id="l34.4704" class="difflineminus">-            m_pop3ConData-&gt;cur_msg_size = atol(num);</span>
<a href="#l34.4705"></a><span id="l34.4705" class="difflineminus">-          m_commandResponse = newStr;</span>
<a href="#l34.4706"></a><span id="l34.4706" class="difflineminus">-        }</span>
<a href="#l34.4707"></a><span id="l34.4707" class="difflineminus">-</span>
<a href="#l34.4708"></a><span id="l34.4708" class="difflineminus">-        /* RETR complete message */</span>
<a href="#l34.4709"></a><span id="l34.4709" class="difflineminus">-        if (!m_senderInfo.IsEmpty())</span>
<a href="#l34.4710"></a><span id="l34.4710" class="difflineminus">-            flags |= nsMsgMessageFlags::SenderAuthed;</span>
<a href="#l34.4711"></a><span id="l34.4711" class="difflineminus">-</span>
<a href="#l34.4712"></a><span id="l34.4712" class="difflineminus">-        if(m_pop3ConData-&gt;cur_msg_size &lt;= 0)</span>
<a href="#l34.4713"></a><span id="l34.4713" class="difflineminus">-        {</span>
<a href="#l34.4714"></a><span id="l34.4714" class="difflineminus">-          if (m_pop3ConData-&gt;msg_info)</span>
<a href="#l34.4715"></a><span id="l34.4715" class="difflineminus">-            m_pop3ConData-&gt;cur_msg_size = m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].size;</span>
<a href="#l34.4716"></a><span id="l34.4716" class="difflineminus">-          else</span>
<a href="#l34.4717"></a><span id="l34.4717" class="difflineminus">-            m_pop3ConData-&gt;cur_msg_size = 0;</span>
<a href="#l34.4718"></a><span id="l34.4718" class="difflineminus">-        }</span>
<a href="#l34.4719"></a><span id="l34.4719" class="difflineminus">-</span>
<a href="#l34.4720"></a><span id="l34.4720" class="difflineminus">-        if (m_pop3ConData-&gt;msg_info &amp;&amp;</span>
<a href="#l34.4721"></a><span id="l34.4721" class="difflineminus">-            m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].uidl)</span>
<a href="#l34.4722"></a><span id="l34.4722" class="difflineminus">-            uidl = m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].uidl;</span>
<a href="#l34.4723"></a><span id="l34.4723" class="difflineminus">-</span>
<a href="#l34.4724"></a><span id="l34.4724" class="difflineminus">-        m_pop3ConData-&gt;parsed_bytes = 0;</span>
<a href="#l34.4725"></a><span id="l34.4725" class="difflineminus">-        m_pop3ConData-&gt;pop3_size = m_pop3ConData-&gt;cur_msg_size;</span>
<a href="#l34.4726"></a><span id="l34.4726" class="difflineminus">-        m_pop3ConData-&gt;assumed_end = false;</span>
<a href="#l34.4727"></a><span id="l34.4727" class="difflineminus">-</span>
<a href="#l34.4728"></a><span id="l34.4728" class="difflineminus">-        m_pop3Server-&gt;GetDotFix(&amp;m_pop3ConData-&gt;dot_fix);</span>
<a href="#l34.4729"></a><span id="l34.4729" class="difflineminus">-</span>
<a href="#l34.4730"></a><span id="l34.4730" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE,LogLevel::Info,</span>
<a href="#l34.4731"></a><span id="l34.4731" class="difflineminus">-                (POP3LOG(&quot;Opening message stream: MSG_IncorporateBegin&quot;)));</span>
<a href="#l34.4732"></a><span id="l34.4732" class="difflineminus">-</span>
<a href="#l34.4733"></a><span id="l34.4733" class="difflineminus">-        /* open the message stream so we have someplace</span>
<a href="#l34.4734"></a><span id="l34.4734" class="difflineminus">-         * to put the data</span>
<a href="#l34.4735"></a><span id="l34.4735" class="difflineminus">-         */</span>
<a href="#l34.4736"></a><span id="l34.4736" class="difflineminus">-        m_pop3ConData-&gt;real_new_counter++;</span>
<a href="#l34.4737"></a><span id="l34.4737" class="difflineminus">-        /* (rb) count only real messages being downloaded */</span>
<a href="#l34.4738"></a><span id="l34.4738" class="difflineminus">-        rv = m_nsIPop3Sink-&gt;IncorporateBegin(uidl, m_url, flags,</span>
<a href="#l34.4739"></a><span id="l34.4739" class="difflineminus">-                                        &amp;m_pop3ConData-&gt;msg_closure);</span>
<a href="#l34.4740"></a><span id="l34.4740" class="difflineminus">-</span>
<a href="#l34.4741"></a><span id="l34.4741" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;Done opening message stream!&quot;)));</span>
<a href="#l34.4742"></a><span id="l34.4742" class="difflineminus">-</span>
<a href="#l34.4743"></a><span id="l34.4743" class="difflineminus">-        if(!m_pop3ConData-&gt;msg_closure || NS_FAILED(rv))</span>
<a href="#l34.4744"></a><span id="l34.4744" class="difflineminus">-            return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.4745"></a><span id="l34.4745" class="difflineplus">+int32_t nsPop3Protocol::RetrResponse(nsIInputStream *inputStream,</span>
<a href="#l34.4746"></a><span id="l34.4746" class="difflineplus">+                                     uint32_t length) {</span>
<a href="#l34.4747"></a><span id="l34.4747" class="difflineplus">+  uint32_t buffer_size;</span>
<a href="#l34.4748"></a><span id="l34.4748" class="difflineplus">+  int32_t flags = 0;</span>
<a href="#l34.4749"></a><span id="l34.4749" class="difflineplus">+  char *uidl = NULL;</span>
<a href="#l34.4750"></a><span id="l34.4750" class="difflineplus">+  nsresult rv;</span>
<a href="#l34.4751"></a><span id="l34.4751" class="difflineplus">+  uint32_t status = 0;</span>
<a href="#l34.4752"></a><span id="l34.4752" class="difflineplus">+</span>
<a href="#l34.4753"></a><span id="l34.4753" class="difflineplus">+  if (m_pop3ConData-&gt;cur_msg_size == -1) {</span>
<a href="#l34.4754"></a><span id="l34.4754" class="difflineplus">+    /* this is the beginning of a message</span>
<a href="#l34.4755"></a><span id="l34.4755" class="difflineplus">+     * get the response code and byte size</span>
<a href="#l34.4756"></a><span id="l34.4756" class="difflineplus">+     */</span>
<a href="#l34.4757"></a><span id="l34.4757" class="difflineplus">+    if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3RetrFailure&quot;);</span>
<a href="#l34.4758"></a><span id="l34.4758" class="difflineplus">+</span>
<a href="#l34.4759"></a><span id="l34.4759" class="difflineplus">+    /* a successful RETR response looks like: #num_bytes Junk</span>
<a href="#l34.4760"></a><span id="l34.4760" class="difflineplus">+       from TOP we only get the +OK and data</span>
<a href="#l34.4761"></a><span id="l34.4761" class="difflineplus">+       */</span>
<a href="#l34.4762"></a><span id="l34.4762" class="difflineplus">+    if (m_pop3ConData-&gt;truncating_cur_msg) { /* TOP, truncated message */</span>
<a href="#l34.4763"></a><span id="l34.4763" class="difflineplus">+      flags |= nsMsgMessageFlags::Partial;</span>
<a href="#l34.4764"></a><span id="l34.4764" class="difflineplus">+    } else {</span>
<a href="#l34.4765"></a><span id="l34.4765" class="difflineplus">+      nsCString cmdResp(m_commandResponse);</span>
<a href="#l34.4766"></a><span id="l34.4766" class="difflineplus">+      char *newStr = cmdResp.BeginWriting();</span>
<a href="#l34.4767"></a><span id="l34.4767" class="difflineplus">+      char *num = NS_strtok(&quot; &quot;, &amp;newStr);</span>
<a href="#l34.4768"></a><span id="l34.4768" class="difflineplus">+      if (num) m_pop3ConData-&gt;cur_msg_size = atol(num);</span>
<a href="#l34.4769"></a><span id="l34.4769" class="difflineplus">+      m_commandResponse = newStr;</span>
<a href="#l34.4770"></a><span id="l34.4770" class="difflineplus">+    }</span>
<a href="#l34.4771"></a><span id="l34.4771" class="difflineplus">+</span>
<a href="#l34.4772"></a><span id="l34.4772" class="difflineplus">+    /* RETR complete message */</span>
<a href="#l34.4773"></a><span id="l34.4773" class="difflineplus">+    if (!m_senderInfo.IsEmpty()) flags |= nsMsgMessageFlags::SenderAuthed;</span>
<a href="#l34.4774"></a><span id="l34.4774" class="difflineplus">+</span>
<a href="#l34.4775"></a><span id="l34.4775" class="difflineplus">+    if (m_pop3ConData-&gt;cur_msg_size &lt;= 0) {</span>
<a href="#l34.4776"></a><span id="l34.4776" class="difflineplus">+      if (m_pop3ConData-&gt;msg_info)</span>
<a href="#l34.4777"></a><span id="l34.4777" class="difflineplus">+        m_pop3ConData-&gt;cur_msg_size =</span>
<a href="#l34.4778"></a><span id="l34.4778" class="difflineplus">+            m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].size;</span>
<a href="#l34.4779"></a><span id="l34.4779" class="difflineplus">+      else</span>
<a href="#l34.4780"></a><span id="l34.4780" class="difflineplus">+        m_pop3ConData-&gt;cur_msg_size = 0;</span>
<a href="#l34.4781"></a><span id="l34.4781">     }</span>
<a href="#l34.4782"></a><span id="l34.4782"> </span>
<a href="#l34.4783"></a><span id="l34.4783" class="difflineminus">-    m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.4784"></a><span id="l34.4784" class="difflineminus">-</span>
<a href="#l34.4785"></a><span id="l34.4785" class="difflineminus">-    bool pauseForMoreData = false;</span>
<a href="#l34.4786"></a><span id="l34.4786" class="difflineminus">-    char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status, pauseForMoreData, &amp;rv, true);</span>
<a href="#l34.4787"></a><span id="l34.4787" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.4788"></a><span id="l34.4788" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.4789"></a><span id="l34.4789" class="difflineminus">-      return -1;</span>
<a href="#l34.4790"></a><span id="l34.4790" class="difflineminus">-</span>
<a href="#l34.4791"></a><span id="l34.4791" class="difflineminus">-    buffer_size = status;</span>
<a href="#l34.4792"></a><span id="l34.4792" class="difflineminus">-</span>
<a href="#l34.4793"></a><span id="l34.4793" class="difflineminus">-    if (status == 0 &amp;&amp; !line)  // no bytes read in...</span>
<a href="#l34.4794"></a><span id="l34.4794" class="difflineminus">-      return (0);</span>
<a href="#l34.4795"></a><span id="l34.4795" class="difflineminus">-</span>
<a href="#l34.4796"></a><span id="l34.4796" class="difflineminus">-    if (m_pop3ConData-&gt;msg_closure) /* not done yet */</span>
<a href="#l34.4797"></a><span id="l34.4797" class="difflineminus">-    {</span>
<a href="#l34.4798"></a><span id="l34.4798" class="difflineminus">-      // buffer the line we just read in, and buffer all remaining lines in the stream</span>
<a href="#l34.4799"></a><span id="l34.4799" class="difflineminus">-      status = buffer_size;</span>
<a href="#l34.4800"></a><span id="l34.4800" class="difflineminus">-      do</span>
<a href="#l34.4801"></a><span id="l34.4801" class="difflineminus">-      {</span>
<a href="#l34.4802"></a><span id="l34.4802" class="difflineminus">-        if (m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.4803"></a><span id="l34.4803" class="difflineminus">-        {</span>
<a href="#l34.4804"></a><span id="l34.4804" class="difflineminus">-          rv = HandleLine(line, buffer_size);</span>
<a href="#l34.4805"></a><span id="l34.4805" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l34.4806"></a><span id="l34.4806" class="difflineminus">-            return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.4807"></a><span id="l34.4807" class="difflineminus">-</span>
<a href="#l34.4808"></a><span id="l34.4808" class="difflineminus">-          // buffer_size already includes MSG_LINEBREAK_LEN so</span>
<a href="#l34.4809"></a><span id="l34.4809" class="difflineminus">-          // subtract and add CRLF</span>
<a href="#l34.4810"></a><span id="l34.4810" class="difflineminus">-          // but not really sure we always had CRLF in input since</span>
<a href="#l34.4811"></a><span id="l34.4811" class="difflineminus">-          // we also treat a single LF as line ending!</span>
<a href="#l34.4812"></a><span id="l34.4812" class="difflineminus">-          m_pop3ConData-&gt;parsed_bytes += buffer_size - MSG_LINEBREAK_LEN + 2;</span>
<a href="#l34.4813"></a><span id="l34.4813" class="difflineminus">-        }</span>
<a href="#l34.4814"></a><span id="l34.4814" class="difflineminus">-</span>
<a href="#l34.4815"></a><span id="l34.4815" class="difflineminus">-        // now read in the next line</span>
<a href="#l34.4816"></a><span id="l34.4816" class="difflineminus">-        PR_Free(line);</span>
<a href="#l34.4817"></a><span id="l34.4817" class="difflineminus">-        line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, buffer_size,</span>
<a href="#l34.4818"></a><span id="l34.4818" class="difflineplus">+    if (m_pop3ConData-&gt;msg_info &amp;&amp;</span>
<a href="#l34.4819"></a><span id="l34.4819" class="difflineplus">+        m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].uidl)</span>
<a href="#l34.4820"></a><span id="l34.4820" class="difflineplus">+      uidl = m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].uidl;</span>
<a href="#l34.4821"></a><span id="l34.4821" class="difflineplus">+</span>
<a href="#l34.4822"></a><span id="l34.4822" class="difflineplus">+    m_pop3ConData-&gt;parsed_bytes = 0;</span>
<a href="#l34.4823"></a><span id="l34.4823" class="difflineplus">+    m_pop3ConData-&gt;pop3_size = m_pop3ConData-&gt;cur_msg_size;</span>
<a href="#l34.4824"></a><span id="l34.4824" class="difflineplus">+    m_pop3ConData-&gt;assumed_end = false;</span>
<a href="#l34.4825"></a><span id="l34.4825" class="difflineplus">+</span>
<a href="#l34.4826"></a><span id="l34.4826" class="difflineplus">+    m_pop3Server-&gt;GetDotFix(&amp;m_pop3ConData-&gt;dot_fix);</span>
<a href="#l34.4827"></a><span id="l34.4827" class="difflineplus">+</span>
<a href="#l34.4828"></a><span id="l34.4828" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.4829"></a><span id="l34.4829" class="difflineplus">+            (POP3LOG(&quot;Opening message stream: MSG_IncorporateBegin&quot;)));</span>
<a href="#l34.4830"></a><span id="l34.4830" class="difflineplus">+</span>
<a href="#l34.4831"></a><span id="l34.4831" class="difflineplus">+    /* open the message stream so we have someplace</span>
<a href="#l34.4832"></a><span id="l34.4832" class="difflineplus">+     * to put the data</span>
<a href="#l34.4833"></a><span id="l34.4833" class="difflineplus">+     */</span>
<a href="#l34.4834"></a><span id="l34.4834" class="difflineplus">+    m_pop3ConData-&gt;real_new_counter++;</span>
<a href="#l34.4835"></a><span id="l34.4835" class="difflineplus">+    /* (rb) count only real messages being downloaded */</span>
<a href="#l34.4836"></a><span id="l34.4836" class="difflineplus">+    rv = m_nsIPop3Sink-&gt;IncorporateBegin(uidl, m_url, flags,</span>
<a href="#l34.4837"></a><span id="l34.4837" class="difflineplus">+                                         &amp;m_pop3ConData-&gt;msg_closure);</span>
<a href="#l34.4838"></a><span id="l34.4838" class="difflineplus">+</span>
<a href="#l34.4839"></a><span id="l34.4839" class="difflineplus">+    MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.4840"></a><span id="l34.4840" class="difflineplus">+            (POP3LOG(&quot;Done opening message stream!&quot;)));</span>
<a href="#l34.4841"></a><span id="l34.4841" class="difflineplus">+</span>
<a href="#l34.4842"></a><span id="l34.4842" class="difflineplus">+    if (!m_pop3ConData-&gt;msg_closure || NS_FAILED(rv))</span>
<a href="#l34.4843"></a><span id="l34.4843" class="difflineplus">+      return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.4844"></a><span id="l34.4844" class="difflineplus">+  }</span>
<a href="#l34.4845"></a><span id="l34.4845" class="difflineplus">+</span>
<a href="#l34.4846"></a><span id="l34.4846" class="difflineplus">+  m_pop3ConData-&gt;pause_for_read = true;</span>
<a href="#l34.4847"></a><span id="l34.4847" class="difflineplus">+</span>
<a href="#l34.4848"></a><span id="l34.4848" class="difflineplus">+  bool pauseForMoreData = false;</span>
<a href="#l34.4849"></a><span id="l34.4849" class="difflineplus">+  char *line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, status,</span>
<a href="#l34.4850"></a><span id="l34.4850">                                                 pauseForMoreData, &amp;rv, true);</span>
<a href="#l34.4851"></a><span id="l34.4851" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l34.4852"></a><span id="l34.4852" class="difflineminus">-          return -1;</span>
<a href="#l34.4853"></a><span id="l34.4853" class="difflineminus">-</span>
<a href="#l34.4854"></a><span id="l34.4854" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.4855"></a><span id="l34.4855" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.4856"></a><span id="l34.4856" class="difflineplus">+  if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.4857"></a><span id="l34.4857" class="difflineplus">+</span>
<a href="#l34.4858"></a><span id="l34.4858" class="difflineplus">+  buffer_size = status;</span>
<a href="#l34.4859"></a><span id="l34.4859" class="difflineplus">+</span>
<a href="#l34.4860"></a><span id="l34.4860" class="difflineplus">+  if (status == 0 &amp;&amp; !line)  // no bytes read in...</span>
<a href="#l34.4861"></a><span id="l34.4861" class="difflineplus">+    return (0);</span>
<a href="#l34.4862"></a><span id="l34.4862" class="difflineplus">+</span>
<a href="#l34.4863"></a><span id="l34.4863" class="difflineplus">+  if (m_pop3ConData-&gt;msg_closure) /* not done yet */</span>
<a href="#l34.4864"></a><span id="l34.4864" class="difflineplus">+  {</span>
<a href="#l34.4865"></a><span id="l34.4865" class="difflineplus">+    // buffer the line we just read in, and buffer all remaining lines in the</span>
<a href="#l34.4866"></a><span id="l34.4866" class="difflineplus">+    // stream</span>
<a href="#l34.4867"></a><span id="l34.4867" class="difflineplus">+    status = buffer_size;</span>
<a href="#l34.4868"></a><span id="l34.4868" class="difflineplus">+    do {</span>
<a href="#l34.4869"></a><span id="l34.4869" class="difflineplus">+      if (m_pop3ConData-&gt;msg_closure) {</span>
<a href="#l34.4870"></a><span id="l34.4870" class="difflineplus">+        rv = HandleLine(line, buffer_size);</span>
<a href="#l34.4871"></a><span id="l34.4871" class="difflineplus">+        if (NS_FAILED(rv)) return Error(&quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.4872"></a><span id="l34.4872" class="difflineplus">+</span>
<a href="#l34.4873"></a><span id="l34.4873">         // buffer_size already includes MSG_LINEBREAK_LEN so</span>
<a href="#l34.4874"></a><span id="l34.4874">         // subtract and add CRLF</span>
<a href="#l34.4875"></a><span id="l34.4875">         // but not really sure we always had CRLF in input since</span>
<a href="#l34.4876"></a><span id="l34.4876">         // we also treat a single LF as line ending!</span>
<a href="#l34.4877"></a><span id="l34.4877" class="difflineminus">-        status += buffer_size - MSG_LINEBREAK_LEN + 2;</span>
<a href="#l34.4878"></a><span id="l34.4878" class="difflineminus">-      } while (line);</span>
<a href="#l34.4879"></a><span id="l34.4879" class="difflineminus">-    }</span>
<a href="#l34.4880"></a><span id="l34.4880" class="difflineminus">-</span>
<a href="#l34.4881"></a><span id="l34.4881" class="difflineminus">-    buffer_size = status;  // status holds # bytes we've actually buffered so far...</span>
<a href="#l34.4882"></a><span id="l34.4882" class="difflineminus">-</span>
<a href="#l34.4883"></a><span id="l34.4883" class="difflineminus">-    /* normal read. Yay! */</span>
<a href="#l34.4884"></a><span id="l34.4884" class="difflineminus">-    if ((int32_t) (m_bytesInMsgReceived + buffer_size) &gt; m_pop3ConData-&gt;cur_msg_size)</span>
<a href="#l34.4885"></a><span id="l34.4885" class="difflineminus">-        buffer_size = m_pop3ConData-&gt;cur_msg_size - m_bytesInMsgReceived;</span>
<a href="#l34.4886"></a><span id="l34.4886" class="difflineminus">-</span>
<a href="#l34.4887"></a><span id="l34.4887" class="difflineminus">-    m_bytesInMsgReceived += buffer_size;</span>
<a href="#l34.4888"></a><span id="l34.4888" class="difflineminus">-    m_totalBytesReceived += buffer_size;</span>
<a href="#l34.4889"></a><span id="l34.4889" class="difflineminus">-</span>
<a href="#l34.4890"></a><span id="l34.4890" class="difflineminus">-    // *** jefft in case of the message size that server tells us is different</span>
<a href="#l34.4891"></a><span id="l34.4891" class="difflineminus">-    // from the actual message size</span>
<a href="#l34.4892"></a><span id="l34.4892" class="difflineminus">-    if (pauseForMoreData &amp;&amp; m_pop3ConData-&gt;dot_fix &amp;&amp;</span>
<a href="#l34.4893"></a><span id="l34.4893" class="difflineminus">-        m_pop3ConData-&gt;assumed_end &amp;&amp; m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.4894"></a><span id="l34.4894" class="difflineminus">-    {</span>
<a href="#l34.4895"></a><span id="l34.4895" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.4896"></a><span id="l34.4896" class="difflineminus">-        nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.4897"></a><span id="l34.4897" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l34.4898"></a><span id="l34.4898" class="difflineminus">-          rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.4899"></a><span id="l34.4899" class="difflineminus">-        rv = m_nsIPop3Sink-&gt;IncorporateComplete(msgWindow,</span>
<a href="#l34.4900"></a><span id="l34.4900" class="difflineminus">-          m_pop3ConData-&gt;truncating_cur_msg ? m_pop3ConData-&gt;cur_msg_size : 0);</span>
<a href="#l34.4901"></a><span id="l34.4901" class="difflineminus">-</span>
<a href="#l34.4902"></a><span id="l34.4902" class="difflineminus">-        // The following was added to prevent the loss of Data when we try</span>
<a href="#l34.4903"></a><span id="l34.4903" class="difflineminus">-        // and write to somewhere we don't have write access error to (See</span>
<a href="#l34.4904"></a><span id="l34.4904" class="difflineminus">-        // bug 62480)</span>
<a href="#l34.4905"></a><span id="l34.4905" class="difflineminus">-        // (Note: This is only a temp hack until the underlying XPCOM is</span>
<a href="#l34.4906"></a><span id="l34.4906" class="difflineminus">-        // fixed to return errors)</span>
<a href="#l34.4907"></a><span id="l34.4907" class="difflineminus">-</span>
<a href="#l34.4908"></a><span id="l34.4908" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l34.4909"></a><span id="l34.4909" class="difflineminus">-            return Error((rv == NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD) ?</span>
<a href="#l34.4910"></a><span id="l34.4910" class="difflineminus">-                         &quot;pop3TmpDownloadError&quot; :</span>
<a href="#l34.4911"></a><span id="l34.4911" class="difflineminus">-                         &quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.4912"></a><span id="l34.4912" class="difflineminus">-</span>
<a href="#l34.4913"></a><span id="l34.4913" class="difflineminus">-        m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l34.4914"></a><span id="l34.4914" class="difflineplus">+        m_pop3ConData-&gt;parsed_bytes += buffer_size - MSG_LINEBREAK_LEN + 2;</span>
<a href="#l34.4915"></a><span id="l34.4915" class="difflineplus">+      }</span>
<a href="#l34.4916"></a><span id="l34.4916" class="difflineplus">+</span>
<a href="#l34.4917"></a><span id="l34.4917" class="difflineplus">+      // now read in the next line</span>
<a href="#l34.4918"></a><span id="l34.4918" class="difflineplus">+      PR_Free(line);</span>
<a href="#l34.4919"></a><span id="l34.4919" class="difflineplus">+      line = m_lineStreamBuffer-&gt;ReadNextLine(inputStream, buffer_size,</span>
<a href="#l34.4920"></a><span id="l34.4920" class="difflineplus">+                                              pauseForMoreData, &amp;rv, true);</span>
<a href="#l34.4921"></a><span id="l34.4921" class="difflineplus">+      if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.4922"></a><span id="l34.4922" class="difflineplus">+</span>
<a href="#l34.4923"></a><span id="l34.4923" class="difflineplus">+      MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;RECV: %s&quot;), line));</span>
<a href="#l34.4924"></a><span id="l34.4924" class="difflineplus">+      // buffer_size already includes MSG_LINEBREAK_LEN so</span>
<a href="#l34.4925"></a><span id="l34.4925" class="difflineplus">+      // subtract and add CRLF</span>
<a href="#l34.4926"></a><span id="l34.4926" class="difflineplus">+      // but not really sure we always had CRLF in input since</span>
<a href="#l34.4927"></a><span id="l34.4927" class="difflineplus">+      // we also treat a single LF as line ending!</span>
<a href="#l34.4928"></a><span id="l34.4928" class="difflineplus">+      status += buffer_size - MSG_LINEBREAK_LEN + 2;</span>
<a href="#l34.4929"></a><span id="l34.4929" class="difflineplus">+    } while (line);</span>
<a href="#l34.4930"></a><span id="l34.4930" class="difflineplus">+  }</span>
<a href="#l34.4931"></a><span id="l34.4931" class="difflineplus">+</span>
<a href="#l34.4932"></a><span id="l34.4932" class="difflineplus">+  buffer_size =</span>
<a href="#l34.4933"></a><span id="l34.4933" class="difflineplus">+      status;  // status holds # bytes we've actually buffered so far...</span>
<a href="#l34.4934"></a><span id="l34.4934" class="difflineplus">+</span>
<a href="#l34.4935"></a><span id="l34.4935" class="difflineplus">+  /* normal read. Yay! */</span>
<a href="#l34.4936"></a><span id="l34.4936" class="difflineplus">+  if ((int32_t)(m_bytesInMsgReceived + buffer_size) &gt;</span>
<a href="#l34.4937"></a><span id="l34.4937" class="difflineplus">+      m_pop3ConData-&gt;cur_msg_size)</span>
<a href="#l34.4938"></a><span id="l34.4938" class="difflineplus">+    buffer_size = m_pop3ConData-&gt;cur_msg_size - m_bytesInMsgReceived;</span>
<a href="#l34.4939"></a><span id="l34.4939" class="difflineplus">+</span>
<a href="#l34.4940"></a><span id="l34.4940" class="difflineplus">+  m_bytesInMsgReceived += buffer_size;</span>
<a href="#l34.4941"></a><span id="l34.4941" class="difflineplus">+  m_totalBytesReceived += buffer_size;</span>
<a href="#l34.4942"></a><span id="l34.4942" class="difflineplus">+</span>
<a href="#l34.4943"></a><span id="l34.4943" class="difflineplus">+  // *** jefft in case of the message size that server tells us is different</span>
<a href="#l34.4944"></a><span id="l34.4944" class="difflineplus">+  // from the actual message size</span>
<a href="#l34.4945"></a><span id="l34.4945" class="difflineplus">+  if (pauseForMoreData &amp;&amp; m_pop3ConData-&gt;dot_fix &amp;&amp;</span>
<a href="#l34.4946"></a><span id="l34.4946" class="difflineplus">+      m_pop3ConData-&gt;assumed_end &amp;&amp; m_pop3ConData-&gt;msg_closure) {</span>
<a href="#l34.4947"></a><span id="l34.4947" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.4948"></a><span id="l34.4948" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.4949"></a><span id="l34.4949" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l34.4950"></a><span id="l34.4950" class="difflineplus">+      rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.4951"></a><span id="l34.4951" class="difflineplus">+    rv = m_nsIPop3Sink-&gt;IncorporateComplete(</span>
<a href="#l34.4952"></a><span id="l34.4952" class="difflineplus">+        msgWindow,</span>
<a href="#l34.4953"></a><span id="l34.4953" class="difflineplus">+        m_pop3ConData-&gt;truncating_cur_msg ? m_pop3ConData-&gt;cur_msg_size : 0);</span>
<a href="#l34.4954"></a><span id="l34.4954" class="difflineplus">+</span>
<a href="#l34.4955"></a><span id="l34.4955" class="difflineplus">+    // The following was added to prevent the loss of Data when we try</span>
<a href="#l34.4956"></a><span id="l34.4956" class="difflineplus">+    // and write to somewhere we don't have write access error to (See</span>
<a href="#l34.4957"></a><span id="l34.4957" class="difflineplus">+    // bug 62480)</span>
<a href="#l34.4958"></a><span id="l34.4958" class="difflineplus">+    // (Note: This is only a temp hack until the underlying XPCOM is</span>
<a href="#l34.4959"></a><span id="l34.4959" class="difflineplus">+    // fixed to return errors)</span>
<a href="#l34.4960"></a><span id="l34.4960" class="difflineplus">+</span>
<a href="#l34.4961"></a><span id="l34.4961" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l34.4962"></a><span id="l34.4962" class="difflineplus">+      return Error((rv == NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD)</span>
<a href="#l34.4963"></a><span id="l34.4963" class="difflineplus">+                       ? &quot;pop3TmpDownloadError&quot;</span>
<a href="#l34.4964"></a><span id="l34.4964" class="difflineplus">+                       : &quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.4965"></a><span id="l34.4965" class="difflineplus">+</span>
<a href="#l34.4966"></a><span id="l34.4966" class="difflineplus">+    m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l34.4967"></a><span id="l34.4967" class="difflineplus">+  }</span>
<a href="#l34.4968"></a><span id="l34.4968" class="difflineplus">+</span>
<a href="#l34.4969"></a><span id="l34.4969" class="difflineplus">+  if (!m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.4970"></a><span id="l34.4970" class="difflineplus">+  /* meaning _handle_line read &quot;.\r\n&quot; at end-of-msg */</span>
<a href="#l34.4971"></a><span id="l34.4971" class="difflineplus">+  {</span>
<a href="#l34.4972"></a><span id="l34.4972" class="difflineplus">+    m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.4973"></a><span id="l34.4973" class="difflineplus">+</span>
<a href="#l34.4974"></a><span id="l34.4974" class="difflineplus">+    if (m_pop3ConData-&gt;truncating_cur_msg || m_pop3ConData-&gt;leave_on_server) {</span>
<a href="#l34.4975"></a><span id="l34.4975" class="difflineplus">+      Pop3UidlEntry *uidlEntry = NULL;</span>
<a href="#l34.4976"></a><span id="l34.4976" class="difflineplus">+      Pop3MsgInfo *info =</span>
<a href="#l34.4977"></a><span id="l34.4977" class="difflineplus">+          m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l34.4978"></a><span id="l34.4978" class="difflineplus">+</span>
<a href="#l34.4979"></a><span id="l34.4979" class="difflineplus">+      /* Check for filter actions - FETCH or DELETE */</span>
<a href="#l34.4980"></a><span id="l34.4980" class="difflineplus">+      if ((m_pop3ConData-&gt;newuidl) &amp;&amp; (info-&gt;uidl))</span>
<a href="#l34.4981"></a><span id="l34.4981" class="difflineplus">+        uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.4982"></a><span id="l34.4982" class="difflineplus">+                                                        info-&gt;uidl);</span>
<a href="#l34.4983"></a><span id="l34.4983" class="difflineplus">+</span>
<a href="#l34.4984"></a><span id="l34.4984" class="difflineplus">+      if (uidlEntry &amp;&amp; uidlEntry-&gt;status == FETCH_BODY &amp;&amp;</span>
<a href="#l34.4985"></a><span id="l34.4985" class="difflineplus">+          m_pop3ConData-&gt;truncating_cur_msg) {</span>
<a href="#l34.4986"></a><span id="l34.4986" class="difflineplus">+        /* A filter decided to retrieve this full msg.</span>
<a href="#l34.4987"></a><span id="l34.4987" class="difflineplus">+           Use GetMsg() so the popstate will update correctly,</span>
<a href="#l34.4988"></a><span id="l34.4988" class="difflineplus">+           but don't let this msg get counted twice. */</span>
<a href="#l34.4989"></a><span id="l34.4989" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.4990"></a><span id="l34.4990" class="difflineplus">+        m_pop3ConData-&gt;real_new_counter--;</span>
<a href="#l34.4991"></a><span id="l34.4991" class="difflineplus">+        /* Make sure we don't try to come through here again. */</span>
<a href="#l34.4992"></a><span id="l34.4992" class="difflineplus">+        PL_HashTableRemove(m_pop3ConData-&gt;newuidl, (void *)info-&gt;uidl);</span>
<a href="#l34.4993"></a><span id="l34.4993" class="difflineplus">+        put_hash(m_pop3ConData-&gt;uidlinfo-&gt;hash, info-&gt;uidl, FETCH_BODY,</span>
<a href="#l34.4994"></a><span id="l34.4994" class="difflineplus">+                 uidlEntry-&gt;dateReceived);</span>
<a href="#l34.4995"></a><span id="l34.4995" class="difflineplus">+</span>
<a href="#l34.4996"></a><span id="l34.4996" class="difflineplus">+      } else if (uidlEntry &amp;&amp; uidlEntry-&gt;status == DELETE_CHAR) {</span>
<a href="#l34.4997"></a><span id="l34.4997" class="difflineplus">+        // A filter decided to delete this msg from the server</span>
<a href="#l34.4998"></a><span id="l34.4998" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_SEND_DELE;</span>
<a href="#l34.4999"></a><span id="l34.4999" class="difflineplus">+      } else {</span>
<a href="#l34.5000"></a><span id="l34.5000" class="difflineplus">+        /* We've retrieved all or part of this message, but we want to</span>
<a href="#l34.5001"></a><span id="l34.5001" class="difflineplus">+           keep it on the server.  Go on to the next message. */</span>
<a href="#l34.5002"></a><span id="l34.5002" class="difflineplus">+        m_pop3ConData-&gt;last_accessed_msg++;</span>
<a href="#l34.5003"></a><span id="l34.5003" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.5004"></a><span id="l34.5004" class="difflineplus">+      }</span>
<a href="#l34.5005"></a><span id="l34.5005" class="difflineplus">+      if (m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.5006"></a><span id="l34.5006" class="difflineplus">+        /* GetMsg didn't update this field. Do it now */</span>
<a href="#l34.5007"></a><span id="l34.5007" class="difflineplus">+        uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(</span>
<a href="#l34.5008"></a><span id="l34.5008" class="difflineplus">+            m_pop3ConData-&gt;uidlinfo-&gt;hash, m_pop3ConData-&gt;only_uidl);</span>
<a href="#l34.5009"></a><span id="l34.5009" class="difflineplus">+        NS_ASSERTION(uidlEntry, &quot;uidl not found in uidlinfo&quot;);</span>
<a href="#l34.5010"></a><span id="l34.5010" class="difflineplus">+        if (uidlEntry)</span>
<a href="#l34.5011"></a><span id="l34.5011" class="difflineplus">+          put_hash(m_pop3ConData-&gt;uidlinfo-&gt;hash, m_pop3ConData-&gt;only_uidl,</span>
<a href="#l34.5012"></a><span id="l34.5012" class="difflineplus">+                   KEEP, uidlEntry-&gt;dateReceived);</span>
<a href="#l34.5013"></a><span id="l34.5013" class="difflineplus">+      }</span>
<a href="#l34.5014"></a><span id="l34.5014" class="difflineplus">+    } else {</span>
<a href="#l34.5015"></a><span id="l34.5015" class="difflineplus">+      m_pop3ConData-&gt;next_state = POP3_SEND_DELE;</span>
<a href="#l34.5016"></a><span id="l34.5016">     }</span>
<a href="#l34.5017"></a><span id="l34.5017"> </span>
<a href="#l34.5018"></a><span id="l34.5018" class="difflineminus">-    if (!m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.5019"></a><span id="l34.5019" class="difflineminus">-        /* meaning _handle_line read &quot;.\r\n&quot; at end-of-msg */</span>
<a href="#l34.5020"></a><span id="l34.5020" class="difflineminus">-    {</span>
<a href="#l34.5021"></a><span id="l34.5021" class="difflineminus">-        m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.5022"></a><span id="l34.5022" class="difflineminus">-</span>
<a href="#l34.5023"></a><span id="l34.5023" class="difflineminus">-        if (m_pop3ConData-&gt;truncating_cur_msg ||</span>
<a href="#l34.5024"></a><span id="l34.5024" class="difflineminus">-            m_pop3ConData-&gt;leave_on_server )</span>
<a href="#l34.5025"></a><span id="l34.5025" class="difflineminus">-        {</span>
<a href="#l34.5026"></a><span id="l34.5026" class="difflineminus">-            Pop3UidlEntry *uidlEntry = NULL;</span>
<a href="#l34.5027"></a><span id="l34.5027" class="difflineminus">-            Pop3MsgInfo* info = m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l34.5028"></a><span id="l34.5028" class="difflineminus">-</span>
<a href="#l34.5029"></a><span id="l34.5029" class="difflineminus">-            /* Check for filter actions - FETCH or DELETE */</span>
<a href="#l34.5030"></a><span id="l34.5030" class="difflineminus">-            if ((m_pop3ConData-&gt;newuidl) &amp;&amp; (info-&gt;uidl))</span>
<a href="#l34.5031"></a><span id="l34.5031" class="difflineminus">-              uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(m_pop3ConData-&gt;newuidl, info-&gt;uidl);</span>
<a href="#l34.5032"></a><span id="l34.5032" class="difflineminus">-</span>
<a href="#l34.5033"></a><span id="l34.5033" class="difflineminus">-            if (uidlEntry &amp;&amp; uidlEntry-&gt;status == FETCH_BODY &amp;&amp;</span>
<a href="#l34.5034"></a><span id="l34.5034" class="difflineminus">-                m_pop3ConData-&gt;truncating_cur_msg)</span>
<a href="#l34.5035"></a><span id="l34.5035" class="difflineminus">-            {</span>
<a href="#l34.5036"></a><span id="l34.5036" class="difflineminus">-            /* A filter decided to retrieve this full msg.</span>
<a href="#l34.5037"></a><span id="l34.5037" class="difflineminus">-               Use GetMsg() so the popstate will update correctly,</span>
<a href="#l34.5038"></a><span id="l34.5038" class="difflineminus">-               but don't let this msg get counted twice. */</span>
<a href="#l34.5039"></a><span id="l34.5039" class="difflineminus">-               m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.5040"></a><span id="l34.5040" class="difflineminus">-               m_pop3ConData-&gt;real_new_counter--;</span>
<a href="#l34.5041"></a><span id="l34.5041" class="difflineminus">-            /* Make sure we don't try to come through here again. */</span>
<a href="#l34.5042"></a><span id="l34.5042" class="difflineminus">-               PL_HashTableRemove (m_pop3ConData-&gt;newuidl, (void*)info-&gt;uidl);</span>
<a href="#l34.5043"></a><span id="l34.5043" class="difflineminus">-               put_hash(m_pop3ConData-&gt;uidlinfo-&gt;hash, info-&gt;uidl, FETCH_BODY, uidlEntry-&gt;dateReceived);</span>
<a href="#l34.5044"></a><span id="l34.5044" class="difflineminus">-</span>
<a href="#l34.5045"></a><span id="l34.5045" class="difflineminus">-            } else if (uidlEntry &amp;&amp; uidlEntry-&gt;status == DELETE_CHAR)</span>
<a href="#l34.5046"></a><span id="l34.5046" class="difflineminus">-            {</span>
<a href="#l34.5047"></a><span id="l34.5047" class="difflineminus">-            // A filter decided to delete this msg from the server</span>
<a href="#l34.5048"></a><span id="l34.5048" class="difflineminus">-               m_pop3ConData-&gt;next_state = POP3_SEND_DELE;</span>
<a href="#l34.5049"></a><span id="l34.5049" class="difflineminus">-            } else</span>
<a href="#l34.5050"></a><span id="l34.5050" class="difflineminus">-            {</span>
<a href="#l34.5051"></a><span id="l34.5051" class="difflineminus">-            /* We've retrieved all or part of this message, but we want to</span>
<a href="#l34.5052"></a><span id="l34.5052" class="difflineminus">-               keep it on the server.  Go on to the next message. */</span>
<a href="#l34.5053"></a><span id="l34.5053" class="difflineminus">-               m_pop3ConData-&gt;last_accessed_msg++;</span>
<a href="#l34.5054"></a><span id="l34.5054" class="difflineminus">-               m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.5055"></a><span id="l34.5055" class="difflineminus">-            }</span>
<a href="#l34.5056"></a><span id="l34.5056" class="difflineminus">-            if (m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.5057"></a><span id="l34.5057" class="difflineminus">-            {</span>
<a href="#l34.5058"></a><span id="l34.5058" class="difflineminus">-            /* GetMsg didn't update this field. Do it now */</span>
<a href="#l34.5059"></a><span id="l34.5059" class="difflineminus">-              uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(m_pop3ConData-&gt;uidlinfo-&gt;hash, m_pop3ConData-&gt;only_uidl);</span>
<a href="#l34.5060"></a><span id="l34.5060" class="difflineminus">-              NS_ASSERTION(uidlEntry, &quot;uidl not found in uidlinfo&quot;);</span>
<a href="#l34.5061"></a><span id="l34.5061" class="difflineminus">-              if (uidlEntry)</span>
<a href="#l34.5062"></a><span id="l34.5062" class="difflineminus">-                put_hash(m_pop3ConData-&gt;uidlinfo-&gt;hash, m_pop3ConData-&gt;only_uidl, KEEP, uidlEntry-&gt;dateReceived);</span>
<a href="#l34.5063"></a><span id="l34.5063" class="difflineminus">-            }</span>
<a href="#l34.5064"></a><span id="l34.5064" class="difflineminus">-        }</span>
<a href="#l34.5065"></a><span id="l34.5065" class="difflineminus">-        else</span>
<a href="#l34.5066"></a><span id="l34.5066" class="difflineminus">-        {</span>
<a href="#l34.5067"></a><span id="l34.5067" class="difflineminus">-           m_pop3ConData-&gt;next_state = POP3_SEND_DELE;</span>
<a href="#l34.5068"></a><span id="l34.5068" class="difflineminus">-        }</span>
<a href="#l34.5069"></a><span id="l34.5069" class="difflineminus">-</span>
<a href="#l34.5070"></a><span id="l34.5070" class="difflineminus">-        /* if we didn't get the whole message add the bytes that we didn't get</span>
<a href="#l34.5071"></a><span id="l34.5071" class="difflineminus">-           to the bytes received part so that the progress percent stays sane.</span>
<a href="#l34.5072"></a><span id="l34.5072" class="difflineminus">-           */</span>
<a href="#l34.5073"></a><span id="l34.5073" class="difflineminus">-        if (m_bytesInMsgReceived &lt; m_pop3ConData-&gt;cur_msg_size)</span>
<a href="#l34.5074"></a><span id="l34.5074" class="difflineminus">-          m_totalBytesReceived += (m_pop3ConData-&gt;cur_msg_size -</span>
<a href="#l34.5075"></a><span id="l34.5075" class="difflineminus">-                                   m_bytesInMsgReceived);</span>
<a href="#l34.5076"></a><span id="l34.5076" class="difflineminus">-    }</span>
<a href="#l34.5077"></a><span id="l34.5077" class="difflineminus">-</span>
<a href="#l34.5078"></a><span id="l34.5078" class="difflineminus">-    /* set percent done to portion of total bytes of all messages</span>
<a href="#l34.5079"></a><span id="l34.5079" class="difflineminus">-       that we're going to download. */</span>
<a href="#l34.5080"></a><span id="l34.5080" class="difflineminus">-    if (m_totalDownloadSize)</span>
<a href="#l34.5081"></a><span id="l34.5081" class="difflineminus">-      UpdateProgressPercent(m_totalBytesReceived, m_totalDownloadSize);</span>
<a href="#l34.5082"></a><span id="l34.5082" class="difflineminus">-</span>
<a href="#l34.5083"></a><span id="l34.5083" class="difflineminus">-    PR_Free(line);</span>
<a href="#l34.5084"></a><span id="l34.5084" class="difflineminus">-    return(0);</span>
<a href="#l34.5085"></a><span id="l34.5085" class="difflineplus">+    /* if we didn't get the whole message add the bytes that we didn't get</span>
<a href="#l34.5086"></a><span id="l34.5086" class="difflineplus">+       to the bytes received part so that the progress percent stays sane.</span>
<a href="#l34.5087"></a><span id="l34.5087" class="difflineplus">+       */</span>
<a href="#l34.5088"></a><span id="l34.5088" class="difflineplus">+    if (m_bytesInMsgReceived &lt; m_pop3ConData-&gt;cur_msg_size)</span>
<a href="#l34.5089"></a><span id="l34.5089" class="difflineplus">+      m_totalBytesReceived +=</span>
<a href="#l34.5090"></a><span id="l34.5090" class="difflineplus">+          (m_pop3ConData-&gt;cur_msg_size - m_bytesInMsgReceived);</span>
<a href="#l34.5091"></a><span id="l34.5091" class="difflineplus">+  }</span>
<a href="#l34.5092"></a><span id="l34.5092" class="difflineplus">+</span>
<a href="#l34.5093"></a><span id="l34.5093" class="difflineplus">+  /* set percent done to portion of total bytes of all messages</span>
<a href="#l34.5094"></a><span id="l34.5094" class="difflineplus">+     that we're going to download. */</span>
<a href="#l34.5095"></a><span id="l34.5095" class="difflineplus">+  if (m_totalDownloadSize)</span>
<a href="#l34.5096"></a><span id="l34.5096" class="difflineplus">+    UpdateProgressPercent(m_totalBytesReceived, m_totalDownloadSize);</span>
<a href="#l34.5097"></a><span id="l34.5097" class="difflineplus">+</span>
<a href="#l34.5098"></a><span id="l34.5098" class="difflineplus">+  PR_Free(line);</span>
<a href="#l34.5099"></a><span id="l34.5099" class="difflineplus">+  return (0);</span>
<a href="#l34.5100"></a><span id="l34.5100"> }</span>
<a href="#l34.5101"></a><span id="l34.5101"> </span>
<a href="#l34.5102"></a><span id="l34.5102" class="difflineminus">-</span>
<a href="#l34.5103"></a><span id="l34.5103" class="difflineminus">-int32_t</span>
<a href="#l34.5104"></a><span id="l34.5104" class="difflineminus">-nsPop3Protocol::TopResponse(nsIInputStream* inputStream, uint32_t length)</span>
<a href="#l34.5105"></a><span id="l34.5105" class="difflineminus">-{</span>
<a href="#l34.5106"></a><span id="l34.5106" class="difflineminus">-  if (TestCapFlag(POP3_TOP_UNDEFINED))</span>
<a href="#l34.5107"></a><span id="l34.5107" class="difflineminus">-  {</span>
<a href="#l34.5108"></a><span id="l34.5108" class="difflineplus">+int32_t nsPop3Protocol::TopResponse(nsIInputStream *inputStream,</span>
<a href="#l34.5109"></a><span id="l34.5109" class="difflineplus">+                                    uint32_t length) {</span>
<a href="#l34.5110"></a><span id="l34.5110" class="difflineplus">+  if (TestCapFlag(POP3_TOP_UNDEFINED)) {</span>
<a href="#l34.5111"></a><span id="l34.5111">     ClearCapFlag(POP3_TOP_UNDEFINED);</span>
<a href="#l34.5112"></a><span id="l34.5112">     if (m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.5113"></a><span id="l34.5113">       SetCapFlag(POP3_HAS_TOP);</span>
<a href="#l34.5114"></a><span id="l34.5114">     else</span>
<a href="#l34.5115"></a><span id="l34.5115">       ClearCapFlag(POP3_HAS_TOP);</span>
<a href="#l34.5116"></a><span id="l34.5116">     m_pop3Server-&gt;SetPop3CapabilityFlags(m_pop3ConData-&gt;capability_flags);</span>
<a href="#l34.5117"></a><span id="l34.5117">   }</span>
<a href="#l34.5118"></a><span id="l34.5118"> </span>
<a href="#l34.5119"></a><span id="l34.5119" class="difflineminus">-  if(m_pop3ConData-&gt;cur_msg_size == -1 &amp;&amp;  /* first line after TOP command sent */</span>
<a href="#l34.5120"></a><span id="l34.5120" class="difflineminus">-    !m_pop3ConData-&gt;command_succeeded)  /* and TOP command failed */</span>
<a href="#l34.5121"></a><span id="l34.5121" class="difflineplus">+  if (m_pop3ConData-&gt;cur_msg_size ==</span>
<a href="#l34.5122"></a><span id="l34.5122" class="difflineplus">+          -1 &amp;&amp;                          /* first line after TOP command sent */</span>
<a href="#l34.5123"></a><span id="l34.5123" class="difflineplus">+      !m_pop3ConData-&gt;command_succeeded) /* and TOP command failed */</span>
<a href="#l34.5124"></a><span id="l34.5124">   {</span>
<a href="#l34.5125"></a><span id="l34.5125" class="difflineminus">-  /* TOP doesn't work so we can't retrieve the first part of this msg.</span>
<a href="#l34.5126"></a><span id="l34.5126" class="difflineminus">-  So just go download the whole thing, and warn the user.</span>
<a href="#l34.5127"></a><span id="l34.5127" class="difflineminus">-</span>
<a href="#l34.5128"></a><span id="l34.5128" class="difflineminus">-    Note that the progress bar will not be accurate in this case.</span>
<a href="#l34.5129"></a><span id="l34.5129" class="difflineminus">-    Oops. #### */</span>
<a href="#l34.5130"></a><span id="l34.5130" class="difflineplus">+    /* TOP doesn't work so we can't retrieve the first part of this msg.</span>
<a href="#l34.5131"></a><span id="l34.5131" class="difflineplus">+    So just go download the whole thing, and warn the user.</span>
<a href="#l34.5132"></a><span id="l34.5132" class="difflineplus">+</span>
<a href="#l34.5133"></a><span id="l34.5133" class="difflineplus">+      Note that the progress bar will not be accurate in this case.</span>
<a href="#l34.5134"></a><span id="l34.5134" class="difflineplus">+      Oops. #### */</span>
<a href="#l34.5135"></a><span id="l34.5135">     m_pop3ConData-&gt;truncating_cur_msg = false;</span>
<a href="#l34.5136"></a><span id="l34.5136"> </span>
<a href="#l34.5137"></a><span id="l34.5137">     nsString statusTemplate;</span>
<a href="#l34.5138"></a><span id="l34.5138" class="difflineminus">-    mLocalBundle-&gt;GetStringFromName(</span>
<a href="#l34.5139"></a><span id="l34.5139" class="difflineminus">-      &quot;pop3ServerDoesNotSupportTopCommand&quot;,</span>
<a href="#l34.5140"></a><span id="l34.5140" class="difflineminus">-      statusTemplate);</span>
<a href="#l34.5141"></a><span id="l34.5141" class="difflineminus">-    if (!statusTemplate.IsEmpty())</span>
<a href="#l34.5142"></a><span id="l34.5142" class="difflineminus">-    {</span>
<a href="#l34.5143"></a><span id="l34.5143" class="difflineplus">+    mLocalBundle-&gt;GetStringFromName(&quot;pop3ServerDoesNotSupportTopCommand&quot;,</span>
<a href="#l34.5144"></a><span id="l34.5144" class="difflineplus">+                                    statusTemplate);</span>
<a href="#l34.5145"></a><span id="l34.5145" class="difflineplus">+    if (!statusTemplate.IsEmpty()) {</span>
<a href="#l34.5146"></a><span id="l34.5146">       nsAutoCString hostName;</span>
<a href="#l34.5147"></a><span id="l34.5147">       nsString statusString;</span>
<a href="#l34.5148"></a><span id="l34.5148">       m_url-&gt;GetHost(hostName);</span>
<a href="#l34.5149"></a><span id="l34.5149"> </span>
<a href="#l34.5150"></a><span id="l34.5150">       nsTextFormatter::ssprintf(statusString, statusTemplate.get(),</span>
<a href="#l34.5151"></a><span id="l34.5151">                                 hostName.get());</span>
<a href="#l34.5152"></a><span id="l34.5152">       UpdateStatusWithString(statusString.get());</span>
<a href="#l34.5153"></a><span id="l34.5153">     }</span>
<a href="#l34.5154"></a><span id="l34.5154"> </span>
<a href="#l34.5155"></a><span id="l34.5155">     if (m_prefAuthMethods != POP3_HAS_AUTH_USER &amp;&amp;</span>
<a href="#l34.5156"></a><span id="l34.5156">         TestCapFlag(POP3_HAS_XSENDER))</span>
<a href="#l34.5157"></a><span id="l34.5157">       m_pop3ConData-&gt;next_state = POP3_SEND_XSENDER;</span>
<a href="#l34.5158"></a><span id="l34.5158">     else</span>
<a href="#l34.5159"></a><span id="l34.5159">       m_pop3ConData-&gt;next_state = POP3_SEND_RETR;</span>
<a href="#l34.5160"></a><span id="l34.5160" class="difflineminus">-    return(0);</span>
<a href="#l34.5161"></a><span id="l34.5161" class="difflineplus">+    return (0);</span>
<a href="#l34.5162"></a><span id="l34.5162">   }</span>
<a href="#l34.5163"></a><span id="l34.5163"> </span>
<a href="#l34.5164"></a><span id="l34.5164">   /* If TOP works, we handle it in the same way as RETR. */</span>
<a href="#l34.5165"></a><span id="l34.5165">   return RetrResponse(inputStream, length);</span>
<a href="#l34.5166"></a><span id="l34.5166"> }</span>
<a href="#l34.5167"></a><span id="l34.5167"> </span>
<a href="#l34.5168"></a><span id="l34.5168"> /* line is handed over as null-terminated string with MSG_LINEBREAK */</span>
<a href="#l34.5169"></a><span id="l34.5169" class="difflineminus">-nsresult</span>
<a href="#l34.5170"></a><span id="l34.5170" class="difflineminus">-nsPop3Protocol::HandleLine(char *line, uint32_t line_length)</span>
<a href="#l34.5171"></a><span id="l34.5171" class="difflineminus">-{</span>
<a href="#l34.5172"></a><span id="l34.5172" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l34.5173"></a><span id="l34.5173" class="difflineminus">-</span>
<a href="#l34.5174"></a><span id="l34.5174" class="difflineminus">-    NS_ASSERTION(m_pop3ConData-&gt;msg_closure, &quot;m_pop3ConData-&gt;msg_closure is null in nsPop3Protocol::HandleLine()&quot;);</span>
<a href="#l34.5175"></a><span id="l34.5175" class="difflineminus">-    if (!m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.5176"></a><span id="l34.5176" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.5177"></a><span id="l34.5177" class="difflineminus">-</span>
<a href="#l34.5178"></a><span id="l34.5178" class="difflineminus">-    if (!m_senderInfo.IsEmpty() &amp;&amp; !m_pop3ConData-&gt;seenFromHeader)</span>
<a href="#l34.5179"></a><span id="l34.5179" class="difflineminus">-    {</span>
<a href="#l34.5180"></a><span id="l34.5180" class="difflineminus">-        if (line_length &gt; 6 &amp;&amp; !PL_strncasecmp(&quot;From: &quot;, line, 6))</span>
<a href="#l34.5181"></a><span id="l34.5181" class="difflineminus">-        {</span>
<a href="#l34.5182"></a><span id="l34.5182" class="difflineminus">-            m_pop3ConData-&gt;seenFromHeader = true;</span>
<a href="#l34.5183"></a><span id="l34.5183" class="difflineminus">-            if (PL_strstr(line, m_senderInfo.get()) == NULL)</span>
<a href="#l34.5184"></a><span id="l34.5184" class="difflineminus">-                m_nsIPop3Sink-&gt;SetSenderAuthedFlag(m_pop3ConData-&gt;msg_closure,</span>
<a href="#l34.5185"></a><span id="l34.5185" class="difflineminus">-                                                     false);</span>
<a href="#l34.5186"></a><span id="l34.5186" class="difflineminus">-        }</span>
<a href="#l34.5187"></a><span id="l34.5187" class="difflineplus">+nsresult nsPop3Protocol::HandleLine(char *line, uint32_t line_length) {</span>
<a href="#l34.5188"></a><span id="l34.5188" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l34.5189"></a><span id="l34.5189" class="difflineplus">+</span>
<a href="#l34.5190"></a><span id="l34.5190" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l34.5191"></a><span id="l34.5191" class="difflineplus">+      m_pop3ConData-&gt;msg_closure,</span>
<a href="#l34.5192"></a><span id="l34.5192" class="difflineplus">+      &quot;m_pop3ConData-&gt;msg_closure is null in nsPop3Protocol::HandleLine()&quot;);</span>
<a href="#l34.5193"></a><span id="l34.5193" class="difflineplus">+  if (!m_pop3ConData-&gt;msg_closure) return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.5194"></a><span id="l34.5194" class="difflineplus">+</span>
<a href="#l34.5195"></a><span id="l34.5195" class="difflineplus">+  if (!m_senderInfo.IsEmpty() &amp;&amp; !m_pop3ConData-&gt;seenFromHeader) {</span>
<a href="#l34.5196"></a><span id="l34.5196" class="difflineplus">+    if (line_length &gt; 6 &amp;&amp; !PL_strncasecmp(&quot;From: &quot;, line, 6)) {</span>
<a href="#l34.5197"></a><span id="l34.5197" class="difflineplus">+      m_pop3ConData-&gt;seenFromHeader = true;</span>
<a href="#l34.5198"></a><span id="l34.5198" class="difflineplus">+      if (PL_strstr(line, m_senderInfo.get()) == NULL)</span>
<a href="#l34.5199"></a><span id="l34.5199" class="difflineplus">+        m_nsIPop3Sink-&gt;SetSenderAuthedFlag(m_pop3ConData-&gt;msg_closure, false);</span>
<a href="#l34.5200"></a><span id="l34.5200">     }</span>
<a href="#l34.5201"></a><span id="l34.5201" class="difflineminus">-</span>
<a href="#l34.5202"></a><span id="l34.5202" class="difflineminus">-    // line contains only a single dot and linebreak -&gt; message end</span>
<a href="#l34.5203"></a><span id="l34.5203" class="difflineminus">-    if (line_length == 1 + MSG_LINEBREAK_LEN &amp;&amp; line[0] == '.')</span>
<a href="#l34.5204"></a><span id="l34.5204" class="difflineminus">-    {</span>
<a href="#l34.5205"></a><span id="l34.5205" class="difflineminus">-        m_pop3ConData-&gt;assumed_end = true;  /* in case byte count from server is */</span>
<a href="#l34.5206"></a><span id="l34.5206" class="difflineminus">-                                    /* wrong, mark we may have had the end */</span>
<a href="#l34.5207"></a><span id="l34.5207" class="difflineminus">-        if (!m_pop3ConData-&gt;dot_fix || m_pop3ConData-&gt;truncating_cur_msg ||</span>
<a href="#l34.5208"></a><span id="l34.5208" class="difflineminus">-            (m_pop3ConData-&gt;parsed_bytes &gt;= (m_pop3ConData-&gt;pop3_size -3)))</span>
<a href="#l34.5209"></a><span id="l34.5209" class="difflineminus">-        {</span>
<a href="#l34.5210"></a><span id="l34.5210" class="difflineminus">-            nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.5211"></a><span id="l34.5211" class="difflineminus">-            nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.5212"></a><span id="l34.5212" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l34.5213"></a><span id="l34.5213" class="difflineminus">-              rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.5214"></a><span id="l34.5214" class="difflineminus">-            rv = m_nsIPop3Sink-&gt;IncorporateComplete(msgWindow,</span>
<a href="#l34.5215"></a><span id="l34.5215" class="difflineminus">-              m_pop3ConData-&gt;truncating_cur_msg ? m_pop3ConData-&gt;cur_msg_size : 0);</span>
<a href="#l34.5216"></a><span id="l34.5216" class="difflineminus">-</span>
<a href="#l34.5217"></a><span id="l34.5217" class="difflineminus">-            // The following was added to prevent the loss of Data when we try</span>
<a href="#l34.5218"></a><span id="l34.5218" class="difflineminus">-            // and write to somewhere we don't have write access error to (See</span>
<a href="#l34.5219"></a><span id="l34.5219" class="difflineminus">-            // bug 62480)</span>
<a href="#l34.5220"></a><span id="l34.5220" class="difflineminus">-            // (Note: This is only a temp hack until the underlying XPCOM is</span>
<a href="#l34.5221"></a><span id="l34.5221" class="difflineminus">-            // fixed to return errors)</span>
<a href="#l34.5222"></a><span id="l34.5222" class="difflineminus">-</span>
<a href="#l34.5223"></a><span id="l34.5223" class="difflineminus">-            if (NS_FAILED(rv)) {</span>
<a href="#l34.5224"></a><span id="l34.5224" class="difflineminus">-              Error((rv == NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD) ?</span>
<a href="#l34.5225"></a><span id="l34.5225" class="difflineminus">-                    &quot;pop3TmpDownloadError&quot; :</span>
<a href="#l34.5226"></a><span id="l34.5226" class="difflineminus">-                    &quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.5227"></a><span id="l34.5227" class="difflineminus">-              return rv;</span>
<a href="#l34.5228"></a><span id="l34.5228" class="difflineminus">-            }</span>
<a href="#l34.5229"></a><span id="l34.5229" class="difflineminus">-</span>
<a href="#l34.5230"></a><span id="l34.5230" class="difflineminus">-            m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l34.5231"></a><span id="l34.5231" class="difflineminus">-            return rv;</span>
<a href="#l34.5232"></a><span id="l34.5232" class="difflineminus">-        }</span>
<a href="#l34.5233"></a><span id="l34.5233" class="difflineplus">+  }</span>
<a href="#l34.5234"></a><span id="l34.5234" class="difflineplus">+</span>
<a href="#l34.5235"></a><span id="l34.5235" class="difflineplus">+  // line contains only a single dot and linebreak -&gt; message end</span>
<a href="#l34.5236"></a><span id="l34.5236" class="difflineplus">+  if (line_length == 1 + MSG_LINEBREAK_LEN &amp;&amp; line[0] == '.') {</span>
<a href="#l34.5237"></a><span id="l34.5237" class="difflineplus">+    m_pop3ConData-&gt;assumed_end = true; /* in case byte count from server is */</span>
<a href="#l34.5238"></a><span id="l34.5238" class="difflineplus">+                                       /* wrong, mark we may have had the end */</span>
<a href="#l34.5239"></a><span id="l34.5239" class="difflineplus">+    if (!m_pop3ConData-&gt;dot_fix || m_pop3ConData-&gt;truncating_cur_msg ||</span>
<a href="#l34.5240"></a><span id="l34.5240" class="difflineplus">+        (m_pop3ConData-&gt;parsed_bytes &gt;= (m_pop3ConData-&gt;pop3_size - 3))) {</span>
<a href="#l34.5241"></a><span id="l34.5241" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l34.5242"></a><span id="l34.5242" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.5243"></a><span id="l34.5243" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l34.5244"></a><span id="l34.5244" class="difflineplus">+        rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.5245"></a><span id="l34.5245" class="difflineplus">+      rv = m_nsIPop3Sink-&gt;IncorporateComplete(</span>
<a href="#l34.5246"></a><span id="l34.5246" class="difflineplus">+          msgWindow,</span>
<a href="#l34.5247"></a><span id="l34.5247" class="difflineplus">+          m_pop3ConData-&gt;truncating_cur_msg ? m_pop3ConData-&gt;cur_msg_size : 0);</span>
<a href="#l34.5248"></a><span id="l34.5248" class="difflineplus">+</span>
<a href="#l34.5249"></a><span id="l34.5249" class="difflineplus">+      // The following was added to prevent the loss of Data when we try</span>
<a href="#l34.5250"></a><span id="l34.5250" class="difflineplus">+      // and write to somewhere we don't have write access error to (See</span>
<a href="#l34.5251"></a><span id="l34.5251" class="difflineplus">+      // bug 62480)</span>
<a href="#l34.5252"></a><span id="l34.5252" class="difflineplus">+      // (Note: This is only a temp hack until the underlying XPCOM is</span>
<a href="#l34.5253"></a><span id="l34.5253" class="difflineplus">+      // fixed to return errors)</span>
<a href="#l34.5254"></a><span id="l34.5254" class="difflineplus">+</span>
<a href="#l34.5255"></a><span id="l34.5255" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l34.5256"></a><span id="l34.5256" class="difflineplus">+        Error((rv == NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD)</span>
<a href="#l34.5257"></a><span id="l34.5257" class="difflineplus">+                  ? &quot;pop3TmpDownloadError&quot;</span>
<a href="#l34.5258"></a><span id="l34.5258" class="difflineplus">+                  : &quot;pop3MessageWriteError&quot;);</span>
<a href="#l34.5259"></a><span id="l34.5259" class="difflineplus">+        return rv;</span>
<a href="#l34.5260"></a><span id="l34.5260" class="difflineplus">+      }</span>
<a href="#l34.5261"></a><span id="l34.5261" class="difflineplus">+</span>
<a href="#l34.5262"></a><span id="l34.5262" class="difflineplus">+      m_pop3ConData-&gt;msg_closure = nullptr;</span>
<a href="#l34.5263"></a><span id="l34.5263" class="difflineplus">+      return rv;</span>
<a href="#l34.5264"></a><span id="l34.5264">     }</span>
<a href="#l34.5265"></a><span id="l34.5265" class="difflineminus">-    /* Check if the line begins with the termination octet. If so</span>
<a href="#l34.5266"></a><span id="l34.5266" class="difflineminus">-       and if another termination octet follows, we step over the</span>
<a href="#l34.5267"></a><span id="l34.5267" class="difflineminus">-       first occurrence of it. */</span>
<a href="#l34.5268"></a><span id="l34.5268" class="difflineminus">-    else if (line_length &gt; 1 &amp;&amp; line[0] == '.' &amp;&amp; line[1] == '.') {</span>
<a href="#l34.5269"></a><span id="l34.5269" class="difflineminus">-        line++;</span>
<a href="#l34.5270"></a><span id="l34.5270" class="difflineminus">-        line_length--;</span>
<a href="#l34.5271"></a><span id="l34.5271" class="difflineminus">-</span>
<a href="#l34.5272"></a><span id="l34.5272" class="difflineminus">-    }</span>
<a href="#l34.5273"></a><span id="l34.5273" class="difflineminus">-</span>
<a href="#l34.5274"></a><span id="l34.5274" class="difflineminus">-    return m_nsIPop3Sink-&gt;IncorporateWrite(line, line_length);</span>
<a href="#l34.5275"></a><span id="l34.5275" class="difflineplus">+  }</span>
<a href="#l34.5276"></a><span id="l34.5276" class="difflineplus">+  /* Check if the line begins with the termination octet. If so</span>
<a href="#l34.5277"></a><span id="l34.5277" class="difflineplus">+     and if another termination octet follows, we step over the</span>
<a href="#l34.5278"></a><span id="l34.5278" class="difflineplus">+     first occurrence of it. */</span>
<a href="#l34.5279"></a><span id="l34.5279" class="difflineplus">+  else if (line_length &gt; 1 &amp;&amp; line[0] == '.' &amp;&amp; line[1] == '.') {</span>
<a href="#l34.5280"></a><span id="l34.5280" class="difflineplus">+    line++;</span>
<a href="#l34.5281"></a><span id="l34.5281" class="difflineplus">+    line_length--;</span>
<a href="#l34.5282"></a><span id="l34.5282" class="difflineplus">+  }</span>
<a href="#l34.5283"></a><span id="l34.5283" class="difflineplus">+</span>
<a href="#l34.5284"></a><span id="l34.5284" class="difflineplus">+  return m_nsIPop3Sink-&gt;IncorporateWrite(line, line_length);</span>
<a href="#l34.5285"></a><span id="l34.5285"> }</span>
<a href="#l34.5286"></a><span id="l34.5286"> </span>
<a href="#l34.5287"></a><span id="l34.5287" class="difflineminus">-int32_t nsPop3Protocol::SendDele()</span>
<a href="#l34.5288"></a><span id="l34.5288" class="difflineminus">-{</span>
<a href="#l34.5289"></a><span id="l34.5289" class="difflineminus">-    /* increment the last accessed message since we have now read it</span>
<a href="#l34.5290"></a><span id="l34.5290" class="difflineminus">-     */</span>
<a href="#l34.5291"></a><span id="l34.5291" class="difflineminus">-    char * cmd = PR_smprintf(&quot;DELE %ld&quot; CRLF, m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l34.5292"></a><span id="l34.5292" class="difflineminus">-    m_pop3ConData-&gt;last_accessed_msg++;</span>
<a href="#l34.5293"></a><span id="l34.5293" class="difflineminus">-    int32_t status = -1;</span>
<a href="#l34.5294"></a><span id="l34.5294" class="difflineminus">-    if (cmd)</span>
<a href="#l34.5295"></a><span id="l34.5295" class="difflineminus">-    {</span>
<a href="#l34.5296"></a><span id="l34.5296" class="difflineminus">-      m_pop3ConData-&gt;next_state_after_response = POP3_DELE_RESPONSE;</span>
<a href="#l34.5297"></a><span id="l34.5297" class="difflineminus">-      status = Pop3SendData(cmd);</span>
<a href="#l34.5298"></a><span id="l34.5298" class="difflineminus">-    }</span>
<a href="#l34.5299"></a><span id="l34.5299" class="difflineminus">-    PR_Free(cmd);</span>
<a href="#l34.5300"></a><span id="l34.5300" class="difflineminus">-    return status;</span>
<a href="#l34.5301"></a><span id="l34.5301" class="difflineplus">+int32_t nsPop3Protocol::SendDele() {</span>
<a href="#l34.5302"></a><span id="l34.5302" class="difflineplus">+  /* increment the last accessed message since we have now read it</span>
<a href="#l34.5303"></a><span id="l34.5303" class="difflineplus">+   */</span>
<a href="#l34.5304"></a><span id="l34.5304" class="difflineplus">+  char *cmd = PR_smprintf(</span>
<a href="#l34.5305"></a><span id="l34.5305" class="difflineplus">+      &quot;DELE %ld&quot; CRLF,</span>
<a href="#l34.5306"></a><span id="l34.5306" class="difflineplus">+      m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg].msgnum);</span>
<a href="#l34.5307"></a><span id="l34.5307" class="difflineplus">+  m_pop3ConData-&gt;last_accessed_msg++;</span>
<a href="#l34.5308"></a><span id="l34.5308" class="difflineplus">+  int32_t status = -1;</span>
<a href="#l34.5309"></a><span id="l34.5309" class="difflineplus">+  if (cmd) {</span>
<a href="#l34.5310"></a><span id="l34.5310" class="difflineplus">+    m_pop3ConData-&gt;next_state_after_response = POP3_DELE_RESPONSE;</span>
<a href="#l34.5311"></a><span id="l34.5311" class="difflineplus">+    status = Pop3SendData(cmd);</span>
<a href="#l34.5312"></a><span id="l34.5312" class="difflineplus">+  }</span>
<a href="#l34.5313"></a><span id="l34.5313" class="difflineplus">+  PR_Free(cmd);</span>
<a href="#l34.5314"></a><span id="l34.5314" class="difflineplus">+  return status;</span>
<a href="#l34.5315"></a><span id="l34.5315"> }</span>
<a href="#l34.5316"></a><span id="l34.5316"> </span>
<a href="#l34.5317"></a><span id="l34.5317" class="difflineminus">-int32_t nsPop3Protocol::DeleResponse()</span>
<a href="#l34.5318"></a><span id="l34.5318" class="difflineminus">-{</span>
<a href="#l34.5319"></a><span id="l34.5319" class="difflineplus">+int32_t nsPop3Protocol::DeleResponse() {</span>
<a href="#l34.5320"></a><span id="l34.5320">   Pop3UidlHost *host = NULL;</span>
<a href="#l34.5321"></a><span id="l34.5321"> </span>
<a href="#l34.5322"></a><span id="l34.5322">   host = m_pop3ConData-&gt;uidlinfo;</span>
<a href="#l34.5323"></a><span id="l34.5323"> </span>
<a href="#l34.5324"></a><span id="l34.5324">   /* the return from the delete will come here</span>
<a href="#l34.5325"></a><span id="l34.5325" class="difflineminus">-  */</span>
<a href="#l34.5326"></a><span id="l34.5326" class="difflineminus">-  if(!m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.5327"></a><span id="l34.5327" class="difflineminus">-    return Error(&quot;pop3DeleFailure&quot;);</span>
<a href="#l34.5328"></a><span id="l34.5328" class="difflineminus">-</span>
<a href="#l34.5329"></a><span id="l34.5329" class="difflineplus">+   */</span>
<a href="#l34.5330"></a><span id="l34.5330" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) return Error(&quot;pop3DeleFailure&quot;);</span>
<a href="#l34.5331"></a><span id="l34.5331"> </span>
<a href="#l34.5332"></a><span id="l34.5332">   /*  ###chrisf</span>
<a href="#l34.5333"></a><span id="l34.5333">   the delete succeeded.  Write out state so that we</span>
<a href="#l34.5334"></a><span id="l34.5334">   keep track of all the deletes which have not yet been</span>
<a href="#l34.5335"></a><span id="l34.5335">   committed on the server.  Flush this state upon successful</span>
<a href="#l34.5336"></a><span id="l34.5336">   QUIT.</span>
<a href="#l34.5337"></a><span id="l34.5337"> </span>
<a href="#l34.5338"></a><span id="l34.5338">   We will do this by adding each successfully deleted message id</span>
<a href="#l34.5339"></a><span id="l34.5339">   to a list which we will write out to popstate.dat in</span>
<a href="#l34.5340"></a><span id="l34.5340">   net_pop3_write_state().</span>
<a href="#l34.5341"></a><span id="l34.5341">   */</span>
<a href="#l34.5342"></a><span id="l34.5342" class="difflineminus">-  if (host)</span>
<a href="#l34.5343"></a><span id="l34.5343" class="difflineminus">-  {</span>
<a href="#l34.5344"></a><span id="l34.5344" class="difflineplus">+  if (host) {</span>
<a href="#l34.5345"></a><span id="l34.5345">     if (m_pop3ConData-&gt;msg_info &amp;&amp;</span>
<a href="#l34.5346"></a><span id="l34.5346" class="difflineminus">-      m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg-1].uidl)</span>
<a href="#l34.5347"></a><span id="l34.5347" class="difflineminus">-    {</span>
<a href="#l34.5348"></a><span id="l34.5348" class="difflineplus">+        m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg - 1].uidl) {</span>
<a href="#l34.5349"></a><span id="l34.5349">       if (m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.5350"></a><span id="l34.5350" class="difflineminus">-        if (m_pop3ConData-&gt;leave_on_server)</span>
<a href="#l34.5351"></a><span id="l34.5351" class="difflineminus">-        {</span>
<a href="#l34.5352"></a><span id="l34.5352" class="difflineminus">-          PL_HashTableRemove(m_pop3ConData-&gt;newuidl, (void*)</span>
<a href="#l34.5353"></a><span id="l34.5353" class="difflineminus">-            m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg-1].uidl);</span>
<a href="#l34.5354"></a><span id="l34.5354" class="difflineminus">-        }</span>
<a href="#l34.5355"></a><span id="l34.5355" class="difflineminus">-        else</span>
<a href="#l34.5356"></a><span id="l34.5356" class="difflineminus">-        {</span>
<a href="#l34.5357"></a><span id="l34.5357" class="difflineplus">+        if (m_pop3ConData-&gt;leave_on_server) {</span>
<a href="#l34.5358"></a><span id="l34.5358" class="difflineplus">+          PL_HashTableRemove(</span>
<a href="#l34.5359"></a><span id="l34.5359" class="difflineplus">+              m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.5360"></a><span id="l34.5360" class="difflineplus">+              (void *)m_pop3ConData</span>
<a href="#l34.5361"></a><span id="l34.5361" class="difflineplus">+                  -&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg - 1]</span>
<a href="#l34.5362"></a><span id="l34.5362" class="difflineplus">+                  .uidl);</span>
<a href="#l34.5363"></a><span id="l34.5363" class="difflineplus">+        } else {</span>
<a href="#l34.5364"></a><span id="l34.5364">           put_hash(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.5365"></a><span id="l34.5365" class="difflineminus">-            m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg-1].uidl, DELETE_CHAR, 0);</span>
<a href="#l34.5366"></a><span id="l34.5366" class="difflineplus">+                   m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg - 1]</span>
<a href="#l34.5367"></a><span id="l34.5367" class="difflineplus">+                       .uidl,</span>
<a href="#l34.5368"></a><span id="l34.5368" class="difflineplus">+                   DELETE_CHAR, 0);</span>
<a href="#l34.5369"></a><span id="l34.5369">           /* kill message in new hash table */</span>
<a href="#l34.5370"></a><span id="l34.5370">         }</span>
<a href="#l34.5371"></a><span id="l34.5371">       else</span>
<a href="#l34.5372"></a><span id="l34.5372">         PL_HashTableRemove(host-&gt;hash,</span>
<a href="#l34.5373"></a><span id="l34.5373" class="difflineminus">-            (void*) m_pop3ConData-&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg-1].uidl);</span>
<a href="#l34.5374"></a><span id="l34.5374" class="difflineplus">+                           (void *)m_pop3ConData</span>
<a href="#l34.5375"></a><span id="l34.5375" class="difflineplus">+                               -&gt;msg_info[m_pop3ConData-&gt;last_accessed_msg - 1]</span>
<a href="#l34.5376"></a><span id="l34.5376" class="difflineplus">+                               .uidl);</span>
<a href="#l34.5377"></a><span id="l34.5377">     }</span>
<a href="#l34.5378"></a><span id="l34.5378">   }</span>
<a href="#l34.5379"></a><span id="l34.5379"> </span>
<a href="#l34.5380"></a><span id="l34.5380">   m_pop3ConData-&gt;next_state = POP3_GET_MSG;</span>
<a href="#l34.5381"></a><span id="l34.5381">   m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.5382"></a><span id="l34.5382"> </span>
<a href="#l34.5383"></a><span id="l34.5383" class="difflineminus">-  return(0);</span>
<a href="#l34.5384"></a><span id="l34.5384" class="difflineplus">+  return (0);</span>
<a href="#l34.5385"></a><span id="l34.5385"> }</span>
<a href="#l34.5386"></a><span id="l34.5386"> </span>
<a href="#l34.5387"></a><span id="l34.5387" class="difflineminus">-</span>
<a href="#l34.5388"></a><span id="l34.5388" class="difflineminus">-int32_t</span>
<a href="#l34.5389"></a><span id="l34.5389" class="difflineminus">-nsPop3Protocol::CommitState(bool remove_last_entry)</span>
<a href="#l34.5390"></a><span id="l34.5390" class="difflineminus">-{</span>
<a href="#l34.5391"></a><span id="l34.5391" class="difflineplus">+int32_t nsPop3Protocol::CommitState(bool remove_last_entry) {</span>
<a href="#l34.5392"></a><span id="l34.5392">   // only use newuidl if we successfully finished looping through all the</span>
<a href="#l34.5393"></a><span id="l34.5393">   // messages in the inbox.</span>
<a href="#l34.5394"></a><span id="l34.5394" class="difflineminus">-  if (m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.5395"></a><span id="l34.5395" class="difflineminus">-  {</span>
<a href="#l34.5396"></a><span id="l34.5396" class="difflineminus">-    if (m_pop3ConData-&gt;last_accessed_msg &gt;= m_pop3ConData-&gt;number_of_messages)</span>
<a href="#l34.5397"></a><span id="l34.5397" class="difflineminus">-    {</span>
<a href="#l34.5398"></a><span id="l34.5398" class="difflineplus">+  if (m_pop3ConData-&gt;newuidl) {</span>
<a href="#l34.5399"></a><span id="l34.5399" class="difflineplus">+    if (m_pop3ConData-&gt;last_accessed_msg &gt;= m_pop3ConData-&gt;number_of_messages) {</span>
<a href="#l34.5400"></a><span id="l34.5400">       PL_HashTableDestroy(m_pop3ConData-&gt;uidlinfo-&gt;hash);</span>
<a href="#l34.5401"></a><span id="l34.5401">       m_pop3ConData-&gt;uidlinfo-&gt;hash = m_pop3ConData-&gt;newuidl;</span>
<a href="#l34.5402"></a><span id="l34.5402">       m_pop3ConData-&gt;newuidl = nullptr;</span>
<a href="#l34.5403"></a><span id="l34.5403" class="difflineminus">-    }</span>
<a href="#l34.5404"></a><span id="l34.5404" class="difflineminus">-    else</span>
<a href="#l34.5405"></a><span id="l34.5405" class="difflineminus">-    {</span>
<a href="#l34.5406"></a><span id="l34.5406" class="difflineplus">+    } else {</span>
<a href="#l34.5407"></a><span id="l34.5407">       /* If we are leaving messages on the server, pull out the last</span>
<a href="#l34.5408"></a><span id="l34.5408">         uidl from the hash, because it might have been put in there before</span>
<a href="#l34.5409"></a><span id="l34.5409">         we got it into the database.</span>
<a href="#l34.5410"></a><span id="l34.5410">       */</span>
<a href="#l34.5411"></a><span id="l34.5411">       if (remove_last_entry &amp;&amp; m_pop3ConData-&gt;msg_info &amp;&amp;</span>
<a href="#l34.5412"></a><span id="l34.5412" class="difflineminus">-          !m_pop3ConData-&gt;only_uidl &amp;&amp; m_pop3ConData-&gt;newuidl-&gt;nentries &gt; 0)</span>
<a href="#l34.5413"></a><span id="l34.5413" class="difflineminus">-      {</span>
<a href="#l34.5414"></a><span id="l34.5414" class="difflineminus">-        Pop3MsgInfo* info = m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l34.5415"></a><span id="l34.5415" class="difflineminus">-        if (info &amp;&amp; info-&gt;uidl)</span>
<a href="#l34.5416"></a><span id="l34.5416" class="difflineminus">-        {</span>
<a href="#l34.5417"></a><span id="l34.5417" class="difflineminus">-          mozilla::DebugOnly&lt;bool&gt; val = PL_HashTableRemove(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.5418"></a><span id="l34.5418" class="difflineminus">-                                                            info-&gt;uidl);</span>
<a href="#l34.5419"></a><span id="l34.5419" class="difflineplus">+          !m_pop3ConData-&gt;only_uidl &amp;&amp; m_pop3ConData-&gt;newuidl-&gt;nentries &gt; 0) {</span>
<a href="#l34.5420"></a><span id="l34.5420" class="difflineplus">+        Pop3MsgInfo *info =</span>
<a href="#l34.5421"></a><span id="l34.5421" class="difflineplus">+            m_pop3ConData-&gt;msg_info + m_pop3ConData-&gt;last_accessed_msg;</span>
<a href="#l34.5422"></a><span id="l34.5422" class="difflineplus">+        if (info &amp;&amp; info-&gt;uidl) {</span>
<a href="#l34.5423"></a><span id="l34.5423" class="difflineplus">+          mozilla::DebugOnly&lt;bool&gt; val =</span>
<a href="#l34.5424"></a><span id="l34.5424" class="difflineplus">+              PL_HashTableRemove(m_pop3ConData-&gt;newuidl, info-&gt;uidl);</span>
<a href="#l34.5425"></a><span id="l34.5425">           NS_ASSERTION(val, &quot;uidl not in hash table&quot;);</span>
<a href="#l34.5426"></a><span id="l34.5426">         }</span>
<a href="#l34.5427"></a><span id="l34.5427">       }</span>
<a href="#l34.5428"></a><span id="l34.5428"> </span>
<a href="#l34.5429"></a><span id="l34.5429">       // Add the entries in newuidl to m_pop3ConData-&gt;uidlinfo-&gt;hash to keep</span>
<a href="#l34.5430"></a><span id="l34.5430">       // track of the messages we *did* download in this session.</span>
<a href="#l34.5431"></a><span id="l34.5431" class="difflineminus">-      PL_HashTableEnumerateEntries(m_pop3ConData-&gt;newuidl, net_pop3_copy_hash_entries, (void *)m_pop3ConData-&gt;uidlinfo-&gt;hash);</span>
<a href="#l34.5432"></a><span id="l34.5432" class="difflineplus">+      PL_HashTableEnumerateEntries(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.5433"></a><span id="l34.5433" class="difflineplus">+                                   net_pop3_copy_hash_entries,</span>
<a href="#l34.5434"></a><span id="l34.5434" class="difflineplus">+                                   (void *)m_pop3ConData-&gt;uidlinfo-&gt;hash);</span>
<a href="#l34.5435"></a><span id="l34.5435">     }</span>
<a href="#l34.5436"></a><span id="l34.5436">   }</span>
<a href="#l34.5437"></a><span id="l34.5437"> </span>
<a href="#l34.5438"></a><span id="l34.5438" class="difflineminus">-  if (!m_pop3ConData-&gt;only_check_for_new_mail)</span>
<a href="#l34.5439"></a><span id="l34.5439" class="difflineminus">-  {</span>
<a href="#l34.5440"></a><span id="l34.5440" class="difflineplus">+  if (!m_pop3ConData-&gt;only_check_for_new_mail) {</span>
<a href="#l34.5441"></a><span id="l34.5441">     nsresult rv;</span>
<a href="#l34.5442"></a><span id="l34.5442">     nsCOMPtr&lt;nsIFile&gt; mailDirectory;</span>
<a href="#l34.5443"></a><span id="l34.5443"> </span>
<a href="#l34.5444"></a><span id="l34.5444">     // get the mail directory</span>
<a href="#l34.5445"></a><span id="l34.5445">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l34.5446"></a><span id="l34.5446" class="difflineminus">-      do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l34.5447"></a><span id="l34.5447" class="difflineplus">+        do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l34.5448"></a><span id="l34.5448">     if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.5449"></a><span id="l34.5449"> </span>
<a href="#l34.5450"></a><span id="l34.5450">     rv = server-&gt;GetLocalPath(getter_AddRefs(mailDirectory));</span>
<a href="#l34.5451"></a><span id="l34.5451">     if (NS_FAILED(rv)) return -1;</span>
<a href="#l34.5452"></a><span id="l34.5452"> </span>
<a href="#l34.5453"></a><span id="l34.5453">     // write the state in the mail directory</span>
<a href="#l34.5454"></a><span id="l34.5454">     net_pop3_write_state(m_pop3ConData-&gt;uidlinfo, mailDirectory.get());</span>
<a href="#l34.5455"></a><span id="l34.5455">   }</span>
<a href="#l34.5456"></a><span id="l34.5456">   return 0;</span>
<a href="#l34.5457"></a><span id="l34.5457"> }</span>
<a href="#l34.5458"></a><span id="l34.5458"> </span>
<a href="#l34.5459"></a><span id="l34.5459" class="difflineminus">-</span>
<a href="#l34.5460"></a><span id="l34.5460"> /* NET_process_Pop3  will control the state machine that</span>
<a href="#l34.5461"></a><span id="l34.5461">  * loads messages from a pop3 server</span>
<a href="#l34.5462"></a><span id="l34.5462">  *</span>
<a href="#l34.5463"></a><span id="l34.5463">  * returns negative if the transfer is finished or error'd out</span>
<a href="#l34.5464"></a><span id="l34.5464">  *</span>
<a href="#l34.5465"></a><span id="l34.5465">  * returns zero or more if the transfer needs to be continued.</span>
<a href="#l34.5466"></a><span id="l34.5466">  */</span>
<a href="#l34.5467"></a><span id="l34.5467" class="difflineminus">-nsresult nsPop3Protocol::ProcessProtocolState(nsIURI * url, nsIInputStream * aInputStream,</span>
<a href="#l34.5468"></a><span id="l34.5468" class="difflineminus">-                                              uint64_t sourceOffset, uint32_t aLength)</span>
<a href="#l34.5469"></a><span id="l34.5469" class="difflineminus">-{</span>
<a href="#l34.5470"></a><span id="l34.5470" class="difflineplus">+nsresult nsPop3Protocol::ProcessProtocolState(nsIURI *url,</span>
<a href="#l34.5471"></a><span id="l34.5471" class="difflineplus">+                                              nsIInputStream *aInputStream,</span>
<a href="#l34.5472"></a><span id="l34.5472" class="difflineplus">+                                              uint64_t sourceOffset,</span>
<a href="#l34.5473"></a><span id="l34.5473" class="difflineplus">+                                              uint32_t aLength) {</span>
<a href="#l34.5474"></a><span id="l34.5474">   int32_t status = 0;</span>
<a href="#l34.5475"></a><span id="l34.5475">   bool urlStatusSet = false;</span>
<a href="#l34.5476"></a><span id="l34.5476">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(m_url);</span>
<a href="#l34.5477"></a><span id="l34.5477"> </span>
<a href="#l34.5478"></a><span id="l34.5478" class="difflineminus">-  MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;Entering NET_ProcessPop3 %d&quot;),</span>
<a href="#l34.5479"></a><span id="l34.5479" class="difflineminus">-                                          aLength));</span>
<a href="#l34.5480"></a><span id="l34.5480" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.5481"></a><span id="l34.5481" class="difflineplus">+          (POP3LOG(&quot;Entering NET_ProcessPop3 %d&quot;), aLength));</span>
<a href="#l34.5482"></a><span id="l34.5482"> </span>
<a href="#l34.5483"></a><span id="l34.5483">   m_pop3ConData-&gt;pause_for_read = false; /* already paused; reset */</span>
<a href="#l34.5484"></a><span id="l34.5484"> </span>
<a href="#l34.5485"></a><span id="l34.5485" class="difflineminus">-  if(m_username.IsEmpty())</span>
<a href="#l34.5486"></a><span id="l34.5486" class="difflineminus">-  {</span>
<a href="#l34.5487"></a><span id="l34.5487" class="difflineplus">+  if (m_username.IsEmpty()) {</span>
<a href="#l34.5488"></a><span id="l34.5488">     // net_pop3_block = false;</span>
<a href="#l34.5489"></a><span id="l34.5489">     Error(&quot;pop3UsernameUndefined&quot;);</span>
<a href="#l34.5490"></a><span id="l34.5490">     return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l34.5491"></a><span id="l34.5491">   }</span>
<a href="#l34.5492"></a><span id="l34.5492"> </span>
<a href="#l34.5493"></a><span id="l34.5493" class="difflineminus">-  while(!m_pop3ConData-&gt;pause_for_read)</span>
<a href="#l34.5494"></a><span id="l34.5494" class="difflineminus">-  {</span>
<a href="#l34.5495"></a><span id="l34.5495" class="difflineplus">+  while (!m_pop3ConData-&gt;pause_for_read) {</span>
<a href="#l34.5496"></a><span id="l34.5496">     MOZ_LOG(POP3LOGMODULE, LogLevel::Info,</span>
<a href="#l34.5497"></a><span id="l34.5497">             (POP3LOG(&quot;Entering state: %d&quot;), m_pop3ConData-&gt;next_state));</span>
<a href="#l34.5498"></a><span id="l34.5498"> </span>
<a href="#l34.5499"></a><span id="l34.5499" class="difflineminus">-    switch(m_pop3ConData-&gt;next_state)</span>
<a href="#l34.5500"></a><span id="l34.5500" class="difflineminus">-    {</span>
<a href="#l34.5501"></a><span id="l34.5501" class="difflineminus">-    case POP3_READ_PASSWORD:</span>
<a href="#l34.5502"></a><span id="l34.5502" class="difflineminus">-      // This is a separate state so that we're waiting for the user to type</span>
<a href="#l34.5503"></a><span id="l34.5503" class="difflineminus">-      // in a password while we don't actually have a connection to the pop</span>
<a href="#l34.5504"></a><span id="l34.5504" class="difflineminus">-      // server open; this saves us from having to worry about the server</span>
<a href="#l34.5505"></a><span id="l34.5505" class="difflineminus">-      // timing out on us while we wait for user input.</span>
<a href="#l34.5506"></a><span id="l34.5506" class="difflineminus">-      if (NS_FAILED(StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_EARLY)))</span>
<a href="#l34.5507"></a><span id="l34.5507" class="difflineminus">-        status = -1;</span>
<a href="#l34.5508"></a><span id="l34.5508" class="difflineminus">-      break;</span>
<a href="#l34.5509"></a><span id="l34.5509" class="difflineminus">-    case POP3_FINISH_OBTAIN_PASSWORD_EARLY:</span>
<a href="#l34.5510"></a><span id="l34.5510" class="difflineminus">-      {</span>
<a href="#l34.5511"></a><span id="l34.5511" class="difflineminus">-        if (m_passwordResult.IsEmpty() || m_username.IsEmpty())</span>
<a href="#l34.5512"></a><span id="l34.5512" class="difflineminus">-        {</span>
<a href="#l34.5513"></a><span id="l34.5513" class="difflineplus">+    switch (m_pop3ConData-&gt;next_state) {</span>
<a href="#l34.5514"></a><span id="l34.5514" class="difflineplus">+      case POP3_READ_PASSWORD:</span>
<a href="#l34.5515"></a><span id="l34.5515" class="difflineplus">+        // This is a separate state so that we're waiting for the user to type</span>
<a href="#l34.5516"></a><span id="l34.5516" class="difflineplus">+        // in a password while we don't actually have a connection to the pop</span>
<a href="#l34.5517"></a><span id="l34.5517" class="difflineplus">+        // server open; this saves us from having to worry about the server</span>
<a href="#l34.5518"></a><span id="l34.5518" class="difflineplus">+        // timing out on us while we wait for user input.</span>
<a href="#l34.5519"></a><span id="l34.5519" class="difflineplus">+        if (NS_FAILED(StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_EARLY)))</span>
<a href="#l34.5520"></a><span id="l34.5520" class="difflineplus">+          status = -1;</span>
<a href="#l34.5521"></a><span id="l34.5521" class="difflineplus">+        break;</span>
<a href="#l34.5522"></a><span id="l34.5522" class="difflineplus">+      case POP3_FINISH_OBTAIN_PASSWORD_EARLY: {</span>
<a href="#l34.5523"></a><span id="l34.5523" class="difflineplus">+        if (m_passwordResult.IsEmpty() || m_username.IsEmpty()) {</span>
<a href="#l34.5524"></a><span id="l34.5524">           status = MK_POP3_PASSWORD_UNDEFINED;</span>
<a href="#l34.5525"></a><span id="l34.5525">           m_pop3ConData-&gt;biffstate = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l34.5526"></a><span id="l34.5526" class="difflineminus">-          m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(m_pop3ConData-&gt;biffstate, 0, false);</span>
<a href="#l34.5527"></a><span id="l34.5527" class="difflineplus">+          m_nsIPop3Sink-&gt;SetBiffStateAndUpdateFE(m_pop3ConData-&gt;biffstate, 0,</span>
<a href="#l34.5528"></a><span id="l34.5528" class="difflineplus">+                                                 false);</span>
<a href="#l34.5529"></a><span id="l34.5529"> </span>
<a href="#l34.5530"></a><span id="l34.5530">           /* update old style biff */</span>
<a href="#l34.5531"></a><span id="l34.5531">           m_pop3ConData-&gt;next_state = POP3_FREE;</span>
<a href="#l34.5532"></a><span id="l34.5532">           m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.5533"></a><span id="l34.5533">           break;</span>
<a href="#l34.5534"></a><span id="l34.5534">         }</span>
<a href="#l34.5535"></a><span id="l34.5535"> </span>
<a href="#l34.5536"></a><span id="l34.5536">         m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.5537"></a><span id="l34.5537">         // we are already connected so just go on and send the username</span>
<a href="#l34.5538"></a><span id="l34.5538" class="difflineminus">-        if (m_prefAuthMethods == POP3_HAS_AUTH_USER)</span>
<a href="#l34.5539"></a><span id="l34.5539" class="difflineminus">-        {</span>
<a href="#l34.5540"></a><span id="l34.5540" class="difflineplus">+        if (m_prefAuthMethods == POP3_HAS_AUTH_USER) {</span>
<a href="#l34.5541"></a><span id="l34.5541">           m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l34.5542"></a><span id="l34.5542">           m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.5543"></a><span id="l34.5543" class="difflineminus">-        }</span>
<a href="#l34.5544"></a><span id="l34.5544" class="difflineminus">-        else</span>
<a href="#l34.5545"></a><span id="l34.5545" class="difflineminus">-        {</span>
<a href="#l34.5546"></a><span id="l34.5546" class="difflineplus">+        } else {</span>
<a href="#l34.5547"></a><span id="l34.5547">           if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l34.5548"></a><span id="l34.5548">             m_pop3ConData-&gt;next_state = POP3_SEND_AUTH;</span>
<a href="#l34.5549"></a><span id="l34.5549">           else</span>
<a href="#l34.5550"></a><span id="l34.5550">             m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l34.5551"></a><span id="l34.5551">         }</span>
<a href="#l34.5552"></a><span id="l34.5552">         break;</span>
<a href="#l34.5553"></a><span id="l34.5553">       }</span>
<a href="#l34.5554"></a><span id="l34.5554"> </span>
<a href="#l34.5555"></a><span id="l34.5555" class="difflineminus">-</span>
<a href="#l34.5556"></a><span id="l34.5556" class="difflineminus">-    case POP3_START_CONNECT:</span>
<a href="#l34.5557"></a><span id="l34.5557" class="difflineminus">-      {</span>
<a href="#l34.5558"></a><span id="l34.5558" class="difflineplus">+      case POP3_START_CONNECT: {</span>
<a href="#l34.5559"></a><span id="l34.5559">         m_pop3ConData-&gt;next_state = POP3_FINISH_CONNECT;</span>
<a href="#l34.5560"></a><span id="l34.5560">         m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.5561"></a><span id="l34.5561">         break;</span>
<a href="#l34.5562"></a><span id="l34.5562">       }</span>
<a href="#l34.5563"></a><span id="l34.5563"> </span>
<a href="#l34.5564"></a><span id="l34.5564" class="difflineminus">-    case POP3_FINISH_CONNECT:</span>
<a href="#l34.5565"></a><span id="l34.5565" class="difflineminus">-      {</span>
<a href="#l34.5566"></a><span id="l34.5566" class="difflineplus">+      case POP3_FINISH_CONNECT: {</span>
<a href="#l34.5567"></a><span id="l34.5567">         m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.5568"></a><span id="l34.5568">         m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE;</span>
<a href="#l34.5569"></a><span id="l34.5569">         break;</span>
<a href="#l34.5570"></a><span id="l34.5570">       }</span>
<a href="#l34.5571"></a><span id="l34.5571"> </span>
<a href="#l34.5572"></a><span id="l34.5572" class="difflineminus">-    case POP3_WAIT_FOR_RESPONSE:</span>
<a href="#l34.5573"></a><span id="l34.5573" class="difflineminus">-      status = WaitForResponse(aInputStream, aLength);</span>
<a href="#l34.5574"></a><span id="l34.5574" class="difflineminus">-      break;</span>
<a href="#l34.5575"></a><span id="l34.5575" class="difflineminus">-</span>
<a href="#l34.5576"></a><span id="l34.5576" class="difflineminus">-    case POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE:</span>
<a href="#l34.5577"></a><span id="l34.5577" class="difflineminus">-      {</span>
<a href="#l34.5578"></a><span id="l34.5578" class="difflineplus">+      case POP3_WAIT_FOR_RESPONSE:</span>
<a href="#l34.5579"></a><span id="l34.5579" class="difflineplus">+        status = WaitForResponse(aInputStream, aLength);</span>
<a href="#l34.5580"></a><span id="l34.5580" class="difflineplus">+        break;</span>
<a href="#l34.5581"></a><span id="l34.5581" class="difflineplus">+</span>
<a href="#l34.5582"></a><span id="l34.5582" class="difflineplus">+      case POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE: {</span>
<a href="#l34.5583"></a><span id="l34.5583">         status = WaitForStartOfConnectionResponse(aInputStream, aLength);</span>
<a href="#l34.5584"></a><span id="l34.5584"> </span>
<a href="#l34.5585"></a><span id="l34.5585" class="difflineminus">-        if(status)</span>
<a href="#l34.5586"></a><span id="l34.5586" class="difflineminus">-        {</span>
<a href="#l34.5587"></a><span id="l34.5587" class="difflineminus">-          if (m_prefAuthMethods == POP3_HAS_AUTH_USER)</span>
<a href="#l34.5588"></a><span id="l34.5588" class="difflineminus">-          {</span>
<a href="#l34.5589"></a><span id="l34.5589" class="difflineplus">+        if (status) {</span>
<a href="#l34.5590"></a><span id="l34.5590" class="difflineplus">+          if (m_prefAuthMethods == POP3_HAS_AUTH_USER) {</span>
<a href="#l34.5591"></a><span id="l34.5591">             m_currentAuthMethod = POP3_HAS_AUTH_USER;</span>
<a href="#l34.5592"></a><span id="l34.5592">             m_pop3ConData-&gt;next_state = POP3_SEND_USERNAME;</span>
<a href="#l34.5593"></a><span id="l34.5593" class="difflineminus">-          }</span>
<a href="#l34.5594"></a><span id="l34.5594" class="difflineminus">-          else</span>
<a href="#l34.5595"></a><span id="l34.5595" class="difflineminus">-          {</span>
<a href="#l34.5596"></a><span id="l34.5596" class="difflineplus">+          } else {</span>
<a href="#l34.5597"></a><span id="l34.5597">             if (TestCapFlag(POP3_AUTH_MECH_UNDEFINED))</span>
<a href="#l34.5598"></a><span id="l34.5598">               m_pop3ConData-&gt;next_state = POP3_SEND_AUTH;</span>
<a href="#l34.5599"></a><span id="l34.5599">             else</span>
<a href="#l34.5600"></a><span id="l34.5600">               m_pop3ConData-&gt;next_state = POP3_SEND_CAPA;</span>
<a href="#l34.5601"></a><span id="l34.5601">           }</span>
<a href="#l34.5602"></a><span id="l34.5602">         }</span>
<a href="#l34.5603"></a><span id="l34.5603"> </span>
<a href="#l34.5604"></a><span id="l34.5604">         break;</span>
<a href="#l34.5605"></a><span id="l34.5605">       }</span>
<a href="#l34.5606"></a><span id="l34.5606"> </span>
<a href="#l34.5607"></a><span id="l34.5607" class="difflineminus">-    case POP3_SEND_AUTH:</span>
<a href="#l34.5608"></a><span id="l34.5608" class="difflineminus">-      status = SendAuth();</span>
<a href="#l34.5609"></a><span id="l34.5609" class="difflineminus">-      break;</span>
<a href="#l34.5610"></a><span id="l34.5610" class="difflineminus">-</span>
<a href="#l34.5611"></a><span id="l34.5611" class="difflineminus">-    case POP3_AUTH_RESPONSE:</span>
<a href="#l34.5612"></a><span id="l34.5612" class="difflineminus">-      status = AuthResponse(aInputStream, aLength);</span>
<a href="#l34.5613"></a><span id="l34.5613" class="difflineminus">-      break;</span>
<a href="#l34.5614"></a><span id="l34.5614" class="difflineminus">-</span>
<a href="#l34.5615"></a><span id="l34.5615" class="difflineminus">-   case POP3_SEND_CAPA:</span>
<a href="#l34.5616"></a><span id="l34.5616" class="difflineminus">-      status = SendCapa();</span>
<a href="#l34.5617"></a><span id="l34.5617" class="difflineminus">-      break;</span>
<a href="#l34.5618"></a><span id="l34.5618" class="difflineminus">-</span>
<a href="#l34.5619"></a><span id="l34.5619" class="difflineminus">-    case POP3_CAPA_RESPONSE:</span>
<a href="#l34.5620"></a><span id="l34.5620" class="difflineminus">-      status = CapaResponse(aInputStream, aLength);</span>
<a href="#l34.5621"></a><span id="l34.5621" class="difflineminus">-      break;</span>
<a href="#l34.5622"></a><span id="l34.5622" class="difflineminus">-</span>
<a href="#l34.5623"></a><span id="l34.5623" class="difflineminus">-    case POP3_TLS_RESPONSE:</span>
<a href="#l34.5624"></a><span id="l34.5624" class="difflineminus">-      status = SendTLSResponse();</span>
<a href="#l34.5625"></a><span id="l34.5625" class="difflineminus">-      break;</span>
<a href="#l34.5626"></a><span id="l34.5626" class="difflineminus">-</span>
<a href="#l34.5627"></a><span id="l34.5627" class="difflineminus">-    case POP3_PROCESS_AUTH:</span>
<a href="#l34.5628"></a><span id="l34.5628" class="difflineminus">-      status = ProcessAuth();</span>
<a href="#l34.5629"></a><span id="l34.5629" class="difflineminus">-      break;</span>
<a href="#l34.5630"></a><span id="l34.5630" class="difflineminus">-</span>
<a href="#l34.5631"></a><span id="l34.5631" class="difflineminus">-    case POP3_NEXT_AUTH_STEP:</span>
<a href="#l34.5632"></a><span id="l34.5632" class="difflineminus">-      status = NextAuthStep();</span>
<a href="#l34.5633"></a><span id="l34.5633" class="difflineminus">-      break;</span>
<a href="#l34.5634"></a><span id="l34.5634" class="difflineminus">-</span>
<a href="#l34.5635"></a><span id="l34.5635" class="difflineminus">-    case POP3_AUTH_LOGIN:</span>
<a href="#l34.5636"></a><span id="l34.5636" class="difflineminus">-      status = AuthLogin();</span>
<a href="#l34.5637"></a><span id="l34.5637" class="difflineminus">-      break;</span>
<a href="#l34.5638"></a><span id="l34.5638" class="difflineminus">-</span>
<a href="#l34.5639"></a><span id="l34.5639" class="difflineminus">-    case POP3_AUTH_LOGIN_RESPONSE:</span>
<a href="#l34.5640"></a><span id="l34.5640" class="difflineminus">-      status = AuthLoginResponse();</span>
<a href="#l34.5641"></a><span id="l34.5641" class="difflineminus">-      break;</span>
<a href="#l34.5642"></a><span id="l34.5642" class="difflineminus">-</span>
<a href="#l34.5643"></a><span id="l34.5643" class="difflineminus">-    case POP3_AUTH_NTLM:</span>
<a href="#l34.5644"></a><span id="l34.5644" class="difflineminus">-      status = AuthNtlm();</span>
<a href="#l34.5645"></a><span id="l34.5645" class="difflineminus">-      break;</span>
<a href="#l34.5646"></a><span id="l34.5646" class="difflineminus">-</span>
<a href="#l34.5647"></a><span id="l34.5647" class="difflineminus">-    case POP3_AUTH_NTLM_RESPONSE:</span>
<a href="#l34.5648"></a><span id="l34.5648" class="difflineminus">-      status = AuthNtlmResponse();</span>
<a href="#l34.5649"></a><span id="l34.5649" class="difflineminus">-      break;</span>
<a href="#l34.5650"></a><span id="l34.5650" class="difflineminus">-</span>
<a href="#l34.5651"></a><span id="l34.5651" class="difflineminus">-    case POP3_AUTH_GSSAPI:</span>
<a href="#l34.5652"></a><span id="l34.5652" class="difflineminus">-      status = AuthGSSAPI();</span>
<a href="#l34.5653"></a><span id="l34.5653" class="difflineminus">-      break;</span>
<a href="#l34.5654"></a><span id="l34.5654" class="difflineminus">-</span>
<a href="#l34.5655"></a><span id="l34.5655" class="difflineminus">-    case POP3_AUTH_GSSAPI_FIRST:</span>
<a href="#l34.5656"></a><span id="l34.5656" class="difflineminus">-      UpdateStatus(&quot;hostContact&quot;);</span>
<a href="#l34.5657"></a><span id="l34.5657" class="difflineminus">-      status = AuthGSSAPIResponse(true);</span>
<a href="#l34.5658"></a><span id="l34.5658" class="difflineminus">-      break;</span>
<a href="#l34.5659"></a><span id="l34.5659" class="difflineminus">-</span>
<a href="#l34.5660"></a><span id="l34.5660" class="difflineminus">-    case POP3_AUTH_GSSAPI_STEP:</span>
<a href="#l34.5661"></a><span id="l34.5661" class="difflineminus">-      status = AuthGSSAPIResponse(false);</span>
<a href="#l34.5662"></a><span id="l34.5662" class="difflineminus">-      break;</span>
<a href="#l34.5663"></a><span id="l34.5663" class="difflineminus">-</span>
<a href="#l34.5664"></a><span id="l34.5664" class="difflineminus">-    case POP3_SEND_USERNAME:</span>
<a href="#l34.5665"></a><span id="l34.5665" class="difflineminus">-      if (NS_FAILED(StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_BEFORE_USERNAME)))</span>
<a href="#l34.5666"></a><span id="l34.5666" class="difflineminus">-        status = -1;</span>
<a href="#l34.5667"></a><span id="l34.5667" class="difflineminus">-      break;</span>
<a href="#l34.5668"></a><span id="l34.5668" class="difflineminus">-</span>
<a href="#l34.5669"></a><span id="l34.5669" class="difflineminus">-    case POP3_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l34.5670"></a><span id="l34.5670" class="difflineminus">-      status = -1;</span>
<a href="#l34.5671"></a><span id="l34.5671" class="difflineminus">-      break;</span>
<a href="#l34.5672"></a><span id="l34.5672" class="difflineminus">-</span>
<a href="#l34.5673"></a><span id="l34.5673" class="difflineminus">-    case POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l34.5674"></a><span id="l34.5674" class="difflineminus">-      UpdateStatus(&quot;hostContact&quot;);</span>
<a href="#l34.5675"></a><span id="l34.5675" class="difflineminus">-      status = SendUsername();</span>
<a href="#l34.5676"></a><span id="l34.5676" class="difflineminus">-      break;</span>
<a href="#l34.5677"></a><span id="l34.5677" class="difflineminus">-</span>
<a href="#l34.5678"></a><span id="l34.5678" class="difflineminus">-    case POP3_SEND_PASSWORD:</span>
<a href="#l34.5679"></a><span id="l34.5679" class="difflineminus">-      if (NS_FAILED(StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD)))</span>
<a href="#l34.5680"></a><span id="l34.5680" class="difflineplus">+      case POP3_SEND_AUTH:</span>
<a href="#l34.5681"></a><span id="l34.5681" class="difflineplus">+        status = SendAuth();</span>
<a href="#l34.5682"></a><span id="l34.5682" class="difflineplus">+        break;</span>
<a href="#l34.5683"></a><span id="l34.5683" class="difflineplus">+</span>
<a href="#l34.5684"></a><span id="l34.5684" class="difflineplus">+      case POP3_AUTH_RESPONSE:</span>
<a href="#l34.5685"></a><span id="l34.5685" class="difflineplus">+        status = AuthResponse(aInputStream, aLength);</span>
<a href="#l34.5686"></a><span id="l34.5686" class="difflineplus">+        break;</span>
<a href="#l34.5687"></a><span id="l34.5687" class="difflineplus">+</span>
<a href="#l34.5688"></a><span id="l34.5688" class="difflineplus">+      case POP3_SEND_CAPA:</span>
<a href="#l34.5689"></a><span id="l34.5689" class="difflineplus">+        status = SendCapa();</span>
<a href="#l34.5690"></a><span id="l34.5690" class="difflineplus">+        break;</span>
<a href="#l34.5691"></a><span id="l34.5691" class="difflineplus">+</span>
<a href="#l34.5692"></a><span id="l34.5692" class="difflineplus">+      case POP3_CAPA_RESPONSE:</span>
<a href="#l34.5693"></a><span id="l34.5693" class="difflineplus">+        status = CapaResponse(aInputStream, aLength);</span>
<a href="#l34.5694"></a><span id="l34.5694" class="difflineplus">+        break;</span>
<a href="#l34.5695"></a><span id="l34.5695" class="difflineplus">+</span>
<a href="#l34.5696"></a><span id="l34.5696" class="difflineplus">+      case POP3_TLS_RESPONSE:</span>
<a href="#l34.5697"></a><span id="l34.5697" class="difflineplus">+        status = SendTLSResponse();</span>
<a href="#l34.5698"></a><span id="l34.5698" class="difflineplus">+        break;</span>
<a href="#l34.5699"></a><span id="l34.5699" class="difflineplus">+</span>
<a href="#l34.5700"></a><span id="l34.5700" class="difflineplus">+      case POP3_PROCESS_AUTH:</span>
<a href="#l34.5701"></a><span id="l34.5701" class="difflineplus">+        status = ProcessAuth();</span>
<a href="#l34.5702"></a><span id="l34.5702" class="difflineplus">+        break;</span>
<a href="#l34.5703"></a><span id="l34.5703" class="difflineplus">+</span>
<a href="#l34.5704"></a><span id="l34.5704" class="difflineplus">+      case POP3_NEXT_AUTH_STEP:</span>
<a href="#l34.5705"></a><span id="l34.5705" class="difflineplus">+        status = NextAuthStep();</span>
<a href="#l34.5706"></a><span id="l34.5706" class="difflineplus">+        break;</span>
<a href="#l34.5707"></a><span id="l34.5707" class="difflineplus">+</span>
<a href="#l34.5708"></a><span id="l34.5708" class="difflineplus">+      case POP3_AUTH_LOGIN:</span>
<a href="#l34.5709"></a><span id="l34.5709" class="difflineplus">+        status = AuthLogin();</span>
<a href="#l34.5710"></a><span id="l34.5710" class="difflineplus">+        break;</span>
<a href="#l34.5711"></a><span id="l34.5711" class="difflineplus">+</span>
<a href="#l34.5712"></a><span id="l34.5712" class="difflineplus">+      case POP3_AUTH_LOGIN_RESPONSE:</span>
<a href="#l34.5713"></a><span id="l34.5713" class="difflineplus">+        status = AuthLoginResponse();</span>
<a href="#l34.5714"></a><span id="l34.5714" class="difflineplus">+        break;</span>
<a href="#l34.5715"></a><span id="l34.5715" class="difflineplus">+</span>
<a href="#l34.5716"></a><span id="l34.5716" class="difflineplus">+      case POP3_AUTH_NTLM:</span>
<a href="#l34.5717"></a><span id="l34.5717" class="difflineplus">+        status = AuthNtlm();</span>
<a href="#l34.5718"></a><span id="l34.5718" class="difflineplus">+        break;</span>
<a href="#l34.5719"></a><span id="l34.5719" class="difflineplus">+</span>
<a href="#l34.5720"></a><span id="l34.5720" class="difflineplus">+      case POP3_AUTH_NTLM_RESPONSE:</span>
<a href="#l34.5721"></a><span id="l34.5721" class="difflineplus">+        status = AuthNtlmResponse();</span>
<a href="#l34.5722"></a><span id="l34.5722" class="difflineplus">+        break;</span>
<a href="#l34.5723"></a><span id="l34.5723" class="difflineplus">+</span>
<a href="#l34.5724"></a><span id="l34.5724" class="difflineplus">+      case POP3_AUTH_GSSAPI:</span>
<a href="#l34.5725"></a><span id="l34.5725" class="difflineplus">+        status = AuthGSSAPI();</span>
<a href="#l34.5726"></a><span id="l34.5726" class="difflineplus">+        break;</span>
<a href="#l34.5727"></a><span id="l34.5727" class="difflineplus">+</span>
<a href="#l34.5728"></a><span id="l34.5728" class="difflineplus">+      case POP3_AUTH_GSSAPI_FIRST:</span>
<a href="#l34.5729"></a><span id="l34.5729" class="difflineplus">+        UpdateStatus(&quot;hostContact&quot;);</span>
<a href="#l34.5730"></a><span id="l34.5730" class="difflineplus">+        status = AuthGSSAPIResponse(true);</span>
<a href="#l34.5731"></a><span id="l34.5731" class="difflineplus">+        break;</span>
<a href="#l34.5732"></a><span id="l34.5732" class="difflineplus">+</span>
<a href="#l34.5733"></a><span id="l34.5733" class="difflineplus">+      case POP3_AUTH_GSSAPI_STEP:</span>
<a href="#l34.5734"></a><span id="l34.5734" class="difflineplus">+        status = AuthGSSAPIResponse(false);</span>
<a href="#l34.5735"></a><span id="l34.5735" class="difflineplus">+        break;</span>
<a href="#l34.5736"></a><span id="l34.5736" class="difflineplus">+</span>
<a href="#l34.5737"></a><span id="l34.5737" class="difflineplus">+      case POP3_SEND_USERNAME:</span>
<a href="#l34.5738"></a><span id="l34.5738" class="difflineplus">+        if (NS_FAILED(</span>
<a href="#l34.5739"></a><span id="l34.5739" class="difflineplus">+                StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_BEFORE_USERNAME)))</span>
<a href="#l34.5740"></a><span id="l34.5740" class="difflineplus">+          status = -1;</span>
<a href="#l34.5741"></a><span id="l34.5741" class="difflineplus">+        break;</span>
<a href="#l34.5742"></a><span id="l34.5742" class="difflineplus">+</span>
<a href="#l34.5743"></a><span id="l34.5743" class="difflineplus">+      case POP3_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l34.5744"></a><span id="l34.5744">         status = -1;</span>
<a href="#l34.5745"></a><span id="l34.5745" class="difflineminus">-      break;</span>
<a href="#l34.5746"></a><span id="l34.5746" class="difflineminus">-</span>
<a href="#l34.5747"></a><span id="l34.5747" class="difflineminus">-    case POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD:</span>
<a href="#l34.5748"></a><span id="l34.5748" class="difflineminus">-      status = SendPassword();</span>
<a href="#l34.5749"></a><span id="l34.5749" class="difflineminus">-      break;</span>
<a href="#l34.5750"></a><span id="l34.5750" class="difflineminus">-</span>
<a href="#l34.5751"></a><span id="l34.5751" class="difflineminus">-    case POP3_SEND_GURL:</span>
<a href="#l34.5752"></a><span id="l34.5752" class="difflineminus">-      status = SendGurl();</span>
<a href="#l34.5753"></a><span id="l34.5753" class="difflineminus">-      break;</span>
<a href="#l34.5754"></a><span id="l34.5754" class="difflineminus">-</span>
<a href="#l34.5755"></a><span id="l34.5755" class="difflineminus">-    case POP3_GURL_RESPONSE:</span>
<a href="#l34.5756"></a><span id="l34.5756" class="difflineminus">-      status = GurlResponse();</span>
<a href="#l34.5757"></a><span id="l34.5757" class="difflineminus">-      break;</span>
<a href="#l34.5758"></a><span id="l34.5758" class="difflineminus">-</span>
<a href="#l34.5759"></a><span id="l34.5759" class="difflineminus">-    case POP3_SEND_STAT:</span>
<a href="#l34.5760"></a><span id="l34.5760" class="difflineminus">-      status = SendStat();</span>
<a href="#l34.5761"></a><span id="l34.5761" class="difflineminus">-      break;</span>
<a href="#l34.5762"></a><span id="l34.5762" class="difflineminus">-</span>
<a href="#l34.5763"></a><span id="l34.5763" class="difflineminus">-    case POP3_GET_STAT:</span>
<a href="#l34.5764"></a><span id="l34.5764" class="difflineminus">-      status = GetStat();</span>
<a href="#l34.5765"></a><span id="l34.5765" class="difflineminus">-      break;</span>
<a href="#l34.5766"></a><span id="l34.5766" class="difflineminus">-</span>
<a href="#l34.5767"></a><span id="l34.5767" class="difflineminus">-    case POP3_SEND_LIST:</span>
<a href="#l34.5768"></a><span id="l34.5768" class="difflineminus">-      status = SendList();</span>
<a href="#l34.5769"></a><span id="l34.5769" class="difflineminus">-      break;</span>
<a href="#l34.5770"></a><span id="l34.5770" class="difflineminus">-</span>
<a href="#l34.5771"></a><span id="l34.5771" class="difflineminus">-    case POP3_GET_LIST:</span>
<a href="#l34.5772"></a><span id="l34.5772" class="difflineminus">-      status = GetList(aInputStream, aLength);</span>
<a href="#l34.5773"></a><span id="l34.5773" class="difflineminus">-      break;</span>
<a href="#l34.5774"></a><span id="l34.5774" class="difflineminus">-</span>
<a href="#l34.5775"></a><span id="l34.5775" class="difflineminus">-    case POP3_SEND_UIDL_LIST:</span>
<a href="#l34.5776"></a><span id="l34.5776" class="difflineminus">-      status = SendUidlList();</span>
<a href="#l34.5777"></a><span id="l34.5777" class="difflineminus">-      break;</span>
<a href="#l34.5778"></a><span id="l34.5778" class="difflineminus">-</span>
<a href="#l34.5779"></a><span id="l34.5779" class="difflineminus">-    case POP3_GET_UIDL_LIST:</span>
<a href="#l34.5780"></a><span id="l34.5780" class="difflineminus">-      status = GetUidlList(aInputStream, aLength);</span>
<a href="#l34.5781"></a><span id="l34.5781" class="difflineminus">-      break;</span>
<a href="#l34.5782"></a><span id="l34.5782" class="difflineminus">-</span>
<a href="#l34.5783"></a><span id="l34.5783" class="difflineminus">-    case POP3_SEND_XTND_XLST_MSGID:</span>
<a href="#l34.5784"></a><span id="l34.5784" class="difflineminus">-      status = SendXtndXlstMsgid();</span>
<a href="#l34.5785"></a><span id="l34.5785" class="difflineminus">-      break;</span>
<a href="#l34.5786"></a><span id="l34.5786" class="difflineminus">-</span>
<a href="#l34.5787"></a><span id="l34.5787" class="difflineminus">-    case POP3_GET_XTND_XLST_MSGID:</span>
<a href="#l34.5788"></a><span id="l34.5788" class="difflineminus">-      status = GetXtndXlstMsgid(aInputStream, aLength);</span>
<a href="#l34.5789"></a><span id="l34.5789" class="difflineminus">-      break;</span>
<a href="#l34.5790"></a><span id="l34.5790" class="difflineminus">-</span>
<a href="#l34.5791"></a><span id="l34.5791" class="difflineminus">-    case POP3_GET_MSG:</span>
<a href="#l34.5792"></a><span id="l34.5792" class="difflineminus">-      status = GetMsg();</span>
<a href="#l34.5793"></a><span id="l34.5793" class="difflineminus">-      break;</span>
<a href="#l34.5794"></a><span id="l34.5794" class="difflineminus">-</span>
<a href="#l34.5795"></a><span id="l34.5795" class="difflineminus">-    case POP3_SEND_TOP:</span>
<a href="#l34.5796"></a><span id="l34.5796" class="difflineminus">-      status = SendTop();</span>
<a href="#l34.5797"></a><span id="l34.5797" class="difflineminus">-      break;</span>
<a href="#l34.5798"></a><span id="l34.5798" class="difflineminus">-</span>
<a href="#l34.5799"></a><span id="l34.5799" class="difflineminus">-    case POP3_TOP_RESPONSE:</span>
<a href="#l34.5800"></a><span id="l34.5800" class="difflineminus">-      status = TopResponse(aInputStream, aLength);</span>
<a href="#l34.5801"></a><span id="l34.5801" class="difflineminus">-      break;</span>
<a href="#l34.5802"></a><span id="l34.5802" class="difflineminus">-</span>
<a href="#l34.5803"></a><span id="l34.5803" class="difflineminus">-    case POP3_SEND_XSENDER:</span>
<a href="#l34.5804"></a><span id="l34.5804" class="difflineminus">-      status = SendXsender();</span>
<a href="#l34.5805"></a><span id="l34.5805" class="difflineminus">-      break;</span>
<a href="#l34.5806"></a><span id="l34.5806" class="difflineminus">-</span>
<a href="#l34.5807"></a><span id="l34.5807" class="difflineminus">-    case POP3_XSENDER_RESPONSE:</span>
<a href="#l34.5808"></a><span id="l34.5808" class="difflineminus">-      status = XsenderResponse();</span>
<a href="#l34.5809"></a><span id="l34.5809" class="difflineminus">-      break;</span>
<a href="#l34.5810"></a><span id="l34.5810" class="difflineminus">-</span>
<a href="#l34.5811"></a><span id="l34.5811" class="difflineminus">-    case POP3_SEND_RETR:</span>
<a href="#l34.5812"></a><span id="l34.5812" class="difflineminus">-      status = SendRetr();</span>
<a href="#l34.5813"></a><span id="l34.5813" class="difflineminus">-      break;</span>
<a href="#l34.5814"></a><span id="l34.5814" class="difflineminus">-</span>
<a href="#l34.5815"></a><span id="l34.5815" class="difflineminus">-    case POP3_RETR_RESPONSE:</span>
<a href="#l34.5816"></a><span id="l34.5816" class="difflineminus">-      status = RetrResponse(aInputStream, aLength);</span>
<a href="#l34.5817"></a><span id="l34.5817" class="difflineminus">-      break;</span>
<a href="#l34.5818"></a><span id="l34.5818" class="difflineminus">-</span>
<a href="#l34.5819"></a><span id="l34.5819" class="difflineminus">-    case POP3_SEND_DELE:</span>
<a href="#l34.5820"></a><span id="l34.5820" class="difflineminus">-      status = SendDele();</span>
<a href="#l34.5821"></a><span id="l34.5821" class="difflineminus">-      break;</span>
<a href="#l34.5822"></a><span id="l34.5822" class="difflineminus">-</span>
<a href="#l34.5823"></a><span id="l34.5823" class="difflineminus">-    case POP3_DELE_RESPONSE:</span>
<a href="#l34.5824"></a><span id="l34.5824" class="difflineminus">-      status = DeleResponse();</span>
<a href="#l34.5825"></a><span id="l34.5825" class="difflineminus">-      break;</span>
<a href="#l34.5826"></a><span id="l34.5826" class="difflineminus">-</span>
<a href="#l34.5827"></a><span id="l34.5827" class="difflineminus">-    case POP3_SEND_QUIT:</span>
<a href="#l34.5828"></a><span id="l34.5828" class="difflineminus">-    /* attempt to send a server quit command.  Since this means</span>
<a href="#l34.5829"></a><span id="l34.5829" class="difflineminus">-    everything went well, this is a good time to update the</span>
<a href="#l34.5830"></a><span id="l34.5830" class="difflineminus">-    status file and the FE's biff state.</span>
<a href="#l34.5831"></a><span id="l34.5831" class="difflineminus">-      */</span>
<a href="#l34.5832"></a><span id="l34.5832" class="difflineminus">-      if (!m_pop3ConData-&gt;only_uidl)</span>
<a href="#l34.5833"></a><span id="l34.5833" class="difflineminus">-      {</span>
<a href="#l34.5834"></a><span id="l34.5834" class="difflineminus">-        /* update old style biff */</span>
<a href="#l34.5835"></a><span id="l34.5835" class="difflineminus">-        if (!m_pop3ConData-&gt;only_check_for_new_mail)</span>
<a href="#l34.5836"></a><span id="l34.5836" class="difflineminus">-        {</span>
<a href="#l34.5837"></a><span id="l34.5837" class="difflineminus">-        /* We don't want to pop up a warning message any more (see</span>
<a href="#l34.5838"></a><span id="l34.5838" class="difflineminus">-        bug 54116), so instead we put the &quot;no new messages&quot; or</span>
<a href="#l34.5839"></a><span id="l34.5839" class="difflineminus">-        &quot;retrieved x new messages&quot;</span>
<a href="#l34.5840"></a><span id="l34.5840" class="difflineminus">-        in the status line.  Unfortunately, this tends to be running</span>
<a href="#l34.5841"></a><span id="l34.5841" class="difflineminus">-        in a progress pane, so we try to get the real pane and</span>
<a href="#l34.5842"></a><span id="l34.5842" class="difflineminus">-          show the message there. */</span>
<a href="#l34.5843"></a><span id="l34.5843" class="difflineminus">-</span>
<a href="#l34.5844"></a><span id="l34.5844" class="difflineminus">-          if (m_totalDownloadSize &lt;= 0)</span>
<a href="#l34.5845"></a><span id="l34.5845" class="difflineminus">-          {</span>
<a href="#l34.5846"></a><span id="l34.5846" class="difflineminus">-            UpdateStatus(&quot;noNewMessages&quot;);</span>
<a href="#l34.5847"></a><span id="l34.5847" class="difflineminus">-            /* There are no new messages.  */</span>
<a href="#l34.5848"></a><span id="l34.5848" class="difflineminus">-          }</span>
<a href="#l34.5849"></a><span id="l34.5849" class="difflineminus">-          else</span>
<a href="#l34.5850"></a><span id="l34.5850" class="difflineminus">-          {</span>
<a href="#l34.5851"></a><span id="l34.5851" class="difflineminus">-            nsString statusString;</span>
<a href="#l34.5852"></a><span id="l34.5852" class="difflineminus">-            nsresult rv = FormatCounterString(NS_LITERAL_STRING(&quot;receivedMsgs&quot;),</span>
<a href="#l34.5853"></a><span id="l34.5853" class="difflineminus">-                                              m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l34.5854"></a><span id="l34.5854" class="difflineminus">-                                              m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l34.5855"></a><span id="l34.5855" class="difflineminus">-                                              statusString);</span>
<a href="#l34.5856"></a><span id="l34.5856" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l34.5857"></a><span id="l34.5857" class="difflineminus">-              UpdateStatusWithString(statusString.get());</span>
<a href="#l34.5858"></a><span id="l34.5858" class="difflineplus">+        break;</span>
<a href="#l34.5859"></a><span id="l34.5859" class="difflineplus">+</span>
<a href="#l34.5860"></a><span id="l34.5860" class="difflineplus">+      case POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME:</span>
<a href="#l34.5861"></a><span id="l34.5861" class="difflineplus">+        UpdateStatus(&quot;hostContact&quot;);</span>
<a href="#l34.5862"></a><span id="l34.5862" class="difflineplus">+        status = SendUsername();</span>
<a href="#l34.5863"></a><span id="l34.5863" class="difflineplus">+        break;</span>
<a href="#l34.5864"></a><span id="l34.5864" class="difflineplus">+</span>
<a href="#l34.5865"></a><span id="l34.5865" class="difflineplus">+      case POP3_SEND_PASSWORD:</span>
<a href="#l34.5866"></a><span id="l34.5866" class="difflineplus">+        if (NS_FAILED(</span>
<a href="#l34.5867"></a><span id="l34.5867" class="difflineplus">+                StartGetAsyncPassword(POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD)))</span>
<a href="#l34.5868"></a><span id="l34.5868" class="difflineplus">+          status = -1;</span>
<a href="#l34.5869"></a><span id="l34.5869" class="difflineplus">+        break;</span>
<a href="#l34.5870"></a><span id="l34.5870" class="difflineplus">+</span>
<a href="#l34.5871"></a><span id="l34.5871" class="difflineplus">+      case POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD:</span>
<a href="#l34.5872"></a><span id="l34.5872" class="difflineplus">+        status = SendPassword();</span>
<a href="#l34.5873"></a><span id="l34.5873" class="difflineplus">+        break;</span>
<a href="#l34.5874"></a><span id="l34.5874" class="difflineplus">+</span>
<a href="#l34.5875"></a><span id="l34.5875" class="difflineplus">+      case POP3_SEND_GURL:</span>
<a href="#l34.5876"></a><span id="l34.5876" class="difflineplus">+        status = SendGurl();</span>
<a href="#l34.5877"></a><span id="l34.5877" class="difflineplus">+        break;</span>
<a href="#l34.5878"></a><span id="l34.5878" class="difflineplus">+</span>
<a href="#l34.5879"></a><span id="l34.5879" class="difflineplus">+      case POP3_GURL_RESPONSE:</span>
<a href="#l34.5880"></a><span id="l34.5880" class="difflineplus">+        status = GurlResponse();</span>
<a href="#l34.5881"></a><span id="l34.5881" class="difflineplus">+        break;</span>
<a href="#l34.5882"></a><span id="l34.5882" class="difflineplus">+</span>
<a href="#l34.5883"></a><span id="l34.5883" class="difflineplus">+      case POP3_SEND_STAT:</span>
<a href="#l34.5884"></a><span id="l34.5884" class="difflineplus">+        status = SendStat();</span>
<a href="#l34.5885"></a><span id="l34.5885" class="difflineplus">+        break;</span>
<a href="#l34.5886"></a><span id="l34.5886" class="difflineplus">+</span>
<a href="#l34.5887"></a><span id="l34.5887" class="difflineplus">+      case POP3_GET_STAT:</span>
<a href="#l34.5888"></a><span id="l34.5888" class="difflineplus">+        status = GetStat();</span>
<a href="#l34.5889"></a><span id="l34.5889" class="difflineplus">+        break;</span>
<a href="#l34.5890"></a><span id="l34.5890" class="difflineplus">+</span>
<a href="#l34.5891"></a><span id="l34.5891" class="difflineplus">+      case POP3_SEND_LIST:</span>
<a href="#l34.5892"></a><span id="l34.5892" class="difflineplus">+        status = SendList();</span>
<a href="#l34.5893"></a><span id="l34.5893" class="difflineplus">+        break;</span>
<a href="#l34.5894"></a><span id="l34.5894" class="difflineplus">+</span>
<a href="#l34.5895"></a><span id="l34.5895" class="difflineplus">+      case POP3_GET_LIST:</span>
<a href="#l34.5896"></a><span id="l34.5896" class="difflineplus">+        status = GetList(aInputStream, aLength);</span>
<a href="#l34.5897"></a><span id="l34.5897" class="difflineplus">+        break;</span>
<a href="#l34.5898"></a><span id="l34.5898" class="difflineplus">+</span>
<a href="#l34.5899"></a><span id="l34.5899" class="difflineplus">+      case POP3_SEND_UIDL_LIST:</span>
<a href="#l34.5900"></a><span id="l34.5900" class="difflineplus">+        status = SendUidlList();</span>
<a href="#l34.5901"></a><span id="l34.5901" class="difflineplus">+        break;</span>
<a href="#l34.5902"></a><span id="l34.5902" class="difflineplus">+</span>
<a href="#l34.5903"></a><span id="l34.5903" class="difflineplus">+      case POP3_GET_UIDL_LIST:</span>
<a href="#l34.5904"></a><span id="l34.5904" class="difflineplus">+        status = GetUidlList(aInputStream, aLength);</span>
<a href="#l34.5905"></a><span id="l34.5905" class="difflineplus">+        break;</span>
<a href="#l34.5906"></a><span id="l34.5906" class="difflineplus">+</span>
<a href="#l34.5907"></a><span id="l34.5907" class="difflineplus">+      case POP3_SEND_XTND_XLST_MSGID:</span>
<a href="#l34.5908"></a><span id="l34.5908" class="difflineplus">+        status = SendXtndXlstMsgid();</span>
<a href="#l34.5909"></a><span id="l34.5909" class="difflineplus">+        break;</span>
<a href="#l34.5910"></a><span id="l34.5910" class="difflineplus">+</span>
<a href="#l34.5911"></a><span id="l34.5911" class="difflineplus">+      case POP3_GET_XTND_XLST_MSGID:</span>
<a href="#l34.5912"></a><span id="l34.5912" class="difflineplus">+        status = GetXtndXlstMsgid(aInputStream, aLength);</span>
<a href="#l34.5913"></a><span id="l34.5913" class="difflineplus">+        break;</span>
<a href="#l34.5914"></a><span id="l34.5914" class="difflineplus">+</span>
<a href="#l34.5915"></a><span id="l34.5915" class="difflineplus">+      case POP3_GET_MSG:</span>
<a href="#l34.5916"></a><span id="l34.5916" class="difflineplus">+        status = GetMsg();</span>
<a href="#l34.5917"></a><span id="l34.5917" class="difflineplus">+        break;</span>
<a href="#l34.5918"></a><span id="l34.5918" class="difflineplus">+</span>
<a href="#l34.5919"></a><span id="l34.5919" class="difflineplus">+      case POP3_SEND_TOP:</span>
<a href="#l34.5920"></a><span id="l34.5920" class="difflineplus">+        status = SendTop();</span>
<a href="#l34.5921"></a><span id="l34.5921" class="difflineplus">+        break;</span>
<a href="#l34.5922"></a><span id="l34.5922" class="difflineplus">+</span>
<a href="#l34.5923"></a><span id="l34.5923" class="difflineplus">+      case POP3_TOP_RESPONSE:</span>
<a href="#l34.5924"></a><span id="l34.5924" class="difflineplus">+        status = TopResponse(aInputStream, aLength);</span>
<a href="#l34.5925"></a><span id="l34.5925" class="difflineplus">+        break;</span>
<a href="#l34.5926"></a><span id="l34.5926" class="difflineplus">+</span>
<a href="#l34.5927"></a><span id="l34.5927" class="difflineplus">+      case POP3_SEND_XSENDER:</span>
<a href="#l34.5928"></a><span id="l34.5928" class="difflineplus">+        status = SendXsender();</span>
<a href="#l34.5929"></a><span id="l34.5929" class="difflineplus">+        break;</span>
<a href="#l34.5930"></a><span id="l34.5930" class="difflineplus">+</span>
<a href="#l34.5931"></a><span id="l34.5931" class="difflineplus">+      case POP3_XSENDER_RESPONSE:</span>
<a href="#l34.5932"></a><span id="l34.5932" class="difflineplus">+        status = XsenderResponse();</span>
<a href="#l34.5933"></a><span id="l34.5933" class="difflineplus">+        break;</span>
<a href="#l34.5934"></a><span id="l34.5934" class="difflineplus">+</span>
<a href="#l34.5935"></a><span id="l34.5935" class="difflineplus">+      case POP3_SEND_RETR:</span>
<a href="#l34.5936"></a><span id="l34.5936" class="difflineplus">+        status = SendRetr();</span>
<a href="#l34.5937"></a><span id="l34.5937" class="difflineplus">+        break;</span>
<a href="#l34.5938"></a><span id="l34.5938" class="difflineplus">+</span>
<a href="#l34.5939"></a><span id="l34.5939" class="difflineplus">+      case POP3_RETR_RESPONSE:</span>
<a href="#l34.5940"></a><span id="l34.5940" class="difflineplus">+        status = RetrResponse(aInputStream, aLength);</span>
<a href="#l34.5941"></a><span id="l34.5941" class="difflineplus">+        break;</span>
<a href="#l34.5942"></a><span id="l34.5942" class="difflineplus">+</span>
<a href="#l34.5943"></a><span id="l34.5943" class="difflineplus">+      case POP3_SEND_DELE:</span>
<a href="#l34.5944"></a><span id="l34.5944" class="difflineplus">+        status = SendDele();</span>
<a href="#l34.5945"></a><span id="l34.5945" class="difflineplus">+        break;</span>
<a href="#l34.5946"></a><span id="l34.5946" class="difflineplus">+</span>
<a href="#l34.5947"></a><span id="l34.5947" class="difflineplus">+      case POP3_DELE_RESPONSE:</span>
<a href="#l34.5948"></a><span id="l34.5948" class="difflineplus">+        status = DeleResponse();</span>
<a href="#l34.5949"></a><span id="l34.5949" class="difflineplus">+        break;</span>
<a href="#l34.5950"></a><span id="l34.5950" class="difflineplus">+</span>
<a href="#l34.5951"></a><span id="l34.5951" class="difflineplus">+      case POP3_SEND_QUIT:</span>
<a href="#l34.5952"></a><span id="l34.5952" class="difflineplus">+        /* attempt to send a server quit command.  Since this means</span>
<a href="#l34.5953"></a><span id="l34.5953" class="difflineplus">+        everything went well, this is a good time to update the</span>
<a href="#l34.5954"></a><span id="l34.5954" class="difflineplus">+        status file and the FE's biff state.</span>
<a href="#l34.5955"></a><span id="l34.5955" class="difflineplus">+          */</span>
<a href="#l34.5956"></a><span id="l34.5956" class="difflineplus">+        if (!m_pop3ConData-&gt;only_uidl) {</span>
<a href="#l34.5957"></a><span id="l34.5957" class="difflineplus">+          /* update old style biff */</span>
<a href="#l34.5958"></a><span id="l34.5958" class="difflineplus">+          if (!m_pop3ConData-&gt;only_check_for_new_mail) {</span>
<a href="#l34.5959"></a><span id="l34.5959" class="difflineplus">+            /* We don't want to pop up a warning message any more (see</span>
<a href="#l34.5960"></a><span id="l34.5960" class="difflineplus">+            bug 54116), so instead we put the &quot;no new messages&quot; or</span>
<a href="#l34.5961"></a><span id="l34.5961" class="difflineplus">+            &quot;retrieved x new messages&quot;</span>
<a href="#l34.5962"></a><span id="l34.5962" class="difflineplus">+            in the status line.  Unfortunately, this tends to be running</span>
<a href="#l34.5963"></a><span id="l34.5963" class="difflineplus">+            in a progress pane, so we try to get the real pane and</span>
<a href="#l34.5964"></a><span id="l34.5964" class="difflineplus">+              show the message there. */</span>
<a href="#l34.5965"></a><span id="l34.5965" class="difflineplus">+</span>
<a href="#l34.5966"></a><span id="l34.5966" class="difflineplus">+            if (m_totalDownloadSize &lt;= 0) {</span>
<a href="#l34.5967"></a><span id="l34.5967" class="difflineplus">+              UpdateStatus(&quot;noNewMessages&quot;);</span>
<a href="#l34.5968"></a><span id="l34.5968" class="difflineplus">+              /* There are no new messages.  */</span>
<a href="#l34.5969"></a><span id="l34.5969" class="difflineplus">+            } else {</span>
<a href="#l34.5970"></a><span id="l34.5970" class="difflineplus">+              nsString statusString;</span>
<a href="#l34.5971"></a><span id="l34.5971" class="difflineplus">+              nsresult rv = FormatCounterString(</span>
<a href="#l34.5972"></a><span id="l34.5972" class="difflineplus">+                  NS_LITERAL_STRING(&quot;receivedMsgs&quot;),</span>
<a href="#l34.5973"></a><span id="l34.5973" class="difflineplus">+                  m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l34.5974"></a><span id="l34.5974" class="difflineplus">+                  m_pop3ConData-&gt;really_new_messages, statusString);</span>
<a href="#l34.5975"></a><span id="l34.5975" class="difflineplus">+              if (NS_SUCCEEDED(rv)) UpdateStatusWithString(statusString.get());</span>
<a href="#l34.5976"></a><span id="l34.5976" class="difflineplus">+            }</span>
<a href="#l34.5977"></a><span id="l34.5977">           }</span>
<a href="#l34.5978"></a><span id="l34.5978">         }</span>
<a href="#l34.5979"></a><span id="l34.5979" class="difflineminus">-      }</span>
<a href="#l34.5980"></a><span id="l34.5980" class="difflineminus">-</span>
<a href="#l34.5981"></a><span id="l34.5981" class="difflineminus">-      status = Pop3SendData(&quot;QUIT&quot; CRLF);</span>
<a href="#l34.5982"></a><span id="l34.5982" class="difflineminus">-      m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l34.5983"></a><span id="l34.5983" class="difflineminus">-      m_pop3ConData-&gt;next_state_after_response = POP3_QUIT_RESPONSE;</span>
<a href="#l34.5984"></a><span id="l34.5984" class="difflineminus">-      break;</span>
<a href="#l34.5985"></a><span id="l34.5985" class="difflineminus">-</span>
<a href="#l34.5986"></a><span id="l34.5986" class="difflineminus">-    case POP3_QUIT_RESPONSE:</span>
<a href="#l34.5987"></a><span id="l34.5987" class="difflineminus">-      if(m_pop3ConData-&gt;command_succeeded)</span>
<a href="#l34.5988"></a><span id="l34.5988" class="difflineminus">-      {</span>
<a href="#l34.5989"></a><span id="l34.5989" class="difflineminus">-      /*  the QUIT succeeded.  We can now flush the state in popstate.dat which</span>
<a href="#l34.5990"></a><span id="l34.5990" class="difflineminus">-        keeps track of any uncommitted DELE's */</span>
<a href="#l34.5991"></a><span id="l34.5991" class="difflineminus">-</span>
<a href="#l34.5992"></a><span id="l34.5992" class="difflineminus">-        /* clear the hash of all our uncommitted deletes */</span>
<a href="#l34.5993"></a><span id="l34.5993" class="difflineminus">-        if (!m_pop3ConData-&gt;leave_on_server &amp;&amp; m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.5994"></a><span id="l34.5994" class="difflineminus">-        {</span>
<a href="#l34.5995"></a><span id="l34.5995" class="difflineminus">-          PL_HashTableEnumerateEntries(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.5996"></a><span id="l34.5996" class="difflineminus">-                                        net_pop3_remove_messages_marked_delete,</span>
<a href="#l34.5997"></a><span id="l34.5997" class="difflineminus">-                                       (void *)m_pop3ConData);</span>
<a href="#l34.5998"></a><span id="l34.5998" class="difflineplus">+</span>
<a href="#l34.5999"></a><span id="l34.5999" class="difflineplus">+        status = Pop3SendData(&quot;QUIT&quot; CRLF);</span>
<a href="#l34.6000"></a><span id="l34.6000" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_WAIT_FOR_RESPONSE;</span>
<a href="#l34.6001"></a><span id="l34.6001" class="difflineplus">+        m_pop3ConData-&gt;next_state_after_response = POP3_QUIT_RESPONSE;</span>
<a href="#l34.6002"></a><span id="l34.6002" class="difflineplus">+        break;</span>
<a href="#l34.6003"></a><span id="l34.6003" class="difflineplus">+</span>
<a href="#l34.6004"></a><span id="l34.6004" class="difflineplus">+      case POP3_QUIT_RESPONSE:</span>
<a href="#l34.6005"></a><span id="l34.6005" class="difflineplus">+        if (m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l34.6006"></a><span id="l34.6006" class="difflineplus">+          /*  the QUIT succeeded.  We can now flush the state in popstate.dat</span>
<a href="#l34.6007"></a><span id="l34.6007" class="difflineplus">+            which keeps track of any uncommitted DELE's */</span>
<a href="#l34.6008"></a><span id="l34.6008" class="difflineplus">+</span>
<a href="#l34.6009"></a><span id="l34.6009" class="difflineplus">+          /* clear the hash of all our uncommitted deletes */</span>
<a href="#l34.6010"></a><span id="l34.6010" class="difflineplus">+          if (!m_pop3ConData-&gt;leave_on_server &amp;&amp; m_pop3ConData-&gt;newuidl) {</span>
<a href="#l34.6011"></a><span id="l34.6011" class="difflineplus">+            PL_HashTableEnumerateEntries(m_pop3ConData-&gt;newuidl,</span>
<a href="#l34.6012"></a><span id="l34.6012" class="difflineplus">+                                         net_pop3_remove_messages_marked_delete,</span>
<a href="#l34.6013"></a><span id="l34.6013" class="difflineplus">+                                         (void *)m_pop3ConData);</span>
<a href="#l34.6014"></a><span id="l34.6014" class="difflineplus">+          }</span>
<a href="#l34.6015"></a><span id="l34.6015" class="difflineplus">+          m_pop3ConData-&gt;next_state = POP3_DONE;</span>
<a href="#l34.6016"></a><span id="l34.6016" class="difflineplus">+        } else {</span>
<a href="#l34.6017"></a><span id="l34.6017" class="difflineplus">+          m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.6018"></a><span id="l34.6018" class="difflineplus">+        }</span>
<a href="#l34.6019"></a><span id="l34.6019" class="difflineplus">+        break;</span>
<a href="#l34.6020"></a><span id="l34.6020" class="difflineplus">+</span>
<a href="#l34.6021"></a><span id="l34.6021" class="difflineplus">+      case POP3_DONE:</span>
<a href="#l34.6022"></a><span id="l34.6022" class="difflineplus">+        CommitState(false);</span>
<a href="#l34.6023"></a><span id="l34.6023" class="difflineplus">+        m_pop3ConData-&gt;urlStatus = NS_OK;</span>
<a href="#l34.6024"></a><span id="l34.6024" class="difflineplus">+        urlStatusSet = true;</span>
<a href="#l34.6025"></a><span id="l34.6025" class="difflineplus">+        m_pop3ConData-&gt;next_state = POP3_FREE;</span>
<a href="#l34.6026"></a><span id="l34.6026" class="difflineplus">+        break;</span>
<a href="#l34.6027"></a><span id="l34.6027" class="difflineplus">+</span>
<a href="#l34.6028"></a><span id="l34.6028" class="difflineplus">+      case POP3_ERROR_DONE:</span>
<a href="#l34.6029"></a><span id="l34.6029" class="difflineplus">+        /*  write out the state */</span>
<a href="#l34.6030"></a><span id="l34.6030" class="difflineplus">+        if (m_pop3ConData-&gt;list_done) CommitState(true);</span>
<a href="#l34.6031"></a><span id="l34.6031" class="difflineplus">+</span>
<a href="#l34.6032"></a><span id="l34.6032" class="difflineplus">+        if (m_pop3ConData-&gt;msg_closure) {</span>
<a href="#l34.6033"></a><span id="l34.6033" class="difflineplus">+          m_nsIPop3Sink-&gt;IncorporateAbort(m_pop3ConData-&gt;only_uidl != nullptr);</span>
<a href="#l34.6034"></a><span id="l34.6034" class="difflineplus">+          m_pop3ConData-&gt;msg_closure = NULL;</span>
<a href="#l34.6035"></a><span id="l34.6035" class="difflineplus">+          m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.6036"></a><span id="l34.6036">         }</span>
<a href="#l34.6037"></a><span id="l34.6037" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_DONE;</span>
<a href="#l34.6038"></a><span id="l34.6038" class="difflineminus">-      }</span>
<a href="#l34.6039"></a><span id="l34.6039" class="difflineminus">-      else</span>
<a href="#l34.6040"></a><span id="l34.6040" class="difflineminus">-      {</span>
<a href="#l34.6041"></a><span id="l34.6041" class="difflineminus">-        m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.6042"></a><span id="l34.6042" class="difflineminus">-      }</span>
<a href="#l34.6043"></a><span id="l34.6043" class="difflineminus">-      break;</span>
<a href="#l34.6044"></a><span id="l34.6044" class="difflineminus">-</span>
<a href="#l34.6045"></a><span id="l34.6045" class="difflineminus">-    case POP3_DONE:</span>
<a href="#l34.6046"></a><span id="l34.6046" class="difflineminus">-      CommitState(false);</span>
<a href="#l34.6047"></a><span id="l34.6047" class="difflineminus">-      m_pop3ConData-&gt;urlStatus = NS_OK;</span>
<a href="#l34.6048"></a><span id="l34.6048" class="difflineminus">-      urlStatusSet = true;</span>
<a href="#l34.6049"></a><span id="l34.6049" class="difflineminus">-      m_pop3ConData-&gt;next_state = POP3_FREE;</span>
<a href="#l34.6050"></a><span id="l34.6050" class="difflineminus">-      break;</span>
<a href="#l34.6051"></a><span id="l34.6051" class="difflineminus">-</span>
<a href="#l34.6052"></a><span id="l34.6052" class="difflineminus">-    case POP3_ERROR_DONE:</span>
<a href="#l34.6053"></a><span id="l34.6053" class="difflineminus">-      /*  write out the state */</span>
<a href="#l34.6054"></a><span id="l34.6054" class="difflineminus">-      if(m_pop3ConData-&gt;list_done)</span>
<a href="#l34.6055"></a><span id="l34.6055" class="difflineminus">-        CommitState(true);</span>
<a href="#l34.6056"></a><span id="l34.6056" class="difflineminus">-</span>
<a href="#l34.6057"></a><span id="l34.6057" class="difflineminus">-      if(m_pop3ConData-&gt;msg_closure)</span>
<a href="#l34.6058"></a><span id="l34.6058" class="difflineminus">-      {</span>
<a href="#l34.6059"></a><span id="l34.6059" class="difflineminus">-        m_nsIPop3Sink-&gt;IncorporateAbort(m_pop3ConData-&gt;only_uidl != nullptr);</span>
<a href="#l34.6060"></a><span id="l34.6060" class="difflineminus">-        m_pop3ConData-&gt;msg_closure = NULL;</span>
<a href="#l34.6061"></a><span id="l34.6061" class="difflineminus">-        m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.6062"></a><span id="l34.6062" class="difflineminus">-      }</span>
<a href="#l34.6063"></a><span id="l34.6063" class="difflineminus">-</span>
<a href="#l34.6064"></a><span id="l34.6064" class="difflineminus">-      if(m_pop3ConData-&gt;msg_del_started)</span>
<a href="#l34.6065"></a><span id="l34.6065" class="difflineminus">-      {</span>
<a href="#l34.6066"></a><span id="l34.6066" class="difflineminus">-        nsString statusString;</span>
<a href="#l34.6067"></a><span id="l34.6067" class="difflineminus">-        nsresult rv = FormatCounterString(NS_LITERAL_STRING(&quot;receivedMsgs&quot;),</span>
<a href="#l34.6068"></a><span id="l34.6068" class="difflineminus">-                                 m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l34.6069"></a><span id="l34.6069" class="difflineminus">-                                 m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l34.6070"></a><span id="l34.6070" class="difflineminus">-                                 statusString);</span>
<a href="#l34.6071"></a><span id="l34.6071" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l34.6072"></a><span id="l34.6072" class="difflineminus">-          UpdateStatusWithString(statusString.get());</span>
<a href="#l34.6073"></a><span id="l34.6073" class="difflineminus">-</span>
<a href="#l34.6074"></a><span id="l34.6074" class="difflineminus">-        NS_ASSERTION (!TestFlag(POP3_PASSWORD_FAILED), &quot;POP3_PASSWORD_FAILED set when del_started&quot;);</span>
<a href="#l34.6075"></a><span id="l34.6075" class="difflineminus">-        m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.6076"></a><span id="l34.6076" class="difflineminus">-      }</span>
<a href="#l34.6077"></a><span id="l34.6077" class="difflineminus">-      { // this brace is to avoid compiler error about vars in switch case.</span>
<a href="#l34.6078"></a><span id="l34.6078" class="difflineminus">-        nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.6079"></a><span id="l34.6079" class="difflineminus">-</span>
<a href="#l34.6080"></a><span id="l34.6080" class="difflineminus">-        if (mailnewsurl)</span>
<a href="#l34.6081"></a><span id="l34.6081" class="difflineminus">-          mailnewsurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.6082"></a><span id="l34.6082" class="difflineminus">-        // no msgWindow means no re-prompt, so treat as error.</span>
<a href="#l34.6083"></a><span id="l34.6083" class="difflineminus">-        if (TestFlag(POP3_PASSWORD_FAILED) &amp;&amp; msgWindow)</span>
<a href="#l34.6084"></a><span id="l34.6084" class="difflineminus">-        {</span>
<a href="#l34.6085"></a><span id="l34.6085" class="difflineminus">-          // We get here because the password was wrong.</span>
<a href="#l34.6086"></a><span id="l34.6086" class="difflineminus">-          if (!m_socketIsOpen &amp;&amp; mailnewsurl)</span>
<a href="#l34.6087"></a><span id="l34.6087" class="difflineminus">-          {</span>
<a href="#l34.6088"></a><span id="l34.6088" class="difflineminus">-            // The server dropped the connection, so we're going</span>
<a href="#l34.6089"></a><span id="l34.6089" class="difflineminus">-            // to re-run the url.</span>
<a href="#l34.6090"></a><span id="l34.6090" class="difflineminus">-            MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.6091"></a><span id="l34.6091" class="difflineminus">-                    (POP3LOG(&quot;need to rerun url because connection dropped during auth&quot;)));</span>
<a href="#l34.6092"></a><span id="l34.6092" class="difflineminus">-            m_needToRerunUrl = true;</span>
<a href="#l34.6093"></a><span id="l34.6093" class="difflineminus">-            return NS_OK;</span>
<a href="#l34.6094"></a><span id="l34.6094" class="difflineminus">-          }</span>
<a href="#l34.6095"></a><span id="l34.6095" class="difflineminus">-          m_pop3ConData-&gt;next_state = POP3_READ_PASSWORD;</span>
<a href="#l34.6096"></a><span id="l34.6096" class="difflineminus">-          m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.6097"></a><span id="l34.6097" class="difflineminus">-          status = 0;</span>
<a href="#l34.6098"></a><span id="l34.6098" class="difflineminus">-          break;</span>
<a href="#l34.6099"></a><span id="l34.6099" class="difflineplus">+</span>
<a href="#l34.6100"></a><span id="l34.6100" class="difflineplus">+        if (m_pop3ConData-&gt;msg_del_started) {</span>
<a href="#l34.6101"></a><span id="l34.6101" class="difflineplus">+          nsString statusString;</span>
<a href="#l34.6102"></a><span id="l34.6102" class="difflineplus">+          nsresult rv = FormatCounterString(NS_LITERAL_STRING(&quot;receivedMsgs&quot;),</span>
<a href="#l34.6103"></a><span id="l34.6103" class="difflineplus">+                                            m_pop3ConData-&gt;real_new_counter - 1,</span>
<a href="#l34.6104"></a><span id="l34.6104" class="difflineplus">+                                            m_pop3ConData-&gt;really_new_messages,</span>
<a href="#l34.6105"></a><span id="l34.6105" class="difflineplus">+                                            statusString);</span>
<a href="#l34.6106"></a><span id="l34.6106" class="difflineplus">+          if (NS_SUCCEEDED(rv)) UpdateStatusWithString(statusString.get());</span>
<a href="#l34.6107"></a><span id="l34.6107" class="difflineplus">+</span>
<a href="#l34.6108"></a><span id="l34.6108" class="difflineplus">+          NS_ASSERTION(!TestFlag(POP3_PASSWORD_FAILED),</span>
<a href="#l34.6109"></a><span id="l34.6109" class="difflineplus">+                       &quot;POP3_PASSWORD_FAILED set when del_started&quot;);</span>
<a href="#l34.6110"></a><span id="l34.6110" class="difflineplus">+          m_nsIPop3Sink-&gt;AbortMailDelivery(this);</span>
<a href="#l34.6111"></a><span id="l34.6111">         }</span>
<a href="#l34.6112"></a><span id="l34.6112" class="difflineminus">-        else</span>
<a href="#l34.6113"></a><span id="l34.6113" class="difflineminus">-          /* Else we got a &quot;real&quot; error, so finish up. */</span>
<a href="#l34.6114"></a><span id="l34.6114" class="difflineminus">-          m_pop3ConData-&gt;next_state = POP3_FREE;</span>
<a href="#l34.6115"></a><span id="l34.6115" class="difflineminus">-      }</span>
<a href="#l34.6116"></a><span id="l34.6116" class="difflineminus">-      m_pop3ConData-&gt;urlStatus = NS_ERROR_FAILURE;</span>
<a href="#l34.6117"></a><span id="l34.6117" class="difflineminus">-      urlStatusSet = true;</span>
<a href="#l34.6118"></a><span id="l34.6118" class="difflineminus">-      m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.6119"></a><span id="l34.6119" class="difflineminus">-      break;</span>
<a href="#l34.6120"></a><span id="l34.6120" class="difflineminus">-</span>
<a href="#l34.6121"></a><span id="l34.6121" class="difflineminus">-    case POP3_FREE:</span>
<a href="#l34.6122"></a><span id="l34.6122" class="difflineminus">-      {</span>
<a href="#l34.6123"></a><span id="l34.6123" class="difflineminus">-        UpdateProgressPercent(0,0); // clear out the progress meter</span>
<a href="#l34.6124"></a><span id="l34.6124" class="difflineplus">+        {  // this brace is to avoid compiler error about vars in switch case.</span>
<a href="#l34.6125"></a><span id="l34.6125" class="difflineplus">+          nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l34.6126"></a><span id="l34.6126" class="difflineplus">+</span>
<a href="#l34.6127"></a><span id="l34.6127" class="difflineplus">+          if (mailnewsurl) mailnewsurl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l34.6128"></a><span id="l34.6128" class="difflineplus">+          // no msgWindow means no re-prompt, so treat as error.</span>
<a href="#l34.6129"></a><span id="l34.6129" class="difflineplus">+          if (TestFlag(POP3_PASSWORD_FAILED) &amp;&amp; msgWindow) {</span>
<a href="#l34.6130"></a><span id="l34.6130" class="difflineplus">+            // We get here because the password was wrong.</span>
<a href="#l34.6131"></a><span id="l34.6131" class="difflineplus">+            if (!m_socketIsOpen &amp;&amp; mailnewsurl) {</span>
<a href="#l34.6132"></a><span id="l34.6132" class="difflineplus">+              // The server dropped the connection, so we're going</span>
<a href="#l34.6133"></a><span id="l34.6133" class="difflineplus">+              // to re-run the url.</span>
<a href="#l34.6134"></a><span id="l34.6134" class="difflineplus">+              MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.6135"></a><span id="l34.6135" class="difflineplus">+                      (POP3LOG(&quot;need to rerun url because connection dropped &quot;</span>
<a href="#l34.6136"></a><span id="l34.6136" class="difflineplus">+                               &quot;during auth&quot;)));</span>
<a href="#l34.6137"></a><span id="l34.6137" class="difflineplus">+              m_needToRerunUrl = true;</span>
<a href="#l34.6138"></a><span id="l34.6138" class="difflineplus">+              return NS_OK;</span>
<a href="#l34.6139"></a><span id="l34.6139" class="difflineplus">+            }</span>
<a href="#l34.6140"></a><span id="l34.6140" class="difflineplus">+            m_pop3ConData-&gt;next_state = POP3_READ_PASSWORD;</span>
<a href="#l34.6141"></a><span id="l34.6141" class="difflineplus">+            m_pop3ConData-&gt;command_succeeded = true;</span>
<a href="#l34.6142"></a><span id="l34.6142" class="difflineplus">+            status = 0;</span>
<a href="#l34.6143"></a><span id="l34.6143" class="difflineplus">+            break;</span>
<a href="#l34.6144"></a><span id="l34.6144" class="difflineplus">+          } else</span>
<a href="#l34.6145"></a><span id="l34.6145" class="difflineplus">+            /* Else we got a &quot;real&quot; error, so finish up. */</span>
<a href="#l34.6146"></a><span id="l34.6146" class="difflineplus">+            m_pop3ConData-&gt;next_state = POP3_FREE;</span>
<a href="#l34.6147"></a><span id="l34.6147" class="difflineplus">+        }</span>
<a href="#l34.6148"></a><span id="l34.6148" class="difflineplus">+        m_pop3ConData-&gt;urlStatus = NS_ERROR_FAILURE;</span>
<a href="#l34.6149"></a><span id="l34.6149" class="difflineplus">+        urlStatusSet = true;</span>
<a href="#l34.6150"></a><span id="l34.6150" class="difflineplus">+        m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.6151"></a><span id="l34.6151" class="difflineplus">+        break;</span>
<a href="#l34.6152"></a><span id="l34.6152" class="difflineplus">+</span>
<a href="#l34.6153"></a><span id="l34.6153" class="difflineplus">+      case POP3_FREE: {</span>
<a href="#l34.6154"></a><span id="l34.6154" class="difflineplus">+        UpdateProgressPercent(0, 0);  // clear out the progress meter</span>
<a href="#l34.6155"></a><span id="l34.6155">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l34.6156"></a><span id="l34.6156" class="difflineminus">-        if (server)</span>
<a href="#l34.6157"></a><span id="l34.6157" class="difflineminus">-        {</span>
<a href="#l34.6158"></a><span id="l34.6158" class="difflineminus">-          MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;Clearing server busy in POP3_FREE&quot;)));</span>
<a href="#l34.6159"></a><span id="l34.6159" class="difflineminus">-          server-&gt;SetServerBusy(false); // the server is now not busy</span>
<a href="#l34.6160"></a><span id="l34.6160" class="difflineplus">+        if (server) {</span>
<a href="#l34.6161"></a><span id="l34.6161" class="difflineplus">+          MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.6162"></a><span id="l34.6162" class="difflineplus">+                  (POP3LOG(&quot;Clearing server busy in POP3_FREE&quot;)));</span>
<a href="#l34.6163"></a><span id="l34.6163" class="difflineplus">+          server-&gt;SetServerBusy(false);  // the server is now not busy</span>
<a href="#l34.6164"></a><span id="l34.6164">         }</span>
<a href="#l34.6165"></a><span id="l34.6165" class="difflineminus">-        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;Clearing running protocol in POP3_FREE&quot;)));</span>
<a href="#l34.6166"></a><span id="l34.6166" class="difflineplus">+        MOZ_LOG(POP3LOGMODULE, LogLevel::Debug,</span>
<a href="#l34.6167"></a><span id="l34.6167" class="difflineplus">+                (POP3LOG(&quot;Clearing running protocol in POP3_FREE&quot;)));</span>
<a href="#l34.6168"></a><span id="l34.6168">         CloseSocket();</span>
<a href="#l34.6169"></a><span id="l34.6169">         m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l34.6170"></a><span id="l34.6170">         if (mailnewsurl &amp;&amp; urlStatusSet)</span>
<a href="#l34.6171"></a><span id="l34.6171">           mailnewsurl-&gt;SetUrlState(false, m_pop3ConData-&gt;urlStatus);</span>
<a href="#l34.6172"></a><span id="l34.6172"> </span>
<a href="#l34.6173"></a><span id="l34.6173">         m_url = nullptr;</span>
<a href="#l34.6174"></a><span id="l34.6174">         return NS_OK;</span>
<a href="#l34.6175"></a><span id="l34.6175">       }</span>
<a href="#l34.6176"></a><span id="l34.6176" class="difflineminus">-    default:</span>
<a href="#l34.6177"></a><span id="l34.6177" class="difflineminus">-      NS_ERROR(&quot;Got to unexpected state in nsPop3Protocol::ProcessProtocolState&quot;);</span>
<a href="#l34.6178"></a><span id="l34.6178" class="difflineminus">-      status = -1;</span>
<a href="#l34.6179"></a><span id="l34.6179" class="difflineminus">-    }  /* end switch */</span>
<a href="#l34.6180"></a><span id="l34.6180" class="difflineminus">-</span>
<a href="#l34.6181"></a><span id="l34.6181" class="difflineminus">-    if((status &lt; 0) &amp;&amp; m_pop3ConData-&gt;next_state != POP3_FREE)</span>
<a href="#l34.6182"></a><span id="l34.6182" class="difflineminus">-    {</span>
<a href="#l34.6183"></a><span id="l34.6183" class="difflineplus">+      default:</span>
<a href="#l34.6184"></a><span id="l34.6184" class="difflineplus">+        NS_ERROR(</span>
<a href="#l34.6185"></a><span id="l34.6185" class="difflineplus">+            &quot;Got to unexpected state in nsPop3Protocol::ProcessProtocolState&quot;);</span>
<a href="#l34.6186"></a><span id="l34.6186" class="difflineplus">+        status = -1;</span>
<a href="#l34.6187"></a><span id="l34.6187" class="difflineplus">+    } /* end switch */</span>
<a href="#l34.6188"></a><span id="l34.6188" class="difflineplus">+</span>
<a href="#l34.6189"></a><span id="l34.6189" class="difflineplus">+    if ((status &lt; 0) &amp;&amp; m_pop3ConData-&gt;next_state != POP3_FREE) {</span>
<a href="#l34.6190"></a><span id="l34.6190">       m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l34.6191"></a><span id="l34.6191">       m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l34.6192"></a><span id="l34.6192">     }</span>
<a href="#l34.6193"></a><span id="l34.6193"> </span>
<a href="#l34.6194"></a><span id="l34.6194" class="difflineminus">-  }  /* end while */</span>
<a href="#l34.6195"></a><span id="l34.6195" class="difflineplus">+  } /* end while */</span>
<a href="#l34.6196"></a><span id="l34.6196"> </span>
<a href="#l34.6197"></a><span id="l34.6197">   return NS_OK;</span>
<a href="#l34.6198"></a><span id="l34.6198" class="difflineminus">-</span>
<a href="#l34.6199"></a><span id="l34.6199"> }</span>
<a href="#l34.6200"></a><span id="l34.6200"> </span>
<a href="#l34.6201"></a><span id="l34.6201" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::MarkMessages(nsTArray&lt;Pop3UidlEntry*&gt; *aUIDLArray)</span>
<a href="#l34.6202"></a><span id="l34.6202" class="difflineminus">-{</span>
<a href="#l34.6203"></a><span id="l34.6203" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::MarkMessages(</span>
<a href="#l34.6204"></a><span id="l34.6204" class="difflineplus">+    nsTArray&lt;Pop3UidlEntry *&gt; *aUIDLArray) {</span>
<a href="#l34.6205"></a><span id="l34.6205">   NS_ENSURE_ARG_POINTER(aUIDLArray);</span>
<a href="#l34.6206"></a><span id="l34.6206">   uint32_t count = aUIDLArray-&gt;Length();</span>
<a href="#l34.6207"></a><span id="l34.6207"> </span>
<a href="#l34.6208"></a><span id="l34.6208" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l34.6209"></a><span id="l34.6209" class="difflineminus">-  {</span>
<a href="#l34.6210"></a><span id="l34.6210" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l34.6211"></a><span id="l34.6211">     bool changed;</span>
<a href="#l34.6212"></a><span id="l34.6212">     if (m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.6213"></a><span id="l34.6213" class="difflineminus">-      MarkMsgInHashTable(m_pop3ConData-&gt;newuidl, aUIDLArray-&gt;ElementAt(i), &amp;changed);</span>
<a href="#l34.6214"></a><span id="l34.6214" class="difflineplus">+      MarkMsgInHashTable(m_pop3ConData-&gt;newuidl, aUIDLArray-&gt;ElementAt(i),</span>
<a href="#l34.6215"></a><span id="l34.6215" class="difflineplus">+                         &amp;changed);</span>
<a href="#l34.6216"></a><span id="l34.6216">     if (m_pop3ConData-&gt;uidlinfo)</span>
<a href="#l34.6217"></a><span id="l34.6217" class="difflineminus">-      MarkMsgInHashTable(m_pop3ConData-&gt;uidlinfo-&gt;hash, aUIDLArray-&gt;ElementAt(i), &amp;changed);</span>
<a href="#l34.6218"></a><span id="l34.6218" class="difflineplus">+      MarkMsgInHashTable(m_pop3ConData-&gt;uidlinfo-&gt;hash,</span>
<a href="#l34.6219"></a><span id="l34.6219" class="difflineplus">+                         aUIDLArray-&gt;ElementAt(i), &amp;changed);</span>
<a href="#l34.6220"></a><span id="l34.6220">   }</span>
<a href="#l34.6221"></a><span id="l34.6221">   return NS_OK;</span>
<a href="#l34.6222"></a><span id="l34.6222"> }</span>
<a href="#l34.6223"></a><span id="l34.6223"> </span>
<a href="#l34.6224"></a><span id="l34.6224" class="difflineminus">-NS_IMETHODIMP nsPop3Protocol::CheckMessage(const char *aUidl, bool *aBool)</span>
<a href="#l34.6225"></a><span id="l34.6225" class="difflineminus">-{</span>
<a href="#l34.6226"></a><span id="l34.6226" class="difflineplus">+NS_IMETHODIMP nsPop3Protocol::CheckMessage(const char *aUidl, bool *aBool) {</span>
<a href="#l34.6227"></a><span id="l34.6227">   Pop3UidlEntry *uidlEntry = nullptr;</span>
<a href="#l34.6228"></a><span id="l34.6228"> </span>
<a href="#l34.6229"></a><span id="l34.6229" class="difflineminus">-  if (aUidl)</span>
<a href="#l34.6230"></a><span id="l34.6230" class="difflineminus">-  {</span>
<a href="#l34.6231"></a><span id="l34.6231" class="difflineplus">+  if (aUidl) {</span>
<a href="#l34.6232"></a><span id="l34.6232">     if (m_pop3ConData-&gt;newuidl)</span>
<a href="#l34.6233"></a><span id="l34.6233" class="difflineminus">-      uidlEntry = (Pop3UidlEntry *) PL_HashTableLookup(m_pop3ConData-&gt;newuidl, aUidl);</span>
<a href="#l34.6234"></a><span id="l34.6234" class="difflineplus">+      uidlEntry =</span>
<a href="#l34.6235"></a><span id="l34.6235" class="difflineplus">+          (Pop3UidlEntry *)PL_HashTableLookup(m_pop3ConData-&gt;newuidl, aUidl);</span>
<a href="#l34.6236"></a><span id="l34.6236">     else if (m_pop3ConData-&gt;uidlinfo)</span>
<a href="#l34.6237"></a><span id="l34.6237" class="difflineminus">-      uidlEntry = (Pop3UidlEntry *) PL_HashTableLookup(m_pop3ConData-&gt;uidlinfo-&gt;hash, aUidl);</span>
<a href="#l34.6238"></a><span id="l34.6238" class="difflineplus">+      uidlEntry = (Pop3UidlEntry *)PL_HashTableLookup(</span>
<a href="#l34.6239"></a><span id="l34.6239" class="difflineplus">+          m_pop3ConData-&gt;uidlinfo-&gt;hash, aUidl);</span>
<a href="#l34.6240"></a><span id="l34.6240">   }</span>
<a href="#l34.6241"></a><span id="l34.6241"> </span>
<a href="#l34.6242"></a><span id="l34.6242">   *aBool = uidlEntry ? true : false;</span>
<a href="#l34.6243"></a><span id="l34.6243">   return NS_OK;</span>
<a href="#l34.6244"></a><span id="l34.6244"> }</span>
<a href="#l34.6245"></a><span id="l34.6245"> </span>
<a href="#l34.6246"></a><span id="l34.6246" class="difflineminus">-</span>
<a href="#l34.6247"></a><span id="l34.6247"> /* Function for finding an APOP Timestamp and simple check</span>
<a href="#l34.6248"></a><span id="l34.6248">    it for its validity. If returning NS_OK m_ApopTimestamp</span>
<a href="#l34.6249"></a><span id="l34.6249">    contains the validated substring of m_commandResponse. */</span>
<a href="#l34.6250"></a><span id="l34.6250" class="difflineminus">-nsresult nsPop3Protocol::GetApopTimestamp()</span>
<a href="#l34.6251"></a><span id="l34.6251" class="difflineminus">-{</span>
<a href="#l34.6252"></a><span id="l34.6252" class="difflineplus">+nsresult nsPop3Protocol::GetApopTimestamp() {</span>
<a href="#l34.6253"></a><span id="l34.6253">   int32_t startMark = m_commandResponse.Length(), endMark = -1;</span>
<a href="#l34.6254"></a><span id="l34.6254"> </span>
<a href="#l34.6255"></a><span id="l34.6255" class="difflineminus">-  while (true)</span>
<a href="#l34.6256"></a><span id="l34.6256" class="difflineminus">-  {</span>
<a href="#l34.6257"></a><span id="l34.6257" class="difflineplus">+  while (true) {</span>
<a href="#l34.6258"></a><span id="l34.6258">     // search for previous &lt;</span>
<a href="#l34.6259"></a><span id="l34.6259">     if ((startMark = MsgRFindChar(m_commandResponse, '&lt;', startMark - 1)) &lt; 0)</span>
<a href="#l34.6260"></a><span id="l34.6260">       return NS_ERROR_FAILURE;</span>
<a href="#l34.6261"></a><span id="l34.6261"> </span>
<a href="#l34.6262"></a><span id="l34.6262">     // search for next &gt;</span>
<a href="#l34.6263"></a><span id="l34.6263" class="difflineminus">-    if ((endMark = m_commandResponse.FindChar('&gt;', startMark)) &lt; 0)</span>
<a href="#l34.6264"></a><span id="l34.6264" class="difflineminus">-      continue;</span>
<a href="#l34.6265"></a><span id="l34.6265" class="difflineplus">+    if ((endMark = m_commandResponse.FindChar('&gt;', startMark)) &lt; 0) continue;</span>
<a href="#l34.6266"></a><span id="l34.6266"> </span>
<a href="#l34.6267"></a><span id="l34.6267">     // look for an @ between start and end as a raw test</span>
<a href="#l34.6268"></a><span id="l34.6268">     int32_t at = m_commandResponse.FindChar('@', startMark);</span>
<a href="#l34.6269"></a><span id="l34.6269" class="difflineminus">-    if (at &lt; 0 || at &gt;= endMark)</span>
<a href="#l34.6270"></a><span id="l34.6270" class="difflineminus">-      continue;</span>
<a href="#l34.6271"></a><span id="l34.6271" class="difflineplus">+    if (at &lt; 0 || at &gt;= endMark) continue;</span>
<a href="#l34.6272"></a><span id="l34.6272"> </span>
<a href="#l34.6273"></a><span id="l34.6273">     // now test if sub only consists of chars in ASCII range</span>
<a href="#l34.6274"></a><span id="l34.6274" class="difflineminus">-    nsCString sub(Substring(m_commandResponse, startMark, endMark - startMark + 1));</span>
<a href="#l34.6275"></a><span id="l34.6275" class="difflineminus">-    if (NS_IsAscii(sub.get()))</span>
<a href="#l34.6276"></a><span id="l34.6276" class="difflineminus">-    {</span>
<a href="#l34.6277"></a><span id="l34.6277" class="difflineplus">+    nsCString sub(</span>
<a href="#l34.6278"></a><span id="l34.6278" class="difflineplus">+        Substring(m_commandResponse, startMark, endMark - startMark + 1));</span>
<a href="#l34.6279"></a><span id="l34.6279" class="difflineplus">+    if (NS_IsAscii(sub.get())) {</span>
<a href="#l34.6280"></a><span id="l34.6280">       // set m_ApopTimestamp to the validated substring</span>
<a href="#l34.6281"></a><span id="l34.6281">       m_ApopTimestamp.Assign(sub);</span>
<a href="#l34.6282"></a><span id="l34.6282">       break;</span>
<a href="#l34.6283"></a><span id="l34.6283">     }</span>
<a href="#l34.6284"></a><span id="l34.6284">   }</span>
<a href="#l34.6285"></a><span id="l34.6285"> </span>
<a href="#l34.6286"></a><span id="l34.6286">   return NS_OK;</span>
<a href="#l34.6287"></a><span id="l34.6287"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l35.4"></a><span id="l35.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l35.5"></a><span id="l35.5"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l35.6"></a><span id="l35.6"> #include &quot;nsIPop3Sink.h&quot;</span>
<a href="#l35.7"></a><span id="l35.7"> #include &quot;nsMsgLineBuffer.h&quot;</span>
<a href="#l35.8"></a><span id="l35.8"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l35.9"></a><span id="l35.9"> #include &quot;nsIPop3Protocol.h&quot;</span>
<a href="#l35.10"></a><span id="l35.10"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l35.11"></a><span id="l35.11"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot; // TO include biffState enum. Change to bool later...</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;  // TO include biffState enum. Change to bool later...</span>
<a href="#l35.14"></a><span id="l35.14"> #include &quot;nsIMsgAsyncPrompter.h&quot;</span>
<a href="#l35.15"></a><span id="l35.15"> #include &quot;nsIProtocolProxyCallback.h&quot;</span>
<a href="#l35.16"></a><span id="l35.16"> </span>
<a href="#l35.17"></a><span id="l35.17"> #include &quot;prerror.h&quot;</span>
<a href="#l35.18"></a><span id="l35.18"> #include &quot;plhash.h&quot;</span>
<a href="#l35.19"></a><span id="l35.19"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21"> /* A more guaranteed way of making sure that we never get duplicate messages</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -41,324 +41,327 @@ and change the POP3_QUIT_RESPONSE state </span>
<a href="#l35.23"></a><span id="l35.23">  */</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25"> #define MK_OUT_OF_MEMORY -207</span>
<a href="#l35.26"></a><span id="l35.26"> #define MK_POP3_PASSWORD_UNDEFINED -313</span>
<a href="#l35.27"></a><span id="l35.27"> #define XP_NO_ANSWER 14401</span>
<a href="#l35.28"></a><span id="l35.28"> #define XP_THE_PREVIOUSLY_ENTERED_PASSWORD_IS_INVALID_ETC 14405</span>
<a href="#l35.29"></a><span id="l35.29"> #define XP_PASSWORD_FOR_POP3_USER 14590</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-#define OUTPUT_BUFFER_SIZE 8192 // maximum size of command string</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+#define OUTPUT_BUFFER_SIZE 8192  // maximum size of command string</span>
<a href="#l35.33"></a><span id="l35.33"> </span>
<a href="#l35.34"></a><span id="l35.34"> /* structure to hold data pertaining to the active state of</span>
<a href="#l35.35"></a><span id="l35.35">  * a transfer in progress.</span>
<a href="#l35.36"></a><span id="l35.36">  *</span>
<a href="#l35.37"></a><span id="l35.37">  */</span>
<a href="#l35.38"></a><span id="l35.38"> </span>
<a href="#l35.39"></a><span id="l35.39"> enum Pop3CapabilityEnum {</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">-    POP3_CAPABILITY_UNDEFINED   = 0x00000000,</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-    POP3_HAS_XSENDER            = 0x00000001,</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-    POP3_GURL_UNDEFINED         = 0x00000002,</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineminus">-    POP3_HAS_GURL               = 0x00000004,</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-    POP3_UIDL_UNDEFINED         = 0x00000008,</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-    POP3_HAS_UIDL               = 0x00000010,</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-    POP3_XTND_XLST_UNDEFINED    = 0x00000020,</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineminus">-    POP3_HAS_XTND_XLST          = 0x00000040,</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-    POP3_TOP_UNDEFINED          = 0x00000080,</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-    POP3_HAS_TOP                = 0x00000100,</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-    POP3_AUTH_MECH_UNDEFINED    = 0x00000200,</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-    POP3_HAS_AUTH_USER          = 0x00000400,</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-    POP3_HAS_AUTH_LOGIN         = 0x00000800,</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-    POP3_HAS_AUTH_PLAIN         = 0x00001000,</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineminus">-    POP3_HAS_AUTH_CRAM_MD5      = 0x00002000,</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-    POP3_HAS_AUTH_APOP          = 0x00004000,</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-    POP3_HAS_AUTH_NTLM          = 0x00008000,</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-    POP3_HAS_AUTH_MSN           = 0x00010000,</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-    POP3_HAS_RESP_CODES         = 0x00020000,</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-    POP3_HAS_AUTH_RESP_CODE     = 0x00040000,</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-    POP3_HAS_STLS               = 0x00080000,</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineminus">-    POP3_HAS_AUTH_GSSAPI        = 0x00100000</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+  POP3_CAPABILITY_UNDEFINED = 0x00000000,</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+  POP3_HAS_XSENDER = 0x00000001,</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+  POP3_GURL_UNDEFINED = 0x00000002,</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+  POP3_HAS_GURL = 0x00000004,</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+  POP3_UIDL_UNDEFINED = 0x00000008,</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+  POP3_HAS_UIDL = 0x00000010,</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+  POP3_XTND_XLST_UNDEFINED = 0x00000020,</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+  POP3_HAS_XTND_XLST = 0x00000040,</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+  POP3_TOP_UNDEFINED = 0x00000080,</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  POP3_HAS_TOP = 0x00000100,</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+  POP3_AUTH_MECH_UNDEFINED = 0x00000200,</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+  POP3_HAS_AUTH_USER = 0x00000400,</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  POP3_HAS_AUTH_LOGIN = 0x00000800,</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+  POP3_HAS_AUTH_PLAIN = 0x00001000,</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+  POP3_HAS_AUTH_CRAM_MD5 = 0x00002000,</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+  POP3_HAS_AUTH_APOP = 0x00004000,</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  POP3_HAS_AUTH_NTLM = 0x00008000,</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+  POP3_HAS_AUTH_MSN = 0x00010000,</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+  POP3_HAS_RESP_CODES = 0x00020000,</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+  POP3_HAS_AUTH_RESP_CODE = 0x00040000,</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+  POP3_HAS_STLS = 0x00080000,</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+  POP3_HAS_AUTH_GSSAPI = 0x00100000</span>
<a href="#l35.84"></a><span id="l35.84"> };</span>
<a href="#l35.85"></a><span id="l35.85"> </span>
<a href="#l35.86"></a><span id="l35.86"> // TODO use value &gt; 0?</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineminus">-#define POP3_HAS_AUTH_NONE        0</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineminus">-#define POP3_HAS_AUTH_ANY         0x00001C00</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineminus">-#define POP3_HAS_AUTH_ANY_SEC     0x0011E000</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+#define POP3_HAS_AUTH_NONE 0</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+#define POP3_HAS_AUTH_ANY 0x00001C00</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+#define POP3_HAS_AUTH_ANY_SEC 0x0011E000</span>
<a href="#l35.93"></a><span id="l35.93"> </span>
<a href="#l35.94"></a><span id="l35.94"> enum Pop3StatesEnum {</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-    POP3_READ_PASSWORD,                         // 0</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineminus">-                                                //</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineminus">-    POP3_START_CONNECT,                         // 1</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineminus">-    POP3_FINISH_CONNECT,                        // 2</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineminus">-    POP3_WAIT_FOR_RESPONSE,                     // 3</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineminus">-    POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE, // 4</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineminus">-    POP3_SEND_USERNAME,                         // 5</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+  POP3_READ_PASSWORD,                          // 0</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+                                               //</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+  POP3_START_CONNECT,                          // 1</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+  POP3_FINISH_CONNECT,                         // 2</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  POP3_WAIT_FOR_RESPONSE,                      // 3</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+  POP3_WAIT_FOR_START_OF_CONNECTION_RESPONSE,  // 4</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+  POP3_SEND_USERNAME,                          // 5</span>
<a href="#l35.109"></a><span id="l35.109"> </span>
<a href="#l35.110"></a><span id="l35.110" class="difflineminus">-    POP3_SEND_PASSWORD,                         // 6</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineminus">-    POP3_SEND_STAT,                             // 7</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineminus">-    POP3_GET_STAT,                              // 8</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineminus">-    POP3_SEND_LIST,                             // 9</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineminus">-    POP3_GET_LIST,                              // 10</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+  POP3_SEND_PASSWORD,  // 6</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+  POP3_SEND_STAT,      // 7</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+  POP3_GET_STAT,       // 8</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+  POP3_SEND_LIST,      // 9</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+  POP3_GET_LIST,       // 10</span>
<a href="#l35.120"></a><span id="l35.120"> </span>
<a href="#l35.121"></a><span id="l35.121" class="difflineminus">-    POP3_SEND_UIDL_LIST,                        // 11</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineminus">-    POP3_GET_UIDL_LIST,                         // 12</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineminus">-    POP3_SEND_XTND_XLST_MSGID,                  // 13</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-    POP3_GET_XTND_XLST_MSGID,                   // 14</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineminus">-    POP3_GET_MSG,                               // 15</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+  POP3_SEND_UIDL_LIST,        // 11</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+  POP3_GET_UIDL_LIST,         // 12</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+  POP3_SEND_XTND_XLST_MSGID,  // 13</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  POP3_GET_XTND_XLST_MSGID,   // 14</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+  POP3_GET_MSG,               // 15</span>
<a href="#l35.131"></a><span id="l35.131"> </span>
<a href="#l35.132"></a><span id="l35.132" class="difflineminus">-    POP3_SEND_TOP,                              // 16</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineminus">-    POP3_TOP_RESPONSE,                          // 17</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineminus">-    POP3_SEND_RETR,                             // 18</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-    POP3_RETR_RESPONSE,                         // 19</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-    POP3_SEND_DELE,                             // 20</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+  POP3_SEND_TOP,       // 16</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+  POP3_TOP_RESPONSE,   // 17</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+  POP3_SEND_RETR,      // 18</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  POP3_RETR_RESPONSE,  // 19</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+  POP3_SEND_DELE,      // 20</span>
<a href="#l35.142"></a><span id="l35.142"> </span>
<a href="#l35.143"></a><span id="l35.143" class="difflineminus">-    POP3_DELE_RESPONSE,                         // 21</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineminus">-    POP3_SEND_QUIT,                             // 22</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineminus">-    POP3_DONE,                                  // 23</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineminus">-    POP3_ERROR_DONE,                            // 24</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineminus">-    POP3_FREE,                                  // 25</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineminus">-    POP3_SEND_AUTH,                             // 26</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineminus">-    POP3_AUTH_RESPONSE,                         // 27</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineminus">-    POP3_SEND_CAPA,                             // 28</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineminus">-    POP3_CAPA_RESPONSE,                         // 29</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineminus">-    POP3_PROCESS_AUTH,                          // 30</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineminus">-    POP3_NEXT_AUTH_STEP,                        // 31</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+  POP3_DELE_RESPONSE,   // 21</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+  POP3_SEND_QUIT,       // 22</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+  POP3_DONE,            // 23</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+  POP3_ERROR_DONE,      // 24</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+  POP3_FREE,            // 25</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+  POP3_SEND_AUTH,       // 26</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+  POP3_AUTH_RESPONSE,   // 27</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+  POP3_SEND_CAPA,       // 28</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+  POP3_CAPA_RESPONSE,   // 29</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+  POP3_PROCESS_AUTH,    // 30</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+  POP3_NEXT_AUTH_STEP,  // 31</span>
<a href="#l35.165"></a><span id="l35.165"> </span>
<a href="#l35.166"></a><span id="l35.166" class="difflineminus">-    POP3_AUTH_LOGIN,                            // 32</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineminus">-    POP3_AUTH_LOGIN_RESPONSE,                   // 33</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineminus">-    POP3_AUTH_NTLM,                             // 34</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineminus">-    POP3_AUTH_NTLM_RESPONSE,                    // 35</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineminus">-    POP3_SEND_XSENDER,                          // 36</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineminus">-    POP3_XSENDER_RESPONSE,                      // 37</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineminus">-    POP3_SEND_GURL,                             // 38</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+  POP3_AUTH_LOGIN,           // 32</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+  POP3_AUTH_LOGIN_RESPONSE,  // 33</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+  POP3_AUTH_NTLM,            // 34</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+  POP3_AUTH_NTLM_RESPONSE,   // 35</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+  POP3_SEND_XSENDER,         // 36</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+  POP3_XSENDER_RESPONSE,     // 37</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+  POP3_SEND_GURL,            // 38</span>
<a href="#l35.180"></a><span id="l35.180"> </span>
<a href="#l35.181"></a><span id="l35.181" class="difflineminus">-    POP3_GURL_RESPONSE,                         // 39</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineminus">-    POP3_QUIT_RESPONSE,                         // 40</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineminus">-    POP3_TLS_RESPONSE,                          // 41</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+  POP3_GURL_RESPONSE,  // 39</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+  POP3_QUIT_RESPONSE,  // 40</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+  POP3_TLS_RESPONSE,   // 41</span>
<a href="#l35.187"></a><span id="l35.187"> </span>
<a href="#l35.188"></a><span id="l35.188" class="difflineminus">-    POP3_AUTH_GSSAPI,                           // 42</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineminus">-    POP3_AUTH_GSSAPI_FIRST,                     // 43</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineminus">-    POP3_AUTH_GSSAPI_STEP,                      // 44</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+  POP3_AUTH_GSSAPI,        // 42</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+  POP3_AUTH_GSSAPI_FIRST,  // 43</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+  POP3_AUTH_GSSAPI_STEP,   // 44</span>
<a href="#l35.194"></a><span id="l35.194"> </span>
<a href="#l35.195"></a><span id="l35.195" class="difflineminus">-    /**</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineminus">-     * Async wait to obtain the password and deal with the result.</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineminus">-     * The *PREOBTAIN* states are used for where we try and get the password</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineminus">-     * before we've initiated a connection to the server.</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineminus">-     */</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineminus">-    POP3_OBTAIN_PASSWORD_EARLY,                 // 45</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineminus">-    POP3_FINISH_OBTAIN_PASSWORD_EARLY,          // 46</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineminus">-    POP3_OBTAIN_PASSWORD_BEFORE_USERNAME,       // 47</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineminus">-    POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME,// 48</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineminus">-    POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD,       // 49</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineminus">-    POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD // 50</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+  /**</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+   * Async wait to obtain the password and deal with the result.</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+   * The *PREOBTAIN* states are used for where we try and get the password</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+   * before we've initiated a connection to the server.</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+   */</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+  POP3_OBTAIN_PASSWORD_EARLY,                   // 45</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+  POP3_FINISH_OBTAIN_PASSWORD_EARLY,            // 46</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+  POP3_OBTAIN_PASSWORD_BEFORE_USERNAME,         // 47</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+  POP3_FINISH_OBTAIN_PASSWORD_BEFORE_USERNAME,  // 48</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+  POP3_OBTAIN_PASSWORD_BEFORE_PASSWORD,         // 49</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+  POP3_FINISH_OBTAIN_PASSWORD_BEFORE_PASSWORD   // 50</span>
<a href="#l35.217"></a><span id="l35.217"> };</span>
<a href="#l35.218"></a><span id="l35.218"> </span>
<a href="#l35.219"></a><span id="l35.219" class="difflineminus">-</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineminus">-#define KEEP        'k'         /* If we want to keep this item on server. */</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineminus">-#define DELETE_CHAR 'd'         /* If we want to delete this item. */</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineminus">-#define TOO_BIG     'b'         /* item left on server because it was too big */</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineminus">-#define FETCH_BODY  'f'         /* Fetch full body of a partial msg */</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+#define KEEP 'k'        /* If we want to keep this item on server. */</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+#define DELETE_CHAR 'd' /* If we want to delete this item. */</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+#define TOO_BIG 'b'     /* item left on server because it was too big */</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+#define FETCH_BODY 'f'  /* Fetch full body of a partial msg */</span>
<a href="#l35.228"></a><span id="l35.228"> </span>
<a href="#l35.229"></a><span id="l35.229"> typedef struct Pop3UidlEntry { /* information about this message */</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineminus">-    char* uidl;</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineminus">-    char  status; // KEEP=='k', DELETE='d' TOO_BIG='b' FETCH_BODY='f'</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineminus">-    uint32_t dateReceived; // time message received, used for aging</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+  char* uidl;</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+  char status;            // KEEP=='k', DELETE='d' TOO_BIG='b' FETCH_BODY='f'</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+  uint32_t dateReceived;  // time message received, used for aging</span>
<a href="#l35.236"></a><span id="l35.236"> } Pop3UidlEntry;</span>
<a href="#l35.237"></a><span id="l35.237"> </span>
<a href="#l35.238"></a><span id="l35.238"> typedef struct Pop3UidlHost {</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineminus">-    char* host;</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineminus">-    char* user;</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineminus">-    PLHashTable * hash;</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineminus">-    Pop3UidlEntry* uidlEntries;</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineminus">-    struct Pop3UidlHost* next;</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+  char* host;</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+  char* user;</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+  PLHashTable* hash;</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+  Pop3UidlEntry* uidlEntries;</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+  struct Pop3UidlHost* next;</span>
<a href="#l35.249"></a><span id="l35.249"> } Pop3UidlHost;</span>
<a href="#l35.250"></a><span id="l35.250"> </span>
<a href="#l35.251"></a><span id="l35.251"> typedef struct Pop3MsgInfo {</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineminus">-    int32_t msgnum;</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineminus">-    int32_t size;</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineminus">-    char* uidl;</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+  int32_t msgnum;</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+  int32_t size;</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+  char* uidl;</span>
<a href="#l35.258"></a><span id="l35.258"> } Pop3MsgInfo;</span>
<a href="#l35.259"></a><span id="l35.259"> </span>
<a href="#l35.260"></a><span id="l35.260"> typedef struct _Pop3ConData {</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineminus">-    bool leave_on_server;     /* Whether we're supposed to leave messages</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineminus">-                                   on server. */</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineminus">-    bool headers_only;        /* Whether to just fetch headers on initial</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineminus">-                                   downloads. */</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineminus">-    int32_t size_limit;         /* Leave messages bigger than this on the</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineminus">-                                   server and only download a partial</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineminus">-                                   message. */</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineminus">-    uint32_t capability_flags; /* What capability this server has? */</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+  bool leave_on_server;      /* Whether we're supposed to leave messages</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+                                  on server. */</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+  bool headers_only;         /* Whether to just fetch headers on initial</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+                                  downloads. */</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+  int32_t size_limit;        /* Leave messages bigger than this on the</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+                                server and only download a partial</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+                                message. */</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+  uint32_t capability_flags; /* What capability this server has? */</span>
<a href="#l35.277"></a><span id="l35.277"> </span>
<a href="#l35.278"></a><span id="l35.278" class="difflineminus">-    Pop3StatesEnum next_state;  /* the next state or action to be taken */</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineminus">-    Pop3StatesEnum next_state_after_response;</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineminus">-    bool pause_for_read;       /* Pause now for next read? */</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+  Pop3StatesEnum next_state; /* the next state or action to be taken */</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+  Pop3StatesEnum next_state_after_response;</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+  bool pause_for_read; /* Pause now for next read? */</span>
<a href="#l35.284"></a><span id="l35.284"> </span>
<a href="#l35.285"></a><span id="l35.285" class="difflineminus">-    bool command_succeeded;   /* did the last command succeed? */</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineminus">-    bool list_done;    /* did we get the complete list of msgIDs? */</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineminus">-    int32_t first_msg;</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+  bool command_succeeded; /* did the last command succeed? */</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+  bool list_done;         /* did we get the complete list of msgIDs? */</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+  int32_t first_msg;</span>
<a href="#l35.291"></a><span id="l35.291"> </span>
<a href="#l35.292"></a><span id="l35.292" class="difflineminus">-    uint32_t obuffer_size;</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineminus">-    uint32_t obuffer_fp;</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+  uint32_t obuffer_size;</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+  uint32_t obuffer_fp;</span>
<a href="#l35.296"></a><span id="l35.296"> </span>
<a href="#l35.297"></a><span id="l35.297" class="difflineminus">-    int32_t  really_new_messages;</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineminus">-    int32_t  real_new_counter;</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineminus">-    int32_t number_of_messages;</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineminus">-    Pop3MsgInfo  *msg_info;      /* Message sizes and uidls (used only if we</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineminus">-                                   are playing games that involve leaving</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineminus">-                                   messages on the server). */</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineminus">-    int32_t last_accessed_msg;</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineminus">-    int32_t cur_msg_size;</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineminus">-    bool truncating_cur_msg;  /* are we using top and uidl? */</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineminus">-    bool msg_del_started;     /* True if MSG_BeginMailDel...</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineminus">-                                 * called</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineminus">-                                 */</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineminus">-    bool only_check_for_new_mail;</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineminus">-    nsMsgBiffState biffstate;     /* If just checking for, what the answer is. */</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+  int32_t really_new_messages;</span>
<a href="#l35.312"></a><span id="l35.312" class="difflineplus">+  int32_t real_new_counter;</span>
<a href="#l35.313"></a><span id="l35.313" class="difflineplus">+  int32_t number_of_messages;</span>
<a href="#l35.314"></a><span id="l35.314" class="difflineplus">+  Pop3MsgInfo* msg_info; /* Message sizes and uidls (used only if we</span>
<a href="#l35.315"></a><span id="l35.315" class="difflineplus">+                           are playing games that involve leaving</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineplus">+                           messages on the server). */</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineplus">+  int32_t last_accessed_msg;</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineplus">+  int32_t cur_msg_size;</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineplus">+  bool truncating_cur_msg; /* are we using top and uidl? */</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineplus">+  bool msg_del_started;    /* True if MSG_BeginMailDel...</span>
<a href="#l35.321"></a><span id="l35.321" class="difflineplus">+                            * called</span>
<a href="#l35.322"></a><span id="l35.322" class="difflineplus">+                            */</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineplus">+  bool only_check_for_new_mail;</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineplus">+  nsMsgBiffState biffstate; /* If just checking for, what the answer is. */</span>
<a href="#l35.325"></a><span id="l35.325"> </span>
<a href="#l35.326"></a><span id="l35.326" class="difflineminus">-    bool verify_logon;        /* true if we're just seeing if we can logon */</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineplus">+  bool verify_logon; /* true if we're just seeing if we can logon */</span>
<a href="#l35.328"></a><span id="l35.328"> </span>
<a href="#l35.329"></a><span id="l35.329" class="difflineminus">-    void *msg_closure;</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineplus">+  void* msg_closure;</span>
<a href="#l35.331"></a><span id="l35.331"> </span>
<a href="#l35.332"></a><span id="l35.332" class="difflineminus">-    bool graph_progress_bytes_p; /* whether we should display info about</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineminus">-                                      the bytes transferred (usually we</span>
<a href="#l35.334"></a><span id="l35.334" class="difflineminus">-                                      display info about the number of</span>
<a href="#l35.335"></a><span id="l35.335" class="difflineminus">-                                      messages instead.) */</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineplus">+  bool graph_progress_bytes_p; /* whether we should display info about</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineplus">+                                    the bytes transferred (usually we</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineplus">+                                    display info about the number of</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+                                    messages instead.) */</span>
<a href="#l35.340"></a><span id="l35.340"> </span>
<a href="#l35.341"></a><span id="l35.341" class="difflineminus">-    Pop3UidlHost *uidlinfo;</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineminus">-    PLHashTable *newuidl;</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineminus">-    char *only_uidl;              /* If non-NULL, then load only this UIDL. */</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineplus">+  Pop3UidlHost* uidlinfo;</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineplus">+  PLHashTable* newuidl;</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+  char* only_uidl; /* If non-NULL, then load only this UIDL. */</span>
<a href="#l35.347"></a><span id="l35.347"> </span>
<a href="#l35.348"></a><span id="l35.348" class="difflineminus">-    bool get_url;</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineminus">-    bool seenFromHeader;</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineminus">-    int32_t parsed_bytes;</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineminus">-    int32_t pop3_size;</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineminus">-    bool dot_fix;</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineminus">-    bool assumed_end;</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineminus">-    nsresult urlStatus;</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+  bool get_url;</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineplus">+  bool seenFromHeader;</span>
<a href="#l35.357"></a><span id="l35.357" class="difflineplus">+  int32_t parsed_bytes;</span>
<a href="#l35.358"></a><span id="l35.358" class="difflineplus">+  int32_t pop3_size;</span>
<a href="#l35.359"></a><span id="l35.359" class="difflineplus">+  bool dot_fix;</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineplus">+  bool assumed_end;</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineplus">+  nsresult urlStatus;</span>
<a href="#l35.362"></a><span id="l35.362"> } Pop3ConData;</span>
<a href="#l35.363"></a><span id="l35.363"> </span>
<a href="#l35.364"></a><span id="l35.364"> // State Flags (Note, I use the word state in terms of storing</span>
<a href="#l35.365"></a><span id="l35.365"> // state information about the connection (authentication, have we sent</span>
<a href="#l35.366"></a><span id="l35.366"> // commands, etc. I do not intend it to refer to protocol state)</span>
<a href="#l35.367"></a><span id="l35.367" class="difflineminus">-#define POP3_PAUSE_FOR_READ      0x00000001  /* should we pause for the next read */</span>
<a href="#l35.368"></a><span id="l35.368" class="difflineminus">-#define POP3_PASSWORD_FAILED    0x00000002</span>
<a href="#l35.369"></a><span id="l35.369" class="difflineminus">-#define POP3_STOPLOGIN              0x00000004  /* error logging in, so stop here */</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineminus">-#define POP3_AUTH_FAILURE           0x00000008  /* extended code said authentication failed */</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineminus">-</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+#define POP3_PAUSE_FOR_READ 0x00000001 /* should we pause for the next read */</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineplus">+#define POP3_PASSWORD_FAILED 0x00000002</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineplus">+#define POP3_STOPLOGIN 0x00000004 /* error logging in, so stop here */</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineplus">+#define POP3_AUTH_FAILURE \</span>
<a href="#l35.376"></a><span id="l35.376" class="difflineplus">+  0x00000008 /* extended code said authentication failed */</span>
<a href="#l35.377"></a><span id="l35.377"> </span>
<a href="#l35.378"></a><span id="l35.378"> class nsPop3Protocol : public nsMsgProtocol,</span>
<a href="#l35.379"></a><span id="l35.379">                        public nsIPop3Protocol,</span>
<a href="#l35.380"></a><span id="l35.380">                        public nsIMsgAsyncPromptListener,</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineminus">-                       public nsIProtocolProxyCallback</span>
<a href="#l35.382"></a><span id="l35.382" class="difflineminus">-{</span>
<a href="#l35.383"></a><span id="l35.383" class="difflineminus">-public:</span>
<a href="#l35.384"></a><span id="l35.384" class="difflineplus">+                       public nsIProtocolProxyCallback {</span>
<a href="#l35.385"></a><span id="l35.385" class="difflineplus">+ public:</span>
<a href="#l35.386"></a><span id="l35.386">   explicit nsPop3Protocol(nsIURI* aURL);</span>
<a href="#l35.387"></a><span id="l35.387"> </span>
<a href="#l35.388"></a><span id="l35.388">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l35.389"></a><span id="l35.389">   NS_DECL_NSIPOP3PROTOCOL</span>
<a href="#l35.390"></a><span id="l35.390">   NS_DECL_NSIMSGASYNCPROMPTLISTENER</span>
<a href="#l35.391"></a><span id="l35.391">   NS_DECL_NSIPROTOCOLPROXYCALLBACK</span>
<a href="#l35.392"></a><span id="l35.392"> </span>
<a href="#l35.393"></a><span id="l35.393" class="difflineminus">-  nsresult Initialize(nsIURI * aURL);</span>
<a href="#l35.394"></a><span id="l35.394" class="difflineplus">+  nsresult Initialize(nsIURI* aURL);</span>
<a href="#l35.395"></a><span id="l35.395">   nsresult InitializeInternal(nsIProxyInfo* proxyInfo);</span>
<a href="#l35.396"></a><span id="l35.396" class="difflineminus">-  virtual nsresult LoadUrl(nsIURI *aURL, nsISupports * aConsumer = nullptr) override;</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineminus">-  nsresult LoadUrlInternal(nsIURI *aURL);</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+  virtual nsresult LoadUrl(nsIURI* aURL,</span>
<a href="#l35.399"></a><span id="l35.399" class="difflineplus">+                           nsISupports* aConsumer = nullptr) override;</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineplus">+  nsresult LoadUrlInternal(nsIURI* aURL);</span>
<a href="#l35.401"></a><span id="l35.401">   void Cleanup();</span>
<a href="#l35.402"></a><span id="l35.402"> </span>
<a href="#l35.403"></a><span id="l35.403">   const char* GetUsername() { return m_username.get(); }</span>
<a href="#l35.404"></a><span id="l35.404">   void SetUsername(const char* name);</span>
<a href="#l35.405"></a><span id="l35.405"> </span>
<a href="#l35.406"></a><span id="l35.406">   nsresult StartGetAsyncPassword(Pop3StatesEnum aNextState);</span>
<a href="#l35.407"></a><span id="l35.407"> </span>
<a href="#l35.408"></a><span id="l35.408" class="difflineminus">-  NS_IMETHOD OnTransportStatus(nsITransport *transport, nsresult status, int64_t progress, int64_t progressMax) override;</span>
<a href="#l35.409"></a><span id="l35.409" class="difflineminus">-  NS_IMETHOD OnStopRequest(nsIRequest *request, nsresult aStatus) override;</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineplus">+  NS_IMETHOD OnTransportStatus(nsITransport* transport, nsresult status,</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineplus">+                               int64_t progress, int64_t progressMax) override;</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineplus">+  NS_IMETHOD OnStopRequest(nsIRequest* request, nsresult aStatus) override;</span>
<a href="#l35.413"></a><span id="l35.413">   NS_IMETHOD Cancel(nsresult status) override;</span>
<a href="#l35.414"></a><span id="l35.414"> </span>
<a href="#l35.415"></a><span id="l35.415" class="difflineminus">-  static void MarkMsgInHashTable(PLHashTable *hashTable, const Pop3UidlEntry *uidl,</span>
<a href="#l35.416"></a><span id="l35.416" class="difflineminus">-                                  bool *changed);</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineplus">+  static void MarkMsgInHashTable(PLHashTable* hashTable,</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineplus">+                                 const Pop3UidlEntry* uidl, bool* changed);</span>
<a href="#l35.419"></a><span id="l35.419"> </span>
<a href="#l35.420"></a><span id="l35.420" class="difflineminus">-  static nsresult MarkMsgForHost(const char *hostName, const char *userName,</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineminus">-                                      nsIFile *mailDirectory,</span>
<a href="#l35.422"></a><span id="l35.422" class="difflineminus">-                                      nsTArray&lt;Pop3UidlEntry*&gt; &amp;UIDLArray);</span>
<a href="#l35.423"></a><span id="l35.423" class="difflineminus">-private:</span>
<a href="#l35.424"></a><span id="l35.424" class="difflineplus">+  static nsresult MarkMsgForHost(const char* hostName, const char* userName,</span>
<a href="#l35.425"></a><span id="l35.425" class="difflineplus">+                                 nsIFile* mailDirectory,</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineplus">+                                 nsTArray&lt;Pop3UidlEntry*&gt;&amp; UIDLArray);</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineplus">+</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineplus">+ private:</span>
<a href="#l35.429"></a><span id="l35.429">   virtual ~nsPop3Protocol();</span>
<a href="#l35.430"></a><span id="l35.430">   nsCString m_ApopTimestamp;</span>
<a href="#l35.431"></a><span id="l35.431">   nsCOMPtr&lt;nsIStringBundle&gt; mLocalBundle;</span>
<a href="#l35.432"></a><span id="l35.432"> </span>
<a href="#l35.433"></a><span id="l35.433">   nsCString m_username;</span>
<a href="#l35.434"></a><span id="l35.434">   nsCString m_senderInfo;</span>
<a href="#l35.435"></a><span id="l35.435">   nsCString m_commandResponse;</span>
<a href="#l35.436"></a><span id="l35.436">   nsCString m_GSSAPICache;</span>
<a href="#l35.437"></a><span id="l35.437"> </span>
<a href="#l35.438"></a><span id="l35.438">   // Used for asynchronous password prompts to store the password temporarily.</span>
<a href="#l35.439"></a><span id="l35.439">   nsString m_passwordResult;</span>
<a href="#l35.440"></a><span id="l35.440"> </span>
<a href="#l35.441"></a><span id="l35.441">   // progress state information</span>
<a href="#l35.442"></a><span id="l35.442">   void UpdateProgressPercent(int64_t totalDone, int64_t total);</span>
<a href="#l35.443"></a><span id="l35.443" class="difflineminus">-  void UpdateStatus(const char *aStatusName);</span>
<a href="#l35.444"></a><span id="l35.444" class="difflineminus">-  void UpdateStatusWithString(const char16_t *aString);</span>
<a href="#l35.445"></a><span id="l35.445" class="difflineminus">-  nsresult FormatCounterString(const nsString &amp;stringName,</span>
<a href="#l35.446"></a><span id="l35.446" class="difflineminus">-                               uint32_t count1,</span>
<a href="#l35.447"></a><span id="l35.447" class="difflineminus">-                               uint32_t count2,</span>
<a href="#l35.448"></a><span id="l35.448" class="difflineminus">-                               nsString &amp;resultString);</span>
<a href="#l35.449"></a><span id="l35.449" class="difflineplus">+  void UpdateStatus(const char* aStatusName);</span>
<a href="#l35.450"></a><span id="l35.450" class="difflineplus">+  void UpdateStatusWithString(const char16_t* aString);</span>
<a href="#l35.451"></a><span id="l35.451" class="difflineplus">+  nsresult FormatCounterString(const nsString&amp; stringName, uint32_t count1,</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineplus">+                               uint32_t count2, nsString&amp; resultString);</span>
<a href="#l35.453"></a><span id="l35.453"> </span>
<a href="#l35.454"></a><span id="l35.454">   int32_t m_bytesInMsgReceived;</span>
<a href="#l35.455"></a><span id="l35.455">   int64_t m_totalFolderSize;</span>
<a href="#l35.456"></a><span id="l35.456" class="difflineminus">-  int64_t m_totalDownloadSize;  /* Number of bytes we're going to</span>
<a href="#l35.457"></a><span id="l35.457" class="difflineminus">-                                   download.  Might be much less</span>
<a href="#l35.458"></a><span id="l35.458" class="difflineminus">-                                   than the total_folder_size. */</span>
<a href="#l35.459"></a><span id="l35.459" class="difflineminus">-  int64_t m_totalBytesReceived; // total # bytes received for the connection</span>
<a href="#l35.460"></a><span id="l35.460" class="difflineplus">+  int64_t m_totalDownloadSize;   /* Number of bytes we're going to</span>
<a href="#l35.461"></a><span id="l35.461" class="difflineplus">+                                    download.  Might be much less</span>
<a href="#l35.462"></a><span id="l35.462" class="difflineplus">+                                    than the total_folder_size. */</span>
<a href="#l35.463"></a><span id="l35.463" class="difflineplus">+  int64_t m_totalBytesReceived;  // total # bytes received for the connection</span>
<a href="#l35.464"></a><span id="l35.464"> </span>
<a href="#l35.465"></a><span id="l35.465" class="difflineminus">-  virtual nsresult ProcessProtocolState(nsIURI * url, nsIInputStream * inputStream,</span>
<a href="#l35.466"></a><span id="l35.466" class="difflineminus">-                                        uint64_t sourceOffset, uint32_t length) override;</span>
<a href="#l35.467"></a><span id="l35.467" class="difflineminus">-  virtual int32_t Pop3SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l35.468"></a><span id="l35.468" class="difflineplus">+  virtual nsresult ProcessProtocolState(nsIURI* url,</span>
<a href="#l35.469"></a><span id="l35.469" class="difflineplus">+                                        nsIInputStream* inputStream,</span>
<a href="#l35.470"></a><span id="l35.470" class="difflineplus">+                                        uint64_t sourceOffset,</span>
<a href="#l35.471"></a><span id="l35.471" class="difflineplus">+                                        uint32_t length) override;</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineplus">+  virtual int32_t Pop3SendData(const char* dataBuffer,</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineplus">+                               bool aSuppressLogging = false);</span>
<a href="#l35.474"></a><span id="l35.474"> </span>
<a href="#l35.475"></a><span id="l35.475" class="difflineminus">-  virtual const char* GetType() override {return &quot;pop3&quot;;}</span>
<a href="#l35.476"></a><span id="l35.476" class="difflineplus">+  virtual const char* GetType() override { return &quot;pop3&quot;; }</span>
<a href="#l35.477"></a><span id="l35.477"> </span>
<a href="#l35.478"></a><span id="l35.478">   nsCOMPtr&lt;nsIURI&gt; m_url;</span>
<a href="#l35.479"></a><span id="l35.479">   nsCOMPtr&lt;nsIPop3Sink&gt; m_nsIPop3Sink;</span>
<a href="#l35.480"></a><span id="l35.480">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; m_pop3Server;</span>
<a href="#l35.481"></a><span id="l35.481"> </span>
<a href="#l35.482"></a><span id="l35.482" class="difflineminus">-  RefPtr&lt;nsMsgLineStreamBuffer&gt; m_lineStreamBuffer; // used to efficiently extract lines from the incoming data stream</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineplus">+  RefPtr&lt;nsMsgLineStreamBuffer&gt;</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineplus">+      m_lineStreamBuffer;  // used to efficiently extract lines from the</span>
<a href="#l35.485"></a><span id="l35.485" class="difflineplus">+                           // incoming data stream</span>
<a href="#l35.486"></a><span id="l35.486">   Pop3ConData* m_pop3ConData;</span>
<a href="#l35.487"></a><span id="l35.487">   void FreeMsgInfo();</span>
<a href="#l35.488"></a><span id="l35.488">   void Abort();</span>
<a href="#l35.489"></a><span id="l35.489"> </span>
<a href="#l35.490"></a><span id="l35.490">   bool m_tlsEnabled;</span>
<a href="#l35.491"></a><span id="l35.491">   int32_t m_socketType;</span>
<a href="#l35.492"></a><span id="l35.492">   bool m_password_already_sent;</span>
<a href="#l35.493"></a><span id="l35.493">   bool m_needToRerunUrl;</span>
<a href="#l35.494"></a><span id="l35.494"> </span>
<a href="#l35.495"></a><span id="l35.495">   void SetCapFlag(uint32_t flag);</span>
<a href="#l35.496"></a><span id="l35.496">   void ClearCapFlag(uint32_t flag);</span>
<a href="#l35.497"></a><span id="l35.497">   bool TestCapFlag(uint32_t flag);</span>
<a href="#l35.498"></a><span id="l35.498">   uint32_t GetCapFlags();</span>
<a href="#l35.499"></a><span id="l35.499"> </span>
<a href="#l35.500"></a><span id="l35.500" class="difflineminus">-  void    InitPrefAuthMethods(int32_t authMethodPrefValue);</span>
<a href="#l35.501"></a><span id="l35.501" class="difflineplus">+  void InitPrefAuthMethods(int32_t authMethodPrefValue);</span>
<a href="#l35.502"></a><span id="l35.502">   nsresult ChooseAuthMethod();</span>
<a href="#l35.503"></a><span id="l35.503" class="difflineminus">-  void    MarkAuthMethodAsFailed(int32_t failedAuthMethod);</span>
<a href="#l35.504"></a><span id="l35.504" class="difflineminus">-  void    ResetAuthMethods();</span>
<a href="#l35.505"></a><span id="l35.505" class="difflineminus">-  int32_t m_prefAuthMethods; // set of capability flags for auth methods</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineminus">-  int32_t m_failedAuthMethods; // ditto</span>
<a href="#l35.507"></a><span id="l35.507" class="difflineminus">-  int32_t m_currentAuthMethod; // exactly one capability flag, or 0</span>
<a href="#l35.508"></a><span id="l35.508" class="difflineplus">+  void MarkAuthMethodAsFailed(int32_t failedAuthMethod);</span>
<a href="#l35.509"></a><span id="l35.509" class="difflineplus">+  void ResetAuthMethods();</span>
<a href="#l35.510"></a><span id="l35.510" class="difflineplus">+  int32_t m_prefAuthMethods;    // set of capability flags for auth methods</span>
<a href="#l35.511"></a><span id="l35.511" class="difflineplus">+  int32_t m_failedAuthMethods;  // ditto</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineplus">+  int32_t m_currentAuthMethod;  // exactly one capability flag, or 0</span>
<a href="#l35.513"></a><span id="l35.513"> </span>
<a href="#l35.514"></a><span id="l35.514">   int32_t m_listpos;</span>
<a href="#l35.515"></a><span id="l35.515"> </span>
<a href="#l35.516"></a><span id="l35.516" class="difflineminus">-  nsresult HandleLine(char *line, uint32_t line_length);</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineplus">+  nsresult HandleLine(char* line, uint32_t line_length);</span>
<a href="#l35.518"></a><span id="l35.518"> </span>
<a href="#l35.519"></a><span id="l35.519">   nsresult GetApopTimestamp();</span>
<a href="#l35.520"></a><span id="l35.520"> </span>
<a href="#l35.521"></a><span id="l35.521">   //////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineminus">-      // Begin Pop3 protocol state handlers</span>
<a href="#l35.523"></a><span id="l35.523" class="difflineminus">-      //////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.524"></a><span id="l35.524" class="difflineplus">+  // Begin Pop3 protocol state handlers</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.526"></a><span id="l35.526">   int32_t WaitForStartOfConnectionResponse(nsIInputStream* inputStream,</span>
<a href="#l35.527"></a><span id="l35.527">                                            uint32_t length);</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineminus">-  int32_t WaitForResponse(nsIInputStream* inputStream,</span>
<a href="#l35.529"></a><span id="l35.529" class="difflineminus">-                          uint32_t length);</span>
<a href="#l35.530"></a><span id="l35.530" class="difflineminus">-  int32_t Error(const char* err_code, const char16_t **params = nullptr,</span>
<a href="#l35.531"></a><span id="l35.531" class="difflineplus">+  int32_t WaitForResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l35.532"></a><span id="l35.532" class="difflineplus">+  int32_t Error(const char* err_code, const char16_t** params = nullptr,</span>
<a href="#l35.533"></a><span id="l35.533">                 uint32_t length = 0);</span>
<a href="#l35.534"></a><span id="l35.534">   int32_t SendAuth();</span>
<a href="#l35.535"></a><span id="l35.535">   int32_t AuthResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l35.536"></a><span id="l35.536">   int32_t SendCapa();</span>
<a href="#l35.537"></a><span id="l35.537">   int32_t CapaResponse(nsIInputStream* inputStream, uint32_t length);</span>
<a href="#l35.538"></a><span id="l35.538">   int32_t SendTLSResponse();</span>
<a href="#l35.539"></a><span id="l35.539">   int32_t ProcessAuth();</span>
<a href="#l35.540"></a><span id="l35.540">   int32_t NextAuthStep();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l36.5"></a><span id="l36.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.6"></a><span id="l36.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.7"></a><span id="l36.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12"> #include &quot;nsPop3Service.h&quot;</span>
<a href="#l36.13"></a><span id="l36.13"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l36.14"></a><span id="l36.14"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15"> </span>
<a href="#l36.16"></a><span id="l36.16"> #include &quot;nsPop3URL.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17"> #include &quot;nsPop3Sink.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18"> #include &quot;nsPop3Protocol.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineat">@@ -26,148 +26,134 @@</span>
<a href="#l36.20"></a><span id="l36.20"> #include &quot;nsLocalMailFolder.h&quot;</span>
<a href="#l36.21"></a><span id="l36.21"> #include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l36.22"></a><span id="l36.22"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l36.23"></a><span id="l36.23"> #include &quot;nsINetUtil.h&quot;</span>
<a href="#l36.24"></a><span id="l36.24"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l36.25"></a><span id="l36.25"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l36.26"></a><span id="l36.26"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l36.27"></a><span id="l36.27"> </span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-#define PREF_MAIL_ROOT_POP3 &quot;mail.root.pop3&quot;        // old - for backward compatibility only</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+#define PREF_MAIL_ROOT_POP3 \</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+  &quot;mail.root.pop3&quot;  // old - for backward compatibility only</span>
<a href="#l36.31"></a><span id="l36.31"> #define PREF_MAIL_ROOT_POP3_REL &quot;mail.root.pop3-rel&quot;</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33"> static NS_DEFINE_CID(kPop3UrlCID, NS_POP3URL_CID);</span>
<a href="#l36.34"></a><span id="l36.34"> </span>
<a href="#l36.35"></a><span id="l36.35" class="difflineminus">-nsPop3Service::nsPop3Service()</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineminus">-{</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">-}</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+nsPop3Service::nsPop3Service() {}</span>
<a href="#l36.39"></a><span id="l36.39"> </span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-nsPop3Service::~nsPop3Service()</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-{}</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+nsPop3Service::~nsPop3Service() {}</span>
<a href="#l36.43"></a><span id="l36.43"> </span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-NS_IMPL_ISUPPORTS(nsPop3Service,</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-                   nsIPop3Service,</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineminus">-                   nsIProtocolHandler,</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-                   nsIMsgProtocolInfo)</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+NS_IMPL_ISUPPORTS(nsPop3Service, nsIPop3Service, nsIProtocolHandler,</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+                  nsIMsgProtocolInfo)</span>
<a href="#l36.50"></a><span id="l36.50"> </span>
<a href="#l36.51"></a><span id="l36.51" class="difflineminus">-NS_IMETHODIMP nsPop3Service::CheckForNewMail(nsIMsgWindow* aMsgWindow,</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+NS_IMETHODIMP nsPop3Service::CheckForNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l36.53"></a><span id="l36.53">                                              nsIUrlListener *aUrlListener,</span>
<a href="#l36.54"></a><span id="l36.54">                                              nsIMsgFolder *aInbox,</span>
<a href="#l36.55"></a><span id="l36.55">                                              nsIPop3IncomingServer *aPopServer,</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-                                             nsIURI **aURL)</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-{</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineminus">-  return GetMail(false /* don't download, just check */,</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-                 aMsgWindow, aUrlListener, aInbox, aPopServer, aURL);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+                                             nsIURI **aURL) {</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+  return GetMail(false /* don't download, just check */, aMsgWindow,</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+                 aUrlListener, aInbox, aPopServer, aURL);</span>
<a href="#l36.63"></a><span id="l36.63"> }</span>
<a href="#l36.64"></a><span id="l36.64"> </span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-</span>
<a href="#l36.66"></a><span id="l36.66"> nsresult nsPop3Service::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l36.67"></a><span id="l36.67">                                    nsIUrlListener *aUrlListener,</span>
<a href="#l36.68"></a><span id="l36.68">                                    nsIMsgFolder *aInbox,</span>
<a href="#l36.69"></a><span id="l36.69">                                    nsIPop3IncomingServer *aPopServer,</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-                                   nsIURI **aURL)</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-{</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineminus">-  return GetMail(true /* download */,</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-                 aMsgWindow, aUrlListener, aInbox, aPopServer, aURL);</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+                                   nsIURI **aURL) {</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+  return GetMail(true /* download */, aMsgWindow, aUrlListener, aInbox,</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+                 aPopServer, aURL);</span>
<a href="#l36.77"></a><span id="l36.77"> }</span>
<a href="#l36.78"></a><span id="l36.78"> </span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-nsresult nsPop3Service::GetMail(bool downloadNewMail,</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineminus">-                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+nsresult nsPop3Service::GetMail(bool downloadNewMail, nsIMsgWindow *aMsgWindow,</span>
<a href="#l36.82"></a><span id="l36.82">                                 nsIUrlListener *aUrlListener,</span>
<a href="#l36.83"></a><span id="l36.83">                                 nsIMsgFolder *aInbox,</span>
<a href="#l36.84"></a><span id="l36.84">                                 nsIPop3IncomingServer *aPopServer,</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineminus">-                                nsIURI **aURL)</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineminus">-{</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineminus">-</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+                                nsIURI **aURL) {</span>
<a href="#l36.89"></a><span id="l36.89">   NS_ENSURE_ARG_POINTER(aInbox);</span>
<a href="#l36.90"></a><span id="l36.90">   int32_t popPort = -1;</span>
<a href="#l36.91"></a><span id="l36.91"> </span>
<a href="#l36.92"></a><span id="l36.92">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l36.93"></a><span id="l36.93">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l36.94"></a><span id="l36.94"> </span>
<a href="#l36.95"></a><span id="l36.95">   server = do_QueryInterface(aPopServer);</span>
<a href="#l36.96"></a><span id="l36.96">   NS_ENSURE_TRUE(server, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l36.97"></a><span id="l36.97"> </span>
<a href="#l36.98"></a><span id="l36.98">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; destLocalFolder = do_QueryInterface(aInbox);</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-  if (destLocalFolder)</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-  {</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+  if (destLocalFolder) {</span>
<a href="#l36.102"></a><span id="l36.102">     // We don't know the needed size yet, so at least check</span>
<a href="#l36.103"></a><span id="l36.103">     // if there is some free space (1MB) in the message store.</span>
<a href="#l36.104"></a><span id="l36.104">     bool destFolderTooBig;</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineminus">-    destLocalFolder-&gt;WarnIfLocalFileTooBig(aMsgWindow, 0xFFFF, &amp;destFolderTooBig);</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineminus">-    if (destFolderTooBig)</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineminus">-      return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+    destLocalFolder-&gt;WarnIfLocalFileTooBig(aMsgWindow, 0xFFFF,</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+                                           &amp;destFolderTooBig);</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+    if (destFolderTooBig) return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l36.111"></a><span id="l36.111">   }</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113">   nsCString popHost;</span>
<a href="#l36.114"></a><span id="l36.114">   nsCString popUser;</span>
<a href="#l36.115"></a><span id="l36.115">   nsresult rv = server-&gt;GetHostName(popHost);</span>
<a href="#l36.116"></a><span id="l36.116">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineminus">-  if (popHost.IsEmpty())</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineminus">-    return NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+  if (popHost.IsEmpty()) return NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l36.120"></a><span id="l36.120"> </span>
<a href="#l36.121"></a><span id="l36.121">   rv = server-&gt;GetPort(&amp;popPort);</span>
<a href="#l36.122"></a><span id="l36.122">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.123"></a><span id="l36.123"> </span>
<a href="#l36.124"></a><span id="l36.124">   rv = server-&gt;GetUsername(popUser);</span>
<a href="#l36.125"></a><span id="l36.125">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineminus">-  if (popUser.IsEmpty())</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineminus">-    return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+  if (popUser.IsEmpty()) return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l36.129"></a><span id="l36.129"> </span>
<a href="#l36.130"></a><span id="l36.130">   nsCString escapedUsername;</span>
<a href="#l36.131"></a><span id="l36.131">   MsgEscapeString(popUser, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l36.132"></a><span id="l36.132"> </span>
<a href="#l36.133"></a><span id="l36.133" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; aPopServer)</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineminus">-  {</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; aPopServer) {</span>
<a href="#l36.136"></a><span id="l36.136">     // now construct a pop3 url...</span>
<a href="#l36.137"></a><span id="l36.137">     // we need to escape the username because it may contain</span>
<a href="#l36.138"></a><span id="l36.138">     // characters like / % or @</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineminus">-    char * urlSpec = (downloadNewMail)</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-      ? PR_smprintf(&quot;pop3://%s@%s:%d&quot;, escapedUsername.get(), popHost.get(), popPort)</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-      : PR_smprintf(&quot;pop3://%s@%s:%d/?check&quot;, escapedUsername.get(), popHost.get(), popPort);</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-    rv = BuildPop3Url(urlSpec, aInbox, aPopServer, aUrlListener, getter_AddRefs(url), aMsgWindow);</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+    char *urlSpec =</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineplus">+        (downloadNewMail)</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+            ? PR_smprintf(&quot;pop3://%s@%s:%d&quot;, escapedUsername.get(),</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+                          popHost.get(), popPort)</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+            : PR_smprintf(&quot;pop3://%s@%s:%d/?check&quot;, escapedUsername.get(),</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+                          popHost.get(), popPort);</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+    rv = BuildPop3Url(urlSpec, aInbox, aPopServer, aUrlListener,</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+                      getter_AddRefs(url), aMsgWindow);</span>
<a href="#l36.151"></a><span id="l36.151">     PR_smprintf_free(urlSpec);</span>
<a href="#l36.152"></a><span id="l36.152">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.153"></a><span id="l36.153">   }</span>
<a href="#l36.154"></a><span id="l36.154"> </span>
<a href="#l36.155"></a><span id="l36.155">   NS_ENSURE_TRUE(url, rv);</span>
<a href="#l36.156"></a><span id="l36.156"> </span>
<a href="#l36.157"></a><span id="l36.157" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineminus">-    rv = RunPopUrl(server, url);</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = RunPopUrl(server, url);</span>
<a href="#l36.160"></a><span id="l36.160"> </span>
<a href="#l36.161"></a><span id="l36.161" class="difflineminus">-  if (aURL) // we already have a ref count on pop3url...</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+  if (aURL)  // we already have a ref count on pop3url...</span>
<a href="#l36.163"></a><span id="l36.163">     url.forget(aURL);</span>
<a href="#l36.164"></a><span id="l36.164"> </span>
<a href="#l36.165"></a><span id="l36.165">   return rv;</span>
<a href="#l36.166"></a><span id="l36.166"> }</span>
<a href="#l36.167"></a><span id="l36.167"> </span>
<a href="#l36.168"></a><span id="l36.168"> NS_IMETHODIMP nsPop3Service::VerifyLogon(nsIMsgIncomingServer *aServer,</span>
<a href="#l36.169"></a><span id="l36.169">                                          nsIUrlListener *aUrlListener,</span>
<a href="#l36.170"></a><span id="l36.170">                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-                                         nsIURI **aURL)</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineminus">-{</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+                                         nsIURI **aURL) {</span>
<a href="#l36.174"></a><span id="l36.174">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l36.175"></a><span id="l36.175">   nsCString popHost;</span>
<a href="#l36.176"></a><span id="l36.176">   nsCString popUser;</span>
<a href="#l36.177"></a><span id="l36.177">   int32_t popPort = -1;</span>
<a href="#l36.178"></a><span id="l36.178"> </span>
<a href="#l36.179"></a><span id="l36.179">   nsresult rv = aServer-&gt;GetHostName(popHost);</span>
<a href="#l36.180"></a><span id="l36.180">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.181"></a><span id="l36.181"> </span>
<a href="#l36.182"></a><span id="l36.182" class="difflineminus">-  if (popHost.IsEmpty())</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineminus">-    return NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+  if (popHost.IsEmpty()) return NS_MSG_INVALID_OR_MISSING_SERVER;</span>
<a href="#l36.185"></a><span id="l36.185"> </span>
<a href="#l36.186"></a><span id="l36.186">   rv = aServer-&gt;GetPort(&amp;popPort);</span>
<a href="#l36.187"></a><span id="l36.187">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.188"></a><span id="l36.188"> </span>
<a href="#l36.189"></a><span id="l36.189">   rv = aServer-&gt;GetUsername(popUser);</span>
<a href="#l36.190"></a><span id="l36.190">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.191"></a><span id="l36.191"> </span>
<a href="#l36.192"></a><span id="l36.192" class="difflineminus">-  if (popUser.IsEmpty())</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineminus">-    return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+  if (popUser.IsEmpty()) return NS_MSG_SERVER_USERNAME_MISSING;</span>
<a href="#l36.195"></a><span id="l36.195"> </span>
<a href="#l36.196"></a><span id="l36.196">   nsCString escapedUsername;</span>
<a href="#l36.197"></a><span id="l36.197">   MsgEscapeString(popUser, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l36.198"></a><span id="l36.198"> </span>
<a href="#l36.199"></a><span id="l36.199">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; popServer = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l36.200"></a><span id="l36.200">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.201"></a><span id="l36.201">   // now construct a pop3 url...</span>
<a href="#l36.202"></a><span id="l36.202">   // we need to escape the username because it may contain</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineat">@@ -176,320 +162,283 @@ NS_IMETHODIMP nsPop3Service::VerifyLogon</span>
<a href="#l36.204"></a><span id="l36.204">                               escapedUsername.get(), popHost.get(), popPort);</span>
<a href="#l36.205"></a><span id="l36.205">   NS_ENSURE_TRUE(urlSpec, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l36.206"></a><span id="l36.206"> </span>
<a href="#l36.207"></a><span id="l36.207">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l36.208"></a><span id="l36.208">   rv = BuildPop3Url(urlSpec, nullptr, popServer, aUrlListener,</span>
<a href="#l36.209"></a><span id="l36.209">                     getter_AddRefs(url), aMsgWindow);</span>
<a href="#l36.210"></a><span id="l36.210">   PR_smprintf_free(urlSpec);</span>
<a href="#l36.211"></a><span id="l36.211"> </span>
<a href="#l36.212"></a><span id="l36.212" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineminus">-  {</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; url) {</span>
<a href="#l36.215"></a><span id="l36.215">     rv = RunPopUrl(aServer, url);</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aURL)</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineminus">-      url.forget(aURL);</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aURL) url.forget(aURL);</span>
<a href="#l36.219"></a><span id="l36.219">   }</span>
<a href="#l36.220"></a><span id="l36.220"> </span>
<a href="#l36.221"></a><span id="l36.221">   return rv;</span>
<a href="#l36.222"></a><span id="l36.222"> }</span>
<a href="#l36.223"></a><span id="l36.223"> </span>
<a href="#l36.224"></a><span id="l36.224" class="difflineminus">-nsresult nsPop3Service::BuildPop3Url(const char *urlSpec,</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineminus">-                                     nsIMsgFolder *inbox,</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+nsresult nsPop3Service::BuildPop3Url(const char *urlSpec, nsIMsgFolder *inbox,</span>
<a href="#l36.227"></a><span id="l36.227">                                      nsIPop3IncomingServer *server,</span>
<a href="#l36.228"></a><span id="l36.228">                                      nsIUrlListener *aUrlListener,</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineminus">-                                     nsIURI **aUrl,</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineminus">-                                     nsIMsgWindow *aMsgWindow)</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineminus">-{</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+                                     nsIURI **aUrl, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l36.233"></a><span id="l36.233">   nsresult rv;</span>
<a href="#l36.234"></a><span id="l36.234"> </span>
<a href="#l36.235"></a><span id="l36.235">   nsPop3Sink *pop3Sink = new nsPop3Sink();</span>
<a href="#l36.236"></a><span id="l36.236"> </span>
<a href="#l36.237"></a><span id="l36.237">   NS_ENSURE_TRUE(pop3Sink, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l36.238"></a><span id="l36.238"> </span>
<a href="#l36.239"></a><span id="l36.239">   pop3Sink-&gt;SetPopServer(server);</span>
<a href="#l36.240"></a><span id="l36.240">   pop3Sink-&gt;SetFolder(inbox);</span>
<a href="#l36.241"></a><span id="l36.241"> </span>
<a href="#l36.242"></a><span id="l36.242">   // now create a pop3 url and a protocol instance to run the url....</span>
<a href="#l36.243"></a><span id="l36.243">   nsCOMPtr&lt;nsIPop3URL&gt; pop3Url = do_CreateInstance(kPop3UrlCID, &amp;rv);</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.246"></a><span id="l36.246"> </span>
<a href="#l36.247"></a><span id="l36.247">   pop3Url-&gt;SetPop3Sink(pop3Sink);</span>
<a href="#l36.248"></a><span id="l36.248"> </span>
<a href="#l36.249"></a><span id="l36.249">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl;</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineminus">-  rv = pop3Url-&gt;QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(mailnewsurl));</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+  rv = pop3Url-&gt;QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl),</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineplus">+                               getter_AddRefs(mailnewsurl));</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.255"></a><span id="l36.255"> </span>
<a href="#l36.256"></a><span id="l36.256">   rv = mailnewsurl-&gt;SetSpecInternal(nsDependentCString(urlSpec));</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.259"></a><span id="l36.259"> </span>
<a href="#l36.260"></a><span id="l36.260" class="difflineminus">-  if (aUrlListener)</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineminus">-    mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineminus">-    mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineplus">+  if (aUrlListener) mailnewsurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+  if (aMsgWindow) mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l36.266"></a><span id="l36.266"> </span>
<a href="#l36.267"></a><span id="l36.267">   mailnewsurl.forget(aUrl);</span>
<a href="#l36.268"></a><span id="l36.268"> </span>
<a href="#l36.269"></a><span id="l36.269">   return rv;</span>
<a href="#l36.270"></a><span id="l36.270"> }</span>
<a href="#l36.271"></a><span id="l36.271"> </span>
<a href="#l36.272"></a><span id="l36.272" class="difflineminus">-nsresult nsPop3Service::RunPopUrl(nsIMsgIncomingServer *aServer, nsIURI *aUrlToRun)</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineminus">-{</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineminus">-</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+nsresult nsPop3Service::RunPopUrl(nsIMsgIncomingServer *aServer,</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineplus">+                                  nsIURI *aUrlToRun) {</span>
<a href="#l36.277"></a><span id="l36.277">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l36.278"></a><span id="l36.278">   NS_ENSURE_ARG_POINTER(aUrlToRun);</span>
<a href="#l36.279"></a><span id="l36.279"> </span>
<a href="#l36.280"></a><span id="l36.280">   nsCString userName;</span>
<a href="#l36.281"></a><span id="l36.281"> </span>
<a href="#l36.282"></a><span id="l36.282">   // load up required server information</span>
<a href="#l36.283"></a><span id="l36.283">   // we store the username unescaped in the server</span>
<a href="#l36.284"></a><span id="l36.284">   // so there is no need to unescape it</span>
<a href="#l36.285"></a><span id="l36.285">   nsresult rv = aServer-&gt;GetRealUsername(userName);</span>
<a href="#l36.286"></a><span id="l36.286"> </span>
<a href="#l36.287"></a><span id="l36.287">   // find out if the server is busy or not...if the server is busy, we are</span>
<a href="#l36.288"></a><span id="l36.288">   // *NOT* going to run the url</span>
<a href="#l36.289"></a><span id="l36.289">   bool serverBusy = false;</span>
<a href="#l36.290"></a><span id="l36.290">   rv = aServer-&gt;GetServerBusy(&amp;serverBusy);</span>
<a href="#l36.291"></a><span id="l36.291">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineminus">-  if (!serverBusy)</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineminus">-  {</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineplus">+  if (!serverBusy) {</span>
<a href="#l36.295"></a><span id="l36.295">     RefPtr&lt;nsPop3Protocol&gt; protocol = new nsPop3Protocol(aUrlToRun);</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineminus">-    if (protocol)</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineminus">-    {</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineminus">-      // the protocol stores the unescaped username, so there is no need to escape it.</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineplus">+    if (protocol) {</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineplus">+      // the protocol stores the unescaped username, so there is no need to</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineplus">+      // escape it.</span>
<a href="#l36.302"></a><span id="l36.302">       protocol-&gt;SetUsername(userName.get());</span>
<a href="#l36.303"></a><span id="l36.303">       rv = protocol-&gt;LoadUrl(aUrlToRun);</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineminus">-        aServer-&gt;SetServerBusy(false);</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineplus">+      if (NS_FAILED(rv)) aServer-&gt;SetServerBusy(false);</span>
<a href="#l36.307"></a><span id="l36.307">     }</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineminus">-  }</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineminus">-  else</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineminus">-  {</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineplus">+  } else {</span>
<a href="#l36.312"></a><span id="l36.312">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(aUrlToRun);</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineminus">-    if (url)</span>
<a href="#l36.314"></a><span id="l36.314" class="difflineminus">-      AlertServerBusy(url);</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineplus">+    if (url) AlertServerBusy(url);</span>
<a href="#l36.316"></a><span id="l36.316">     rv = NS_ERROR_FAILURE;</span>
<a href="#l36.317"></a><span id="l36.317">   }</span>
<a href="#l36.318"></a><span id="l36.318">   return rv;</span>
<a href="#l36.319"></a><span id="l36.319"> }</span>
<a href="#l36.320"></a><span id="l36.320"> </span>
<a href="#l36.321"></a><span id="l36.321" class="difflineminus">-</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineminus">-NS_IMETHODIMP nsPop3Service::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineminus">-{</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineminus">-    aScheme.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineplus">+NS_IMETHODIMP nsPop3Service::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineplus">+  aScheme.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.329"></a><span id="l36.329"> }</span>
<a href="#l36.330"></a><span id="l36.330"> </span>
<a href="#l36.331"></a><span id="l36.331" class="difflineminus">-NS_IMETHODIMP nsPop3Service::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineminus">-{</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-    *aDefaultPort = nsIPop3URL::DEFAULT_POP3_PORT;</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineplus">+NS_IMETHODIMP nsPop3Service::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineplus">+  *aDefaultPort = nsIPop3URL::DEFAULT_POP3_PORT;</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.340"></a><span id="l36.340"> }</span>
<a href="#l36.341"></a><span id="l36.341"> </span>
<a href="#l36.342"></a><span id="l36.342" class="difflineminus">-NS_IMETHODIMP nsPop3Service::AllowPort(int32_t port, const char *scheme, bool *_retval)</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineminus">-{</span>
<a href="#l36.344"></a><span id="l36.344" class="difflineminus">-    *_retval = true; // allow pop on any port</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineplus">+NS_IMETHODIMP nsPop3Service::AllowPort(int32_t port, const char *scheme,</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineplus">+                                       bool *_retval) {</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineplus">+  *_retval = true;  // allow pop on any port</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.350"></a><span id="l36.350"> }</span>
<a href="#l36.351"></a><span id="l36.351"> </span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-NS_IMETHODIMP nsPop3Service::GetDefaultDoBiff(bool *aDoBiff)</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineminus">-{</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineminus">-    // by default, do biff for POP3 servers</span>
<a href="#l36.356"></a><span id="l36.356" class="difflineminus">-    *aDoBiff = true;</span>
<a href="#l36.357"></a><span id="l36.357" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.358"></a><span id="l36.358" class="difflineplus">+NS_IMETHODIMP nsPop3Service::GetDefaultDoBiff(bool *aDoBiff) {</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineplus">+  // by default, do biff for POP3 servers</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineplus">+  *aDoBiff = true;</span>
<a href="#l36.362"></a><span id="l36.362" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.363"></a><span id="l36.363"> }</span>
<a href="#l36.364"></a><span id="l36.364"> </span>
<a href="#l36.365"></a><span id="l36.365" class="difflineminus">-NS_IMETHODIMP nsPop3Service::GetProtocolFlags(uint32_t *result)</span>
<a href="#l36.366"></a><span id="l36.366" class="difflineminus">-{</span>
<a href="#l36.367"></a><span id="l36.367" class="difflineminus">-    NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineminus">-    *result = URI_NORELATIVE | URI_DANGEROUS_TO_LOAD | ALLOWS_PROXY;</span>
<a href="#l36.369"></a><span id="l36.369" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.370"></a><span id="l36.370" class="difflineplus">+NS_IMETHODIMP nsPop3Service::GetProtocolFlags(uint32_t *result) {</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineplus">+  NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l36.372"></a><span id="l36.372" class="difflineplus">+  *result = URI_NORELATIVE | URI_DANGEROUS_TO_LOAD | ALLOWS_PROXY;</span>
<a href="#l36.373"></a><span id="l36.373" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.374"></a><span id="l36.374"> }</span>
<a href="#l36.375"></a><span id="l36.375"> </span>
<a href="#l36.376"></a><span id="l36.376"> NS_IMETHODIMP nsPop3Service::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineminus">-                                    const char *aOriginCharset, // ignored</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineminus">-                                    nsIURI *aBaseURI,</span>
<a href="#l36.379"></a><span id="l36.379" class="difflineminus">-                                    nsIURI **_retval)</span>
<a href="#l36.380"></a><span id="l36.380" class="difflineminus">-{</span>
<a href="#l36.381"></a><span id="l36.381" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l36.382"></a><span id="l36.382" class="difflineplus">+                                    const char *aOriginCharset,  // ignored</span>
<a href="#l36.383"></a><span id="l36.383" class="difflineplus">+                                    nsIURI *aBaseURI, nsIURI **_retval) {</span>
<a href="#l36.384"></a><span id="l36.384" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l36.385"></a><span id="l36.385"> </span>
<a href="#l36.386"></a><span id="l36.386" class="difflineminus">-    nsAutoCString folderUri(aSpec);</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineminus">-    int32_t offset = folderUri.FindChar('?');</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineminus">-    if (offset != kNotFound)</span>
<a href="#l36.389"></a><span id="l36.389" class="difflineminus">-      folderUri.SetLength(offset);</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineplus">+  nsAutoCString folderUri(aSpec);</span>
<a href="#l36.391"></a><span id="l36.391" class="difflineplus">+  int32_t offset = folderUri.FindChar('?');</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineplus">+  if (offset != kNotFound) folderUri.SetLength(offset);</span>
<a href="#l36.393"></a><span id="l36.393"> </span>
<a href="#l36.394"></a><span id="l36.394" class="difflineminus">-    const char *uidl = PL_strstr(nsCString(aSpec).get(), &quot;uidl=&quot;);</span>
<a href="#l36.395"></a><span id="l36.395" class="difflineminus">-    NS_ENSURE_TRUE(uidl, NS_ERROR_FAILURE);</span>
<a href="#l36.396"></a><span id="l36.396" class="difflineplus">+  const char *uidl = PL_strstr(nsCString(aSpec).get(), &quot;uidl=&quot;);</span>
<a href="#l36.397"></a><span id="l36.397" class="difflineplus">+  NS_ENSURE_TRUE(uidl, NS_ERROR_FAILURE);</span>
<a href="#l36.398"></a><span id="l36.398"> </span>
<a href="#l36.399"></a><span id="l36.399" class="difflineminus">-    nsresult rv;</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineplus">+  nsresult rv;</span>
<a href="#l36.401"></a><span id="l36.401"> </span>
<a href="#l36.402"></a><span id="l36.402" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l36.403"></a><span id="l36.403" class="difflineminus">-    rv = GetOrCreateFolder(folderUri, getter_AddRefs(folder));</span>
<a href="#l36.404"></a><span id="l36.404" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.405"></a><span id="l36.405" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineplus">+  rv = GetOrCreateFolder(folderUri, getter_AddRefs(folder));</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.408"></a><span id="l36.408"> </span>
<a href="#l36.409"></a><span id="l36.409" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l36.410"></a><span id="l36.410" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l36.411"></a><span id="l36.411"> </span>
<a href="#l36.412"></a><span id="l36.412" class="difflineminus">-    nsLocalFolderScanState folderScanState;</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineminus">-    nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder);</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineminus">-    nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(aBaseURI);</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineplus">+  nsLocalFolderScanState folderScanState;</span>
<a href="#l36.416"></a><span id="l36.416" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder);</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineplus">+  nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(aBaseURI);</span>
<a href="#l36.418"></a><span id="l36.418"> </span>
<a href="#l36.419"></a><span id="l36.419" class="difflineminus">-    if (mailboxUrl &amp;&amp; localFolder)</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineminus">-    {</span>
<a href="#l36.421"></a><span id="l36.421" class="difflineminus">-      rv = localFolder-&gt;GetFolderScanState(&amp;folderScanState);</span>
<a href="#l36.422"></a><span id="l36.422" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.423"></a><span id="l36.423" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l36.424"></a><span id="l36.424" class="difflineminus">-      nsMsgKey msgKey;</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineminus">-      mailboxUrl-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineminus">-      folder-&gt;GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineminus">-      // we do this to get the account key</span>
<a href="#l36.428"></a><span id="l36.428" class="difflineminus">-      if (msgHdr)</span>
<a href="#l36.429"></a><span id="l36.429" class="difflineminus">-        localFolder-&gt;GetUidlFromFolder(&amp;folderScanState, msgHdr);</span>
<a href="#l36.430"></a><span id="l36.430" class="difflineminus">-      if (!folderScanState.m_accountKey.IsEmpty())</span>
<a href="#l36.431"></a><span id="l36.431" class="difflineminus">-      {</span>
<a href="#l36.432"></a><span id="l36.432" class="difflineminus">-        nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l36.433"></a><span id="l36.433" class="difflineminus">-                 do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l36.434"></a><span id="l36.434" class="difflineminus">-        if (accountManager)</span>
<a href="#l36.435"></a><span id="l36.435" class="difflineminus">-        {</span>
<a href="#l36.436"></a><span id="l36.436" class="difflineminus">-          nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l36.437"></a><span id="l36.437" class="difflineminus">-          accountManager-&gt;GetAccount(folderScanState.m_accountKey, getter_AddRefs(account));</span>
<a href="#l36.438"></a><span id="l36.438" class="difflineminus">-          if (account)</span>
<a href="#l36.439"></a><span id="l36.439" class="difflineminus">-            account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l36.440"></a><span id="l36.440" class="difflineminus">-        }</span>
<a href="#l36.441"></a><span id="l36.441" class="difflineplus">+  if (mailboxUrl &amp;&amp; localFolder) {</span>
<a href="#l36.442"></a><span id="l36.442" class="difflineplus">+    rv = localFolder-&gt;GetFolderScanState(&amp;folderScanState);</span>
<a href="#l36.443"></a><span id="l36.443" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.444"></a><span id="l36.444" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l36.445"></a><span id="l36.445" class="difflineplus">+    nsMsgKey msgKey;</span>
<a href="#l36.446"></a><span id="l36.446" class="difflineplus">+    mailboxUrl-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l36.447"></a><span id="l36.447" class="difflineplus">+    folder-&gt;GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l36.448"></a><span id="l36.448" class="difflineplus">+    // we do this to get the account key</span>
<a href="#l36.449"></a><span id="l36.449" class="difflineplus">+    if (msgHdr) localFolder-&gt;GetUidlFromFolder(&amp;folderScanState, msgHdr);</span>
<a href="#l36.450"></a><span id="l36.450" class="difflineplus">+    if (!folderScanState.m_accountKey.IsEmpty()) {</span>
<a href="#l36.451"></a><span id="l36.451" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l36.452"></a><span id="l36.452" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l36.453"></a><span id="l36.453" class="difflineplus">+      if (accountManager) {</span>
<a href="#l36.454"></a><span id="l36.454" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l36.455"></a><span id="l36.455" class="difflineplus">+        accountManager-&gt;GetAccount(folderScanState.m_accountKey,</span>
<a href="#l36.456"></a><span id="l36.456" class="difflineplus">+                                   getter_AddRefs(account));</span>
<a href="#l36.457"></a><span id="l36.457" class="difflineplus">+        if (account) account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l36.458"></a><span id="l36.458">       }</span>
<a href="#l36.459"></a><span id="l36.459">     }</span>
<a href="#l36.460"></a><span id="l36.460" class="difflineminus">-</span>
<a href="#l36.461"></a><span id="l36.461" class="difflineminus">-    if (!server)</span>
<a href="#l36.462"></a><span id="l36.462" class="difflineminus">-      rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l36.463"></a><span id="l36.463" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.464"></a><span id="l36.464" class="difflineplus">+  }</span>
<a href="#l36.465"></a><span id="l36.465"> </span>
<a href="#l36.466"></a><span id="l36.466" class="difflineminus">-    nsCOMPtr&lt;nsIPop3IncomingServer&gt; popServer = do_QueryInterface(server,&amp;rv);</span>
<a href="#l36.467"></a><span id="l36.467" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.468"></a><span id="l36.468" class="difflineplus">+  if (!server) rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l36.469"></a><span id="l36.469" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.470"></a><span id="l36.470"> </span>
<a href="#l36.471"></a><span id="l36.471" class="difflineminus">-    nsCString hostname;</span>
<a href="#l36.472"></a><span id="l36.472" class="difflineminus">-    nsCString username;</span>
<a href="#l36.473"></a><span id="l36.473" class="difflineminus">-    server-&gt;GetHostName(hostname);</span>
<a href="#l36.474"></a><span id="l36.474" class="difflineminus">-    server-&gt;GetUsername(username);</span>
<a href="#l36.475"></a><span id="l36.475" class="difflineplus">+  nsCOMPtr&lt;nsIPop3IncomingServer&gt; popServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l36.476"></a><span id="l36.476" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.477"></a><span id="l36.477"> </span>
<a href="#l36.478"></a><span id="l36.478" class="difflineminus">-    int32_t port;</span>
<a href="#l36.479"></a><span id="l36.479" class="difflineminus">-    server-&gt;GetPort(&amp;port);</span>
<a href="#l36.480"></a><span id="l36.480" class="difflineminus">-    if (port == -1) port = nsIPop3URL::DEFAULT_POP3_PORT;</span>
<a href="#l36.481"></a><span id="l36.481" class="difflineminus">-</span>
<a href="#l36.482"></a><span id="l36.482" class="difflineminus">-    // We need to escape the username before calling SetUsername() because it may</span>
<a href="#l36.483"></a><span id="l36.483" class="difflineminus">-    // contain characters like / % or @. GetUsername() will unescape the username.</span>
<a href="#l36.484"></a><span id="l36.484" class="difflineminus">-    nsCString escapedUsername;</span>
<a href="#l36.485"></a><span id="l36.485" class="difflineminus">-    MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l36.486"></a><span id="l36.486" class="difflineplus">+  nsCString hostname;</span>
<a href="#l36.487"></a><span id="l36.487" class="difflineplus">+  nsCString username;</span>
<a href="#l36.488"></a><span id="l36.488" class="difflineplus">+  server-&gt;GetHostName(hostname);</span>
<a href="#l36.489"></a><span id="l36.489" class="difflineplus">+  server-&gt;GetUsername(username);</span>
<a href="#l36.490"></a><span id="l36.490"> </span>
<a href="#l36.491"></a><span id="l36.491" class="difflineminus">-    nsAutoCString popSpec(&quot;pop://&quot;);</span>
<a href="#l36.492"></a><span id="l36.492" class="difflineminus">-    popSpec += escapedUsername;</span>
<a href="#l36.493"></a><span id="l36.493" class="difflineminus">-    popSpec += &quot;@&quot;;</span>
<a href="#l36.494"></a><span id="l36.494" class="difflineminus">-    popSpec += hostname;</span>
<a href="#l36.495"></a><span id="l36.495" class="difflineminus">-    popSpec += &quot;:&quot;;</span>
<a href="#l36.496"></a><span id="l36.496" class="difflineminus">-    popSpec.AppendInt(port);</span>
<a href="#l36.497"></a><span id="l36.497" class="difflineminus">-    popSpec += &quot;?&quot;;</span>
<a href="#l36.498"></a><span id="l36.498" class="difflineminus">-    popSpec += uidl;</span>
<a href="#l36.499"></a><span id="l36.499" class="difflineminus">-    nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l36.500"></a><span id="l36.500" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.501"></a><span id="l36.501" class="difflineplus">+  int32_t port;</span>
<a href="#l36.502"></a><span id="l36.502" class="difflineplus">+  server-&gt;GetPort(&amp;port);</span>
<a href="#l36.503"></a><span id="l36.503" class="difflineplus">+  if (port == -1) port = nsIPop3URL::DEFAULT_POP3_PORT;</span>
<a href="#l36.504"></a><span id="l36.504" class="difflineplus">+</span>
<a href="#l36.505"></a><span id="l36.505" class="difflineplus">+  // We need to escape the username before calling SetUsername() because it may</span>
<a href="#l36.506"></a><span id="l36.506" class="difflineplus">+  // contain characters like / % or @. GetUsername() will unescape the username.</span>
<a href="#l36.507"></a><span id="l36.507" class="difflineplus">+  nsCString escapedUsername;</span>
<a href="#l36.508"></a><span id="l36.508" class="difflineplus">+  MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l36.509"></a><span id="l36.509"> </span>
<a href="#l36.510"></a><span id="l36.510" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l36.511"></a><span id="l36.511" class="difflineminus">-    rv = BuildPop3Url(popSpec.get(), folder, popServer,</span>
<a href="#l36.512"></a><span id="l36.512" class="difflineminus">-                      urlListener, getter_AddRefs(newUri), nullptr);</span>
<a href="#l36.513"></a><span id="l36.513" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.514"></a><span id="l36.514" class="difflineplus">+  nsAutoCString popSpec(&quot;pop://&quot;);</span>
<a href="#l36.515"></a><span id="l36.515" class="difflineplus">+  popSpec += escapedUsername;</span>
<a href="#l36.516"></a><span id="l36.516" class="difflineplus">+  popSpec += &quot;@&quot;;</span>
<a href="#l36.517"></a><span id="l36.517" class="difflineplus">+  popSpec += hostname;</span>
<a href="#l36.518"></a><span id="l36.518" class="difflineplus">+  popSpec += &quot;:&quot;;</span>
<a href="#l36.519"></a><span id="l36.519" class="difflineplus">+  popSpec.AppendInt(port);</span>
<a href="#l36.520"></a><span id="l36.520" class="difflineplus">+  popSpec += &quot;?&quot;;</span>
<a href="#l36.521"></a><span id="l36.521" class="difflineplus">+  popSpec += uidl;</span>
<a href="#l36.522"></a><span id="l36.522" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(folder, &amp;rv);</span>
<a href="#l36.523"></a><span id="l36.523" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.524"></a><span id="l36.524"> </span>
<a href="#l36.525"></a><span id="l36.525" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l36.526"></a><span id="l36.526" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.527"></a><span id="l36.527" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; newUri;</span>
<a href="#l36.528"></a><span id="l36.528" class="difflineplus">+  rv = BuildPop3Url(popSpec.get(), folder, popServer, urlListener,</span>
<a href="#l36.529"></a><span id="l36.529" class="difflineplus">+                    getter_AddRefs(newUri), nullptr);</span>
<a href="#l36.530"></a><span id="l36.530" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.531"></a><span id="l36.531"> </span>
<a href="#l36.532"></a><span id="l36.532" class="difflineminus">-    rv = mailnewsurl-&gt;SetUsernameInternal(escapedUsername);</span>
<a href="#l36.533"></a><span id="l36.533" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.534"></a><span id="l36.534" class="difflineminus">-</span>
<a href="#l36.535"></a><span id="l36.535" class="difflineminus">-    nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l36.536"></a><span id="l36.536" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.537"></a><span id="l36.537" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l36.538"></a><span id="l36.538" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.539"></a><span id="l36.539"> </span>
<a href="#l36.540"></a><span id="l36.540" class="difflineminus">-    nsAutoCString messageUri (aSpec);</span>
<a href="#l36.541"></a><span id="l36.541" class="difflineminus">-    if (!strncmp(messageUri.get(), &quot;mailbox:&quot;, 8))</span>
<a href="#l36.542"></a><span id="l36.542" class="difflineminus">-      messageUri.Replace(0, 8, &quot;mailbox-message:&quot;);</span>
<a href="#l36.543"></a><span id="l36.543" class="difflineminus">-    offset = messageUri.Find(&quot;?number=&quot;);</span>
<a href="#l36.544"></a><span id="l36.544" class="difflineminus">-    if (offset != kNotFound)</span>
<a href="#l36.545"></a><span id="l36.545" class="difflineminus">-      messageUri.Replace(offset, 8, &quot;#&quot;);</span>
<a href="#l36.546"></a><span id="l36.546" class="difflineminus">-    offset = messageUri.FindChar('&amp;');</span>
<a href="#l36.547"></a><span id="l36.547" class="difflineminus">-    if (offset != kNotFound)</span>
<a href="#l36.548"></a><span id="l36.548" class="difflineminus">-      messageUri.SetLength(offset);</span>
<a href="#l36.549"></a><span id="l36.549" class="difflineminus">-    popurl-&gt;SetMessageUri(messageUri.get());</span>
<a href="#l36.550"></a><span id="l36.550" class="difflineminus">-    nsCOMPtr&lt;nsIPop3Sink&gt; pop3Sink;</span>
<a href="#l36.551"></a><span id="l36.551" class="difflineminus">-    rv = popurl-&gt;GetPop3Sink(getter_AddRefs(pop3Sink));</span>
<a href="#l36.552"></a><span id="l36.552" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.553"></a><span id="l36.553" class="difflineplus">+  rv = mailnewsurl-&gt;SetUsernameInternal(escapedUsername);</span>
<a href="#l36.554"></a><span id="l36.554" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.555"></a><span id="l36.555" class="difflineplus">+</span>
<a href="#l36.556"></a><span id="l36.556" class="difflineplus">+  nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(newUri, &amp;rv);</span>
<a href="#l36.557"></a><span id="l36.557" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.558"></a><span id="l36.558"> </span>
<a href="#l36.559"></a><span id="l36.559" class="difflineminus">-    pop3Sink-&gt;SetBuildMessageUri(true);</span>
<a href="#l36.560"></a><span id="l36.560" class="difflineplus">+  nsAutoCString messageUri(aSpec);</span>
<a href="#l36.561"></a><span id="l36.561" class="difflineplus">+  if (!strncmp(messageUri.get(), &quot;mailbox:&quot;, 8))</span>
<a href="#l36.562"></a><span id="l36.562" class="difflineplus">+    messageUri.Replace(0, 8, &quot;mailbox-message:&quot;);</span>
<a href="#l36.563"></a><span id="l36.563" class="difflineplus">+  offset = messageUri.Find(&quot;?number=&quot;);</span>
<a href="#l36.564"></a><span id="l36.564" class="difflineplus">+  if (offset != kNotFound) messageUri.Replace(offset, 8, &quot;#&quot;);</span>
<a href="#l36.565"></a><span id="l36.565" class="difflineplus">+  offset = messageUri.FindChar('&amp;');</span>
<a href="#l36.566"></a><span id="l36.566" class="difflineplus">+  if (offset != kNotFound) messageUri.SetLength(offset);</span>
<a href="#l36.567"></a><span id="l36.567" class="difflineplus">+  popurl-&gt;SetMessageUri(messageUri.get());</span>
<a href="#l36.568"></a><span id="l36.568" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Sink&gt; pop3Sink;</span>
<a href="#l36.569"></a><span id="l36.569" class="difflineplus">+  rv = popurl-&gt;GetPop3Sink(getter_AddRefs(pop3Sink));</span>
<a href="#l36.570"></a><span id="l36.570" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.571"></a><span id="l36.571"> </span>
<a href="#l36.572"></a><span id="l36.572" class="difflineminus">-    newUri.forget(_retval);</span>
<a href="#l36.573"></a><span id="l36.573" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.574"></a><span id="l36.574" class="difflineplus">+  pop3Sink-&gt;SetBuildMessageUri(true);</span>
<a href="#l36.575"></a><span id="l36.575" class="difflineplus">+</span>
<a href="#l36.576"></a><span id="l36.576" class="difflineplus">+  newUri.forget(_retval);</span>
<a href="#l36.577"></a><span id="l36.577" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.578"></a><span id="l36.578"> }</span>
<a href="#l36.579"></a><span id="l36.579"> </span>
<a href="#l36.580"></a><span id="l36.580" class="difflineminus">-void nsPop3Service::AlertServerBusy(nsIMsgMailNewsUrl *url)</span>
<a href="#l36.581"></a><span id="l36.581" class="difflineminus">-{</span>
<a href="#l36.582"></a><span id="l36.582" class="difflineplus">+void nsPop3Service::AlertServerBusy(nsIMsgMailNewsUrl *url) {</span>
<a href="#l36.583"></a><span id="l36.583">   nsresult rv;</span>
<a href="#l36.584"></a><span id="l36.584">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l36.585"></a><span id="l36.585" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l36.586"></a><span id="l36.586" class="difflineminus">-  if (!bundleService)</span>
<a href="#l36.587"></a><span id="l36.587" class="difflineminus">-    return;</span>
<a href="#l36.588"></a><span id="l36.588" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l36.589"></a><span id="l36.589" class="difflineplus">+  if (!bundleService) return;</span>
<a href="#l36.590"></a><span id="l36.590">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l36.591"></a><span id="l36.591" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l36.592"></a><span id="l36.592" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l36.593"></a><span id="l36.593" class="difflineplus">+      &quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l36.594"></a><span id="l36.594">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l36.595"></a><span id="l36.595"> </span>
<a href="#l36.596"></a><span id="l36.596">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l36.597"></a><span id="l36.597">   nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l36.598"></a><span id="l36.598" class="difflineminus">-  rv = url-&gt;GetMsgWindow(getter_AddRefs(msgWindow)); //it is ok to have null msgWindow, for example when biffing</span>
<a href="#l36.599"></a><span id="l36.599" class="difflineminus">-  if (NS_FAILED(rv) || !msgWindow)</span>
<a href="#l36.600"></a><span id="l36.600" class="difflineminus">-    return;</span>
<a href="#l36.601"></a><span id="l36.601" class="difflineplus">+  rv = url-&gt;GetMsgWindow(getter_AddRefs(</span>
<a href="#l36.602"></a><span id="l36.602" class="difflineplus">+      msgWindow));  // it is ok to have null msgWindow, for example when biffing</span>
<a href="#l36.603"></a><span id="l36.603" class="difflineplus">+  if (NS_FAILED(rv) || !msgWindow) return;</span>
<a href="#l36.604"></a><span id="l36.604"> </span>
<a href="#l36.605"></a><span id="l36.605">   rv = msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l36.606"></a><span id="l36.606">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l36.607"></a><span id="l36.607"> </span>
<a href="#l36.608"></a><span id="l36.608">   nsString accountName;</span>
<a href="#l36.609"></a><span id="l36.609">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l36.610"></a><span id="l36.610">   rv = url-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l36.611"></a><span id="l36.611">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l36.612"></a><span id="l36.612">   rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l36.613"></a><span id="l36.613">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l36.614"></a><span id="l36.614"> </span>
<a href="#l36.615"></a><span id="l36.615" class="difflineminus">-  const char16_t *params[] = { accountName.get() };</span>
<a href="#l36.616"></a><span id="l36.616" class="difflineplus">+  const char16_t *params[] = {accountName.get()};</span>
<a href="#l36.617"></a><span id="l36.617">   nsString alertString;</span>
<a href="#l36.618"></a><span id="l36.618">   nsString dialogTitle;</span>
<a href="#l36.619"></a><span id="l36.619" class="difflineminus">-  bundle-&gt;FormatStringFromName(</span>
<a href="#l36.620"></a><span id="l36.620" class="difflineminus">-    &quot;pop3ServerBusy&quot;,</span>
<a href="#l36.621"></a><span id="l36.621" class="difflineminus">-    params, 1, alertString);</span>
<a href="#l36.622"></a><span id="l36.622" class="difflineminus">-  bundle-&gt;FormatStringFromName(</span>
<a href="#l36.623"></a><span id="l36.623" class="difflineminus">-    &quot;pop3ErrorDialogTitle&quot;,</span>
<a href="#l36.624"></a><span id="l36.624" class="difflineminus">-    params, 1, dialogTitle);</span>
<a href="#l36.625"></a><span id="l36.625" class="difflineplus">+  bundle-&gt;FormatStringFromName(&quot;pop3ServerBusy&quot;, params, 1, alertString);</span>
<a href="#l36.626"></a><span id="l36.626" class="difflineplus">+  bundle-&gt;FormatStringFromName(&quot;pop3ErrorDialogTitle&quot;, params, 1, dialogTitle);</span>
<a href="#l36.627"></a><span id="l36.627">   if (!alertString.IsEmpty())</span>
<a href="#l36.628"></a><span id="l36.628">     dialog-&gt;Alert(dialogTitle.get(), alertString.get());</span>
<a href="#l36.629"></a><span id="l36.629"> }</span>
<a href="#l36.630"></a><span id="l36.630"> </span>
<a href="#l36.631"></a><span id="l36.631" class="difflineminus">-NS_IMETHODIMP nsPop3Service::NewChannel(nsIURI *aURI,</span>
<a href="#l36.632"></a><span id="l36.632" class="difflineminus">-                                        nsILoadInfo *aLoadInfo,</span>
<a href="#l36.633"></a><span id="l36.633" class="difflineminus">-                                        nsIChannel **_retval)</span>
<a href="#l36.634"></a><span id="l36.634" class="difflineminus">-{</span>
<a href="#l36.635"></a><span id="l36.635" class="difflineplus">+NS_IMETHODIMP nsPop3Service::NewChannel(nsIURI *aURI, nsILoadInfo *aLoadInfo,</span>
<a href="#l36.636"></a><span id="l36.636" class="difflineplus">+                                        nsIChannel **_retval) {</span>
<a href="#l36.637"></a><span id="l36.637">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l36.638"></a><span id="l36.638">   nsresult rv;</span>
<a href="#l36.639"></a><span id="l36.639"> </span>
<a href="#l36.640"></a><span id="l36.640">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l36.641"></a><span id="l36.641">   nsCString realUserName;</span>
<a href="#l36.642"></a><span id="l36.642" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l36.643"></a><span id="l36.643" class="difflineminus">-  {</span>
<a href="#l36.644"></a><span id="l36.644" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; url) {</span>
<a href="#l36.645"></a><span id="l36.645">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l36.646"></a><span id="l36.646">     url-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l36.647"></a><span id="l36.647" class="difflineminus">-    if (server)</span>
<a href="#l36.648"></a><span id="l36.648" class="difflineminus">-    {</span>
<a href="#l36.649"></a><span id="l36.649" class="difflineplus">+    if (server) {</span>
<a href="#l36.650"></a><span id="l36.650">       // find out if the server is busy or not...if the server is busy, we are</span>
<a href="#l36.651"></a><span id="l36.651">       // *NOT* going to run the url. The error code isn't quite right...</span>
<a href="#l36.652"></a><span id="l36.652">       // We might want to put up an error right here.</span>
<a href="#l36.653"></a><span id="l36.653">       bool serverBusy = false;</span>
<a href="#l36.654"></a><span id="l36.654">       rv = server-&gt;GetServerBusy(&amp;serverBusy);</span>
<a href="#l36.655"></a><span id="l36.655" class="difflineminus">-      if (serverBusy)</span>
<a href="#l36.656"></a><span id="l36.656" class="difflineminus">-      {</span>
<a href="#l36.657"></a><span id="l36.657" class="difflineplus">+      if (serverBusy) {</span>
<a href="#l36.658"></a><span id="l36.658">         AlertServerBusy(url);</span>
<a href="#l36.659"></a><span id="l36.659">         return NS_MSG_FOLDER_BUSY;</span>
<a href="#l36.660"></a><span id="l36.660">       }</span>
<a href="#l36.661"></a><span id="l36.661">       server-&gt;GetRealUsername(realUserName);</span>
<a href="#l36.662"></a><span id="l36.662">     }</span>
<a href="#l36.663"></a><span id="l36.663">   }</span>
<a href="#l36.664"></a><span id="l36.664"> </span>
<a href="#l36.665"></a><span id="l36.665">   RefPtr&lt;nsPop3Protocol&gt; protocol = new nsPop3Protocol(aURI);</span>
<a href="#l36.666"></a><span id="l36.666" class="difflineat">@@ -502,194 +451,174 @@ NS_IMETHODIMP nsPop3Service::NewChannel(</span>
<a href="#l36.667"></a><span id="l36.667">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.668"></a><span id="l36.668"> </span>
<a href="#l36.669"></a><span id="l36.669">   protocol-&gt;SetUsername(realUserName.get());</span>
<a href="#l36.670"></a><span id="l36.670"> </span>
<a href="#l36.671"></a><span id="l36.671">   protocol.forget(_retval);</span>
<a href="#l36.672"></a><span id="l36.672">   return NS_OK;</span>
<a href="#l36.673"></a><span id="l36.673"> }</span>
<a href="#l36.674"></a><span id="l36.674"> </span>
<a href="#l36.675"></a><span id="l36.675" class="difflineminus">-</span>
<a href="#l36.676"></a><span id="l36.676"> NS_IMETHODIMP</span>
<a href="#l36.677"></a><span id="l36.677" class="difflineminus">-nsPop3Service::SetDefaultLocalPath(nsIFile *aPath)</span>
<a href="#l36.678"></a><span id="l36.678" class="difflineminus">-{</span>
<a href="#l36.679"></a><span id="l36.679" class="difflineminus">-    NS_ENSURE_ARG(aPath);</span>
<a href="#l36.680"></a><span id="l36.680" class="difflineminus">-    return NS_SetPersistentFile(PREF_MAIL_ROOT_POP3_REL, PREF_MAIL_ROOT_POP3, aPath);</span>
<a href="#l36.681"></a><span id="l36.681" class="difflineplus">+nsPop3Service::SetDefaultLocalPath(nsIFile *aPath) {</span>
<a href="#l36.682"></a><span id="l36.682" class="difflineplus">+  NS_ENSURE_ARG(aPath);</span>
<a href="#l36.683"></a><span id="l36.683" class="difflineplus">+  return NS_SetPersistentFile(PREF_MAIL_ROOT_POP3_REL, PREF_MAIL_ROOT_POP3,</span>
<a href="#l36.684"></a><span id="l36.684" class="difflineplus">+                              aPath);</span>
<a href="#l36.685"></a><span id="l36.685"> }</span>
<a href="#l36.686"></a><span id="l36.686"> </span>
<a href="#l36.687"></a><span id="l36.687"> NS_IMETHODIMP</span>
<a href="#l36.688"></a><span id="l36.688" class="difflineminus">-nsPop3Service::GetDefaultLocalPath(nsIFile **aResult)</span>
<a href="#l36.689"></a><span id="l36.689" class="difflineminus">-{</span>
<a href="#l36.690"></a><span id="l36.690" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l36.691"></a><span id="l36.691" class="difflineminus">-    *aResult = nullptr;</span>
<a href="#l36.692"></a><span id="l36.692" class="difflineplus">+nsPop3Service::GetDefaultLocalPath(nsIFile **aResult) {</span>
<a href="#l36.693"></a><span id="l36.693" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l36.694"></a><span id="l36.694" class="difflineplus">+  *aResult = nullptr;</span>
<a href="#l36.695"></a><span id="l36.695"> </span>
<a href="#l36.696"></a><span id="l36.696" class="difflineminus">-    bool havePref;</span>
<a href="#l36.697"></a><span id="l36.697" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l36.698"></a><span id="l36.698" class="difflineminus">-    nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_POP3_REL,</span>
<a href="#l36.699"></a><span id="l36.699" class="difflineminus">-                                       PREF_MAIL_ROOT_POP3,</span>
<a href="#l36.700"></a><span id="l36.700" class="difflineminus">-                                       NS_APP_MAIL_50_DIR,</span>
<a href="#l36.701"></a><span id="l36.701" class="difflineminus">-                                       havePref,</span>
<a href="#l36.702"></a><span id="l36.702" class="difflineminus">-                                       getter_AddRefs(localFile));</span>
<a href="#l36.703"></a><span id="l36.703" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.704"></a><span id="l36.704" class="difflineplus">+  bool havePref;</span>
<a href="#l36.705"></a><span id="l36.705" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l36.706"></a><span id="l36.706" class="difflineplus">+  nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_POP3_REL,</span>
<a href="#l36.707"></a><span id="l36.707" class="difflineplus">+                                     PREF_MAIL_ROOT_POP3, NS_APP_MAIL_50_DIR,</span>
<a href="#l36.708"></a><span id="l36.708" class="difflineplus">+                                     havePref, getter_AddRefs(localFile));</span>
<a href="#l36.709"></a><span id="l36.709" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.710"></a><span id="l36.710"> </span>
<a href="#l36.711"></a><span id="l36.711" class="difflineminus">-    bool exists;</span>
<a href="#l36.712"></a><span id="l36.712" class="difflineminus">-    rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l36.713"></a><span id="l36.713" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l36.714"></a><span id="l36.714" class="difflineminus">-        rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l36.715"></a><span id="l36.715" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.716"></a><span id="l36.716" class="difflineminus">-</span>
<a href="#l36.717"></a><span id="l36.717" class="difflineminus">-    if (!havePref || !exists) {</span>
<a href="#l36.718"></a><span id="l36.718" class="difflineminus">-        rv = NS_SetPersistentFile(PREF_MAIL_ROOT_POP3_REL, PREF_MAIL_ROOT_POP3, localFile);</span>
<a href="#l36.719"></a><span id="l36.719" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l36.720"></a><span id="l36.720" class="difflineminus">-    }</span>
<a href="#l36.721"></a><span id="l36.721" class="difflineplus">+  bool exists;</span>
<a href="#l36.722"></a><span id="l36.722" class="difflineplus">+  rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l36.723"></a><span id="l36.723" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l36.724"></a><span id="l36.724" class="difflineplus">+    rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l36.725"></a><span id="l36.725" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.726"></a><span id="l36.726"> </span>
<a href="#l36.727"></a><span id="l36.727" class="difflineminus">-    localFile.forget(aResult);</span>
<a href="#l36.728"></a><span id="l36.728" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.729"></a><span id="l36.729" class="difflineminus">-}</span>
<a href="#l36.730"></a><span id="l36.730" class="difflineminus">-</span>
<a href="#l36.731"></a><span id="l36.731" class="difflineplus">+  if (!havePref || !exists) {</span>
<a href="#l36.732"></a><span id="l36.732" class="difflineplus">+    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_POP3_REL, PREF_MAIL_ROOT_POP3,</span>
<a href="#l36.733"></a><span id="l36.733" class="difflineplus">+                              localFile);</span>
<a href="#l36.734"></a><span id="l36.734" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l36.735"></a><span id="l36.735" class="difflineplus">+  }</span>
<a href="#l36.736"></a><span id="l36.736"> </span>
<a href="#l36.737"></a><span id="l36.737" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l36.738"></a><span id="l36.738" class="difflineminus">-nsPop3Service::GetServerIID(nsIID **aServerIID)</span>
<a href="#l36.739"></a><span id="l36.739" class="difflineminus">-{</span>
<a href="#l36.740"></a><span id="l36.740" class="difflineminus">-    *aServerIID = new nsIID(NS_GET_IID(nsIPop3IncomingServer));</span>
<a href="#l36.741"></a><span id="l36.741" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.742"></a><span id="l36.742" class="difflineplus">+  localFile.forget(aResult);</span>
<a href="#l36.743"></a><span id="l36.743" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.744"></a><span id="l36.744"> }</span>
<a href="#l36.745"></a><span id="l36.745"> </span>
<a href="#l36.746"></a><span id="l36.746"> NS_IMETHODIMP</span>
<a href="#l36.747"></a><span id="l36.747" class="difflineminus">-nsPop3Service::GetRequiresUsername(bool *aRequiresUsername)</span>
<a href="#l36.748"></a><span id="l36.748" class="difflineminus">-{</span>
<a href="#l36.749"></a><span id="l36.749" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l36.750"></a><span id="l36.750" class="difflineminus">-    *aRequiresUsername = true;</span>
<a href="#l36.751"></a><span id="l36.751" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.752"></a><span id="l36.752" class="difflineplus">+nsPop3Service::GetServerIID(nsIID **aServerIID) {</span>
<a href="#l36.753"></a><span id="l36.753" class="difflineplus">+  *aServerIID = new nsIID(NS_GET_IID(nsIPop3IncomingServer));</span>
<a href="#l36.754"></a><span id="l36.754" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.755"></a><span id="l36.755" class="difflineplus">+}</span>
<a href="#l36.756"></a><span id="l36.756" class="difflineplus">+</span>
<a href="#l36.757"></a><span id="l36.757" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l36.758"></a><span id="l36.758" class="difflineplus">+nsPop3Service::GetRequiresUsername(bool *aRequiresUsername) {</span>
<a href="#l36.759"></a><span id="l36.759" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l36.760"></a><span id="l36.760" class="difflineplus">+  *aRequiresUsername = true;</span>
<a href="#l36.761"></a><span id="l36.761" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.762"></a><span id="l36.762"> }</span>
<a href="#l36.763"></a><span id="l36.763"> </span>
<a href="#l36.764"></a><span id="l36.764"> NS_IMETHODIMP</span>
<a href="#l36.765"></a><span id="l36.765" class="difflineminus">-nsPop3Service::GetPreflightPrettyNameWithEmailAddress(bool *aPreflightPrettyNameWithEmailAddress)</span>
<a href="#l36.766"></a><span id="l36.766" class="difflineminus">-{</span>
<a href="#l36.767"></a><span id="l36.767" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPreflightPrettyNameWithEmailAddress);</span>
<a href="#l36.768"></a><span id="l36.768" class="difflineminus">-    *aPreflightPrettyNameWithEmailAddress = true;</span>
<a href="#l36.769"></a><span id="l36.769" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.770"></a><span id="l36.770" class="difflineplus">+nsPop3Service::GetPreflightPrettyNameWithEmailAddress(</span>
<a href="#l36.771"></a><span id="l36.771" class="difflineplus">+    bool *aPreflightPrettyNameWithEmailAddress) {</span>
<a href="#l36.772"></a><span id="l36.772" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aPreflightPrettyNameWithEmailAddress);</span>
<a href="#l36.773"></a><span id="l36.773" class="difflineplus">+  *aPreflightPrettyNameWithEmailAddress = true;</span>
<a href="#l36.774"></a><span id="l36.774" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.775"></a><span id="l36.775"> }</span>
<a href="#l36.776"></a><span id="l36.776"> </span>
<a href="#l36.777"></a><span id="l36.777"> NS_IMETHODIMP</span>
<a href="#l36.778"></a><span id="l36.778" class="difflineminus">-nsPop3Service::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp)</span>
<a href="#l36.779"></a><span id="l36.779" class="difflineminus">-{</span>
<a href="#l36.780"></a><span id="l36.780" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l36.781"></a><span id="l36.781" class="difflineminus">-    *aCanLoginAtStartUp = true;</span>
<a href="#l36.782"></a><span id="l36.782" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.783"></a><span id="l36.783" class="difflineplus">+nsPop3Service::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp) {</span>
<a href="#l36.784"></a><span id="l36.784" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l36.785"></a><span id="l36.785" class="difflineplus">+  *aCanLoginAtStartUp = true;</span>
<a href="#l36.786"></a><span id="l36.786" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.787"></a><span id="l36.787"> }</span>
<a href="#l36.788"></a><span id="l36.788"> </span>
<a href="#l36.789"></a><span id="l36.789"> NS_IMETHODIMP</span>
<a href="#l36.790"></a><span id="l36.790" class="difflineminus">-nsPop3Service::GetCanDelete(bool *aCanDelete)</span>
<a href="#l36.791"></a><span id="l36.791" class="difflineminus">-{</span>
<a href="#l36.792"></a><span id="l36.792" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l36.793"></a><span id="l36.793" class="difflineminus">-    *aCanDelete = true;</span>
<a href="#l36.794"></a><span id="l36.794" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.795"></a><span id="l36.795" class="difflineplus">+nsPop3Service::GetCanDelete(bool *aCanDelete) {</span>
<a href="#l36.796"></a><span id="l36.796" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l36.797"></a><span id="l36.797" class="difflineplus">+  *aCanDelete = true;</span>
<a href="#l36.798"></a><span id="l36.798" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.799"></a><span id="l36.799"> }</span>
<a href="#l36.800"></a><span id="l36.800"> </span>
<a href="#l36.801"></a><span id="l36.801"> NS_IMETHODIMP</span>
<a href="#l36.802"></a><span id="l36.802" class="difflineminus">-nsPop3Service::GetCanDuplicate(bool *aCanDuplicate)</span>
<a href="#l36.803"></a><span id="l36.803" class="difflineminus">-{</span>
<a href="#l36.804"></a><span id="l36.804" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l36.805"></a><span id="l36.805" class="difflineminus">-    *aCanDuplicate = true;</span>
<a href="#l36.806"></a><span id="l36.806" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.807"></a><span id="l36.807" class="difflineplus">+nsPop3Service::GetCanDuplicate(bool *aCanDuplicate) {</span>
<a href="#l36.808"></a><span id="l36.808" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l36.809"></a><span id="l36.809" class="difflineplus">+  *aCanDuplicate = true;</span>
<a href="#l36.810"></a><span id="l36.810" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.811"></a><span id="l36.811"> }</span>
<a href="#l36.812"></a><span id="l36.812"> </span>
<a href="#l36.813"></a><span id="l36.813"> NS_IMETHODIMP</span>
<a href="#l36.814"></a><span id="l36.814" class="difflineminus">-nsPop3Service::GetCanGetMessages(bool *aCanGetMessages)</span>
<a href="#l36.815"></a><span id="l36.815" class="difflineminus">-{</span>
<a href="#l36.816"></a><span id="l36.816" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l36.817"></a><span id="l36.817" class="difflineminus">-    *aCanGetMessages = true;</span>
<a href="#l36.818"></a><span id="l36.818" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.819"></a><span id="l36.819" class="difflineplus">+nsPop3Service::GetCanGetMessages(bool *aCanGetMessages) {</span>
<a href="#l36.820"></a><span id="l36.820" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l36.821"></a><span id="l36.821" class="difflineplus">+  *aCanGetMessages = true;</span>
<a href="#l36.822"></a><span id="l36.822" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.823"></a><span id="l36.823"> }</span>
<a href="#l36.824"></a><span id="l36.824"> </span>
<a href="#l36.825"></a><span id="l36.825"> NS_IMETHODIMP</span>
<a href="#l36.826"></a><span id="l36.826" class="difflineminus">-nsPop3Service::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages)</span>
<a href="#l36.827"></a><span id="l36.827" class="difflineminus">-{</span>
<a href="#l36.828"></a><span id="l36.828" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l36.829"></a><span id="l36.829" class="difflineminus">-    *aCanGetIncomingMessages = true;</span>
<a href="#l36.830"></a><span id="l36.830" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.831"></a><span id="l36.831" class="difflineplus">+nsPop3Service::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages) {</span>
<a href="#l36.832"></a><span id="l36.832" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l36.833"></a><span id="l36.833" class="difflineplus">+  *aCanGetIncomingMessages = true;</span>
<a href="#l36.834"></a><span id="l36.834" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.835"></a><span id="l36.835"> }</span>
<a href="#l36.836"></a><span id="l36.836"> </span>
<a href="#l36.837"></a><span id="l36.837"> NS_IMETHODIMP</span>
<a href="#l36.838"></a><span id="l36.838" class="difflineminus">-nsPop3Service::GetShowComposeMsgLink(bool *showComposeMsgLink)</span>
<a href="#l36.839"></a><span id="l36.839" class="difflineminus">-{</span>
<a href="#l36.840"></a><span id="l36.840" class="difflineminus">-    NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l36.841"></a><span id="l36.841" class="difflineminus">-    *showComposeMsgLink = true;</span>
<a href="#l36.842"></a><span id="l36.842" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.843"></a><span id="l36.843" class="difflineplus">+nsPop3Service::GetShowComposeMsgLink(bool *showComposeMsgLink) {</span>
<a href="#l36.844"></a><span id="l36.844" class="difflineplus">+  NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l36.845"></a><span id="l36.845" class="difflineplus">+  *showComposeMsgLink = true;</span>
<a href="#l36.846"></a><span id="l36.846" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.847"></a><span id="l36.847"> }</span>
<a href="#l36.848"></a><span id="l36.848"> </span>
<a href="#l36.849"></a><span id="l36.849"> NS_IMETHODIMP</span>
<a href="#l36.850"></a><span id="l36.850" class="difflineminus">-nsPop3Service::GetFoldersCreatedAsync(bool *aAsyncCreation)</span>
<a href="#l36.851"></a><span id="l36.851" class="difflineminus">-{</span>
<a href="#l36.852"></a><span id="l36.852" class="difflineplus">+nsPop3Service::GetFoldersCreatedAsync(bool *aAsyncCreation) {</span>
<a href="#l36.853"></a><span id="l36.853">   NS_ENSURE_ARG_POINTER(aAsyncCreation);</span>
<a href="#l36.854"></a><span id="l36.854">   *aAsyncCreation = false;</span>
<a href="#l36.855"></a><span id="l36.855">   return NS_OK;</span>
<a href="#l36.856"></a><span id="l36.856"> }</span>
<a href="#l36.857"></a><span id="l36.857"> </span>
<a href="#l36.858"></a><span id="l36.858"> NS_IMETHODIMP</span>
<a href="#l36.859"></a><span id="l36.859" class="difflineminus">-nsPop3Service::GetDefaultServerPort(bool isSecure, int32_t *aPort)</span>
<a href="#l36.860"></a><span id="l36.860" class="difflineminus">-{</span>
<a href="#l36.861"></a><span id="l36.861" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aPort);</span>
<a href="#l36.862"></a><span id="l36.862" class="difflineplus">+nsPop3Service::GetDefaultServerPort(bool isSecure, int32_t *aPort) {</span>
<a href="#l36.863"></a><span id="l36.863" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aPort);</span>
<a href="#l36.864"></a><span id="l36.864"> </span>
<a href="#l36.865"></a><span id="l36.865" class="difflineminus">-    if (!isSecure)</span>
<a href="#l36.866"></a><span id="l36.866" class="difflineminus">-      return GetDefaultPort(aPort);</span>
<a href="#l36.867"></a><span id="l36.867" class="difflineplus">+  if (!isSecure) return GetDefaultPort(aPort);</span>
<a href="#l36.868"></a><span id="l36.868"> </span>
<a href="#l36.869"></a><span id="l36.869" class="difflineminus">-    *aPort = nsIPop3URL::DEFAULT_POP3S_PORT;</span>
<a href="#l36.870"></a><span id="l36.870" class="difflineplus">+  *aPort = nsIPop3URL::DEFAULT_POP3S_PORT;</span>
<a href="#l36.871"></a><span id="l36.871"> </span>
<a href="#l36.872"></a><span id="l36.872" class="difflineminus">-    return NS_OK;</span>
<a href="#l36.873"></a><span id="l36.873" class="difflineplus">+  return NS_OK;</span>
<a href="#l36.874"></a><span id="l36.874"> }</span>
<a href="#l36.875"></a><span id="l36.875"> </span>
<a href="#l36.876"></a><span id="l36.876"> NS_IMETHODIMP</span>
<a href="#l36.877"></a><span id="l36.877" class="difflineminus">-nsPop3Service::NotifyDownloadStarted(nsIMsgFolder *aFolder)</span>
<a href="#l36.878"></a><span id="l36.878" class="difflineminus">-{</span>
<a href="#l36.879"></a><span id="l36.879" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt;::ForwardIterator</span>
<a href="#l36.880"></a><span id="l36.880" class="difflineminus">-    iter(mListeners);</span>
<a href="#l36.881"></a><span id="l36.881" class="difflineplus">+nsPop3Service::NotifyDownloadStarted(nsIMsgFolder *aFolder) {</span>
<a href="#l36.882"></a><span id="l36.882" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l36.883"></a><span id="l36.883" class="difflineplus">+      mListeners);</span>
<a href="#l36.884"></a><span id="l36.884">   nsCOMPtr&lt;nsIPop3ServiceListener&gt; listener;</span>
<a href="#l36.885"></a><span id="l36.885">   while (iter.HasMore()) {</span>
<a href="#l36.886"></a><span id="l36.886">     listener = iter.GetNext();</span>
<a href="#l36.887"></a><span id="l36.887">     listener-&gt;OnDownloadStarted(aFolder);</span>
<a href="#l36.888"></a><span id="l36.888">   }</span>
<a href="#l36.889"></a><span id="l36.889">   return NS_OK;</span>
<a href="#l36.890"></a><span id="l36.890"> }</span>
<a href="#l36.891"></a><span id="l36.891"> </span>
<a href="#l36.892"></a><span id="l36.892"> NS_IMETHODIMP</span>
<a href="#l36.893"></a><span id="l36.893"> nsPop3Service::NotifyDownloadProgress(nsIMsgFolder *aFolder,</span>
<a href="#l36.894"></a><span id="l36.894">                                       uint32_t aNumMessages,</span>
<a href="#l36.895"></a><span id="l36.895" class="difflineminus">-                                      uint32_t aNumTotalMessages)</span>
<a href="#l36.896"></a><span id="l36.896" class="difflineminus">-{</span>
<a href="#l36.897"></a><span id="l36.897" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt;::ForwardIterator</span>
<a href="#l36.898"></a><span id="l36.898" class="difflineminus">-    iter(mListeners);</span>
<a href="#l36.899"></a><span id="l36.899" class="difflineplus">+                                      uint32_t aNumTotalMessages) {</span>
<a href="#l36.900"></a><span id="l36.900" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l36.901"></a><span id="l36.901" class="difflineplus">+      mListeners);</span>
<a href="#l36.902"></a><span id="l36.902">   nsCOMPtr&lt;nsIPop3ServiceListener&gt; listener;</span>
<a href="#l36.903"></a><span id="l36.903">   while (iter.HasMore()) {</span>
<a href="#l36.904"></a><span id="l36.904">     listener = iter.GetNext();</span>
<a href="#l36.905"></a><span id="l36.905">     listener-&gt;OnDownloadProgress(aFolder, aNumMessages, aNumTotalMessages);</span>
<a href="#l36.906"></a><span id="l36.906">   }</span>
<a href="#l36.907"></a><span id="l36.907">   return NS_OK;</span>
<a href="#l36.908"></a><span id="l36.908"> }</span>
<a href="#l36.909"></a><span id="l36.909"> </span>
<a href="#l36.910"></a><span id="l36.910"> NS_IMETHODIMP</span>
<a href="#l36.911"></a><span id="l36.911"> nsPop3Service::NotifyDownloadCompleted(nsIMsgFolder *aFolder,</span>
<a href="#l36.912"></a><span id="l36.912" class="difflineminus">-                                       uint32_t aNumMessages)</span>
<a href="#l36.913"></a><span id="l36.913" class="difflineminus">-{</span>
<a href="#l36.914"></a><span id="l36.914" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt;::ForwardIterator</span>
<a href="#l36.915"></a><span id="l36.915" class="difflineminus">-    iter(mListeners);</span>
<a href="#l36.916"></a><span id="l36.916" class="difflineplus">+                                       uint32_t aNumMessages) {</span>
<a href="#l36.917"></a><span id="l36.917" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l36.918"></a><span id="l36.918" class="difflineplus">+      mListeners);</span>
<a href="#l36.919"></a><span id="l36.919">   nsCOMPtr&lt;nsIPop3ServiceListener&gt; listener;</span>
<a href="#l36.920"></a><span id="l36.920">   while (iter.HasMore()) {</span>
<a href="#l36.921"></a><span id="l36.921">     listener = iter.GetNext();</span>
<a href="#l36.922"></a><span id="l36.922">     listener-&gt;OnDownloadCompleted(aFolder, aNumMessages);</span>
<a href="#l36.923"></a><span id="l36.923">   }</span>
<a href="#l36.924"></a><span id="l36.924">   return NS_OK;</span>
<a href="#l36.925"></a><span id="l36.925"> }</span>
<a href="#l36.926"></a><span id="l36.926"> </span>
<a href="#l36.927"></a><span id="l36.927" class="difflineminus">-NS_IMETHODIMP nsPop3Service::AddListener(nsIPop3ServiceListener *aListener)</span>
<a href="#l36.928"></a><span id="l36.928" class="difflineminus">-{</span>
<a href="#l36.929"></a><span id="l36.929" class="difflineplus">+NS_IMETHODIMP nsPop3Service::AddListener(nsIPop3ServiceListener *aListener) {</span>
<a href="#l36.930"></a><span id="l36.930">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l36.931"></a><span id="l36.931">   mListeners.AppendElementUnlessExists(aListener);</span>
<a href="#l36.932"></a><span id="l36.932">   return NS_OK;</span>
<a href="#l36.933"></a><span id="l36.933"> }</span>
<a href="#l36.934"></a><span id="l36.934"> </span>
<a href="#l36.935"></a><span id="l36.935" class="difflineminus">-NS_IMETHODIMP nsPop3Service::RemoveListener(nsIPop3ServiceListener *aListener)</span>
<a href="#l36.936"></a><span id="l36.936" class="difflineminus">-{</span>
<a href="#l36.937"></a><span id="l36.937" class="difflineplus">+NS_IMETHODIMP nsPop3Service::RemoveListener(nsIPop3ServiceListener *aListener) {</span>
<a href="#l36.938"></a><span id="l36.938">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l36.939"></a><span id="l36.939">   mListeners.RemoveElement(aListener);</span>
<a href="#l36.940"></a><span id="l36.940">   return NS_OK;</span>
<a href="#l36.941"></a><span id="l36.941"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Service.h</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Service.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -13,38 +13,33 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> class nsIMsgMailNewsUrl;</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> class nsPop3Service : public nsIPop3Service,</span>
<a href="#l37.11"></a><span id="l37.11">                       public nsIProtocolHandler,</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-                      public nsIMsgProtocolInfo</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-{</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-public:</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+                      public nsIMsgProtocolInfo {</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ public:</span>
<a href="#l37.18"></a><span id="l37.18">   nsPop3Service();</span>
<a href="#l37.19"></a><span id="l37.19"> </span>
<a href="#l37.20"></a><span id="l37.20">   NS_DECL_ISUPPORTS</span>
<a href="#l37.21"></a><span id="l37.21">   NS_DECL_NSIPOP3SERVICE</span>
<a href="#l37.22"></a><span id="l37.22">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l37.23"></a><span id="l37.23">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-protected:</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+ protected:</span>
<a href="#l37.27"></a><span id="l37.27">   virtual ~nsPop3Service();</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-  nsresult GetMail(bool downloadNewMail,</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-                   nsIMsgWindow* aMsgWindow,</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-                   nsIUrlListener * aUrlListener,</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-                   nsIMsgFolder *inbox,</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-                   nsIPop3IncomingServer *popServer,</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-                   nsIURI ** aURL);</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+  nsresult GetMail(bool downloadNewMail, nsIMsgWindow *aMsgWindow,</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+                   nsIUrlListener *aUrlListener, nsIMsgFolder *inbox,</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+                   nsIPop3IncomingServer *popServer, nsIURI **aURL);</span>
<a href="#l37.37"></a><span id="l37.37">   // convenience function to make constructing of the pop3 url easier...</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-  nsresult BuildPop3Url(const char * urlSpec, nsIMsgFolder *inbox,</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-                    nsIPop3IncomingServer *, nsIUrlListener * aUrlListener,</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-                    nsIURI ** aUrl, nsIMsgWindow *aMsgWindow);</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+  nsresult BuildPop3Url(const char *urlSpec, nsIMsgFolder *inbox,</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+                        nsIPop3IncomingServer *, nsIUrlListener *aUrlListener,</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+                        nsIURI **aUrl, nsIMsgWindow *aMsgWindow);</span>
<a href="#l37.44"></a><span id="l37.44"> </span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-  nsresult RunPopUrl(nsIMsgIncomingServer * aServer, nsIURI * aUrlToRun);</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+  nsresult RunPopUrl(nsIMsgIncomingServer *aServer, nsIURI *aUrlToRun);</span>
<a href="#l37.47"></a><span id="l37.47">   void AlertServerBusy(nsIMsgMailNewsUrl *url);</span>
<a href="#l37.48"></a><span id="l37.48">   nsTObserverArray&lt;nsCOMPtr&lt;nsIPop3ServiceListener&gt; &gt; mListeners;</span>
<a href="#l37.49"></a><span id="l37.49"> };</span>
<a href="#l37.50"></a><span id="l37.50"> </span>
<a href="#l37.51"></a><span id="l37.51"> #endif /* nsPop3Service_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,26 +1,26 @@</span>
<a href="#l38.4"></a><span id="l38.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l38.5"></a><span id="l38.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.6"></a><span id="l38.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.7"></a><span id="l38.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l38.11"></a><span id="l38.11"> #include &quot;nsPop3Sink.h&quot;</span>
<a href="#l38.12"></a><span id="l38.12"> #include &quot;prprf.h&quot;</span>
<a href="#l38.13"></a><span id="l38.13"> #include &quot;prlog.h&quot;</span>
<a href="#l38.14"></a><span id="l38.14"> #include &quot;nscore.h&quot;</span>
<a href="#l38.15"></a><span id="l38.15"> #include &lt;stdio.h&gt;</span>
<a href="#l38.16"></a><span id="l38.16"> #include &lt;time.h&gt;</span>
<a href="#l38.17"></a><span id="l38.17"> #include &quot;nsParseMailbox.h&quot;</span>
<a href="#l38.18"></a><span id="l38.18"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l38.19"></a><span id="l38.19"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l38.20"></a><span id="l38.20"> #include &quot;nsLocalUtils.h&quot;</span>
<a href="#l38.21"></a><span id="l38.21"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-#include &quot;nsIMsgFolder.h&quot; // TO include biffState enum. Change to bool later...</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;  // TO include biffState enum. Change to bool later...</span>
<a href="#l38.24"></a><span id="l38.24"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l38.25"></a><span id="l38.25"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l38.26"></a><span id="l38.26"> #include &quot;nsIPop3Protocol.h&quot;</span>
<a href="#l38.27"></a><span id="l38.27"> #include &quot;nsLocalMailFolder.h&quot;</span>
<a href="#l38.28"></a><span id="l38.28"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l38.29"></a><span id="l38.29"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l38.30"></a><span id="l38.30"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l38.31"></a><span id="l38.31"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineat">@@ -34,137 +34,112 @@</span>
<a href="#l38.33"></a><span id="l38.33"> #include &quot;nsIPop3Service.h&quot;</span>
<a href="#l38.34"></a><span id="l38.34"> #include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l38.35"></a><span id="l38.35"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l38.36"></a><span id="l38.36"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l38.37"></a><span id="l38.37"> </span>
<a href="#l38.38"></a><span id="l38.38"> /* for logging to Error Console */</span>
<a href="#l38.39"></a><span id="l38.39"> #include &quot;nsIScriptError.h&quot;</span>
<a href="#l38.40"></a><span id="l38.40"> </span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-extern mozilla::LazyLogModule POP3LOGMODULE; //defined in nsPop3Protocol.cpp</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+extern mozilla::LazyLogModule POP3LOGMODULE;  // defined in nsPop3Protocol.cpp</span>
<a href="#l38.43"></a><span id="l38.43"> #define POP3LOG(str) &quot;sink: [this=%p] &quot; str, this</span>
<a href="#l38.44"></a><span id="l38.44"> </span>
<a href="#l38.45"></a><span id="l38.45"> NS_IMPL_ISUPPORTS(nsPop3Sink, nsIPop3Sink)</span>
<a href="#l38.46"></a><span id="l38.46"> </span>
<a href="#l38.47"></a><span id="l38.47" class="difflineminus">-nsPop3Sink::nsPop3Sink()</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineminus">-{</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineminus">-    m_authed = false;</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-    m_downloadingToTempFile = false;</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineminus">-    m_biffState = 0;</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-    m_numNewMessages = 0;</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-    m_numNewMessagesInFolder = 0;</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-    m_numMsgsDownloaded = 0;</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-    m_senderAuthed = false;</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineminus">-    m_outFileStream = nullptr;</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-    m_uidlDownload = false;</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineminus">-    m_buildMessageUri = false;</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+nsPop3Sink::nsPop3Sink() {</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+  m_authed = false;</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+  m_downloadingToTempFile = false;</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+  m_biffState = 0;</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+  m_numNewMessages = 0;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+  m_numNewMessagesInFolder = 0;</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+  m_numMsgsDownloaded = 0;</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+  m_senderAuthed = false;</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+  m_outFileStream = nullptr;</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+  m_uidlDownload = false;</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+  m_buildMessageUri = false;</span>
<a href="#l38.70"></a><span id="l38.70"> }</span>
<a href="#l38.71"></a><span id="l38.71"> </span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-nsPop3Sink::~nsPop3Sink()</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-{</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-    MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-            (POP3LOG(&quot;Calling ReleaseFolderLock from ~nsPop3Sink&quot;)));</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-    ReleaseFolderLock();</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+nsPop3Sink::~nsPop3Sink() {</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+  MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+          (POP3LOG(&quot;Calling ReleaseFolderLock from ~nsPop3Sink&quot;)));</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+  ReleaseFolderLock();</span>
<a href="#l38.81"></a><span id="l38.81"> }</span>
<a href="#l38.82"></a><span id="l38.82"> </span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-nsresult</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-nsPop3Sink::SetUserAuthenticated(bool authed)</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineminus">-{</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+nsresult nsPop3Sink::SetUserAuthenticated(bool authed) {</span>
<a href="#l38.87"></a><span id="l38.87">   m_authed = authed;</span>
<a href="#l38.88"></a><span id="l38.88">   m_popServer-&gt;SetAuthenticated(authed);</span>
<a href="#l38.89"></a><span id="l38.89">   return NS_OK;</span>
<a href="#l38.90"></a><span id="l38.90"> }</span>
<a href="#l38.91"></a><span id="l38.91"> </span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-nsresult</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-nsPop3Sink::GetUserAuthenticated(bool* authed)</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-{</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+nsresult nsPop3Sink::GetUserAuthenticated(bool *authed) {</span>
<a href="#l38.96"></a><span id="l38.96">   return m_popServer-&gt;GetAuthenticated(authed);</span>
<a href="#l38.97"></a><span id="l38.97"> }</span>
<a href="#l38.98"></a><span id="l38.98"> </span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-nsresult</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-nsPop3Sink::SetSenderAuthedFlag(void* closure, bool authed)</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-{</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+nsresult nsPop3Sink::SetSenderAuthedFlag(void *closure, bool authed) {</span>
<a href="#l38.103"></a><span id="l38.103">   m_authed = authed;</span>
<a href="#l38.104"></a><span id="l38.104">   return NS_OK;</span>
<a href="#l38.105"></a><span id="l38.105"> }</span>
<a href="#l38.106"></a><span id="l38.106"> </span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-nsresult</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineminus">-nsPop3Sink::SetMailAccountURL(const nsACString &amp;urlString)</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineminus">-{</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+nsresult nsPop3Sink::SetMailAccountURL(const nsACString &amp;urlString) {</span>
<a href="#l38.111"></a><span id="l38.111">   m_accountUrl.Assign(urlString);</span>
<a href="#l38.112"></a><span id="l38.112">   return NS_OK;</span>
<a href="#l38.113"></a><span id="l38.113"> }</span>
<a href="#l38.114"></a><span id="l38.114"> </span>
<a href="#l38.115"></a><span id="l38.115" class="difflineminus">-nsresult</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineminus">-nsPop3Sink::GetMailAccountURL(nsACString &amp;urlString)</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineminus">-{</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+nsresult nsPop3Sink::GetMailAccountURL(nsACString &amp;urlString) {</span>
<a href="#l38.119"></a><span id="l38.119">   urlString.Assign(m_accountUrl);</span>
<a href="#l38.120"></a><span id="l38.120">   return NS_OK;</span>
<a href="#l38.121"></a><span id="l38.121"> }</span>
<a href="#l38.122"></a><span id="l38.122"> </span>
<a href="#l38.123"></a><span id="l38.123" class="difflineminus">-partialRecord::partialRecord() :</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineminus">-  m_msgDBHdr(nullptr)</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineminus">-{</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-}</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+partialRecord::partialRecord() : m_msgDBHdr(nullptr) {}</span>
<a href="#l38.128"></a><span id="l38.128"> </span>
<a href="#l38.129"></a><span id="l38.129" class="difflineminus">-partialRecord::~partialRecord()</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineminus">-{</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineminus">-}</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+partialRecord::~partialRecord() {}</span>
<a href="#l38.133"></a><span id="l38.133"> </span>
<a href="#l38.134"></a><span id="l38.134"> // Walk through all the messages in this folder and look for any</span>
<a href="#l38.135"></a><span id="l38.135"> // PARTIAL messages. For each of those, dig through the mailbox and</span>
<a href="#l38.136"></a><span id="l38.136"> // find the Account that the message belongs to. If that Account</span>
<a href="#l38.137"></a><span id="l38.137"> // matches the current Account, then look for the Uidl and save</span>
<a href="#l38.138"></a><span id="l38.138"> // this message for later processing.</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineminus">-nsresult</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-nsPop3Sink::FindPartialMessages()</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineminus">-{</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+nsresult nsPop3Sink::FindPartialMessages() {</span>
<a href="#l38.143"></a><span id="l38.143">   nsCOMPtr&lt;nsISimpleEnumerator&gt; messages;</span>
<a href="#l38.144"></a><span id="l38.144">   bool hasMore = false;</span>
<a href="#l38.145"></a><span id="l38.145">   bool isOpen = false;</span>
<a href="#l38.146"></a><span id="l38.146">   nsLocalFolderScanState folderScanState;</span>
<a href="#l38.147"></a><span id="l38.147">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l38.148"></a><span id="l38.148">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.149"></a><span id="l38.149">   m_folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l38.150"></a><span id="l38.150">   if (!localFolder || !db)</span>
<a href="#l38.151"></a><span id="l38.151">     return NS_ERROR_FAILURE;  // we need it to grub through the folder</span>
<a href="#l38.152"></a><span id="l38.152"> </span>
<a href="#l38.153"></a><span id="l38.153">   nsresult rv = db-&gt;EnumerateMessages(getter_AddRefs(messages));</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineminus">-  if (messages)</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineminus">-    messages-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineminus">-  while(hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineminus">-  {</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+  if (messages) messages-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+  while (hasMore &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l38.160"></a><span id="l38.160">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l38.161"></a><span id="l38.161">     uint32_t flags = 0;</span>
<a href="#l38.162"></a><span id="l38.162">     rv = messages-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l38.163"></a><span id="l38.163">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l38.164"></a><span id="l38.164">     msgDBHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineminus">-    {</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::Partial) {</span>
<a href="#l38.168"></a><span id="l38.168">       // Open the various streams we need to seek and read from the mailbox</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineminus">-      if (!isOpen)</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineminus">-      {</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineplus">+      if (!isOpen) {</span>
<a href="#l38.172"></a><span id="l38.172">         rv = localFolder-&gt;GetFolderScanState(&amp;folderScanState);</span>
<a href="#l38.173"></a><span id="l38.173">         if (NS_SUCCEEDED(rv))</span>
<a href="#l38.174"></a><span id="l38.174">           isOpen = true;</span>
<a href="#l38.175"></a><span id="l38.175">         else</span>
<a href="#l38.176"></a><span id="l38.176">           break;</span>
<a href="#l38.177"></a><span id="l38.177">       }</span>
<a href="#l38.178"></a><span id="l38.178">       rv = localFolder-&gt;GetUidlFromFolder(&amp;folderScanState, msgDBHdr);</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineminus">-      if (!NS_SUCCEEDED(rv))</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineminus">-        break;</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineplus">+      if (!NS_SUCCEEDED(rv)) break;</span>
<a href="#l38.182"></a><span id="l38.182"> </span>
<a href="#l38.183"></a><span id="l38.183">       // If we got the uidl, see if this partial message belongs to this</span>
<a href="#l38.184"></a><span id="l38.184">       // account. Add it to the array if so...</span>
<a href="#l38.185"></a><span id="l38.185">       if (folderScanState.m_uidl &amp;&amp;</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineminus">-          m_accountKey.Equals(folderScanState.m_accountKey, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineminus">-      {</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineplus">+          m_accountKey.Equals(folderScanState.m_accountKey,</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineplus">+                              nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l38.190"></a><span id="l38.190">         partialRecord *partialMsg = new partialRecord();</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineminus">-        if (partialMsg)</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineminus">-        {</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineplus">+        if (partialMsg) {</span>
<a href="#l38.194"></a><span id="l38.194">           partialMsg-&gt;m_uidl = folderScanState.m_uidl;</span>
<a href="#l38.195"></a><span id="l38.195">           partialMsg-&gt;m_msgDBHdr = msgDBHdr;</span>
<a href="#l38.196"></a><span id="l38.196">           m_partialMsgsArray.AppendElement(partialMsg);</span>
<a href="#l38.197"></a><span id="l38.197">         }</span>
<a href="#l38.198"></a><span id="l38.198">       }</span>
<a href="#l38.199"></a><span id="l38.199">     }</span>
<a href="#l38.200"></a><span id="l38.200">     messages-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l38.201"></a><span id="l38.201">   }</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineat">@@ -172,844 +147,777 @@ nsPop3Sink::FindPartialMessages()</span>
<a href="#l38.203"></a><span id="l38.203">     folderScanState.m_inputStream-&gt;Close();</span>
<a href="#l38.204"></a><span id="l38.204">   return rv;</span>
<a href="#l38.205"></a><span id="l38.205"> }</span>
<a href="#l38.206"></a><span id="l38.206"> </span>
<a href="#l38.207"></a><span id="l38.207"> // For all the partial messages saved by FindPartialMessages,</span>
<a href="#l38.208"></a><span id="l38.208"> // ask the protocol handler if they still exist on the server.</span>
<a href="#l38.209"></a><span id="l38.209"> // Any messages that don't exist any more are deleted from the</span>
<a href="#l38.210"></a><span id="l38.210"> // msgDB.</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineminus">-void</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-nsPop3Sink::CheckPartialMessages(nsIPop3Protocol *protocol)</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineminus">-{</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineplus">+void nsPop3Sink::CheckPartialMessages(nsIPop3Protocol *protocol) {</span>
<a href="#l38.215"></a><span id="l38.215">   uint32_t count = m_partialMsgsArray.Length();</span>
<a href="#l38.216"></a><span id="l38.216">   bool deleted = false;</span>
<a href="#l38.217"></a><span id="l38.217"> </span>
<a href="#l38.218"></a><span id="l38.218" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineminus">-  {</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l38.221"></a><span id="l38.221">     partialRecord *partialMsg;</span>
<a href="#l38.222"></a><span id="l38.222">     bool found = true;</span>
<a href="#l38.223"></a><span id="l38.223">     partialMsg = m_partialMsgsArray.ElementAt(i);</span>
<a href="#l38.224"></a><span id="l38.224">     protocol-&gt;CheckMessage(partialMsg-&gt;m_uidl.get(), &amp;found);</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineminus">-    if (!found &amp;&amp; partialMsg-&gt;m_msgDBHdr)</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineminus">-    {</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineplus">+    if (!found &amp;&amp; partialMsg-&gt;m_msgDBHdr) {</span>
<a href="#l38.228"></a><span id="l38.228">       if (m_newMailParser)</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineminus">-        m_newMailParser-&gt;m_mailDB-&gt;DeleteHeader(partialMsg-&gt;m_msgDBHdr, nullptr, false, true);</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineplus">+        m_newMailParser-&gt;m_mailDB-&gt;DeleteHeader(partialMsg-&gt;m_msgDBHdr, nullptr,</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineplus">+                                                false, true);</span>
<a href="#l38.232"></a><span id="l38.232">       deleted = true;</span>
<a href="#l38.233"></a><span id="l38.233">     }</span>
<a href="#l38.234"></a><span id="l38.234">     delete partialMsg;</span>
<a href="#l38.235"></a><span id="l38.235">   }</span>
<a href="#l38.236"></a><span id="l38.236">   m_partialMsgsArray.Clear();</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineminus">-  if (deleted)</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineminus">-  {</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineplus">+  if (deleted) {</span>
<a href="#l38.240"></a><span id="l38.240">     nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineminus">-    if (localFolder)</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineminus">-      localFolder-&gt;NotifyDelete();</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineplus">+    if (localFolder) localFolder-&gt;NotifyDelete();</span>
<a href="#l38.244"></a><span id="l38.244">   }</span>
<a href="#l38.245"></a><span id="l38.245"> }</span>
<a href="#l38.246"></a><span id="l38.246"> </span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-nsresult</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineminus">-nsPop3Sink::BeginMailDelivery(bool uidlDownload, nsIMsgWindow *aMsgWindow, bool* aBool)</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineminus">-{</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineplus">+nsresult nsPop3Sink::BeginMailDelivery(bool uidlDownload,</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineplus">+                                       nsIMsgWindow *aMsgWindow, bool *aBool) {</span>
<a href="#l38.252"></a><span id="l38.252">   nsresult rv;</span>
<a href="#l38.253"></a><span id="l38.253"> </span>
<a href="#l38.254"></a><span id="l38.254">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineminus">-  if (!server)</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineplus">+  if (!server) return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.258"></a><span id="l38.258"> </span>
<a href="#l38.259"></a><span id="l38.259">   m_window = aMsgWindow;</span>
<a href="#l38.260"></a><span id="l38.260"> </span>
<a href="#l38.261"></a><span id="l38.261" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; acctMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; acctMgr =</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l38.266"></a><span id="l38.266">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.267"></a><span id="l38.267">   acctMgr-&gt;FindAccountForServer(server, getter_AddRefs(account));</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineminus">-  if (account)</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineminus">-    account-&gt;GetKey(m_accountKey);</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineplus">+  if (account) account-&gt;GetKey(m_accountKey);</span>
<a href="#l38.271"></a><span id="l38.271"> </span>
<a href="#l38.272"></a><span id="l38.272">   bool isLocked;</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIPop3Sink*&gt;(this));</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineplus">+      do_QueryInterface(static_cast&lt;nsIPop3Sink *&gt;(this));</span>
<a href="#l38.276"></a><span id="l38.276">   m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineminus">-  if(!isLocked)</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineminus">-  {</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineplus">+  if (!isLocked) {</span>
<a href="#l38.280"></a><span id="l38.280">     MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.281"></a><span id="l38.281">             (POP3LOG(&quot;BeginMailDelivery acquiring semaphore&quot;)));</span>
<a href="#l38.282"></a><span id="l38.282">     m_folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineminus">-  }</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineminus">-  else</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-  {</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineplus">+  } else {</span>
<a href="#l38.287"></a><span id="l38.287">     MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.288"></a><span id="l38.288">             (POP3LOG(&quot;BeginMailDelivery folder locked&quot;)));</span>
<a href="#l38.289"></a><span id="l38.289">     return NS_MSG_FOLDER_BUSY;</span>
<a href="#l38.290"></a><span id="l38.290">   }</span>
<a href="#l38.291"></a><span id="l38.291">   m_uidlDownload = uidlDownload;</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineminus">-  if (!uidlDownload)</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-    FindPartialMessages();</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineplus">+  if (!uidlDownload) FindPartialMessages();</span>
<a href="#l38.295"></a><span id="l38.295"> </span>
<a href="#l38.296"></a><span id="l38.296">   m_folder-&gt;GetNumNewMessages(false, &amp;m_numNewMessagesInFolder);</span>
<a href="#l38.297"></a><span id="l38.297"> </span>
<a href="#l38.298"></a><span id="l38.298"> #ifdef DEBUG</span>
<a href="#l38.299"></a><span id="l38.299">   printf(&quot;Begin mail message delivery.\n&quot;);</span>
<a href="#l38.300"></a><span id="l38.300"> #endif</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineminus">-  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineplus">+      do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.304"></a><span id="l38.304">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.305"></a><span id="l38.305">   pop3Service-&gt;NotifyDownloadStarted(m_folder);</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineminus">-  if (aBool)</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineminus">-    *aBool = true;</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineplus">+  if (aBool) *aBool = true;</span>
<a href="#l38.309"></a><span id="l38.309">   return NS_OK;</span>
<a href="#l38.310"></a><span id="l38.310"> }</span>
<a href="#l38.311"></a><span id="l38.311"> </span>
<a href="#l38.312"></a><span id="l38.312" class="difflineminus">-nsresult</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineminus">-nsPop3Sink::EndMailDelivery(nsIPop3Protocol *protocol)</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineminus">-{</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineplus">+nsresult nsPop3Sink::EndMailDelivery(nsIPop3Protocol *protocol) {</span>
<a href="#l38.316"></a><span id="l38.316">   CheckPartialMessages(protocol);</span>
<a href="#l38.317"></a><span id="l38.317"> </span>
<a href="#l38.318"></a><span id="l38.318" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineminus">-  {</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineminus">-    if (m_outFileStream)</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineminus">-      m_outFileStream-&gt;Flush();  // try this.</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineplus">+  if (m_newMailParser) {</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+    if (m_outFileStream) m_outFileStream-&gt;Flush();  // try this.</span>
<a href="#l38.324"></a><span id="l38.324">     m_newMailParser-&gt;OnStopRequest(nullptr, NS_OK);</span>
<a href="#l38.325"></a><span id="l38.325">     m_newMailParser-&gt;EndMsgDownload();</span>
<a href="#l38.326"></a><span id="l38.326">   }</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineminus">-  if (m_outFileStream)</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineminus">-  {</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+  if (m_outFileStream) {</span>
<a href="#l38.330"></a><span id="l38.330">     m_outFileStream-&gt;Close();</span>
<a href="#l38.331"></a><span id="l38.331">     m_outFileStream = nullptr;</span>
<a href="#l38.332"></a><span id="l38.332">   }</span>
<a href="#l38.333"></a><span id="l38.333"> </span>
<a href="#l38.334"></a><span id="l38.334" class="difflineminus">-  if (m_downloadingToTempFile)</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineminus">-    m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+  if (m_downloadingToTempFile) m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l38.337"></a><span id="l38.337"> </span>
<a href="#l38.338"></a><span id="l38.338">   // tell the parser to mark the db valid *after* closing the mailbox.</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineminus">-    m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineplus">+  if (m_newMailParser) m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l38.342"></a><span id="l38.342"> </span>
<a href="#l38.343"></a><span id="l38.343">   MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.344"></a><span id="l38.344">           (POP3LOG(&quot;Calling ReleaseFolderLock from EndMailDelivery&quot;)));</span>
<a href="#l38.345"></a><span id="l38.345">   nsresult rv = ReleaseFolderLock();</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;folder lock not released successfully&quot;);</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;folder lock not released successfully&quot;);</span>
<a href="#l38.348"></a><span id="l38.348"> </span>
<a href="#l38.349"></a><span id="l38.349">   bool filtersRun;</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-  m_folder-&gt;CallFilterPlugins(nullptr, &amp;filtersRun); // ??? do we need msgWindow?</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineplus">+  m_folder-&gt;CallFilterPlugins(nullptr,</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineplus">+                              &amp;filtersRun);  // ??? do we need msgWindow?</span>
<a href="#l38.353"></a><span id="l38.353">   int32_t numNewMessagesInFolder;</span>
<a href="#l38.354"></a><span id="l38.354">   // if filters have marked msgs read or deleted, the num new messages count</span>
<a href="#l38.355"></a><span id="l38.355">   // will go negative by the number of messages marked read or deleted,</span>
<a href="#l38.356"></a><span id="l38.356">   // so if we add that number to the number of msgs downloaded, that will give</span>
<a href="#l38.357"></a><span id="l38.357">   // us the number of actual new messages.</span>
<a href="#l38.358"></a><span id="l38.358">   m_folder-&gt;GetNumNewMessages(false, &amp;numNewMessagesInFolder);</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineminus">-  m_numNewMessages -= (m_numNewMessagesInFolder  - numNewMessagesInFolder);</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineminus">-  m_folder-&gt;SetNumNewMessages(m_numNewMessages); // we'll adjust this for spam later</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineminus">-  if (!filtersRun &amp;&amp; m_numNewMessages &gt; 0)</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineminus">-  {</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineplus">+  m_numNewMessages -= (m_numNewMessagesInFolder - numNewMessagesInFolder);</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineplus">+  m_folder-&gt;SetNumNewMessages(</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineplus">+      m_numNewMessages);  // we'll adjust this for spam later</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineplus">+  if (!filtersRun &amp;&amp; m_numNewMessages &gt; 0) {</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l38.369"></a><span id="l38.369">     m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineminus">-    if (server)</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineminus">-    {</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineplus">+    if (server) {</span>
<a href="#l38.373"></a><span id="l38.373">       server-&gt;SetPerformingBiff(true);</span>
<a href="#l38.374"></a><span id="l38.374">       m_folder-&gt;SetBiffState(m_biffState);</span>
<a href="#l38.375"></a><span id="l38.375">       server-&gt;SetPerformingBiff(false);</span>
<a href="#l38.376"></a><span id="l38.376">     }</span>
<a href="#l38.377"></a><span id="l38.377">   }</span>
<a href="#l38.378"></a><span id="l38.378">   // note that size on disk has possibly changed.</span>
<a href="#l38.379"></a><span id="l38.379">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-  if (localFolder)</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineminus">-    (void) localFolder-&gt;RefreshSizeOnDisk();</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineplus">+  if (localFolder) (void)localFolder-&gt;RefreshSizeOnDisk();</span>
<a href="#l38.383"></a><span id="l38.383">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineminus">-  if (server)</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineminus">-  {</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+  if (server) {</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l38.389"></a><span id="l38.389">     rv = server-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l38.390"></a><span id="l38.390">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.391"></a><span id="l38.391"> </span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-    if (filterList)</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineminus">-      (void) filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+    if (filterList) (void)filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l38.395"></a><span id="l38.395">   }</span>
<a href="#l38.396"></a><span id="l38.396"> </span>
<a href="#l38.397"></a><span id="l38.397">   // fix for bug #161999</span>
<a href="#l38.398"></a><span id="l38.398">   // we should update the summary totals for the folder (inbox)</span>
<a href="#l38.399"></a><span id="l38.399">   // in case it's not the open folder</span>
<a href="#l38.400"></a><span id="l38.400">   m_folder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l38.401"></a><span id="l38.401"> </span>
<a href="#l38.402"></a><span id="l38.402" class="difflineminus">-  // check if the folder open in this window is not the current folder, and if it has new</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineminus">-  // message, in which case we need to try to run the filter plugin.</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineminus">-  {</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineminus">-    nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineplus">+  // check if the folder open in this window is not the current folder, and if</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineplus">+  // it has new message, in which case we need to try to run the filter plugin.</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+  if (m_newMailParser) {</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l38.411"></a><span id="l38.411">     m_newMailParser-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l38.412"></a><span id="l38.412">     // this breaks down if it's biff downloading new mail because</span>
<a href="#l38.413"></a><span id="l38.413">     // there's no msgWindow...</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineminus">-    if (msgWindow)</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineminus">-    {</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; openFolder;</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineminus">-      (void) msgWindow-&gt;GetOpenFolder(getter_AddRefs(openFolder));</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineminus">-      if (openFolder &amp;&amp; openFolder != m_folder)</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-      {</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; openFolder;</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineplus">+      (void)msgWindow-&gt;GetOpenFolder(getter_AddRefs(openFolder));</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineplus">+      if (openFolder &amp;&amp; openFolder != m_folder) {</span>
<a href="#l38.424"></a><span id="l38.424">         // only call filter plugins if folder is a local folder, because only</span>
<a href="#l38.425"></a><span id="l38.425">         // local folders get messages filtered into them synchronously by pop3.</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineminus">-        nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(openFolder);</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineminus">-        if (localFolder)</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineminus">-        {</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineplus">+        nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineplus">+            do_QueryInterface(openFolder);</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineplus">+        if (localFolder) {</span>
<a href="#l38.432"></a><span id="l38.432">           bool hasNew, isLocked;</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-          (void) openFolder-&gt;GetHasNewMessages(&amp;hasNew);</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-          if (hasNew)</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineminus">-          {</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineplus">+          (void)openFolder-&gt;GetHasNewMessages(&amp;hasNew);</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineplus">+          if (hasNew) {</span>
<a href="#l38.438"></a><span id="l38.438">             // if the open folder is locked, we shouldn't run the spam filters</span>
<a href="#l38.439"></a><span id="l38.439">             // on it because someone is using the folder. see 218433.</span>
<a href="#l38.440"></a><span id="l38.440">             // Ideally, the filter plugin code would try to grab the folder lock</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineminus">-            // and hold onto it until done, but that's more difficult and I think</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineminus">-            // this will actually fix the problem.</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineplus">+            // and hold onto it until done, but that's more difficult and I</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineplus">+            // think this will actually fix the problem.</span>
<a href="#l38.445"></a><span id="l38.445">             openFolder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineminus">-            if(!isLocked)</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineminus">-              openFolder-&gt;CallFilterPlugins(nullptr, &amp;filtersRun);</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineplus">+            if (!isLocked) openFolder-&gt;CallFilterPlugins(nullptr, &amp;filtersRun);</span>
<a href="#l38.449"></a><span id="l38.449">           }</span>
<a href="#l38.450"></a><span id="l38.450">         }</span>
<a href="#l38.451"></a><span id="l38.451">       }</span>
<a href="#l38.452"></a><span id="l38.452">     }</span>
<a href="#l38.453"></a><span id="l38.453">   }</span>
<a href="#l38.454"></a><span id="l38.454"> #ifdef DEBUG</span>
<a href="#l38.455"></a><span id="l38.455">   printf(&quot;End mail message delivery.\n&quot;);</span>
<a href="#l38.456"></a><span id="l38.456"> #endif</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineplus">+      do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.460"></a><span id="l38.460">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.461"></a><span id="l38.461">   pop3Service-&gt;NotifyDownloadCompleted(m_folder, m_numNewMessages);</span>
<a href="#l38.462"></a><span id="l38.462">   return NS_OK;</span>
<a href="#l38.463"></a><span id="l38.463"> }</span>
<a href="#l38.464"></a><span id="l38.464"> </span>
<a href="#l38.465"></a><span id="l38.465" class="difflineminus">-nsresult</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineminus">-nsPop3Sink::ReleaseFolderLock()</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineminus">-{</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineplus">+nsresult nsPop3Sink::ReleaseFolderLock() {</span>
<a href="#l38.469"></a><span id="l38.469">   nsresult result = NS_OK;</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineminus">-  if (!m_folder)</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineminus">-    return result;</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineplus">+  if (!m_folder) return result;</span>
<a href="#l38.473"></a><span id="l38.473">   bool haveSemaphore;</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIPop3Sink*&gt;(this));</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports =</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineplus">+      do_QueryInterface(static_cast&lt;nsIPop3Sink *&gt;(this));</span>
<a href="#l38.477"></a><span id="l38.477">   result = m_folder-&gt;TestSemaphore(supports, &amp;haveSemaphore);</span>
<a href="#l38.478"></a><span id="l38.478">   MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineminus">-          (POP3LOG(&quot;ReleaseFolderLock haveSemaphore = %s&quot;), haveSemaphore ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l38.480"></a><span id="l38.480" class="difflineplus">+          (POP3LOG(&quot;ReleaseFolderLock haveSemaphore = %s&quot;),</span>
<a href="#l38.481"></a><span id="l38.481" class="difflineplus">+           haveSemaphore ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l38.482"></a><span id="l38.482"> </span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-  if(NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineplus">+  if (NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l38.485"></a><span id="l38.485">     result = m_folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l38.486"></a><span id="l38.486">   return result;</span>
<a href="#l38.487"></a><span id="l38.487"> }</span>
<a href="#l38.488"></a><span id="l38.488"> </span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-nsresult</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-nsPop3Sink::AbortMailDelivery(nsIPop3Protocol *protocol)</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-{</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineplus">+nsresult nsPop3Sink::AbortMailDelivery(nsIPop3Protocol *protocol) {</span>
<a href="#l38.493"></a><span id="l38.493">   CheckPartialMessages(protocol);</span>
<a href="#l38.494"></a><span id="l38.494"> </span>
<a href="#l38.495"></a><span id="l38.495">   // ### PS TODO - discard any new message?</span>
<a href="#l38.496"></a><span id="l38.496"> </span>
<a href="#l38.497"></a><span id="l38.497" class="difflineminus">-  if (m_outFileStream)</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineminus">-  {</span>
<a href="#l38.499"></a><span id="l38.499" class="difflineplus">+  if (m_outFileStream) {</span>
<a href="#l38.500"></a><span id="l38.500">     m_outFileStream-&gt;Close();</span>
<a href="#l38.501"></a><span id="l38.501">     m_outFileStream = nullptr;</span>
<a href="#l38.502"></a><span id="l38.502">   }</span>
<a href="#l38.503"></a><span id="l38.503"> </span>
<a href="#l38.504"></a><span id="l38.504">   if (m_downloadingToTempFile &amp;&amp; m_tmpDownloadFile)</span>
<a href="#l38.505"></a><span id="l38.505">     m_tmpDownloadFile-&gt;Remove(false);</span>
<a href="#l38.506"></a><span id="l38.506"> </span>
<a href="#l38.507"></a><span id="l38.507">   /* tell the parser to mark the db valid *after* closing the mailbox.</span>
<a href="#l38.508"></a><span id="l38.508">   we have truncated the inbox, so berkeley mailbox and msf file are in sync*/</span>
<a href="#l38.509"></a><span id="l38.509" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineminus">-    m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineplus">+  if (m_newMailParser) m_newMailParser-&gt;UpdateDBFolderInfo();</span>
<a href="#l38.512"></a><span id="l38.512">   MOZ_LOG(POP3LOGMODULE, mozilla::LogLevel::Debug,</span>
<a href="#l38.513"></a><span id="l38.513">           (POP3LOG(&quot;Calling ReleaseFolderLock from AbortMailDelivery&quot;)));</span>
<a href="#l38.514"></a><span id="l38.514"> </span>
<a href="#l38.515"></a><span id="l38.515">   nsresult rv = ReleaseFolderLock();</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;folder lock not released successfully&quot;);</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;folder lock not released successfully&quot;);</span>
<a href="#l38.518"></a><span id="l38.518"> </span>
<a href="#l38.519"></a><span id="l38.519"> #ifdef DEBUG</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineminus">-    printf(&quot;Abort mail message delivery.\n&quot;);</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineplus">+  printf(&quot;Abort mail message delivery.\n&quot;);</span>
<a href="#l38.522"></a><span id="l38.522"> #endif</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineplus">+      do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.526"></a><span id="l38.526">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.527"></a><span id="l38.527">   pop3Service-&gt;NotifyDownloadCompleted(m_folder, 0);</span>
<a href="#l38.528"></a><span id="l38.528">   return NS_OK;</span>
<a href="#l38.529"></a><span id="l38.529"> }</span>
<a href="#l38.530"></a><span id="l38.530"> </span>
<a href="#l38.531"></a><span id="l38.531"> NS_IMETHODIMP</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-nsPop3Sink::IncorporateBegin(const char* uidlString,</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-                             nsIURI* aURL,</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineminus">-                             uint32_t flags,</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineminus">-                             void** closure)</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineminus">-{</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineplus">+nsPop3Sink::IncorporateBegin(const char *uidlString, nsIURI *aURL,</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineplus">+                             uint32_t flags, void **closure) {</span>
<a href="#l38.539"></a><span id="l38.539"> #ifdef DEBUG</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineminus">-    printf(&quot;Incorporate message begin:\n&quot;);</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineminus">-    if (uidlString)</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineminus">-        printf(&quot;uidl string: %s\n&quot;, uidlString);</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineplus">+  printf(&quot;Incorporate message begin:\n&quot;);</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineplus">+  if (uidlString) printf(&quot;uidl string: %s\n&quot;, uidlString);</span>
<a href="#l38.545"></a><span id="l38.545"> #endif</span>
<a href="#l38.546"></a><span id="l38.546">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l38.547"></a><span id="l38.547"> </span>
<a href="#l38.548"></a><span id="l38.548">   m_folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l38.549"></a><span id="l38.549"> </span>
<a href="#l38.550"></a><span id="l38.550">   nsresult rv;</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-  {</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l38.557"></a><span id="l38.557">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l38.558"></a><span id="l38.558">     m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l38.559"></a><span id="l38.559">     nsCString plugStoreContract;</span>
<a href="#l38.560"></a><span id="l38.560">     server-&gt;GetCharValue(&quot;storeContractID&quot;, plugStoreContract);</span>
<a href="#l38.561"></a><span id="l38.561">     // Maildir doesn't care about quaranting, but other stores besides berkeley</span>
<a href="#l38.562"></a><span id="l38.562">     // mailbox might. We should probably make this an attribute on the pluggable</span>
<a href="#l38.563"></a><span id="l38.563">     // store, though.</span>
<a href="#l38.564"></a><span id="l38.564">     if (plugStoreContract.Equals(</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineminus">-          NS_LITERAL_CSTRING(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;)))</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineminus">-      pPrefBranch-&gt;GetBoolPref(&quot;mailnews.downloadToTempFile&quot;, &amp;m_downloadingToTempFile);</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineplus">+            NS_LITERAL_CSTRING(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;)))</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineplus">+      pPrefBranch-&gt;GetBoolPref(&quot;mailnews.downloadToTempFile&quot;,</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineplus">+                               &amp;m_downloadingToTempFile);</span>
<a href="#l38.570"></a><span id="l38.570">   }</span>
<a href="#l38.571"></a><span id="l38.571"> </span>
<a href="#l38.572"></a><span id="l38.572">   nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l38.573"></a><span id="l38.573"> </span>
<a href="#l38.574"></a><span id="l38.574">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineminus">-  if (!server)</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineplus">+  if (!server) return NS_ERROR_UNEXPECTED;</span>
<a href="#l38.578"></a><span id="l38.578"> </span>
<a href="#l38.579"></a><span id="l38.579" class="difflineminus">-  if (m_downloadingToTempFile)</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineminus">-  {</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineplus">+  if (m_downloadingToTempFile) {</span>
<a href="#l38.582"></a><span id="l38.582">     // need to create an nsIOFileStream from a temp file...</span>
<a href="#l38.583"></a><span id="l38.583">     nsCOMPtr&lt;nsIFile&gt; tmpDownloadFile;</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineminus">-    rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineminus">-                                         &quot;newmsg&quot;,</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineplus">+    rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;newmsg&quot;,</span>
<a href="#l38.587"></a><span id="l38.587">                                          getter_AddRefs(tmpDownloadFile));</span>
<a href="#l38.588"></a><span id="l38.588"> </span>
<a href="#l38.589"></a><span id="l38.589">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l38.590"></a><span id="l38.590">                  &quot;writing tmp pop3 download file: failed to append filename&quot;);</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineminus">-      return rv;</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.594"></a><span id="l38.594"> </span>
<a href="#l38.595"></a><span id="l38.595" class="difflineminus">-    if (!m_tmpDownloadFile)</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineminus">-    {</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineminus">-      //need a unique tmp file to prevent dataloss in multiuser environment</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineplus">+    if (!m_tmpDownloadFile) {</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineplus">+      // need a unique tmp file to prevent dataloss in multiuser environment</span>
<a href="#l38.600"></a><span id="l38.600">       rv = tmpDownloadFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l38.601"></a><span id="l38.601">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.602"></a><span id="l38.602"> </span>
<a href="#l38.603"></a><span id="l38.603">       m_tmpDownloadFile = tmpDownloadFile;</span>
<a href="#l38.604"></a><span id="l38.604">     }</span>
<a href="#l38.605"></a><span id="l38.605">     rv = MsgGetFileStream(m_tmpDownloadFile, getter_AddRefs(m_outFileStream));</span>
<a href="#l38.606"></a><span id="l38.606">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineminus">-  }</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineminus">-  else</span>
<a href="#l38.609"></a><span id="l38.609" class="difflineminus">-  {</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineplus">+  } else {</span>
<a href="#l38.611"></a><span id="l38.611">     rv = server-&gt;GetMsgStore(getter_AddRefs(m_msgStore));</span>
<a href="#l38.612"></a><span id="l38.612">     bool reusable;</span>
<a href="#l38.613"></a><span id="l38.613">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.614"></a><span id="l38.614">     m_msgStore-&gt;GetNewMsgOutputStream(m_folder, getter_AddRefs(newHdr),</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineminus">-                                      &amp;reusable, getter_AddRefs(m_outFileStream));</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineplus">+                                      &amp;reusable,</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineplus">+                                      getter_AddRefs(m_outFileStream));</span>
<a href="#l38.618"></a><span id="l38.618">   }</span>
<a href="#l38.619"></a><span id="l38.619">   // The following (!m_outFileStream etc) was added to make sure that we don't</span>
<a href="#l38.620"></a><span id="l38.620">   // write somewhere where for some reason or another we can't write to and</span>
<a href="#l38.621"></a><span id="l38.621">   // lose the messages. See bug 62480</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">-  if (!m_outFileStream)</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineplus">+  if (!m_outFileStream) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.625"></a><span id="l38.625"> </span>
<a href="#l38.626"></a><span id="l38.626" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; seekableOutStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableOutStream =</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineplus">+      do_QueryInterface(m_outFileStream);</span>
<a href="#l38.629"></a><span id="l38.629"> </span>
<a href="#l38.630"></a><span id="l38.630">   // create a new mail parser</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-  if (!m_newMailParser)</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-    m_newMailParser = new nsParseNewMailState;</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineplus">+  if (!m_newMailParser) m_newMailParser = new nsParseNewMailState;</span>
<a href="#l38.634"></a><span id="l38.634">   NS_ENSURE_TRUE(m_newMailParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineminus">-  if (m_uidlDownload)</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineminus">-    m_newMailParser-&gt;DisableFilters();</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineplus">+  if (m_uidlDownload) m_newMailParser-&gt;DisableFilters();</span>
<a href="#l38.638"></a><span id="l38.638"> </span>
<a href="#l38.639"></a><span id="l38.639" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l38.641"></a><span id="l38.641">   rv = GetServerFolder(getter_AddRefs(serverFolder));</span>
<a href="#l38.642"></a><span id="l38.642">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.643"></a><span id="l38.643"> </span>
<a href="#l38.644"></a><span id="l38.644" class="difflineminus">-  rv = m_newMailParser-&gt;Init(serverFolder, m_folder,</span>
<a href="#l38.645"></a><span id="l38.645" class="difflineminus">-                             m_window, newHdr, m_outFileStream);</span>
<a href="#l38.646"></a><span id="l38.646" class="difflineplus">+  rv = m_newMailParser-&gt;Init(serverFolder, m_folder, m_window, newHdr,</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineplus">+                             m_outFileStream);</span>
<a href="#l38.648"></a><span id="l38.648">   // If we failed to initialize the parser, then just don't use it!!!</span>
<a href="#l38.649"></a><span id="l38.649">   // We can still continue without one.</span>
<a href="#l38.650"></a><span id="l38.650"> </span>
<a href="#l38.651"></a><span id="l38.651" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineminus">-  {</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l38.654"></a><span id="l38.654">     m_newMailParser = nullptr;</span>
<a href="#l38.655"></a><span id="l38.655">     rv = NS_OK;</span>
<a href="#l38.656"></a><span id="l38.656">   }</span>
<a href="#l38.657"></a><span id="l38.657"> </span>
<a href="#l38.658"></a><span id="l38.658" class="difflineminus">-    if (closure)</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineminus">-        *closure = (void*) this;</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineminus">-</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineminus">-    // Debugging, see bug 1116055.</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineminus">-    int64_t first_pre_seek_pos;</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineminus">-    nsresult rv3 = seekableOutStream-&gt;Tell(&amp;first_pre_seek_pos);</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineminus">-#endif</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineminus">-</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineminus">-    // XXX Handle error such as network error for remote file system.</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineminus">-    seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineplus">+  if (closure) *closure = (void *)this;</span>
<a href="#l38.670"></a><span id="l38.670"> </span>
<a href="#l38.671"></a><span id="l38.671"> #ifdef DEBUG</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineminus">-    // Debugging, see bug 1116055.</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineminus">-    int64_t first_post_seek_pos;</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineminus">-    nsresult rv4 = seekableOutStream-&gt;Tell(&amp;first_post_seek_pos);</span>
<a href="#l38.675"></a><span id="l38.675" class="difflineminus">-    if (NS_SUCCEEDED(rv3) &amp;&amp; NS_SUCCEEDED(rv4)) {</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineminus">-      if (first_pre_seek_pos != first_post_seek_pos) {</span>
<a href="#l38.677"></a><span id="l38.677" class="difflineminus">-        nsString folderName;</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineminus">-        if (m_folder)</span>
<a href="#l38.679"></a><span id="l38.679" class="difflineminus">-          m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.680"></a><span id="l38.680" class="difflineminus">-        if (!folderName.IsEmpty()) {</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineminus">-          fprintf(stderr,&quot;(seekdebug) Seek was necessary in IncorporateBegin() for folder %s.\n&quot;,</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineminus">-                  NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineminus">-        } else {</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineminus">-          fprintf(stderr,&quot;(seekdebug) Seek was necessary in IncorporateBegin().\n&quot;);</span>
<a href="#l38.685"></a><span id="l38.685" class="difflineminus">-        }</span>
<a href="#l38.686"></a><span id="l38.686" class="difflineminus">-        fprintf(stderr,&quot;(seekdebug) first_pre_seek_pos = 0x%016llx, first_post_seek_pos=0x%016llx\n&quot;,</span>
<a href="#l38.687"></a><span id="l38.687" class="difflineminus">-                (unsigned long long) first_pre_seek_pos, (unsigned long long) first_post_seek_pos);</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineminus">-      }</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineminus">-    }</span>
<a href="#l38.690"></a><span id="l38.690" class="difflineplus">+  // Debugging, see bug 1116055.</span>
<a href="#l38.691"></a><span id="l38.691" class="difflineplus">+  int64_t first_pre_seek_pos;</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineplus">+  nsresult rv3 = seekableOutStream-&gt;Tell(&amp;first_pre_seek_pos);</span>
<a href="#l38.693"></a><span id="l38.693"> #endif</span>
<a href="#l38.694"></a><span id="l38.694"> </span>
<a href="#l38.695"></a><span id="l38.695" class="difflineminus">-    nsCString outputString(GetDummyEnvelope());</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineplus">+  // XXX Handle error such as network error for remote file system.</span>
<a href="#l38.697"></a><span id="l38.697" class="difflineplus">+  seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l38.698"></a><span id="l38.698" class="difflineplus">+</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineplus">+  // Debugging, see bug 1116055.</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineplus">+  int64_t first_post_seek_pos;</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineplus">+  nsresult rv4 = seekableOutStream-&gt;Tell(&amp;first_post_seek_pos);</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineplus">+  if (NS_SUCCEEDED(rv3) &amp;&amp; NS_SUCCEEDED(rv4)) {</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineplus">+    if (first_pre_seek_pos != first_post_seek_pos) {</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineplus">+      nsString folderName;</span>
<a href="#l38.706"></a><span id="l38.706" class="difflineplus">+      if (m_folder) m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineplus">+      if (!folderName.IsEmpty()) {</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineplus">+        fprintf(stderr,</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineplus">+                &quot;(seekdebug) Seek was necessary in IncorporateBegin() for &quot;</span>
<a href="#l38.710"></a><span id="l38.710" class="difflineplus">+                &quot;folder %s.\n&quot;,</span>
<a href="#l38.711"></a><span id="l38.711" class="difflineplus">+                NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineplus">+      } else {</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineplus">+        fprintf(stderr,</span>
<a href="#l38.714"></a><span id="l38.714" class="difflineplus">+                &quot;(seekdebug) Seek was necessary in IncorporateBegin().\n&quot;);</span>
<a href="#l38.715"></a><span id="l38.715" class="difflineplus">+      }</span>
<a href="#l38.716"></a><span id="l38.716" class="difflineplus">+      fprintf(stderr,</span>
<a href="#l38.717"></a><span id="l38.717" class="difflineplus">+              &quot;(seekdebug) first_pre_seek_pos = 0x%016llx, &quot;</span>
<a href="#l38.718"></a><span id="l38.718" class="difflineplus">+              &quot;first_post_seek_pos=0x%016llx\n&quot;,</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineplus">+              (unsigned long long)first_pre_seek_pos,</span>
<a href="#l38.720"></a><span id="l38.720" class="difflineplus">+              (unsigned long long)first_post_seek_pos);</span>
<a href="#l38.721"></a><span id="l38.721" class="difflineplus">+    }</span>
<a href="#l38.722"></a><span id="l38.722" class="difflineplus">+  }</span>
<a href="#l38.723"></a><span id="l38.723" class="difflineplus">+#endif</span>
<a href="#l38.724"></a><span id="l38.724" class="difflineplus">+</span>
<a href="#l38.725"></a><span id="l38.725" class="difflineplus">+  nsCString outputString(GetDummyEnvelope());</span>
<a href="#l38.726"></a><span id="l38.726" class="difflineplus">+  rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.727"></a><span id="l38.727" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.728"></a><span id="l38.728" class="difflineplus">+  // Write out account-key before UIDL so the code that looks for</span>
<a href="#l38.729"></a><span id="l38.729" class="difflineplus">+  // UIDL will find the account first and know it can stop looking</span>
<a href="#l38.730"></a><span id="l38.730" class="difflineplus">+  // once it finds the UIDL line.</span>
<a href="#l38.731"></a><span id="l38.731" class="difflineplus">+  if (!m_accountKey.IsEmpty()) {</span>
<a href="#l38.732"></a><span id="l38.732" class="difflineplus">+    outputString.AssignLiteral(HEADER_X_MOZILLA_ACCOUNT_KEY &quot;: &quot;);</span>
<a href="#l38.733"></a><span id="l38.733" class="difflineplus">+    outputString.Append(m_accountKey);</span>
<a href="#l38.734"></a><span id="l38.734" class="difflineplus">+    outputString.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l38.735"></a><span id="l38.735">     rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.736"></a><span id="l38.736">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.737"></a><span id="l38.737" class="difflineminus">-    // Write out account-key before UIDL so the code that looks for</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineminus">-    // UIDL will find the account first and know it can stop looking</span>
<a href="#l38.739"></a><span id="l38.739" class="difflineminus">-    // once it finds the UIDL line.</span>
<a href="#l38.740"></a><span id="l38.740" class="difflineminus">-    if (!m_accountKey.IsEmpty())</span>
<a href="#l38.741"></a><span id="l38.741" class="difflineminus">-    {</span>
<a href="#l38.742"></a><span id="l38.742" class="difflineminus">-      outputString.AssignLiteral(HEADER_X_MOZILLA_ACCOUNT_KEY &quot;: &quot;);</span>
<a href="#l38.743"></a><span id="l38.743" class="difflineminus">-      outputString.Append(m_accountKey);</span>
<a href="#l38.744"></a><span id="l38.744" class="difflineminus">-      outputString.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l38.745"></a><span id="l38.745" class="difflineminus">-      rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.746"></a><span id="l38.746" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.747"></a><span id="l38.747" class="difflineminus">-    }</span>
<a href="#l38.748"></a><span id="l38.748" class="difflineminus">-    if (uidlString)</span>
<a href="#l38.749"></a><span id="l38.749" class="difflineminus">-    {</span>
<a href="#l38.750"></a><span id="l38.750" class="difflineminus">-      outputString.AssignLiteral(&quot;X-UIDL: &quot;);</span>
<a href="#l38.751"></a><span id="l38.751" class="difflineminus">-      outputString.Append(uidlString);</span>
<a href="#l38.752"></a><span id="l38.752" class="difflineminus">-      outputString.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l38.753"></a><span id="l38.753" class="difflineminus">-      rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.754"></a><span id="l38.754" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.755"></a><span id="l38.755" class="difflineminus">-    }</span>
<a href="#l38.756"></a><span id="l38.756" class="difflineplus">+  }</span>
<a href="#l38.757"></a><span id="l38.757" class="difflineplus">+  if (uidlString) {</span>
<a href="#l38.758"></a><span id="l38.758" class="difflineplus">+    outputString.AssignLiteral(&quot;X-UIDL: &quot;);</span>
<a href="#l38.759"></a><span id="l38.759" class="difflineplus">+    outputString.Append(uidlString);</span>
<a href="#l38.760"></a><span id="l38.760" class="difflineplus">+    outputString.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l38.761"></a><span id="l38.761" class="difflineplus">+    rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.762"></a><span id="l38.762" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineplus">+  }</span>
<a href="#l38.764"></a><span id="l38.764"> </span>
<a href="#l38.765"></a><span id="l38.765" class="difflineminus">-    // WriteLineToMailbox(&quot;X-Mozilla-Status: 8000&quot; MSG_LINEBREAK);</span>
<a href="#l38.766"></a><span id="l38.766" class="difflineminus">-    char *statusLine = PR_smprintf(X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, flags);</span>
<a href="#l38.767"></a><span id="l38.767" class="difflineminus">-    outputString.Assign(statusLine);</span>
<a href="#l38.768"></a><span id="l38.768" class="difflineminus">-    rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.769"></a><span id="l38.769" class="difflineminus">-    PR_smprintf_free(statusLine);</span>
<a href="#l38.770"></a><span id="l38.770" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.771"></a><span id="l38.771" class="difflineplus">+  // WriteLineToMailbox(&quot;X-Mozilla-Status: 8000&quot; MSG_LINEBREAK);</span>
<a href="#l38.772"></a><span id="l38.772" class="difflineplus">+  char *statusLine = PR_smprintf(X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, flags);</span>
<a href="#l38.773"></a><span id="l38.773" class="difflineplus">+  outputString.Assign(statusLine);</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineplus">+  rv = WriteLineToMailbox(outputString);</span>
<a href="#l38.775"></a><span id="l38.775" class="difflineplus">+  PR_smprintf_free(statusLine);</span>
<a href="#l38.776"></a><span id="l38.776" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.777"></a><span id="l38.777"> </span>
<a href="#l38.778"></a><span id="l38.778" class="difflineminus">-    rv = WriteLineToMailbox(NS_LITERAL_CSTRING(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK));</span>
<a href="#l38.779"></a><span id="l38.779" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.780"></a><span id="l38.780" class="difflineplus">+  rv = WriteLineToMailbox(</span>
<a href="#l38.781"></a><span id="l38.781" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK));</span>
<a href="#l38.782"></a><span id="l38.782" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.783"></a><span id="l38.783"> </span>
<a href="#l38.784"></a><span id="l38.784" class="difflineminus">-    // leave space for 60 bytes worth of keys/tags</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineminus">-    rv = WriteLineToMailbox(NS_LITERAL_CSTRING(X_MOZILLA_KEYWORDS));</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineplus">+  // leave space for 60 bytes worth of keys/tags</span>
<a href="#l38.788"></a><span id="l38.788" class="difflineplus">+  rv = WriteLineToMailbox(NS_LITERAL_CSTRING(X_MOZILLA_KEYWORDS));</span>
<a href="#l38.789"></a><span id="l38.789" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.790"></a><span id="l38.790"> }</span>
<a href="#l38.791"></a><span id="l38.791"> </span>
<a href="#l38.792"></a><span id="l38.792"> NS_IMETHODIMP</span>
<a href="#l38.793"></a><span id="l38.793" class="difflineminus">-nsPop3Sink::SetPopServer(nsIPop3IncomingServer *server)</span>
<a href="#l38.794"></a><span id="l38.794" class="difflineminus">-{</span>
<a href="#l38.795"></a><span id="l38.795" class="difflineplus">+nsPop3Sink::SetPopServer(nsIPop3IncomingServer *server) {</span>
<a href="#l38.796"></a><span id="l38.796">   m_popServer = server;</span>
<a href="#l38.797"></a><span id="l38.797">   return NS_OK;</span>
<a href="#l38.798"></a><span id="l38.798"> }</span>
<a href="#l38.799"></a><span id="l38.799"> </span>
<a href="#l38.800"></a><span id="l38.800"> NS_IMETHODIMP</span>
<a href="#l38.801"></a><span id="l38.801" class="difflineminus">-nsPop3Sink::GetPopServer(nsIPop3IncomingServer **aServer)</span>
<a href="#l38.802"></a><span id="l38.802" class="difflineminus">-{</span>
<a href="#l38.803"></a><span id="l38.803" class="difflineplus">+nsPop3Sink::GetPopServer(nsIPop3IncomingServer **aServer) {</span>
<a href="#l38.804"></a><span id="l38.804">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l38.805"></a><span id="l38.805">   NS_IF_ADDREF(*aServer = m_popServer);</span>
<a href="#l38.806"></a><span id="l38.806">   return NS_OK;</span>
<a href="#l38.807"></a><span id="l38.807"> }</span>
<a href="#l38.808"></a><span id="l38.808"> </span>
<a href="#l38.809"></a><span id="l38.809" class="difflineminus">-NS_IMETHODIMP nsPop3Sink::GetFolder(nsIMsgFolder **aFolder)</span>
<a href="#l38.810"></a><span id="l38.810" class="difflineminus">-{</span>
<a href="#l38.811"></a><span id="l38.811" class="difflineplus">+NS_IMETHODIMP nsPop3Sink::GetFolder(nsIMsgFolder **aFolder) {</span>
<a href="#l38.812"></a><span id="l38.812">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l38.813"></a><span id="l38.813">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l38.814"></a><span id="l38.814">   return NS_OK;</span>
<a href="#l38.815"></a><span id="l38.815"> }</span>
<a href="#l38.816"></a><span id="l38.816"> </span>
<a href="#l38.817"></a><span id="l38.817" class="difflineminus">-NS_IMETHODIMP nsPop3Sink::SetFolder(nsIMsgFolder * aFolder)</span>
<a href="#l38.818"></a><span id="l38.818" class="difflineminus">-{</span>
<a href="#l38.819"></a><span id="l38.819" class="difflineplus">+NS_IMETHODIMP nsPop3Sink::SetFolder(nsIMsgFolder *aFolder) {</span>
<a href="#l38.820"></a><span id="l38.820">   m_folder = aFolder;</span>
<a href="#l38.821"></a><span id="l38.821">   return NS_OK;</span>
<a href="#l38.822"></a><span id="l38.822"> }</span>
<a href="#l38.823"></a><span id="l38.823"> </span>
<a href="#l38.824"></a><span id="l38.824" class="difflineminus">-nsresult</span>
<a href="#l38.825"></a><span id="l38.825" class="difflineminus">-nsPop3Sink::GetServerFolder(nsIMsgFolder **aFolder)</span>
<a href="#l38.826"></a><span id="l38.826" class="difflineminus">-{</span>
<a href="#l38.827"></a><span id="l38.827" class="difflineplus">+nsresult nsPop3Sink::GetServerFolder(nsIMsgFolder **aFolder) {</span>
<a href="#l38.828"></a><span id="l38.828">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l38.829"></a><span id="l38.829"> </span>
<a href="#l38.830"></a><span id="l38.830" class="difflineminus">-  if (m_popServer)</span>
<a href="#l38.831"></a><span id="l38.831" class="difflineminus">-  {</span>
<a href="#l38.832"></a><span id="l38.832" class="difflineminus">-    // not sure what this is used for - might be wrong if we have a deferred account.</span>
<a href="#l38.833"></a><span id="l38.833" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer = do_QueryInterface(m_popServer);</span>
<a href="#l38.834"></a><span id="l38.834" class="difflineminus">-    if (incomingServer)</span>
<a href="#l38.835"></a><span id="l38.835" class="difflineminus">-      return incomingServer-&gt;GetRootFolder(aFolder);</span>
<a href="#l38.836"></a><span id="l38.836" class="difflineplus">+  if (m_popServer) {</span>
<a href="#l38.837"></a><span id="l38.837" class="difflineplus">+    // not sure what this is used for - might be wrong if we have a deferred</span>
<a href="#l38.838"></a><span id="l38.838" class="difflineplus">+    // account.</span>
<a href="#l38.839"></a><span id="l38.839" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer =</span>
<a href="#l38.840"></a><span id="l38.840" class="difflineplus">+        do_QueryInterface(m_popServer);</span>
<a href="#l38.841"></a><span id="l38.841" class="difflineplus">+    if (incomingServer) return incomingServer-&gt;GetRootFolder(aFolder);</span>
<a href="#l38.842"></a><span id="l38.842">   }</span>
<a href="#l38.843"></a><span id="l38.843">   *aFolder = nullptr;</span>
<a href="#l38.844"></a><span id="l38.844">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l38.845"></a><span id="l38.845"> }</span>
<a href="#l38.846"></a><span id="l38.846"> </span>
<a href="#l38.847"></a><span id="l38.847" class="difflineminus">-NS_IMETHODIMP nsPop3Sink::SetMsgsToDownload(uint32_t aNumMessages)</span>
<a href="#l38.848"></a><span id="l38.848" class="difflineminus">-{</span>
<a href="#l38.849"></a><span id="l38.849" class="difflineplus">+NS_IMETHODIMP nsPop3Sink::SetMsgsToDownload(uint32_t aNumMessages) {</span>
<a href="#l38.850"></a><span id="l38.850">   m_numNewMessages = aNumMessages;</span>
<a href="#l38.851"></a><span id="l38.851">   return NS_OK;</span>
<a href="#l38.852"></a><span id="l38.852"> }</span>
<a href="#l38.853"></a><span id="l38.853"> </span>
<a href="#l38.854"></a><span id="l38.854" class="difflineminus">-char*</span>
<a href="#l38.855"></a><span id="l38.855" class="difflineminus">-nsPop3Sink::GetDummyEnvelope(void)</span>
<a href="#l38.856"></a><span id="l38.856" class="difflineminus">-{</span>
<a href="#l38.857"></a><span id="l38.857" class="difflineplus">+char *nsPop3Sink::GetDummyEnvelope(void) {</span>
<a href="#l38.858"></a><span id="l38.858">   static char result[75];</span>
<a href="#l38.859"></a><span id="l38.859">   char *ct;</span>
<a href="#l38.860"></a><span id="l38.860" class="difflineminus">-  time_t now = time ((time_t *) 0);</span>
<a href="#l38.861"></a><span id="l38.861" class="difflineminus">-#if defined (XP_WIN)</span>
<a href="#l38.862"></a><span id="l38.862" class="difflineminus">-  if (now &lt; 0 || now &gt; 0x7FFFFFFF)</span>
<a href="#l38.863"></a><span id="l38.863" class="difflineminus">-    now = 0x7FFFFFFF;</span>
<a href="#l38.864"></a><span id="l38.864" class="difflineplus">+  time_t now = time((time_t *)0);</span>
<a href="#l38.865"></a><span id="l38.865" class="difflineplus">+#if defined(XP_WIN)</span>
<a href="#l38.866"></a><span id="l38.866" class="difflineplus">+  if (now &lt; 0 || now &gt; 0x7FFFFFFF) now = 0x7FFFFFFF;</span>
<a href="#l38.867"></a><span id="l38.867"> #endif</span>
<a href="#l38.868"></a><span id="l38.868">   ct = ctime(&amp;now);</span>
<a href="#l38.869"></a><span id="l38.869">   PR_ASSERT(ct[24] == '\r' || ct[24] == '\n');</span>
<a href="#l38.870"></a><span id="l38.870">   ct[24] = 0;</span>
<a href="#l38.871"></a><span id="l38.871">   /* This value must be in ctime() format, with English abbreviations.</span>
<a href="#l38.872"></a><span id="l38.872">    strftime(&quot;... %c ...&quot;) is no good, because it is localized. */</span>
<a href="#l38.873"></a><span id="l38.873">   PL_strcpy(result, &quot;From - &quot;);</span>
<a href="#l38.874"></a><span id="l38.874">   PL_strcpy(result + 7, ct);</span>
<a href="#l38.875"></a><span id="l38.875">   PL_strcpy(result + 7 + 24, MSG_LINEBREAK);</span>
<a href="#l38.876"></a><span id="l38.876">   return result;</span>
<a href="#l38.877"></a><span id="l38.877"> }</span>
<a href="#l38.878"></a><span id="l38.878"> </span>
<a href="#l38.879"></a><span id="l38.879" class="difflineminus">-nsresult</span>
<a href="#l38.880"></a><span id="l38.880" class="difflineminus">-nsPop3Sink::IncorporateWrite(const char* block,</span>
<a href="#l38.881"></a><span id="l38.881" class="difflineminus">-                             int32_t length)</span>
<a href="#l38.882"></a><span id="l38.882" class="difflineminus">-{</span>
<a href="#l38.883"></a><span id="l38.883" class="difflineplus">+nsresult nsPop3Sink::IncorporateWrite(const char *block, int32_t length) {</span>
<a href="#l38.884"></a><span id="l38.884">   m_outputBuffer.Truncate();</span>
<a href="#l38.885"></a><span id="l38.885" class="difflineminus">-  if (!strncmp(block, &quot;From &quot;, 5))</span>
<a href="#l38.886"></a><span id="l38.886" class="difflineminus">-    m_outputBuffer.Assign('&gt;');</span>
<a href="#l38.887"></a><span id="l38.887" class="difflineplus">+  if (!strncmp(block, &quot;From &quot;, 5)) m_outputBuffer.Assign('&gt;');</span>
<a href="#l38.888"></a><span id="l38.888"> </span>
<a href="#l38.889"></a><span id="l38.889">   m_outputBuffer.Append(block);</span>
<a href="#l38.890"></a><span id="l38.890"> </span>
<a href="#l38.891"></a><span id="l38.891">   return WriteLineToMailbox(m_outputBuffer);</span>
<a href="#l38.892"></a><span id="l38.892"> }</span>
<a href="#l38.893"></a><span id="l38.893"> </span>
<a href="#l38.894"></a><span id="l38.894" class="difflineminus">-nsresult nsPop3Sink::WriteLineToMailbox(const nsACString&amp; buffer)</span>
<a href="#l38.895"></a><span id="l38.895" class="difflineminus">-{</span>
<a href="#l38.896"></a><span id="l38.896" class="difflineminus">-  if (!buffer.IsEmpty())</span>
<a href="#l38.897"></a><span id="l38.897" class="difflineminus">-  {</span>
<a href="#l38.898"></a><span id="l38.898" class="difflineplus">+nsresult nsPop3Sink::WriteLineToMailbox(const nsACString &amp;buffer) {</span>
<a href="#l38.899"></a><span id="l38.899" class="difflineplus">+  if (!buffer.IsEmpty()) {</span>
<a href="#l38.900"></a><span id="l38.900">     uint32_t bufferLen = buffer.Length();</span>
<a href="#l38.901"></a><span id="l38.901">     if (m_newMailParser)</span>
<a href="#l38.902"></a><span id="l38.902">       m_newMailParser-&gt;HandleLine(buffer.BeginReading(), bufferLen);</span>
<a href="#l38.903"></a><span id="l38.903" class="difflineminus">-    // The following (!m_outFileStream etc) was added to make sure that we don't write somewhere</span>
<a href="#l38.904"></a><span id="l38.904" class="difflineminus">-    // where for some reason or another we can't write to and lose the messages</span>
<a href="#l38.905"></a><span id="l38.905" class="difflineminus">-    // See bug 62480</span>
<a href="#l38.906"></a><span id="l38.906" class="difflineplus">+    // The following (!m_outFileStream etc) was added to make sure that we don't</span>
<a href="#l38.907"></a><span id="l38.907" class="difflineplus">+    // write somewhere where for some reason or another we can't write to and</span>
<a href="#l38.908"></a><span id="l38.908" class="difflineplus">+    // lose the messages See bug 62480</span>
<a href="#l38.909"></a><span id="l38.909">     NS_ENSURE_TRUE(m_outFileStream, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l38.910"></a><span id="l38.910"> </span>
<a href="#l38.911"></a><span id="l38.911">     // To remove seeking to the end for each line to be written, remove the</span>
<a href="#l38.912"></a><span id="l38.912">     // following line. See bug 1116055 for details.</span>
<a href="#l38.913"></a><span id="l38.913"> #define SEEK_TO_END</span>
<a href="#l38.914"></a><span id="l38.914" class="difflineminus">-#ifdef  SEEK_TO_END</span>
<a href="#l38.915"></a><span id="l38.915" class="difflineplus">+#ifdef SEEK_TO_END</span>
<a href="#l38.916"></a><span id="l38.916">     // seek to the end in case someone else has sought elsewhere in our stream.</span>
<a href="#l38.917"></a><span id="l38.917" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableOutStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l38.918"></a><span id="l38.918" class="difflineplus">+    nsCOMPtr&lt;nsISeekableStream&gt; seekableOutStream =</span>
<a href="#l38.919"></a><span id="l38.919" class="difflineplus">+        do_QueryInterface(m_outFileStream);</span>
<a href="#l38.920"></a><span id="l38.920"> </span>
<a href="#l38.921"></a><span id="l38.921">     int64_t before_seek_pos;</span>
<a href="#l38.922"></a><span id="l38.922">     nsresult rv2 = seekableOutStream-&gt;Tell(&amp;before_seek_pos);</span>
<a href="#l38.923"></a><span id="l38.923" class="difflineminus">-    MOZ_ASSERT(NS_SUCCEEDED(rv2), &quot;seekableOutStream-&gt;Tell(&amp;before_seek_pos) failed&quot;);</span>
<a href="#l38.924"></a><span id="l38.924" class="difflineplus">+    MOZ_ASSERT(NS_SUCCEEDED(rv2),</span>
<a href="#l38.925"></a><span id="l38.925" class="difflineplus">+               &quot;seekableOutStream-&gt;Tell(&amp;before_seek_pos) failed&quot;);</span>
<a href="#l38.926"></a><span id="l38.926"> </span>
<a href="#l38.927"></a><span id="l38.927">     // XXX Handle error such as network error for remote file system.</span>
<a href="#l38.928"></a><span id="l38.928">     seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l38.929"></a><span id="l38.929"> </span>
<a href="#l38.930"></a><span id="l38.930">     int64_t after_seek_pos;</span>
<a href="#l38.931"></a><span id="l38.931">     nsresult rv3 = seekableOutStream-&gt;Tell(&amp;after_seek_pos);</span>
<a href="#l38.932"></a><span id="l38.932" class="difflineminus">-    MOZ_ASSERT(NS_SUCCEEDED(rv3), &quot;seekableOutStream-&gt;Tell(&amp;after_seek_pos) failed&quot;);</span>
<a href="#l38.933"></a><span id="l38.933" class="difflineplus">+    MOZ_ASSERT(NS_SUCCEEDED(rv3),</span>
<a href="#l38.934"></a><span id="l38.934" class="difflineplus">+               &quot;seekableOutStream-&gt;Tell(&amp;after_seek_pos) failed&quot;);</span>
<a href="#l38.935"></a><span id="l38.935"> </span>
<a href="#l38.936"></a><span id="l38.936">     if (NS_SUCCEEDED(rv2) &amp;&amp; NS_SUCCEEDED(rv3)) {</span>
<a href="#l38.937"></a><span id="l38.937">       if (before_seek_pos != after_seek_pos) {</span>
<a href="#l38.938"></a><span id="l38.938">         nsString folderName;</span>
<a href="#l38.939"></a><span id="l38.939" class="difflineminus">-        if (m_folder)</span>
<a href="#l38.940"></a><span id="l38.940" class="difflineminus">-          m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.941"></a><span id="l38.941" class="difflineplus">+        if (m_folder) m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.942"></a><span id="l38.942">         // This merits a console message, it's poor man's telemetry.</span>
<a href="#l38.943"></a><span id="l38.943">         MsgLogToConsole4(</span>
<a href="#l38.944"></a><span id="l38.944" class="difflineminus">-          NS_LITERAL_STRING(&quot;Unexpected file position change detected&quot;) +</span>
<a href="#l38.945"></a><span id="l38.945" class="difflineminus">-          (folderName.IsEmpty() ? EmptyString() : NS_LITERAL_STRING(&quot; in folder &quot;)) +</span>
<a href="#l38.946"></a><span id="l38.946" class="difflineminus">-          (folderName.IsEmpty() ? EmptyString() : folderName) + NS_LITERAL_STRING(&quot;. &quot;</span>
<a href="#l38.947"></a><span id="l38.947" class="difflineminus">-          &quot;If you can reliably reproduce this, please report the steps &quot;</span>
<a href="#l38.948"></a><span id="l38.948" class="difflineminus">-          &quot;you used to dev-apps-thunderbird@lists.mozilla.org or to bug 1308335 at bugzilla.mozilla.org. &quot;</span>
<a href="#l38.949"></a><span id="l38.949" class="difflineminus">-          &quot;Resolving this problem will allow speeding up message downloads.&quot;),</span>
<a href="#l38.950"></a><span id="l38.950" class="difflineminus">-          NS_LITERAL_STRING(__FILE__), __LINE__, nsIScriptError::errorFlag);</span>
<a href="#l38.951"></a><span id="l38.951" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l38.952"></a><span id="l38.952" class="difflineplus">+            NS_LITERAL_STRING(&quot;Unexpected file position change detected&quot;) +</span>
<a href="#l38.953"></a><span id="l38.953" class="difflineplus">+                (folderName.IsEmpty() ? EmptyString()</span>
<a href="#l38.954"></a><span id="l38.954" class="difflineplus">+                                      : NS_LITERAL_STRING(&quot; in folder &quot;)) +</span>
<a href="#l38.955"></a><span id="l38.955" class="difflineplus">+                (folderName.IsEmpty() ? EmptyString() : folderName) +</span>
<a href="#l38.956"></a><span id="l38.956" class="difflineplus">+                NS_LITERAL_STRING(</span>
<a href="#l38.957"></a><span id="l38.957" class="difflineplus">+                    &quot;. &quot;</span>
<a href="#l38.958"></a><span id="l38.958" class="difflineplus">+                    &quot;If you can reliably reproduce this, please report the &quot;</span>
<a href="#l38.959"></a><span id="l38.959" class="difflineplus">+                    &quot;steps &quot;</span>
<a href="#l38.960"></a><span id="l38.960" class="difflineplus">+                    &quot;you used to dev-apps-thunderbird@lists.mozilla.org or to &quot;</span>
<a href="#l38.961"></a><span id="l38.961" class="difflineplus">+                    &quot;bug 1308335 at bugzilla.mozilla.org. &quot;</span>
<a href="#l38.962"></a><span id="l38.962" class="difflineplus">+                    &quot;Resolving this problem will allow speeding up message &quot;</span>
<a href="#l38.963"></a><span id="l38.963" class="difflineplus">+                    &quot;downloads.&quot;),</span>
<a href="#l38.964"></a><span id="l38.964" class="difflineplus">+            NS_LITERAL_STRING(__FILE__), __LINE__, nsIScriptError::errorFlag);</span>
<a href="#l38.965"></a><span id="l38.965" class="difflineplus">+#  ifdef DEBUG</span>
<a href="#l38.966"></a><span id="l38.966">         // Debugging, see bug 1116055.</span>
<a href="#l38.967"></a><span id="l38.967">         if (!folderName.IsEmpty()) {</span>
<a href="#l38.968"></a><span id="l38.968" class="difflineminus">-          fprintf(stderr,&quot;(seekdebug) WriteLineToMailbox() detected an unexpected file position change in folder %s.\n&quot;,</span>
<a href="#l38.969"></a><span id="l38.969" class="difflineplus">+          fprintf(stderr,</span>
<a href="#l38.970"></a><span id="l38.970" class="difflineplus">+                  &quot;(seekdebug) WriteLineToMailbox() detected an unexpected &quot;</span>
<a href="#l38.971"></a><span id="l38.971" class="difflineplus">+                  &quot;file position change in folder %s.\n&quot;,</span>
<a href="#l38.972"></a><span id="l38.972">                   NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l38.973"></a><span id="l38.973">         } else {</span>
<a href="#l38.974"></a><span id="l38.974" class="difflineminus">-          fprintf(stderr,&quot;(seekdebug) WriteLineToMailbox() detected an unexpected file position change.\n&quot;);</span>
<a href="#l38.975"></a><span id="l38.975" class="difflineplus">+          fprintf(stderr,</span>
<a href="#l38.976"></a><span id="l38.976" class="difflineplus">+                  &quot;(seekdebug) WriteLineToMailbox() detected an unexpected &quot;</span>
<a href="#l38.977"></a><span id="l38.977" class="difflineplus">+                  &quot;file position change.\n&quot;);</span>
<a href="#l38.978"></a><span id="l38.978">         }</span>
<a href="#l38.979"></a><span id="l38.979" class="difflineminus">-        fprintf(stderr,&quot;(seekdebug) before_seek_pos=0x%016llx, after_seek_pos=0x%016llx\n&quot;,</span>
<a href="#l38.980"></a><span id="l38.980" class="difflineminus">-                (long long unsigned int) before_seek_pos, (long long unsigned int) after_seek_pos);</span>
<a href="#l38.981"></a><span id="l38.981" class="difflineminus">-#endif</span>
<a href="#l38.982"></a><span id="l38.982" class="difflineplus">+        fprintf(</span>
<a href="#l38.983"></a><span id="l38.983" class="difflineplus">+            stderr,</span>
<a href="#l38.984"></a><span id="l38.984" class="difflineplus">+            &quot;(seekdebug) before_seek_pos=0x%016llx, after_seek_pos=0x%016llx\n&quot;,</span>
<a href="#l38.985"></a><span id="l38.985" class="difflineplus">+            (long long unsigned int)before_seek_pos,</span>
<a href="#l38.986"></a><span id="l38.986" class="difflineplus">+            (long long unsigned int)after_seek_pos);</span>
<a href="#l38.987"></a><span id="l38.987" class="difflineplus">+#  endif</span>
<a href="#l38.988"></a><span id="l38.988">       }</span>
<a href="#l38.989"></a><span id="l38.989">     }</span>
<a href="#l38.990"></a><span id="l38.990"> #endif</span>
<a href="#l38.991"></a><span id="l38.991"> </span>
<a href="#l38.992"></a><span id="l38.992">     uint32_t bytesWritten;</span>
<a href="#l38.993"></a><span id="l38.993">     m_outFileStream-&gt;Write(buffer.BeginReading(), bufferLen, &amp;bytesWritten);</span>
<a href="#l38.994"></a><span id="l38.994">     NS_ENSURE_TRUE(bytesWritten == bufferLen, NS_ERROR_FAILURE);</span>
<a href="#l38.995"></a><span id="l38.995">   }</span>
<a href="#l38.996"></a><span id="l38.996">   return NS_OK;</span>
<a href="#l38.997"></a><span id="l38.997"> }</span>
<a href="#l38.998"></a><span id="l38.998"> </span>
<a href="#l38.999"></a><span id="l38.999" class="difflineminus">-nsresult nsPop3Sink::HandleTempDownloadFailed(nsIMsgWindow *msgWindow)</span>
<a href="#l38.1000"></a><span id="l38.1000" class="difflineminus">-{</span>
<a href="#l38.1001"></a><span id="l38.1001" class="difflineplus">+nsresult nsPop3Sink::HandleTempDownloadFailed(nsIMsgWindow *msgWindow) {</span>
<a href="#l38.1002"></a><span id="l38.1002">   nsresult rv;</span>
<a href="#l38.1003"></a><span id="l38.1003">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l38.1004"></a><span id="l38.1004" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l38.1005"></a><span id="l38.1005" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l38.1006"></a><span id="l38.1006">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l38.1007"></a><span id="l38.1007">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l38.1008"></a><span id="l38.1008" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l38.1009"></a><span id="l38.1009" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l38.1010"></a><span id="l38.1010" class="difflineplus">+      &quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l38.1011"></a><span id="l38.1011">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1012"></a><span id="l38.1012">   nsString fromStr, subjectStr, confirmString;</span>
<a href="#l38.1013"></a><span id="l38.1013"> </span>
<a href="#l38.1014"></a><span id="l38.1014">   m_newMailParser-&gt;m_newMsgHdr-&gt;GetMime2DecodedSubject(subjectStr);</span>
<a href="#l38.1015"></a><span id="l38.1015">   m_newMailParser-&gt;m_newMsgHdr-&gt;GetMime2DecodedAuthor(fromStr);</span>
<a href="#l38.1016"></a><span id="l38.1016" class="difflineminus">-  const char16_t *params[] = { fromStr.get(), subjectStr.get() };</span>
<a href="#l38.1017"></a><span id="l38.1017" class="difflineminus">-  bundle-&gt;FormatStringFromName(</span>
<a href="#l38.1018"></a><span id="l38.1018" class="difflineminus">-    &quot;pop3TmpDownloadError&quot;,</span>
<a href="#l38.1019"></a><span id="l38.1019" class="difflineminus">-    params, 2, confirmString);</span>
<a href="#l38.1020"></a><span id="l38.1020" class="difflineplus">+  const char16_t *params[] = {fromStr.get(), subjectStr.get()};</span>
<a href="#l38.1021"></a><span id="l38.1021" class="difflineplus">+  bundle-&gt;FormatStringFromName(&quot;pop3TmpDownloadError&quot;, params, 2,</span>
<a href="#l38.1022"></a><span id="l38.1022" class="difflineplus">+                               confirmString);</span>
<a href="#l38.1023"></a><span id="l38.1023">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; parentWindow;</span>
<a href="#l38.1024"></a><span id="l38.1024" class="difflineminus">-  nsCOMPtr&lt;nsIPromptService&gt; promptService = do_GetService(NS_PROMPTSERVICE_CONTRACTID);</span>
<a href="#l38.1025"></a><span id="l38.1025" class="difflineplus">+  nsCOMPtr&lt;nsIPromptService&gt; promptService =</span>
<a href="#l38.1026"></a><span id="l38.1026" class="difflineplus">+      do_GetService(NS_PROMPTSERVICE_CONTRACTID);</span>
<a href="#l38.1027"></a><span id="l38.1027">   nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l38.1028"></a><span id="l38.1028" class="difflineminus">-  if (msgWindow)</span>
<a href="#l38.1029"></a><span id="l38.1029" class="difflineminus">-  {</span>
<a href="#l38.1030"></a><span id="l38.1030" class="difflineminus">-    (void) msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l38.1031"></a><span id="l38.1031" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l38.1032"></a><span id="l38.1032" class="difflineplus">+    (void)msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l38.1033"></a><span id="l38.1033">     parentWindow = do_QueryInterface(docShell);</span>
<a href="#l38.1034"></a><span id="l38.1034">   }</span>
<a href="#l38.1035"></a><span id="l38.1035" class="difflineminus">-  if (promptService &amp;&amp; !confirmString.IsEmpty())</span>
<a href="#l38.1036"></a><span id="l38.1036" class="difflineminus">-  {</span>
<a href="#l38.1037"></a><span id="l38.1037" class="difflineminus">-    int32_t dlgResult  = -1;</span>
<a href="#l38.1038"></a><span id="l38.1038" class="difflineplus">+  if (promptService &amp;&amp; !confirmString.IsEmpty()) {</span>
<a href="#l38.1039"></a><span id="l38.1039" class="difflineplus">+    int32_t dlgResult = -1;</span>
<a href="#l38.1040"></a><span id="l38.1040">     bool dummyValue = false;</span>
<a href="#l38.1041"></a><span id="l38.1041">     rv = promptService-&gt;ConfirmEx(parentWindow, nullptr, confirmString.get(),</span>
<a href="#l38.1042"></a><span id="l38.1042" class="difflineminus">-                      nsIPromptService::STD_YES_NO_BUTTONS,</span>
<a href="#l38.1043"></a><span id="l38.1043" class="difflineminus">-                      nullptr,</span>
<a href="#l38.1044"></a><span id="l38.1044" class="difflineminus">-                      nullptr,</span>
<a href="#l38.1045"></a><span id="l38.1045" class="difflineminus">-                      nullptr,</span>
<a href="#l38.1046"></a><span id="l38.1046" class="difflineminus">-                      nullptr,</span>
<a href="#l38.1047"></a><span id="l38.1047" class="difflineminus">-                      &amp;dummyValue,</span>
<a href="#l38.1048"></a><span id="l38.1048" class="difflineminus">-                      &amp;dlgResult);</span>
<a href="#l38.1049"></a><span id="l38.1049" class="difflineplus">+                                  nsIPromptService::STD_YES_NO_BUTTONS, nullptr,</span>
<a href="#l38.1050"></a><span id="l38.1050" class="difflineplus">+                                  nullptr, nullptr, nullptr, &amp;dummyValue,</span>
<a href="#l38.1051"></a><span id="l38.1051" class="difflineplus">+                                  &amp;dlgResult);</span>
<a href="#l38.1052"></a><span id="l38.1052">     m_newMailParser-&gt;m_newMsgHdr = nullptr;</span>
<a href="#l38.1053"></a><span id="l38.1053"> </span>
<a href="#l38.1054"></a><span id="l38.1054">     return (dlgResult == 0) ? NS_OK : NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD;</span>
<a href="#l38.1055"></a><span id="l38.1055">   }</span>
<a href="#l38.1056"></a><span id="l38.1056">   return rv;</span>
<a href="#l38.1057"></a><span id="l38.1057"> }</span>
<a href="#l38.1058"></a><span id="l38.1058"> </span>
<a href="#l38.1059"></a><span id="l38.1059" class="difflineminus">-</span>
<a href="#l38.1060"></a><span id="l38.1060"> NS_IMETHODIMP</span>
<a href="#l38.1061"></a><span id="l38.1061" class="difflineminus">-nsPop3Sink::IncorporateComplete(nsIMsgWindow *aMsgWindow, int32_t aSize)</span>
<a href="#l38.1062"></a><span id="l38.1062" class="difflineminus">-{</span>
<a href="#l38.1063"></a><span id="l38.1063" class="difflineplus">+nsPop3Sink::IncorporateComplete(nsIMsgWindow *aMsgWindow, int32_t aSize) {</span>
<a href="#l38.1064"></a><span id="l38.1064">   if (m_buildMessageUri &amp;&amp; !m_baseMessageUri.IsEmpty() &amp;&amp; m_newMailParser &amp;&amp;</span>
<a href="#l38.1065"></a><span id="l38.1065" class="difflineminus">-      m_newMailParser-&gt;m_newMsgHdr)</span>
<a href="#l38.1066"></a><span id="l38.1066" class="difflineminus">-  {</span>
<a href="#l38.1067"></a><span id="l38.1067" class="difflineplus">+      m_newMailParser-&gt;m_newMsgHdr) {</span>
<a href="#l38.1068"></a><span id="l38.1068">     nsMsgKey msgKey;</span>
<a href="#l38.1069"></a><span id="l38.1069">     m_newMailParser-&gt;m_newMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l38.1070"></a><span id="l38.1070">     m_messageUri.Truncate();</span>
<a href="#l38.1071"></a><span id="l38.1071">     nsBuildLocalMessageURI(m_baseMessageUri.get(), msgKey, m_messageUri);</span>
<a href="#l38.1072"></a><span id="l38.1072">   }</span>
<a href="#l38.1073"></a><span id="l38.1073"> </span>
<a href="#l38.1074"></a><span id="l38.1074">   nsresult rv = WriteLineToMailbox(NS_LITERAL_CSTRING(MSG_LINEBREAK));</span>
<a href="#l38.1075"></a><span id="l38.1075">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1076"></a><span id="l38.1076">   bool leaveOnServer = false;</span>
<a href="#l38.1077"></a><span id="l38.1077">   m_popServer-&gt;GetLeaveMessagesOnServer(&amp;leaveOnServer);</span>
<a href="#l38.1078"></a><span id="l38.1078">   // We need to flush the output stream, in case mail filters move</span>
<a href="#l38.1079"></a><span id="l38.1079">   // the new message, which relies on all the data being flushed.</span>
<a href="#l38.1080"></a><span id="l38.1080" class="difflineminus">-  rv = m_outFileStream-&gt;Flush(); // Make sure the message is written to the disk</span>
<a href="#l38.1081"></a><span id="l38.1081" class="difflineplus">+  rv =</span>
<a href="#l38.1082"></a><span id="l38.1082" class="difflineplus">+      m_outFileStream-&gt;Flush();  // Make sure the message is written to the disk</span>
<a href="#l38.1083"></a><span id="l38.1083">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1084"></a><span id="l38.1084">   NS_ASSERTION(m_newMailParser, &quot;could not get m_newMailParser&quot;);</span>
<a href="#l38.1085"></a><span id="l38.1085" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l38.1086"></a><span id="l38.1086" class="difflineminus">-  {</span>
<a href="#l38.1087"></a><span id="l38.1087" class="difflineplus">+  if (m_newMailParser) {</span>
<a href="#l38.1088"></a><span id="l38.1088">     // PublishMsgHdr clears m_newMsgHdr, so we need a comptr to</span>
<a href="#l38.1089"></a><span id="l38.1089">     // hold onto it.</span>
<a href="#l38.1090"></a><span id="l38.1090">     nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr = m_newMailParser-&gt;m_newMsgHdr;</span>
<a href="#l38.1091"></a><span id="l38.1091">     NS_ASSERTION(hdr, &quot;m_newMailParser-&gt;m_newMsgHdr wasn't set&quot;);</span>
<a href="#l38.1092"></a><span id="l38.1092" class="difflineminus">-    if (!hdr)</span>
<a href="#l38.1093"></a><span id="l38.1093" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l38.1094"></a><span id="l38.1094" class="difflineplus">+    if (!hdr) return NS_ERROR_FAILURE;</span>
<a href="#l38.1095"></a><span id="l38.1095"> </span>
<a href="#l38.1096"></a><span id="l38.1096">     nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.1097"></a><span id="l38.1097">     bool doSelect = false;</span>
<a href="#l38.1098"></a><span id="l38.1098"> </span>
<a href="#l38.1099"></a><span id="l38.1099">     // aSize is only set for partial messages. For full messages,</span>
<a href="#l38.1100"></a><span id="l38.1100">     // check to see if we're replacing an old partial message.</span>
<a href="#l38.1101"></a><span id="l38.1101">     if (!aSize &amp;&amp; localFolder)</span>
<a href="#l38.1102"></a><span id="l38.1102" class="difflineminus">-      (void) localFolder-&gt;DeleteDownloadMsg(hdr, &amp;doSelect);</span>
<a href="#l38.1103"></a><span id="l38.1103" class="difflineplus">+      (void)localFolder-&gt;DeleteDownloadMsg(hdr, &amp;doSelect);</span>
<a href="#l38.1104"></a><span id="l38.1104"> </span>
<a href="#l38.1105"></a><span id="l38.1105">     // If a header already exists for this message (for example, when</span>
<a href="#l38.1106"></a><span id="l38.1106">     // getting a complete message when a partial exists), then update the new</span>
<a href="#l38.1107"></a><span id="l38.1107">     // header from the old.</span>
<a href="#l38.1108"></a><span id="l38.1108" class="difflineminus">-    if (!m_origMessageUri.IsEmpty() &amp;&amp; localFolder)</span>
<a href="#l38.1109"></a><span id="l38.1109" class="difflineminus">-    {</span>
<a href="#l38.1110"></a><span id="l38.1110" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; oldMsgHdr;</span>
<a href="#l38.1111"></a><span id="l38.1111" class="difflineminus">-      rv = GetMsgDBHdrFromURI(m_origMessageUri.get(), getter_AddRefs(oldMsgHdr));</span>
<a href="#l38.1112"></a><span id="l38.1112" class="difflineplus">+    if (!m_origMessageUri.IsEmpty() &amp;&amp; localFolder) {</span>
<a href="#l38.1113"></a><span id="l38.1113" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; oldMsgHdr;</span>
<a href="#l38.1114"></a><span id="l38.1114" class="difflineplus">+      rv =</span>
<a href="#l38.1115"></a><span id="l38.1115" class="difflineplus">+          GetMsgDBHdrFromURI(m_origMessageUri.get(), getter_AddRefs(oldMsgHdr));</span>
<a href="#l38.1116"></a><span id="l38.1116">       if (NS_SUCCEEDED(rv) &amp;&amp; oldMsgHdr)</span>
<a href="#l38.1117"></a><span id="l38.1117">         localFolder-&gt;UpdateNewMsgHdr(oldMsgHdr, hdr);</span>
<a href="#l38.1118"></a><span id="l38.1118">     }</span>
<a href="#l38.1119"></a><span id="l38.1119"> </span>
<a href="#l38.1120"></a><span id="l38.1120" class="difflineminus">-    if (m_downloadingToTempFile)</span>
<a href="#l38.1121"></a><span id="l38.1121" class="difflineminus">-    {</span>
<a href="#l38.1122"></a><span id="l38.1122" class="difflineplus">+    if (m_downloadingToTempFile) {</span>
<a href="#l38.1123"></a><span id="l38.1123">       // close file to give virus checkers a chance to do their thing...</span>
<a href="#l38.1124"></a><span id="l38.1124">       m_outFileStream-&gt;Flush();</span>
<a href="#l38.1125"></a><span id="l38.1125">       m_outFileStream-&gt;Close();</span>
<a href="#l38.1126"></a><span id="l38.1126">       m_newMailParser-&gt;FinishHeader();</span>
<a href="#l38.1127"></a><span id="l38.1127">       // need to re-open the inbox file stream.</span>
<a href="#l38.1128"></a><span id="l38.1128">       bool exists;</span>
<a href="#l38.1129"></a><span id="l38.1129">       m_tmpDownloadFile-&gt;Exists(&amp;exists);</span>
<a href="#l38.1130"></a><span id="l38.1130" class="difflineminus">-      if (!exists)</span>
<a href="#l38.1131"></a><span id="l38.1131" class="difflineminus">-        return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l38.1132"></a><span id="l38.1132" class="difflineplus">+      if (!exists) return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l38.1133"></a><span id="l38.1133"> </span>
<a href="#l38.1134"></a><span id="l38.1134" class="difflineminus">-      nsCOMPtr &lt;nsIInputStream&gt; inboxInputStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l38.1135"></a><span id="l38.1135" class="difflineplus">+      nsCOMPtr&lt;nsIInputStream&gt; inboxInputStream =</span>
<a href="#l38.1136"></a><span id="l38.1136" class="difflineplus">+          do_QueryInterface(m_outFileStream);</span>
<a href="#l38.1137"></a><span id="l38.1137">       rv = MsgReopenFileStream(m_tmpDownloadFile, inboxInputStream);</span>
<a href="#l38.1138"></a><span id="l38.1138">       NS_ENSURE_SUCCESS(rv, HandleTempDownloadFailed(aMsgWindow));</span>
<a href="#l38.1139"></a><span id="l38.1139" class="difflineminus">-      if (m_outFileStream)</span>
<a href="#l38.1140"></a><span id="l38.1140" class="difflineminus">-      {</span>
<a href="#l38.1141"></a><span id="l38.1141" class="difflineplus">+      if (m_outFileStream) {</span>
<a href="#l38.1142"></a><span id="l38.1142">         int64_t tmpDownloadFileSize;</span>
<a href="#l38.1143"></a><span id="l38.1143">         uint32_t msgSize;</span>
<a href="#l38.1144"></a><span id="l38.1144">         hdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l38.1145"></a><span id="l38.1145">         // we need to clone because nsLocalFileUnix caches its stat result,</span>
<a href="#l38.1146"></a><span id="l38.1146">         // so it doesn't realize the file has changed size.</span>
<a href="#l38.1147"></a><span id="l38.1147" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; tmpClone;</span>
<a href="#l38.1148"></a><span id="l38.1148" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; tmpClone;</span>
<a href="#l38.1149"></a><span id="l38.1149">         rv = m_tmpDownloadFile-&gt;Clone(getter_AddRefs(tmpClone));</span>
<a href="#l38.1150"></a><span id="l38.1150">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1151"></a><span id="l38.1151">         tmpClone-&gt;GetFileSize(&amp;tmpDownloadFileSize);</span>
<a href="#l38.1152"></a><span id="l38.1152"> </span>
<a href="#l38.1153"></a><span id="l38.1153">         if (msgSize &gt; tmpDownloadFileSize)</span>
<a href="#l38.1154"></a><span id="l38.1154">           rv = NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l38.1155"></a><span id="l38.1155">         else</span>
<a href="#l38.1156"></a><span id="l38.1156">           rv = m_newMailParser-&gt;AppendMsgFromStream(inboxInputStream, hdr,</span>
<a href="#l38.1157"></a><span id="l38.1157">                                                     msgSize, m_folder);</span>
<a href="#l38.1158"></a><span id="l38.1158" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l38.1159"></a><span id="l38.1159" class="difflineminus">-          return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l38.1160"></a><span id="l38.1160" class="difflineplus">+        if (NS_FAILED(rv)) return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l38.1161"></a><span id="l38.1161"> </span>
<a href="#l38.1162"></a><span id="l38.1162" class="difflineminus">-        m_outFileStream-&gt;Close(); // close so we can truncate.</span>
<a href="#l38.1163"></a><span id="l38.1163" class="difflineplus">+        m_outFileStream-&gt;Close();  // close so we can truncate.</span>
<a href="#l38.1164"></a><span id="l38.1164">         m_tmpDownloadFile-&gt;SetFileSize(0);</span>
<a href="#l38.1165"></a><span id="l38.1165" class="difflineminus">-      }</span>
<a href="#l38.1166"></a><span id="l38.1166" class="difflineminus">-      else</span>
<a href="#l38.1167"></a><span id="l38.1167" class="difflineminus">-      {</span>
<a href="#l38.1168"></a><span id="l38.1168" class="difflineminus">-          return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l38.1169"></a><span id="l38.1169" class="difflineplus">+      } else {</span>
<a href="#l38.1170"></a><span id="l38.1170" class="difflineplus">+        return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l38.1171"></a><span id="l38.1171">         // need to give an error here.</span>
<a href="#l38.1172"></a><span id="l38.1172">       }</span>
<a href="#l38.1173"></a><span id="l38.1173" class="difflineminus">-    }</span>
<a href="#l38.1174"></a><span id="l38.1174" class="difflineminus">-    else</span>
<a href="#l38.1175"></a><span id="l38.1175" class="difflineminus">-    {</span>
<a href="#l38.1176"></a><span id="l38.1176" class="difflineplus">+    } else {</span>
<a href="#l38.1177"></a><span id="l38.1177">       m_msgStore-&gt;FinishNewMessage(m_outFileStream, hdr);</span>
<a href="#l38.1178"></a><span id="l38.1178">     }</span>
<a href="#l38.1179"></a><span id="l38.1179">     m_newMailParser-&gt;PublishMsgHeader(aMsgWindow);</span>
<a href="#l38.1180"></a><span id="l38.1180">     // run any reply/forward filter after we've finished with the</span>
<a href="#l38.1181"></a><span id="l38.1181">     // temp quarantine file, and/or moved the message to another folder.</span>
<a href="#l38.1182"></a><span id="l38.1182">     m_newMailParser-&gt;ApplyForwardAndReplyFilter(aMsgWindow);</span>
<a href="#l38.1183"></a><span id="l38.1183" class="difflineminus">-    if (aSize)</span>
<a href="#l38.1184"></a><span id="l38.1184" class="difflineminus">-      hdr-&gt;SetUint32Property(&quot;onlineSize&quot;, aSize);</span>
<a href="#l38.1185"></a><span id="l38.1185" class="difflineplus">+    if (aSize) hdr-&gt;SetUint32Property(&quot;onlineSize&quot;, aSize);</span>
<a href="#l38.1186"></a><span id="l38.1186"> </span>
<a href="#l38.1187"></a><span id="l38.1187">     // if DeleteDownloadMsg requested it, select the new message</span>
<a href="#l38.1188"></a><span id="l38.1188">     else if (doSelect)</span>
<a href="#l38.1189"></a><span id="l38.1189" class="difflineminus">-      (void) localFolder-&gt;SelectDownloadMsg();</span>
<a href="#l38.1190"></a><span id="l38.1190" class="difflineplus">+      (void)localFolder-&gt;SelectDownloadMsg();</span>
<a href="#l38.1191"></a><span id="l38.1191">   }</span>
<a href="#l38.1192"></a><span id="l38.1192"> </span>
<a href="#l38.1193"></a><span id="l38.1193"> #ifdef DEBUG</span>
<a href="#l38.1194"></a><span id="l38.1194">   printf(&quot;Incorporate message complete.\n&quot;);</span>
<a href="#l38.1195"></a><span id="l38.1195"> #endif</span>
<a href="#l38.1196"></a><span id="l38.1196" class="difflineminus">-  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.1197"></a><span id="l38.1197" class="difflineplus">+  nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(</span>
<a href="#l38.1198"></a><span id="l38.1198" class="difflineplus">+      do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l38.1199"></a><span id="l38.1199">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1200"></a><span id="l38.1200" class="difflineminus">-  pop3Service-&gt;NotifyDownloadProgress(m_folder, ++m_numMsgsDownloaded, m_numNewMessages);</span>
<a href="#l38.1201"></a><span id="l38.1201" class="difflineplus">+  pop3Service-&gt;NotifyDownloadProgress(m_folder, ++m_numMsgsDownloaded,</span>
<a href="#l38.1202"></a><span id="l38.1202" class="difflineplus">+                                      m_numNewMessages);</span>
<a href="#l38.1203"></a><span id="l38.1203">   return NS_OK;</span>
<a href="#l38.1204"></a><span id="l38.1204"> }</span>
<a href="#l38.1205"></a><span id="l38.1205"> </span>
<a href="#l38.1206"></a><span id="l38.1206"> NS_IMETHODIMP</span>
<a href="#l38.1207"></a><span id="l38.1207" class="difflineminus">-nsPop3Sink::IncorporateAbort(bool uidlDownload)</span>
<a href="#l38.1208"></a><span id="l38.1208" class="difflineminus">-{</span>
<a href="#l38.1209"></a><span id="l38.1209" class="difflineplus">+nsPop3Sink::IncorporateAbort(bool uidlDownload) {</span>
<a href="#l38.1210"></a><span id="l38.1210">   nsresult rv = m_outFileStream-&gt;Close();</span>
<a href="#l38.1211"></a><span id="l38.1211" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l38.1212"></a><span id="l38.1212" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.1213"></a><span id="l38.1213">   if (!m_downloadingToTempFile &amp;&amp; m_msgStore &amp;&amp; m_newMailParser &amp;&amp;</span>
<a href="#l38.1214"></a><span id="l38.1214" class="difflineminus">-      m_newMailParser-&gt;m_newMsgHdr)</span>
<a href="#l38.1215"></a><span id="l38.1215" class="difflineminus">-  {</span>
<a href="#l38.1216"></a><span id="l38.1216" class="difflineminus">-      m_msgStore-&gt;DiscardNewMessage(m_outFileStream,</span>
<a href="#l38.1217"></a><span id="l38.1217" class="difflineminus">-                                    m_newMailParser-&gt;m_newMsgHdr);</span>
<a href="#l38.1218"></a><span id="l38.1218" class="difflineplus">+      m_newMailParser-&gt;m_newMsgHdr) {</span>
<a href="#l38.1219"></a><span id="l38.1219" class="difflineplus">+    m_msgStore-&gt;DiscardNewMessage(m_outFileStream,</span>
<a href="#l38.1220"></a><span id="l38.1220" class="difflineplus">+                                  m_newMailParser-&gt;m_newMsgHdr);</span>
<a href="#l38.1221"></a><span id="l38.1221">   }</span>
<a href="#l38.1222"></a><span id="l38.1222"> #ifdef DEBUG</span>
<a href="#l38.1223"></a><span id="l38.1223">   printf(&quot;Incorporate message abort.\n&quot;);</span>
<a href="#l38.1224"></a><span id="l38.1224"> #endif</span>
<a href="#l38.1225"></a><span id="l38.1225">   return rv;</span>
<a href="#l38.1226"></a><span id="l38.1226"> }</span>
<a href="#l38.1227"></a><span id="l38.1227"> </span>
<a href="#l38.1228"></a><span id="l38.1228" class="difflineminus">-nsresult</span>
<a href="#l38.1229"></a><span id="l38.1229" class="difflineminus">-nsPop3Sink::BiffGetNewMail()</span>
<a href="#l38.1230"></a><span id="l38.1230" class="difflineminus">-{</span>
<a href="#l38.1231"></a><span id="l38.1231" class="difflineplus">+nsresult nsPop3Sink::BiffGetNewMail() {</span>
<a href="#l38.1232"></a><span id="l38.1232"> #ifdef DEBUG</span>
<a href="#l38.1233"></a><span id="l38.1233" class="difflineminus">-    printf(&quot;Biff get new mail.\n&quot;);</span>
<a href="#l38.1234"></a><span id="l38.1234" class="difflineplus">+  printf(&quot;Biff get new mail.\n&quot;);</span>
<a href="#l38.1235"></a><span id="l38.1235"> #endif</span>
<a href="#l38.1236"></a><span id="l38.1236" class="difflineminus">-    return NS_OK;</span>
<a href="#l38.1237"></a><span id="l38.1237" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.1238"></a><span id="l38.1238"> }</span>
<a href="#l38.1239"></a><span id="l38.1239"> </span>
<a href="#l38.1240"></a><span id="l38.1240" class="difflineminus">-nsresult</span>
<a href="#l38.1241"></a><span id="l38.1241" class="difflineminus">-nsPop3Sink::SetBiffStateAndUpdateFE(uint32_t aBiffState, int32_t numNewMessages, bool notify)</span>
<a href="#l38.1242"></a><span id="l38.1242" class="difflineminus">-{</span>
<a href="#l38.1243"></a><span id="l38.1243" class="difflineplus">+nsresult nsPop3Sink::SetBiffStateAndUpdateFE(uint32_t aBiffState,</span>
<a href="#l38.1244"></a><span id="l38.1244" class="difflineplus">+                                             int32_t numNewMessages,</span>
<a href="#l38.1245"></a><span id="l38.1245" class="difflineplus">+                                             bool notify) {</span>
<a href="#l38.1246"></a><span id="l38.1246">   m_biffState = aBiffState;</span>
<a href="#l38.1247"></a><span id="l38.1247" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l38.1248"></a><span id="l38.1248" class="difflineminus">-    numNewMessages -= m_newMailParser-&gt;m_numNotNewMessages;</span>
<a href="#l38.1249"></a><span id="l38.1249" class="difflineplus">+  if (m_newMailParser) numNewMessages -= m_newMailParser-&gt;m_numNotNewMessages;</span>
<a href="#l38.1250"></a><span id="l38.1250"> </span>
<a href="#l38.1251"></a><span id="l38.1251" class="difflineminus">-  if (notify &amp;&amp; m_folder &amp;&amp; numNewMessages &gt; 0 &amp;&amp; numNewMessages != m_numNewMessages</span>
<a href="#l38.1252"></a><span id="l38.1252" class="difflineminus">-      &amp;&amp; aBiffState == nsIMsgFolder::nsMsgBiffState_NewMail)</span>
<a href="#l38.1253"></a><span id="l38.1253" class="difflineminus">-  {</span>
<a href="#l38.1254"></a><span id="l38.1254" class="difflineplus">+  if (notify &amp;&amp; m_folder &amp;&amp; numNewMessages &gt; 0 &amp;&amp;</span>
<a href="#l38.1255"></a><span id="l38.1255" class="difflineplus">+      numNewMessages != m_numNewMessages &amp;&amp;</span>
<a href="#l38.1256"></a><span id="l38.1256" class="difflineplus">+      aBiffState == nsIMsgFolder::nsMsgBiffState_NewMail) {</span>
<a href="#l38.1257"></a><span id="l38.1257">     m_folder-&gt;SetNumNewMessages(numNewMessages);</span>
<a href="#l38.1258"></a><span id="l38.1258">     m_folder-&gt;SetBiffState(aBiffState);</span>
<a href="#l38.1259"></a><span id="l38.1259">   }</span>
<a href="#l38.1260"></a><span id="l38.1260">   m_numNewMessages = numNewMessages;</span>
<a href="#l38.1261"></a><span id="l38.1261"> </span>
<a href="#l38.1262"></a><span id="l38.1262">   return NS_OK;</span>
<a href="#l38.1263"></a><span id="l38.1263"> }</span>
<a href="#l38.1264"></a><span id="l38.1264"> </span>
<a href="#l38.1265"></a><span id="l38.1265"> NS_IMETHODIMP</span>
<a href="#l38.1266"></a><span id="l38.1266" class="difflineminus">-nsPop3Sink::GetBuildMessageUri(bool *bVal)</span>
<a href="#l38.1267"></a><span id="l38.1267" class="difflineminus">-{</span>
<a href="#l38.1268"></a><span id="l38.1268" class="difflineplus">+nsPop3Sink::GetBuildMessageUri(bool *bVal) {</span>
<a href="#l38.1269"></a><span id="l38.1269">   NS_ENSURE_ARG_POINTER(bVal);</span>
<a href="#l38.1270"></a><span id="l38.1270">   *bVal = m_buildMessageUri;</span>
<a href="#l38.1271"></a><span id="l38.1271">   return NS_OK;</span>
<a href="#l38.1272"></a><span id="l38.1272"> }</span>
<a href="#l38.1273"></a><span id="l38.1273"> </span>
<a href="#l38.1274"></a><span id="l38.1274"> NS_IMETHODIMP</span>
<a href="#l38.1275"></a><span id="l38.1275" class="difflineminus">-nsPop3Sink::SetBuildMessageUri(bool bVal)</span>
<a href="#l38.1276"></a><span id="l38.1276" class="difflineminus">-{</span>
<a href="#l38.1277"></a><span id="l38.1277" class="difflineplus">+nsPop3Sink::SetBuildMessageUri(bool bVal) {</span>
<a href="#l38.1278"></a><span id="l38.1278">   m_buildMessageUri = bVal;</span>
<a href="#l38.1279"></a><span id="l38.1279">   return NS_OK;</span>
<a href="#l38.1280"></a><span id="l38.1280"> }</span>
<a href="#l38.1281"></a><span id="l38.1281"> </span>
<a href="#l38.1282"></a><span id="l38.1282"> NS_IMETHODIMP</span>
<a href="#l38.1283"></a><span id="l38.1283" class="difflineminus">-nsPop3Sink::GetMessageUri(char **messageUri)</span>
<a href="#l38.1284"></a><span id="l38.1284" class="difflineminus">-{</span>
<a href="#l38.1285"></a><span id="l38.1285" class="difflineplus">+nsPop3Sink::GetMessageUri(char **messageUri) {</span>
<a href="#l38.1286"></a><span id="l38.1286">   NS_ENSURE_ARG_POINTER(messageUri);</span>
<a href="#l38.1287"></a><span id="l38.1287">   NS_ENSURE_TRUE(!m_messageUri.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l38.1288"></a><span id="l38.1288">   *messageUri = ToNewCString(m_messageUri);</span>
<a href="#l38.1289"></a><span id="l38.1289">   return NS_OK;</span>
<a href="#l38.1290"></a><span id="l38.1290"> }</span>
<a href="#l38.1291"></a><span id="l38.1291"> </span>
<a href="#l38.1292"></a><span id="l38.1292"> NS_IMETHODIMP</span>
<a href="#l38.1293"></a><span id="l38.1293" class="difflineminus">-nsPop3Sink::SetMessageUri(const char *messageUri)</span>
<a href="#l38.1294"></a><span id="l38.1294" class="difflineminus">-{</span>
<a href="#l38.1295"></a><span id="l38.1295" class="difflineplus">+nsPop3Sink::SetMessageUri(const char *messageUri) {</span>
<a href="#l38.1296"></a><span id="l38.1296">   NS_ENSURE_ARG_POINTER(messageUri);</span>
<a href="#l38.1297"></a><span id="l38.1297">   m_messageUri = messageUri;</span>
<a href="#l38.1298"></a><span id="l38.1298">   return NS_OK;</span>
<a href="#l38.1299"></a><span id="l38.1299"> }</span>
<a href="#l38.1300"></a><span id="l38.1300"> </span>
<a href="#l38.1301"></a><span id="l38.1301"> NS_IMETHODIMP</span>
<a href="#l38.1302"></a><span id="l38.1302" class="difflineminus">-nsPop3Sink::GetBaseMessageUri(char ** baseMessageUri)</span>
<a href="#l38.1303"></a><span id="l38.1303" class="difflineminus">-{</span>
<a href="#l38.1304"></a><span id="l38.1304" class="difflineplus">+nsPop3Sink::GetBaseMessageUri(char **baseMessageUri) {</span>
<a href="#l38.1305"></a><span id="l38.1305">   NS_ENSURE_ARG_POINTER(baseMessageUri);</span>
<a href="#l38.1306"></a><span id="l38.1306">   NS_ENSURE_TRUE(!m_baseMessageUri.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l38.1307"></a><span id="l38.1307">   *baseMessageUri = ToNewCString(m_baseMessageUri);</span>
<a href="#l38.1308"></a><span id="l38.1308">   return NS_OK;</span>
<a href="#l38.1309"></a><span id="l38.1309"> }</span>
<a href="#l38.1310"></a><span id="l38.1310"> </span>
<a href="#l38.1311"></a><span id="l38.1311"> NS_IMETHODIMP</span>
<a href="#l38.1312"></a><span id="l38.1312" class="difflineminus">-nsPop3Sink::SetBaseMessageUri(const char *baseMessageUri)</span>
<a href="#l38.1313"></a><span id="l38.1313" class="difflineminus">-{</span>
<a href="#l38.1314"></a><span id="l38.1314" class="difflineplus">+nsPop3Sink::SetBaseMessageUri(const char *baseMessageUri) {</span>
<a href="#l38.1315"></a><span id="l38.1315">   NS_ENSURE_ARG_POINTER(baseMessageUri);</span>
<a href="#l38.1316"></a><span id="l38.1316">   m_baseMessageUri = baseMessageUri;</span>
<a href="#l38.1317"></a><span id="l38.1317">   return NS_OK;</span>
<a href="#l38.1318"></a><span id="l38.1318"> }</span>
<a href="#l38.1319"></a><span id="l38.1319"> </span>
<a href="#l38.1320"></a><span id="l38.1320"> NS_IMETHODIMP</span>
<a href="#l38.1321"></a><span id="l38.1321" class="difflineminus">-nsPop3Sink::GetOrigMessageUri(nsACString&amp; aOrigMessageUri)</span>
<a href="#l38.1322"></a><span id="l38.1322" class="difflineminus">-{</span>
<a href="#l38.1323"></a><span id="l38.1323" class="difflineplus">+nsPop3Sink::GetOrigMessageUri(nsACString &amp;aOrigMessageUri) {</span>
<a href="#l38.1324"></a><span id="l38.1324">   aOrigMessageUri.Assign(m_origMessageUri);</span>
<a href="#l38.1325"></a><span id="l38.1325">   return NS_OK;</span>
<a href="#l38.1326"></a><span id="l38.1326"> }</span>
<a href="#l38.1327"></a><span id="l38.1327"> </span>
<a href="#l38.1328"></a><span id="l38.1328"> NS_IMETHODIMP</span>
<a href="#l38.1329"></a><span id="l38.1329" class="difflineminus">-nsPop3Sink::SetOrigMessageUri(const nsACString&amp; aOrigMessageUri)</span>
<a href="#l38.1330"></a><span id="l38.1330" class="difflineminus">-{</span>
<a href="#l38.1331"></a><span id="l38.1331" class="difflineplus">+nsPop3Sink::SetOrigMessageUri(const nsACString &amp;aOrigMessageUri) {</span>
<a href="#l38.1332"></a><span id="l38.1332">   m_origMessageUri.Assign(aOrigMessageUri);</span>
<a href="#l38.1333"></a><span id="l38.1333">   return NS_OK;</span>
<a href="#l38.1334"></a><span id="l38.1334"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.h</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -15,63 +15,62 @@</span>
<a href="#l39.4"></a><span id="l39.4"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l39.5"></a><span id="l39.5"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l39.6"></a><span id="l39.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l39.7"></a><span id="l39.7"> #include &quot;nsString.h&quot;</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9"> class nsParseNewMailState;</span>
<a href="#l39.10"></a><span id="l39.10"> class nsIMsgFolder;</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-struct partialRecord</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-{</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+struct partialRecord {</span>
<a href="#l39.15"></a><span id="l39.15">   partialRecord();</span>
<a href="#l39.16"></a><span id="l39.16">   ~partialRecord();</span>
<a href="#l39.17"></a><span id="l39.17"> </span>
<a href="#l39.18"></a><span id="l39.18">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_msgDBHdr;</span>
<a href="#l39.19"></a><span id="l39.19">   nsCString m_uidl;</span>
<a href="#l39.20"></a><span id="l39.20"> };</span>
<a href="#l39.21"></a><span id="l39.21"> </span>
<a href="#l39.22"></a><span id="l39.22" class="difflineminus">-class nsPop3Sink : public nsIPop3Sink</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-{</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-public:</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-    nsPop3Sink();</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+class nsPop3Sink : public nsIPop3Sink {</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+ public:</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+  nsPop3Sink();</span>
<a href="#l39.29"></a><span id="l39.29"> </span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-    NS_DECL_NSIPOP3SINK</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-    nsresult GetServerFolder(nsIMsgFolder **aFolder);</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-    nsresult FindPartialMessages();</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-    void CheckPartialMessages(nsIPop3Protocol *protocol);</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+  NS_DECL_NSIPOP3SINK</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+  nsresult GetServerFolder(nsIMsgFolder **aFolder);</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+  nsresult FindPartialMessages();</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+  void CheckPartialMessages(nsIPop3Protocol *protocol);</span>
<a href="#l39.40"></a><span id="l39.40"> </span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-    static char*  GetDummyEnvelope(void);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+  static char *GetDummyEnvelope(void);</span>
<a href="#l39.43"></a><span id="l39.43"> </span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-protected:</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-    virtual ~nsPop3Sink();</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-    nsresult WriteLineToMailbox(const nsACString&amp; buffer);</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-    nsresult ReleaseFolderLock();</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-    nsresult HandleTempDownloadFailed(nsIMsgWindow *msgWindow);</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+ protected:</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+  virtual ~nsPop3Sink();</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+  nsresult WriteLineToMailbox(const nsACString &amp;buffer);</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+  nsresult ReleaseFolderLock();</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+  nsresult HandleTempDownloadFailed(nsIMsgWindow *msgWindow);</span>
<a href="#l39.54"></a><span id="l39.54"> </span>
<a href="#l39.55"></a><span id="l39.55" class="difflineminus">-    bool m_authed;</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-    nsCString m_accountUrl;</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-    uint32_t m_biffState;</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-    int32_t m_numNewMessages;</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-    int32_t m_numNewMessagesInFolder;</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineminus">-    int32_t m_numMsgsDownloaded;</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-    bool m_senderAuthed;</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-    nsCString m_outputBuffer;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-    nsCOMPtr&lt;nsIPop3IncomingServer&gt; m_popServer;</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineminus">-    //Currently the folder we want to update about biff info</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-    RefPtr&lt;nsParseNewMailState&gt; m_newMailParser;</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-    nsCOMPtr &lt;nsIOutputStream&gt; m_outFileStream; // the file we write to, which may be temporary</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineminus">-    nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-    bool m_uidlDownload;</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">-    bool m_buildMessageUri;</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineminus">-    bool m_downloadingToTempFile;</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; m_tmpDownloadFile;</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineminus">-    nsCString m_messageUri;</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineminus">-    nsCString m_baseMessageUri;</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineminus">-    nsCString m_origMessageUri;</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineminus">-    nsCString m_accountKey;</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-    nsTArray&lt;partialRecord*&gt; m_partialMsgsArray;</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+  bool m_authed;</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+  nsCString m_accountUrl;</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+  uint32_t m_biffState;</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+  int32_t m_numNewMessages;</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+  int32_t m_numNewMessagesInFolder;</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+  int32_t m_numMsgsDownloaded;</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+  bool m_senderAuthed;</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+  nsCString m_outputBuffer;</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+  nsCOMPtr&lt;nsIPop3IncomingServer&gt; m_popServer;</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  // Currently the folder we want to update about biff info</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+  RefPtr&lt;nsParseNewMailState&gt; m_newMailParser;</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt;</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+      m_outFileStream;  // the file we write to, which may be temporary</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+  bool m_uidlDownload;</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+  bool m_buildMessageUri;</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+  bool m_downloadingToTempFile;</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_tmpDownloadFile;</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+  nsCString m_messageUri;</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+  nsCString m_baseMessageUri;</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+  nsCString m_origMessageUri;</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+  nsCString m_accountKey;</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+  nsTArray&lt;partialRecord *&gt; m_partialMsgsArray;</span>
<a href="#l39.104"></a><span id="l39.104"> };</span>
<a href="#l39.105"></a><span id="l39.105"> </span>
<a href="#l39.106"></a><span id="l39.106"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/local/src/nsPop3URL.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3URL.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,62 +1,49 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l40.5"></a><span id="l40.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.6"></a><span id="l40.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.7"></a><span id="l40.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12"> #include &quot;nsPop3URL.h&quot;</span>
<a href="#l40.13"></a><span id="l40.13"> #include &quot;nsPop3Protocol.h&quot;</span>
<a href="#l40.14"></a><span id="l40.14"> #include &quot;nsString.h&quot;</span>
<a href="#l40.15"></a><span id="l40.15"> #include &quot;prmem.h&quot;</span>
<a href="#l40.16"></a><span id="l40.16"> #include &quot;plstr.h&quot;</span>
<a href="#l40.17"></a><span id="l40.17"> #include &quot;prprf.h&quot;</span>
<a href="#l40.18"></a><span id="l40.18"> </span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-nsPop3URL::nsPop3URL(): nsMsgMailNewsUrl()</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-{</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-}</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+nsPop3URL::nsPop3URL() : nsMsgMailNewsUrl() {}</span>
<a href="#l40.23"></a><span id="l40.23"> </span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-nsPop3URL::~nsPop3URL()</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-{</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-}</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+nsPop3URL::~nsPop3URL() {}</span>
<a href="#l40.28"></a><span id="l40.28"> </span>
<a href="#l40.29"></a><span id="l40.29"> NS_IMPL_ISUPPORTS_INHERITED(nsPop3URL, nsMsgMailNewsUrl, nsIPop3URL)</span>
<a href="#l40.30"></a><span id="l40.30"> </span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-</span>
<a href="#l40.32"></a><span id="l40.32"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l40.33"></a><span id="l40.33"> // Begin nsIPop3URL specific support</span>
<a href="#l40.34"></a><span id="l40.34"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l40.35"></a><span id="l40.35"> </span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">-nsresult nsPop3URL::SetPop3Sink(nsIPop3Sink* aPop3Sink)</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineminus">-{</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineminus">-    if (aPop3Sink)</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-        m_pop3Sink = aPop3Sink;</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineminus">-    return NS_OK;</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineplus">+nsresult nsPop3URL::SetPop3Sink(nsIPop3Sink* aPop3Sink) {</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+  if (aPop3Sink) m_pop3Sink = aPop3Sink;</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.44"></a><span id="l40.44"> }</span>
<a href="#l40.45"></a><span id="l40.45"> </span>
<a href="#l40.46"></a><span id="l40.46" class="difflineminus">-nsresult nsPop3URL::GetPop3Sink(nsIPop3Sink** aPop3Sink)</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">-{</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineminus">-    if (aPop3Sink)</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineminus">-    {</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineminus">-        *aPop3Sink = m_pop3Sink;</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineminus">-        NS_IF_ADDREF(*aPop3Sink);</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineminus">-    }</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineminus">-    return NS_OK;</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+nsresult nsPop3URL::GetPop3Sink(nsIPop3Sink** aPop3Sink) {</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+  if (aPop3Sink) {</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+    *aPop3Sink = m_pop3Sink;</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+    NS_IF_ADDREF(*aPop3Sink);</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+  }</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.60"></a><span id="l40.60"> }</span>
<a href="#l40.61"></a><span id="l40.61"> </span>
<a href="#l40.62"></a><span id="l40.62"> NS_IMETHODIMP</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineminus">-nsPop3URL::GetMessageUri(char ** aMessageUri)</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineminus">-{</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineminus">-    if(!aMessageUri || m_messageUri.IsEmpty())</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineminus">-    *aMessageUri = ToNewCString(m_messageUri);</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineminus">-    return NS_OK;</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+nsPop3URL::GetMessageUri(char** aMessageUri) {</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+  if (!aMessageUri || m_messageUri.IsEmpty()) return NS_ERROR_NULL_POINTER;</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+  *aMessageUri = ToNewCString(m_messageUri);</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.73"></a><span id="l40.73"> }</span>
<a href="#l40.74"></a><span id="l40.74"> </span>
<a href="#l40.75"></a><span id="l40.75"> NS_IMETHODIMP</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineminus">-nsPop3URL::SetMessageUri(const char *aMessageUri)</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineminus">-{</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineminus">-    if (aMessageUri)</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineminus">-        m_messageUri = aMessageUri;</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineminus">-    return NS_OK;</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+nsPop3URL::SetMessageUri(const char* aMessageUri) {</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+  if (aMessageUri) m_messageUri = aMessageUri;</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+  return NS_OK;</span>
<a href="#l40.84"></a><span id="l40.84"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/local/src/nsPop3URL.h</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3URL.h</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -5,25 +5,24 @@</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5"> #ifndef nsPop3URL_h__</span>
<a href="#l41.6"></a><span id="l41.6"> #define nsPop3URL_h__</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8"> #include &quot;nsIPop3URL.h&quot;</span>
<a href="#l41.9"></a><span id="l41.9"> #include &quot;nsMsgMailNewsUrl.h&quot;</span>
<a href="#l41.10"></a><span id="l41.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-class nsPop3URL : public nsIPop3URL, public nsMsgMailNewsUrl</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-{</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-public:</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+class nsPop3URL : public nsIPop3URL, public nsMsgMailNewsUrl {</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+ public:</span>
<a href="#l41.17"></a><span id="l41.17">   NS_DECL_NSIPOP3URL</span>
<a href="#l41.18"></a><span id="l41.18">   nsPop3URL();</span>
<a href="#l41.19"></a><span id="l41.19">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l41.20"></a><span id="l41.20"> </span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-protected:</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+ protected:</span>
<a href="#l41.23"></a><span id="l41.23">   virtual ~nsPop3URL();</span>
<a href="#l41.24"></a><span id="l41.24"> </span>
<a href="#l41.25"></a><span id="l41.25">   nsCString m_messageUri;</span>
<a href="#l41.26"></a><span id="l41.26"> </span>
<a href="#l41.27"></a><span id="l41.27">   /* Pop3 specific event sinks */</span>
<a href="#l41.28"></a><span id="l41.28">   nsCOMPtr&lt;nsIPop3Sink&gt; m_pop3Sink;</span>
<a href="#l41.29"></a><span id="l41.29"> };</span>
<a href="#l41.30"></a><span id="l41.30"> </span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-#endif // nsPop3URL_h__</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+#endif  // nsPop3URL_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -10,250 +10,223 @@</span>
<a href="#l42.4"></a><span id="l42.4"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> #include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l42.7"></a><span id="l42.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l42.8"></a><span id="l42.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l42.9"></a><span id="l42.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l42.10"></a><span id="l42.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-nsrefcnt nsRssIncomingServer::gInstanceCount    = 0;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+nsrefcnt nsRssIncomingServer::gInstanceCount = 0;</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED(nsRssIncomingServer,</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineminus">-                             nsMsgIncomingServer,</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-                             nsIRssIncomingServer,</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineminus">-                             nsIMsgFolderListener,</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineminus">-                             nsILocalMailIncomingServer)</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED(nsRssIncomingServer, nsMsgIncomingServer,</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+                            nsIRssIncomingServer, nsIMsgFolderListener,</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+                            nsILocalMailIncomingServer)</span>
<a href="#l42.23"></a><span id="l42.23"> </span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-nsRssIncomingServer::nsRssIncomingServer()</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-{</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+nsRssIncomingServer::nsRssIncomingServer() {</span>
<a href="#l42.27"></a><span id="l42.27">   m_canHaveFilters = true;</span>
<a href="#l42.28"></a><span id="l42.28"> </span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">-  if (gInstanceCount == 0)</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">-  {</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+  if (gInstanceCount == 0) {</span>
<a href="#l42.32"></a><span id="l42.32">     nsresult rv;</span>
<a href="#l42.33"></a><span id="l42.33">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifyService =</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l42.36"></a><span id="l42.36">     if (NS_SUCCEEDED(rv))</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-      notifyService-&gt;AddListener(this,</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-          nsIMsgFolderNotificationService::folderAdded |</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-          nsIMsgFolderNotificationService::folderDeleted |</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-          nsIMsgFolderNotificationService::folderMoveCopyCompleted |</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineminus">-          nsIMsgFolderNotificationService::folderRenamed);</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+      notifyService-&gt;AddListener(</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+          this, nsIMsgFolderNotificationService::folderAdded |</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+                    nsIMsgFolderNotificationService::folderDeleted |</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+                    nsIMsgFolderNotificationService::folderMoveCopyCompleted |</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+                    nsIMsgFolderNotificationService::folderRenamed);</span>
<a href="#l42.47"></a><span id="l42.47">   }</span>
<a href="#l42.48"></a><span id="l42.48"> </span>
<a href="#l42.49"></a><span id="l42.49">   gInstanceCount++;</span>
<a href="#l42.50"></a><span id="l42.50"> }</span>
<a href="#l42.51"></a><span id="l42.51"> </span>
<a href="#l42.52"></a><span id="l42.52" class="difflineminus">-nsRssIncomingServer::~nsRssIncomingServer()</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-{</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+nsRssIncomingServer::~nsRssIncomingServer() {</span>
<a href="#l42.55"></a><span id="l42.55">   gInstanceCount--;</span>
<a href="#l42.56"></a><span id="l42.56"> </span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-  if (gInstanceCount == 0)</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-  {</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+  if (gInstanceCount == 0) {</span>
<a href="#l42.60"></a><span id="l42.60">     nsresult rv;</span>
<a href="#l42.61"></a><span id="l42.61">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifyService =</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineminus">-      notifyService-&gt;RemoveListener(this);</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+    if (NS_SUCCEEDED(rv)) notifyService-&gt;RemoveListener(this);</span>
<a href="#l42.67"></a><span id="l42.67">   }</span>
<a href="#l42.68"></a><span id="l42.68"> }</span>
<a href="#l42.69"></a><span id="l42.69"> </span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-nsresult nsRssIncomingServer::FillInDataSourcePath(const nsAString&amp; aDataSourceName,</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">-                                                   nsIFile ** aLocation)</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineminus">-{</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineplus">+nsresult nsRssIncomingServer::FillInDataSourcePath(</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+    const nsAString &amp;aDataSourceName, nsIFile **aLocation) {</span>
<a href="#l42.75"></a><span id="l42.75">   nsresult rv;</span>
<a href="#l42.76"></a><span id="l42.76">   // Get the local path for this server.</span>
<a href="#l42.77"></a><span id="l42.77">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l42.78"></a><span id="l42.78">   rv = GetLocalPath(getter_AddRefs(localFile));</span>
<a href="#l42.79"></a><span id="l42.79">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.80"></a><span id="l42.80"> </span>
<a href="#l42.81"></a><span id="l42.81">   // Append the name of the subscriptions data source.</span>
<a href="#l42.82"></a><span id="l42.82">   rv = localFile-&gt;Append(aDataSourceName);</span>
<a href="#l42.83"></a><span id="l42.83">   localFile.forget(aLocation);</span>
<a href="#l42.84"></a><span id="l42.84">   return rv;</span>
<a href="#l42.85"></a><span id="l42.85"> }</span>
<a href="#l42.86"></a><span id="l42.86"> </span>
<a href="#l42.87"></a><span id="l42.87"> // nsIRSSIncomingServer methods</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetSubscriptionsDataSourcePath(nsIFile ** aLocation)</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-{</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetSubscriptionsDataSourcePath(</span>
<a href="#l42.91"></a><span id="l42.91" class="difflineplus">+    nsIFile **aLocation) {</span>
<a href="#l42.92"></a><span id="l42.92">   return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeds.rdf&quot;), aLocation);</span>
<a href="#l42.93"></a><span id="l42.93"> }</span>
<a href="#l42.94"></a><span id="l42.94"> </span>
<a href="#l42.95"></a><span id="l42.95" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetFeedItemsDataSourcePath(nsIFile ** aLocation)</span>
<a href="#l42.96"></a><span id="l42.96" class="difflineminus">-{</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetFeedItemsDataSourcePath(</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineplus">+    nsIFile **aLocation) {</span>
<a href="#l42.99"></a><span id="l42.99">   return FillInDataSourcePath(NS_LITERAL_STRING(&quot;feeditems.rdf&quot;), aLocation);</span>
<a href="#l42.100"></a><span id="l42.100"> }</span>
<a href="#l42.101"></a><span id="l42.101"> </span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::CreateDefaultMailboxes()</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-{</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::CreateDefaultMailboxes() {</span>
<a href="#l42.105"></a><span id="l42.105">   // For Feeds, all we have is Trash.</span>
<a href="#l42.106"></a><span id="l42.106">   return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l42.107"></a><span id="l42.107"> }</span>
<a href="#l42.108"></a><span id="l42.108"> </span>
<a href="#l42.109"></a><span id="l42.109" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::SetFlagsOnDefaultMailboxes()</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineminus">-{</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::SetFlagsOnDefaultMailboxes() {</span>
<a href="#l42.112"></a><span id="l42.112">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l42.113"></a><span id="l42.113">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l42.114"></a><span id="l42.114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.115"></a><span id="l42.115"> </span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder =</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+      do_QueryInterface(rootFolder, &amp;rv);</span>
<a href="#l42.119"></a><span id="l42.119">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.120"></a><span id="l42.120"> </span>
<a href="#l42.121"></a><span id="l42.121">   localFolder-&gt;SetFlagsOnDefaultMailboxes(nsMsgFolderFlags::Trash);</span>
<a href="#l42.122"></a><span id="l42.122">   return NS_OK;</span>
<a href="#l42.123"></a><span id="l42.123"> }</span>
<a href="#l42.124"></a><span id="l42.124"> </span>
<a href="#l42.125"></a><span id="l42.125" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow)</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineminus">-{</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::PerformBiff(nsIMsgWindow *aMsgWindow) {</span>
<a href="#l42.128"></a><span id="l42.128">   // Get the account root (server) folder and pass it on.</span>
<a href="#l42.129"></a><span id="l42.129">   nsCOMPtr&lt;nsIMsgFolder&gt; rootRSSFolder;</span>
<a href="#l42.130"></a><span id="l42.130">   GetRootMsgFolder(getter_AddRefs(rootRSSFolder));</span>
<a href="#l42.131"></a><span id="l42.131">   nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(rootRSSFolder);</span>
<a href="#l42.132"></a><span id="l42.132">   nsresult rv;</span>
<a href="#l42.133"></a><span id="l42.133">   bool isBiff = true;</span>
<a href="#l42.134"></a><span id="l42.134">   nsCOMPtr&lt;nsINewsBlogFeedDownloader&gt; rssDownloader =</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineminus">-    do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+      do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l42.137"></a><span id="l42.137">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.138"></a><span id="l42.138">   rssDownloader-&gt;DownloadFeed(rootRSSFolder, urlListener, isBiff, aMsgWindow);</span>
<a href="#l42.139"></a><span id="l42.139">   return NS_OK;</span>
<a href="#l42.140"></a><span id="l42.140"> }</span>
<a href="#l42.141"></a><span id="l42.141"> </span>
<a href="#l42.142"></a><span id="l42.142"> NS_IMETHODIMP nsRssIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow,</span>
<a href="#l42.143"></a><span id="l42.143">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l42.144"></a><span id="l42.144">                                               nsIMsgFolder *aFolder,</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-                                              nsIURI **_retval)</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-{</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+                                              nsIURI **_retval) {</span>
<a href="#l42.148"></a><span id="l42.148">   // Pass the selected folder on to the downloader.</span>
<a href="#l42.149"></a><span id="l42.149">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l42.150"></a><span id="l42.150">   nsresult rv;</span>
<a href="#l42.151"></a><span id="l42.151">   bool isBiff = false;</span>
<a href="#l42.152"></a><span id="l42.152">   nsCOMPtr&lt;nsINewsBlogFeedDownloader&gt; rssDownloader =</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineminus">-    do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineplus">+      do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l42.155"></a><span id="l42.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.156"></a><span id="l42.156">   rssDownloader-&gt;DownloadFeed(aFolder, aUrlListener, isBiff, aMsgWindow);</span>
<a href="#l42.157"></a><span id="l42.157">   return NS_OK;</span>
<a href="#l42.158"></a><span id="l42.158"> }</span>
<a href="#l42.159"></a><span id="l42.159"> </span>
<a href="#l42.160"></a><span id="l42.160" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetAccountManagerChrome(nsAString&amp; aResult)</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineminus">-{</span>
<a href="#l42.162"></a><span id="l42.162" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetAccountManagerChrome(nsAString &amp;aResult) {</span>
<a href="#l42.163"></a><span id="l42.163">   aResult.AssignLiteral(&quot;am-newsblog.xul&quot;);</span>
<a href="#l42.164"></a><span id="l42.164">   return NS_OK;</span>
<a href="#l42.165"></a><span id="l42.165"> }</span>
<a href="#l42.166"></a><span id="l42.166"> </span>
<a href="#l42.167"></a><span id="l42.167" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetOfflineSupportLevel(int32_t *aSupportLevel)</span>
<a href="#l42.168"></a><span id="l42.168" class="difflineminus">-{</span>
<a href="#l42.169"></a><span id="l42.169" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetOfflineSupportLevel(</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineplus">+    int32_t *aSupportLevel) {</span>
<a href="#l42.171"></a><span id="l42.171">   NS_ENSURE_ARG_POINTER(aSupportLevel);</span>
<a href="#l42.172"></a><span id="l42.172">   *aSupportLevel = OFFLINE_SUPPORT_LEVEL_NONE;</span>
<a href="#l42.173"></a><span id="l42.173">   return NS_OK;</span>
<a href="#l42.174"></a><span id="l42.174"> }</span>
<a href="#l42.175"></a><span id="l42.175"> </span>
<a href="#l42.176"></a><span id="l42.176" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetSupportsDiskSpace(bool *aSupportsDiskSpace)</span>
<a href="#l42.177"></a><span id="l42.177" class="difflineminus">-{</span>
<a href="#l42.178"></a><span id="l42.178" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetSupportsDiskSpace(</span>
<a href="#l42.179"></a><span id="l42.179" class="difflineplus">+    bool *aSupportsDiskSpace) {</span>
<a href="#l42.180"></a><span id="l42.180">   NS_ENSURE_ARG_POINTER(aSupportsDiskSpace);</span>
<a href="#l42.181"></a><span id="l42.181">   *aSupportsDiskSpace = true;</span>
<a href="#l42.182"></a><span id="l42.182">   return NS_OK;</span>
<a href="#l42.183"></a><span id="l42.183"> }</span>
<a href="#l42.184"></a><span id="l42.184"> </span>
<a href="#l42.185"></a><span id="l42.185" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l42.186"></a><span id="l42.186" class="difflineminus">-{</span>
<a href="#l42.187"></a><span id="l42.187" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetServerRequiresPasswordForBiff(</span>
<a href="#l42.188"></a><span id="l42.188" class="difflineplus">+    bool *aServerRequiresPasswordForBiff) {</span>
<a href="#l42.189"></a><span id="l42.189">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l42.190"></a><span id="l42.190">   // For Feed folders, we don't require a password.</span>
<a href="#l42.191"></a><span id="l42.191">   *aServerRequiresPasswordForBiff = false;</span>
<a href="#l42.192"></a><span id="l42.192">   return NS_OK;</span>
<a href="#l42.193"></a><span id="l42.193"> }</span>
<a href="#l42.194"></a><span id="l42.194"> </span>
<a href="#l42.195"></a><span id="l42.195" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::GetCanSearchMessages(bool *canSearchMessages)</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineminus">-{</span>
<a href="#l42.197"></a><span id="l42.197" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::GetCanSearchMessages(</span>
<a href="#l42.198"></a><span id="l42.198" class="difflineplus">+    bool *canSearchMessages) {</span>
<a href="#l42.199"></a><span id="l42.199">   NS_ENSURE_ARG_POINTER(canSearchMessages);</span>
<a href="#l42.200"></a><span id="l42.200">   *canSearchMessages = true;</span>
<a href="#l42.201"></a><span id="l42.201">   return NS_OK;</span>
<a href="#l42.202"></a><span id="l42.202"> }</span>
<a href="#l42.203"></a><span id="l42.203"> </span>
<a href="#l42.204"></a><span id="l42.204" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::MsgAdded(nsIMsgDBHdr *aMsg)</span>
<a href="#l42.205"></a><span id="l42.205" class="difflineminus">-{</span>
<a href="#l42.206"></a><span id="l42.206" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::MsgAdded(nsIMsgDBHdr *aMsg) {</span>
<a href="#l42.207"></a><span id="l42.207">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.208"></a><span id="l42.208"> }</span>
<a href="#l42.209"></a><span id="l42.209"> </span>
<a href="#l42.210"></a><span id="l42.210"> NS_IMETHODIMP nsRssIncomingServer::MsgsClassified(nsIArray *aMsgs,</span>
<a href="#l42.211"></a><span id="l42.211">                                                   bool aJunkProcessed,</span>
<a href="#l42.212"></a><span id="l42.212" class="difflineminus">-                                                  bool aTraitProcessed)</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineminus">-{</span>
<a href="#l42.214"></a><span id="l42.214" class="difflineplus">+                                                  bool aTraitProcessed) {</span>
<a href="#l42.215"></a><span id="l42.215">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.216"></a><span id="l42.216"> }</span>
<a href="#l42.217"></a><span id="l42.217"> </span>
<a href="#l42.218"></a><span id="l42.218" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::MsgsDeleted(nsIArray *aMsgs)</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineminus">-{</span>
<a href="#l42.220"></a><span id="l42.220" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::MsgsDeleted(nsIArray *aMsgs) {</span>
<a href="#l42.221"></a><span id="l42.221">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.222"></a><span id="l42.222"> }</span>
<a href="#l42.223"></a><span id="l42.223"> </span>
<a href="#l42.224"></a><span id="l42.224" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::MsgsMoveCopyCompleted(bool aMove,</span>
<a href="#l42.225"></a><span id="l42.225" class="difflineminus">-                                                         nsIArray *aSrcMsgs,</span>
<a href="#l42.226"></a><span id="l42.226" class="difflineminus">-                                                         nsIMsgFolder *aDestFolder,</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineminus">-  nsIArray *aDestMsgs)</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineminus">-{</span>
<a href="#l42.229"></a><span id="l42.229" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::MsgsMoveCopyCompleted(</span>
<a href="#l42.230"></a><span id="l42.230" class="difflineplus">+    bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l42.231"></a><span id="l42.231" class="difflineplus">+    nsIArray *aDestMsgs) {</span>
<a href="#l42.232"></a><span id="l42.232">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.233"></a><span id="l42.233"> }</span>
<a href="#l42.234"></a><span id="l42.234"> </span>
<a href="#l42.235"></a><span id="l42.235"> NS_IMETHODIMP nsRssIncomingServer::MsgKeyChanged(nsMsgKey aOldKey,</span>
<a href="#l42.236"></a><span id="l42.236" class="difflineminus">-                                                 nsIMsgDBHdr *aNewHdr)</span>
<a href="#l42.237"></a><span id="l42.237" class="difflineminus">-{</span>
<a href="#l42.238"></a><span id="l42.238" class="difflineplus">+                                                 nsIMsgDBHdr *aNewHdr) {</span>
<a href="#l42.239"></a><span id="l42.239">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.240"></a><span id="l42.240"> }</span>
<a href="#l42.241"></a><span id="l42.241"> </span>
<a href="#l42.242"></a><span id="l42.242" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::FolderAdded(nsIMsgFolder *aFolder)</span>
<a href="#l42.243"></a><span id="l42.243" class="difflineminus">-{</span>
<a href="#l42.244"></a><span id="l42.244" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::FolderAdded(nsIMsgFolder *aFolder) {</span>
<a href="#l42.245"></a><span id="l42.245">   // Nothing to do. Not necessary for new folder adds, as a new folder never</span>
<a href="#l42.246"></a><span id="l42.246">   // has a subscription.</span>
<a href="#l42.247"></a><span id="l42.247">   return NS_OK;</span>
<a href="#l42.248"></a><span id="l42.248"> }</span>
<a href="#l42.249"></a><span id="l42.249"> </span>
<a href="#l42.250"></a><span id="l42.250" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::FolderDeleted(nsIMsgFolder *aFolder)</span>
<a href="#l42.251"></a><span id="l42.251" class="difflineminus">-{</span>
<a href="#l42.252"></a><span id="l42.252" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::FolderDeleted(nsIMsgFolder *aFolder) {</span>
<a href="#l42.253"></a><span id="l42.253">   // Not necessary for folder deletes, which are move to Trash and handled by</span>
<a href="#l42.254"></a><span id="l42.254">   // movecopy. Virtual folder or trash folder deletes send a folderdeleted,</span>
<a href="#l42.255"></a><span id="l42.255">   // but these should have no subscriptions already.</span>
<a href="#l42.256"></a><span id="l42.256">   return NS_OK;</span>
<a href="#l42.257"></a><span id="l42.257"> }</span>
<a href="#l42.258"></a><span id="l42.258"> </span>
<a href="#l42.259"></a><span id="l42.259" class="difflineminus">-NS_IMETHODIMP nsRssIncomingServer::FolderMoveCopyCompleted(bool aMove,</span>
<a href="#l42.260"></a><span id="l42.260" class="difflineminus">-                                                           nsIMsgFolder *aSrcFolder,</span>
<a href="#l42.261"></a><span id="l42.261" class="difflineminus">-                                                           nsIMsgFolder *aDestFolder)</span>
<a href="#l42.262"></a><span id="l42.262" class="difflineminus">-{</span>
<a href="#l42.263"></a><span id="l42.263" class="difflineplus">+NS_IMETHODIMP nsRssIncomingServer::FolderMoveCopyCompleted(</span>
<a href="#l42.264"></a><span id="l42.264" class="difflineplus">+    bool aMove, nsIMsgFolder *aSrcFolder, nsIMsgFolder *aDestFolder) {</span>
<a href="#l42.265"></a><span id="l42.265">   return FolderChanged(aDestFolder, aSrcFolder, (aMove ? &quot;move&quot; : &quot;copy&quot;));</span>
<a href="#l42.266"></a><span id="l42.266"> }</span>
<a href="#l42.267"></a><span id="l42.267"> </span>
<a href="#l42.268"></a><span id="l42.268"> NS_IMETHODIMP nsRssIncomingServer::FolderRenamed(nsIMsgFolder *aOrigFolder,</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineminus">-                                                 nsIMsgFolder *aNewFolder)</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineminus">-{</span>
<a href="#l42.271"></a><span id="l42.271" class="difflineplus">+                                                 nsIMsgFolder *aNewFolder) {</span>
<a href="#l42.272"></a><span id="l42.272">   return FolderChanged(aNewFolder, aOrigFolder, &quot;rename&quot;);</span>
<a href="#l42.273"></a><span id="l42.273"> }</span>
<a href="#l42.274"></a><span id="l42.274"> </span>
<a href="#l42.275"></a><span id="l42.275"> NS_IMETHODIMP nsRssIncomingServer::ItemEvent(nsISupports *aItem,</span>
<a href="#l42.276"></a><span id="l42.276">                                              const nsACString &amp;aEvent,</span>
<a href="#l42.277"></a><span id="l42.277">                                              nsISupports *aData,</span>
<a href="#l42.278"></a><span id="l42.278" class="difflineminus">-                                             const nsACString &amp;aString)</span>
<a href="#l42.279"></a><span id="l42.279" class="difflineminus">-{</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineplus">+                                             const nsACString &amp;aString) {</span>
<a href="#l42.281"></a><span id="l42.281">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l42.282"></a><span id="l42.282"> }</span>
<a href="#l42.283"></a><span id="l42.283"> </span>
<a href="#l42.284"></a><span id="l42.284"> nsresult nsRssIncomingServer::FolderChanged(nsIMsgFolder *aFolder,</span>
<a href="#l42.285"></a><span id="l42.285">                                             nsIMsgFolder *aOrigFolder,</span>
<a href="#l42.286"></a><span id="l42.286" class="difflineminus">-                                            const char *aAction)</span>
<a href="#l42.287"></a><span id="l42.287" class="difflineminus">-{</span>
<a href="#l42.288"></a><span id="l42.288" class="difflineminus">-  if (!aFolder)</span>
<a href="#l42.289"></a><span id="l42.289" class="difflineminus">-    return NS_OK;</span>
<a href="#l42.290"></a><span id="l42.290" class="difflineplus">+                                            const char *aAction) {</span>
<a href="#l42.291"></a><span id="l42.291" class="difflineplus">+  if (!aFolder) return NS_OK;</span>
<a href="#l42.292"></a><span id="l42.292"> </span>
<a href="#l42.293"></a><span id="l42.293">   nsresult rv;</span>
<a href="#l42.294"></a><span id="l42.294">   nsCOMPtr&lt;nsINewsBlogFeedDownloader&gt; rssDownloader =</span>
<a href="#l42.295"></a><span id="l42.295" class="difflineminus">-    do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l42.296"></a><span id="l42.296" class="difflineplus">+      do_GetService(&quot;@mozilla.org/newsblog-feed-downloader;1&quot;, &amp;rv);</span>
<a href="#l42.297"></a><span id="l42.297">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l42.298"></a><span id="l42.298">   rssDownloader-&gt;UpdateSubscriptionsDS(aFolder, aOrigFolder, aAction);</span>
<a href="#l42.299"></a><span id="l42.299">   return rv;</span>
<a href="#l42.300"></a><span id="l42.300"> }</span>
<a href="#l42.301"></a><span id="l42.301"> </span>
<a href="#l42.302"></a><span id="l42.302"> NS_IMETHODIMP</span>
<a href="#l42.303"></a><span id="l42.303" class="difflineminus">-nsRssIncomingServer::GetSortOrder(int32_t* aSortOrder)</span>
<a href="#l42.304"></a><span id="l42.304" class="difflineminus">-{</span>
<a href="#l42.305"></a><span id="l42.305" class="difflineplus">+nsRssIncomingServer::GetSortOrder(int32_t *aSortOrder) {</span>
<a href="#l42.306"></a><span id="l42.306">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l42.307"></a><span id="l42.307">   *aSortOrder = 400000000;</span>
<a href="#l42.308"></a><span id="l42.308">   return NS_OK;</span>
<a href="#l42.309"></a><span id="l42.309"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/local/src/nsRssIncomingServer.h</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/local/src/nsRssIncomingServer.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -13,31 +13,35 @@</span>
<a href="#l43.4"></a><span id="l43.4"> #include &quot;nsMailboxServer.h&quot;</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6"> class nsRssIncomingServer : public nsMailboxServer,</span>
<a href="#l43.7"></a><span id="l43.7">                             public nsIRssIncomingServer,</span>
<a href="#l43.8"></a><span id="l43.8">                             public nsILocalMailIncomingServer,</span>
<a href="#l43.9"></a><span id="l43.9">                             public nsIMsgFolderListener</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11"> {</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-public:</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-    NS_DECL_NSIRSSINCOMINGSERVER</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-    NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineminus">-    NS_DECL_NSIMSGFOLDERLISTENER</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ public:</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+  NS_DECL_NSIRSSINCOMINGSERVER</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+  NS_DECL_NSILOCALMAILINCOMINGSERVER</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+  NS_DECL_NSIMSGFOLDERLISTENER</span>
<a href="#l43.22"></a><span id="l43.22"> </span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">-    NS_IMETHOD GetOfflineSupportLevel(int32_t *aSupportLevel) override;</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineminus">-    NS_IMETHOD GetSupportsDiskSpace(bool *aSupportsDiskSpace) override;</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineminus">-    NS_IMETHOD GetAccountManagerChrome(nsAString&amp; aResult) override;</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineminus">-    NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineminus">-    NS_IMETHOD GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineminus">-    NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineminus">-    NS_IMETHOD GetSortOrder(int32_t* aSortOrder) override;</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+  NS_IMETHOD GetOfflineSupportLevel(int32_t *aSupportLevel) override;</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+  NS_IMETHOD GetSupportsDiskSpace(bool *aSupportsDiskSpace) override;</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+  NS_IMETHOD GetAccountManagerChrome(nsAString &amp;aResult) override;</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+  NS_IMETHOD PerformBiff(nsIMsgWindow *aMsgWindow) override;</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+  NS_IMETHOD GetServerRequiresPasswordForBiff(</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+      bool *aServerRequiresPasswordForBiff) override;</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+  NS_IMETHOD GetCanSearchMessages(bool *canSearchMessages) override;</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+  NS_IMETHOD GetSortOrder(int32_t *aSortOrder) override;</span>
<a href="#l43.38"></a><span id="l43.38"> </span>
<a href="#l43.39"></a><span id="l43.39" class="difflineminus">-    nsRssIncomingServer();</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">-protected:</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineminus">-    virtual ~nsRssIncomingServer();</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineminus">-    nsresult FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder, const char *aAction);</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineminus">-    nsresult FillInDataSourcePath(const nsAString&amp; aDataSourceName, nsIFile ** aLocation);</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineminus">-    static nsrefcnt gInstanceCount;</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+  nsRssIncomingServer();</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineplus">+</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+ protected:</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+  virtual ~nsRssIncomingServer();</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+  nsresult FolderChanged(nsIMsgFolder *aFolder, nsIMsgFolder *aOrigFolder,</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineplus">+                         const char *aAction);</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+  nsresult FillInDataSourcePath(const nsAString &amp;aDataSourceName,</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineplus">+                                nsIFile **aLocation);</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineplus">+  static nsrefcnt gInstanceCount;</span>
<a href="#l43.54"></a><span id="l43.54"> };</span>
<a href="#l43.55"></a><span id="l43.55"> </span>
<a href="#l43.56"></a><span id="l43.56"> #endif /* __nsRssIncomingServer_h */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/local/src/nsRssService.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/local/src/nsRssService.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -4,125 +4,110 @@</span>
<a href="#l44.4"></a><span id="l44.4"> </span>
<a href="#l44.5"></a><span id="l44.5"> #include &quot;nsRssService.h&quot;</span>
<a href="#l44.6"></a><span id="l44.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l44.7"></a><span id="l44.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l44.8"></a><span id="l44.8"> #include &quot;nsMailDirServiceDefs.h&quot;</span>
<a href="#l44.9"></a><span id="l44.9"> #include &quot;nsIProperties.h&quot;</span>
<a href="#l44.10"></a><span id="l44.10"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-nsRssService::nsRssService()</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-{</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-}</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+nsRssService::nsRssService() {}</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+nsRssService::~nsRssService() {}</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+NS_IMPL_ISUPPORTS(nsRssService, nsIRssService, nsIMsgProtocolInfo)</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+NS_IMETHODIMP nsRssService::GetDefaultLocalPath(nsIFile **aDefaultLocalPath) {</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDefaultLocalPath);</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+  *aDefaultLocalPath = nullptr;</span>
<a href="#l44.24"></a><span id="l44.24"> </span>
<a href="#l44.25"></a><span id="l44.25" class="difflineminus">-nsRssService::~nsRssService()</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineminus">-{</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+  nsCOMPtr&lt;nsIProperties&gt; dirService(</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+      do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+  if (!dirService) return NS_ERROR_FAILURE;</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+  dirService-&gt;Get(NS_APP_MAIL_50_DIR, NS_GET_IID(nsIFile),</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+                  getter_AddRefs(localFile));</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+  if (!localFile) return NS_ERROR_FAILURE;</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+  bool exists;</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+  nsresult rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+    rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineplus">+</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+  localFile.forget(aDefaultLocalPath);</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.43"></a><span id="l44.43"> }</span>
<a href="#l44.44"></a><span id="l44.44"> </span>
<a href="#l44.45"></a><span id="l44.45" class="difflineminus">-NS_IMPL_ISUPPORTS(nsRssService,</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineminus">-                   nsIRssService,</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineminus">-                   nsIMsgProtocolInfo)</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineminus">-</span>
<a href="#l44.49"></a><span id="l44.49" class="difflineminus">-NS_IMETHODIMP nsRssService::GetDefaultLocalPath(nsIFile * *aDefaultLocalPath)</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineminus">-{</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDefaultLocalPath);</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-    *aDefaultLocalPath = nullptr;</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineplus">+NS_IMETHODIMP nsRssService::SetDefaultLocalPath(nsIFile *aDefaultLocalPath) {</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+}</span>
<a href="#l44.56"></a><span id="l44.56"> </span>
<a href="#l44.57"></a><span id="l44.57" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineminus">-    nsCOMPtr&lt;nsIProperties&gt; dirService(do_GetService(&quot;@mozilla.org/file/directory_service;1&quot;));</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineminus">-    if (!dirService) return NS_ERROR_FAILURE;</span>
<a href="#l44.60"></a><span id="l44.60" class="difflineminus">-    dirService-&gt;Get(NS_APP_MAIL_50_DIR, NS_GET_IID(nsIFile), getter_AddRefs(localFile));</span>
<a href="#l44.61"></a><span id="l44.61" class="difflineminus">-    if (!localFile) return NS_ERROR_FAILURE;</span>
<a href="#l44.62"></a><span id="l44.62" class="difflineminus">-</span>
<a href="#l44.63"></a><span id="l44.63" class="difflineminus">-    bool exists;</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineminus">-    nsresult rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l44.66"></a><span id="l44.66" class="difflineminus">-        rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l44.67"></a><span id="l44.67" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineminus">-</span>
<a href="#l44.69"></a><span id="l44.69" class="difflineminus">-    localFile.forget(aDefaultLocalPath);</span>
<a href="#l44.70"></a><span id="l44.70" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.71"></a><span id="l44.71" class="difflineplus">+NS_IMETHODIMP nsRssService::GetServerIID(nsIID **aServerIID) {</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l44.73"></a><span id="l44.73"> }</span>
<a href="#l44.74"></a><span id="l44.74"> </span>
<a href="#l44.75"></a><span id="l44.75" class="difflineminus">-NS_IMETHODIMP nsRssService::SetDefaultLocalPath(nsIFile * aDefaultLocalPath)</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineminus">-{</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineminus">-}</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineminus">-</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-NS_IMETHODIMP nsRssService::GetServerIID(nsIID * *aServerIID)</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineminus">-{</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineplus">+NS_IMETHODIMP nsRssService::GetRequiresUsername(bool *aRequiresUsername) {</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineplus">+  *aRequiresUsername = false;</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.87"></a><span id="l44.87"> }</span>
<a href="#l44.88"></a><span id="l44.88"> </span>
<a href="#l44.89"></a><span id="l44.89" class="difflineminus">-NS_IMETHODIMP nsRssService::GetRequiresUsername(bool *aRequiresUsername)</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-{</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineminus">-    *aRequiresUsername = false;</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineminus">-}</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineminus">-</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineminus">-NS_IMETHODIMP nsRssService::GetPreflightPrettyNameWithEmailAddress(bool *aPreflightPrettyNameWithEmailAddress)</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineminus">-{</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+NS_IMETHODIMP nsRssService::GetPreflightPrettyNameWithEmailAddress(</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+    bool *aPreflightPrettyNameWithEmailAddress) {</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l44.102"></a><span id="l44.102"> }</span>
<a href="#l44.103"></a><span id="l44.103"> </span>
<a href="#l44.104"></a><span id="l44.104" class="difflineminus">-NS_IMETHODIMP nsRssService::GetCanDelete(bool *aCanDelete)</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineminus">-{</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineminus">-    *aCanDelete = true;</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+NS_IMETHODIMP nsRssService::GetCanDelete(bool *aCanDelete) {</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+  *aCanDelete = true;</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.113"></a><span id="l44.113"> }</span>
<a href="#l44.114"></a><span id="l44.114"> </span>
<a href="#l44.115"></a><span id="l44.115" class="difflineminus">-NS_IMETHODIMP nsRssService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp)</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineminus">-{</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineminus">-    *aCanLoginAtStartUp = false;</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineplus">+NS_IMETHODIMP nsRssService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp) {</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineplus">+  *aCanLoginAtStartUp = false;</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.124"></a><span id="l44.124"> }</span>
<a href="#l44.125"></a><span id="l44.125"> </span>
<a href="#l44.126"></a><span id="l44.126" class="difflineminus">-NS_IMETHODIMP nsRssService::GetCanDuplicate(bool *aCanDuplicate)</span>
<a href="#l44.127"></a><span id="l44.127" class="difflineminus">-{</span>
<a href="#l44.128"></a><span id="l44.128" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineminus">-    *aCanDuplicate = true;</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.131"></a><span id="l44.131" class="difflineplus">+NS_IMETHODIMP nsRssService::GetCanDuplicate(bool *aCanDuplicate) {</span>
<a href="#l44.132"></a><span id="l44.132" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l44.133"></a><span id="l44.133" class="difflineplus">+  *aCanDuplicate = true;</span>
<a href="#l44.134"></a><span id="l44.134" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.135"></a><span id="l44.135"> }</span>
<a href="#l44.136"></a><span id="l44.136"> </span>
<a href="#l44.137"></a><span id="l44.137" class="difflineminus">-NS_IMETHODIMP nsRssService::GetDefaultServerPort(bool isSecure, int32_t *_retval)</span>
<a href="#l44.138"></a><span id="l44.138" class="difflineminus">-{</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineminus">-    *_retval = -1;</span>
<a href="#l44.140"></a><span id="l44.140" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.141"></a><span id="l44.141" class="difflineplus">+NS_IMETHODIMP nsRssService::GetDefaultServerPort(bool isSecure,</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+                                                 int32_t *_retval) {</span>
<a href="#l44.143"></a><span id="l44.143" class="difflineplus">+  *_retval = -1;</span>
<a href="#l44.144"></a><span id="l44.144" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.145"></a><span id="l44.145"> }</span>
<a href="#l44.146"></a><span id="l44.146"> </span>
<a href="#l44.147"></a><span id="l44.147" class="difflineminus">-NS_IMETHODIMP nsRssService::GetCanGetMessages(bool *aCanGetMessages)</span>
<a href="#l44.148"></a><span id="l44.148" class="difflineminus">-{</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineminus">-    *aCanGetMessages = true;</span>
<a href="#l44.151"></a><span id="l44.151" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.152"></a><span id="l44.152" class="difflineplus">+NS_IMETHODIMP nsRssService::GetCanGetMessages(bool *aCanGetMessages) {</span>
<a href="#l44.153"></a><span id="l44.153" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l44.154"></a><span id="l44.154" class="difflineplus">+  *aCanGetMessages = true;</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.156"></a><span id="l44.156"> }</span>
<a href="#l44.157"></a><span id="l44.157"> </span>
<a href="#l44.158"></a><span id="l44.158" class="difflineminus">-NS_IMETHODIMP nsRssService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages)</span>
<a href="#l44.159"></a><span id="l44.159" class="difflineminus">-{</span>
<a href="#l44.160"></a><span id="l44.160" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineminus">-    *aCanGetIncomingMessages = true;</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.163"></a><span id="l44.163" class="difflineplus">+NS_IMETHODIMP nsRssService::GetCanGetIncomingMessages(</span>
<a href="#l44.164"></a><span id="l44.164" class="difflineplus">+    bool *aCanGetIncomingMessages) {</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineplus">+  *aCanGetIncomingMessages = true;</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.168"></a><span id="l44.168"> }</span>
<a href="#l44.169"></a><span id="l44.169"> </span>
<a href="#l44.170"></a><span id="l44.170" class="difflineminus">-NS_IMETHODIMP nsRssService::GetDefaultDoBiff(bool *aDefaultDoBiff)</span>
<a href="#l44.171"></a><span id="l44.171" class="difflineminus">-{</span>
<a href="#l44.172"></a><span id="l44.172" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDefaultDoBiff);</span>
<a href="#l44.173"></a><span id="l44.173" class="difflineminus">-    // by default, do biff for RSS feeds</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineminus">-    *aDefaultDoBiff = true;</span>
<a href="#l44.175"></a><span id="l44.175" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.176"></a><span id="l44.176" class="difflineplus">+NS_IMETHODIMP nsRssService::GetDefaultDoBiff(bool *aDefaultDoBiff) {</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDefaultDoBiff);</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineplus">+  // by default, do biff for RSS feeds</span>
<a href="#l44.179"></a><span id="l44.179" class="difflineplus">+  *aDefaultDoBiff = true;</span>
<a href="#l44.180"></a><span id="l44.180" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.181"></a><span id="l44.181"> }</span>
<a href="#l44.182"></a><span id="l44.182"> </span>
<a href="#l44.183"></a><span id="l44.183" class="difflineminus">-NS_IMETHODIMP nsRssService::GetShowComposeMsgLink(bool *aShowComposeMsgLink)</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineminus">-{</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aShowComposeMsgLink);</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineminus">-    *aShowComposeMsgLink = false;</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineminus">-    return NS_OK;</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+NS_IMETHODIMP nsRssService::GetShowComposeMsgLink(bool *aShowComposeMsgLink) {</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aShowComposeMsgLink);</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineplus">+  *aShowComposeMsgLink = false;</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+  return NS_OK;</span>
<a href="#l44.192"></a><span id="l44.192"> }</span>
<a href="#l44.193"></a><span id="l44.193"> </span>
<a href="#l44.194"></a><span id="l44.194" class="difflineminus">-NS_IMETHODIMP nsRssService::GetFoldersCreatedAsync(bool *aAsyncCreation)</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineminus">-{</span>
<a href="#l44.196"></a><span id="l44.196" class="difflineplus">+NS_IMETHODIMP nsRssService::GetFoldersCreatedAsync(bool *aAsyncCreation) {</span>
<a href="#l44.197"></a><span id="l44.197">   NS_ENSURE_ARG_POINTER(aAsyncCreation);</span>
<a href="#l44.198"></a><span id="l44.198">   *aAsyncCreation = false;</span>
<a href="#l44.199"></a><span id="l44.199">   return NS_OK;</span>
<a href="#l44.200"></a><span id="l44.200"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/local/src/nsRssService.h</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/local/src/nsRssService.h</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -3,23 +3,21 @@</span>
<a href="#l45.4"></a><span id="l45.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.5"></a><span id="l45.5"> </span>
<a href="#l45.6"></a><span id="l45.6"> #ifndef nsRssService_h___</span>
<a href="#l45.7"></a><span id="l45.7"> #define nsRssService_h___</span>
<a href="#l45.8"></a><span id="l45.8"> </span>
<a href="#l45.9"></a><span id="l45.9"> #include &quot;nsIRssService.h&quot;</span>
<a href="#l45.10"></a><span id="l45.10"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-class nsRssService : public nsIMsgProtocolInfo, public nsIRssService</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-{</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-public:</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineminus">-</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+class nsRssService : public nsIMsgProtocolInfo, public nsIRssService {</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+ public:</span>
<a href="#l45.18"></a><span id="l45.18">   nsRssService();</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20">   NS_DECL_ISUPPORTS</span>
<a href="#l45.21"></a><span id="l45.21">   NS_DECL_NSIRSSSERVICE</span>
<a href="#l45.22"></a><span id="l45.22">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l45.23"></a><span id="l45.23"> </span>
<a href="#l45.24"></a><span id="l45.24" class="difflineminus">-private:</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+ private:</span>
<a href="#l45.26"></a><span id="l45.26">   virtual ~nsRssService();</span>
<a href="#l45.27"></a><span id="l45.27"> };</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29"> #endif /* nsRssService_h___ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

