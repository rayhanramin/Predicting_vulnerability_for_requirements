<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21286:6c8ca70fc623f516dcf414226cc3f5dbe5502dd0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6c8ca70fc623f516dcf414226cc3f5dbe5502dd0" />
<meta property="og:url" content="/comm-central/rev/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0" />
<meta property="og:description" content="Bug 1336804 - Synchronize the TB installer.nsi, shared.nsh and updater_append.ini with the Firefox versions. r+a=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6c8ca70fc623f516dcf414226cc3f5dbe5502dd0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">shortlog</a> |
<a href="/comm-central/log/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">files</a> |
changeset |
<a href="/comm-central/raw-rev/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">raw</a>  | <a href="/comm-central/archive/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1336804">Bug 1336804</a> - Synchronize the TB installer.nsi, shared.nsh and updater_append.ini with the Firefox versions. r+a=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#82;&#105;&#99;&#104;&#97;&#114;&#100;&#32;&#77;&#97;&#114;&#116;&#105;&#32;&#60;&#114;&#105;&#99;&#104;&#97;&#114;&#100;&#46;&#109;&#97;&#114;&#116;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 07 Feb 2017 21:15:50 +0100</td></tr>

<tr>
 <td>changeset 21286</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">6c8ca70fc623f516dcf414226cc3f5dbe5502dd0</a></td>
</tr>



<tr>
<td>parent 21285</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d005000364d48c33c17e2c83cd11242320d81cde">d005000364d48c33c17e2c83cd11242320d81cde</a>
</td>
</tr>

<tr>
<td>child 21287</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/21cd0f3254e5f9733647f53e32b2b704373d0e0d">21cd0f3254e5f9733647f53e32b2b704373d0e0d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">12935</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 11 Mar 2017 08:10:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6c8ca70fc623 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6c8ca70fc623f516dcf414226cc3f5dbe5502dd0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6c8ca70fc623f516dcf414226cc3f5dbe5502dd0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c8ca70fc623f516dcf414226cc3f5dbe5502dd0&newProject=comm-central&newRevision=671537074650c774078be7374aa61145405099b8&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c8ca70fc623f516dcf414226cc3f5dbe5502dd0&newProject=comm-central&newRevision=671537074650c774078be7374aa61145405099b8&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6c8ca70fc623f516dcf414226cc3f5dbe5502dd0&newProject=comm-central&newRevision=671537074650c774078be7374aa61145405099b8&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1336804">1336804</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1336804">Bug 1336804</a> - Synchronize the TB installer.nsi, shared.nsh and updater_append.ini with the Firefox versions. r+a=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/installer.nsi">mail/installer/windows/nsis/installer.nsi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/installer.nsi">file</a> |
<a href="/comm-central/annotate/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/installer.nsi">annotate</a> |
<a href="/comm-central/diff/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/installer.nsi">diff</a> |
<a href="/comm-central/comparison/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/installer.nsi">comparison</a> |
<a href="/comm-central/log/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/installer.nsi">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/shared.nsh">mail/installer/windows/nsis/shared.nsh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/shared.nsh">file</a> |
<a href="/comm-central/annotate/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/shared.nsh">annotate</a> |
<a href="/comm-central/diff/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/shared.nsh">diff</a> |
<a href="/comm-central/comparison/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/shared.nsh">comparison</a> |
<a href="/comm-central/log/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/shared.nsh">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/updater_append.ini">mail/installer/windows/nsis/updater_append.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/updater_append.ini">file</a> |
<a href="/comm-central/annotate/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/updater_append.ini">annotate</a> |
<a href="/comm-central/diff/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/updater_append.ini">diff</a> |
<a href="/comm-central/comparison/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/updater_append.ini">comparison</a> |
<a href="/comm-central/log/6c8ca70fc623f516dcf414226cc3f5dbe5502dd0/mail/installer/windows/nsis/updater_append.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/installer/windows/nsis/installer.nsi</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/installer/windows/nsis/installer.nsi</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,106 +1,109 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.5"></a><span id="l1.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.6"></a><span id="l1.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # Required Plugins:</span>
<a href="#l1.9"></a><span id="l1.9"> # AppAssocReg    http://nsis.sourceforge.net/Application_Association_Registration_plug-in</span>
<a href="#l1.10"></a><span id="l1.10"> # ApplicationID  http://nsis.sourceforge.net/ApplicationID_plug-in</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-# CityHash       http://mxr.mozilla.org/mozilla-central/source/other-licenses/nsis/Contrib/CityHash</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+# CityHash       http://dxr.mozilla.org/mozilla-central/source/other-licenses/nsis/Contrib/CityHash</span>
<a href="#l1.13"></a><span id="l1.13"> # ShellLink      http://nsis.sourceforge.net/ShellLink_plug-in</span>
<a href="#l1.14"></a><span id="l1.14"> # UAC            http://nsis.sourceforge.net/UAC_plug-in</span>
<a href="#l1.15"></a><span id="l1.15"> # ServicesHelper Mozilla specific plugin that is located in /other-licenses/nsis</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> ; Set verbosity to 3 (e.g. no script) to lessen the noise in the build logs</span>
<a href="#l1.18"></a><span id="l1.18"> !verbose 3</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> ; 7-Zip provides better compression than the lzma from NSIS so we add the files</span>
<a href="#l1.21"></a><span id="l1.21"> ; uncompressed and use 7-Zip to create a SFX archive of it</span>
<a href="#l1.22"></a><span id="l1.22"> SetDatablockOptimize on</span>
<a href="#l1.23"></a><span id="l1.23"> SetCompress off</span>
<a href="#l1.24"></a><span id="l1.24"> CRCCheck on</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> RequestExecutionLevel user</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-; The commands inside this ifdef require NSIS 3.0a2 or greater so the ifdef can</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-; be removed after we require NSIS 3.0a2 or greater.</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-!ifdef NSIS_PACKEDVERSION</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  Unicode true</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  ManifestSupportedOS all</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  ManifestDPIAware true</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-!endif</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+Unicode true</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+ManifestSupportedOS all</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+ManifestDPIAware true</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> !addplugindir ./</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> Var TmpVal</span>
<a href="#l1.42"></a><span id="l1.42"> Var InstallType</span>
<a href="#l1.43"></a><span id="l1.43"> Var AddStartMenuSC</span>
<a href="#l1.44"></a><span id="l1.44"> Var AddTaskbarSC</span>
<a href="#l1.45"></a><span id="l1.45"> Var AddQuickLaunchSC</span>
<a href="#l1.46"></a><span id="l1.46"> Var AddDesktopSC</span>
<a href="#l1.47"></a><span id="l1.47"> Var InstallMaintenanceService</span>
<a href="#l1.48"></a><span id="l1.48"> Var PageName</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+Var PreventRebootRequired</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51"> ; By defining NO_STARTMENU_DIR an installer that doesn't provide an option for</span>
<a href="#l1.52"></a><span id="l1.52"> ; an application's Start Menu PROGRAMS directory and doesn't define the</span>
<a href="#l1.53"></a><span id="l1.53"> ; StartMenuDir variable can use the common InstallOnInitCommon macro.</span>
<a href="#l1.54"></a><span id="l1.54"> !define NO_STARTMENU_DIR</span>
<a href="#l1.55"></a><span id="l1.55"> </span>
<a href="#l1.56"></a><span id="l1.56"> ; Attempt to elevate Standard Users in addition to users that</span>
<a href="#l1.57"></a><span id="l1.57"> ; are a member of the Administrators group.</span>
<a href="#l1.58"></a><span id="l1.58"> !define NONADMIN_ELEVATE</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-; Disabled until a survey url is provided</span>
<a href="#l1.61"></a><span id="l1.61"> !define AbortSurveyURL &quot;http://live.mozillamessaging.com/survey/cancel/?page=&quot;</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63"> ; Other included files may depend upon these includes!</span>
<a href="#l1.64"></a><span id="l1.64"> ; The following includes are provided by NSIS.</span>
<a href="#l1.65"></a><span id="l1.65"> !include FileFunc.nsh</span>
<a href="#l1.66"></a><span id="l1.66"> !include LogicLib.nsh</span>
<a href="#l1.67"></a><span id="l1.67"> !include MUI.nsh</span>
<a href="#l1.68"></a><span id="l1.68"> !include WinMessages.nsh</span>
<a href="#l1.69"></a><span id="l1.69"> !include WinVer.nsh</span>
<a href="#l1.70"></a><span id="l1.70"> !include WordFunc.nsh</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> !insertmacro GetOptions</span>
<a href="#l1.73"></a><span id="l1.73"> !insertmacro GetParameters</span>
<a href="#l1.74"></a><span id="l1.74"> !insertmacro GetSize</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+!insertmacro StrFilter</span>
<a href="#l1.76"></a><span id="l1.76"> !insertmacro WordFind</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+!insertmacro WordReplace</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79"> ; The following includes are custom.</span>
<a href="#l1.80"></a><span id="l1.80"> !include branding.nsi</span>
<a href="#l1.81"></a><span id="l1.81"> !include defines.nsi</span>
<a href="#l1.82"></a><span id="l1.82"> !include common.nsh</span>
<a href="#l1.83"></a><span id="l1.83"> !include locales.nsi</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-VIAddVersionKey &quot;FileDescription&quot;  &quot;${BrandShortName} Installer&quot;</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+VIAddVersionKey &quot;FileDescription&quot; &quot;${BrandShortName} Installer&quot;</span>
<a href="#l1.87"></a><span id="l1.87"> VIAddVersionKey &quot;OriginalFilename&quot; &quot;setup.exe&quot;</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89"> ; Must be inserted before other macros that use logging</span>
<a href="#l1.90"></a><span id="l1.90"> !insertmacro _LoggingCommon</span>
<a href="#l1.91"></a><span id="l1.91"> </span>
<a href="#l1.92"></a><span id="l1.92"> !insertmacro AddHandlerValues</span>
<a href="#l1.93"></a><span id="l1.93"> !insertmacro ChangeMUIHeaderImage</span>
<a href="#l1.94"></a><span id="l1.94"> !insertmacro CheckForFilesInUse</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-!insertmacro CleanUpdatesDir</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+!insertmacro CleanUpdateDirectories</span>
<a href="#l1.97"></a><span id="l1.97"> !insertmacro CopyFilesFromDir</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+!insertmacro CreateRegKey</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+!insertmacro GetLongPath</span>
<a href="#l1.100"></a><span id="l1.100"> !insertmacro GetPathFromString</span>
<a href="#l1.101"></a><span id="l1.101"> !insertmacro GetParent</span>
<a href="#l1.102"></a><span id="l1.102"> !insertmacro InitHashAppModelId</span>
<a href="#l1.103"></a><span id="l1.103"> !insertmacro IsHandlerForInstallDir</span>
<a href="#l1.104"></a><span id="l1.104"> !insertmacro IsPinnedToTaskBar</span>
<a href="#l1.105"></a><span id="l1.105"> !insertmacro IsUserAdmin</span>
<a href="#l1.106"></a><span id="l1.106"> !insertmacro LogDesktopShortcut</span>
<a href="#l1.107"></a><span id="l1.107"> !insertmacro LogQuickLaunchShortcut</span>
<a href="#l1.108"></a><span id="l1.108"> !insertmacro LogStartMenuShortcut</span>
<a href="#l1.109"></a><span id="l1.109"> !insertmacro ManualCloseAppPrompt</span>
<a href="#l1.110"></a><span id="l1.110"> !insertmacro PinnedToStartMenuLnkCount</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+!insertmacro RegCleanAppHandler</span>
<a href="#l1.112"></a><span id="l1.112"> !insertmacro RegCleanMain</span>
<a href="#l1.113"></a><span id="l1.113"> !insertmacro RegCleanUninstall</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+!insertmacro RemovePrecompleteEntries</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+!insertmacro SetAppLSPCategories</span>
<a href="#l1.116"></a><span id="l1.116"> !insertmacro SetBrandNameVars</span>
<a href="#l1.117"></a><span id="l1.117"> !insertmacro UpdateShortcutAppModelIDs</span>
<a href="#l1.118"></a><span id="l1.118"> !insertmacro UnloadUAC</span>
<a href="#l1.119"></a><span id="l1.119"> !insertmacro WriteRegStr2</span>
<a href="#l1.120"></a><span id="l1.120"> !insertmacro WriteRegDWORD2</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122"> !include shared.nsh</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124" class="difflineat">@@ -190,54 +193,81 @@ ChangeUI IDD_VERIFY &quot;${NSISDIR}\Contrib\</span>
<a href="#l1.125"></a><span id="l1.125"> Section &quot;-InstallStartCleanup&quot;</span>
<a href="#l1.126"></a><span id="l1.126">   SetDetailsPrint both</span>
<a href="#l1.127"></a><span id="l1.127">   DetailPrint $(STATUS_CLEANUP)</span>
<a href="#l1.128"></a><span id="l1.128">   SetDetailsPrint none</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">   SetOutPath &quot;$INSTDIR&quot;</span>
<a href="#l1.131"></a><span id="l1.131">   ${StartInstallLog} &quot;${BrandFullName}&quot; &quot;${AB_CD}&quot; &quot;${AppVersion}&quot; &quot;${GREVersion}&quot;</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  ; Delete the app exe to prevent launching the app while we are installing.</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+  StrCpy $R9 &quot;true&quot;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+  StrCpy $PreventRebootRequired &quot;false&quot;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+  ${GetParameters} $R8</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  ${GetOptions} &quot;$R8&quot; &quot;/INI=&quot; $R7</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  ${Unless} ${Errors}</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+    ; The configuration file must also exist</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    ${If} ${FileExists} &quot;$R7&quot;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+      ReadINIStr $R9 $R7 &quot;Install&quot; &quot;RemoveDistributionDir&quot;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+      ReadINIStr $R8 $R7 &quot;Install&quot; &quot;PreventRebootRequired&quot;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+      ${If} $R8 == &quot;true&quot;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+        StrCpy $PreventRebootRequired &quot;true&quot;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+      ${EndIf}</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+    ${EndIf}</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  ${EndUnless}</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+  ; Remove directories and files we always control before parsing the uninstall</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  ; log so empty directories can be removed.</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\updates&quot;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+    RmDir /r &quot;$INSTDIR\updates&quot;</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\updated&quot;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+    RmDir /r &quot;$INSTDIR\updated&quot;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\defaults\shortcuts&quot;</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    RmDir /r &quot;$INSTDIR\defaults\shortcuts&quot;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+  ; Only remove the distribution directory if it exists and if the installer</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+  ; isn't launched with an ini file that has RemoveDistributionDir=false in the</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+  ; install section.</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+  ${If} ${FileExists} &quot;$INSTDIR\distribution&quot;</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+  ${AndIf} $R9 != &quot;false&quot;</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+    RmDir /r &quot;$INSTDIR\distribution&quot;</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+  ; Delete the app exe if present to prevent launching the app while we are</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+  ; installing.</span>
<a href="#l1.170"></a><span id="l1.170">   ClearErrors</span>
<a href="#l1.171"></a><span id="l1.171">   ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.172"></a><span id="l1.172">   ${If} ${Errors}</span>
<a href="#l1.173"></a><span id="l1.173">     ; If the user closed the application it can take several seconds for it to</span>
<a href="#l1.174"></a><span id="l1.174">     ; shut down completely. If the application is being used by another user we</span>
<a href="#l1.175"></a><span id="l1.175">     ; can rename the file and then delete is when the system is restarted.</span>
<a href="#l1.176"></a><span id="l1.176">     Sleep 5000</span>
<a href="#l1.177"></a><span id="l1.177">     ${DeleteFile} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.178"></a><span id="l1.178">     ClearErrors</span>
<a href="#l1.179"></a><span id="l1.179">   ${EndIf}</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+  ; setup the application model id registration value</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+  ${InitHashAppModelId} &quot;$INSTDIR&quot; &quot;Software\Mozilla\${AppName}\TaskBarIDs&quot;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+  ; Remove the updates directory</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+  ${CleanUpdateDirectories} &quot;Thunderbird&quot; &quot;Thunderbird\updates&quot;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+  ; Upgrade the copies of the MAPI DLL's</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+  ${UpgradeMapiDLLs}</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+</span>
<a href="#l1.190"></a><span id="l1.190">   ; Delete two files installed by Kaspersky Anti-Spam extension that are only</span>
<a href="#l1.191"></a><span id="l1.191">   ; compatible with Thunderbird 2 (bug 533692).</span>
<a href="#l1.192"></a><span id="l1.192">   ${If} ${FileExists} &quot;$INSTDIR\components\klthbplg.dll&quot;</span>
<a href="#l1.193"></a><span id="l1.193">     Delete /REBOOTOK &quot;$INSTDIR\components\klthbplg.dll&quot;</span>
<a href="#l1.194"></a><span id="l1.194">   ${EndIf}</span>
<a href="#l1.195"></a><span id="l1.195">   ${If} ${FileExists} &quot;$INSTDIR\components\IKLAntiSpam.xpt&quot;</span>
<a href="#l1.196"></a><span id="l1.196">     Delete /REBOOTOK &quot;$INSTDIR\components\IKLAntiSpam.xpt&quot;</span>
<a href="#l1.197"></a><span id="l1.197">   ${EndIf}</span>
<a href="#l1.198"></a><span id="l1.198"> </span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  ; Remove the updates directory</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-  ${CleanUpdatesDir} &quot;Thunderbird&quot;</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  ${GetParameters} $0</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-  ${GetOptions} &quot;$0&quot; &quot;/INI=&quot; $1</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  ${Unless} ${Errors}</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-    ; The configuration file must also exist</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-    ${If} ${FileExists} &quot;$1&quot;</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-      ReadINIStr $0 $1 &quot;Install&quot; &quot;RemoveDistributionDir&quot;</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-    ${EndIf}</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-  ${EndUnless}</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\distribution&quot;</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-  ${AndIf} $0 != &quot;false&quot;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-    RmDir /r &quot;$INSTDIR\distribution&quot;</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-  ${EndIf}</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-</span>
<a href="#l1.216"></a><span id="l1.216">   ${InstallStartCleanupCommon}</span>
<a href="#l1.217"></a><span id="l1.217"> SectionEnd</span>
<a href="#l1.218"></a><span id="l1.218"> </span>
<a href="#l1.219"></a><span id="l1.219"> Section &quot;-Application&quot; APP_IDX</span>
<a href="#l1.220"></a><span id="l1.220">   ${StartUninstallLog}</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222">   SetDetailsPrint both</span>
<a href="#l1.223"></a><span id="l1.223">   DetailPrint $(STATUS_INSTALL_APP)</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineat">@@ -335,19 +365,16 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l1.225"></a><span id="l1.225">     SetShellVarContext all  ; Set SHCTX to HKLM</span>
<a href="#l1.226"></a><span id="l1.226">     DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l1.227"></a><span id="l1.227">     StrCpy $TmpVal &quot;HKLM&quot; ; used primarily for logging</span>
<a href="#l1.228"></a><span id="l1.228">     ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l1.229"></a><span id="l1.229">     ${RegCleanUninstall}</span>
<a href="#l1.230"></a><span id="l1.230">     ${UpdateProtocolHandlers}</span>
<a href="#l1.231"></a><span id="l1.231">   ${EndIf}</span>
<a href="#l1.232"></a><span id="l1.232"> </span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-  ; setup the application model id registration value</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-  ${InitHashAppModelId} &quot;$INSTDIR&quot; &quot;Software\Mozilla\${AppName}\TaskBarIDs&quot;</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-</span>
<a href="#l1.236"></a><span id="l1.236">   ${RemoveDeprecatedKeys}</span>
<a href="#l1.237"></a><span id="l1.237"> </span>
<a href="#l1.238"></a><span id="l1.238">   ; The previous installer adds several regsitry values to both HKLM and HKCU.</span>
<a href="#l1.239"></a><span id="l1.239">   ; We now try to add to HKLM and if that fails to HKCU</span>
<a href="#l1.240"></a><span id="l1.240"> </span>
<a href="#l1.241"></a><span id="l1.241">   ; The order that reg keys and values are added is important if you use the</span>
<a href="#l1.242"></a><span id="l1.242">   ; uninstall log to remove them on uninstall. When using the uninstall log you</span>
<a href="#l1.243"></a><span id="l1.243">   ; MUST add children first so they will be removed first on uninstall so they</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineat">@@ -371,51 +398,44 @@ Section &quot;-Application&quot; APP_IDX</span>
<a href="#l1.245"></a><span id="l1.245">   ; protocol handler</span>
<a href="#l1.246"></a><span id="l1.246">   ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot;  &quot;$1&quot; &quot;$8,0&quot; \</span>
<a href="#l1.247"></a><span id="l1.247">                       &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l1.248"></a><span id="l1.248">   ${AddHandlerValues} &quot;$0\Thunderbird.Url.mailto&quot;  &quot;$2&quot; &quot;$8,0&quot; \</span>
<a href="#l1.249"></a><span id="l1.249">                       &quot;${AppRegNameMail} URL&quot; &quot;delete&quot; &quot;&quot;</span>
<a href="#l1.250"></a><span id="l1.250">   ${AddHandlerValues} &quot;$0\Thunderbird.Url.news&quot; &quot;$3&quot; &quot;$8,0&quot; \</span>
<a href="#l1.251"></a><span id="l1.251">                       &quot;${AppRegNameNews} URL&quot; &quot;delete&quot; &quot;&quot;</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-  ; The following keys should only be set if we can write to HKLM</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+  ; For pre win8, the following keys should only be set if we can write to HKLM.</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+  ; For post win8, the keys below can be set in HKCU if needed.</span>
<a href="#l1.256"></a><span id="l1.256">   ${If} $TmpVal == &quot;HKLM&quot;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-    ; Set the Start Menu Internet and Registered App HKLM registry keys.</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-    ${SetClientsMail}</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-    ${SetClientsNews}</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-    ; If we are writing to HKLM and create either the desktop or start menu</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-    ; shortcuts set IconsVisible to 1 otherwise to 0.</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-    ; Taskbar shortcuts imply having a start menu shortcut.</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-    StrCpy $0 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-    ${If} $AddDesktopSC == 1</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-    ${OrIf} $AddStartMenuSC == 1</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-    ${OrIf} $AddTaskbarSC == 1</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-      WriteRegDWORD HKLM &quot;$0&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-    ${Else}</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-      WriteRegDWORD HKLM &quot;$0&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-    ${EndIf}</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+    ; Set the Start Menu Mail/News and Registered App HKLM registry keys.</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+    ${SetClientsMail} &quot;HKLM&quot;</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+    ${SetClientsNews} &quot;HKLM&quot;</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+  ${ElseIf} ${AtLeastWin8}</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+    ; Set the Start Menu Mail/News and Registered App HKCU registry keys.</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+    ${SetClientsMail} &quot;HKCU&quot;</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+    ${SetClientsNews} &quot;HKCU&quot;</span>
<a href="#l1.279"></a><span id="l1.279">   ${EndIf}</span>
<a href="#l1.280"></a><span id="l1.280"> </span>
<a href="#l1.281"></a><span id="l1.281"> !ifdef MOZ_MAINTENANCE_SERVICE</span>
<a href="#l1.282"></a><span id="l1.282">   ; If the maintenance service page was displayed then a value was already</span>
<a href="#l1.283"></a><span id="l1.283">   ; explicitly selected for installing the maintenance service and</span>
<a href="#l1.284"></a><span id="l1.284">   ; and so InstallMaintenanceService will already be 0 or 1.</span>
<a href="#l1.285"></a><span id="l1.285">   ; If the maintenance service page was not displayed then</span>
<a href="#l1.286"></a><span id="l1.286">   ; InstallMaintenanceService will be equal to &quot;&quot;.</span>
<a href="#l1.287"></a><span id="l1.287">   ${If} $InstallMaintenanceService == &quot;&quot;</span>
<a href="#l1.288"></a><span id="l1.288">     Call IsUserAdmin</span>
<a href="#l1.289"></a><span id="l1.289">     Pop $R0</span>
<a href="#l1.290"></a><span id="l1.290">     ${If} $R0 == &quot;true&quot;</span>
<a href="#l1.291"></a><span id="l1.291">     ; Only proceed if we have HKLM write access</span>
<a href="#l1.292"></a><span id="l1.292">     ${AndIf} $TmpVal == &quot;HKLM&quot;</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-      ; The user is an admin so we should default to install service yes</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+      ; The user is an admin, so we should default to installing the service.</span>
<a href="#l1.295"></a><span id="l1.295">       StrCpy $InstallMaintenanceService &quot;1&quot;</span>
<a href="#l1.296"></a><span id="l1.296">     ${Else}</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-      ; The user is not admin so we should default to install service no</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+      ; The user is not admin, so we can't install the service.</span>
<a href="#l1.299"></a><span id="l1.299">       StrCpy $InstallMaintenanceService &quot;0&quot;</span>
<a href="#l1.300"></a><span id="l1.300">     ${EndIf}</span>
<a href="#l1.301"></a><span id="l1.301">   ${EndIf}</span>
<a href="#l1.302"></a><span id="l1.302"> </span>
<a href="#l1.303"></a><span id="l1.303">   ${If} $InstallMaintenanceService == &quot;1&quot;</span>
<a href="#l1.304"></a><span id="l1.304">     ; The user wants to install the maintenance service, so execute</span>
<a href="#l1.305"></a><span id="l1.305">     ; the pre-packaged maintenance service installer.</span>
<a href="#l1.306"></a><span id="l1.306">     ; This option can only be turned on if the user is an admin so there</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineat">@@ -541,16 +561,17 @@ SectionEnd</span>
<a href="#l1.308"></a><span id="l1.308"> </span>
<a href="#l1.309"></a><span id="l1.309"> ; Cleanup operations to perform at the end of the installation.</span>
<a href="#l1.310"></a><span id="l1.310"> Section &quot;-InstallEndCleanup&quot;</span>
<a href="#l1.311"></a><span id="l1.311">   SetDetailsPrint both</span>
<a href="#l1.312"></a><span id="l1.312">   DetailPrint &quot;$(STATUS_CLEANUP)&quot;</span>
<a href="#l1.313"></a><span id="l1.313">   SetDetailsPrint none</span>
<a href="#l1.314"></a><span id="l1.314"> </span>
<a href="#l1.315"></a><span id="l1.315">   ${Unless} ${Silent}</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+    ClearErrors</span>
<a href="#l1.317"></a><span id="l1.317">     ${MUI_INSTALLOPTIONS_READ} $0 &quot;options.ini&quot; &quot;Field 6&quot; &quot;State&quot;</span>
<a href="#l1.318"></a><span id="l1.318">     ${If} &quot;$0&quot; == &quot;1&quot;</span>
<a href="#l1.319"></a><span id="l1.319">       ${LogHeader} &quot;Setting as the default mail application&quot;</span>
<a href="#l1.320"></a><span id="l1.320">       ClearErrors</span>
<a href="#l1.321"></a><span id="l1.321">       ${GetParameters} $0</span>
<a href="#l1.322"></a><span id="l1.322">       ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l1.323"></a><span id="l1.323">       ${If} ${Errors}</span>
<a href="#l1.324"></a><span id="l1.324">         Call SetAsDefaultMailAppUserHKCU</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineat">@@ -564,58 +585,67 @@ Section &quot;-InstallEndCleanup&quot;</span>
<a href="#l1.326"></a><span id="l1.326">   ; Adds a pinned Task Bar shortcut (see MigrateTaskBarShortcut for details).</span>
<a href="#l1.327"></a><span id="l1.327">   ${MigrateTaskBarShortcut}</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329">   ; Refresh desktop icons</span>
<a href="#l1.330"></a><span id="l1.330">   System::Call &quot;shell32::SHChangeNotify(i 0x08000000, i 0, i 0, i 0)&quot;</span>
<a href="#l1.331"></a><span id="l1.331"> </span>
<a href="#l1.332"></a><span id="l1.332">   ${InstallEndCleanupCommon}</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+  ${If} $PreventRebootRequired == &quot;true&quot;</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+    SetRebootFlag false</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+  ${EndIf}</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+</span>
<a href="#l1.338"></a><span id="l1.338">   ${If} ${RebootFlag}</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-    ; If we have to reboot give SHChangeNotify time to finish refreshing</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-    ; the icons so the OS doesn't display the icons from helper.exe</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-    Sleep 10000</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-    ${LogHeader} &quot;Reboot Required To Finish Installation&quot;</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-    ; ${FileMainEXE}.moz-upgrade should never exist but just in case...</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-    ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-      Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-    ${EndUnless}</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+    ; Admin is required to delete files on reboot so only add the moz-delete if</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+    ; the user is an admin. After calling UAC::IsAdmin $0 will equal 1 if the</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+    ; user is an admin.</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+    UAC::IsAdmin</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+    ${If} &quot;$0&quot; == &quot;1&quot;</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+      ; When a reboot is required give SHChangeNotify time to finish the</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+      ; refreshing the icons so the OS doesn't display the icons from helper.exe</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+      Sleep 10000</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+      ${LogHeader} &quot;Reboot Required To Finish Installation&quot;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+      ; ${FileMainEXE}.moz-upgrade should never exist but just in case...</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+      ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+        Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+      ${EndUnless}</span>
<a href="#l1.360"></a><span id="l1.360"> </span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-    ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-      ClearErrors</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-      Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-      ${Unless} ${Errors}</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-        Delete /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+      ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+        ClearErrors</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+        Rename &quot;$INSTDIR\${FileMainEXE}&quot; &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+        ${Unless} ${Errors}</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+          Delete /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot;</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+        ${EndUnless}</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+      ${EndIf}</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+      ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineplus">+        CopyFiles /SILENT &quot;$INSTDIR\uninstall\helper.exe&quot; &quot;$INSTDIR&quot;</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineplus">+        FileOpen $0 &quot;$INSTDIR\${FileMainEXE}&quot; w</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+        FileWrite $0 &quot;Will be deleted on restart&quot;</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+        Rename /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineplus">+        FileClose $0</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+        Delete &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+        Rename &quot;$INSTDIR\helper.exe&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.382"></a><span id="l1.382">       ${EndUnless}</span>
<a href="#l1.383"></a><span id="l1.383">     ${EndIf}</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    ${Unless} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-      CopyFiles /SILENT &quot;$INSTDIR\uninstall\helper.exe&quot; &quot;$INSTDIR&quot;</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-      FileOpen $0 &quot;$INSTDIR\${FileMainEXE}&quot; w</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-      FileWrite $0 &quot;Will be deleted on restart&quot;</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-      Rename /REBOOTOK &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-      FileClose $0</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-      Delete &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-      Rename &quot;$INSTDIR\helper.exe&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-    ${EndUnless}</span>
<a href="#l1.394"></a><span id="l1.394">   ${EndIf}</span>
<a href="#l1.395"></a><span id="l1.395"> SectionEnd</span>
<a href="#l1.396"></a><span id="l1.396"> </span>
<a href="#l1.397"></a><span id="l1.397"> ################################################################################</span>
<a href="#l1.398"></a><span id="l1.398"> # Install Abort Survey Functions</span>
<a href="#l1.399"></a><span id="l1.399"> </span>
<a href="#l1.400"></a><span id="l1.400"> Function CustomAbort</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-!ifdef AbortSurveyURL</span>
<a href="#l1.402"></a><span id="l1.402">   ${If} &quot;${AB_CD}&quot; == &quot;en-US&quot;</span>
<a href="#l1.403"></a><span id="l1.403">   ${AndIf} &quot;$PageName&quot; != &quot;&quot;</span>
<a href="#l1.404"></a><span id="l1.404">   ${AndIf} ${FileExists} &quot;$EXEDIR\core\distribution\distribution.ini&quot;</span>
<a href="#l1.405"></a><span id="l1.405">     ReadINIStr $0 &quot;$EXEDIR\core\distribution\distribution.ini&quot; &quot;Global&quot; &quot;about&quot;</span>
<a href="#l1.406"></a><span id="l1.406">     ClearErrors</span>
<a href="#l1.407"></a><span id="l1.407">     ${WordFind} &quot;$0&quot; &quot;Funnelcake&quot; &quot;E#&quot; $1</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-   ${Unless} ${Errors}</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+    ${Unless} ${Errors}</span>
<a href="#l1.410"></a><span id="l1.410">       ; Yes = fill out the survey and exit, No = don't fill out survey and exit,</span>
<a href="#l1.411"></a><span id="l1.411">       ; Cancel = don't exit.</span>
<a href="#l1.412"></a><span id="l1.412">       MessageBox MB_YESNO|MB_ICONEXCLAMATION \</span>
<a href="#l1.413"></a><span id="l1.413">                  &quot;Would you like to tell us why you are canceling this installation?&quot; \</span>
<a href="#l1.414"></a><span id="l1.414">                  IDYes +1 IDNO CustomAbort_finish</span>
<a href="#l1.415"></a><span id="l1.415">       ${If} &quot;$PageName&quot; == &quot;Welcome&quot;</span>
<a href="#l1.416"></a><span id="l1.416">           GetFunctionAddress $0 AbortSurveyWelcome</span>
<a href="#l1.417"></a><span id="l1.417">       ${ElseIf} &quot;$PageName&quot; == &quot;Options&quot;</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineat">@@ -635,25 +665,23 @@ Function CustomAbort</span>
<a href="#l1.419"></a><span id="l1.419">       ${Else}</span>
<a href="#l1.420"></a><span id="l1.420">         UAC::ExecCodeSegment $0</span>
<a href="#l1.421"></a><span id="l1.421">       ${EndIf}</span>
<a href="#l1.422"></a><span id="l1.422"> </span>
<a href="#l1.423"></a><span id="l1.423">       CustomAbort_finish:</span>
<a href="#l1.424"></a><span id="l1.424">       Return</span>
<a href="#l1.425"></a><span id="l1.425">     ${EndUnless}</span>
<a href="#l1.426"></a><span id="l1.426">   ${EndIf}</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-!endif</span>
<a href="#l1.428"></a><span id="l1.428"> </span>
<a href="#l1.429"></a><span id="l1.429">   MessageBox MB_YESNO|MB_ICONEXCLAMATION &quot;$(MOZ_MUI_TEXT_ABORTWARNING)&quot; \</span>
<a href="#l1.430"></a><span id="l1.430">              IDYES +1 IDNO +2</span>
<a href="#l1.431"></a><span id="l1.431">   Return</span>
<a href="#l1.432"></a><span id="l1.432">   Abort</span>
<a href="#l1.433"></a><span id="l1.433"> FunctionEnd</span>
<a href="#l1.434"></a><span id="l1.434"> </span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-!ifdef AbortSurveyURL</span>
<a href="#l1.436"></a><span id="l1.436"> Function AbortSurveyWelcome</span>
<a href="#l1.437"></a><span id="l1.437">   ExecShell &quot;open&quot; &quot;${AbortSurveyURL}step1&quot;</span>
<a href="#l1.438"></a><span id="l1.438"> FunctionEnd</span>
<a href="#l1.439"></a><span id="l1.439"> </span>
<a href="#l1.440"></a><span id="l1.440"> Function AbortSurveyOptions</span>
<a href="#l1.441"></a><span id="l1.441">   ExecShell &quot;open&quot; &quot;${AbortSurveyURL}step2&quot;</span>
<a href="#l1.442"></a><span id="l1.442"> FunctionEnd</span>
<a href="#l1.443"></a><span id="l1.443"> </span>
<a href="#l1.444"></a><span id="l1.444" class="difflineat">@@ -663,92 +691,101 @@ FunctionEnd</span>
<a href="#l1.445"></a><span id="l1.445"> </span>
<a href="#l1.446"></a><span id="l1.446"> Function AbortSurveyShortcuts</span>
<a href="#l1.447"></a><span id="l1.447">   ExecShell &quot;open&quot; &quot;${AbortSurveyURL}step4&quot;</span>
<a href="#l1.448"></a><span id="l1.448"> FunctionEnd</span>
<a href="#l1.449"></a><span id="l1.449"> </span>
<a href="#l1.450"></a><span id="l1.450"> Function AbortSurveySummary</span>
<a href="#l1.451"></a><span id="l1.451">   ExecShell &quot;open&quot; &quot;${AbortSurveyURL}step5&quot;</span>
<a href="#l1.452"></a><span id="l1.452"> FunctionEnd</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-!endif</span>
<a href="#l1.454"></a><span id="l1.454"> </span>
<a href="#l1.455"></a><span id="l1.455"> ################################################################################</span>
<a href="#l1.456"></a><span id="l1.456"> # Helper Functions</span>
<a href="#l1.457"></a><span id="l1.457"> </span>
<a href="#l1.458"></a><span id="l1.458"> Function AddQuickLaunchShortcut</span>
<a href="#l1.459"></a><span id="l1.459">   CreateShortCut &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.460"></a><span id="l1.460">   ${If} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l1.461"></a><span id="l1.461">     ShellLink::SetShortCutWorkingDirectory &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot; \</span>
<a href="#l1.462"></a><span id="l1.462">                                            &quot;$INSTDIR&quot;</span>
<a href="#l1.463"></a><span id="l1.463">   ${EndIf}</span>
<a href="#l1.464"></a><span id="l1.464"> FunctionEnd</span>
<a href="#l1.465"></a><span id="l1.465"> </span>
<a href="#l1.466"></a><span id="l1.466"> Function CheckExistingInstall</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-  ; If there is a pending file copy from a previous uninstall don't allow</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+  ; If there is a pending file copy from a previous upgrade don't allow</span>
<a href="#l1.469"></a><span id="l1.469">   ; installing until after the system has rebooted.</span>
<a href="#l1.470"></a><span id="l1.470">   IfFileExists &quot;$INSTDIR\${FileMainEXE}.moz-upgrade&quot; +1 +4</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-  MessageBox MB_YESNO &quot;$(WARN_RESTART_REQUIRED_UPGRADE)&quot; IDNO +2</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineplus">+  MessageBox MB_YESNO|MB_ICONEXCLAMATION &quot;$(WARN_RESTART_REQUIRED_UPGRADE)&quot; IDNO +2</span>
<a href="#l1.473"></a><span id="l1.473">   Reboot</span>
<a href="#l1.474"></a><span id="l1.474">   Quit</span>
<a href="#l1.475"></a><span id="l1.475"> </span>
<a href="#l1.476"></a><span id="l1.476">   ; If there is a pending file deletion from a previous uninstall don't allow</span>
<a href="#l1.477"></a><span id="l1.477">   ; installing until after the system has rebooted.</span>
<a href="#l1.478"></a><span id="l1.478">   IfFileExists &quot;$INSTDIR\${FileMainEXE}.moz-delete&quot; +1 +4</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-  MessageBox MB_YESNO &quot;$(WARN_RESTART_REQUIRED_UNINSTALL)&quot; IDNO +2</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+  MessageBox MB_YESNO|MB_ICONEXCLAMATION &quot;$(WARN_RESTART_REQUIRED_UNINSTALL)&quot; IDNO +2</span>
<a href="#l1.481"></a><span id="l1.481">   Reboot</span>
<a href="#l1.482"></a><span id="l1.482">   Quit</span>
<a href="#l1.483"></a><span id="l1.483"> </span>
<a href="#l1.484"></a><span id="l1.484">   ${If} ${FileExists} &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+    ; Disable the next, cancel, and back buttons</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+    GetDlgItem $0 $HWNDPARENT 1 ; Next button</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+    EnableWindow $0 0</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+    GetDlgItem $0 $HWNDPARENT 2 ; Cancel button</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+    EnableWindow $0 0</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+    GetDlgItem $0 $HWNDPARENT 3 ; Back button</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+    EnableWindow $0 0</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+</span>
<a href="#l1.493"></a><span id="l1.493">     Banner::show /NOUNLOAD &quot;$(BANNER_CHECK_EXISTING)&quot;</span>
<a href="#l1.494"></a><span id="l1.494"> </span>
<a href="#l1.495"></a><span id="l1.495">     ${If} &quot;$TmpVal&quot; == &quot;FoundMessageWindow&quot;</span>
<a href="#l1.496"></a><span id="l1.496">       Sleep 5000</span>
<a href="#l1.497"></a><span id="l1.497">     ${EndIf}</span>
<a href="#l1.498"></a><span id="l1.498"> </span>
<a href="#l1.499"></a><span id="l1.499">     ${PushFilesToCheck}</span>
<a href="#l1.500"></a><span id="l1.500"> </span>
<a href="#l1.501"></a><span id="l1.501">     ; Store the return value in $TmpVal so it is less likely to be accidentally</span>
<a href="#l1.502"></a><span id="l1.502">     ; overwritten elsewhere.</span>
<a href="#l1.503"></a><span id="l1.503">     ${CheckForFilesInUse} $TmpVal</span>
<a href="#l1.504"></a><span id="l1.504"> </span>
<a href="#l1.505"></a><span id="l1.505">     Banner::destroy</span>
<a href="#l1.506"></a><span id="l1.506"> </span>
<a href="#l1.507"></a><span id="l1.507" class="difflineplus">+    ; Enable the next, cancel, and back buttons</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+    GetDlgItem $0 $HWNDPARENT 1 ; Next button</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+    EnableWindow $0 1</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+    GetDlgItem $0 $HWNDPARENT 2 ; Cancel button</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+    EnableWindow $0 1</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+    GetDlgItem $0 $HWNDPARENT 3 ; Back button</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+    EnableWindow $0 1</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+</span>
<a href="#l1.515"></a><span id="l1.515">     ${If} &quot;$TmpVal&quot; == &quot;true&quot;</span>
<a href="#l1.516"></a><span id="l1.516">       StrCpy $TmpVal &quot;FoundMessageWindow&quot;</span>
<a href="#l1.517"></a><span id="l1.517">       ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_INSTALL)&quot;</span>
<a href="#l1.518"></a><span id="l1.518">       StrCpy $TmpVal &quot;true&quot;</span>
<a href="#l1.519"></a><span id="l1.519">     ${EndIf}</span>
<a href="#l1.520"></a><span id="l1.520">   ${EndIf}</span>
<a href="#l1.521"></a><span id="l1.521"> FunctionEnd</span>
<a href="#l1.522"></a><span id="l1.522"> </span>
<a href="#l1.523"></a><span id="l1.523"> Function LaunchApp</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+  ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_LAUNCH)&quot;</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+</span>
<a href="#l1.526"></a><span id="l1.526">   ClearErrors</span>
<a href="#l1.527"></a><span id="l1.527">   ${GetParameters} $0</span>
<a href="#l1.528"></a><span id="l1.528">   ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $1</span>
<a href="#l1.529"></a><span id="l1.529">   ${If} ${Errors}</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-    ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_LAUNCH)&quot;</span>
<a href="#l1.531"></a><span id="l1.531">     Exec &quot;$\&quot;$INSTDIR\${FileMainEXE}$\&quot;&quot;</span>
<a href="#l1.532"></a><span id="l1.532">   ${Else}</span>
<a href="#l1.533"></a><span id="l1.533">     GetFunctionAddress $0 LaunchAppFromElevatedProcess</span>
<a href="#l1.534"></a><span id="l1.534">     UAC::ExecCodeSegment $0</span>
<a href="#l1.535"></a><span id="l1.535">   ${EndIf}</span>
<a href="#l1.536"></a><span id="l1.536"> FunctionEnd</span>
<a href="#l1.537"></a><span id="l1.537"> </span>
<a href="#l1.538"></a><span id="l1.538"> Function LaunchAppFromElevatedProcess</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-  ${ManualCloseAppPrompt} &quot;${WindowClass}&quot; &quot;$(WARN_MANUALLY_CLOSE_APP_LAUNCH)&quot;</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-  ; Find the installation directory when launching using GetFunctionAddress</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-  ; from an elevated installer since $INSTDIR will not be set in this installer</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-  ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-  ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-  ${GetParent} &quot;$0&quot; $1</span>
<a href="#l1.546"></a><span id="l1.546">   ; Set our current working directory to the application's install directory</span>
<a href="#l1.547"></a><span id="l1.547">   ; otherwise the 7-Zip temp directory will be in use and won't be deleted.</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-  SetOutPath &quot;$1&quot;</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineminus">-  Exec &quot;$\&quot;$0$\&quot;&quot;</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineplus">+  SetOutPath &quot;$INSTDIR&quot;</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineplus">+  Exec &quot;$\&quot;$INSTDIR\${FileMainEXE}$\&quot;&quot;</span>
<a href="#l1.552"></a><span id="l1.552"> FunctionEnd</span>
<a href="#l1.553"></a><span id="l1.553"> </span>
<a href="#l1.554"></a><span id="l1.554"> ################################################################################</span>
<a href="#l1.555"></a><span id="l1.555"> # Language</span>
<a href="#l1.556"></a><span id="l1.556"> </span>
<a href="#l1.557"></a><span id="l1.557"> !insertmacro MOZ_MUI_LANGUAGE 'baseLocale'</span>
<a href="#l1.558"></a><span id="l1.558"> !verbose push</span>
<a href="#l1.559"></a><span id="l1.559"> !verbose 3</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineat">@@ -774,17 +811,16 @@ FunctionEnd</span>
<a href="#l1.561"></a><span id="l1.561"> Function preOptions</span>
<a href="#l1.562"></a><span id="l1.562">   StrCpy $PageName &quot;Options&quot;</span>
<a href="#l1.563"></a><span id="l1.563">   ${If} ${FileExists} &quot;$EXEDIR\core\distribution\modern-header.bmp&quot;</span>
<a href="#l1.564"></a><span id="l1.564">   ${AndIf} $hHeaderBitmap == &quot;&quot;</span>
<a href="#l1.565"></a><span id="l1.565">     Delete &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l1.566"></a><span id="l1.566">     CopyFiles /SILENT &quot;$EXEDIR\core\distribution\modern-header.bmp&quot; &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l1.567"></a><span id="l1.567">     ${ChangeMUIHeaderImage} &quot;$PLUGINSDIR\modern-header.bmp&quot;</span>
<a href="#l1.568"></a><span id="l1.568">   ${EndIf}</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-</span>
<a href="#l1.570"></a><span id="l1.570">   !insertmacro MUI_HEADER_TEXT &quot;$(OPTIONS_PAGE_TITLE)&quot; &quot;$(OPTIONS_PAGE_SUBTITLE)&quot;</span>
<a href="#l1.571"></a><span id="l1.571">   !insertmacro MUI_INSTALLOPTIONS_DISPLAY &quot;options.ini&quot;</span>
<a href="#l1.572"></a><span id="l1.572"> FunctionEnd</span>
<a href="#l1.573"></a><span id="l1.573"> </span>
<a href="#l1.574"></a><span id="l1.574"> Function leaveOptions</span>
<a href="#l1.575"></a><span id="l1.575">   ${MUI_INSTALLOPTIONS_READ} $0 &quot;options.ini&quot; &quot;Settings&quot; &quot;State&quot;</span>
<a href="#l1.576"></a><span id="l1.576">   ${If} $0 != 0</span>
<a href="#l1.577"></a><span id="l1.577">     Abort</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineat">@@ -824,16 +860,17 @@ FunctionEnd</span>
<a href="#l1.579"></a><span id="l1.579"> </span>
<a href="#l1.580"></a><span id="l1.580"> Function leaveShortcuts</span>
<a href="#l1.581"></a><span id="l1.581">   ${MUI_INSTALLOPTIONS_READ} $0 &quot;shortcuts.ini&quot; &quot;Settings&quot; &quot;State&quot;</span>
<a href="#l1.582"></a><span id="l1.582">   ${If} $0 != 0</span>
<a href="#l1.583"></a><span id="l1.583">     Abort</span>
<a href="#l1.584"></a><span id="l1.584">   ${EndIf}</span>
<a href="#l1.585"></a><span id="l1.585">   ${MUI_INSTALLOPTIONS_READ} $AddDesktopSC &quot;shortcuts.ini&quot; &quot;Field 2&quot; &quot;State&quot;</span>
<a href="#l1.586"></a><span id="l1.586">   ${MUI_INSTALLOPTIONS_READ} $AddStartMenuSC &quot;shortcuts.ini&quot; &quot;Field 3&quot; &quot;State&quot;</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineplus">+</span>
<a href="#l1.588"></a><span id="l1.588">   ; Don't install the quick launch shortcut on Windows 7</span>
<a href="#l1.589"></a><span id="l1.589">   ${Unless} ${AtLeastWin7}</span>
<a href="#l1.590"></a><span id="l1.590">     ${MUI_INSTALLOPTIONS_READ} $AddQuickLaunchSC &quot;shortcuts.ini&quot; &quot;Field 4&quot; &quot;State&quot;</span>
<a href="#l1.591"></a><span id="l1.591">   ${EndUnless}</span>
<a href="#l1.592"></a><span id="l1.592"> </span>
<a href="#l1.593"></a><span id="l1.593">   ${If} $InstallType == ${INSTALLTYPE_CUSTOM}</span>
<a href="#l1.594"></a><span id="l1.594">     Call CheckExistingInstall</span>
<a href="#l1.595"></a><span id="l1.595">   ${EndIf}</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineat">@@ -905,17 +942,16 @@ Function preSummary</span>
<a href="#l1.597"></a><span id="l1.597">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; state  &quot;&quot;</span>
<a href="#l1.598"></a><span id="l1.598">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Left   &quot;0&quot;</span>
<a href="#l1.599"></a><span id="l1.599">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Right  &quot;-1&quot;</span>
<a href="#l1.600"></a><span id="l1.600">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Top    &quot;17&quot;</span>
<a href="#l1.601"></a><span id="l1.601">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; Bottom &quot;30&quot;</span>
<a href="#l1.602"></a><span id="l1.602">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 2&quot; flags  &quot;READONLY&quot;</span>
<a href="#l1.603"></a><span id="l1.603"> </span>
<a href="#l1.604"></a><span id="l1.604">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Type   &quot;label&quot;</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-  WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Text   &quot;$(SUMMARY_CLICK)&quot;</span>
<a href="#l1.606"></a><span id="l1.606">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Left   &quot;0&quot;</span>
<a href="#l1.607"></a><span id="l1.607">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Right  &quot;-1&quot;</span>
<a href="#l1.608"></a><span id="l1.608">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Top    &quot;130&quot;</span>
<a href="#l1.609"></a><span id="l1.609">   WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 3&quot; Bottom &quot;150&quot;</span>
<a href="#l1.610"></a><span id="l1.610"> </span>
<a href="#l1.611"></a><span id="l1.611">   ${If} &quot;$TmpVal&quot; == &quot;true&quot;</span>
<a href="#l1.612"></a><span id="l1.612">     WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Type   &quot;label&quot;</span>
<a href="#l1.613"></a><span id="l1.613">     WriteINIStr &quot;$PLUGINSDIR\summary.ini&quot; &quot;Field 4&quot; Text   &quot;$(SUMMARY_REBOOT_REQUIRED_INSTALL)&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/installer/windows/nsis/shared.nsh</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/installer/windows/nsis/shared.nsh</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -7,41 +7,30 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   ; Remove registry entries for non-existent apps and for apps that point to our</span>
<a href="#l2.6"></a><span id="l2.6">   ; install location in the Software\Mozilla key and uninstall registry entries</span>
<a href="#l2.7"></a><span id="l2.7">   ; that point to our install location for both HKCU and HKLM.</span>
<a href="#l2.8"></a><span id="l2.8">   SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.9"></a><span id="l2.9">   ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l2.10"></a><span id="l2.10">   ${RegCleanUninstall}</span>
<a href="#l2.11"></a><span id="l2.11">   ${UpdateProtocolHandlers}</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  ; Win7 taskbar and start menu link maintenance</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  Call FixShortcutAppModelIDs</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   ; setup the application model id registration value</span>
<a href="#l2.16"></a><span id="l2.16">   ${InitHashAppModelId} &quot;$INSTDIR&quot; &quot;Software\Mozilla\${AppName}\TaskBarIDs&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  ; Upgrade the copies of the MAPI DLL's</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  ${UpgradeMapiDLLs}</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  ; Delete two files installed by Kaspersky Anti-Spam extension that are only</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  ; compatible with Thunderbird 2 (bug 533692).</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\components\klthbplg.dll&quot;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    Delete /REBOOTOK &quot;$INSTDIR\components\klthbplg.dll&quot;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  ${EndIf}</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\components\IKLAntiSpam.xpt&quot;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-    Delete /REBOOTOK &quot;$INSTDIR\components\IKLAntiSpam.xpt&quot;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  ${EndIf}</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  ; Win7 taskbar and start menu link maintenance</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+  Call FixShortcutAppModelIDs</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   ClearErrors</span>
<a href="#l2.33"></a><span id="l2.33">   WriteRegStr HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot; &quot;Write Test&quot;</span>
<a href="#l2.34"></a><span id="l2.34">   ${If} ${Errors}</span>
<a href="#l2.35"></a><span id="l2.35">     StrCpy $TmpVal &quot;HKCU&quot; ; used primarily for logging</span>
<a href="#l2.36"></a><span id="l2.36">   ${Else}</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    SetShellVarContext all    ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.38"></a><span id="l2.38">     DeleteRegValue HKLM &quot;Software\Mozilla&quot; &quot;${BrandShortName}InstallerTest&quot;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    SetShellVarContext all    ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.40"></a><span id="l2.40">     StrCpy $TmpVal &quot;HKLM&quot; ; used primarily for logging</span>
<a href="#l2.41"></a><span id="l2.41">     ${RegCleanMain} &quot;Software\Mozilla&quot;</span>
<a href="#l2.42"></a><span id="l2.42">     ${RegCleanUninstall}</span>
<a href="#l2.43"></a><span id="l2.43">     ${UpdateProtocolHandlers}</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">     ; Win7 taskbar and start menu link maintenance</span>
<a href="#l2.46"></a><span id="l2.46">     Call FixShortcutAppModelIDs</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -49,29 +38,29 @@</span>
<a href="#l2.49"></a><span id="l2.49">     ; this installation is the same as the one set in those keys.</span>
<a href="#l2.50"></a><span id="l2.50">     ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.51"></a><span id="l2.51">     ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.52"></a><span id="l2.52">     ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.53"></a><span id="l2.53">     ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.54"></a><span id="l2.54">       ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.55"></a><span id="l2.55">     ${EndIf}</span>
<a href="#l2.56"></a><span id="l2.56">     ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      ${SetClientsMail}</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+      ${SetClientsMail} &quot;HKLM&quot;</span>
<a href="#l2.59"></a><span id="l2.59">     ${EndIf}</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">     ; Only update the Clients\News registry key values if they don't exist or</span>
<a href="#l2.62"></a><span id="l2.62">     ; this installation is the same as the one set in those keys.</span>
<a href="#l2.63"></a><span id="l2.63">     ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.64"></a><span id="l2.64">     ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.65"></a><span id="l2.65">     ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.66"></a><span id="l2.66">     ${If} ${FileExists} &quot;$0&quot;</span>
<a href="#l2.67"></a><span id="l2.67">       ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.68"></a><span id="l2.68">     ${EndIf}</span>
<a href="#l2.69"></a><span id="l2.69">     ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      ${SetClientsNews}</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      ${SetClientsNews} &quot;HKLM&quot;</span>
<a href="#l2.72"></a><span id="l2.72">     ${EndIf}</span>
<a href="#l2.73"></a><span id="l2.73">   ${EndIf}</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">   ; Migrate the application's Start Menu directory to a single shortcut in the</span>
<a href="#l2.76"></a><span id="l2.76">   ; root of the Start Menu Programs directory.</span>
<a href="#l2.77"></a><span id="l2.77">   ${MigrateStartMenuShortcut}</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79">   ; Update lastwritetime of the Start Menu shortcut to clear the tile cache.</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineat">@@ -94,112 +83,167 @@</span>
<a href="#l2.81"></a><span id="l2.81">   ${CleanVirtualStore}</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83"> !ifdef MOZ_MAINTENANCE_SERVICE</span>
<a href="#l2.84"></a><span id="l2.84">   Call IsUserAdmin</span>
<a href="#l2.85"></a><span id="l2.85">   Pop $R0</span>
<a href="#l2.86"></a><span id="l2.86">   ${If} $R0 == &quot;true&quot;</span>
<a href="#l2.87"></a><span id="l2.87">   ; Only proceed if we have HKLM write access</span>
<a href="#l2.88"></a><span id="l2.88">   ${AndIf} $TmpVal == &quot;HKLM&quot;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-    ; Add the registry keys for allowed certificates.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-    ${AddMaintCertKeys}</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-</span>
<a href="#l2.92"></a><span id="l2.92">     ; We check to see if the maintenance service install was already attempted.</span>
<a href="#l2.93"></a><span id="l2.93">     ; Since the Maintenance service can be installed either x86 or x64,</span>
<a href="#l2.94"></a><span id="l2.94">     ; always use the 64-bit registry for checking if an attempt was made.</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    SetRegView 64</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    ${If} ${RunningX64}</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+      SetRegView 64</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.99"></a><span id="l2.99">     ReadRegDWORD $5 HKLM &quot;Software\Mozilla\MaintenanceService&quot; &quot;Attempted&quot;</span>
<a href="#l2.100"></a><span id="l2.100">     ClearErrors</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    SetRegView lastused</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+    ${If} ${RunningX64}</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+      SetRegView lastused</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+    ; Add the registry keys for allowed certificates.</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+    ${AddMaintCertKeys}</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109">     ; If the maintenance service is already installed, do nothing.</span>
<a href="#l2.110"></a><span id="l2.110">     ; The maintenance service will launch:</span>
<a href="#l2.111"></a><span id="l2.111">     ; maintenanceservice_installer.exe /Upgrade to upgrade the maintenance</span>
<a href="#l2.112"></a><span id="l2.112">     ; service if necessary.   If the update was done from updater.exe without</span>
<a href="#l2.113"></a><span id="l2.113">     ; the service (i.e. service is failing), updater.exe will do the update of</span>
<a href="#l2.114"></a><span id="l2.114">     ; the service.  The reasons we do not do it here is because we don't want</span>
<a href="#l2.115"></a><span id="l2.115">     ; to have to prompt for limited user accounts when the service isn't used</span>
<a href="#l2.116"></a><span id="l2.116">     ; and we currently call the PostUpdate twice, once for the user and once</span>
<a href="#l2.117"></a><span id="l2.117">     ; for the SYSTEM account.  Also, this would stop the maintenance service</span>
<a href="#l2.118"></a><span id="l2.118">     ; and we need a return result back to the service when run that way.</span>
<a href="#l2.119"></a><span id="l2.119">     ${If} $5 == &quot;&quot;</span>
<a href="#l2.120"></a><span id="l2.120">       ; An install of maintenance service was never attempted.</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-      ; We call ExecShell (which is ShellExecute) with the verb &quot;runas&quot;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-      ; to ask for elevation if the user isn't already elevated.  If the user</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-      ; is already elevated it will just launch the program.</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      ExecShell &quot;runas&quot; &quot;$\&quot;$INSTDIR\maintenanceservice_installer.exe$\&quot;&quot;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+      ; We know we are an Admin and that we have write access into HKLM</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+      ; based on the above checks, so attempt to just run the EXE.</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+      ; In the worst case, in case there is some edge case with the</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+      ; IsAdmin check and the permissions check, the maintenance service</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+      ; will just fail to be attempted to be installed.</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      nsExec::Exec &quot;$\&quot;$INSTDIR\maintenanceservice_installer.exe$\&quot;&quot;</span>
<a href="#l2.131"></a><span id="l2.131">     ${EndIf}</span>
<a href="#l2.132"></a><span id="l2.132">   ${EndIf}</span>
<a href="#l2.133"></a><span id="l2.133"> !endif</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-  ; Remove talkback if it is present (remove after bug 386760 is fixed)</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-  ${If} ${FileExists} &quot;$INSTDIR\extensions\talkback@mozilla.org\&quot;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    RmDir /r &quot;$INSTDIR\extensions\talkback@mozilla.org\&quot;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  ${EndIf}</span>
<a href="#l2.139"></a><span id="l2.139"> !macroend</span>
<a href="#l2.140"></a><span id="l2.140"> !define PostUpdate &quot;!insertmacro PostUpdate&quot;</span>
<a href="#l2.141"></a><span id="l2.141"> </span>
<a href="#l2.142"></a><span id="l2.142"> !macro SetAsDefaultAppGlobal</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  ${RemoveDeprecatedKeys}</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  ${RemoveDeprecatedKeys} ; Does not use SHCTX</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146">   SetShellVarContext all      ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-  ${SetHandlersMail}</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-  ${SetHandlersNews}</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-  ${SetClientsMail}</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-  ${SetClientsNews}</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  ${SetHandlersMail} ; Uses SHCTX</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  ${SetHandlersNews} ; Uses SHCTX</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+  ${SetClientsMail} &quot;HKLM&quot;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  ${SetClientsNews} &quot;HKLM&quot;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  ${SetMailClientForMapi} &quot;HKLM&quot;</span>
<a href="#l2.156"></a><span id="l2.156">   ${ShowShortcuts}</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-  ${SetMailClientForMapi}</span>
<a href="#l2.158"></a><span id="l2.158"> !macroend</span>
<a href="#l2.159"></a><span id="l2.159"> !define SetAsDefaultAppGlobal &quot;!insertmacro SetAsDefaultAppGlobal&quot;</span>
<a href="#l2.160"></a><span id="l2.160"> </span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-!macro SetMailClientForMapi</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-  WriteRegStr HKLM &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+!macro SetMailClientForMapi RegKey</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  WriteRegStr ${RegKey} &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.165"></a><span id="l2.165"> !macroend</span>
<a href="#l2.166"></a><span id="l2.166"> !define SetMailClientForMapi &quot;!insertmacro SetMailClientForMapi&quot;</span>
<a href="#l2.167"></a><span id="l2.167"> </span>
<a href="#l2.168"></a><span id="l2.168"> !macro HideShortcuts</span>
<a href="#l2.169"></a><span id="l2.169">   StrCpy $R1 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l2.170"></a><span id="l2.170">   WriteRegDWORD HKLM &quot;$R1&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  ${If} ${AtLeastWin8}</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+    WriteRegDWORD HKCU &quot;$R1&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+</span>
<a href="#l2.175"></a><span id="l2.175">   SetShellVarContext all  ; Set $DESKTOP to All Users</span>
<a href="#l2.176"></a><span id="l2.176">   ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.177"></a><span id="l2.177">     SetShellVarContext current  ; Set $DESKTOP to the current user's desktop</span>
<a href="#l2.178"></a><span id="l2.178">   ${EndUnless}</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180">   ${If} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.181"></a><span id="l2.181">     ShellLink::GetShortCutArgs &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.182"></a><span id="l2.182">     Pop $0</span>
<a href="#l2.183"></a><span id="l2.183">     ${If} &quot;$0&quot; == &quot;&quot;</span>
<a href="#l2.184"></a><span id="l2.184">       ShellLink::GetShortCutTarget &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.185"></a><span id="l2.185">       Pop $0</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-      ; Needs to handle short paths</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.188"></a><span id="l2.188">       ${If} &quot;$0&quot; == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.189"></a><span id="l2.189">         Delete &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.190"></a><span id="l2.190">       ${EndIf}</span>
<a href="#l2.191"></a><span id="l2.191">     ${EndIf}</span>
<a href="#l2.192"></a><span id="l2.192">   ${EndIf}</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+  SetShellVarContext all  ; Set $SMPROGRAMS to All Users</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+  ${Unless} ${FileExists} &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+    SetShellVarContext current  ; Set $SMPROGRAMS to the current user's Start</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+                                ; Menu Programs directory</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+  ${EndUnless}</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+  ${If} ${FileExists} &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+    ShellLink::GetShortCutArgs &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+    Pop $0</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+    ${If} &quot;$0&quot; == &quot;&quot;</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+      ShellLink::GetShortCutTarget &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+      Pop $0</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+      ${If} &quot;$0&quot; == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+        Delete &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+      ${EndIf}</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+</span>
<a href="#l2.213"></a><span id="l2.213">   ${If} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l2.214"></a><span id="l2.214">     ShellLink::GetShortCutArgs &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l2.215"></a><span id="l2.215">     Pop $0</span>
<a href="#l2.216"></a><span id="l2.216">     ${If} &quot;$0&quot; == &quot;&quot;</span>
<a href="#l2.217"></a><span id="l2.217">       ShellLink::GetShortCutTarget &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l2.218"></a><span id="l2.218">       Pop $0</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-      ; Needs to handle short paths</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+      ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.221"></a><span id="l2.221">       ${If} &quot;$0&quot; == &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.222"></a><span id="l2.222">         Delete &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l2.223"></a><span id="l2.223">       ${EndIf}</span>
<a href="#l2.224"></a><span id="l2.224">     ${EndIf}</span>
<a href="#l2.225"></a><span id="l2.225">   ${EndIf}</span>
<a href="#l2.226"></a><span id="l2.226"> !macroend</span>
<a href="#l2.227"></a><span id="l2.227"> !define HideShortcuts &quot;!insertmacro HideShortcuts&quot;</span>
<a href="#l2.228"></a><span id="l2.228"> </span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+; Adds shortcuts for this installation. This should also add the application</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+; to Open With for the file types the application handles (bug 370480).</span>
<a href="#l2.231"></a><span id="l2.231"> !macro ShowShortcuts</span>
<a href="#l2.232"></a><span id="l2.232">   StrCpy $R1 &quot;Software\Clients\Mail\${ClientsRegName}\InstallInfo&quot;</span>
<a href="#l2.233"></a><span id="l2.233">   WriteRegDWORD HKLM &quot;$R1&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+  ${If} ${AtLeastWin8}</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+    WriteRegDWORD HKCU &quot;$R1&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+</span>
<a href="#l2.238"></a><span id="l2.238">   SetShellVarContext all  ; Set $DESKTOP to All Users</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+  ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+    CreateShortCut &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    ${If} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+      ShellLink::SetShortCutWorkingDirectory &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR&quot;</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+      ${If} ${AtLeastWin7}</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+      ${AndIf} &quot;$AppUserModelID&quot; != &quot;&quot;</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+        ApplicationID::Set &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$AppUserModelID&quot; &quot;true&quot;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+      ${EndIf}</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+    ${Else}</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+      SetShellVarContext current  ; Set $DESKTOP to the current user's desktop</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+      ${Unless} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+        CreateShortCut &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+        ${If} ${FileExists} &quot;$DESKTOP\${BrandFullName}.lnk&quot;</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+          ShellLink::SetShortCutWorkingDirectory &quot;$DESKTOP\${BrandFullName}.lnk&quot; \</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+                                                 &quot;$INSTDIR&quot;</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+          ${If} ${AtLeastWin7}</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+          ${AndIf} &quot;$AppUserModelID&quot; != &quot;&quot;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+            ApplicationID::Set &quot;$DESKTOP\${BrandFullName}.lnk&quot; &quot;$AppUserModelID&quot; &quot;true&quot;</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+          ${EndIf}</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+        ${EndIf}</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+      ${EndUnless}</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+  ${EndUnless}</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+  SetShellVarContext all  ; Set $SMPROGRAMS to All Users</span>
<a href="#l2.264"></a><span id="l2.264">   ${Unless} ${FileExists} &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.265"></a><span id="l2.265">     CreateShortCut &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot; &quot;$INSTDIR\${FileMainEXE}&quot;</span>
<a href="#l2.266"></a><span id="l2.266">     ${If} ${FileExists} &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot;</span>
<a href="#l2.267"></a><span id="l2.267">       ShellLink::SetShortCutWorkingDirectory &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot; \</span>
<a href="#l2.268"></a><span id="l2.268">                                              &quot;$INSTDIR&quot;</span>
<a href="#l2.269"></a><span id="l2.269">       ${If} ${AtLeastWin7}</span>
<a href="#l2.270"></a><span id="l2.270">       ${AndIf} &quot;$AppUserModelID&quot; != &quot;&quot;</span>
<a href="#l2.271"></a><span id="l2.271">         ApplicationID::Set &quot;$SMPROGRAMS\${BrandFullName}.lnk&quot; &quot;$AppUserModelID&quot; &quot;true&quot;</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineat">@@ -231,16 +275,17 @@</span>
<a href="#l2.273"></a><span id="l2.273">                                              &quot;$INSTDIR&quot;</span>
<a href="#l2.274"></a><span id="l2.274">     ${EndIf}</span>
<a href="#l2.275"></a><span id="l2.275">   ${EndUnless}</span>
<a href="#l2.276"></a><span id="l2.276"> !macroend</span>
<a href="#l2.277"></a><span id="l2.277"> !define ShowShortcuts &quot;!insertmacro ShowShortcuts&quot;</span>
<a href="#l2.278"></a><span id="l2.278"> </span>
<a href="#l2.279"></a><span id="l2.279"> !macro SetHandlersMail</span>
<a href="#l2.280"></a><span id="l2.280">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+</span>
<a href="#l2.282"></a><span id="l2.282">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l2.283"></a><span id="l2.283">   StrCpy $1 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.284"></a><span id="l2.284">   StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.285"></a><span id="l2.285"> </span>
<a href="#l2.286"></a><span id="l2.286">   ; An empty string is used for the 5th param because ThunderbirdEML is not a</span>
<a href="#l2.287"></a><span id="l2.287">   ; protocol handler</span>
<a href="#l2.288"></a><span id="l2.288">   ${AddHandlerValues} &quot;$0\ThunderbirdEML&quot;  &quot;$1&quot; &quot;$8,0&quot; \</span>
<a href="#l2.289"></a><span id="l2.289">                       &quot;${AppRegNameMail} Document&quot; &quot;&quot; &quot;&quot;</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineat">@@ -265,26 +310,26 @@</span>
<a href="#l2.291"></a><span id="l2.291">   ${AddHandlerValues} &quot;$0\news&quot;   &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.292"></a><span id="l2.292">   ${AddHandlerValues} &quot;$0\nntp&quot;   &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.293"></a><span id="l2.293">   ${AddHandlerValues} &quot;$0\snews&quot;  &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.294"></a><span id="l2.294"> !macroend</span>
<a href="#l2.295"></a><span id="l2.295"> !define SetHandlersNews &quot;!insertmacro SetHandlersNews&quot;</span>
<a href="#l2.296"></a><span id="l2.296"> </span>
<a href="#l2.297"></a><span id="l2.297"> ; XXXrstrong - there are several values that will be overwritten by and</span>
<a href="#l2.298"></a><span id="l2.298"> ; overwrite other installs of the same application.</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-!macro SetClientsMail</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+!macro SetClientsMail RegKey</span>
<a href="#l2.301"></a><span id="l2.301">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l2.302"></a><span id="l2.302">   ${GetLongPath} &quot;$INSTDIR\uninstall\helper.exe&quot; $7</span>
<a href="#l2.303"></a><span id="l2.303">   ${GetLongPath} &quot;$INSTDIR\mozMapi32_InUse.dll&quot; $6</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305">   StrCpy $0 &quot;Software\Clients\Mail\${ClientsRegName}&quot;</span>
<a href="#l2.306"></a><span id="l2.306"> </span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-  WriteRegStr HKLM &quot;$0&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-  WriteRegStr HKLM &quot;$0\DefaultIcon&quot; &quot;&quot; &quot;$8,0&quot;</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-  WriteRegStr HKLM &quot;$0&quot; &quot;DLLPath&quot; &quot;$6&quot;</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\DefaultIcon&quot; &quot;&quot; &quot;$8,0&quot;</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0&quot; &quot;DLLPath&quot; &quot;$6&quot;</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314">   ; The MapiProxy dll can exist in multiple installs of the application.</span>
<a href="#l2.315"></a><span id="l2.315">   ; Registration occurs as follows with the last action to occur being the one</span>
<a href="#l2.316"></a><span id="l2.316">   ; that wins:</span>
<a href="#l2.317"></a><span id="l2.317">   ; On install and software update when helper.exe runs with the /PostUpdate</span>
<a href="#l2.318"></a><span id="l2.318">   ; argument. On setting the application as the system's default application</span>
<a href="#l2.319"></a><span id="l2.319">   ; using Window's &quot;Set program access and defaults&quot;.</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321" class="difflineat">@@ -298,85 +343,82 @@</span>
<a href="#l2.322"></a><span id="l2.322">       ${LogMsg} &quot;** ERROR Registering: $INSTDIR\MapiProxy_InUse.dll **&quot;</span>
<a href="#l2.323"></a><span id="l2.323">     ${Else}</span>
<a href="#l2.324"></a><span id="l2.324">       ${LogUninstall} &quot;DLLReg: \MapiProxy_InUse.dll&quot;</span>
<a href="#l2.325"></a><span id="l2.325">       ${LogMsg} &quot;Registered: $INSTDIR\MapiProxy_InUse.dll&quot;</span>
<a href="#l2.326"></a><span id="l2.326">     ${EndIf}</span>
<a href="#l2.327"></a><span id="l2.327">   !endif</span>
<a href="#l2.328"></a><span id="l2.328"> </span>
<a href="#l2.329"></a><span id="l2.329">   StrCpy $1 &quot;Software\Classes\CLSID\{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-  WriteRegStr HKLM &quot;$1\LocalServer32&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; /MAPIStartup&quot;</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-  WriteRegStr HKLM &quot;$1\ProgID&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-  WriteRegStr HKLM &quot;$1\VersionIndependentProgID&quot; &quot;&quot; &quot;MozillaMAPI&quot;</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\LocalServer32&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; /MAPIStartup&quot;</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\ProgID&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\VersionIndependentProgID&quot; &quot;&quot; &quot;MozillaMAPI&quot;</span>
<a href="#l2.336"></a><span id="l2.336">   StrCpy $1 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi\CurVer&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi.1&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi.1\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi\CurVer&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi.1&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi.1\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.347"></a><span id="l2.347"> </span>
<a href="#l2.348"></a><span id="l2.348">   ; The Reinstall Command is defined at</span>
<a href="#l2.349"></a><span id="l2.349">   ; http://msdn.microsoft.com/library/default.asp?url=/library/en-us/shellcc/platform/shell/programmersguide/shell_adv/registeringapps.asp</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-  WriteRegStr HKLM &quot;$0\InstallInfo&quot; &quot;HideIconsCommand&quot; &quot;$\&quot;$7$\&quot; /HideShortcuts&quot;</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-  WriteRegStr HKLM &quot;$0\InstallInfo&quot; &quot;ShowIconsCommand&quot; &quot;$\&quot;$7$\&quot; /ShowShortcuts&quot;</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-  WriteRegStr HKLM &quot;$0\InstallInfo&quot; &quot;ReinstallCommand&quot; &quot;$\&quot;$7$\&quot; /SetAsDefaultAppGlobal&quot;</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\InstallInfo&quot; &quot;HideIconsCommand&quot; &quot;$\&quot;$7$\&quot; /HideShortcuts&quot;</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\InstallInfo&quot; &quot;ShowIconsCommand&quot; &quot;$\&quot;$7$\&quot; /ShowShortcuts&quot;</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\InstallInfo&quot; &quot;ReinstallCommand&quot; &quot;$\&quot;$7$\&quot; /SetAsDefaultAppGlobal&quot;</span>
<a href="#l2.356"></a><span id="l2.356"> </span>
<a href="#l2.357"></a><span id="l2.357">   ClearErrors</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-  ReadRegDWORD $1 HKLM &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot;</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-  ; If the IconsVisible name vale pair doesn't exist add it otherwise the</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+  ReadRegDWORD $1 ${RegKey} &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot;</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+  ; If the IconsVisible name value pair doesn't exist add it otherwise the</span>
<a href="#l2.362"></a><span id="l2.362">   ; application won't be displayed in Set Program Access and Defaults.</span>
<a href="#l2.363"></a><span id="l2.363">   ${If} ${Errors}</span>
<a href="#l2.364"></a><span id="l2.364">     ${If} ${FileExists} &quot;$QUICKLAUNCH\${BrandFullName}.lnk&quot;</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-      WriteRegDWORD HKLM &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+      WriteRegDWORD ${RegKey} &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot; 1</span>
<a href="#l2.367"></a><span id="l2.367">     ${Else}</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-      WriteRegDWORD HKLM &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+      WriteRegDWORD ${RegKey} &quot;$0\InstallInfo&quot; &quot;IconsVisible&quot; 0</span>
<a href="#l2.370"></a><span id="l2.370">     ${EndIf}</span>
<a href="#l2.371"></a><span id="l2.371">   ${EndIf}</span>
<a href="#l2.372"></a><span id="l2.372"> </span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-  ; Mail shell/open/command</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-  WriteRegStr HKLM &quot;$0\shell\open\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -mail&quot;</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\shell\open\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -mail&quot;</span>
<a href="#l2.376"></a><span id="l2.376"> </span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-  ; options</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-  WriteRegStr HKLM &quot;$0\shell\properties&quot; &quot;&quot; &quot;$(CONTEXT_OPTIONS)&quot;</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-  WriteRegStr HKLM &quot;$0\shell\properties\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -options&quot;</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\shell\properties&quot; &quot;&quot; &quot;$(CONTEXT_OPTIONS)&quot;</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\shell\properties\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -options&quot;</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-  ; safemode</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-  WriteRegStr HKLM &quot;$0\shell\safemode&quot; &quot;&quot; &quot;$(CONTEXT_SAFE_MODE)&quot;</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-  WriteRegStr HKLM &quot;$0\shell\safemode\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -safe-mode&quot;</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\shell\safemode&quot; &quot;&quot; &quot;$(CONTEXT_SAFE_MODE)&quot;</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\shell\safemode\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -safe-mode&quot;</span>
<a href="#l2.388"></a><span id="l2.388"> </span>
<a href="#l2.389"></a><span id="l2.389">   ; Protocols</span>
<a href="#l2.390"></a><span id="l2.390">   StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.391"></a><span id="l2.391">   ${AddHandlerValues} &quot;$0\Protocols\mailto&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameMail} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.392"></a><span id="l2.392"> </span>
<a href="#l2.393"></a><span id="l2.393">   ; Capabilities registry keys</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationDescription&quot; &quot;$(REG_APP_DESC)&quot;</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationIcon&quot; &quot;$8,0&quot;</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationName&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\FileAssociations&quot; &quot;.eml&quot;   &quot;ThunderbirdEML&quot;</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\FileAssociations&quot; &quot;.wdseml&quot; &quot;ThunderbirdEML&quot;</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\StartMenu&quot; &quot;Mail&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\URLAssociations&quot; &quot;mailto&quot; &quot;Thunderbird.Url.mailto&quot;</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities&quot; &quot;ApplicationDescription&quot; &quot;$(REG_APP_DESC)&quot;</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities&quot; &quot;ApplicationIcon&quot; &quot;$8,0&quot;</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities&quot; &quot;ApplicationName&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\FileAssociations&quot; &quot;.eml&quot;   &quot;ThunderbirdEML&quot;</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\FileAssociations&quot; &quot;.wdseml&quot; &quot;ThunderbirdEML&quot;</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\StartMenu&quot; &quot;Mail&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\URLAssociations&quot; &quot;mailto&quot; &quot;Thunderbird.Url.mailto&quot;</span>
<a href="#l2.408"></a><span id="l2.408"> </span>
<a href="#l2.409"></a><span id="l2.409">   ; Registered Application</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-  WriteRegStr HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot; &quot;$0\Capabilities&quot;</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+  WriteRegStr ${RegKey} &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot; &quot;$0\Capabilities&quot;</span>
<a href="#l2.412"></a><span id="l2.412"> !macroend</span>
<a href="#l2.413"></a><span id="l2.413"> !define SetClientsMail &quot;!insertmacro SetClientsMail&quot;</span>
<a href="#l2.414"></a><span id="l2.414"> </span>
<a href="#l2.415"></a><span id="l2.415"> ; XXXrstrong - there are several values that will be overwritten by and</span>
<a href="#l2.416"></a><span id="l2.416"> ; overwrite other installs of the same application.</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-!macro SetClientsNews</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+!macro SetClientsNews RegKey</span>
<a href="#l2.419"></a><span id="l2.419">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l2.420"></a><span id="l2.420">   ${GetLongPath} &quot;$INSTDIR\uninstall\helper.exe&quot; $7</span>
<a href="#l2.421"></a><span id="l2.421">   ${GetLongPath} &quot;$INSTDIR\mozMapi32_InUse.dll&quot; $6</span>
<a href="#l2.422"></a><span id="l2.422"> </span>
<a href="#l2.423"></a><span id="l2.423">   StrCpy $0 &quot;Software\Clients\News\${ClientsRegName}&quot;</span>
<a href="#l2.424"></a><span id="l2.424"> </span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-  WriteRegStr HKLM &quot;$0&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-  WriteRegStr HKLM &quot;$0\DefaultIcon&quot; &quot;&quot; &quot;$8,0&quot;</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-  WriteRegStr HKLM &quot;$0&quot; &quot;DLLPath&quot; &quot;$6&quot;</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\DefaultIcon&quot; &quot;&quot; &quot;$8,0&quot;</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0&quot; &quot;DLLPath&quot; &quot;$6&quot;</span>
<a href="#l2.431"></a><span id="l2.431"> </span>
<a href="#l2.432"></a><span id="l2.432">   ; The MapiProxy dll can exist in multiple installs of the application.</span>
<a href="#l2.433"></a><span id="l2.433">   ; Registration occurs as follows with the last action to occur being the one</span>
<a href="#l2.434"></a><span id="l2.434">   ; that wins:</span>
<a href="#l2.435"></a><span id="l2.435">   ; On install and software update when helper.exe runs with the /PostUpdate</span>
<a href="#l2.436"></a><span id="l2.436">   ; argument. On setting the application as the system's default application</span>
<a href="#l2.437"></a><span id="l2.437">   ; using Window's &quot;Set program access and defaults&quot;.</span>
<a href="#l2.438"></a><span id="l2.438"> </span>
<a href="#l2.439"></a><span id="l2.439" class="difflineat">@@ -390,48 +432,49 @@</span>
<a href="#l2.440"></a><span id="l2.440">       ${LogMsg} &quot;** ERROR Registering: $INSTDIR\MapiProxy_InUse.dll **&quot;</span>
<a href="#l2.441"></a><span id="l2.441">     ${Else}</span>
<a href="#l2.442"></a><span id="l2.442">       ${LogUninstall} &quot;DLLReg: \MapiProxy_InUse.dll&quot;</span>
<a href="#l2.443"></a><span id="l2.443">       ${LogMsg} &quot;Registered: $INSTDIR\MapiProxy_InUse.dll&quot;</span>
<a href="#l2.444"></a><span id="l2.444">     ${EndIf}</span>
<a href="#l2.445"></a><span id="l2.445">   !endif</span>
<a href="#l2.446"></a><span id="l2.446"> </span>
<a href="#l2.447"></a><span id="l2.447">   StrCpy $1 &quot;Software\Classes\CLSID\{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-  WriteRegStr HKLM &quot;$1\LocalServer32&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; /MAPIStartup&quot;</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-  WriteRegStr HKLM &quot;$1\ProgID&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-  WriteRegStr HKLM &quot;$1\VersionIndependentProgID&quot; &quot;&quot; &quot;MozillaMAPI&quot;</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\LocalServer32&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; /MAPIStartup&quot;</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\ProgID&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\VersionIndependentProgID&quot; &quot;&quot; &quot;MozillaMAPI&quot;</span>
<a href="#l2.454"></a><span id="l2.454">   StrCpy $1 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi\CurVer&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi.1&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-  WriteRegStr HKLM &quot;$1\MozillaMapi.1\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi\CurVer&quot; &quot;&quot; &quot;MozillaMapi.1&quot;</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi.1&quot; &quot;&quot; &quot;Mozilla MAPI&quot;</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$1\MozillaMapi.1\CLSID&quot; &quot;&quot; &quot;{29F458BE-8866-11D5-A3DD-00B0D0F3BAA7}&quot;</span>
<a href="#l2.465"></a><span id="l2.465"> </span>
<a href="#l2.466"></a><span id="l2.466">   ; Mail shell/open/command</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-  WriteRegStr HKLM &quot;$0\shell\open\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -mail&quot;</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\shell\open\command&quot; &quot;&quot; &quot;$\&quot;$8$\&quot; -mail&quot;</span>
<a href="#l2.469"></a><span id="l2.469"> </span>
<a href="#l2.470"></a><span id="l2.470">   ; Capabilities registry keys</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationDescription&quot; &quot;$(REG_APP_DESC)&quot;</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationIcon&quot; &quot;$8,0&quot;</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities&quot; &quot;ApplicationName&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\URLAssociations&quot; &quot;nntp&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\URLAssociations&quot; &quot;news&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-  WriteRegStr HKLM &quot;$0\Capabilities\URLAssociations&quot; &quot;snews&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities&quot; &quot;ApplicationDescription&quot; &quot;$(REG_APP_DESC)&quot;</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities&quot; &quot;ApplicationIcon&quot; &quot;$8,0&quot;</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities&quot; &quot;ApplicationName&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\URLAssociations&quot; &quot;nntp&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\URLAssociations&quot; &quot;news&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+  WriteRegStr ${RegKey} &quot;$0\Capabilities\URLAssociations&quot; &quot;snews&quot; &quot;Thunderbird.Url.news&quot;</span>
<a href="#l2.483"></a><span id="l2.483"> </span>
<a href="#l2.484"></a><span id="l2.484">   ; Protocols</span>
<a href="#l2.485"></a><span id="l2.485">   StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.486"></a><span id="l2.486">   ${AddHandlerValues} &quot;$0\Protocols\nntp&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.487"></a><span id="l2.487">   ${AddHandlerValues} &quot;$0\Protocols\news&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.488"></a><span id="l2.488">   ${AddHandlerValues} &quot;$0\Protocols\snews&quot; &quot;$1&quot; &quot;$8,0&quot; &quot;${AppRegNameNews} URL&quot; &quot;true&quot; &quot;&quot;</span>
<a href="#l2.489"></a><span id="l2.489"> </span>
<a href="#l2.490"></a><span id="l2.490">   ; Registered Application</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-  WriteRegStr HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot; &quot;$0\Capabilities&quot;</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+  WriteRegStr ${RegKey} &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot; &quot;$0\Capabilities&quot;</span>
<a href="#l2.493"></a><span id="l2.493"> !macroend</span>
<a href="#l2.494"></a><span id="l2.494"> !define SetClientsNews &quot;!insertmacro SetClientsNews&quot;</span>
<a href="#l2.495"></a><span id="l2.495"> </span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+; Add Software\Mozilla\ registry entries (uses SHCTX).</span>
<a href="#l2.497"></a><span id="l2.497"> !macro SetAppKeys</span>
<a href="#l2.498"></a><span id="l2.498">   ${GetLongPath} &quot;$INSTDIR&quot; $8</span>
<a href="#l2.499"></a><span id="l2.499">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})\Main&quot;</span>
<a href="#l2.500"></a><span id="l2.500">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Install Directory&quot; &quot;$8&quot; 0</span>
<a href="#l2.501"></a><span id="l2.501">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;PathToExe&quot; &quot;$8\${FileMainEXE}&quot; 0</span>
<a href="#l2.502"></a><span id="l2.502"> </span>
<a href="#l2.503"></a><span id="l2.503">   StrCpy $0 &quot;Software\Mozilla\${BrandFullNameInternal}\${AppVersion} (${AB_CD})\Uninstall&quot;</span>
<a href="#l2.504"></a><span id="l2.504">   ${WriteRegStr2} $TmpVal &quot;$0&quot; &quot;Description&quot; &quot;${BrandFullNameInternal} ${AppVersion} (${ARCH} ${AB_CD})&quot; 0</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineat">@@ -506,17 +549,17 @@</span>
<a href="#l2.506"></a><span id="l2.506">     ${Else}</span>
<a href="#l2.507"></a><span id="l2.507">       SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.508"></a><span id="l2.508">     ${EndIf}</span>
<a href="#l2.509"></a><span id="l2.509">   ${EndIf}</span>
<a href="#l2.510"></a><span id="l2.510"> !macroend</span>
<a href="#l2.511"></a><span id="l2.511"> !define SetUninstallKeys &quot;!insertmacro SetUninstallKeys&quot;</span>
<a href="#l2.512"></a><span id="l2.512"> </span>
<a href="#l2.513"></a><span id="l2.513"> ; Updates protocol handlers if their registry open command value is for this</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-; install location (uses SHCTX)</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+; install location (uses SHCTX).</span>
<a href="#l2.516"></a><span id="l2.516"> !macro UpdateProtocolHandlers</span>
<a href="#l2.517"></a><span id="l2.517">   ; Store the command to open the app with an url in a register for easy access.</span>
<a href="#l2.518"></a><span id="l2.518">   ${GetLongPath} &quot;$INSTDIR\${FileMainEXE}&quot; $8</span>
<a href="#l2.519"></a><span id="l2.519">   StrCpy $0 &quot;SOFTWARE\Classes&quot;</span>
<a href="#l2.520"></a><span id="l2.520">   StrCpy $1 &quot;$\&quot;$8$\&quot; -osint -compose $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.521"></a><span id="l2.521">   StrCpy $2 &quot;$\&quot;$8$\&quot; -osint -mail $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.522"></a><span id="l2.522">   StrCpy $3 &quot;$\&quot;$8$\&quot; $\&quot;%1$\&quot;&quot;</span>
<a href="#l2.523"></a><span id="l2.523"> </span>
<a href="#l2.524"></a><span id="l2.524" class="difflineat">@@ -572,28 +615,38 @@</span>
<a href="#l2.525"></a><span id="l2.525">   ServicesHelper::PathToUniqueRegistryPath &quot;$INSTDIR&quot;</span>
<a href="#l2.526"></a><span id="l2.526">   Pop $R0</span>
<a href="#l2.527"></a><span id="l2.527">   ${If} $R0 != &quot;&quot;</span>
<a href="#l2.528"></a><span id="l2.528">     ; More than one certificate can be specified in a different subfolder</span>
<a href="#l2.529"></a><span id="l2.529">     ; for example: $R0\1, but each individual binary can be signed</span>
<a href="#l2.530"></a><span id="l2.530">     ; with at most one certificate.  A fallback certificate can only be used</span>
<a href="#l2.531"></a><span id="l2.531">     ; if the binary is replaced with a different certificate.</span>
<a href="#l2.532"></a><span id="l2.532">     ; We always use the 64bit registry for certs.</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-    ; This call is ignored on 32-bit systems.</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-    SetRegView 64</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+    ${If} ${RunningX64}</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+      SetRegView 64</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.538"></a><span id="l2.538">     DeleteRegKey HKLM &quot;$R0&quot;</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+    ; Setting the Attempted value will ensure that a new Maintenance Service</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineplus">+    ; install will never be attempted again after this from updates.  The value</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+    ; is used only to see if updates should attempt new service installs.</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+    WriteRegDWORD HKLM &quot;Software\Mozilla\MaintenanceService&quot; &quot;Attempted&quot; 1</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+    ; These values associate the allowed certificates for the current</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+    ; installation.</span>
<a href="#l2.547"></a><span id="l2.547">     WriteRegStr HKLM &quot;$R0\0&quot; &quot;name&quot; &quot;${CERTIFICATE_NAME}&quot;</span>
<a href="#l2.548"></a><span id="l2.548">     WriteRegStr HKLM &quot;$R0\0&quot; &quot;issuer&quot; &quot;${CERTIFICATE_ISSUER}&quot;</span>
<a href="#l2.549"></a><span id="l2.549">     ; These values associate the allowed certificates for the previous</span>
<a href="#l2.550"></a><span id="l2.550">     ;  installation, so that we can update from it cleanly using the</span>
<a href="#l2.551"></a><span id="l2.551">     ;  old updater.exe (which will still have this signature).</span>
<a href="#l2.552"></a><span id="l2.552">     WriteRegStr HKLM &quot;$R0\1&quot; &quot;name&quot; &quot;${CERTIFICATE_NAME_PREVIOUS}&quot;</span>
<a href="#l2.553"></a><span id="l2.553">     WriteRegStr HKLM &quot;$R0\1&quot; &quot;issuer&quot; &quot;${CERTIFICATE_ISSUER_PREVIOUS}&quot;</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineminus">-</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineminus">-    SetRegView lastused</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+    ${If} ${RunningX64}</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+      SetRegView lastused</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+    ${EndIf}</span>
<a href="#l2.559"></a><span id="l2.559">     ClearErrors</span>
<a href="#l2.560"></a><span id="l2.560">   ${EndIf}</span>
<a href="#l2.561"></a><span id="l2.561">   ; Restore the previously used value back</span>
<a href="#l2.562"></a><span id="l2.562">   Pop $R0</span>
<a href="#l2.563"></a><span id="l2.563"> !macroend</span>
<a href="#l2.564"></a><span id="l2.564"> !define AddMaintCertKeys &quot;!insertmacro AddMaintCertKeys&quot;</span>
<a href="#l2.565"></a><span id="l2.565"> !endif</span>
<a href="#l2.566"></a><span id="l2.566"> </span>
<a href="#l2.567"></a><span id="l2.567" class="difflineat">@@ -1022,18 +1075,18 @@ Function SetAsDefaultAppUser</span>
<a href="#l2.568"></a><span id="l2.568">   ${EndUnless}</span>
<a href="#l2.569"></a><span id="l2.569"> </span>
<a href="#l2.570"></a><span id="l2.570">   ; The code after ElevateUAC won't be executed when the user:</span>
<a href="#l2.571"></a><span id="l2.571">   ; a) is a member of the administrators group (e.g. elevation is required)</span>
<a href="#l2.572"></a><span id="l2.572">   ; b) is not a member of the administrators group and chooses to elevate</span>
<a href="#l2.573"></a><span id="l2.573">   ${ElevateUAC}</span>
<a href="#l2.574"></a><span id="l2.574"> </span>
<a href="#l2.575"></a><span id="l2.575">   SetShellVarContext all  ; Set SHCTX to all users (e.g. HKLM)</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-  ${SetClientsMail}</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-  ${SetClientsNews}</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+  ${SetClientsMail} &quot;HKLM&quot;</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+  ${SetClientsNews} &quot;HKLM&quot;</span>
<a href="#l2.580"></a><span id="l2.580"> </span>
<a href="#l2.581"></a><span id="l2.581">   ${RemoveDeprecatedKeys}</span>
<a href="#l2.582"></a><span id="l2.582">   ${MigrateTaskBarShortcut}</span>
<a href="#l2.583"></a><span id="l2.583"> </span>
<a href="#l2.584"></a><span id="l2.584">   ClearErrors</span>
<a href="#l2.585"></a><span id="l2.585">   ${GetParameters} $0</span>
<a href="#l2.586"></a><span id="l2.586">   ${GetOptions} &quot;$0&quot; &quot;/UAC:&quot; $0</span>
<a href="#l2.587"></a><span id="l2.587">   ${If} ${Errors}</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineat">@@ -1060,16 +1113,21 @@ Function SetAsDefaultAppUser</span>
<a href="#l2.589"></a><span id="l2.589">       UAC::ExecCodeSegment $0</span>
<a href="#l2.590"></a><span id="l2.590">     ${EndUnless}</span>
<a href="#l2.591"></a><span id="l2.591">   ${EndIf}</span>
<a href="#l2.592"></a><span id="l2.592"> FunctionEnd</span>
<a href="#l2.593"></a><span id="l2.593"> !define SetAsDefaultAppUser &quot;Call SetAsDefaultAppUser&quot;</span>
<a href="#l2.594"></a><span id="l2.594"> </span>
<a href="#l2.595"></a><span id="l2.595"> !endif</span>
<a href="#l2.596"></a><span id="l2.596"> </span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+; Sets this installation as the default mailer by setting the registry keys</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+; under HKEY_CURRENT_USER via registry calls and using the AppAssocReg NSIS</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineplus">+; plugin. This is a function instead of a macro so it is</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineplus">+; easily called from an elevated instance of the binary. Since this can be</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineplus">+; called by an elevated instance logging is not performed in this function.</span>
<a href="#l2.602"></a><span id="l2.602"> Function SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.603"></a><span id="l2.603">   ; Only set as the user's Mail client if the StartMenuInternet</span>
<a href="#l2.604"></a><span id="l2.604">   ; registry keys are for this install.</span>
<a href="#l2.605"></a><span id="l2.605">   ClearErrors</span>
<a href="#l2.606"></a><span id="l2.606">   ReadRegStr $0 HKLM &quot;Software\Clients\Mail\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.607"></a><span id="l2.607">   ${Unless} ${Errors}</span>
<a href="#l2.608"></a><span id="l2.608">     ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.609"></a><span id="l2.609">     ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineat">@@ -1077,30 +1135,39 @@ Function SetAsDefaultMailAppUserHKCU</span>
<a href="#l2.611"></a><span id="l2.611">       ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.612"></a><span id="l2.612">       ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.613"></a><span id="l2.613">         WriteRegStr HKCU &quot;Software\Clients\Mail&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.614"></a><span id="l2.614">       ${EndIf}</span>
<a href="#l2.615"></a><span id="l2.615">     ${EndIf}</span>
<a href="#l2.616"></a><span id="l2.616">   ${EndUnless}</span>
<a href="#l2.617"></a><span id="l2.617"> </span>
<a href="#l2.618"></a><span id="l2.618">   SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-  ${SetHandlersMail}</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineplus">+</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineplus">+  ${If} ${AtLeastWin8}</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+    ${SetHandlersMail}</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+</span>
<a href="#l2.625"></a><span id="l2.625">   ClearErrors</span>
<a href="#l2.626"></a><span id="l2.626">   ReadRegStr $0 HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameMail}&quot;</span>
<a href="#l2.627"></a><span id="l2.627">   ; Only register as the handler if the app registry name exists</span>
<a href="#l2.628"></a><span id="l2.628">   ; under the RegisteredApplications registry key.</span>
<a href="#l2.629"></a><span id="l2.629">   ${Unless} ${Errors}</span>
<a href="#l2.630"></a><span id="l2.630">     AppAssocReg::SetAppAsDefaultAll &quot;${AppRegNameMail}&quot;</span>
<a href="#l2.631"></a><span id="l2.631">   ${EndUnless}</span>
<a href="#l2.632"></a><span id="l2.632"> FunctionEnd</span>
<a href="#l2.633"></a><span id="l2.633"> </span>
<a href="#l2.634"></a><span id="l2.634"> ; The !ifdef NO_LOG prevents warnings when compiling the installer.nsi due to</span>
<a href="#l2.635"></a><span id="l2.635"> ; this function only being used by SetAsDefaultAppUser.</span>
<a href="#l2.636"></a><span id="l2.636"> !ifdef NO_LOG</span>
<a href="#l2.637"></a><span id="l2.637"> </span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+; Sets this installation as the default news client by setting the registry keys</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+; under HKEY_CURRENT_USER via registry calls and using the AppAssocReg NSIS</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+; plugin. This is a function instead of a macro so it is</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+; easily called from an elevated instance of the binary. Since this can be</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+; called by an elevated instance logging is not performed in this function.</span>
<a href="#l2.643"></a><span id="l2.643"> Function SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.644"></a><span id="l2.644">   ; Only set as the user's News client if the StartMenuInternet</span>
<a href="#l2.645"></a><span id="l2.645">   ; registry keys are for this install.</span>
<a href="#l2.646"></a><span id="l2.646">   ClearErrors</span>
<a href="#l2.647"></a><span id="l2.647">   ReadRegStr $0 HKLM &quot;Software\Clients\News\${ClientsRegName}\DefaultIcon&quot; &quot;&quot;</span>
<a href="#l2.648"></a><span id="l2.648">   ${Unless} ${Errors}</span>
<a href="#l2.649"></a><span id="l2.649">     ${GetPathFromString} &quot;$0&quot; $0</span>
<a href="#l2.650"></a><span id="l2.650">     ${GetParent} &quot;$0&quot; $0</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineat">@@ -1108,17 +1175,21 @@ Function SetAsDefaultNewsAppUserHKCU</span>
<a href="#l2.652"></a><span id="l2.652">       ${GetLongPath} &quot;$0&quot; $0</span>
<a href="#l2.653"></a><span id="l2.653">       ${If} &quot;$0&quot; == &quot;$INSTDIR&quot;</span>
<a href="#l2.654"></a><span id="l2.654">         WriteRegStr HKCU &quot;Software\Clients\News&quot; &quot;&quot; &quot;${ClientsRegName}&quot;</span>
<a href="#l2.655"></a><span id="l2.655">       ${EndIf}</span>
<a href="#l2.656"></a><span id="l2.656">     ${EndIf}</span>
<a href="#l2.657"></a><span id="l2.657">   ${EndUnless}</span>
<a href="#l2.658"></a><span id="l2.658"> </span>
<a href="#l2.659"></a><span id="l2.659">   SetShellVarContext current  ; Set SHCTX to the current user (e.g. HKCU)</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineminus">-  ${SetHandlersNews}</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineplus">+</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+  ${If} ${AtLeastWin8}</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+    ${SetHandlersNews}</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineplus">+  ${EndIf}</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineplus">+</span>
<a href="#l2.666"></a><span id="l2.666">   ClearErrors</span>
<a href="#l2.667"></a><span id="l2.667">   ReadRegStr $0 HKLM &quot;Software\RegisteredApplications&quot; &quot;${AppRegNameNews}&quot;</span>
<a href="#l2.668"></a><span id="l2.668">   ; Only register as the handler if the app registry name exists</span>
<a href="#l2.669"></a><span id="l2.669">   ; under the RegisteredApplications registry key.</span>
<a href="#l2.670"></a><span id="l2.670">   ${Unless} ${Errors}</span>
<a href="#l2.671"></a><span id="l2.671">     AppAssocReg::SetAppAsDefaultAll &quot;${AppRegNameNews}&quot;</span>
<a href="#l2.672"></a><span id="l2.672">   ${EndUnless}</span>
<a href="#l2.673"></a><span id="l2.673"> FunctionEnd</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/installer/windows/nsis/updater_append.ini</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/installer/windows/nsis/updater_append.ini</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,12 +1,8 @@</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineminus">-; This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-; License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-; file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> ; IMPORTANT: This file should always start with a newline in case a locale</span>
<a href="#l3.10"></a><span id="l3.10"> ; provided updater.ini does not end with a newline.</span>
<a href="#l3.11"></a><span id="l3.11"> ; Application to launch after an update has been successfully applied. This</span>
<a href="#l3.12"></a><span id="l3.12"> ; must be in the same directory or a sub-directory of the directory of the</span>
<a href="#l3.13"></a><span id="l3.13"> ; application executable that initiated the software update.</span>
<a href="#l3.14"></a><span id="l3.14"> [PostUpdateWin]</span>
<a href="#l3.15"></a><span id="l3.15"> ; ExeRelPath is the path to the PostUpdateWin executable relative to the</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

