<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23909:13e2fda05aa3793cde3c1afb06472de6d391e88a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 13e2fda05aa3793cde3c1afb06472de6d391e88a" />
<meta property="og:url" content="/comm-central/rev/13e2fda05aa3793cde3c1afb06472de6d391e88a" />
<meta property="og:description" content="Bug 1459748 - Fork RDF to comm-central. rs=bustage-fix" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 13e2fda05aa3793cde3c1afb06472de6d391e88a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/13e2fda05aa3793cde3c1afb06472de6d391e88a">shortlog</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/13e2fda05aa3793cde3c1afb06472de6d391e88a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a">files</a> |
changeset |
<a href="/comm-central/raw-rev/13e2fda05aa3793cde3c1afb06472de6d391e88a">raw</a>  | <a href="/comm-central/archive/13e2fda05aa3793cde3c1afb06472de6d391e88a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1459748">Bug 1459748</a> - Fork RDF to comm-central. rs=bustage-fix
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 08 May 2018 18:19:56 +0200</td></tr>

<tr>
 <td>changeset 23909</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/13e2fda05aa3793cde3c1afb06472de6d391e88a">13e2fda05aa3793cde3c1afb06472de6d391e88a</a></td>
</tr>



<tr>
<td>parent 23908</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b00e830b9e5e3a006102519c34b8fc8e862e9cdf">b00e830b9e5e3a006102519c34b8fc8e862e9cdf</a>
</td>
</tr>

<tr>
<td>child 23910</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0719cec3b02019d20a742a39900fd36752188a23">0719cec3b02019d20a742a39900fd36752188a23</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=13e2fda05aa3793cde3c1afb06472de6d391e88a">14408</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 08 May 2018 17:01:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@13e2fda05aa3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=13e2fda05aa3793cde3c1afb06472de6d391e88a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=13e2fda05aa3793cde3c1afb06472de6d391e88a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=13e2fda05aa3793cde3c1afb06472de6d391e88a&newProject=comm-central&newRevision=13e2fda05aa3793cde3c1afb06472de6d391e88a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=13e2fda05aa3793cde3c1afb06472de6d391e88a&newProject=comm-central&newRevision=13e2fda05aa3793cde3c1afb06472de6d391e88a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=13e2fda05aa3793cde3c1afb06472de6d391e88a&newProject=comm-central&newRevision=13e2fda05aa3793cde3c1afb06472de6d391e88a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bustage-fix%29&revcount=50">bustage-fix</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1459748">1459748</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1459748">Bug 1459748</a> - Fork RDF to comm-central. rs=bustage-fix</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/mailnews/mailnews.mozbuild">mailnews/mailnews.mozbuild</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/mailnews/mailnews.mozbuild">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/mailnews/mailnews.mozbuild">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/mailnews/mailnews.mozbuild">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/mailnews/mailnews.mozbuild">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/mailnews/mailnews.mozbuild">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/moz.build">rdf/base/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/moz.build">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/moz.build">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/moz.build">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/moz.build">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsCompositeDataSource.cpp">rdf/base/nsCompositeDataSource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsCompositeDataSource.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsCompositeDataSource.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsCompositeDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsCompositeDataSource.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsCompositeDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsContainerEnumerator.cpp">rdf/base/nsContainerEnumerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsContainerEnumerator.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsContainerEnumerator.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsContainerEnumerator.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsContainerEnumerator.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsContainerEnumerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsDefaultResourceFactory.cpp">rdf/base/nsDefaultResourceFactory.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsDefaultResourceFactory.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsDefaultResourceFactory.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsDefaultResourceFactory.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsDefaultResourceFactory.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsDefaultResourceFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFCompositeDataSource.idl">rdf/base/nsIRDFCompositeDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFCompositeDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFCompositeDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFCompositeDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFCompositeDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFCompositeDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainer.idl">rdf/base/nsIRDFContainer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainer.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainer.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainer.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainer.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainerUtils.idl">rdf/base/nsIRDFContainerUtils.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainerUtils.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainerUtils.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainerUtils.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainerUtils.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContainerUtils.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContentSink.h">rdf/base/nsIRDFContentSink.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContentSink.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContentSink.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContentSink.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContentSink.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFContentSink.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDataSource.idl">rdf/base/nsIRDFDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDelegateFactory.idl">rdf/base/nsIRDFDelegateFactory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDelegateFactory.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDelegateFactory.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDelegateFactory.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDelegateFactory.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFDelegateFactory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInMemoryDataSource.idl">rdf/base/nsIRDFInMemoryDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInMemoryDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInMemoryDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInMemoryDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInMemoryDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInMemoryDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInferDataSource.idl">rdf/base/nsIRDFInferDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInferDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInferDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInferDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInferDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFInferDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFLiteral.idl">rdf/base/nsIRDFLiteral.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFLiteral.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFLiteral.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFLiteral.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFLiteral.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFLiteral.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFNode.idl">rdf/base/nsIRDFNode.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFNode.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFNode.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFNode.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFNode.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFNode.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFObserver.idl">rdf/base/nsIRDFObserver.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFObserver.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFObserver.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFObserver.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFObserver.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFObserver.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPropagatableDataSource.idl">rdf/base/nsIRDFPropagatableDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPropagatableDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPropagatableDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPropagatableDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPropagatableDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPropagatableDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPurgeableDataSource.idl">rdf/base/nsIRDFPurgeableDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPurgeableDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPurgeableDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPurgeableDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPurgeableDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFPurgeableDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFRemoteDataSource.idl">rdf/base/nsIRDFRemoteDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFRemoteDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFRemoteDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFRemoteDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFRemoteDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFRemoteDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFResource.idl">rdf/base/nsIRDFResource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFResource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFResource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFResource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFResource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFResource.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFService.idl">rdf/base/nsIRDFService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFService.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFService.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFService.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFService.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLParser.idl">rdf/base/nsIRDFXMLParser.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLParser.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLParser.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLParser.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLParser.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLParser.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSerializer.idl">rdf/base/nsIRDFXMLSerializer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSerializer.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSerializer.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSerializer.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSerializer.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSerializer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSink.idl">rdf/base/nsIRDFXMLSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSink.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSink.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSink.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSink.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSink.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSource.idl">rdf/base/nsIRDFXMLSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsIRDFXMLSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsInMemoryDataSource.cpp">rdf/base/nsInMemoryDataSource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsInMemoryDataSource.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsInMemoryDataSource.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsInMemoryDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsInMemoryDataSource.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsInMemoryDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.cpp">rdf/base/nsNameSpaceMap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.h">rdf/base/nsNameSpaceMap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsNameSpaceMap.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFBaseDataSources.h">rdf/base/nsRDFBaseDataSources.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFBaseDataSources.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFBaseDataSources.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFBaseDataSources.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFBaseDataSources.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFBaseDataSources.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainer.cpp">rdf/base/nsRDFContainer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainer.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainer.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainer.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainer.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainerUtils.cpp">rdf/base/nsRDFContainerUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainerUtils.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainerUtils.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainerUtils.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainerUtils.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContainerUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContentSink.cpp">rdf/base/nsRDFContentSink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContentSink.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContentSink.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContentSink.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContentSink.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFContentSink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.cpp">rdf/base/nsRDFResource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.h">rdf/base/nsRDFResource.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFResource.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.cpp">rdf/base/nsRDFService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.h">rdf/base/nsRDFService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLDataSource.cpp">rdf/base/nsRDFXMLDataSource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLDataSource.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLDataSource.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLDataSource.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.cpp">rdf/base/nsRDFXMLParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.h">rdf/base/nsRDFXMLParser.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLParser.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.cpp">rdf/base/nsRDFXMLSerializer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.h">rdf/base/nsRDFXMLSerializer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/nsRDFXMLSerializer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdf.h">rdf/base/rdf.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdf.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdf.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdf.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdf.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdf.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfIDataSource.idl">rdf/base/rdfIDataSource.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfIDataSource.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfIDataSource.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfIDataSource.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfIDataSource.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfIDataSource.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfITripleVisitor.idl">rdf/base/rdfITripleVisitor.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfITripleVisitor.idl">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfITripleVisitor.idl">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfITripleVisitor.idl">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfITripleVisitor.idl">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfITripleVisitor.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.cpp">rdf/base/rdfutil.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.h">rdf/base/rdfutil.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/base/rdfutil.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/moz.build">rdf/build/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/moz.build">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/moz.build">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/moz.build">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/moz.build">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFCID.h">rdf/build/nsRDFCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFCID.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFCID.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFCID.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFCID.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFModule.cpp">rdf/build/nsRDFModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFModule.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFModule.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFModule.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFModule.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/build/nsRDFModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/moz.build">rdf/datasource/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/moz.build">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/moz.build">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/moz.build">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/moz.build">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsILocalStore.h">rdf/datasource/nsILocalStore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsILocalStore.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsILocalStore.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsILocalStore.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsILocalStore.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsILocalStore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsIRDFFTP.h">rdf/datasource/nsIRDFFTP.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsIRDFFTP.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsIRDFFTP.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsIRDFFTP.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsIRDFFTP.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsIRDFFTP.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsLocalStore.cpp">rdf/datasource/nsLocalStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsLocalStore.cpp">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsLocalStore.cpp">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsLocalStore.cpp">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsLocalStore.cpp">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsLocalStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsRDFBuiltInDataSources.h">rdf/datasource/nsRDFBuiltInDataSources.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsRDFBuiltInDataSources.h">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsRDFBuiltInDataSources.h">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsRDFBuiltInDataSources.h">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsRDFBuiltInDataSources.h">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/datasource/nsRDFBuiltInDataSources.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/moz.build">rdf/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/moz.build">file</a> |
<a href="/comm-central/annotate/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/moz.build">annotate</a> |
<a href="/comm-central/diff/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/moz.build">diff</a> |
<a href="/comm-central/comparison/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/moz.build">comparison</a> |
<a href="/comm-central/log/13e2fda05aa3793cde3c1afb06472de6d391e88a/rdf/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mailnews.mozbuild</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mailnews.mozbuild</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -7,10 +7,11 @@ if CONFIG['MOZ_LDAP_XPCOM']:</span>
<a href="#l1.4"></a><span id="l1.4">     DIRS += [</span>
<a href="#l1.5"></a><span id="l1.5">         '/%s/ldap' % CONFIG['commreltopsrcdir'],</span>
<a href="#l1.6"></a><span id="l1.6">         '/%s/ldap/xpcom' % CONFIG['commreltopsrcdir'],</span>
<a href="#l1.7"></a><span id="l1.7">     ]</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> DIRS += [</span>
<a href="#l1.10"></a><span id="l1.10">     '/%s/mailnews' % CONFIG['commreltopsrcdir'],</span>
<a href="#l1.11"></a><span id="l1.11">     '/%s/db' % CONFIG['commreltopsrcdir'],</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    '/%s/rdf' % CONFIG['commreltopsrcdir'],</span>
<a href="#l1.13"></a><span id="l1.13"> ]</span>
<a href="#l1.14"></a><span id="l1.14"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/rdf/base/moz.build</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,59 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+XPIDL_SOURCES += [</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    'nsIRDFCompositeDataSource.idl',</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    'nsIRDFContainer.idl',</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    'nsIRDFContainerUtils.idl',</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    'nsIRDFDataSource.idl',</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    'nsIRDFDelegateFactory.idl',</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    'nsIRDFInferDataSource.idl',</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    'nsIRDFInMemoryDataSource.idl',</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    'nsIRDFLiteral.idl',</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    'nsIRDFNode.idl',</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    'nsIRDFObserver.idl',</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    'nsIRDFPropagatableDataSource.idl',</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    'nsIRDFPurgeableDataSource.idl',</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    'nsIRDFRemoteDataSource.idl',</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    'nsIRDFResource.idl',</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    'nsIRDFService.idl',</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    'nsIRDFXMLParser.idl',</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+    'nsIRDFXMLSerializer.idl',</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    'nsIRDFXMLSink.idl',</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    'nsIRDFXMLSource.idl',</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    'rdfIDataSource.idl',</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    'rdfITripleVisitor.idl',</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+]</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+XPIDL_MODULE = 'rdf'</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+EXPORTS += [</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    'nsIRDFContentSink.h',</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    'nsRDFResource.h',</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    'rdf.h',</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+]</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+UNIFIED_SOURCES += [</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    'nsCompositeDataSource.cpp',</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    'nsContainerEnumerator.cpp',</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+    'nsDefaultResourceFactory.cpp',</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    'nsInMemoryDataSource.cpp',</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    'nsNameSpaceMap.cpp',</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    'nsRDFContainer.cpp',</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    'nsRDFContainerUtils.cpp',</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    'nsRDFContentSink.cpp',</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    'nsRDFResource.cpp',</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    'nsRDFService.cpp',</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    'nsRDFXMLDataSource.cpp',</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    'nsRDFXMLParser.cpp',</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    'nsRDFXMLSerializer.cpp',</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    'rdfutil.cpp',</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+]</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+FINAL_LIBRARY = 'xul'</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+if CONFIG['CC_TYPE'] in ('clang', 'gcc'):</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    CXXFLAGS += ['-Wno-error=shadow']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/rdf/base/nsCompositeDataSource.cpp</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,1357 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+/*</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  A simple composite data source implementation. A composit data</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  source is just a strategy for combining individual data sources into</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  a collective graph.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  1) A composite data source holds a sequence of data sources. The set</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+     of data sources can be specified during creation of the</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+     database. Data sources can also be added/deleted from a database</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+     later.</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  2) The aggregation mechanism is based on simple super-positioning of</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+     the graphs from the datasources. If there is a conflict (i.e.,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+     data source A has a true arc from foo to bar while data source B</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+     has a false arc from foo to bar), the data source that it earlier</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+     in the sequence wins.</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+     The implementation below doesn't really do this and needs to be</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+     fixed.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+*/</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+#include &quot;xpcom-config.h&quot;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+#include &quot;nsIRDFCompositeDataSource.h&quot;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+#include &quot;nsIRDFObserver.h&quot;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+#include &lt;stdio.h&gt;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+mozilla::LazyLogModule nsRDFLog(&quot;RDF&quot;);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+//</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+// CompositeDataSourceImpl</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+//</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+class CompositeEnumeratorImpl;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+class CompositeArcsInOutEnumeratorImpl;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+class CompositeAssertionEnumeratorImpl;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+class CompositeDataSourceImpl : public nsIRDFCompositeDataSource,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+                                public nsIRDFObserver</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+{</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+public:</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    CompositeDataSourceImpl(void);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+    explicit CompositeDataSourceImpl(char** dataSources);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    // nsISupports interface</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(CompositeDataSourceImpl,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+                                             nsIRDFCompositeDataSource)</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+    // nsIRDFDataSource interface</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+    NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+    // nsIRDFCompositeDataSource interface</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    NS_DECL_NSIRDFCOMPOSITEDATASOURCE</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    // nsIRDFObserver interface</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    NS_DECL_NSIRDFOBSERVER</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+    bool HasAssertionN(int n, nsIRDFResource* source,</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+                            nsIRDFResource* property,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+                            nsIRDFNode* target,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+                            bool tv);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+protected:</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+    nsCOMArray&lt;nsIRDFObserver&gt; mObservers;</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    nsCOMArray&lt;nsIRDFDataSource&gt; mDataSources;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    bool        mAllowNegativeAssertions;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    bool        mCoalesceDuplicateArcs;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    int32_t     mUpdateBatchNest;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    virtual ~CompositeDataSourceImpl() {}</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+    friend class CompositeEnumeratorImpl;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    friend class CompositeArcsInOutEnumeratorImpl;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+    friend class CompositeAssertionEnumeratorImpl;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+};</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+//</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+// CompositeEnumeratorImpl</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+//</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+class CompositeEnumeratorImpl : public nsISimpleEnumerator</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+{</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+    // nsISupports</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    // nsISimpleEnumerator interface</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    // pure abstract methods to be overridden</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+    virtual nsresult</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+    GetEnumerator(nsIRDFDataSource* aDataSource, nsISimpleEnumerator** aResult) = 0;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+    virtual nsresult</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+    HasNegation(nsIRDFDataSource* aDataSource, nsIRDFNode* aNode, bool* aResult) = 0;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+protected:</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+    CompositeEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+                            bool aAllowNegativeAssertions,</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+                            bool aCoalesceDuplicateArcs);</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+    virtual ~CompositeEnumeratorImpl();</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+    CompositeDataSourceImpl* mCompositeDataSource;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+    nsISimpleEnumerator* mCurrent;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    nsIRDFNode*  mResult;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+    int32_t      mNext;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+    AutoTArray&lt;nsCOMPtr&lt;nsIRDFNode&gt;, 8&gt;  mAlreadyReturned;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+    bool mAllowNegativeAssertions;</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    bool mCoalesceDuplicateArcs;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+};</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+CompositeEnumeratorImpl::CompositeEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+                                                 bool aAllowNegativeAssertions,</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+                                                 bool aCoalesceDuplicateArcs)</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    : mCompositeDataSource(aCompositeDataSource),</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+      mCurrent(nullptr),</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+      mResult(nullptr),</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+	  mNext(0),</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+      mAllowNegativeAssertions(aAllowNegativeAssertions),</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+      mCoalesceDuplicateArcs(aCoalesceDuplicateArcs)</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+{</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+    NS_ADDREF(mCompositeDataSource);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+}</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+CompositeEnumeratorImpl::~CompositeEnumeratorImpl(void)</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+{</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+    NS_IF_RELEASE(mCurrent);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+    NS_IF_RELEASE(mResult);</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+    NS_RELEASE(mCompositeDataSource);</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+}</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+NS_IMPL_ADDREF(CompositeEnumeratorImpl)</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+NS_IMPL_RELEASE(CompositeEnumeratorImpl)</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+NS_IMPL_QUERY_INTERFACE(CompositeEnumeratorImpl, nsISimpleEnumerator)</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+CompositeEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+{</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+    // If we've already queued up a next target, then yep, there are</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+    // more elements.</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+    if (mResult) {</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+        *aResult = true;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+        return NS_OK;</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+    }</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+    // Otherwise, we'll need to find a next target, switching cursors</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+    // if necessary.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+    for ( ; mNext &lt; mCompositeDataSource-&gt;mDataSources.Count(); ++mNext) {</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+        if (! mCurrent) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+            // We don't have a current enumerator, so create a new one on</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+            // the next data source.</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+            nsIRDFDataSource* datasource =</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+                mCompositeDataSource-&gt;mDataSources[mNext];</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+            rv = GetEnumerator(datasource, &amp;mCurrent);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+            if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+                continue;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+            NS_ASSERTION(mCurrent != nullptr, &quot;you're always supposed to return an enumerator from GetEnumerator, punk.&quot;);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+            if (! mCurrent)</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+                continue;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+        }</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+        do {</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+            int32_t i;</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+            bool hasMore;</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+            rv = mCurrent-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+            // Is the current enumerator depleted?</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+            if (! hasMore) {</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+                NS_RELEASE(mCurrent);</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+                break;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+            }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+            // Even if the current enumerator has more elements, we still</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+            // need to check that the current element isn't masked by</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+            // a negation in an earlier data source.</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+            // &quot;Peek&quot; ahead and pull out the next target.</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; result;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+            rv = mCurrent-&gt;GetNext(getter_AddRefs(result));</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+            rv = result-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) &amp;mResult);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+            if (mAllowNegativeAssertions)</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+            {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+                // See if any previous data source negates this</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+                bool hasNegation = false;</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+                for (i = mNext - 1; i &gt;= 0; --i)</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+                {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+                    nsIRDFDataSource* datasource =</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+                        mCompositeDataSource-&gt;mDataSources[i];</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+                    rv = HasNegation(datasource, mResult, &amp;hasNegation);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+                    if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+                    if (hasNegation)</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+                        break;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+                }</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+                // if so, we've gotta keep looking</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+                if (hasNegation)</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+                {</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+                    NS_RELEASE(mResult);</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+                    continue;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+                }</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+            }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+            if (mCoalesceDuplicateArcs)</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+            {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+                // Now see if we've returned it once already.</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+                // XXX N.B. performance here...may want to hash if things get large?</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+                bool alreadyReturned = false;</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+                for (i = mAlreadyReturned.Length() - 1; i &gt;= 0; --i)</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+                {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+                    if (mAlreadyReturned[i] == mResult)</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+                    {</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+                        alreadyReturned = true;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+                        break;</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+                    }</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+                }</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+                if (alreadyReturned)</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+                {</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+                    NS_RELEASE(mResult);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+                    continue;</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+                }</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+            }</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+            // If we get here, then we've really found one. It'll</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+            // remain cached in mResult until GetNext() sucks it out.</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+            *aResult = true;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+            // Remember that we returned it, so we don't return duplicates.</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+            // XXX I wonder if we should make unique-checking be</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+            // optional. This could get to be pretty expensive (this</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+            // implementation turns iteration into O(n^2)).</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+            if (mCoalesceDuplicateArcs)</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+            {</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+                mAlreadyReturned.AppendElement(mResult);</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+            }</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+            return NS_OK;</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+        } while (1);</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+    }</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+    // if we get here, there aren't any elements left.</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+    *aResult = false;</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+}</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+CompositeEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+{</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+    bool hasMore;</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+    if (! hasMore)</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+    // Don't AddRef: we &quot;transfer&quot; ownership to the caller</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+    *aResult = mResult;</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+    mResult = nullptr;</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+}</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+//</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+// CompositeArcsInOutEnumeratorImpl</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+//</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+//</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+class CompositeArcsInOutEnumeratorImpl : public CompositeEnumeratorImpl</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+{</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+public:</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+    enum Type { eArcsIn, eArcsOut };</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+    virtual ~CompositeArcsInOutEnumeratorImpl();</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+    virtual nsresult</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+    GetEnumerator(nsIRDFDataSource* aDataSource, nsISimpleEnumerator** aResult) override;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+    virtual nsresult</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+    HasNegation(nsIRDFDataSource* aDataSource, nsIRDFNode* aNode, bool* aResult) override;</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+    CompositeArcsInOutEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+                                     nsIRDFNode* aNode,</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+                                     Type aType,</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+                                     bool aAllowNegativeAssertions,</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+                                     bool aCoalesceDuplicateArcs);</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+private:</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+    nsIRDFNode* mNode;</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+    Type        mType;</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+};</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+CompositeArcsInOutEnumeratorImpl::CompositeArcsInOutEnumeratorImpl(</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+                CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+                nsIRDFNode* aNode,</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+                Type aType,</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+                bool aAllowNegativeAssertions,</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+                bool aCoalesceDuplicateArcs)</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+    : CompositeEnumeratorImpl(aCompositeDataSource, aAllowNegativeAssertions, aCoalesceDuplicateArcs),</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+      mNode(aNode),</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+      mType(aType)</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+{</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+    NS_ADDREF(mNode);</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+}</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+CompositeArcsInOutEnumeratorImpl::~CompositeArcsInOutEnumeratorImpl()</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+{</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+    NS_RELEASE(mNode);</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+}</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+nsresult</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+CompositeArcsInOutEnumeratorImpl::GetEnumerator(</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+                 nsIRDFDataSource* aDataSource,</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+                 nsISimpleEnumerator** aResult)</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+{</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+    if (mType == eArcsIn) {</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+        return aDataSource-&gt;ArcLabelsIn(mNode, aResult);</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+    }</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+    else {</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; resource( do_QueryInterface(mNode) );</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+        return aDataSource-&gt;ArcLabelsOut(resource, aResult);</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+    }</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+}</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+nsresult</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+CompositeArcsInOutEnumeratorImpl::HasNegation(</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+                 nsIRDFDataSource* aDataSource,</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+                 nsIRDFNode* aNode,</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+                 bool* aResult)</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+{</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+    *aResult = false;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+}</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+//</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+// CompositeAssertionEnumeratorImpl</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+//</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+class CompositeAssertionEnumeratorImpl : public CompositeEnumeratorImpl</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+{</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+public:</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+    virtual nsresult</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+    GetEnumerator(nsIRDFDataSource* aDataSource, nsISimpleEnumerator** aResult) override;</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+    virtual nsresult</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+    HasNegation(nsIRDFDataSource* aDataSource, nsIRDFNode* aNode, bool* aResult) override;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+    CompositeAssertionEnumeratorImpl(CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+                                     nsIRDFResource* aSource,</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+                                     nsIRDFResource* aProperty,</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+                                     nsIRDFNode* aTarget,</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+                                     bool aTruthValue,</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+                                     bool aAllowNegativeAssertions,</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+                                     bool aCoalesceDuplicateArcs);</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+    virtual ~CompositeAssertionEnumeratorImpl();</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+private:</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+    nsIRDFResource* mSource;</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+    nsIRDFResource* mProperty;</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+    nsIRDFNode*     mTarget;</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+    bool            mTruthValue;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+};</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+CompositeAssertionEnumeratorImpl::CompositeAssertionEnumeratorImpl(</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+                  CompositeDataSourceImpl* aCompositeDataSource,</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+                  nsIRDFResource* aSource,</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+                  nsIRDFResource* aProperty,</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+                  nsIRDFNode* aTarget,</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+                  bool aTruthValue,</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+                  bool aAllowNegativeAssertions,</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+                  bool aCoalesceDuplicateArcs)</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+    : CompositeEnumeratorImpl(aCompositeDataSource, aAllowNegativeAssertions, aCoalesceDuplicateArcs),</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+      mSource(aSource),</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+      mProperty(aProperty),</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+      mTarget(aTarget),</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+      mTruthValue(aTruthValue)</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+{</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+    NS_IF_ADDREF(mSource);</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+    NS_ADDREF(mProperty); // always must be specified</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+    NS_IF_ADDREF(mTarget);</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+}</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+CompositeAssertionEnumeratorImpl::~CompositeAssertionEnumeratorImpl()</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+{</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+    NS_IF_RELEASE(mSource);</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+    NS_RELEASE(mProperty);</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+    NS_IF_RELEASE(mTarget);</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+}</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+nsresult</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+CompositeAssertionEnumeratorImpl::GetEnumerator(</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+                 nsIRDFDataSource* aDataSource,</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+                 nsISimpleEnumerator** aResult)</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+{</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+    if (mSource) {</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+        return aDataSource-&gt;GetTargets(mSource, mProperty, mTruthValue, aResult);</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+    }</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+    else {</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+        return aDataSource-&gt;GetSources(mProperty, mTarget, mTruthValue, aResult);</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+    }</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+}</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+nsresult</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+CompositeAssertionEnumeratorImpl::HasNegation(</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+                 nsIRDFDataSource* aDataSource,</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+                 nsIRDFNode* aNode,</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+                 bool* aResult)</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+{</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+    if (mSource) {</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+        return aDataSource-&gt;HasAssertion(mSource, mProperty, aNode, !mTruthValue, aResult);</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+    }</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+    else {</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; source( do_QueryInterface(aNode) );</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+        return aDataSource-&gt;HasAssertion(source, mProperty, mTarget, !mTruthValue, aResult);</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+    }</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+}</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+nsresult</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+NS_NewRDFCompositeDataSource(nsIRDFCompositeDataSource** result)</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+{</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+    CompositeDataSourceImpl* db = new CompositeDataSourceImpl();</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+    if (! db)</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+    *result = db;</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+    NS_ADDREF(*result);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+}</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+CompositeDataSourceImpl::CompositeDataSourceImpl(void)</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+	: mAllowNegativeAssertions(true),</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+	  mCoalesceDuplicateArcs(true),</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+      mUpdateBatchNest(0)</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+{</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+}</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+//</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+// nsISupports interface</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+//</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_CLASS(CompositeDataSourceImpl)</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(CompositeDataSourceImpl)</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+    uint32_t i, count = tmp-&gt;mDataSources.Count();</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+    for (i = count; i &gt; 0; --i) {</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+        tmp-&gt;mDataSources[i - 1]-&gt;RemoveObserver(tmp);</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+        tmp-&gt;mDataSources.RemoveObjectAt(i - 1);</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+    }</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+    NS_IMPL_CYCLE_COLLECTION_UNLINK(mObservers);</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(CompositeDataSourceImpl)</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mObservers)</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mDataSources)</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_ADDREF(CompositeDataSourceImpl)</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_RELEASE(CompositeDataSourceImpl)</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineplus">+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(CompositeDataSourceImpl)</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFCompositeDataSource)</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFObserver)</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFCompositeDataSource)</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIRDFCompositeDataSource)</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineplus">+</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineplus">+</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineplus">+//</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineplus">+// nsIRDFDataSource interface</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+//</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+CompositeDataSourceImpl::GetURI(nsACString&amp; aURI)</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+{</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineplus">+    aURI.SetIsVoid(true);</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineplus">+}</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+CompositeDataSourceImpl::GetSource(nsIRDFResource* property,</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+                                   nsIRDFNode* target,</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+                                   bool tv,</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+                                   nsIRDFResource** source)</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineplus">+{</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineplus">+	if (!mAllowNegativeAssertions &amp;&amp; !tv)</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+		return(NS_RDF_NO_VALUE);</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+    int32_t count = mDataSources.Count();</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineplus">+    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+        nsresult rv;</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+        rv = mDataSources[i]-&gt;GetSource(property, target, tv, source);</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+        if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+            continue;</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineplus">+</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineplus">+        if (!mAllowNegativeAssertions) return(NS_OK);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineplus">+        // okay, found it. make sure we don't have the opposite</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+        // asserted in a more local data source</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+        if (!HasAssertionN(count-1, *source, property, target, !tv))</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+            return NS_OK;</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+        NS_RELEASE(*source);</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+        return NS_RDF_NO_VALUE;</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+    }</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+    return NS_RDF_NO_VALUE;</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineplus">+}</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+CompositeDataSourceImpl::GetSources(nsIRDFResource* aProperty,</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+                                    nsIRDFNode* aTarget,</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+                                    bool aTruthValue,</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineplus">+                                    nsISimpleEnumerator** aResult)</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineplus">+{</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+    if (! aTarget)</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+        return(NS_RDF_NO_VALUE);</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+    *aResult = new CompositeAssertionEnumeratorImpl(this, nullptr, aProperty,</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+                                                    aTarget, aTruthValue,</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+                                                    mAllowNegativeAssertions,</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+                                                    mCoalesceDuplicateArcs);</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+    if (! *aResult)</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+    NS_ADDREF(*aResult);</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineplus">+}</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineplus">+CompositeDataSourceImpl::GetTarget(nsIRDFResource* aSource,</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineplus">+                                   nsIRDFResource* aProperty,</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+                                   bool aTruthValue,</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+                                   nsIRDFNode** aResult)</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+{</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineplus">+        return(NS_RDF_NO_VALUE);</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineplus">+</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+    int32_t count = mDataSources.Count();</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+        nsresult rv;</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+        rv = mDataSources[i]-&gt;GetTarget(aSource, aProperty, aTruthValue,</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+                                        aResult);</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+            return rv;</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+        if (rv == NS_OK) {</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+            // okay, found it. make sure we don't have the opposite</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+            // asserted in an earlier data source</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineplus">+            if (mAllowNegativeAssertions) {</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+                if (HasAssertionN(count-1, aSource, aProperty, *aResult, !aTruthValue)) {</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+                    // whoops, it's been negated.</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+                    NS_RELEASE(*aResult);</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineplus">+                    return NS_RDF_NO_VALUE;</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineplus">+                }</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+            }</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineplus">+            return NS_OK;</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+        }</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+    }</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+    // Otherwise, we couldn't find it at all.</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineplus">+    return NS_RDF_NO_VALUE;</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineplus">+}</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineplus">+bool</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineplus">+CompositeDataSourceImpl::HasAssertionN(int n,</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineplus">+                                       nsIRDFResource* aSource,</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+                                       nsIRDFResource* aProperty,</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+                                       nsIRDFNode* aTarget,</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineplus">+                                       bool aTruthValue)</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+{</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+    for (int32_t m = 0; m &lt; n; ++m) {</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineplus">+        bool result;</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineplus">+        rv = mDataSources[m]-&gt;HasAssertion(aSource, aProperty, aTarget,</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+                                           aTruthValue, &amp;result);</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+            return false;</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+        // found it!</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+        if (result)</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+            return true;</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineplus">+    }</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+    return false;</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+}</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineplus">+</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineplus">+CompositeDataSourceImpl::GetTargets(nsIRDFResource* aSource,</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+                                    nsIRDFResource* aProperty,</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineplus">+                                    bool aTruthValue,</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+                                    nsISimpleEnumerator** aResult)</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+{</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineplus">+</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineplus">+    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+        return(NS_RDF_NO_VALUE);</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineplus">+</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineplus">+    *aResult =</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+        new CompositeAssertionEnumeratorImpl(this,</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+                                             aSource, aProperty, nullptr,</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+                                             aTruthValue,</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+                                             mAllowNegativeAssertions,</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+                                             mCoalesceDuplicateArcs);</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+    if (! *aResult)</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineplus">+</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+    NS_ADDREF(*aResult);</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineplus">+}</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+CompositeDataSourceImpl::Assert(nsIRDFResource* aSource,</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+                                nsIRDFResource* aProperty,</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+                                nsIRDFNode* aTarget,</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+                                bool aTruthValue)</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineplus">+{</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineplus">+</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+    if (! aTarget)</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+        return(NS_RDF_ASSERTION_REJECTED);</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+    // XXX Need to add back the stuff for unblocking ...</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+    // We iterate backwards from the last data source which was added</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+    // (&quot;the most remote&quot;) to the first (&quot;the most local&quot;), trying to</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+    // apply the assertion in each.</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+        rv = mDataSources[i]-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+        if (NS_RDF_ASSERTION_ACCEPTED == rv)</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+            return rv;</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+            return rv;</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+    }</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+    // nobody wanted to accept it</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+}</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+CompositeDataSourceImpl::Unassert(nsIRDFResource* aSource,</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+                                  nsIRDFResource* aProperty,</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+                                  nsIRDFNode* aTarget)</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+{</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+    if (! aTarget)</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+    // Iterate through each of the datasources, starting with &quot;the</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+    // most local&quot; and moving to &quot;the most remote&quot;. If _any_ of the</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+    // datasources have the assertion, attempt to unassert it.</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+    bool unasserted = true;</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+    int32_t i;</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+    int32_t count = mDataSources.Count();</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+    for (i = 0; i &lt; count; ++i) {</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+        nsIRDFDataSource* ds = mDataSources[i];</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+        bool hasAssertion;</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+        rv = ds-&gt;HasAssertion(aSource, aProperty, aTarget, true, &amp;hasAssertion);</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+        if (hasAssertion) {</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+            rv = ds-&gt;Unassert(aSource, aProperty, aTarget);</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+            if (rv != NS_RDF_ASSERTION_ACCEPTED) {</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+                unasserted = false;</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+                break;</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+            }</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+        }</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+    }</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+    // Either none of the datasources had it, or they were all willing</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+    // to let it be unasserted.</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+    if (unasserted)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+        return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+    // If we get here, one of the datasources already had the</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+    // assertion, and was adamant about not letting us remove</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+    // it. Iterate from the &quot;most local&quot; to the &quot;most remote&quot;</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+    // attempting to assert the negation...</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+    for (i = 0; i &lt; count; ++i) {</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+        rv = mDataSources[i]-&gt;Assert(aSource, aProperty, aTarget, false);</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+        // Did it take?</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+        if (rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+            return rv;</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+    }</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+    // Couln't get anyone to accept the negation, either.</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+}</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+CompositeDataSourceImpl::Change(nsIRDFResource* aSource,</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+                                nsIRDFResource* aProperty,</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+                                nsIRDFNode* aOldTarget,</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+                                nsIRDFNode* aNewTarget)</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+{</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+    NS_PRECONDITION(aOldTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+    if (! aOldTarget)</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+    NS_PRECONDITION(aNewTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+    if (! aNewTarget)</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+    // XXX So we're assuming that a datasource _must_ accept the</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+    // atomic change; i.e., we can't split it up across two</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+    // datasources. That sucks.</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+    // We iterate backwards from the last data source which was added</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineplus">+    // (&quot;the most remote&quot;) to the first (&quot;the most local&quot;), trying to</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineplus">+    // apply the change in each.</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+        rv = mDataSources[i]-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+        if (NS_RDF_ASSERTION_ACCEPTED == rv)</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+            return rv;</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+            return rv;</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+    }</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+    // nobody wanted to accept it</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+}</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineplus">+CompositeDataSourceImpl::Move(nsIRDFResource* aOldSource,</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+                              nsIRDFResource* aNewSource,</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+                              nsIRDFResource* aProperty,</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+                              nsIRDFNode* aTarget)</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+{</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+    NS_PRECONDITION(aOldSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineplus">+    if (! aOldSource)</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineplus">+    NS_PRECONDITION(aNewSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+    if (! aNewSource)</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+    if (! aTarget)</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+    // XXX So we're assuming that a datasource _must_ accept the</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+    // atomic move; i.e., we can't split it up across two</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+    // datasources. That sucks.</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+    // We iterate backwards from the last data source which was added</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineplus">+    // (&quot;the most remote&quot;) to the first (&quot;the most local&quot;), trying to</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+    // apply the assertion in each.</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+        rv = mDataSources[i]-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+        if (NS_RDF_ASSERTION_ACCEPTED == rv)</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+            return rv;</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+            return rv;</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+    }</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    // nobody wanted to accept it</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+    return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+}</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+CompositeDataSourceImpl::HasAssertion(nsIRDFResource* aSource,</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+                                      nsIRDFResource* aProperty,</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineplus">+                                      nsIRDFNode* aTarget,</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineplus">+                                      bool aTruthValue,</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+                                      bool* aResult)</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineplus">+{</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+    if (! aProperty)</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+    if (! mAllowNegativeAssertions &amp;&amp; ! aTruthValue)</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+    {</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+        *aResult = false;</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+        return(NS_OK);</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+    }</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+    // Otherwise, look through all the data sources to see if anyone</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+    // has the positive...</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+    int32_t count = mDataSources.Count();</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+        nsIRDFDataSource* datasource = mDataSources[i];</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+        rv = datasource-&gt;HasAssertion(aSource, aProperty, aTarget, aTruthValue, aResult);</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+        if (*aResult)</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+            return NS_OK;</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+        if (mAllowNegativeAssertions)</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+        {</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineplus">+            bool hasNegation;</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+            rv = datasource-&gt;HasAssertion(aSource, aProperty, aTarget, !aTruthValue, &amp;hasNegation);</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineplus">+            if (hasNegation)</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineplus">+            {</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+                *aResult = false;</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+                return NS_OK;</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+            }</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+        }</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+    }</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+    // If we get here, nobody had the assertion at all</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+    *aResult = false;</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+}</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+CompositeDataSourceImpl::AddObserver(nsIRDFObserver* aObserver)</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+{</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+    NS_PRECONDITION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+    if (! aObserver)</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineplus">+</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineplus">+    // XXX ensure uniqueness?</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineplus">+    mObservers.AppendObject(aObserver);</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineplus">+}</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineplus">+</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+CompositeDataSourceImpl::RemoveObserver(nsIRDFObserver* aObserver)</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+{</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+    NS_PRECONDITION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineplus">+    if (! aObserver)</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineplus">+</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineplus">+    mObservers.RemoveObject(aObserver);</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+}</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineplus">+CompositeDataSourceImpl::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *result)</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+{</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+    *result = false;</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineplus">+    int32_t count = mDataSources.Count();</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+        rv = mDataSources[i]-&gt;HasArcIn(aNode, aArc, result);</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+        if (*result)</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+            return NS_OK;</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+    }</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineplus">+}</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineplus">+</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineplus">+CompositeDataSourceImpl::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *result)</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineplus">+{</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+    *result = false;</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineplus">+    int32_t count = mDataSources.Count();</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineplus">+    for (int32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineplus">+        rv = mDataSources[i]-&gt;HasArcOut(aSource, aArc, result);</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+        if (*result)</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineplus">+            return NS_OK;</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineplus">+    }</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineplus">+}</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineplus">+</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineplus">+CompositeDataSourceImpl::ArcLabelsIn(nsIRDFNode* aTarget, nsISimpleEnumerator** aResult)</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+{</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineplus">+    if (! aTarget)</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineplus">+</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+    nsISimpleEnumerator* result =</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+        new CompositeArcsInOutEnumeratorImpl(this, aTarget,</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+                                             CompositeArcsInOutEnumeratorImpl::eArcsIn,</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+                                             mAllowNegativeAssertions,</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineplus">+                                             mCoalesceDuplicateArcs);</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineplus">+    if (! result)</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineplus">+    *aResult = result;</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineplus">+}</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineplus">+</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineplus">+CompositeDataSourceImpl::ArcLabelsOut(nsIRDFResource* aSource,</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+                                      nsISimpleEnumerator** aResult)</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+{</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+    if (! aSource)</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineplus">+    if (! aResult)</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+    nsISimpleEnumerator* result =</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+        new CompositeArcsInOutEnumeratorImpl(this, aSource,</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+                                             CompositeArcsInOutEnumeratorImpl::eArcsOut,</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+                                             mAllowNegativeAssertions,</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+                                             mCoalesceDuplicateArcs);</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+    if (! result)</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineplus">+</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineplus">+    *aResult = result;</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineplus">+}</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineplus">+</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineplus">+CompositeDataSourceImpl::GetAllResources(nsISimpleEnumerator** aResult)</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineplus">+{</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineplus">+    MOZ_ASSERT_UNREACHABLE(&quot;CompositeDataSourceImpl::GetAllResources&quot;);</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineplus">+}</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineplus">+</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineplus">+CompositeDataSourceImpl::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineplus">+                                    nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** result)</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineplus">+{</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; set;</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineplus">+    for (int32_t i = 0; i &lt; mDataSources.Count(); i++)</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+    {</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineplus">+        nsCOMPtr&lt;nsISimpleEnumerator&gt; dsCmds;</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineplus">+        rv = mDataSources[i]-&gt;GetAllCmds(source, getter_AddRefs(dsCmds));</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineplus">+        {</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineplus">+            nsCOMPtr&lt;nsISimpleEnumerator&gt; tmp;</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineplus">+            rv = NS_NewUnionEnumerator(getter_AddRefs(tmp), set, dsCmds);</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineplus">+            set.swap(tmp);</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineplus">+            if (NS_FAILED(rv)) return(rv);</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineplus">+        }</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+    }</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineplus">+</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineplus">+    set.forget(result);</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineplus">+}</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineplus">+</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineplus">+CompositeDataSourceImpl::IsCommandEnabled(nsISupports/* nsIRDFResource container */* aSources,</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+                                          nsIRDFResource*   aCommand,</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineplus">+                                          nsISupports/* nsIRDFResource container */* aArguments,</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+                                          bool* aResult)</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+{</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+        bool enabled = true;</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+        rv = mDataSources[i]-&gt;IsCommandEnabled(aSources, aCommand, aArguments, &amp;enabled);</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+        if (NS_FAILED(rv) &amp;&amp; (rv != NS_ERROR_NOT_IMPLEMENTED))</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+        {</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineplus">+            return(rv);</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineplus">+        }</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineplus">+</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+        if (! enabled) {</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineplus">+            *aResult = false;</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineplus">+            return(NS_OK);</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+        }</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+    }</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineplus">+    *aResult = true;</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+    return(NS_OK);</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineplus">+}</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineplus">+</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineplus">+CompositeDataSourceImpl::DoCommand(nsISupports/* nsIRDFResource container */* aSources,</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineplus">+                                   nsIRDFResource*   aCommand,</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+                                   nsISupports/* nsIRDFResource container */* aArguments)</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineplus">+{</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineplus">+        nsresult rv = mDataSources[i]-&gt;DoCommand(aSources, aCommand, aArguments);</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineplus">+        if (NS_FAILED(rv) &amp;&amp; (rv != NS_ERROR_NOT_IMPLEMENTED))</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineplus">+        {</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineplus">+            return(rv);   // all datasources must succeed</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineplus">+        }</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineplus">+    }</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineplus">+    return(NS_OK);</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineplus">+}</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineplus">+</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineplus">+CompositeDataSourceImpl::BeginUpdateBatch()</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineplus">+{</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineplus">+        mDataSources[i]-&gt;BeginUpdateBatch();</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineplus">+    }</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+}</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineplus">+</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineplus">+CompositeDataSourceImpl::EndUpdateBatch()</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineplus">+{</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineplus">+    for (int32_t i = mDataSources.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineplus">+        mDataSources[i]-&gt;EndUpdateBatch();</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineplus">+    }</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineplus">+}</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineplus">+</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineplus">+// nsIRDFCompositeDataSource methods</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineplus">+// XXX rvg We should make this take an additional argument specifying where</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineplus">+// in the sequence of data sources (of the db), the new data source should</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineplus">+// fit in. Right now, the new datasource gets stuck at the end.</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineplus">+// need to add the observers of the CompositeDataSourceImpl to the new data source.</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineplus">+</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineplus">+CompositeDataSourceImpl::GetAllowNegativeAssertions(bool *aAllowNegativeAssertions)</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineplus">+{</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineplus">+	*aAllowNegativeAssertions = mAllowNegativeAssertions;</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineplus">+	return(NS_OK);</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineplus">+}</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineplus">+</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineplus">+CompositeDataSourceImpl::SetAllowNegativeAssertions(bool aAllowNegativeAssertions)</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineplus">+{</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineplus">+	mAllowNegativeAssertions = aAllowNegativeAssertions;</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineplus">+	return(NS_OK);</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineplus">+}</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineplus">+</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineplus">+CompositeDataSourceImpl::GetCoalesceDuplicateArcs(bool *aCoalesceDuplicateArcs)</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineplus">+{</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineplus">+	*aCoalesceDuplicateArcs = mCoalesceDuplicateArcs;</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineplus">+	return(NS_OK);</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineplus">+}</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineplus">+</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+CompositeDataSourceImpl::SetCoalesceDuplicateArcs(bool aCoalesceDuplicateArcs)</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineplus">+{</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+	mCoalesceDuplicateArcs = aCoalesceDuplicateArcs;</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineplus">+	return(NS_OK);</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+}</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineplus">+</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineplus">+CompositeDataSourceImpl::AddDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineplus">+{</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineplus">+    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineplus">+</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineplus">+    mDataSources.AppendObject(aDataSource);</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineplus">+    aDataSource-&gt;AddObserver(this);</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineplus">+}</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineplus">+</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineplus">+</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineplus">+</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineplus">+CompositeDataSourceImpl::RemoveDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineplus">+{</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineplus">+    NS_ASSERTION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineplus">+</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineplus">+</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineplus">+    if (mDataSources.IndexOf(aDataSource) &gt;= 0) {</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineplus">+        aDataSource-&gt;RemoveObserver(this);</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineplus">+        mDataSources.RemoveObject(aDataSource);</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineplus">+    }</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineplus">+}</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineplus">+</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineplus">+</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineplus">+CompositeDataSourceImpl::GetDataSources(nsISimpleEnumerator** _result)</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineplus">+{</span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineplus">+    // NS_NewArrayEnumerator for an nsCOMArray takes a snapshot of the</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineplus">+    // current state.</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineplus">+    return NS_NewArrayEnumerator(_result, mDataSources);</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineplus">+}</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineplus">+</span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineplus">+CompositeDataSourceImpl::OnAssert(nsIRDFDataSource* aDataSource,</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineplus">+                                  nsIRDFResource* aSource,</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineplus">+                                  nsIRDFResource* aProperty,</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineplus">+                                  nsIRDFNode* aTarget)</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineplus">+{</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineplus">+    // Make sure that the assertion isn't masked by another</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineplus">+    // datasource.</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineplus">+    //</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineplus">+    // XXX We could make this more efficient if we knew _which_</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineplus">+    // datasource actually served up the OnAssert(): we could use</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineplus">+    // HasAssertionN() to only search datasources _before_ the</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineplus">+    // datasource that coughed up the assertion.</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineplus">+	nsresult	rv = NS_OK;</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineplus">+</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineplus">+	if (mAllowNegativeAssertions)</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineplus">+	{</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineplus">+		bool hasAssertion;</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineplus">+		rv = HasAssertion(aSource, aProperty, aTarget, true, &amp;hasAssertion);</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineplus">+		if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineplus">+</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+		if (! hasAssertion)</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineplus">+			return(NS_OK);</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineplus">+	}</span>
<a href="#l3.1258"></a><span id="l3.1258" class="difflineplus">+</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineplus">+        mObservers[i]-&gt;OnAssert(this, aSource, aProperty, aTarget);</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineplus">+    }</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineplus">+}</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineplus">+</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineplus">+CompositeDataSourceImpl::OnUnassert(nsIRDFDataSource* aDataSource,</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineplus">+                                    nsIRDFResource* aSource,</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineplus">+                                    nsIRDFResource* aProperty,</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineplus">+                                    nsIRDFNode* aTarget)</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineplus">+{</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineplus">+    // Make sure that the un-assertion doesn't just unmask the</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineplus">+    // same assertion in a different datasource.</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineplus">+    //</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineplus">+    // XXX We could make this more efficient if we knew _which_</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineplus">+    // datasource actually served up the OnAssert(): we could use</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineplus">+    // HasAssertionN() to only search datasources _before_ the</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineplus">+    // datasource that coughed up the assertion.</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineplus">+    nsresult rv;</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineplus">+</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineplus">+	if (mAllowNegativeAssertions)</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineplus">+	{</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineplus">+		bool hasAssertion;</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineplus">+		rv = HasAssertion(aSource, aProperty, aTarget, true, &amp;hasAssertion);</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineplus">+		if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineplus">+</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineplus">+		if (hasAssertion)</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineplus">+			return NS_OK;</span>
<a href="#l3.1288"></a><span id="l3.1288" class="difflineplus">+	}</span>
<a href="#l3.1289"></a><span id="l3.1289" class="difflineplus">+</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineplus">+        mObservers[i]-&gt;OnUnassert(this, aSource, aProperty, aTarget);</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineplus">+    }</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineplus">+}</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineplus">+</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineplus">+</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineplus">+CompositeDataSourceImpl::OnChange(nsIRDFDataSource* aDataSource,</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineplus">+                                  nsIRDFResource* aSource,</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineplus">+                                  nsIRDFResource* aProperty,</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineplus">+                                  nsIRDFNode* aOldTarget,</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineplus">+                                  nsIRDFNode* aNewTarget)</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineplus">+{</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineplus">+    // Make sure that the change is actually visible, and not hidden</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineplus">+    // by an assertion in a different datasource.</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineplus">+    //</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineplus">+    // XXX Because of aggregation, this could actually mutate into a</span>
<a href="#l3.1308"></a><span id="l3.1308" class="difflineplus">+    // variety of OnAssert or OnChange notifications, which we'll</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineplus">+    // ignore for now :-/.</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineplus">+        mObservers[i]-&gt;OnChange(this, aSource, aProperty,</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineplus">+                                aOldTarget, aNewTarget);</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineplus">+    }</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineplus">+}</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineplus">+</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineplus">+</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineplus">+CompositeDataSourceImpl::OnMove(nsIRDFDataSource* aDataSource,</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineplus">+                                nsIRDFResource* aOldSource,</span>
<a href="#l3.1321"></a><span id="l3.1321" class="difflineplus">+                                nsIRDFResource* aNewSource,</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineplus">+                                nsIRDFResource* aProperty,</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineplus">+                                nsIRDFNode* aTarget)</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineplus">+{</span>
<a href="#l3.1325"></a><span id="l3.1325" class="difflineplus">+    // Make sure that the move is actually visible, and not hidden</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineplus">+    // by an assertion in a different datasource.</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineplus">+    //</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineplus">+    // XXX Because of aggregation, this could actually mutate into a</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineplus">+    // variety of OnAssert or OnMove notifications, which we'll</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineplus">+    // ignore for now :-/.</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineplus">+        mObservers[i]-&gt;OnMove(this, aOldSource, aNewSource,</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineplus">+                              aProperty, aTarget);</span>
<a href="#l3.1334"></a><span id="l3.1334" class="difflineplus">+    }</span>
<a href="#l3.1335"></a><span id="l3.1335" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1336"></a><span id="l3.1336" class="difflineplus">+}</span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineplus">+</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineplus">+</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1340"></a><span id="l3.1340" class="difflineplus">+CompositeDataSourceImpl::OnBeginUpdateBatch(nsIRDFDataSource* aDataSource)</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineplus">+{</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineplus">+    if (mUpdateBatchNest++ == 0) {</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineplus">+        for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineplus">+            mObservers[i]-&gt;OnBeginUpdateBatch(this);</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineplus">+        }</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineplus">+    }</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineplus">+}</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineplus">+</span>
<a href="#l3.1350"></a><span id="l3.1350" class="difflineplus">+</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.1352"></a><span id="l3.1352" class="difflineplus">+CompositeDataSourceImpl::OnEndUpdateBatch(nsIRDFDataSource* aDataSource)</span>
<a href="#l3.1353"></a><span id="l3.1353" class="difflineplus">+{</span>
<a href="#l3.1354"></a><span id="l3.1354" class="difflineplus">+    NS_ASSERTION(mUpdateBatchNest &gt; 0, &quot;badly nested update batch&quot;);</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineplus">+    if (--mUpdateBatchNest == 0) {</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineplus">+        for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineplus">+            mObservers[i]-&gt;OnEndUpdateBatch(this);</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineplus">+        }</span>
<a href="#l3.1359"></a><span id="l3.1359" class="difflineplus">+    }</span>
<a href="#l3.1360"></a><span id="l3.1360" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.1361"></a><span id="l3.1361" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/rdf/base/nsContainerEnumerator.cpp</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,262 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+/*</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  A simple cursor that enumerates the elements of an RDF container</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  (RDF:Bag, RDF:Seq, or RDF:Alt).</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  Caveats</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  -------</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  1. This uses an implementation-specific detail to determine the</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+     index of the last element in the container; specifically, the RDF</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+     utilities maintain a counter attribute on the container that</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+     holds the numeric value of the next value that is to be</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+     assigned. So, this cursor will bust if you use it with a bag that</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+     hasn't been created using the RDF utility routines.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+ */</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+class ContainerEnumeratorImpl : public nsISimpleEnumerator {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+private:</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+    // pseudo-constants</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+    static nsrefcnt              gRefCnt;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    static nsIRDFResource*       kRDF_nextVal;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    static nsIRDFContainerUtils* gRDFC;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDataSource&gt;      mDataSource;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt;        mContainer;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt;        mOrdinalProperty;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt;   mCurrent;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt;            mResult;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+    int32_t mNextIndex;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+    virtual ~ContainerEnumeratorImpl();</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+public:</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+    ContainerEnumeratorImpl(nsIRDFDataSource* ds, nsIRDFResource* container);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+    nsresult Init();</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+};</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+nsrefcnt              ContainerEnumeratorImpl::gRefCnt;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+nsIRDFResource*       ContainerEnumeratorImpl::kRDF_nextVal;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+nsIRDFContainerUtils* ContainerEnumeratorImpl::gRDFC;</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+ContainerEnumeratorImpl::ContainerEnumeratorImpl(nsIRDFDataSource* aDataSource,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+                                                 nsIRDFResource* aContainer)</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+    : mDataSource(aDataSource),</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+      mContainer(aContainer),</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+      mNextIndex(1)</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+{</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+}</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+nsresult</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+ContainerEnumeratorImpl::Init()</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+{</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+    if (gRefCnt++ == 0) {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+        nsresult rv;</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+        nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(kRDFServiceCID);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+        NS_ASSERTION(rdf != nullptr, &quot;unable to acquire resource manager&quot;);</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+        if (! rdf)</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+            return NS_ERROR_FAILURE;</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;), &amp;kRDF_nextVal);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get resource&quot;);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+        NS_DEFINE_CID(kRDFContainerUtilsCID, NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFC);</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+    }</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+}</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+ContainerEnumeratorImpl::~ContainerEnumeratorImpl()</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+{</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    if (--gRefCnt == 0) {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+        NS_IF_RELEASE(gRDFC);</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+    }</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+}</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+NS_IMPL_ISUPPORTS(ContainerEnumeratorImpl, nsISimpleEnumerator)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+ContainerEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+{</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    if (! aResult)</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    nsresult rv;</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+    // If we've already queued up a next value, then we know there are more elements.</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+    if (mResult) {</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+        *aResult = true;</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+        return NS_OK;</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+    }</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    // Otherwise, we need to grovel</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+    // Figure out the upper bound so we'll know when we're done. Since it's</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    // possible that we're targeting a composite datasource, we'll need to</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    // &quot;GetTargets()&quot; and take the maximum value of &quot;nextVal&quot; to know the</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+    // upper bound.</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+    //</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+    // Remember that since nextVal is the next index that we'd assign</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+    // to an element in a container, it's *one more* than count of</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+    // elements in the container.</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+    int32_t max = 0;</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; targets;</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+    rv = mDataSource-&gt;GetTargets(mContainer, kRDF_nextVal, true, getter_AddRefs(targets));</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+    while (1) {</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        bool hasmore;</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        targets-&gt;HasMoreElements(&amp;hasmore);</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+        if (! hasmore)</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+            break;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+        targets-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+        nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral = do_QueryInterface(isupports);</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+        if (! nextValLiteral)</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+             continue;</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+         const char16_t *nextValStr;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+         nextValLiteral-&gt;GetValueConst(&amp;nextValStr);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+         nsresult err;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+         int32_t nextVal = nsAutoString(nextValStr).ToInteger(&amp;err);</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+         if (nextVal &gt; max)</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+             max = nextVal;</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+    }</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineplus">+</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+    // Now pre-fetch our next value into mResult.</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+    while (mCurrent || mNextIndex &lt; max) {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+        // If mCurrent has been depleted, then conjure up a new one</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+        if (! mCurrent) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+            rv = gRDFC-&gt;IndexToOrdinalResource(mNextIndex, getter_AddRefs(mOrdinalProperty));</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+            rv = mDataSource-&gt;GetTargets(mContainer, mOrdinalProperty, true, getter_AddRefs(mCurrent));</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+            ++mNextIndex;</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+        }</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+        if (mCurrent) {</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+            bool hasMore;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+            rv = mCurrent-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+            // Is the current enumerator depleted? If so, iterate to</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+            // the next index.</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+            if (! hasMore) {</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+                mCurrent = nullptr;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+                continue;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+            }</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+            // &quot;Peek&quot; ahead and pull out the next target.</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; result;</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+            rv = mCurrent-&gt;GetNext(getter_AddRefs(result));</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+            mResult = do_QueryInterface(result, &amp;rv);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+            *aResult = true;</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+            return NS_OK;</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+        }</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    }</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    // If we get here, we ran out of elements. The cursor is empty.</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+    *aResult = false;</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+}</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+ContainerEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+{</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+    nsresult rv;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+    bool hasMore;</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineplus">+    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineplus">+</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+    if (! hasMore)</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineplus">+</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+    NS_ADDREF(*aResult = mResult);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+    mResult = nullptr;</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+    return NS_OK;</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+}</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+nsresult</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+NS_NewContainerEnumerator(nsIRDFDataSource* aDataSource,</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+                          nsIRDFResource* aContainer,</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+                          nsISimpleEnumerator** aResult)</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+{</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+    NS_PRECONDITION(aContainer != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+    if (! aContainer)</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    if (! aResult)</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+    ContainerEnumeratorImpl* result = new ContainerEnumeratorImpl(aDataSource, aContainer);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+    if (! result)</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+    nsresult rv = result-&gt;Init();</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+        NS_RELEASE(result);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    *aResult = result;</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    return rv;</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/rdf/base/nsDefaultResourceFactory.cpp</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,30 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+/*</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  The default resource factory implementation. This resource factory</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  produces nsIRDFResource objects for any URI prefix that is not</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  covered by some other factory.</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+ */</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+#include &quot;nsRDFResource.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+nsresult</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+NS_NewDefaultResource(nsIRDFResource** aResult)</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+{</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    if (! aResult)</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+    nsRDFResource* resource = new nsRDFResource();</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+    if (! resource)</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    NS_ADDREF(resource);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    *aResult = resource;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/rdf/base/nsIRDFCompositeDataSource.idl</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,68 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+interface nsISimpleEnumerator;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+/**</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ * An nsIRDFCompositeDataSource composes individual data sources, providing</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * the illusion of a single, coherent RDF graph.</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ */</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+[scriptable, uuid(96343820-307C-11D2-BC15-00805F912FE7)]</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+interface nsIRDFCompositeDataSource : nsIRDFDataSource {</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+    /**</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+     *</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+     * Set this value to &lt;code&gt;true&lt;/code&gt; if the composite datasource</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+     * may contains at least one datasource that has &lt;em&gt;negative&lt;/em&gt;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+     * assertions. (This is the default.)</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+     *</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+     * Set this value to &lt;code&gt;false&lt;/code&gt; if none of the datasources</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+     * being composed contains a negative assertion. This allows the</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+     * composite datasource to perform some query optimizations.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+     *</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+     * By default, this value is &lt;code&gt;true&lt;/true&gt;.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+     */</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    attribute boolean	allowNegativeAssertions;</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    /**</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+     * Set to &lt;code&gt;true&lt;/code&gt; if the composite datasource should</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+     * take care to coalesce duplicate arcs when returning values from</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+     * queries. (This is the default.)</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+     *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+     * Set to &lt;code&gt;false&lt;/code&gt; if the composite datasource shouldn't</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+     * bother to check for duplicates. This allows the composite</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+     * datasource to more efficiently answer queries.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+     *</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+     * By default, this value is &lt;code&gt;true&lt;/code&gt;.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+     */</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+    attribute boolean	coalesceDuplicateArcs;</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+    /**</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+     * Add a datasource the the composite data source.</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+     * @param aDataSource the datasource to add to composite</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+     */</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    void AddDataSource(in nsIRDFDataSource aDataSource);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+    /**</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+     * Remove a datasource from the composite data source.</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+     * @param aDataSource the datasource to remove from the composite</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+     */</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    void RemoveDataSource(in nsIRDFDataSource aDataSource);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+    /**</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+     * Retrieve the datasources in the composite data source.</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+     * @return an nsISimpleEnumerator that will enumerate each</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+     * of the datasources in the composite</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+     */</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+    nsISimpleEnumerator GetDataSources();</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+};</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+%{C++</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+extern nsresult</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+NS_NewRDFCompositeDataSource(nsIRDFCompositeDataSource** result);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+%}</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/rdf/base/nsIRDFContainer.idl</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,94 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+// A wrapper for manipulating RDF containers</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+[scriptable, uuid(D4214E90-FB94-11D2-BDD8-00104BDE6048)]</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+interface nsIRDFContainer : nsISupports {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    readonly attribute nsIRDFDataSource DataSource;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+    readonly attribute nsIRDFResource   Resource;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+    /**</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+     * Initialize the container wrapper to the specified resource</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+     * using the specified datasource for context.</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+     */</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+    void Init(in nsIRDFDataSource aDataSource, in nsIRDFResource aContainer);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+    /**</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+     * Return the number of elements in the container. Note that this</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+     * may not always be accurate due to aggregation.</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+     */</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    long GetCount();</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+    /**</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+     * Return an enumerator that can be used to enumerate the contents</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+     * of the container in ascending order.</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+     */</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    nsISimpleEnumerator GetElements();</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+    /**</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+     * Append an element to the container, assigning it the next</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+     * available ordinal.</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+     */</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+    void AppendElement(in nsIRDFNode aElement);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    /**</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+     * Remove the first occurence of the specified element from the</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+     * container. If aRenumber is 'true', then the underlying RDF graph</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+     * will be 're-numbered' to account for the removal.</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+     */</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    void RemoveElement(in nsIRDFNode aElement, in boolean aRenumber);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+    /**</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+     * Insert aElement at the specified index. If aRenumber is 'true', then</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+     * the underlying RDF graph will be 're-numbered' to accomodate the new</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+     * element.</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+     */</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    void InsertElementAt(in nsIRDFNode aElement, in long aIndex, in boolean aRenumber);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    /**</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+     * Remove the element at the specified index. If aRenumber is 'true', then</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+     * the underlying RDF graph will be 're-numbered' to account for the</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+     * removal.</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+     *</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+     * @return the element that was removed.</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+     */</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    nsIRDFNode RemoveElementAt(in long aIndex, in boolean aRenumber);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+    /**</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+     * Determine the index of an element in the container.</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+     *</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+     * @return The index of the specified element in the container. If</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+     * the element is not contained in the container, this function</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+     * returns '-1'.</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+     */</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    long IndexOf(in nsIRDFNode aElement);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+};</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+%{C++</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+nsresult</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+NS_NewRDFContainer(nsIRDFContainer** aResult);</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+nsresult</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+NS_NewRDFContainer(nsIRDFDataSource* aDataSource,</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+                   nsIRDFResource* aResource,</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+                   nsIRDFContainer** aResult);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+/**</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+ * Create a cursor on a container that enumerates its contents in</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+ * order</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+ */</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+nsresult</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+NS_NewContainerEnumerator(nsIRDFDataSource* aDataSource,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+                          nsIRDFResource* aContainer,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+                          nsISimpleEnumerator** aResult);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/rdf/base/nsIRDFContainerUtils.idl</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+#include &quot;nsIRDFContainer.idl&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+// Container utilities</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+[scriptable, uuid(D4214E91-FB94-11D2-BDD8-00104BDE6048)]</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+interface nsIRDFContainerUtils : nsISupports {</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    /**</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+     * Returns 'true' if the property is an RDF ordinal property.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+     */</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    boolean IsOrdinalProperty(in nsIRDFResource aProperty);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    /**</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+     * Convert the specified index to an ordinal property.</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+     */</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+    nsIRDFResource IndexToOrdinalResource(in long aIndex);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+    /**</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+     * Convert the specified ordinal property into an index</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+     */</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    long OrdinalResourceToIndex(in nsIRDFResource aOrdinal);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+    /**</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+     * Return 'true' if the specified resource is a container</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+     */</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    boolean IsContainer(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+    /**</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+     * Return 'true' if the specified resource is a container and it is empty</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+     */</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    boolean IsEmpty(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    /**</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+     * Return 'true' if the specified resource is a bag</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+     */</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+    boolean IsBag(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    /**</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+     * Return 'true' if the specified resource is a sequence</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+     */</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    boolean IsSeq(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    /**</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+     * Return 'true' if the specified resource is an alternation</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+     */</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    boolean IsAlt(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    /**</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+     * Decorates the specified resource appropriately to make it</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+     * usable as an empty bag in the specified data source.</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+     */</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    nsIRDFContainer MakeBag(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    /**</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+     * Decorates the specified resource appropriately to make it</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+     * usable as an empty sequence in the specified data source.</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+     */</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    nsIRDFContainer MakeSeq(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+    /**</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+     * Decorates the specified resource appropriately to make it</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+     * usable as an empty alternation in the specified data source.</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+     */</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+    nsIRDFContainer MakeAlt(in nsIRDFDataSource aDataSource, in nsIRDFResource aResource);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+    /**</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+     * Retrieve the index of element in the container. Returns -1 if</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+     * the element is not in the container.</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+     */</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    long indexOf(in nsIRDFDataSource aDataSource, in nsIRDFResource aContainer, in nsIRDFNode aElement);</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+};</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+%{C++</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+extern nsresult</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+NS_NewRDFContainerUtils(nsIRDFContainerUtils** aResult);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+%}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/rdf/base/nsIRDFContentSink.h</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+/*</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  An RDF-specific content sink. The content sink is targeted by the</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  parser for building the RDF content model.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+ */</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+#ifndef nsIRDFContentSink_h___</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+#define nsIRDFContentSink_h___</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+#include &quot;nsIXMLContentSink.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+class nsIRDFDataSource;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+class nsIURI;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+// {3a7459d7-d723-483c-aef0-404fc48e09b8}</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+#define NS_IRDFCONTENTSINK_IID \</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+{ 0x3a7459d7, 0xd723, 0x483c, { 0xae, 0xf0, 0x40, 0x4f, 0xc4, 0x8e, 0x09, 0xb8 } }</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+/**</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+ * This interface represents a content sink for RDF files.</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+ */</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+class nsIRDFContentSink : public nsIXMLContentSink {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+public:</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    NS_DECLARE_STATIC_IID_ACCESSOR(NS_IRDFCONTENTSINK_IID)</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+    /**</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+     * Initialize the content sink.</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+     */</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+    NS_IMETHOD Init(nsIURI* aURL) = 0;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    /**</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+     * Set the content sink's RDF Data source</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+     */</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+    NS_IMETHOD SetDataSource(nsIRDFDataSource* aDataSource) = 0;</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    /**</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+     * Retrieve the content sink's RDF data source.</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+     */</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    NS_IMETHOD GetDataSource(nsIRDFDataSource*&amp; rDataSource) = 0;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+};</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+NS_DEFINE_STATIC_IID_ACCESSOR(nsIRDFContentSink, NS_IRDFCONTENTSINK_IID)</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+/**</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+ * This constructs a content sink that can be used without a</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+ * document, say, to create a stand-alone in-memory graph.</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+ */</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+nsresult</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+NS_NewRDFContentSink(nsIRDFContentSink** aResult);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+#endif // nsIRDFContentSink_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/rdf/base/nsIRDFDataSource.idl</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,181 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+#include &quot;nsIRDFObserver.idl&quot;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+[scriptable, uuid(0F78DA58-8321-11d2-8EAC-00805F29F370)]</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+interface nsIRDFDataSource : nsISupports</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+{</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+    /** The &quot;URI&quot; of the data source. This used by the RDF service's</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+     * |GetDataSource()| method to cache datasources.</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+     */</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+    readonly attribute ACString URI;</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+    /** Find an RDF resource that points to a given node over the</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+     * specified arc &amp; truth value</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+     *</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+     * @throws NS_RDF_NO_VALUE if there is no source that leads</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+     * to the target with the specified property.</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+     */</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+    nsIRDFResource GetSource(in nsIRDFResource aProperty,</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+                             in nsIRDFNode     aTarget,</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                             in boolean        aTruthValue);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+    /**</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+     * Find all RDF resources that point to a given node over the</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+     * specified arc &amp; truth value</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+     */</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    nsISimpleEnumerator GetSources(in nsIRDFResource aProperty,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+                                   in nsIRDFNode     aTarget,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+                                   in boolean        aTruthValue);</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    /**</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+     * Find a child of that is related to the source by the given arc</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+     * arc and truth value</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+     *</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+     * @throws NS_RDF_NO_VALUE if there is no target accessible from the</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+     * source via the specified property.</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+     */</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+    nsIRDFNode GetTarget(in nsIRDFResource aSource,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+                         in nsIRDFResource aProperty,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+                         in boolean        aTruthValue);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    /**</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+     * Find all children of that are related to the source by the given arc</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+     * arc and truth value.</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+     */</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    nsISimpleEnumerator GetTargets(in nsIRDFResource aSource,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+                                   in nsIRDFResource aProperty,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+                                   in boolean aTruthValue);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    /**</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+     * Add an assertion to the graph.</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+     */</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+    void Assert(in nsIRDFResource aSource, </span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+                in nsIRDFResource aProperty, </span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+                in nsIRDFNode     aTarget,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+                in boolean        aTruthValue);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+    /**</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+     * Remove an assertion from the graph.</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+     */</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    void Unassert(in nsIRDFResource aSource,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+                  in nsIRDFResource aProperty,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+                  in nsIRDFNode     aTarget);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+    /**</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+     * Change an assertion from</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+     *</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+     *   [aSource]--[aProperty]--&gt;[aOldTarget]</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+     *</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+     * to</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+     * </span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+     *   [aSource]--[aProperty]--&gt;[aNewTarget]</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+     */</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+    void Change(in nsIRDFResource aSource,</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+                in nsIRDFResource aProperty,</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+                in nsIRDFNode     aOldTarget,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+                in nsIRDFNode     aNewTarget);</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+    /**</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+     * 'Move' an assertion from</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+     *</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+     *   [aOldSource]--[aProperty]--&gt;[aTarget]</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+     *</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+     * to</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+     * </span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+     *   [aNewSource]--[aProperty]--&gt;[aTarget]</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+     */</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+    void Move(in nsIRDFResource aOldSource,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+              in nsIRDFResource aNewSource,</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+              in nsIRDFResource aProperty,</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+              in nsIRDFNode     aTarget);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+    /**</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+     * Query whether an assertion exists in this graph.</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+     */</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+    boolean HasAssertion(in nsIRDFResource aSource,</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+                         in nsIRDFResource aProperty,</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+                         in nsIRDFNode     aTarget,</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+                         in boolean        aTruthValue);</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+    /**</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+     * Add an observer to this data source. If the datasource</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+     * supports observers, the datasource source should hold a strong</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+     * reference to the observer.</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+     */</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+    void AddObserver(in nsIRDFObserver aObserver);</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+    /**</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineplus">+     * Remove an observer from this data source.</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+     */</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+    void RemoveObserver(in nsIRDFObserver aObserver);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineplus">+    /**</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+     * Get a cursor to iterate over all the arcs that point into a node.</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+     */</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+    nsISimpleEnumerator ArcLabelsIn(in nsIRDFNode aNode);</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+    /**</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+     * Get a cursor to iterate over all the arcs that originate in</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+     * a resource.</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+     */</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+    nsISimpleEnumerator ArcLabelsOut(in nsIRDFResource aSource);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+    /**</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+     * Retrieve all of the resources that the data source currently</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+     * refers to.</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+     */</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    nsISimpleEnumerator GetAllResources();</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+    /**</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+     * Returns whether a given command is enabled for a set of sources. </span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+     */</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineplus">+    boolean IsCommandEnabled(in nsISupports aSources,</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineplus">+                             in nsIRDFResource   aCommand,</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+                             in nsISupports aArguments);</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+    /**</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+     * Perform the specified command on set of sources.</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineplus">+     */</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineplus">+    void DoCommand(in nsISupports aSources,</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineplus">+                   in nsIRDFResource   aCommand,</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineplus">+                   in nsISupports aArguments);</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineplus">+</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+    /**</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+     * Returns the set of all commands defined for a given source.</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+     */</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+    nsISimpleEnumerator GetAllCmds(in nsIRDFResource aSource);</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+    /**</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+     * Returns true if the specified node is pointed to by the specified arc.</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+     * Equivalent to enumerating ArcLabelsIn and comparing for the specified arc.</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+     */</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+    boolean hasArcIn(in nsIRDFNode aNode, in nsIRDFResource aArc);</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+    /**</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+     * Returns true if the specified node has the specified outward arc.</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+     * Equivalent to enumerating ArcLabelsOut and comparing for the specified arc.</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+     */</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+    boolean hasArcOut(in nsIRDFResource aSource, in nsIRDFResource aArc);</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+    /**</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+     * Notify observers that the datasource is about to send several</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+     * notifications at once.</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+     * This must be followed by calling endUpdateBatch(), otherwise</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+     * viewers will get out of sync.</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+     */</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    void beginUpdateBatch();</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+    /**</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+     * Notify observers that the datasource has completed issuing</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+     * a notification group.</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+     */</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+    void endUpdateBatch();</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/rdf/base/nsIRDFDelegateFactory.idl</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,40 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+/*</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+  An interface used for runtime pseudo-aggregation of RDF delegate</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  objects.</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+*/</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+#include &quot;nsrootidl.idl&quot;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+interface nsIRDFResource;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+/**</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * This interface should be implemented by an XPCOM factory that</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * is registered to handle &quot;@mozilla.org/rdf/delegate-factory/[key]/[scheme];1&quot;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ * ContractIDs.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ *</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ * The factory will be invoked to create delegate objects from</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ * nsIRDFResource::GetDelegate().</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ */</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+[scriptable, uuid(A1B89470-A124-11d3-BE59-0020A6361667)]</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+interface nsIRDFDelegateFactory : nsISupports</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+{</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+    /**</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+     * Create a delegate for the specified RDF resource.</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+     *</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+     * The created delegate should forward AddRef() and Release()</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+     * calls to the aOuter object.</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+     */</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+    void CreateDelegate(in nsIRDFResource aOuter,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+                        in string aKey,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+                        in nsIIDRef aIID,</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+                        [retval, iid_is(aIID)] out nsQIResult aResult);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+};</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/rdf/base/nsIRDFInMemoryDataSource.idl</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+[scriptable, uuid(17C4E0AA-1DD2-11B2-8029-BF6F668DE500)]</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+interface nsIRDFInMemoryDataSource : nsISupports</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+{</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+    void EnsureFastContainment(in nsIRDFResource aSource);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/rdf/base/nsIRDFInferDataSource.idl</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,28 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+/**</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * An nsIRDFInferDataSource is implemented by a infer engine. This</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * engine mimics assertions in addition to those in the baseDataSource</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * according to a particular vocabulary.</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * Infer engines have contract IDs in the form of</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ * &quot;@mozilla.org/rdf/infer-datasource;1?engine=&quot;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ */</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+[scriptable, uuid(2b04860f-4017-40f6-8a57-784a1e35077a)]</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+interface nsIRDFInferDataSource : nsIRDFDataSource {</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+    /**</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+     *</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+     * The wrapped datasource.</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+     *</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+     * The InferDataSource contains all arcs from the wrapped</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+     * datasource plus those infered by the vocabulary implemented</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+     * by the InferDataSource.</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+     */</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+    attribute nsIRDFDataSource baseDataSource;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+};</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/rdf/base/nsIRDFLiteral.idl</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,68 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+%{C++</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#include &quot;nscore.h&quot; // for char16_t</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+%}</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+[ptr] native const_octet_ptr(const uint8_t);</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+/**</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ * A literal node in the graph, whose value is a string.</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ */</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+[scriptable, uuid(E0C493D2-9542-11d2-8EB8-00805F29F370)]</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+interface nsIRDFLiteral : nsIRDFNode {</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+    /**</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+     * The Unicode string value of the literal.</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+     */</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+    readonly attribute wstring Value;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+    /**</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+     * An unscriptable version used to avoid a string copy. Meant</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+     * for use as a performance optimization.</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+     */</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    [noscript] void GetValueConst([shared] out wstring aConstValue);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+};</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+/**</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * A literal node in the graph, whose value is a date</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ */</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+[scriptable, uuid(E13A24E1-C77A-11d2-80BE-006097B76B8E)]</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+interface nsIRDFDate : nsIRDFNode {</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+    /**</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+     * The date value of the literal</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+     */</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    readonly attribute PRTime Value;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+};</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+/**</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+ * A literal node in the graph, whose value is an integer</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+ */</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+[scriptable, uuid(E13A24E3-C77A-11d2-80BE-006097B76B8E)]</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+interface nsIRDFInt : nsIRDFNode {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    /**</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+     * The integer value of the literal</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+     */</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    readonly attribute long Value;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+};</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+/**</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+ * A literal node in the graph, whose value is arbitrary</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+ * binary data.</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+ */</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+[scriptable, uuid(237f85a2-1dd2-11b2-94af-8122582fc45e)]</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+interface nsIRDFBlob : nsIRDFNode {</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+    /**</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+     * The binary data.</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+     */</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    [noscript] readonly attribute const_octet_ptr value;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    /**</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+     * The data's length.</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+     */</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+    readonly attribute long length;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/rdf/base/nsIRDFNode.idl</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+// An nsIRDFNode object is an abstract placeholder for a node in the</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+// RDF data model. Its concreted implementations (e.g., nsIRDFResource</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+// or nsIRDFLiteral) are the actual objects that populate the graph.</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+[scriptable, uuid(0F78DA50-8321-11d2-8EAC-00805F29F370)]</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+interface nsIRDFNode : nsISupports {</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+    // Determine if two nodes are identical</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+    boolean EqualsNode(in nsIRDFNode aNode);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/rdf/base/nsIRDFObserver.idl</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,94 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+interface nsIRDFDataSource;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+// An nsIRDFObserver object is an observer that will be notified</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+// when assertions are made or removed from a datasource</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+[scriptable, uuid(3CC75360-484A-11D2-BC16-00805F912FE7)]</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+interface nsIRDFObserver : nsISupports {</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+    /**</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+     * This method is called whenever a new assertion is made</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+     * in the data source</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+     * @param aDataSource the datasource that is issuing</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+     *   the notification.</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+     * @param aSource the subject of the assertion</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+     * @param aProperty the predicate of the assertion</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+     * @param aTarget the object of the assertion</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+     */</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+    void onAssert(in nsIRDFDataSource aDataSource,</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+                  in nsIRDFResource aSource,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+                  in nsIRDFResource aProperty,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+                  in nsIRDFNode     aTarget);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+    /**</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+     * This method is called whenever an assertion is removed</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+     * from the data source</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+     * @param aDataSource the datasource that is issuing</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+     *   the notification.</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+     * @param aSource the subject of the assertion</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+     * @param aProperty the predicate of the assertion</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+     * @param aTarget the object of the assertion</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+     */</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+    void onUnassert(in nsIRDFDataSource aDataSource,</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+                    in nsIRDFResource aSource,</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+                    in nsIRDFResource aProperty,</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+                    in nsIRDFNode     aTarget);</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+    /**</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+     * This method is called when the object of an assertion</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+     * changes from one value to another.</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+     * @param aDataSource the datasource that is issuing</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+     *   the notification.</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+     * @param aSource the subject of the assertion</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+     * @param aProperty the predicate of the assertion</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+     * @param aOldTarget the old object of the assertion</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+     * @param aNewTarget the new object of the assertion</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+     */</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+    void onChange(in nsIRDFDataSource aDataSource,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+                  in nsIRDFResource aSource,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+                  in nsIRDFResource aProperty,</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+                  in nsIRDFNode     aOldTarget,</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+                  in nsIRDFNode     aNewTarget);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+    /**</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+     * This method is called when the subject of an assertion</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+     * changes from one value to another.</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+     * @param aDataSource the datasource that is issuing</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+     *   the notification.</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+     * @param aOldSource the old subject of the assertion</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+     * @param aNewSource the new subject of the assertion</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+     * @param aProperty the predicate of the assertion</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+     * @param aTarget the object of the assertion</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+     */</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    void onMove(in nsIRDFDataSource aDataSource,</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+                in nsIRDFResource aOldSource,</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+                in nsIRDFResource aNewSource,</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+                in nsIRDFResource aProperty,</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+                in nsIRDFNode     aTarget);</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+    /**</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+     * This method is called when a datasource is about to</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+     * send several notifications at once. The observer can</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+     * use this as a cue to optimize its behavior. The observer</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+     * can expect the datasource to call endUpdateBatch() when</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+     * the group of notifications has completed.</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+     * @param aDataSource the datasource that is going to</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+     *   be issuing the notifications.</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+     */</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    void onBeginUpdateBatch(in nsIRDFDataSource aDataSource);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+    /**</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+     * This method is called when a datasource has completed</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+     * issuing a notification group.</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+     * @param aDataSource the datasource that has finished</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+     *   issuing a group of notifications</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+     */</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+    void onEndUpdateBatch(in nsIRDFDataSource aDataSource);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/rdf/base/nsIRDFPropagatableDataSource.idl</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,27 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* -*- Mode: idl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+/**</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * An nsIRDFPropagatableDataSource provides an ability to suppress</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * synchronization notifications.</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ */</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+[scriptable, uuid(5a9b4770-9fcb-4307-a12e-4b6708e78b97)]</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+interface nsIRDFPropagatableDataSource: nsISupports {</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  /**</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+   * Set this value to &lt;code&gt;true&lt;/code&gt; to enable synchronization</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+   * notifications.</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+   *</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+   * Set this value to &lt;code&gt;false&lt;/code&gt; to disable synchronization</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+   * notifications.</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+   *</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+   * By default, this value is &lt;code&gt;true&lt;/code&gt;.</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+   */</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+  attribute boolean propagateChanges;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/rdf/base/nsIRDFPurgeableDataSource.idl</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+[scriptable, uuid(951700F0-FED0-11D2-BDD9-00104BDE6048)]</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+interface nsIRDFPurgeableDataSource : nsISupports</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+{</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+    boolean Mark(in nsIRDFResource aSource,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+                 in nsIRDFResource aProperty,</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+                 in nsIRDFNode aTarget,</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+                 in boolean aTruthValue);</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+    void Sweep();</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/rdf/base/nsIRDFRemoteDataSource.idl</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,44 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+/**</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+ * A datasource that may load asynchronously</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+ */</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+[scriptable, uuid(1D297320-27F7-11d3-BE01-000064657374)]</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+interface nsIRDFRemoteDataSource : nsISupports</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+{</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+    /**</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+     * This value is &lt;code&gt;true&lt;/code&gt; when the datasource has</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+     * fully loaded itself.</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+     */</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+    readonly attribute boolean loaded;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+    /**</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+     * Specify the URI for the data source: this is the prefix</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+     * that will be used to register the data source in the</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+     * data source registry.</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+     * @param aURI the URI to load</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+     */</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+    void Init(in string aURI);</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    /**</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+     * Refresh the remote datasource, re-loading its contents</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+     * from the URI.</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+     *</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+     * @param aBlocking If &lt;code&gt;true&lt;/code&gt;, the call will block</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+     * until the datasource has completely reloaded.</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+     */</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    void Refresh(in boolean aBlocking);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+    /**</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+     * Request that a data source write its contents out to </span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+     * permanent storage, if applicable.</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+     */</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+    void Flush();</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+    void FlushTo(in string aURI);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+};</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/rdf/base/nsIRDFResource.idl</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+#include &quot;nsrootidl.idl&quot;</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+#include &quot;nsIRDFNode.idl&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+/**</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+ * An nsIRDFResource is an object that has unique identity in the </span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ * RDF data model. The object's identity is determined by its URI.</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+ */</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+[scriptable, uuid(fb9686a7-719a-49dc-9107-10dea5739341)]</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+interface nsIRDFResource : nsIRDFNode {</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+    /**</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+     * The single-byte string value of the resource.</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+     * @note THIS IS OBSOLETE. C++ should use GetValueConst and script</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+     *       should use .valueUTF8</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+     */</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+    readonly attribute string Value;</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+    /**</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+     * The UTF-8 URI of the resource.</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+     */</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+    readonly attribute AUTF8String ValueUTF8;</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    /**</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+     * An unscriptable version used to avoid a string copy. Meant</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+     * for use as a performance optimization. The string is encoded</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+     * in UTF-8.</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+     */</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    [noscript] void GetValueConst([shared] out string aConstValue);</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+    /**</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+     * This method is called by the nsIRDFService after constructing</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+     * a resource object to initialize its URI. You would not normally</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+     * call this method directly</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+     */</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+    void Init(in string uri);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+    /**</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+     * Determine if the resource has the given URI.</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+     */</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+    boolean EqualsString(in string aURI);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    /**</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+     * Retrieve the &quot;delegate&quot; object for this resource. A resource</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+     * may have several delegate objects, each of whose lifetimes is</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+     * bound to the life of the resource object.</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+     *</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+     * This method will return the delegate for the given key after</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+     * QueryInterface()-ing it to the requested IID.</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+     *</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+     * If no delegate exists for the specified key, this method will</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+     * attempt to create one using the component manager. Specifically,</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+     * it will combine aKey with the resource's URI scheme to produce</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+     * a ContractID as follows:</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+     *</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+     *   component:/rdf/delegate-factory/[key]/[scheme]</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+     *</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+     * This ContractID will be used to locate a factory using the</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+     * FindFactory() method of nsIComponentManager. If the nsIFactory</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+     * exists, it will be used to create a &quot;delegate factory&quot;; that</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+     * is, an object that supports nsIRDFDelegateFactory. The delegate</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+     * factory will be used to construct the delegate object.</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+     */</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+    void GetDelegate(in string aKey, in nsIIDRef aIID,</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+                     [iid_is(aIID),retval] out nsQIResult aResult);</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+    /**</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+     * Force a delegate to be &quot;unbound&quot; from the resource.</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+     *</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+     * Normally, a delegate object's lifetime will be identical to</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+     * that of the resource to which it is bound; this method allows a</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+     * delegate to unlink itself from an RDF resource prematurely.</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+     */</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    void ReleaseDelegate(in string aKey);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+};</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/rdf/base/nsIRDFService.idl</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,146 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+#include &quot;nsIRDFResource.idl&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+#include &quot;nsIRDFLiteral.idl&quot;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+/**</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+ * The RDF service interface. This is a singleton object which should be</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+ * obtained from the &lt;code&gt;nsServiceManager&lt;/code&gt;.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+ */</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+[scriptable, uuid(BFD05261-834C-11d2-8EAC-00805F29F370)]</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+interface nsIRDFService : nsISupports {</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+    /**</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+     * Construct an RDF resource from a single-byte URI. &lt;code&gt;nsIRDFService&lt;/code&gt;</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+     * caches resources that are in-use, so multiple calls to &lt;code&gt;GetResource()&lt;/code&gt;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+     * for the same &lt;code&gt;uri&lt;/code&gt; will return identical pointers. FindResource</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+     * is used to find out whether there already exists a resource corresponding to that url.</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+     */</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+    nsIRDFResource GetResource(in AUTF8String aURI);</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+    /**</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+     * Construct an RDF resource from a Unicode URI. This is provided</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+     * as a convenience method, allowing automatic, in-line C++</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+     * conversion from &lt;code&gt;nsString&lt;/code&gt; objects. The &lt;code&gt;uri&lt;/code&gt; will</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+     * be converted to a single-byte representation internally.</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+     */</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    nsIRDFResource GetUnicodeResource(in AString aURI);</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+    nsIRDFResource GetAnonymousResource();</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+    /**</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+     * Construct an RDF literal from a Unicode string.</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+     */</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+    nsIRDFLiteral  GetLiteral(in wstring aValue);</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+    /**</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+     * Construct an RDF literal from a PRTime.</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+     */</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+    nsIRDFDate     GetDateLiteral(in PRTime aValue);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+    /**</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+     * Construct an RDF literal from an int.</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+     */</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+    nsIRDFInt      GetIntLiteral(in long aValue);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+    /**</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+     * Construct an RDF literal from a data blob</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+     */</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+    [noscript] nsIRDFBlob getBlobLiteral(in const_octet_ptr aValue, in long aLength);</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+    boolean IsAnonymousResource(in nsIRDFResource aResource);</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+    /**</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+     * Registers a resource with the RDF system, making it unique w.r.t.</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+     * GetResource.</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+     *</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+     * An implementation of nsIRDFResource should call this in its</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+     * Init() method if it wishes the resource to be globally unique</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+     * (which is usually the case).</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+     *</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+     * @note that the resource will &lt;i&gt;not&lt;/i&gt; be ref-counted by the</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+     * RDF service: the assumption is that the resource implementation</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+     * will call nsIRDFService::UnregisterResource() when the last</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+     * reference to the resource is released.</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+     *</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+     * @note that the nsIRDFService implementation may choose to</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+     * maintain a reference to the resource's URI; therefore, the</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+     * resource implementation should ensure that the resource's URI</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+     * (accessible via nsIRDFResource::GetValue(const char* *aURI)) is</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+     * valid before calling RegisterResource(). Furthermore, the</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+     * resource implementation should ensure that this pointer</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+     * &lt;i&gt;remains&lt;/i&gt; valid for the lifetime of the resource. (The</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+     * implementation of the resource cache in nsIRDFService uses the</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+     * URI maintained &quot;internally&quot; in the resource as a key into the</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+     * cache rather than copying the resource URI itself.)</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+     */</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+    void RegisterResource(in nsIRDFResource aResource, in boolean aReplace);</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+    /**</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+     * Called to notify the resource manager that a resource is no</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+     * longer in use. This method should only be called from the</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+     * destructor of a &quot;custom&quot; resource implementation to notify the</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+     * RDF service that the last reference to the resource has been</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+     * released, so the resource is no longer valid.</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+     *</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+     * @note As mentioned in nsIRDFResourceFactory::CreateResource(),</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+     * the RDF service will use the result of</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+     * nsIRDFResource::GetValue() as a key into its cache. For this</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+     * reason, you must always un-cache the resource &lt;b&gt;before&lt;/b&gt;</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+     * releasing the storage for the &lt;code&gt;const char*&lt;/code&gt; URI.</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+     */</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+    void UnregisterResource(in nsIRDFResource aResource);</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+    /**</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+     * Register a &lt;i&gt;named data source&lt;/i&gt;. The RDF service will call</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+     * &lt;code&gt;nsIRDFDataSource::GetURI()&lt;/code&gt; to determine the URI under</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+     * which to register the data source.</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+     *</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+     * @note that the data source will &lt;i&gt;not&lt;/i&gt; be refcounted by the</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+     * RDF service! The assumption is that an RDF data source</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+     * registers with the service once it is initialized (via</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+     * &lt;code&gt;nsIRDFDataSource::Init()&lt;/code&gt;), and unregisters when the</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+     * last reference to the data source is released.</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+     */</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+    void RegisterDataSource(in nsIRDFDataSource aDataSource,</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+                            in boolean          aReplace);</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+    /**</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+     * Unregister a &lt;i&gt;named data source&lt;/i&gt;. The RDF service will call</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+     * &lt;code&gt;nsIRDFDataSource::GetURI()&lt;/code&gt; to determine the URI under which the</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+     * data source was registered.</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+     */</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    void UnregisterDataSource(in nsIRDFDataSource aDataSource);</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+    /**</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+     * Get the &lt;i&gt;named data source&lt;/i&gt; corresponding to the URI. If a data</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+     * source has been registered via &lt;code&gt;RegisterDataSource()&lt;/code&gt;, that</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+     * data source will be returned.</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+     *</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+     * If no data source is currently</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+     * registered for the specified URI, and a data source &lt;i&gt;constructor&lt;/i&gt;</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+     * function has been registered via &lt;code&gt;RegisterDatasourceConstructor()&lt;/code&gt;,</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+     * the RDF service will call the constructor to attempt to construct a</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+     * new data source. If construction is successful, the data source will</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineplus">+     * be initialized via &lt;code&gt;nsIRDFDataSource::Init()&lt;/code&gt;.</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+     */</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+    nsIRDFDataSource GetDataSource(in string aURI);</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+    /**</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+     * Same as GetDataSource, but if a remote/XML data source needs to be</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+     * constructed, then this method will issue a &lt;b&gt;blocking&lt;/b&gt; Refresh</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+     * call on that data source.</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+     */</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+    nsIRDFDataSource GetDataSourceBlocking(in string aURI);</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+};</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+%{C++</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+extern nsresult</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+NS_NewRDFService(nsIRDFService** result);</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+%}</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/rdf/base/nsIRDFXMLParser.idl</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,33 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+ *</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+#include &quot;nsIStreamListener.idl&quot;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+#include &quot;nsIURI.idl&quot;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+[scriptable, uuid(1831dd2e-1dd2-11b2-bdb3-86b7b50b70b5)]</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+interface nsIRDFXMLParser : nsISupports</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+{</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+    /**</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+     * Create a stream listener that can be used to asynchronously</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+     * parse RDF/XML.</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+     * @param aSink the RDF datasource the will receive the data</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+     * @param aBaseURI the base URI used to resolve relative</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+     *   references in the RDF/XML</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+     * @return an nsIStreamListener object to handle the data</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+     */</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+    nsIStreamListener parseAsync(in nsIRDFDataSource aSink, in nsIURI aBaseURI);</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+    /**</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+     * Parse a string of RDF/XML</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+     * @param aSink the RDF datasource that will receive the data</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+     * @param aBaseURI the base URI used to resolve relative</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+     *   references in the RDF/XML</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+     * @param aSource a UTF8 string containing RDF/XML data.</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+     */</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+    void parseString(in nsIRDFDataSource aSink, in nsIURI aBaseURI, in AUTF8String aSource);</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/rdf/base/nsIRDFXMLSerializer.idl</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+ *</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+#include &quot;nsIRDFDataSource.idl&quot;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+%{C++</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+class nsAtom;</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+%}</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+[ptr] native nsAtomPtr(nsAtom);</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+[scriptable, uuid(8ae1fbf8-1dd2-11b2-bd21-d728069cca92)]</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+interface nsIRDFXMLSerializer : nsISupports</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+{</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+    /**</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+     * Initialize the serializer with the specified datasource.</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+     * @param aDataSource the datasource from which data will be</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+     *   serialized</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+     */</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+    void init(in nsIRDFDataSource aDataSource);</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+    /**</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+     * Add the specified namespace to the serializer.</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+     * @param aPrefix the attribute namespace prefix</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+     * @param aURI the namespace URI</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+     */</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+    [noscript] void addNameSpace(in nsAtomPtr aPrefix, in DOMString aURI);</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/rdf/base/nsIRDFXMLSink.idl</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,133 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+/*</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  Interfaces for the RDF/XML sink, which parses RDF/XML into</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  a graph representation.</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+*/</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+%{C++</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+class nsAtom;</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+%}</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+[ptr] native nsAtomPtr(nsAtom);</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+// XXX Until these get scriptable. See nsIRDFXMLSink::AddNameSpace()</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+[ref] native nsStringRef(nsString);</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+%{C++</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+#include &quot;nsStringFwd.h&quot;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+%}</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+interface nsIRDFXMLSink;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+/**</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+ * An observer that is notified as progress is made on the load</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+ * of an RDF/XML document in an &lt;code&gt;nsIRDFXMLSink&lt;/code&gt;.</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+ */</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+[scriptable, uuid(EB1A5D30-AB33-11D2-8EC6-00805F29F370)]</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+interface nsIRDFXMLSinkObserver : nsISupports</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+{</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+    /**</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+     * Called when the load begins.</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+     * @param aSink the RDF/XML sink on which the load is beginning.</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+     */</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+    void onBeginLoad(in nsIRDFXMLSink aSink);</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+    /**</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+     * Called when the load is suspended (e.g., for network quantization).</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+     * @param aSink the RDF/XML sink that is being interrupted.</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+     */</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+    void onInterrupt(in nsIRDFXMLSink aSink);</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+    /**</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+     * Called when a suspended load is resuming.</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+     * @param aSink the RDF/XML sink that is resuming.</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+     */</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+    void onResume(in nsIRDFXMLSink aSink);</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+    /**</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+     * Called when an RDF/XML load completes successfully.</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+     * @param aSink the RDF/XML sink that has finished loading.</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+     */</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+    void onEndLoad(in nsIRDFXMLSink aSink);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+    /**</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+     * Called when an error occurs during the load</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+     * @param aSink the RDF/XML sink in which the error occurred</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+     * @param aStatus the networking result code</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+     * @param aErrorMsg an error message, if applicable</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+     */</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+    void onError(in nsIRDFXMLSink aSink, in nsresult aStatus, in wstring aErrorMsg);</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+};</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+/**</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+ * A &quot;sink&quot; that receives and processes RDF/XML. This interface is used</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+ * by the RDF/XML parser.</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+ */</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+[scriptable, uuid(EB1A5D31-AB33-11D2-8EC6-00805F29F370)]</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+interface nsIRDFXMLSink : nsISupports</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+{</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    /**</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+     * Set to &lt;code&gt;true&lt;/code&gt; if the sink is read-only and cannot</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+     * be modified</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+     */</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+    attribute boolean readOnly;</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+    /**</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+     * Initiate the RDF/XML load.</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+     */</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+    void beginLoad();</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+    /**</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineplus">+     * Suspend the RDF/XML load.</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+     */</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+    void interrupt();</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+    /**</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+     * Resume the RDF/XML load.</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+     */</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+    void resume();</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+    /**</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineplus">+     * Complete the RDF/XML load.</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+     */</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+    void endLoad();</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+    /**</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+     * Add namespace information to the RDF/XML sink.</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+     * @param aPrefix the namespace prefix</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineplus">+     * @param aURI the namespace URI</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+     */</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineplus">+    [noscript] void addNameSpace(in nsAtomPtr aPrefix,</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+                                 [const] in nsStringRef aURI);</span>
<a href="#l24.114"></a><span id="l24.114" class="difflineplus">+</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineplus">+    /**</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+     * Add an observer that will be notified as the RDF/XML load</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineplus">+     * progresses.</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineplus">+     * &lt;p&gt;</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+     *</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+     * Note that the sink will acquire a strong reference to the</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+     * observer, so care should be taken to avoid cyclical references</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+     * that cannot be released (i.e., if the observer holds a</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+     * reference to the sink, it should be sure that it eventually</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineplus">+     * clears the reference).</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineplus">+     *</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+     * @param aObserver the observer to add to the sink's set of</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineplus">+     * load observers.</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+     */</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineplus">+    void addXMLSinkObserver(in nsIRDFXMLSinkObserver aObserver);</span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+</span>
<a href="#l24.131"></a><span id="l24.131" class="difflineplus">+    /**</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineplus">+     * Remove an observer from the sink's set of observers.</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+     * @param aObserver the observer to remove.</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+     */</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+    void removeXMLSinkObserver(in nsIRDFXMLSinkObserver aObserver);</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineplus">+};</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/rdf/base/nsIRDFXMLSource.idl</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+#include &quot;nsIOutputStream.idl&quot;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+[scriptable, uuid(4DA56F10-99FE-11d2-8EBB-00805F29F370)]</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+interface nsIRDFXMLSource : nsISupports</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+{</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+    /**</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+     * Serialize the contents of the datasource to aStream.</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+     * @param aStream the output stream the will receive the</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+     *   RDF/XML. Currently, the output stream need only</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+     *   implement the |write()| method.</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+     */</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+    void Serialize(in nsIOutputStream aStream);</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+};</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/rdf/base/nsInMemoryDataSource.cpp</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,1938 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+ *</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+/*</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+  Implementation for an in-memory RDF data store.</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+  TO DO</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+  1) Instrument this code to gather space and time performance</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+     characteristics.</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+  2) Optimize lookups for datasources which have a small number</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+     of properties + fanning out to a large number of targets.</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineplus">+</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineplus">+  3) Complete implementation of thread-safety; specifically, make</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineplus">+     assertions be reference counted objects (so that a cursor can</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+     still refer to an assertion that gets removed from the graph).</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+ */</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+#include &quot;nsAgg.h&quot;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+#include &quot;nsIRDFLiteral.h&quot;</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+#include &quot;nsIRDFObserver.h&quot;</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+#include &quot;nsIRDFInMemoryDataSource.h&quot;</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineplus">+#include &quot;nsIRDFPropagatableDataSource.h&quot;</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+#include &quot;nsIRDFPurgeableDataSource.h&quot;</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+#include &quot;nsRDFBaseDataSources.h&quot;</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineplus">+#include &quot;PLDHashTable.h&quot;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+#include &quot;plstr.h&quot;</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+#include &quot;rdfIDataSource.h&quot;</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+#include &quot;rdfITripleVisitor.h&quot;</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+using mozilla::LogLevel;</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+// This struct is used as the slot value in the forward and reverse</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+// arcs hash tables.</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+//</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+// Assertion objects are reference counted, because each Assertion's</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+// ownership is shared between the datasource and any enumerators that</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+// are currently iterating over the datasource.</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+//</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+class Assertion</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+{</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+public:</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+    Assertion(nsIRDFResource* aSource,      // normal assertion</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+              nsIRDFResource* aProperty,</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+              nsIRDFNode* aTarget,</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+              bool aTruthValue);</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+    explicit Assertion(nsIRDFResource* aSource);     // PLDHashTable assertion variant</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+private:</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+    ~Assertion();</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineplus">+</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+public:</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+    void AddRef() {</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+        if (mRefCnt == UINT16_MAX) {</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+            NS_WARNING(&quot;refcount overflow, leaking Assertion&quot;);</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+            return;</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+        }</span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+        ++mRefCnt;</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineplus">+    }</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineplus">+    void Release() {</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineplus">+        if (mRefCnt == UINT16_MAX) {</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineplus">+            NS_WARNING(&quot;refcount overflow, leaking Assertion&quot;);</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+            return;</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineplus">+        }</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+        if (--mRefCnt == 0)</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineplus">+            delete this;</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineplus">+    }</span>
<a href="#l26.99"></a><span id="l26.99" class="difflineplus">+</span>
<a href="#l26.100"></a><span id="l26.100" class="difflineplus">+    // For nsIRDFPurgeableDataSource</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineplus">+    inline  void    Mark()      { u.as.mMarked = true; }</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+    inline  bool    IsMarked()  { return u.as.mMarked; }</span>
<a href="#l26.103"></a><span id="l26.103" class="difflineplus">+    inline  void    Unmark()    { u.as.mMarked = false; }</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineplus">+</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+    // public for now, because I'm too lazy to go thru and clean this up.</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+    // These are shared between hash/as (see the union below)</span>
<a href="#l26.108"></a><span id="l26.108" class="difflineplus">+    nsIRDFResource*         mSource;</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineplus">+    Assertion*              mNext;</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+    union</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineplus">+    {</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+        struct hash</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineplus">+        {</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineplus">+            PLDHashTable*  mPropertyHash;</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineplus">+        } hash;</span>
<a href="#l26.117"></a><span id="l26.117" class="difflineplus">+        struct as</span>
<a href="#l26.118"></a><span id="l26.118" class="difflineplus">+        {</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineplus">+            nsIRDFResource* mProperty;</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+            nsIRDFNode*     mTarget;</span>
<a href="#l26.121"></a><span id="l26.121" class="difflineplus">+            Assertion*      mInvNext;</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineplus">+            // make sure bool are final elements</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineplus">+            bool            mTruthValue;</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+            bool            mMarked;</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineplus">+        } as;</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineplus">+    } u;</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+    // also shared between hash/as (see the union above)</span>
<a href="#l26.129"></a><span id="l26.129" class="difflineplus">+    // but placed after union definition to ensure that</span>
<a href="#l26.130"></a><span id="l26.130" class="difflineplus">+    // all 32-bit entries are long aligned</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineplus">+    uint16_t                    mRefCnt;</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+    bool                        mHashEntry;</span>
<a href="#l26.133"></a><span id="l26.133" class="difflineplus">+};</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineplus">+</span>
<a href="#l26.135"></a><span id="l26.135" class="difflineplus">+</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineplus">+struct Entry : PLDHashEntryHdr {</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+    nsIRDFNode*     mNode;</span>
<a href="#l26.138"></a><span id="l26.138" class="difflineplus">+    Assertion*      mAssertions;</span>
<a href="#l26.139"></a><span id="l26.139" class="difflineplus">+};</span>
<a href="#l26.140"></a><span id="l26.140" class="difflineplus">+</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineplus">+</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineplus">+Assertion::Assertion(nsIRDFResource* aSource)</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineplus">+    : mSource(aSource),</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineplus">+      mNext(nullptr),</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineplus">+      mRefCnt(0),</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineplus">+      mHashEntry(true)</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineplus">+{</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineplus">+    MOZ_COUNT_CTOR(Assertion);</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+    NS_ADDREF(mSource);</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+</span>
<a href="#l26.152"></a><span id="l26.152" class="difflineplus">+    u.hash.mPropertyHash =</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineplus">+        new PLDHashTable(PLDHashTable::StubOps(), sizeof(Entry));</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+}</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineplus">+</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineplus">+Assertion::Assertion(nsIRDFResource* aSource,</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineplus">+                     nsIRDFResource* aProperty,</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineplus">+                     nsIRDFNode* aTarget,</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+                     bool aTruthValue)</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineplus">+    : mSource(aSource),</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineplus">+      mNext(nullptr),</span>
<a href="#l26.162"></a><span id="l26.162" class="difflineplus">+      mRefCnt(0),</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineplus">+      mHashEntry(false)</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineplus">+{</span>
<a href="#l26.165"></a><span id="l26.165" class="difflineplus">+    MOZ_COUNT_CTOR(Assertion);</span>
<a href="#l26.166"></a><span id="l26.166" class="difflineplus">+</span>
<a href="#l26.167"></a><span id="l26.167" class="difflineplus">+    u.as.mProperty = aProperty;</span>
<a href="#l26.168"></a><span id="l26.168" class="difflineplus">+    u.as.mTarget = aTarget;</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineplus">+</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineplus">+    NS_ADDREF(mSource);</span>
<a href="#l26.171"></a><span id="l26.171" class="difflineplus">+    NS_ADDREF(u.as.mProperty);</span>
<a href="#l26.172"></a><span id="l26.172" class="difflineplus">+    NS_ADDREF(u.as.mTarget);</span>
<a href="#l26.173"></a><span id="l26.173" class="difflineplus">+</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineplus">+    u.as.mInvNext = nullptr;</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineplus">+    u.as.mTruthValue = aTruthValue;</span>
<a href="#l26.176"></a><span id="l26.176" class="difflineplus">+    u.as.mMarked = false;</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineplus">+}</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineplus">+Assertion::~Assertion()</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineplus">+{</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+    if (mHashEntry &amp;&amp; u.hash.mPropertyHash) {</span>
<a href="#l26.182"></a><span id="l26.182" class="difflineplus">+        for (auto i = u.hash.mPropertyHash-&gt;Iter(); !i.Done(); i.Next()) {</span>
<a href="#l26.183"></a><span id="l26.183" class="difflineplus">+            auto entry = static_cast&lt;Entry*&gt;(i.Get());</span>
<a href="#l26.184"></a><span id="l26.184" class="difflineplus">+            Assertion* as = entry-&gt;mAssertions;</span>
<a href="#l26.185"></a><span id="l26.185" class="difflineplus">+            while (as) {</span>
<a href="#l26.186"></a><span id="l26.186" class="difflineplus">+                Assertion* doomed = as;</span>
<a href="#l26.187"></a><span id="l26.187" class="difflineplus">+                as = as-&gt;mNext;</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineplus">+</span>
<a href="#l26.189"></a><span id="l26.189" class="difflineplus">+                // Unlink, and release the datasource's reference.</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineplus">+                doomed-&gt;mNext = doomed-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineplus">+                doomed-&gt;Release();</span>
<a href="#l26.192"></a><span id="l26.192" class="difflineplus">+            }</span>
<a href="#l26.193"></a><span id="l26.193" class="difflineplus">+        }</span>
<a href="#l26.194"></a><span id="l26.194" class="difflineplus">+        delete u.hash.mPropertyHash;</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineplus">+        u.hash.mPropertyHash = nullptr;</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+    }</span>
<a href="#l26.197"></a><span id="l26.197" class="difflineplus">+</span>
<a href="#l26.198"></a><span id="l26.198" class="difflineplus">+    MOZ_COUNT_DTOR(Assertion);</span>
<a href="#l26.199"></a><span id="l26.199" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l26.200"></a><span id="l26.200" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l26.201"></a><span id="l26.201" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: Assertion\n&quot;, gInstanceCount);</span>
<a href="#l26.202"></a><span id="l26.202" class="difflineplus">+#endif</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineplus">+</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+    NS_RELEASE(mSource);</span>
<a href="#l26.205"></a><span id="l26.205" class="difflineplus">+    if (!mHashEntry)</span>
<a href="#l26.206"></a><span id="l26.206" class="difflineplus">+    {</span>
<a href="#l26.207"></a><span id="l26.207" class="difflineplus">+        NS_RELEASE(u.as.mProperty);</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineplus">+        NS_RELEASE(u.as.mTarget);</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineplus">+    }</span>
<a href="#l26.210"></a><span id="l26.210" class="difflineplus">+}</span>
<a href="#l26.211"></a><span id="l26.211" class="difflineplus">+</span>
<a href="#l26.212"></a><span id="l26.212" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineplus">+// InMemoryDataSource</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineplus">+class InMemoryArcsEnumeratorImpl;</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineplus">+class InMemoryAssertionEnumeratorImpl;</span>
<a href="#l26.216"></a><span id="l26.216" class="difflineplus">+class InMemoryResourceEnumeratorImpl;</span>
<a href="#l26.217"></a><span id="l26.217" class="difflineplus">+</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineplus">+class InMemoryDataSource : public nsIRDFDataSource,</span>
<a href="#l26.219"></a><span id="l26.219" class="difflineplus">+                           public nsIRDFInMemoryDataSource,</span>
<a href="#l26.220"></a><span id="l26.220" class="difflineplus">+                           public nsIRDFPropagatableDataSource,</span>
<a href="#l26.221"></a><span id="l26.221" class="difflineplus">+                           public nsIRDFPurgeableDataSource,</span>
<a href="#l26.222"></a><span id="l26.222" class="difflineplus">+                           public rdfIDataSource</span>
<a href="#l26.223"></a><span id="l26.223" class="difflineplus">+{</span>
<a href="#l26.224"></a><span id="l26.224" class="difflineplus">+protected:</span>
<a href="#l26.225"></a><span id="l26.225" class="difflineplus">+    // These hash tables are keyed on pointers to nsIRDFResource</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineplus">+    // objects (the nsIRDFService ensures that there is only ever one</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineplus">+    // nsIRDFResource object per unique URI). The value of an entry is</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineplus">+    // an Assertion struct, which is a linked list of (subject</span>
<a href="#l26.229"></a><span id="l26.229" class="difflineplus">+    // predicate object) triples.</span>
<a href="#l26.230"></a><span id="l26.230" class="difflineplus">+    PLDHashTable mForwardArcs;</span>
<a href="#l26.231"></a><span id="l26.231" class="difflineplus">+    PLDHashTable mReverseArcs;</span>
<a href="#l26.232"></a><span id="l26.232" class="difflineplus">+</span>
<a href="#l26.233"></a><span id="l26.233" class="difflineplus">+    nsCOMArray&lt;nsIRDFObserver&gt; mObservers;</span>
<a href="#l26.234"></a><span id="l26.234" class="difflineplus">+    uint32_t                   mNumObservers;</span>
<a href="#l26.235"></a><span id="l26.235" class="difflineplus">+</span>
<a href="#l26.236"></a><span id="l26.236" class="difflineplus">+    // VisitFoo needs to block writes, [Un]Assert only allowed</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineplus">+    // during mReadCount == 0</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineplus">+    uint32_t mReadCount;</span>
<a href="#l26.239"></a><span id="l26.239" class="difflineplus">+</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineplus">+    friend class InMemoryArcsEnumeratorImpl;</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineplus">+    friend class InMemoryAssertionEnumeratorImpl;</span>
<a href="#l26.242"></a><span id="l26.242" class="difflineplus">+    friend class InMemoryResourceEnumeratorImpl; // b/c it needs to enumerate mForwardArcs</span>
<a href="#l26.243"></a><span id="l26.243" class="difflineplus">+</span>
<a href="#l26.244"></a><span id="l26.244" class="difflineplus">+    // Thread-safe writer implementation methods.</span>
<a href="#l26.245"></a><span id="l26.245" class="difflineplus">+    nsresult</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineplus">+    LockedAssert(nsIRDFResource* source,</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineplus">+                 nsIRDFResource* property,</span>
<a href="#l26.248"></a><span id="l26.248" class="difflineplus">+                 nsIRDFNode* target,</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineplus">+                 bool tv);</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineplus">+</span>
<a href="#l26.251"></a><span id="l26.251" class="difflineplus">+    nsresult</span>
<a href="#l26.252"></a><span id="l26.252" class="difflineplus">+    LockedUnassert(nsIRDFResource* source,</span>
<a href="#l26.253"></a><span id="l26.253" class="difflineplus">+                   nsIRDFResource* property,</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineplus">+                   nsIRDFNode* target);</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineplus">+</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineplus">+    explicit InMemoryDataSource(nsISupports* aOuter);</span>
<a href="#l26.257"></a><span id="l26.257" class="difflineplus">+    virtual ~InMemoryDataSource();</span>
<a href="#l26.258"></a><span id="l26.258" class="difflineplus">+</span>
<a href="#l26.259"></a><span id="l26.259" class="difflineplus">+    friend nsresult</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineplus">+    NS_NewRDFInMemoryDataSource(nsISupports* aOuter, const nsIID&amp; aIID, void** aResult);</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineplus">+</span>
<a href="#l26.262"></a><span id="l26.262" class="difflineplus">+public:</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineplus">+    NS_DECL_CYCLE_COLLECTING_AGGREGATED</span>
<a href="#l26.264"></a><span id="l26.264" class="difflineplus">+    NS_DECL_AGGREGATED_CYCLE_COLLECTION_CLASS(InMemoryDataSource)</span>
<a href="#l26.265"></a><span id="l26.265" class="difflineplus">+</span>
<a href="#l26.266"></a><span id="l26.266" class="difflineplus">+    // nsIRDFDataSource methods</span>
<a href="#l26.267"></a><span id="l26.267" class="difflineplus">+    NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l26.268"></a><span id="l26.268" class="difflineplus">+</span>
<a href="#l26.269"></a><span id="l26.269" class="difflineplus">+    // nsIRDFInMemoryDataSource methods</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineplus">+    NS_DECL_NSIRDFINMEMORYDATASOURCE</span>
<a href="#l26.271"></a><span id="l26.271" class="difflineplus">+</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineplus">+    // nsIRDFPropagatableDataSource methods</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineplus">+    NS_DECL_NSIRDFPROPAGATABLEDATASOURCE</span>
<a href="#l26.274"></a><span id="l26.274" class="difflineplus">+</span>
<a href="#l26.275"></a><span id="l26.275" class="difflineplus">+    // nsIRDFPurgeableDataSource methods</span>
<a href="#l26.276"></a><span id="l26.276" class="difflineplus">+    NS_DECL_NSIRDFPURGEABLEDATASOURCE</span>
<a href="#l26.277"></a><span id="l26.277" class="difflineplus">+</span>
<a href="#l26.278"></a><span id="l26.278" class="difflineplus">+    // rdfIDataSource methods</span>
<a href="#l26.279"></a><span id="l26.279" class="difflineplus">+    NS_DECL_RDFIDATASOURCE</span>
<a href="#l26.280"></a><span id="l26.280" class="difflineplus">+</span>
<a href="#l26.281"></a><span id="l26.281" class="difflineplus">+protected:</span>
<a href="#l26.282"></a><span id="l26.282" class="difflineplus">+    struct SweepInfo {</span>
<a href="#l26.283"></a><span id="l26.283" class="difflineplus">+        Assertion* mUnassertList;</span>
<a href="#l26.284"></a><span id="l26.284" class="difflineplus">+        PLDHashTable* mReverseArcs;</span>
<a href="#l26.285"></a><span id="l26.285" class="difflineplus">+    };</span>
<a href="#l26.286"></a><span id="l26.286" class="difflineplus">+</span>
<a href="#l26.287"></a><span id="l26.287" class="difflineplus">+    static void</span>
<a href="#l26.288"></a><span id="l26.288" class="difflineplus">+    SweepForwardArcsEntries(PLDHashTable* aTable, SweepInfo* aArg);</span>
<a href="#l26.289"></a><span id="l26.289" class="difflineplus">+</span>
<a href="#l26.290"></a><span id="l26.290" class="difflineplus">+public:</span>
<a href="#l26.291"></a><span id="l26.291" class="difflineplus">+    // Implementation methods</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineplus">+    Assertion*</span>
<a href="#l26.293"></a><span id="l26.293" class="difflineplus">+    GetForwardArcs(nsIRDFResource* u) {</span>
<a href="#l26.294"></a><span id="l26.294" class="difflineplus">+        PLDHashEntryHdr* hdr = mForwardArcs.Search(u);</span>
<a href="#l26.295"></a><span id="l26.295" class="difflineplus">+        return hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.296"></a><span id="l26.296" class="difflineplus">+    }</span>
<a href="#l26.297"></a><span id="l26.297" class="difflineplus">+</span>
<a href="#l26.298"></a><span id="l26.298" class="difflineplus">+    Assertion*</span>
<a href="#l26.299"></a><span id="l26.299" class="difflineplus">+    GetReverseArcs(nsIRDFNode* v) {</span>
<a href="#l26.300"></a><span id="l26.300" class="difflineplus">+        PLDHashEntryHdr* hdr = mReverseArcs.Search(v);</span>
<a href="#l26.301"></a><span id="l26.301" class="difflineplus">+        return hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.302"></a><span id="l26.302" class="difflineplus">+    }</span>
<a href="#l26.303"></a><span id="l26.303" class="difflineplus">+</span>
<a href="#l26.304"></a><span id="l26.304" class="difflineplus">+    void</span>
<a href="#l26.305"></a><span id="l26.305" class="difflineplus">+    SetForwardArcs(nsIRDFResource* u, Assertion* as) {</span>
<a href="#l26.306"></a><span id="l26.306" class="difflineplus">+        if (as) {</span>
<a href="#l26.307"></a><span id="l26.307" class="difflineplus">+            auto entry =</span>
<a href="#l26.308"></a><span id="l26.308" class="difflineplus">+                static_cast&lt;Entry*&gt;(mForwardArcs.Add(u, mozilla::fallible));</span>
<a href="#l26.309"></a><span id="l26.309" class="difflineplus">+            if (entry) {</span>
<a href="#l26.310"></a><span id="l26.310" class="difflineplus">+                entry-&gt;mNode = u;</span>
<a href="#l26.311"></a><span id="l26.311" class="difflineplus">+                entry-&gt;mAssertions = as;</span>
<a href="#l26.312"></a><span id="l26.312" class="difflineplus">+            }</span>
<a href="#l26.313"></a><span id="l26.313" class="difflineplus">+        }</span>
<a href="#l26.314"></a><span id="l26.314" class="difflineplus">+        else {</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineplus">+            mForwardArcs.Remove(u);</span>
<a href="#l26.316"></a><span id="l26.316" class="difflineplus">+        }</span>
<a href="#l26.317"></a><span id="l26.317" class="difflineplus">+    }</span>
<a href="#l26.318"></a><span id="l26.318" class="difflineplus">+</span>
<a href="#l26.319"></a><span id="l26.319" class="difflineplus">+    void</span>
<a href="#l26.320"></a><span id="l26.320" class="difflineplus">+    SetReverseArcs(nsIRDFNode* v, Assertion* as) {</span>
<a href="#l26.321"></a><span id="l26.321" class="difflineplus">+        if (as) {</span>
<a href="#l26.322"></a><span id="l26.322" class="difflineplus">+            auto entry =</span>
<a href="#l26.323"></a><span id="l26.323" class="difflineplus">+                static_cast&lt;Entry*&gt;(mReverseArcs.Add(v, mozilla::fallible));</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineplus">+            if (entry) {</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineplus">+                entry-&gt;mNode = v;</span>
<a href="#l26.326"></a><span id="l26.326" class="difflineplus">+                entry-&gt;mAssertions = as;</span>
<a href="#l26.327"></a><span id="l26.327" class="difflineplus">+            }</span>
<a href="#l26.328"></a><span id="l26.328" class="difflineplus">+        }</span>
<a href="#l26.329"></a><span id="l26.329" class="difflineplus">+        else {</span>
<a href="#l26.330"></a><span id="l26.330" class="difflineplus">+            mReverseArcs.Remove(v);</span>
<a href="#l26.331"></a><span id="l26.331" class="difflineplus">+        }</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineplus">+    }</span>
<a href="#l26.333"></a><span id="l26.333" class="difflineplus">+</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineplus">+    void</span>
<a href="#l26.335"></a><span id="l26.335" class="difflineplus">+    LogOperation(const char* aOperation,</span>
<a href="#l26.336"></a><span id="l26.336" class="difflineplus">+                 nsIRDFResource* asource,</span>
<a href="#l26.337"></a><span id="l26.337" class="difflineplus">+                 nsIRDFResource* aProperty,</span>
<a href="#l26.338"></a><span id="l26.338" class="difflineplus">+                 nsIRDFNode* aTarget,</span>
<a href="#l26.339"></a><span id="l26.339" class="difflineplus">+                 bool aTruthValue = true);</span>
<a href="#l26.340"></a><span id="l26.340" class="difflineplus">+</span>
<a href="#l26.341"></a><span id="l26.341" class="difflineplus">+    bool    mPropagateChanges;</span>
<a href="#l26.342"></a><span id="l26.342" class="difflineplus">+</span>
<a href="#l26.343"></a><span id="l26.343" class="difflineplus">+private:</span>
<a href="#l26.344"></a><span id="l26.344" class="difflineplus">+    static mozilla::LazyLogModule gLog;</span>
<a href="#l26.345"></a><span id="l26.345" class="difflineplus">+};</span>
<a href="#l26.346"></a><span id="l26.346" class="difflineplus">+</span>
<a href="#l26.347"></a><span id="l26.347" class="difflineplus">+mozilla::LazyLogModule InMemoryDataSource::gLog(&quot;InMemoryDataSource&quot;);</span>
<a href="#l26.348"></a><span id="l26.348" class="difflineplus">+</span>
<a href="#l26.349"></a><span id="l26.349" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l26.350"></a><span id="l26.350" class="difflineplus">+//</span>
<a href="#l26.351"></a><span id="l26.351" class="difflineplus">+// InMemoryAssertionEnumeratorImpl</span>
<a href="#l26.352"></a><span id="l26.352" class="difflineplus">+//</span>
<a href="#l26.353"></a><span id="l26.353" class="difflineplus">+</span>
<a href="#l26.354"></a><span id="l26.354" class="difflineplus">+/**</span>
<a href="#l26.355"></a><span id="l26.355" class="difflineplus">+ * InMemoryAssertionEnumeratorImpl</span>
<a href="#l26.356"></a><span id="l26.356" class="difflineplus">+ */</span>
<a href="#l26.357"></a><span id="l26.357" class="difflineplus">+class InMemoryAssertionEnumeratorImpl : public nsISimpleEnumerator</span>
<a href="#l26.358"></a><span id="l26.358" class="difflineplus">+{</span>
<a href="#l26.359"></a><span id="l26.359" class="difflineplus">+private:</span>
<a href="#l26.360"></a><span id="l26.360" class="difflineplus">+    InMemoryDataSource* mDataSource;</span>
<a href="#l26.361"></a><span id="l26.361" class="difflineplus">+    nsIRDFResource* mSource;</span>
<a href="#l26.362"></a><span id="l26.362" class="difflineplus">+    nsIRDFResource* mProperty;</span>
<a href="#l26.363"></a><span id="l26.363" class="difflineplus">+    nsIRDFNode*     mTarget;</span>
<a href="#l26.364"></a><span id="l26.364" class="difflineplus">+    nsIRDFNode*     mValue;</span>
<a href="#l26.365"></a><span id="l26.365" class="difflineplus">+    bool            mTruthValue;</span>
<a href="#l26.366"></a><span id="l26.366" class="difflineplus">+    Assertion*      mNextAssertion;</span>
<a href="#l26.367"></a><span id="l26.367" class="difflineplus">+</span>
<a href="#l26.368"></a><span id="l26.368" class="difflineplus">+    virtual ~InMemoryAssertionEnumeratorImpl();</span>
<a href="#l26.369"></a><span id="l26.369" class="difflineplus">+</span>
<a href="#l26.370"></a><span id="l26.370" class="difflineplus">+public:</span>
<a href="#l26.371"></a><span id="l26.371" class="difflineplus">+    InMemoryAssertionEnumeratorImpl(InMemoryDataSource* aDataSource,</span>
<a href="#l26.372"></a><span id="l26.372" class="difflineplus">+                                    nsIRDFResource* aSource,</span>
<a href="#l26.373"></a><span id="l26.373" class="difflineplus">+                                    nsIRDFResource* aProperty,</span>
<a href="#l26.374"></a><span id="l26.374" class="difflineplus">+                                    nsIRDFNode* aTarget,</span>
<a href="#l26.375"></a><span id="l26.375" class="difflineplus">+                                    bool aTruthValue);</span>
<a href="#l26.376"></a><span id="l26.376" class="difflineplus">+</span>
<a href="#l26.377"></a><span id="l26.377" class="difflineplus">+    // nsISupports interface</span>
<a href="#l26.378"></a><span id="l26.378" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l26.379"></a><span id="l26.379" class="difflineplus">+</span>
<a href="#l26.380"></a><span id="l26.380" class="difflineplus">+    // nsISimpleEnumerator interface</span>
<a href="#l26.381"></a><span id="l26.381" class="difflineplus">+    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l26.382"></a><span id="l26.382" class="difflineplus">+};</span>
<a href="#l26.383"></a><span id="l26.383" class="difflineplus">+</span>
<a href="#l26.384"></a><span id="l26.384" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.385"></a><span id="l26.385" class="difflineplus">+</span>
<a href="#l26.386"></a><span id="l26.386" class="difflineplus">+</span>
<a href="#l26.387"></a><span id="l26.387" class="difflineplus">+InMemoryAssertionEnumeratorImpl::InMemoryAssertionEnumeratorImpl(</span>
<a href="#l26.388"></a><span id="l26.388" class="difflineplus">+                 InMemoryDataSource* aDataSource,</span>
<a href="#l26.389"></a><span id="l26.389" class="difflineplus">+                 nsIRDFResource* aSource,</span>
<a href="#l26.390"></a><span id="l26.390" class="difflineplus">+                 nsIRDFResource* aProperty,</span>
<a href="#l26.391"></a><span id="l26.391" class="difflineplus">+                 nsIRDFNode* aTarget,</span>
<a href="#l26.392"></a><span id="l26.392" class="difflineplus">+                 bool aTruthValue)</span>
<a href="#l26.393"></a><span id="l26.393" class="difflineplus">+    : mDataSource(aDataSource),</span>
<a href="#l26.394"></a><span id="l26.394" class="difflineplus">+      mSource(aSource),</span>
<a href="#l26.395"></a><span id="l26.395" class="difflineplus">+      mProperty(aProperty),</span>
<a href="#l26.396"></a><span id="l26.396" class="difflineplus">+      mTarget(aTarget),</span>
<a href="#l26.397"></a><span id="l26.397" class="difflineplus">+      mValue(nullptr),</span>
<a href="#l26.398"></a><span id="l26.398" class="difflineplus">+      mTruthValue(aTruthValue),</span>
<a href="#l26.399"></a><span id="l26.399" class="difflineplus">+      mNextAssertion(nullptr)</span>
<a href="#l26.400"></a><span id="l26.400" class="difflineplus">+{</span>
<a href="#l26.401"></a><span id="l26.401" class="difflineplus">+    NS_ADDREF(mDataSource);</span>
<a href="#l26.402"></a><span id="l26.402" class="difflineplus">+    NS_IF_ADDREF(mSource);</span>
<a href="#l26.403"></a><span id="l26.403" class="difflineplus">+    NS_ADDREF(mProperty);</span>
<a href="#l26.404"></a><span id="l26.404" class="difflineplus">+    NS_IF_ADDREF(mTarget);</span>
<a href="#l26.405"></a><span id="l26.405" class="difflineplus">+</span>
<a href="#l26.406"></a><span id="l26.406" class="difflineplus">+    if (mSource) {</span>
<a href="#l26.407"></a><span id="l26.407" class="difflineplus">+        mNextAssertion = mDataSource-&gt;GetForwardArcs(mSource);</span>
<a href="#l26.408"></a><span id="l26.408" class="difflineplus">+</span>
<a href="#l26.409"></a><span id="l26.409" class="difflineplus">+        if (mNextAssertion &amp;&amp; mNextAssertion-&gt;mHashEntry) {</span>
<a href="#l26.410"></a><span id="l26.410" class="difflineplus">+            // its our magical HASH_ENTRY forward hash for assertions</span>
<a href="#l26.411"></a><span id="l26.411" class="difflineplus">+            PLDHashEntryHdr* hdr =</span>
<a href="#l26.412"></a><span id="l26.412" class="difflineplus">+                mNextAssertion-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l26.413"></a><span id="l26.413" class="difflineplus">+            mNextAssertion =</span>
<a href="#l26.414"></a><span id="l26.414" class="difflineplus">+                hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.415"></a><span id="l26.415" class="difflineplus">+        }</span>
<a href="#l26.416"></a><span id="l26.416" class="difflineplus">+    }</span>
<a href="#l26.417"></a><span id="l26.417" class="difflineplus">+    else {</span>
<a href="#l26.418"></a><span id="l26.418" class="difflineplus">+        mNextAssertion = mDataSource-&gt;GetReverseArcs(mTarget);</span>
<a href="#l26.419"></a><span id="l26.419" class="difflineplus">+    }</span>
<a href="#l26.420"></a><span id="l26.420" class="difflineplus">+</span>
<a href="#l26.421"></a><span id="l26.421" class="difflineplus">+    // Add an owning reference from the enumerator</span>
<a href="#l26.422"></a><span id="l26.422" class="difflineplus">+    if (mNextAssertion)</span>
<a href="#l26.423"></a><span id="l26.423" class="difflineplus">+        mNextAssertion-&gt;AddRef();</span>
<a href="#l26.424"></a><span id="l26.424" class="difflineplus">+}</span>
<a href="#l26.425"></a><span id="l26.425" class="difflineplus">+</span>
<a href="#l26.426"></a><span id="l26.426" class="difflineplus">+InMemoryAssertionEnumeratorImpl::~InMemoryAssertionEnumeratorImpl()</span>
<a href="#l26.427"></a><span id="l26.427" class="difflineplus">+{</span>
<a href="#l26.428"></a><span id="l26.428" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l26.429"></a><span id="l26.429" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l26.430"></a><span id="l26.430" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: InMemoryAssertionEnumeratorImpl\n&quot;, gInstanceCount);</span>
<a href="#l26.431"></a><span id="l26.431" class="difflineplus">+#endif</span>
<a href="#l26.432"></a><span id="l26.432" class="difflineplus">+</span>
<a href="#l26.433"></a><span id="l26.433" class="difflineplus">+    if (mNextAssertion)</span>
<a href="#l26.434"></a><span id="l26.434" class="difflineplus">+        mNextAssertion-&gt;Release();</span>
<a href="#l26.435"></a><span id="l26.435" class="difflineplus">+</span>
<a href="#l26.436"></a><span id="l26.436" class="difflineplus">+    NS_IF_RELEASE(mDataSource);</span>
<a href="#l26.437"></a><span id="l26.437" class="difflineplus">+    NS_IF_RELEASE(mSource);</span>
<a href="#l26.438"></a><span id="l26.438" class="difflineplus">+    NS_IF_RELEASE(mProperty);</span>
<a href="#l26.439"></a><span id="l26.439" class="difflineplus">+    NS_IF_RELEASE(mTarget);</span>
<a href="#l26.440"></a><span id="l26.440" class="difflineplus">+    NS_IF_RELEASE(mValue);</span>
<a href="#l26.441"></a><span id="l26.441" class="difflineplus">+}</span>
<a href="#l26.442"></a><span id="l26.442" class="difflineplus">+</span>
<a href="#l26.443"></a><span id="l26.443" class="difflineplus">+NS_IMPL_ADDREF(InMemoryAssertionEnumeratorImpl)</span>
<a href="#l26.444"></a><span id="l26.444" class="difflineplus">+NS_IMPL_RELEASE(InMemoryAssertionEnumeratorImpl)</span>
<a href="#l26.445"></a><span id="l26.445" class="difflineplus">+NS_IMPL_QUERY_INTERFACE(InMemoryAssertionEnumeratorImpl, nsISimpleEnumerator)</span>
<a href="#l26.446"></a><span id="l26.446" class="difflineplus">+</span>
<a href="#l26.447"></a><span id="l26.447" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.448"></a><span id="l26.448" class="difflineplus">+InMemoryAssertionEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l26.449"></a><span id="l26.449" class="difflineplus">+{</span>
<a href="#l26.450"></a><span id="l26.450" class="difflineplus">+    if (mValue) {</span>
<a href="#l26.451"></a><span id="l26.451" class="difflineplus">+        *aResult = true;</span>
<a href="#l26.452"></a><span id="l26.452" class="difflineplus">+        return NS_OK;</span>
<a href="#l26.453"></a><span id="l26.453" class="difflineplus">+    }</span>
<a href="#l26.454"></a><span id="l26.454" class="difflineplus">+</span>
<a href="#l26.455"></a><span id="l26.455" class="difflineplus">+    while (mNextAssertion) {</span>
<a href="#l26.456"></a><span id="l26.456" class="difflineplus">+        bool foundIt = false;</span>
<a href="#l26.457"></a><span id="l26.457" class="difflineplus">+        if ((mProperty == mNextAssertion-&gt;u.as.mProperty) &amp;&amp;</span>
<a href="#l26.458"></a><span id="l26.458" class="difflineplus">+            (mTruthValue == mNextAssertion-&gt;u.as.mTruthValue)) {</span>
<a href="#l26.459"></a><span id="l26.459" class="difflineplus">+            if (mSource) {</span>
<a href="#l26.460"></a><span id="l26.460" class="difflineplus">+                mValue = mNextAssertion-&gt;u.as.mTarget;</span>
<a href="#l26.461"></a><span id="l26.461" class="difflineplus">+                NS_ADDREF(mValue);</span>
<a href="#l26.462"></a><span id="l26.462" class="difflineplus">+            }</span>
<a href="#l26.463"></a><span id="l26.463" class="difflineplus">+            else {</span>
<a href="#l26.464"></a><span id="l26.464" class="difflineplus">+                mValue = mNextAssertion-&gt;mSource;</span>
<a href="#l26.465"></a><span id="l26.465" class="difflineplus">+                NS_ADDREF(mValue);</span>
<a href="#l26.466"></a><span id="l26.466" class="difflineplus">+            }</span>
<a href="#l26.467"></a><span id="l26.467" class="difflineplus">+            foundIt = true;</span>
<a href="#l26.468"></a><span id="l26.468" class="difflineplus">+        }</span>
<a href="#l26.469"></a><span id="l26.469" class="difflineplus">+</span>
<a href="#l26.470"></a><span id="l26.470" class="difflineplus">+        // Remember the last assertion we were holding on to</span>
<a href="#l26.471"></a><span id="l26.471" class="difflineplus">+        Assertion* as = mNextAssertion;</span>
<a href="#l26.472"></a><span id="l26.472" class="difflineplus">+</span>
<a href="#l26.473"></a><span id="l26.473" class="difflineplus">+        // iterate</span>
<a href="#l26.474"></a><span id="l26.474" class="difflineplus">+        mNextAssertion = (mSource) ? mNextAssertion-&gt;mNext : mNextAssertion-&gt;u.as.mInvNext;</span>
<a href="#l26.475"></a><span id="l26.475" class="difflineplus">+</span>
<a href="#l26.476"></a><span id="l26.476" class="difflineplus">+        // grab an owning reference from the enumerator to the next assertion</span>
<a href="#l26.477"></a><span id="l26.477" class="difflineplus">+        if (mNextAssertion)</span>
<a href="#l26.478"></a><span id="l26.478" class="difflineplus">+            mNextAssertion-&gt;AddRef();</span>
<a href="#l26.479"></a><span id="l26.479" class="difflineplus">+</span>
<a href="#l26.480"></a><span id="l26.480" class="difflineplus">+        // ...and release the reference from the enumerator to the old one.</span>
<a href="#l26.481"></a><span id="l26.481" class="difflineplus">+        as-&gt;Release();</span>
<a href="#l26.482"></a><span id="l26.482" class="difflineplus">+</span>
<a href="#l26.483"></a><span id="l26.483" class="difflineplus">+        if (foundIt) {</span>
<a href="#l26.484"></a><span id="l26.484" class="difflineplus">+            *aResult = true;</span>
<a href="#l26.485"></a><span id="l26.485" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.486"></a><span id="l26.486" class="difflineplus">+        }</span>
<a href="#l26.487"></a><span id="l26.487" class="difflineplus">+    }</span>
<a href="#l26.488"></a><span id="l26.488" class="difflineplus">+</span>
<a href="#l26.489"></a><span id="l26.489" class="difflineplus">+    *aResult = false;</span>
<a href="#l26.490"></a><span id="l26.490" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.491"></a><span id="l26.491" class="difflineplus">+}</span>
<a href="#l26.492"></a><span id="l26.492" class="difflineplus">+</span>
<a href="#l26.493"></a><span id="l26.493" class="difflineplus">+</span>
<a href="#l26.494"></a><span id="l26.494" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.495"></a><span id="l26.495" class="difflineplus">+InMemoryAssertionEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l26.496"></a><span id="l26.496" class="difflineplus">+{</span>
<a href="#l26.497"></a><span id="l26.497" class="difflineplus">+    nsresult rv;</span>
<a href="#l26.498"></a><span id="l26.498" class="difflineplus">+</span>
<a href="#l26.499"></a><span id="l26.499" class="difflineplus">+    bool hasMore;</span>
<a href="#l26.500"></a><span id="l26.500" class="difflineplus">+    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l26.501"></a><span id="l26.501" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.502"></a><span id="l26.502" class="difflineplus">+</span>
<a href="#l26.503"></a><span id="l26.503" class="difflineplus">+    if (! hasMore)</span>
<a href="#l26.504"></a><span id="l26.504" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.505"></a><span id="l26.505" class="difflineplus">+</span>
<a href="#l26.506"></a><span id="l26.506" class="difflineplus">+    // Don't AddRef: we &quot;transfer&quot; ownership to the caller</span>
<a href="#l26.507"></a><span id="l26.507" class="difflineplus">+    *aResult = mValue;</span>
<a href="#l26.508"></a><span id="l26.508" class="difflineplus">+    mValue = nullptr;</span>
<a href="#l26.509"></a><span id="l26.509" class="difflineplus">+</span>
<a href="#l26.510"></a><span id="l26.510" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.511"></a><span id="l26.511" class="difflineplus">+}</span>
<a href="#l26.512"></a><span id="l26.512" class="difflineplus">+</span>
<a href="#l26.513"></a><span id="l26.513" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.514"></a><span id="l26.514" class="difflineplus">+//</span>
<a href="#l26.515"></a><span id="l26.515" class="difflineplus">+</span>
<a href="#l26.516"></a><span id="l26.516" class="difflineplus">+/**</span>
<a href="#l26.517"></a><span id="l26.517" class="difflineplus">+ * This class is a little bit bizarre in that it implements both the</span>
<a href="#l26.518"></a><span id="l26.518" class="difflineplus">+ * &lt;tt&gt;nsIRDFArcsOutCursor&lt;/tt&gt; and &lt;tt&gt;nsIRDFArcsInCursor&lt;/tt&gt; interfaces.</span>
<a href="#l26.519"></a><span id="l26.519" class="difflineplus">+ * Because the structure of the in-memory graph is pretty flexible, it's</span>
<a href="#l26.520"></a><span id="l26.520" class="difflineplus">+ * fairly easy to parameterize this class. The only funky thing to watch</span>
<a href="#l26.521"></a><span id="l26.521" class="difflineplus">+ * out for is the multiple inheritance clashes.</span>
<a href="#l26.522"></a><span id="l26.522" class="difflineplus">+ */</span>
<a href="#l26.523"></a><span id="l26.523" class="difflineplus">+</span>
<a href="#l26.524"></a><span id="l26.524" class="difflineplus">+class InMemoryArcsEnumeratorImpl : public nsISimpleEnumerator</span>
<a href="#l26.525"></a><span id="l26.525" class="difflineplus">+{</span>
<a href="#l26.526"></a><span id="l26.526" class="difflineplus">+private:</span>
<a href="#l26.527"></a><span id="l26.527" class="difflineplus">+    InMemoryDataSource* mDataSource;</span>
<a href="#l26.528"></a><span id="l26.528" class="difflineplus">+    nsIRDFResource*     mSource;</span>
<a href="#l26.529"></a><span id="l26.529" class="difflineplus">+    nsIRDFNode*         mTarget;</span>
<a href="#l26.530"></a><span id="l26.530" class="difflineplus">+    AutoTArray&lt;nsCOMPtr&lt;nsIRDFResource&gt;, 8&gt; mAlreadyReturned;</span>
<a href="#l26.531"></a><span id="l26.531" class="difflineplus">+    nsIRDFResource*     mCurrent;</span>
<a href="#l26.532"></a><span id="l26.532" class="difflineplus">+    Assertion*          mAssertion;</span>
<a href="#l26.533"></a><span id="l26.533" class="difflineplus">+    nsCOMArray&lt;nsIRDFNode&gt;* mHashArcs;</span>
<a href="#l26.534"></a><span id="l26.534" class="difflineplus">+</span>
<a href="#l26.535"></a><span id="l26.535" class="difflineplus">+    virtual ~InMemoryArcsEnumeratorImpl();</span>
<a href="#l26.536"></a><span id="l26.536" class="difflineplus">+</span>
<a href="#l26.537"></a><span id="l26.537" class="difflineplus">+public:</span>
<a href="#l26.538"></a><span id="l26.538" class="difflineplus">+    InMemoryArcsEnumeratorImpl(InMemoryDataSource* aDataSource,</span>
<a href="#l26.539"></a><span id="l26.539" class="difflineplus">+                               nsIRDFResource* aSource,</span>
<a href="#l26.540"></a><span id="l26.540" class="difflineplus">+                               nsIRDFNode* aTarget);</span>
<a href="#l26.541"></a><span id="l26.541" class="difflineplus">+</span>
<a href="#l26.542"></a><span id="l26.542" class="difflineplus">+    // nsISupports interface</span>
<a href="#l26.543"></a><span id="l26.543" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l26.544"></a><span id="l26.544" class="difflineplus">+</span>
<a href="#l26.545"></a><span id="l26.545" class="difflineplus">+    // nsISimpleEnumerator interface</span>
<a href="#l26.546"></a><span id="l26.546" class="difflineplus">+    NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l26.547"></a><span id="l26.547" class="difflineplus">+};</span>
<a href="#l26.548"></a><span id="l26.548" class="difflineplus">+</span>
<a href="#l26.549"></a><span id="l26.549" class="difflineplus">+</span>
<a href="#l26.550"></a><span id="l26.550" class="difflineplus">+InMemoryArcsEnumeratorImpl::InMemoryArcsEnumeratorImpl(InMemoryDataSource* aDataSource,</span>
<a href="#l26.551"></a><span id="l26.551" class="difflineplus">+                                                       nsIRDFResource* aSource,</span>
<a href="#l26.552"></a><span id="l26.552" class="difflineplus">+                                                       nsIRDFNode* aTarget)</span>
<a href="#l26.553"></a><span id="l26.553" class="difflineplus">+    : mDataSource(aDataSource),</span>
<a href="#l26.554"></a><span id="l26.554" class="difflineplus">+      mSource(aSource),</span>
<a href="#l26.555"></a><span id="l26.555" class="difflineplus">+      mTarget(aTarget),</span>
<a href="#l26.556"></a><span id="l26.556" class="difflineplus">+      mCurrent(nullptr),</span>
<a href="#l26.557"></a><span id="l26.557" class="difflineplus">+      mHashArcs(nullptr)</span>
<a href="#l26.558"></a><span id="l26.558" class="difflineplus">+{</span>
<a href="#l26.559"></a><span id="l26.559" class="difflineplus">+    NS_ADDREF(mDataSource);</span>
<a href="#l26.560"></a><span id="l26.560" class="difflineplus">+    NS_IF_ADDREF(mSource);</span>
<a href="#l26.561"></a><span id="l26.561" class="difflineplus">+    NS_IF_ADDREF(mTarget);</span>
<a href="#l26.562"></a><span id="l26.562" class="difflineplus">+</span>
<a href="#l26.563"></a><span id="l26.563" class="difflineplus">+    if (mSource) {</span>
<a href="#l26.564"></a><span id="l26.564" class="difflineplus">+        // cast okay because it's a closed system</span>
<a href="#l26.565"></a><span id="l26.565" class="difflineplus">+        mAssertion = mDataSource-&gt;GetForwardArcs(mSource);</span>
<a href="#l26.566"></a><span id="l26.566" class="difflineplus">+</span>
<a href="#l26.567"></a><span id="l26.567" class="difflineplus">+        if (mAssertion &amp;&amp; mAssertion-&gt;mHashEntry) {</span>
<a href="#l26.568"></a><span id="l26.568" class="difflineplus">+            // its our magical HASH_ENTRY forward hash for assertions</span>
<a href="#l26.569"></a><span id="l26.569" class="difflineplus">+            mHashArcs = new nsCOMArray&lt;nsIRDFNode&gt;();</span>
<a href="#l26.570"></a><span id="l26.570" class="difflineplus">+            for (auto i = mAssertion-&gt;u.hash.mPropertyHash-&gt;Iter();</span>
<a href="#l26.571"></a><span id="l26.571" class="difflineplus">+                 !i.Done();</span>
<a href="#l26.572"></a><span id="l26.572" class="difflineplus">+                 i.Next()) {</span>
<a href="#l26.573"></a><span id="l26.573" class="difflineplus">+                auto entry = static_cast&lt;Entry*&gt;(i.Get());</span>
<a href="#l26.574"></a><span id="l26.574" class="difflineplus">+                mHashArcs-&gt;AppendElement(entry-&gt;mNode);</span>
<a href="#l26.575"></a><span id="l26.575" class="difflineplus">+            }</span>
<a href="#l26.576"></a><span id="l26.576" class="difflineplus">+            mAssertion = nullptr;</span>
<a href="#l26.577"></a><span id="l26.577" class="difflineplus">+        }</span>
<a href="#l26.578"></a><span id="l26.578" class="difflineplus">+    }</span>
<a href="#l26.579"></a><span id="l26.579" class="difflineplus">+    else {</span>
<a href="#l26.580"></a><span id="l26.580" class="difflineplus">+        mAssertion = mDataSource-&gt;GetReverseArcs(mTarget);</span>
<a href="#l26.581"></a><span id="l26.581" class="difflineplus">+    }</span>
<a href="#l26.582"></a><span id="l26.582" class="difflineplus">+}</span>
<a href="#l26.583"></a><span id="l26.583" class="difflineplus">+</span>
<a href="#l26.584"></a><span id="l26.584" class="difflineplus">+InMemoryArcsEnumeratorImpl::~InMemoryArcsEnumeratorImpl()</span>
<a href="#l26.585"></a><span id="l26.585" class="difflineplus">+{</span>
<a href="#l26.586"></a><span id="l26.586" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l26.587"></a><span id="l26.587" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l26.588"></a><span id="l26.588" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: InMemoryArcsEnumeratorImpl\n&quot;, gInstanceCount);</span>
<a href="#l26.589"></a><span id="l26.589" class="difflineplus">+#endif</span>
<a href="#l26.590"></a><span id="l26.590" class="difflineplus">+</span>
<a href="#l26.591"></a><span id="l26.591" class="difflineplus">+    NS_RELEASE(mDataSource);</span>
<a href="#l26.592"></a><span id="l26.592" class="difflineplus">+    NS_IF_RELEASE(mSource);</span>
<a href="#l26.593"></a><span id="l26.593" class="difflineplus">+    NS_IF_RELEASE(mTarget);</span>
<a href="#l26.594"></a><span id="l26.594" class="difflineplus">+    NS_IF_RELEASE(mCurrent);</span>
<a href="#l26.595"></a><span id="l26.595" class="difflineplus">+    delete mHashArcs;</span>
<a href="#l26.596"></a><span id="l26.596" class="difflineplus">+}</span>
<a href="#l26.597"></a><span id="l26.597" class="difflineplus">+</span>
<a href="#l26.598"></a><span id="l26.598" class="difflineplus">+NS_IMPL_ADDREF(InMemoryArcsEnumeratorImpl)</span>
<a href="#l26.599"></a><span id="l26.599" class="difflineplus">+NS_IMPL_RELEASE(InMemoryArcsEnumeratorImpl)</span>
<a href="#l26.600"></a><span id="l26.600" class="difflineplus">+NS_IMPL_QUERY_INTERFACE(InMemoryArcsEnumeratorImpl, nsISimpleEnumerator)</span>
<a href="#l26.601"></a><span id="l26.601" class="difflineplus">+</span>
<a href="#l26.602"></a><span id="l26.602" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.603"></a><span id="l26.603" class="difflineplus">+InMemoryArcsEnumeratorImpl::HasMoreElements(bool* aResult)</span>
<a href="#l26.604"></a><span id="l26.604" class="difflineplus">+{</span>
<a href="#l26.605"></a><span id="l26.605" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.606"></a><span id="l26.606" class="difflineplus">+    if (! aResult)</span>
<a href="#l26.607"></a><span id="l26.607" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.608"></a><span id="l26.608" class="difflineplus">+</span>
<a href="#l26.609"></a><span id="l26.609" class="difflineplus">+    if (mCurrent) {</span>
<a href="#l26.610"></a><span id="l26.610" class="difflineplus">+        *aResult = true;</span>
<a href="#l26.611"></a><span id="l26.611" class="difflineplus">+        return NS_OK;</span>
<a href="#l26.612"></a><span id="l26.612" class="difflineplus">+    }</span>
<a href="#l26.613"></a><span id="l26.613" class="difflineplus">+</span>
<a href="#l26.614"></a><span id="l26.614" class="difflineplus">+    if (mHashArcs) {</span>
<a href="#l26.615"></a><span id="l26.615" class="difflineplus">+        if (!mHashArcs-&gt;IsEmpty()) {</span>
<a href="#l26.616"></a><span id="l26.616" class="difflineplus">+            const uint32_t last = mHashArcs-&gt;Length() - 1;</span>
<a href="#l26.617"></a><span id="l26.617" class="difflineplus">+            nsCOMPtr&lt;nsIRDFResource&gt; tmp(do_QueryInterface(mHashArcs-&gt;ObjectAt(last)));</span>
<a href="#l26.618"></a><span id="l26.618" class="difflineplus">+            tmp.forget(&amp;mCurrent);</span>
<a href="#l26.619"></a><span id="l26.619" class="difflineplus">+            mHashArcs-&gt;RemoveElementAt(last);</span>
<a href="#l26.620"></a><span id="l26.620" class="difflineplus">+            *aResult = true;</span>
<a href="#l26.621"></a><span id="l26.621" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.622"></a><span id="l26.622" class="difflineplus">+        }</span>
<a href="#l26.623"></a><span id="l26.623" class="difflineplus">+    }</span>
<a href="#l26.624"></a><span id="l26.624" class="difflineplus">+    else</span>
<a href="#l26.625"></a><span id="l26.625" class="difflineplus">+        while (mAssertion) {</span>
<a href="#l26.626"></a><span id="l26.626" class="difflineplus">+            nsIRDFResource* next = mAssertion-&gt;u.as.mProperty;</span>
<a href="#l26.627"></a><span id="l26.627" class="difflineplus">+</span>
<a href="#l26.628"></a><span id="l26.628" class="difflineplus">+            // &quot;next&quot; is the property arc we are tentatively going to return</span>
<a href="#l26.629"></a><span id="l26.629" class="difflineplus">+            // in a subsequent GetNext() call.  It is important to do two</span>
<a href="#l26.630"></a><span id="l26.630" class="difflineplus">+            // things, however, before that can happen:</span>
<a href="#l26.631"></a><span id="l26.631" class="difflineplus">+            //   1) Make sure it's not an arc we've already returned.</span>
<a href="#l26.632"></a><span id="l26.632" class="difflineplus">+            //   2) Make sure that |mAssertion| is not left pointing to</span>
<a href="#l26.633"></a><span id="l26.633" class="difflineplus">+            //      another assertion that has the same property as this one.</span>
<a href="#l26.634"></a><span id="l26.634" class="difflineplus">+            // The first is a practical concern; the second a defense against</span>
<a href="#l26.635"></a><span id="l26.635" class="difflineplus">+            // an obscure crash and other erratic behavior.  To ensure the</span>
<a href="#l26.636"></a><span id="l26.636" class="difflineplus">+            // second condition, skip down the chain until we find the next</span>
<a href="#l26.637"></a><span id="l26.637" class="difflineplus">+            // assertion with a property that doesn't match the current one.</span>
<a href="#l26.638"></a><span id="l26.638" class="difflineplus">+            // (All these assertions would be skipped via mAlreadyReturned</span>
<a href="#l26.639"></a><span id="l26.639" class="difflineplus">+            // checks anyways; this is even a bit faster.)</span>
<a href="#l26.640"></a><span id="l26.640" class="difflineplus">+</span>
<a href="#l26.641"></a><span id="l26.641" class="difflineplus">+            do {</span>
<a href="#l26.642"></a><span id="l26.642" class="difflineplus">+                mAssertion = (mSource ? mAssertion-&gt;mNext :</span>
<a href="#l26.643"></a><span id="l26.643" class="difflineplus">+                        mAssertion-&gt;u.as.mInvNext);</span>
<a href="#l26.644"></a><span id="l26.644" class="difflineplus">+            }</span>
<a href="#l26.645"></a><span id="l26.645" class="difflineplus">+            while (mAssertion &amp;&amp; (next == mAssertion-&gt;u.as.mProperty));</span>
<a href="#l26.646"></a><span id="l26.646" class="difflineplus">+</span>
<a href="#l26.647"></a><span id="l26.647" class="difflineplus">+            bool alreadyReturned = false;</span>
<a href="#l26.648"></a><span id="l26.648" class="difflineplus">+            for (int32_t i = mAlreadyReturned.Length() - 1; i &gt;= 0; --i) {</span>
<a href="#l26.649"></a><span id="l26.649" class="difflineplus">+                if (mAlreadyReturned[i] == next) {</span>
<a href="#l26.650"></a><span id="l26.650" class="difflineplus">+                    alreadyReturned = true;</span>
<a href="#l26.651"></a><span id="l26.651" class="difflineplus">+                    break;</span>
<a href="#l26.652"></a><span id="l26.652" class="difflineplus">+                }</span>
<a href="#l26.653"></a><span id="l26.653" class="difflineplus">+            }</span>
<a href="#l26.654"></a><span id="l26.654" class="difflineplus">+</span>
<a href="#l26.655"></a><span id="l26.655" class="difflineplus">+            if (! alreadyReturned) {</span>
<a href="#l26.656"></a><span id="l26.656" class="difflineplus">+                mCurrent = next;</span>
<a href="#l26.657"></a><span id="l26.657" class="difflineplus">+                NS_ADDREF(mCurrent);</span>
<a href="#l26.658"></a><span id="l26.658" class="difflineplus">+                *aResult = true;</span>
<a href="#l26.659"></a><span id="l26.659" class="difflineplus">+                return NS_OK;</span>
<a href="#l26.660"></a><span id="l26.660" class="difflineplus">+            }</span>
<a href="#l26.661"></a><span id="l26.661" class="difflineplus">+        }</span>
<a href="#l26.662"></a><span id="l26.662" class="difflineplus">+</span>
<a href="#l26.663"></a><span id="l26.663" class="difflineplus">+    *aResult = false;</span>
<a href="#l26.664"></a><span id="l26.664" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.665"></a><span id="l26.665" class="difflineplus">+}</span>
<a href="#l26.666"></a><span id="l26.666" class="difflineplus">+</span>
<a href="#l26.667"></a><span id="l26.667" class="difflineplus">+</span>
<a href="#l26.668"></a><span id="l26.668" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.669"></a><span id="l26.669" class="difflineplus">+InMemoryArcsEnumeratorImpl::GetNext(nsISupports** aResult)</span>
<a href="#l26.670"></a><span id="l26.670" class="difflineplus">+{</span>
<a href="#l26.671"></a><span id="l26.671" class="difflineplus">+    nsresult rv;</span>
<a href="#l26.672"></a><span id="l26.672" class="difflineplus">+</span>
<a href="#l26.673"></a><span id="l26.673" class="difflineplus">+    bool hasMore;</span>
<a href="#l26.674"></a><span id="l26.674" class="difflineplus">+    rv = HasMoreElements(&amp;hasMore);</span>
<a href="#l26.675"></a><span id="l26.675" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.676"></a><span id="l26.676" class="difflineplus">+</span>
<a href="#l26.677"></a><span id="l26.677" class="difflineplus">+    if (! hasMore)</span>
<a href="#l26.678"></a><span id="l26.678" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l26.679"></a><span id="l26.679" class="difflineplus">+</span>
<a href="#l26.680"></a><span id="l26.680" class="difflineplus">+    // Add this to the set of things we've already returned so that we</span>
<a href="#l26.681"></a><span id="l26.681" class="difflineplus">+    // can ensure uniqueness</span>
<a href="#l26.682"></a><span id="l26.682" class="difflineplus">+    mAlreadyReturned.AppendElement(mCurrent);</span>
<a href="#l26.683"></a><span id="l26.683" class="difflineplus">+</span>
<a href="#l26.684"></a><span id="l26.684" class="difflineplus">+    // Don't AddRef: we &quot;transfer&quot; ownership to the caller</span>
<a href="#l26.685"></a><span id="l26.685" class="difflineplus">+    *aResult = mCurrent;</span>
<a href="#l26.686"></a><span id="l26.686" class="difflineplus">+    mCurrent = nullptr;</span>
<a href="#l26.687"></a><span id="l26.687" class="difflineplus">+</span>
<a href="#l26.688"></a><span id="l26.688" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.689"></a><span id="l26.689" class="difflineplus">+}</span>
<a href="#l26.690"></a><span id="l26.690" class="difflineplus">+</span>
<a href="#l26.691"></a><span id="l26.691" class="difflineplus">+</span>
<a href="#l26.692"></a><span id="l26.692" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.693"></a><span id="l26.693" class="difflineplus">+// InMemoryDataSource</span>
<a href="#l26.694"></a><span id="l26.694" class="difflineplus">+</span>
<a href="#l26.695"></a><span id="l26.695" class="difflineplus">+nsresult</span>
<a href="#l26.696"></a><span id="l26.696" class="difflineplus">+NS_NewRDFInMemoryDataSource(nsISupports* aOuter, const nsIID&amp; aIID, void** aResult)</span>
<a href="#l26.697"></a><span id="l26.697" class="difflineplus">+{</span>
<a href="#l26.698"></a><span id="l26.698" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.699"></a><span id="l26.699" class="difflineplus">+    if (! aResult)</span>
<a href="#l26.700"></a><span id="l26.700" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.701"></a><span id="l26.701" class="difflineplus">+    *aResult = nullptr;</span>
<a href="#l26.702"></a><span id="l26.702" class="difflineplus">+</span>
<a href="#l26.703"></a><span id="l26.703" class="difflineplus">+    if (aOuter &amp;&amp; !aIID.Equals(NS_GET_IID(nsISupports))) {</span>
<a href="#l26.704"></a><span id="l26.704" class="difflineplus">+        NS_ERROR(&quot;aggregation requires nsISupports&quot;);</span>
<a href="#l26.705"></a><span id="l26.705" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l26.706"></a><span id="l26.706" class="difflineplus">+    }</span>
<a href="#l26.707"></a><span id="l26.707" class="difflineplus">+</span>
<a href="#l26.708"></a><span id="l26.708" class="difflineplus">+    InMemoryDataSource* datasource = new InMemoryDataSource(aOuter);</span>
<a href="#l26.709"></a><span id="l26.709" class="difflineplus">+    NS_ADDREF(datasource);</span>
<a href="#l26.710"></a><span id="l26.710" class="difflineplus">+</span>
<a href="#l26.711"></a><span id="l26.711" class="difflineplus">+    datasource-&gt;fAggregated.AddRef();</span>
<a href="#l26.712"></a><span id="l26.712" class="difflineplus">+    nsresult rv = datasource-&gt;AggregatedQueryInterface(aIID, aResult); // This'll AddRef()</span>
<a href="#l26.713"></a><span id="l26.713" class="difflineplus">+    datasource-&gt;fAggregated.Release();</span>
<a href="#l26.714"></a><span id="l26.714" class="difflineplus">+</span>
<a href="#l26.715"></a><span id="l26.715" class="difflineplus">+    NS_RELEASE(datasource);</span>
<a href="#l26.716"></a><span id="l26.716" class="difflineplus">+    return rv;</span>
<a href="#l26.717"></a><span id="l26.717" class="difflineplus">+}</span>
<a href="#l26.718"></a><span id="l26.718" class="difflineplus">+</span>
<a href="#l26.719"></a><span id="l26.719" class="difflineplus">+</span>
<a href="#l26.720"></a><span id="l26.720" class="difflineplus">+InMemoryDataSource::InMemoryDataSource(nsISupports* aOuter)</span>
<a href="#l26.721"></a><span id="l26.721" class="difflineplus">+    : mForwardArcs(PLDHashTable::StubOps(), sizeof(Entry))</span>
<a href="#l26.722"></a><span id="l26.722" class="difflineplus">+    , mReverseArcs(PLDHashTable::StubOps(), sizeof(Entry))</span>
<a href="#l26.723"></a><span id="l26.723" class="difflineplus">+    , mNumObservers(0)</span>
<a href="#l26.724"></a><span id="l26.724" class="difflineplus">+    , mReadCount(0)</span>
<a href="#l26.725"></a><span id="l26.725" class="difflineplus">+{</span>
<a href="#l26.726"></a><span id="l26.726" class="difflineplus">+    NS_INIT_AGGREGATED(aOuter);</span>
<a href="#l26.727"></a><span id="l26.727" class="difflineplus">+</span>
<a href="#l26.728"></a><span id="l26.728" class="difflineplus">+    mPropagateChanges = true;</span>
<a href="#l26.729"></a><span id="l26.729" class="difflineplus">+}</span>
<a href="#l26.730"></a><span id="l26.730" class="difflineplus">+</span>
<a href="#l26.731"></a><span id="l26.731" class="difflineplus">+</span>
<a href="#l26.732"></a><span id="l26.732" class="difflineplus">+InMemoryDataSource::~InMemoryDataSource()</span>
<a href="#l26.733"></a><span id="l26.733" class="difflineplus">+{</span>
<a href="#l26.734"></a><span id="l26.734" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l26.735"></a><span id="l26.735" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l26.736"></a><span id="l26.736" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: InMemoryDataSource\n&quot;, gInstanceCount);</span>
<a href="#l26.737"></a><span id="l26.737" class="difflineplus">+#endif</span>
<a href="#l26.738"></a><span id="l26.738" class="difflineplus">+</span>
<a href="#l26.739"></a><span id="l26.739" class="difflineplus">+    if (mForwardArcs.EntryCount() &gt; 0) {</span>
<a href="#l26.740"></a><span id="l26.740" class="difflineplus">+        // This'll release all of the Assertion objects that are</span>
<a href="#l26.741"></a><span id="l26.741" class="difflineplus">+        // associated with this data source. We only need to do this</span>
<a href="#l26.742"></a><span id="l26.742" class="difflineplus">+        // for the forward arcs, because the reverse arcs table</span>
<a href="#l26.743"></a><span id="l26.743" class="difflineplus">+        // indexes the exact same set of resources.</span>
<a href="#l26.744"></a><span id="l26.744" class="difflineplus">+        for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l26.745"></a><span id="l26.745" class="difflineplus">+            auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l26.746"></a><span id="l26.746" class="difflineplus">+            Assertion* as = entry-&gt;mAssertions;</span>
<a href="#l26.747"></a><span id="l26.747" class="difflineplus">+            while (as) {</span>
<a href="#l26.748"></a><span id="l26.748" class="difflineplus">+                Assertion* doomed = as;</span>
<a href="#l26.749"></a><span id="l26.749" class="difflineplus">+                as = as-&gt;mNext;</span>
<a href="#l26.750"></a><span id="l26.750" class="difflineplus">+</span>
<a href="#l26.751"></a><span id="l26.751" class="difflineplus">+                // Unlink, and release the datasource's reference.</span>
<a href="#l26.752"></a><span id="l26.752" class="difflineplus">+                doomed-&gt;mNext = doomed-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l26.753"></a><span id="l26.753" class="difflineplus">+                doomed-&gt;Release();</span>
<a href="#l26.754"></a><span id="l26.754" class="difflineplus">+            }</span>
<a href="#l26.755"></a><span id="l26.755" class="difflineplus">+        }</span>
<a href="#l26.756"></a><span id="l26.756" class="difflineplus">+    }</span>
<a href="#l26.757"></a><span id="l26.757" class="difflineplus">+</span>
<a href="#l26.758"></a><span id="l26.758" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.759"></a><span id="l26.759" class="difflineplus">+           (&quot;InMemoryDataSource(%p): destroyed.&quot;, this));</span>
<a href="#l26.760"></a><span id="l26.760" class="difflineplus">+}</span>
<a href="#l26.761"></a><span id="l26.761" class="difflineplus">+</span>
<a href="#l26.762"></a><span id="l26.762" class="difflineplus">+</span>
<a href="#l26.763"></a><span id="l26.763" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.764"></a><span id="l26.764" class="difflineplus">+</span>
<a href="#l26.765"></a><span id="l26.765" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_CLASS(InMemoryDataSource)</span>
<a href="#l26.766"></a><span id="l26.766" class="difflineplus">+</span>
<a href="#l26.767"></a><span id="l26.767" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN(InMemoryDataSource)</span>
<a href="#l26.768"></a><span id="l26.768" class="difflineplus">+    NS_IMPL_CYCLE_COLLECTION_UNLINK(mObservers)</span>
<a href="#l26.769"></a><span id="l26.769" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_UNLINK_END</span>
<a href="#l26.770"></a><span id="l26.770" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN_AGGREGATED(InMemoryDataSource)</span>
<a href="#l26.771"></a><span id="l26.771" class="difflineplus">+    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mObservers)</span>
<a href="#l26.772"></a><span id="l26.772" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l26.773"></a><span id="l26.773" class="difflineplus">+</span>
<a href="#l26.774"></a><span id="l26.774" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_AGGREGATED(InMemoryDataSource)</span>
<a href="#l26.775"></a><span id="l26.775" class="difflineplus">+NS_INTERFACE_MAP_BEGIN_AGGREGATED(InMemoryDataSource)</span>
<a href="#l26.776"></a><span id="l26.776" class="difflineplus">+    NS_INTERFACE_MAP_ENTRIES_CYCLE_COLLECTION_AGGREGATED(InMemoryDataSource)</span>
<a href="#l26.777"></a><span id="l26.777" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l26.778"></a><span id="l26.778" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFInMemoryDataSource)</span>
<a href="#l26.779"></a><span id="l26.779" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFPropagatableDataSource)</span>
<a href="#l26.780"></a><span id="l26.780" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFPurgeableDataSource)</span>
<a href="#l26.781"></a><span id="l26.781" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(rdfIDataSource)</span>
<a href="#l26.782"></a><span id="l26.782" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l26.783"></a><span id="l26.783" class="difflineplus">+</span>
<a href="#l26.784"></a><span id="l26.784" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.785"></a><span id="l26.785" class="difflineplus">+</span>
<a href="#l26.786"></a><span id="l26.786" class="difflineplus">+</span>
<a href="#l26.787"></a><span id="l26.787" class="difflineplus">+void</span>
<a href="#l26.788"></a><span id="l26.788" class="difflineplus">+InMemoryDataSource::LogOperation(const char* aOperation,</span>
<a href="#l26.789"></a><span id="l26.789" class="difflineplus">+                                 nsIRDFResource* aSource,</span>
<a href="#l26.790"></a><span id="l26.790" class="difflineplus">+                                 nsIRDFResource* aProperty,</span>
<a href="#l26.791"></a><span id="l26.791" class="difflineplus">+                                 nsIRDFNode* aTarget,</span>
<a href="#l26.792"></a><span id="l26.792" class="difflineplus">+                                 bool aTruthValue)</span>
<a href="#l26.793"></a><span id="l26.793" class="difflineplus">+{</span>
<a href="#l26.794"></a><span id="l26.794" class="difflineplus">+    if (! MOZ_LOG_TEST(gLog, LogLevel::Debug))</span>
<a href="#l26.795"></a><span id="l26.795" class="difflineplus">+        return;</span>
<a href="#l26.796"></a><span id="l26.796" class="difflineplus">+</span>
<a href="#l26.797"></a><span id="l26.797" class="difflineplus">+    nsCString uri;</span>
<a href="#l26.798"></a><span id="l26.798" class="difflineplus">+    aSource-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l26.799"></a><span id="l26.799" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.800"></a><span id="l26.800" class="difflineplus">+           (&quot;InMemoryDataSource(%p): %s&quot;, this, aOperation));</span>
<a href="#l26.801"></a><span id="l26.801" class="difflineplus">+</span>
<a href="#l26.802"></a><span id="l26.802" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.803"></a><span id="l26.803" class="difflineplus">+           (&quot;  [(%p)%s]--&quot;, aSource, uri.get()));</span>
<a href="#l26.804"></a><span id="l26.804" class="difflineplus">+</span>
<a href="#l26.805"></a><span id="l26.805" class="difflineplus">+    aProperty-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l26.806"></a><span id="l26.806" class="difflineplus">+</span>
<a href="#l26.807"></a><span id="l26.807" class="difflineplus">+    char tv = (aTruthValue ? '-' : '!');</span>
<a href="#l26.808"></a><span id="l26.808" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.809"></a><span id="l26.809" class="difflineplus">+           (&quot;  --%c[(%p)%s]--&quot;, tv, aProperty, uri.get()));</span>
<a href="#l26.810"></a><span id="l26.810" class="difflineplus">+</span>
<a href="#l26.811"></a><span id="l26.811" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l26.812"></a><span id="l26.812" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l26.813"></a><span id="l26.813" class="difflineplus">+</span>
<a href="#l26.814"></a><span id="l26.814" class="difflineplus">+    if ((resource = do_QueryInterface(aTarget)) != nullptr) {</span>
<a href="#l26.815"></a><span id="l26.815" class="difflineplus">+        resource-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l26.816"></a><span id="l26.816" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.817"></a><span id="l26.817" class="difflineplus">+           (&quot;  --&gt;[(%p)%s]&quot;, aTarget, uri.get()));</span>
<a href="#l26.818"></a><span id="l26.818" class="difflineplus">+    }</span>
<a href="#l26.819"></a><span id="l26.819" class="difflineplus">+    else if ((literal = do_QueryInterface(aTarget)) != nullptr) {</span>
<a href="#l26.820"></a><span id="l26.820" class="difflineplus">+        nsString value;</span>
<a href="#l26.821"></a><span id="l26.821" class="difflineplus">+        literal-&gt;GetValue(getter_Copies(value));</span>
<a href="#l26.822"></a><span id="l26.822" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.823"></a><span id="l26.823" class="difflineplus">+           (&quot;  --&gt;(\&quot;%s\&quot;)\n&quot;, NS_ConvertUTF16toUTF8(value).get()));</span>
<a href="#l26.824"></a><span id="l26.824" class="difflineplus">+    }</span>
<a href="#l26.825"></a><span id="l26.825" class="difflineplus">+    else {</span>
<a href="#l26.826"></a><span id="l26.826" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l26.827"></a><span id="l26.827" class="difflineplus">+           (&quot;  --&gt;(unknown-type)\n&quot;));</span>
<a href="#l26.828"></a><span id="l26.828" class="difflineplus">+    }</span>
<a href="#l26.829"></a><span id="l26.829" class="difflineplus">+}</span>
<a href="#l26.830"></a><span id="l26.830" class="difflineplus">+</span>
<a href="#l26.831"></a><span id="l26.831" class="difflineplus">+</span>
<a href="#l26.832"></a><span id="l26.832" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.833"></a><span id="l26.833" class="difflineplus">+InMemoryDataSource::GetURI(nsACString&amp; aURI)</span>
<a href="#l26.834"></a><span id="l26.834" class="difflineplus">+{</span>
<a href="#l26.835"></a><span id="l26.835" class="difflineplus">+    aURI.SetIsVoid(true);</span>
<a href="#l26.836"></a><span id="l26.836" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.837"></a><span id="l26.837" class="difflineplus">+}</span>
<a href="#l26.838"></a><span id="l26.838" class="difflineplus">+</span>
<a href="#l26.839"></a><span id="l26.839" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.840"></a><span id="l26.840" class="difflineplus">+InMemoryDataSource::GetSource(nsIRDFResource* property,</span>
<a href="#l26.841"></a><span id="l26.841" class="difflineplus">+                              nsIRDFNode* target,</span>
<a href="#l26.842"></a><span id="l26.842" class="difflineplus">+                              bool tv,</span>
<a href="#l26.843"></a><span id="l26.843" class="difflineplus">+                              nsIRDFResource** source)</span>
<a href="#l26.844"></a><span id="l26.844" class="difflineplus">+{</span>
<a href="#l26.845"></a><span id="l26.845" class="difflineplus">+    NS_PRECONDITION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.846"></a><span id="l26.846" class="difflineplus">+    if (! source)</span>
<a href="#l26.847"></a><span id="l26.847" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.848"></a><span id="l26.848" class="difflineplus">+</span>
<a href="#l26.849"></a><span id="l26.849" class="difflineplus">+    NS_PRECONDITION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.850"></a><span id="l26.850" class="difflineplus">+    if (! property)</span>
<a href="#l26.851"></a><span id="l26.851" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.852"></a><span id="l26.852" class="difflineplus">+</span>
<a href="#l26.853"></a><span id="l26.853" class="difflineplus">+    NS_PRECONDITION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.854"></a><span id="l26.854" class="difflineplus">+    if (! target)</span>
<a href="#l26.855"></a><span id="l26.855" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.856"></a><span id="l26.856" class="difflineplus">+</span>
<a href="#l26.857"></a><span id="l26.857" class="difflineplus">+    for (Assertion* as = GetReverseArcs(target); as; as = as-&gt;u.as.mInvNext) {</span>
<a href="#l26.858"></a><span id="l26.858" class="difflineplus">+        if ((property == as-&gt;u.as.mProperty) &amp;&amp; (tv == as-&gt;u.as.mTruthValue)) {</span>
<a href="#l26.859"></a><span id="l26.859" class="difflineplus">+            *source = as-&gt;mSource;</span>
<a href="#l26.860"></a><span id="l26.860" class="difflineplus">+            NS_ADDREF(*source);</span>
<a href="#l26.861"></a><span id="l26.861" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.862"></a><span id="l26.862" class="difflineplus">+        }</span>
<a href="#l26.863"></a><span id="l26.863" class="difflineplus">+    }</span>
<a href="#l26.864"></a><span id="l26.864" class="difflineplus">+    *source = nullptr;</span>
<a href="#l26.865"></a><span id="l26.865" class="difflineplus">+    return NS_RDF_NO_VALUE;</span>
<a href="#l26.866"></a><span id="l26.866" class="difflineplus">+}</span>
<a href="#l26.867"></a><span id="l26.867" class="difflineplus">+</span>
<a href="#l26.868"></a><span id="l26.868" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.869"></a><span id="l26.869" class="difflineplus">+InMemoryDataSource::GetTarget(nsIRDFResource* source,</span>
<a href="#l26.870"></a><span id="l26.870" class="difflineplus">+                              nsIRDFResource* property,</span>
<a href="#l26.871"></a><span id="l26.871" class="difflineplus">+                              bool tv,</span>
<a href="#l26.872"></a><span id="l26.872" class="difflineplus">+                              nsIRDFNode** target)</span>
<a href="#l26.873"></a><span id="l26.873" class="difflineplus">+{</span>
<a href="#l26.874"></a><span id="l26.874" class="difflineplus">+    NS_PRECONDITION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.875"></a><span id="l26.875" class="difflineplus">+    if (! source)</span>
<a href="#l26.876"></a><span id="l26.876" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.877"></a><span id="l26.877" class="difflineplus">+</span>
<a href="#l26.878"></a><span id="l26.878" class="difflineplus">+    NS_PRECONDITION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.879"></a><span id="l26.879" class="difflineplus">+    if (! property)</span>
<a href="#l26.880"></a><span id="l26.880" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.881"></a><span id="l26.881" class="difflineplus">+</span>
<a href="#l26.882"></a><span id="l26.882" class="difflineplus">+    NS_PRECONDITION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.883"></a><span id="l26.883" class="difflineplus">+    if (! target)</span>
<a href="#l26.884"></a><span id="l26.884" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.885"></a><span id="l26.885" class="difflineplus">+</span>
<a href="#l26.886"></a><span id="l26.886" class="difflineplus">+    Assertion *as = GetForwardArcs(source);</span>
<a href="#l26.887"></a><span id="l26.887" class="difflineplus">+    if (as &amp;&amp; as-&gt;mHashEntry) {</span>
<a href="#l26.888"></a><span id="l26.888" class="difflineplus">+        PLDHashEntryHdr* hdr = as-&gt;u.hash.mPropertyHash-&gt;Search(property);</span>
<a href="#l26.889"></a><span id="l26.889" class="difflineplus">+        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.890"></a><span id="l26.890" class="difflineplus">+        while (val) {</span>
<a href="#l26.891"></a><span id="l26.891" class="difflineplus">+            if (tv == val-&gt;u.as.mTruthValue) {</span>
<a href="#l26.892"></a><span id="l26.892" class="difflineplus">+                *target = val-&gt;u.as.mTarget;</span>
<a href="#l26.893"></a><span id="l26.893" class="difflineplus">+                NS_IF_ADDREF(*target);</span>
<a href="#l26.894"></a><span id="l26.894" class="difflineplus">+                return NS_OK;</span>
<a href="#l26.895"></a><span id="l26.895" class="difflineplus">+            }</span>
<a href="#l26.896"></a><span id="l26.896" class="difflineplus">+            val = val-&gt;mNext;</span>
<a href="#l26.897"></a><span id="l26.897" class="difflineplus">+        }</span>
<a href="#l26.898"></a><span id="l26.898" class="difflineplus">+    }</span>
<a href="#l26.899"></a><span id="l26.899" class="difflineplus">+    else</span>
<a href="#l26.900"></a><span id="l26.900" class="difflineplus">+    for (; as != nullptr; as = as-&gt;mNext) {</span>
<a href="#l26.901"></a><span id="l26.901" class="difflineplus">+        if ((property == as-&gt;u.as.mProperty) &amp;&amp; (tv == (as-&gt;u.as.mTruthValue))) {</span>
<a href="#l26.902"></a><span id="l26.902" class="difflineplus">+            *target = as-&gt;u.as.mTarget;</span>
<a href="#l26.903"></a><span id="l26.903" class="difflineplus">+            NS_ADDREF(*target);</span>
<a href="#l26.904"></a><span id="l26.904" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.905"></a><span id="l26.905" class="difflineplus">+        }</span>
<a href="#l26.906"></a><span id="l26.906" class="difflineplus">+    }</span>
<a href="#l26.907"></a><span id="l26.907" class="difflineplus">+</span>
<a href="#l26.908"></a><span id="l26.908" class="difflineplus">+    // If we get here, then there was no target with for the specified</span>
<a href="#l26.909"></a><span id="l26.909" class="difflineplus">+    // property &amp; truth value.</span>
<a href="#l26.910"></a><span id="l26.910" class="difflineplus">+    *target = nullptr;</span>
<a href="#l26.911"></a><span id="l26.911" class="difflineplus">+    return NS_RDF_NO_VALUE;</span>
<a href="#l26.912"></a><span id="l26.912" class="difflineplus">+}</span>
<a href="#l26.913"></a><span id="l26.913" class="difflineplus">+</span>
<a href="#l26.914"></a><span id="l26.914" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.915"></a><span id="l26.915" class="difflineplus">+InMemoryDataSource::HasAssertion(nsIRDFResource* source,</span>
<a href="#l26.916"></a><span id="l26.916" class="difflineplus">+                                 nsIRDFResource* property,</span>
<a href="#l26.917"></a><span id="l26.917" class="difflineplus">+                                 nsIRDFNode* target,</span>
<a href="#l26.918"></a><span id="l26.918" class="difflineplus">+                                 bool tv,</span>
<a href="#l26.919"></a><span id="l26.919" class="difflineplus">+                                 bool* hasAssertion)</span>
<a href="#l26.920"></a><span id="l26.920" class="difflineplus">+{</span>
<a href="#l26.921"></a><span id="l26.921" class="difflineplus">+    if (! source)</span>
<a href="#l26.922"></a><span id="l26.922" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.923"></a><span id="l26.923" class="difflineplus">+</span>
<a href="#l26.924"></a><span id="l26.924" class="difflineplus">+    if (! property)</span>
<a href="#l26.925"></a><span id="l26.925" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.926"></a><span id="l26.926" class="difflineplus">+</span>
<a href="#l26.927"></a><span id="l26.927" class="difflineplus">+    if (! target)</span>
<a href="#l26.928"></a><span id="l26.928" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.929"></a><span id="l26.929" class="difflineplus">+</span>
<a href="#l26.930"></a><span id="l26.930" class="difflineplus">+    Assertion *as = GetForwardArcs(source);</span>
<a href="#l26.931"></a><span id="l26.931" class="difflineplus">+    if (as &amp;&amp; as-&gt;mHashEntry) {</span>
<a href="#l26.932"></a><span id="l26.932" class="difflineplus">+        PLDHashEntryHdr* hdr = as-&gt;u.hash.mPropertyHash-&gt;Search(property);</span>
<a href="#l26.933"></a><span id="l26.933" class="difflineplus">+        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.934"></a><span id="l26.934" class="difflineplus">+        while (val) {</span>
<a href="#l26.935"></a><span id="l26.935" class="difflineplus">+            if ((val-&gt;u.as.mTarget == target) &amp;&amp; (tv == (val-&gt;u.as.mTruthValue))) {</span>
<a href="#l26.936"></a><span id="l26.936" class="difflineplus">+                *hasAssertion = true;</span>
<a href="#l26.937"></a><span id="l26.937" class="difflineplus">+                return NS_OK;</span>
<a href="#l26.938"></a><span id="l26.938" class="difflineplus">+            }</span>
<a href="#l26.939"></a><span id="l26.939" class="difflineplus">+            val = val-&gt;mNext;</span>
<a href="#l26.940"></a><span id="l26.940" class="difflineplus">+        }</span>
<a href="#l26.941"></a><span id="l26.941" class="difflineplus">+    }</span>
<a href="#l26.942"></a><span id="l26.942" class="difflineplus">+    else</span>
<a href="#l26.943"></a><span id="l26.943" class="difflineplus">+    for (; as != nullptr; as = as-&gt;mNext) {</span>
<a href="#l26.944"></a><span id="l26.944" class="difflineplus">+        // check target first as its most unique</span>
<a href="#l26.945"></a><span id="l26.945" class="difflineplus">+        if (target != as-&gt;u.as.mTarget)</span>
<a href="#l26.946"></a><span id="l26.946" class="difflineplus">+            continue;</span>
<a href="#l26.947"></a><span id="l26.947" class="difflineplus">+</span>
<a href="#l26.948"></a><span id="l26.948" class="difflineplus">+        if (property != as-&gt;u.as.mProperty)</span>
<a href="#l26.949"></a><span id="l26.949" class="difflineplus">+            continue;</span>
<a href="#l26.950"></a><span id="l26.950" class="difflineplus">+</span>
<a href="#l26.951"></a><span id="l26.951" class="difflineplus">+        if (tv != (as-&gt;u.as.mTruthValue))</span>
<a href="#l26.952"></a><span id="l26.952" class="difflineplus">+            continue;</span>
<a href="#l26.953"></a><span id="l26.953" class="difflineplus">+</span>
<a href="#l26.954"></a><span id="l26.954" class="difflineplus">+        // found it!</span>
<a href="#l26.955"></a><span id="l26.955" class="difflineplus">+        *hasAssertion = true;</span>
<a href="#l26.956"></a><span id="l26.956" class="difflineplus">+        return NS_OK;</span>
<a href="#l26.957"></a><span id="l26.957" class="difflineplus">+    }</span>
<a href="#l26.958"></a><span id="l26.958" class="difflineplus">+</span>
<a href="#l26.959"></a><span id="l26.959" class="difflineplus">+    // If we get here, we couldn't find the assertion</span>
<a href="#l26.960"></a><span id="l26.960" class="difflineplus">+    *hasAssertion = false;</span>
<a href="#l26.961"></a><span id="l26.961" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.962"></a><span id="l26.962" class="difflineplus">+}</span>
<a href="#l26.963"></a><span id="l26.963" class="difflineplus">+</span>
<a href="#l26.964"></a><span id="l26.964" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.965"></a><span id="l26.965" class="difflineplus">+InMemoryDataSource::GetSources(nsIRDFResource* aProperty,</span>
<a href="#l26.966"></a><span id="l26.966" class="difflineplus">+                               nsIRDFNode* aTarget,</span>
<a href="#l26.967"></a><span id="l26.967" class="difflineplus">+                               bool aTruthValue,</span>
<a href="#l26.968"></a><span id="l26.968" class="difflineplus">+                               nsISimpleEnumerator** aResult)</span>
<a href="#l26.969"></a><span id="l26.969" class="difflineplus">+{</span>
<a href="#l26.970"></a><span id="l26.970" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.971"></a><span id="l26.971" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.972"></a><span id="l26.972" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.973"></a><span id="l26.973" class="difflineplus">+</span>
<a href="#l26.974"></a><span id="l26.974" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.975"></a><span id="l26.975" class="difflineplus">+    if (! aTarget)</span>
<a href="#l26.976"></a><span id="l26.976" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.977"></a><span id="l26.977" class="difflineplus">+</span>
<a href="#l26.978"></a><span id="l26.978" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.979"></a><span id="l26.979" class="difflineplus">+    if (! aResult)</span>
<a href="#l26.980"></a><span id="l26.980" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.981"></a><span id="l26.981" class="difflineplus">+</span>
<a href="#l26.982"></a><span id="l26.982" class="difflineplus">+    InMemoryAssertionEnumeratorImpl* result =</span>
<a href="#l26.983"></a><span id="l26.983" class="difflineplus">+        new InMemoryAssertionEnumeratorImpl(this, nullptr, aProperty,</span>
<a href="#l26.984"></a><span id="l26.984" class="difflineplus">+                                            aTarget, aTruthValue);</span>
<a href="#l26.985"></a><span id="l26.985" class="difflineplus">+</span>
<a href="#l26.986"></a><span id="l26.986" class="difflineplus">+    if (! result)</span>
<a href="#l26.987"></a><span id="l26.987" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l26.988"></a><span id="l26.988" class="difflineplus">+</span>
<a href="#l26.989"></a><span id="l26.989" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l26.990"></a><span id="l26.990" class="difflineplus">+    *aResult = result;</span>
<a href="#l26.991"></a><span id="l26.991" class="difflineplus">+</span>
<a href="#l26.992"></a><span id="l26.992" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.993"></a><span id="l26.993" class="difflineplus">+}</span>
<a href="#l26.994"></a><span id="l26.994" class="difflineplus">+</span>
<a href="#l26.995"></a><span id="l26.995" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.996"></a><span id="l26.996" class="difflineplus">+InMemoryDataSource::GetTargets(nsIRDFResource* aSource,</span>
<a href="#l26.997"></a><span id="l26.997" class="difflineplus">+                               nsIRDFResource* aProperty,</span>
<a href="#l26.998"></a><span id="l26.998" class="difflineplus">+                               bool aTruthValue,</span>
<a href="#l26.999"></a><span id="l26.999" class="difflineplus">+                               nsISimpleEnumerator** aResult)</span>
<a href="#l26.1000"></a><span id="l26.1000" class="difflineplus">+{</span>
<a href="#l26.1001"></a><span id="l26.1001" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1002"></a><span id="l26.1002" class="difflineplus">+    if (! aSource)</span>
<a href="#l26.1003"></a><span id="l26.1003" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1004"></a><span id="l26.1004" class="difflineplus">+</span>
<a href="#l26.1005"></a><span id="l26.1005" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1006"></a><span id="l26.1006" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.1007"></a><span id="l26.1007" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1008"></a><span id="l26.1008" class="difflineplus">+</span>
<a href="#l26.1009"></a><span id="l26.1009" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1010"></a><span id="l26.1010" class="difflineplus">+    if (! aResult)</span>
<a href="#l26.1011"></a><span id="l26.1011" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1012"></a><span id="l26.1012" class="difflineplus">+</span>
<a href="#l26.1013"></a><span id="l26.1013" class="difflineplus">+    InMemoryAssertionEnumeratorImpl* result =</span>
<a href="#l26.1014"></a><span id="l26.1014" class="difflineplus">+        new InMemoryAssertionEnumeratorImpl(this, aSource, aProperty,</span>
<a href="#l26.1015"></a><span id="l26.1015" class="difflineplus">+                                            nullptr, aTruthValue);</span>
<a href="#l26.1016"></a><span id="l26.1016" class="difflineplus">+</span>
<a href="#l26.1017"></a><span id="l26.1017" class="difflineplus">+    if (! result)</span>
<a href="#l26.1018"></a><span id="l26.1018" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l26.1019"></a><span id="l26.1019" class="difflineplus">+</span>
<a href="#l26.1020"></a><span id="l26.1020" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l26.1021"></a><span id="l26.1021" class="difflineplus">+    *aResult = result;</span>
<a href="#l26.1022"></a><span id="l26.1022" class="difflineplus">+</span>
<a href="#l26.1023"></a><span id="l26.1023" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1024"></a><span id="l26.1024" class="difflineplus">+}</span>
<a href="#l26.1025"></a><span id="l26.1025" class="difflineplus">+</span>
<a href="#l26.1026"></a><span id="l26.1026" class="difflineplus">+</span>
<a href="#l26.1027"></a><span id="l26.1027" class="difflineplus">+nsresult</span>
<a href="#l26.1028"></a><span id="l26.1028" class="difflineplus">+InMemoryDataSource::LockedAssert(nsIRDFResource* aSource,</span>
<a href="#l26.1029"></a><span id="l26.1029" class="difflineplus">+                                 nsIRDFResource* aProperty,</span>
<a href="#l26.1030"></a><span id="l26.1030" class="difflineplus">+                                 nsIRDFNode* aTarget,</span>
<a href="#l26.1031"></a><span id="l26.1031" class="difflineplus">+                                 bool aTruthValue)</span>
<a href="#l26.1032"></a><span id="l26.1032" class="difflineplus">+{</span>
<a href="#l26.1033"></a><span id="l26.1033" class="difflineplus">+    LogOperation(&quot;ASSERT&quot;, aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l26.1034"></a><span id="l26.1034" class="difflineplus">+</span>
<a href="#l26.1035"></a><span id="l26.1035" class="difflineplus">+    Assertion* next = GetForwardArcs(aSource);</span>
<a href="#l26.1036"></a><span id="l26.1036" class="difflineplus">+    Assertion* prev = next;</span>
<a href="#l26.1037"></a><span id="l26.1037" class="difflineplus">+    Assertion* as = nullptr;</span>
<a href="#l26.1038"></a><span id="l26.1038" class="difflineplus">+</span>
<a href="#l26.1039"></a><span id="l26.1039" class="difflineplus">+    bool    haveHash = (next) ? next-&gt;mHashEntry : false;</span>
<a href="#l26.1040"></a><span id="l26.1040" class="difflineplus">+    if (haveHash) {</span>
<a href="#l26.1041"></a><span id="l26.1041" class="difflineplus">+        PLDHashEntryHdr* hdr = next-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l26.1042"></a><span id="l26.1042" class="difflineplus">+        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.1043"></a><span id="l26.1043" class="difflineplus">+        while (val) {</span>
<a href="#l26.1044"></a><span id="l26.1044" class="difflineplus">+            if (val-&gt;u.as.mTarget == aTarget) {</span>
<a href="#l26.1045"></a><span id="l26.1045" class="difflineplus">+                // Wow, we already had the assertion. Make sure that the</span>
<a href="#l26.1046"></a><span id="l26.1046" class="difflineplus">+                // truth values are correct and bail.</span>
<a href="#l26.1047"></a><span id="l26.1047" class="difflineplus">+                val-&gt;u.as.mTruthValue = aTruthValue;</span>
<a href="#l26.1048"></a><span id="l26.1048" class="difflineplus">+                return NS_OK;</span>
<a href="#l26.1049"></a><span id="l26.1049" class="difflineplus">+            }</span>
<a href="#l26.1050"></a><span id="l26.1050" class="difflineplus">+            val = val-&gt;mNext;</span>
<a href="#l26.1051"></a><span id="l26.1051" class="difflineplus">+        }</span>
<a href="#l26.1052"></a><span id="l26.1052" class="difflineplus">+    }</span>
<a href="#l26.1053"></a><span id="l26.1053" class="difflineplus">+    else</span>
<a href="#l26.1054"></a><span id="l26.1054" class="difflineplus">+    {</span>
<a href="#l26.1055"></a><span id="l26.1055" class="difflineplus">+        while (next) {</span>
<a href="#l26.1056"></a><span id="l26.1056" class="difflineplus">+            // check target first as its most unique</span>
<a href="#l26.1057"></a><span id="l26.1057" class="difflineplus">+            if (aTarget == next-&gt;u.as.mTarget) {</span>
<a href="#l26.1058"></a><span id="l26.1058" class="difflineplus">+                if (aProperty == next-&gt;u.as.mProperty) {</span>
<a href="#l26.1059"></a><span id="l26.1059" class="difflineplus">+                    // Wow, we already had the assertion. Make sure that the</span>
<a href="#l26.1060"></a><span id="l26.1060" class="difflineplus">+                    // truth values are correct and bail.</span>
<a href="#l26.1061"></a><span id="l26.1061" class="difflineplus">+                    next-&gt;u.as.mTruthValue = aTruthValue;</span>
<a href="#l26.1062"></a><span id="l26.1062" class="difflineplus">+                    return NS_OK;</span>
<a href="#l26.1063"></a><span id="l26.1063" class="difflineplus">+                }</span>
<a href="#l26.1064"></a><span id="l26.1064" class="difflineplus">+            }</span>
<a href="#l26.1065"></a><span id="l26.1065" class="difflineplus">+</span>
<a href="#l26.1066"></a><span id="l26.1066" class="difflineplus">+            prev = next;</span>
<a href="#l26.1067"></a><span id="l26.1067" class="difflineplus">+            next = next-&gt;mNext;</span>
<a href="#l26.1068"></a><span id="l26.1068" class="difflineplus">+        }</span>
<a href="#l26.1069"></a><span id="l26.1069" class="difflineplus">+    }</span>
<a href="#l26.1070"></a><span id="l26.1070" class="difflineplus">+</span>
<a href="#l26.1071"></a><span id="l26.1071" class="difflineplus">+    as = new Assertion(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l26.1072"></a><span id="l26.1072" class="difflineplus">+    if (! as)</span>
<a href="#l26.1073"></a><span id="l26.1073" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l26.1074"></a><span id="l26.1074" class="difflineplus">+</span>
<a href="#l26.1075"></a><span id="l26.1075" class="difflineplus">+    // Add the datasource's owning reference.</span>
<a href="#l26.1076"></a><span id="l26.1076" class="difflineplus">+    as-&gt;AddRef();</span>
<a href="#l26.1077"></a><span id="l26.1077" class="difflineplus">+</span>
<a href="#l26.1078"></a><span id="l26.1078" class="difflineplus">+    if (haveHash)</span>
<a href="#l26.1079"></a><span id="l26.1079" class="difflineplus">+    {</span>
<a href="#l26.1080"></a><span id="l26.1080" class="difflineplus">+        PLDHashEntryHdr* hdr = next-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l26.1081"></a><span id="l26.1081" class="difflineplus">+        Assertion *asRef =</span>
<a href="#l26.1082"></a><span id="l26.1082" class="difflineplus">+            hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.1083"></a><span id="l26.1083" class="difflineplus">+        if (asRef)</span>
<a href="#l26.1084"></a><span id="l26.1084" class="difflineplus">+        {</span>
<a href="#l26.1085"></a><span id="l26.1085" class="difflineplus">+            as-&gt;mNext = asRef-&gt;mNext;</span>
<a href="#l26.1086"></a><span id="l26.1086" class="difflineplus">+            asRef-&gt;mNext = as;</span>
<a href="#l26.1087"></a><span id="l26.1087" class="difflineplus">+        }</span>
<a href="#l26.1088"></a><span id="l26.1088" class="difflineplus">+        else</span>
<a href="#l26.1089"></a><span id="l26.1089" class="difflineplus">+        {</span>
<a href="#l26.1090"></a><span id="l26.1090" class="difflineplus">+            hdr = next-&gt;u.hash.mPropertyHash-&gt;Add(aProperty, mozilla::fallible);</span>
<a href="#l26.1091"></a><span id="l26.1091" class="difflineplus">+            if (hdr)</span>
<a href="#l26.1092"></a><span id="l26.1092" class="difflineplus">+            {</span>
<a href="#l26.1093"></a><span id="l26.1093" class="difflineplus">+                Entry* entry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l26.1094"></a><span id="l26.1094" class="difflineplus">+                entry-&gt;mNode = aProperty;</span>
<a href="#l26.1095"></a><span id="l26.1095" class="difflineplus">+                entry-&gt;mAssertions = as;</span>
<a href="#l26.1096"></a><span id="l26.1096" class="difflineplus">+            }</span>
<a href="#l26.1097"></a><span id="l26.1097" class="difflineplus">+        }</span>
<a href="#l26.1098"></a><span id="l26.1098" class="difflineplus">+    }</span>
<a href="#l26.1099"></a><span id="l26.1099" class="difflineplus">+    else</span>
<a href="#l26.1100"></a><span id="l26.1100" class="difflineplus">+    {</span>
<a href="#l26.1101"></a><span id="l26.1101" class="difflineplus">+        // Link it in to the &quot;forward arcs&quot; table</span>
<a href="#l26.1102"></a><span id="l26.1102" class="difflineplus">+        if (!prev) {</span>
<a href="#l26.1103"></a><span id="l26.1103" class="difflineplus">+            SetForwardArcs(aSource, as);</span>
<a href="#l26.1104"></a><span id="l26.1104" class="difflineplus">+        } else {</span>
<a href="#l26.1105"></a><span id="l26.1105" class="difflineplus">+            prev-&gt;mNext = as;</span>
<a href="#l26.1106"></a><span id="l26.1106" class="difflineplus">+        }</span>
<a href="#l26.1107"></a><span id="l26.1107" class="difflineplus">+    }</span>
<a href="#l26.1108"></a><span id="l26.1108" class="difflineplus">+</span>
<a href="#l26.1109"></a><span id="l26.1109" class="difflineplus">+    // Link it in to the &quot;reverse arcs&quot; table</span>
<a href="#l26.1110"></a><span id="l26.1110" class="difflineplus">+</span>
<a href="#l26.1111"></a><span id="l26.1111" class="difflineplus">+    next = GetReverseArcs(aTarget);</span>
<a href="#l26.1112"></a><span id="l26.1112" class="difflineplus">+    as-&gt;u.as.mInvNext = next;</span>
<a href="#l26.1113"></a><span id="l26.1113" class="difflineplus">+    next = as;</span>
<a href="#l26.1114"></a><span id="l26.1114" class="difflineplus">+    SetReverseArcs(aTarget, next);</span>
<a href="#l26.1115"></a><span id="l26.1115" class="difflineplus">+</span>
<a href="#l26.1116"></a><span id="l26.1116" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1117"></a><span id="l26.1117" class="difflineplus">+}</span>
<a href="#l26.1118"></a><span id="l26.1118" class="difflineplus">+</span>
<a href="#l26.1119"></a><span id="l26.1119" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1120"></a><span id="l26.1120" class="difflineplus">+InMemoryDataSource::Assert(nsIRDFResource* aSource,</span>
<a href="#l26.1121"></a><span id="l26.1121" class="difflineplus">+                           nsIRDFResource* aProperty,</span>
<a href="#l26.1122"></a><span id="l26.1122" class="difflineplus">+                           nsIRDFNode* aTarget,</span>
<a href="#l26.1123"></a><span id="l26.1123" class="difflineplus">+                           bool aTruthValue)</span>
<a href="#l26.1124"></a><span id="l26.1124" class="difflineplus">+{</span>
<a href="#l26.1125"></a><span id="l26.1125" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1126"></a><span id="l26.1126" class="difflineplus">+    if (! aSource)</span>
<a href="#l26.1127"></a><span id="l26.1127" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1128"></a><span id="l26.1128" class="difflineplus">+</span>
<a href="#l26.1129"></a><span id="l26.1129" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1130"></a><span id="l26.1130" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.1131"></a><span id="l26.1131" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1132"></a><span id="l26.1132" class="difflineplus">+</span>
<a href="#l26.1133"></a><span id="l26.1133" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1134"></a><span id="l26.1134" class="difflineplus">+    if (! aTarget)</span>
<a href="#l26.1135"></a><span id="l26.1135" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1136"></a><span id="l26.1136" class="difflineplus">+</span>
<a href="#l26.1137"></a><span id="l26.1137" class="difflineplus">+    if (mReadCount) {</span>
<a href="#l26.1138"></a><span id="l26.1138" class="difflineplus">+        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l26.1139"></a><span id="l26.1139" class="difflineplus">+        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l26.1140"></a><span id="l26.1140" class="difflineplus">+    }</span>
<a href="#l26.1141"></a><span id="l26.1141" class="difflineplus">+</span>
<a href="#l26.1142"></a><span id="l26.1142" class="difflineplus">+    nsresult rv;</span>
<a href="#l26.1143"></a><span id="l26.1143" class="difflineplus">+    rv = LockedAssert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l26.1144"></a><span id="l26.1144" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1145"></a><span id="l26.1145" class="difflineplus">+</span>
<a href="#l26.1146"></a><span id="l26.1146" class="difflineplus">+    // notify observers</span>
<a href="#l26.1147"></a><span id="l26.1147" class="difflineplus">+    for (int32_t i = (int32_t)mNumObservers - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1148"></a><span id="l26.1148" class="difflineplus">+        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1149"></a><span id="l26.1149" class="difflineplus">+</span>
<a href="#l26.1150"></a><span id="l26.1150" class="difflineplus">+        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l26.1151"></a><span id="l26.1151" class="difflineplus">+        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l26.1152"></a><span id="l26.1152" class="difflineplus">+        if (! obs)</span>
<a href="#l26.1153"></a><span id="l26.1153" class="difflineplus">+          continue;</span>
<a href="#l26.1154"></a><span id="l26.1154" class="difflineplus">+</span>
<a href="#l26.1155"></a><span id="l26.1155" class="difflineplus">+        obs-&gt;OnAssert(this, aSource, aProperty, aTarget);</span>
<a href="#l26.1156"></a><span id="l26.1156" class="difflineplus">+        // XXX ignore return value?</span>
<a href="#l26.1157"></a><span id="l26.1157" class="difflineplus">+    }</span>
<a href="#l26.1158"></a><span id="l26.1158" class="difflineplus">+</span>
<a href="#l26.1159"></a><span id="l26.1159" class="difflineplus">+    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l26.1160"></a><span id="l26.1160" class="difflineplus">+}</span>
<a href="#l26.1161"></a><span id="l26.1161" class="difflineplus">+</span>
<a href="#l26.1162"></a><span id="l26.1162" class="difflineplus">+</span>
<a href="#l26.1163"></a><span id="l26.1163" class="difflineplus">+nsresult</span>
<a href="#l26.1164"></a><span id="l26.1164" class="difflineplus">+InMemoryDataSource::LockedUnassert(nsIRDFResource* aSource,</span>
<a href="#l26.1165"></a><span id="l26.1165" class="difflineplus">+                                   nsIRDFResource* aProperty,</span>
<a href="#l26.1166"></a><span id="l26.1166" class="difflineplus">+                                   nsIRDFNode* aTarget)</span>
<a href="#l26.1167"></a><span id="l26.1167" class="difflineplus">+{</span>
<a href="#l26.1168"></a><span id="l26.1168" class="difflineplus">+    LogOperation(&quot;UNASSERT&quot;, aSource, aProperty, aTarget);</span>
<a href="#l26.1169"></a><span id="l26.1169" class="difflineplus">+</span>
<a href="#l26.1170"></a><span id="l26.1170" class="difflineplus">+    Assertion* next = GetForwardArcs(aSource);</span>
<a href="#l26.1171"></a><span id="l26.1171" class="difflineplus">+    Assertion* prev = next;</span>
<a href="#l26.1172"></a><span id="l26.1172" class="difflineplus">+    Assertion* root = next;</span>
<a href="#l26.1173"></a><span id="l26.1173" class="difflineplus">+    Assertion* as = nullptr;</span>
<a href="#l26.1174"></a><span id="l26.1174" class="difflineplus">+</span>
<a href="#l26.1175"></a><span id="l26.1175" class="difflineplus">+    bool    haveHash = (next) ? next-&gt;mHashEntry : false;</span>
<a href="#l26.1176"></a><span id="l26.1176" class="difflineplus">+    if (haveHash) {</span>
<a href="#l26.1177"></a><span id="l26.1177" class="difflineplus">+        PLDHashEntryHdr* hdr = next-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l26.1178"></a><span id="l26.1178" class="difflineplus">+        prev = next = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.1179"></a><span id="l26.1179" class="difflineplus">+        bool first = true;</span>
<a href="#l26.1180"></a><span id="l26.1180" class="difflineplus">+        while (next) {</span>
<a href="#l26.1181"></a><span id="l26.1181" class="difflineplus">+            if (aTarget == next-&gt;u.as.mTarget) {</span>
<a href="#l26.1182"></a><span id="l26.1182" class="difflineplus">+                break;</span>
<a href="#l26.1183"></a><span id="l26.1183" class="difflineplus">+            }</span>
<a href="#l26.1184"></a><span id="l26.1184" class="difflineplus">+            first = false;</span>
<a href="#l26.1185"></a><span id="l26.1185" class="difflineplus">+            prev = next;</span>
<a href="#l26.1186"></a><span id="l26.1186" class="difflineplus">+            next = next-&gt;mNext;</span>
<a href="#l26.1187"></a><span id="l26.1187" class="difflineplus">+        }</span>
<a href="#l26.1188"></a><span id="l26.1188" class="difflineplus">+        // We don't even have the assertion, so just bail.</span>
<a href="#l26.1189"></a><span id="l26.1189" class="difflineplus">+        if (!next)</span>
<a href="#l26.1190"></a><span id="l26.1190" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.1191"></a><span id="l26.1191" class="difflineplus">+</span>
<a href="#l26.1192"></a><span id="l26.1192" class="difflineplus">+        as = next;</span>
<a href="#l26.1193"></a><span id="l26.1193" class="difflineplus">+</span>
<a href="#l26.1194"></a><span id="l26.1194" class="difflineplus">+        if (first) {</span>
<a href="#l26.1195"></a><span id="l26.1195" class="difflineplus">+            root-&gt;u.hash.mPropertyHash-&gt;RawRemove(hdr);</span>
<a href="#l26.1196"></a><span id="l26.1196" class="difflineplus">+</span>
<a href="#l26.1197"></a><span id="l26.1197" class="difflineplus">+            if (next &amp;&amp; next-&gt;mNext) {</span>
<a href="#l26.1198"></a><span id="l26.1198" class="difflineplus">+                PLDHashEntryHdr* hdr =</span>
<a href="#l26.1199"></a><span id="l26.1199" class="difflineplus">+                    root-&gt;u.hash.mPropertyHash-&gt;Add(aProperty,</span>
<a href="#l26.1200"></a><span id="l26.1200" class="difflineplus">+                                                    mozilla::fallible);</span>
<a href="#l26.1201"></a><span id="l26.1201" class="difflineplus">+                if (hdr) {</span>
<a href="#l26.1202"></a><span id="l26.1202" class="difflineplus">+                    Entry* entry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l26.1203"></a><span id="l26.1203" class="difflineplus">+                    entry-&gt;mNode = aProperty;</span>
<a href="#l26.1204"></a><span id="l26.1204" class="difflineplus">+                    entry-&gt;mAssertions = next-&gt;mNext;</span>
<a href="#l26.1205"></a><span id="l26.1205" class="difflineplus">+                }</span>
<a href="#l26.1206"></a><span id="l26.1206" class="difflineplus">+            }</span>
<a href="#l26.1207"></a><span id="l26.1207" class="difflineplus">+            else {</span>
<a href="#l26.1208"></a><span id="l26.1208" class="difflineplus">+                // If this second-level hash empties out, clean it up.</span>
<a href="#l26.1209"></a><span id="l26.1209" class="difflineplus">+                if (!root-&gt;u.hash.mPropertyHash-&gt;EntryCount()) {</span>
<a href="#l26.1210"></a><span id="l26.1210" class="difflineplus">+                    root-&gt;Release();</span>
<a href="#l26.1211"></a><span id="l26.1211" class="difflineplus">+                    SetForwardArcs(aSource, nullptr);</span>
<a href="#l26.1212"></a><span id="l26.1212" class="difflineplus">+                }</span>
<a href="#l26.1213"></a><span id="l26.1213" class="difflineplus">+            }</span>
<a href="#l26.1214"></a><span id="l26.1214" class="difflineplus">+        }</span>
<a href="#l26.1215"></a><span id="l26.1215" class="difflineplus">+        else {</span>
<a href="#l26.1216"></a><span id="l26.1216" class="difflineplus">+            prev-&gt;mNext = next-&gt;mNext;</span>
<a href="#l26.1217"></a><span id="l26.1217" class="difflineplus">+        }</span>
<a href="#l26.1218"></a><span id="l26.1218" class="difflineplus">+    }</span>
<a href="#l26.1219"></a><span id="l26.1219" class="difflineplus">+    else</span>
<a href="#l26.1220"></a><span id="l26.1220" class="difflineplus">+    {</span>
<a href="#l26.1221"></a><span id="l26.1221" class="difflineplus">+        while (next) {</span>
<a href="#l26.1222"></a><span id="l26.1222" class="difflineplus">+            // check target first as its most unique</span>
<a href="#l26.1223"></a><span id="l26.1223" class="difflineplus">+            if (aTarget == next-&gt;u.as.mTarget) {</span>
<a href="#l26.1224"></a><span id="l26.1224" class="difflineplus">+                if (aProperty == next-&gt;u.as.mProperty) {</span>
<a href="#l26.1225"></a><span id="l26.1225" class="difflineplus">+                    if (prev == next) {</span>
<a href="#l26.1226"></a><span id="l26.1226" class="difflineplus">+                        SetForwardArcs(aSource, next-&gt;mNext);</span>
<a href="#l26.1227"></a><span id="l26.1227" class="difflineplus">+                    } else {</span>
<a href="#l26.1228"></a><span id="l26.1228" class="difflineplus">+                        prev-&gt;mNext = next-&gt;mNext;</span>
<a href="#l26.1229"></a><span id="l26.1229" class="difflineplus">+                    }</span>
<a href="#l26.1230"></a><span id="l26.1230" class="difflineplus">+                    as = next;</span>
<a href="#l26.1231"></a><span id="l26.1231" class="difflineplus">+                    break;</span>
<a href="#l26.1232"></a><span id="l26.1232" class="difflineplus">+                }</span>
<a href="#l26.1233"></a><span id="l26.1233" class="difflineplus">+            }</span>
<a href="#l26.1234"></a><span id="l26.1234" class="difflineplus">+</span>
<a href="#l26.1235"></a><span id="l26.1235" class="difflineplus">+            prev = next;</span>
<a href="#l26.1236"></a><span id="l26.1236" class="difflineplus">+            next = next-&gt;mNext;</span>
<a href="#l26.1237"></a><span id="l26.1237" class="difflineplus">+        }</span>
<a href="#l26.1238"></a><span id="l26.1238" class="difflineplus">+    }</span>
<a href="#l26.1239"></a><span id="l26.1239" class="difflineplus">+    // We don't even have the assertion, so just bail.</span>
<a href="#l26.1240"></a><span id="l26.1240" class="difflineplus">+    if (!as)</span>
<a href="#l26.1241"></a><span id="l26.1241" class="difflineplus">+        return NS_OK;</span>
<a href="#l26.1242"></a><span id="l26.1242" class="difflineplus">+</span>
<a href="#l26.1243"></a><span id="l26.1243" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l26.1244"></a><span id="l26.1244" class="difflineplus">+    bool foundReverseArc = false;</span>
<a href="#l26.1245"></a><span id="l26.1245" class="difflineplus">+#endif</span>
<a href="#l26.1246"></a><span id="l26.1246" class="difflineplus">+</span>
<a href="#l26.1247"></a><span id="l26.1247" class="difflineplus">+    next = prev = GetReverseArcs(aTarget);</span>
<a href="#l26.1248"></a><span id="l26.1248" class="difflineplus">+    while (next) {</span>
<a href="#l26.1249"></a><span id="l26.1249" class="difflineplus">+        if (next == as) {</span>
<a href="#l26.1250"></a><span id="l26.1250" class="difflineplus">+            if (prev == next) {</span>
<a href="#l26.1251"></a><span id="l26.1251" class="difflineplus">+                SetReverseArcs(aTarget, next-&gt;u.as.mInvNext);</span>
<a href="#l26.1252"></a><span id="l26.1252" class="difflineplus">+            } else {</span>
<a href="#l26.1253"></a><span id="l26.1253" class="difflineplus">+                prev-&gt;u.as.mInvNext = next-&gt;u.as.mInvNext;</span>
<a href="#l26.1254"></a><span id="l26.1254" class="difflineplus">+            }</span>
<a href="#l26.1255"></a><span id="l26.1255" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l26.1256"></a><span id="l26.1256" class="difflineplus">+            foundReverseArc = true;</span>
<a href="#l26.1257"></a><span id="l26.1257" class="difflineplus">+#endif</span>
<a href="#l26.1258"></a><span id="l26.1258" class="difflineplus">+            break;</span>
<a href="#l26.1259"></a><span id="l26.1259" class="difflineplus">+        }</span>
<a href="#l26.1260"></a><span id="l26.1260" class="difflineplus">+        prev = next;</span>
<a href="#l26.1261"></a><span id="l26.1261" class="difflineplus">+        next = next-&gt;u.as.mInvNext;</span>
<a href="#l26.1262"></a><span id="l26.1262" class="difflineplus">+    }</span>
<a href="#l26.1263"></a><span id="l26.1263" class="difflineplus">+</span>
<a href="#l26.1264"></a><span id="l26.1264" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l26.1265"></a><span id="l26.1265" class="difflineplus">+    NS_ASSERTION(foundReverseArc, &quot;in-memory db corrupted: unable to find reverse arc&quot;);</span>
<a href="#l26.1266"></a><span id="l26.1266" class="difflineplus">+#endif</span>
<a href="#l26.1267"></a><span id="l26.1267" class="difflineplus">+</span>
<a href="#l26.1268"></a><span id="l26.1268" class="difflineplus">+    // Unlink, and release the datasource's reference</span>
<a href="#l26.1269"></a><span id="l26.1269" class="difflineplus">+    as-&gt;mNext = as-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l26.1270"></a><span id="l26.1270" class="difflineplus">+    as-&gt;Release();</span>
<a href="#l26.1271"></a><span id="l26.1271" class="difflineplus">+</span>
<a href="#l26.1272"></a><span id="l26.1272" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1273"></a><span id="l26.1273" class="difflineplus">+}</span>
<a href="#l26.1274"></a><span id="l26.1274" class="difflineplus">+</span>
<a href="#l26.1275"></a><span id="l26.1275" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1276"></a><span id="l26.1276" class="difflineplus">+InMemoryDataSource::Unassert(nsIRDFResource* aSource,</span>
<a href="#l26.1277"></a><span id="l26.1277" class="difflineplus">+                             nsIRDFResource* aProperty,</span>
<a href="#l26.1278"></a><span id="l26.1278" class="difflineplus">+                             nsIRDFNode* aTarget)</span>
<a href="#l26.1279"></a><span id="l26.1279" class="difflineplus">+{</span>
<a href="#l26.1280"></a><span id="l26.1280" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1281"></a><span id="l26.1281" class="difflineplus">+    if (! aSource)</span>
<a href="#l26.1282"></a><span id="l26.1282" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1283"></a><span id="l26.1283" class="difflineplus">+</span>
<a href="#l26.1284"></a><span id="l26.1284" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1285"></a><span id="l26.1285" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.1286"></a><span id="l26.1286" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1287"></a><span id="l26.1287" class="difflineplus">+</span>
<a href="#l26.1288"></a><span id="l26.1288" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1289"></a><span id="l26.1289" class="difflineplus">+    if (! aTarget)</span>
<a href="#l26.1290"></a><span id="l26.1290" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1291"></a><span id="l26.1291" class="difflineplus">+</span>
<a href="#l26.1292"></a><span id="l26.1292" class="difflineplus">+    if (mReadCount) {</span>
<a href="#l26.1293"></a><span id="l26.1293" class="difflineplus">+        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l26.1294"></a><span id="l26.1294" class="difflineplus">+        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l26.1295"></a><span id="l26.1295" class="difflineplus">+    }</span>
<a href="#l26.1296"></a><span id="l26.1296" class="difflineplus">+</span>
<a href="#l26.1297"></a><span id="l26.1297" class="difflineplus">+    nsresult rv;</span>
<a href="#l26.1298"></a><span id="l26.1298" class="difflineplus">+</span>
<a href="#l26.1299"></a><span id="l26.1299" class="difflineplus">+    rv = LockedUnassert(aSource, aProperty, aTarget);</span>
<a href="#l26.1300"></a><span id="l26.1300" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1301"></a><span id="l26.1301" class="difflineplus">+</span>
<a href="#l26.1302"></a><span id="l26.1302" class="difflineplus">+    // Notify the world</span>
<a href="#l26.1303"></a><span id="l26.1303" class="difflineplus">+    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1304"></a><span id="l26.1304" class="difflineplus">+        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1305"></a><span id="l26.1305" class="difflineplus">+</span>
<a href="#l26.1306"></a><span id="l26.1306" class="difflineplus">+        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l26.1307"></a><span id="l26.1307" class="difflineplus">+        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l26.1308"></a><span id="l26.1308" class="difflineplus">+        if (! obs)</span>
<a href="#l26.1309"></a><span id="l26.1309" class="difflineplus">+          continue;</span>
<a href="#l26.1310"></a><span id="l26.1310" class="difflineplus">+</span>
<a href="#l26.1311"></a><span id="l26.1311" class="difflineplus">+        obs-&gt;OnUnassert(this, aSource, aProperty, aTarget);</span>
<a href="#l26.1312"></a><span id="l26.1312" class="difflineplus">+        // XXX ignore return value?</span>
<a href="#l26.1313"></a><span id="l26.1313" class="difflineplus">+    }</span>
<a href="#l26.1314"></a><span id="l26.1314" class="difflineplus">+</span>
<a href="#l26.1315"></a><span id="l26.1315" class="difflineplus">+    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l26.1316"></a><span id="l26.1316" class="difflineplus">+}</span>
<a href="#l26.1317"></a><span id="l26.1317" class="difflineplus">+</span>
<a href="#l26.1318"></a><span id="l26.1318" class="difflineplus">+</span>
<a href="#l26.1319"></a><span id="l26.1319" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1320"></a><span id="l26.1320" class="difflineplus">+InMemoryDataSource::Change(nsIRDFResource* aSource,</span>
<a href="#l26.1321"></a><span id="l26.1321" class="difflineplus">+                           nsIRDFResource* aProperty,</span>
<a href="#l26.1322"></a><span id="l26.1322" class="difflineplus">+                           nsIRDFNode* aOldTarget,</span>
<a href="#l26.1323"></a><span id="l26.1323" class="difflineplus">+                           nsIRDFNode* aNewTarget)</span>
<a href="#l26.1324"></a><span id="l26.1324" class="difflineplus">+{</span>
<a href="#l26.1325"></a><span id="l26.1325" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1326"></a><span id="l26.1326" class="difflineplus">+    if (! aSource)</span>
<a href="#l26.1327"></a><span id="l26.1327" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1328"></a><span id="l26.1328" class="difflineplus">+</span>
<a href="#l26.1329"></a><span id="l26.1329" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1330"></a><span id="l26.1330" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.1331"></a><span id="l26.1331" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1332"></a><span id="l26.1332" class="difflineplus">+</span>
<a href="#l26.1333"></a><span id="l26.1333" class="difflineplus">+    NS_PRECONDITION(aOldTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1334"></a><span id="l26.1334" class="difflineplus">+    if (! aOldTarget)</span>
<a href="#l26.1335"></a><span id="l26.1335" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1336"></a><span id="l26.1336" class="difflineplus">+</span>
<a href="#l26.1337"></a><span id="l26.1337" class="difflineplus">+    NS_PRECONDITION(aNewTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1338"></a><span id="l26.1338" class="difflineplus">+    if (! aNewTarget)</span>
<a href="#l26.1339"></a><span id="l26.1339" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1340"></a><span id="l26.1340" class="difflineplus">+</span>
<a href="#l26.1341"></a><span id="l26.1341" class="difflineplus">+    if (mReadCount) {</span>
<a href="#l26.1342"></a><span id="l26.1342" class="difflineplus">+        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l26.1343"></a><span id="l26.1343" class="difflineplus">+        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l26.1344"></a><span id="l26.1344" class="difflineplus">+    }</span>
<a href="#l26.1345"></a><span id="l26.1345" class="difflineplus">+</span>
<a href="#l26.1346"></a><span id="l26.1346" class="difflineplus">+    nsresult rv;</span>
<a href="#l26.1347"></a><span id="l26.1347" class="difflineplus">+</span>
<a href="#l26.1348"></a><span id="l26.1348" class="difflineplus">+    // XXX We can implement LockedChange() if we decide that this</span>
<a href="#l26.1349"></a><span id="l26.1349" class="difflineplus">+    // is a performance bottleneck.</span>
<a href="#l26.1350"></a><span id="l26.1350" class="difflineplus">+</span>
<a href="#l26.1351"></a><span id="l26.1351" class="difflineplus">+    rv = LockedUnassert(aSource, aProperty, aOldTarget);</span>
<a href="#l26.1352"></a><span id="l26.1352" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1353"></a><span id="l26.1353" class="difflineplus">+</span>
<a href="#l26.1354"></a><span id="l26.1354" class="difflineplus">+    rv = LockedAssert(aSource, aProperty, aNewTarget, true);</span>
<a href="#l26.1355"></a><span id="l26.1355" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1356"></a><span id="l26.1356" class="difflineplus">+</span>
<a href="#l26.1357"></a><span id="l26.1357" class="difflineplus">+    // Notify the world</span>
<a href="#l26.1358"></a><span id="l26.1358" class="difflineplus">+    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1359"></a><span id="l26.1359" class="difflineplus">+        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1360"></a><span id="l26.1360" class="difflineplus">+</span>
<a href="#l26.1361"></a><span id="l26.1361" class="difflineplus">+        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l26.1362"></a><span id="l26.1362" class="difflineplus">+        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l26.1363"></a><span id="l26.1363" class="difflineplus">+        if (! obs)</span>
<a href="#l26.1364"></a><span id="l26.1364" class="difflineplus">+          continue;</span>
<a href="#l26.1365"></a><span id="l26.1365" class="difflineplus">+</span>
<a href="#l26.1366"></a><span id="l26.1366" class="difflineplus">+        obs-&gt;OnChange(this, aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l26.1367"></a><span id="l26.1367" class="difflineplus">+        // XXX ignore return value?</span>
<a href="#l26.1368"></a><span id="l26.1368" class="difflineplus">+    }</span>
<a href="#l26.1369"></a><span id="l26.1369" class="difflineplus">+</span>
<a href="#l26.1370"></a><span id="l26.1370" class="difflineplus">+    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l26.1371"></a><span id="l26.1371" class="difflineplus">+}</span>
<a href="#l26.1372"></a><span id="l26.1372" class="difflineplus">+</span>
<a href="#l26.1373"></a><span id="l26.1373" class="difflineplus">+</span>
<a href="#l26.1374"></a><span id="l26.1374" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1375"></a><span id="l26.1375" class="difflineplus">+InMemoryDataSource::Move(nsIRDFResource* aOldSource,</span>
<a href="#l26.1376"></a><span id="l26.1376" class="difflineplus">+                         nsIRDFResource* aNewSource,</span>
<a href="#l26.1377"></a><span id="l26.1377" class="difflineplus">+                         nsIRDFResource* aProperty,</span>
<a href="#l26.1378"></a><span id="l26.1378" class="difflineplus">+                         nsIRDFNode* aTarget)</span>
<a href="#l26.1379"></a><span id="l26.1379" class="difflineplus">+{</span>
<a href="#l26.1380"></a><span id="l26.1380" class="difflineplus">+    NS_PRECONDITION(aOldSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1381"></a><span id="l26.1381" class="difflineplus">+    if (! aOldSource)</span>
<a href="#l26.1382"></a><span id="l26.1382" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1383"></a><span id="l26.1383" class="difflineplus">+</span>
<a href="#l26.1384"></a><span id="l26.1384" class="difflineplus">+    NS_PRECONDITION(aNewSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1385"></a><span id="l26.1385" class="difflineplus">+    if (! aNewSource)</span>
<a href="#l26.1386"></a><span id="l26.1386" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1387"></a><span id="l26.1387" class="difflineplus">+</span>
<a href="#l26.1388"></a><span id="l26.1388" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1389"></a><span id="l26.1389" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.1390"></a><span id="l26.1390" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1391"></a><span id="l26.1391" class="difflineplus">+</span>
<a href="#l26.1392"></a><span id="l26.1392" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1393"></a><span id="l26.1393" class="difflineplus">+    if (! aTarget)</span>
<a href="#l26.1394"></a><span id="l26.1394" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1395"></a><span id="l26.1395" class="difflineplus">+</span>
<a href="#l26.1396"></a><span id="l26.1396" class="difflineplus">+    if (mReadCount) {</span>
<a href="#l26.1397"></a><span id="l26.1397" class="difflineplus">+        NS_WARNING(&quot;Writing to InMemoryDataSource during read\n&quot;);</span>
<a href="#l26.1398"></a><span id="l26.1398" class="difflineplus">+        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l26.1399"></a><span id="l26.1399" class="difflineplus">+    }</span>
<a href="#l26.1400"></a><span id="l26.1400" class="difflineplus">+</span>
<a href="#l26.1401"></a><span id="l26.1401" class="difflineplus">+    nsresult rv;</span>
<a href="#l26.1402"></a><span id="l26.1402" class="difflineplus">+</span>
<a href="#l26.1403"></a><span id="l26.1403" class="difflineplus">+    // XXX We can implement LockedMove() if we decide that this</span>
<a href="#l26.1404"></a><span id="l26.1404" class="difflineplus">+    // is a performance bottleneck.</span>
<a href="#l26.1405"></a><span id="l26.1405" class="difflineplus">+</span>
<a href="#l26.1406"></a><span id="l26.1406" class="difflineplus">+    rv = LockedUnassert(aOldSource, aProperty, aTarget);</span>
<a href="#l26.1407"></a><span id="l26.1407" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1408"></a><span id="l26.1408" class="difflineplus">+</span>
<a href="#l26.1409"></a><span id="l26.1409" class="difflineplus">+    rv = LockedAssert(aNewSource, aProperty, aTarget, true);</span>
<a href="#l26.1410"></a><span id="l26.1410" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l26.1411"></a><span id="l26.1411" class="difflineplus">+</span>
<a href="#l26.1412"></a><span id="l26.1412" class="difflineplus">+    // Notify the world</span>
<a href="#l26.1413"></a><span id="l26.1413" class="difflineplus">+    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1414"></a><span id="l26.1414" class="difflineplus">+        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1415"></a><span id="l26.1415" class="difflineplus">+</span>
<a href="#l26.1416"></a><span id="l26.1416" class="difflineplus">+        // XXX this should never happen, but it does, and we can't figure out why.</span>
<a href="#l26.1417"></a><span id="l26.1417" class="difflineplus">+        NS_ASSERTION(obs, &quot;observer array corrupted!&quot;);</span>
<a href="#l26.1418"></a><span id="l26.1418" class="difflineplus">+        if (! obs)</span>
<a href="#l26.1419"></a><span id="l26.1419" class="difflineplus">+          continue;</span>
<a href="#l26.1420"></a><span id="l26.1420" class="difflineplus">+</span>
<a href="#l26.1421"></a><span id="l26.1421" class="difflineplus">+        obs-&gt;OnMove(this, aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l26.1422"></a><span id="l26.1422" class="difflineplus">+        // XXX ignore return value?</span>
<a href="#l26.1423"></a><span id="l26.1423" class="difflineplus">+    }</span>
<a href="#l26.1424"></a><span id="l26.1424" class="difflineplus">+</span>
<a href="#l26.1425"></a><span id="l26.1425" class="difflineplus">+    return NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l26.1426"></a><span id="l26.1426" class="difflineplus">+}</span>
<a href="#l26.1427"></a><span id="l26.1427" class="difflineplus">+</span>
<a href="#l26.1428"></a><span id="l26.1428" class="difflineplus">+</span>
<a href="#l26.1429"></a><span id="l26.1429" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1430"></a><span id="l26.1430" class="difflineplus">+InMemoryDataSource::AddObserver(nsIRDFObserver* aObserver)</span>
<a href="#l26.1431"></a><span id="l26.1431" class="difflineplus">+{</span>
<a href="#l26.1432"></a><span id="l26.1432" class="difflineplus">+    NS_PRECONDITION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1433"></a><span id="l26.1433" class="difflineplus">+    if (! aObserver)</span>
<a href="#l26.1434"></a><span id="l26.1434" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1435"></a><span id="l26.1435" class="difflineplus">+</span>
<a href="#l26.1436"></a><span id="l26.1436" class="difflineplus">+    mObservers.AppendObject(aObserver);</span>
<a href="#l26.1437"></a><span id="l26.1437" class="difflineplus">+    mNumObservers = mObservers.Count();</span>
<a href="#l26.1438"></a><span id="l26.1438" class="difflineplus">+</span>
<a href="#l26.1439"></a><span id="l26.1439" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1440"></a><span id="l26.1440" class="difflineplus">+}</span>
<a href="#l26.1441"></a><span id="l26.1441" class="difflineplus">+</span>
<a href="#l26.1442"></a><span id="l26.1442" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1443"></a><span id="l26.1443" class="difflineplus">+InMemoryDataSource::RemoveObserver(nsIRDFObserver* aObserver)</span>
<a href="#l26.1444"></a><span id="l26.1444" class="difflineplus">+{</span>
<a href="#l26.1445"></a><span id="l26.1445" class="difflineplus">+    NS_PRECONDITION(aObserver != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1446"></a><span id="l26.1446" class="difflineplus">+    if (! aObserver)</span>
<a href="#l26.1447"></a><span id="l26.1447" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1448"></a><span id="l26.1448" class="difflineplus">+</span>
<a href="#l26.1449"></a><span id="l26.1449" class="difflineplus">+    mObservers.RemoveObject(aObserver);</span>
<a href="#l26.1450"></a><span id="l26.1450" class="difflineplus">+    // note: use Count() instead of just decrementing</span>
<a href="#l26.1451"></a><span id="l26.1451" class="difflineplus">+    // in case aObserver wasn't in list, for example</span>
<a href="#l26.1452"></a><span id="l26.1452" class="difflineplus">+    mNumObservers = mObservers.Count();</span>
<a href="#l26.1453"></a><span id="l26.1453" class="difflineplus">+</span>
<a href="#l26.1454"></a><span id="l26.1454" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1455"></a><span id="l26.1455" class="difflineplus">+}</span>
<a href="#l26.1456"></a><span id="l26.1456" class="difflineplus">+</span>
<a href="#l26.1457"></a><span id="l26.1457" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1458"></a><span id="l26.1458" class="difflineplus">+InMemoryDataSource::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *result)</span>
<a href="#l26.1459"></a><span id="l26.1459" class="difflineplus">+{</span>
<a href="#l26.1460"></a><span id="l26.1460" class="difflineplus">+    Assertion* ass = GetReverseArcs(aNode);</span>
<a href="#l26.1461"></a><span id="l26.1461" class="difflineplus">+    while (ass) {</span>
<a href="#l26.1462"></a><span id="l26.1462" class="difflineplus">+        nsIRDFResource* elbow = ass-&gt;u.as.mProperty;</span>
<a href="#l26.1463"></a><span id="l26.1463" class="difflineplus">+        if (elbow == aArc) {</span>
<a href="#l26.1464"></a><span id="l26.1464" class="difflineplus">+            *result = true;</span>
<a href="#l26.1465"></a><span id="l26.1465" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.1466"></a><span id="l26.1466" class="difflineplus">+        }</span>
<a href="#l26.1467"></a><span id="l26.1467" class="difflineplus">+        ass = ass-&gt;u.as.mInvNext;</span>
<a href="#l26.1468"></a><span id="l26.1468" class="difflineplus">+    }</span>
<a href="#l26.1469"></a><span id="l26.1469" class="difflineplus">+    *result = false;</span>
<a href="#l26.1470"></a><span id="l26.1470" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1471"></a><span id="l26.1471" class="difflineplus">+}</span>
<a href="#l26.1472"></a><span id="l26.1472" class="difflineplus">+</span>
<a href="#l26.1473"></a><span id="l26.1473" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1474"></a><span id="l26.1474" class="difflineplus">+InMemoryDataSource::HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *result)</span>
<a href="#l26.1475"></a><span id="l26.1475" class="difflineplus">+{</span>
<a href="#l26.1476"></a><span id="l26.1476" class="difflineplus">+    Assertion* ass = GetForwardArcs(aSource);</span>
<a href="#l26.1477"></a><span id="l26.1477" class="difflineplus">+    if (ass &amp;&amp; ass-&gt;mHashEntry) {</span>
<a href="#l26.1478"></a><span id="l26.1478" class="difflineplus">+        PLDHashEntryHdr* hdr = ass-&gt;u.hash.mPropertyHash-&gt;Search(aArc);</span>
<a href="#l26.1479"></a><span id="l26.1479" class="difflineplus">+        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.1480"></a><span id="l26.1480" class="difflineplus">+        if (val) {</span>
<a href="#l26.1481"></a><span id="l26.1481" class="difflineplus">+            *result = true;</span>
<a href="#l26.1482"></a><span id="l26.1482" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.1483"></a><span id="l26.1483" class="difflineplus">+        }</span>
<a href="#l26.1484"></a><span id="l26.1484" class="difflineplus">+        ass = ass-&gt;mNext;</span>
<a href="#l26.1485"></a><span id="l26.1485" class="difflineplus">+    }</span>
<a href="#l26.1486"></a><span id="l26.1486" class="difflineplus">+    while (ass) {</span>
<a href="#l26.1487"></a><span id="l26.1487" class="difflineplus">+        nsIRDFResource* elbow = ass-&gt;u.as.mProperty;</span>
<a href="#l26.1488"></a><span id="l26.1488" class="difflineplus">+        if (elbow == aArc) {</span>
<a href="#l26.1489"></a><span id="l26.1489" class="difflineplus">+            *result = true;</span>
<a href="#l26.1490"></a><span id="l26.1490" class="difflineplus">+            return NS_OK;</span>
<a href="#l26.1491"></a><span id="l26.1491" class="difflineplus">+        }</span>
<a href="#l26.1492"></a><span id="l26.1492" class="difflineplus">+        ass = ass-&gt;mNext;</span>
<a href="#l26.1493"></a><span id="l26.1493" class="difflineplus">+    }</span>
<a href="#l26.1494"></a><span id="l26.1494" class="difflineplus">+    *result = false;</span>
<a href="#l26.1495"></a><span id="l26.1495" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1496"></a><span id="l26.1496" class="difflineplus">+}</span>
<a href="#l26.1497"></a><span id="l26.1497" class="difflineplus">+</span>
<a href="#l26.1498"></a><span id="l26.1498" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1499"></a><span id="l26.1499" class="difflineplus">+InMemoryDataSource::ArcLabelsIn(nsIRDFNode* aTarget, nsISimpleEnumerator** aResult)</span>
<a href="#l26.1500"></a><span id="l26.1500" class="difflineplus">+{</span>
<a href="#l26.1501"></a><span id="l26.1501" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1502"></a><span id="l26.1502" class="difflineplus">+    if (! aTarget)</span>
<a href="#l26.1503"></a><span id="l26.1503" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1504"></a><span id="l26.1504" class="difflineplus">+</span>
<a href="#l26.1505"></a><span id="l26.1505" class="difflineplus">+    InMemoryArcsEnumeratorImpl* result =</span>
<a href="#l26.1506"></a><span id="l26.1506" class="difflineplus">+        new InMemoryArcsEnumeratorImpl(this, nullptr, aTarget);</span>
<a href="#l26.1507"></a><span id="l26.1507" class="difflineplus">+</span>
<a href="#l26.1508"></a><span id="l26.1508" class="difflineplus">+    if (! result)</span>
<a href="#l26.1509"></a><span id="l26.1509" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l26.1510"></a><span id="l26.1510" class="difflineplus">+</span>
<a href="#l26.1511"></a><span id="l26.1511" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l26.1512"></a><span id="l26.1512" class="difflineplus">+    *aResult = result;</span>
<a href="#l26.1513"></a><span id="l26.1513" class="difflineplus">+</span>
<a href="#l26.1514"></a><span id="l26.1514" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1515"></a><span id="l26.1515" class="difflineplus">+}</span>
<a href="#l26.1516"></a><span id="l26.1516" class="difflineplus">+</span>
<a href="#l26.1517"></a><span id="l26.1517" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1518"></a><span id="l26.1518" class="difflineplus">+InMemoryDataSource::ArcLabelsOut(nsIRDFResource* aSource, nsISimpleEnumerator** aResult)</span>
<a href="#l26.1519"></a><span id="l26.1519" class="difflineplus">+{</span>
<a href="#l26.1520"></a><span id="l26.1520" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1521"></a><span id="l26.1521" class="difflineplus">+    if (! aSource)</span>
<a href="#l26.1522"></a><span id="l26.1522" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1523"></a><span id="l26.1523" class="difflineplus">+</span>
<a href="#l26.1524"></a><span id="l26.1524" class="difflineplus">+    InMemoryArcsEnumeratorImpl* result =</span>
<a href="#l26.1525"></a><span id="l26.1525" class="difflineplus">+        new InMemoryArcsEnumeratorImpl(this, aSource, nullptr);</span>
<a href="#l26.1526"></a><span id="l26.1526" class="difflineplus">+</span>
<a href="#l26.1527"></a><span id="l26.1527" class="difflineplus">+    if (! result)</span>
<a href="#l26.1528"></a><span id="l26.1528" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l26.1529"></a><span id="l26.1529" class="difflineplus">+</span>
<a href="#l26.1530"></a><span id="l26.1530" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l26.1531"></a><span id="l26.1531" class="difflineplus">+    *aResult = result;</span>
<a href="#l26.1532"></a><span id="l26.1532" class="difflineplus">+</span>
<a href="#l26.1533"></a><span id="l26.1533" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1534"></a><span id="l26.1534" class="difflineplus">+}</span>
<a href="#l26.1535"></a><span id="l26.1535" class="difflineplus">+</span>
<a href="#l26.1536"></a><span id="l26.1536" class="difflineplus">+</span>
<a href="#l26.1537"></a><span id="l26.1537" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1538"></a><span id="l26.1538" class="difflineplus">+InMemoryDataSource::GetAllResources(nsISimpleEnumerator** aResult)</span>
<a href="#l26.1539"></a><span id="l26.1539" class="difflineplus">+{</span>
<a href="#l26.1540"></a><span id="l26.1540" class="difflineplus">+    nsCOMArray&lt;nsIRDFNode&gt; nodes;</span>
<a href="#l26.1541"></a><span id="l26.1541" class="difflineplus">+    nodes.SetCapacity(mForwardArcs.EntryCount());</span>
<a href="#l26.1542"></a><span id="l26.1542" class="difflineplus">+</span>
<a href="#l26.1543"></a><span id="l26.1543" class="difflineplus">+    // Get all of our entries into an nsCOMArray</span>
<a href="#l26.1544"></a><span id="l26.1544" class="difflineplus">+    for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l26.1545"></a><span id="l26.1545" class="difflineplus">+        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l26.1546"></a><span id="l26.1546" class="difflineplus">+        nodes.AppendObject(entry-&gt;mNode);</span>
<a href="#l26.1547"></a><span id="l26.1547" class="difflineplus">+    }</span>
<a href="#l26.1548"></a><span id="l26.1548" class="difflineplus">+    return NS_NewArrayEnumerator(aResult, nodes);</span>
<a href="#l26.1549"></a><span id="l26.1549" class="difflineplus">+}</span>
<a href="#l26.1550"></a><span id="l26.1550" class="difflineplus">+</span>
<a href="#l26.1551"></a><span id="l26.1551" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1552"></a><span id="l26.1552" class="difflineplus">+InMemoryDataSource::GetAllCmds(nsIRDFResource* source,</span>
<a href="#l26.1553"></a><span id="l26.1553" class="difflineplus">+                               nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands)</span>
<a href="#l26.1554"></a><span id="l26.1554" class="difflineplus">+{</span>
<a href="#l26.1555"></a><span id="l26.1555" class="difflineplus">+    return(NS_NewEmptyEnumerator(commands));</span>
<a href="#l26.1556"></a><span id="l26.1556" class="difflineplus">+}</span>
<a href="#l26.1557"></a><span id="l26.1557" class="difflineplus">+</span>
<a href="#l26.1558"></a><span id="l26.1558" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1559"></a><span id="l26.1559" class="difflineplus">+InMemoryDataSource::IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l26.1560"></a><span id="l26.1560" class="difflineplus">+                                     nsIRDFResource*   aCommand,</span>
<a href="#l26.1561"></a><span id="l26.1561" class="difflineplus">+                                     nsISupports* aArguments,</span>
<a href="#l26.1562"></a><span id="l26.1562" class="difflineplus">+                                     bool* aResult)</span>
<a href="#l26.1563"></a><span id="l26.1563" class="difflineplus">+{</span>
<a href="#l26.1564"></a><span id="l26.1564" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l26.1565"></a><span id="l26.1565" class="difflineplus">+}</span>
<a href="#l26.1566"></a><span id="l26.1566" class="difflineplus">+</span>
<a href="#l26.1567"></a><span id="l26.1567" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1568"></a><span id="l26.1568" class="difflineplus">+InMemoryDataSource::DoCommand(nsISupports* aSources,</span>
<a href="#l26.1569"></a><span id="l26.1569" class="difflineplus">+                              nsIRDFResource*   aCommand,</span>
<a href="#l26.1570"></a><span id="l26.1570" class="difflineplus">+                              nsISupports* aArguments)</span>
<a href="#l26.1571"></a><span id="l26.1571" class="difflineplus">+{</span>
<a href="#l26.1572"></a><span id="l26.1572" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l26.1573"></a><span id="l26.1573" class="difflineplus">+}</span>
<a href="#l26.1574"></a><span id="l26.1574" class="difflineplus">+</span>
<a href="#l26.1575"></a><span id="l26.1575" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1576"></a><span id="l26.1576" class="difflineplus">+InMemoryDataSource::BeginUpdateBatch()</span>
<a href="#l26.1577"></a><span id="l26.1577" class="difflineplus">+{</span>
<a href="#l26.1578"></a><span id="l26.1578" class="difflineplus">+    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1579"></a><span id="l26.1579" class="difflineplus">+        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1580"></a><span id="l26.1580" class="difflineplus">+        obs-&gt;OnBeginUpdateBatch(this);</span>
<a href="#l26.1581"></a><span id="l26.1581" class="difflineplus">+    }</span>
<a href="#l26.1582"></a><span id="l26.1582" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1583"></a><span id="l26.1583" class="difflineplus">+}</span>
<a href="#l26.1584"></a><span id="l26.1584" class="difflineplus">+</span>
<a href="#l26.1585"></a><span id="l26.1585" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1586"></a><span id="l26.1586" class="difflineplus">+InMemoryDataSource::EndUpdateBatch()</span>
<a href="#l26.1587"></a><span id="l26.1587" class="difflineplus">+{</span>
<a href="#l26.1588"></a><span id="l26.1588" class="difflineplus">+    for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1589"></a><span id="l26.1589" class="difflineplus">+        nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1590"></a><span id="l26.1590" class="difflineplus">+        obs-&gt;OnEndUpdateBatch(this);</span>
<a href="#l26.1591"></a><span id="l26.1591" class="difflineplus">+    }</span>
<a href="#l26.1592"></a><span id="l26.1592" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1593"></a><span id="l26.1593" class="difflineplus">+}</span>
<a href="#l26.1594"></a><span id="l26.1594" class="difflineplus">+</span>
<a href="#l26.1595"></a><span id="l26.1595" class="difflineplus">+</span>
<a href="#l26.1596"></a><span id="l26.1596" class="difflineplus">+</span>
<a href="#l26.1597"></a><span id="l26.1597" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.1598"></a><span id="l26.1598" class="difflineplus">+// nsIRDFInMemoryDataSource methods</span>
<a href="#l26.1599"></a><span id="l26.1599" class="difflineplus">+</span>
<a href="#l26.1600"></a><span id="l26.1600" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1601"></a><span id="l26.1601" class="difflineplus">+InMemoryDataSource::EnsureFastContainment(nsIRDFResource* aSource)</span>
<a href="#l26.1602"></a><span id="l26.1602" class="difflineplus">+{</span>
<a href="#l26.1603"></a><span id="l26.1603" class="difflineplus">+    Assertion *as = GetForwardArcs(aSource);</span>
<a href="#l26.1604"></a><span id="l26.1604" class="difflineplus">+    bool    haveHash = (as) ? as-&gt;mHashEntry : false;</span>
<a href="#l26.1605"></a><span id="l26.1605" class="difflineplus">+</span>
<a href="#l26.1606"></a><span id="l26.1606" class="difflineplus">+    // if its already a hash, then nothing to do</span>
<a href="#l26.1607"></a><span id="l26.1607" class="difflineplus">+    if (haveHash)   return(NS_OK);</span>
<a href="#l26.1608"></a><span id="l26.1608" class="difflineplus">+</span>
<a href="#l26.1609"></a><span id="l26.1609" class="difflineplus">+    // convert aSource in forward hash into a hash</span>
<a href="#l26.1610"></a><span id="l26.1610" class="difflineplus">+    Assertion *hashAssertion = new Assertion(aSource);</span>
<a href="#l26.1611"></a><span id="l26.1611" class="difflineplus">+    NS_ASSERTION(hashAssertion, &quot;unable to create Assertion&quot;);</span>
<a href="#l26.1612"></a><span id="l26.1612" class="difflineplus">+    if (!hashAssertion) return(NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l26.1613"></a><span id="l26.1613" class="difflineplus">+</span>
<a href="#l26.1614"></a><span id="l26.1614" class="difflineplus">+    // Add the datasource's owning reference.</span>
<a href="#l26.1615"></a><span id="l26.1615" class="difflineplus">+    hashAssertion-&gt;AddRef();</span>
<a href="#l26.1616"></a><span id="l26.1616" class="difflineplus">+</span>
<a href="#l26.1617"></a><span id="l26.1617" class="difflineplus">+    Assertion *first = GetForwardArcs(aSource);</span>
<a href="#l26.1618"></a><span id="l26.1618" class="difflineplus">+    SetForwardArcs(aSource, hashAssertion);</span>
<a href="#l26.1619"></a><span id="l26.1619" class="difflineplus">+</span>
<a href="#l26.1620"></a><span id="l26.1620" class="difflineplus">+    // mutate references of existing forward assertions into this hash</span>
<a href="#l26.1621"></a><span id="l26.1621" class="difflineplus">+    PLDHashTable *table = hashAssertion-&gt;u.hash.mPropertyHash;</span>
<a href="#l26.1622"></a><span id="l26.1622" class="difflineplus">+    Assertion *nextRef;</span>
<a href="#l26.1623"></a><span id="l26.1623" class="difflineplus">+    while(first) {</span>
<a href="#l26.1624"></a><span id="l26.1624" class="difflineplus">+        nextRef = first-&gt;mNext;</span>
<a href="#l26.1625"></a><span id="l26.1625" class="difflineplus">+        nsIRDFResource *prop = first-&gt;u.as.mProperty;</span>
<a href="#l26.1626"></a><span id="l26.1626" class="difflineplus">+</span>
<a href="#l26.1627"></a><span id="l26.1627" class="difflineplus">+        PLDHashEntryHdr* hdr = table-&gt;Search(prop);</span>
<a href="#l26.1628"></a><span id="l26.1628" class="difflineplus">+        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.1629"></a><span id="l26.1629" class="difflineplus">+        if (val) {</span>
<a href="#l26.1630"></a><span id="l26.1630" class="difflineplus">+            first-&gt;mNext = val-&gt;mNext;</span>
<a href="#l26.1631"></a><span id="l26.1631" class="difflineplus">+            val-&gt;mNext = first;</span>
<a href="#l26.1632"></a><span id="l26.1632" class="difflineplus">+        }</span>
<a href="#l26.1633"></a><span id="l26.1633" class="difflineplus">+        else {</span>
<a href="#l26.1634"></a><span id="l26.1634" class="difflineplus">+            PLDHashEntryHdr* hdr = table-&gt;Add(prop, mozilla::fallible);</span>
<a href="#l26.1635"></a><span id="l26.1635" class="difflineplus">+            if (hdr) {</span>
<a href="#l26.1636"></a><span id="l26.1636" class="difflineplus">+                Entry* entry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l26.1637"></a><span id="l26.1637" class="difflineplus">+                entry-&gt;mNode = prop;</span>
<a href="#l26.1638"></a><span id="l26.1638" class="difflineplus">+                entry-&gt;mAssertions = first;</span>
<a href="#l26.1639"></a><span id="l26.1639" class="difflineplus">+                first-&gt;mNext = nullptr;</span>
<a href="#l26.1640"></a><span id="l26.1640" class="difflineplus">+            }</span>
<a href="#l26.1641"></a><span id="l26.1641" class="difflineplus">+        }</span>
<a href="#l26.1642"></a><span id="l26.1642" class="difflineplus">+        first = nextRef;</span>
<a href="#l26.1643"></a><span id="l26.1643" class="difflineplus">+    }</span>
<a href="#l26.1644"></a><span id="l26.1644" class="difflineplus">+    return(NS_OK);</span>
<a href="#l26.1645"></a><span id="l26.1645" class="difflineplus">+}</span>
<a href="#l26.1646"></a><span id="l26.1646" class="difflineplus">+</span>
<a href="#l26.1647"></a><span id="l26.1647" class="difflineplus">+</span>
<a href="#l26.1648"></a><span id="l26.1648" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.1649"></a><span id="l26.1649" class="difflineplus">+// nsIRDFPropagatableDataSource methods</span>
<a href="#l26.1650"></a><span id="l26.1650" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1651"></a><span id="l26.1651" class="difflineplus">+InMemoryDataSource::GetPropagateChanges(bool* aPropagateChanges)</span>
<a href="#l26.1652"></a><span id="l26.1652" class="difflineplus">+{</span>
<a href="#l26.1653"></a><span id="l26.1653" class="difflineplus">+    *aPropagateChanges = mPropagateChanges;</span>
<a href="#l26.1654"></a><span id="l26.1654" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1655"></a><span id="l26.1655" class="difflineplus">+}</span>
<a href="#l26.1656"></a><span id="l26.1656" class="difflineplus">+</span>
<a href="#l26.1657"></a><span id="l26.1657" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1658"></a><span id="l26.1658" class="difflineplus">+InMemoryDataSource::SetPropagateChanges(bool aPropagateChanges)</span>
<a href="#l26.1659"></a><span id="l26.1659" class="difflineplus">+{</span>
<a href="#l26.1660"></a><span id="l26.1660" class="difflineplus">+    mPropagateChanges = aPropagateChanges;</span>
<a href="#l26.1661"></a><span id="l26.1661" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1662"></a><span id="l26.1662" class="difflineplus">+}</span>
<a href="#l26.1663"></a><span id="l26.1663" class="difflineplus">+</span>
<a href="#l26.1664"></a><span id="l26.1664" class="difflineplus">+</span>
<a href="#l26.1665"></a><span id="l26.1665" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.1666"></a><span id="l26.1666" class="difflineplus">+// nsIRDFPurgeableDataSource methods</span>
<a href="#l26.1667"></a><span id="l26.1667" class="difflineplus">+</span>
<a href="#l26.1668"></a><span id="l26.1668" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1669"></a><span id="l26.1669" class="difflineplus">+InMemoryDataSource::Mark(nsIRDFResource* aSource,</span>
<a href="#l26.1670"></a><span id="l26.1670" class="difflineplus">+                         nsIRDFResource* aProperty,</span>
<a href="#l26.1671"></a><span id="l26.1671" class="difflineplus">+                         nsIRDFNode* aTarget,</span>
<a href="#l26.1672"></a><span id="l26.1672" class="difflineplus">+                         bool aTruthValue,</span>
<a href="#l26.1673"></a><span id="l26.1673" class="difflineplus">+                         bool* aDidMark)</span>
<a href="#l26.1674"></a><span id="l26.1674" class="difflineplus">+{</span>
<a href="#l26.1675"></a><span id="l26.1675" class="difflineplus">+    NS_PRECONDITION(aSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1676"></a><span id="l26.1676" class="difflineplus">+    if (! aSource)</span>
<a href="#l26.1677"></a><span id="l26.1677" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1678"></a><span id="l26.1678" class="difflineplus">+</span>
<a href="#l26.1679"></a><span id="l26.1679" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1680"></a><span id="l26.1680" class="difflineplus">+    if (! aProperty)</span>
<a href="#l26.1681"></a><span id="l26.1681" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1682"></a><span id="l26.1682" class="difflineplus">+</span>
<a href="#l26.1683"></a><span id="l26.1683" class="difflineplus">+    NS_PRECONDITION(aTarget != nullptr, &quot;null ptr&quot;);</span>
<a href="#l26.1684"></a><span id="l26.1684" class="difflineplus">+    if (! aTarget)</span>
<a href="#l26.1685"></a><span id="l26.1685" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l26.1686"></a><span id="l26.1686" class="difflineplus">+</span>
<a href="#l26.1687"></a><span id="l26.1687" class="difflineplus">+    Assertion *as = GetForwardArcs(aSource);</span>
<a href="#l26.1688"></a><span id="l26.1688" class="difflineplus">+    if (as &amp;&amp; as-&gt;mHashEntry) {</span>
<a href="#l26.1689"></a><span id="l26.1689" class="difflineplus">+        PLDHashEntryHdr* hdr = as-&gt;u.hash.mPropertyHash-&gt;Search(aProperty);</span>
<a href="#l26.1690"></a><span id="l26.1690" class="difflineplus">+        Assertion* val = hdr ? static_cast&lt;Entry*&gt;(hdr)-&gt;mAssertions : nullptr;</span>
<a href="#l26.1691"></a><span id="l26.1691" class="difflineplus">+        while (val) {</span>
<a href="#l26.1692"></a><span id="l26.1692" class="difflineplus">+            if ((val-&gt;u.as.mTarget == aTarget) &amp;&amp;</span>
<a href="#l26.1693"></a><span id="l26.1693" class="difflineplus">+                (aTruthValue == (val-&gt;u.as.mTruthValue))) {</span>
<a href="#l26.1694"></a><span id="l26.1694" class="difflineplus">+</span>
<a href="#l26.1695"></a><span id="l26.1695" class="difflineplus">+                // found it! so mark it.</span>
<a href="#l26.1696"></a><span id="l26.1696" class="difflineplus">+                as-&gt;Mark();</span>
<a href="#l26.1697"></a><span id="l26.1697" class="difflineplus">+                *aDidMark = true;</span>
<a href="#l26.1698"></a><span id="l26.1698" class="difflineplus">+</span>
<a href="#l26.1699"></a><span id="l26.1699" class="difflineplus">+                LogOperation(&quot;MARK&quot;, aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l26.1700"></a><span id="l26.1700" class="difflineplus">+</span>
<a href="#l26.1701"></a><span id="l26.1701" class="difflineplus">+                return NS_OK;</span>
<a href="#l26.1702"></a><span id="l26.1702" class="difflineplus">+            }</span>
<a href="#l26.1703"></a><span id="l26.1703" class="difflineplus">+            val = val-&gt;mNext;</span>
<a href="#l26.1704"></a><span id="l26.1704" class="difflineplus">+        }</span>
<a href="#l26.1705"></a><span id="l26.1705" class="difflineplus">+    }</span>
<a href="#l26.1706"></a><span id="l26.1706" class="difflineplus">+    else for (; as != nullptr; as = as-&gt;mNext) {</span>
<a href="#l26.1707"></a><span id="l26.1707" class="difflineplus">+        // check target first as its most unique</span>
<a href="#l26.1708"></a><span id="l26.1708" class="difflineplus">+        if (aTarget != as-&gt;u.as.mTarget)</span>
<a href="#l26.1709"></a><span id="l26.1709" class="difflineplus">+            continue;</span>
<a href="#l26.1710"></a><span id="l26.1710" class="difflineplus">+</span>
<a href="#l26.1711"></a><span id="l26.1711" class="difflineplus">+        if (aProperty != as-&gt;u.as.mProperty)</span>
<a href="#l26.1712"></a><span id="l26.1712" class="difflineplus">+            continue;</span>
<a href="#l26.1713"></a><span id="l26.1713" class="difflineplus">+</span>
<a href="#l26.1714"></a><span id="l26.1714" class="difflineplus">+        if (aTruthValue != (as-&gt;u.as.mTruthValue))</span>
<a href="#l26.1715"></a><span id="l26.1715" class="difflineplus">+            continue;</span>
<a href="#l26.1716"></a><span id="l26.1716" class="difflineplus">+</span>
<a href="#l26.1717"></a><span id="l26.1717" class="difflineplus">+        // found it! so mark it.</span>
<a href="#l26.1718"></a><span id="l26.1718" class="difflineplus">+        as-&gt;Mark();</span>
<a href="#l26.1719"></a><span id="l26.1719" class="difflineplus">+        *aDidMark = true;</span>
<a href="#l26.1720"></a><span id="l26.1720" class="difflineplus">+</span>
<a href="#l26.1721"></a><span id="l26.1721" class="difflineplus">+        LogOperation(&quot;MARK&quot;, aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l26.1722"></a><span id="l26.1722" class="difflineplus">+</span>
<a href="#l26.1723"></a><span id="l26.1723" class="difflineplus">+        return NS_OK;</span>
<a href="#l26.1724"></a><span id="l26.1724" class="difflineplus">+    }</span>
<a href="#l26.1725"></a><span id="l26.1725" class="difflineplus">+</span>
<a href="#l26.1726"></a><span id="l26.1726" class="difflineplus">+    // If we get here, we couldn't find the assertion</span>
<a href="#l26.1727"></a><span id="l26.1727" class="difflineplus">+    *aDidMark = false;</span>
<a href="#l26.1728"></a><span id="l26.1728" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1729"></a><span id="l26.1729" class="difflineplus">+}</span>
<a href="#l26.1730"></a><span id="l26.1730" class="difflineplus">+</span>
<a href="#l26.1731"></a><span id="l26.1731" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1732"></a><span id="l26.1732" class="difflineplus">+InMemoryDataSource::Sweep()</span>
<a href="#l26.1733"></a><span id="l26.1733" class="difflineplus">+{</span>
<a href="#l26.1734"></a><span id="l26.1734" class="difflineplus">+    SweepInfo info = { nullptr, &amp;mReverseArcs };</span>
<a href="#l26.1735"></a><span id="l26.1735" class="difflineplus">+</span>
<a href="#l26.1736"></a><span id="l26.1736" class="difflineplus">+    // Remove all the assertions, but don't notify anyone.</span>
<a href="#l26.1737"></a><span id="l26.1737" class="difflineplus">+    SweepForwardArcsEntries(&amp;mForwardArcs, &amp;info);</span>
<a href="#l26.1738"></a><span id="l26.1738" class="difflineplus">+</span>
<a href="#l26.1739"></a><span id="l26.1739" class="difflineplus">+    // Now do the notification.</span>
<a href="#l26.1740"></a><span id="l26.1740" class="difflineplus">+    Assertion* as = info.mUnassertList;</span>
<a href="#l26.1741"></a><span id="l26.1741" class="difflineplus">+    while (as) {</span>
<a href="#l26.1742"></a><span id="l26.1742" class="difflineplus">+        LogOperation(&quot;SWEEP&quot;, as-&gt;mSource, as-&gt;u.as.mProperty, as-&gt;u.as.mTarget, as-&gt;u.as.mTruthValue);</span>
<a href="#l26.1743"></a><span id="l26.1743" class="difflineplus">+        if (!(as-&gt;mHashEntry))</span>
<a href="#l26.1744"></a><span id="l26.1744" class="difflineplus">+        {</span>
<a href="#l26.1745"></a><span id="l26.1745" class="difflineplus">+            for (int32_t i = int32_t(mNumObservers) - 1; mPropagateChanges &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l26.1746"></a><span id="l26.1746" class="difflineplus">+                nsIRDFObserver* obs = mObservers[i];</span>
<a href="#l26.1747"></a><span id="l26.1747" class="difflineplus">+                // XXXbz other loops over mObservers null-check |obs| here!</span>
<a href="#l26.1748"></a><span id="l26.1748" class="difflineplus">+                obs-&gt;OnUnassert(this, as-&gt;mSource, as-&gt;u.as.mProperty, as-&gt;u.as.mTarget);</span>
<a href="#l26.1749"></a><span id="l26.1749" class="difflineplus">+                // XXX ignore return value?</span>
<a href="#l26.1750"></a><span id="l26.1750" class="difflineplus">+            }</span>
<a href="#l26.1751"></a><span id="l26.1751" class="difflineplus">+        }</span>
<a href="#l26.1752"></a><span id="l26.1752" class="difflineplus">+</span>
<a href="#l26.1753"></a><span id="l26.1753" class="difflineplus">+        Assertion* doomed = as;</span>
<a href="#l26.1754"></a><span id="l26.1754" class="difflineplus">+        as = as-&gt;mNext;</span>
<a href="#l26.1755"></a><span id="l26.1755" class="difflineplus">+</span>
<a href="#l26.1756"></a><span id="l26.1756" class="difflineplus">+        // Unlink, and release the datasource's reference</span>
<a href="#l26.1757"></a><span id="l26.1757" class="difflineplus">+        doomed-&gt;mNext = doomed-&gt;u.as.mInvNext = nullptr;</span>
<a href="#l26.1758"></a><span id="l26.1758" class="difflineplus">+        doomed-&gt;Release();</span>
<a href="#l26.1759"></a><span id="l26.1759" class="difflineplus">+    }</span>
<a href="#l26.1760"></a><span id="l26.1760" class="difflineplus">+</span>
<a href="#l26.1761"></a><span id="l26.1761" class="difflineplus">+    return NS_OK;</span>
<a href="#l26.1762"></a><span id="l26.1762" class="difflineplus">+}</span>
<a href="#l26.1763"></a><span id="l26.1763" class="difflineplus">+</span>
<a href="#l26.1764"></a><span id="l26.1764" class="difflineplus">+</span>
<a href="#l26.1765"></a><span id="l26.1765" class="difflineplus">+void</span>
<a href="#l26.1766"></a><span id="l26.1766" class="difflineplus">+InMemoryDataSource::SweepForwardArcsEntries(PLDHashTable* aTable,</span>
<a href="#l26.1767"></a><span id="l26.1767" class="difflineplus">+                                            SweepInfo* aInfo)</span>
<a href="#l26.1768"></a><span id="l26.1768" class="difflineplus">+{</span>
<a href="#l26.1769"></a><span id="l26.1769" class="difflineplus">+    for (auto iter = aTable-&gt;Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l26.1770"></a><span id="l26.1770" class="difflineplus">+        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l26.1771"></a><span id="l26.1771" class="difflineplus">+</span>
<a href="#l26.1772"></a><span id="l26.1772" class="difflineplus">+        Assertion* as = entry-&gt;mAssertions;</span>
<a href="#l26.1773"></a><span id="l26.1773" class="difflineplus">+        if (as &amp;&amp; (as-&gt;mHashEntry)) {</span>
<a href="#l26.1774"></a><span id="l26.1774" class="difflineplus">+            // Stuff in sub-hashes must be swept recursively (max depth: 1)</span>
<a href="#l26.1775"></a><span id="l26.1775" class="difflineplus">+            SweepForwardArcsEntries(as-&gt;u.hash.mPropertyHash, aInfo);</span>
<a href="#l26.1776"></a><span id="l26.1776" class="difflineplus">+</span>
<a href="#l26.1777"></a><span id="l26.1777" class="difflineplus">+            // If the sub-hash is now empty, clean it up.</span>
<a href="#l26.1778"></a><span id="l26.1778" class="difflineplus">+            if (!as-&gt;u.hash.mPropertyHash-&gt;EntryCount()) {</span>
<a href="#l26.1779"></a><span id="l26.1779" class="difflineplus">+                as-&gt;Release();</span>
<a href="#l26.1780"></a><span id="l26.1780" class="difflineplus">+                iter.Remove();</span>
<a href="#l26.1781"></a><span id="l26.1781" class="difflineplus">+            }</span>
<a href="#l26.1782"></a><span id="l26.1782" class="difflineplus">+            continue;</span>
<a href="#l26.1783"></a><span id="l26.1783" class="difflineplus">+        }</span>
<a href="#l26.1784"></a><span id="l26.1784" class="difflineplus">+</span>
<a href="#l26.1785"></a><span id="l26.1785" class="difflineplus">+        Assertion* prev = nullptr;</span>
<a href="#l26.1786"></a><span id="l26.1786" class="difflineplus">+        while (as) {</span>
<a href="#l26.1787"></a><span id="l26.1787" class="difflineplus">+            if (as-&gt;IsMarked()) {</span>
<a href="#l26.1788"></a><span id="l26.1788" class="difflineplus">+                prev = as;</span>
<a href="#l26.1789"></a><span id="l26.1789" class="difflineplus">+                as-&gt;Unmark();</span>
<a href="#l26.1790"></a><span id="l26.1790" class="difflineplus">+                as = as-&gt;mNext;</span>
<a href="#l26.1791"></a><span id="l26.1791" class="difflineplus">+            }</span>
<a href="#l26.1792"></a><span id="l26.1792" class="difflineplus">+            else {</span>
<a href="#l26.1793"></a><span id="l26.1793" class="difflineplus">+                // remove from the list of assertions in the datasource</span>
<a href="#l26.1794"></a><span id="l26.1794" class="difflineplus">+                Assertion* next = as-&gt;mNext;</span>
<a href="#l26.1795"></a><span id="l26.1795" class="difflineplus">+                if (prev) {</span>
<a href="#l26.1796"></a><span id="l26.1796" class="difflineplus">+                    prev-&gt;mNext = next;</span>
<a href="#l26.1797"></a><span id="l26.1797" class="difflineplus">+                }</span>
<a href="#l26.1798"></a><span id="l26.1798" class="difflineplus">+                else {</span>
<a href="#l26.1799"></a><span id="l26.1799" class="difflineplus">+                    // it's the first one. update the hashtable entry.</span>
<a href="#l26.1800"></a><span id="l26.1800" class="difflineplus">+                    entry-&gt;mAssertions = next;</span>
<a href="#l26.1801"></a><span id="l26.1801" class="difflineplus">+                }</span>
<a href="#l26.1802"></a><span id="l26.1802" class="difflineplus">+</span>
<a href="#l26.1803"></a><span id="l26.1803" class="difflineplus">+                // remove from the reverse arcs</span>
<a href="#l26.1804"></a><span id="l26.1804" class="difflineplus">+                PLDHashEntryHdr* hdr =</span>
<a href="#l26.1805"></a><span id="l26.1805" class="difflineplus">+                    aInfo-&gt;mReverseArcs-&gt;Search(as-&gt;u.as.mTarget);</span>
<a href="#l26.1806"></a><span id="l26.1806" class="difflineplus">+                NS_ASSERTION(hdr, &quot;no assertion in reverse arcs&quot;);</span>
<a href="#l26.1807"></a><span id="l26.1807" class="difflineplus">+</span>
<a href="#l26.1808"></a><span id="l26.1808" class="difflineplus">+                Entry* rentry = static_cast&lt;Entry*&gt;(hdr);</span>
<a href="#l26.1809"></a><span id="l26.1809" class="difflineplus">+                Assertion* ras = rentry-&gt;mAssertions;</span>
<a href="#l26.1810"></a><span id="l26.1810" class="difflineplus">+                Assertion* rprev = nullptr;</span>
<a href="#l26.1811"></a><span id="l26.1811" class="difflineplus">+                while (ras) {</span>
<a href="#l26.1812"></a><span id="l26.1812" class="difflineplus">+                    if (ras == as) {</span>
<a href="#l26.1813"></a><span id="l26.1813" class="difflineplus">+                        if (rprev) {</span>
<a href="#l26.1814"></a><span id="l26.1814" class="difflineplus">+                            rprev-&gt;u.as.mInvNext = ras-&gt;u.as.mInvNext;</span>
<a href="#l26.1815"></a><span id="l26.1815" class="difflineplus">+                        }</span>
<a href="#l26.1816"></a><span id="l26.1816" class="difflineplus">+                        else {</span>
<a href="#l26.1817"></a><span id="l26.1817" class="difflineplus">+                            // it's the first one. update the hashtable entry.</span>
<a href="#l26.1818"></a><span id="l26.1818" class="difflineplus">+                            rentry-&gt;mAssertions = ras-&gt;u.as.mInvNext;</span>
<a href="#l26.1819"></a><span id="l26.1819" class="difflineplus">+                        }</span>
<a href="#l26.1820"></a><span id="l26.1820" class="difflineplus">+                        as-&gt;u.as.mInvNext = nullptr; // for my sanity.</span>
<a href="#l26.1821"></a><span id="l26.1821" class="difflineplus">+                        break;</span>
<a href="#l26.1822"></a><span id="l26.1822" class="difflineplus">+                    }</span>
<a href="#l26.1823"></a><span id="l26.1823" class="difflineplus">+                    rprev = ras;</span>
<a href="#l26.1824"></a><span id="l26.1824" class="difflineplus">+                    ras = ras-&gt;u.as.mInvNext;</span>
<a href="#l26.1825"></a><span id="l26.1825" class="difflineplus">+                }</span>
<a href="#l26.1826"></a><span id="l26.1826" class="difflineplus">+</span>
<a href="#l26.1827"></a><span id="l26.1827" class="difflineplus">+                // Wow, it was the _only_ one. Unhash it.</span>
<a href="#l26.1828"></a><span id="l26.1828" class="difflineplus">+                if (! rentry-&gt;mAssertions) {</span>
<a href="#l26.1829"></a><span id="l26.1829" class="difflineplus">+                    aInfo-&gt;mReverseArcs-&gt;RawRemove(hdr);</span>
<a href="#l26.1830"></a><span id="l26.1830" class="difflineplus">+                }</span>
<a href="#l26.1831"></a><span id="l26.1831" class="difflineplus">+</span>
<a href="#l26.1832"></a><span id="l26.1832" class="difflineplus">+                // add to the list of assertions to unassert</span>
<a href="#l26.1833"></a><span id="l26.1833" class="difflineplus">+                as-&gt;mNext = aInfo-&gt;mUnassertList;</span>
<a href="#l26.1834"></a><span id="l26.1834" class="difflineplus">+                aInfo-&gt;mUnassertList = as;</span>
<a href="#l26.1835"></a><span id="l26.1835" class="difflineplus">+</span>
<a href="#l26.1836"></a><span id="l26.1836" class="difflineplus">+                // Advance to the next assertion</span>
<a href="#l26.1837"></a><span id="l26.1837" class="difflineplus">+                as = next;</span>
<a href="#l26.1838"></a><span id="l26.1838" class="difflineplus">+            }</span>
<a href="#l26.1839"></a><span id="l26.1839" class="difflineplus">+        }</span>
<a href="#l26.1840"></a><span id="l26.1840" class="difflineplus">+</span>
<a href="#l26.1841"></a><span id="l26.1841" class="difflineplus">+        // if no more assertions exist for this resource, then unhash it.</span>
<a href="#l26.1842"></a><span id="l26.1842" class="difflineplus">+        if (! entry-&gt;mAssertions) {</span>
<a href="#l26.1843"></a><span id="l26.1843" class="difflineplus">+            iter.Remove();</span>
<a href="#l26.1844"></a><span id="l26.1844" class="difflineplus">+        }</span>
<a href="#l26.1845"></a><span id="l26.1845" class="difflineplus">+    }</span>
<a href="#l26.1846"></a><span id="l26.1846" class="difflineplus">+}</span>
<a href="#l26.1847"></a><span id="l26.1847" class="difflineplus">+</span>
<a href="#l26.1848"></a><span id="l26.1848" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.1849"></a><span id="l26.1849" class="difflineplus">+// rdfIDataSource methods</span>
<a href="#l26.1850"></a><span id="l26.1850" class="difflineplus">+</span>
<a href="#l26.1851"></a><span id="l26.1851" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1852"></a><span id="l26.1852" class="difflineplus">+InMemoryDataSource::VisitAllSubjects(rdfITripleVisitor *aVisitor)</span>
<a href="#l26.1853"></a><span id="l26.1853" class="difflineplus">+{</span>
<a href="#l26.1854"></a><span id="l26.1854" class="difflineplus">+    // Lock datasource against writes</span>
<a href="#l26.1855"></a><span id="l26.1855" class="difflineplus">+    ++mReadCount;</span>
<a href="#l26.1856"></a><span id="l26.1856" class="difflineplus">+</span>
<a href="#l26.1857"></a><span id="l26.1857" class="difflineplus">+    // Enumerate all of our entries.</span>
<a href="#l26.1858"></a><span id="l26.1858" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l26.1859"></a><span id="l26.1859" class="difflineplus">+    for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l26.1860"></a><span id="l26.1860" class="difflineplus">+        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l26.1861"></a><span id="l26.1861" class="difflineplus">+        nsresult rv2;</span>
<a href="#l26.1862"></a><span id="l26.1862" class="difflineplus">+        nsCOMPtr&lt;nsIRDFNode&gt; subject = do_QueryInterface(entry-&gt;mNode, &amp;rv2);</span>
<a href="#l26.1863"></a><span id="l26.1863" class="difflineplus">+        if (NS_FAILED(rv2)) {</span>
<a href="#l26.1864"></a><span id="l26.1864" class="difflineplus">+            NS_WARNING(&quot;QI to nsIRDFNode failed&quot;);</span>
<a href="#l26.1865"></a><span id="l26.1865" class="difflineplus">+            continue;</span>
<a href="#l26.1866"></a><span id="l26.1866" class="difflineplus">+        }</span>
<a href="#l26.1867"></a><span id="l26.1867" class="difflineplus">+        rv = aVisitor-&gt;Visit(subject, nullptr, nullptr, true);</span>
<a href="#l26.1868"></a><span id="l26.1868" class="difflineplus">+        if (NS_FAILED(rv) || rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l26.1869"></a><span id="l26.1869" class="difflineplus">+            break;</span>
<a href="#l26.1870"></a><span id="l26.1870" class="difflineplus">+        }</span>
<a href="#l26.1871"></a><span id="l26.1871" class="difflineplus">+    }</span>
<a href="#l26.1872"></a><span id="l26.1872" class="difflineplus">+</span>
<a href="#l26.1873"></a><span id="l26.1873" class="difflineplus">+    // Unlock datasource</span>
<a href="#l26.1874"></a><span id="l26.1874" class="difflineplus">+    --mReadCount;</span>
<a href="#l26.1875"></a><span id="l26.1875" class="difflineplus">+</span>
<a href="#l26.1876"></a><span id="l26.1876" class="difflineplus">+    return rv;</span>
<a href="#l26.1877"></a><span id="l26.1877" class="difflineplus">+}</span>
<a href="#l26.1878"></a><span id="l26.1878" class="difflineplus">+</span>
<a href="#l26.1879"></a><span id="l26.1879" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l26.1880"></a><span id="l26.1880" class="difflineplus">+InMemoryDataSource::VisitAllTriples(rdfITripleVisitor *aVisitor)</span>
<a href="#l26.1881"></a><span id="l26.1881" class="difflineplus">+{</span>
<a href="#l26.1882"></a><span id="l26.1882" class="difflineplus">+    // Lock datasource against writes</span>
<a href="#l26.1883"></a><span id="l26.1883" class="difflineplus">+    ++mReadCount;</span>
<a href="#l26.1884"></a><span id="l26.1884" class="difflineplus">+</span>
<a href="#l26.1885"></a><span id="l26.1885" class="difflineplus">+    // Enumerate all of our entries.</span>
<a href="#l26.1886"></a><span id="l26.1886" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l26.1887"></a><span id="l26.1887" class="difflineplus">+    for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l26.1888"></a><span id="l26.1888" class="difflineplus">+        auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l26.1889"></a><span id="l26.1889" class="difflineplus">+</span>
<a href="#l26.1890"></a><span id="l26.1890" class="difflineplus">+        nsresult rv2;</span>
<a href="#l26.1891"></a><span id="l26.1891" class="difflineplus">+        nsCOMPtr&lt;nsIRDFNode&gt; subject = do_QueryInterface(entry-&gt;mNode, &amp;rv2);</span>
<a href="#l26.1892"></a><span id="l26.1892" class="difflineplus">+        if (NS_FAILED(rv2)) {</span>
<a href="#l26.1893"></a><span id="l26.1893" class="difflineplus">+            NS_WARNING(&quot;QI to nsIRDFNode failed&quot;);</span>
<a href="#l26.1894"></a><span id="l26.1894" class="difflineplus">+</span>
<a href="#l26.1895"></a><span id="l26.1895" class="difflineplus">+        } else if (entry-&gt;mAssertions-&gt;mHashEntry) {</span>
<a href="#l26.1896"></a><span id="l26.1896" class="difflineplus">+            for (auto iter = entry-&gt;mAssertions-&gt;u.hash.mPropertyHash-&gt;Iter();</span>
<a href="#l26.1897"></a><span id="l26.1897" class="difflineplus">+                 !iter.Done();</span>
<a href="#l26.1898"></a><span id="l26.1898" class="difflineplus">+                 iter.Next()) {</span>
<a href="#l26.1899"></a><span id="l26.1899" class="difflineplus">+                auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l26.1900"></a><span id="l26.1900" class="difflineplus">+                Assertion* assertion = entry-&gt;mAssertions;</span>
<a href="#l26.1901"></a><span id="l26.1901" class="difflineplus">+                while (assertion) {</span>
<a href="#l26.1902"></a><span id="l26.1902" class="difflineplus">+                    NS_ASSERTION(!assertion-&gt;mHashEntry, &quot;shouldn't have to hashes&quot;);</span>
<a href="#l26.1903"></a><span id="l26.1903" class="difflineplus">+                    rv = aVisitor-&gt;Visit(subject, assertion-&gt;u.as.mProperty,</span>
<a href="#l26.1904"></a><span id="l26.1904" class="difflineplus">+                                                  assertion-&gt;u.as.mTarget,</span>
<a href="#l26.1905"></a><span id="l26.1905" class="difflineplus">+                                                  assertion-&gt;u.as.mTruthValue);</span>
<a href="#l26.1906"></a><span id="l26.1906" class="difflineplus">+                    if (NS_FAILED(rv)) {</span>
<a href="#l26.1907"></a><span id="l26.1907" class="difflineplus">+                        goto end;</span>
<a href="#l26.1908"></a><span id="l26.1908" class="difflineplus">+                    }</span>
<a href="#l26.1909"></a><span id="l26.1909" class="difflineplus">+                    if (rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l26.1910"></a><span id="l26.1910" class="difflineplus">+                        goto inner_end;</span>
<a href="#l26.1911"></a><span id="l26.1911" class="difflineplus">+                    }</span>
<a href="#l26.1912"></a><span id="l26.1912" class="difflineplus">+                    assertion = assertion-&gt;mNext;</span>
<a href="#l26.1913"></a><span id="l26.1913" class="difflineplus">+                }</span>
<a href="#l26.1914"></a><span id="l26.1914" class="difflineplus">+            }</span>
<a href="#l26.1915"></a><span id="l26.1915" class="difflineplus">+</span>
<a href="#l26.1916"></a><span id="l26.1916" class="difflineplus">+        } else {</span>
<a href="#l26.1917"></a><span id="l26.1917" class="difflineplus">+            Assertion* assertion = entry-&gt;mAssertions;</span>
<a href="#l26.1918"></a><span id="l26.1918" class="difflineplus">+            while (assertion) {</span>
<a href="#l26.1919"></a><span id="l26.1919" class="difflineplus">+                NS_ASSERTION(!assertion-&gt;mHashEntry, &quot;shouldn't have to hashes&quot;);</span>
<a href="#l26.1920"></a><span id="l26.1920" class="difflineplus">+                rv = aVisitor-&gt;Visit(subject, assertion-&gt;u.as.mProperty,</span>
<a href="#l26.1921"></a><span id="l26.1921" class="difflineplus">+                                              assertion-&gt;u.as.mTarget,</span>
<a href="#l26.1922"></a><span id="l26.1922" class="difflineplus">+                                              assertion-&gt;u.as.mTruthValue);</span>
<a href="#l26.1923"></a><span id="l26.1923" class="difflineplus">+                if (NS_FAILED(rv) || rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l26.1924"></a><span id="l26.1924" class="difflineplus">+                    goto end;</span>
<a href="#l26.1925"></a><span id="l26.1925" class="difflineplus">+                }</span>
<a href="#l26.1926"></a><span id="l26.1926" class="difflineplus">+                assertion = assertion-&gt;mNext;</span>
<a href="#l26.1927"></a><span id="l26.1927" class="difflineplus">+            }</span>
<a href="#l26.1928"></a><span id="l26.1928" class="difflineplus">+        }</span>
<a href="#l26.1929"></a><span id="l26.1929" class="difflineplus">+</span>
<a href="#l26.1930"></a><span id="l26.1930" class="difflineplus">+      inner_end:</span>
<a href="#l26.1931"></a><span id="l26.1931" class="difflineplus">+        (void) 0;</span>
<a href="#l26.1932"></a><span id="l26.1932" class="difflineplus">+    }</span>
<a href="#l26.1933"></a><span id="l26.1933" class="difflineplus">+</span>
<a href="#l26.1934"></a><span id="l26.1934" class="difflineplus">+  end:</span>
<a href="#l26.1935"></a><span id="l26.1935" class="difflineplus">+    // Unlock datasource</span>
<a href="#l26.1936"></a><span id="l26.1936" class="difflineplus">+    --mReadCount;</span>
<a href="#l26.1937"></a><span id="l26.1937" class="difflineplus">+</span>
<a href="#l26.1938"></a><span id="l26.1938" class="difflineplus">+    return rv;</span>
<a href="#l26.1939"></a><span id="l26.1939" class="difflineplus">+}</span>
<a href="#l26.1940"></a><span id="l26.1940" class="difflineplus">+</span>
<a href="#l26.1941"></a><span id="l26.1941" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.1942"></a><span id="l26.1942" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/rdf/base/nsNameSpaceMap.cpp</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,64 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineplus">+ *</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+#include &quot;nsNameSpaceMap.h&quot;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+nsNameSpaceMap::nsNameSpaceMap()</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+    : mEntries(nullptr)</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+{</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+    MOZ_COUNT_CTOR(nsNameSpaceMap);</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+}</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+nsNameSpaceMap::~nsNameSpaceMap()</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+{</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+    MOZ_COUNT_DTOR(nsNameSpaceMap);</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+    while (mEntries) {</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+        Entry* doomed = mEntries;</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+        mEntries = mEntries-&gt;mNext;</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+        delete doomed;</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+    }</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineplus">+}</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+nsresult</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+nsNameSpaceMap::Put(const nsAString&amp; aURI, nsAtom* aPrefix)</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+{</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+    nsCString uriUTF8;</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+    AppendUTF16toUTF8(aURI, uriUTF8);</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+    return Put(uriUTF8, aPrefix);</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+}</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+nsresult</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+nsNameSpaceMap::Put(const nsACString&amp; aURI, nsAtom* aPrefix)</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+{</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+    Entry* entry;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+    // Make sure we're not adding a duplicate</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+    for (entry = mEntries; entry != nullptr; entry = entry-&gt;mNext) {</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+        if (entry-&gt;mURI == aURI || entry-&gt;mPrefix == aPrefix)</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+            return NS_ERROR_FAILURE;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+    }</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+    entry = new Entry(aURI, aPrefix);</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+    if (! entry)</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+    entry-&gt;mNext = mEntries;</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+    mEntries = entry;</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+    return NS_OK;</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineplus">+}</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineplus">+</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineplus">+nsNameSpaceMap::const_iterator</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+nsNameSpaceMap::GetNameSpaceOf(const nsACString&amp; aURI) const</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+{</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+    for (Entry* entry = mEntries; entry != nullptr; entry = entry-&gt;mNext) {</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+        if (StringBeginsWith(aURI, entry-&gt;mURI))</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+            return const_iterator(entry);</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+    }</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+    return last();</span>
<a href="#l27.68"></a><span id="l27.68" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">new file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- /dev/null</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ b/rdf/base/nsNameSpaceMap.h</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -0,0 +1,98 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineplus">+ *</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+#ifndef nsNameSpaceMap_h__</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+#define nsNameSpaceMap_h__</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+#include &quot;nsAtom.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+class nsNameSpaceMap</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+{</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+public:</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineplus">+    class Entry {</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+    public:</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+        Entry(const nsACString&amp; aURI, nsAtom* aPrefix)</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+            : mURI(aURI), mPrefix(aPrefix), mNext(nullptr) {</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+            MOZ_COUNT_CTOR(nsNameSpaceMap::Entry); }</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+        ~Entry() { MOZ_COUNT_DTOR(nsNameSpaceMap::Entry); }</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+        nsCString mURI;</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+        RefPtr&lt;nsAtom&gt; mPrefix;</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+        Entry* mNext;</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineplus">+    };</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineplus">+</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineplus">+    nsNameSpaceMap();</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+    ~nsNameSpaceMap();</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+    nsresult</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+    Put(const nsAString&amp; aURI, nsAtom* aPrefix);</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+    nsresult</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+    Put(const nsACString&amp; aURI, nsAtom* aPrefix);</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+    class const_iterator {</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+    protected:</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+        friend class nsNameSpaceMap;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+        explicit const_iterator(const Entry* aCurrent)</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+            : mCurrent(aCurrent) {}</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineplus">+        const Entry* mCurrent;</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+    public:</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+        const_iterator()</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineplus">+            : mCurrent(nullptr) {}</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineplus">+</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineplus">+        const_iterator(const const_iterator&amp; iter)</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineplus">+            : mCurrent(iter.mCurrent) {}</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineplus">+</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineplus">+        const_iterator&amp;</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineplus">+        operator=(const const_iterator&amp; iter) {</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineplus">+            mCurrent = iter.mCurrent;</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+            return *this; }</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+        const_iterator&amp;</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+        operator++() {</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+            mCurrent = mCurrent-&gt;mNext;</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+            return *this; }</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineplus">+        const_iterator</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineplus">+        operator++(int) {</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineplus">+            const_iterator tmp(*this);</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+            mCurrent = mCurrent-&gt;mNext;</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+            return tmp; }</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineplus">+        const Entry* operator-&gt;() const { return mCurrent; }</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineplus">+</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineplus">+        const Entry&amp; operator*() const { return *mCurrent; }</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineplus">+</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineplus">+        bool</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+        operator==(const const_iterator&amp; iter) const {</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineplus">+            return mCurrent == iter.mCurrent; }</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+        bool</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+        operator!=(const const_iterator&amp; iter) const {</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+            return ! iter.operator==(*this); }</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+    };</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+    const_iterator first() const {</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+        return const_iterator(mEntries); }</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+    const_iterator last() const {</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineplus">+        return const_iterator(nullptr); }</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineplus">+    const_iterator GetNameSpaceOf(const nsACString&amp; aURI) const;</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineplus">+</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineplus">+protected:</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineplus">+    Entry* mEntries;</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+};</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineplus">+</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineplus">+</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineplus">+#endif // nsNameSpaceMap_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/rdf/base/nsRDFBaseDataSources.h</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,32 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+/*</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+  This header file just contains prototypes for the factory methods</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  for &quot;builtin&quot; data sources that are included in rdf.dll.</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+  Each of these data sources is exposed to the external world via its</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+  CID in ../include/nsRDFCID.h.</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+*/</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+#ifndef nsBaseDataSources_h__</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+#define nsBaseDataSources_h__</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+class nsIRDFDataSource;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+// in nsInMemoryDataSource.cpp</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+nsresult</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+NS_NewRDFInMemoryDataSource(nsISupports* aOuter, const nsIID&amp; aIID, void** aResult);</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+// in nsRDFXMLDataSource.cpp</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+extern nsresult</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+NS_NewRDFXMLDataSource(nsIRDFDataSource** aResult);</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+#endif // nsBaseDataSources_h__</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/rdf/base/nsRDFContainer.cpp</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,724 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+/*</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+  Implementation for the RDF container.</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  Notes</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+  -----</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+  1. RDF containers are one-indexed. This means that a lot of the loops</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+     that you'd normally think you'd write like this:</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+       for (i = 0; i &lt; count; ++i) {}</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+     You've gotta write like this:</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+       for (i = 1; i &lt;= count; ++i) {}</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+     &quot;Sure, right, yeah, of course.&quot;, you say. Well maybe I'm just</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+     thick, but it's easy to slip up.</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+  2. The RDF:nextVal property on the container is an</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+     implementation-level hack that is used to quickly compute the</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+     next value for appending to the container. It will no doubt</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+     become royally screwed up in the case of aggregation.</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+  3. The RDF:nextVal property is also used to retrieve the count of</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+     elements in the container.</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+ */</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+#include &quot;nsIRDFInMemoryDataSource.h&quot;</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+#include &quot;nsIRDFPropagatableDataSource.h&quot;</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+#define RDF_SEQ_LIST_LIMIT   8</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+class RDFContainerImpl : public nsIRDFContainer</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+{</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+public:</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+    // nsISupports interface</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+    // nsIRDFContainer interface</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+    NS_DECL_NSIRDFCONTAINER</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+private:</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+    friend nsresult NS_NewRDFContainer(nsIRDFContainer** aResult);</span>
<a href="#l30.65"></a><span id="l30.65" class="difflineplus">+</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineplus">+    RDFContainerImpl();</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+    virtual ~RDFContainerImpl();</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+    nsresult Init();</span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineplus">+    nsresult Renumber(int32_t aStartIndex, int32_t aIncrement);</span>
<a href="#l30.72"></a><span id="l30.72" class="difflineplus">+    nsresult SetNextValue(int32_t aIndex);</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineplus">+    nsresult GetNextValue(nsIRDFResource** aResult);</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineplus">+</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineplus">+    nsIRDFDataSource* mDataSource;</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+    nsIRDFResource*   mContainer;</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineplus">+    // pseudo constants</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineplus">+    static int32_t gRefCnt;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+    static nsIRDFService*        gRDFService;</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+    static nsIRDFContainerUtils* gRDFContainerUtils;</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+    static nsIRDFResource*       kRDF_nextVal;</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+};</span>
<a href="#l30.84"></a><span id="l30.84" class="difflineplus">+</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineplus">+</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+int32_t               RDFContainerImpl::gRefCnt = 0;</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineplus">+nsIRDFService*        RDFContainerImpl::gRDFService;</span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+nsIRDFContainerUtils* RDFContainerImpl::gRDFContainerUtils;</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+nsIRDFResource*       RDFContainerImpl::kRDF_nextVal;</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+// nsISupports interface</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+</span>
<a href="#l30.94"></a><span id="l30.94" class="difflineplus">+NS_IMPL_ISUPPORTS(RDFContainerImpl, nsIRDFContainer)</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineplus">+</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+// nsIRDFContainer interface</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+RDFContainerImpl::GetDataSource(nsIRDFDataSource** _retval)</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+{</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+    *_retval = mDataSource;</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+    NS_IF_ADDREF(*_retval);</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+}</span>
<a href="#l30.108"></a><span id="l30.108" class="difflineplus">+</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.111"></a><span id="l30.111" class="difflineplus">+RDFContainerImpl::GetResource(nsIRDFResource** _retval)</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineplus">+{</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+    *_retval = mContainer;</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+    NS_IF_ADDREF(*_retval);</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineplus">+}</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+RDFContainerImpl::Init(nsIRDFDataSource *aDataSource, nsIRDFResource *aContainer)</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineplus">+{</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineplus">+</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+    NS_PRECONDITION(aContainer != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+    if (! aContainer)</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+    bool isContainer;</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+    rv = gRDFContainerUtils-&gt;IsContainer(aDataSource, aContainer, &amp;isContainer);</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+</span>
<a href="#l30.135"></a><span id="l30.135" class="difflineplus">+    // ``throw'' if we can't create a container on the specified</span>
<a href="#l30.136"></a><span id="l30.136" class="difflineplus">+    // datasource/resource combination.</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+    if (! isContainer)</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+    NS_IF_RELEASE(mDataSource);</span>
<a href="#l30.141"></a><span id="l30.141" class="difflineplus">+    mDataSource = aDataSource;</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineplus">+    NS_ADDREF(mDataSource);</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+    NS_IF_RELEASE(mContainer);</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineplus">+    mContainer = aContainer;</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+    NS_ADDREF(mContainer);</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+}</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+</span>
<a href="#l30.152"></a><span id="l30.152" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.153"></a><span id="l30.153" class="difflineplus">+RDFContainerImpl::GetCount(int32_t *aCount)</span>
<a href="#l30.154"></a><span id="l30.154" class="difflineplus">+{</span>
<a href="#l30.155"></a><span id="l30.155" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineplus">+</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineplus">+    // Get the next value, which hangs off of the bag via the</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+    // RDF:nextVal property. This is the _next value_ that will get</span>
<a href="#l30.162"></a><span id="l30.162" class="difflineplus">+    // assigned in a one-indexed array. So, it's actually _one more_</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineplus">+    // than the actual count of elements in the container.</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineplus">+    //</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineplus">+    // XXX To handle aggregation, this should probably be a</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineplus">+    // GetTargets() that enumerates all of the values and picks the</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+    // largest one.</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+    rv = mDataSource-&gt;GetTarget(mContainer, kRDF_nextVal, true, getter_AddRefs(nextValNode));</span>
<a href="#l30.170"></a><span id="l30.170" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineplus">+</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+    if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral;</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+    rv = nextValNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), getter_AddRefs(nextValLiteral));</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineplus">+</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineplus">+    const char16_t *s;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+    rv = nextValLiteral-&gt;GetValueConst( &amp;s );</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.182"></a><span id="l30.182" class="difflineplus">+</span>
<a href="#l30.183"></a><span id="l30.183" class="difflineplus">+    nsAutoString nextValStr(s);</span>
<a href="#l30.184"></a><span id="l30.184" class="difflineplus">+</span>
<a href="#l30.185"></a><span id="l30.185" class="difflineplus">+    int32_t nextVal;</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineplus">+    nsresult err;</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+    nextVal = nextValStr.ToInteger(&amp;err);</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+    if (NS_FAILED(err))</span>
<a href="#l30.189"></a><span id="l30.189" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineplus">+</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+    *aCount = nextVal - 1;</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+}</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineplus">+</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineplus">+</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+RDFContainerImpl::GetElements(nsISimpleEnumerator **_retval)</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+{</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+</span>
<a href="#l30.202"></a><span id="l30.202" class="difflineplus">+    return NS_NewContainerEnumerator(mDataSource, mContainer, _retval);</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineplus">+}</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineplus">+</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineplus">+RDFContainerImpl::AppendElement(nsIRDFNode *aElement)</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+{</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.210"></a><span id="l30.210" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineplus">+</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineplus">+    NS_PRECONDITION(aElement != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+    if (! aElement)</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; nextVal;</span>
<a href="#l30.219"></a><span id="l30.219" class="difflineplus">+    rv = GetNextValue(getter_AddRefs(nextVal));</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+</span>
<a href="#l30.222"></a><span id="l30.222" class="difflineplus">+    rv = mDataSource-&gt;Assert(mContainer, nextVal, aElement, true);</span>
<a href="#l30.223"></a><span id="l30.223" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineplus">+}</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineplus">+</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineplus">+</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+RDFContainerImpl::RemoveElement(nsIRDFNode *aElement, bool aRenumber)</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+{</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineplus">+    NS_PRECONDITION(aElement != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineplus">+    if (! aElement)</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+</span>
<a href="#l30.239"></a><span id="l30.239" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineplus">+</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+    int32_t idx;</span>
<a href="#l30.242"></a><span id="l30.242" class="difflineplus">+    rv = IndexOf(aElement, &amp;idx);</span>
<a href="#l30.243"></a><span id="l30.243" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineplus">+    if (idx &lt; 0)</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+        return NS_OK;</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+</span>
<a href="#l30.248"></a><span id="l30.248" class="difflineplus">+    // Remove the element.</span>
<a href="#l30.249"></a><span id="l30.249" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; ordinal;</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineplus">+    rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(idx,</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+                                                    getter_AddRefs(ordinal));</span>
<a href="#l30.252"></a><span id="l30.252" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.253"></a><span id="l30.253" class="difflineplus">+</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineplus">+    rv = mDataSource-&gt;Unassert(mContainer, ordinal, aElement);</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+    if (aRenumber) {</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+        // Now slide the rest of the collection backwards to fill in</span>
<a href="#l30.259"></a><span id="l30.259" class="difflineplus">+        // the gap. This will have the side effect of completely</span>
<a href="#l30.260"></a><span id="l30.260" class="difflineplus">+        // renumber the container from index to the end.</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineplus">+        rv = Renumber(idx + 1, -1);</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+    }</span>
<a href="#l30.264"></a><span id="l30.264" class="difflineplus">+</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.266"></a><span id="l30.266" class="difflineplus">+}</span>
<a href="#l30.267"></a><span id="l30.267" class="difflineplus">+</span>
<a href="#l30.268"></a><span id="l30.268" class="difflineplus">+</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineplus">+RDFContainerImpl::InsertElementAt(nsIRDFNode *aElement, int32_t aIndex, bool aRenumber)</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineplus">+{</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineplus">+</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+    NS_PRECONDITION(aElement != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+    if (! aElement)</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineplus">+    NS_PRECONDITION(aIndex &gt;= 1, &quot;illegal value&quot;);</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineplus">+    if (aIndex &lt; 1)</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineplus">+</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineplus">+    int32_t count;</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineplus">+    rv = GetCount(&amp;count);</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineplus">+</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineplus">+    NS_ASSERTION(aIndex &lt;= count + 1, &quot;illegal value&quot;);</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineplus">+    if (aIndex &gt; count + 1)</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineplus">+</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineplus">+    if (aRenumber) {</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineplus">+        // Make a hole for the element. This will have the side effect of</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineplus">+        // completely renumbering the container from 'aIndex' to 'count',</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+        // and will spew assertions.</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+        rv = Renumber(aIndex, +1);</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineplus">+    }</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineplus">+</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; ordinal;</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineplus">+    rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(aIndex, getter_AddRefs(ordinal));</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineplus">+    rv = mDataSource-&gt;Assert(mContainer, ordinal, aElement, true);</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineplus">+</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineplus">+}</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineplus">+</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineplus">+RDFContainerImpl::RemoveElementAt(int32_t aIndex, bool aRenumber, nsIRDFNode** _retval)</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineplus">+{</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineplus">+</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineplus">+    *_retval = nullptr;</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineplus">+</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineplus">+    if (aIndex&lt; 1)</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineplus">+</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineplus">+</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineplus">+    int32_t count;</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineplus">+    rv = GetCount(&amp;count);</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineplus">+</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineplus">+    if (aIndex &gt; count)</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineplus">+</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; ordinal;</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineplus">+    rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(aIndex, getter_AddRefs(ordinal));</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineplus">+</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; old;</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineplus">+    rv = mDataSource-&gt;GetTarget(mContainer, ordinal, true, getter_AddRefs(old));</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineplus">+</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+    if (rv == NS_OK) {</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+        rv = mDataSource-&gt;Unassert(mContainer, ordinal, old);</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+        if (aRenumber) {</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineplus">+            // Now slide the rest of the collection backwards to fill in</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineplus">+            // the gap. This will have the side effect of completely</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineplus">+            // renumber the container from index to the end.</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineplus">+            rv = Renumber(aIndex + 1, -1);</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineplus">+        }</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineplus">+    }</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineplus">+</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineplus">+    old.swap(*_retval);</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineplus">+</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineplus">+}</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineplus">+</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineplus">+RDFContainerImpl::IndexOf(nsIRDFNode *aElement, int32_t *aIndex)</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+{</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineplus">+</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineplus">+    return gRDFContainerUtils-&gt;IndexOf(mDataSource, mContainer,</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineplus">+                                       aElement, aIndex);</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineplus">+}</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineplus">+</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineplus">+</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineplus">+</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineplus">+</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineplus">+RDFContainerImpl::RDFContainerImpl()</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+    : mDataSource(nullptr), mContainer(nullptr)</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineplus">+{</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineplus">+}</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineplus">+</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineplus">+nsresult</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineplus">+RDFContainerImpl::Init()</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineplus">+{</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineplus">+    if (gRefCnt++ == 0) {</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+        nsresult rv;</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineplus">+</span>
<a href="#l30.383"></a><span id="l30.383" class="difflineplus">+        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineplus">+        rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineplus">+            NS_ERROR(&quot;unable to get RDF service&quot;);</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineplus">+            return rv;</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineplus">+        }</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineplus">+</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineplus">+        rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineplus">+                                      &amp;kRDF_nextVal);</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineplus">+</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineplus">+        NS_DEFINE_CID(kRDFContainerUtilsCID, NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineplus">+        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFContainerUtils);</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineplus">+            NS_ERROR(&quot;unable to get RDF container utils service&quot;);</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineplus">+            return rv;</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineplus">+        }</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineplus">+    }</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineplus">+</span>
<a href="#l30.402"></a><span id="l30.402" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.403"></a><span id="l30.403" class="difflineplus">+}</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineplus">+</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineplus">+</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineplus">+RDFContainerImpl::~RDFContainerImpl()</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineplus">+{</span>
<a href="#l30.408"></a><span id="l30.408" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l30.409"></a><span id="l30.409" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l30.410"></a><span id="l30.410" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: RDFContainerImpl\n&quot;, gInstanceCount);</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineplus">+#endif</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineplus">+</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineplus">+    NS_IF_RELEASE(mContainer);</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineplus">+    NS_IF_RELEASE(mDataSource);</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineplus">+</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineplus">+    if (--gRefCnt == 0) {</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineplus">+        NS_IF_RELEASE(gRDFContainerUtils);</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineplus">+        NS_IF_RELEASE(gRDFService);</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineplus">+        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l30.420"></a><span id="l30.420" class="difflineplus">+    }</span>
<a href="#l30.421"></a><span id="l30.421" class="difflineplus">+}</span>
<a href="#l30.422"></a><span id="l30.422" class="difflineplus">+</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineplus">+</span>
<a href="#l30.424"></a><span id="l30.424" class="difflineplus">+nsresult</span>
<a href="#l30.425"></a><span id="l30.425" class="difflineplus">+NS_NewRDFContainer(nsIRDFContainer** aResult)</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineplus">+{</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineplus">+    RDFContainerImpl* result = new RDFContainerImpl();</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineplus">+    if (! result)</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l30.430"></a><span id="l30.430" class="difflineplus">+</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineplus">+    rv = result-&gt;Init();</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineplus">+        delete result;</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineplus">+        return rv;</span>
<a href="#l30.436"></a><span id="l30.436" class="difflineplus">+    }</span>
<a href="#l30.437"></a><span id="l30.437" class="difflineplus">+</span>
<a href="#l30.438"></a><span id="l30.438" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l30.439"></a><span id="l30.439" class="difflineplus">+    *aResult = result;</span>
<a href="#l30.440"></a><span id="l30.440" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.441"></a><span id="l30.441" class="difflineplus">+}</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineplus">+</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineplus">+</span>
<a href="#l30.444"></a><span id="l30.444" class="difflineplus">+nsresult</span>
<a href="#l30.445"></a><span id="l30.445" class="difflineplus">+NS_NewRDFContainer(nsIRDFDataSource* aDataSource,</span>
<a href="#l30.446"></a><span id="l30.446" class="difflineplus">+                   nsIRDFResource* aResource,</span>
<a href="#l30.447"></a><span id="l30.447" class="difflineplus">+                   nsIRDFContainer** aResult)</span>
<a href="#l30.448"></a><span id="l30.448" class="difflineplus">+{</span>
<a href="#l30.449"></a><span id="l30.449" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.450"></a><span id="l30.450" class="difflineplus">+    rv = NS_NewRDFContainer(aResult);</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineplus">+</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineplus">+    rv = (*aResult)-&gt;Init(aDataSource, aResource);</span>
<a href="#l30.454"></a><span id="l30.454" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l30.455"></a><span id="l30.455" class="difflineplus">+        NS_RELEASE(*aResult);</span>
<a href="#l30.456"></a><span id="l30.456" class="difflineplus">+    }</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineplus">+    return rv;</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineplus">+}</span>
<a href="#l30.459"></a><span id="l30.459" class="difflineplus">+</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineplus">+</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineplus">+nsresult</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineplus">+RDFContainerImpl::Renumber(int32_t aStartIndex, int32_t aIncrement)</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineplus">+{</span>
<a href="#l30.464"></a><span id="l30.464" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.465"></a><span id="l30.465" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.466"></a><span id="l30.466" class="difflineplus">+</span>
<a href="#l30.467"></a><span id="l30.467" class="difflineplus">+    // Renumber the elements in the container starting with</span>
<a href="#l30.468"></a><span id="l30.468" class="difflineplus">+    // aStartIndex, updating each element's index by aIncrement. For</span>
<a href="#l30.469"></a><span id="l30.469" class="difflineplus">+    // example,</span>
<a href="#l30.470"></a><span id="l30.470" class="difflineplus">+    //</span>
<a href="#l30.471"></a><span id="l30.471" class="difflineplus">+    //   (1:a 2:b 3:c)</span>
<a href="#l30.472"></a><span id="l30.472" class="difflineplus">+    //   Renumber(2, +1);</span>
<a href="#l30.473"></a><span id="l30.473" class="difflineplus">+    //   (1:a 3:b 4:c)</span>
<a href="#l30.474"></a><span id="l30.474" class="difflineplus">+    //   Renumber(3, -1);</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineplus">+    //   (1:a 2:b 3:c)</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineplus">+    //</span>
<a href="#l30.477"></a><span id="l30.477" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.478"></a><span id="l30.478" class="difflineplus">+</span>
<a href="#l30.479"></a><span id="l30.479" class="difflineplus">+    if (! aIncrement)</span>
<a href="#l30.480"></a><span id="l30.480" class="difflineplus">+        return NS_OK;</span>
<a href="#l30.481"></a><span id="l30.481" class="difflineplus">+</span>
<a href="#l30.482"></a><span id="l30.482" class="difflineplus">+    int32_t count;</span>
<a href="#l30.483"></a><span id="l30.483" class="difflineplus">+    rv = GetCount(&amp;count);</span>
<a href="#l30.484"></a><span id="l30.484" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineplus">+</span>
<a href="#l30.486"></a><span id="l30.486" class="difflineplus">+    if (aIncrement &gt; 0) {</span>
<a href="#l30.487"></a><span id="l30.487" class="difflineplus">+        // Update the container's nextVal to reflect the</span>
<a href="#l30.488"></a><span id="l30.488" class="difflineplus">+        // renumbering. We do this now if aIncrement &gt; 0 because we'll</span>
<a href="#l30.489"></a><span id="l30.489" class="difflineplus">+        // want to be able to acknowledge that new elements are in the</span>
<a href="#l30.490"></a><span id="l30.490" class="difflineplus">+        // container.</span>
<a href="#l30.491"></a><span id="l30.491" class="difflineplus">+        rv = SetNextValue(count + aIncrement + 1);</span>
<a href="#l30.492"></a><span id="l30.492" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.493"></a><span id="l30.493" class="difflineplus">+    }</span>
<a href="#l30.494"></a><span id="l30.494" class="difflineplus">+</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineplus">+    int32_t i;</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineplus">+    if (aIncrement &lt; 0) {</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineplus">+        i = aStartIndex;</span>
<a href="#l30.498"></a><span id="l30.498" class="difflineplus">+    }</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineplus">+    else {</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineplus">+        i = count; // we're one-indexed.</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineplus">+    }</span>
<a href="#l30.502"></a><span id="l30.502" class="difflineplus">+</span>
<a href="#l30.503"></a><span id="l30.503" class="difflineplus">+    // Note: once we disable notifications, don't exit this method until</span>
<a href="#l30.504"></a><span id="l30.504" class="difflineplus">+    // enabling notifications</span>
<a href="#l30.505"></a><span id="l30.505" class="difflineplus">+    nsCOMPtr&lt;nsIRDFPropagatableDataSource&gt; propagatable =</span>
<a href="#l30.506"></a><span id="l30.506" class="difflineplus">+        do_QueryInterface(mDataSource);</span>
<a href="#l30.507"></a><span id="l30.507" class="difflineplus">+    if (propagatable) {</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineplus">+        propagatable-&gt;SetPropagateChanges(false);</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineplus">+    }</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineplus">+</span>
<a href="#l30.511"></a><span id="l30.511" class="difflineplus">+    bool    err = false;</span>
<a href="#l30.512"></a><span id="l30.512" class="difflineplus">+    while (!err &amp;&amp; ((aIncrement &lt; 0) ? (i &lt;= count) : (i &gt;= aStartIndex)))</span>
<a href="#l30.513"></a><span id="l30.513" class="difflineplus">+    {</span>
<a href="#l30.514"></a><span id="l30.514" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; oldOrdinal;</span>
<a href="#l30.515"></a><span id="l30.515" class="difflineplus">+        rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(i, getter_AddRefs(oldOrdinal));</span>
<a href="#l30.516"></a><span id="l30.516" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l30.517"></a><span id="l30.517" class="difflineplus">+        {</span>
<a href="#l30.518"></a><span id="l30.518" class="difflineplus">+            err = true;</span>
<a href="#l30.519"></a><span id="l30.519" class="difflineplus">+            continue;</span>
<a href="#l30.520"></a><span id="l30.520" class="difflineplus">+        }</span>
<a href="#l30.521"></a><span id="l30.521" class="difflineplus">+</span>
<a href="#l30.522"></a><span id="l30.522" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; newOrdinal;</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineplus">+        rv = gRDFContainerUtils-&gt;IndexToOrdinalResource(i + aIncrement, getter_AddRefs(newOrdinal));</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l30.525"></a><span id="l30.525" class="difflineplus">+        {</span>
<a href="#l30.526"></a><span id="l30.526" class="difflineplus">+            err = true;</span>
<a href="#l30.527"></a><span id="l30.527" class="difflineplus">+            continue;</span>
<a href="#l30.528"></a><span id="l30.528" class="difflineplus">+        }</span>
<a href="#l30.529"></a><span id="l30.529" class="difflineplus">+</span>
<a href="#l30.530"></a><span id="l30.530" class="difflineplus">+        // Because of aggregation, we need to be paranoid about the</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineplus">+        // possibility that &gt;1 element may be present per ordinal. If</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineplus">+        // there _is_ in fact more than one element, they'll all get</span>
<a href="#l30.533"></a><span id="l30.533" class="difflineplus">+        // assigned to the same new ordinal; i.e., we don't make any</span>
<a href="#l30.534"></a><span id="l30.534" class="difflineplus">+        // attempt to &quot;clean up&quot; the duplicate numbering. (Doing so</span>
<a href="#l30.535"></a><span id="l30.535" class="difflineplus">+        // would require two passes.)</span>
<a href="#l30.536"></a><span id="l30.536" class="difflineplus">+        nsCOMPtr&lt;nsISimpleEnumerator&gt; targets;</span>
<a href="#l30.537"></a><span id="l30.537" class="difflineplus">+        rv = mDataSource-&gt;GetTargets(mContainer, oldOrdinal, true, getter_AddRefs(targets));</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineplus">+        {</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineplus">+            err = true;</span>
<a href="#l30.541"></a><span id="l30.541" class="difflineplus">+            continue;</span>
<a href="#l30.542"></a><span id="l30.542" class="difflineplus">+        }</span>
<a href="#l30.543"></a><span id="l30.543" class="difflineplus">+</span>
<a href="#l30.544"></a><span id="l30.544" class="difflineplus">+        while (1) {</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineplus">+            bool hasMore;</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineplus">+            rv = targets-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l30.548"></a><span id="l30.548" class="difflineplus">+            {</span>
<a href="#l30.549"></a><span id="l30.549" class="difflineplus">+                err = true;</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineplus">+                break;</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineplus">+            }</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineplus">+</span>
<a href="#l30.553"></a><span id="l30.553" class="difflineplus">+            if (! hasMore)</span>
<a href="#l30.554"></a><span id="l30.554" class="difflineplus">+                break;</span>
<a href="#l30.555"></a><span id="l30.555" class="difflineplus">+</span>
<a href="#l30.556"></a><span id="l30.556" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l30.557"></a><span id="l30.557" class="difflineplus">+            rv = targets-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l30.558"></a><span id="l30.558" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l30.559"></a><span id="l30.559" class="difflineplus">+            {</span>
<a href="#l30.560"></a><span id="l30.560" class="difflineplus">+                err = true;</span>
<a href="#l30.561"></a><span id="l30.561" class="difflineplus">+                break;</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineplus">+            }</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineplus">+</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineplus">+            nsCOMPtr&lt;nsIRDFNode&gt; element( do_QueryInterface(isupports) );</span>
<a href="#l30.565"></a><span id="l30.565" class="difflineplus">+            NS_ASSERTION(element != nullptr, &quot;something funky in the enumerator&quot;);</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineplus">+            if (! element)</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineplus">+            {</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineplus">+                err = true;</span>
<a href="#l30.569"></a><span id="l30.569" class="difflineplus">+                rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l30.570"></a><span id="l30.570" class="difflineplus">+                break;</span>
<a href="#l30.571"></a><span id="l30.571" class="difflineplus">+            }</span>
<a href="#l30.572"></a><span id="l30.572" class="difflineplus">+</span>
<a href="#l30.573"></a><span id="l30.573" class="difflineplus">+            rv = mDataSource-&gt;Unassert(mContainer, oldOrdinal, element);</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineplus">+            {</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineplus">+                err = true;</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineplus">+                break;</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineplus">+            }</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineplus">+</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineplus">+            rv = mDataSource-&gt;Assert(mContainer, newOrdinal, element, true);</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineplus">+            {</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineplus">+                err = true;</span>
<a href="#l30.584"></a><span id="l30.584" class="difflineplus">+                break;</span>
<a href="#l30.585"></a><span id="l30.585" class="difflineplus">+            }</span>
<a href="#l30.586"></a><span id="l30.586" class="difflineplus">+        }</span>
<a href="#l30.587"></a><span id="l30.587" class="difflineplus">+</span>
<a href="#l30.588"></a><span id="l30.588" class="difflineplus">+        i -= aIncrement;</span>
<a href="#l30.589"></a><span id="l30.589" class="difflineplus">+    }</span>
<a href="#l30.590"></a><span id="l30.590" class="difflineplus">+</span>
<a href="#l30.591"></a><span id="l30.591" class="difflineplus">+    if (!err &amp;&amp; (aIncrement &lt; 0))</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineplus">+    {</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineplus">+        // Update the container's nextVal to reflect the</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineplus">+        // renumbering. We do this now if aIncrement &lt; 0 because, up</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineplus">+        // until this point, we'll want people to be able to find</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineplus">+        // things that are still &quot;at the end&quot;.</span>
<a href="#l30.597"></a><span id="l30.597" class="difflineplus">+        rv = SetNextValue(count + aIncrement + 1);</span>
<a href="#l30.598"></a><span id="l30.598" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineplus">+        {</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineplus">+            err = true;</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineplus">+        }</span>
<a href="#l30.602"></a><span id="l30.602" class="difflineplus">+    }</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineplus">+</span>
<a href="#l30.604"></a><span id="l30.604" class="difflineplus">+    // Note: MUST enable notifications before exiting this method</span>
<a href="#l30.605"></a><span id="l30.605" class="difflineplus">+    if (propagatable) {</span>
<a href="#l30.606"></a><span id="l30.606" class="difflineplus">+        propagatable-&gt;SetPropagateChanges(true);</span>
<a href="#l30.607"></a><span id="l30.607" class="difflineplus">+    }</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineplus">+</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineplus">+    if (err) return(rv);</span>
<a href="#l30.610"></a><span id="l30.610" class="difflineplus">+</span>
<a href="#l30.611"></a><span id="l30.611" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.612"></a><span id="l30.612" class="difflineplus">+}</span>
<a href="#l30.613"></a><span id="l30.613" class="difflineplus">+</span>
<a href="#l30.614"></a><span id="l30.614" class="difflineplus">+</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineplus">+</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineplus">+nsresult</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineplus">+RDFContainerImpl::SetNextValue(int32_t aIndex)</span>
<a href="#l30.618"></a><span id="l30.618" class="difflineplus">+{</span>
<a href="#l30.619"></a><span id="l30.619" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.620"></a><span id="l30.620" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.621"></a><span id="l30.621" class="difflineplus">+</span>
<a href="#l30.622"></a><span id="l30.622" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineplus">+</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineplus">+    // Remove the current value of nextVal, if there is one.</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l30.626"></a><span id="l30.626" class="difflineplus">+    if (NS_SUCCEEDED(rv = mDataSource-&gt;GetTarget(mContainer,</span>
<a href="#l30.627"></a><span id="l30.627" class="difflineplus">+                                                 kRDF_nextVal,</span>
<a href="#l30.628"></a><span id="l30.628" class="difflineplus">+                                                 true,</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineplus">+                                                 getter_AddRefs(nextValNode)))) {</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineplus">+        if (NS_FAILED(rv = mDataSource-&gt;Unassert(mContainer, kRDF_nextVal, nextValNode))) {</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineplus">+            NS_ERROR(&quot;unable to update nextVal&quot;);</span>
<a href="#l30.632"></a><span id="l30.632" class="difflineplus">+            return rv;</span>
<a href="#l30.633"></a><span id="l30.633" class="difflineplus">+        }</span>
<a href="#l30.634"></a><span id="l30.634" class="difflineplus">+    }</span>
<a href="#l30.635"></a><span id="l30.635" class="difflineplus">+</span>
<a href="#l30.636"></a><span id="l30.636" class="difflineplus">+    nsAutoString s;</span>
<a href="#l30.637"></a><span id="l30.637" class="difflineplus">+    s.AppendInt(aIndex, 10);</span>
<a href="#l30.638"></a><span id="l30.638" class="difflineplus">+</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; nextVal;</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineplus">+    if (NS_FAILED(rv = gRDFService-&gt;GetLiteral(s.get(), getter_AddRefs(nextVal)))) {</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineplus">+        NS_ERROR(&quot;unable to get nextVal literal&quot;);</span>
<a href="#l30.642"></a><span id="l30.642" class="difflineplus">+        return rv;</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineplus">+    }</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineplus">+</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineplus">+    rv = mDataSource-&gt;Assert(mContainer, kRDF_nextVal, nextVal, true);</span>
<a href="#l30.646"></a><span id="l30.646" class="difflineplus">+    if (rv != NS_RDF_ASSERTION_ACCEPTED) {</span>
<a href="#l30.647"></a><span id="l30.647" class="difflineplus">+        NS_ERROR(&quot;unable to update nextVal&quot;);</span>
<a href="#l30.648"></a><span id="l30.648" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l30.649"></a><span id="l30.649" class="difflineplus">+    }</span>
<a href="#l30.650"></a><span id="l30.650" class="difflineplus">+</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineplus">+}</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineplus">+</span>
<a href="#l30.654"></a><span id="l30.654" class="difflineplus">+</span>
<a href="#l30.655"></a><span id="l30.655" class="difflineplus">+nsresult</span>
<a href="#l30.656"></a><span id="l30.656" class="difflineplus">+RDFContainerImpl::GetNextValue(nsIRDFResource** aResult)</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineplus">+{</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineplus">+    if (!mDataSource || !mContainer)</span>
<a href="#l30.659"></a><span id="l30.659" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l30.660"></a><span id="l30.660" class="difflineplus">+</span>
<a href="#l30.661"></a><span id="l30.661" class="difflineplus">+    nsresult rv;</span>
<a href="#l30.662"></a><span id="l30.662" class="difflineplus">+</span>
<a href="#l30.663"></a><span id="l30.663" class="difflineplus">+    // Get the next value, which hangs off of the bag via the</span>
<a href="#l30.664"></a><span id="l30.664" class="difflineplus">+    // RDF:nextVal property.</span>
<a href="#l30.665"></a><span id="l30.665" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l30.666"></a><span id="l30.666" class="difflineplus">+    rv = mDataSource-&gt;GetTarget(mContainer, kRDF_nextVal, true, getter_AddRefs(nextValNode));</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineplus">+</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineplus">+    if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineplus">+</span>
<a href="#l30.672"></a><span id="l30.672" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral;</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineplus">+    rv = nextValNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), getter_AddRefs(nextValLiteral));</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineplus">+</span>
<a href="#l30.676"></a><span id="l30.676" class="difflineplus">+    const char16_t* s;</span>
<a href="#l30.677"></a><span id="l30.677" class="difflineplus">+    rv = nextValLiteral-&gt;GetValueConst(&amp;s);</span>
<a href="#l30.678"></a><span id="l30.678" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.679"></a><span id="l30.679" class="difflineplus">+</span>
<a href="#l30.680"></a><span id="l30.680" class="difflineplus">+    int32_t nextVal = 0;</span>
<a href="#l30.681"></a><span id="l30.681" class="difflineplus">+    {</span>
<a href="#l30.682"></a><span id="l30.682" class="difflineplus">+        for (const char16_t* p = s; *p != 0; ++p) {</span>
<a href="#l30.683"></a><span id="l30.683" class="difflineplus">+            NS_ASSERTION(*p &gt;= '0' &amp;&amp; *p &lt;= '9', &quot;not a digit&quot;);</span>
<a href="#l30.684"></a><span id="l30.684" class="difflineplus">+            if (*p &lt; '0' || *p &gt; '9')</span>
<a href="#l30.685"></a><span id="l30.685" class="difflineplus">+                break;</span>
<a href="#l30.686"></a><span id="l30.686" class="difflineplus">+</span>
<a href="#l30.687"></a><span id="l30.687" class="difflineplus">+            nextVal *= 10;</span>
<a href="#l30.688"></a><span id="l30.688" class="difflineplus">+            nextVal += *p - '0';</span>
<a href="#l30.689"></a><span id="l30.689" class="difflineplus">+        }</span>
<a href="#l30.690"></a><span id="l30.690" class="difflineplus">+    }</span>
<a href="#l30.691"></a><span id="l30.691" class="difflineplus">+</span>
<a href="#l30.692"></a><span id="l30.692" class="difflineplus">+    static const char kRDFNameSpaceURI[] = RDF_NAMESPACE_URI;</span>
<a href="#l30.693"></a><span id="l30.693" class="difflineplus">+    nsAutoCStringN&lt;sizeof(kRDFNameSpaceURI) + 16&gt; nextValStr;</span>
<a href="#l30.694"></a><span id="l30.694" class="difflineplus">+    nextValStr = kRDFNameSpaceURI;</span>
<a href="#l30.695"></a><span id="l30.695" class="difflineplus">+    nextValStr.Append('_');</span>
<a href="#l30.696"></a><span id="l30.696" class="difflineplus">+    nextValStr.AppendInt(nextVal, 10);</span>
<a href="#l30.697"></a><span id="l30.697" class="difflineplus">+</span>
<a href="#l30.698"></a><span id="l30.698" class="difflineplus">+    rv = gRDFService-&gt;GetResource(nextValStr, aResult);</span>
<a href="#l30.699"></a><span id="l30.699" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.700"></a><span id="l30.700" class="difflineplus">+</span>
<a href="#l30.701"></a><span id="l30.701" class="difflineplus">+    // Now increment the RDF:nextVal property.</span>
<a href="#l30.702"></a><span id="l30.702" class="difflineplus">+    rv = mDataSource-&gt;Unassert(mContainer, kRDF_nextVal, nextValLiteral);</span>
<a href="#l30.703"></a><span id="l30.703" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.704"></a><span id="l30.704" class="difflineplus">+</span>
<a href="#l30.705"></a><span id="l30.705" class="difflineplus">+    ++nextVal;</span>
<a href="#l30.706"></a><span id="l30.706" class="difflineplus">+    nextValStr.Truncate();</span>
<a href="#l30.707"></a><span id="l30.707" class="difflineplus">+    nextValStr.AppendInt(nextVal, 10);</span>
<a href="#l30.708"></a><span id="l30.708" class="difflineplus">+</span>
<a href="#l30.709"></a><span id="l30.709" class="difflineplus">+    rv = gRDFService-&gt;GetLiteral(NS_ConvertASCIItoUTF16(nextValStr).get(), getter_AddRefs(nextValLiteral));</span>
<a href="#l30.710"></a><span id="l30.710" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.711"></a><span id="l30.711" class="difflineplus">+</span>
<a href="#l30.712"></a><span id="l30.712" class="difflineplus">+    rv = mDataSource-&gt;Assert(mContainer, kRDF_nextVal, nextValLiteral, true);</span>
<a href="#l30.713"></a><span id="l30.713" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.714"></a><span id="l30.714" class="difflineplus">+</span>
<a href="#l30.715"></a><span id="l30.715" class="difflineplus">+    if (RDF_SEQ_LIST_LIMIT == nextVal)</span>
<a href="#l30.716"></a><span id="l30.716" class="difflineplus">+    {</span>
<a href="#l30.717"></a><span id="l30.717" class="difflineplus">+        // focal point for RDF container mutation;</span>
<a href="#l30.718"></a><span id="l30.718" class="difflineplus">+        // basically, provide a hint to allow for fast access</span>
<a href="#l30.719"></a><span id="l30.719" class="difflineplus">+        nsCOMPtr&lt;nsIRDFInMemoryDataSource&gt; inMem = do_QueryInterface(mDataSource);</span>
<a href="#l30.720"></a><span id="l30.720" class="difflineplus">+        if (inMem)</span>
<a href="#l30.721"></a><span id="l30.721" class="difflineplus">+        {</span>
<a href="#l30.722"></a><span id="l30.722" class="difflineplus">+            // ignore error; failure just means slower access</span>
<a href="#l30.723"></a><span id="l30.723" class="difflineplus">+            (void)inMem-&gt;EnsureFastContainment(mContainer);</span>
<a href="#l30.724"></a><span id="l30.724" class="difflineplus">+        }</span>
<a href="#l30.725"></a><span id="l30.725" class="difflineplus">+    }</span>
<a href="#l30.726"></a><span id="l30.726" class="difflineplus">+</span>
<a href="#l30.727"></a><span id="l30.727" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.728"></a><span id="l30.728" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">new file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- /dev/null</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ b/rdf/base/nsRDFContainerUtils.cpp</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -0,0 +1,513 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+/*</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+  Implementation for the RDF container utils.</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+ */</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+#include &quot;plstr.h&quot;</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+class RDFContainerUtilsImpl : public nsIRDFContainerUtils</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+{</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+public:</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+    // nsISupports interface</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineplus">+</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+    // nsIRDFContainerUtils interface</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+    NS_DECL_NSIRDFCONTAINERUTILS</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+private:</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+    friend nsresult NS_NewRDFContainerUtils(nsIRDFContainerUtils** aResult);</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+    RDFContainerUtilsImpl();</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineplus">+    virtual ~RDFContainerUtilsImpl();</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineplus">+</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+    nsresult MakeContainer(nsIRDFDataSource* aDataSource,</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineplus">+                           nsIRDFResource* aResource,</span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+                           nsIRDFResource* aType,</span>
<a href="#l31.46"></a><span id="l31.46" class="difflineplus">+                           nsIRDFContainer** aResult);</span>
<a href="#l31.47"></a><span id="l31.47" class="difflineplus">+</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+    bool IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType);</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+    // pseudo constants</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+    static int32_t gRefCnt;</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+    static nsIRDFService* gRDFService;</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+    static nsIRDFResource* kRDF_instanceOf;</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineplus">+    static nsIRDFResource* kRDF_nextVal;</span>
<a href="#l31.55"></a><span id="l31.55" class="difflineplus">+    static nsIRDFResource* kRDF_Bag;</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineplus">+    static nsIRDFResource* kRDF_Seq;</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+    static nsIRDFResource* kRDF_Alt;</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineplus">+    static nsIRDFLiteral* kOne;</span>
<a href="#l31.59"></a><span id="l31.59" class="difflineplus">+    static const char kRDFNameSpaceURI[];</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+};</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineplus">+int32_t         RDFContainerUtilsImpl::gRefCnt = 0;</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+nsIRDFService*  RDFContainerUtilsImpl::gRDFService;</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+nsIRDFResource* RDFContainerUtilsImpl::kRDF_instanceOf;</span>
<a href="#l31.65"></a><span id="l31.65" class="difflineplus">+nsIRDFResource* RDFContainerUtilsImpl::kRDF_nextVal;</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineplus">+nsIRDFResource* RDFContainerUtilsImpl::kRDF_Bag;</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineplus">+nsIRDFResource* RDFContainerUtilsImpl::kRDF_Seq;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+nsIRDFResource* RDFContainerUtilsImpl::kRDF_Alt;</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+nsIRDFLiteral*  RDFContainerUtilsImpl::kOne;</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+const char      RDFContainerUtilsImpl::kRDFNameSpaceURI[] = RDF_NAMESPACE_URI;</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineplus">+</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineplus">+// nsISupports interface</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineplus">+</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineplus">+NS_IMPL_ISUPPORTS(RDFContainerUtilsImpl, nsIRDFContainerUtils)</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.78"></a><span id="l31.78" class="difflineplus">+// nsIRDFContainerUtils interface</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineplus">+</span>
<a href="#l31.80"></a><span id="l31.80" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineplus">+RDFContainerUtilsImpl::IsOrdinalProperty(nsIRDFResource *aProperty, bool *_retval)</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+{</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+    NS_PRECONDITION(aProperty != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineplus">+    if (! aProperty)</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+    nsresult rv;</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+    const char	*propertyStr;</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineplus">+    rv = aProperty-&gt;GetValueConst( &amp;propertyStr );</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineplus">+</span>
<a href="#l31.93"></a><span id="l31.93" class="difflineplus">+    if (PL_strncmp(propertyStr, kRDFNameSpaceURI, sizeof(kRDFNameSpaceURI) - 1) != 0) {</span>
<a href="#l31.94"></a><span id="l31.94" class="difflineplus">+        *_retval = false;</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineplus">+        return NS_OK;</span>
<a href="#l31.96"></a><span id="l31.96" class="difflineplus">+    }</span>
<a href="#l31.97"></a><span id="l31.97" class="difflineplus">+</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineplus">+    const char* s = propertyStr;</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineplus">+    s += sizeof(kRDFNameSpaceURI) - 1;</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineplus">+    if (*s != '_') {</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+        *_retval = false;</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineplus">+        return NS_OK;</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineplus">+    }</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineplus">+</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+    ++s;</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+    while (*s) {</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+        if (*s &lt; '0' || *s &gt; '9') {</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+            *_retval = false;</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+            return NS_OK;</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+        }</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+        ++s;</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineplus">+    }</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineplus">+</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineplus">+    *_retval = true;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+}</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineplus">+</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineplus">+RDFContainerUtilsImpl::IndexToOrdinalResource(int32_t aIndex, nsIRDFResource **aOrdinal)</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineplus">+{</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineplus">+    NS_PRECONDITION(aIndex &gt; 0, &quot;illegal value&quot;);</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+    if (aIndex &lt;= 0)</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineplus">+</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineplus">+    nsAutoCString uri(kRDFNameSpaceURI);</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineplus">+    uri.Append('_');</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineplus">+    uri.AppendInt(aIndex);</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineplus">+</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineplus">+    nsresult rv = gRDFService-&gt;GetResource(uri, aOrdinal);</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get ordinal resource&quot;);</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+}</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineplus">+</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineplus">+</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+RDFContainerUtilsImpl::OrdinalResourceToIndex(nsIRDFResource *aOrdinal, int32_t *aIndex)</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+{</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+    NS_PRECONDITION(aOrdinal != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+    if (! aOrdinal)</span>
<a href="#l31.144"></a><span id="l31.144" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineplus">+</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineplus">+    const char	*ordinalStr;</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+    if (NS_FAILED(aOrdinal-&gt;GetValueConst( &amp;ordinalStr )))</span>
<a href="#l31.148"></a><span id="l31.148" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l31.149"></a><span id="l31.149" class="difflineplus">+</span>
<a href="#l31.150"></a><span id="l31.150" class="difflineplus">+    const char* s = ordinalStr;</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineplus">+    if (PL_strncmp(s, kRDFNameSpaceURI, sizeof(kRDFNameSpaceURI) - 1) != 0) {</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineplus">+        NS_ERROR(&quot;not an ordinal&quot;);</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l31.154"></a><span id="l31.154" class="difflineplus">+    }</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineplus">+</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+    s += sizeof(kRDFNameSpaceURI) - 1;</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+    if (*s != '_') {</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineplus">+        NS_ERROR(&quot;not an ordinal&quot;);</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineplus">+    }</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineplus">+</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineplus">+    int32_t idx = 0;</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineplus">+</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineplus">+    ++s;</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+    while (*s) {</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineplus">+        if (*s &lt; '0' || *s &gt; '9') {</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineplus">+            NS_ERROR(&quot;not an ordinal&quot;);</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineplus">+            return NS_ERROR_UNEXPECTED;</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineplus">+        }</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineplus">+</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineplus">+        idx *= 10;</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineplus">+        idx += (*s - '0');</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineplus">+        ++s;</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+    }</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+</span>
<a href="#l31.177"></a><span id="l31.177" class="difflineplus">+    *aIndex = idx;</span>
<a href="#l31.178"></a><span id="l31.178" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.179"></a><span id="l31.179" class="difflineplus">+}</span>
<a href="#l31.180"></a><span id="l31.180" class="difflineplus">+</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.182"></a><span id="l31.182" class="difflineplus">+RDFContainerUtilsImpl::IsContainer(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineplus">+{</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineplus">+    if (! aResource)</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineplus">+    NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+    if (! _retval)</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineplus">+</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+    if (IsA(aDataSource, aResource, kRDF_Seq) ||</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+        IsA(aDataSource, aResource, kRDF_Bag) ||</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+        IsA(aDataSource, aResource, kRDF_Alt)) {</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineplus">+        *_retval = true;</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineplus">+    }</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineplus">+    else {</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineplus">+        *_retval = false;</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineplus">+    }</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+}</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineplus">+</span>
<a href="#l31.207"></a><span id="l31.207" class="difflineplus">+</span>
<a href="#l31.208"></a><span id="l31.208" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineplus">+RDFContainerUtilsImpl::IsEmpty(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, bool* _retval)</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineplus">+{</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineplus">+</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineplus">+    nsresult rv;</span>
<a href="#l31.215"></a><span id="l31.215" class="difflineplus">+</span>
<a href="#l31.216"></a><span id="l31.216" class="difflineplus">+    // By default, say that we're an empty container. Even if we're not</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineplus">+    // really even a container.</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineplus">+    *_retval = true;</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineplus">+</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; nextValNode;</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineplus">+    rv = aDataSource-&gt;GetTarget(aResource, kRDF_nextVal, true, getter_AddRefs(nextValNode));</span>
<a href="#l31.222"></a><span id="l31.222" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineplus">+</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineplus">+    if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineplus">+        return NS_OK;</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineplus">+</span>
<a href="#l31.227"></a><span id="l31.227" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; nextValLiteral;</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineplus">+    rv = nextValNode-&gt;QueryInterface(NS_GET_IID(nsIRDFLiteral), getter_AddRefs(nextValLiteral));</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.230"></a><span id="l31.230" class="difflineplus">+</span>
<a href="#l31.231"></a><span id="l31.231" class="difflineplus">+    if (nextValLiteral.get() != kOne)</span>
<a href="#l31.232"></a><span id="l31.232" class="difflineplus">+        *_retval = false;</span>
<a href="#l31.233"></a><span id="l31.233" class="difflineplus">+</span>
<a href="#l31.234"></a><span id="l31.234" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineplus">+}</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineplus">+</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineplus">+</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineplus">+RDFContainerUtilsImpl::IsBag(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineplus">+{</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l31.243"></a><span id="l31.243" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineplus">+</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.246"></a><span id="l31.246" class="difflineplus">+    if (! aResource)</span>
<a href="#l31.247"></a><span id="l31.247" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineplus">+</span>
<a href="#l31.249"></a><span id="l31.249" class="difflineplus">+    NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.250"></a><span id="l31.250" class="difflineplus">+    if (! _retval)</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.252"></a><span id="l31.252" class="difflineplus">+</span>
<a href="#l31.253"></a><span id="l31.253" class="difflineplus">+    *_retval = IsA(aDataSource, aResource, kRDF_Bag);</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineplus">+}</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineplus">+</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineplus">+</span>
<a href="#l31.258"></a><span id="l31.258" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.259"></a><span id="l31.259" class="difflineplus">+RDFContainerUtilsImpl::IsSeq(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l31.260"></a><span id="l31.260" class="difflineplus">+{</span>
<a href="#l31.261"></a><span id="l31.261" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.262"></a><span id="l31.262" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l31.263"></a><span id="l31.263" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.264"></a><span id="l31.264" class="difflineplus">+</span>
<a href="#l31.265"></a><span id="l31.265" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.266"></a><span id="l31.266" class="difflineplus">+    if (! aResource)</span>
<a href="#l31.267"></a><span id="l31.267" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.268"></a><span id="l31.268" class="difflineplus">+</span>
<a href="#l31.269"></a><span id="l31.269" class="difflineplus">+    NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.270"></a><span id="l31.270" class="difflineplus">+    if (! _retval)</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineplus">+</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineplus">+    *_retval = IsA(aDataSource, aResource, kRDF_Seq);</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineplus">+}</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+</span>
<a href="#l31.277"></a><span id="l31.277" class="difflineplus">+</span>
<a href="#l31.278"></a><span id="l31.278" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.279"></a><span id="l31.279" class="difflineplus">+RDFContainerUtilsImpl::IsAlt(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, bool *_retval)</span>
<a href="#l31.280"></a><span id="l31.280" class="difflineplus">+{</span>
<a href="#l31.281"></a><span id="l31.281" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.282"></a><span id="l31.282" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineplus">+</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineplus">+    if (! aResource)</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineplus">+</span>
<a href="#l31.289"></a><span id="l31.289" class="difflineplus">+    NS_PRECONDITION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.290"></a><span id="l31.290" class="difflineplus">+    if (! _retval)</span>
<a href="#l31.291"></a><span id="l31.291" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.292"></a><span id="l31.292" class="difflineplus">+</span>
<a href="#l31.293"></a><span id="l31.293" class="difflineplus">+    *_retval = IsA(aDataSource, aResource, kRDF_Alt);</span>
<a href="#l31.294"></a><span id="l31.294" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.295"></a><span id="l31.295" class="difflineplus">+}</span>
<a href="#l31.296"></a><span id="l31.296" class="difflineplus">+</span>
<a href="#l31.297"></a><span id="l31.297" class="difflineplus">+</span>
<a href="#l31.298"></a><span id="l31.298" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.299"></a><span id="l31.299" class="difflineplus">+RDFContainerUtilsImpl::MakeBag(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, nsIRDFContainer **_retval)</span>
<a href="#l31.300"></a><span id="l31.300" class="difflineplus">+{</span>
<a href="#l31.301"></a><span id="l31.301" class="difflineplus">+    return MakeContainer(aDataSource, aResource, kRDF_Bag, _retval);</span>
<a href="#l31.302"></a><span id="l31.302" class="difflineplus">+}</span>
<a href="#l31.303"></a><span id="l31.303" class="difflineplus">+</span>
<a href="#l31.304"></a><span id="l31.304" class="difflineplus">+</span>
<a href="#l31.305"></a><span id="l31.305" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.306"></a><span id="l31.306" class="difflineplus">+RDFContainerUtilsImpl::MakeSeq(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, nsIRDFContainer **_retval)</span>
<a href="#l31.307"></a><span id="l31.307" class="difflineplus">+{</span>
<a href="#l31.308"></a><span id="l31.308" class="difflineplus">+    return MakeContainer(aDataSource, aResource, kRDF_Seq, _retval);</span>
<a href="#l31.309"></a><span id="l31.309" class="difflineplus">+}</span>
<a href="#l31.310"></a><span id="l31.310" class="difflineplus">+</span>
<a href="#l31.311"></a><span id="l31.311" class="difflineplus">+</span>
<a href="#l31.312"></a><span id="l31.312" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.313"></a><span id="l31.313" class="difflineplus">+RDFContainerUtilsImpl::MakeAlt(nsIRDFDataSource *aDataSource, nsIRDFResource *aResource, nsIRDFContainer **_retval)</span>
<a href="#l31.314"></a><span id="l31.314" class="difflineplus">+{</span>
<a href="#l31.315"></a><span id="l31.315" class="difflineplus">+    return MakeContainer(aDataSource, aResource, kRDF_Alt, _retval);</span>
<a href="#l31.316"></a><span id="l31.316" class="difflineplus">+}</span>
<a href="#l31.317"></a><span id="l31.317" class="difflineplus">+</span>
<a href="#l31.318"></a><span id="l31.318" class="difflineplus">+</span>
<a href="#l31.319"></a><span id="l31.319" class="difflineplus">+</span>
<a href="#l31.320"></a><span id="l31.320" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.321"></a><span id="l31.321" class="difflineplus">+</span>
<a href="#l31.322"></a><span id="l31.322" class="difflineplus">+</span>
<a href="#l31.323"></a><span id="l31.323" class="difflineplus">+RDFContainerUtilsImpl::RDFContainerUtilsImpl()</span>
<a href="#l31.324"></a><span id="l31.324" class="difflineplus">+{</span>
<a href="#l31.325"></a><span id="l31.325" class="difflineplus">+    if (gRefCnt++ == 0) {</span>
<a href="#l31.326"></a><span id="l31.326" class="difflineplus">+        nsresult rv;</span>
<a href="#l31.327"></a><span id="l31.327" class="difflineplus">+</span>
<a href="#l31.328"></a><span id="l31.328" class="difflineplus">+        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l31.329"></a><span id="l31.329" class="difflineplus">+        rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l31.330"></a><span id="l31.330" class="difflineplus">+</span>
<a href="#l31.331"></a><span id="l31.331" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get RDF service&quot;);</span>
<a href="#l31.332"></a><span id="l31.332" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l31.333"></a><span id="l31.333" class="difflineplus">+            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;instanceOf&quot;),</span>
<a href="#l31.334"></a><span id="l31.334" class="difflineplus">+                                     &amp;kRDF_instanceOf);</span>
<a href="#l31.335"></a><span id="l31.335" class="difflineplus">+            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l31.336"></a><span id="l31.336" class="difflineplus">+                                     &amp;kRDF_nextVal);</span>
<a href="#l31.337"></a><span id="l31.337" class="difflineplus">+            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Bag&quot;),</span>
<a href="#l31.338"></a><span id="l31.338" class="difflineplus">+                                     &amp;kRDF_Bag);</span>
<a href="#l31.339"></a><span id="l31.339" class="difflineplus">+            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Seq&quot;),</span>
<a href="#l31.340"></a><span id="l31.340" class="difflineplus">+                                     &amp;kRDF_Seq);</span>
<a href="#l31.341"></a><span id="l31.341" class="difflineplus">+            gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Alt&quot;),</span>
<a href="#l31.342"></a><span id="l31.342" class="difflineplus">+                                     &amp;kRDF_Alt);</span>
<a href="#l31.343"></a><span id="l31.343" class="difflineplus">+            gRDFService-&gt;GetLiteral(u&quot;1&quot;, &amp;kOne);</span>
<a href="#l31.344"></a><span id="l31.344" class="difflineplus">+        }</span>
<a href="#l31.345"></a><span id="l31.345" class="difflineplus">+    }</span>
<a href="#l31.346"></a><span id="l31.346" class="difflineplus">+}</span>
<a href="#l31.347"></a><span id="l31.347" class="difflineplus">+</span>
<a href="#l31.348"></a><span id="l31.348" class="difflineplus">+</span>
<a href="#l31.349"></a><span id="l31.349" class="difflineplus">+RDFContainerUtilsImpl::~RDFContainerUtilsImpl()</span>
<a href="#l31.350"></a><span id="l31.350" class="difflineplus">+{</span>
<a href="#l31.351"></a><span id="l31.351" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l31.352"></a><span id="l31.352" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l31.353"></a><span id="l31.353" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: RDFContainerUtilsImpl\n&quot;, gInstanceCount);</span>
<a href="#l31.354"></a><span id="l31.354" class="difflineplus">+#endif</span>
<a href="#l31.355"></a><span id="l31.355" class="difflineplus">+</span>
<a href="#l31.356"></a><span id="l31.356" class="difflineplus">+    if (--gRefCnt == 0) {</span>
<a href="#l31.357"></a><span id="l31.357" class="difflineplus">+        NS_IF_RELEASE(gRDFService);</span>
<a href="#l31.358"></a><span id="l31.358" class="difflineplus">+        NS_IF_RELEASE(kRDF_instanceOf);</span>
<a href="#l31.359"></a><span id="l31.359" class="difflineplus">+        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l31.360"></a><span id="l31.360" class="difflineplus">+        NS_IF_RELEASE(kRDF_Bag);</span>
<a href="#l31.361"></a><span id="l31.361" class="difflineplus">+        NS_IF_RELEASE(kRDF_Seq);</span>
<a href="#l31.362"></a><span id="l31.362" class="difflineplus">+        NS_IF_RELEASE(kRDF_Alt);</span>
<a href="#l31.363"></a><span id="l31.363" class="difflineplus">+        NS_IF_RELEASE(kOne);</span>
<a href="#l31.364"></a><span id="l31.364" class="difflineplus">+    }</span>
<a href="#l31.365"></a><span id="l31.365" class="difflineplus">+}</span>
<a href="#l31.366"></a><span id="l31.366" class="difflineplus">+</span>
<a href="#l31.367"></a><span id="l31.367" class="difflineplus">+</span>
<a href="#l31.368"></a><span id="l31.368" class="difflineplus">+</span>
<a href="#l31.369"></a><span id="l31.369" class="difflineplus">+nsresult</span>
<a href="#l31.370"></a><span id="l31.370" class="difflineplus">+NS_NewRDFContainerUtils(nsIRDFContainerUtils** aResult)</span>
<a href="#l31.371"></a><span id="l31.371" class="difflineplus">+{</span>
<a href="#l31.372"></a><span id="l31.372" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.373"></a><span id="l31.373" class="difflineplus">+    if (! aResult)</span>
<a href="#l31.374"></a><span id="l31.374" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.375"></a><span id="l31.375" class="difflineplus">+</span>
<a href="#l31.376"></a><span id="l31.376" class="difflineplus">+    RDFContainerUtilsImpl* result =</span>
<a href="#l31.377"></a><span id="l31.377" class="difflineplus">+        new RDFContainerUtilsImpl();</span>
<a href="#l31.378"></a><span id="l31.378" class="difflineplus">+</span>
<a href="#l31.379"></a><span id="l31.379" class="difflineplus">+    if (! result)</span>
<a href="#l31.380"></a><span id="l31.380" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l31.381"></a><span id="l31.381" class="difflineplus">+</span>
<a href="#l31.382"></a><span id="l31.382" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l31.383"></a><span id="l31.383" class="difflineplus">+    *aResult = result;</span>
<a href="#l31.384"></a><span id="l31.384" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.385"></a><span id="l31.385" class="difflineplus">+}</span>
<a href="#l31.386"></a><span id="l31.386" class="difflineplus">+</span>
<a href="#l31.387"></a><span id="l31.387" class="difflineplus">+</span>
<a href="#l31.388"></a><span id="l31.388" class="difflineplus">+nsresult</span>
<a href="#l31.389"></a><span id="l31.389" class="difflineplus">+RDFContainerUtilsImpl::MakeContainer(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType, nsIRDFContainer** aResult)</span>
<a href="#l31.390"></a><span id="l31.390" class="difflineplus">+{</span>
<a href="#l31.391"></a><span id="l31.391" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.392"></a><span id="l31.392" class="difflineplus">+    if (! aDataSource)	return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.393"></a><span id="l31.393" class="difflineplus">+</span>
<a href="#l31.394"></a><span id="l31.394" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.395"></a><span id="l31.395" class="difflineplus">+    if (! aResource)	return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.396"></a><span id="l31.396" class="difflineplus">+</span>
<a href="#l31.397"></a><span id="l31.397" class="difflineplus">+    NS_PRECONDITION(aType != nullptr, &quot;null ptr&quot;);</span>
<a href="#l31.398"></a><span id="l31.398" class="difflineplus">+    if (! aType)	return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.399"></a><span id="l31.399" class="difflineplus">+</span>
<a href="#l31.400"></a><span id="l31.400" class="difflineplus">+    if (aResult)	*aResult = nullptr;</span>
<a href="#l31.401"></a><span id="l31.401" class="difflineplus">+</span>
<a href="#l31.402"></a><span id="l31.402" class="difflineplus">+    nsresult rv;</span>
<a href="#l31.403"></a><span id="l31.403" class="difflineplus">+</span>
<a href="#l31.404"></a><span id="l31.404" class="difflineplus">+    // Check to see if somebody has already turned it into a container; if so</span>
<a href="#l31.405"></a><span id="l31.405" class="difflineplus">+    // don't try to do it again.</span>
<a href="#l31.406"></a><span id="l31.406" class="difflineplus">+    bool isContainer;</span>
<a href="#l31.407"></a><span id="l31.407" class="difflineplus">+    rv = IsContainer(aDataSource, aResource, &amp;isContainer);</span>
<a href="#l31.408"></a><span id="l31.408" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.409"></a><span id="l31.409" class="difflineplus">+</span>
<a href="#l31.410"></a><span id="l31.410" class="difflineplus">+    if (!isContainer)</span>
<a href="#l31.411"></a><span id="l31.411" class="difflineplus">+    {</span>
<a href="#l31.412"></a><span id="l31.412" class="difflineplus">+	rv = aDataSource-&gt;Assert(aResource, kRDF_instanceOf, aType, true);</span>
<a href="#l31.413"></a><span id="l31.413" class="difflineplus">+	if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.414"></a><span id="l31.414" class="difflineplus">+</span>
<a href="#l31.415"></a><span id="l31.415" class="difflineplus">+	rv = aDataSource-&gt;Assert(aResource, kRDF_nextVal, kOne, true);</span>
<a href="#l31.416"></a><span id="l31.416" class="difflineplus">+	if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.417"></a><span id="l31.417" class="difflineplus">+    }</span>
<a href="#l31.418"></a><span id="l31.418" class="difflineplus">+</span>
<a href="#l31.419"></a><span id="l31.419" class="difflineplus">+    if (aResult) {</span>
<a href="#l31.420"></a><span id="l31.420" class="difflineplus">+        rv = NS_NewRDFContainer(aResult);</span>
<a href="#l31.421"></a><span id="l31.421" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.422"></a><span id="l31.422" class="difflineplus">+</span>
<a href="#l31.423"></a><span id="l31.423" class="difflineplus">+        rv = (*aResult)-&gt;Init(aDataSource, aResource);</span>
<a href="#l31.424"></a><span id="l31.424" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.425"></a><span id="l31.425" class="difflineplus">+    }</span>
<a href="#l31.426"></a><span id="l31.426" class="difflineplus">+</span>
<a href="#l31.427"></a><span id="l31.427" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.428"></a><span id="l31.428" class="difflineplus">+}</span>
<a href="#l31.429"></a><span id="l31.429" class="difflineplus">+</span>
<a href="#l31.430"></a><span id="l31.430" class="difflineplus">+bool</span>
<a href="#l31.431"></a><span id="l31.431" class="difflineplus">+RDFContainerUtilsImpl::IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType)</span>
<a href="#l31.432"></a><span id="l31.432" class="difflineplus">+{</span>
<a href="#l31.433"></a><span id="l31.433" class="difflineplus">+    if (!aDataSource || !aResource || !aType) {</span>
<a href="#l31.434"></a><span id="l31.434" class="difflineplus">+        NS_WARNING(&quot;Unexpected null argument&quot;);</span>
<a href="#l31.435"></a><span id="l31.435" class="difflineplus">+        return false;</span>
<a href="#l31.436"></a><span id="l31.436" class="difflineplus">+    }</span>
<a href="#l31.437"></a><span id="l31.437" class="difflineplus">+</span>
<a href="#l31.438"></a><span id="l31.438" class="difflineplus">+    nsresult rv;</span>
<a href="#l31.439"></a><span id="l31.439" class="difflineplus">+</span>
<a href="#l31.440"></a><span id="l31.440" class="difflineplus">+    bool result;</span>
<a href="#l31.441"></a><span id="l31.441" class="difflineplus">+    rv = aDataSource-&gt;HasAssertion(aResource, kRDF_instanceOf, aType, true, &amp;result);</span>
<a href="#l31.442"></a><span id="l31.442" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l31.443"></a><span id="l31.443" class="difflineplus">+      return false;</span>
<a href="#l31.444"></a><span id="l31.444" class="difflineplus">+</span>
<a href="#l31.445"></a><span id="l31.445" class="difflineplus">+    return result;</span>
<a href="#l31.446"></a><span id="l31.446" class="difflineplus">+}</span>
<a href="#l31.447"></a><span id="l31.447" class="difflineplus">+</span>
<a href="#l31.448"></a><span id="l31.448" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l31.449"></a><span id="l31.449" class="difflineplus">+RDFContainerUtilsImpl::IndexOf(nsIRDFDataSource* aDataSource, nsIRDFResource* aContainer, nsIRDFNode* aElement, int32_t* aIndex)</span>
<a href="#l31.450"></a><span id="l31.450" class="difflineplus">+{</span>
<a href="#l31.451"></a><span id="l31.451" class="difflineplus">+    if (!aDataSource || !aContainer)</span>
<a href="#l31.452"></a><span id="l31.452" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.453"></a><span id="l31.453" class="difflineplus">+</span>
<a href="#l31.454"></a><span id="l31.454" class="difflineplus">+    // Assume we can't find it.</span>
<a href="#l31.455"></a><span id="l31.455" class="difflineplus">+    *aIndex = -1;</span>
<a href="#l31.456"></a><span id="l31.456" class="difflineplus">+</span>
<a href="#l31.457"></a><span id="l31.457" class="difflineplus">+    // If the resource is null, bail quietly</span>
<a href="#l31.458"></a><span id="l31.458" class="difflineplus">+    if (! aElement)</span>
<a href="#l31.459"></a><span id="l31.459" class="difflineplus">+      return NS_OK;</span>
<a href="#l31.460"></a><span id="l31.460" class="difflineplus">+</span>
<a href="#l31.461"></a><span id="l31.461" class="difflineplus">+    // We'll assume that fan-out is much higher than fan-in, so grovel</span>
<a href="#l31.462"></a><span id="l31.462" class="difflineplus">+    // through the inbound arcs, look for an ordinal resource, and</span>
<a href="#l31.463"></a><span id="l31.463" class="difflineplus">+    // decode it.</span>
<a href="#l31.464"></a><span id="l31.464" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcsIn;</span>
<a href="#l31.465"></a><span id="l31.465" class="difflineplus">+    aDataSource-&gt;ArcLabelsIn(aElement, getter_AddRefs(arcsIn));</span>
<a href="#l31.466"></a><span id="l31.466" class="difflineplus">+    if (! arcsIn)</span>
<a href="#l31.467"></a><span id="l31.467" class="difflineplus">+        return NS_OK;</span>
<a href="#l31.468"></a><span id="l31.468" class="difflineplus">+</span>
<a href="#l31.469"></a><span id="l31.469" class="difflineplus">+    while (1) {</span>
<a href="#l31.470"></a><span id="l31.470" class="difflineplus">+        bool hasMoreArcs = false;</span>
<a href="#l31.471"></a><span id="l31.471" class="difflineplus">+        arcsIn-&gt;HasMoreElements(&amp;hasMoreArcs);</span>
<a href="#l31.472"></a><span id="l31.472" class="difflineplus">+        if (! hasMoreArcs)</span>
<a href="#l31.473"></a><span id="l31.473" class="difflineplus">+            break;</span>
<a href="#l31.474"></a><span id="l31.474" class="difflineplus">+</span>
<a href="#l31.475"></a><span id="l31.475" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l31.476"></a><span id="l31.476" class="difflineplus">+        arcsIn-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l31.477"></a><span id="l31.477" class="difflineplus">+        if (! isupports)</span>
<a href="#l31.478"></a><span id="l31.478" class="difflineplus">+            break;</span>
<a href="#l31.479"></a><span id="l31.479" class="difflineplus">+</span>
<a href="#l31.480"></a><span id="l31.480" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; property =</span>
<a href="#l31.481"></a><span id="l31.481" class="difflineplus">+            do_QueryInterface(isupports);</span>
<a href="#l31.482"></a><span id="l31.482" class="difflineplus">+</span>
<a href="#l31.483"></a><span id="l31.483" class="difflineplus">+        if (! property)</span>
<a href="#l31.484"></a><span id="l31.484" class="difflineplus">+            continue;</span>
<a href="#l31.485"></a><span id="l31.485" class="difflineplus">+</span>
<a href="#l31.486"></a><span id="l31.486" class="difflineplus">+        bool isOrdinal;</span>
<a href="#l31.487"></a><span id="l31.487" class="difflineplus">+        IsOrdinalProperty(property, &amp;isOrdinal);</span>
<a href="#l31.488"></a><span id="l31.488" class="difflineplus">+        if (! isOrdinal)</span>
<a href="#l31.489"></a><span id="l31.489" class="difflineplus">+            continue;</span>
<a href="#l31.490"></a><span id="l31.490" class="difflineplus">+</span>
<a href="#l31.491"></a><span id="l31.491" class="difflineplus">+        nsCOMPtr&lt;nsISimpleEnumerator&gt; sources;</span>
<a href="#l31.492"></a><span id="l31.492" class="difflineplus">+        aDataSource-&gt;GetSources(property, aElement, true, getter_AddRefs(sources));</span>
<a href="#l31.493"></a><span id="l31.493" class="difflineplus">+        if (! sources)</span>
<a href="#l31.494"></a><span id="l31.494" class="difflineplus">+            continue;</span>
<a href="#l31.495"></a><span id="l31.495" class="difflineplus">+</span>
<a href="#l31.496"></a><span id="l31.496" class="difflineplus">+        while (1) {</span>
<a href="#l31.497"></a><span id="l31.497" class="difflineplus">+            bool hasMoreSources = false;</span>
<a href="#l31.498"></a><span id="l31.498" class="difflineplus">+            sources-&gt;HasMoreElements(&amp;hasMoreSources);</span>
<a href="#l31.499"></a><span id="l31.499" class="difflineplus">+            if (! hasMoreSources)</span>
<a href="#l31.500"></a><span id="l31.500" class="difflineplus">+                break;</span>
<a href="#l31.501"></a><span id="l31.501" class="difflineplus">+</span>
<a href="#l31.502"></a><span id="l31.502" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; isupports2;</span>
<a href="#l31.503"></a><span id="l31.503" class="difflineplus">+            sources-&gt;GetNext(getter_AddRefs(isupports2));</span>
<a href="#l31.504"></a><span id="l31.504" class="difflineplus">+            if (! isupports2)</span>
<a href="#l31.505"></a><span id="l31.505" class="difflineplus">+                break;</span>
<a href="#l31.506"></a><span id="l31.506" class="difflineplus">+</span>
<a href="#l31.507"></a><span id="l31.507" class="difflineplus">+            nsCOMPtr&lt;nsIRDFResource&gt; source =</span>
<a href="#l31.508"></a><span id="l31.508" class="difflineplus">+                do_QueryInterface(isupports2);</span>
<a href="#l31.509"></a><span id="l31.509" class="difflineplus">+</span>
<a href="#l31.510"></a><span id="l31.510" class="difflineplus">+            if (source == aContainer)</span>
<a href="#l31.511"></a><span id="l31.511" class="difflineplus">+                // Found it.</span>
<a href="#l31.512"></a><span id="l31.512" class="difflineplus">+                return OrdinalResourceToIndex(property, aIndex);</span>
<a href="#l31.513"></a><span id="l31.513" class="difflineplus">+        }</span>
<a href="#l31.514"></a><span id="l31.514" class="difflineplus">+    }</span>
<a href="#l31.515"></a><span id="l31.515" class="difflineplus">+</span>
<a href="#l31.516"></a><span id="l31.516" class="difflineplus">+    return NS_OK;</span>
<a href="#l31.517"></a><span id="l31.517" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">new file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- /dev/null</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ b/rdf/base/nsRDFContentSink.cpp</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -0,0 +1,1444 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineplus">+/*</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineplus">+</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineplus">+  An implementation for an NGLayout-style content sink that knows how</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  to build an RDF content model from XML-serialized RDF.</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+  For more information on the RDF/XML syntax,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+  see http://www.w3.org/TR/REC-rdf-syntax/</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+  This code is based on the final W3C Recommendation,</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+  http://www.w3.org/TR/1999/REC-rdf-syntax-19990222.</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+  Open Issues ------------------</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+  1) factoring code with nsXMLContentSink - There's some amount of</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineplus">+     common code between this and the HTML content sink. This will</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+     increase as we support more and more HTML elements. How can code</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+     from XML/HTML be factored?</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+  2) We don't support the `parseType' attribute on the Description</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+     tag; therefore, it is impossible to &quot;inline&quot; raw XML in this</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+     implemenation.</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+  3) We don't build the reifications at parse time due to the</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+     footprint overhead it would incur for large RDF documents. (It</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+     may be possible to attach a &quot;reification&quot; wrapper datasource that</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineplus">+     would present this information at query-time.) Because of this,</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineplus">+     the `bagID' attribute is not processed correctly.</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+  4) No attempt is made to `resolve URIs' to a canonical form (the</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+     specification hints that an implementation should do this). This</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+     is omitted for the obvious reason that we can ill afford to</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+     resolve each URI reference.</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineplus">+</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+*/</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+#include &quot;nsIContentSink.h&quot;</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+#include &quot;nsIRDFContentSink.h&quot;</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineplus">+#include &quot;nsIRDFXMLSink.h&quot;</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+#include &quot;nsIURL.h&quot;</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineplus">+#include &quot;nsIXMLContentSink.h&quot;</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineplus">+#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+#include &quot;nsIExpatSink.h&quot;</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+#include &quot;nsAtom.h&quot;</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+#include &quot;nsGkAtoms.h&quot;</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+#include &quot;nsIScriptError.h&quot;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+#include &quot;nsIDTD.h&quot;</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+using namespace mozilla;</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+///////////////////////////////////////////////////////////////////////</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+enum RDFContentSinkState {</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+    eRDFContentSinkState_InProlog,</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+    eRDFContentSinkState_InDocumentElement,</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+    eRDFContentSinkState_InDescriptionElement,</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+    eRDFContentSinkState_InContainerElement,</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+    eRDFContentSinkState_InPropertyElement,</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+    eRDFContentSinkState_InMemberElement,</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+    eRDFContentSinkState_InEpilog</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+};</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+enum RDFContentSinkParseMode {</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+    eRDFContentSinkParseMode_Resource,</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+    eRDFContentSinkParseMode_Literal,</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+    eRDFContentSinkParseMode_Int,</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+    eRDFContentSinkParseMode_Date</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+};</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+typedef decltype(&amp;nsIRDFContainerUtils::IsAlt) nsContainerTestFn;</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+typedef decltype(&amp;nsIRDFContainerUtils::MakeAlt) nsMakeContainerFn;</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineplus">+</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineplus">+class RDFContentSinkImpl : public nsIRDFContentSink,</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+                           public nsIExpatSink</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineplus">+{</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+public:</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+    RDFContentSinkImpl();</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineplus">+    // nsISupports</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+    NS_DECL_NSIEXPATSINK</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+    // nsIContentSink</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+    NS_IMETHOD WillParse(void) override;</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+    NS_IMETHOD WillBuildModel(nsDTDMode aDTDMode) override;</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+    NS_IMETHOD DidBuildModel(bool aTerminated) override;</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+    NS_IMETHOD WillInterrupt(void) override;</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+    NS_IMETHOD WillResume(void) override;</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+    NS_IMETHOD SetParser(nsParserBase* aParser) override;</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineplus">+    virtual void FlushPendingNotifications(mozilla::FlushType aType) override { }</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+    virtual void SetDocumentCharset(NotNull&lt;const Encoding*&gt; aEncoding)</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineplus">+      override { }</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+    virtual nsISupports *GetTarget() override { return nullptr; }</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineplus">+</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineplus">+    // nsIRDFContentSink</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineplus">+    NS_IMETHOD Init(nsIURI* aURL) override;</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+    NS_IMETHOD SetDataSource(nsIRDFDataSource* aDataSource) override;</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineplus">+    NS_IMETHOD GetDataSource(nsIRDFDataSource*&amp; aDataSource) override;</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineplus">+</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+    // pseudo constants</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineplus">+    static int32_t gRefCnt;</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineplus">+    static nsIRDFService* gRDFService;</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+    static nsIRDFContainerUtils* gRDFContainerUtils;</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+    static nsIRDFResource* kRDF_type;</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+    static nsIRDFResource* kRDF_instanceOf; // XXX should be RDF:type</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+    static nsIRDFResource* kRDF_Alt;</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+    static nsIRDFResource* kRDF_Bag;</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineplus">+    static nsIRDFResource* kRDF_Seq;</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+    static nsIRDFResource* kRDF_nextVal;</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+</span>
<a href="#l32.133"></a><span id="l32.133" class="difflineplus">+    typedef struct ContainerInfo {</span>
<a href="#l32.134"></a><span id="l32.134" class="difflineplus">+        nsIRDFResource**  mType;</span>
<a href="#l32.135"></a><span id="l32.135" class="difflineplus">+        nsContainerTestFn mTestFn;</span>
<a href="#l32.136"></a><span id="l32.136" class="difflineplus">+        nsMakeContainerFn mMakeFn;</span>
<a href="#l32.137"></a><span id="l32.137" class="difflineplus">+    } ContainerInfo;</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineplus">+</span>
<a href="#l32.139"></a><span id="l32.139" class="difflineplus">+protected:</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineplus">+    virtual ~RDFContentSinkImpl();</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+    // Text management</span>
<a href="#l32.143"></a><span id="l32.143" class="difflineplus">+    void ParseText(nsIRDFNode **aResult);</span>
<a href="#l32.144"></a><span id="l32.144" class="difflineplus">+</span>
<a href="#l32.145"></a><span id="l32.145" class="difflineplus">+    nsresult FlushText();</span>
<a href="#l32.146"></a><span id="l32.146" class="difflineplus">+    nsresult AddText(const char16_t* aText, int32_t aLength);</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineplus">+</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineplus">+    // RDF-specific parsing</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+    nsresult OpenRDF(const char16_t* aName);</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+    nsresult OpenObject(const char16_t* aName ,const char16_t** aAttributes);</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+    nsresult OpenProperty(const char16_t* aName, const char16_t** aAttributes);</span>
<a href="#l32.152"></a><span id="l32.152" class="difflineplus">+    nsresult OpenMember(const char16_t* aName, const char16_t** aAttributes);</span>
<a href="#l32.153"></a><span id="l32.153" class="difflineplus">+    nsresult OpenValue(const char16_t* aName, const char16_t** aAttributes);</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+</span>
<a href="#l32.155"></a><span id="l32.155" class="difflineplus">+    nsresult GetIdAboutAttribute(const char16_t** aAttributes, nsIRDFResource** aResource, bool* aIsAnonymous = nullptr);</span>
<a href="#l32.156"></a><span id="l32.156" class="difflineplus">+    nsresult GetResourceAttribute(const char16_t** aAttributes, nsIRDFResource** aResource);</span>
<a href="#l32.157"></a><span id="l32.157" class="difflineplus">+    nsresult AddProperties(const char16_t** aAttributes, nsIRDFResource* aSubject, int32_t* aCount = nullptr);</span>
<a href="#l32.158"></a><span id="l32.158" class="difflineplus">+    void SetParseMode(const char16_t **aAttributes);</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineplus">+</span>
<a href="#l32.160"></a><span id="l32.160" class="difflineplus">+    char16_t* mText;</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineplus">+    int32_t mTextLength;</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineplus">+    int32_t mTextSize;</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineplus">+</span>
<a href="#l32.164"></a><span id="l32.164" class="difflineplus">+    /**</span>
<a href="#l32.165"></a><span id="l32.165" class="difflineplus">+     * From the set of given attributes, this method extracts the</span>
<a href="#l32.166"></a><span id="l32.166" class="difflineplus">+     * namespace definitions and feeds them to the datasource.</span>
<a href="#l32.167"></a><span id="l32.167" class="difflineplus">+     * These can then be suggested to the serializer to be used again.</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineplus">+     * Hopefully, this will keep namespace definitions intact in a</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+     * parse - serialize cycle.</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+     */</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineplus">+    void RegisterNamespaces(const char16_t **aAttributes);</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineplus">+</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineplus">+    /**</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineplus">+     * Extracts the localname from aExpatName, the name that the Expat parser</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineplus">+     * passes us.</span>
<a href="#l32.176"></a><span id="l32.176" class="difflineplus">+     * aLocalName will contain the localname in aExpatName.</span>
<a href="#l32.177"></a><span id="l32.177" class="difflineplus">+     * The return value is a dependent string containing just the namespace.</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineplus">+     */</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineplus">+    const nsDependentSubstring SplitExpatName(const char16_t *aExpatName,</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+                                              nsAtom **aLocalName);</span>
<a href="#l32.181"></a><span id="l32.181" class="difflineplus">+</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineplus">+    enum eContainerType { eBag, eSeq, eAlt };</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+    nsresult InitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer);</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+    nsresult ReinitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer);</span>
<a href="#l32.185"></a><span id="l32.185" class="difflineplus">+</span>
<a href="#l32.186"></a><span id="l32.186" class="difflineplus">+    // The datasource in which we're assigning assertions</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDataSource&gt; mDataSource;</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+</span>
<a href="#l32.189"></a><span id="l32.189" class="difflineplus">+    // A hash of all the node IDs referred to</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineplus">+    nsInterfaceHashtable&lt;nsStringHashKey, nsIRDFResource&gt; mNodeIDMap;</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineplus">+</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineplus">+    // The current state of the content sink</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineplus">+    RDFContentSinkState mState;</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineplus">+    RDFContentSinkParseMode mParseMode;</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineplus">+</span>
<a href="#l32.196"></a><span id="l32.196" class="difflineplus">+    // content stack management</span>
<a href="#l32.197"></a><span id="l32.197" class="difflineplus">+    int32_t</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineplus">+    PushContext(nsIRDFResource *aContext,</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+                RDFContentSinkState aState,</span>
<a href="#l32.200"></a><span id="l32.200" class="difflineplus">+                RDFContentSinkParseMode aParseMode);</span>
<a href="#l32.201"></a><span id="l32.201" class="difflineplus">+</span>
<a href="#l32.202"></a><span id="l32.202" class="difflineplus">+    nsresult</span>
<a href="#l32.203"></a><span id="l32.203" class="difflineplus">+    PopContext(nsIRDFResource         *&amp;aContext,</span>
<a href="#l32.204"></a><span id="l32.204" class="difflineplus">+               RDFContentSinkState     &amp;aState,</span>
<a href="#l32.205"></a><span id="l32.205" class="difflineplus">+               RDFContentSinkParseMode &amp;aParseMode);</span>
<a href="#l32.206"></a><span id="l32.206" class="difflineplus">+</span>
<a href="#l32.207"></a><span id="l32.207" class="difflineplus">+    nsIRDFResource* GetContextElement(int32_t ancestor = 0);</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineplus">+</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineplus">+</span>
<a href="#l32.210"></a><span id="l32.210" class="difflineplus">+    struct RDFContextStackElement {</span>
<a href="#l32.211"></a><span id="l32.211" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; mResource;</span>
<a href="#l32.212"></a><span id="l32.212" class="difflineplus">+        RDFContentSinkState      mState;</span>
<a href="#l32.213"></a><span id="l32.213" class="difflineplus">+        RDFContentSinkParseMode  mParseMode;</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineplus">+    };</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineplus">+</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineplus">+    AutoTArray&lt;RDFContextStackElement, 8&gt;* mContextStack;</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineplus">+</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; mDocumentURL;</span>
<a href="#l32.219"></a><span id="l32.219" class="difflineplus">+</span>
<a href="#l32.220"></a><span id="l32.220" class="difflineplus">+private:</span>
<a href="#l32.221"></a><span id="l32.221" class="difflineplus">+    static mozilla::LazyLogModule gLog;</span>
<a href="#l32.222"></a><span id="l32.222" class="difflineplus">+};</span>
<a href="#l32.223"></a><span id="l32.223" class="difflineplus">+</span>
<a href="#l32.224"></a><span id="l32.224" class="difflineplus">+int32_t         RDFContentSinkImpl::gRefCnt = 0;</span>
<a href="#l32.225"></a><span id="l32.225" class="difflineplus">+nsIRDFService*  RDFContentSinkImpl::gRDFService;</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineplus">+nsIRDFContainerUtils* RDFContentSinkImpl::gRDFContainerUtils;</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineplus">+nsIRDFResource* RDFContentSinkImpl::kRDF_type;</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineplus">+nsIRDFResource* RDFContentSinkImpl::kRDF_instanceOf;</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineplus">+nsIRDFResource* RDFContentSinkImpl::kRDF_Alt;</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineplus">+nsIRDFResource* RDFContentSinkImpl::kRDF_Bag;</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineplus">+nsIRDFResource* RDFContentSinkImpl::kRDF_Seq;</span>
<a href="#l32.232"></a><span id="l32.232" class="difflineplus">+nsIRDFResource* RDFContentSinkImpl::kRDF_nextVal;</span>
<a href="#l32.233"></a><span id="l32.233" class="difflineplus">+</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineplus">+mozilla::LazyLogModule RDFContentSinkImpl::gLog(&quot;nsRDFContentSink&quot;);</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineplus">+</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineplus">+</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineplus">+RDFContentSinkImpl::RDFContentSinkImpl()</span>
<a href="#l32.239"></a><span id="l32.239" class="difflineplus">+    : mText(nullptr),</span>
<a href="#l32.240"></a><span id="l32.240" class="difflineplus">+      mTextLength(0),</span>
<a href="#l32.241"></a><span id="l32.241" class="difflineplus">+      mTextSize(0),</span>
<a href="#l32.242"></a><span id="l32.242" class="difflineplus">+      mState(eRDFContentSinkState_InProlog),</span>
<a href="#l32.243"></a><span id="l32.243" class="difflineplus">+      mParseMode(eRDFContentSinkParseMode_Literal),</span>
<a href="#l32.244"></a><span id="l32.244" class="difflineplus">+      mContextStack(nullptr)</span>
<a href="#l32.245"></a><span id="l32.245" class="difflineplus">+{</span>
<a href="#l32.246"></a><span id="l32.246" class="difflineplus">+    if (gRefCnt++ == 0) {</span>
<a href="#l32.247"></a><span id="l32.247" class="difflineplus">+        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l32.248"></a><span id="l32.248" class="difflineplus">+        nsresult rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineplus">+</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get RDF service&quot;);</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.252"></a><span id="l32.252" class="difflineplus">+            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;type&quot;),</span>
<a href="#l32.253"></a><span id="l32.253" class="difflineplus">+                                          &amp;kRDF_type);</span>
<a href="#l32.254"></a><span id="l32.254" class="difflineplus">+            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;instanceOf&quot;),</span>
<a href="#l32.255"></a><span id="l32.255" class="difflineplus">+                                          &amp;kRDF_instanceOf);</span>
<a href="#l32.256"></a><span id="l32.256" class="difflineplus">+            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Alt&quot;),</span>
<a href="#l32.257"></a><span id="l32.257" class="difflineplus">+                                          &amp;kRDF_Alt);</span>
<a href="#l32.258"></a><span id="l32.258" class="difflineplus">+            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Bag&quot;),</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineplus">+                                          &amp;kRDF_Bag);</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineplus">+            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Seq&quot;),</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineplus">+                                          &amp;kRDF_Seq);</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineplus">+            rv = gRDFService-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineplus">+                                          &amp;kRDF_nextVal);</span>
<a href="#l32.264"></a><span id="l32.264" class="difflineplus">+        }</span>
<a href="#l32.265"></a><span id="l32.265" class="difflineplus">+</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineplus">+        NS_DEFINE_CID(kRDFContainerUtilsCID, NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineplus">+        rv = CallGetService(kRDFContainerUtilsCID, &amp;gRDFContainerUtils);</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineplus">+    }</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineplus">+}</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineplus">+</span>
<a href="#l32.271"></a><span id="l32.271" class="difflineplus">+</span>
<a href="#l32.272"></a><span id="l32.272" class="difflineplus">+RDFContentSinkImpl::~RDFContentSinkImpl()</span>
<a href="#l32.273"></a><span id="l32.273" class="difflineplus">+{</span>
<a href="#l32.274"></a><span id="l32.274" class="difflineplus">+#ifdef DEBUG_REFS</span>
<a href="#l32.275"></a><span id="l32.275" class="difflineplus">+    --gInstanceCount;</span>
<a href="#l32.276"></a><span id="l32.276" class="difflineplus">+    fprintf(stdout, &quot;%d - RDF: RDFContentSinkImpl\n&quot;, gInstanceCount);</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineplus">+#endif</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineplus">+</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineplus">+    if (mContextStack) {</span>
<a href="#l32.280"></a><span id="l32.280" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l32.281"></a><span id="l32.281" class="difflineplus">+               (&quot;rdfxml: warning! unclosed tag&quot;));</span>
<a href="#l32.282"></a><span id="l32.282" class="difflineplus">+</span>
<a href="#l32.283"></a><span id="l32.283" class="difflineplus">+        // XXX we should never need to do this, but, we'll write the</span>
<a href="#l32.284"></a><span id="l32.284" class="difflineplus">+        // code all the same. If someone left the content stack dirty,</span>
<a href="#l32.285"></a><span id="l32.285" class="difflineplus">+        // pop all the elements off the stack and release them.</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineplus">+        int32_t i = mContextStack-&gt;Length();</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineplus">+        while (0 &lt; i--) {</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineplus">+            nsIRDFResource* resource = nullptr;</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineplus">+            RDFContentSinkState state;</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineplus">+            RDFContentSinkParseMode parseMode;</span>
<a href="#l32.291"></a><span id="l32.291" class="difflineplus">+            PopContext(resource, state, parseMode);</span>
<a href="#l32.292"></a><span id="l32.292" class="difflineplus">+</span>
<a href="#l32.293"></a><span id="l32.293" class="difflineplus">+            // print some fairly useless debugging info</span>
<a href="#l32.294"></a><span id="l32.294" class="difflineplus">+            // XXX we should save line numbers on the context stack: this'd</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineplus">+            // be about 1000x more helpful.</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineplus">+            if (resource &amp;&amp; MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineplus">+                nsCString uri;</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineplus">+                resource-&gt;GetValue(getter_Copies(uri));</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineplus">+                MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineplus">+                       (&quot;rdfxml:   uri=%s&quot;, uri.get()));</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineplus">+            }</span>
<a href="#l32.302"></a><span id="l32.302" class="difflineplus">+</span>
<a href="#l32.303"></a><span id="l32.303" class="difflineplus">+            NS_IF_RELEASE(resource);</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineplus">+        }</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineplus">+</span>
<a href="#l32.306"></a><span id="l32.306" class="difflineplus">+        delete mContextStack;</span>
<a href="#l32.307"></a><span id="l32.307" class="difflineplus">+    }</span>
<a href="#l32.308"></a><span id="l32.308" class="difflineplus">+    free(mText);</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineplus">+</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineplus">+</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineplus">+    if (--gRefCnt == 0) {</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineplus">+        NS_IF_RELEASE(gRDFService);</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineplus">+        NS_IF_RELEASE(gRDFContainerUtils);</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineplus">+        NS_IF_RELEASE(kRDF_type);</span>
<a href="#l32.315"></a><span id="l32.315" class="difflineplus">+        NS_IF_RELEASE(kRDF_instanceOf);</span>
<a href="#l32.316"></a><span id="l32.316" class="difflineplus">+        NS_IF_RELEASE(kRDF_Alt);</span>
<a href="#l32.317"></a><span id="l32.317" class="difflineplus">+        NS_IF_RELEASE(kRDF_Bag);</span>
<a href="#l32.318"></a><span id="l32.318" class="difflineplus">+        NS_IF_RELEASE(kRDF_Seq);</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineplus">+        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineplus">+    }</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineplus">+}</span>
<a href="#l32.322"></a><span id="l32.322" class="difflineplus">+</span>
<a href="#l32.323"></a><span id="l32.323" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineplus">+// nsISupports interface</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineplus">+</span>
<a href="#l32.326"></a><span id="l32.326" class="difflineplus">+NS_IMPL_ADDREF(RDFContentSinkImpl)</span>
<a href="#l32.327"></a><span id="l32.327" class="difflineplus">+NS_IMPL_RELEASE(RDFContentSinkImpl)</span>
<a href="#l32.328"></a><span id="l32.328" class="difflineplus">+</span>
<a href="#l32.329"></a><span id="l32.329" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.330"></a><span id="l32.330" class="difflineplus">+RDFContentSinkImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineplus">+{</span>
<a href="#l32.332"></a><span id="l32.332" class="difflineplus">+    NS_PRECONDITION(result, &quot;null ptr&quot;);</span>
<a href="#l32.333"></a><span id="l32.333" class="difflineplus">+    if (! result)</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineplus">+</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineplus">+    NS_DEFINE_IID(kIContentSinkIID,    NS_ICONTENT_SINK_IID);</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineplus">+    NS_DEFINE_IID(kIExpatSinkIID,      NS_IEXPATSINK_IID);</span>
<a href="#l32.338"></a><span id="l32.338" class="difflineplus">+    NS_DEFINE_IID(kISupportsIID,       NS_ISUPPORTS_IID);</span>
<a href="#l32.339"></a><span id="l32.339" class="difflineplus">+    NS_DEFINE_IID(kIXMLContentSinkIID, NS_IXMLCONTENT_SINK_IID);</span>
<a href="#l32.340"></a><span id="l32.340" class="difflineplus">+    NS_DEFINE_IID(kIRDFContentSinkIID, NS_IRDFCONTENTSINK_IID);</span>
<a href="#l32.341"></a><span id="l32.341" class="difflineplus">+</span>
<a href="#l32.342"></a><span id="l32.342" class="difflineplus">+    *result = nullptr;</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineplus">+    if (iid.Equals(kIRDFContentSinkIID) ||</span>
<a href="#l32.344"></a><span id="l32.344" class="difflineplus">+        iid.Equals(kIXMLContentSinkIID) ||</span>
<a href="#l32.345"></a><span id="l32.345" class="difflineplus">+        iid.Equals(kIContentSinkIID) ||</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineplus">+        iid.Equals(kISupportsIID)) {</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineplus">+        *result = static_cast&lt;nsIXMLContentSink*&gt;(this);</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineplus">+        AddRef();</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineplus">+        return NS_OK;</span>
<a href="#l32.350"></a><span id="l32.350" class="difflineplus">+    }</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineplus">+    else if (iid.Equals(kIExpatSinkIID)) {</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineplus">+      *result = static_cast&lt;nsIExpatSink*&gt;(this);</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineplus">+       AddRef();</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineplus">+       return NS_OK;</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineplus">+    }</span>
<a href="#l32.356"></a><span id="l32.356" class="difflineplus">+    return NS_NOINTERFACE;</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineplus">+}</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineplus">+</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.360"></a><span id="l32.360" class="difflineplus">+RDFContentSinkImpl::HandleStartElement(const char16_t *aName,</span>
<a href="#l32.361"></a><span id="l32.361" class="difflineplus">+                                       const char16_t **aAtts,</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineplus">+                                       uint32_t aAttsCount,</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineplus">+                                       uint32_t aLineNumber)</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineplus">+{</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineplus">+  FlushText();</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineplus">+</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineplus">+  nsresult rv = NS_ERROR_UNEXPECTED; // XXX</span>
<a href="#l32.368"></a><span id="l32.368" class="difflineplus">+</span>
<a href="#l32.369"></a><span id="l32.369" class="difflineplus">+  RegisterNamespaces(aAtts);</span>
<a href="#l32.370"></a><span id="l32.370" class="difflineplus">+</span>
<a href="#l32.371"></a><span id="l32.371" class="difflineplus">+  switch (mState) {</span>
<a href="#l32.372"></a><span id="l32.372" class="difflineplus">+  case eRDFContentSinkState_InProlog:</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineplus">+      rv = OpenRDF(aName);</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineplus">+      break;</span>
<a href="#l32.375"></a><span id="l32.375" class="difflineplus">+</span>
<a href="#l32.376"></a><span id="l32.376" class="difflineplus">+  case eRDFContentSinkState_InDocumentElement:</span>
<a href="#l32.377"></a><span id="l32.377" class="difflineplus">+      rv = OpenObject(aName,aAtts);</span>
<a href="#l32.378"></a><span id="l32.378" class="difflineplus">+      break;</span>
<a href="#l32.379"></a><span id="l32.379" class="difflineplus">+</span>
<a href="#l32.380"></a><span id="l32.380" class="difflineplus">+  case eRDFContentSinkState_InDescriptionElement:</span>
<a href="#l32.381"></a><span id="l32.381" class="difflineplus">+      rv = OpenProperty(aName,aAtts);</span>
<a href="#l32.382"></a><span id="l32.382" class="difflineplus">+      break;</span>
<a href="#l32.383"></a><span id="l32.383" class="difflineplus">+</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineplus">+  case eRDFContentSinkState_InContainerElement:</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineplus">+      rv = OpenMember(aName,aAtts);</span>
<a href="#l32.386"></a><span id="l32.386" class="difflineplus">+      break;</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineplus">+</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineplus">+  case eRDFContentSinkState_InPropertyElement:</span>
<a href="#l32.389"></a><span id="l32.389" class="difflineplus">+  case eRDFContentSinkState_InMemberElement:</span>
<a href="#l32.390"></a><span id="l32.390" class="difflineplus">+      rv = OpenValue(aName,aAtts);</span>
<a href="#l32.391"></a><span id="l32.391" class="difflineplus">+      break;</span>
<a href="#l32.392"></a><span id="l32.392" class="difflineplus">+</span>
<a href="#l32.393"></a><span id="l32.393" class="difflineplus">+  case eRDFContentSinkState_InEpilog:</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineplus">+      MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineplus">+             (&quot;rdfxml: unexpected content in epilog at line %d&quot;,</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineplus">+              aLineNumber));</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineplus">+      break;</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineplus">+  }</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineplus">+</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineplus">+  return rv;</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineplus">+}</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineplus">+</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineplus">+RDFContentSinkImpl::HandleEndElement(const char16_t *aName)</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineplus">+{</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineplus">+  FlushText();</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineplus">+</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineplus">+  nsIRDFResource* resource;</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineplus">+  if (NS_FAILED(PopContext(resource, mState, mParseMode))) {</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineplus">+      // XXX parser didn't catch unmatched tags?</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineplus">+      if (MOZ_LOG_TEST(gLog, LogLevel::Warning)) {</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineplus">+          nsAutoString tagStr(aName);</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineplus">+          char* tagCStr = ToNewCString(tagStr);</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineplus">+</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineplus">+          MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineplus">+                 (&quot;rdfxml: extra close tag '%s' at line %d&quot;,</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineplus">+                  tagCStr, 0/*XXX fix me */));</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineplus">+</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineplus">+          free(tagCStr);</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineplus">+      }</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineplus">+</span>
<a href="#l32.422"></a><span id="l32.422" class="difflineplus">+      return NS_ERROR_UNEXPECTED; // XXX</span>
<a href="#l32.423"></a><span id="l32.423" class="difflineplus">+  }</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineplus">+</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineplus">+  // If we've just popped a member or property element, _now_ is the</span>
<a href="#l32.426"></a><span id="l32.426" class="difflineplus">+  // time to add that element to the graph.</span>
<a href="#l32.427"></a><span id="l32.427" class="difflineplus">+  switch (mState) {</span>
<a href="#l32.428"></a><span id="l32.428" class="difflineplus">+    case eRDFContentSinkState_InMemberElement:</span>
<a href="#l32.429"></a><span id="l32.429" class="difflineplus">+      {</span>
<a href="#l32.430"></a><span id="l32.430" class="difflineplus">+        nsCOMPtr&lt;nsIRDFContainer&gt; container;</span>
<a href="#l32.431"></a><span id="l32.431" class="difflineplus">+        NS_NewRDFContainer(getter_AddRefs(container));</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineplus">+        container-&gt;Init(mDataSource, GetContextElement(1));</span>
<a href="#l32.433"></a><span id="l32.433" class="difflineplus">+        container-&gt;AppendElement(resource);</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineplus">+      }</span>
<a href="#l32.435"></a><span id="l32.435" class="difflineplus">+      break;</span>
<a href="#l32.436"></a><span id="l32.436" class="difflineplus">+</span>
<a href="#l32.437"></a><span id="l32.437" class="difflineplus">+    case eRDFContentSinkState_InPropertyElement:</span>
<a href="#l32.438"></a><span id="l32.438" class="difflineplus">+      {</span>
<a href="#l32.439"></a><span id="l32.439" class="difflineplus">+        mDataSource-&gt;Assert(GetContextElement(1), GetContextElement(0), resource, true);</span>
<a href="#l32.440"></a><span id="l32.440" class="difflineplus">+      } break;</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineplus">+    default:</span>
<a href="#l32.442"></a><span id="l32.442" class="difflineplus">+      break;</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineplus">+  }</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineplus">+</span>
<a href="#l32.445"></a><span id="l32.445" class="difflineplus">+  if (mContextStack-&gt;IsEmpty())</span>
<a href="#l32.446"></a><span id="l32.446" class="difflineplus">+      mState = eRDFContentSinkState_InEpilog;</span>
<a href="#l32.447"></a><span id="l32.447" class="difflineplus">+</span>
<a href="#l32.448"></a><span id="l32.448" class="difflineplus">+  NS_IF_RELEASE(resource);</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineplus">+}</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineplus">+</span>
<a href="#l32.452"></a><span id="l32.452" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.453"></a><span id="l32.453" class="difflineplus">+RDFContentSinkImpl::HandleComment(const char16_t *aName)</span>
<a href="#l32.454"></a><span id="l32.454" class="difflineplus">+{</span>
<a href="#l32.455"></a><span id="l32.455" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.456"></a><span id="l32.456" class="difflineplus">+}</span>
<a href="#l32.457"></a><span id="l32.457" class="difflineplus">+</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineplus">+RDFContentSinkImpl::HandleCDataSection(const char16_t *aData,</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineplus">+                                       uint32_t aLength)</span>
<a href="#l32.461"></a><span id="l32.461" class="difflineplus">+{</span>
<a href="#l32.462"></a><span id="l32.462" class="difflineplus">+  return aData ?  AddText(aData, aLength) : NS_OK;</span>
<a href="#l32.463"></a><span id="l32.463" class="difflineplus">+}</span>
<a href="#l32.464"></a><span id="l32.464" class="difflineplus">+</span>
<a href="#l32.465"></a><span id="l32.465" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.466"></a><span id="l32.466" class="difflineplus">+RDFContentSinkImpl::HandleDoctypeDecl(const nsAString &amp; aSubset,</span>
<a href="#l32.467"></a><span id="l32.467" class="difflineplus">+                                      const nsAString &amp; aName,</span>
<a href="#l32.468"></a><span id="l32.468" class="difflineplus">+                                      const nsAString &amp; aSystemId,</span>
<a href="#l32.469"></a><span id="l32.469" class="difflineplus">+                                      const nsAString &amp; aPublicId,</span>
<a href="#l32.470"></a><span id="l32.470" class="difflineplus">+                                      nsISupports* aCatalogData)</span>
<a href="#l32.471"></a><span id="l32.471" class="difflineplus">+{</span>
<a href="#l32.472"></a><span id="l32.472" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.473"></a><span id="l32.473" class="difflineplus">+}</span>
<a href="#l32.474"></a><span id="l32.474" class="difflineplus">+</span>
<a href="#l32.475"></a><span id="l32.475" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.476"></a><span id="l32.476" class="difflineplus">+RDFContentSinkImpl::HandleCharacterData(const char16_t *aData,</span>
<a href="#l32.477"></a><span id="l32.477" class="difflineplus">+                                        uint32_t aLength)</span>
<a href="#l32.478"></a><span id="l32.478" class="difflineplus">+{</span>
<a href="#l32.479"></a><span id="l32.479" class="difflineplus">+  return aData ?  AddText(aData, aLength) : NS_OK;</span>
<a href="#l32.480"></a><span id="l32.480" class="difflineplus">+}</span>
<a href="#l32.481"></a><span id="l32.481" class="difflineplus">+</span>
<a href="#l32.482"></a><span id="l32.482" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.483"></a><span id="l32.483" class="difflineplus">+RDFContentSinkImpl::HandleProcessingInstruction(const char16_t *aTarget,</span>
<a href="#l32.484"></a><span id="l32.484" class="difflineplus">+                                                const char16_t *aData)</span>
<a href="#l32.485"></a><span id="l32.485" class="difflineplus">+{</span>
<a href="#l32.486"></a><span id="l32.486" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.487"></a><span id="l32.487" class="difflineplus">+}</span>
<a href="#l32.488"></a><span id="l32.488" class="difflineplus">+</span>
<a href="#l32.489"></a><span id="l32.489" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.490"></a><span id="l32.490" class="difflineplus">+RDFContentSinkImpl::HandleXMLDeclaration(const char16_t *aVersion,</span>
<a href="#l32.491"></a><span id="l32.491" class="difflineplus">+                                         const char16_t *aEncoding,</span>
<a href="#l32.492"></a><span id="l32.492" class="difflineplus">+                                         int32_t aStandalone)</span>
<a href="#l32.493"></a><span id="l32.493" class="difflineplus">+{</span>
<a href="#l32.494"></a><span id="l32.494" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.495"></a><span id="l32.495" class="difflineplus">+}</span>
<a href="#l32.496"></a><span id="l32.496" class="difflineplus">+</span>
<a href="#l32.497"></a><span id="l32.497" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.498"></a><span id="l32.498" class="difflineplus">+RDFContentSinkImpl::ReportError(const char16_t* aErrorText,</span>
<a href="#l32.499"></a><span id="l32.499" class="difflineplus">+                                const char16_t* aSourceText,</span>
<a href="#l32.500"></a><span id="l32.500" class="difflineplus">+                                nsIScriptError *aError,</span>
<a href="#l32.501"></a><span id="l32.501" class="difflineplus">+                                bool *_retval)</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineplus">+{</span>
<a href="#l32.503"></a><span id="l32.503" class="difflineplus">+  NS_PRECONDITION(aError &amp;&amp; aSourceText &amp;&amp; aErrorText, &quot;Check arguments!!!&quot;);</span>
<a href="#l32.504"></a><span id="l32.504" class="difflineplus">+</span>
<a href="#l32.505"></a><span id="l32.505" class="difflineplus">+  // The expat driver should report the error.</span>
<a href="#l32.506"></a><span id="l32.506" class="difflineplus">+  *_retval = true;</span>
<a href="#l32.507"></a><span id="l32.507" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.508"></a><span id="l32.508" class="difflineplus">+}</span>
<a href="#l32.509"></a><span id="l32.509" class="difflineplus">+</span>
<a href="#l32.510"></a><span id="l32.510" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.511"></a><span id="l32.511" class="difflineplus">+// nsIContentSink interface</span>
<a href="#l32.512"></a><span id="l32.512" class="difflineplus">+</span>
<a href="#l32.513"></a><span id="l32.513" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.514"></a><span id="l32.514" class="difflineplus">+RDFContentSinkImpl::WillParse(void)</span>
<a href="#l32.515"></a><span id="l32.515" class="difflineplus">+{</span>
<a href="#l32.516"></a><span id="l32.516" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.517"></a><span id="l32.517" class="difflineplus">+}</span>
<a href="#l32.518"></a><span id="l32.518" class="difflineplus">+</span>
<a href="#l32.519"></a><span id="l32.519" class="difflineplus">+</span>
<a href="#l32.520"></a><span id="l32.520" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.521"></a><span id="l32.521" class="difflineplus">+RDFContentSinkImpl::WillBuildModel(nsDTDMode)</span>
<a href="#l32.522"></a><span id="l32.522" class="difflineplus">+{</span>
<a href="#l32.523"></a><span id="l32.523" class="difflineplus">+    if (mDataSource) {</span>
<a href="#l32.524"></a><span id="l32.524" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l32.525"></a><span id="l32.525" class="difflineplus">+        if (sink)</span>
<a href="#l32.526"></a><span id="l32.526" class="difflineplus">+            return sink-&gt;BeginLoad();</span>
<a href="#l32.527"></a><span id="l32.527" class="difflineplus">+    }</span>
<a href="#l32.528"></a><span id="l32.528" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.529"></a><span id="l32.529" class="difflineplus">+}</span>
<a href="#l32.530"></a><span id="l32.530" class="difflineplus">+</span>
<a href="#l32.531"></a><span id="l32.531" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.532"></a><span id="l32.532" class="difflineplus">+RDFContentSinkImpl::DidBuildModel(bool aTerminated)</span>
<a href="#l32.533"></a><span id="l32.533" class="difflineplus">+{</span>
<a href="#l32.534"></a><span id="l32.534" class="difflineplus">+    if (mDataSource) {</span>
<a href="#l32.535"></a><span id="l32.535" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l32.536"></a><span id="l32.536" class="difflineplus">+        if (sink)</span>
<a href="#l32.537"></a><span id="l32.537" class="difflineplus">+            return sink-&gt;EndLoad();</span>
<a href="#l32.538"></a><span id="l32.538" class="difflineplus">+    }</span>
<a href="#l32.539"></a><span id="l32.539" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.540"></a><span id="l32.540" class="difflineplus">+}</span>
<a href="#l32.541"></a><span id="l32.541" class="difflineplus">+</span>
<a href="#l32.542"></a><span id="l32.542" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.543"></a><span id="l32.543" class="difflineplus">+RDFContentSinkImpl::WillInterrupt(void)</span>
<a href="#l32.544"></a><span id="l32.544" class="difflineplus">+{</span>
<a href="#l32.545"></a><span id="l32.545" class="difflineplus">+    if (mDataSource) {</span>
<a href="#l32.546"></a><span id="l32.546" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l32.547"></a><span id="l32.547" class="difflineplus">+        if (sink)</span>
<a href="#l32.548"></a><span id="l32.548" class="difflineplus">+            return sink-&gt;Interrupt();</span>
<a href="#l32.549"></a><span id="l32.549" class="difflineplus">+    }</span>
<a href="#l32.550"></a><span id="l32.550" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.551"></a><span id="l32.551" class="difflineplus">+}</span>
<a href="#l32.552"></a><span id="l32.552" class="difflineplus">+</span>
<a href="#l32.553"></a><span id="l32.553" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.554"></a><span id="l32.554" class="difflineplus">+RDFContentSinkImpl::WillResume(void)</span>
<a href="#l32.555"></a><span id="l32.555" class="difflineplus">+{</span>
<a href="#l32.556"></a><span id="l32.556" class="difflineplus">+    if (mDataSource) {</span>
<a href="#l32.557"></a><span id="l32.557" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l32.558"></a><span id="l32.558" class="difflineplus">+        if (sink)</span>
<a href="#l32.559"></a><span id="l32.559" class="difflineplus">+            return sink-&gt;Resume();</span>
<a href="#l32.560"></a><span id="l32.560" class="difflineplus">+    }</span>
<a href="#l32.561"></a><span id="l32.561" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.562"></a><span id="l32.562" class="difflineplus">+}</span>
<a href="#l32.563"></a><span id="l32.563" class="difflineplus">+</span>
<a href="#l32.564"></a><span id="l32.564" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.565"></a><span id="l32.565" class="difflineplus">+RDFContentSinkImpl::SetParser(nsParserBase* aParser)</span>
<a href="#l32.566"></a><span id="l32.566" class="difflineplus">+{</span>
<a href="#l32.567"></a><span id="l32.567" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.568"></a><span id="l32.568" class="difflineplus">+}</span>
<a href="#l32.569"></a><span id="l32.569" class="difflineplus">+</span>
<a href="#l32.570"></a><span id="l32.570" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.571"></a><span id="l32.571" class="difflineplus">+// nsIRDFContentSink interface</span>
<a href="#l32.572"></a><span id="l32.572" class="difflineplus">+</span>
<a href="#l32.573"></a><span id="l32.573" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.574"></a><span id="l32.574" class="difflineplus">+RDFContentSinkImpl::Init(nsIURI* aURL)</span>
<a href="#l32.575"></a><span id="l32.575" class="difflineplus">+{</span>
<a href="#l32.576"></a><span id="l32.576" class="difflineplus">+    NS_PRECONDITION(aURL != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.577"></a><span id="l32.577" class="difflineplus">+    if (! aURL)</span>
<a href="#l32.578"></a><span id="l32.578" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.579"></a><span id="l32.579" class="difflineplus">+</span>
<a href="#l32.580"></a><span id="l32.580" class="difflineplus">+    mDocumentURL = aURL;</span>
<a href="#l32.581"></a><span id="l32.581" class="difflineplus">+    mState = eRDFContentSinkState_InProlog;</span>
<a href="#l32.582"></a><span id="l32.582" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.583"></a><span id="l32.583" class="difflineplus">+}</span>
<a href="#l32.584"></a><span id="l32.584" class="difflineplus">+</span>
<a href="#l32.585"></a><span id="l32.585" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.586"></a><span id="l32.586" class="difflineplus">+RDFContentSinkImpl::SetDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l32.587"></a><span id="l32.587" class="difflineplus">+{</span>
<a href="#l32.588"></a><span id="l32.588" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;SetDataSource null ptr&quot;);</span>
<a href="#l32.589"></a><span id="l32.589" class="difflineplus">+    mDataSource = aDataSource;</span>
<a href="#l32.590"></a><span id="l32.590" class="difflineplus">+    NS_ASSERTION(mDataSource != nullptr,&quot;Couldn't QI RDF DataSource&quot;);</span>
<a href="#l32.591"></a><span id="l32.591" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.592"></a><span id="l32.592" class="difflineplus">+}</span>
<a href="#l32.593"></a><span id="l32.593" class="difflineplus">+</span>
<a href="#l32.594"></a><span id="l32.594" class="difflineplus">+</span>
<a href="#l32.595"></a><span id="l32.595" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l32.596"></a><span id="l32.596" class="difflineplus">+RDFContentSinkImpl::GetDataSource(nsIRDFDataSource*&amp; aDataSource)</span>
<a href="#l32.597"></a><span id="l32.597" class="difflineplus">+{</span>
<a href="#l32.598"></a><span id="l32.598" class="difflineplus">+    aDataSource = mDataSource;</span>
<a href="#l32.599"></a><span id="l32.599" class="difflineplus">+    NS_IF_ADDREF(aDataSource);</span>
<a href="#l32.600"></a><span id="l32.600" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.601"></a><span id="l32.601" class="difflineplus">+}</span>
<a href="#l32.602"></a><span id="l32.602" class="difflineplus">+</span>
<a href="#l32.603"></a><span id="l32.603" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.604"></a><span id="l32.604" class="difflineplus">+// Text buffering</span>
<a href="#l32.605"></a><span id="l32.605" class="difflineplus">+</span>
<a href="#l32.606"></a><span id="l32.606" class="difflineplus">+static bool</span>
<a href="#l32.607"></a><span id="l32.607" class="difflineplus">+rdf_IsDataInBuffer(char16_t* buffer, int32_t length)</span>
<a href="#l32.608"></a><span id="l32.608" class="difflineplus">+{</span>
<a href="#l32.609"></a><span id="l32.609" class="difflineplus">+    for (int32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l32.610"></a><span id="l32.610" class="difflineplus">+        if (buffer[i] == ' ' ||</span>
<a href="#l32.611"></a><span id="l32.611" class="difflineplus">+            buffer[i] == '\t' ||</span>
<a href="#l32.612"></a><span id="l32.612" class="difflineplus">+            buffer[i] == '\n' ||</span>
<a href="#l32.613"></a><span id="l32.613" class="difflineplus">+            buffer[i] == '\r')</span>
<a href="#l32.614"></a><span id="l32.614" class="difflineplus">+            continue;</span>
<a href="#l32.615"></a><span id="l32.615" class="difflineplus">+</span>
<a href="#l32.616"></a><span id="l32.616" class="difflineplus">+        return true;</span>
<a href="#l32.617"></a><span id="l32.617" class="difflineplus">+    }</span>
<a href="#l32.618"></a><span id="l32.618" class="difflineplus">+    return false;</span>
<a href="#l32.619"></a><span id="l32.619" class="difflineplus">+}</span>
<a href="#l32.620"></a><span id="l32.620" class="difflineplus">+</span>
<a href="#l32.621"></a><span id="l32.621" class="difflineplus">+void</span>
<a href="#l32.622"></a><span id="l32.622" class="difflineplus">+RDFContentSinkImpl::ParseText(nsIRDFNode **aResult)</span>
<a href="#l32.623"></a><span id="l32.623" class="difflineplus">+{</span>
<a href="#l32.624"></a><span id="l32.624" class="difflineplus">+    // XXXwaterson wasteful, but we'd need to make a copy anyway to be</span>
<a href="#l32.625"></a><span id="l32.625" class="difflineplus">+    // able to call nsIRDFService::Get[Resource|Literal|...]().</span>
<a href="#l32.626"></a><span id="l32.626" class="difflineplus">+    nsAutoString value;</span>
<a href="#l32.627"></a><span id="l32.627" class="difflineplus">+    value.Append(mText, mTextLength);</span>
<a href="#l32.628"></a><span id="l32.628" class="difflineplus">+    value.Trim(&quot; \t\n\r&quot;);</span>
<a href="#l32.629"></a><span id="l32.629" class="difflineplus">+</span>
<a href="#l32.630"></a><span id="l32.630" class="difflineplus">+    switch (mParseMode) {</span>
<a href="#l32.631"></a><span id="l32.631" class="difflineplus">+    case eRDFContentSinkParseMode_Literal:</span>
<a href="#l32.632"></a><span id="l32.632" class="difflineplus">+        {</span>
<a href="#l32.633"></a><span id="l32.633" class="difflineplus">+            nsIRDFLiteral *result;</span>
<a href="#l32.634"></a><span id="l32.634" class="difflineplus">+            gRDFService-&gt;GetLiteral(value.get(), &amp;result);</span>
<a href="#l32.635"></a><span id="l32.635" class="difflineplus">+            *aResult = result;</span>
<a href="#l32.636"></a><span id="l32.636" class="difflineplus">+        }</span>
<a href="#l32.637"></a><span id="l32.637" class="difflineplus">+        break;</span>
<a href="#l32.638"></a><span id="l32.638" class="difflineplus">+</span>
<a href="#l32.639"></a><span id="l32.639" class="difflineplus">+    case eRDFContentSinkParseMode_Resource:</span>
<a href="#l32.640"></a><span id="l32.640" class="difflineplus">+        {</span>
<a href="#l32.641"></a><span id="l32.641" class="difflineplus">+            nsIRDFResource *result;</span>
<a href="#l32.642"></a><span id="l32.642" class="difflineplus">+            gRDFService-&gt;GetUnicodeResource(value, &amp;result);</span>
<a href="#l32.643"></a><span id="l32.643" class="difflineplus">+            *aResult = result;</span>
<a href="#l32.644"></a><span id="l32.644" class="difflineplus">+        }</span>
<a href="#l32.645"></a><span id="l32.645" class="difflineplus">+        break;</span>
<a href="#l32.646"></a><span id="l32.646" class="difflineplus">+</span>
<a href="#l32.647"></a><span id="l32.647" class="difflineplus">+    case eRDFContentSinkParseMode_Int:</span>
<a href="#l32.648"></a><span id="l32.648" class="difflineplus">+        {</span>
<a href="#l32.649"></a><span id="l32.649" class="difflineplus">+            nsresult err;</span>
<a href="#l32.650"></a><span id="l32.650" class="difflineplus">+            int32_t i = value.ToInteger(&amp;err);</span>
<a href="#l32.651"></a><span id="l32.651" class="difflineplus">+            nsIRDFInt *result;</span>
<a href="#l32.652"></a><span id="l32.652" class="difflineplus">+            gRDFService-&gt;GetIntLiteral(i, &amp;result);</span>
<a href="#l32.653"></a><span id="l32.653" class="difflineplus">+            *aResult = result;</span>
<a href="#l32.654"></a><span id="l32.654" class="difflineplus">+        }</span>
<a href="#l32.655"></a><span id="l32.655" class="difflineplus">+        break;</span>
<a href="#l32.656"></a><span id="l32.656" class="difflineplus">+</span>
<a href="#l32.657"></a><span id="l32.657" class="difflineplus">+    case eRDFContentSinkParseMode_Date:</span>
<a href="#l32.658"></a><span id="l32.658" class="difflineplus">+        {</span>
<a href="#l32.659"></a><span id="l32.659" class="difflineplus">+            PRTime t = rdf_ParseDate(nsDependentCString(NS_LossyConvertUTF16toASCII(value).get(), value.Length()));</span>
<a href="#l32.660"></a><span id="l32.660" class="difflineplus">+            nsIRDFDate *result;</span>
<a href="#l32.661"></a><span id="l32.661" class="difflineplus">+            gRDFService-&gt;GetDateLiteral(t, &amp;result);</span>
<a href="#l32.662"></a><span id="l32.662" class="difflineplus">+            *aResult = result;</span>
<a href="#l32.663"></a><span id="l32.663" class="difflineplus">+        }</span>
<a href="#l32.664"></a><span id="l32.664" class="difflineplus">+        break;</span>
<a href="#l32.665"></a><span id="l32.665" class="difflineplus">+</span>
<a href="#l32.666"></a><span id="l32.666" class="difflineplus">+    default:</span>
<a href="#l32.667"></a><span id="l32.667" class="difflineplus">+        NS_NOTREACHED(&quot;unknown parse type&quot;);</span>
<a href="#l32.668"></a><span id="l32.668" class="difflineplus">+        break;</span>
<a href="#l32.669"></a><span id="l32.669" class="difflineplus">+    }</span>
<a href="#l32.670"></a><span id="l32.670" class="difflineplus">+}</span>
<a href="#l32.671"></a><span id="l32.671" class="difflineplus">+</span>
<a href="#l32.672"></a><span id="l32.672" class="difflineplus">+nsresult</span>
<a href="#l32.673"></a><span id="l32.673" class="difflineplus">+RDFContentSinkImpl::FlushText()</span>
<a href="#l32.674"></a><span id="l32.674" class="difflineplus">+{</span>
<a href="#l32.675"></a><span id="l32.675" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l32.676"></a><span id="l32.676" class="difflineplus">+    if (0 != mTextLength) {</span>
<a href="#l32.677"></a><span id="l32.677" class="difflineplus">+        if (rdf_IsDataInBuffer(mText, mTextLength)) {</span>
<a href="#l32.678"></a><span id="l32.678" class="difflineplus">+            // XXX if there's anything but whitespace, then we'll</span>
<a href="#l32.679"></a><span id="l32.679" class="difflineplus">+            // create a text node.</span>
<a href="#l32.680"></a><span id="l32.680" class="difflineplus">+</span>
<a href="#l32.681"></a><span id="l32.681" class="difflineplus">+            switch (mState) {</span>
<a href="#l32.682"></a><span id="l32.682" class="difflineplus">+            case eRDFContentSinkState_InMemberElement: {</span>
<a href="#l32.683"></a><span id="l32.683" class="difflineplus">+                nsCOMPtr&lt;nsIRDFNode&gt; node;</span>
<a href="#l32.684"></a><span id="l32.684" class="difflineplus">+                ParseText(getter_AddRefs(node));</span>
<a href="#l32.685"></a><span id="l32.685" class="difflineplus">+</span>
<a href="#l32.686"></a><span id="l32.686" class="difflineplus">+                nsCOMPtr&lt;nsIRDFContainer&gt; container;</span>
<a href="#l32.687"></a><span id="l32.687" class="difflineplus">+                NS_NewRDFContainer(getter_AddRefs(container));</span>
<a href="#l32.688"></a><span id="l32.688" class="difflineplus">+                container-&gt;Init(mDataSource, GetContextElement(1));</span>
<a href="#l32.689"></a><span id="l32.689" class="difflineplus">+</span>
<a href="#l32.690"></a><span id="l32.690" class="difflineplus">+                container-&gt;AppendElement(node);</span>
<a href="#l32.691"></a><span id="l32.691" class="difflineplus">+            } break;</span>
<a href="#l32.692"></a><span id="l32.692" class="difflineplus">+</span>
<a href="#l32.693"></a><span id="l32.693" class="difflineplus">+            case eRDFContentSinkState_InPropertyElement: {</span>
<a href="#l32.694"></a><span id="l32.694" class="difflineplus">+                nsCOMPtr&lt;nsIRDFNode&gt; node;</span>
<a href="#l32.695"></a><span id="l32.695" class="difflineplus">+                ParseText(getter_AddRefs(node));</span>
<a href="#l32.696"></a><span id="l32.696" class="difflineplus">+</span>
<a href="#l32.697"></a><span id="l32.697" class="difflineplus">+                mDataSource-&gt;Assert(GetContextElement(1), GetContextElement(0), node, true);</span>
<a href="#l32.698"></a><span id="l32.698" class="difflineplus">+            } break;</span>
<a href="#l32.699"></a><span id="l32.699" class="difflineplus">+</span>
<a href="#l32.700"></a><span id="l32.700" class="difflineplus">+            default:</span>
<a href="#l32.701"></a><span id="l32.701" class="difflineplus">+                // just ignore it</span>
<a href="#l32.702"></a><span id="l32.702" class="difflineplus">+                break;</span>
<a href="#l32.703"></a><span id="l32.703" class="difflineplus">+            }</span>
<a href="#l32.704"></a><span id="l32.704" class="difflineplus">+        }</span>
<a href="#l32.705"></a><span id="l32.705" class="difflineplus">+        mTextLength = 0;</span>
<a href="#l32.706"></a><span id="l32.706" class="difflineplus">+    }</span>
<a href="#l32.707"></a><span id="l32.707" class="difflineplus">+    return rv;</span>
<a href="#l32.708"></a><span id="l32.708" class="difflineplus">+}</span>
<a href="#l32.709"></a><span id="l32.709" class="difflineplus">+</span>
<a href="#l32.710"></a><span id="l32.710" class="difflineplus">+</span>
<a href="#l32.711"></a><span id="l32.711" class="difflineplus">+nsresult</span>
<a href="#l32.712"></a><span id="l32.712" class="difflineplus">+RDFContentSinkImpl::AddText(const char16_t* aText, int32_t aLength)</span>
<a href="#l32.713"></a><span id="l32.713" class="difflineplus">+{</span>
<a href="#l32.714"></a><span id="l32.714" class="difflineplus">+    // Create buffer when we first need it</span>
<a href="#l32.715"></a><span id="l32.715" class="difflineplus">+    if (0 == mTextSize) {</span>
<a href="#l32.716"></a><span id="l32.716" class="difflineplus">+        mText = (char16_t *) malloc(sizeof(char16_t) * 4096);</span>
<a href="#l32.717"></a><span id="l32.717" class="difflineplus">+        if (!mText) {</span>
<a href="#l32.718"></a><span id="l32.718" class="difflineplus">+            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.719"></a><span id="l32.719" class="difflineplus">+        }</span>
<a href="#l32.720"></a><span id="l32.720" class="difflineplus">+        mTextSize = 4096;</span>
<a href="#l32.721"></a><span id="l32.721" class="difflineplus">+    }</span>
<a href="#l32.722"></a><span id="l32.722" class="difflineplus">+</span>
<a href="#l32.723"></a><span id="l32.723" class="difflineplus">+    // Copy data from string into our buffer; grow the buffer as needed.</span>
<a href="#l32.724"></a><span id="l32.724" class="difflineplus">+    // It never shrinks, but since the content sink doesn't stick around,</span>
<a href="#l32.725"></a><span id="l32.725" class="difflineplus">+    // this shouldn't be a bloat issue.</span>
<a href="#l32.726"></a><span id="l32.726" class="difflineplus">+    int32_t amount = mTextSize - mTextLength;</span>
<a href="#l32.727"></a><span id="l32.727" class="difflineplus">+    if (amount &lt; aLength) {</span>
<a href="#l32.728"></a><span id="l32.728" class="difflineplus">+        // Grow the buffer by at least a factor of two to prevent thrashing.</span>
<a href="#l32.729"></a><span id="l32.729" class="difflineplus">+        // Since realloc() will leave mText intact if the call fails,</span>
<a href="#l32.730"></a><span id="l32.730" class="difflineplus">+        // don't clobber mText or mTextSize until the new mem is allocated.</span>
<a href="#l32.731"></a><span id="l32.731" class="difflineplus">+        int32_t newSize = (2 * mTextSize &gt; (mTextSize + aLength)) ?</span>
<a href="#l32.732"></a><span id="l32.732" class="difflineplus">+                          (2 * mTextSize) : (mTextSize + aLength);</span>
<a href="#l32.733"></a><span id="l32.733" class="difflineplus">+        char16_t* newText =</span>
<a href="#l32.734"></a><span id="l32.734" class="difflineplus">+            (char16_t *) realloc(mText, sizeof(char16_t) * newSize);</span>
<a href="#l32.735"></a><span id="l32.735" class="difflineplus">+        if (!newText)</span>
<a href="#l32.736"></a><span id="l32.736" class="difflineplus">+            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.737"></a><span id="l32.737" class="difflineplus">+        mTextSize = newSize;</span>
<a href="#l32.738"></a><span id="l32.738" class="difflineplus">+        mText = newText;</span>
<a href="#l32.739"></a><span id="l32.739" class="difflineplus">+    }</span>
<a href="#l32.740"></a><span id="l32.740" class="difflineplus">+    memcpy(&amp;mText[mTextLength], aText, sizeof(char16_t) * aLength);</span>
<a href="#l32.741"></a><span id="l32.741" class="difflineplus">+    mTextLength += aLength;</span>
<a href="#l32.742"></a><span id="l32.742" class="difflineplus">+</span>
<a href="#l32.743"></a><span id="l32.743" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.744"></a><span id="l32.744" class="difflineplus">+}</span>
<a href="#l32.745"></a><span id="l32.745" class="difflineplus">+</span>
<a href="#l32.746"></a><span id="l32.746" class="difflineplus">+bool</span>
<a href="#l32.747"></a><span id="l32.747" class="difflineplus">+rdf_RequiresAbsoluteURI(const nsString&amp; uri)</span>
<a href="#l32.748"></a><span id="l32.748" class="difflineplus">+{</span>
<a href="#l32.749"></a><span id="l32.749" class="difflineplus">+    // cheap shot at figuring out if this requires an absolute url translation</span>
<a href="#l32.750"></a><span id="l32.750" class="difflineplus">+    return !(StringBeginsWith(uri, NS_LITERAL_STRING(&quot;urn:&quot;)) ||</span>
<a href="#l32.751"></a><span id="l32.751" class="difflineplus">+             StringBeginsWith(uri, NS_LITERAL_STRING(&quot;chrome:&quot;)));</span>
<a href="#l32.752"></a><span id="l32.752" class="difflineplus">+}</span>
<a href="#l32.753"></a><span id="l32.753" class="difflineplus">+</span>
<a href="#l32.754"></a><span id="l32.754" class="difflineplus">+nsresult</span>
<a href="#l32.755"></a><span id="l32.755" class="difflineplus">+RDFContentSinkImpl::GetIdAboutAttribute(const char16_t** aAttributes,</span>
<a href="#l32.756"></a><span id="l32.756" class="difflineplus">+                                        nsIRDFResource** aResource,</span>
<a href="#l32.757"></a><span id="l32.757" class="difflineplus">+                                        bool* aIsAnonymous)</span>
<a href="#l32.758"></a><span id="l32.758" class="difflineplus">+{</span>
<a href="#l32.759"></a><span id="l32.759" class="difflineplus">+    // This corresponds to the dirty work of production [6.5]</span>
<a href="#l32.760"></a><span id="l32.760" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l32.761"></a><span id="l32.761" class="difflineplus">+</span>
<a href="#l32.762"></a><span id="l32.762" class="difflineplus">+    nsAutoString nodeID;</span>
<a href="#l32.763"></a><span id="l32.763" class="difflineplus">+</span>
<a href="#l32.764"></a><span id="l32.764" class="difflineplus">+    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.765"></a><span id="l32.765" class="difflineplus">+    for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l32.766"></a><span id="l32.766" class="difflineplus">+        const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.767"></a><span id="l32.767" class="difflineplus">+            SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l32.768"></a><span id="l32.768" class="difflineplus">+</span>
<a href="#l32.769"></a><span id="l32.769" class="difflineplus">+        // We'll accept either `ID' or `rdf:ID' (ibid with `about' or</span>
<a href="#l32.770"></a><span id="l32.770" class="difflineplus">+        // `rdf:about') in the spirit of being liberal towards the</span>
<a href="#l32.771"></a><span id="l32.771" class="difflineplus">+        // input that we receive.</span>
<a href="#l32.772"></a><span id="l32.772" class="difflineplus">+        if (!nameSpaceURI.IsEmpty() &amp;&amp;</span>
<a href="#l32.773"></a><span id="l32.773" class="difflineplus">+            !nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l32.774"></a><span id="l32.774" class="difflineplus">+          continue;</span>
<a href="#l32.775"></a><span id="l32.775" class="difflineplus">+        }</span>
<a href="#l32.776"></a><span id="l32.776" class="difflineplus">+</span>
<a href="#l32.777"></a><span id="l32.777" class="difflineplus">+        // XXX you can't specify both, but we'll just pick up the</span>
<a href="#l32.778"></a><span id="l32.778" class="difflineplus">+        // first thing that was specified and ignore the other.</span>
<a href="#l32.779"></a><span id="l32.779" class="difflineplus">+</span>
<a href="#l32.780"></a><span id="l32.780" class="difflineplus">+        if (localName == nsGkAtoms::about) {</span>
<a href="#l32.781"></a><span id="l32.781" class="difflineplus">+            if (aIsAnonymous)</span>
<a href="#l32.782"></a><span id="l32.782" class="difflineplus">+                *aIsAnonymous = false;</span>
<a href="#l32.783"></a><span id="l32.783" class="difflineplus">+</span>
<a href="#l32.784"></a><span id="l32.784" class="difflineplus">+            nsAutoString relURI(aAttributes[1]);</span>
<a href="#l32.785"></a><span id="l32.785" class="difflineplus">+            if (rdf_RequiresAbsoluteURI(relURI)) {</span>
<a href="#l32.786"></a><span id="l32.786" class="difflineplus">+                nsAutoCString uri;</span>
<a href="#l32.787"></a><span id="l32.787" class="difflineplus">+                rv = mDocumentURL-&gt;Resolve(NS_ConvertUTF16toUTF8(aAttributes[1]), uri);</span>
<a href="#l32.788"></a><span id="l32.788" class="difflineplus">+                if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.789"></a><span id="l32.789" class="difflineplus">+</span>
<a href="#l32.790"></a><span id="l32.790" class="difflineplus">+                return gRDFService-&gt;GetResource(uri,</span>
<a href="#l32.791"></a><span id="l32.791" class="difflineplus">+                                                aResource);</span>
<a href="#l32.792"></a><span id="l32.792" class="difflineplus">+            }</span>
<a href="#l32.793"></a><span id="l32.793" class="difflineplus">+            return gRDFService-&gt;GetResource(NS_ConvertUTF16toUTF8(aAttributes[1]),</span>
<a href="#l32.794"></a><span id="l32.794" class="difflineplus">+                                            aResource);</span>
<a href="#l32.795"></a><span id="l32.795" class="difflineplus">+        }</span>
<a href="#l32.796"></a><span id="l32.796" class="difflineplus">+        else if (localName == nsGkAtoms::ID) {</span>
<a href="#l32.797"></a><span id="l32.797" class="difflineplus">+            if (aIsAnonymous)</span>
<a href="#l32.798"></a><span id="l32.798" class="difflineplus">+                *aIsAnonymous = false;</span>
<a href="#l32.799"></a><span id="l32.799" class="difflineplus">+            // In the spirit of leniency, we do not bother trying to</span>
<a href="#l32.800"></a><span id="l32.800" class="difflineplus">+            // enforce that this be a valid &quot;XML Name&quot; (see</span>
<a href="#l32.801"></a><span id="l32.801" class="difflineplus">+            // http://www.w3.org/TR/REC-xml#NT-Nmtoken), as per</span>
<a href="#l32.802"></a><span id="l32.802" class="difflineplus">+            // 6.21. If we wanted to, this would be where to do it.</span>
<a href="#l32.803"></a><span id="l32.803" class="difflineplus">+</span>
<a href="#l32.804"></a><span id="l32.804" class="difflineplus">+            // Construct an in-line resource whose URI is the</span>
<a href="#l32.805"></a><span id="l32.805" class="difflineplus">+            // document's URI plus the XML name specified in the ID</span>
<a href="#l32.806"></a><span id="l32.806" class="difflineplus">+            // attribute.</span>
<a href="#l32.807"></a><span id="l32.807" class="difflineplus">+            nsAutoCString name;</span>
<a href="#l32.808"></a><span id="l32.808" class="difflineplus">+            nsAutoCString ref('#');</span>
<a href="#l32.809"></a><span id="l32.809" class="difflineplus">+            AppendUTF16toUTF8(aAttributes[1], ref);</span>
<a href="#l32.810"></a><span id="l32.810" class="difflineplus">+</span>
<a href="#l32.811"></a><span id="l32.811" class="difflineplus">+            rv = mDocumentURL-&gt;Resolve(ref, name);</span>
<a href="#l32.812"></a><span id="l32.812" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.813"></a><span id="l32.813" class="difflineplus">+</span>
<a href="#l32.814"></a><span id="l32.814" class="difflineplus">+            return gRDFService-&gt;GetResource(name, aResource);</span>
<a href="#l32.815"></a><span id="l32.815" class="difflineplus">+        }</span>
<a href="#l32.816"></a><span id="l32.816" class="difflineplus">+        else if (localName == nsGkAtoms::nodeID) {</span>
<a href="#l32.817"></a><span id="l32.817" class="difflineplus">+            nodeID.Assign(aAttributes[1]);</span>
<a href="#l32.818"></a><span id="l32.818" class="difflineplus">+        }</span>
<a href="#l32.819"></a><span id="l32.819" class="difflineplus">+        else if (localName == nsGkAtoms::about) {</span>
<a href="#l32.820"></a><span id="l32.820" class="difflineplus">+            // XXX we don't deal with aboutEach...</span>
<a href="#l32.821"></a><span id="l32.821" class="difflineplus">+            //MOZ_LOG(gLog, LogLevel::Warning,</span>
<a href="#l32.822"></a><span id="l32.822" class="difflineplus">+            //       (&quot;rdfxml: ignoring aboutEach at line %d&quot;,</span>
<a href="#l32.823"></a><span id="l32.823" class="difflineplus">+            //        aNode.GetSourceLineNumber()));</span>
<a href="#l32.824"></a><span id="l32.824" class="difflineplus">+        }</span>
<a href="#l32.825"></a><span id="l32.825" class="difflineplus">+    }</span>
<a href="#l32.826"></a><span id="l32.826" class="difflineplus">+</span>
<a href="#l32.827"></a><span id="l32.827" class="difflineplus">+    // Otherwise, we couldn't find anything, so just gensym one...</span>
<a href="#l32.828"></a><span id="l32.828" class="difflineplus">+    if (aIsAnonymous)</span>
<a href="#l32.829"></a><span id="l32.829" class="difflineplus">+        *aIsAnonymous = true;</span>
<a href="#l32.830"></a><span id="l32.830" class="difflineplus">+</span>
<a href="#l32.831"></a><span id="l32.831" class="difflineplus">+    // If nodeID is present, check if we already know about it. If we've seen</span>
<a href="#l32.832"></a><span id="l32.832" class="difflineplus">+    // the nodeID before, use the same resource, otherwise generate a new one.</span>
<a href="#l32.833"></a><span id="l32.833" class="difflineplus">+    if (!nodeID.IsEmpty()) {</span>
<a href="#l32.834"></a><span id="l32.834" class="difflineplus">+        mNodeIDMap.Get(nodeID,aResource);</span>
<a href="#l32.835"></a><span id="l32.835" class="difflineplus">+</span>
<a href="#l32.836"></a><span id="l32.836" class="difflineplus">+        if (!*aResource) {</span>
<a href="#l32.837"></a><span id="l32.837" class="difflineplus">+            rv = gRDFService-&gt;GetAnonymousResource(aResource);</span>
<a href="#l32.838"></a><span id="l32.838" class="difflineplus">+            mNodeIDMap.Put(nodeID,*aResource);</span>
<a href="#l32.839"></a><span id="l32.839" class="difflineplus">+        }</span>
<a href="#l32.840"></a><span id="l32.840" class="difflineplus">+    }</span>
<a href="#l32.841"></a><span id="l32.841" class="difflineplus">+    else {</span>
<a href="#l32.842"></a><span id="l32.842" class="difflineplus">+        rv = gRDFService-&gt;GetAnonymousResource(aResource);</span>
<a href="#l32.843"></a><span id="l32.843" class="difflineplus">+    }</span>
<a href="#l32.844"></a><span id="l32.844" class="difflineplus">+</span>
<a href="#l32.845"></a><span id="l32.845" class="difflineplus">+    return rv;</span>
<a href="#l32.846"></a><span id="l32.846" class="difflineplus">+}</span>
<a href="#l32.847"></a><span id="l32.847" class="difflineplus">+</span>
<a href="#l32.848"></a><span id="l32.848" class="difflineplus">+nsresult</span>
<a href="#l32.849"></a><span id="l32.849" class="difflineplus">+RDFContentSinkImpl::GetResourceAttribute(const char16_t** aAttributes,</span>
<a href="#l32.850"></a><span id="l32.850" class="difflineplus">+                                         nsIRDFResource** aResource)</span>
<a href="#l32.851"></a><span id="l32.851" class="difflineplus">+{</span>
<a href="#l32.852"></a><span id="l32.852" class="difflineplus">+  RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.853"></a><span id="l32.853" class="difflineplus">+</span>
<a href="#l32.854"></a><span id="l32.854" class="difflineplus">+  nsAutoString nodeID;</span>
<a href="#l32.855"></a><span id="l32.855" class="difflineplus">+</span>
<a href="#l32.856"></a><span id="l32.856" class="difflineplus">+  for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l32.857"></a><span id="l32.857" class="difflineplus">+      const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.858"></a><span id="l32.858" class="difflineplus">+          SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l32.859"></a><span id="l32.859" class="difflineplus">+</span>
<a href="#l32.860"></a><span id="l32.860" class="difflineplus">+      // We'll accept `resource' or `rdf:resource', under the spirit</span>
<a href="#l32.861"></a><span id="l32.861" class="difflineplus">+      // that we should be liberal towards the input that we</span>
<a href="#l32.862"></a><span id="l32.862" class="difflineplus">+      // receive.</span>
<a href="#l32.863"></a><span id="l32.863" class="difflineplus">+      if (!nameSpaceURI.IsEmpty() &amp;&amp;</span>
<a href="#l32.864"></a><span id="l32.864" class="difflineplus">+          !nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l32.865"></a><span id="l32.865" class="difflineplus">+          continue;</span>
<a href="#l32.866"></a><span id="l32.866" class="difflineplus">+      }</span>
<a href="#l32.867"></a><span id="l32.867" class="difflineplus">+</span>
<a href="#l32.868"></a><span id="l32.868" class="difflineplus">+      // XXX you can't specify both, but we'll just pick up the</span>
<a href="#l32.869"></a><span id="l32.869" class="difflineplus">+      // first thing that was specified and ignore the other.</span>
<a href="#l32.870"></a><span id="l32.870" class="difflineplus">+</span>
<a href="#l32.871"></a><span id="l32.871" class="difflineplus">+      if (localName == nsGkAtoms::resource) {</span>
<a href="#l32.872"></a><span id="l32.872" class="difflineplus">+          // XXX Take the URI and make it fully qualified by</span>
<a href="#l32.873"></a><span id="l32.873" class="difflineplus">+          // sticking it into the document's URL. This may not be</span>
<a href="#l32.874"></a><span id="l32.874" class="difflineplus">+          // appropriate...</span>
<a href="#l32.875"></a><span id="l32.875" class="difflineplus">+          nsAutoString relURI(aAttributes[1]);</span>
<a href="#l32.876"></a><span id="l32.876" class="difflineplus">+          if (rdf_RequiresAbsoluteURI(relURI)) {</span>
<a href="#l32.877"></a><span id="l32.877" class="difflineplus">+              nsresult rv;</span>
<a href="#l32.878"></a><span id="l32.878" class="difflineplus">+              nsAutoCString uri;</span>
<a href="#l32.879"></a><span id="l32.879" class="difflineplus">+</span>
<a href="#l32.880"></a><span id="l32.880" class="difflineplus">+              rv = mDocumentURL-&gt;Resolve(NS_ConvertUTF16toUTF8(aAttributes[1]), uri);</span>
<a href="#l32.881"></a><span id="l32.881" class="difflineplus">+              if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.882"></a><span id="l32.882" class="difflineplus">+</span>
<a href="#l32.883"></a><span id="l32.883" class="difflineplus">+              return gRDFService-&gt;GetResource(uri, aResource);</span>
<a href="#l32.884"></a><span id="l32.884" class="difflineplus">+          }</span>
<a href="#l32.885"></a><span id="l32.885" class="difflineplus">+          return gRDFService-&gt;GetResource(NS_ConvertUTF16toUTF8(aAttributes[1]),</span>
<a href="#l32.886"></a><span id="l32.886" class="difflineplus">+                                          aResource);</span>
<a href="#l32.887"></a><span id="l32.887" class="difflineplus">+      }</span>
<a href="#l32.888"></a><span id="l32.888" class="difflineplus">+      else if (localName == nsGkAtoms::nodeID) {</span>
<a href="#l32.889"></a><span id="l32.889" class="difflineplus">+          nodeID.Assign(aAttributes[1]);</span>
<a href="#l32.890"></a><span id="l32.890" class="difflineplus">+      }</span>
<a href="#l32.891"></a><span id="l32.891" class="difflineplus">+  }</span>
<a href="#l32.892"></a><span id="l32.892" class="difflineplus">+</span>
<a href="#l32.893"></a><span id="l32.893" class="difflineplus">+  // If nodeID is present, check if we already know about it. If we've seen</span>
<a href="#l32.894"></a><span id="l32.894" class="difflineplus">+  // the nodeID before, use the same resource, otherwise generate a new one.</span>
<a href="#l32.895"></a><span id="l32.895" class="difflineplus">+  if (!nodeID.IsEmpty()) {</span>
<a href="#l32.896"></a><span id="l32.896" class="difflineplus">+      mNodeIDMap.Get(nodeID,aResource);</span>
<a href="#l32.897"></a><span id="l32.897" class="difflineplus">+</span>
<a href="#l32.898"></a><span id="l32.898" class="difflineplus">+      if (!*aResource) {</span>
<a href="#l32.899"></a><span id="l32.899" class="difflineplus">+          nsresult rv;</span>
<a href="#l32.900"></a><span id="l32.900" class="difflineplus">+          rv = gRDFService-&gt;GetAnonymousResource(aResource);</span>
<a href="#l32.901"></a><span id="l32.901" class="difflineplus">+          if (NS_FAILED(rv)) {</span>
<a href="#l32.902"></a><span id="l32.902" class="difflineplus">+              return rv;</span>
<a href="#l32.903"></a><span id="l32.903" class="difflineplus">+          }</span>
<a href="#l32.904"></a><span id="l32.904" class="difflineplus">+          mNodeIDMap.Put(nodeID,*aResource);</span>
<a href="#l32.905"></a><span id="l32.905" class="difflineplus">+      }</span>
<a href="#l32.906"></a><span id="l32.906" class="difflineplus">+      return NS_OK;</span>
<a href="#l32.907"></a><span id="l32.907" class="difflineplus">+  }</span>
<a href="#l32.908"></a><span id="l32.908" class="difflineplus">+</span>
<a href="#l32.909"></a><span id="l32.909" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l32.910"></a><span id="l32.910" class="difflineplus">+}</span>
<a href="#l32.911"></a><span id="l32.911" class="difflineplus">+</span>
<a href="#l32.912"></a><span id="l32.912" class="difflineplus">+nsresult</span>
<a href="#l32.913"></a><span id="l32.913" class="difflineplus">+RDFContentSinkImpl::AddProperties(const char16_t** aAttributes,</span>
<a href="#l32.914"></a><span id="l32.914" class="difflineplus">+                                  nsIRDFResource* aSubject,</span>
<a href="#l32.915"></a><span id="l32.915" class="difflineplus">+                                  int32_t* aCount)</span>
<a href="#l32.916"></a><span id="l32.916" class="difflineplus">+{</span>
<a href="#l32.917"></a><span id="l32.917" class="difflineplus">+  if (aCount)</span>
<a href="#l32.918"></a><span id="l32.918" class="difflineplus">+      *aCount = 0;</span>
<a href="#l32.919"></a><span id="l32.919" class="difflineplus">+</span>
<a href="#l32.920"></a><span id="l32.920" class="difflineplus">+  RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.921"></a><span id="l32.921" class="difflineplus">+  for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l32.922"></a><span id="l32.922" class="difflineplus">+      const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.923"></a><span id="l32.923" class="difflineplus">+          SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l32.924"></a><span id="l32.924" class="difflineplus">+</span>
<a href="#l32.925"></a><span id="l32.925" class="difflineplus">+      // skip 'xmlns' directives, these are &quot;meta&quot; information</span>
<a href="#l32.926"></a><span id="l32.926" class="difflineplus">+      if (nameSpaceURI.EqualsLiteral(&quot;http://www.w3.org/2000/xmlns/&quot;)) {</span>
<a href="#l32.927"></a><span id="l32.927" class="difflineplus">+        continue;</span>
<a href="#l32.928"></a><span id="l32.928" class="difflineplus">+      }</span>
<a href="#l32.929"></a><span id="l32.929" class="difflineplus">+</span>
<a href="#l32.930"></a><span id="l32.930" class="difflineplus">+      // skip `about', `ID', `resource', and 'nodeID' attributes (either with or</span>
<a href="#l32.931"></a><span id="l32.931" class="difflineplus">+      // without the `rdf:' prefix); these are all &quot;special&quot; and</span>
<a href="#l32.932"></a><span id="l32.932" class="difflineplus">+      // should've been dealt with by the caller.</span>
<a href="#l32.933"></a><span id="l32.933" class="difflineplus">+      if (localName == nsGkAtoms::about || localName == nsGkAtoms::ID ||</span>
<a href="#l32.934"></a><span id="l32.934" class="difflineplus">+          localName == nsGkAtoms::resource || localName == nsGkAtoms::nodeID) {</span>
<a href="#l32.935"></a><span id="l32.935" class="difflineplus">+          if (nameSpaceURI.IsEmpty() ||</span>
<a href="#l32.936"></a><span id="l32.936" class="difflineplus">+              nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI))</span>
<a href="#l32.937"></a><span id="l32.937" class="difflineplus">+              continue;</span>
<a href="#l32.938"></a><span id="l32.938" class="difflineplus">+      }</span>
<a href="#l32.939"></a><span id="l32.939" class="difflineplus">+</span>
<a href="#l32.940"></a><span id="l32.940" class="difflineplus">+      // Skip `parseType', `RDF:parseType', and `NC:parseType'. This</span>
<a href="#l32.941"></a><span id="l32.941" class="difflineplus">+      // is meta-information that will be handled in SetParseMode.</span>
<a href="#l32.942"></a><span id="l32.942" class="difflineplus">+      if (localName == nsGkAtoms::parseType) {</span>
<a href="#l32.943"></a><span id="l32.943" class="difflineplus">+          if (nameSpaceURI.IsEmpty() ||</span>
<a href="#l32.944"></a><span id="l32.944" class="difflineplus">+              nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI) ||</span>
<a href="#l32.945"></a><span id="l32.945" class="difflineplus">+              nameSpaceURI.EqualsLiteral(NC_NAMESPACE_URI)) {</span>
<a href="#l32.946"></a><span id="l32.946" class="difflineplus">+              continue;</span>
<a href="#l32.947"></a><span id="l32.947" class="difflineplus">+          }</span>
<a href="#l32.948"></a><span id="l32.948" class="difflineplus">+      }</span>
<a href="#l32.949"></a><span id="l32.949" class="difflineplus">+</span>
<a href="#l32.950"></a><span id="l32.950" class="difflineplus">+      NS_ConvertUTF16toUTF8 propertyStr(nameSpaceURI);</span>
<a href="#l32.951"></a><span id="l32.951" class="difflineplus">+      propertyStr.Append(nsAtomCString(localName));</span>
<a href="#l32.952"></a><span id="l32.952" class="difflineplus">+</span>
<a href="#l32.953"></a><span id="l32.953" class="difflineplus">+      // Add the assertion to RDF</span>
<a href="#l32.954"></a><span id="l32.954" class="difflineplus">+      nsCOMPtr&lt;nsIRDFResource&gt; property;</span>
<a href="#l32.955"></a><span id="l32.955" class="difflineplus">+      gRDFService-&gt;GetResource(propertyStr, getter_AddRefs(property));</span>
<a href="#l32.956"></a><span id="l32.956" class="difflineplus">+</span>
<a href="#l32.957"></a><span id="l32.957" class="difflineplus">+      nsCOMPtr&lt;nsIRDFLiteral&gt; target;</span>
<a href="#l32.958"></a><span id="l32.958" class="difflineplus">+      gRDFService-&gt;GetLiteral(aAttributes[1],</span>
<a href="#l32.959"></a><span id="l32.959" class="difflineplus">+                              getter_AddRefs(target));</span>
<a href="#l32.960"></a><span id="l32.960" class="difflineplus">+</span>
<a href="#l32.961"></a><span id="l32.961" class="difflineplus">+      mDataSource-&gt;Assert(aSubject, property, target, true);</span>
<a href="#l32.962"></a><span id="l32.962" class="difflineplus">+  }</span>
<a href="#l32.963"></a><span id="l32.963" class="difflineplus">+  return NS_OK;</span>
<a href="#l32.964"></a><span id="l32.964" class="difflineplus">+}</span>
<a href="#l32.965"></a><span id="l32.965" class="difflineplus">+</span>
<a href="#l32.966"></a><span id="l32.966" class="difflineplus">+void</span>
<a href="#l32.967"></a><span id="l32.967" class="difflineplus">+RDFContentSinkImpl::SetParseMode(const char16_t **aAttributes)</span>
<a href="#l32.968"></a><span id="l32.968" class="difflineplus">+{</span>
<a href="#l32.969"></a><span id="l32.969" class="difflineplus">+    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.970"></a><span id="l32.970" class="difflineplus">+    for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l32.971"></a><span id="l32.971" class="difflineplus">+        const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.972"></a><span id="l32.972" class="difflineplus">+            SplitExpatName(aAttributes[0], getter_AddRefs(localName));</span>
<a href="#l32.973"></a><span id="l32.973" class="difflineplus">+</span>
<a href="#l32.974"></a><span id="l32.974" class="difflineplus">+        if (localName == nsGkAtoms::parseType) {</span>
<a href="#l32.975"></a><span id="l32.975" class="difflineplus">+            nsDependentString v(aAttributes[1]);</span>
<a href="#l32.976"></a><span id="l32.976" class="difflineplus">+</span>
<a href="#l32.977"></a><span id="l32.977" class="difflineplus">+            if (nameSpaceURI.IsEmpty() ||</span>
<a href="#l32.978"></a><span id="l32.978" class="difflineplus">+                nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l32.979"></a><span id="l32.979" class="difflineplus">+                if (v.EqualsLiteral(&quot;Resource&quot;))</span>
<a href="#l32.980"></a><span id="l32.980" class="difflineplus">+                    mParseMode = eRDFContentSinkParseMode_Resource;</span>
<a href="#l32.981"></a><span id="l32.981" class="difflineplus">+</span>
<a href="#l32.982"></a><span id="l32.982" class="difflineplus">+                break;</span>
<a href="#l32.983"></a><span id="l32.983" class="difflineplus">+            }</span>
<a href="#l32.984"></a><span id="l32.984" class="difflineplus">+            else if (nameSpaceURI.EqualsLiteral(NC_NAMESPACE_URI)) {</span>
<a href="#l32.985"></a><span id="l32.985" class="difflineplus">+                if (v.EqualsLiteral(&quot;Date&quot;))</span>
<a href="#l32.986"></a><span id="l32.986" class="difflineplus">+                    mParseMode = eRDFContentSinkParseMode_Date;</span>
<a href="#l32.987"></a><span id="l32.987" class="difflineplus">+                else if (v.EqualsLiteral(&quot;Integer&quot;))</span>
<a href="#l32.988"></a><span id="l32.988" class="difflineplus">+                    mParseMode = eRDFContentSinkParseMode_Int;</span>
<a href="#l32.989"></a><span id="l32.989" class="difflineplus">+</span>
<a href="#l32.990"></a><span id="l32.990" class="difflineplus">+                break;</span>
<a href="#l32.991"></a><span id="l32.991" class="difflineplus">+            }</span>
<a href="#l32.992"></a><span id="l32.992" class="difflineplus">+        }</span>
<a href="#l32.993"></a><span id="l32.993" class="difflineplus">+    }</span>
<a href="#l32.994"></a><span id="l32.994" class="difflineplus">+}</span>
<a href="#l32.995"></a><span id="l32.995" class="difflineplus">+</span>
<a href="#l32.996"></a><span id="l32.996" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.997"></a><span id="l32.997" class="difflineplus">+// RDF-specific routines used to build the model</span>
<a href="#l32.998"></a><span id="l32.998" class="difflineplus">+</span>
<a href="#l32.999"></a><span id="l32.999" class="difflineplus">+nsresult</span>
<a href="#l32.1000"></a><span id="l32.1000" class="difflineplus">+RDFContentSinkImpl::OpenRDF(const char16_t* aName)</span>
<a href="#l32.1001"></a><span id="l32.1001" class="difflineplus">+{</span>
<a href="#l32.1002"></a><span id="l32.1002" class="difflineplus">+    // ensure that we're actually reading RDF by making sure that the</span>
<a href="#l32.1003"></a><span id="l32.1003" class="difflineplus">+    // opening tag is &lt;rdf:RDF&gt;, where &quot;rdf:&quot; corresponds to whatever</span>
<a href="#l32.1004"></a><span id="l32.1004" class="difflineplus">+    // they've declared the standard RDF namespace to be.</span>
<a href="#l32.1005"></a><span id="l32.1005" class="difflineplus">+    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.1006"></a><span id="l32.1006" class="difflineplus">+    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.1007"></a><span id="l32.1007" class="difflineplus">+        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l32.1008"></a><span id="l32.1008" class="difflineplus">+</span>
<a href="#l32.1009"></a><span id="l32.1009" class="difflineplus">+    if (!nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI) ||</span>
<a href="#l32.1010"></a><span id="l32.1010" class="difflineplus">+        localName != nsGkAtoms::RDF) {</span>
<a href="#l32.1011"></a><span id="l32.1011" class="difflineplus">+       // MOZ_LOG(gLog, LogLevel::Info,</span>
<a href="#l32.1012"></a><span id="l32.1012" class="difflineplus">+       //        (&quot;rdfxml: expected RDF:RDF at line %d&quot;,</span>
<a href="#l32.1013"></a><span id="l32.1013" class="difflineplus">+       //         aNode.GetSourceLineNumber()));</span>
<a href="#l32.1014"></a><span id="l32.1014" class="difflineplus">+</span>
<a href="#l32.1015"></a><span id="l32.1015" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l32.1016"></a><span id="l32.1016" class="difflineplus">+    }</span>
<a href="#l32.1017"></a><span id="l32.1017" class="difflineplus">+</span>
<a href="#l32.1018"></a><span id="l32.1018" class="difflineplus">+    PushContext(nullptr, mState, mParseMode);</span>
<a href="#l32.1019"></a><span id="l32.1019" class="difflineplus">+    mState = eRDFContentSinkState_InDocumentElement;</span>
<a href="#l32.1020"></a><span id="l32.1020" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1021"></a><span id="l32.1021" class="difflineplus">+}</span>
<a href="#l32.1022"></a><span id="l32.1022" class="difflineplus">+</span>
<a href="#l32.1023"></a><span id="l32.1023" class="difflineplus">+nsresult</span>
<a href="#l32.1024"></a><span id="l32.1024" class="difflineplus">+RDFContentSinkImpl::OpenObject(const char16_t* aName,</span>
<a href="#l32.1025"></a><span id="l32.1025" class="difflineplus">+                               const char16_t** aAttributes)</span>
<a href="#l32.1026"></a><span id="l32.1026" class="difflineplus">+{</span>
<a href="#l32.1027"></a><span id="l32.1027" class="difflineplus">+    // an &quot;object&quot; non-terminal is either a &quot;description&quot;, a &quot;typed</span>
<a href="#l32.1028"></a><span id="l32.1028" class="difflineplus">+    // node&quot;, or a &quot;container&quot;, so this change the content sink's</span>
<a href="#l32.1029"></a><span id="l32.1029" class="difflineplus">+    // state appropriately.</span>
<a href="#l32.1030"></a><span id="l32.1030" class="difflineplus">+    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.1031"></a><span id="l32.1031" class="difflineplus">+    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.1032"></a><span id="l32.1032" class="difflineplus">+        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l32.1033"></a><span id="l32.1033" class="difflineplus">+</span>
<a href="#l32.1034"></a><span id="l32.1034" class="difflineplus">+    // Figure out the URI of this object, and create an RDF node for it.</span>
<a href="#l32.1035"></a><span id="l32.1035" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; source;</span>
<a href="#l32.1036"></a><span id="l32.1036" class="difflineplus">+    GetIdAboutAttribute(aAttributes, getter_AddRefs(source));</span>
<a href="#l32.1037"></a><span id="l32.1037" class="difflineplus">+</span>
<a href="#l32.1038"></a><span id="l32.1038" class="difflineplus">+    // If there is no `ID' or `about', then there's not much we can do.</span>
<a href="#l32.1039"></a><span id="l32.1039" class="difflineplus">+    if (! source)</span>
<a href="#l32.1040"></a><span id="l32.1040" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l32.1041"></a><span id="l32.1041" class="difflineplus">+</span>
<a href="#l32.1042"></a><span id="l32.1042" class="difflineplus">+    // Push the element onto the context stack</span>
<a href="#l32.1043"></a><span id="l32.1043" class="difflineplus">+    PushContext(source, mState, mParseMode);</span>
<a href="#l32.1044"></a><span id="l32.1044" class="difflineplus">+</span>
<a href="#l32.1045"></a><span id="l32.1045" class="difflineplus">+    // Now figure out what kind of state transition we need to</span>
<a href="#l32.1046"></a><span id="l32.1046" class="difflineplus">+    // make. We'll either be going into a mode where we parse a</span>
<a href="#l32.1047"></a><span id="l32.1047" class="difflineplus">+    // description or a container.</span>
<a href="#l32.1048"></a><span id="l32.1048" class="difflineplus">+    bool isaTypedNode = true;</span>
<a href="#l32.1049"></a><span id="l32.1049" class="difflineplus">+</span>
<a href="#l32.1050"></a><span id="l32.1050" class="difflineplus">+    if (nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI)) {</span>
<a href="#l32.1051"></a><span id="l32.1051" class="difflineplus">+        isaTypedNode = false;</span>
<a href="#l32.1052"></a><span id="l32.1052" class="difflineplus">+</span>
<a href="#l32.1053"></a><span id="l32.1053" class="difflineplus">+        if (localName == nsGkAtoms::Description) {</span>
<a href="#l32.1054"></a><span id="l32.1054" class="difflineplus">+            // it's a description</span>
<a href="#l32.1055"></a><span id="l32.1055" class="difflineplus">+            mState = eRDFContentSinkState_InDescriptionElement;</span>
<a href="#l32.1056"></a><span id="l32.1056" class="difflineplus">+        }</span>
<a href="#l32.1057"></a><span id="l32.1057" class="difflineplus">+        else if (localName == nsGkAtoms::Bag) {</span>
<a href="#l32.1058"></a><span id="l32.1058" class="difflineplus">+            // it's a bag container</span>
<a href="#l32.1059"></a><span id="l32.1059" class="difflineplus">+            InitContainer(kRDF_Bag, source);</span>
<a href="#l32.1060"></a><span id="l32.1060" class="difflineplus">+            mState = eRDFContentSinkState_InContainerElement;</span>
<a href="#l32.1061"></a><span id="l32.1061" class="difflineplus">+        }</span>
<a href="#l32.1062"></a><span id="l32.1062" class="difflineplus">+        else if (localName == nsGkAtoms::Seq) {</span>
<a href="#l32.1063"></a><span id="l32.1063" class="difflineplus">+            // it's a seq container</span>
<a href="#l32.1064"></a><span id="l32.1064" class="difflineplus">+            InitContainer(kRDF_Seq, source);</span>
<a href="#l32.1065"></a><span id="l32.1065" class="difflineplus">+            mState = eRDFContentSinkState_InContainerElement;</span>
<a href="#l32.1066"></a><span id="l32.1066" class="difflineplus">+        }</span>
<a href="#l32.1067"></a><span id="l32.1067" class="difflineplus">+        else if (localName == nsGkAtoms::Alt) {</span>
<a href="#l32.1068"></a><span id="l32.1068" class="difflineplus">+            // it's an alt container</span>
<a href="#l32.1069"></a><span id="l32.1069" class="difflineplus">+            InitContainer(kRDF_Alt, source);</span>
<a href="#l32.1070"></a><span id="l32.1070" class="difflineplus">+            mState = eRDFContentSinkState_InContainerElement;</span>
<a href="#l32.1071"></a><span id="l32.1071" class="difflineplus">+        }</span>
<a href="#l32.1072"></a><span id="l32.1072" class="difflineplus">+        else {</span>
<a href="#l32.1073"></a><span id="l32.1073" class="difflineplus">+            // heh, that's not *in* the RDF namespace: just treat it</span>
<a href="#l32.1074"></a><span id="l32.1074" class="difflineplus">+            // like a typed node</span>
<a href="#l32.1075"></a><span id="l32.1075" class="difflineplus">+            isaTypedNode = true;</span>
<a href="#l32.1076"></a><span id="l32.1076" class="difflineplus">+        }</span>
<a href="#l32.1077"></a><span id="l32.1077" class="difflineplus">+    }</span>
<a href="#l32.1078"></a><span id="l32.1078" class="difflineplus">+</span>
<a href="#l32.1079"></a><span id="l32.1079" class="difflineplus">+    if (isaTypedNode) {</span>
<a href="#l32.1080"></a><span id="l32.1080" class="difflineplus">+        NS_ConvertUTF16toUTF8 typeStr(nameSpaceURI);</span>
<a href="#l32.1081"></a><span id="l32.1081" class="difflineplus">+        typeStr.Append(nsAtomCString(localName));</span>
<a href="#l32.1082"></a><span id="l32.1082" class="difflineplus">+</span>
<a href="#l32.1083"></a><span id="l32.1083" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; type;</span>
<a href="#l32.1084"></a><span id="l32.1084" class="difflineplus">+        nsresult rv = gRDFService-&gt;GetResource(typeStr, getter_AddRefs(type));</span>
<a href="#l32.1085"></a><span id="l32.1085" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1086"></a><span id="l32.1086" class="difflineplus">+</span>
<a href="#l32.1087"></a><span id="l32.1087" class="difflineplus">+        rv = mDataSource-&gt;Assert(source, kRDF_type, type, true);</span>
<a href="#l32.1088"></a><span id="l32.1088" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1089"></a><span id="l32.1089" class="difflineplus">+</span>
<a href="#l32.1090"></a><span id="l32.1090" class="difflineplus">+        mState = eRDFContentSinkState_InDescriptionElement;</span>
<a href="#l32.1091"></a><span id="l32.1091" class="difflineplus">+    }</span>
<a href="#l32.1092"></a><span id="l32.1092" class="difflineplus">+</span>
<a href="#l32.1093"></a><span id="l32.1093" class="difflineplus">+    AddProperties(aAttributes, source);</span>
<a href="#l32.1094"></a><span id="l32.1094" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1095"></a><span id="l32.1095" class="difflineplus">+}</span>
<a href="#l32.1096"></a><span id="l32.1096" class="difflineplus">+</span>
<a href="#l32.1097"></a><span id="l32.1097" class="difflineplus">+nsresult</span>
<a href="#l32.1098"></a><span id="l32.1098" class="difflineplus">+RDFContentSinkImpl::OpenProperty(const char16_t* aName, const char16_t** aAttributes)</span>
<a href="#l32.1099"></a><span id="l32.1099" class="difflineplus">+{</span>
<a href="#l32.1100"></a><span id="l32.1100" class="difflineplus">+    nsresult rv;</span>
<a href="#l32.1101"></a><span id="l32.1101" class="difflineplus">+</span>
<a href="#l32.1102"></a><span id="l32.1102" class="difflineplus">+    // an &quot;object&quot; non-terminal is either a &quot;description&quot;, a &quot;typed</span>
<a href="#l32.1103"></a><span id="l32.1103" class="difflineplus">+    // node&quot;, or a &quot;container&quot;, so this change the content sink's</span>
<a href="#l32.1104"></a><span id="l32.1104" class="difflineplus">+    // state appropriately.</span>
<a href="#l32.1105"></a><span id="l32.1105" class="difflineplus">+    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.1106"></a><span id="l32.1106" class="difflineplus">+    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.1107"></a><span id="l32.1107" class="difflineplus">+        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l32.1108"></a><span id="l32.1108" class="difflineplus">+</span>
<a href="#l32.1109"></a><span id="l32.1109" class="difflineplus">+    NS_ConvertUTF16toUTF8 propertyStr(nameSpaceURI);</span>
<a href="#l32.1110"></a><span id="l32.1110" class="difflineplus">+    propertyStr.Append(nsAtomCString(localName));</span>
<a href="#l32.1111"></a><span id="l32.1111" class="difflineplus">+</span>
<a href="#l32.1112"></a><span id="l32.1112" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; property;</span>
<a href="#l32.1113"></a><span id="l32.1113" class="difflineplus">+    rv = gRDFService-&gt;GetResource(propertyStr, getter_AddRefs(property));</span>
<a href="#l32.1114"></a><span id="l32.1114" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1115"></a><span id="l32.1115" class="difflineplus">+</span>
<a href="#l32.1116"></a><span id="l32.1116" class="difflineplus">+    // See if they've specified a 'resource' attribute, in which case</span>
<a href="#l32.1117"></a><span id="l32.1117" class="difflineplus">+    // they mean *that* to be the object of this property.</span>
<a href="#l32.1118"></a><span id="l32.1118" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; target;</span>
<a href="#l32.1119"></a><span id="l32.1119" class="difflineplus">+    GetResourceAttribute(aAttributes, getter_AddRefs(target));</span>
<a href="#l32.1120"></a><span id="l32.1120" class="difflineplus">+</span>
<a href="#l32.1121"></a><span id="l32.1121" class="difflineplus">+    bool isAnonymous = false;</span>
<a href="#l32.1122"></a><span id="l32.1122" class="difflineplus">+</span>
<a href="#l32.1123"></a><span id="l32.1123" class="difflineplus">+    if (! target) {</span>
<a href="#l32.1124"></a><span id="l32.1124" class="difflineplus">+        // See if an 'ID' attribute has been specified, in which case</span>
<a href="#l32.1125"></a><span id="l32.1125" class="difflineplus">+        // this corresponds to the fourth form of [6.12].</span>
<a href="#l32.1126"></a><span id="l32.1126" class="difflineplus">+</span>
<a href="#l32.1127"></a><span id="l32.1127" class="difflineplus">+        // XXX strictly speaking, we should reject the RDF/XML as</span>
<a href="#l32.1128"></a><span id="l32.1128" class="difflineplus">+        // invalid if they've specified both an 'ID' and a 'resource'</span>
<a href="#l32.1129"></a><span id="l32.1129" class="difflineplus">+        // attribute. Bah.</span>
<a href="#l32.1130"></a><span id="l32.1130" class="difflineplus">+</span>
<a href="#l32.1131"></a><span id="l32.1131" class="difflineplus">+        // XXX strictly speaking, 'about=' isn't allowed here, but</span>
<a href="#l32.1132"></a><span id="l32.1132" class="difflineplus">+        // what the hell.</span>
<a href="#l32.1133"></a><span id="l32.1133" class="difflineplus">+        GetIdAboutAttribute(aAttributes, getter_AddRefs(target), &amp;isAnonymous);</span>
<a href="#l32.1134"></a><span id="l32.1134" class="difflineplus">+    }</span>
<a href="#l32.1135"></a><span id="l32.1135" class="difflineplus">+</span>
<a href="#l32.1136"></a><span id="l32.1136" class="difflineplus">+    if (target) {</span>
<a href="#l32.1137"></a><span id="l32.1137" class="difflineplus">+        // They specified an inline resource for the value of this</span>
<a href="#l32.1138"></a><span id="l32.1138" class="difflineplus">+        // property. Create an RDF resource for the inline resource</span>
<a href="#l32.1139"></a><span id="l32.1139" class="difflineplus">+        // URI, add the properties to it, and attach the inline</span>
<a href="#l32.1140"></a><span id="l32.1140" class="difflineplus">+        // resource to its parent.</span>
<a href="#l32.1141"></a><span id="l32.1141" class="difflineplus">+        int32_t count;</span>
<a href="#l32.1142"></a><span id="l32.1142" class="difflineplus">+        rv = AddProperties(aAttributes, target, &amp;count);</span>
<a href="#l32.1143"></a><span id="l32.1143" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;problem adding properties&quot;);</span>
<a href="#l32.1144"></a><span id="l32.1144" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1145"></a><span id="l32.1145" class="difflineplus">+</span>
<a href="#l32.1146"></a><span id="l32.1146" class="difflineplus">+        if (count || !isAnonymous) {</span>
<a href="#l32.1147"></a><span id="l32.1147" class="difflineplus">+            // If the resource was &quot;anonymous&quot; (i.e., they hadn't</span>
<a href="#l32.1148"></a><span id="l32.1148" class="difflineplus">+            // explicitly set an ID or resource attribute), then we'll</span>
<a href="#l32.1149"></a><span id="l32.1149" class="difflineplus">+            // only assert this property from the context element *if*</span>
<a href="#l32.1150"></a><span id="l32.1150" class="difflineplus">+            // there were properties specified on the anonymous</span>
<a href="#l32.1151"></a><span id="l32.1151" class="difflineplus">+            // resource.</span>
<a href="#l32.1152"></a><span id="l32.1152" class="difflineplus">+            rv = mDataSource-&gt;Assert(GetContextElement(0), property, target, true);</span>
<a href="#l32.1153"></a><span id="l32.1153" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1154"></a><span id="l32.1154" class="difflineplus">+        }</span>
<a href="#l32.1155"></a><span id="l32.1155" class="difflineplus">+</span>
<a href="#l32.1156"></a><span id="l32.1156" class="difflineplus">+        // XXX Technically, we should _not_ fall through here and push</span>
<a href="#l32.1157"></a><span id="l32.1157" class="difflineplus">+        // the element onto the stack: this is supposed to be a closed</span>
<a href="#l32.1158"></a><span id="l32.1158" class="difflineplus">+        // node. But right now I'm lazy and the code will just Do The</span>
<a href="#l32.1159"></a><span id="l32.1159" class="difflineplus">+        // Right Thing so long as the RDF is well-formed.</span>
<a href="#l32.1160"></a><span id="l32.1160" class="difflineplus">+    }</span>
<a href="#l32.1161"></a><span id="l32.1161" class="difflineplus">+</span>
<a href="#l32.1162"></a><span id="l32.1162" class="difflineplus">+    // Push the element onto the context stack and change state.</span>
<a href="#l32.1163"></a><span id="l32.1163" class="difflineplus">+    PushContext(property, mState, mParseMode);</span>
<a href="#l32.1164"></a><span id="l32.1164" class="difflineplus">+    mState = eRDFContentSinkState_InPropertyElement;</span>
<a href="#l32.1165"></a><span id="l32.1165" class="difflineplus">+    SetParseMode(aAttributes);</span>
<a href="#l32.1166"></a><span id="l32.1166" class="difflineplus">+</span>
<a href="#l32.1167"></a><span id="l32.1167" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1168"></a><span id="l32.1168" class="difflineplus">+}</span>
<a href="#l32.1169"></a><span id="l32.1169" class="difflineplus">+</span>
<a href="#l32.1170"></a><span id="l32.1170" class="difflineplus">+nsresult</span>
<a href="#l32.1171"></a><span id="l32.1171" class="difflineplus">+RDFContentSinkImpl::OpenMember(const char16_t* aName,</span>
<a href="#l32.1172"></a><span id="l32.1172" class="difflineplus">+                               const char16_t** aAttributes)</span>
<a href="#l32.1173"></a><span id="l32.1173" class="difflineplus">+{</span>
<a href="#l32.1174"></a><span id="l32.1174" class="difflineplus">+    // ensure that we're actually reading a member element by making</span>
<a href="#l32.1175"></a><span id="l32.1175" class="difflineplus">+    // sure that the opening tag is &lt;rdf:li&gt;, where &quot;rdf:&quot; corresponds</span>
<a href="#l32.1176"></a><span id="l32.1176" class="difflineplus">+    // to whatever they've declared the standard RDF namespace to be.</span>
<a href="#l32.1177"></a><span id="l32.1177" class="difflineplus">+    nsresult rv;</span>
<a href="#l32.1178"></a><span id="l32.1178" class="difflineplus">+</span>
<a href="#l32.1179"></a><span id="l32.1179" class="difflineplus">+    RefPtr&lt;nsAtom&gt; localName;</span>
<a href="#l32.1180"></a><span id="l32.1180" class="difflineplus">+    const nsDependentSubstring&amp; nameSpaceURI =</span>
<a href="#l32.1181"></a><span id="l32.1181" class="difflineplus">+        SplitExpatName(aName, getter_AddRefs(localName));</span>
<a href="#l32.1182"></a><span id="l32.1182" class="difflineplus">+</span>
<a href="#l32.1183"></a><span id="l32.1183" class="difflineplus">+    if (!nameSpaceURI.EqualsLiteral(RDF_NAMESPACE_URI) ||</span>
<a href="#l32.1184"></a><span id="l32.1184" class="difflineplus">+        localName != nsGkAtoms::li) {</span>
<a href="#l32.1185"></a><span id="l32.1185" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Error,</span>
<a href="#l32.1186"></a><span id="l32.1186" class="difflineplus">+               (&quot;rdfxml: expected RDF:li at line %d&quot;,</span>
<a href="#l32.1187"></a><span id="l32.1187" class="difflineplus">+                -1)); // XXX pass in line number</span>
<a href="#l32.1188"></a><span id="l32.1188" class="difflineplus">+</span>
<a href="#l32.1189"></a><span id="l32.1189" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l32.1190"></a><span id="l32.1190" class="difflineplus">+    }</span>
<a href="#l32.1191"></a><span id="l32.1191" class="difflineplus">+</span>
<a href="#l32.1192"></a><span id="l32.1192" class="difflineplus">+    // The parent element is the container.</span>
<a href="#l32.1193"></a><span id="l32.1193" class="difflineplus">+    nsIRDFResource* container = GetContextElement(0);</span>
<a href="#l32.1194"></a><span id="l32.1194" class="difflineplus">+    if (! container)</span>
<a href="#l32.1195"></a><span id="l32.1195" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.1196"></a><span id="l32.1196" class="difflineplus">+</span>
<a href="#l32.1197"></a><span id="l32.1197" class="difflineplus">+    nsIRDFResource* resource;</span>
<a href="#l32.1198"></a><span id="l32.1198" class="difflineplus">+    if (NS_SUCCEEDED(rv = GetResourceAttribute(aAttributes, &amp;resource))) {</span>
<a href="#l32.1199"></a><span id="l32.1199" class="difflineplus">+        // Okay, this node has an RDF:resource=&quot;...&quot; attribute. That</span>
<a href="#l32.1200"></a><span id="l32.1200" class="difflineplus">+        // means that it's a &quot;referenced item,&quot; as covered in [6.29].</span>
<a href="#l32.1201"></a><span id="l32.1201" class="difflineplus">+        nsCOMPtr&lt;nsIRDFContainer&gt; c;</span>
<a href="#l32.1202"></a><span id="l32.1202" class="difflineplus">+        NS_NewRDFContainer(getter_AddRefs(c));</span>
<a href="#l32.1203"></a><span id="l32.1203" class="difflineplus">+        c-&gt;Init(mDataSource, container);</span>
<a href="#l32.1204"></a><span id="l32.1204" class="difflineplus">+        c-&gt;AppendElement(resource);</span>
<a href="#l32.1205"></a><span id="l32.1205" class="difflineplus">+</span>
<a href="#l32.1206"></a><span id="l32.1206" class="difflineplus">+        // XXX Technically, we should _not_ fall through here and push</span>
<a href="#l32.1207"></a><span id="l32.1207" class="difflineplus">+        // the element onto the stack: this is supposed to be a closed</span>
<a href="#l32.1208"></a><span id="l32.1208" class="difflineplus">+        // node. But right now I'm lazy and the code will just Do The</span>
<a href="#l32.1209"></a><span id="l32.1209" class="difflineplus">+        // Right Thing so long as the RDF is well-formed.</span>
<a href="#l32.1210"></a><span id="l32.1210" class="difflineplus">+        NS_RELEASE(resource);</span>
<a href="#l32.1211"></a><span id="l32.1211" class="difflineplus">+    }</span>
<a href="#l32.1212"></a><span id="l32.1212" class="difflineplus">+</span>
<a href="#l32.1213"></a><span id="l32.1213" class="difflineplus">+    // Change state. Pushing a null context element is a bit weird,</span>
<a href="#l32.1214"></a><span id="l32.1214" class="difflineplus">+    // but the idea is that there really is _no_ context &quot;property&quot;.</span>
<a href="#l32.1215"></a><span id="l32.1215" class="difflineplus">+    // The contained element will use nsIRDFContainer::AppendElement() to add</span>
<a href="#l32.1216"></a><span id="l32.1216" class="difflineplus">+    // the element to the container, which requires only the container</span>
<a href="#l32.1217"></a><span id="l32.1217" class="difflineplus">+    // and the element to be added.</span>
<a href="#l32.1218"></a><span id="l32.1218" class="difflineplus">+    PushContext(nullptr, mState, mParseMode);</span>
<a href="#l32.1219"></a><span id="l32.1219" class="difflineplus">+    mState = eRDFContentSinkState_InMemberElement;</span>
<a href="#l32.1220"></a><span id="l32.1220" class="difflineplus">+    SetParseMode(aAttributes);</span>
<a href="#l32.1221"></a><span id="l32.1221" class="difflineplus">+</span>
<a href="#l32.1222"></a><span id="l32.1222" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1223"></a><span id="l32.1223" class="difflineplus">+}</span>
<a href="#l32.1224"></a><span id="l32.1224" class="difflineplus">+</span>
<a href="#l32.1225"></a><span id="l32.1225" class="difflineplus">+</span>
<a href="#l32.1226"></a><span id="l32.1226" class="difflineplus">+nsresult</span>
<a href="#l32.1227"></a><span id="l32.1227" class="difflineplus">+RDFContentSinkImpl::OpenValue(const char16_t* aName, const char16_t** aAttributes)</span>
<a href="#l32.1228"></a><span id="l32.1228" class="difflineplus">+{</span>
<a href="#l32.1229"></a><span id="l32.1229" class="difflineplus">+    // a &quot;value&quot; can either be an object or a string: we'll only get</span>
<a href="#l32.1230"></a><span id="l32.1230" class="difflineplus">+    // *here* if it's an object, as raw text is added as a leaf.</span>
<a href="#l32.1231"></a><span id="l32.1231" class="difflineplus">+    return OpenObject(aName,aAttributes);</span>
<a href="#l32.1232"></a><span id="l32.1232" class="difflineplus">+}</span>
<a href="#l32.1233"></a><span id="l32.1233" class="difflineplus">+</span>
<a href="#l32.1234"></a><span id="l32.1234" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.1235"></a><span id="l32.1235" class="difflineplus">+// namespace resolution</span>
<a href="#l32.1236"></a><span id="l32.1236" class="difflineplus">+void</span>
<a href="#l32.1237"></a><span id="l32.1237" class="difflineplus">+RDFContentSinkImpl::RegisterNamespaces(const char16_t **aAttributes)</span>
<a href="#l32.1238"></a><span id="l32.1238" class="difflineplus">+{</span>
<a href="#l32.1239"></a><span id="l32.1239" class="difflineplus">+    nsCOMPtr&lt;nsIRDFXMLSink&gt; sink = do_QueryInterface(mDataSource);</span>
<a href="#l32.1240"></a><span id="l32.1240" class="difflineplus">+    if (!sink) {</span>
<a href="#l32.1241"></a><span id="l32.1241" class="difflineplus">+        return;</span>
<a href="#l32.1242"></a><span id="l32.1242" class="difflineplus">+    }</span>
<a href="#l32.1243"></a><span id="l32.1243" class="difflineplus">+    NS_NAMED_LITERAL_STRING(xmlns, &quot;http://www.w3.org/2000/xmlns/&quot;);</span>
<a href="#l32.1244"></a><span id="l32.1244" class="difflineplus">+    for (; *aAttributes; aAttributes += 2) {</span>
<a href="#l32.1245"></a><span id="l32.1245" class="difflineplus">+        // check the namespace</span>
<a href="#l32.1246"></a><span id="l32.1246" class="difflineplus">+        const char16_t* attr = aAttributes[0];</span>
<a href="#l32.1247"></a><span id="l32.1247" class="difflineplus">+        const char16_t* xmlnsP = xmlns.BeginReading();</span>
<a href="#l32.1248"></a><span id="l32.1248" class="difflineplus">+        while (*attr ==  *xmlnsP) {</span>
<a href="#l32.1249"></a><span id="l32.1249" class="difflineplus">+            ++attr;</span>
<a href="#l32.1250"></a><span id="l32.1250" class="difflineplus">+            ++xmlnsP;</span>
<a href="#l32.1251"></a><span id="l32.1251" class="difflineplus">+        }</span>
<a href="#l32.1252"></a><span id="l32.1252" class="difflineplus">+        if (*attr != 0xFFFF ||</span>
<a href="#l32.1253"></a><span id="l32.1253" class="difflineplus">+            xmlnsP != xmlns.EndReading()) {</span>
<a href="#l32.1254"></a><span id="l32.1254" class="difflineplus">+            continue;</span>
<a href="#l32.1255"></a><span id="l32.1255" class="difflineplus">+        }</span>
<a href="#l32.1256"></a><span id="l32.1256" class="difflineplus">+        // get the localname (or &quot;xmlns&quot; for the default namespace)</span>
<a href="#l32.1257"></a><span id="l32.1257" class="difflineplus">+        const char16_t* endLocal = ++attr;</span>
<a href="#l32.1258"></a><span id="l32.1258" class="difflineplus">+        while (*endLocal &amp;&amp; *endLocal != 0xFFFF) {</span>
<a href="#l32.1259"></a><span id="l32.1259" class="difflineplus">+            ++endLocal;</span>
<a href="#l32.1260"></a><span id="l32.1260" class="difflineplus">+        }</span>
<a href="#l32.1261"></a><span id="l32.1261" class="difflineplus">+        nsDependentSubstring lname(attr, endLocal);</span>
<a href="#l32.1262"></a><span id="l32.1262" class="difflineplus">+        RefPtr&lt;nsAtom&gt; preferred = NS_Atomize(lname);</span>
<a href="#l32.1263"></a><span id="l32.1263" class="difflineplus">+        if (preferred == nsGkAtoms::xmlns) {</span>
<a href="#l32.1264"></a><span id="l32.1264" class="difflineplus">+            preferred = nullptr;</span>
<a href="#l32.1265"></a><span id="l32.1265" class="difflineplus">+        }</span>
<a href="#l32.1266"></a><span id="l32.1266" class="difflineplus">+        sink-&gt;AddNameSpace(preferred, nsDependentString(aAttributes[1]));</span>
<a href="#l32.1267"></a><span id="l32.1267" class="difflineplus">+    }</span>
<a href="#l32.1268"></a><span id="l32.1268" class="difflineplus">+}</span>
<a href="#l32.1269"></a><span id="l32.1269" class="difflineplus">+</span>
<a href="#l32.1270"></a><span id="l32.1270" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.1271"></a><span id="l32.1271" class="difflineplus">+// Qualified name resolution</span>
<a href="#l32.1272"></a><span id="l32.1272" class="difflineplus">+</span>
<a href="#l32.1273"></a><span id="l32.1273" class="difflineplus">+const nsDependentSubstring</span>
<a href="#l32.1274"></a><span id="l32.1274" class="difflineplus">+RDFContentSinkImpl::SplitExpatName(const char16_t *aExpatName,</span>
<a href="#l32.1275"></a><span id="l32.1275" class="difflineplus">+                                   nsAtom **aLocalName)</span>
<a href="#l32.1276"></a><span id="l32.1276" class="difflineplus">+{</span>
<a href="#l32.1277"></a><span id="l32.1277" class="difflineplus">+    /**</span>
<a href="#l32.1278"></a><span id="l32.1278" class="difflineplus">+     *  Expat can send the following:</span>
<a href="#l32.1279"></a><span id="l32.1279" class="difflineplus">+     *    localName</span>
<a href="#l32.1280"></a><span id="l32.1280" class="difflineplus">+     *    namespaceURI&lt;separator&gt;localName</span>
<a href="#l32.1281"></a><span id="l32.1281" class="difflineplus">+     *    namespaceURI&lt;separator&gt;localName&lt;separator&gt;prefix</span>
<a href="#l32.1282"></a><span id="l32.1282" class="difflineplus">+     *</span>
<a href="#l32.1283"></a><span id="l32.1283" class="difflineplus">+     *  and we use 0xFFFF for the &lt;separator&gt;.</span>
<a href="#l32.1284"></a><span id="l32.1284" class="difflineplus">+     *</span>
<a href="#l32.1285"></a><span id="l32.1285" class="difflineplus">+     */</span>
<a href="#l32.1286"></a><span id="l32.1286" class="difflineplus">+</span>
<a href="#l32.1287"></a><span id="l32.1287" class="difflineplus">+    const char16_t *uriEnd = aExpatName;</span>
<a href="#l32.1288"></a><span id="l32.1288" class="difflineplus">+    const char16_t *nameStart = aExpatName;</span>
<a href="#l32.1289"></a><span id="l32.1289" class="difflineplus">+    const char16_t *pos;</span>
<a href="#l32.1290"></a><span id="l32.1290" class="difflineplus">+    for (pos = aExpatName; *pos; ++pos) {</span>
<a href="#l32.1291"></a><span id="l32.1291" class="difflineplus">+        if (*pos == 0xFFFF) {</span>
<a href="#l32.1292"></a><span id="l32.1292" class="difflineplus">+            if (uriEnd != aExpatName) {</span>
<a href="#l32.1293"></a><span id="l32.1293" class="difflineplus">+                break;</span>
<a href="#l32.1294"></a><span id="l32.1294" class="difflineplus">+            }</span>
<a href="#l32.1295"></a><span id="l32.1295" class="difflineplus">+</span>
<a href="#l32.1296"></a><span id="l32.1296" class="difflineplus">+            uriEnd = pos;</span>
<a href="#l32.1297"></a><span id="l32.1297" class="difflineplus">+            nameStart = pos + 1;</span>
<a href="#l32.1298"></a><span id="l32.1298" class="difflineplus">+        }</span>
<a href="#l32.1299"></a><span id="l32.1299" class="difflineplus">+    }</span>
<a href="#l32.1300"></a><span id="l32.1300" class="difflineplus">+</span>
<a href="#l32.1301"></a><span id="l32.1301" class="difflineplus">+    const nsDependentSubstring&amp; nameSpaceURI = Substring(aExpatName, uriEnd);</span>
<a href="#l32.1302"></a><span id="l32.1302" class="difflineplus">+    *aLocalName = NS_Atomize(Substring(nameStart, pos)).take();</span>
<a href="#l32.1303"></a><span id="l32.1303" class="difflineplus">+    return nameSpaceURI;</span>
<a href="#l32.1304"></a><span id="l32.1304" class="difflineplus">+}</span>
<a href="#l32.1305"></a><span id="l32.1305" class="difflineplus">+</span>
<a href="#l32.1306"></a><span id="l32.1306" class="difflineplus">+nsresult</span>
<a href="#l32.1307"></a><span id="l32.1307" class="difflineplus">+RDFContentSinkImpl::InitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer)</span>
<a href="#l32.1308"></a><span id="l32.1308" class="difflineplus">+{</span>
<a href="#l32.1309"></a><span id="l32.1309" class="difflineplus">+    // Do the right kind of initialization based on the container</span>
<a href="#l32.1310"></a><span id="l32.1310" class="difflineplus">+    // 'type' resource, and the state of the container (i.e., 'make' a</span>
<a href="#l32.1311"></a><span id="l32.1311" class="difflineplus">+    // new container vs. 'reinitialize' the container).</span>
<a href="#l32.1312"></a><span id="l32.1312" class="difflineplus">+    nsresult rv;</span>
<a href="#l32.1313"></a><span id="l32.1313" class="difflineplus">+</span>
<a href="#l32.1314"></a><span id="l32.1314" class="difflineplus">+    static const ContainerInfo gContainerInfo[] = {</span>
<a href="#l32.1315"></a><span id="l32.1315" class="difflineplus">+        { &amp;RDFContentSinkImpl::kRDF_Alt, &amp;nsIRDFContainerUtils::IsAlt, &amp;nsIRDFContainerUtils::MakeAlt },</span>
<a href="#l32.1316"></a><span id="l32.1316" class="difflineplus">+        { &amp;RDFContentSinkImpl::kRDF_Bag, &amp;nsIRDFContainerUtils::IsBag, &amp;nsIRDFContainerUtils::MakeBag },</span>
<a href="#l32.1317"></a><span id="l32.1317" class="difflineplus">+        { &amp;RDFContentSinkImpl::kRDF_Seq, &amp;nsIRDFContainerUtils::IsSeq, &amp;nsIRDFContainerUtils::MakeSeq },</span>
<a href="#l32.1318"></a><span id="l32.1318" class="difflineplus">+        { 0, 0, 0 },</span>
<a href="#l32.1319"></a><span id="l32.1319" class="difflineplus">+    };</span>
<a href="#l32.1320"></a><span id="l32.1320" class="difflineplus">+</span>
<a href="#l32.1321"></a><span id="l32.1321" class="difflineplus">+    for (const ContainerInfo* info = gContainerInfo; info-&gt;mType != 0; ++info) {</span>
<a href="#l32.1322"></a><span id="l32.1322" class="difflineplus">+        if (*info-&gt;mType != aContainerType)</span>
<a href="#l32.1323"></a><span id="l32.1323" class="difflineplus">+            continue;</span>
<a href="#l32.1324"></a><span id="l32.1324" class="difflineplus">+</span>
<a href="#l32.1325"></a><span id="l32.1325" class="difflineplus">+        bool isContainer;</span>
<a href="#l32.1326"></a><span id="l32.1326" class="difflineplus">+        rv = (gRDFContainerUtils-&gt;*(info-&gt;mTestFn))(mDataSource, aContainer, &amp;isContainer);</span>
<a href="#l32.1327"></a><span id="l32.1327" class="difflineplus">+        if (isContainer) {</span>
<a href="#l32.1328"></a><span id="l32.1328" class="difflineplus">+            rv = ReinitContainer(aContainerType, aContainer);</span>
<a href="#l32.1329"></a><span id="l32.1329" class="difflineplus">+        }</span>
<a href="#l32.1330"></a><span id="l32.1330" class="difflineplus">+        else {</span>
<a href="#l32.1331"></a><span id="l32.1331" class="difflineplus">+            rv = (gRDFContainerUtils-&gt;*(info-&gt;mMakeFn))(mDataSource, aContainer, nullptr);</span>
<a href="#l32.1332"></a><span id="l32.1332" class="difflineplus">+        }</span>
<a href="#l32.1333"></a><span id="l32.1333" class="difflineplus">+        return rv;</span>
<a href="#l32.1334"></a><span id="l32.1334" class="difflineplus">+    }</span>
<a href="#l32.1335"></a><span id="l32.1335" class="difflineplus">+</span>
<a href="#l32.1336"></a><span id="l32.1336" class="difflineplus">+    NS_NOTREACHED(&quot;not an RDF container type&quot;);</span>
<a href="#l32.1337"></a><span id="l32.1337" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l32.1338"></a><span id="l32.1338" class="difflineplus">+}</span>
<a href="#l32.1339"></a><span id="l32.1339" class="difflineplus">+</span>
<a href="#l32.1340"></a><span id="l32.1340" class="difflineplus">+</span>
<a href="#l32.1341"></a><span id="l32.1341" class="difflineplus">+</span>
<a href="#l32.1342"></a><span id="l32.1342" class="difflineplus">+nsresult</span>
<a href="#l32.1343"></a><span id="l32.1343" class="difflineplus">+RDFContentSinkImpl::ReinitContainer(nsIRDFResource* aContainerType, nsIRDFResource* aContainer)</span>
<a href="#l32.1344"></a><span id="l32.1344" class="difflineplus">+{</span>
<a href="#l32.1345"></a><span id="l32.1345" class="difflineplus">+    // Mega-kludge to deal with the fact that Make[Seq|Alt|Bag] is</span>
<a href="#l32.1346"></a><span id="l32.1346" class="difflineplus">+    // idempotent, and as such, containers will have state (e.g.,</span>
<a href="#l32.1347"></a><span id="l32.1347" class="difflineplus">+    // RDF:nextVal) maintained in the graph across loads. This</span>
<a href="#l32.1348"></a><span id="l32.1348" class="difflineplus">+    // re-initializes each container's RDF:nextVal to '1', and 'marks'</span>
<a href="#l32.1349"></a><span id="l32.1349" class="difflineplus">+    // the container as such.</span>
<a href="#l32.1350"></a><span id="l32.1350" class="difflineplus">+    nsresult rv;</span>
<a href="#l32.1351"></a><span id="l32.1351" class="difflineplus">+</span>
<a href="#l32.1352"></a><span id="l32.1352" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; one;</span>
<a href="#l32.1353"></a><span id="l32.1353" class="difflineplus">+    rv = gRDFService-&gt;GetLiteral(u&quot;1&quot;, getter_AddRefs(one));</span>
<a href="#l32.1354"></a><span id="l32.1354" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1355"></a><span id="l32.1355" class="difflineplus">+</span>
<a href="#l32.1356"></a><span id="l32.1356" class="difflineplus">+    // Re-initialize the 'nextval' property</span>
<a href="#l32.1357"></a><span id="l32.1357" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; nextval;</span>
<a href="#l32.1358"></a><span id="l32.1358" class="difflineplus">+    rv = mDataSource-&gt;GetTarget(aContainer, kRDF_nextVal, true, getter_AddRefs(nextval));</span>
<a href="#l32.1359"></a><span id="l32.1359" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1360"></a><span id="l32.1360" class="difflineplus">+</span>
<a href="#l32.1361"></a><span id="l32.1361" class="difflineplus">+    rv = mDataSource-&gt;Change(aContainer, kRDF_nextVal, nextval, one);</span>
<a href="#l32.1362"></a><span id="l32.1362" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1363"></a><span id="l32.1363" class="difflineplus">+</span>
<a href="#l32.1364"></a><span id="l32.1364" class="difflineplus">+    // Re-mark as a container. XXX should be kRDF_type</span>
<a href="#l32.1365"></a><span id="l32.1365" class="difflineplus">+    rv = mDataSource-&gt;Assert(aContainer, kRDF_instanceOf, aContainerType, true);</span>
<a href="#l32.1366"></a><span id="l32.1366" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to mark container as such&quot;);</span>
<a href="#l32.1367"></a><span id="l32.1367" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.1368"></a><span id="l32.1368" class="difflineplus">+</span>
<a href="#l32.1369"></a><span id="l32.1369" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1370"></a><span id="l32.1370" class="difflineplus">+}</span>
<a href="#l32.1371"></a><span id="l32.1371" class="difflineplus">+</span>
<a href="#l32.1372"></a><span id="l32.1372" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.1373"></a><span id="l32.1373" class="difflineplus">+// Content stack management</span>
<a href="#l32.1374"></a><span id="l32.1374" class="difflineplus">+</span>
<a href="#l32.1375"></a><span id="l32.1375" class="difflineplus">+nsIRDFResource*</span>
<a href="#l32.1376"></a><span id="l32.1376" class="difflineplus">+RDFContentSinkImpl::GetContextElement(int32_t ancestor /* = 0 */)</span>
<a href="#l32.1377"></a><span id="l32.1377" class="difflineplus">+{</span>
<a href="#l32.1378"></a><span id="l32.1378" class="difflineplus">+    if ((nullptr == mContextStack) ||</span>
<a href="#l32.1379"></a><span id="l32.1379" class="difflineplus">+        (uint32_t(ancestor) &gt;= mContextStack-&gt;Length())) {</span>
<a href="#l32.1380"></a><span id="l32.1380" class="difflineplus">+        return nullptr;</span>
<a href="#l32.1381"></a><span id="l32.1381" class="difflineplus">+    }</span>
<a href="#l32.1382"></a><span id="l32.1382" class="difflineplus">+</span>
<a href="#l32.1383"></a><span id="l32.1383" class="difflineplus">+    return mContextStack-&gt;ElementAt(</span>
<a href="#l32.1384"></a><span id="l32.1384" class="difflineplus">+           mContextStack-&gt;Length()-ancestor-1).mResource;</span>
<a href="#l32.1385"></a><span id="l32.1385" class="difflineplus">+}</span>
<a href="#l32.1386"></a><span id="l32.1386" class="difflineplus">+</span>
<a href="#l32.1387"></a><span id="l32.1387" class="difflineplus">+int32_t</span>
<a href="#l32.1388"></a><span id="l32.1388" class="difflineplus">+RDFContentSinkImpl::PushContext(nsIRDFResource         *aResource,</span>
<a href="#l32.1389"></a><span id="l32.1389" class="difflineplus">+                                RDFContentSinkState     aState,</span>
<a href="#l32.1390"></a><span id="l32.1390" class="difflineplus">+                                RDFContentSinkParseMode aParseMode)</span>
<a href="#l32.1391"></a><span id="l32.1391" class="difflineplus">+{</span>
<a href="#l32.1392"></a><span id="l32.1392" class="difflineplus">+    if (! mContextStack) {</span>
<a href="#l32.1393"></a><span id="l32.1393" class="difflineplus">+        mContextStack = new AutoTArray&lt;RDFContextStackElement, 8&gt;();</span>
<a href="#l32.1394"></a><span id="l32.1394" class="difflineplus">+        if (! mContextStack)</span>
<a href="#l32.1395"></a><span id="l32.1395" class="difflineplus">+            return 0;</span>
<a href="#l32.1396"></a><span id="l32.1396" class="difflineplus">+    }</span>
<a href="#l32.1397"></a><span id="l32.1397" class="difflineplus">+</span>
<a href="#l32.1398"></a><span id="l32.1398" class="difflineplus">+    RDFContextStackElement* e = mContextStack-&gt;AppendElement();</span>
<a href="#l32.1399"></a><span id="l32.1399" class="difflineplus">+    if (! e)</span>
<a href="#l32.1400"></a><span id="l32.1400" class="difflineplus">+        return mContextStack-&gt;Length();</span>
<a href="#l32.1401"></a><span id="l32.1401" class="difflineplus">+</span>
<a href="#l32.1402"></a><span id="l32.1402" class="difflineplus">+    e-&gt;mResource  = aResource;</span>
<a href="#l32.1403"></a><span id="l32.1403" class="difflineplus">+    e-&gt;mState     = aState;</span>
<a href="#l32.1404"></a><span id="l32.1404" class="difflineplus">+    e-&gt;mParseMode = aParseMode;</span>
<a href="#l32.1405"></a><span id="l32.1405" class="difflineplus">+</span>
<a href="#l32.1406"></a><span id="l32.1406" class="difflineplus">+    return mContextStack-&gt;Length();</span>
<a href="#l32.1407"></a><span id="l32.1407" class="difflineplus">+}</span>
<a href="#l32.1408"></a><span id="l32.1408" class="difflineplus">+</span>
<a href="#l32.1409"></a><span id="l32.1409" class="difflineplus">+nsresult</span>
<a href="#l32.1410"></a><span id="l32.1410" class="difflineplus">+RDFContentSinkImpl::PopContext(nsIRDFResource         *&amp;aResource,</span>
<a href="#l32.1411"></a><span id="l32.1411" class="difflineplus">+                               RDFContentSinkState     &amp;aState,</span>
<a href="#l32.1412"></a><span id="l32.1412" class="difflineplus">+                               RDFContentSinkParseMode &amp;aParseMode)</span>
<a href="#l32.1413"></a><span id="l32.1413" class="difflineplus">+{</span>
<a href="#l32.1414"></a><span id="l32.1414" class="difflineplus">+    if ((nullptr == mContextStack) ||</span>
<a href="#l32.1415"></a><span id="l32.1415" class="difflineplus">+        (mContextStack-&gt;IsEmpty())) {</span>
<a href="#l32.1416"></a><span id="l32.1416" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.1417"></a><span id="l32.1417" class="difflineplus">+    }</span>
<a href="#l32.1418"></a><span id="l32.1418" class="difflineplus">+</span>
<a href="#l32.1419"></a><span id="l32.1419" class="difflineplus">+    uint32_t i = mContextStack-&gt;Length() - 1;</span>
<a href="#l32.1420"></a><span id="l32.1420" class="difflineplus">+    RDFContextStackElement &amp;e = mContextStack-&gt;ElementAt(i);</span>
<a href="#l32.1421"></a><span id="l32.1421" class="difflineplus">+</span>
<a href="#l32.1422"></a><span id="l32.1422" class="difflineplus">+    aResource  = e.mResource;</span>
<a href="#l32.1423"></a><span id="l32.1423" class="difflineplus">+    NS_IF_ADDREF(aResource);</span>
<a href="#l32.1424"></a><span id="l32.1424" class="difflineplus">+    aState     = e.mState;</span>
<a href="#l32.1425"></a><span id="l32.1425" class="difflineplus">+    aParseMode = e.mParseMode;</span>
<a href="#l32.1426"></a><span id="l32.1426" class="difflineplus">+</span>
<a href="#l32.1427"></a><span id="l32.1427" class="difflineplus">+    mContextStack-&gt;RemoveElementAt(i);</span>
<a href="#l32.1428"></a><span id="l32.1428" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1429"></a><span id="l32.1429" class="difflineplus">+}</span>
<a href="#l32.1430"></a><span id="l32.1430" class="difflineplus">+</span>
<a href="#l32.1431"></a><span id="l32.1431" class="difflineplus">+</span>
<a href="#l32.1432"></a><span id="l32.1432" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l32.1433"></a><span id="l32.1433" class="difflineplus">+</span>
<a href="#l32.1434"></a><span id="l32.1434" class="difflineplus">+nsresult</span>
<a href="#l32.1435"></a><span id="l32.1435" class="difflineplus">+NS_NewRDFContentSink(nsIRDFContentSink** aResult)</span>
<a href="#l32.1436"></a><span id="l32.1436" class="difflineplus">+{</span>
<a href="#l32.1437"></a><span id="l32.1437" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l32.1438"></a><span id="l32.1438" class="difflineplus">+    if (! aResult)</span>
<a href="#l32.1439"></a><span id="l32.1439" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.1440"></a><span id="l32.1440" class="difflineplus">+</span>
<a href="#l32.1441"></a><span id="l32.1441" class="difflineplus">+    RDFContentSinkImpl* sink = new RDFContentSinkImpl();</span>
<a href="#l32.1442"></a><span id="l32.1442" class="difflineplus">+    if (! sink)</span>
<a href="#l32.1443"></a><span id="l32.1443" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l32.1444"></a><span id="l32.1444" class="difflineplus">+</span>
<a href="#l32.1445"></a><span id="l32.1445" class="difflineplus">+    NS_ADDREF(sink);</span>
<a href="#l32.1446"></a><span id="l32.1446" class="difflineplus">+    *aResult = sink;</span>
<a href="#l32.1447"></a><span id="l32.1447" class="difflineplus">+    return NS_OK;</span>
<a href="#l32.1448"></a><span id="l32.1448" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/rdf/base/nsRDFResource.cpp</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,220 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+#include &quot;nsRDFResource.h&quot;</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+#include &quot;nsIRDFDelegateFactory.h&quot;</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+nsIRDFService* nsRDFResource::gRDFService = nullptr;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+nsrefcnt nsRDFResource::gRDFServiceRefCnt = 0;</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+nsRDFResource::nsRDFResource(void)</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+    : mDelegates(nullptr)</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+{</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+}</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+nsRDFResource::~nsRDFResource(void)</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+{</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+    // Release all of the delegate objects</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+    while (mDelegates) {</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+        DelegateEntry* doomed = mDelegates;</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+        mDelegates = mDelegates-&gt;mNext;</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+        delete doomed;</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+    }</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+    if (!gRDFService)</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+        return;</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+    gRDFService-&gt;UnregisterResource(this);</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+    if (--gRDFServiceRefCnt == 0)</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+        NS_RELEASE(gRDFService);</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+}</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+NS_IMPL_ISUPPORTS(nsRDFResource, nsIRDFResource, nsIRDFNode)</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+// nsIRDFNode methods:</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+nsRDFResource::EqualsNode(nsIRDFNode* aNode, bool* aResult)</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+{</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+    NS_PRECONDITION(aNode != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+    if (! aNode)</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+    nsresult rv;</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+    nsIRDFResource* resource;</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+    rv = aNode-&gt;QueryInterface(NS_GET_IID(nsIRDFResource), (void**)&amp;resource);</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+        *aResult = (static_cast&lt;nsIRDFResource*&gt;(this) == resource);</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+        NS_RELEASE(resource);</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+        return NS_OK;</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+    }</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+    if (rv == NS_NOINTERFACE) {</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+        *aResult = false;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+        return NS_OK;</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+    }</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+    return rv;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+}</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+// nsIRDFResource methods:</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+nsRDFResource::Init(const char* aURI)</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+{</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+    NS_PRECONDITION(aURI != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+    if (! aURI)</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+    mURI = aURI;</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+    if (gRDFServiceRefCnt++ == 0) {</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+        nsresult rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+    }</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+    // don't replace an existing resource with the same URI automatically</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+    return gRDFService-&gt;RegisterResource(this, true);</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+}</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+nsRDFResource::GetValue(char* *aURI)</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+{</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+    NS_ASSERTION(aURI, &quot;Null out param.&quot;);</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+    *aURI = ToNewCString(mURI);</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+    if (!*aURI)</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+    return NS_OK;</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineplus">+}</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+nsRDFResource::GetValueUTF8(nsACString&amp; aResult)</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+{</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+    aResult = mURI;</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+    return NS_OK;</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+}</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineplus">+nsRDFResource::GetValueConst(const char** aURI)</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+{</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+    *aURI = mURI.get();</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+    return NS_OK;</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineplus">+}</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineplus">+</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+nsRDFResource::EqualsString(const char* aURI, bool* aResult)</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+{</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+    NS_PRECONDITION(aURI != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+    if (! aURI)</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+    NS_PRECONDITION(aResult, &quot;null ptr&quot;);</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineplus">+    *aResult = mURI.Equals(aURI);</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+    return NS_OK;</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+}</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+nsRDFResource::GetDelegate(const char* aKey, REFNSIID aIID, void** aResult)</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+{</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineplus">+    NS_PRECONDITION(aKey != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+    if (! aKey)</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+    nsresult rv;</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+    *aResult = nullptr;</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+    DelegateEntry* entry = mDelegates;</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+    while (entry) {</span>
<a href="#l33.150"></a><span id="l33.150" class="difflineplus">+        if (entry-&gt;mKey.Equals(aKey)) {</span>
<a href="#l33.151"></a><span id="l33.151" class="difflineplus">+            rv = entry-&gt;mDelegate-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l33.152"></a><span id="l33.152" class="difflineplus">+            return rv;</span>
<a href="#l33.153"></a><span id="l33.153" class="difflineplus">+        }</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineplus">+</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+        entry = entry-&gt;mNext;</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+    }</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineplus">+</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineplus">+    // Construct a ContractID of the form &quot;@mozilla.org/rdf/delegate/[key]/[scheme];1</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+    nsAutoCString contractID(NS_RDF_DELEGATEFACTORY_CONTRACTID_PREFIX);</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+    contractID.Append(aKey);</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+    contractID.AppendLiteral(&quot;&amp;scheme=&quot;);</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+    int32_t i = mURI.FindChar(':');</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+    contractID += StringHead(mURI, i);</span>
<a href="#l33.165"></a><span id="l33.165" class="difflineplus">+</span>
<a href="#l33.166"></a><span id="l33.166" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDelegateFactory&gt; delegateFactory =</span>
<a href="#l33.167"></a><span id="l33.167" class="difflineplus">+             do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineplus">+</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineplus">+    rv = delegateFactory-&gt;CreateDelegate(this, aKey, aIID, aResult);</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineplus">+</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+    // Okay, we've successfully created a delegate. Let's remember it.</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+    entry = new DelegateEntry;</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+    if (! entry) {</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+        NS_RELEASE(*reinterpret_cast&lt;nsISupports**&gt;(aResult));</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+    }</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineplus">+</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineplus">+    entry-&gt;mKey      = aKey;</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+    entry-&gt;mDelegate = do_QueryInterface(*reinterpret_cast&lt;nsISupports**&gt;(aResult), &amp;rv);</span>
<a href="#l33.182"></a><span id="l33.182" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+        NS_ERROR(&quot;nsRDFResource::GetDelegate(): can't QI to nsISupports!&quot;);</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+</span>
<a href="#l33.185"></a><span id="l33.185" class="difflineplus">+        delete entry;</span>
<a href="#l33.186"></a><span id="l33.186" class="difflineplus">+        NS_RELEASE(*reinterpret_cast&lt;nsISupports**&gt;(aResult));</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+    }</span>
<a href="#l33.189"></a><span id="l33.189" class="difflineplus">+</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineplus">+    entry-&gt;mNext     = mDelegates;</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineplus">+</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineplus">+    mDelegates = entry;</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineplus">+</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineplus">+    return NS_OK;</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineplus">+}</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineplus">+</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineplus">+nsRDFResource::ReleaseDelegate(const char* aKey)</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineplus">+{</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineplus">+    NS_PRECONDITION(aKey != nullptr, &quot;null ptr&quot;);</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineplus">+    if (! aKey)</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineplus">+</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineplus">+    DelegateEntry* entry = mDelegates;</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineplus">+    DelegateEntry** link = &amp;mDelegates;</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineplus">+</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineplus">+    while (entry) {</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineplus">+        if (entry-&gt;mKey.Equals(aKey)) {</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+            *link = entry-&gt;mNext;</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineplus">+            delete entry;</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineplus">+            return NS_OK;</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineplus">+        }</span>
<a href="#l33.213"></a><span id="l33.213" class="difflineplus">+</span>
<a href="#l33.214"></a><span id="l33.214" class="difflineplus">+        link = &amp;(entry-&gt;mNext);</span>
<a href="#l33.215"></a><span id="l33.215" class="difflineplus">+        entry = entry-&gt;mNext;</span>
<a href="#l33.216"></a><span id="l33.216" class="difflineplus">+    }</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineplus">+</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineplus">+    NS_WARNING(&quot;nsRDFResource::ReleaseDelegate() no delegate found&quot;);</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineplus">+    return NS_OK;</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineplus">+}</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineplus">+</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineplus">+</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineplus">+////////////////////////////////////////////////////////////////////////////////</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/rdf/base/nsRDFResource.h</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,59 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+#ifndef nsRDFResource_h__</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+#define nsRDFResource_h__</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+class nsIRDFService;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+/**</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+ * This simple base class implements nsIRDFResource, and can be used as a</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+ * superclass for more sophisticated resource implementations.</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+ */</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+class nsRDFResource : public nsIRDFResource {</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+public:</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+    // nsIRDFNode methods:</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+    NS_IMETHOD EqualsNode(nsIRDFNode* aNode, bool* aResult) override;</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+    // nsIRDFResource methods:</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+    NS_IMETHOD Init(const char* aURI) override;</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+    NS_IMETHOD GetValue(char* *aURI) override;</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+    NS_IMETHOD GetValueUTF8(nsACString&amp; aResult) override;</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+    NS_IMETHOD GetValueConst(const char** aURI) override;</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+    NS_IMETHOD EqualsString(const char* aURI, bool* aResult) override;</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+    NS_IMETHOD GetDelegate(const char* aKey, REFNSIID aIID, void** aResult) override;</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+    NS_IMETHOD ReleaseDelegate(const char* aKey) override;</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+    // nsRDFResource methods:</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+    nsRDFResource(void);</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+protected:</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+    virtual ~nsRDFResource(void);</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+    static nsIRDFService* gRDFService;</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+    static nsrefcnt gRDFServiceRefCnt;</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+protected:</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+    nsCString mURI;</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+    struct DelegateEntry {</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+        nsCString             mKey;</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; mDelegate;</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+        DelegateEntry*        mNext;</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+    };</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+    DelegateEntry* mDelegates;</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+};</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+#endif // nsRDFResource_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/rdf/base/nsRDFService.cpp</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,1540 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ *</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.  */</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+/*</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+  This file provides the implementation for the RDF service manager.</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+  TO DO</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+  -----</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+  1) Implement the CreateDataBase() methods.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+  2) Cache date and int literals.</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ */</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+#include &quot;nsRDFService.h&quot;</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+#include &quot;nsMemory.h&quot;</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+#include &quot;nsAtom.h&quot;</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+#include &quot;nsIFactory.h&quot;</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+#include &quot;nsIURI.h&quot;</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+#include &quot;PLDHashTable.h&quot;</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+#include &quot;plhash.h&quot;</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+#include &quot;plstr.h&quot;</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+#include &quot;prprf.h&quot;</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+#include &quot;mozilla/HashFunctions.h&quot;</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+#include &quot;mozilla/IntegerPrintfMacros.h&quot;</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+using namespace mozilla;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+static NS_DEFINE_CID(kRDFXMLDataSourceCID,    NS_RDFXMLDATASOURCE_CID);</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+static NS_DEFINE_CID(kRDFDefaultResourceCID,  NS_RDFDEFAULTRESOURCE_CID);</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+static NS_DEFINE_IID(kIRDFLiteralIID,         NS_IRDFLITERAL_IID);</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+static NS_DEFINE_IID(kIRDFDateIID,         NS_IRDFDATE_IID);</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+static NS_DEFINE_IID(kIRDFIntIID,         NS_IRDFINT_IID);</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+static NS_DEFINE_IID(kIRDFNodeIID,            NS_IRDFNODE_IID);</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+static NS_DEFINE_IID(kISupportsIID,           NS_ISUPPORTS_IID);</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+static LazyLogModule gLog(&quot;nsRDFService&quot;);</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+class BlobImpl;</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+// These functions are copied from nsprpub/lib/ds/plhash.c, with one</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+// change to free the key in DataSourceFreeEntry.</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+// XXX sigh, why were DefaultAllocTable et. al. declared static, anyway?</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+static void *</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+DataSourceAllocTable(void *pool, size_t size)</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+{</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+    return malloc(size);</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+}</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+static void</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+DataSourceFreeTable(void *pool, void *item)</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+{</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+    free(item);</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+}</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+static PLHashEntry *</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+DataSourceAllocEntry(void *pool, const void *key)</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+{</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+    return (PLHashEntry*) malloc(sizeof(PLHashEntry));</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+}</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+static void</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+DataSourceFreeEntry(void *pool, PLHashEntry *he, unsigned flag)</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+{</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+    if (flag == HT_FREE_ENTRY) {</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+        PL_strfree((char*) he-&gt;key);</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+        free(he);</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+    }</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+}</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+static PLHashAllocOps dataSourceHashAllocOps = {</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+    DataSourceAllocTable, DataSourceFreeTable,</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+    DataSourceAllocEntry, DataSourceFreeEntry</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+};</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+//</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+// For the mResources hashtable.</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+//</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+struct ResourceHashEntry : public PLDHashEntryHdr {</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+    const char *mKey;</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+    nsIRDFResource *mResource;</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+    static PLDHashNumber</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+    HashKey(const void *key)</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+    {</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+        return HashString(static_cast&lt;const char *&gt;(key));</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+    }</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+    static bool</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+    {</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+        const ResourceHashEntry *entry =</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+            static_cast&lt;const ResourceHashEntry *&gt;(hdr);</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+        return 0 == nsCRT::strcmp(static_cast&lt;const char *&gt;(key),</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+                                  entry-&gt;mKey);</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+    }</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+};</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+static const PLDHashTableOps gResourceTableOps = {</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+    ResourceHashEntry::HashKey,</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+    ResourceHashEntry::MatchEntry,</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+    PLDHashTable::MoveEntryStub,</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+    PLDHashTable::ClearEntryStub,</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+    nullptr</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+};</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+// ----------------------------------------------------------------------</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+//</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+// For the mLiterals hashtable.</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+//</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+struct LiteralHashEntry : public PLDHashEntryHdr {</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+    nsIRDFLiteral *mLiteral;</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+    const char16_t *mKey;</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+    static PLDHashNumber</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+    HashKey(const void *key)</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+    {</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+        return HashString(static_cast&lt;const char16_t *&gt;(key));</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+    }</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+    static bool</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+    {</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+        const LiteralHashEntry *entry =</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+            static_cast&lt;const LiteralHashEntry *&gt;(hdr);</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+        return 0 == nsCRT::strcmp(static_cast&lt;const char16_t *&gt;(key),</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+                                  entry-&gt;mKey);</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+    }</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+};</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+static const PLDHashTableOps gLiteralTableOps = {</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+    LiteralHashEntry::HashKey,</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+    LiteralHashEntry::MatchEntry,</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+    PLDHashTable::MoveEntryStub,</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+    PLDHashTable::ClearEntryStub,</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+    nullptr</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+};</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+// ----------------------------------------------------------------------</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+//</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+// For the mInts hashtable.</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+//</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+struct IntHashEntry : public PLDHashEntryHdr {</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+    nsIRDFInt *mInt;</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+    int32_t    mKey;</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+    static PLDHashNumber</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+    HashKey(const void *key)</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+    {</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+        return PLDHashNumber(*static_cast&lt;const int32_t *&gt;(key));</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+    }</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+    static bool</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+    {</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+        const IntHashEntry *entry =</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+            static_cast&lt;const IntHashEntry *&gt;(hdr);</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+        return *static_cast&lt;const int32_t *&gt;(key) == entry-&gt;mKey;</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+    }</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+};</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+static const PLDHashTableOps gIntTableOps = {</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+    IntHashEntry::HashKey,</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+    IntHashEntry::MatchEntry,</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+    PLDHashTable::MoveEntryStub,</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+    PLDHashTable::ClearEntryStub,</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+    nullptr</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+};</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+// ----------------------------------------------------------------------</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+//</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+// For the mDates hashtable.</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+//</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+struct DateHashEntry : public PLDHashEntryHdr {</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+    nsIRDFDate *mDate;</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+    PRTime      mKey;</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+    static PLDHashNumber</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+    HashKey(const void *key)</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+    {</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+        // xor the low 32 bits with the high 32 bits.</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+        PRTime t = *static_cast&lt;const PRTime *&gt;(key);</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+        int32_t h32 = int32_t(t &gt;&gt; 32);</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+        int32_t l32 = int32_t(0xffffffff &amp; t);</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+        return PLDHashNumber(l32 ^ h32);</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+    }</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+    static bool</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+    {</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+        const DateHashEntry *entry =</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+            static_cast&lt;const DateHashEntry *&gt;(hdr);</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+        return *static_cast&lt;const PRTime *&gt;(key) == entry-&gt;mKey;</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+    }</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+};</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+static const PLDHashTableOps gDateTableOps = {</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+    DateHashEntry::HashKey,</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+    DateHashEntry::MatchEntry,</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+    PLDHashTable::MoveEntryStub,</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+    PLDHashTable::ClearEntryStub,</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+    nullptr</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+};</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+class BlobImpl : public nsIRDFBlob</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+{</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+public:</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+    struct Data {</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+        int32_t  mLength;</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+        uint8_t *mBytes;</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+    };</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+    BlobImpl(const uint8_t *aBytes, int32_t aLength)</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+    {</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+        mData.mLength = aLength;</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+        mData.mBytes = new uint8_t[aLength];</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+        memcpy(mData.mBytes, aBytes, aLength);</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+        NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+        RDFServiceImpl::gRDFService-&gt;RegisterBlob(this);</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+    }</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+protected:</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+    virtual ~BlobImpl()</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+    {</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+        RDFServiceImpl::gRDFService-&gt;UnregisterBlob(this);</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+        // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+        // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+        // what a vanilla NS_RELEASE() would do).</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+        nsrefcnt refcnt;</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+        NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+        delete[] mData.mBytes;</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineplus">+    }</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+public:</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+    NS_DECL_NSIRDFNODE</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+    NS_DECL_NSIRDFBLOB</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+    Data mData;</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+};</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+NS_IMPL_ISUPPORTS(BlobImpl, nsIRDFNode, nsIRDFBlob)</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+BlobImpl::EqualsNode(nsIRDFNode *aNode, bool *aEquals)</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+{</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+    nsCOMPtr&lt;nsIRDFBlob&gt; blob = do_QueryInterface(aNode);</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+    if (blob) {</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineplus">+        int32_t length;</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineplus">+        blob-&gt;GetLength(&amp;length);</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+        if (length == mData.mLength) {</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+            const uint8_t *bytes;</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+            blob-&gt;GetValue(&amp;bytes);</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+            if (0 == memcmp(bytes, mData.mBytes, length)) {</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+                *aEquals = true;</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+                return NS_OK;</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+            }</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+        }</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+    }</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineplus">+</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+    *aEquals = false;</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineplus">+}</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineplus">+</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+BlobImpl::GetValue(const uint8_t **aResult)</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+{</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+    *aResult = mData.mBytes;</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineplus">+}</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineplus">+</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+BlobImpl::GetLength(int32_t *aResult)</span>
<a href="#l35.312"></a><span id="l35.312" class="difflineplus">+{</span>
<a href="#l35.313"></a><span id="l35.313" class="difflineplus">+    *aResult = mData.mLength;</span>
<a href="#l35.314"></a><span id="l35.314" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.315"></a><span id="l35.315" class="difflineplus">+}</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineplus">+</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineplus">+// ----------------------------------------------------------------------</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineplus">+//</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineplus">+// For the mBlobs hashtable.</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineplus">+//</span>
<a href="#l35.321"></a><span id="l35.321" class="difflineplus">+</span>
<a href="#l35.322"></a><span id="l35.322" class="difflineplus">+struct BlobHashEntry : public PLDHashEntryHdr {</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineplus">+    BlobImpl *mBlob;</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineplus">+</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineplus">+    static PLDHashNumber</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineplus">+    HashKey(const void *key)</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineplus">+    {</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineplus">+        const BlobImpl::Data *data =</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineplus">+            static_cast&lt;const BlobImpl::Data *&gt;(key);</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineplus">+        return HashBytes(data-&gt;mBytes, data-&gt;mLength);</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineplus">+    }</span>
<a href="#l35.332"></a><span id="l35.332" class="difflineplus">+</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineplus">+    static bool</span>
<a href="#l35.334"></a><span id="l35.334" class="difflineplus">+    MatchEntry(const PLDHashEntryHdr *hdr, const void *key)</span>
<a href="#l35.335"></a><span id="l35.335" class="difflineplus">+    {</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineplus">+        const BlobHashEntry *entry =</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineplus">+            static_cast&lt;const BlobHashEntry *&gt;(hdr);</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineplus">+</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+        const BlobImpl::Data *left = &amp;entry-&gt;mBlob-&gt;mData;</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineplus">+</span>
<a href="#l35.341"></a><span id="l35.341" class="difflineplus">+        const BlobImpl::Data *right =</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineplus">+            static_cast&lt;const BlobImpl::Data *&gt;(key);</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineplus">+</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineplus">+        return (left-&gt;mLength == right-&gt;mLength)</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineplus">+            &amp;&amp; 0 == memcmp(left-&gt;mBytes, right-&gt;mBytes, right-&gt;mLength);</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+    }</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineplus">+};</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineplus">+</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineplus">+static const PLDHashTableOps gBlobTableOps = {</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineplus">+    BlobHashEntry::HashKey,</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineplus">+    BlobHashEntry::MatchEntry,</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineplus">+    PLDHashTable::MoveEntryStub,</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineplus">+    PLDHashTable::ClearEntryStub,</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineplus">+    nullptr</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+};</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineplus">+</span>
<a href="#l35.357"></a><span id="l35.357" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.358"></a><span id="l35.358" class="difflineplus">+// LiteralImpl</span>
<a href="#l35.359"></a><span id="l35.359" class="difflineplus">+//</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineplus">+//   Currently, all literals are implemented exactly the same way;</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineplus">+//   i.e., there is are no resource factories to allow you to generate</span>
<a href="#l35.362"></a><span id="l35.362" class="difflineplus">+//   customer resources. I doubt that makes sense, anyway.</span>
<a href="#l35.363"></a><span id="l35.363" class="difflineplus">+//</span>
<a href="#l35.364"></a><span id="l35.364" class="difflineplus">+class LiteralImpl : public nsIRDFLiteral {</span>
<a href="#l35.365"></a><span id="l35.365" class="difflineplus">+public:</span>
<a href="#l35.366"></a><span id="l35.366" class="difflineplus">+    static nsresult</span>
<a href="#l35.367"></a><span id="l35.367" class="difflineplus">+    Create(const char16_t* aValue, nsIRDFLiteral** aResult);</span>
<a href="#l35.368"></a><span id="l35.368" class="difflineplus">+</span>
<a href="#l35.369"></a><span id="l35.369" class="difflineplus">+    // nsISupports</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineplus">+    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineplus">+</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+    // nsIRDFNode</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineplus">+    NS_DECL_NSIRDFNODE</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineplus">+</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineplus">+    // nsIRDFLiteral</span>
<a href="#l35.376"></a><span id="l35.376" class="difflineplus">+    NS_DECL_NSIRDFLITERAL</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineplus">+</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+protected:</span>
<a href="#l35.379"></a><span id="l35.379" class="difflineplus">+    explicit LiteralImpl(const char16_t* s);</span>
<a href="#l35.380"></a><span id="l35.380" class="difflineplus">+    virtual ~LiteralImpl();</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineplus">+</span>
<a href="#l35.382"></a><span id="l35.382" class="difflineplus">+    const char16_t* GetValue() const {</span>
<a href="#l35.383"></a><span id="l35.383" class="difflineplus">+        size_t objectSize = ((sizeof(LiteralImpl) + sizeof(char16_t) - 1) / sizeof(char16_t)) * sizeof(char16_t);</span>
<a href="#l35.384"></a><span id="l35.384" class="difflineplus">+        return reinterpret_cast&lt;const char16_t*&gt;(reinterpret_cast&lt;const unsigned char*&gt;(this) + objectSize);</span>
<a href="#l35.385"></a><span id="l35.385" class="difflineplus">+    }</span>
<a href="#l35.386"></a><span id="l35.386" class="difflineplus">+};</span>
<a href="#l35.387"></a><span id="l35.387" class="difflineplus">+</span>
<a href="#l35.388"></a><span id="l35.388" class="difflineplus">+</span>
<a href="#l35.389"></a><span id="l35.389" class="difflineplus">+nsresult</span>
<a href="#l35.390"></a><span id="l35.390" class="difflineplus">+LiteralImpl::Create(const char16_t* aValue, nsIRDFLiteral** aResult)</span>
<a href="#l35.391"></a><span id="l35.391" class="difflineplus">+{</span>
<a href="#l35.392"></a><span id="l35.392" class="difflineplus">+    // Goofy math to get alignment right. Copied from nsSharedString.h.</span>
<a href="#l35.393"></a><span id="l35.393" class="difflineplus">+    size_t objectSize = ((sizeof(LiteralImpl) + sizeof(char16_t) - 1) / sizeof(char16_t)) * sizeof(char16_t);</span>
<a href="#l35.394"></a><span id="l35.394" class="difflineplus">+    size_t stringLen = nsCharTraits&lt;char16_t&gt;::length(aValue);</span>
<a href="#l35.395"></a><span id="l35.395" class="difflineplus">+    size_t stringSize = (stringLen + 1) * sizeof(char16_t);</span>
<a href="#l35.396"></a><span id="l35.396" class="difflineplus">+</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineplus">+    void* objectPtr = operator new(objectSize + stringSize);</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+    if (! objectPtr)</span>
<a href="#l35.399"></a><span id="l35.399" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.400"></a><span id="l35.400" class="difflineplus">+</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineplus">+    char16_t* buf = reinterpret_cast&lt;char16_t*&gt;(static_cast&lt;unsigned char*&gt;(objectPtr) + objectSize);</span>
<a href="#l35.402"></a><span id="l35.402" class="difflineplus">+    nsCharTraits&lt;char16_t&gt;::copy(buf, aValue, stringLen + 1);</span>
<a href="#l35.403"></a><span id="l35.403" class="difflineplus">+</span>
<a href="#l35.404"></a><span id="l35.404" class="difflineplus">+    NS_ADDREF(*aResult = new (objectPtr) LiteralImpl(buf));</span>
<a href="#l35.405"></a><span id="l35.405" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.406"></a><span id="l35.406" class="difflineplus">+}</span>
<a href="#l35.407"></a><span id="l35.407" class="difflineplus">+</span>
<a href="#l35.408"></a><span id="l35.408" class="difflineplus">+</span>
<a href="#l35.409"></a><span id="l35.409" class="difflineplus">+LiteralImpl::LiteralImpl(const char16_t* s)</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineplus">+{</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineplus">+    RDFServiceImpl::gRDFService-&gt;RegisterLiteral(this);</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineplus">+    NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineplus">+}</span>
<a href="#l35.414"></a><span id="l35.414" class="difflineplus">+</span>
<a href="#l35.415"></a><span id="l35.415" class="difflineplus">+LiteralImpl::~LiteralImpl()</span>
<a href="#l35.416"></a><span id="l35.416" class="difflineplus">+{</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineplus">+    RDFServiceImpl::gRDFService-&gt;UnregisterLiteral(this);</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineplus">+</span>
<a href="#l35.419"></a><span id="l35.419" class="difflineplus">+    // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l35.420"></a><span id="l35.420" class="difflineplus">+    // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineplus">+    // what a vanilla NS_RELEASE() would do).</span>
<a href="#l35.422"></a><span id="l35.422" class="difflineplus">+    nsrefcnt refcnt;</span>
<a href="#l35.423"></a><span id="l35.423" class="difflineplus">+    NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l35.424"></a><span id="l35.424" class="difflineplus">+}</span>
<a href="#l35.425"></a><span id="l35.425" class="difflineplus">+</span>
<a href="#l35.426"></a><span id="l35.426" class="difflineplus">+NS_IMPL_ADDREF(LiteralImpl)</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineplus">+NS_IMPL_RELEASE(LiteralImpl)</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineplus">+</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineplus">+nsresult</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineplus">+LiteralImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l35.431"></a><span id="l35.431" class="difflineplus">+{</span>
<a href="#l35.432"></a><span id="l35.432" class="difflineplus">+    if (! result)</span>
<a href="#l35.433"></a><span id="l35.433" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.434"></a><span id="l35.434" class="difflineplus">+</span>
<a href="#l35.435"></a><span id="l35.435" class="difflineplus">+    *result = nullptr;</span>
<a href="#l35.436"></a><span id="l35.436" class="difflineplus">+    if (iid.Equals(kIRDFLiteralIID) ||</span>
<a href="#l35.437"></a><span id="l35.437" class="difflineplus">+        iid.Equals(kIRDFNodeIID) ||</span>
<a href="#l35.438"></a><span id="l35.438" class="difflineplus">+        iid.Equals(kISupportsIID)) {</span>
<a href="#l35.439"></a><span id="l35.439" class="difflineplus">+        *result = static_cast&lt;nsIRDFLiteral*&gt;(this);</span>
<a href="#l35.440"></a><span id="l35.440" class="difflineplus">+        AddRef();</span>
<a href="#l35.441"></a><span id="l35.441" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.442"></a><span id="l35.442" class="difflineplus">+    }</span>
<a href="#l35.443"></a><span id="l35.443" class="difflineplus">+    return NS_NOINTERFACE;</span>
<a href="#l35.444"></a><span id="l35.444" class="difflineplus">+}</span>
<a href="#l35.445"></a><span id="l35.445" class="difflineplus">+</span>
<a href="#l35.446"></a><span id="l35.446" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.447"></a><span id="l35.447" class="difflineplus">+LiteralImpl::EqualsNode(nsIRDFNode* aNode, bool* aResult)</span>
<a href="#l35.448"></a><span id="l35.448" class="difflineplus">+{</span>
<a href="#l35.449"></a><span id="l35.449" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.450"></a><span id="l35.450" class="difflineplus">+    nsIRDFLiteral* literal;</span>
<a href="#l35.451"></a><span id="l35.451" class="difflineplus">+    rv = aNode-&gt;QueryInterface(kIRDFLiteralIID, (void**) &amp;literal);</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l35.453"></a><span id="l35.453" class="difflineplus">+        *aResult = (static_cast&lt;nsIRDFLiteral*&gt;(this) == literal);</span>
<a href="#l35.454"></a><span id="l35.454" class="difflineplus">+        NS_RELEASE(literal);</span>
<a href="#l35.455"></a><span id="l35.455" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.456"></a><span id="l35.456" class="difflineplus">+    }</span>
<a href="#l35.457"></a><span id="l35.457" class="difflineplus">+    else if (rv == NS_NOINTERFACE) {</span>
<a href="#l35.458"></a><span id="l35.458" class="difflineplus">+        *aResult = false;</span>
<a href="#l35.459"></a><span id="l35.459" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.460"></a><span id="l35.460" class="difflineplus">+    }</span>
<a href="#l35.461"></a><span id="l35.461" class="difflineplus">+    else {</span>
<a href="#l35.462"></a><span id="l35.462" class="difflineplus">+        return rv;</span>
<a href="#l35.463"></a><span id="l35.463" class="difflineplus">+    }</span>
<a href="#l35.464"></a><span id="l35.464" class="difflineplus">+}</span>
<a href="#l35.465"></a><span id="l35.465" class="difflineplus">+</span>
<a href="#l35.466"></a><span id="l35.466" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.467"></a><span id="l35.467" class="difflineplus">+LiteralImpl::GetValue(char16_t* *value)</span>
<a href="#l35.468"></a><span id="l35.468" class="difflineplus">+{</span>
<a href="#l35.469"></a><span id="l35.469" class="difflineplus">+    NS_ASSERTION(value, &quot;null ptr&quot;);</span>
<a href="#l35.470"></a><span id="l35.470" class="difflineplus">+    if (! value)</span>
<a href="#l35.471"></a><span id="l35.471" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineplus">+</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineplus">+    const char16_t *temp = GetValue();</span>
<a href="#l35.474"></a><span id="l35.474" class="difflineplus">+    *value = temp? NS_strdup(temp) : 0;</span>
<a href="#l35.475"></a><span id="l35.475" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.476"></a><span id="l35.476" class="difflineplus">+}</span>
<a href="#l35.477"></a><span id="l35.477" class="difflineplus">+</span>
<a href="#l35.478"></a><span id="l35.478" class="difflineplus">+</span>
<a href="#l35.479"></a><span id="l35.479" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.480"></a><span id="l35.480" class="difflineplus">+LiteralImpl::GetValueConst(const char16_t** aValue)</span>
<a href="#l35.481"></a><span id="l35.481" class="difflineplus">+{</span>
<a href="#l35.482"></a><span id="l35.482" class="difflineplus">+    *aValue = GetValue();</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineplus">+}</span>
<a href="#l35.485"></a><span id="l35.485" class="difflineplus">+</span>
<a href="#l35.486"></a><span id="l35.486" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.487"></a><span id="l35.487" class="difflineplus">+// DateImpl</span>
<a href="#l35.488"></a><span id="l35.488" class="difflineplus">+//</span>
<a href="#l35.489"></a><span id="l35.489" class="difflineplus">+</span>
<a href="#l35.490"></a><span id="l35.490" class="difflineplus">+class DateImpl : public nsIRDFDate {</span>
<a href="#l35.491"></a><span id="l35.491" class="difflineplus">+public:</span>
<a href="#l35.492"></a><span id="l35.492" class="difflineplus">+    explicit DateImpl(const PRTime s);</span>
<a href="#l35.493"></a><span id="l35.493" class="difflineplus">+</span>
<a href="#l35.494"></a><span id="l35.494" class="difflineplus">+    // nsISupports</span>
<a href="#l35.495"></a><span id="l35.495" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l35.496"></a><span id="l35.496" class="difflineplus">+</span>
<a href="#l35.497"></a><span id="l35.497" class="difflineplus">+    // nsIRDFNode</span>
<a href="#l35.498"></a><span id="l35.498" class="difflineplus">+    NS_DECL_NSIRDFNODE</span>
<a href="#l35.499"></a><span id="l35.499" class="difflineplus">+</span>
<a href="#l35.500"></a><span id="l35.500" class="difflineplus">+    // nsIRDFDate</span>
<a href="#l35.501"></a><span id="l35.501" class="difflineplus">+    NS_IMETHOD GetValue(PRTime *value) override;</span>
<a href="#l35.502"></a><span id="l35.502" class="difflineplus">+</span>
<a href="#l35.503"></a><span id="l35.503" class="difflineplus">+private:</span>
<a href="#l35.504"></a><span id="l35.504" class="difflineplus">+    virtual ~DateImpl();</span>
<a href="#l35.505"></a><span id="l35.505" class="difflineplus">+</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineplus">+    nsresult EqualsDate(nsIRDFDate* date, bool* result);</span>
<a href="#l35.507"></a><span id="l35.507" class="difflineplus">+    PRTime mValue;</span>
<a href="#l35.508"></a><span id="l35.508" class="difflineplus">+};</span>
<a href="#l35.509"></a><span id="l35.509" class="difflineplus">+</span>
<a href="#l35.510"></a><span id="l35.510" class="difflineplus">+</span>
<a href="#l35.511"></a><span id="l35.511" class="difflineplus">+DateImpl::DateImpl(const PRTime s)</span>
<a href="#l35.512"></a><span id="l35.512" class="difflineplus">+    : mValue(s)</span>
<a href="#l35.513"></a><span id="l35.513" class="difflineplus">+{</span>
<a href="#l35.514"></a><span id="l35.514" class="difflineplus">+    RDFServiceImpl::gRDFService-&gt;RegisterDate(this);</span>
<a href="#l35.515"></a><span id="l35.515" class="difflineplus">+    NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l35.516"></a><span id="l35.516" class="difflineplus">+}</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineplus">+</span>
<a href="#l35.518"></a><span id="l35.518" class="difflineplus">+DateImpl::~DateImpl()</span>
<a href="#l35.519"></a><span id="l35.519" class="difflineplus">+{</span>
<a href="#l35.520"></a><span id="l35.520" class="difflineplus">+    RDFServiceImpl::gRDFService-&gt;UnregisterDate(this);</span>
<a href="#l35.521"></a><span id="l35.521" class="difflineplus">+</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineplus">+    // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l35.523"></a><span id="l35.523" class="difflineplus">+    // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l35.524"></a><span id="l35.524" class="difflineplus">+    // what a vanilla NS_RELEASE() would do).</span>
<a href="#l35.525"></a><span id="l35.525" class="difflineplus">+    nsrefcnt refcnt;</span>
<a href="#l35.526"></a><span id="l35.526" class="difflineplus">+    NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l35.527"></a><span id="l35.527" class="difflineplus">+}</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineplus">+</span>
<a href="#l35.529"></a><span id="l35.529" class="difflineplus">+NS_IMPL_ADDREF(DateImpl)</span>
<a href="#l35.530"></a><span id="l35.530" class="difflineplus">+NS_IMPL_RELEASE(DateImpl)</span>
<a href="#l35.531"></a><span id="l35.531" class="difflineplus">+</span>
<a href="#l35.532"></a><span id="l35.532" class="difflineplus">+nsresult</span>
<a href="#l35.533"></a><span id="l35.533" class="difflineplus">+DateImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l35.534"></a><span id="l35.534" class="difflineplus">+{</span>
<a href="#l35.535"></a><span id="l35.535" class="difflineplus">+    if (! result)</span>
<a href="#l35.536"></a><span id="l35.536" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.537"></a><span id="l35.537" class="difflineplus">+</span>
<a href="#l35.538"></a><span id="l35.538" class="difflineplus">+    *result = nullptr;</span>
<a href="#l35.539"></a><span id="l35.539" class="difflineplus">+    if (iid.Equals(kIRDFDateIID) ||</span>
<a href="#l35.540"></a><span id="l35.540" class="difflineplus">+        iid.Equals(kIRDFNodeIID) ||</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineplus">+        iid.Equals(kISupportsIID)) {</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineplus">+        *result = static_cast&lt;nsIRDFDate*&gt;(this);</span>
<a href="#l35.543"></a><span id="l35.543" class="difflineplus">+        AddRef();</span>
<a href="#l35.544"></a><span id="l35.544" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.545"></a><span id="l35.545" class="difflineplus">+    }</span>
<a href="#l35.546"></a><span id="l35.546" class="difflineplus">+    return NS_NOINTERFACE;</span>
<a href="#l35.547"></a><span id="l35.547" class="difflineplus">+}</span>
<a href="#l35.548"></a><span id="l35.548" class="difflineplus">+</span>
<a href="#l35.549"></a><span id="l35.549" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.550"></a><span id="l35.550" class="difflineplus">+DateImpl::EqualsNode(nsIRDFNode* node, bool* result)</span>
<a href="#l35.551"></a><span id="l35.551" class="difflineplus">+{</span>
<a href="#l35.552"></a><span id="l35.552" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.553"></a><span id="l35.553" class="difflineplus">+    nsIRDFDate* date;</span>
<a href="#l35.554"></a><span id="l35.554" class="difflineplus">+    if (NS_SUCCEEDED(node-&gt;QueryInterface(kIRDFDateIID, (void**) &amp;date))) {</span>
<a href="#l35.555"></a><span id="l35.555" class="difflineplus">+        rv = EqualsDate(date, result);</span>
<a href="#l35.556"></a><span id="l35.556" class="difflineplus">+        NS_RELEASE(date);</span>
<a href="#l35.557"></a><span id="l35.557" class="difflineplus">+    }</span>
<a href="#l35.558"></a><span id="l35.558" class="difflineplus">+    else {</span>
<a href="#l35.559"></a><span id="l35.559" class="difflineplus">+        *result = false;</span>
<a href="#l35.560"></a><span id="l35.560" class="difflineplus">+        rv = NS_OK;</span>
<a href="#l35.561"></a><span id="l35.561" class="difflineplus">+    }</span>
<a href="#l35.562"></a><span id="l35.562" class="difflineplus">+    return rv;</span>
<a href="#l35.563"></a><span id="l35.563" class="difflineplus">+}</span>
<a href="#l35.564"></a><span id="l35.564" class="difflineplus">+</span>
<a href="#l35.565"></a><span id="l35.565" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.566"></a><span id="l35.566" class="difflineplus">+DateImpl::GetValue(PRTime *value)</span>
<a href="#l35.567"></a><span id="l35.567" class="difflineplus">+{</span>
<a href="#l35.568"></a><span id="l35.568" class="difflineplus">+    NS_ASSERTION(value, &quot;null ptr&quot;);</span>
<a href="#l35.569"></a><span id="l35.569" class="difflineplus">+    if (! value)</span>
<a href="#l35.570"></a><span id="l35.570" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.571"></a><span id="l35.571" class="difflineplus">+</span>
<a href="#l35.572"></a><span id="l35.572" class="difflineplus">+    *value = mValue;</span>
<a href="#l35.573"></a><span id="l35.573" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.574"></a><span id="l35.574" class="difflineplus">+}</span>
<a href="#l35.575"></a><span id="l35.575" class="difflineplus">+</span>
<a href="#l35.576"></a><span id="l35.576" class="difflineplus">+</span>
<a href="#l35.577"></a><span id="l35.577" class="difflineplus">+nsresult</span>
<a href="#l35.578"></a><span id="l35.578" class="difflineplus">+DateImpl::EqualsDate(nsIRDFDate* date, bool* result)</span>
<a href="#l35.579"></a><span id="l35.579" class="difflineplus">+{</span>
<a href="#l35.580"></a><span id="l35.580" class="difflineplus">+    NS_ASSERTION(date &amp;&amp; result, &quot;null ptr&quot;);</span>
<a href="#l35.581"></a><span id="l35.581" class="difflineplus">+    if (!date || !result)</span>
<a href="#l35.582"></a><span id="l35.582" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.583"></a><span id="l35.583" class="difflineplus">+</span>
<a href="#l35.584"></a><span id="l35.584" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.585"></a><span id="l35.585" class="difflineplus">+    PRTime p;</span>
<a href="#l35.586"></a><span id="l35.586" class="difflineplus">+    if (NS_FAILED(rv = date-&gt;GetValue(&amp;p)))</span>
<a href="#l35.587"></a><span id="l35.587" class="difflineplus">+        return rv;</span>
<a href="#l35.588"></a><span id="l35.588" class="difflineplus">+</span>
<a href="#l35.589"></a><span id="l35.589" class="difflineplus">+    *result = p == mValue;</span>
<a href="#l35.590"></a><span id="l35.590" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.591"></a><span id="l35.591" class="difflineplus">+}</span>
<a href="#l35.592"></a><span id="l35.592" class="difflineplus">+</span>
<a href="#l35.593"></a><span id="l35.593" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.594"></a><span id="l35.594" class="difflineplus">+// IntImpl</span>
<a href="#l35.595"></a><span id="l35.595" class="difflineplus">+//</span>
<a href="#l35.596"></a><span id="l35.596" class="difflineplus">+</span>
<a href="#l35.597"></a><span id="l35.597" class="difflineplus">+class IntImpl : public nsIRDFInt {</span>
<a href="#l35.598"></a><span id="l35.598" class="difflineplus">+public:</span>
<a href="#l35.599"></a><span id="l35.599" class="difflineplus">+    explicit IntImpl(int32_t s);</span>
<a href="#l35.600"></a><span id="l35.600" class="difflineplus">+</span>
<a href="#l35.601"></a><span id="l35.601" class="difflineplus">+    // nsISupports</span>
<a href="#l35.602"></a><span id="l35.602" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l35.603"></a><span id="l35.603" class="difflineplus">+</span>
<a href="#l35.604"></a><span id="l35.604" class="difflineplus">+    // nsIRDFNode</span>
<a href="#l35.605"></a><span id="l35.605" class="difflineplus">+    NS_DECL_NSIRDFNODE</span>
<a href="#l35.606"></a><span id="l35.606" class="difflineplus">+</span>
<a href="#l35.607"></a><span id="l35.607" class="difflineplus">+    // nsIRDFInt</span>
<a href="#l35.608"></a><span id="l35.608" class="difflineplus">+    NS_IMETHOD GetValue(int32_t *value) override;</span>
<a href="#l35.609"></a><span id="l35.609" class="difflineplus">+</span>
<a href="#l35.610"></a><span id="l35.610" class="difflineplus">+private:</span>
<a href="#l35.611"></a><span id="l35.611" class="difflineplus">+    virtual ~IntImpl();</span>
<a href="#l35.612"></a><span id="l35.612" class="difflineplus">+</span>
<a href="#l35.613"></a><span id="l35.613" class="difflineplus">+    nsresult EqualsInt(nsIRDFInt* value, bool* result);</span>
<a href="#l35.614"></a><span id="l35.614" class="difflineplus">+    int32_t mValue;</span>
<a href="#l35.615"></a><span id="l35.615" class="difflineplus">+};</span>
<a href="#l35.616"></a><span id="l35.616" class="difflineplus">+</span>
<a href="#l35.617"></a><span id="l35.617" class="difflineplus">+</span>
<a href="#l35.618"></a><span id="l35.618" class="difflineplus">+IntImpl::IntImpl(int32_t s)</span>
<a href="#l35.619"></a><span id="l35.619" class="difflineplus">+    : mValue(s)</span>
<a href="#l35.620"></a><span id="l35.620" class="difflineplus">+{</span>
<a href="#l35.621"></a><span id="l35.621" class="difflineplus">+    RDFServiceImpl::gRDFService-&gt;RegisterInt(this);</span>
<a href="#l35.622"></a><span id="l35.622" class="difflineplus">+    NS_ADDREF(RDFServiceImpl::gRDFService);</span>
<a href="#l35.623"></a><span id="l35.623" class="difflineplus">+}</span>
<a href="#l35.624"></a><span id="l35.624" class="difflineplus">+</span>
<a href="#l35.625"></a><span id="l35.625" class="difflineplus">+IntImpl::~IntImpl()</span>
<a href="#l35.626"></a><span id="l35.626" class="difflineplus">+{</span>
<a href="#l35.627"></a><span id="l35.627" class="difflineplus">+    RDFServiceImpl::gRDFService-&gt;UnregisterInt(this);</span>
<a href="#l35.628"></a><span id="l35.628" class="difflineplus">+</span>
<a href="#l35.629"></a><span id="l35.629" class="difflineplus">+    // Use NS_RELEASE2() here, because we want to decrease the</span>
<a href="#l35.630"></a><span id="l35.630" class="difflineplus">+    // refcount, but not null out the gRDFService pointer (which is</span>
<a href="#l35.631"></a><span id="l35.631" class="difflineplus">+    // what a vanilla NS_RELEASE() would do).</span>
<a href="#l35.632"></a><span id="l35.632" class="difflineplus">+    nsrefcnt refcnt;</span>
<a href="#l35.633"></a><span id="l35.633" class="difflineplus">+    NS_RELEASE2(RDFServiceImpl::gRDFService, refcnt);</span>
<a href="#l35.634"></a><span id="l35.634" class="difflineplus">+}</span>
<a href="#l35.635"></a><span id="l35.635" class="difflineplus">+</span>
<a href="#l35.636"></a><span id="l35.636" class="difflineplus">+NS_IMPL_ADDREF(IntImpl)</span>
<a href="#l35.637"></a><span id="l35.637" class="difflineplus">+NS_IMPL_RELEASE(IntImpl)</span>
<a href="#l35.638"></a><span id="l35.638" class="difflineplus">+</span>
<a href="#l35.639"></a><span id="l35.639" class="difflineplus">+nsresult</span>
<a href="#l35.640"></a><span id="l35.640" class="difflineplus">+IntImpl::QueryInterface(REFNSIID iid, void** result)</span>
<a href="#l35.641"></a><span id="l35.641" class="difflineplus">+{</span>
<a href="#l35.642"></a><span id="l35.642" class="difflineplus">+    if (! result)</span>
<a href="#l35.643"></a><span id="l35.643" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.644"></a><span id="l35.644" class="difflineplus">+</span>
<a href="#l35.645"></a><span id="l35.645" class="difflineplus">+    *result = nullptr;</span>
<a href="#l35.646"></a><span id="l35.646" class="difflineplus">+    if (iid.Equals(kIRDFIntIID) ||</span>
<a href="#l35.647"></a><span id="l35.647" class="difflineplus">+        iid.Equals(kIRDFNodeIID) ||</span>
<a href="#l35.648"></a><span id="l35.648" class="difflineplus">+        iid.Equals(kISupportsIID)) {</span>
<a href="#l35.649"></a><span id="l35.649" class="difflineplus">+        *result = static_cast&lt;nsIRDFInt*&gt;(this);</span>
<a href="#l35.650"></a><span id="l35.650" class="difflineplus">+        AddRef();</span>
<a href="#l35.651"></a><span id="l35.651" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.652"></a><span id="l35.652" class="difflineplus">+    }</span>
<a href="#l35.653"></a><span id="l35.653" class="difflineplus">+    return NS_NOINTERFACE;</span>
<a href="#l35.654"></a><span id="l35.654" class="difflineplus">+}</span>
<a href="#l35.655"></a><span id="l35.655" class="difflineplus">+</span>
<a href="#l35.656"></a><span id="l35.656" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.657"></a><span id="l35.657" class="difflineplus">+IntImpl::EqualsNode(nsIRDFNode* node, bool* result)</span>
<a href="#l35.658"></a><span id="l35.658" class="difflineplus">+{</span>
<a href="#l35.659"></a><span id="l35.659" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.660"></a><span id="l35.660" class="difflineplus">+    nsIRDFInt* intValue;</span>
<a href="#l35.661"></a><span id="l35.661" class="difflineplus">+    if (NS_SUCCEEDED(node-&gt;QueryInterface(kIRDFIntIID, (void**) &amp;intValue))) {</span>
<a href="#l35.662"></a><span id="l35.662" class="difflineplus">+        rv = EqualsInt(intValue, result);</span>
<a href="#l35.663"></a><span id="l35.663" class="difflineplus">+        NS_RELEASE(intValue);</span>
<a href="#l35.664"></a><span id="l35.664" class="difflineplus">+    }</span>
<a href="#l35.665"></a><span id="l35.665" class="difflineplus">+    else {</span>
<a href="#l35.666"></a><span id="l35.666" class="difflineplus">+        *result = false;</span>
<a href="#l35.667"></a><span id="l35.667" class="difflineplus">+        rv = NS_OK;</span>
<a href="#l35.668"></a><span id="l35.668" class="difflineplus">+    }</span>
<a href="#l35.669"></a><span id="l35.669" class="difflineplus">+    return rv;</span>
<a href="#l35.670"></a><span id="l35.670" class="difflineplus">+}</span>
<a href="#l35.671"></a><span id="l35.671" class="difflineplus">+</span>
<a href="#l35.672"></a><span id="l35.672" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.673"></a><span id="l35.673" class="difflineplus">+IntImpl::GetValue(int32_t *value)</span>
<a href="#l35.674"></a><span id="l35.674" class="difflineplus">+{</span>
<a href="#l35.675"></a><span id="l35.675" class="difflineplus">+    NS_ASSERTION(value, &quot;null ptr&quot;);</span>
<a href="#l35.676"></a><span id="l35.676" class="difflineplus">+    if (! value)</span>
<a href="#l35.677"></a><span id="l35.677" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.678"></a><span id="l35.678" class="difflineplus">+</span>
<a href="#l35.679"></a><span id="l35.679" class="difflineplus">+    *value = mValue;</span>
<a href="#l35.680"></a><span id="l35.680" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.681"></a><span id="l35.681" class="difflineplus">+}</span>
<a href="#l35.682"></a><span id="l35.682" class="difflineplus">+</span>
<a href="#l35.683"></a><span id="l35.683" class="difflineplus">+</span>
<a href="#l35.684"></a><span id="l35.684" class="difflineplus">+nsresult</span>
<a href="#l35.685"></a><span id="l35.685" class="difflineplus">+IntImpl::EqualsInt(nsIRDFInt* intValue, bool* result)</span>
<a href="#l35.686"></a><span id="l35.686" class="difflineplus">+{</span>
<a href="#l35.687"></a><span id="l35.687" class="difflineplus">+    NS_ASSERTION(intValue &amp;&amp; result, &quot;null ptr&quot;);</span>
<a href="#l35.688"></a><span id="l35.688" class="difflineplus">+    if (!intValue || !result)</span>
<a href="#l35.689"></a><span id="l35.689" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.690"></a><span id="l35.690" class="difflineplus">+</span>
<a href="#l35.691"></a><span id="l35.691" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.692"></a><span id="l35.692" class="difflineplus">+    int32_t p;</span>
<a href="#l35.693"></a><span id="l35.693" class="difflineplus">+    if (NS_FAILED(rv = intValue-&gt;GetValue(&amp;p)))</span>
<a href="#l35.694"></a><span id="l35.694" class="difflineplus">+        return rv;</span>
<a href="#l35.695"></a><span id="l35.695" class="difflineplus">+</span>
<a href="#l35.696"></a><span id="l35.696" class="difflineplus">+    *result = (p == mValue);</span>
<a href="#l35.697"></a><span id="l35.697" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.698"></a><span id="l35.698" class="difflineplus">+}</span>
<a href="#l35.699"></a><span id="l35.699" class="difflineplus">+</span>
<a href="#l35.700"></a><span id="l35.700" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.701"></a><span id="l35.701" class="difflineplus">+// RDFServiceImpl</span>
<a href="#l35.702"></a><span id="l35.702" class="difflineplus">+</span>
<a href="#l35.703"></a><span id="l35.703" class="difflineplus">+RDFServiceImpl*</span>
<a href="#l35.704"></a><span id="l35.704" class="difflineplus">+RDFServiceImpl::gRDFService;</span>
<a href="#l35.705"></a><span id="l35.705" class="difflineplus">+</span>
<a href="#l35.706"></a><span id="l35.706" class="difflineplus">+RDFServiceImpl::RDFServiceImpl()</span>
<a href="#l35.707"></a><span id="l35.707" class="difflineplus">+    : mNamedDataSources(nullptr)</span>
<a href="#l35.708"></a><span id="l35.708" class="difflineplus">+    , mResources(&amp;gResourceTableOps, sizeof(ResourceHashEntry))</span>
<a href="#l35.709"></a><span id="l35.709" class="difflineplus">+    , mLiterals(&amp;gLiteralTableOps, sizeof(LiteralHashEntry))</span>
<a href="#l35.710"></a><span id="l35.710" class="difflineplus">+    , mInts(&amp;gIntTableOps, sizeof(IntHashEntry))</span>
<a href="#l35.711"></a><span id="l35.711" class="difflineplus">+    , mDates(&amp;gDateTableOps, sizeof(DateHashEntry))</span>
<a href="#l35.712"></a><span id="l35.712" class="difflineplus">+    , mBlobs(&amp;gBlobTableOps, sizeof(BlobHashEntry))</span>
<a href="#l35.713"></a><span id="l35.713" class="difflineplus">+{</span>
<a href="#l35.714"></a><span id="l35.714" class="difflineplus">+    gRDFService = this;</span>
<a href="#l35.715"></a><span id="l35.715" class="difflineplus">+}</span>
<a href="#l35.716"></a><span id="l35.716" class="difflineplus">+</span>
<a href="#l35.717"></a><span id="l35.717" class="difflineplus">+nsresult</span>
<a href="#l35.718"></a><span id="l35.718" class="difflineplus">+RDFServiceImpl::Init()</span>
<a href="#l35.719"></a><span id="l35.719" class="difflineplus">+{</span>
<a href="#l35.720"></a><span id="l35.720" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.721"></a><span id="l35.721" class="difflineplus">+</span>
<a href="#l35.722"></a><span id="l35.722" class="difflineplus">+    mNamedDataSources = PL_NewHashTable(23,</span>
<a href="#l35.723"></a><span id="l35.723" class="difflineplus">+                                        PL_HashString,</span>
<a href="#l35.724"></a><span id="l35.724" class="difflineplus">+                                        PL_CompareStrings,</span>
<a href="#l35.725"></a><span id="l35.725" class="difflineplus">+                                        PL_CompareValues,</span>
<a href="#l35.726"></a><span id="l35.726" class="difflineplus">+                                        &amp;dataSourceHashAllocOps, nullptr);</span>
<a href="#l35.727"></a><span id="l35.727" class="difflineplus">+</span>
<a href="#l35.728"></a><span id="l35.728" class="difflineplus">+    if (! mNamedDataSources)</span>
<a href="#l35.729"></a><span id="l35.729" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.730"></a><span id="l35.730" class="difflineplus">+</span>
<a href="#l35.731"></a><span id="l35.731" class="difflineplus">+    mDefaultResourceFactory = do_GetClassObject(kRDFDefaultResourceCID, &amp;rv);</span>
<a href="#l35.732"></a><span id="l35.732" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get default resource factory&quot;);</span>
<a href="#l35.733"></a><span id="l35.733" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.734"></a><span id="l35.734" class="difflineplus">+</span>
<a href="#l35.735"></a><span id="l35.735" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.736"></a><span id="l35.736" class="difflineplus">+}</span>
<a href="#l35.737"></a><span id="l35.737" class="difflineplus">+</span>
<a href="#l35.738"></a><span id="l35.738" class="difflineplus">+</span>
<a href="#l35.739"></a><span id="l35.739" class="difflineplus">+RDFServiceImpl::~RDFServiceImpl()</span>
<a href="#l35.740"></a><span id="l35.740" class="difflineplus">+{</span>
<a href="#l35.741"></a><span id="l35.741" class="difflineplus">+    if (mNamedDataSources) {</span>
<a href="#l35.742"></a><span id="l35.742" class="difflineplus">+        PL_HashTableDestroy(mNamedDataSources);</span>
<a href="#l35.743"></a><span id="l35.743" class="difflineplus">+        mNamedDataSources = nullptr;</span>
<a href="#l35.744"></a><span id="l35.744" class="difflineplus">+    }</span>
<a href="#l35.745"></a><span id="l35.745" class="difflineplus">+    gRDFService = nullptr;</span>
<a href="#l35.746"></a><span id="l35.746" class="difflineplus">+}</span>
<a href="#l35.747"></a><span id="l35.747" class="difflineplus">+</span>
<a href="#l35.748"></a><span id="l35.748" class="difflineplus">+</span>
<a href="#l35.749"></a><span id="l35.749" class="difflineplus">+// static</span>
<a href="#l35.750"></a><span id="l35.750" class="difflineplus">+nsresult</span>
<a href="#l35.751"></a><span id="l35.751" class="difflineplus">+RDFServiceImpl::CreateSingleton(nsISupports* aOuter,</span>
<a href="#l35.752"></a><span id="l35.752" class="difflineplus">+                                const nsIID&amp; aIID, void **aResult)</span>
<a href="#l35.753"></a><span id="l35.753" class="difflineplus">+{</span>
<a href="#l35.754"></a><span id="l35.754" class="difflineplus">+    NS_ENSURE_NO_AGGREGATION(aOuter);</span>
<a href="#l35.755"></a><span id="l35.755" class="difflineplus">+</span>
<a href="#l35.756"></a><span id="l35.756" class="difflineplus">+    if (gRDFService) {</span>
<a href="#l35.757"></a><span id="l35.757" class="difflineplus">+        NS_ERROR(&quot;Trying to create RDF serviec twice.&quot;);</span>
<a href="#l35.758"></a><span id="l35.758" class="difflineplus">+        return gRDFService-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l35.759"></a><span id="l35.759" class="difflineplus">+    }</span>
<a href="#l35.760"></a><span id="l35.760" class="difflineplus">+</span>
<a href="#l35.761"></a><span id="l35.761" class="difflineplus">+    RefPtr&lt;RDFServiceImpl&gt; serv = new RDFServiceImpl();</span>
<a href="#l35.762"></a><span id="l35.762" class="difflineplus">+    nsresult rv = serv-&gt;Init();</span>
<a href="#l35.763"></a><span id="l35.763" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l35.764"></a><span id="l35.764" class="difflineplus">+        return rv;</span>
<a href="#l35.765"></a><span id="l35.765" class="difflineplus">+</span>
<a href="#l35.766"></a><span id="l35.766" class="difflineplus">+    return serv-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l35.767"></a><span id="l35.767" class="difflineplus">+}</span>
<a href="#l35.768"></a><span id="l35.768" class="difflineplus">+</span>
<a href="#l35.769"></a><span id="l35.769" class="difflineplus">+NS_IMPL_ISUPPORTS(RDFServiceImpl, nsIRDFService, nsISupportsWeakReference)</span>
<a href="#l35.770"></a><span id="l35.770" class="difflineplus">+</span>
<a href="#l35.771"></a><span id="l35.771" class="difflineplus">+// Per RFC2396.</span>
<a href="#l35.772"></a><span id="l35.772" class="difflineplus">+static const uint8_t</span>
<a href="#l35.773"></a><span id="l35.773" class="difflineplus">+kLegalSchemeChars[] = {</span>
<a href="#l35.774"></a><span id="l35.774" class="difflineplus">+          //        ASCII    Bits     Ordered  Hex</span>
<a href="#l35.775"></a><span id="l35.775" class="difflineplus">+          //                 01234567 76543210</span>
<a href="#l35.776"></a><span id="l35.776" class="difflineplus">+    0x00, // 00-07</span>
<a href="#l35.777"></a><span id="l35.777" class="difflineplus">+    0x00, // 08-0F</span>
<a href="#l35.778"></a><span id="l35.778" class="difflineplus">+    0x00, // 10-17</span>
<a href="#l35.779"></a><span id="l35.779" class="difflineplus">+    0x00, // 18-1F</span>
<a href="#l35.780"></a><span id="l35.780" class="difflineplus">+    0x00, // 20-27   !&quot;#$%&amp;' 00000000 00000000</span>
<a href="#l35.781"></a><span id="l35.781" class="difflineplus">+    0x28, // 28-2F  ()*+,-./ 00010100 00101000 0x28</span>
<a href="#l35.782"></a><span id="l35.782" class="difflineplus">+    0xff, // 30-37  01234567 11111111 11111111 0xFF</span>
<a href="#l35.783"></a><span id="l35.783" class="difflineplus">+    0x03, // 38-3F  89:;&lt;=&gt;? 11000000 00000011 0x03</span>
<a href="#l35.784"></a><span id="l35.784" class="difflineplus">+    0xfe, // 40-47  @ABCDEFG 01111111 11111110 0xFE</span>
<a href="#l35.785"></a><span id="l35.785" class="difflineplus">+    0xff, // 48-4F  HIJKLMNO 11111111 11111111 0xFF</span>
<a href="#l35.786"></a><span id="l35.786" class="difflineplus">+    0xff, // 50-57  PQRSTUVW 11111111 11111111 0xFF</span>
<a href="#l35.787"></a><span id="l35.787" class="difflineplus">+    0x87, // 58-5F  XYZ[\]^_ 11100001 10000111 0x87</span>
<a href="#l35.788"></a><span id="l35.788" class="difflineplus">+    0xfe, // 60-67  `abcdefg 01111111 11111110 0xFE</span>
<a href="#l35.789"></a><span id="l35.789" class="difflineplus">+    0xff, // 68-6F  hijklmno 11111111 11111111 0xFF</span>
<a href="#l35.790"></a><span id="l35.790" class="difflineplus">+    0xff, // 70-77  pqrstuvw 11111111 11111111 0xFF</span>
<a href="#l35.791"></a><span id="l35.791" class="difflineplus">+    0x07, // 78-7F  xyz{|}~  11100000 00000111 0x07</span>
<a href="#l35.792"></a><span id="l35.792" class="difflineplus">+    0x00, 0x00, 0x00, 0x00, // &gt;= 80</span>
<a href="#l35.793"></a><span id="l35.793" class="difflineplus">+    0x00, 0x00, 0x00, 0x00,</span>
<a href="#l35.794"></a><span id="l35.794" class="difflineplus">+    0x00, 0x00, 0x00, 0x00,</span>
<a href="#l35.795"></a><span id="l35.795" class="difflineplus">+    0x00, 0x00, 0x00, 0x00</span>
<a href="#l35.796"></a><span id="l35.796" class="difflineplus">+};</span>
<a href="#l35.797"></a><span id="l35.797" class="difflineplus">+</span>
<a href="#l35.798"></a><span id="l35.798" class="difflineplus">+static inline bool</span>
<a href="#l35.799"></a><span id="l35.799" class="difflineplus">+IsLegalSchemeCharacter(const char aChar)</span>
<a href="#l35.800"></a><span id="l35.800" class="difflineplus">+{</span>
<a href="#l35.801"></a><span id="l35.801" class="difflineplus">+    uint8_t mask = kLegalSchemeChars[aChar &gt;&gt; 3];</span>
<a href="#l35.802"></a><span id="l35.802" class="difflineplus">+    uint8_t bit = 1u &lt;&lt; (aChar &amp; 0x7);</span>
<a href="#l35.803"></a><span id="l35.803" class="difflineplus">+    return bool((mask &amp; bit) != 0);</span>
<a href="#l35.804"></a><span id="l35.804" class="difflineplus">+}</span>
<a href="#l35.805"></a><span id="l35.805" class="difflineplus">+</span>
<a href="#l35.806"></a><span id="l35.806" class="difflineplus">+</span>
<a href="#l35.807"></a><span id="l35.807" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.808"></a><span id="l35.808" class="difflineplus">+RDFServiceImpl::GetResource(const nsACString&amp; aURI, nsIRDFResource** aResource)</span>
<a href="#l35.809"></a><span id="l35.809" class="difflineplus">+{</span>
<a href="#l35.810"></a><span id="l35.810" class="difflineplus">+    // Sanity checks</span>
<a href="#l35.811"></a><span id="l35.811" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.812"></a><span id="l35.812" class="difflineplus">+    NS_PRECONDITION(!aURI.IsEmpty(), &quot;URI is empty&quot;);</span>
<a href="#l35.813"></a><span id="l35.813" class="difflineplus">+    if (! aResource)</span>
<a href="#l35.814"></a><span id="l35.814" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.815"></a><span id="l35.815" class="difflineplus">+    if (aURI.IsEmpty())</span>
<a href="#l35.816"></a><span id="l35.816" class="difflineplus">+        return NS_ERROR_INVALID_ARG;</span>
<a href="#l35.817"></a><span id="l35.817" class="difflineplus">+</span>
<a href="#l35.818"></a><span id="l35.818" class="difflineplus">+    const nsCString&amp; flatURI = PromiseFlatCString(aURI);</span>
<a href="#l35.819"></a><span id="l35.819" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug, (&quot;rdfserv get-resource %s&quot;, flatURI.get()));</span>
<a href="#l35.820"></a><span id="l35.820" class="difflineplus">+</span>
<a href="#l35.821"></a><span id="l35.821" class="difflineplus">+    // First, check the cache to see if we've already created and</span>
<a href="#l35.822"></a><span id="l35.822" class="difflineplus">+    // registered this thing.</span>
<a href="#l35.823"></a><span id="l35.823" class="difflineplus">+    PLDHashEntryHdr *hdr = mResources.Search(flatURI.get());</span>
<a href="#l35.824"></a><span id="l35.824" class="difflineplus">+    if (hdr) {</span>
<a href="#l35.825"></a><span id="l35.825" class="difflineplus">+        ResourceHashEntry *entry = static_cast&lt;ResourceHashEntry *&gt;(hdr);</span>
<a href="#l35.826"></a><span id="l35.826" class="difflineplus">+        NS_ADDREF(*aResource = entry-&gt;mResource);</span>
<a href="#l35.827"></a><span id="l35.827" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.828"></a><span id="l35.828" class="difflineplus">+    }</span>
<a href="#l35.829"></a><span id="l35.829" class="difflineplus">+</span>
<a href="#l35.830"></a><span id="l35.830" class="difflineplus">+    // Nope. So go to the repository to create it.</span>
<a href="#l35.831"></a><span id="l35.831" class="difflineplus">+</span>
<a href="#l35.832"></a><span id="l35.832" class="difflineplus">+    // Compute the scheme of the URI. Scan forward until we either:</span>
<a href="#l35.833"></a><span id="l35.833" class="difflineplus">+    //</span>
<a href="#l35.834"></a><span id="l35.834" class="difflineplus">+    // 1. Reach the end of the string</span>
<a href="#l35.835"></a><span id="l35.835" class="difflineplus">+    // 2. Encounter a non-alpha character</span>
<a href="#l35.836"></a><span id="l35.836" class="difflineplus">+    // 3. Encouter a colon.</span>
<a href="#l35.837"></a><span id="l35.837" class="difflineplus">+    //</span>
<a href="#l35.838"></a><span id="l35.838" class="difflineplus">+    // If we encounter a colon _before_ encountering a non-alpha</span>
<a href="#l35.839"></a><span id="l35.839" class="difflineplus">+    // character, then assume it's the scheme.</span>
<a href="#l35.840"></a><span id="l35.840" class="difflineplus">+    //</span>
<a href="#l35.841"></a><span id="l35.841" class="difflineplus">+    // XXX Although it's really not correct, we'll allow underscore</span>
<a href="#l35.842"></a><span id="l35.842" class="difflineplus">+    // characters ('_'), too.</span>
<a href="#l35.843"></a><span id="l35.843" class="difflineplus">+    nsACString::const_iterator p, end;</span>
<a href="#l35.844"></a><span id="l35.844" class="difflineplus">+    aURI.BeginReading(p);</span>
<a href="#l35.845"></a><span id="l35.845" class="difflineplus">+    aURI.EndReading(end);</span>
<a href="#l35.846"></a><span id="l35.846" class="difflineplus">+    while (p != end &amp;&amp; IsLegalSchemeCharacter(*p))</span>
<a href="#l35.847"></a><span id="l35.847" class="difflineplus">+        ++p;</span>
<a href="#l35.848"></a><span id="l35.848" class="difflineplus">+</span>
<a href="#l35.849"></a><span id="l35.849" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.850"></a><span id="l35.850" class="difflineplus">+    nsCOMPtr&lt;nsIFactory&gt; factory;</span>
<a href="#l35.851"></a><span id="l35.851" class="difflineplus">+</span>
<a href="#l35.852"></a><span id="l35.852" class="difflineplus">+    nsACString::const_iterator begin;</span>
<a href="#l35.853"></a><span id="l35.853" class="difflineplus">+    aURI.BeginReading(begin);</span>
<a href="#l35.854"></a><span id="l35.854" class="difflineplus">+    if (*p == ':') {</span>
<a href="#l35.855"></a><span id="l35.855" class="difflineplus">+        // There _was_ a scheme. First see if it's the same scheme</span>
<a href="#l35.856"></a><span id="l35.856" class="difflineplus">+        // that we just tried to use...</span>
<a href="#l35.857"></a><span id="l35.857" class="difflineplus">+        if (mLastFactory &amp;&amp; mLastURIPrefix.Equals(Substring(begin, p)))</span>
<a href="#l35.858"></a><span id="l35.858" class="difflineplus">+            factory = mLastFactory;</span>
<a href="#l35.859"></a><span id="l35.859" class="difflineplus">+        else {</span>
<a href="#l35.860"></a><span id="l35.860" class="difflineplus">+            // Try to find a factory using the component manager.</span>
<a href="#l35.861"></a><span id="l35.861" class="difflineplus">+            nsACString::const_iterator begin;</span>
<a href="#l35.862"></a><span id="l35.862" class="difflineplus">+            aURI.BeginReading(begin);</span>
<a href="#l35.863"></a><span id="l35.863" class="difflineplus">+            nsAutoCString contractID;</span>
<a href="#l35.864"></a><span id="l35.864" class="difflineplus">+            contractID = NS_LITERAL_CSTRING(NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX) +</span>
<a href="#l35.865"></a><span id="l35.865" class="difflineplus">+                         Substring(begin, p);</span>
<a href="#l35.866"></a><span id="l35.866" class="difflineplus">+</span>
<a href="#l35.867"></a><span id="l35.867" class="difflineplus">+            factory = do_GetClassObject(contractID.get());</span>
<a href="#l35.868"></a><span id="l35.868" class="difflineplus">+            if (factory) {</span>
<a href="#l35.869"></a><span id="l35.869" class="difflineplus">+                // Store the factory in our one-element cache.</span>
<a href="#l35.870"></a><span id="l35.870" class="difflineplus">+                if (p != begin) {</span>
<a href="#l35.871"></a><span id="l35.871" class="difflineplus">+                    mLastFactory = factory;</span>
<a href="#l35.872"></a><span id="l35.872" class="difflineplus">+                    mLastURIPrefix = Substring(begin, p);</span>
<a href="#l35.873"></a><span id="l35.873" class="difflineplus">+                }</span>
<a href="#l35.874"></a><span id="l35.874" class="difflineplus">+            }</span>
<a href="#l35.875"></a><span id="l35.875" class="difflineplus">+        }</span>
<a href="#l35.876"></a><span id="l35.876" class="difflineplus">+    }</span>
<a href="#l35.877"></a><span id="l35.877" class="difflineplus">+</span>
<a href="#l35.878"></a><span id="l35.878" class="difflineplus">+    if (! factory) {</span>
<a href="#l35.879"></a><span id="l35.879" class="difflineplus">+        // fall through to using the &quot;default&quot; resource factory if either:</span>
<a href="#l35.880"></a><span id="l35.880" class="difflineplus">+        //</span>
<a href="#l35.881"></a><span id="l35.881" class="difflineplus">+        // 1. The URI didn't have a scheme, or</span>
<a href="#l35.882"></a><span id="l35.882" class="difflineplus">+        // 2. There was no resource factory registered for the scheme.</span>
<a href="#l35.883"></a><span id="l35.883" class="difflineplus">+        factory = mDefaultResourceFactory;</span>
<a href="#l35.884"></a><span id="l35.884" class="difflineplus">+</span>
<a href="#l35.885"></a><span id="l35.885" class="difflineplus">+        // Store the factory in our one-element cache.</span>
<a href="#l35.886"></a><span id="l35.886" class="difflineplus">+        if (p != begin) {</span>
<a href="#l35.887"></a><span id="l35.887" class="difflineplus">+            mLastFactory = factory;</span>
<a href="#l35.888"></a><span id="l35.888" class="difflineplus">+            mLastURIPrefix = Substring(begin, p);</span>
<a href="#l35.889"></a><span id="l35.889" class="difflineplus">+        }</span>
<a href="#l35.890"></a><span id="l35.890" class="difflineplus">+    }</span>
<a href="#l35.891"></a><span id="l35.891" class="difflineplus">+</span>
<a href="#l35.892"></a><span id="l35.892" class="difflineplus">+    nsIRDFResource *result;</span>
<a href="#l35.893"></a><span id="l35.893" class="difflineplus">+    rv = factory-&gt;CreateInstance(nullptr, NS_GET_IID(nsIRDFResource), (void**) &amp;result);</span>
<a href="#l35.894"></a><span id="l35.894" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.895"></a><span id="l35.895" class="difflineplus">+</span>
<a href="#l35.896"></a><span id="l35.896" class="difflineplus">+    // Now initialize it with its URI. At this point, the resource</span>
<a href="#l35.897"></a><span id="l35.897" class="difflineplus">+    // implementation should register itself with the RDF service.</span>
<a href="#l35.898"></a><span id="l35.898" class="difflineplus">+    rv = result-&gt;Init(flatURI.get());</span>
<a href="#l35.899"></a><span id="l35.899" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l35.900"></a><span id="l35.900" class="difflineplus">+        NS_ERROR(&quot;unable to initialize resource&quot;);</span>
<a href="#l35.901"></a><span id="l35.901" class="difflineplus">+        NS_RELEASE(result);</span>
<a href="#l35.902"></a><span id="l35.902" class="difflineplus">+        return rv;</span>
<a href="#l35.903"></a><span id="l35.903" class="difflineplus">+    }</span>
<a href="#l35.904"></a><span id="l35.904" class="difflineplus">+</span>
<a href="#l35.905"></a><span id="l35.905" class="difflineplus">+    *aResource = result; // already refcounted from repository</span>
<a href="#l35.906"></a><span id="l35.906" class="difflineplus">+    return rv;</span>
<a href="#l35.907"></a><span id="l35.907" class="difflineplus">+}</span>
<a href="#l35.908"></a><span id="l35.908" class="difflineplus">+</span>
<a href="#l35.909"></a><span id="l35.909" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.910"></a><span id="l35.910" class="difflineplus">+RDFServiceImpl::GetUnicodeResource(const nsAString&amp; aURI, nsIRDFResource** aResource)</span>
<a href="#l35.911"></a><span id="l35.911" class="difflineplus">+{</span>
<a href="#l35.912"></a><span id="l35.912" class="difflineplus">+    return GetResource(NS_ConvertUTF16toUTF8(aURI), aResource);</span>
<a href="#l35.913"></a><span id="l35.913" class="difflineplus">+}</span>
<a href="#l35.914"></a><span id="l35.914" class="difflineplus">+</span>
<a href="#l35.915"></a><span id="l35.915" class="difflineplus">+</span>
<a href="#l35.916"></a><span id="l35.916" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.917"></a><span id="l35.917" class="difflineplus">+RDFServiceImpl::GetAnonymousResource(nsIRDFResource** aResult)</span>
<a href="#l35.918"></a><span id="l35.918" class="difflineplus">+{</span>
<a href="#l35.919"></a><span id="l35.919" class="difflineplus">+static uint32_t gCounter = 0;</span>
<a href="#l35.920"></a><span id="l35.920" class="difflineplus">+static char gChars[] = &quot;0123456789abcdef&quot;</span>
<a href="#l35.921"></a><span id="l35.921" class="difflineplus">+                       &quot;ghijklmnopqrstuv&quot;</span>
<a href="#l35.922"></a><span id="l35.922" class="difflineplus">+                       &quot;wxyzABCDEFGHIJKL&quot;</span>
<a href="#l35.923"></a><span id="l35.923" class="difflineplus">+                       &quot;MNOPQRSTUVWXYZ.+&quot;;</span>
<a href="#l35.924"></a><span id="l35.924" class="difflineplus">+</span>
<a href="#l35.925"></a><span id="l35.925" class="difflineplus">+static int32_t kMask  = 0x003f;</span>
<a href="#l35.926"></a><span id="l35.926" class="difflineplus">+static int32_t kShift = 6;</span>
<a href="#l35.927"></a><span id="l35.927" class="difflineplus">+</span>
<a href="#l35.928"></a><span id="l35.928" class="difflineplus">+    if (! gCounter) {</span>
<a href="#l35.929"></a><span id="l35.929" class="difflineplus">+        // Start it at a semi-unique value, just to minimize the</span>
<a href="#l35.930"></a><span id="l35.930" class="difflineplus">+        // chance that we get into a situation where</span>
<a href="#l35.931"></a><span id="l35.931" class="difflineplus">+        //</span>
<a href="#l35.932"></a><span id="l35.932" class="difflineplus">+        // 1. An anonymous resource gets serialized out in a graph</span>
<a href="#l35.933"></a><span id="l35.933" class="difflineplus">+        // 2. Reboot</span>
<a href="#l35.934"></a><span id="l35.934" class="difflineplus">+        // 3. The same anonymous resource gets requested, and refers</span>
<a href="#l35.935"></a><span id="l35.935" class="difflineplus">+        //    to something completely different.</span>
<a href="#l35.936"></a><span id="l35.936" class="difflineplus">+        // 4. The serialization is read back in.</span>
<a href="#l35.937"></a><span id="l35.937" class="difflineplus">+        gCounter = uint32_t(PR_Now());</span>
<a href="#l35.938"></a><span id="l35.938" class="difflineplus">+    }</span>
<a href="#l35.939"></a><span id="l35.939" class="difflineplus">+</span>
<a href="#l35.940"></a><span id="l35.940" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.941"></a><span id="l35.941" class="difflineplus">+    nsAutoCString s;</span>
<a href="#l35.942"></a><span id="l35.942" class="difflineplus">+</span>
<a href="#l35.943"></a><span id="l35.943" class="difflineplus">+    do {</span>
<a href="#l35.944"></a><span id="l35.944" class="difflineplus">+        // Ugh, this is a really sloppy way to do this; I copied the</span>
<a href="#l35.945"></a><span id="l35.945" class="difflineplus">+        // implementation from the days when it lived outside the RDF</span>
<a href="#l35.946"></a><span id="l35.946" class="difflineplus">+        // service. Now that it's a member we can be more cleverer.</span>
<a href="#l35.947"></a><span id="l35.947" class="difflineplus">+</span>
<a href="#l35.948"></a><span id="l35.948" class="difflineplus">+        s.Truncate();</span>
<a href="#l35.949"></a><span id="l35.949" class="difflineplus">+        s.AppendLiteral(&quot;rdf:#$&quot;);</span>
<a href="#l35.950"></a><span id="l35.950" class="difflineplus">+</span>
<a href="#l35.951"></a><span id="l35.951" class="difflineplus">+        uint32_t id = ++gCounter;</span>
<a href="#l35.952"></a><span id="l35.952" class="difflineplus">+        while (id) {</span>
<a href="#l35.953"></a><span id="l35.953" class="difflineplus">+            char ch = gChars[(id &amp; kMask)];</span>
<a href="#l35.954"></a><span id="l35.954" class="difflineplus">+            s.Append(ch);</span>
<a href="#l35.955"></a><span id="l35.955" class="difflineplus">+            id &gt;&gt;= kShift;</span>
<a href="#l35.956"></a><span id="l35.956" class="difflineplus">+        }</span>
<a href="#l35.957"></a><span id="l35.957" class="difflineplus">+</span>
<a href="#l35.958"></a><span id="l35.958" class="difflineplus">+        nsIRDFResource* resource;</span>
<a href="#l35.959"></a><span id="l35.959" class="difflineplus">+        rv = GetResource(s, &amp;resource);</span>
<a href="#l35.960"></a><span id="l35.960" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.961"></a><span id="l35.961" class="difflineplus">+</span>
<a href="#l35.962"></a><span id="l35.962" class="difflineplus">+        // XXX an ugly but effective way to make sure that this</span>
<a href="#l35.963"></a><span id="l35.963" class="difflineplus">+        // resource is really unique in the world.</span>
<a href="#l35.964"></a><span id="l35.964" class="difflineplus">+        resource-&gt;AddRef();</span>
<a href="#l35.965"></a><span id="l35.965" class="difflineplus">+        nsrefcnt refcnt = resource-&gt;Release();</span>
<a href="#l35.966"></a><span id="l35.966" class="difflineplus">+</span>
<a href="#l35.967"></a><span id="l35.967" class="difflineplus">+        if (refcnt == 1) {</span>
<a href="#l35.968"></a><span id="l35.968" class="difflineplus">+            *aResult = resource;</span>
<a href="#l35.969"></a><span id="l35.969" class="difflineplus">+            break;</span>
<a href="#l35.970"></a><span id="l35.970" class="difflineplus">+        }</span>
<a href="#l35.971"></a><span id="l35.971" class="difflineplus">+</span>
<a href="#l35.972"></a><span id="l35.972" class="difflineplus">+        NS_RELEASE(resource);</span>
<a href="#l35.973"></a><span id="l35.973" class="difflineplus">+    } while (1);</span>
<a href="#l35.974"></a><span id="l35.974" class="difflineplus">+</span>
<a href="#l35.975"></a><span id="l35.975" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.976"></a><span id="l35.976" class="difflineplus">+}</span>
<a href="#l35.977"></a><span id="l35.977" class="difflineplus">+</span>
<a href="#l35.978"></a><span id="l35.978" class="difflineplus">+</span>
<a href="#l35.979"></a><span id="l35.979" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.980"></a><span id="l35.980" class="difflineplus">+RDFServiceImpl::GetLiteral(const char16_t* aValue, nsIRDFLiteral** aLiteral)</span>
<a href="#l35.981"></a><span id="l35.981" class="difflineplus">+{</span>
<a href="#l35.982"></a><span id="l35.982" class="difflineplus">+    NS_PRECONDITION(aValue != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.983"></a><span id="l35.983" class="difflineplus">+    if (! aValue)</span>
<a href="#l35.984"></a><span id="l35.984" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.985"></a><span id="l35.985" class="difflineplus">+</span>
<a href="#l35.986"></a><span id="l35.986" class="difflineplus">+    NS_PRECONDITION(aLiteral != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.987"></a><span id="l35.987" class="difflineplus">+    if (! aLiteral)</span>
<a href="#l35.988"></a><span id="l35.988" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.989"></a><span id="l35.989" class="difflineplus">+</span>
<a href="#l35.990"></a><span id="l35.990" class="difflineplus">+    // See if we have one already cached</span>
<a href="#l35.991"></a><span id="l35.991" class="difflineplus">+    PLDHashEntryHdr *hdr = mLiterals.Search(aValue);</span>
<a href="#l35.992"></a><span id="l35.992" class="difflineplus">+    if (hdr) {</span>
<a href="#l35.993"></a><span id="l35.993" class="difflineplus">+        LiteralHashEntry *entry = static_cast&lt;LiteralHashEntry *&gt;(hdr);</span>
<a href="#l35.994"></a><span id="l35.994" class="difflineplus">+        NS_ADDREF(*aLiteral = entry-&gt;mLiteral);</span>
<a href="#l35.995"></a><span id="l35.995" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.996"></a><span id="l35.996" class="difflineplus">+    }</span>
<a href="#l35.997"></a><span id="l35.997" class="difflineplus">+</span>
<a href="#l35.998"></a><span id="l35.998" class="difflineplus">+    // Nope. Create a new one</span>
<a href="#l35.999"></a><span id="l35.999" class="difflineplus">+    return LiteralImpl::Create(aValue, aLiteral);</span>
<a href="#l35.1000"></a><span id="l35.1000" class="difflineplus">+}</span>
<a href="#l35.1001"></a><span id="l35.1001" class="difflineplus">+</span>
<a href="#l35.1002"></a><span id="l35.1002" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1003"></a><span id="l35.1003" class="difflineplus">+RDFServiceImpl::GetDateLiteral(PRTime aTime, nsIRDFDate** aResult)</span>
<a href="#l35.1004"></a><span id="l35.1004" class="difflineplus">+{</span>
<a href="#l35.1005"></a><span id="l35.1005" class="difflineplus">+    // See if we have one already cached</span>
<a href="#l35.1006"></a><span id="l35.1006" class="difflineplus">+    PLDHashEntryHdr *hdr = mDates.Search(&amp;aTime);</span>
<a href="#l35.1007"></a><span id="l35.1007" class="difflineplus">+    if (hdr) {</span>
<a href="#l35.1008"></a><span id="l35.1008" class="difflineplus">+        DateHashEntry *entry = static_cast&lt;DateHashEntry *&gt;(hdr);</span>
<a href="#l35.1009"></a><span id="l35.1009" class="difflineplus">+        NS_ADDREF(*aResult = entry-&gt;mDate);</span>
<a href="#l35.1010"></a><span id="l35.1010" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.1011"></a><span id="l35.1011" class="difflineplus">+    }</span>
<a href="#l35.1012"></a><span id="l35.1012" class="difflineplus">+</span>
<a href="#l35.1013"></a><span id="l35.1013" class="difflineplus">+    DateImpl* result = new DateImpl(aTime);</span>
<a href="#l35.1014"></a><span id="l35.1014" class="difflineplus">+    if (! result)</span>
<a href="#l35.1015"></a><span id="l35.1015" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1016"></a><span id="l35.1016" class="difflineplus">+</span>
<a href="#l35.1017"></a><span id="l35.1017" class="difflineplus">+    NS_ADDREF(*aResult = result);</span>
<a href="#l35.1018"></a><span id="l35.1018" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1019"></a><span id="l35.1019" class="difflineplus">+}</span>
<a href="#l35.1020"></a><span id="l35.1020" class="difflineplus">+</span>
<a href="#l35.1021"></a><span id="l35.1021" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1022"></a><span id="l35.1022" class="difflineplus">+RDFServiceImpl::GetIntLiteral(int32_t aInt, nsIRDFInt** aResult)</span>
<a href="#l35.1023"></a><span id="l35.1023" class="difflineplus">+{</span>
<a href="#l35.1024"></a><span id="l35.1024" class="difflineplus">+    // See if we have one already cached</span>
<a href="#l35.1025"></a><span id="l35.1025" class="difflineplus">+    PLDHashEntryHdr *hdr = mInts.Search(&amp;aInt);</span>
<a href="#l35.1026"></a><span id="l35.1026" class="difflineplus">+    if (hdr) {</span>
<a href="#l35.1027"></a><span id="l35.1027" class="difflineplus">+        IntHashEntry *entry = static_cast&lt;IntHashEntry *&gt;(hdr);</span>
<a href="#l35.1028"></a><span id="l35.1028" class="difflineplus">+        NS_ADDREF(*aResult = entry-&gt;mInt);</span>
<a href="#l35.1029"></a><span id="l35.1029" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.1030"></a><span id="l35.1030" class="difflineplus">+    }</span>
<a href="#l35.1031"></a><span id="l35.1031" class="difflineplus">+</span>
<a href="#l35.1032"></a><span id="l35.1032" class="difflineplus">+    IntImpl* result = new IntImpl(aInt);</span>
<a href="#l35.1033"></a><span id="l35.1033" class="difflineplus">+    if (! result)</span>
<a href="#l35.1034"></a><span id="l35.1034" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1035"></a><span id="l35.1035" class="difflineplus">+</span>
<a href="#l35.1036"></a><span id="l35.1036" class="difflineplus">+    NS_ADDREF(*aResult = result);</span>
<a href="#l35.1037"></a><span id="l35.1037" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1038"></a><span id="l35.1038" class="difflineplus">+}</span>
<a href="#l35.1039"></a><span id="l35.1039" class="difflineplus">+</span>
<a href="#l35.1040"></a><span id="l35.1040" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1041"></a><span id="l35.1041" class="difflineplus">+RDFServiceImpl::GetBlobLiteral(const uint8_t *aBytes, int32_t aLength,</span>
<a href="#l35.1042"></a><span id="l35.1042" class="difflineplus">+                               nsIRDFBlob **aResult)</span>
<a href="#l35.1043"></a><span id="l35.1043" class="difflineplus">+{</span>
<a href="#l35.1044"></a><span id="l35.1044" class="difflineplus">+    BlobImpl::Data key = { aLength, const_cast&lt;uint8_t *&gt;(aBytes) };</span>
<a href="#l35.1045"></a><span id="l35.1045" class="difflineplus">+</span>
<a href="#l35.1046"></a><span id="l35.1046" class="difflineplus">+    PLDHashEntryHdr *hdr = mBlobs.Search(&amp;key);</span>
<a href="#l35.1047"></a><span id="l35.1047" class="difflineplus">+    if (hdr) {</span>
<a href="#l35.1048"></a><span id="l35.1048" class="difflineplus">+        BlobHashEntry *entry = static_cast&lt;BlobHashEntry *&gt;(hdr);</span>
<a href="#l35.1049"></a><span id="l35.1049" class="difflineplus">+        NS_ADDREF(*aResult = entry-&gt;mBlob);</span>
<a href="#l35.1050"></a><span id="l35.1050" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.1051"></a><span id="l35.1051" class="difflineplus">+    }</span>
<a href="#l35.1052"></a><span id="l35.1052" class="difflineplus">+</span>
<a href="#l35.1053"></a><span id="l35.1053" class="difflineplus">+    BlobImpl *result = new BlobImpl(aBytes, aLength);</span>
<a href="#l35.1054"></a><span id="l35.1054" class="difflineplus">+    if (! result)</span>
<a href="#l35.1055"></a><span id="l35.1055" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1056"></a><span id="l35.1056" class="difflineplus">+</span>
<a href="#l35.1057"></a><span id="l35.1057" class="difflineplus">+    NS_ADDREF(*aResult = result);</span>
<a href="#l35.1058"></a><span id="l35.1058" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1059"></a><span id="l35.1059" class="difflineplus">+}</span>
<a href="#l35.1060"></a><span id="l35.1060" class="difflineplus">+</span>
<a href="#l35.1061"></a><span id="l35.1061" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1062"></a><span id="l35.1062" class="difflineplus">+RDFServiceImpl::IsAnonymousResource(nsIRDFResource* aResource, bool* _result)</span>
<a href="#l35.1063"></a><span id="l35.1063" class="difflineplus">+{</span>
<a href="#l35.1064"></a><span id="l35.1064" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.1065"></a><span id="l35.1065" class="difflineplus">+    if (! aResource)</span>
<a href="#l35.1066"></a><span id="l35.1066" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1067"></a><span id="l35.1067" class="difflineplus">+</span>
<a href="#l35.1068"></a><span id="l35.1068" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.1069"></a><span id="l35.1069" class="difflineplus">+</span>
<a href="#l35.1070"></a><span id="l35.1070" class="difflineplus">+    const char* uri;</span>
<a href="#l35.1071"></a><span id="l35.1071" class="difflineplus">+    rv = aResource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l35.1072"></a><span id="l35.1072" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1073"></a><span id="l35.1073" class="difflineplus">+</span>
<a href="#l35.1074"></a><span id="l35.1074" class="difflineplus">+    if ((uri[0] == 'r') &amp;&amp;</span>
<a href="#l35.1075"></a><span id="l35.1075" class="difflineplus">+        (uri[1] == 'd') &amp;&amp;</span>
<a href="#l35.1076"></a><span id="l35.1076" class="difflineplus">+        (uri[2] == 'f') &amp;&amp;</span>
<a href="#l35.1077"></a><span id="l35.1077" class="difflineplus">+        (uri[3] == ':') &amp;&amp;</span>
<a href="#l35.1078"></a><span id="l35.1078" class="difflineplus">+        (uri[4] == '#') &amp;&amp;</span>
<a href="#l35.1079"></a><span id="l35.1079" class="difflineplus">+        (uri[5] == '$')) {</span>
<a href="#l35.1080"></a><span id="l35.1080" class="difflineplus">+        *_result = true;</span>
<a href="#l35.1081"></a><span id="l35.1081" class="difflineplus">+    }</span>
<a href="#l35.1082"></a><span id="l35.1082" class="difflineplus">+    else {</span>
<a href="#l35.1083"></a><span id="l35.1083" class="difflineplus">+        *_result = false;</span>
<a href="#l35.1084"></a><span id="l35.1084" class="difflineplus">+    }</span>
<a href="#l35.1085"></a><span id="l35.1085" class="difflineplus">+</span>
<a href="#l35.1086"></a><span id="l35.1086" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1087"></a><span id="l35.1087" class="difflineplus">+}</span>
<a href="#l35.1088"></a><span id="l35.1088" class="difflineplus">+</span>
<a href="#l35.1089"></a><span id="l35.1089" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1090"></a><span id="l35.1090" class="difflineplus">+RDFServiceImpl::RegisterResource(nsIRDFResource* aResource, bool aReplace)</span>
<a href="#l35.1091"></a><span id="l35.1091" class="difflineplus">+{</span>
<a href="#l35.1092"></a><span id="l35.1092" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.1093"></a><span id="l35.1093" class="difflineplus">+    if (! aResource)</span>
<a href="#l35.1094"></a><span id="l35.1094" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1095"></a><span id="l35.1095" class="difflineplus">+</span>
<a href="#l35.1096"></a><span id="l35.1096" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.1097"></a><span id="l35.1097" class="difflineplus">+</span>
<a href="#l35.1098"></a><span id="l35.1098" class="difflineplus">+    const char* uri;</span>
<a href="#l35.1099"></a><span id="l35.1099" class="difflineplus">+    rv = aResource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l35.1100"></a><span id="l35.1100" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get URI from resource&quot;);</span>
<a href="#l35.1101"></a><span id="l35.1101" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1102"></a><span id="l35.1102" class="difflineplus">+</span>
<a href="#l35.1103"></a><span id="l35.1103" class="difflineplus">+    NS_ASSERTION(uri != nullptr, &quot;resource has no URI&quot;);</span>
<a href="#l35.1104"></a><span id="l35.1104" class="difflineplus">+    if (! uri)</span>
<a href="#l35.1105"></a><span id="l35.1105" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1106"></a><span id="l35.1106" class="difflineplus">+</span>
<a href="#l35.1107"></a><span id="l35.1107" class="difflineplus">+    PLDHashEntryHdr *hdr = mResources.Search(uri);</span>
<a href="#l35.1108"></a><span id="l35.1108" class="difflineplus">+    if (hdr) {</span>
<a href="#l35.1109"></a><span id="l35.1109" class="difflineplus">+        if (!aReplace) {</span>
<a href="#l35.1110"></a><span id="l35.1110" class="difflineplus">+            NS_WARNING(&quot;resource already registered, and replace not specified&quot;);</span>
<a href="#l35.1111"></a><span id="l35.1111" class="difflineplus">+            return NS_ERROR_FAILURE;    // already registered</span>
<a href="#l35.1112"></a><span id="l35.1112" class="difflineplus">+        }</span>
<a href="#l35.1113"></a><span id="l35.1113" class="difflineplus">+</span>
<a href="#l35.1114"></a><span id="l35.1114" class="difflineplus">+        // N.B., we do _not_ release the original resource because we</span>
<a href="#l35.1115"></a><span id="l35.1115" class="difflineplus">+        // only ever held a weak reference to it. We simply replace</span>
<a href="#l35.1116"></a><span id="l35.1116" class="difflineplus">+        // it.</span>
<a href="#l35.1117"></a><span id="l35.1117" class="difflineplus">+</span>
<a href="#l35.1118"></a><span id="l35.1118" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1119"></a><span id="l35.1119" class="difflineplus">+               (&quot;rdfserv   replace-resource [%p] &lt;-- [%p] %s&quot;,</span>
<a href="#l35.1120"></a><span id="l35.1120" class="difflineplus">+                static_cast&lt;ResourceHashEntry *&gt;(hdr)-&gt;mResource,</span>
<a href="#l35.1121"></a><span id="l35.1121" class="difflineplus">+                aResource, (const char*) uri));</span>
<a href="#l35.1122"></a><span id="l35.1122" class="difflineplus">+    }</span>
<a href="#l35.1123"></a><span id="l35.1123" class="difflineplus">+    else {</span>
<a href="#l35.1124"></a><span id="l35.1124" class="difflineplus">+        hdr = mResources.Add(uri, fallible);</span>
<a href="#l35.1125"></a><span id="l35.1125" class="difflineplus">+        if (! hdr)</span>
<a href="#l35.1126"></a><span id="l35.1126" class="difflineplus">+            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1127"></a><span id="l35.1127" class="difflineplus">+</span>
<a href="#l35.1128"></a><span id="l35.1128" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1129"></a><span id="l35.1129" class="difflineplus">+               (&quot;rdfserv   register-resource [%p] %s&quot;,</span>
<a href="#l35.1130"></a><span id="l35.1130" class="difflineplus">+                aResource, (const char*) uri));</span>
<a href="#l35.1131"></a><span id="l35.1131" class="difflineplus">+    }</span>
<a href="#l35.1132"></a><span id="l35.1132" class="difflineplus">+</span>
<a href="#l35.1133"></a><span id="l35.1133" class="difflineplus">+    // N.B., we only hold a weak reference to the resource: that way,</span>
<a href="#l35.1134"></a><span id="l35.1134" class="difflineplus">+    // the resource can be destroyed when the last refcount goes</span>
<a href="#l35.1135"></a><span id="l35.1135" class="difflineplus">+    // away. The single addref that the CreateResource() call made</span>
<a href="#l35.1136"></a><span id="l35.1136" class="difflineplus">+    // will be owned by the callee.</span>
<a href="#l35.1137"></a><span id="l35.1137" class="difflineplus">+    ResourceHashEntry *entry = static_cast&lt;ResourceHashEntry *&gt;(hdr);</span>
<a href="#l35.1138"></a><span id="l35.1138" class="difflineplus">+    entry-&gt;mResource = aResource;</span>
<a href="#l35.1139"></a><span id="l35.1139" class="difflineplus">+    entry-&gt;mKey = uri;</span>
<a href="#l35.1140"></a><span id="l35.1140" class="difflineplus">+</span>
<a href="#l35.1141"></a><span id="l35.1141" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1142"></a><span id="l35.1142" class="difflineplus">+}</span>
<a href="#l35.1143"></a><span id="l35.1143" class="difflineplus">+</span>
<a href="#l35.1144"></a><span id="l35.1144" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1145"></a><span id="l35.1145" class="difflineplus">+RDFServiceImpl::UnregisterResource(nsIRDFResource* aResource)</span>
<a href="#l35.1146"></a><span id="l35.1146" class="difflineplus">+{</span>
<a href="#l35.1147"></a><span id="l35.1147" class="difflineplus">+    NS_PRECONDITION(aResource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.1148"></a><span id="l35.1148" class="difflineplus">+    if (! aResource)</span>
<a href="#l35.1149"></a><span id="l35.1149" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1150"></a><span id="l35.1150" class="difflineplus">+</span>
<a href="#l35.1151"></a><span id="l35.1151" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.1152"></a><span id="l35.1152" class="difflineplus">+</span>
<a href="#l35.1153"></a><span id="l35.1153" class="difflineplus">+    const char* uri;</span>
<a href="#l35.1154"></a><span id="l35.1154" class="difflineplus">+    rv = aResource-&gt;GetValueConst(&amp;uri);</span>
<a href="#l35.1155"></a><span id="l35.1155" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1156"></a><span id="l35.1156" class="difflineplus">+</span>
<a href="#l35.1157"></a><span id="l35.1157" class="difflineplus">+    NS_ASSERTION(uri != nullptr, &quot;resource has no URI&quot;);</span>
<a href="#l35.1158"></a><span id="l35.1158" class="difflineplus">+    if (! uri)</span>
<a href="#l35.1159"></a><span id="l35.1159" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.1160"></a><span id="l35.1160" class="difflineplus">+</span>
<a href="#l35.1161"></a><span id="l35.1161" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1162"></a><span id="l35.1162" class="difflineplus">+           (&quot;rdfserv unregister-resource [%p] %s&quot;,</span>
<a href="#l35.1163"></a><span id="l35.1163" class="difflineplus">+            aResource, (const char*) uri));</span>
<a href="#l35.1164"></a><span id="l35.1164" class="difflineplus">+</span>
<a href="#l35.1165"></a><span id="l35.1165" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l35.1166"></a><span id="l35.1166" class="difflineplus">+    if (!mResources.Search(uri))</span>
<a href="#l35.1167"></a><span id="l35.1167" class="difflineplus">+        NS_WARNING(&quot;resource was never registered&quot;);</span>
<a href="#l35.1168"></a><span id="l35.1168" class="difflineplus">+#endif</span>
<a href="#l35.1169"></a><span id="l35.1169" class="difflineplus">+</span>
<a href="#l35.1170"></a><span id="l35.1170" class="difflineplus">+    mResources.Remove(uri);</span>
<a href="#l35.1171"></a><span id="l35.1171" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1172"></a><span id="l35.1172" class="difflineplus">+}</span>
<a href="#l35.1173"></a><span id="l35.1173" class="difflineplus">+</span>
<a href="#l35.1174"></a><span id="l35.1174" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1175"></a><span id="l35.1175" class="difflineplus">+RDFServiceImpl::RegisterDataSource(nsIRDFDataSource* aDataSource, bool aReplace)</span>
<a href="#l35.1176"></a><span id="l35.1176" class="difflineplus">+{</span>
<a href="#l35.1177"></a><span id="l35.1177" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.1178"></a><span id="l35.1178" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l35.1179"></a><span id="l35.1179" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1180"></a><span id="l35.1180" class="difflineplus">+</span>
<a href="#l35.1181"></a><span id="l35.1181" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.1182"></a><span id="l35.1182" class="difflineplus">+</span>
<a href="#l35.1183"></a><span id="l35.1183" class="difflineplus">+    nsAutoCString uri;</span>
<a href="#l35.1184"></a><span id="l35.1184" class="difflineplus">+    rv = aDataSource-&gt;GetURI(uri);</span>
<a href="#l35.1185"></a><span id="l35.1185" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1186"></a><span id="l35.1186" class="difflineplus">+</span>
<a href="#l35.1187"></a><span id="l35.1187" class="difflineplus">+    PLHashEntry** hep =</span>
<a href="#l35.1188"></a><span id="l35.1188" class="difflineplus">+      PL_HashTableRawLookup(mNamedDataSources,</span>
<a href="#l35.1189"></a><span id="l35.1189" class="difflineplus">+                            (*mNamedDataSources-&gt;keyHash)(uri.get()),</span>
<a href="#l35.1190"></a><span id="l35.1190" class="difflineplus">+                            uri.get());</span>
<a href="#l35.1191"></a><span id="l35.1191" class="difflineplus">+</span>
<a href="#l35.1192"></a><span id="l35.1192" class="difflineplus">+    if (*hep) {</span>
<a href="#l35.1193"></a><span id="l35.1193" class="difflineplus">+        if (! aReplace)</span>
<a href="#l35.1194"></a><span id="l35.1194" class="difflineplus">+            return NS_ERROR_FAILURE; // already registered</span>
<a href="#l35.1195"></a><span id="l35.1195" class="difflineplus">+</span>
<a href="#l35.1196"></a><span id="l35.1196" class="difflineplus">+        // N.B., we only hold a weak reference to the datasource, so</span>
<a href="#l35.1197"></a><span id="l35.1197" class="difflineplus">+        // just replace the old with the new and don't touch any</span>
<a href="#l35.1198"></a><span id="l35.1198" class="difflineplus">+        // refcounts.</span>
<a href="#l35.1199"></a><span id="l35.1199" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1200"></a><span id="l35.1200" class="difflineplus">+               (&quot;rdfserv    replace-datasource [%p] &lt;-- [%p] %s&quot;,</span>
<a href="#l35.1201"></a><span id="l35.1201" class="difflineplus">+                (*hep)-&gt;value, aDataSource, uri.get()));</span>
<a href="#l35.1202"></a><span id="l35.1202" class="difflineplus">+</span>
<a href="#l35.1203"></a><span id="l35.1203" class="difflineplus">+        (*hep)-&gt;value = aDataSource;</span>
<a href="#l35.1204"></a><span id="l35.1204" class="difflineplus">+    }</span>
<a href="#l35.1205"></a><span id="l35.1205" class="difflineplus">+    else {</span>
<a href="#l35.1206"></a><span id="l35.1206" class="difflineplus">+        const char* key = PL_strdup(uri.get());</span>
<a href="#l35.1207"></a><span id="l35.1207" class="difflineplus">+        if (! key)</span>
<a href="#l35.1208"></a><span id="l35.1208" class="difflineplus">+            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1209"></a><span id="l35.1209" class="difflineplus">+</span>
<a href="#l35.1210"></a><span id="l35.1210" class="difflineplus">+        PL_HashTableAdd(mNamedDataSources, key, aDataSource);</span>
<a href="#l35.1211"></a><span id="l35.1211" class="difflineplus">+</span>
<a href="#l35.1212"></a><span id="l35.1212" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1213"></a><span id="l35.1213" class="difflineplus">+               (&quot;rdfserv   register-datasource [%p] %s&quot;,</span>
<a href="#l35.1214"></a><span id="l35.1214" class="difflineplus">+                aDataSource, uri.get()));</span>
<a href="#l35.1215"></a><span id="l35.1215" class="difflineplus">+</span>
<a href="#l35.1216"></a><span id="l35.1216" class="difflineplus">+        // N.B., we only hold a weak reference to the datasource, so don't</span>
<a href="#l35.1217"></a><span id="l35.1217" class="difflineplus">+        // addref.</span>
<a href="#l35.1218"></a><span id="l35.1218" class="difflineplus">+    }</span>
<a href="#l35.1219"></a><span id="l35.1219" class="difflineplus">+</span>
<a href="#l35.1220"></a><span id="l35.1220" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1221"></a><span id="l35.1221" class="difflineplus">+}</span>
<a href="#l35.1222"></a><span id="l35.1222" class="difflineplus">+</span>
<a href="#l35.1223"></a><span id="l35.1223" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1224"></a><span id="l35.1224" class="difflineplus">+RDFServiceImpl::UnregisterDataSource(nsIRDFDataSource* aDataSource)</span>
<a href="#l35.1225"></a><span id="l35.1225" class="difflineplus">+{</span>
<a href="#l35.1226"></a><span id="l35.1226" class="difflineplus">+    NS_PRECONDITION(aDataSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.1227"></a><span id="l35.1227" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l35.1228"></a><span id="l35.1228" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1229"></a><span id="l35.1229" class="difflineplus">+</span>
<a href="#l35.1230"></a><span id="l35.1230" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.1231"></a><span id="l35.1231" class="difflineplus">+</span>
<a href="#l35.1232"></a><span id="l35.1232" class="difflineplus">+    nsAutoCString uri;</span>
<a href="#l35.1233"></a><span id="l35.1233" class="difflineplus">+    rv = aDataSource-&gt;GetURI(uri);</span>
<a href="#l35.1234"></a><span id="l35.1234" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1235"></a><span id="l35.1235" class="difflineplus">+</span>
<a href="#l35.1236"></a><span id="l35.1236" class="difflineplus">+    //NS_ASSERTION(uri != nullptr, &quot;datasource has no URI&quot;);</span>
<a href="#l35.1237"></a><span id="l35.1237" class="difflineplus">+    if (uri.IsVoid())</span>
<a href="#l35.1238"></a><span id="l35.1238" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.1239"></a><span id="l35.1239" class="difflineplus">+</span>
<a href="#l35.1240"></a><span id="l35.1240" class="difflineplus">+    PLHashEntry** hep =</span>
<a href="#l35.1241"></a><span id="l35.1241" class="difflineplus">+        PL_HashTableRawLookup(mNamedDataSources,</span>
<a href="#l35.1242"></a><span id="l35.1242" class="difflineplus">+                              (*mNamedDataSources-&gt;keyHash)(uri.get()),</span>
<a href="#l35.1243"></a><span id="l35.1243" class="difflineplus">+                              uri.get());</span>
<a href="#l35.1244"></a><span id="l35.1244" class="difflineplus">+</span>
<a href="#l35.1245"></a><span id="l35.1245" class="difflineplus">+    // It may well be that this datasource was never registered. If</span>
<a href="#l35.1246"></a><span id="l35.1246" class="difflineplus">+    // so, don't unregister it.</span>
<a href="#l35.1247"></a><span id="l35.1247" class="difflineplus">+    if (! *hep || ((*hep)-&gt;value != aDataSource))</span>
<a href="#l35.1248"></a><span id="l35.1248" class="difflineplus">+        return NS_OK;</span>
<a href="#l35.1249"></a><span id="l35.1249" class="difflineplus">+</span>
<a href="#l35.1250"></a><span id="l35.1250" class="difflineplus">+    // N.B., we only held a weak reference to the datasource, so we</span>
<a href="#l35.1251"></a><span id="l35.1251" class="difflineplus">+    // don't release here.</span>
<a href="#l35.1252"></a><span id="l35.1252" class="difflineplus">+    PL_HashTableRawRemove(mNamedDataSources, hep, *hep);</span>
<a href="#l35.1253"></a><span id="l35.1253" class="difflineplus">+</span>
<a href="#l35.1254"></a><span id="l35.1254" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1255"></a><span id="l35.1255" class="difflineplus">+           (&quot;rdfserv unregister-datasource [%p] %s&quot;,</span>
<a href="#l35.1256"></a><span id="l35.1256" class="difflineplus">+            aDataSource, uri.get()));</span>
<a href="#l35.1257"></a><span id="l35.1257" class="difflineplus">+</span>
<a href="#l35.1258"></a><span id="l35.1258" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1259"></a><span id="l35.1259" class="difflineplus">+}</span>
<a href="#l35.1260"></a><span id="l35.1260" class="difflineplus">+</span>
<a href="#l35.1261"></a><span id="l35.1261" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1262"></a><span id="l35.1262" class="difflineplus">+RDFServiceImpl::GetDataSource(const char* aURI, nsIRDFDataSource** aDataSource)</span>
<a href="#l35.1263"></a><span id="l35.1263" class="difflineplus">+{</span>
<a href="#l35.1264"></a><span id="l35.1264" class="difflineplus">+    // Use the other GetDataSource and ask for a non-blocking Refresh.</span>
<a href="#l35.1265"></a><span id="l35.1265" class="difflineplus">+    // If you wanted it loaded synchronously, then you should've tried to do it</span>
<a href="#l35.1266"></a><span id="l35.1266" class="difflineplus">+    // yourself, or used GetDataSourceBlocking.</span>
<a href="#l35.1267"></a><span id="l35.1267" class="difflineplus">+    return GetDataSource( aURI, false, aDataSource );</span>
<a href="#l35.1268"></a><span id="l35.1268" class="difflineplus">+}</span>
<a href="#l35.1269"></a><span id="l35.1269" class="difflineplus">+</span>
<a href="#l35.1270"></a><span id="l35.1270" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.1271"></a><span id="l35.1271" class="difflineplus">+RDFServiceImpl::GetDataSourceBlocking(const char* aURI, nsIRDFDataSource** aDataSource)</span>
<a href="#l35.1272"></a><span id="l35.1272" class="difflineplus">+{</span>
<a href="#l35.1273"></a><span id="l35.1273" class="difflineplus">+    // Use GetDataSource and ask for a blocking Refresh.</span>
<a href="#l35.1274"></a><span id="l35.1274" class="difflineplus">+    return GetDataSource( aURI, true, aDataSource );</span>
<a href="#l35.1275"></a><span id="l35.1275" class="difflineplus">+}</span>
<a href="#l35.1276"></a><span id="l35.1276" class="difflineplus">+</span>
<a href="#l35.1277"></a><span id="l35.1277" class="difflineplus">+nsresult</span>
<a href="#l35.1278"></a><span id="l35.1278" class="difflineplus">+RDFServiceImpl::GetDataSource(const char* aURI, bool aBlock, nsIRDFDataSource** aDataSource)</span>
<a href="#l35.1279"></a><span id="l35.1279" class="difflineplus">+{</span>
<a href="#l35.1280"></a><span id="l35.1280" class="difflineplus">+    NS_PRECONDITION(aURI != nullptr, &quot;null ptr&quot;);</span>
<a href="#l35.1281"></a><span id="l35.1281" class="difflineplus">+    if (! aURI)</span>
<a href="#l35.1282"></a><span id="l35.1282" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.1283"></a><span id="l35.1283" class="difflineplus">+</span>
<a href="#l35.1284"></a><span id="l35.1284" class="difflineplus">+    nsresult rv;</span>
<a href="#l35.1285"></a><span id="l35.1285" class="difflineplus">+</span>
<a href="#l35.1286"></a><span id="l35.1286" class="difflineplus">+    // Attempt to canonify the URI before we look for it in the</span>
<a href="#l35.1287"></a><span id="l35.1287" class="difflineplus">+    // cache. We won't bother doing this on `rdf:' URIs to avoid</span>
<a href="#l35.1288"></a><span id="l35.1288" class="difflineplus">+    // useless (and expensive) protocol handler lookups.</span>
<a href="#l35.1289"></a><span id="l35.1289" class="difflineplus">+    nsAutoCString spec(aURI);</span>
<a href="#l35.1290"></a><span id="l35.1290" class="difflineplus">+</span>
<a href="#l35.1291"></a><span id="l35.1291" class="difflineplus">+    if (!StringBeginsWith(spec, NS_LITERAL_CSTRING(&quot;rdf:&quot;))) {</span>
<a href="#l35.1292"></a><span id="l35.1292" class="difflineplus">+        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l35.1293"></a><span id="l35.1293" class="difflineplus">+        NS_NewURI(getter_AddRefs(uri), spec);</span>
<a href="#l35.1294"></a><span id="l35.1294" class="difflineplus">+        if (uri) {</span>
<a href="#l35.1295"></a><span id="l35.1295" class="difflineplus">+            rv = uri-&gt;GetSpec(spec);</span>
<a href="#l35.1296"></a><span id="l35.1296" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1297"></a><span id="l35.1297" class="difflineplus">+        }</span>
<a href="#l35.1298"></a><span id="l35.1298" class="difflineplus">+    }</span>
<a href="#l35.1299"></a><span id="l35.1299" class="difflineplus">+</span>
<a href="#l35.1300"></a><span id="l35.1300" class="difflineplus">+    // First, check the cache to see if we already have this</span>
<a href="#l35.1301"></a><span id="l35.1301" class="difflineplus">+    // datasource loaded and initialized.</span>
<a href="#l35.1302"></a><span id="l35.1302" class="difflineplus">+    {</span>
<a href="#l35.1303"></a><span id="l35.1303" class="difflineplus">+        nsIRDFDataSource* cached =</span>
<a href="#l35.1304"></a><span id="l35.1304" class="difflineplus">+            static_cast&lt;nsIRDFDataSource*&gt;(PL_HashTableLookup(mNamedDataSources, spec.get()));</span>
<a href="#l35.1305"></a><span id="l35.1305" class="difflineplus">+</span>
<a href="#l35.1306"></a><span id="l35.1306" class="difflineplus">+        if (cached) {</span>
<a href="#l35.1307"></a><span id="l35.1307" class="difflineplus">+            NS_ADDREF(cached);</span>
<a href="#l35.1308"></a><span id="l35.1308" class="difflineplus">+            *aDataSource = cached;</span>
<a href="#l35.1309"></a><span id="l35.1309" class="difflineplus">+            return NS_OK;</span>
<a href="#l35.1310"></a><span id="l35.1310" class="difflineplus">+        }</span>
<a href="#l35.1311"></a><span id="l35.1311" class="difflineplus">+    }</span>
<a href="#l35.1312"></a><span id="l35.1312" class="difflineplus">+</span>
<a href="#l35.1313"></a><span id="l35.1313" class="difflineplus">+    // Nope. So go to the repository to try to create it.</span>
<a href="#l35.1314"></a><span id="l35.1314" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDataSource&gt; ds;</span>
<a href="#l35.1315"></a><span id="l35.1315" class="difflineplus">+    if (StringBeginsWith(spec, NS_LITERAL_CSTRING(&quot;rdf:&quot;))) {</span>
<a href="#l35.1316"></a><span id="l35.1316" class="difflineplus">+        // It's a built-in data source. Convert it to a contract ID.</span>
<a href="#l35.1317"></a><span id="l35.1317" class="difflineplus">+        nsAutoCString contractID(</span>
<a href="#l35.1318"></a><span id="l35.1318" class="difflineplus">+                NS_LITERAL_CSTRING(NS_RDF_DATASOURCE_CONTRACTID_PREFIX) +</span>
<a href="#l35.1319"></a><span id="l35.1319" class="difflineplus">+                Substring(spec, 4, spec.Length() - 4));</span>
<a href="#l35.1320"></a><span id="l35.1320" class="difflineplus">+</span>
<a href="#l35.1321"></a><span id="l35.1321" class="difflineplus">+        // Strip params to get ``base'' contractID for data source.</span>
<a href="#l35.1322"></a><span id="l35.1322" class="difflineplus">+        int32_t p = contractID.FindChar(char16_t('&amp;'));</span>
<a href="#l35.1323"></a><span id="l35.1323" class="difflineplus">+        if (p &gt;= 0)</span>
<a href="#l35.1324"></a><span id="l35.1324" class="difflineplus">+            contractID.Truncate(p);</span>
<a href="#l35.1325"></a><span id="l35.1325" class="difflineplus">+</span>
<a href="#l35.1326"></a><span id="l35.1326" class="difflineplus">+        ds = do_GetService(contractID.get(), &amp;rv);</span>
<a href="#l35.1327"></a><span id="l35.1327" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1328"></a><span id="l35.1328" class="difflineplus">+</span>
<a href="#l35.1329"></a><span id="l35.1329" class="difflineplus">+        nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(ds);</span>
<a href="#l35.1330"></a><span id="l35.1330" class="difflineplus">+        if (remote) {</span>
<a href="#l35.1331"></a><span id="l35.1331" class="difflineplus">+            rv = remote-&gt;Init(spec.get());</span>
<a href="#l35.1332"></a><span id="l35.1332" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1333"></a><span id="l35.1333" class="difflineplus">+        }</span>
<a href="#l35.1334"></a><span id="l35.1334" class="difflineplus">+    }</span>
<a href="#l35.1335"></a><span id="l35.1335" class="difflineplus">+    else {</span>
<a href="#l35.1336"></a><span id="l35.1336" class="difflineplus">+        // Try to load this as an RDF/XML data source</span>
<a href="#l35.1337"></a><span id="l35.1337" class="difflineplus">+        ds = do_CreateInstance(kRDFXMLDataSourceCID, &amp;rv);</span>
<a href="#l35.1338"></a><span id="l35.1338" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1339"></a><span id="l35.1339" class="difflineplus">+</span>
<a href="#l35.1340"></a><span id="l35.1340" class="difflineplus">+        nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote(do_QueryInterface(ds));</span>
<a href="#l35.1341"></a><span id="l35.1341" class="difflineplus">+        NS_ASSERTION(remote, &quot;not a remote RDF/XML data source!&quot;);</span>
<a href="#l35.1342"></a><span id="l35.1342" class="difflineplus">+        if (! remote) return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.1343"></a><span id="l35.1343" class="difflineplus">+</span>
<a href="#l35.1344"></a><span id="l35.1344" class="difflineplus">+        rv = remote-&gt;Init(spec.get());</span>
<a href="#l35.1345"></a><span id="l35.1345" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1346"></a><span id="l35.1346" class="difflineplus">+</span>
<a href="#l35.1347"></a><span id="l35.1347" class="difflineplus">+        rv = remote-&gt;Refresh(aBlock);</span>
<a href="#l35.1348"></a><span id="l35.1348" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l35.1349"></a><span id="l35.1349" class="difflineplus">+    }</span>
<a href="#l35.1350"></a><span id="l35.1350" class="difflineplus">+</span>
<a href="#l35.1351"></a><span id="l35.1351" class="difflineplus">+    *aDataSource = ds;</span>
<a href="#l35.1352"></a><span id="l35.1352" class="difflineplus">+    NS_ADDREF(*aDataSource);</span>
<a href="#l35.1353"></a><span id="l35.1353" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1354"></a><span id="l35.1354" class="difflineplus">+}</span>
<a href="#l35.1355"></a><span id="l35.1355" class="difflineplus">+</span>
<a href="#l35.1356"></a><span id="l35.1356" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.1357"></a><span id="l35.1357" class="difflineplus">+</span>
<a href="#l35.1358"></a><span id="l35.1358" class="difflineplus">+nsresult</span>
<a href="#l35.1359"></a><span id="l35.1359" class="difflineplus">+RDFServiceImpl::RegisterLiteral(nsIRDFLiteral* aLiteral)</span>
<a href="#l35.1360"></a><span id="l35.1360" class="difflineplus">+{</span>
<a href="#l35.1361"></a><span id="l35.1361" class="difflineplus">+    const char16_t* value;</span>
<a href="#l35.1362"></a><span id="l35.1362" class="difflineplus">+    aLiteral-&gt;GetValueConst(&amp;value);</span>
<a href="#l35.1363"></a><span id="l35.1363" class="difflineplus">+</span>
<a href="#l35.1364"></a><span id="l35.1364" class="difflineplus">+    NS_ASSERTION(!mLiterals.Search(value), &quot;literal already registered&quot;);</span>
<a href="#l35.1365"></a><span id="l35.1365" class="difflineplus">+</span>
<a href="#l35.1366"></a><span id="l35.1366" class="difflineplus">+    PLDHashEntryHdr *hdr = mLiterals.Add(value, fallible);</span>
<a href="#l35.1367"></a><span id="l35.1367" class="difflineplus">+    if (! hdr)</span>
<a href="#l35.1368"></a><span id="l35.1368" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1369"></a><span id="l35.1369" class="difflineplus">+</span>
<a href="#l35.1370"></a><span id="l35.1370" class="difflineplus">+    LiteralHashEntry *entry = static_cast&lt;LiteralHashEntry *&gt;(hdr);</span>
<a href="#l35.1371"></a><span id="l35.1371" class="difflineplus">+</span>
<a href="#l35.1372"></a><span id="l35.1372" class="difflineplus">+    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l35.1373"></a><span id="l35.1373" class="difflineplus">+    // way, the literal can be destroyed when the last refcount</span>
<a href="#l35.1374"></a><span id="l35.1374" class="difflineplus">+    // goes away. The single addref that the CreateLiteral() call</span>
<a href="#l35.1375"></a><span id="l35.1375" class="difflineplus">+    // made will be owned by the callee.</span>
<a href="#l35.1376"></a><span id="l35.1376" class="difflineplus">+    entry-&gt;mLiteral = aLiteral;</span>
<a href="#l35.1377"></a><span id="l35.1377" class="difflineplus">+    entry-&gt;mKey = value;</span>
<a href="#l35.1378"></a><span id="l35.1378" class="difflineplus">+</span>
<a href="#l35.1379"></a><span id="l35.1379" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1380"></a><span id="l35.1380" class="difflineplus">+           (&quot;rdfserv   register-literal [%p] %s&quot;,</span>
<a href="#l35.1381"></a><span id="l35.1381" class="difflineplus">+            aLiteral, NS_ConvertUTF16toUTF8(value).get()));</span>
<a href="#l35.1382"></a><span id="l35.1382" class="difflineplus">+</span>
<a href="#l35.1383"></a><span id="l35.1383" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1384"></a><span id="l35.1384" class="difflineplus">+}</span>
<a href="#l35.1385"></a><span id="l35.1385" class="difflineplus">+</span>
<a href="#l35.1386"></a><span id="l35.1386" class="difflineplus">+</span>
<a href="#l35.1387"></a><span id="l35.1387" class="difflineplus">+nsresult</span>
<a href="#l35.1388"></a><span id="l35.1388" class="difflineplus">+RDFServiceImpl::UnregisterLiteral(nsIRDFLiteral* aLiteral)</span>
<a href="#l35.1389"></a><span id="l35.1389" class="difflineplus">+{</span>
<a href="#l35.1390"></a><span id="l35.1390" class="difflineplus">+    const char16_t* value;</span>
<a href="#l35.1391"></a><span id="l35.1391" class="difflineplus">+    aLiteral-&gt;GetValueConst(&amp;value);</span>
<a href="#l35.1392"></a><span id="l35.1392" class="difflineplus">+</span>
<a href="#l35.1393"></a><span id="l35.1393" class="difflineplus">+    NS_ASSERTION(mLiterals.Search(value), &quot;literal was never registered&quot;);</span>
<a href="#l35.1394"></a><span id="l35.1394" class="difflineplus">+</span>
<a href="#l35.1395"></a><span id="l35.1395" class="difflineplus">+    mLiterals.Remove(value);</span>
<a href="#l35.1396"></a><span id="l35.1396" class="difflineplus">+</span>
<a href="#l35.1397"></a><span id="l35.1397" class="difflineplus">+    // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l35.1398"></a><span id="l35.1398" class="difflineplus">+    // reference to it in the hashtable.</span>
<a href="#l35.1399"></a><span id="l35.1399" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1400"></a><span id="l35.1400" class="difflineplus">+           (&quot;rdfserv unregister-literal [%p] %s&quot;,</span>
<a href="#l35.1401"></a><span id="l35.1401" class="difflineplus">+            aLiteral, NS_ConvertUTF16toUTF8(value).get()));</span>
<a href="#l35.1402"></a><span id="l35.1402" class="difflineplus">+</span>
<a href="#l35.1403"></a><span id="l35.1403" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1404"></a><span id="l35.1404" class="difflineplus">+}</span>
<a href="#l35.1405"></a><span id="l35.1405" class="difflineplus">+</span>
<a href="#l35.1406"></a><span id="l35.1406" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l35.1407"></a><span id="l35.1407" class="difflineplus">+</span>
<a href="#l35.1408"></a><span id="l35.1408" class="difflineplus">+nsresult</span>
<a href="#l35.1409"></a><span id="l35.1409" class="difflineplus">+RDFServiceImpl::RegisterInt(nsIRDFInt* aInt)</span>
<a href="#l35.1410"></a><span id="l35.1410" class="difflineplus">+{</span>
<a href="#l35.1411"></a><span id="l35.1411" class="difflineplus">+    int32_t value;</span>
<a href="#l35.1412"></a><span id="l35.1412" class="difflineplus">+    aInt-&gt;GetValue(&amp;value);</span>
<a href="#l35.1413"></a><span id="l35.1413" class="difflineplus">+</span>
<a href="#l35.1414"></a><span id="l35.1414" class="difflineplus">+    NS_ASSERTION(!mInts.Search(&amp;value), &quot;int already registered&quot;);</span>
<a href="#l35.1415"></a><span id="l35.1415" class="difflineplus">+</span>
<a href="#l35.1416"></a><span id="l35.1416" class="difflineplus">+    PLDHashEntryHdr *hdr = mInts.Add(&amp;value, fallible);</span>
<a href="#l35.1417"></a><span id="l35.1417" class="difflineplus">+    if (! hdr)</span>
<a href="#l35.1418"></a><span id="l35.1418" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1419"></a><span id="l35.1419" class="difflineplus">+</span>
<a href="#l35.1420"></a><span id="l35.1420" class="difflineplus">+    IntHashEntry *entry = static_cast&lt;IntHashEntry *&gt;(hdr);</span>
<a href="#l35.1421"></a><span id="l35.1421" class="difflineplus">+</span>
<a href="#l35.1422"></a><span id="l35.1422" class="difflineplus">+    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l35.1423"></a><span id="l35.1423" class="difflineplus">+    // way, the literal can be destroyed when the last refcount</span>
<a href="#l35.1424"></a><span id="l35.1424" class="difflineplus">+    // goes away. The single addref that the CreateInt() call</span>
<a href="#l35.1425"></a><span id="l35.1425" class="difflineplus">+    // made will be owned by the callee.</span>
<a href="#l35.1426"></a><span id="l35.1426" class="difflineplus">+    entry-&gt;mInt = aInt;</span>
<a href="#l35.1427"></a><span id="l35.1427" class="difflineplus">+    entry-&gt;mKey = value;</span>
<a href="#l35.1428"></a><span id="l35.1428" class="difflineplus">+</span>
<a href="#l35.1429"></a><span id="l35.1429" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1430"></a><span id="l35.1430" class="difflineplus">+           (&quot;rdfserv   register-int [%p] %d&quot;,</span>
<a href="#l35.1431"></a><span id="l35.1431" class="difflineplus">+            aInt, value));</span>
<a href="#l35.1432"></a><span id="l35.1432" class="difflineplus">+</span>
<a href="#l35.1433"></a><span id="l35.1433" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1434"></a><span id="l35.1434" class="difflineplus">+}</span>
<a href="#l35.1435"></a><span id="l35.1435" class="difflineplus">+</span>
<a href="#l35.1436"></a><span id="l35.1436" class="difflineplus">+</span>
<a href="#l35.1437"></a><span id="l35.1437" class="difflineplus">+nsresult</span>
<a href="#l35.1438"></a><span id="l35.1438" class="difflineplus">+RDFServiceImpl::UnregisterInt(nsIRDFInt* aInt)</span>
<a href="#l35.1439"></a><span id="l35.1439" class="difflineplus">+{</span>
<a href="#l35.1440"></a><span id="l35.1440" class="difflineplus">+    int32_t value;</span>
<a href="#l35.1441"></a><span id="l35.1441" class="difflineplus">+    aInt-&gt;GetValue(&amp;value);</span>
<a href="#l35.1442"></a><span id="l35.1442" class="difflineplus">+</span>
<a href="#l35.1443"></a><span id="l35.1443" class="difflineplus">+    NS_ASSERTION(mInts.Search(&amp;value), &quot;int was never registered&quot;);</span>
<a href="#l35.1444"></a><span id="l35.1444" class="difflineplus">+</span>
<a href="#l35.1445"></a><span id="l35.1445" class="difflineplus">+    mInts.Remove(&amp;value);</span>
<a href="#l35.1446"></a><span id="l35.1446" class="difflineplus">+</span>
<a href="#l35.1447"></a><span id="l35.1447" class="difflineplus">+    // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l35.1448"></a><span id="l35.1448" class="difflineplus">+    // reference to it in the hashtable.</span>
<a href="#l35.1449"></a><span id="l35.1449" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1450"></a><span id="l35.1450" class="difflineplus">+           (&quot;rdfserv unregister-int [%p] %d&quot;,</span>
<a href="#l35.1451"></a><span id="l35.1451" class="difflineplus">+            aInt, value));</span>
<a href="#l35.1452"></a><span id="l35.1452" class="difflineplus">+</span>
<a href="#l35.1453"></a><span id="l35.1453" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1454"></a><span id="l35.1454" class="difflineplus">+}</span>
<a href="#l35.1455"></a><span id="l35.1455" class="difflineplus">+</span>
<a href="#l35.1456"></a><span id="l35.1456" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l35.1457"></a><span id="l35.1457" class="difflineplus">+</span>
<a href="#l35.1458"></a><span id="l35.1458" class="difflineplus">+nsresult</span>
<a href="#l35.1459"></a><span id="l35.1459" class="difflineplus">+RDFServiceImpl::RegisterDate(nsIRDFDate* aDate)</span>
<a href="#l35.1460"></a><span id="l35.1460" class="difflineplus">+{</span>
<a href="#l35.1461"></a><span id="l35.1461" class="difflineplus">+    PRTime value;</span>
<a href="#l35.1462"></a><span id="l35.1462" class="difflineplus">+    aDate-&gt;GetValue(&amp;value);</span>
<a href="#l35.1463"></a><span id="l35.1463" class="difflineplus">+</span>
<a href="#l35.1464"></a><span id="l35.1464" class="difflineplus">+    NS_ASSERTION(!mDates.Search(&amp;value), &quot;date already registered&quot;);</span>
<a href="#l35.1465"></a><span id="l35.1465" class="difflineplus">+</span>
<a href="#l35.1466"></a><span id="l35.1466" class="difflineplus">+    PLDHashEntryHdr *hdr = mDates.Add(&amp;value, fallible);</span>
<a href="#l35.1467"></a><span id="l35.1467" class="difflineplus">+    if (! hdr)</span>
<a href="#l35.1468"></a><span id="l35.1468" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1469"></a><span id="l35.1469" class="difflineplus">+</span>
<a href="#l35.1470"></a><span id="l35.1470" class="difflineplus">+    DateHashEntry *entry = static_cast&lt;DateHashEntry *&gt;(hdr);</span>
<a href="#l35.1471"></a><span id="l35.1471" class="difflineplus">+</span>
<a href="#l35.1472"></a><span id="l35.1472" class="difflineplus">+    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l35.1473"></a><span id="l35.1473" class="difflineplus">+    // way, the literal can be destroyed when the last refcount</span>
<a href="#l35.1474"></a><span id="l35.1474" class="difflineplus">+    // goes away. The single addref that the CreateDate() call</span>
<a href="#l35.1475"></a><span id="l35.1475" class="difflineplus">+    // made will be owned by the callee.</span>
<a href="#l35.1476"></a><span id="l35.1476" class="difflineplus">+    entry-&gt;mDate = aDate;</span>
<a href="#l35.1477"></a><span id="l35.1477" class="difflineplus">+    entry-&gt;mKey = value;</span>
<a href="#l35.1478"></a><span id="l35.1478" class="difflineplus">+</span>
<a href="#l35.1479"></a><span id="l35.1479" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1480"></a><span id="l35.1480" class="difflineplus">+           (&quot;rdfserv   register-date [%p] %&quot; PRId64,</span>
<a href="#l35.1481"></a><span id="l35.1481" class="difflineplus">+            aDate, value));</span>
<a href="#l35.1482"></a><span id="l35.1482" class="difflineplus">+</span>
<a href="#l35.1483"></a><span id="l35.1483" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1484"></a><span id="l35.1484" class="difflineplus">+}</span>
<a href="#l35.1485"></a><span id="l35.1485" class="difflineplus">+</span>
<a href="#l35.1486"></a><span id="l35.1486" class="difflineplus">+</span>
<a href="#l35.1487"></a><span id="l35.1487" class="difflineplus">+nsresult</span>
<a href="#l35.1488"></a><span id="l35.1488" class="difflineplus">+RDFServiceImpl::UnregisterDate(nsIRDFDate* aDate)</span>
<a href="#l35.1489"></a><span id="l35.1489" class="difflineplus">+{</span>
<a href="#l35.1490"></a><span id="l35.1490" class="difflineplus">+    PRTime value;</span>
<a href="#l35.1491"></a><span id="l35.1491" class="difflineplus">+    aDate-&gt;GetValue(&amp;value);</span>
<a href="#l35.1492"></a><span id="l35.1492" class="difflineplus">+</span>
<a href="#l35.1493"></a><span id="l35.1493" class="difflineplus">+    NS_ASSERTION(mDates.Search(&amp;value), &quot;date was never registered&quot;);</span>
<a href="#l35.1494"></a><span id="l35.1494" class="difflineplus">+</span>
<a href="#l35.1495"></a><span id="l35.1495" class="difflineplus">+    mDates.Remove(&amp;value);</span>
<a href="#l35.1496"></a><span id="l35.1496" class="difflineplus">+</span>
<a href="#l35.1497"></a><span id="l35.1497" class="difflineplus">+    // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l35.1498"></a><span id="l35.1498" class="difflineplus">+    // reference to it in the hashtable.</span>
<a href="#l35.1499"></a><span id="l35.1499" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1500"></a><span id="l35.1500" class="difflineplus">+           (&quot;rdfserv unregister-date [%p] %&quot; PRId64,</span>
<a href="#l35.1501"></a><span id="l35.1501" class="difflineplus">+            aDate, value));</span>
<a href="#l35.1502"></a><span id="l35.1502" class="difflineplus">+</span>
<a href="#l35.1503"></a><span id="l35.1503" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1504"></a><span id="l35.1504" class="difflineplus">+}</span>
<a href="#l35.1505"></a><span id="l35.1505" class="difflineplus">+</span>
<a href="#l35.1506"></a><span id="l35.1506" class="difflineplus">+nsresult</span>
<a href="#l35.1507"></a><span id="l35.1507" class="difflineplus">+RDFServiceImpl::RegisterBlob(BlobImpl *aBlob)</span>
<a href="#l35.1508"></a><span id="l35.1508" class="difflineplus">+{</span>
<a href="#l35.1509"></a><span id="l35.1509" class="difflineplus">+    NS_ASSERTION(!mBlobs.Search(&amp;aBlob-&gt;mData), &quot;blob already registered&quot;);</span>
<a href="#l35.1510"></a><span id="l35.1510" class="difflineplus">+</span>
<a href="#l35.1511"></a><span id="l35.1511" class="difflineplus">+    PLDHashEntryHdr *hdr = mBlobs.Add(&amp;aBlob-&gt;mData, fallible);</span>
<a href="#l35.1512"></a><span id="l35.1512" class="difflineplus">+    if (! hdr)</span>
<a href="#l35.1513"></a><span id="l35.1513" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1514"></a><span id="l35.1514" class="difflineplus">+</span>
<a href="#l35.1515"></a><span id="l35.1515" class="difflineplus">+    BlobHashEntry *entry = static_cast&lt;BlobHashEntry *&gt;(hdr);</span>
<a href="#l35.1516"></a><span id="l35.1516" class="difflineplus">+</span>
<a href="#l35.1517"></a><span id="l35.1517" class="difflineplus">+    // N.B., we only hold a weak reference to the literal: that</span>
<a href="#l35.1518"></a><span id="l35.1518" class="difflineplus">+    // way, the literal can be destroyed when the last refcount</span>
<a href="#l35.1519"></a><span id="l35.1519" class="difflineplus">+    // goes away. The single addref that the CreateInt() call</span>
<a href="#l35.1520"></a><span id="l35.1520" class="difflineplus">+    // made will be owned by the callee.</span>
<a href="#l35.1521"></a><span id="l35.1521" class="difflineplus">+    entry-&gt;mBlob = aBlob;</span>
<a href="#l35.1522"></a><span id="l35.1522" class="difflineplus">+</span>
<a href="#l35.1523"></a><span id="l35.1523" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1524"></a><span id="l35.1524" class="difflineplus">+           (&quot;rdfserv   register-blob [%p] %s&quot;,</span>
<a href="#l35.1525"></a><span id="l35.1525" class="difflineplus">+            aBlob, aBlob-&gt;mData.mBytes));</span>
<a href="#l35.1526"></a><span id="l35.1526" class="difflineplus">+</span>
<a href="#l35.1527"></a><span id="l35.1527" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1528"></a><span id="l35.1528" class="difflineplus">+}</span>
<a href="#l35.1529"></a><span id="l35.1529" class="difflineplus">+</span>
<a href="#l35.1530"></a><span id="l35.1530" class="difflineplus">+nsresult</span>
<a href="#l35.1531"></a><span id="l35.1531" class="difflineplus">+RDFServiceImpl::UnregisterBlob(BlobImpl *aBlob)</span>
<a href="#l35.1532"></a><span id="l35.1532" class="difflineplus">+{</span>
<a href="#l35.1533"></a><span id="l35.1533" class="difflineplus">+    NS_ASSERTION(mBlobs.Search(&amp;aBlob-&gt;mData), &quot;blob was never registered&quot;);</span>
<a href="#l35.1534"></a><span id="l35.1534" class="difflineplus">+</span>
<a href="#l35.1535"></a><span id="l35.1535" class="difflineplus">+    mBlobs.Remove(&amp;aBlob-&gt;mData);</span>
<a href="#l35.1536"></a><span id="l35.1536" class="difflineplus">+</span>
<a href="#l35.1537"></a><span id="l35.1537" class="difflineplus">+     // N.B. that we _don't_ release the literal: we only held a weak</span>
<a href="#l35.1538"></a><span id="l35.1538" class="difflineplus">+     // reference to it in the hashtable.</span>
<a href="#l35.1539"></a><span id="l35.1539" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l35.1540"></a><span id="l35.1540" class="difflineplus">+           (&quot;rdfserv unregister-blob [%p] %s&quot;,</span>
<a href="#l35.1541"></a><span id="l35.1541" class="difflineplus">+            aBlob, aBlob-&gt;mData.mBytes));</span>
<a href="#l35.1542"></a><span id="l35.1542" class="difflineplus">+</span>
<a href="#l35.1543"></a><span id="l35.1543" class="difflineplus">+    return NS_OK;</span>
<a href="#l35.1544"></a><span id="l35.1544" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/rdf/base/nsRDFService.h</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,66 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+ *</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+#ifndef nsRDFService_h__</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+#define nsRDFService_h__</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+#include &quot;nsWeakReference.h&quot;</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+#include &quot;nsIFactory.h&quot;</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+#include &quot;PLDHashTable.h&quot;</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+struct PLHashTable;</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+class nsIRDFLiteral;</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+class nsIRDFInt;</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+class nsIRDFDate;</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+class BlobImpl;</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+class RDFServiceImpl final : public nsIRDFService,</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+                             public nsSupportsWeakReference</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+{</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+protected:</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+    PLHashTable* mNamedDataSources;</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+    PLDHashTable mResources;</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+    PLDHashTable mLiterals;</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+    PLDHashTable mInts;</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+    PLDHashTable mDates;</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+    PLDHashTable mBlobs;</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+    nsCString mLastURIPrefix;</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+    nsCOMPtr&lt;nsIFactory&gt; mLastFactory;</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+    nsCOMPtr&lt;nsIFactory&gt; mDefaultResourceFactory;</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+    RDFServiceImpl();</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+    nsresult Init();</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+    virtual ~RDFServiceImpl();</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+public:</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+    static RDFServiceImpl *gRDFService NS_VISIBILITY_HIDDEN;</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+    static nsresult CreateSingleton(nsISupports* aOuter,</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+                                    const nsIID&amp; aIID, void **aResult);</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+    // nsISupports</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+    // nsIRDFService</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+    NS_DECL_NSIRDFSERVICE</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+    // Implementation methods</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+    nsresult RegisterLiteral(nsIRDFLiteral* aLiteral);</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+    nsresult UnregisterLiteral(nsIRDFLiteral* aLiteral);</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+    nsresult RegisterInt(nsIRDFInt* aInt);</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+    nsresult UnregisterInt(nsIRDFInt* aInt);</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+    nsresult RegisterDate(nsIRDFDate* aDate);</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+    nsresult UnregisterDate(nsIRDFDate* aDate);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+    nsresult RegisterBlob(BlobImpl* aBlob);</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+    nsresult UnregisterBlob(BlobImpl* aBlob);</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+    nsresult GetDataSource(const char *aURI, bool aBlock, nsIRDFDataSource **aDataSource );</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+};</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+#endif // nsRDFService_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/rdf/base/nsRDFXMLDataSource.cpp</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,1173 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+/*</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+  A data source that can read itself from and write itself to an</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  RDF/XML stream.</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+  For more information on the RDF/XML syntax,</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+  see http://www.w3.org/TR/REC-rdf-syntax/.</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+  This code is based on the final W3C Recommendation,</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+  http://www.w3.org/TR/1999/REC-rdf-syntax-19990222.</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+  TO DO</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+  -----</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+  1) Right now, the only kind of stream data sources that are _really_</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+     writable are &quot;file:&quot; URIs. (In fact, _all_ &quot;file:&quot; URIs are</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+     writable, modulo file system permissions; this may lead to some</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+     surprising behavior.) Eventually, it'd be great if we could open</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+     an arbitrary nsIOutputStream on *any* URL, and Netlib could just</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+     do the magic.</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+  2) Implement a more terse output for &quot;typed&quot; nodes; that is, instead</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+     of &quot;RDF:Description type='ns:foo'&quot;, just output &quot;ns:foo&quot;.</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+  3) When re-serializing, we &quot;cheat&quot; for Descriptions that talk about</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+     inline resources (i.e.., using the `ID' attribute specified in</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+     [6.21]). Instead of writing an `ID=&quot;foo&quot;' for the first instance,</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+     and then `about=&quot;#foo&quot;' for each subsequent instance, we just</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+     _always_ write `about=&quot;#foo&quot;'.</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+     We do this so that we can handle the case where an RDF container</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+     has been assigned arbitrary properties: the spec says we can't</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+     dangle the attributes directly off the container, so we need to</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+     refer to it. Of course, with a little cleverness, we could fix</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+     this. But who cares?</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+  4) When re-serializing containers. We have to cheat on some</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+     containers, and use an illegal &quot;about=&quot; construct. We do this to</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+     handle containers that have been assigned URIs outside of the</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+     local document.</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+  Logging</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+  -------</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+  To turn on logging for this module, set</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+    MOZ_LOG=nsRDFXMLDataSource:5</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+ */</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+#include &quot;nsIFileStreams.h&quot;</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+#include &quot;nsIFileChannel.h&quot;</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+#include &quot;nsIDTD.h&quot;</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+#include &quot;nsIRDFPurgeableDataSource.h&quot;</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+#include &quot;nsIInputStream.h&quot;</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+#include &quot;nsIRDFXMLParser.h&quot;</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+#include &quot;nsIRDFXMLSerializer.h&quot;</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+#include &quot;nsIRDFXMLSink.h&quot;</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+#include &quot;nsIRDFXMLSource.h&quot;</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+#include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+#include &quot;nsIStreamListener.h&quot;</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+#include &quot;nsIURL.h&quot;</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+#include &quot;nsIFileURL.h&quot;</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+#include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+#include &quot;nsIChannel.h&quot;</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+#include &quot;nsRDFBaseDataSources.h&quot;</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+#include &quot;plstr.h&quot;</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineplus">+#include &quot;prio.h&quot;</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineplus">+#include &quot;prthread.h&quot;</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineplus">+#include &quot;nsNameSpaceMap.h&quot;</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineplus">+#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineplus">+#include &quot;nsIScriptSecurityManager.h&quot;</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineplus">+#include &quot;nsIChannelEventSink.h&quot;</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineplus">+#include &quot;nsIAsyncVerifyRedirectCallback.h&quot;</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+#include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineplus">+#include &quot;nsContentUtils.h&quot;</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineplus">+#include &quot;rdfIDataSource.h&quot;</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineplus">+</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineplus">+//</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineplus">+// RDFXMLDataSourceImpl</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineplus">+//</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineplus">+</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineplus">+class RDFXMLDataSourceImpl : public nsIRDFDataSource,</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineplus">+                             public nsIRDFRemoteDataSource,</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+                             public nsIRDFXMLSink,</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineplus">+                             public nsIRDFXMLSource,</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineplus">+                             public nsIStreamListener,</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineplus">+                             public rdfIDataSource,</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineplus">+                             public nsIInterfaceRequestor,</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineplus">+                             public nsIChannelEventSink</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineplus">+{</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineplus">+protected:</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineplus">+    enum LoadState {</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineplus">+        eLoadState_Unloaded,</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+        eLoadState_Pending,</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineplus">+        eLoadState_Loading,</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineplus">+        eLoadState_Loaded</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineplus">+    };</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDataSource&gt; mInner;</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineplus">+    bool                mIsWritable;    // true if the document can be written back</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineplus">+    bool                mIsDirty;       // true if the document should be written back</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineplus">+    LoadState           mLoadState;     // what we're doing now</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+    nsCOMArray&lt;nsIRDFXMLSinkObserver&gt; mObservers;</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt;    mURL;</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; mListener;</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineplus">+    nsNameSpaceMap      mNameSpaces;</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineplus">+</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineplus">+    // pseudo-constants</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineplus">+    static int32_t gRefCnt;</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineplus">+    static nsIRDFService* gRDFService;</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineplus">+</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineplus">+    static mozilla::LazyLogModule gLog;</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineplus">+</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+    nsresult Init();</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+    RDFXMLDataSourceImpl(void);</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+    virtual ~RDFXMLDataSourceImpl(void);</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineplus">+    nsresult rdfXMLFlush(nsIURI *aURI);</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineplus">+    friend nsresult</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineplus">+    NS_NewRDFXMLDataSource(nsIRDFDataSource** aResult);</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineplus">+</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+    inline bool IsLoading() {</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineplus">+        return (mLoadState == eLoadState_Pending) ||</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineplus">+               (mLoadState == eLoadState_Loading);</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineplus">+    }</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineplus">+</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineplus">+public:</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+    // nsISupports</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineplus">+    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineplus">+    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(RDFXMLDataSourceImpl,</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineplus">+                                             nsIRDFDataSource)</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineplus">+</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineplus">+    // nsIRDFDataSource</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineplus">+    NS_IMETHOD GetURI(nsACString&amp; aURI) override;</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineplus">+    NS_IMETHOD GetSource(nsIRDFResource* property,</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineplus">+                         nsIRDFNode* target,</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineplus">+                         bool tv,</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineplus">+                         nsIRDFResource** source) override {</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineplus">+        return mInner-&gt;GetSource(property, target, tv, source);</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+    }</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineplus">+</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineplus">+    NS_IMETHOD GetSources(nsIRDFResource* property,</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineplus">+                          nsIRDFNode* target,</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineplus">+                          bool tv,</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineplus">+                          nsISimpleEnumerator** sources) override {</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineplus">+        return mInner-&gt;GetSources(property, target, tv, sources);</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+    }</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineplus">+</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineplus">+    NS_IMETHOD GetTarget(nsIRDFResource* source,</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineplus">+                         nsIRDFResource* property,</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineplus">+                         bool tv,</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineplus">+                         nsIRDFNode** target) override {</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+        return mInner-&gt;GetTarget(source, property, tv, target);</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+    }</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineplus">+    NS_IMETHOD GetTargets(nsIRDFResource* source,</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineplus">+                          nsIRDFResource* property,</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineplus">+                          bool tv,</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+                          nsISimpleEnumerator** targets) override {</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineplus">+        return mInner-&gt;GetTargets(source, property, tv, targets);</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineplus">+    }</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineplus">+</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineplus">+    NS_IMETHOD Assert(nsIRDFResource* aSource,</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineplus">+                      nsIRDFResource* aProperty,</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+                      nsIRDFNode* aTarget,</span>
<a href="#l37.197"></a><span id="l37.197" class="difflineplus">+                      bool tv) override;</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineplus">+</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineplus">+    NS_IMETHOD Unassert(nsIRDFResource* source,</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineplus">+                        nsIRDFResource* property,</span>
<a href="#l37.201"></a><span id="l37.201" class="difflineplus">+                        nsIRDFNode* target) override;</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineplus">+</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineplus">+    NS_IMETHOD Change(nsIRDFResource* aSource,</span>
<a href="#l37.204"></a><span id="l37.204" class="difflineplus">+                      nsIRDFResource* aProperty,</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineplus">+                      nsIRDFNode* aOldTarget,</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineplus">+                      nsIRDFNode* aNewTarget) override;</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineplus">+</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineplus">+    NS_IMETHOD Move(nsIRDFResource* aOldSource,</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineplus">+                    nsIRDFResource* aNewSource,</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineplus">+                    nsIRDFResource* aProperty,</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineplus">+                    nsIRDFNode* aTarget) override;</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineplus">+</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineplus">+    NS_IMETHOD HasAssertion(nsIRDFResource* source,</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineplus">+                            nsIRDFResource* property,</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineplus">+                            nsIRDFNode* target,</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineplus">+                            bool tv,</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineplus">+                            bool* hasAssertion) override {</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineplus">+        return mInner-&gt;HasAssertion(source, property, target, tv, hasAssertion);</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineplus">+    }</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineplus">+</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineplus">+    NS_IMETHOD AddObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineplus">+        return mInner-&gt;AddObserver(aObserver);</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineplus">+    }</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineplus">+</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineplus">+    NS_IMETHOD RemoveObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineplus">+        return mInner-&gt;RemoveObserver(aObserver);</span>
<a href="#l37.227"></a><span id="l37.227" class="difflineplus">+    }</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineplus">+</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineplus">+    NS_IMETHOD HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineplus">+        return mInner-&gt;HasArcIn(aNode, aArc, _retval);</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineplus">+    }</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineplus">+</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineplus">+    NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineplus">+        return mInner-&gt;HasArcOut(aSource, aArc, _retval);</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineplus">+    }</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineplus">+</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineplus">+    NS_IMETHOD ArcLabelsIn(nsIRDFNode* node,</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineplus">+                           nsISimpleEnumerator** labels) override {</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineplus">+        return mInner-&gt;ArcLabelsIn(node, labels);</span>
<a href="#l37.240"></a><span id="l37.240" class="difflineplus">+    }</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineplus">+</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineplus">+    NS_IMETHOD ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineplus">+                            nsISimpleEnumerator** labels) override {</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineplus">+        return mInner-&gt;ArcLabelsOut(source, labels);</span>
<a href="#l37.245"></a><span id="l37.245" class="difflineplus">+    }</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineplus">+</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineplus">+    NS_IMETHOD GetAllResources(nsISimpleEnumerator** aResult) override {</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineplus">+        return mInner-&gt;GetAllResources(aResult);</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineplus">+    }</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineplus">+</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineplus">+    NS_IMETHOD GetAllCmds(nsIRDFResource* source,</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineplus">+                              nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands) override {</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineplus">+        return mInner-&gt;GetAllCmds(source, commands);</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineplus">+    }</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineplus">+</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineplus">+    NS_IMETHOD IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineplus">+                                nsIRDFResource*   aCommand,</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineplus">+                                nsISupports* aArguments,</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineplus">+                                bool* aResult) override {</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineplus">+        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineplus">+    }</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineplus">+</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineplus">+    NS_IMETHOD DoCommand(nsISupports* aSources,</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineplus">+                         nsIRDFResource*   aCommand,</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineplus">+                         nsISupports* aArguments) override {</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineplus">+        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineplus">+    }</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineplus">+</span>
<a href="#l37.269"></a><span id="l37.269" class="difflineplus">+    NS_IMETHOD BeginUpdateBatch() override {</span>
<a href="#l37.270"></a><span id="l37.270" class="difflineplus">+        return mInner-&gt;BeginUpdateBatch();</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineplus">+    }</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineplus">+</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineplus">+    NS_IMETHOD EndUpdateBatch() override {</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineplus">+        return mInner-&gt;EndUpdateBatch();</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineplus">+    }</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineplus">+</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineplus">+    // nsIRDFRemoteDataSource interface</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineplus">+    NS_DECL_NSIRDFREMOTEDATASOURCE</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineplus">+</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineplus">+    // nsIRDFXMLSink interface</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineplus">+    NS_DECL_NSIRDFXMLSINK</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineplus">+</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineplus">+    // nsIRDFXMLSource interface</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineplus">+    NS_DECL_NSIRDFXMLSOURCE</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineplus">+</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineplus">+    // nsIRequestObserver</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineplus">+    NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineplus">+</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineplus">+    // nsIStreamListener</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+    NS_DECL_NSISTREAMLISTENER</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineplus">+</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineplus">+    // nsIInterfaceRequestor</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineplus">+    NS_DECL_NSIINTERFACEREQUESTOR</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineplus">+</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineplus">+    // nsIChannelEventSink</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineplus">+    NS_DECL_NSICHANNELEVENTSINK</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineplus">+</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineplus">+    // rdfIDataSource</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineplus">+    NS_IMETHOD VisitAllSubjects(rdfITripleVisitor *aVisitor) override {</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineplus">+        nsresult rv;</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineplus">+        nsCOMPtr&lt;rdfIDataSource&gt; rdfds = do_QueryInterface(mInner, &amp;rv);</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineplus">+        return rdfds-&gt;VisitAllSubjects(aVisitor);</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineplus">+    }</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineplus">+</span>
<a href="#l37.306"></a><span id="l37.306" class="difflineplus">+    NS_IMETHOD VisitAllTriples(rdfITripleVisitor *aVisitor) override {</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineplus">+        nsresult rv;</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineplus">+        nsCOMPtr&lt;rdfIDataSource&gt; rdfds = do_QueryInterface(mInner, &amp;rv);</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineplus">+        return rdfds-&gt;VisitAllTriples(aVisitor);</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineplus">+    }</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineplus">+</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineplus">+    // Implementation methods</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineplus">+    bool</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineplus">+    MakeQName(nsIRDFResource* aResource,</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineplus">+              nsString&amp; property,</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineplus">+              nsString&amp; nameSpacePrefix,</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineplus">+              nsString&amp; nameSpaceURI);</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineplus">+</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineplus">+    nsresult</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineplus">+    SerializeAssertion(nsIOutputStream* aStream,</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineplus">+                       nsIRDFResource* aResource,</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineplus">+                       nsIRDFResource* aProperty,</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineplus">+                       nsIRDFNode* aValue);</span>
<a href="#l37.325"></a><span id="l37.325" class="difflineplus">+</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineplus">+    nsresult</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineplus">+    SerializeProperty(nsIOutputStream* aStream,</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineplus">+                      nsIRDFResource* aResource,</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineplus">+                      nsIRDFResource* aProperty);</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineplus">+</span>
<a href="#l37.331"></a><span id="l37.331" class="difflineplus">+    bool</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineplus">+    IsContainerProperty(nsIRDFResource* aProperty);</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineplus">+</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineplus">+    nsresult</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineplus">+    SerializeDescription(nsIOutputStream* aStream,</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineplus">+                         nsIRDFResource* aResource);</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineplus">+</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineplus">+    nsresult</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineplus">+    SerializeMember(nsIOutputStream* aStream,</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineplus">+                    nsIRDFResource* aContainer,</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineplus">+                    nsIRDFNode* aMember);</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineplus">+</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineplus">+    nsresult</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineplus">+    SerializeContainer(nsIOutputStream* aStream,</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineplus">+                       nsIRDFResource* aContainer);</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineplus">+</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineplus">+    nsresult</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineplus">+    SerializePrologue(nsIOutputStream* aStream);</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineplus">+</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineplus">+    nsresult</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineplus">+    SerializeEpilogue(nsIOutputStream* aStream);</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineplus">+</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineplus">+    bool</span>
<a href="#l37.354"></a><span id="l37.354" class="difflineplus">+    IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType);</span>
<a href="#l37.355"></a><span id="l37.355" class="difflineplus">+</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineplus">+protected:</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineplus">+    nsresult</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineplus">+    BlockingParse(nsIURI* aURL, nsIStreamListener* aConsumer);</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineplus">+};</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineplus">+</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineplus">+int32_t         RDFXMLDataSourceImpl::gRefCnt = 0;</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineplus">+nsIRDFService*  RDFXMLDataSourceImpl::gRDFService;</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineplus">+</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineplus">+mozilla::LazyLogModule RDFXMLDataSourceImpl::gLog(&quot;nsRDFXMLDataSource&quot;);</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineplus">+</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineplus">+static const char kFileURIPrefix[] = &quot;file:&quot;;</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineplus">+static const char kResourceURIPrefix[] = &quot;resource:&quot;;</span>
<a href="#l37.368"></a><span id="l37.368" class="difflineplus">+</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineplus">+</span>
<a href="#l37.370"></a><span id="l37.370" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineplus">+</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineplus">+nsresult</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineplus">+NS_NewRDFXMLDataSource(nsIRDFDataSource** aResult)</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineplus">+{</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineplus">+    if (! aResult)</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineplus">+</span>
<a href="#l37.379"></a><span id="l37.379" class="difflineplus">+    RDFXMLDataSourceImpl* datasource = new RDFXMLDataSourceImpl();</span>
<a href="#l37.380"></a><span id="l37.380" class="difflineplus">+    if (! datasource)</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.382"></a><span id="l37.382" class="difflineplus">+</span>
<a href="#l37.383"></a><span id="l37.383" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineplus">+    rv = datasource-&gt;Init();</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineplus">+</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l37.387"></a><span id="l37.387" class="difflineplus">+        delete datasource;</span>
<a href="#l37.388"></a><span id="l37.388" class="difflineplus">+        return rv;</span>
<a href="#l37.389"></a><span id="l37.389" class="difflineplus">+    }</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineplus">+</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineplus">+    NS_ADDREF(datasource);</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineplus">+    *aResult = datasource;</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineplus">+}</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineplus">+</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineplus">+</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineplus">+RDFXMLDataSourceImpl::RDFXMLDataSourceImpl(void)</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineplus">+    : mIsWritable(true),</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineplus">+      mIsDirty(false),</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineplus">+      mLoadState(eLoadState_Unloaded)</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineplus">+{</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineplus">+}</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineplus">+</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineplus">+</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineplus">+nsresult</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineplus">+RDFXMLDataSourceImpl::Init()</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineplus">+{</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineplus">+    NS_DEFINE_CID(kRDFInMemoryDataSourceCID, NS_RDFINMEMORYDATASOURCE_CID);</span>
<a href="#l37.410"></a><span id="l37.410" class="difflineplus">+    mInner = do_CreateInstance(kRDFInMemoryDataSourceCID, &amp;rv);</span>
<a href="#l37.411"></a><span id="l37.411" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineplus">+</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineplus">+    if (gRefCnt++ == 0) {</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineplus">+        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+        rv = CallGetService(kRDFServiceCID, &amp;gRDFService);</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineplus">+</span>
<a href="#l37.417"></a><span id="l37.417" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;unable to get RDF service&quot;);</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineplus">+    }</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineplus">+</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.422"></a><span id="l37.422" class="difflineplus">+}</span>
<a href="#l37.423"></a><span id="l37.423" class="difflineplus">+</span>
<a href="#l37.424"></a><span id="l37.424" class="difflineplus">+</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineplus">+RDFXMLDataSourceImpl::~RDFXMLDataSourceImpl(void)</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineplus">+{</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineplus">+    // Unregister first so that nobody else tries to get us.</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineplus">+    (void) gRDFService-&gt;UnregisterDataSource(this);</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineplus">+</span>
<a href="#l37.430"></a><span id="l37.430" class="difflineplus">+    // Now flush contents</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineplus">+    (void) Flush();</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineplus">+</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineplus">+    // Release RDF/XML sink observers</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineplus">+    mObservers.Clear();</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineplus">+</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineplus">+    if (--gRefCnt == 0)</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineplus">+        NS_IF_RELEASE(gRDFService);</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineplus">+}</span>
<a href="#l37.439"></a><span id="l37.439" class="difflineplus">+</span>
<a href="#l37.440"></a><span id="l37.440" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_CLASS(RDFXMLDataSourceImpl)</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineplus">+</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_UNLINK_0(RDFXMLDataSourceImpl)</span>
<a href="#l37.443"></a><span id="l37.443" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_BEGIN(RDFXMLDataSourceImpl)</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineplus">+    NS_IMPL_CYCLE_COLLECTION_TRAVERSE(mInner)</span>
<a href="#l37.445"></a><span id="l37.445" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION_TRAVERSE_END</span>
<a href="#l37.446"></a><span id="l37.446" class="difflineplus">+</span>
<a href="#l37.447"></a><span id="l37.447" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_ADDREF(RDFXMLDataSourceImpl)</span>
<a href="#l37.448"></a><span id="l37.448" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_RELEASE(RDFXMLDataSourceImpl)</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineplus">+</span>
<a href="#l37.450"></a><span id="l37.450" class="difflineplus">+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(RDFXMLDataSourceImpl)</span>
<a href="#l37.451"></a><span id="l37.451" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l37.452"></a><span id="l37.452" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFRemoteDataSource)</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFXMLSink)</span>
<a href="#l37.454"></a><span id="l37.454" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFXMLSource)</span>
<a href="#l37.455"></a><span id="l37.455" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRequestObserver)</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIStreamListener)</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(rdfIDataSource)</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIInterfaceRequestor)</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIChannelEventSink)</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIRDFDataSource)</span>
<a href="#l37.461"></a><span id="l37.461" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineplus">+</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineplus">+// nsIInterfaceRequestor</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineplus">+RDFXMLDataSourceImpl::GetInterface(const nsIID&amp; aIID, void** aSink)</span>
<a href="#l37.466"></a><span id="l37.466" class="difflineplus">+{</span>
<a href="#l37.467"></a><span id="l37.467" class="difflineplus">+  return QueryInterface(aIID, aSink);</span>
<a href="#l37.468"></a><span id="l37.468" class="difflineplus">+}</span>
<a href="#l37.469"></a><span id="l37.469" class="difflineplus">+</span>
<a href="#l37.470"></a><span id="l37.470" class="difflineplus">+nsresult</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineplus">+RDFXMLDataSourceImpl::BlockingParse(nsIURI* aURL, nsIStreamListener* aConsumer)</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineplus">+{</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineplus">+</span>
<a href="#l37.475"></a><span id="l37.475" class="difflineplus">+    // XXX I really hate the way that we're spoon-feeding this stuff</span>
<a href="#l37.476"></a><span id="l37.476" class="difflineplus">+    // to the parser: it seems like this is something that netlib</span>
<a href="#l37.477"></a><span id="l37.477" class="difflineplus">+    // should be able to do by itself.</span>
<a href="#l37.478"></a><span id="l37.478" class="difflineplus">+</span>
<a href="#l37.479"></a><span id="l37.479" class="difflineplus">+    nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l37.480"></a><span id="l37.480" class="difflineplus">+</span>
<a href="#l37.481"></a><span id="l37.481" class="difflineplus">+    // Null LoadGroup ?</span>
<a href="#l37.482"></a><span id="l37.482" class="difflineplus">+    rv = NS_NewChannel(getter_AddRefs(channel),</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineplus">+                       aURL,</span>
<a href="#l37.484"></a><span id="l37.484" class="difflineplus">+                       nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l37.485"></a><span id="l37.485" class="difflineplus">+                       nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l37.486"></a><span id="l37.486" class="difflineplus">+                       nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l37.487"></a><span id="l37.487" class="difflineplus">+</span>
<a href="#l37.488"></a><span id="l37.488" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.489"></a><span id="l37.489" class="difflineplus">+    nsCOMPtr&lt;nsIInputStream&gt; in;</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineplus">+    rv = channel-&gt;Open2(getter_AddRefs(in));</span>
<a href="#l37.491"></a><span id="l37.491" class="difflineplus">+</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineplus">+    // Report success if the file doesn't exist, but propagate other errors.</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineplus">+    if (rv == NS_ERROR_FILE_NOT_FOUND) return NS_OK;</span>
<a href="#l37.494"></a><span id="l37.494" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.495"></a><span id="l37.495" class="difflineplus">+</span>
<a href="#l37.496"></a><span id="l37.496" class="difflineplus">+    if (! in) {</span>
<a href="#l37.497"></a><span id="l37.497" class="difflineplus">+        NS_ERROR(&quot;no input stream&quot;);</span>
<a href="#l37.498"></a><span id="l37.498" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l37.499"></a><span id="l37.499" class="difflineplus">+    }</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineplus">+</span>
<a href="#l37.501"></a><span id="l37.501" class="difflineplus">+    // Wrap the channel's input stream in a buffered stream to ensure that</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineplus">+    // ReadSegments is implemented (which OnDataAvailable expects).</span>
<a href="#l37.503"></a><span id="l37.503" class="difflineplus">+    nsCOMPtr&lt;nsIInputStream&gt; bufStream;</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineplus">+    rv = NS_NewBufferedInputStream(getter_AddRefs(bufStream), in.forget(),</span>
<a href="#l37.505"></a><span id="l37.505" class="difflineplus">+                                   4096 /* buffer size */);</span>
<a href="#l37.506"></a><span id="l37.506" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.507"></a><span id="l37.507" class="difflineplus">+</span>
<a href="#l37.508"></a><span id="l37.508" class="difflineplus">+    // Notify load observers</span>
<a href="#l37.509"></a><span id="l37.509" class="difflineplus">+    int32_t i;</span>
<a href="#l37.510"></a><span id="l37.510" class="difflineplus">+    for (i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineplus">+        // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineplus">+        // that it doesn't go away in this call if it removes itself</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineplus">+        // as an observer</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineplus">+</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineplus">+        if (obs) {</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineplus">+            obs-&gt;OnBeginLoad(this);</span>
<a href="#l37.518"></a><span id="l37.518" class="difflineplus">+        }</span>
<a href="#l37.519"></a><span id="l37.519" class="difflineplus">+    }</span>
<a href="#l37.520"></a><span id="l37.520" class="difflineplus">+</span>
<a href="#l37.521"></a><span id="l37.521" class="difflineplus">+    rv = aConsumer-&gt;OnStartRequest(channel, nullptr);</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineplus">+</span>
<a href="#l37.523"></a><span id="l37.523" class="difflineplus">+    uint64_t offset = 0;</span>
<a href="#l37.524"></a><span id="l37.524" class="difflineplus">+    while (NS_SUCCEEDED(rv)) {</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineplus">+        // Skip ODA if the channel is canceled</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineplus">+        channel-&gt;GetStatus(&amp;rv);</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l37.528"></a><span id="l37.528" class="difflineplus">+            break;</span>
<a href="#l37.529"></a><span id="l37.529" class="difflineplus">+</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineplus">+        uint64_t avail;</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineplus">+        if (NS_FAILED(rv = bufStream-&gt;Available(&amp;avail)))</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineplus">+            break; // error</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineplus">+</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineplus">+        if (avail == 0)</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineplus">+            break; // eof</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineplus">+</span>
<a href="#l37.537"></a><span id="l37.537" class="difflineplus">+        if (avail &gt; UINT32_MAX)</span>
<a href="#l37.538"></a><span id="l37.538" class="difflineplus">+            avail = UINT32_MAX;</span>
<a href="#l37.539"></a><span id="l37.539" class="difflineplus">+</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineplus">+        rv = aConsumer-&gt;OnDataAvailable(channel, nullptr, bufStream, offset, (uint32_t)avail);</span>
<a href="#l37.541"></a><span id="l37.541" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l37.542"></a><span id="l37.542" class="difflineplus">+            offset += avail;</span>
<a href="#l37.543"></a><span id="l37.543" class="difflineplus">+    }</span>
<a href="#l37.544"></a><span id="l37.544" class="difflineplus">+</span>
<a href="#l37.545"></a><span id="l37.545" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineplus">+        channel-&gt;Cancel(rv);</span>
<a href="#l37.547"></a><span id="l37.547" class="difflineplus">+</span>
<a href="#l37.548"></a><span id="l37.548" class="difflineplus">+    channel-&gt;GetStatus(&amp;rv);</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineplus">+    aConsumer-&gt;OnStopRequest(channel, nullptr, rv);</span>
<a href="#l37.550"></a><span id="l37.550" class="difflineplus">+</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineplus">+    // Notify load observers</span>
<a href="#l37.552"></a><span id="l37.552" class="difflineplus">+    for (i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineplus">+        // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.554"></a><span id="l37.554" class="difflineplus">+        // that it doesn't go away in this call if it removes itself</span>
<a href="#l37.555"></a><span id="l37.555" class="difflineplus">+        // as an observer</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.557"></a><span id="l37.557" class="difflineplus">+</span>
<a href="#l37.558"></a><span id="l37.558" class="difflineplus">+        if (obs) {</span>
<a href="#l37.559"></a><span id="l37.559" class="difflineplus">+            if (NS_FAILED(rv))</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineplus">+                obs-&gt;OnError(this, rv, nullptr);</span>
<a href="#l37.561"></a><span id="l37.561" class="difflineplus">+</span>
<a href="#l37.562"></a><span id="l37.562" class="difflineplus">+            obs-&gt;OnEndLoad(this);</span>
<a href="#l37.563"></a><span id="l37.563" class="difflineplus">+        }</span>
<a href="#l37.564"></a><span id="l37.564" class="difflineplus">+    }</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineplus">+</span>
<a href="#l37.566"></a><span id="l37.566" class="difflineplus">+    return rv;</span>
<a href="#l37.567"></a><span id="l37.567" class="difflineplus">+}</span>
<a href="#l37.568"></a><span id="l37.568" class="difflineplus">+</span>
<a href="#l37.569"></a><span id="l37.569" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.570"></a><span id="l37.570" class="difflineplus">+RDFXMLDataSourceImpl::GetLoaded(bool* _result)</span>
<a href="#l37.571"></a><span id="l37.571" class="difflineplus">+{</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineplus">+    *_result = (mLoadState == eLoadState_Loaded);</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.574"></a><span id="l37.574" class="difflineplus">+}</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineplus">+</span>
<a href="#l37.576"></a><span id="l37.576" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.577"></a><span id="l37.577" class="difflineplus">+RDFXMLDataSourceImpl::Init(const char* uri)</span>
<a href="#l37.578"></a><span id="l37.578" class="difflineplus">+{</span>
<a href="#l37.579"></a><span id="l37.579" class="difflineplus">+    NS_PRECONDITION(mInner != nullptr, &quot;not initialized&quot;);</span>
<a href="#l37.580"></a><span id="l37.580" class="difflineplus">+    if (! mInner)</span>
<a href="#l37.581"></a><span id="l37.581" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.582"></a><span id="l37.582" class="difflineplus">+</span>
<a href="#l37.583"></a><span id="l37.583" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.584"></a><span id="l37.584" class="difflineplus">+</span>
<a href="#l37.585"></a><span id="l37.585" class="difflineplus">+    rv = NS_NewURI(getter_AddRefs(mURL), nsDependentCString(uri));</span>
<a href="#l37.586"></a><span id="l37.586" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.587"></a><span id="l37.587" class="difflineplus">+</span>
<a href="#l37.588"></a><span id="l37.588" class="difflineplus">+    // XXX this is a hack: any &quot;file:&quot; URI is considered writable. All</span>
<a href="#l37.589"></a><span id="l37.589" class="difflineplus">+    // others are considered read-only.</span>
<a href="#l37.590"></a><span id="l37.590" class="difflineplus">+    if ((PL_strncmp(uri, kFileURIPrefix, sizeof(kFileURIPrefix) - 1) != 0) &amp;&amp;</span>
<a href="#l37.591"></a><span id="l37.591" class="difflineplus">+        (PL_strncmp(uri, kResourceURIPrefix, sizeof(kResourceURIPrefix) - 1) != 0)) {</span>
<a href="#l37.592"></a><span id="l37.592" class="difflineplus">+        mIsWritable = false;</span>
<a href="#l37.593"></a><span id="l37.593" class="difflineplus">+    }</span>
<a href="#l37.594"></a><span id="l37.594" class="difflineplus">+</span>
<a href="#l37.595"></a><span id="l37.595" class="difflineplus">+    rv = gRDFService-&gt;RegisterDataSource(this, false);</span>
<a href="#l37.596"></a><span id="l37.596" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.597"></a><span id="l37.597" class="difflineplus">+</span>
<a href="#l37.598"></a><span id="l37.598" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.599"></a><span id="l37.599" class="difflineplus">+}</span>
<a href="#l37.600"></a><span id="l37.600" class="difflineplus">+</span>
<a href="#l37.601"></a><span id="l37.601" class="difflineplus">+</span>
<a href="#l37.602"></a><span id="l37.602" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.603"></a><span id="l37.603" class="difflineplus">+RDFXMLDataSourceImpl::GetURI(nsACString&amp; aURI)</span>
<a href="#l37.604"></a><span id="l37.604" class="difflineplus">+{</span>
<a href="#l37.605"></a><span id="l37.605" class="difflineplus">+    if (!mURL) {</span>
<a href="#l37.606"></a><span id="l37.606" class="difflineplus">+        aURI.SetIsVoid(true);</span>
<a href="#l37.607"></a><span id="l37.607" class="difflineplus">+        return NS_OK;</span>
<a href="#l37.608"></a><span id="l37.608" class="difflineplus">+    }</span>
<a href="#l37.609"></a><span id="l37.609" class="difflineplus">+</span>
<a href="#l37.610"></a><span id="l37.610" class="difflineplus">+    return mURL-&gt;GetSpec(aURI);</span>
<a href="#l37.611"></a><span id="l37.611" class="difflineplus">+}</span>
<a href="#l37.612"></a><span id="l37.612" class="difflineplus">+</span>
<a href="#l37.613"></a><span id="l37.613" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.614"></a><span id="l37.614" class="difflineplus">+RDFXMLDataSourceImpl::Assert(nsIRDFResource* aSource,</span>
<a href="#l37.615"></a><span id="l37.615" class="difflineplus">+                             nsIRDFResource* aProperty,</span>
<a href="#l37.616"></a><span id="l37.616" class="difflineplus">+                             nsIRDFNode* aTarget,</span>
<a href="#l37.617"></a><span id="l37.617" class="difflineplus">+                             bool aTruthValue)</span>
<a href="#l37.618"></a><span id="l37.618" class="difflineplus">+{</span>
<a href="#l37.619"></a><span id="l37.619" class="difflineplus">+    // We don't accept assertions unless we're writable (except in the</span>
<a href="#l37.620"></a><span id="l37.620" class="difflineplus">+    // case that we're actually _reading_ the datasource in).</span>
<a href="#l37.621"></a><span id="l37.621" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.622"></a><span id="l37.622" class="difflineplus">+</span>
<a href="#l37.623"></a><span id="l37.623" class="difflineplus">+    if (IsLoading()) {</span>
<a href="#l37.624"></a><span id="l37.624" class="difflineplus">+        bool hasAssertion = false;</span>
<a href="#l37.625"></a><span id="l37.625" class="difflineplus">+</span>
<a href="#l37.626"></a><span id="l37.626" class="difflineplus">+        nsCOMPtr&lt;nsIRDFPurgeableDataSource&gt; gcable = do_QueryInterface(mInner);</span>
<a href="#l37.627"></a><span id="l37.627" class="difflineplus">+        if (gcable) {</span>
<a href="#l37.628"></a><span id="l37.628" class="difflineplus">+            rv = gcable-&gt;Mark(aSource, aProperty, aTarget, aTruthValue, &amp;hasAssertion);</span>
<a href="#l37.629"></a><span id="l37.629" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.630"></a><span id="l37.630" class="difflineplus">+        }</span>
<a href="#l37.631"></a><span id="l37.631" class="difflineplus">+</span>
<a href="#l37.632"></a><span id="l37.632" class="difflineplus">+        rv = NS_RDF_ASSERTION_ACCEPTED;</span>
<a href="#l37.633"></a><span id="l37.633" class="difflineplus">+</span>
<a href="#l37.634"></a><span id="l37.634" class="difflineplus">+        if (! hasAssertion) {</span>
<a href="#l37.635"></a><span id="l37.635" class="difflineplus">+            rv = mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l37.636"></a><span id="l37.636" class="difflineplus">+</span>
<a href="#l37.637"></a><span id="l37.637" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; gcable) {</span>
<a href="#l37.638"></a><span id="l37.638" class="difflineplus">+                // Now mark the new assertion, so it doesn't get</span>
<a href="#l37.639"></a><span id="l37.639" class="difflineplus">+                // removed when we sweep. Ignore rv, because we want</span>
<a href="#l37.640"></a><span id="l37.640" class="difflineplus">+                // to return what mInner-&gt;Assert() gave us.</span>
<a href="#l37.641"></a><span id="l37.641" class="difflineplus">+                bool didMark;</span>
<a href="#l37.642"></a><span id="l37.642" class="difflineplus">+                (void) gcable-&gt;Mark(aSource, aProperty, aTarget, aTruthValue, &amp;didMark);</span>
<a href="#l37.643"></a><span id="l37.643" class="difflineplus">+            }</span>
<a href="#l37.644"></a><span id="l37.644" class="difflineplus">+</span>
<a href="#l37.645"></a><span id="l37.645" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.646"></a><span id="l37.646" class="difflineplus">+        }</span>
<a href="#l37.647"></a><span id="l37.647" class="difflineplus">+</span>
<a href="#l37.648"></a><span id="l37.648" class="difflineplus">+        return rv;</span>
<a href="#l37.649"></a><span id="l37.649" class="difflineplus">+    }</span>
<a href="#l37.650"></a><span id="l37.650" class="difflineplus">+    else if (mIsWritable) {</span>
<a href="#l37.651"></a><span id="l37.651" class="difflineplus">+        rv = mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineplus">+</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineplus">+        if (rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l37.654"></a><span id="l37.654" class="difflineplus">+            mIsDirty = true;</span>
<a href="#l37.655"></a><span id="l37.655" class="difflineplus">+</span>
<a href="#l37.656"></a><span id="l37.656" class="difflineplus">+        return rv;</span>
<a href="#l37.657"></a><span id="l37.657" class="difflineplus">+    }</span>
<a href="#l37.658"></a><span id="l37.658" class="difflineplus">+    else {</span>
<a href="#l37.659"></a><span id="l37.659" class="difflineplus">+        return NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l37.660"></a><span id="l37.660" class="difflineplus">+    }</span>
<a href="#l37.661"></a><span id="l37.661" class="difflineplus">+}</span>
<a href="#l37.662"></a><span id="l37.662" class="difflineplus">+</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineplus">+</span>
<a href="#l37.664"></a><span id="l37.664" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineplus">+RDFXMLDataSourceImpl::Unassert(nsIRDFResource* source,</span>
<a href="#l37.666"></a><span id="l37.666" class="difflineplus">+                               nsIRDFResource* property,</span>
<a href="#l37.667"></a><span id="l37.667" class="difflineplus">+                               nsIRDFNode* target)</span>
<a href="#l37.668"></a><span id="l37.668" class="difflineplus">+{</span>
<a href="#l37.669"></a><span id="l37.669" class="difflineplus">+    // We don't accept assertions unless we're writable (except in the</span>
<a href="#l37.670"></a><span id="l37.670" class="difflineplus">+    // case that we're actually _reading_ the datasource in).</span>
<a href="#l37.671"></a><span id="l37.671" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineplus">+</span>
<a href="#l37.673"></a><span id="l37.673" class="difflineplus">+    if (IsLoading() || mIsWritable) {</span>
<a href="#l37.674"></a><span id="l37.674" class="difflineplus">+        rv = mInner-&gt;Unassert(source, property, target);</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineplus">+        if (!IsLoading() &amp;&amp; rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l37.676"></a><span id="l37.676" class="difflineplus">+            mIsDirty = true;</span>
<a href="#l37.677"></a><span id="l37.677" class="difflineplus">+    }</span>
<a href="#l37.678"></a><span id="l37.678" class="difflineplus">+    else {</span>
<a href="#l37.679"></a><span id="l37.679" class="difflineplus">+        rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l37.680"></a><span id="l37.680" class="difflineplus">+    }</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineplus">+</span>
<a href="#l37.682"></a><span id="l37.682" class="difflineplus">+    return rv;</span>
<a href="#l37.683"></a><span id="l37.683" class="difflineplus">+}</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineplus">+</span>
<a href="#l37.685"></a><span id="l37.685" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.686"></a><span id="l37.686" class="difflineplus">+RDFXMLDataSourceImpl::Change(nsIRDFResource* aSource,</span>
<a href="#l37.687"></a><span id="l37.687" class="difflineplus">+                             nsIRDFResource* aProperty,</span>
<a href="#l37.688"></a><span id="l37.688" class="difflineplus">+                             nsIRDFNode* aOldTarget,</span>
<a href="#l37.689"></a><span id="l37.689" class="difflineplus">+                             nsIRDFNode* aNewTarget)</span>
<a href="#l37.690"></a><span id="l37.690" class="difflineplus">+{</span>
<a href="#l37.691"></a><span id="l37.691" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.692"></a><span id="l37.692" class="difflineplus">+</span>
<a href="#l37.693"></a><span id="l37.693" class="difflineplus">+    if (IsLoading() || mIsWritable) {</span>
<a href="#l37.694"></a><span id="l37.694" class="difflineplus">+        rv = mInner-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineplus">+</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineplus">+        if (!IsLoading() &amp;&amp; rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l37.697"></a><span id="l37.697" class="difflineplus">+            mIsDirty = true;</span>
<a href="#l37.698"></a><span id="l37.698" class="difflineplus">+    }</span>
<a href="#l37.699"></a><span id="l37.699" class="difflineplus">+    else {</span>
<a href="#l37.700"></a><span id="l37.700" class="difflineplus">+        rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l37.701"></a><span id="l37.701" class="difflineplus">+    }</span>
<a href="#l37.702"></a><span id="l37.702" class="difflineplus">+</span>
<a href="#l37.703"></a><span id="l37.703" class="difflineplus">+    return rv;</span>
<a href="#l37.704"></a><span id="l37.704" class="difflineplus">+}</span>
<a href="#l37.705"></a><span id="l37.705" class="difflineplus">+</span>
<a href="#l37.706"></a><span id="l37.706" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.707"></a><span id="l37.707" class="difflineplus">+RDFXMLDataSourceImpl::Move(nsIRDFResource* aOldSource,</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineplus">+                           nsIRDFResource* aNewSource,</span>
<a href="#l37.709"></a><span id="l37.709" class="difflineplus">+                           nsIRDFResource* aProperty,</span>
<a href="#l37.710"></a><span id="l37.710" class="difflineplus">+                           nsIRDFNode* aTarget)</span>
<a href="#l37.711"></a><span id="l37.711" class="difflineplus">+{</span>
<a href="#l37.712"></a><span id="l37.712" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.713"></a><span id="l37.713" class="difflineplus">+</span>
<a href="#l37.714"></a><span id="l37.714" class="difflineplus">+    if (IsLoading() || mIsWritable) {</span>
<a href="#l37.715"></a><span id="l37.715" class="difflineplus">+        rv = mInner-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l37.716"></a><span id="l37.716" class="difflineplus">+        if (!IsLoading() &amp;&amp; rv == NS_RDF_ASSERTION_ACCEPTED)</span>
<a href="#l37.717"></a><span id="l37.717" class="difflineplus">+            mIsDirty = true;</span>
<a href="#l37.718"></a><span id="l37.718" class="difflineplus">+    }</span>
<a href="#l37.719"></a><span id="l37.719" class="difflineplus">+    else {</span>
<a href="#l37.720"></a><span id="l37.720" class="difflineplus">+        rv = NS_RDF_ASSERTION_REJECTED;</span>
<a href="#l37.721"></a><span id="l37.721" class="difflineplus">+    }</span>
<a href="#l37.722"></a><span id="l37.722" class="difflineplus">+</span>
<a href="#l37.723"></a><span id="l37.723" class="difflineplus">+    return rv;</span>
<a href="#l37.724"></a><span id="l37.724" class="difflineplus">+}</span>
<a href="#l37.725"></a><span id="l37.725" class="difflineplus">+</span>
<a href="#l37.726"></a><span id="l37.726" class="difflineplus">+</span>
<a href="#l37.727"></a><span id="l37.727" class="difflineplus">+nsresult</span>
<a href="#l37.728"></a><span id="l37.728" class="difflineplus">+RDFXMLDataSourceImpl::rdfXMLFlush(nsIURI *aURI)</span>
<a href="#l37.729"></a><span id="l37.729" class="difflineplus">+{</span>
<a href="#l37.730"></a><span id="l37.730" class="difflineplus">+</span>
<a href="#l37.731"></a><span id="l37.731" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.732"></a><span id="l37.732" class="difflineplus">+</span>
<a href="#l37.733"></a><span id="l37.733" class="difflineplus">+    {</span>
<a href="#l37.734"></a><span id="l37.734" class="difflineplus">+        // Quick and dirty check to see if we're in XPCOM shutdown. If</span>
<a href="#l37.735"></a><span id="l37.735" class="difflineplus">+        // we are, we're screwed: it's too late to serialize because</span>
<a href="#l37.736"></a><span id="l37.736" class="difflineplus">+        // many of the services that we'll need to acquire to properly</span>
<a href="#l37.737"></a><span id="l37.737" class="difflineplus">+        // write the file will be unaquirable.</span>
<a href="#l37.738"></a><span id="l37.738" class="difflineplus">+        NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l37.739"></a><span id="l37.739" class="difflineplus">+        nsCOMPtr&lt;nsIRDFService&gt; dummy = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l37.740"></a><span id="l37.740" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l37.741"></a><span id="l37.741" class="difflineplus">+            NS_WARNING(&quot;unable to Flush() dirty datasource during XPCOM shutdown&quot;);</span>
<a href="#l37.742"></a><span id="l37.742" class="difflineplus">+            return rv;</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineplus">+        }</span>
<a href="#l37.744"></a><span id="l37.744" class="difflineplus">+    }</span>
<a href="#l37.745"></a><span id="l37.745" class="difflineplus">+</span>
<a href="#l37.746"></a><span id="l37.746" class="difflineplus">+    // Is it a file? If so, we can write to it. Some day, it'd be nice</span>
<a href="#l37.747"></a><span id="l37.747" class="difflineplus">+    // if we didn't care what kind of stream this was...</span>
<a href="#l37.748"></a><span id="l37.748" class="difflineplus">+    nsCOMPtr&lt;nsIFileURL&gt; fileURL = do_QueryInterface(aURI);</span>
<a href="#l37.749"></a><span id="l37.749" class="difflineplus">+</span>
<a href="#l37.750"></a><span id="l37.750" class="difflineplus">+    if (fileURL) {</span>
<a href="#l37.751"></a><span id="l37.751" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l37.752"></a><span id="l37.752" class="difflineplus">+        fileURL-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l37.753"></a><span id="l37.753" class="difflineplus">+        if (file) {</span>
<a href="#l37.754"></a><span id="l37.754" class="difflineplus">+            // get a safe output stream, so we don't clobber the datasource file unless</span>
<a href="#l37.755"></a><span id="l37.755" class="difflineplus">+            // all the writes succeeded.</span>
<a href="#l37.756"></a><span id="l37.756" class="difflineplus">+            nsCOMPtr&lt;nsIOutputStream&gt; out;</span>
<a href="#l37.757"></a><span id="l37.757" class="difflineplus">+            rv = NS_NewSafeLocalFileOutputStream(getter_AddRefs(out),</span>
<a href="#l37.758"></a><span id="l37.758" class="difflineplus">+                                                 file,</span>
<a href="#l37.759"></a><span id="l37.759" class="difflineplus">+                                                 PR_WRONLY | PR_CREATE_FILE,</span>
<a href="#l37.760"></a><span id="l37.760" class="difflineplus">+                                                 /*octal*/ 0666,</span>
<a href="#l37.761"></a><span id="l37.761" class="difflineplus">+                                                 0);</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.763"></a><span id="l37.763" class="difflineplus">+</span>
<a href="#l37.764"></a><span id="l37.764" class="difflineplus">+            nsCOMPtr&lt;nsIOutputStream&gt; bufferedOut;</span>
<a href="#l37.765"></a><span id="l37.765" class="difflineplus">+            rv = NS_NewBufferedOutputStream(getter_AddRefs(bufferedOut),</span>
<a href="#l37.766"></a><span id="l37.766" class="difflineplus">+                                            out.forget(), 4096);</span>
<a href="#l37.767"></a><span id="l37.767" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.768"></a><span id="l37.768" class="difflineplus">+</span>
<a href="#l37.769"></a><span id="l37.769" class="difflineplus">+            rv = Serialize(bufferedOut);</span>
<a href="#l37.770"></a><span id="l37.770" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.771"></a><span id="l37.771" class="difflineplus">+</span>
<a href="#l37.772"></a><span id="l37.772" class="difflineplus">+            // All went ok. Maybe except for problems in Write(), but the stream detects</span>
<a href="#l37.773"></a><span id="l37.773" class="difflineplus">+            // that for us</span>
<a href="#l37.774"></a><span id="l37.774" class="difflineplus">+            nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(bufferedOut, &amp;rv);</span>
<a href="#l37.775"></a><span id="l37.775" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.776"></a><span id="l37.776" class="difflineplus">+</span>
<a href="#l37.777"></a><span id="l37.777" class="difflineplus">+            rv = safeStream-&gt;Finish();</span>
<a href="#l37.778"></a><span id="l37.778" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l37.779"></a><span id="l37.779" class="difflineplus">+                NS_WARNING(&quot;failed to save datasource file! possible dataloss&quot;);</span>
<a href="#l37.780"></a><span id="l37.780" class="difflineplus">+                return rv;</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineplus">+            }</span>
<a href="#l37.782"></a><span id="l37.782" class="difflineplus">+        }</span>
<a href="#l37.783"></a><span id="l37.783" class="difflineplus">+    }</span>
<a href="#l37.784"></a><span id="l37.784" class="difflineplus">+</span>
<a href="#l37.785"></a><span id="l37.785" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.786"></a><span id="l37.786" class="difflineplus">+}</span>
<a href="#l37.787"></a><span id="l37.787" class="difflineplus">+</span>
<a href="#l37.788"></a><span id="l37.788" class="difflineplus">+</span>
<a href="#l37.789"></a><span id="l37.789" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.790"></a><span id="l37.790" class="difflineplus">+RDFXMLDataSourceImpl::FlushTo(const char *aURI)</span>
<a href="#l37.791"></a><span id="l37.791" class="difflineplus">+{</span>
<a href="#l37.792"></a><span id="l37.792" class="difflineplus">+    NS_PRECONDITION(aURI != nullptr, &quot;not initialized&quot;);</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineplus">+    if (!aURI)</span>
<a href="#l37.794"></a><span id="l37.794" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.795"></a><span id="l37.795" class="difflineplus">+</span>
<a href="#l37.796"></a><span id="l37.796" class="difflineplus">+    // XXX this is a hack: any &quot;file:&quot; URI is considered writable. All</span>
<a href="#l37.797"></a><span id="l37.797" class="difflineplus">+    // others are considered read-only.</span>
<a href="#l37.798"></a><span id="l37.798" class="difflineplus">+    if ((PL_strncmp(aURI, kFileURIPrefix, sizeof(kFileURIPrefix) - 1) != 0) &amp;&amp;</span>
<a href="#l37.799"></a><span id="l37.799" class="difflineplus">+        (PL_strncmp(aURI, kResourceURIPrefix, sizeof(kResourceURIPrefix) - 1) != 0))</span>
<a href="#l37.800"></a><span id="l37.800" class="difflineplus">+    {</span>
<a href="#l37.801"></a><span id="l37.801" class="difflineplus">+        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l37.802"></a><span id="l37.802" class="difflineplus">+    }</span>
<a href="#l37.803"></a><span id="l37.803" class="difflineplus">+</span>
<a href="#l37.804"></a><span id="l37.804" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt;  url;</span>
<a href="#l37.805"></a><span id="l37.805" class="difflineplus">+    nsresult rv = NS_NewURI(getter_AddRefs(url), aURI);</span>
<a href="#l37.806"></a><span id="l37.806" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l37.807"></a><span id="l37.807" class="difflineplus">+      return rv;</span>
<a href="#l37.808"></a><span id="l37.808" class="difflineplus">+    rv = rdfXMLFlush(url);</span>
<a href="#l37.809"></a><span id="l37.809" class="difflineplus">+    return rv;</span>
<a href="#l37.810"></a><span id="l37.810" class="difflineplus">+}</span>
<a href="#l37.811"></a><span id="l37.811" class="difflineplus">+</span>
<a href="#l37.812"></a><span id="l37.812" class="difflineplus">+</span>
<a href="#l37.813"></a><span id="l37.813" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.814"></a><span id="l37.814" class="difflineplus">+RDFXMLDataSourceImpl::Flush(void)</span>
<a href="#l37.815"></a><span id="l37.815" class="difflineplus">+{</span>
<a href="#l37.816"></a><span id="l37.816" class="difflineplus">+    if (!mIsWritable || !mIsDirty)</span>
<a href="#l37.817"></a><span id="l37.817" class="difflineplus">+        return NS_OK;</span>
<a href="#l37.818"></a><span id="l37.818" class="difflineplus">+</span>
<a href="#l37.819"></a><span id="l37.819" class="difflineplus">+    // while it is not fatal if mURL is not set,</span>
<a href="#l37.820"></a><span id="l37.820" class="difflineplus">+    // indicate failure since we can't flush back to an unknown origin</span>
<a href="#l37.821"></a><span id="l37.821" class="difflineplus">+    if (! mURL)</span>
<a href="#l37.822"></a><span id="l37.822" class="difflineplus">+        return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l37.823"></a><span id="l37.823" class="difflineplus">+</span>
<a href="#l37.824"></a><span id="l37.824" class="difflineplus">+    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l37.825"></a><span id="l37.825" class="difflineplus">+      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.826"></a><span id="l37.826" class="difflineplus">+              (&quot;rdfxml[%p] flush(%s)&quot;, this, mURL-&gt;GetSpecOrDefault().get()));</span>
<a href="#l37.827"></a><span id="l37.827" class="difflineplus">+    }</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineplus">+</span>
<a href="#l37.829"></a><span id="l37.829" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.830"></a><span id="l37.830" class="difflineplus">+    if (NS_SUCCEEDED(rv = rdfXMLFlush(mURL)))</span>
<a href="#l37.831"></a><span id="l37.831" class="difflineplus">+    {</span>
<a href="#l37.832"></a><span id="l37.832" class="difflineplus">+      mIsDirty = false;</span>
<a href="#l37.833"></a><span id="l37.833" class="difflineplus">+    }</span>
<a href="#l37.834"></a><span id="l37.834" class="difflineplus">+    return rv;</span>
<a href="#l37.835"></a><span id="l37.835" class="difflineplus">+}</span>
<a href="#l37.836"></a><span id="l37.836" class="difflineplus">+</span>
<a href="#l37.837"></a><span id="l37.837" class="difflineplus">+</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineplus">+//</span>
<a href="#l37.840"></a><span id="l37.840" class="difflineplus">+// nsIRDFXMLDataSource methods</span>
<a href="#l37.841"></a><span id="l37.841" class="difflineplus">+//</span>
<a href="#l37.842"></a><span id="l37.842" class="difflineplus">+</span>
<a href="#l37.843"></a><span id="l37.843" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.844"></a><span id="l37.844" class="difflineplus">+RDFXMLDataSourceImpl::GetReadOnly(bool* aIsReadOnly)</span>
<a href="#l37.845"></a><span id="l37.845" class="difflineplus">+{</span>
<a href="#l37.846"></a><span id="l37.846" class="difflineplus">+    *aIsReadOnly = !mIsWritable;</span>
<a href="#l37.847"></a><span id="l37.847" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.848"></a><span id="l37.848" class="difflineplus">+}</span>
<a href="#l37.849"></a><span id="l37.849" class="difflineplus">+</span>
<a href="#l37.850"></a><span id="l37.850" class="difflineplus">+</span>
<a href="#l37.851"></a><span id="l37.851" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.852"></a><span id="l37.852" class="difflineplus">+RDFXMLDataSourceImpl::SetReadOnly(bool aIsReadOnly)</span>
<a href="#l37.853"></a><span id="l37.853" class="difflineplus">+{</span>
<a href="#l37.854"></a><span id="l37.854" class="difflineplus">+    if (mIsWritable &amp;&amp; aIsReadOnly)</span>
<a href="#l37.855"></a><span id="l37.855" class="difflineplus">+        mIsWritable = false;</span>
<a href="#l37.856"></a><span id="l37.856" class="difflineplus">+</span>
<a href="#l37.857"></a><span id="l37.857" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineplus">+}</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineplus">+</span>
<a href="#l37.860"></a><span id="l37.860" class="difflineplus">+// nsIChannelEventSink</span>
<a href="#l37.861"></a><span id="l37.861" class="difflineplus">+</span>
<a href="#l37.862"></a><span id="l37.862" class="difflineplus">+// This code is copied from nsSameOriginChecker::OnChannelRedirect. See</span>
<a href="#l37.863"></a><span id="l37.863" class="difflineplus">+// bug 475940 on providing this code in a shared location.</span>
<a href="#l37.864"></a><span id="l37.864" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.865"></a><span id="l37.865" class="difflineplus">+RDFXMLDataSourceImpl::AsyncOnChannelRedirect(nsIChannel *aOldChannel,</span>
<a href="#l37.866"></a><span id="l37.866" class="difflineplus">+                                             nsIChannel *aNewChannel,</span>
<a href="#l37.867"></a><span id="l37.867" class="difflineplus">+                                             uint32_t aFlags,</span>
<a href="#l37.868"></a><span id="l37.868" class="difflineplus">+                                             nsIAsyncVerifyRedirectCallback *cb)</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineplus">+{</span>
<a href="#l37.870"></a><span id="l37.870" class="difflineplus">+    NS_PRECONDITION(aNewChannel, &quot;Redirecting to null channel?&quot;);</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineplus">+</span>
<a href="#l37.872"></a><span id="l37.872" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.873"></a><span id="l37.873" class="difflineplus">+    nsCOMPtr&lt;nsIScriptSecurityManager&gt; secMan =</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineplus">+        do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l37.875"></a><span id="l37.875" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.876"></a><span id="l37.876" class="difflineplus">+</span>
<a href="#l37.877"></a><span id="l37.877" class="difflineplus">+    nsCOMPtr&lt;nsIPrincipal&gt; oldPrincipal;</span>
<a href="#l37.878"></a><span id="l37.878" class="difflineplus">+    secMan-&gt;GetChannelResultPrincipal(aOldChannel, getter_AddRefs(oldPrincipal));</span>
<a href="#l37.879"></a><span id="l37.879" class="difflineplus">+</span>
<a href="#l37.880"></a><span id="l37.880" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; newURI;</span>
<a href="#l37.881"></a><span id="l37.881" class="difflineplus">+    aNewChannel-&gt;GetURI(getter_AddRefs(newURI));</span>
<a href="#l37.882"></a><span id="l37.882" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; newOriginalURI;</span>
<a href="#l37.883"></a><span id="l37.883" class="difflineplus">+    aNewChannel-&gt;GetOriginalURI(getter_AddRefs(newOriginalURI));</span>
<a href="#l37.884"></a><span id="l37.884" class="difflineplus">+</span>
<a href="#l37.885"></a><span id="l37.885" class="difflineplus">+    NS_ENSURE_STATE(oldPrincipal &amp;&amp; newURI &amp;&amp; newOriginalURI);</span>
<a href="#l37.886"></a><span id="l37.886" class="difflineplus">+</span>
<a href="#l37.887"></a><span id="l37.887" class="difflineplus">+    rv = oldPrincipal-&gt;CheckMayLoad(newURI, false, false);</span>
<a href="#l37.888"></a><span id="l37.888" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; newOriginalURI != newURI) {</span>
<a href="#l37.889"></a><span id="l37.889" class="difflineplus">+        rv = oldPrincipal-&gt;CheckMayLoad(newOriginalURI, false, false);</span>
<a href="#l37.890"></a><span id="l37.890" class="difflineplus">+    }</span>
<a href="#l37.891"></a><span id="l37.891" class="difflineplus">+</span>
<a href="#l37.892"></a><span id="l37.892" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l37.893"></a><span id="l37.893" class="difflineplus">+        return rv;</span>
<a href="#l37.894"></a><span id="l37.894" class="difflineplus">+</span>
<a href="#l37.895"></a><span id="l37.895" class="difflineplus">+    cb-&gt;OnRedirectVerifyCallback(NS_OK);</span>
<a href="#l37.896"></a><span id="l37.896" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.897"></a><span id="l37.897" class="difflineplus">+}</span>
<a href="#l37.898"></a><span id="l37.898" class="difflineplus">+</span>
<a href="#l37.899"></a><span id="l37.899" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.900"></a><span id="l37.900" class="difflineplus">+RDFXMLDataSourceImpl::Refresh(bool aBlocking)</span>
<a href="#l37.901"></a><span id="l37.901" class="difflineplus">+{</span>
<a href="#l37.902"></a><span id="l37.902" class="difflineplus">+    nsAutoCString spec;</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineplus">+    if (mURL) {</span>
<a href="#l37.904"></a><span id="l37.904" class="difflineplus">+        spec = mURL-&gt;GetSpecOrDefault();</span>
<a href="#l37.905"></a><span id="l37.905" class="difflineplus">+    }</span>
<a href="#l37.906"></a><span id="l37.906" class="difflineplus">+    MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.907"></a><span id="l37.907" class="difflineplus">+           (&quot;rdfxml[%p] refresh(%s) %sblocking&quot;, this, spec.get(), (aBlocking ? &quot;&quot; : &quot;non&quot;)));</span>
<a href="#l37.908"></a><span id="l37.908" class="difflineplus">+</span>
<a href="#l37.909"></a><span id="l37.909" class="difflineplus">+    // If an asynchronous load is already pending, then just let it do</span>
<a href="#l37.910"></a><span id="l37.910" class="difflineplus">+    // the honors.</span>
<a href="#l37.911"></a><span id="l37.911" class="difflineplus">+    if (IsLoading()) {</span>
<a href="#l37.912"></a><span id="l37.912" class="difflineplus">+        MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.913"></a><span id="l37.913" class="difflineplus">+               (&quot;rdfxml[%p] refresh(%s) a load was pending&quot;, this, spec.get()));</span>
<a href="#l37.914"></a><span id="l37.914" class="difflineplus">+</span>
<a href="#l37.915"></a><span id="l37.915" class="difflineplus">+        if (aBlocking) {</span>
<a href="#l37.916"></a><span id="l37.916" class="difflineplus">+            NS_WARNING(&quot;blocking load requested when async load pending&quot;);</span>
<a href="#l37.917"></a><span id="l37.917" class="difflineplus">+            return NS_ERROR_FAILURE;</span>
<a href="#l37.918"></a><span id="l37.918" class="difflineplus">+        }</span>
<a href="#l37.919"></a><span id="l37.919" class="difflineplus">+        else {</span>
<a href="#l37.920"></a><span id="l37.920" class="difflineplus">+            return NS_OK;</span>
<a href="#l37.921"></a><span id="l37.921" class="difflineplus">+        }</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineplus">+    }</span>
<a href="#l37.923"></a><span id="l37.923" class="difflineplus">+</span>
<a href="#l37.924"></a><span id="l37.924" class="difflineplus">+    if (! mURL)</span>
<a href="#l37.925"></a><span id="l37.925" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l37.926"></a><span id="l37.926" class="difflineplus">+    nsCOMPtr&lt;nsIRDFXMLParser&gt; parser = do_CreateInstance(&quot;@mozilla.org/rdf/xml-parser;1&quot;);</span>
<a href="#l37.927"></a><span id="l37.927" class="difflineplus">+    if (! parser)</span>
<a href="#l37.928"></a><span id="l37.928" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l37.929"></a><span id="l37.929" class="difflineplus">+</span>
<a href="#l37.930"></a><span id="l37.930" class="difflineplus">+    nsresult rv = parser-&gt;ParseAsync(this, mURL, getter_AddRefs(mListener));</span>
<a href="#l37.931"></a><span id="l37.931" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.932"></a><span id="l37.932" class="difflineplus">+</span>
<a href="#l37.933"></a><span id="l37.933" class="difflineplus">+    if (aBlocking) {</span>
<a href="#l37.934"></a><span id="l37.934" class="difflineplus">+        rv = BlockingParse(mURL, this);</span>
<a href="#l37.935"></a><span id="l37.935" class="difflineplus">+</span>
<a href="#l37.936"></a><span id="l37.936" class="difflineplus">+        mListener = nullptr; // release the parser</span>
<a href="#l37.937"></a><span id="l37.937" class="difflineplus">+</span>
<a href="#l37.938"></a><span id="l37.938" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.939"></a><span id="l37.939" class="difflineplus">+    }</span>
<a href="#l37.940"></a><span id="l37.940" class="difflineplus">+    else {</span>
<a href="#l37.941"></a><span id="l37.941" class="difflineplus">+        // Null LoadGroup ?</span>
<a href="#l37.942"></a><span id="l37.942" class="difflineplus">+        nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l37.943"></a><span id="l37.943" class="difflineplus">+        rv = NS_NewChannel(getter_AddRefs(channel),</span>
<a href="#l37.944"></a><span id="l37.944" class="difflineplus">+                           mURL,</span>
<a href="#l37.945"></a><span id="l37.945" class="difflineplus">+                           nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l37.946"></a><span id="l37.946" class="difflineplus">+                           nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l37.947"></a><span id="l37.947" class="difflineplus">+                           nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l37.948"></a><span id="l37.948" class="difflineplus">+                           nullptr, // aPerformanceStorage</span>
<a href="#l37.949"></a><span id="l37.949" class="difflineplus">+                           nullptr, // aLoadGroup</span>
<a href="#l37.950"></a><span id="l37.950" class="difflineplus">+                           this);   // aCallbacks</span>
<a href="#l37.951"></a><span id="l37.951" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.952"></a><span id="l37.952" class="difflineplus">+        rv = channel-&gt;AsyncOpen2(this);</span>
<a href="#l37.953"></a><span id="l37.953" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l37.954"></a><span id="l37.954" class="difflineplus">+</span>
<a href="#l37.955"></a><span id="l37.955" class="difflineplus">+        // So we don't try to issue two asynchronous loads at once.</span>
<a href="#l37.956"></a><span id="l37.956" class="difflineplus">+        mLoadState = eLoadState_Pending;</span>
<a href="#l37.957"></a><span id="l37.957" class="difflineplus">+    }</span>
<a href="#l37.958"></a><span id="l37.958" class="difflineplus">+</span>
<a href="#l37.959"></a><span id="l37.959" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.960"></a><span id="l37.960" class="difflineplus">+}</span>
<a href="#l37.961"></a><span id="l37.961" class="difflineplus">+</span>
<a href="#l37.962"></a><span id="l37.962" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.963"></a><span id="l37.963" class="difflineplus">+RDFXMLDataSourceImpl::BeginLoad(void)</span>
<a href="#l37.964"></a><span id="l37.964" class="difflineplus">+{</span>
<a href="#l37.965"></a><span id="l37.965" class="difflineplus">+    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l37.966"></a><span id="l37.966" class="difflineplus">+      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.967"></a><span id="l37.967" class="difflineplus">+              (&quot;rdfxml[%p] begin-load(%s)&quot;, this,</span>
<a href="#l37.968"></a><span id="l37.968" class="difflineplus">+               mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l37.969"></a><span id="l37.969" class="difflineplus">+    }</span>
<a href="#l37.970"></a><span id="l37.970" class="difflineplus">+</span>
<a href="#l37.971"></a><span id="l37.971" class="difflineplus">+    mLoadState = eLoadState_Loading;</span>
<a href="#l37.972"></a><span id="l37.972" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.973"></a><span id="l37.973" class="difflineplus">+        // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.974"></a><span id="l37.974" class="difflineplus">+        // that it doesn't go away in this call if it removes itself</span>
<a href="#l37.975"></a><span id="l37.975" class="difflineplus">+        // as an observer</span>
<a href="#l37.976"></a><span id="l37.976" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.977"></a><span id="l37.977" class="difflineplus">+</span>
<a href="#l37.978"></a><span id="l37.978" class="difflineplus">+        if (obs) {</span>
<a href="#l37.979"></a><span id="l37.979" class="difflineplus">+            obs-&gt;OnBeginLoad(this);</span>
<a href="#l37.980"></a><span id="l37.980" class="difflineplus">+        }</span>
<a href="#l37.981"></a><span id="l37.981" class="difflineplus">+    }</span>
<a href="#l37.982"></a><span id="l37.982" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.983"></a><span id="l37.983" class="difflineplus">+}</span>
<a href="#l37.984"></a><span id="l37.984" class="difflineplus">+</span>
<a href="#l37.985"></a><span id="l37.985" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.986"></a><span id="l37.986" class="difflineplus">+RDFXMLDataSourceImpl::Interrupt(void)</span>
<a href="#l37.987"></a><span id="l37.987" class="difflineplus">+{</span>
<a href="#l37.988"></a><span id="l37.988" class="difflineplus">+    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l37.989"></a><span id="l37.989" class="difflineplus">+      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.990"></a><span id="l37.990" class="difflineplus">+              (&quot;rdfxml[%p] interrupt(%s)&quot;, this,</span>
<a href="#l37.991"></a><span id="l37.991" class="difflineplus">+               mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l37.992"></a><span id="l37.992" class="difflineplus">+    }</span>
<a href="#l37.993"></a><span id="l37.993" class="difflineplus">+</span>
<a href="#l37.994"></a><span id="l37.994" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.995"></a><span id="l37.995" class="difflineplus">+        // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.996"></a><span id="l37.996" class="difflineplus">+        // that it doesn't go away in this call if it removes itself</span>
<a href="#l37.997"></a><span id="l37.997" class="difflineplus">+        // as an observer</span>
<a href="#l37.998"></a><span id="l37.998" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.999"></a><span id="l37.999" class="difflineplus">+</span>
<a href="#l37.1000"></a><span id="l37.1000" class="difflineplus">+        if (obs) {</span>
<a href="#l37.1001"></a><span id="l37.1001" class="difflineplus">+            obs-&gt;OnInterrupt(this);</span>
<a href="#l37.1002"></a><span id="l37.1002" class="difflineplus">+        }</span>
<a href="#l37.1003"></a><span id="l37.1003" class="difflineplus">+    }</span>
<a href="#l37.1004"></a><span id="l37.1004" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.1005"></a><span id="l37.1005" class="difflineplus">+}</span>
<a href="#l37.1006"></a><span id="l37.1006" class="difflineplus">+</span>
<a href="#l37.1007"></a><span id="l37.1007" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1008"></a><span id="l37.1008" class="difflineplus">+RDFXMLDataSourceImpl::Resume(void)</span>
<a href="#l37.1009"></a><span id="l37.1009" class="difflineplus">+{</span>
<a href="#l37.1010"></a><span id="l37.1010" class="difflineplus">+    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l37.1011"></a><span id="l37.1011" class="difflineplus">+      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.1012"></a><span id="l37.1012" class="difflineplus">+             (&quot;rdfxml[%p] resume(%s)&quot;, this,</span>
<a href="#l37.1013"></a><span id="l37.1013" class="difflineplus">+              mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l37.1014"></a><span id="l37.1014" class="difflineplus">+    }</span>
<a href="#l37.1015"></a><span id="l37.1015" class="difflineplus">+</span>
<a href="#l37.1016"></a><span id="l37.1016" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.1017"></a><span id="l37.1017" class="difflineplus">+        // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.1018"></a><span id="l37.1018" class="difflineplus">+        // that it doesn't go away in this call if it removes itself</span>
<a href="#l37.1019"></a><span id="l37.1019" class="difflineplus">+        // as an observer</span>
<a href="#l37.1020"></a><span id="l37.1020" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.1021"></a><span id="l37.1021" class="difflineplus">+</span>
<a href="#l37.1022"></a><span id="l37.1022" class="difflineplus">+        if (obs) {</span>
<a href="#l37.1023"></a><span id="l37.1023" class="difflineplus">+            obs-&gt;OnResume(this);</span>
<a href="#l37.1024"></a><span id="l37.1024" class="difflineplus">+        }</span>
<a href="#l37.1025"></a><span id="l37.1025" class="difflineplus">+    }</span>
<a href="#l37.1026"></a><span id="l37.1026" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.1027"></a><span id="l37.1027" class="difflineplus">+}</span>
<a href="#l37.1028"></a><span id="l37.1028" class="difflineplus">+</span>
<a href="#l37.1029"></a><span id="l37.1029" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1030"></a><span id="l37.1030" class="difflineplus">+RDFXMLDataSourceImpl::EndLoad(void)</span>
<a href="#l37.1031"></a><span id="l37.1031" class="difflineplus">+{</span>
<a href="#l37.1032"></a><span id="l37.1032" class="difflineplus">+    if (MOZ_LOG_TEST(gLog, LogLevel::Debug)) {</span>
<a href="#l37.1033"></a><span id="l37.1033" class="difflineplus">+      MOZ_LOG(gLog, LogLevel::Debug,</span>
<a href="#l37.1034"></a><span id="l37.1034" class="difflineplus">+              (&quot;rdfxml[%p] end-load(%s)&quot;, this,</span>
<a href="#l37.1035"></a><span id="l37.1035" class="difflineplus">+               mURL ? mURL-&gt;GetSpecOrDefault().get() : &quot;&quot;));</span>
<a href="#l37.1036"></a><span id="l37.1036" class="difflineplus">+    }</span>
<a href="#l37.1037"></a><span id="l37.1037" class="difflineplus">+</span>
<a href="#l37.1038"></a><span id="l37.1038" class="difflineplus">+    mLoadState = eLoadState_Loaded;</span>
<a href="#l37.1039"></a><span id="l37.1039" class="difflineplus">+</span>
<a href="#l37.1040"></a><span id="l37.1040" class="difflineplus">+    // Clear out any unmarked assertions from the datasource.</span>
<a href="#l37.1041"></a><span id="l37.1041" class="difflineplus">+    nsCOMPtr&lt;nsIRDFPurgeableDataSource&gt; gcable = do_QueryInterface(mInner);</span>
<a href="#l37.1042"></a><span id="l37.1042" class="difflineplus">+    if (gcable) {</span>
<a href="#l37.1043"></a><span id="l37.1043" class="difflineplus">+        gcable-&gt;Sweep();</span>
<a href="#l37.1044"></a><span id="l37.1044" class="difflineplus">+    }</span>
<a href="#l37.1045"></a><span id="l37.1045" class="difflineplus">+</span>
<a href="#l37.1046"></a><span id="l37.1046" class="difflineplus">+    // Notify load observers</span>
<a href="#l37.1047"></a><span id="l37.1047" class="difflineplus">+    for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.1048"></a><span id="l37.1048" class="difflineplus">+        // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.1049"></a><span id="l37.1049" class="difflineplus">+        // that it doesn't go away in this call if it removes itself</span>
<a href="#l37.1050"></a><span id="l37.1050" class="difflineplus">+        // as an observer</span>
<a href="#l37.1051"></a><span id="l37.1051" class="difflineplus">+        nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.1052"></a><span id="l37.1052" class="difflineplus">+</span>
<a href="#l37.1053"></a><span id="l37.1053" class="difflineplus">+        if (obs) {</span>
<a href="#l37.1054"></a><span id="l37.1054" class="difflineplus">+            obs-&gt;OnEndLoad(this);</span>
<a href="#l37.1055"></a><span id="l37.1055" class="difflineplus">+        }</span>
<a href="#l37.1056"></a><span id="l37.1056" class="difflineplus">+    }</span>
<a href="#l37.1057"></a><span id="l37.1057" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.1058"></a><span id="l37.1058" class="difflineplus">+}</span>
<a href="#l37.1059"></a><span id="l37.1059" class="difflineplus">+</span>
<a href="#l37.1060"></a><span id="l37.1060" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1061"></a><span id="l37.1061" class="difflineplus">+RDFXMLDataSourceImpl::AddNameSpace(nsAtom* aPrefix, const nsString&amp; aURI)</span>
<a href="#l37.1062"></a><span id="l37.1062" class="difflineplus">+{</span>
<a href="#l37.1063"></a><span id="l37.1063" class="difflineplus">+    mNameSpaces.Put(aURI, aPrefix);</span>
<a href="#l37.1064"></a><span id="l37.1064" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.1065"></a><span id="l37.1065" class="difflineplus">+}</span>
<a href="#l37.1066"></a><span id="l37.1066" class="difflineplus">+</span>
<a href="#l37.1067"></a><span id="l37.1067" class="difflineplus">+</span>
<a href="#l37.1068"></a><span id="l37.1068" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1069"></a><span id="l37.1069" class="difflineplus">+RDFXMLDataSourceImpl::AddXMLSinkObserver(nsIRDFXMLSinkObserver* aObserver)</span>
<a href="#l37.1070"></a><span id="l37.1070" class="difflineplus">+{</span>
<a href="#l37.1071"></a><span id="l37.1071" class="difflineplus">+    if (! aObserver)</span>
<a href="#l37.1072"></a><span id="l37.1072" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.1073"></a><span id="l37.1073" class="difflineplus">+</span>
<a href="#l37.1074"></a><span id="l37.1074" class="difflineplus">+    mObservers.AppendObject(aObserver);</span>
<a href="#l37.1075"></a><span id="l37.1075" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.1076"></a><span id="l37.1076" class="difflineplus">+}</span>
<a href="#l37.1077"></a><span id="l37.1077" class="difflineplus">+</span>
<a href="#l37.1078"></a><span id="l37.1078" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1079"></a><span id="l37.1079" class="difflineplus">+RDFXMLDataSourceImpl::RemoveXMLSinkObserver(nsIRDFXMLSinkObserver* aObserver)</span>
<a href="#l37.1080"></a><span id="l37.1080" class="difflineplus">+{</span>
<a href="#l37.1081"></a><span id="l37.1081" class="difflineplus">+    if (! aObserver)</span>
<a href="#l37.1082"></a><span id="l37.1082" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l37.1083"></a><span id="l37.1083" class="difflineplus">+</span>
<a href="#l37.1084"></a><span id="l37.1084" class="difflineplus">+    mObservers.RemoveObject(aObserver);</span>
<a href="#l37.1085"></a><span id="l37.1085" class="difflineplus">+</span>
<a href="#l37.1086"></a><span id="l37.1086" class="difflineplus">+    return NS_OK;</span>
<a href="#l37.1087"></a><span id="l37.1087" class="difflineplus">+}</span>
<a href="#l37.1088"></a><span id="l37.1088" class="difflineplus">+</span>
<a href="#l37.1089"></a><span id="l37.1089" class="difflineplus">+</span>
<a href="#l37.1090"></a><span id="l37.1090" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l37.1091"></a><span id="l37.1091" class="difflineplus">+//</span>
<a href="#l37.1092"></a><span id="l37.1092" class="difflineplus">+// nsIRequestObserver</span>
<a href="#l37.1093"></a><span id="l37.1093" class="difflineplus">+//</span>
<a href="#l37.1094"></a><span id="l37.1094" class="difflineplus">+</span>
<a href="#l37.1095"></a><span id="l37.1095" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1096"></a><span id="l37.1096" class="difflineplus">+RDFXMLDataSourceImpl::OnStartRequest(nsIRequest *request, nsISupports *ctxt)</span>
<a href="#l37.1097"></a><span id="l37.1097" class="difflineplus">+{</span>
<a href="#l37.1098"></a><span id="l37.1098" class="difflineplus">+    return mListener-&gt;OnStartRequest(request, ctxt);</span>
<a href="#l37.1099"></a><span id="l37.1099" class="difflineplus">+}</span>
<a href="#l37.1100"></a><span id="l37.1100" class="difflineplus">+</span>
<a href="#l37.1101"></a><span id="l37.1101" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1102"></a><span id="l37.1102" class="difflineplus">+RDFXMLDataSourceImpl::OnStopRequest(nsIRequest *request,</span>
<a href="#l37.1103"></a><span id="l37.1103" class="difflineplus">+                                    nsISupports *ctxt,</span>
<a href="#l37.1104"></a><span id="l37.1104" class="difflineplus">+                                    nsresult status)</span>
<a href="#l37.1105"></a><span id="l37.1105" class="difflineplus">+{</span>
<a href="#l37.1106"></a><span id="l37.1106" class="difflineplus">+    if (NS_FAILED(status)) {</span>
<a href="#l37.1107"></a><span id="l37.1107" class="difflineplus">+        for (int32_t i = mObservers.Count() - 1; i &gt;= 0; --i) {</span>
<a href="#l37.1108"></a><span id="l37.1108" class="difflineplus">+            // Make sure to hold a strong reference to the observer so</span>
<a href="#l37.1109"></a><span id="l37.1109" class="difflineplus">+            // that it doesn't go away in this call if it removes</span>
<a href="#l37.1110"></a><span id="l37.1110" class="difflineplus">+            // itself as an observer</span>
<a href="#l37.1111"></a><span id="l37.1111" class="difflineplus">+            nsCOMPtr&lt;nsIRDFXMLSinkObserver&gt; obs = mObservers[i];</span>
<a href="#l37.1112"></a><span id="l37.1112" class="difflineplus">+</span>
<a href="#l37.1113"></a><span id="l37.1113" class="difflineplus">+            if (obs) {</span>
<a href="#l37.1114"></a><span id="l37.1114" class="difflineplus">+                obs-&gt;OnError(this, status, nullptr);</span>
<a href="#l37.1115"></a><span id="l37.1115" class="difflineplus">+            }</span>
<a href="#l37.1116"></a><span id="l37.1116" class="difflineplus">+        }</span>
<a href="#l37.1117"></a><span id="l37.1117" class="difflineplus">+    }</span>
<a href="#l37.1118"></a><span id="l37.1118" class="difflineplus">+</span>
<a href="#l37.1119"></a><span id="l37.1119" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.1120"></a><span id="l37.1120" class="difflineplus">+    rv = mListener-&gt;OnStopRequest(request, ctxt, status);</span>
<a href="#l37.1121"></a><span id="l37.1121" class="difflineplus">+</span>
<a href="#l37.1122"></a><span id="l37.1122" class="difflineplus">+    mListener = nullptr; // release the parser</span>
<a href="#l37.1123"></a><span id="l37.1123" class="difflineplus">+</span>
<a href="#l37.1124"></a><span id="l37.1124" class="difflineplus">+    return rv;</span>
<a href="#l37.1125"></a><span id="l37.1125" class="difflineplus">+}</span>
<a href="#l37.1126"></a><span id="l37.1126" class="difflineplus">+</span>
<a href="#l37.1127"></a><span id="l37.1127" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l37.1128"></a><span id="l37.1128" class="difflineplus">+//</span>
<a href="#l37.1129"></a><span id="l37.1129" class="difflineplus">+// nsIStreamListener</span>
<a href="#l37.1130"></a><span id="l37.1130" class="difflineplus">+//</span>
<a href="#l37.1131"></a><span id="l37.1131" class="difflineplus">+</span>
<a href="#l37.1132"></a><span id="l37.1132" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1133"></a><span id="l37.1133" class="difflineplus">+RDFXMLDataSourceImpl::OnDataAvailable(nsIRequest *request,</span>
<a href="#l37.1134"></a><span id="l37.1134" class="difflineplus">+                                      nsISupports *ctxt,</span>
<a href="#l37.1135"></a><span id="l37.1135" class="difflineplus">+                                      nsIInputStream *inStr,</span>
<a href="#l37.1136"></a><span id="l37.1136" class="difflineplus">+                                      uint64_t sourceOffset,</span>
<a href="#l37.1137"></a><span id="l37.1137" class="difflineplus">+                                      uint32_t count)</span>
<a href="#l37.1138"></a><span id="l37.1138" class="difflineplus">+{</span>
<a href="#l37.1139"></a><span id="l37.1139" class="difflineplus">+    return mListener-&gt;OnDataAvailable(request, ctxt, inStr, sourceOffset, count);</span>
<a href="#l37.1140"></a><span id="l37.1140" class="difflineplus">+}</span>
<a href="#l37.1141"></a><span id="l37.1141" class="difflineplus">+</span>
<a href="#l37.1142"></a><span id="l37.1142" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l37.1143"></a><span id="l37.1143" class="difflineplus">+//</span>
<a href="#l37.1144"></a><span id="l37.1144" class="difflineplus">+// nsIRDFXMLSource</span>
<a href="#l37.1145"></a><span id="l37.1145" class="difflineplus">+//</span>
<a href="#l37.1146"></a><span id="l37.1146" class="difflineplus">+</span>
<a href="#l37.1147"></a><span id="l37.1147" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l37.1148"></a><span id="l37.1148" class="difflineplus">+RDFXMLDataSourceImpl::Serialize(nsIOutputStream* aStream)</span>
<a href="#l37.1149"></a><span id="l37.1149" class="difflineplus">+{</span>
<a href="#l37.1150"></a><span id="l37.1150" class="difflineplus">+    nsresult rv;</span>
<a href="#l37.1151"></a><span id="l37.1151" class="difflineplus">+    nsCOMPtr&lt;nsIRDFXMLSerializer&gt; serializer</span>
<a href="#l37.1152"></a><span id="l37.1152" class="difflineplus">+        = do_CreateInstance(&quot;@mozilla.org/rdf/xml-serializer;1&quot;, &amp;rv);</span>
<a href="#l37.1153"></a><span id="l37.1153" class="difflineplus">+</span>
<a href="#l37.1154"></a><span id="l37.1154" class="difflineplus">+    if (! serializer)</span>
<a href="#l37.1155"></a><span id="l37.1155" class="difflineplus">+        return rv;</span>
<a href="#l37.1156"></a><span id="l37.1156" class="difflineplus">+</span>
<a href="#l37.1157"></a><span id="l37.1157" class="difflineplus">+    rv = serializer-&gt;Init(this);</span>
<a href="#l37.1158"></a><span id="l37.1158" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l37.1159"></a><span id="l37.1159" class="difflineplus">+</span>
<a href="#l37.1160"></a><span id="l37.1160" class="difflineplus">+    // Add any namespace information that we picked up when reading</span>
<a href="#l37.1161"></a><span id="l37.1161" class="difflineplus">+    // the RDF/XML</span>
<a href="#l37.1162"></a><span id="l37.1162" class="difflineplus">+    nsNameSpaceMap::const_iterator last = mNameSpaces.last();</span>
<a href="#l37.1163"></a><span id="l37.1163" class="difflineplus">+    for (nsNameSpaceMap::const_iterator iter = mNameSpaces.first();</span>
<a href="#l37.1164"></a><span id="l37.1164" class="difflineplus">+         iter != last; ++iter) {</span>
<a href="#l37.1165"></a><span id="l37.1165" class="difflineplus">+        // We might wanna change nsIRDFXMLSerializer to nsACString and</span>
<a href="#l37.1166"></a><span id="l37.1166" class="difflineplus">+        // use a heap allocated buffer here in the future.</span>
<a href="#l37.1167"></a><span id="l37.1167" class="difflineplus">+        NS_ConvertUTF8toUTF16 uri(iter-&gt;mURI);</span>
<a href="#l37.1168"></a><span id="l37.1168" class="difflineplus">+        serializer-&gt;AddNameSpace(iter-&gt;mPrefix, uri);</span>
<a href="#l37.1169"></a><span id="l37.1169" class="difflineplus">+    }</span>
<a href="#l37.1170"></a><span id="l37.1170" class="difflineplus">+</span>
<a href="#l37.1171"></a><span id="l37.1171" class="difflineplus">+    // Serialize!</span>
<a href="#l37.1172"></a><span id="l37.1172" class="difflineplus">+    nsCOMPtr&lt;nsIRDFXMLSource&gt; source = do_QueryInterface(serializer);</span>
<a href="#l37.1173"></a><span id="l37.1173" class="difflineplus">+    if (! source)</span>
<a href="#l37.1174"></a><span id="l37.1174" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l37.1175"></a><span id="l37.1175" class="difflineplus">+</span>
<a href="#l37.1176"></a><span id="l37.1176" class="difflineplus">+    return source-&gt;Serialize(aStream);</span>
<a href="#l37.1177"></a><span id="l37.1177" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/rdf/base/nsRDFXMLParser.cpp</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,137 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+ *</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+#include &quot;nsRDFXMLParser.h&quot;</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+#include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+#include &quot;nsIParser.h&quot;</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+#include &quot;nsCharsetSource.h&quot;</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+#include &quot;nsIRDFContentSink.h&quot;</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+#include &quot;nsParserCIID.h&quot;</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+#include &quot;nsStringStream.h&quot;</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+#include &quot;NullPrincipal.h&quot;</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+static NS_DEFINE_CID(kParserCID, NS_PARSER_CID);</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+NS_IMPL_ISUPPORTS(nsRDFXMLParser, nsIRDFXMLParser)</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+nsresult</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+nsRDFXMLParser::Create(nsISupports* aOuter, REFNSIID aIID, void** aResult)</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+{</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+    if (aOuter)</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+        return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    nsRDFXMLParser* result = new nsRDFXMLParser();</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+    if (! result)</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+    nsresult rv;</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+    NS_ADDREF(result);</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+    rv = result-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+    NS_RELEASE(result);</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+    return rv;</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+}</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+nsRDFXMLParser::nsRDFXMLParser()</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+{</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+}</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+nsRDFXMLParser::~nsRDFXMLParser()</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+{</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+}</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+nsRDFXMLParser::ParseAsync(nsIRDFDataSource* aSink, nsIURI* aBaseURI, nsIStreamListener** aResult)</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+{</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+    nsresult rv;</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+    nsCOMPtr&lt;nsIRDFContentSink&gt; sink =</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+        do_CreateInstance(&quot;@mozilla.org/rdf/content-sink;1&quot;, &amp;rv);</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+    rv = sink-&gt;Init(aBaseURI);</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+    // We set the content sink's data source directly to our in-memory</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+    // store. This allows the initial content to be generated &quot;directly&quot;.</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+    rv = sink-&gt;SetDataSource(aSink);</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+    nsCOMPtr&lt;nsIParser&gt; parser = do_CreateInstance(kParserCID, &amp;rv);</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+    parser-&gt;SetDocumentCharset(UTF_8_ENCODING,</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+                               kCharsetFromDocTypeDefault);</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+    parser-&gt;SetContentSink(sink);</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+    rv = parser-&gt;Parse(aBaseURI);</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+    return CallQueryInterface(parser, aResult);</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+}</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+nsRDFXMLParser::ParseString(nsIRDFDataSource* aSink, nsIURI* aBaseURI, const nsACString&amp; aString)</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+{</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+    nsresult rv;</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+    nsCOMPtr&lt;nsIRDFContentSink&gt; sink =</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+        do_CreateInstance(&quot;@mozilla.org/rdf/content-sink;1&quot;, &amp;rv);</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+    rv = sink-&gt;Init(aBaseURI);</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+    // We set the content sink's data source directly to our in-memory</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+    // store. This allows the initial content to be generated &quot;directly&quot;.</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+    rv = sink-&gt;SetDataSource(aSink);</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+    nsCOMPtr&lt;nsIParser&gt; parser = do_CreateInstance(kParserCID, &amp;rv);</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+    parser-&gt;SetDocumentCharset(UTF_8_ENCODING,</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+                               kCharsetFromOtherComponent);</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+    parser-&gt;SetContentSink(sink);</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+    rv = parser-&gt;Parse(aBaseURI);</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; listener =</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+        do_QueryInterface(parser);</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+    if (! listener)</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+    nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+    rv = NS_NewCStringInputStream(getter_AddRefs(stream), aString);</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+    nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal = NullPrincipal::CreateWithoutOriginAttributes();</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+    // The following channel is never openend, so it does not matter what</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+    // securityFlags we pass; let's follow the principle of least privilege.</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineplus">+    nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+    nsCOMPtr&lt;nsIInputStream&gt; tmpStream = stream;</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+    rv = NS_NewInputStreamChannel(getter_AddRefs(channel),</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+                                  aBaseURI,</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+                                  tmpStream.forget(),</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineplus">+                                  nullPrincipal,</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+                                  nsILoadInfo::SEC_REQUIRE_SAME_ORIGIN_DATA_IS_BLOCKED,</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+                                  nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineplus">+                                  NS_LITERAL_CSTRING(&quot;text/xml&quot;));</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+    listener-&gt;OnStartRequest(channel, nullptr);</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+    listener-&gt;OnDataAvailable(channel, nullptr, stream, 0, aString.Length());</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+    listener-&gt;OnStopRequest(channel, nullptr, NS_OK);</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+    return NS_OK;</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/rdf/base/nsRDFXMLParser.h</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+ *</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+#ifndef nsRDFParser_h__</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+#define nsRDFParser_h__</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+#include &quot;nsIRDFXMLParser.h&quot;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+/**</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+ * A helper class that is used to parse RDF/XML.</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+ */</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+class nsRDFXMLParser : public nsIRDFXMLParser {</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+public:</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+    static nsresult</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+    Create(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+    NS_DECL_NSIRDFXMLPARSER</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+protected:</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+    nsRDFXMLParser();</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+    virtual ~nsRDFXMLParser();</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+};</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+#endif // nsRDFParser_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/rdf/base/nsRDFXMLSerializer.cpp</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,1123 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineplus">+ * vim: set ts=4 sw=4 et tw=80:</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+ *</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineplus">+</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+#include &quot;nsRDFXMLSerializer.h&quot;</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+#include &quot;nsAtom.h&quot;</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineplus">+</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+#include &quot;rdfIDataSource.h&quot;</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+int32_t nsRDFXMLSerializer::gRefCnt = 0;</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+nsIRDFContainerUtils* nsRDFXMLSerializer::gRDFC;</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+nsIRDFResource* nsRDFXMLSerializer::kRDF_instanceOf;</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+nsIRDFResource* nsRDFXMLSerializer::kRDF_type;</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+nsIRDFResource* nsRDFXMLSerializer::kRDF_nextVal;</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+nsIRDFResource* nsRDFXMLSerializer::kRDF_Bag;</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+nsIRDFResource* nsRDFXMLSerializer::kRDF_Seq;</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+nsIRDFResource* nsRDFXMLSerializer::kRDF_Alt;</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineplus">+</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+static const char kRDFDescriptionOpen[]      = &quot;  &lt;RDF:Description&quot;;</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+static const char kIDAttr[]                  = &quot; RDF:ID=\&quot;&quot;;</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+static const char kAboutAttr[]               = &quot; RDF:about=\&quot;&quot;;</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineplus">+static const char kRDFDescriptionClose[]     = &quot;  &lt;/RDF:Description&gt;\n&quot;;</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+static const char kRDFResource1[] = &quot; RDF:resource=\&quot;&quot;;</span>
<a href="#l40.41"></a><span id="l40.41" class="difflineplus">+static const char kRDFResource2[] = &quot;\&quot;/&gt;\n&quot;;</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineplus">+static const char kRDFParseTypeInteger[] = &quot; NC:parseType=\&quot;Integer\&quot;&gt;&quot;;</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+static const char kRDFParseTypeDate[] = &quot; NC:parseType=\&quot;Date\&quot;&gt;&quot;;</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+static const char kRDFUnknown[] = &quot;&gt;&lt;!-- unknown node type --&gt;&quot;;</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+nsresult</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+nsRDFXMLSerializer::Create(nsISupports* aOuter, REFNSIID aIID, void** aResult)</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+{</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+    if (aOuter)</span>
<a href="#l40.50"></a><span id="l40.50" class="difflineplus">+        return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineplus">+</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+    nsCOMPtr&lt;nsIRDFXMLSerializer&gt; result = new nsRDFXMLSerializer();</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+    if (! result)</span>
<a href="#l40.54"></a><span id="l40.54" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineplus">+    // The serializer object is here, addref gRefCnt so that the</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+    // destructor can safely release it.</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineplus">+    gRefCnt++;</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineplus">+</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineplus">+    rv = result-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+    if (gRefCnt == 1) do {</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+        nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;instanceOf&quot;),</span>
<a href="#l40.69"></a><span id="l40.69" class="difflineplus">+                              &amp;kRDF_instanceOf);</span>
<a href="#l40.70"></a><span id="l40.70" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineplus">+</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;type&quot;),</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+                              &amp;kRDF_type);</span>
<a href="#l40.74"></a><span id="l40.74" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineplus">+</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;nextVal&quot;),</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+                              &amp;kRDF_nextVal);</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Bag&quot;),</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineplus">+                              &amp;kRDF_Bag);</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineplus">+</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Seq&quot;),</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+                              &amp;kRDF_Seq);</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineplus">+        rv = rdf-&gt;GetResource(NS_LITERAL_CSTRING(RDF_NAMESPACE_URI &quot;Alt&quot;),</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineplus">+                              &amp;kRDF_Alt);</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineplus">+        rv = CallGetService(&quot;@mozilla.org/rdf/container-utils;1&quot;, &amp;gRDFC);</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineplus">+    } while (0);</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+    return rv;</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+}</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+nsRDFXMLSerializer::nsRDFXMLSerializer()</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+{</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+}</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+nsRDFXMLSerializer::~nsRDFXMLSerializer()</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+{</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+    if (--gRefCnt == 0) {</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineplus">+        NS_IF_RELEASE(kRDF_Bag);</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+        NS_IF_RELEASE(kRDF_Seq);</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+        NS_IF_RELEASE(kRDF_Alt);</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+        NS_IF_RELEASE(kRDF_instanceOf);</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+        NS_IF_RELEASE(kRDF_type);</span>
<a href="#l40.111"></a><span id="l40.111" class="difflineplus">+        NS_IF_RELEASE(kRDF_nextVal);</span>
<a href="#l40.112"></a><span id="l40.112" class="difflineplus">+        NS_IF_RELEASE(gRDFC);</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineplus">+    }</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineplus">+}</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+NS_IMPL_ISUPPORTS(nsRDFXMLSerializer, nsIRDFXMLSerializer, nsIRDFXMLSource)</span>
<a href="#l40.117"></a><span id="l40.117" class="difflineplus">+</span>
<a href="#l40.118"></a><span id="l40.118" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l40.119"></a><span id="l40.119" class="difflineplus">+nsRDFXMLSerializer::Init(nsIRDFDataSource* aDataSource)</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineplus">+{</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineplus">+    if (! aDataSource)</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l40.123"></a><span id="l40.123" class="difflineplus">+</span>
<a href="#l40.124"></a><span id="l40.124" class="difflineplus">+    mDataSource = aDataSource;</span>
<a href="#l40.125"></a><span id="l40.125" class="difflineplus">+    mDataSource-&gt;GetURI(mBaseURLSpec);</span>
<a href="#l40.126"></a><span id="l40.126" class="difflineplus">+</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineplus">+    // Add the ``RDF'' prefix, by default.</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+    RefPtr&lt;nsAtom&gt; prefix;</span>
<a href="#l40.129"></a><span id="l40.129" class="difflineplus">+</span>
<a href="#l40.130"></a><span id="l40.130" class="difflineplus">+    prefix = NS_Atomize(&quot;RDF&quot;);</span>
<a href="#l40.131"></a><span id="l40.131" class="difflineplus">+    AddNameSpace(prefix, NS_LITERAL_STRING(&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;));</span>
<a href="#l40.132"></a><span id="l40.132" class="difflineplus">+</span>
<a href="#l40.133"></a><span id="l40.133" class="difflineplus">+    prefix = NS_Atomize(&quot;NC&quot;);</span>
<a href="#l40.134"></a><span id="l40.134" class="difflineplus">+    AddNameSpace(prefix, NS_LITERAL_STRING(&quot;http://home.netscape.com/NC-rdf#&quot;));</span>
<a href="#l40.135"></a><span id="l40.135" class="difflineplus">+</span>
<a href="#l40.136"></a><span id="l40.136" class="difflineplus">+    mPrefixID = 0;</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineplus">+</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineplus">+}</span>
<a href="#l40.140"></a><span id="l40.140" class="difflineplus">+</span>
<a href="#l40.141"></a><span id="l40.141" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l40.142"></a><span id="l40.142" class="difflineplus">+nsRDFXMLSerializer::AddNameSpace(nsAtom* aPrefix, const nsAString&amp; aURI)</span>
<a href="#l40.143"></a><span id="l40.143" class="difflineplus">+{</span>
<a href="#l40.144"></a><span id="l40.144" class="difflineplus">+    RefPtr&lt;nsAtom&gt; prefix = aPrefix;</span>
<a href="#l40.145"></a><span id="l40.145" class="difflineplus">+    if (!prefix) {</span>
<a href="#l40.146"></a><span id="l40.146" class="difflineplus">+        // Make up a prefix, we don't want default namespaces, so</span>
<a href="#l40.147"></a><span id="l40.147" class="difflineplus">+        // that we can use QNames for elements and attributes alike.</span>
<a href="#l40.148"></a><span id="l40.148" class="difflineplus">+        prefix = EnsureNewPrefix();</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineplus">+    }</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+    mNameSpaces.Put(aURI, prefix);</span>
<a href="#l40.151"></a><span id="l40.151" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.152"></a><span id="l40.152" class="difflineplus">+}</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineplus">+</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+static nsresult</span>
<a href="#l40.155"></a><span id="l40.155" class="difflineplus">+rdf_BlockingWrite(nsIOutputStream* stream, const char* buf, uint32_t size)</span>
<a href="#l40.156"></a><span id="l40.156" class="difflineplus">+{</span>
<a href="#l40.157"></a><span id="l40.157" class="difflineplus">+    uint32_t written = 0;</span>
<a href="#l40.158"></a><span id="l40.158" class="difflineplus">+    uint32_t remaining = size;</span>
<a href="#l40.159"></a><span id="l40.159" class="difflineplus">+    while (remaining &gt; 0) {</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineplus">+        nsresult rv;</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineplus">+        uint32_t cb;</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineplus">+</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+        if (NS_FAILED(rv = stream-&gt;Write(buf + written, remaining, &amp;cb)))</span>
<a href="#l40.164"></a><span id="l40.164" class="difflineplus">+            return rv;</span>
<a href="#l40.165"></a><span id="l40.165" class="difflineplus">+</span>
<a href="#l40.166"></a><span id="l40.166" class="difflineplus">+        written += cb;</span>
<a href="#l40.167"></a><span id="l40.167" class="difflineplus">+        remaining -= cb;</span>
<a href="#l40.168"></a><span id="l40.168" class="difflineplus">+    }</span>
<a href="#l40.169"></a><span id="l40.169" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.170"></a><span id="l40.170" class="difflineplus">+}</span>
<a href="#l40.171"></a><span id="l40.171" class="difflineplus">+</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineplus">+static nsresult</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+rdf_BlockingWrite(nsIOutputStream* stream, const nsACString&amp; s)</span>
<a href="#l40.174"></a><span id="l40.174" class="difflineplus">+{</span>
<a href="#l40.175"></a><span id="l40.175" class="difflineplus">+    return rdf_BlockingWrite(stream, s.BeginReading(), s.Length());</span>
<a href="#l40.176"></a><span id="l40.176" class="difflineplus">+}</span>
<a href="#l40.177"></a><span id="l40.177" class="difflineplus">+</span>
<a href="#l40.178"></a><span id="l40.178" class="difflineplus">+static nsresult</span>
<a href="#l40.179"></a><span id="l40.179" class="difflineplus">+rdf_BlockingWrite(nsIOutputStream* stream, const nsAString&amp; s)</span>
<a href="#l40.180"></a><span id="l40.180" class="difflineplus">+{</span>
<a href="#l40.181"></a><span id="l40.181" class="difflineplus">+    NS_ConvertUTF16toUTF8 utf8(s);</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineplus">+    return rdf_BlockingWrite(stream, utf8.get(), utf8.Length());</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineplus">+}</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineplus">+</span>
<a href="#l40.185"></a><span id="l40.185" class="difflineplus">+already_AddRefed&lt;nsAtom&gt;</span>
<a href="#l40.186"></a><span id="l40.186" class="difflineplus">+nsRDFXMLSerializer::EnsureNewPrefix()</span>
<a href="#l40.187"></a><span id="l40.187" class="difflineplus">+{</span>
<a href="#l40.188"></a><span id="l40.188" class="difflineplus">+    nsAutoString qname;</span>
<a href="#l40.189"></a><span id="l40.189" class="difflineplus">+    RefPtr&lt;nsAtom&gt; prefix;</span>
<a href="#l40.190"></a><span id="l40.190" class="difflineplus">+    bool isNewPrefix;</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineplus">+    do {</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+        isNewPrefix = true;</span>
<a href="#l40.193"></a><span id="l40.193" class="difflineplus">+        qname.AssignLiteral(&quot;NS&quot;);</span>
<a href="#l40.194"></a><span id="l40.194" class="difflineplus">+        qname.AppendInt(++mPrefixID, 10);</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineplus">+        prefix = NS_Atomize(qname);</span>
<a href="#l40.196"></a><span id="l40.196" class="difflineplus">+        nsNameSpaceMap::const_iterator iter = mNameSpaces.first();</span>
<a href="#l40.197"></a><span id="l40.197" class="difflineplus">+        while (iter != mNameSpaces.last() &amp;&amp; isNewPrefix) {</span>
<a href="#l40.198"></a><span id="l40.198" class="difflineplus">+            isNewPrefix = (iter-&gt;mPrefix != prefix);</span>
<a href="#l40.199"></a><span id="l40.199" class="difflineplus">+            ++iter;</span>
<a href="#l40.200"></a><span id="l40.200" class="difflineplus">+        }</span>
<a href="#l40.201"></a><span id="l40.201" class="difflineplus">+    } while (!isNewPrefix);</span>
<a href="#l40.202"></a><span id="l40.202" class="difflineplus">+    return prefix.forget();</span>
<a href="#l40.203"></a><span id="l40.203" class="difflineplus">+}</span>
<a href="#l40.204"></a><span id="l40.204" class="difflineplus">+</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineplus">+// This converts a property resource (like</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+// &quot;http://www.w3.org/TR/WD-rdf-syntax#Description&quot;) into a QName</span>
<a href="#l40.207"></a><span id="l40.207" class="difflineplus">+// (&quot;RDF:Description&quot;), and registers the namespace, if it's made up.</span>
<a href="#l40.208"></a><span id="l40.208" class="difflineplus">+</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineplus">+nsresult</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineplus">+nsRDFXMLSerializer::RegisterQName(nsIRDFResource* aResource)</span>
<a href="#l40.211"></a><span id="l40.211" class="difflineplus">+{</span>
<a href="#l40.212"></a><span id="l40.212" class="difflineplus">+    nsAutoCString uri, qname;</span>
<a href="#l40.213"></a><span id="l40.213" class="difflineplus">+    aResource-&gt;GetValueUTF8(uri);</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineplus">+</span>
<a href="#l40.215"></a><span id="l40.215" class="difflineplus">+    nsNameSpaceMap::const_iterator iter = mNameSpaces.GetNameSpaceOf(uri);</span>
<a href="#l40.216"></a><span id="l40.216" class="difflineplus">+    if (iter != mNameSpaces.last()) {</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineplus">+        NS_ENSURE_TRUE(iter-&gt;mPrefix, NS_ERROR_UNEXPECTED);</span>
<a href="#l40.218"></a><span id="l40.218" class="difflineplus">+        iter-&gt;mPrefix-&gt;ToUTF8String(qname);</span>
<a href="#l40.219"></a><span id="l40.219" class="difflineplus">+        qname.Append(':');</span>
<a href="#l40.220"></a><span id="l40.220" class="difflineplus">+        qname += StringTail(uri, uri.Length() - iter-&gt;mURI.Length());</span>
<a href="#l40.221"></a><span id="l40.221" class="difflineplus">+        mQNames.Put(aResource, qname);</span>
<a href="#l40.222"></a><span id="l40.222" class="difflineplus">+        return NS_OK;</span>
<a href="#l40.223"></a><span id="l40.223" class="difflineplus">+    }</span>
<a href="#l40.224"></a><span id="l40.224" class="difflineplus">+</span>
<a href="#l40.225"></a><span id="l40.225" class="difflineplus">+    // Okay, so we don't have it in our map. Try to make one up. This</span>
<a href="#l40.226"></a><span id="l40.226" class="difflineplus">+    // is very bogus.</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineplus">+    int32_t i = uri.RFindChar('#'); // first try a '#'</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineplus">+    if (i == -1) {</span>
<a href="#l40.229"></a><span id="l40.229" class="difflineplus">+        i = uri.RFindChar('/');</span>
<a href="#l40.230"></a><span id="l40.230" class="difflineplus">+        if (i == -1) {</span>
<a href="#l40.231"></a><span id="l40.231" class="difflineplus">+            // Okay, just punt and assume there is _no_ namespace on</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineplus">+            // this thing...</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineplus">+            mQNames.Put(aResource, uri);</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineplus">+            return NS_OK;</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+        }</span>
<a href="#l40.236"></a><span id="l40.236" class="difflineplus">+    }</span>
<a href="#l40.237"></a><span id="l40.237" class="difflineplus">+</span>
<a href="#l40.238"></a><span id="l40.238" class="difflineplus">+    // Take whatever is to the right of the '#' or '/' and call it the</span>
<a href="#l40.239"></a><span id="l40.239" class="difflineplus">+    // local name, make up a prefix.</span>
<a href="#l40.240"></a><span id="l40.240" class="difflineplus">+    RefPtr&lt;nsAtom&gt; prefix = EnsureNewPrefix();</span>
<a href="#l40.241"></a><span id="l40.241" class="difflineplus">+    mNameSpaces.Put(StringHead(uri, i+1), prefix);</span>
<a href="#l40.242"></a><span id="l40.242" class="difflineplus">+    prefix-&gt;ToUTF8String(qname);</span>
<a href="#l40.243"></a><span id="l40.243" class="difflineplus">+    qname.Append(':');</span>
<a href="#l40.244"></a><span id="l40.244" class="difflineplus">+    qname += StringTail(uri, uri.Length() - (i + 1));</span>
<a href="#l40.245"></a><span id="l40.245" class="difflineplus">+</span>
<a href="#l40.246"></a><span id="l40.246" class="difflineplus">+    mQNames.Put(aResource, qname);</span>
<a href="#l40.247"></a><span id="l40.247" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.248"></a><span id="l40.248" class="difflineplus">+}</span>
<a href="#l40.249"></a><span id="l40.249" class="difflineplus">+</span>
<a href="#l40.250"></a><span id="l40.250" class="difflineplus">+nsresult</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineplus">+nsRDFXMLSerializer::GetQName(nsIRDFResource* aResource, nsCString&amp; aQName)</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineplus">+{</span>
<a href="#l40.253"></a><span id="l40.253" class="difflineplus">+    return mQNames.Get(aResource, &amp;aQName) ? NS_OK : NS_ERROR_UNEXPECTED;</span>
<a href="#l40.254"></a><span id="l40.254" class="difflineplus">+}</span>
<a href="#l40.255"></a><span id="l40.255" class="difflineplus">+</span>
<a href="#l40.256"></a><span id="l40.256" class="difflineplus">+bool</span>
<a href="#l40.257"></a><span id="l40.257" class="difflineplus">+nsRDFXMLSerializer::IsContainerProperty(nsIRDFResource* aProperty)</span>
<a href="#l40.258"></a><span id="l40.258" class="difflineplus">+{</span>
<a href="#l40.259"></a><span id="l40.259" class="difflineplus">+    // Return `true' if the property is an internal property related</span>
<a href="#l40.260"></a><span id="l40.260" class="difflineplus">+    // to being a container.</span>
<a href="#l40.261"></a><span id="l40.261" class="difflineplus">+    if (aProperty == kRDF_instanceOf)</span>
<a href="#l40.262"></a><span id="l40.262" class="difflineplus">+        return true;</span>
<a href="#l40.263"></a><span id="l40.263" class="difflineplus">+</span>
<a href="#l40.264"></a><span id="l40.264" class="difflineplus">+    if (aProperty == kRDF_nextVal)</span>
<a href="#l40.265"></a><span id="l40.265" class="difflineplus">+        return true;</span>
<a href="#l40.266"></a><span id="l40.266" class="difflineplus">+</span>
<a href="#l40.267"></a><span id="l40.267" class="difflineplus">+    bool isOrdinal = false;</span>
<a href="#l40.268"></a><span id="l40.268" class="difflineplus">+    gRDFC-&gt;IsOrdinalProperty(aProperty, &amp;isOrdinal);</span>
<a href="#l40.269"></a><span id="l40.269" class="difflineplus">+    if (isOrdinal)</span>
<a href="#l40.270"></a><span id="l40.270" class="difflineplus">+        return true;</span>
<a href="#l40.271"></a><span id="l40.271" class="difflineplus">+</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineplus">+    return false;</span>
<a href="#l40.273"></a><span id="l40.273" class="difflineplus">+}</span>
<a href="#l40.274"></a><span id="l40.274" class="difflineplus">+</span>
<a href="#l40.275"></a><span id="l40.275" class="difflineplus">+</span>
<a href="#l40.276"></a><span id="l40.276" class="difflineplus">+// convert '&amp;', '&lt;', and '&gt;' into &quot;&amp;amp;&quot;, &quot;&amp;lt;&quot;, and &quot;&amp;gt&quot;, respectively.</span>
<a href="#l40.277"></a><span id="l40.277" class="difflineplus">+static const char amp[] = &quot;&amp;amp;&quot;;</span>
<a href="#l40.278"></a><span id="l40.278" class="difflineplus">+static const char lt[] = &quot;&amp;lt;&quot;;</span>
<a href="#l40.279"></a><span id="l40.279" class="difflineplus">+static const char gt[] = &quot;&amp;gt;&quot;;</span>
<a href="#l40.280"></a><span id="l40.280" class="difflineplus">+static const char quot[] = &quot;&amp;quot;&quot;;</span>
<a href="#l40.281"></a><span id="l40.281" class="difflineplus">+</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineplus">+static void</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineplus">+rdf_EscapeAmpersandsAndAngleBrackets(nsCString&amp; s)</span>
<a href="#l40.284"></a><span id="l40.284" class="difflineplus">+{</span>
<a href="#l40.285"></a><span id="l40.285" class="difflineplus">+    uint32_t newLength, origLength;</span>
<a href="#l40.286"></a><span id="l40.286" class="difflineplus">+    newLength = origLength = s.Length();</span>
<a href="#l40.287"></a><span id="l40.287" class="difflineplus">+</span>
<a href="#l40.288"></a><span id="l40.288" class="difflineplus">+    // Compute the length of the result string.</span>
<a href="#l40.289"></a><span id="l40.289" class="difflineplus">+    const char* start = s.BeginReading();</span>
<a href="#l40.290"></a><span id="l40.290" class="difflineplus">+    const char* end = s.EndReading();</span>
<a href="#l40.291"></a><span id="l40.291" class="difflineplus">+    const char* c = start;</span>
<a href="#l40.292"></a><span id="l40.292" class="difflineplus">+    while (c != end) {</span>
<a href="#l40.293"></a><span id="l40.293" class="difflineplus">+        switch (*c) {</span>
<a href="#l40.294"></a><span id="l40.294" class="difflineplus">+        case '&amp;' :</span>
<a href="#l40.295"></a><span id="l40.295" class="difflineplus">+            newLength += sizeof(amp) - 2;</span>
<a href="#l40.296"></a><span id="l40.296" class="difflineplus">+            break;</span>
<a href="#l40.297"></a><span id="l40.297" class="difflineplus">+        case '&lt;':</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineplus">+        case '&gt;':</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+            newLength += sizeof(gt) - 2;</span>
<a href="#l40.300"></a><span id="l40.300" class="difflineplus">+            break;</span>
<a href="#l40.301"></a><span id="l40.301" class="difflineplus">+        default:</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineplus">+            break;</span>
<a href="#l40.303"></a><span id="l40.303" class="difflineplus">+        }</span>
<a href="#l40.304"></a><span id="l40.304" class="difflineplus">+        ++c;</span>
<a href="#l40.305"></a><span id="l40.305" class="difflineplus">+    }</span>
<a href="#l40.306"></a><span id="l40.306" class="difflineplus">+    if (newLength == origLength) {</span>
<a href="#l40.307"></a><span id="l40.307" class="difflineplus">+        // nothing to escape</span>
<a href="#l40.308"></a><span id="l40.308" class="difflineplus">+        return;</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineplus">+    }</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineplus">+</span>
<a href="#l40.311"></a><span id="l40.311" class="difflineplus">+    // escape the chars from the end back to the front.</span>
<a href="#l40.312"></a><span id="l40.312" class="difflineplus">+    s.SetLength(newLength);</span>
<a href="#l40.313"></a><span id="l40.313" class="difflineplus">+</span>
<a href="#l40.314"></a><span id="l40.314" class="difflineplus">+    // Buffer might have changed, get the pointers again</span>
<a href="#l40.315"></a><span id="l40.315" class="difflineplus">+    start = s.BeginReading(); // begin of string</span>
<a href="#l40.316"></a><span id="l40.316" class="difflineplus">+    c = start + origLength - 1; // last char in original string</span>
<a href="#l40.317"></a><span id="l40.317" class="difflineplus">+    char* w = s.EndWriting() - 1; // last char in grown buffer</span>
<a href="#l40.318"></a><span id="l40.318" class="difflineplus">+    while (c &gt;= start) {</span>
<a href="#l40.319"></a><span id="l40.319" class="difflineplus">+        switch (*c) {</span>
<a href="#l40.320"></a><span id="l40.320" class="difflineplus">+        case '&amp;' :</span>
<a href="#l40.321"></a><span id="l40.321" class="difflineplus">+            w -= 4;</span>
<a href="#l40.322"></a><span id="l40.322" class="difflineplus">+            nsCharTraits&lt;char&gt;::copy(w, amp, sizeof(amp) - 1);</span>
<a href="#l40.323"></a><span id="l40.323" class="difflineplus">+            break;</span>
<a href="#l40.324"></a><span id="l40.324" class="difflineplus">+        case '&lt;':</span>
<a href="#l40.325"></a><span id="l40.325" class="difflineplus">+            w -= 3;</span>
<a href="#l40.326"></a><span id="l40.326" class="difflineplus">+            nsCharTraits&lt;char&gt;::copy(w, lt, sizeof(lt) - 1);</span>
<a href="#l40.327"></a><span id="l40.327" class="difflineplus">+            break;</span>
<a href="#l40.328"></a><span id="l40.328" class="difflineplus">+        case '&gt;':</span>
<a href="#l40.329"></a><span id="l40.329" class="difflineplus">+            w -= 3;</span>
<a href="#l40.330"></a><span id="l40.330" class="difflineplus">+            nsCharTraits&lt;char&gt;::copy(w, gt, sizeof(gt) - 1);</span>
<a href="#l40.331"></a><span id="l40.331" class="difflineplus">+            break;</span>
<a href="#l40.332"></a><span id="l40.332" class="difflineplus">+        default:</span>
<a href="#l40.333"></a><span id="l40.333" class="difflineplus">+            *w = *c;</span>
<a href="#l40.334"></a><span id="l40.334" class="difflineplus">+        }</span>
<a href="#l40.335"></a><span id="l40.335" class="difflineplus">+        --w;</span>
<a href="#l40.336"></a><span id="l40.336" class="difflineplus">+        --c;</span>
<a href="#l40.337"></a><span id="l40.337" class="difflineplus">+    }</span>
<a href="#l40.338"></a><span id="l40.338" class="difflineplus">+}</span>
<a href="#l40.339"></a><span id="l40.339" class="difflineplus">+</span>
<a href="#l40.340"></a><span id="l40.340" class="difflineplus">+// convert '&quot;' to &quot;&amp;quot;&quot;</span>
<a href="#l40.341"></a><span id="l40.341" class="difflineplus">+static void</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineplus">+rdf_EscapeQuotes(nsCString&amp; s)</span>
<a href="#l40.343"></a><span id="l40.343" class="difflineplus">+{</span>
<a href="#l40.344"></a><span id="l40.344" class="difflineplus">+    int32_t i = 0;</span>
<a href="#l40.345"></a><span id="l40.345" class="difflineplus">+    while ((i = s.FindChar('&quot;', i)) != -1) {</span>
<a href="#l40.346"></a><span id="l40.346" class="difflineplus">+        s.Replace(i, 1, quot, sizeof(quot) - 1);</span>
<a href="#l40.347"></a><span id="l40.347" class="difflineplus">+        i += sizeof(quot) - 2;</span>
<a href="#l40.348"></a><span id="l40.348" class="difflineplus">+    }</span>
<a href="#l40.349"></a><span id="l40.349" class="difflineplus">+}</span>
<a href="#l40.350"></a><span id="l40.350" class="difflineplus">+</span>
<a href="#l40.351"></a><span id="l40.351" class="difflineplus">+static void</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineplus">+rdf_EscapeAttributeValue(nsCString&amp; s)</span>
<a href="#l40.353"></a><span id="l40.353" class="difflineplus">+{</span>
<a href="#l40.354"></a><span id="l40.354" class="difflineplus">+    rdf_EscapeAmpersandsAndAngleBrackets(s);</span>
<a href="#l40.355"></a><span id="l40.355" class="difflineplus">+    rdf_EscapeQuotes(s);</span>
<a href="#l40.356"></a><span id="l40.356" class="difflineplus">+}</span>
<a href="#l40.357"></a><span id="l40.357" class="difflineplus">+</span>
<a href="#l40.358"></a><span id="l40.358" class="difflineplus">+</span>
<a href="#l40.359"></a><span id="l40.359" class="difflineplus">+nsresult</span>
<a href="#l40.360"></a><span id="l40.360" class="difflineplus">+nsRDFXMLSerializer::SerializeInlineAssertion(nsIOutputStream* aStream,</span>
<a href="#l40.361"></a><span id="l40.361" class="difflineplus">+                                             nsIRDFResource* aResource,</span>
<a href="#l40.362"></a><span id="l40.362" class="difflineplus">+                                             nsIRDFResource* aProperty,</span>
<a href="#l40.363"></a><span id="l40.363" class="difflineplus">+                                             nsIRDFLiteral* aValue)</span>
<a href="#l40.364"></a><span id="l40.364" class="difflineplus">+{</span>
<a href="#l40.365"></a><span id="l40.365" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.366"></a><span id="l40.366" class="difflineplus">+    nsCString qname;</span>
<a href="#l40.367"></a><span id="l40.367" class="difflineplus">+    rv = GetQName(aProperty, qname);</span>
<a href="#l40.368"></a><span id="l40.368" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.369"></a><span id="l40.369" class="difflineplus">+</span>
<a href="#l40.370"></a><span id="l40.370" class="difflineplus">+    rv = rdf_BlockingWrite(aStream,</span>
<a href="#l40.371"></a><span id="l40.371" class="difflineplus">+                           NS_LITERAL_CSTRING(&quot;\n                   &quot;));</span>
<a href="#l40.372"></a><span id="l40.372" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.373"></a><span id="l40.373" class="difflineplus">+</span>
<a href="#l40.374"></a><span id="l40.374" class="difflineplus">+    const char16_t* value;</span>
<a href="#l40.375"></a><span id="l40.375" class="difflineplus">+    aValue-&gt;GetValueConst(&amp;value);</span>
<a href="#l40.376"></a><span id="l40.376" class="difflineplus">+    NS_ConvertUTF16toUTF8 s(value);</span>
<a href="#l40.377"></a><span id="l40.377" class="difflineplus">+</span>
<a href="#l40.378"></a><span id="l40.378" class="difflineplus">+    rdf_EscapeAttributeValue(s);</span>
<a href="#l40.379"></a><span id="l40.379" class="difflineplus">+</span>
<a href="#l40.380"></a><span id="l40.380" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, qname);</span>
<a href="#l40.381"></a><span id="l40.381" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.382"></a><span id="l40.382" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, &quot;=\&quot;&quot;, 2);</span>
<a href="#l40.383"></a><span id="l40.383" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.384"></a><span id="l40.384" class="difflineplus">+    s.Append('&quot;');</span>
<a href="#l40.385"></a><span id="l40.385" class="difflineplus">+    return rdf_BlockingWrite(aStream, s);</span>
<a href="#l40.386"></a><span id="l40.386" class="difflineplus">+}</span>
<a href="#l40.387"></a><span id="l40.387" class="difflineplus">+</span>
<a href="#l40.388"></a><span id="l40.388" class="difflineplus">+nsresult</span>
<a href="#l40.389"></a><span id="l40.389" class="difflineplus">+nsRDFXMLSerializer::SerializeChildAssertion(nsIOutputStream* aStream,</span>
<a href="#l40.390"></a><span id="l40.390" class="difflineplus">+                                            nsIRDFResource* aResource,</span>
<a href="#l40.391"></a><span id="l40.391" class="difflineplus">+                                            nsIRDFResource* aProperty,</span>
<a href="#l40.392"></a><span id="l40.392" class="difflineplus">+                                            nsIRDFNode* aValue)</span>
<a href="#l40.393"></a><span id="l40.393" class="difflineplus">+{</span>
<a href="#l40.394"></a><span id="l40.394" class="difflineplus">+    nsCString qname;</span>
<a href="#l40.395"></a><span id="l40.395" class="difflineplus">+    nsresult rv = GetQName(aProperty, qname);</span>
<a href="#l40.396"></a><span id="l40.396" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l40.397"></a><span id="l40.397" class="difflineplus">+</span>
<a href="#l40.398"></a><span id="l40.398" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, &quot;    &lt;&quot;, 5);</span>
<a href="#l40.399"></a><span id="l40.399" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.400"></a><span id="l40.400" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, qname);</span>
<a href="#l40.401"></a><span id="l40.401" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.402"></a><span id="l40.402" class="difflineplus">+</span>
<a href="#l40.403"></a><span id="l40.403" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l40.404"></a><span id="l40.404" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l40.405"></a><span id="l40.405" class="difflineplus">+    nsCOMPtr&lt;nsIRDFInt&gt; number;</span>
<a href="#l40.406"></a><span id="l40.406" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDate&gt; date;</span>
<a href="#l40.407"></a><span id="l40.407" class="difflineplus">+</span>
<a href="#l40.408"></a><span id="l40.408" class="difflineplus">+    if ((resource = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l40.409"></a><span id="l40.409" class="difflineplus">+        nsAutoCString uri;</span>
<a href="#l40.410"></a><span id="l40.410" class="difflineplus">+        resource-&gt;GetValueUTF8(uri);</span>
<a href="#l40.411"></a><span id="l40.411" class="difflineplus">+</span>
<a href="#l40.412"></a><span id="l40.412" class="difflineplus">+        rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l40.413"></a><span id="l40.413" class="difflineplus">+        rdf_EscapeAttributeValue(uri);</span>
<a href="#l40.414"></a><span id="l40.414" class="difflineplus">+</span>
<a href="#l40.415"></a><span id="l40.415" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFResource1,</span>
<a href="#l40.416"></a><span id="l40.416" class="difflineplus">+                               sizeof(kRDFResource1) - 1);</span>
<a href="#l40.417"></a><span id="l40.417" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.418"></a><span id="l40.418" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l40.419"></a><span id="l40.419" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.420"></a><span id="l40.420" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFResource2,</span>
<a href="#l40.421"></a><span id="l40.421" class="difflineplus">+                               sizeof(kRDFResource2) - 1);</span>
<a href="#l40.422"></a><span id="l40.422" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.423"></a><span id="l40.423" class="difflineplus">+</span>
<a href="#l40.424"></a><span id="l40.424" class="difflineplus">+        goto no_close_tag;</span>
<a href="#l40.425"></a><span id="l40.425" class="difflineplus">+    }</span>
<a href="#l40.426"></a><span id="l40.426" class="difflineplus">+    else if ((literal = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l40.427"></a><span id="l40.427" class="difflineplus">+        const char16_t *value;</span>
<a href="#l40.428"></a><span id="l40.428" class="difflineplus">+        literal-&gt;GetValueConst(&amp;value);</span>
<a href="#l40.429"></a><span id="l40.429" class="difflineplus">+        NS_ConvertUTF16toUTF8 s(value);</span>
<a href="#l40.430"></a><span id="l40.430" class="difflineplus">+</span>
<a href="#l40.431"></a><span id="l40.431" class="difflineplus">+        rdf_EscapeAmpersandsAndAngleBrackets(s);</span>
<a href="#l40.432"></a><span id="l40.432" class="difflineplus">+</span>
<a href="#l40.433"></a><span id="l40.433" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, &quot;&gt;&quot;, 1);</span>
<a href="#l40.434"></a><span id="l40.434" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.435"></a><span id="l40.435" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l40.436"></a><span id="l40.436" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.437"></a><span id="l40.437" class="difflineplus">+    }</span>
<a href="#l40.438"></a><span id="l40.438" class="difflineplus">+    else if ((number = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l40.439"></a><span id="l40.439" class="difflineplus">+        int32_t value;</span>
<a href="#l40.440"></a><span id="l40.440" class="difflineplus">+        number-&gt;GetValue(&amp;value);</span>
<a href="#l40.441"></a><span id="l40.441" class="difflineplus">+</span>
<a href="#l40.442"></a><span id="l40.442" class="difflineplus">+        nsAutoCString n;</span>
<a href="#l40.443"></a><span id="l40.443" class="difflineplus">+        n.AppendInt(value);</span>
<a href="#l40.444"></a><span id="l40.444" class="difflineplus">+</span>
<a href="#l40.445"></a><span id="l40.445" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFParseTypeInteger,</span>
<a href="#l40.446"></a><span id="l40.446" class="difflineplus">+                               sizeof(kRDFParseTypeInteger) - 1);</span>
<a href="#l40.447"></a><span id="l40.447" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.448"></a><span id="l40.448" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, n);</span>
<a href="#l40.449"></a><span id="l40.449" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.450"></a><span id="l40.450" class="difflineplus">+    }</span>
<a href="#l40.451"></a><span id="l40.451" class="difflineplus">+    else if ((date = do_QueryInterface(aValue)) != nullptr) {</span>
<a href="#l40.452"></a><span id="l40.452" class="difflineplus">+        PRTime value;</span>
<a href="#l40.453"></a><span id="l40.453" class="difflineplus">+        date-&gt;GetValue(&amp;value);</span>
<a href="#l40.454"></a><span id="l40.454" class="difflineplus">+</span>
<a href="#l40.455"></a><span id="l40.455" class="difflineplus">+        nsAutoCString s;</span>
<a href="#l40.456"></a><span id="l40.456" class="difflineplus">+        rdf_FormatDate(value, s);</span>
<a href="#l40.457"></a><span id="l40.457" class="difflineplus">+</span>
<a href="#l40.458"></a><span id="l40.458" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFParseTypeDate,</span>
<a href="#l40.459"></a><span id="l40.459" class="difflineplus">+                               sizeof(kRDFParseTypeDate) - 1);</span>
<a href="#l40.460"></a><span id="l40.460" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.461"></a><span id="l40.461" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l40.462"></a><span id="l40.462" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.463"></a><span id="l40.463" class="difflineplus">+    }</span>
<a href="#l40.464"></a><span id="l40.464" class="difflineplus">+    else {</span>
<a href="#l40.465"></a><span id="l40.465" class="difflineplus">+        // XXX it doesn't support nsIRDFResource _or_ nsIRDFLiteral???</span>
<a href="#l40.466"></a><span id="l40.466" class="difflineplus">+        // We should serialize nsIRDFInt, nsIRDFDate, etc...</span>
<a href="#l40.467"></a><span id="l40.467" class="difflineplus">+        NS_WARNING(&quot;unknown RDF node type&quot;);</span>
<a href="#l40.468"></a><span id="l40.468" class="difflineplus">+</span>
<a href="#l40.469"></a><span id="l40.469" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFUnknown, sizeof(kRDFUnknown) - 1);</span>
<a href="#l40.470"></a><span id="l40.470" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.471"></a><span id="l40.471" class="difflineplus">+    }</span>
<a href="#l40.472"></a><span id="l40.472" class="difflineplus">+</span>
<a href="#l40.473"></a><span id="l40.473" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, &quot;&lt;/&quot;, 2);</span>
<a href="#l40.474"></a><span id="l40.474" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.475"></a><span id="l40.475" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, qname);</span>
<a href="#l40.476"></a><span id="l40.476" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.477"></a><span id="l40.477" class="difflineplus">+    return rdf_BlockingWrite(aStream, &quot;&gt;\n&quot;, 2);</span>
<a href="#l40.478"></a><span id="l40.478" class="difflineplus">+</span>
<a href="#l40.479"></a><span id="l40.479" class="difflineplus">+ no_close_tag:</span>
<a href="#l40.480"></a><span id="l40.480" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.481"></a><span id="l40.481" class="difflineplus">+}</span>
<a href="#l40.482"></a><span id="l40.482" class="difflineplus">+</span>
<a href="#l40.483"></a><span id="l40.483" class="difflineplus">+nsresult</span>
<a href="#l40.484"></a><span id="l40.484" class="difflineplus">+nsRDFXMLSerializer::SerializeProperty(nsIOutputStream* aStream,</span>
<a href="#l40.485"></a><span id="l40.485" class="difflineplus">+                                      nsIRDFResource* aResource,</span>
<a href="#l40.486"></a><span id="l40.486" class="difflineplus">+                                      nsIRDFResource* aProperty,</span>
<a href="#l40.487"></a><span id="l40.487" class="difflineplus">+                                      bool aInline,</span>
<a href="#l40.488"></a><span id="l40.488" class="difflineplus">+                                      int32_t* aSkipped)</span>
<a href="#l40.489"></a><span id="l40.489" class="difflineplus">+{</span>
<a href="#l40.490"></a><span id="l40.490" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l40.491"></a><span id="l40.491" class="difflineplus">+</span>
<a href="#l40.492"></a><span id="l40.492" class="difflineplus">+    int32_t skipped = 0;</span>
<a href="#l40.493"></a><span id="l40.493" class="difflineplus">+</span>
<a href="#l40.494"></a><span id="l40.494" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; assertions;</span>
<a href="#l40.495"></a><span id="l40.495" class="difflineplus">+    mDataSource-&gt;GetTargets(aResource, aProperty, true, getter_AddRefs(assertions));</span>
<a href="#l40.496"></a><span id="l40.496" class="difflineplus">+    if (! assertions)</span>
<a href="#l40.497"></a><span id="l40.497" class="difflineplus">+        return NS_ERROR_FAILURE;</span>
<a href="#l40.498"></a><span id="l40.498" class="difflineplus">+</span>
<a href="#l40.499"></a><span id="l40.499" class="difflineplus">+    // Serializing the assertion inline is ok as long as the property has</span>
<a href="#l40.500"></a><span id="l40.500" class="difflineplus">+    // only one target value, and it is a literal that doesn't include line</span>
<a href="#l40.501"></a><span id="l40.501" class="difflineplus">+    // breaks.</span>
<a href="#l40.502"></a><span id="l40.502" class="difflineplus">+    bool needsChild = false;</span>
<a href="#l40.503"></a><span id="l40.503" class="difflineplus">+</span>
<a href="#l40.504"></a><span id="l40.504" class="difflineplus">+    while (1) {</span>
<a href="#l40.505"></a><span id="l40.505" class="difflineplus">+        bool hasMore = false;</span>
<a href="#l40.506"></a><span id="l40.506" class="difflineplus">+        assertions-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l40.507"></a><span id="l40.507" class="difflineplus">+        if (! hasMore)</span>
<a href="#l40.508"></a><span id="l40.508" class="difflineplus">+            break;</span>
<a href="#l40.509"></a><span id="l40.509" class="difflineplus">+</span>
<a href="#l40.510"></a><span id="l40.510" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l40.511"></a><span id="l40.511" class="difflineplus">+        assertions-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l40.512"></a><span id="l40.512" class="difflineplus">+        nsCOMPtr&lt;nsIRDFLiteral&gt; literal = do_QueryInterface(isupports);</span>
<a href="#l40.513"></a><span id="l40.513" class="difflineplus">+        needsChild |= (!literal);</span>
<a href="#l40.514"></a><span id="l40.514" class="difflineplus">+</span>
<a href="#l40.515"></a><span id="l40.515" class="difflineplus">+        if (!needsChild) {</span>
<a href="#l40.516"></a><span id="l40.516" class="difflineplus">+            assertions-&gt;HasMoreElements(&amp;needsChild);</span>
<a href="#l40.517"></a><span id="l40.517" class="difflineplus">+            if (!needsChild) {</span>
<a href="#l40.518"></a><span id="l40.518" class="difflineplus">+                const char16_t* literalVal = nullptr;</span>
<a href="#l40.519"></a><span id="l40.519" class="difflineplus">+                literal-&gt;GetValueConst(&amp;literalVal);</span>
<a href="#l40.520"></a><span id="l40.520" class="difflineplus">+                if (literalVal) {</span>
<a href="#l40.521"></a><span id="l40.521" class="difflineplus">+                    for (; *literalVal; literalVal++) {</span>
<a href="#l40.522"></a><span id="l40.522" class="difflineplus">+                        if (*literalVal == char16_t('\n') ||</span>
<a href="#l40.523"></a><span id="l40.523" class="difflineplus">+                            *literalVal == char16_t('\r')) {</span>
<a href="#l40.524"></a><span id="l40.524" class="difflineplus">+                            needsChild = true;</span>
<a href="#l40.525"></a><span id="l40.525" class="difflineplus">+                            break;</span>
<a href="#l40.526"></a><span id="l40.526" class="difflineplus">+                        }</span>
<a href="#l40.527"></a><span id="l40.527" class="difflineplus">+                    }</span>
<a href="#l40.528"></a><span id="l40.528" class="difflineplus">+                }</span>
<a href="#l40.529"></a><span id="l40.529" class="difflineplus">+            }</span>
<a href="#l40.530"></a><span id="l40.530" class="difflineplus">+        }</span>
<a href="#l40.531"></a><span id="l40.531" class="difflineplus">+</span>
<a href="#l40.532"></a><span id="l40.532" class="difflineplus">+        if (aInline &amp;&amp; !needsChild) {</span>
<a href="#l40.533"></a><span id="l40.533" class="difflineplus">+            rv = SerializeInlineAssertion(aStream, aResource, aProperty, literal);</span>
<a href="#l40.534"></a><span id="l40.534" class="difflineplus">+        }</span>
<a href="#l40.535"></a><span id="l40.535" class="difflineplus">+        else if (!aInline &amp;&amp; needsChild) {</span>
<a href="#l40.536"></a><span id="l40.536" class="difflineplus">+            nsCOMPtr&lt;nsIRDFNode&gt; value = do_QueryInterface(isupports);</span>
<a href="#l40.537"></a><span id="l40.537" class="difflineplus">+            rv = SerializeChildAssertion(aStream, aResource, aProperty, value);</span>
<a href="#l40.538"></a><span id="l40.538" class="difflineplus">+        }</span>
<a href="#l40.539"></a><span id="l40.539" class="difflineplus">+        else {</span>
<a href="#l40.540"></a><span id="l40.540" class="difflineplus">+            ++skipped;</span>
<a href="#l40.541"></a><span id="l40.541" class="difflineplus">+            rv = NS_OK;</span>
<a href="#l40.542"></a><span id="l40.542" class="difflineplus">+        }</span>
<a href="#l40.543"></a><span id="l40.543" class="difflineplus">+</span>
<a href="#l40.544"></a><span id="l40.544" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l40.545"></a><span id="l40.545" class="difflineplus">+            break;</span>
<a href="#l40.546"></a><span id="l40.546" class="difflineplus">+    }</span>
<a href="#l40.547"></a><span id="l40.547" class="difflineplus">+</span>
<a href="#l40.548"></a><span id="l40.548" class="difflineplus">+    *aSkipped += skipped;</span>
<a href="#l40.549"></a><span id="l40.549" class="difflineplus">+    return rv;</span>
<a href="#l40.550"></a><span id="l40.550" class="difflineplus">+}</span>
<a href="#l40.551"></a><span id="l40.551" class="difflineplus">+</span>
<a href="#l40.552"></a><span id="l40.552" class="difflineplus">+</span>
<a href="#l40.553"></a><span id="l40.553" class="difflineplus">+nsresult</span>
<a href="#l40.554"></a><span id="l40.554" class="difflineplus">+nsRDFXMLSerializer::SerializeDescription(nsIOutputStream* aStream,</span>
<a href="#l40.555"></a><span id="l40.555" class="difflineplus">+                                         nsIRDFResource* aResource)</span>
<a href="#l40.556"></a><span id="l40.556" class="difflineplus">+{</span>
<a href="#l40.557"></a><span id="l40.557" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.558"></a><span id="l40.558" class="difflineplus">+</span>
<a href="#l40.559"></a><span id="l40.559" class="difflineplus">+    bool isTypedNode = false;</span>
<a href="#l40.560"></a><span id="l40.560" class="difflineplus">+    nsCString typeQName;</span>
<a href="#l40.561"></a><span id="l40.561" class="difflineplus">+</span>
<a href="#l40.562"></a><span id="l40.562" class="difflineplus">+    nsCOMPtr&lt;nsIRDFNode&gt; typeNode;</span>
<a href="#l40.563"></a><span id="l40.563" class="difflineplus">+    mDataSource-&gt;GetTarget(aResource, kRDF_type, true, getter_AddRefs(typeNode));</span>
<a href="#l40.564"></a><span id="l40.564" class="difflineplus">+    if (typeNode) {</span>
<a href="#l40.565"></a><span id="l40.565" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; type = do_QueryInterface(typeNode, &amp;rv);</span>
<a href="#l40.566"></a><span id="l40.566" class="difflineplus">+        if (type) {</span>
<a href="#l40.567"></a><span id="l40.567" class="difflineplus">+            // Try to get a namespace prefix.  If none is available,</span>
<a href="#l40.568"></a><span id="l40.568" class="difflineplus">+            // just treat the description as if it weren't a typed node</span>
<a href="#l40.569"></a><span id="l40.569" class="difflineplus">+            // after all and emit rdf:type as a normal property.  This</span>
<a href="#l40.570"></a><span id="l40.570" class="difflineplus">+            // seems preferable to using a bogus (invented) prefix.</span>
<a href="#l40.571"></a><span id="l40.571" class="difflineplus">+            isTypedNode = NS_SUCCEEDED(GetQName(type, typeQName));</span>
<a href="#l40.572"></a><span id="l40.572" class="difflineplus">+        }</span>
<a href="#l40.573"></a><span id="l40.573" class="difflineplus">+    }</span>
<a href="#l40.574"></a><span id="l40.574" class="difflineplus">+</span>
<a href="#l40.575"></a><span id="l40.575" class="difflineplus">+    nsAutoCString uri;</span>
<a href="#l40.576"></a><span id="l40.576" class="difflineplus">+    rv = aResource-&gt;GetValueUTF8(uri);</span>
<a href="#l40.577"></a><span id="l40.577" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.578"></a><span id="l40.578" class="difflineplus">+</span>
<a href="#l40.579"></a><span id="l40.579" class="difflineplus">+    rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l40.580"></a><span id="l40.580" class="difflineplus">+    rdf_EscapeAttributeValue(uri);</span>
<a href="#l40.581"></a><span id="l40.581" class="difflineplus">+</span>
<a href="#l40.582"></a><span id="l40.582" class="difflineplus">+    // Emit an open tag and the subject</span>
<a href="#l40.583"></a><span id="l40.583" class="difflineplus">+    if (isTypedNode) {</span>
<a href="#l40.584"></a><span id="l40.584" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, NS_LITERAL_STRING(&quot;  &lt;&quot;));</span>
<a href="#l40.585"></a><span id="l40.585" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.586"></a><span id="l40.586" class="difflineplus">+        // Watch out for the default namespace!</span>
<a href="#l40.587"></a><span id="l40.587" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, typeQName);</span>
<a href="#l40.588"></a><span id="l40.588" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.589"></a><span id="l40.589" class="difflineplus">+    }</span>
<a href="#l40.590"></a><span id="l40.590" class="difflineplus">+    else {</span>
<a href="#l40.591"></a><span id="l40.591" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFDescriptionOpen,</span>
<a href="#l40.592"></a><span id="l40.592" class="difflineplus">+                               sizeof(kRDFDescriptionOpen) - 1);</span>
<a href="#l40.593"></a><span id="l40.593" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.594"></a><span id="l40.594" class="difflineplus">+    }</span>
<a href="#l40.595"></a><span id="l40.595" class="difflineplus">+    if (uri[0] == char16_t('#')) {</span>
<a href="#l40.596"></a><span id="l40.596" class="difflineplus">+        uri.Cut(0, 1);</span>
<a href="#l40.597"></a><span id="l40.597" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kIDAttr, sizeof(kIDAttr) - 1);</span>
<a href="#l40.598"></a><span id="l40.598" class="difflineplus">+    }</span>
<a href="#l40.599"></a><span id="l40.599" class="difflineplus">+    else {</span>
<a href="#l40.600"></a><span id="l40.600" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kAboutAttr, sizeof(kAboutAttr) - 1);</span>
<a href="#l40.601"></a><span id="l40.601" class="difflineplus">+    }</span>
<a href="#l40.602"></a><span id="l40.602" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.603"></a><span id="l40.603" class="difflineplus">+</span>
<a href="#l40.604"></a><span id="l40.604" class="difflineplus">+    uri.Append('&quot;');</span>
<a href="#l40.605"></a><span id="l40.605" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l40.606"></a><span id="l40.606" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.607"></a><span id="l40.607" class="difflineplus">+</span>
<a href="#l40.608"></a><span id="l40.608" class="difflineplus">+    // Any value that's a literal we can write out as an inline</span>
<a href="#l40.609"></a><span id="l40.609" class="difflineplus">+    // attribute on the RDF:Description</span>
<a href="#l40.610"></a><span id="l40.610" class="difflineplus">+    AutoTArray&lt;nsIRDFResource*, 8&gt; visited;</span>
<a href="#l40.611"></a><span id="l40.611" class="difflineplus">+    int32_t skipped = 0;</span>
<a href="#l40.612"></a><span id="l40.612" class="difflineplus">+</span>
<a href="#l40.613"></a><span id="l40.613" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcs;</span>
<a href="#l40.614"></a><span id="l40.614" class="difflineplus">+    mDataSource-&gt;ArcLabelsOut(aResource, getter_AddRefs(arcs));</span>
<a href="#l40.615"></a><span id="l40.615" class="difflineplus">+</span>
<a href="#l40.616"></a><span id="l40.616" class="difflineplus">+    if (arcs) {</span>
<a href="#l40.617"></a><span id="l40.617" class="difflineplus">+        // Don't re-serialize rdf:type later on</span>
<a href="#l40.618"></a><span id="l40.618" class="difflineplus">+        if (isTypedNode)</span>
<a href="#l40.619"></a><span id="l40.619" class="difflineplus">+            visited.AppendElement(kRDF_type);</span>
<a href="#l40.620"></a><span id="l40.620" class="difflineplus">+</span>
<a href="#l40.621"></a><span id="l40.621" class="difflineplus">+        while (1) {</span>
<a href="#l40.622"></a><span id="l40.622" class="difflineplus">+            bool hasMore = false;</span>
<a href="#l40.623"></a><span id="l40.623" class="difflineplus">+            arcs-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l40.624"></a><span id="l40.624" class="difflineplus">+            if (! hasMore)</span>
<a href="#l40.625"></a><span id="l40.625" class="difflineplus">+                break;</span>
<a href="#l40.626"></a><span id="l40.626" class="difflineplus">+</span>
<a href="#l40.627"></a><span id="l40.627" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l40.628"></a><span id="l40.628" class="difflineplus">+            arcs-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l40.629"></a><span id="l40.629" class="difflineplus">+</span>
<a href="#l40.630"></a><span id="l40.630" class="difflineplus">+            nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(isupports);</span>
<a href="#l40.631"></a><span id="l40.631" class="difflineplus">+            if (! property)</span>
<a href="#l40.632"></a><span id="l40.632" class="difflineplus">+                continue;</span>
<a href="#l40.633"></a><span id="l40.633" class="difflineplus">+</span>
<a href="#l40.634"></a><span id="l40.634" class="difflineplus">+            // Ignore properties that pertain to containers; we may be</span>
<a href="#l40.635"></a><span id="l40.635" class="difflineplus">+            // called from SerializeContainer() if the container resource</span>
<a href="#l40.636"></a><span id="l40.636" class="difflineplus">+            // has been assigned non-container properties.</span>
<a href="#l40.637"></a><span id="l40.637" class="difflineplus">+            if (IsContainerProperty(property))</span>
<a href="#l40.638"></a><span id="l40.638" class="difflineplus">+                continue;</span>
<a href="#l40.639"></a><span id="l40.639" class="difflineplus">+</span>
<a href="#l40.640"></a><span id="l40.640" class="difflineplus">+            // Only serialize values for the property once.</span>
<a href="#l40.641"></a><span id="l40.641" class="difflineplus">+            if (visited.Contains(property.get()))</span>
<a href="#l40.642"></a><span id="l40.642" class="difflineplus">+                continue;</span>
<a href="#l40.643"></a><span id="l40.643" class="difflineplus">+</span>
<a href="#l40.644"></a><span id="l40.644" class="difflineplus">+            visited.AppendElement(property.get());</span>
<a href="#l40.645"></a><span id="l40.645" class="difflineplus">+</span>
<a href="#l40.646"></a><span id="l40.646" class="difflineplus">+            SerializeProperty(aStream, aResource, property, true, &amp;skipped);</span>
<a href="#l40.647"></a><span id="l40.647" class="difflineplus">+        }</span>
<a href="#l40.648"></a><span id="l40.648" class="difflineplus">+    }</span>
<a href="#l40.649"></a><span id="l40.649" class="difflineplus">+</span>
<a href="#l40.650"></a><span id="l40.650" class="difflineplus">+    if (skipped) {</span>
<a href="#l40.651"></a><span id="l40.651" class="difflineplus">+        // Close the RDF:Description tag.</span>
<a href="#l40.652"></a><span id="l40.652" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&gt;\n&quot;));</span>
<a href="#l40.653"></a><span id="l40.653" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.654"></a><span id="l40.654" class="difflineplus">+</span>
<a href="#l40.655"></a><span id="l40.655" class="difflineplus">+        // Now write out resources (which might have their own</span>
<a href="#l40.656"></a><span id="l40.656" class="difflineplus">+        // substructure) as children.</span>
<a href="#l40.657"></a><span id="l40.657" class="difflineplus">+        mDataSource-&gt;ArcLabelsOut(aResource, getter_AddRefs(arcs));</span>
<a href="#l40.658"></a><span id="l40.658" class="difflineplus">+</span>
<a href="#l40.659"></a><span id="l40.659" class="difflineplus">+        if (arcs) {</span>
<a href="#l40.660"></a><span id="l40.660" class="difflineplus">+            // Forget that we've visited anything</span>
<a href="#l40.661"></a><span id="l40.661" class="difflineplus">+            visited.Clear();</span>
<a href="#l40.662"></a><span id="l40.662" class="difflineplus">+            // ... except for rdf:type</span>
<a href="#l40.663"></a><span id="l40.663" class="difflineplus">+            if (isTypedNode)</span>
<a href="#l40.664"></a><span id="l40.664" class="difflineplus">+                visited.AppendElement(kRDF_type);</span>
<a href="#l40.665"></a><span id="l40.665" class="difflineplus">+</span>
<a href="#l40.666"></a><span id="l40.666" class="difflineplus">+            while (1) {</span>
<a href="#l40.667"></a><span id="l40.667" class="difflineplus">+                bool hasMore = false;</span>
<a href="#l40.668"></a><span id="l40.668" class="difflineplus">+                arcs-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l40.669"></a><span id="l40.669" class="difflineplus">+                if (! hasMore)</span>
<a href="#l40.670"></a><span id="l40.670" class="difflineplus">+                    break;</span>
<a href="#l40.671"></a><span id="l40.671" class="difflineplus">+</span>
<a href="#l40.672"></a><span id="l40.672" class="difflineplus">+                nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l40.673"></a><span id="l40.673" class="difflineplus">+                arcs-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l40.674"></a><span id="l40.674" class="difflineplus">+</span>
<a href="#l40.675"></a><span id="l40.675" class="difflineplus">+                nsCOMPtr&lt;nsIRDFResource&gt; property = do_QueryInterface(isupports);</span>
<a href="#l40.676"></a><span id="l40.676" class="difflineplus">+                if (! property)</span>
<a href="#l40.677"></a><span id="l40.677" class="difflineplus">+                    continue;</span>
<a href="#l40.678"></a><span id="l40.678" class="difflineplus">+</span>
<a href="#l40.679"></a><span id="l40.679" class="difflineplus">+                // Ignore properties that pertain to containers; we may be</span>
<a href="#l40.680"></a><span id="l40.680" class="difflineplus">+                // called from SerializeContainer() if the container</span>
<a href="#l40.681"></a><span id="l40.681" class="difflineplus">+                // resource has been assigned non-container properties.</span>
<a href="#l40.682"></a><span id="l40.682" class="difflineplus">+                if (IsContainerProperty(property))</span>
<a href="#l40.683"></a><span id="l40.683" class="difflineplus">+                    continue;</span>
<a href="#l40.684"></a><span id="l40.684" class="difflineplus">+</span>
<a href="#l40.685"></a><span id="l40.685" class="difflineplus">+                // have we already seen this property?  If so, don't write it</span>
<a href="#l40.686"></a><span id="l40.686" class="difflineplus">+                // out again; serialize property will write each instance.</span>
<a href="#l40.687"></a><span id="l40.687" class="difflineplus">+                if (visited.Contains(property.get()))</span>
<a href="#l40.688"></a><span id="l40.688" class="difflineplus">+                    continue;</span>
<a href="#l40.689"></a><span id="l40.689" class="difflineplus">+</span>
<a href="#l40.690"></a><span id="l40.690" class="difflineplus">+                visited.AppendElement(property.get());</span>
<a href="#l40.691"></a><span id="l40.691" class="difflineplus">+</span>
<a href="#l40.692"></a><span id="l40.692" class="difflineplus">+                SerializeProperty(aStream, aResource, property, false, &amp;skipped);</span>
<a href="#l40.693"></a><span id="l40.693" class="difflineplus">+            }</span>
<a href="#l40.694"></a><span id="l40.694" class="difflineplus">+        }</span>
<a href="#l40.695"></a><span id="l40.695" class="difflineplus">+</span>
<a href="#l40.696"></a><span id="l40.696" class="difflineplus">+        // Emit a proper close-tag.</span>
<a href="#l40.697"></a><span id="l40.697" class="difflineplus">+        if (isTypedNode) {</span>
<a href="#l40.698"></a><span id="l40.698" class="difflineplus">+            rv = rdf_BlockingWrite(aStream,  NS_LITERAL_CSTRING(&quot;  &lt;/&quot;));</span>
<a href="#l40.699"></a><span id="l40.699" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.700"></a><span id="l40.700" class="difflineplus">+            // Watch out for the default namespace!</span>
<a href="#l40.701"></a><span id="l40.701" class="difflineplus">+            rdf_BlockingWrite(aStream, typeQName);</span>
<a href="#l40.702"></a><span id="l40.702" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.703"></a><span id="l40.703" class="difflineplus">+            rdf_BlockingWrite(aStream, &quot;&gt;\n&quot;, 2);</span>
<a href="#l40.704"></a><span id="l40.704" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.705"></a><span id="l40.705" class="difflineplus">+        }</span>
<a href="#l40.706"></a><span id="l40.706" class="difflineplus">+        else {</span>
<a href="#l40.707"></a><span id="l40.707" class="difflineplus">+            rv = rdf_BlockingWrite(aStream, kRDFDescriptionClose,</span>
<a href="#l40.708"></a><span id="l40.708" class="difflineplus">+                                   sizeof(kRDFDescriptionClose) - 1);</span>
<a href="#l40.709"></a><span id="l40.709" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.710"></a><span id="l40.710" class="difflineplus">+        }</span>
<a href="#l40.711"></a><span id="l40.711" class="difflineplus">+    }</span>
<a href="#l40.712"></a><span id="l40.712" class="difflineplus">+    else {</span>
<a href="#l40.713"></a><span id="l40.713" class="difflineplus">+        // If we saw _no_ child properties, then we can don't need a</span>
<a href="#l40.714"></a><span id="l40.714" class="difflineplus">+        // close-tag.</span>
<a href="#l40.715"></a><span id="l40.715" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot; /&gt;\n&quot;));</span>
<a href="#l40.716"></a><span id="l40.716" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.717"></a><span id="l40.717" class="difflineplus">+    }</span>
<a href="#l40.718"></a><span id="l40.718" class="difflineplus">+</span>
<a href="#l40.719"></a><span id="l40.719" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.720"></a><span id="l40.720" class="difflineplus">+}</span>
<a href="#l40.721"></a><span id="l40.721" class="difflineplus">+</span>
<a href="#l40.722"></a><span id="l40.722" class="difflineplus">+nsresult</span>
<a href="#l40.723"></a><span id="l40.723" class="difflineplus">+nsRDFXMLSerializer::SerializeMember(nsIOutputStream* aStream,</span>
<a href="#l40.724"></a><span id="l40.724" class="difflineplus">+                                      nsIRDFResource* aContainer,</span>
<a href="#l40.725"></a><span id="l40.725" class="difflineplus">+                                      nsIRDFNode* aMember)</span>
<a href="#l40.726"></a><span id="l40.726" class="difflineplus">+{</span>
<a href="#l40.727"></a><span id="l40.727" class="difflineplus">+    // If it's a resource, then output a &quot;&lt;RDF:li RDF:resource=... /&gt;&quot;</span>
<a href="#l40.728"></a><span id="l40.728" class="difflineplus">+    // tag, because we'll be dumping the resource separately. (We</span>
<a href="#l40.729"></a><span id="l40.729" class="difflineplus">+    // iterate thru all the resources in the datasource,</span>
<a href="#l40.730"></a><span id="l40.730" class="difflineplus">+    // remember?) Otherwise, output the literal value.</span>
<a href="#l40.731"></a><span id="l40.731" class="difflineplus">+</span>
<a href="#l40.732"></a><span id="l40.732" class="difflineplus">+    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l40.733"></a><span id="l40.733" class="difflineplus">+    nsCOMPtr&lt;nsIRDFLiteral&gt; literal;</span>
<a href="#l40.734"></a><span id="l40.734" class="difflineplus">+    nsCOMPtr&lt;nsIRDFInt&gt; number;</span>
<a href="#l40.735"></a><span id="l40.735" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDate&gt; date;</span>
<a href="#l40.736"></a><span id="l40.736" class="difflineplus">+</span>
<a href="#l40.737"></a><span id="l40.737" class="difflineplus">+static const char kRDFLIOpen[] = &quot;    &lt;RDF:li&quot;;</span>
<a href="#l40.738"></a><span id="l40.738" class="difflineplus">+    nsresult rv = rdf_BlockingWrite(aStream, kRDFLIOpen,</span>
<a href="#l40.739"></a><span id="l40.739" class="difflineplus">+                                    sizeof(kRDFLIOpen) - 1);</span>
<a href="#l40.740"></a><span id="l40.740" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.741"></a><span id="l40.741" class="difflineplus">+</span>
<a href="#l40.742"></a><span id="l40.742" class="difflineplus">+    if ((resource = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l40.743"></a><span id="l40.743" class="difflineplus">+        nsAutoCString uri;</span>
<a href="#l40.744"></a><span id="l40.744" class="difflineplus">+        resource-&gt;GetValueUTF8(uri);</span>
<a href="#l40.745"></a><span id="l40.745" class="difflineplus">+</span>
<a href="#l40.746"></a><span id="l40.746" class="difflineplus">+        rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l40.747"></a><span id="l40.747" class="difflineplus">+        rdf_EscapeAttributeValue(uri);</span>
<a href="#l40.748"></a><span id="l40.748" class="difflineplus">+</span>
<a href="#l40.749"></a><span id="l40.749" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFResource1,</span>
<a href="#l40.750"></a><span id="l40.750" class="difflineplus">+                               sizeof(kRDFResource1) - 1);</span>
<a href="#l40.751"></a><span id="l40.751" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.752"></a><span id="l40.752" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l40.753"></a><span id="l40.753" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.754"></a><span id="l40.754" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFResource2,</span>
<a href="#l40.755"></a><span id="l40.755" class="difflineplus">+                               sizeof(kRDFResource2) - 1);</span>
<a href="#l40.756"></a><span id="l40.756" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.757"></a><span id="l40.757" class="difflineplus">+</span>
<a href="#l40.758"></a><span id="l40.758" class="difflineplus">+        goto no_close_tag;</span>
<a href="#l40.759"></a><span id="l40.759" class="difflineplus">+    }</span>
<a href="#l40.760"></a><span id="l40.760" class="difflineplus">+    else if ((literal = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l40.761"></a><span id="l40.761" class="difflineplus">+        const char16_t *value;</span>
<a href="#l40.762"></a><span id="l40.762" class="difflineplus">+        literal-&gt;GetValueConst(&amp;value);</span>
<a href="#l40.763"></a><span id="l40.763" class="difflineplus">+static const char kRDFLIOpenGT[] = &quot;&gt;&quot;;</span>
<a href="#l40.764"></a><span id="l40.764" class="difflineplus">+        // close the '&lt;RDF:LI' before adding the literal</span>
<a href="#l40.765"></a><span id="l40.765" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFLIOpenGT,</span>
<a href="#l40.766"></a><span id="l40.766" class="difflineplus">+                               sizeof(kRDFLIOpenGT) - 1);</span>
<a href="#l40.767"></a><span id="l40.767" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.768"></a><span id="l40.768" class="difflineplus">+</span>
<a href="#l40.769"></a><span id="l40.769" class="difflineplus">+        NS_ConvertUTF16toUTF8 s(value);</span>
<a href="#l40.770"></a><span id="l40.770" class="difflineplus">+        rdf_EscapeAmpersandsAndAngleBrackets(s);</span>
<a href="#l40.771"></a><span id="l40.771" class="difflineplus">+</span>
<a href="#l40.772"></a><span id="l40.772" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l40.773"></a><span id="l40.773" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.774"></a><span id="l40.774" class="difflineplus">+    }</span>
<a href="#l40.775"></a><span id="l40.775" class="difflineplus">+    else if ((number = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l40.776"></a><span id="l40.776" class="difflineplus">+        int32_t value;</span>
<a href="#l40.777"></a><span id="l40.777" class="difflineplus">+        number-&gt;GetValue(&amp;value);</span>
<a href="#l40.778"></a><span id="l40.778" class="difflineplus">+</span>
<a href="#l40.779"></a><span id="l40.779" class="difflineplus">+        nsAutoCString n;</span>
<a href="#l40.780"></a><span id="l40.780" class="difflineplus">+        n.AppendInt(value);</span>
<a href="#l40.781"></a><span id="l40.781" class="difflineplus">+</span>
<a href="#l40.782"></a><span id="l40.782" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFParseTypeInteger,</span>
<a href="#l40.783"></a><span id="l40.783" class="difflineplus">+                               sizeof(kRDFParseTypeInteger) - 1);</span>
<a href="#l40.784"></a><span id="l40.784" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.785"></a><span id="l40.785" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, n);</span>
<a href="#l40.786"></a><span id="l40.786" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.787"></a><span id="l40.787" class="difflineplus">+    }</span>
<a href="#l40.788"></a><span id="l40.788" class="difflineplus">+    else if ((date = do_QueryInterface(aMember)) != nullptr) {</span>
<a href="#l40.789"></a><span id="l40.789" class="difflineplus">+        PRTime value;</span>
<a href="#l40.790"></a><span id="l40.790" class="difflineplus">+        date-&gt;GetValue(&amp;value);</span>
<a href="#l40.791"></a><span id="l40.791" class="difflineplus">+</span>
<a href="#l40.792"></a><span id="l40.792" class="difflineplus">+        nsAutoCString s;</span>
<a href="#l40.793"></a><span id="l40.793" class="difflineplus">+        rdf_FormatDate(value, s);</span>
<a href="#l40.794"></a><span id="l40.794" class="difflineplus">+</span>
<a href="#l40.795"></a><span id="l40.795" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFParseTypeDate,</span>
<a href="#l40.796"></a><span id="l40.796" class="difflineplus">+                               sizeof(kRDFParseTypeDate) - 1);</span>
<a href="#l40.797"></a><span id="l40.797" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.798"></a><span id="l40.798" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, s);</span>
<a href="#l40.799"></a><span id="l40.799" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.800"></a><span id="l40.800" class="difflineplus">+    }</span>
<a href="#l40.801"></a><span id="l40.801" class="difflineplus">+    else {</span>
<a href="#l40.802"></a><span id="l40.802" class="difflineplus">+        // XXX it doesn't support nsIRDFResource _or_ nsIRDFLiteral???</span>
<a href="#l40.803"></a><span id="l40.803" class="difflineplus">+        // We should serialize nsIRDFInt, nsIRDFDate, etc...</span>
<a href="#l40.804"></a><span id="l40.804" class="difflineplus">+        NS_WARNING(&quot;unknown RDF node type&quot;);</span>
<a href="#l40.805"></a><span id="l40.805" class="difflineplus">+</span>
<a href="#l40.806"></a><span id="l40.806" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFUnknown, sizeof(kRDFUnknown) - 1);</span>
<a href="#l40.807"></a><span id="l40.807" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.808"></a><span id="l40.808" class="difflineplus">+    }</span>
<a href="#l40.809"></a><span id="l40.809" class="difflineplus">+</span>
<a href="#l40.810"></a><span id="l40.810" class="difflineplus">+    {</span>
<a href="#l40.811"></a><span id="l40.811" class="difflineplus">+static const char kRDFLIClose[] = &quot;&lt;/RDF:li&gt;\n&quot;;</span>
<a href="#l40.812"></a><span id="l40.812" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, kRDFLIClose, sizeof(kRDFLIClose) - 1);</span>
<a href="#l40.813"></a><span id="l40.813" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.814"></a><span id="l40.814" class="difflineplus">+    }</span>
<a href="#l40.815"></a><span id="l40.815" class="difflineplus">+</span>
<a href="#l40.816"></a><span id="l40.816" class="difflineplus">+ no_close_tag:</span>
<a href="#l40.817"></a><span id="l40.817" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.818"></a><span id="l40.818" class="difflineplus">+}</span>
<a href="#l40.819"></a><span id="l40.819" class="difflineplus">+</span>
<a href="#l40.820"></a><span id="l40.820" class="difflineplus">+</span>
<a href="#l40.821"></a><span id="l40.821" class="difflineplus">+nsresult</span>
<a href="#l40.822"></a><span id="l40.822" class="difflineplus">+nsRDFXMLSerializer::SerializeContainer(nsIOutputStream* aStream,</span>
<a href="#l40.823"></a><span id="l40.823" class="difflineplus">+                                         nsIRDFResource* aContainer)</span>
<a href="#l40.824"></a><span id="l40.824" class="difflineplus">+{</span>
<a href="#l40.825"></a><span id="l40.825" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.826"></a><span id="l40.826" class="difflineplus">+    nsAutoCString tag;</span>
<a href="#l40.827"></a><span id="l40.827" class="difflineplus">+</span>
<a href="#l40.828"></a><span id="l40.828" class="difflineplus">+    // Decide if it's a sequence, bag, or alternation, and print the</span>
<a href="#l40.829"></a><span id="l40.829" class="difflineplus">+    // appropriate tag-open sequence</span>
<a href="#l40.830"></a><span id="l40.830" class="difflineplus">+</span>
<a href="#l40.831"></a><span id="l40.831" class="difflineplus">+    if (IsA(mDataSource, aContainer, kRDF_Bag)) {</span>
<a href="#l40.832"></a><span id="l40.832" class="difflineplus">+        tag.AssignLiteral(&quot;RDF:Bag&quot;);</span>
<a href="#l40.833"></a><span id="l40.833" class="difflineplus">+    }</span>
<a href="#l40.834"></a><span id="l40.834" class="difflineplus">+    else if (IsA(mDataSource, aContainer, kRDF_Seq)) {</span>
<a href="#l40.835"></a><span id="l40.835" class="difflineplus">+        tag.AssignLiteral(&quot;RDF:Seq&quot;);</span>
<a href="#l40.836"></a><span id="l40.836" class="difflineplus">+    }</span>
<a href="#l40.837"></a><span id="l40.837" class="difflineplus">+    else if (IsA(mDataSource, aContainer, kRDF_Alt)) {</span>
<a href="#l40.838"></a><span id="l40.838" class="difflineplus">+        tag.AssignLiteral(&quot;RDF:Alt&quot;);</span>
<a href="#l40.839"></a><span id="l40.839" class="difflineplus">+    }</span>
<a href="#l40.840"></a><span id="l40.840" class="difflineplus">+    else {</span>
<a href="#l40.841"></a><span id="l40.841" class="difflineplus">+        NS_ASSERTION(false, &quot;huh? this is _not_ a container.&quot;);</span>
<a href="#l40.842"></a><span id="l40.842" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l40.843"></a><span id="l40.843" class="difflineplus">+    }</span>
<a href="#l40.844"></a><span id="l40.844" class="difflineplus">+</span>
<a href="#l40.845"></a><span id="l40.845" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, &quot;  &lt;&quot;, 3);</span>
<a href="#l40.846"></a><span id="l40.846" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.847"></a><span id="l40.847" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, tag);</span>
<a href="#l40.848"></a><span id="l40.848" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.849"></a><span id="l40.849" class="difflineplus">+</span>
<a href="#l40.850"></a><span id="l40.850" class="difflineplus">+</span>
<a href="#l40.851"></a><span id="l40.851" class="difflineplus">+    // Unfortunately, we always need to print out the identity of the</span>
<a href="#l40.852"></a><span id="l40.852" class="difflineplus">+    // resource, even if was constructed &quot;anonymously&quot;. We need to do</span>
<a href="#l40.853"></a><span id="l40.853" class="difflineplus">+    // this because we never really know who else might be referring</span>
<a href="#l40.854"></a><span id="l40.854" class="difflineplus">+    // to it...</span>
<a href="#l40.855"></a><span id="l40.855" class="difflineplus">+</span>
<a href="#l40.856"></a><span id="l40.856" class="difflineplus">+    nsAutoCString uri;</span>
<a href="#l40.857"></a><span id="l40.857" class="difflineplus">+    if (NS_SUCCEEDED(aContainer-&gt;GetValueUTF8(uri))) {</span>
<a href="#l40.858"></a><span id="l40.858" class="difflineplus">+        rdf_MakeRelativeRef(mBaseURLSpec, uri);</span>
<a href="#l40.859"></a><span id="l40.859" class="difflineplus">+</span>
<a href="#l40.860"></a><span id="l40.860" class="difflineplus">+        rdf_EscapeAttributeValue(uri);</span>
<a href="#l40.861"></a><span id="l40.861" class="difflineplus">+</span>
<a href="#l40.862"></a><span id="l40.862" class="difflineplus">+        if (uri.First() == '#') {</span>
<a href="#l40.863"></a><span id="l40.863" class="difflineplus">+            // Okay, it's actually identified as an element in the</span>
<a href="#l40.864"></a><span id="l40.864" class="difflineplus">+            // current document, not trying to decorate some absolute</span>
<a href="#l40.865"></a><span id="l40.865" class="difflineplus">+            // URI. We can use the 'ID=' attribute...</span>
<a href="#l40.866"></a><span id="l40.866" class="difflineplus">+</span>
<a href="#l40.867"></a><span id="l40.867" class="difflineplus">+            uri.Cut(0, 1); // chop the '#'</span>
<a href="#l40.868"></a><span id="l40.868" class="difflineplus">+            rv = rdf_BlockingWrite(aStream, kIDAttr, sizeof(kIDAttr) - 1);</span>
<a href="#l40.869"></a><span id="l40.869" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.870"></a><span id="l40.870" class="difflineplus">+        }</span>
<a href="#l40.871"></a><span id="l40.871" class="difflineplus">+        else {</span>
<a href="#l40.872"></a><span id="l40.872" class="difflineplus">+            // We need to cheat and spit out an illegal 'about=' on</span>
<a href="#l40.873"></a><span id="l40.873" class="difflineplus">+            // the sequence.</span>
<a href="#l40.874"></a><span id="l40.874" class="difflineplus">+            rv = rdf_BlockingWrite(aStream, kAboutAttr,</span>
<a href="#l40.875"></a><span id="l40.875" class="difflineplus">+                                   sizeof(kAboutAttr) - 1);</span>
<a href="#l40.876"></a><span id="l40.876" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.877"></a><span id="l40.877" class="difflineplus">+        }</span>
<a href="#l40.878"></a><span id="l40.878" class="difflineplus">+</span>
<a href="#l40.879"></a><span id="l40.879" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l40.880"></a><span id="l40.880" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.881"></a><span id="l40.881" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, &quot;\&quot;&quot;, 1);</span>
<a href="#l40.882"></a><span id="l40.882" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.883"></a><span id="l40.883" class="difflineplus">+    }</span>
<a href="#l40.884"></a><span id="l40.884" class="difflineplus">+</span>
<a href="#l40.885"></a><span id="l40.885" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, &quot;&gt;\n&quot;, 2);</span>
<a href="#l40.886"></a><span id="l40.886" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.887"></a><span id="l40.887" class="difflineplus">+</span>
<a href="#l40.888"></a><span id="l40.888" class="difflineplus">+    // First iterate through each of the ordinal elements (the RDF/XML</span>
<a href="#l40.889"></a><span id="l40.889" class="difflineplus">+    // syntax doesn't allow us to place properties on RDF container</span>
<a href="#l40.890"></a><span id="l40.890" class="difflineplus">+    // elements).</span>
<a href="#l40.891"></a><span id="l40.891" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; elements;</span>
<a href="#l40.892"></a><span id="l40.892" class="difflineplus">+    rv = NS_NewContainerEnumerator(mDataSource, aContainer, getter_AddRefs(elements));</span>
<a href="#l40.893"></a><span id="l40.893" class="difflineplus">+</span>
<a href="#l40.894"></a><span id="l40.894" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l40.895"></a><span id="l40.895" class="difflineplus">+        while (1) {</span>
<a href="#l40.896"></a><span id="l40.896" class="difflineplus">+            bool hasMore;</span>
<a href="#l40.897"></a><span id="l40.897" class="difflineplus">+            rv = elements-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l40.898"></a><span id="l40.898" class="difflineplus">+            if (NS_FAILED(rv)) break;</span>
<a href="#l40.899"></a><span id="l40.899" class="difflineplus">+</span>
<a href="#l40.900"></a><span id="l40.900" class="difflineplus">+            if (! hasMore)</span>
<a href="#l40.901"></a><span id="l40.901" class="difflineplus">+                break;</span>
<a href="#l40.902"></a><span id="l40.902" class="difflineplus">+</span>
<a href="#l40.903"></a><span id="l40.903" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l40.904"></a><span id="l40.904" class="difflineplus">+            elements-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l40.905"></a><span id="l40.905" class="difflineplus">+</span>
<a href="#l40.906"></a><span id="l40.906" class="difflineplus">+            nsCOMPtr&lt;nsIRDFNode&gt; element = do_QueryInterface(isupports);</span>
<a href="#l40.907"></a><span id="l40.907" class="difflineplus">+            NS_ASSERTION(element != nullptr, &quot;not an nsIRDFNode&quot;);</span>
<a href="#l40.908"></a><span id="l40.908" class="difflineplus">+            if (! element)</span>
<a href="#l40.909"></a><span id="l40.909" class="difflineplus">+                continue;</span>
<a href="#l40.910"></a><span id="l40.910" class="difflineplus">+</span>
<a href="#l40.911"></a><span id="l40.911" class="difflineplus">+            SerializeMember(aStream, aContainer, element);</span>
<a href="#l40.912"></a><span id="l40.912" class="difflineplus">+        }</span>
<a href="#l40.913"></a><span id="l40.913" class="difflineplus">+    }</span>
<a href="#l40.914"></a><span id="l40.914" class="difflineplus">+</span>
<a href="#l40.915"></a><span id="l40.915" class="difflineplus">+    // close the container tag</span>
<a href="#l40.916"></a><span id="l40.916" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, &quot;  &lt;/&quot;, 4);</span>
<a href="#l40.917"></a><span id="l40.917" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.918"></a><span id="l40.918" class="difflineplus">+    tag.Append(&quot;&gt;\n&quot;, 2);</span>
<a href="#l40.919"></a><span id="l40.919" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, tag);</span>
<a href="#l40.920"></a><span id="l40.920" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.921"></a><span id="l40.921" class="difflineplus">+</span>
<a href="#l40.922"></a><span id="l40.922" class="difflineplus">+    // Now, we iterate through _all_ of the arcs, in case someone has</span>
<a href="#l40.923"></a><span id="l40.923" class="difflineplus">+    // applied properties to the bag itself. These'll be placed in a</span>
<a href="#l40.924"></a><span id="l40.924" class="difflineplus">+    // separate RDF:Description element.</span>
<a href="#l40.925"></a><span id="l40.925" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; arcs;</span>
<a href="#l40.926"></a><span id="l40.926" class="difflineplus">+    mDataSource-&gt;ArcLabelsOut(aContainer, getter_AddRefs(arcs));</span>
<a href="#l40.927"></a><span id="l40.927" class="difflineplus">+</span>
<a href="#l40.928"></a><span id="l40.928" class="difflineplus">+    bool wroteDescription = false;</span>
<a href="#l40.929"></a><span id="l40.929" class="difflineplus">+    while (! wroteDescription) {</span>
<a href="#l40.930"></a><span id="l40.930" class="difflineplus">+        bool hasMore = false;</span>
<a href="#l40.931"></a><span id="l40.931" class="difflineplus">+        rv = arcs-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l40.932"></a><span id="l40.932" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.933"></a><span id="l40.933" class="difflineplus">+</span>
<a href="#l40.934"></a><span id="l40.934" class="difflineplus">+        if (! hasMore)</span>
<a href="#l40.935"></a><span id="l40.935" class="difflineplus">+            break;</span>
<a href="#l40.936"></a><span id="l40.936" class="difflineplus">+</span>
<a href="#l40.937"></a><span id="l40.937" class="difflineplus">+        nsIRDFResource* property;</span>
<a href="#l40.938"></a><span id="l40.938" class="difflineplus">+        rv = arcs-&gt;GetNext((nsISupports**) &amp;property);</span>
<a href="#l40.939"></a><span id="l40.939" class="difflineplus">+        if (NS_FAILED(rv)) break;</span>
<a href="#l40.940"></a><span id="l40.940" class="difflineplus">+</span>
<a href="#l40.941"></a><span id="l40.941" class="difflineplus">+        // If it's a membership property, then output a &quot;LI&quot;</span>
<a href="#l40.942"></a><span id="l40.942" class="difflineplus">+        // tag. Otherwise, output a property.</span>
<a href="#l40.943"></a><span id="l40.943" class="difflineplus">+        if (! IsContainerProperty(property)) {</span>
<a href="#l40.944"></a><span id="l40.944" class="difflineplus">+            rv = SerializeDescription(aStream, aContainer);</span>
<a href="#l40.945"></a><span id="l40.945" class="difflineplus">+            wroteDescription = true;</span>
<a href="#l40.946"></a><span id="l40.946" class="difflineplus">+        }</span>
<a href="#l40.947"></a><span id="l40.947" class="difflineplus">+</span>
<a href="#l40.948"></a><span id="l40.948" class="difflineplus">+        NS_RELEASE(property);</span>
<a href="#l40.949"></a><span id="l40.949" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l40.950"></a><span id="l40.950" class="difflineplus">+            break;</span>
<a href="#l40.951"></a><span id="l40.951" class="difflineplus">+    }</span>
<a href="#l40.952"></a><span id="l40.952" class="difflineplus">+</span>
<a href="#l40.953"></a><span id="l40.953" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.954"></a><span id="l40.954" class="difflineplus">+}</span>
<a href="#l40.955"></a><span id="l40.955" class="difflineplus">+</span>
<a href="#l40.956"></a><span id="l40.956" class="difflineplus">+</span>
<a href="#l40.957"></a><span id="l40.957" class="difflineplus">+nsresult</span>
<a href="#l40.958"></a><span id="l40.958" class="difflineplus">+nsRDFXMLSerializer::SerializePrologue(nsIOutputStream* aStream)</span>
<a href="#l40.959"></a><span id="l40.959" class="difflineplus">+{</span>
<a href="#l40.960"></a><span id="l40.960" class="difflineplus">+static const char kXMLVersion[] = &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;;</span>
<a href="#l40.961"></a><span id="l40.961" class="difflineplus">+</span>
<a href="#l40.962"></a><span id="l40.962" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.963"></a><span id="l40.963" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, kXMLVersion, sizeof(kXMLVersion) - 1);</span>
<a href="#l40.964"></a><span id="l40.964" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.965"></a><span id="l40.965" class="difflineplus">+</span>
<a href="#l40.966"></a><span id="l40.966" class="difflineplus">+    // global name space declarations</span>
<a href="#l40.967"></a><span id="l40.967" class="difflineplus">+    rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&lt;RDF:RDF &quot;));</span>
<a href="#l40.968"></a><span id="l40.968" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.969"></a><span id="l40.969" class="difflineplus">+</span>
<a href="#l40.970"></a><span id="l40.970" class="difflineplus">+    nsNameSpaceMap::const_iterator first = mNameSpaces.first();</span>
<a href="#l40.971"></a><span id="l40.971" class="difflineplus">+    nsNameSpaceMap::const_iterator last = mNameSpaces.last();</span>
<a href="#l40.972"></a><span id="l40.972" class="difflineplus">+    for (nsNameSpaceMap::const_iterator entry = first; entry != last; ++entry) {</span>
<a href="#l40.973"></a><span id="l40.973" class="difflineplus">+        if (entry != first) {</span>
<a href="#l40.974"></a><span id="l40.974" class="difflineplus">+            rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;\n         &quot;));</span>
<a href="#l40.975"></a><span id="l40.975" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.976"></a><span id="l40.976" class="difflineplus">+        }</span>
<a href="#l40.977"></a><span id="l40.977" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;xmlns&quot;));</span>
<a href="#l40.978"></a><span id="l40.978" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.979"></a><span id="l40.979" class="difflineplus">+</span>
<a href="#l40.980"></a><span id="l40.980" class="difflineplus">+        if (entry-&gt;mPrefix) {</span>
<a href="#l40.981"></a><span id="l40.981" class="difflineplus">+            rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;:&quot;));</span>
<a href="#l40.982"></a><span id="l40.982" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.983"></a><span id="l40.983" class="difflineplus">+            nsAutoCString prefix;</span>
<a href="#l40.984"></a><span id="l40.984" class="difflineplus">+            entry-&gt;mPrefix-&gt;ToUTF8String(prefix);</span>
<a href="#l40.985"></a><span id="l40.985" class="difflineplus">+            rv = rdf_BlockingWrite(aStream, prefix);</span>
<a href="#l40.986"></a><span id="l40.986" class="difflineplus">+            if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.987"></a><span id="l40.987" class="difflineplus">+        }</span>
<a href="#l40.988"></a><span id="l40.988" class="difflineplus">+</span>
<a href="#l40.989"></a><span id="l40.989" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;=\&quot;&quot;));</span>
<a href="#l40.990"></a><span id="l40.990" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.991"></a><span id="l40.991" class="difflineplus">+        nsAutoCString uri(entry-&gt;mURI);</span>
<a href="#l40.992"></a><span id="l40.992" class="difflineplus">+        rdf_EscapeAttributeValue(uri);</span>
<a href="#l40.993"></a><span id="l40.993" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, uri);</span>
<a href="#l40.994"></a><span id="l40.994" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.995"></a><span id="l40.995" class="difflineplus">+        rv = rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;\&quot;&quot;));</span>
<a href="#l40.996"></a><span id="l40.996" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.997"></a><span id="l40.997" class="difflineplus">+    }</span>
<a href="#l40.998"></a><span id="l40.998" class="difflineplus">+</span>
<a href="#l40.999"></a><span id="l40.999" class="difflineplus">+    return rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&gt;\n&quot;));</span>
<a href="#l40.1000"></a><span id="l40.1000" class="difflineplus">+}</span>
<a href="#l40.1001"></a><span id="l40.1001" class="difflineplus">+</span>
<a href="#l40.1002"></a><span id="l40.1002" class="difflineplus">+</span>
<a href="#l40.1003"></a><span id="l40.1003" class="difflineplus">+nsresult</span>
<a href="#l40.1004"></a><span id="l40.1004" class="difflineplus">+nsRDFXMLSerializer::SerializeEpilogue(nsIOutputStream* aStream)</span>
<a href="#l40.1005"></a><span id="l40.1005" class="difflineplus">+{</span>
<a href="#l40.1006"></a><span id="l40.1006" class="difflineplus">+    return rdf_BlockingWrite(aStream, NS_LITERAL_CSTRING(&quot;&lt;/RDF:RDF&gt;\n&quot;));</span>
<a href="#l40.1007"></a><span id="l40.1007" class="difflineplus">+}</span>
<a href="#l40.1008"></a><span id="l40.1008" class="difflineplus">+</span>
<a href="#l40.1009"></a><span id="l40.1009" class="difflineplus">+class QNameCollector final : public rdfITripleVisitor {</span>
<a href="#l40.1010"></a><span id="l40.1010" class="difflineplus">+public:</span>
<a href="#l40.1011"></a><span id="l40.1011" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l40.1012"></a><span id="l40.1012" class="difflineplus">+    NS_DECL_RDFITRIPLEVISITOR</span>
<a href="#l40.1013"></a><span id="l40.1013" class="difflineplus">+    explicit QNameCollector(nsRDFXMLSerializer* aParent)</span>
<a href="#l40.1014"></a><span id="l40.1014" class="difflineplus">+        : mParent(aParent){}</span>
<a href="#l40.1015"></a><span id="l40.1015" class="difflineplus">+private:</span>
<a href="#l40.1016"></a><span id="l40.1016" class="difflineplus">+    ~QNameCollector() {}</span>
<a href="#l40.1017"></a><span id="l40.1017" class="difflineplus">+    nsRDFXMLSerializer* mParent;</span>
<a href="#l40.1018"></a><span id="l40.1018" class="difflineplus">+};</span>
<a href="#l40.1019"></a><span id="l40.1019" class="difflineplus">+</span>
<a href="#l40.1020"></a><span id="l40.1020" class="difflineplus">+NS_IMPL_ISUPPORTS(QNameCollector, rdfITripleVisitor)</span>
<a href="#l40.1021"></a><span id="l40.1021" class="difflineplus">+nsresult</span>
<a href="#l40.1022"></a><span id="l40.1022" class="difflineplus">+QNameCollector::Visit(nsIRDFNode* aSubject, nsIRDFResource* aPredicate,</span>
<a href="#l40.1023"></a><span id="l40.1023" class="difflineplus">+                      nsIRDFNode* aObject, bool aTruthValue)</span>
<a href="#l40.1024"></a><span id="l40.1024" class="difflineplus">+{</span>
<a href="#l40.1025"></a><span id="l40.1025" class="difflineplus">+    if (aPredicate == nsRDFXMLSerializer::kRDF_type) {</span>
<a href="#l40.1026"></a><span id="l40.1026" class="difflineplus">+        // try to get a type QName for aObject, should be a resource</span>
<a href="#l40.1027"></a><span id="l40.1027" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; resType = do_QueryInterface(aObject);</span>
<a href="#l40.1028"></a><span id="l40.1028" class="difflineplus">+        if (!resType) {</span>
<a href="#l40.1029"></a><span id="l40.1029" class="difflineplus">+            // ignore error</span>
<a href="#l40.1030"></a><span id="l40.1030" class="difflineplus">+            return NS_OK;</span>
<a href="#l40.1031"></a><span id="l40.1031" class="difflineplus">+        }</span>
<a href="#l40.1032"></a><span id="l40.1032" class="difflineplus">+        if (mParent-&gt;mQNames.Get(resType, nullptr)) {</span>
<a href="#l40.1033"></a><span id="l40.1033" class="difflineplus">+            return NS_OK;</span>
<a href="#l40.1034"></a><span id="l40.1034" class="difflineplus">+        }</span>
<a href="#l40.1035"></a><span id="l40.1035" class="difflineplus">+        mParent-&gt;RegisterQName(resType);</span>
<a href="#l40.1036"></a><span id="l40.1036" class="difflineplus">+        return NS_OK;</span>
<a href="#l40.1037"></a><span id="l40.1037" class="difflineplus">+    }</span>
<a href="#l40.1038"></a><span id="l40.1038" class="difflineplus">+</span>
<a href="#l40.1039"></a><span id="l40.1039" class="difflineplus">+    if (mParent-&gt;mQNames.Get(aPredicate, nullptr)) {</span>
<a href="#l40.1040"></a><span id="l40.1040" class="difflineplus">+        return NS_OK;</span>
<a href="#l40.1041"></a><span id="l40.1041" class="difflineplus">+    }</span>
<a href="#l40.1042"></a><span id="l40.1042" class="difflineplus">+    if (aPredicate == nsRDFXMLSerializer::kRDF_instanceOf ||</span>
<a href="#l40.1043"></a><span id="l40.1043" class="difflineplus">+        aPredicate == nsRDFXMLSerializer::kRDF_nextVal)</span>
<a href="#l40.1044"></a><span id="l40.1044" class="difflineplus">+        return NS_OK;</span>
<a href="#l40.1045"></a><span id="l40.1045" class="difflineplus">+    bool isOrdinal = false;</span>
<a href="#l40.1046"></a><span id="l40.1046" class="difflineplus">+    nsRDFXMLSerializer::gRDFC-&gt;IsOrdinalProperty(aPredicate, &amp;isOrdinal);</span>
<a href="#l40.1047"></a><span id="l40.1047" class="difflineplus">+    if (isOrdinal)</span>
<a href="#l40.1048"></a><span id="l40.1048" class="difflineplus">+        return NS_OK;</span>
<a href="#l40.1049"></a><span id="l40.1049" class="difflineplus">+</span>
<a href="#l40.1050"></a><span id="l40.1050" class="difflineplus">+    mParent-&gt;RegisterQName(aPredicate);</span>
<a href="#l40.1051"></a><span id="l40.1051" class="difflineplus">+</span>
<a href="#l40.1052"></a><span id="l40.1052" class="difflineplus">+    return NS_OK;</span>
<a href="#l40.1053"></a><span id="l40.1053" class="difflineplus">+}</span>
<a href="#l40.1054"></a><span id="l40.1054" class="difflineplus">+</span>
<a href="#l40.1055"></a><span id="l40.1055" class="difflineplus">+nsresult</span>
<a href="#l40.1056"></a><span id="l40.1056" class="difflineplus">+nsRDFXMLSerializer::CollectNamespaces()</span>
<a href="#l40.1057"></a><span id="l40.1057" class="difflineplus">+{</span>
<a href="#l40.1058"></a><span id="l40.1058" class="difflineplus">+    // Iterate over all Triples to get namespaces for subject resource types</span>
<a href="#l40.1059"></a><span id="l40.1059" class="difflineplus">+    // and Predicates and cache all the QNames we want to use.</span>
<a href="#l40.1060"></a><span id="l40.1060" class="difflineplus">+    nsCOMPtr&lt;rdfITripleVisitor&gt; collector =</span>
<a href="#l40.1061"></a><span id="l40.1061" class="difflineplus">+        new QNameCollector(this);</span>
<a href="#l40.1062"></a><span id="l40.1062" class="difflineplus">+    nsCOMPtr&lt;rdfIDataSource&gt; ds = do_QueryInterface(mDataSource); // XXX API</span>
<a href="#l40.1063"></a><span id="l40.1063" class="difflineplus">+    NS_ENSURE_TRUE(collector &amp;&amp; ds, NS_ERROR_FAILURE);</span>
<a href="#l40.1064"></a><span id="l40.1064" class="difflineplus">+    return ds-&gt;VisitAllTriples(collector);</span>
<a href="#l40.1065"></a><span id="l40.1065" class="difflineplus">+}</span>
<a href="#l40.1066"></a><span id="l40.1066" class="difflineplus">+</span>
<a href="#l40.1067"></a><span id="l40.1067" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l40.1068"></a><span id="l40.1068" class="difflineplus">+</span>
<a href="#l40.1069"></a><span id="l40.1069" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l40.1070"></a><span id="l40.1070" class="difflineplus">+nsRDFXMLSerializer::Serialize(nsIOutputStream* aStream)</span>
<a href="#l40.1071"></a><span id="l40.1071" class="difflineplus">+{</span>
<a href="#l40.1072"></a><span id="l40.1072" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.1073"></a><span id="l40.1073" class="difflineplus">+</span>
<a href="#l40.1074"></a><span id="l40.1074" class="difflineplus">+    rv = CollectNamespaces();</span>
<a href="#l40.1075"></a><span id="l40.1075" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.1076"></a><span id="l40.1076" class="difflineplus">+</span>
<a href="#l40.1077"></a><span id="l40.1077" class="difflineplus">+    nsCOMPtr&lt;nsISimpleEnumerator&gt; resources;</span>
<a href="#l40.1078"></a><span id="l40.1078" class="difflineplus">+    rv = mDataSource-&gt;GetAllResources(getter_AddRefs(resources));</span>
<a href="#l40.1079"></a><span id="l40.1079" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l40.1080"></a><span id="l40.1080" class="difflineplus">+</span>
<a href="#l40.1081"></a><span id="l40.1081" class="difflineplus">+    rv = SerializePrologue(aStream);</span>
<a href="#l40.1082"></a><span id="l40.1082" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l40.1083"></a><span id="l40.1083" class="difflineplus">+        return rv;</span>
<a href="#l40.1084"></a><span id="l40.1084" class="difflineplus">+</span>
<a href="#l40.1085"></a><span id="l40.1085" class="difflineplus">+    while (1) {</span>
<a href="#l40.1086"></a><span id="l40.1086" class="difflineplus">+        bool hasMore = false;</span>
<a href="#l40.1087"></a><span id="l40.1087" class="difflineplus">+        resources-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l40.1088"></a><span id="l40.1088" class="difflineplus">+        if (! hasMore)</span>
<a href="#l40.1089"></a><span id="l40.1089" class="difflineplus">+            break;</span>
<a href="#l40.1090"></a><span id="l40.1090" class="difflineplus">+</span>
<a href="#l40.1091"></a><span id="l40.1091" class="difflineplus">+        nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l40.1092"></a><span id="l40.1092" class="difflineplus">+        resources-&gt;GetNext(getter_AddRefs(isupports));</span>
<a href="#l40.1093"></a><span id="l40.1093" class="difflineplus">+</span>
<a href="#l40.1094"></a><span id="l40.1094" class="difflineplus">+        nsCOMPtr&lt;nsIRDFResource&gt; resource = do_QueryInterface(isupports);</span>
<a href="#l40.1095"></a><span id="l40.1095" class="difflineplus">+        if (! resource)</span>
<a href="#l40.1096"></a><span id="l40.1096" class="difflineplus">+            continue;</span>
<a href="#l40.1097"></a><span id="l40.1097" class="difflineplus">+</span>
<a href="#l40.1098"></a><span id="l40.1098" class="difflineplus">+        if (IsA(mDataSource, resource, kRDF_Bag) ||</span>
<a href="#l40.1099"></a><span id="l40.1099" class="difflineplus">+            IsA(mDataSource, resource, kRDF_Seq) ||</span>
<a href="#l40.1100"></a><span id="l40.1100" class="difflineplus">+            IsA(mDataSource, resource, kRDF_Alt)) {</span>
<a href="#l40.1101"></a><span id="l40.1101" class="difflineplus">+            rv = SerializeContainer(aStream, resource);</span>
<a href="#l40.1102"></a><span id="l40.1102" class="difflineplus">+        }</span>
<a href="#l40.1103"></a><span id="l40.1103" class="difflineplus">+        else {</span>
<a href="#l40.1104"></a><span id="l40.1104" class="difflineplus">+            rv = SerializeDescription(aStream, resource);</span>
<a href="#l40.1105"></a><span id="l40.1105" class="difflineplus">+        }</span>
<a href="#l40.1106"></a><span id="l40.1106" class="difflineplus">+</span>
<a href="#l40.1107"></a><span id="l40.1107" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l40.1108"></a><span id="l40.1108" class="difflineplus">+            break;</span>
<a href="#l40.1109"></a><span id="l40.1109" class="difflineplus">+    }</span>
<a href="#l40.1110"></a><span id="l40.1110" class="difflineplus">+</span>
<a href="#l40.1111"></a><span id="l40.1111" class="difflineplus">+    rv = SerializeEpilogue(aStream);</span>
<a href="#l40.1112"></a><span id="l40.1112" class="difflineplus">+</span>
<a href="#l40.1113"></a><span id="l40.1113" class="difflineplus">+    return rv;</span>
<a href="#l40.1114"></a><span id="l40.1114" class="difflineplus">+}</span>
<a href="#l40.1115"></a><span id="l40.1115" class="difflineplus">+</span>
<a href="#l40.1116"></a><span id="l40.1116" class="difflineplus">+</span>
<a href="#l40.1117"></a><span id="l40.1117" class="difflineplus">+bool</span>
<a href="#l40.1118"></a><span id="l40.1118" class="difflineplus">+nsRDFXMLSerializer::IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType)</span>
<a href="#l40.1119"></a><span id="l40.1119" class="difflineplus">+{</span>
<a href="#l40.1120"></a><span id="l40.1120" class="difflineplus">+    nsresult rv;</span>
<a href="#l40.1121"></a><span id="l40.1121" class="difflineplus">+</span>
<a href="#l40.1122"></a><span id="l40.1122" class="difflineplus">+    bool result;</span>
<a href="#l40.1123"></a><span id="l40.1123" class="difflineplus">+    rv = aDataSource-&gt;HasAssertion(aResource, kRDF_instanceOf, aType, true, &amp;result);</span>
<a href="#l40.1124"></a><span id="l40.1124" class="difflineplus">+    if (NS_FAILED(rv)) return false;</span>
<a href="#l40.1125"></a><span id="l40.1125" class="difflineplus">+</span>
<a href="#l40.1126"></a><span id="l40.1126" class="difflineplus">+    return result;</span>
<a href="#l40.1127"></a><span id="l40.1127" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/rdf/base/nsRDFXMLSerializer.h</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,117 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+ *</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+#ifndef nsRDFXMLSerializer_h__</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+#define nsRDFXMLSerializer_h__</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+#include &quot;nsIRDFLiteral.h&quot;</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+#include &quot;nsIRDFXMLSerializer.h&quot;</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+#include &quot;nsIRDFXMLSource.h&quot;</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+#include &quot;nsNameSpaceMap.h&quot;</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+#include &quot;nsDataHashtable.h&quot;</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+#include &quot;rdfITripleVisitor.h&quot;</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineplus">+class nsIOutputStream;</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+class nsIRDFContainerUtils;</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+/**</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+ * A helper class that can serialize RDF/XML from a</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+ * datasource. Implements both nsIRDFXMLSerializer and</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+ * nsIRDFXMLSource.</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+ */</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+class nsRDFXMLSerializer : public nsIRDFXMLSerializer,</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+                           public nsIRDFXMLSource</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+{</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+public:</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+    static nsresult</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+    Create(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+    NS_DECL_ISUPPORTS</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+    NS_DECL_NSIRDFXMLSERIALIZER</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+    NS_DECL_NSIRDFXMLSOURCE</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+protected:</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+    nsRDFXMLSerializer();</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+    virtual ~nsRDFXMLSerializer();</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+    // Implementation methods</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+    nsresult</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+    RegisterQName(nsIRDFResource* aResource);</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+    nsresult</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+    GetQName(nsIRDFResource* aResource, nsCString&amp; aQName);</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+    already_AddRefed&lt;nsAtom&gt;</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+    EnsureNewPrefix();</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+    nsresult</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+    SerializeInlineAssertion(nsIOutputStream* aStream,</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+                             nsIRDFResource* aResource,</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+                             nsIRDFResource* aProperty,</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+                             nsIRDFLiteral* aValue);</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+    nsresult</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+    SerializeChildAssertion(nsIOutputStream* aStream,</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+                            nsIRDFResource* aResource,</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+                            nsIRDFResource* aProperty,</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+                            nsIRDFNode* aValue);</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+    nsresult</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+    SerializeProperty(nsIOutputStream* aStream,</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+                      nsIRDFResource* aResource,</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+                      nsIRDFResource* aProperty,</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+                      bool aInline,</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+                      int32_t* aSkipped);</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+    bool</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+    IsContainerProperty(nsIRDFResource* aProperty);</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+    nsresult</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+    SerializeDescription(nsIOutputStream* aStream,</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+                         nsIRDFResource* aResource);</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+    nsresult</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+    SerializeMember(nsIOutputStream* aStream,</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+                    nsIRDFResource* aContainer,</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+                    nsIRDFNode* aMember);</span>
<a href="#l41.84"></a><span id="l41.84" class="difflineplus">+</span>
<a href="#l41.85"></a><span id="l41.85" class="difflineplus">+    nsresult</span>
<a href="#l41.86"></a><span id="l41.86" class="difflineplus">+    SerializeContainer(nsIOutputStream* aStream,</span>
<a href="#l41.87"></a><span id="l41.87" class="difflineplus">+                       nsIRDFResource* aContainer);</span>
<a href="#l41.88"></a><span id="l41.88" class="difflineplus">+</span>
<a href="#l41.89"></a><span id="l41.89" class="difflineplus">+    nsresult</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineplus">+    SerializePrologue(nsIOutputStream* aStream);</span>
<a href="#l41.91"></a><span id="l41.91" class="difflineplus">+</span>
<a href="#l41.92"></a><span id="l41.92" class="difflineplus">+    nsresult</span>
<a href="#l41.93"></a><span id="l41.93" class="difflineplus">+    SerializeEpilogue(nsIOutputStream* aStream);</span>
<a href="#l41.94"></a><span id="l41.94" class="difflineplus">+</span>
<a href="#l41.95"></a><span id="l41.95" class="difflineplus">+    nsresult</span>
<a href="#l41.96"></a><span id="l41.96" class="difflineplus">+    CollectNamespaces();</span>
<a href="#l41.97"></a><span id="l41.97" class="difflineplus">+</span>
<a href="#l41.98"></a><span id="l41.98" class="difflineplus">+    bool</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineplus">+    IsA(nsIRDFDataSource* aDataSource, nsIRDFResource* aResource, nsIRDFResource* aType);</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineplus">+</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDataSource&gt; mDataSource;</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+    nsNameSpaceMap mNameSpaces;</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+    nsCString mBaseURLSpec;</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+    // hash mapping resources to utf8-encoded QNames</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+    nsDataHashtable&lt;nsISupportsHashKey, nsCString&gt; mQNames;</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+    friend class QNameCollector;</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+    uint32_t mPrefixID;</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+    static int32_t gRefCnt;</span>
<a href="#l41.112"></a><span id="l41.112" class="difflineplus">+    static nsIRDFResource* kRDF_instanceOf;</span>
<a href="#l41.113"></a><span id="l41.113" class="difflineplus">+    static nsIRDFResource* kRDF_type;</span>
<a href="#l41.114"></a><span id="l41.114" class="difflineplus">+    static nsIRDFResource* kRDF_nextVal;</span>
<a href="#l41.115"></a><span id="l41.115" class="difflineplus">+    static nsIRDFResource* kRDF_Bag;</span>
<a href="#l41.116"></a><span id="l41.116" class="difflineplus">+    static nsIRDFResource* kRDF_Seq;</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineplus">+    static nsIRDFResource* kRDF_Alt;</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+    static nsIRDFContainerUtils* gRDFC;</span>
<a href="#l41.119"></a><span id="l41.119" class="difflineplus">+};</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineplus">+</span>
<a href="#l41.121"></a><span id="l41.121" class="difflineplus">+#endif // nsRDFXMLSerializer_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">new file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- /dev/null</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ b/rdf/base/rdf.h</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+/*</span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+  A catch-all header file for miscellaneous RDF stuff. Currently</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+  contains error codes and vocabulary macros.</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+ */</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+#ifndef rdf_h___</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+#define rdf_h___</span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+/**</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+ * The following macros are to aid in vocabulary definition.  They</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+ * creates const char*'s for &quot;kURI[prefix]_[name]&quot;, appropriate</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+ * complete namespace qualification on the URI, e.g.,</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineplus">+ *</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+ * #define RDF_NAMESPACE_URI &quot;http://www.w3.org/TR/WD-rdf-syntax#&quot;</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+ * DEFINE_RDF_ELEMENT(RDF_NAMESPACE_URI, RDF, ID);</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+ *</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineplus">+ * will define:</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+ *</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+ * kURIRDF_ID to be &quot;http://www.w3.org/TR/WD-rdf-syntax#ID&quot;</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineplus">+ */</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineplus">+</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+#define DEFINE_RDF_VOCAB(ns, prefix, name) \</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+static const char kURI##prefix##_##name[] = ns #name</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineplus">+</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineplus">+/**</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineplus">+ * Core RDF vocabularies that we use to define semantics</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+ */</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+#define RDF_NAMESPACE_URI  &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+#define WEB_NAMESPACE_URI  &quot;http://home.netscape.com/WEB-rdf#&quot;</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+#define NC_NAMESPACE_URI   &quot;http://home.netscape.com/NC-rdf#&quot;</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+/* ContractID prefixes for RDF DLL registration. */</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+#define NS_RDF_CONTRACTID                           &quot;@mozilla.org/rdf&quot;</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+#define NS_RDF_DATASOURCE_CONTRACTID                NS_RDF_CONTRACTID &quot;/datasource;1&quot;</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+#define NS_RDF_DATASOURCE_CONTRACTID_PREFIX         NS_RDF_DATASOURCE_CONTRACTID &quot;?name=&quot;</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+#define NS_RDF_RESOURCE_FACTORY_CONTRACTID          &quot;@mozilla.org/rdf/resource-factory;1&quot;</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+#define NS_RDF_RESOURCE_FACTORY_CONTRACTID_PREFIX   NS_RDF_RESOURCE_FACTORY_CONTRACTID &quot;?name=&quot;</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+#define NS_RDF_INFER_DATASOURCE_CONTRACTID_PREFIX   NS_RDF_CONTRACTID &quot;/infer-datasource;1?engine=&quot;</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+// contract ID is in the form</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+// @mozilla.org/rdf/delegate-factory;1?key=&lt;key&gt;&amp;scheme=&lt;scheme&gt;</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+#define NS_RDF_DELEGATEFACTORY_CONTRACTID    &quot;@mozilla.org/rdf/delegate-factory;1&quot;</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+#define NS_RDF_DELEGATEFACTORY_CONTRACTID_PREFIX    NS_RDF_DELEGATEFACTORY_CONTRACTID &quot;?key=&quot;</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+/*@}*/</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+#endif /* rdf_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">new file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- /dev/null</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ b/rdf/base/rdfIDataSource.idl</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -0,0 +1,38 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineplus">+/* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineplus">+</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineplus">+interface rdfITripleVisitor;</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+/**</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+ * Interface used in RDF to describe data sources.</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+ *</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+ * @status PLASMA</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+ */</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+[scriptable, uuid(ebce86bd-1568-4a34-a808-9ccf9cde8087)]</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+interface rdfIDataSource : nsISupports</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+{</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+    /**</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+     * Visit all the subject resources in the datasource. The order is</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+     * intederminate and may change from one invocation to the next.</span>
<a href="#l43.26"></a><span id="l43.26" class="difflineplus">+     * The subjects will be in the aSubject argument in calls into</span>
<a href="#l43.27"></a><span id="l43.27" class="difflineplus">+     * aVisitor, aPredicate and aObject will be null.</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineplus">+     * @note Implementations may throw NS_ERROR_NOT_IMPLEMENTED for</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+     * this method, but in this case RDF serializations of this</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+     * datasource will not be possible.</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+     */</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+    void visitAllSubjects(in rdfITripleVisitor aVisitor);</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineplus">+</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+    /**</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineplus">+     * Visit all the triples in the datasource. The order is</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+     * intederminate and may change from one invocation to the next.</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+     * @note Implementations may throw NS_ERROR_NOT_IMPLEMENTED for</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+     * this method, but in this case RDF serializations of this</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+     * datasource will not be possible.</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+     */</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+    void visitAllTriples(in rdfITripleVisitor aVisitor);</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">new file mode 100644</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineminus">--- /dev/null</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineplus">+++ b/rdf/base/rdfITripleVisitor.idl</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineat">@@ -0,0 +1,31 @@</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineplus">+/* -*- Mode: IDL; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l44.6"></a><span id="l44.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.7"></a><span id="l44.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.8"></a><span id="l44.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+interface nsIRDFResource;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+interface nsIRDFNode;</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+/**</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+ * Interface used in RDF to enumerate triples.</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+ * Also used by rdfIDataSource::getAllSubjects, then aPredicate,</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+ * aObject and aTruthValue are ignored.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+ *</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+ * @status PLASMA</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+ */</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+[scriptable, function, uuid(aafea151-c271-4505-9978-a100d292800c)]</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+interface rdfITripleVisitor : nsISupports</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+{</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+    /**</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+     * Callback function for returning query results.</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+     *</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+     * @param aSubject, aPredicate, aObject describe the (sub-)arc</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+     * @returnCode NS_RDF_STOP_VISIT to stop iterating over the query result.</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+     *             Any error code will stop the iteration as well.</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+     */</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+    void visit(in nsIRDFNode aSubject, in nsIRDFResource aPredicate,</span>
<a href="#l44.34"></a><span id="l44.34" class="difflineplus">+               in nsIRDFNode aObject, in boolean aTruthValue);</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">new file mode 100644</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineminus">--- /dev/null</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineplus">+++ b/rdf/base/rdfutil.cpp</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineat">@@ -0,0 +1,110 @@</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l45.6"></a><span id="l45.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l45.7"></a><span id="l45.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.8"></a><span id="l45.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineplus">+</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineplus">+/*</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineplus">+</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+  Implementations for a bunch of useful RDF utility routines.  Many of</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+  these will eventually be exported outside of RDF.DLL via the</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+  nsIRDFService interface.</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+  TO DO</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+  1) Make this so that it doesn't permanently leak the RDF service</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineplus">+     object.</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineplus">+</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+  2) Make container functions thread-safe. They currently don't ensure</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+     that the RDF:nextVal property is maintained safely.</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineplus">+</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+ */</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineplus">+#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineplus">+#include &quot;nsIURL.h&quot;</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+#include &quot;nsIIOService.h&quot;</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+#include &quot;nsIURL.h&quot;</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineplus">+#include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineplus">+#include &quot;rdfutil.h&quot;</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+#include &quot;prtime.h&quot;</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineplus">+</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineplus">+nsresult</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+rdf_MakeRelativeRef(const nsACString&amp; aBaseURI, nsCString&amp; aURI)</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+{</span>
<a href="#l45.45"></a><span id="l45.45" class="difflineplus">+    // This implementation is extremely simple: e.g., it can't compute</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineplus">+    // relative paths, or anything fancy like that. If the context URI</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+    // is not a prefix of the URI in question, we'll just bail.</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+    uint32_t prefixLen = aBaseURI.Length();</span>
<a href="#l45.49"></a><span id="l45.49" class="difflineplus">+    if (prefixLen != 0 &amp;&amp; StringBeginsWith(aURI, aBaseURI)) {</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineplus">+        if (prefixLen &lt; aURI.Length() &amp;&amp; aURI.CharAt(prefixLen) == '/')</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+            ++prefixLen; // chop the leading slash so it's not `absolute'</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineplus">+</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineplus">+        aURI.Cut(0, prefixLen);</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+    }</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+    return NS_OK;</span>
<a href="#l45.57"></a><span id="l45.57" class="difflineplus">+}</span>
<a href="#l45.58"></a><span id="l45.58" class="difflineplus">+</span>
<a href="#l45.59"></a><span id="l45.59" class="difflineplus">+void</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineplus">+rdf_FormatDate(PRTime aTime, nsACString &amp;aResult)</span>
<a href="#l45.61"></a><span id="l45.61" class="difflineplus">+{</span>
<a href="#l45.62"></a><span id="l45.62" class="difflineplus">+    // Outputs Unixish date in GMT plus usecs; e.g.,</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineplus">+    //   Wed Jan  9 19:15:13 2002 +002441</span>
<a href="#l45.64"></a><span id="l45.64" class="difflineplus">+    //</span>
<a href="#l45.65"></a><span id="l45.65" class="difflineplus">+    PRExplodedTime t;</span>
<a href="#l45.66"></a><span id="l45.66" class="difflineplus">+    PR_ExplodeTime(aTime, PR_GMTParameters, &amp;t);</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineplus">+</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineplus">+    char buf[256];</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineplus">+    PR_FormatTimeUSEnglish(buf, sizeof buf, &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;t);</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+    aResult.Append(buf);</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+    // usecs</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+    aResult.AppendLiteral(&quot; +&quot;);</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+    int32_t usec = t.tm_usec;</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+    for (int32_t digit = 100000; digit &gt; 1; digit /= 10) {</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+        aResult.Append(char('0' + (usec / digit)));</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineplus">+        usec %= digit;</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+    }</span>
<a href="#l45.79"></a><span id="l45.79" class="difflineplus">+    aResult.Append(char('0' + usec));</span>
<a href="#l45.80"></a><span id="l45.80" class="difflineplus">+}</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineplus">+</span>
<a href="#l45.82"></a><span id="l45.82" class="difflineplus">+PRTime</span>
<a href="#l45.83"></a><span id="l45.83" class="difflineplus">+rdf_ParseDate(const nsACString &amp;aTime)</span>
<a href="#l45.84"></a><span id="l45.84" class="difflineplus">+{</span>
<a href="#l45.85"></a><span id="l45.85" class="difflineplus">+    PRTime t;</span>
<a href="#l45.86"></a><span id="l45.86" class="difflineplus">+    PR_ParseTimeString(PromiseFlatCString(aTime).get(), true, &amp;t);</span>
<a href="#l45.87"></a><span id="l45.87" class="difflineplus">+</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineplus">+    int32_t usec = 0;</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+</span>
<a href="#l45.90"></a><span id="l45.90" class="difflineplus">+    nsACString::const_iterator begin, digit, end;</span>
<a href="#l45.91"></a><span id="l45.91" class="difflineplus">+    aTime.BeginReading(begin);</span>
<a href="#l45.92"></a><span id="l45.92" class="difflineplus">+    aTime.EndReading(end);</span>
<a href="#l45.93"></a><span id="l45.93" class="difflineplus">+</span>
<a href="#l45.94"></a><span id="l45.94" class="difflineplus">+    // Walk backwards until we find a `+', run out of string, or a</span>
<a href="#l45.95"></a><span id="l45.95" class="difflineplus">+    // non-numeric character.</span>
<a href="#l45.96"></a><span id="l45.96" class="difflineplus">+    digit = end;</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineplus">+    while (--digit != begin &amp;&amp; *digit != '+') {</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineplus">+        if (*digit &lt; '0' || *digit &gt; '9')</span>
<a href="#l45.99"></a><span id="l45.99" class="difflineplus">+            break;</span>
<a href="#l45.100"></a><span id="l45.100" class="difflineplus">+    }</span>
<a href="#l45.101"></a><span id="l45.101" class="difflineplus">+</span>
<a href="#l45.102"></a><span id="l45.102" class="difflineplus">+    if (digit != begin &amp;&amp; *digit == '+') {</span>
<a href="#l45.103"></a><span id="l45.103" class="difflineplus">+        // There's a usec field specified (or, at least, something</span>
<a href="#l45.104"></a><span id="l45.104" class="difflineplus">+        // that looks close enough. Parse it, and add it to the time.</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineplus">+        while (++digit != end) {</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineplus">+            usec *= 10;</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineplus">+            usec += *digit - '0';</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineplus">+        }</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineplus">+</span>
<a href="#l45.110"></a><span id="l45.110" class="difflineplus">+        t += usec;</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineplus">+    }</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineplus">+</span>
<a href="#l45.113"></a><span id="l45.113" class="difflineplus">+    return t;</span>
<a href="#l45.114"></a><span id="l45.114" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">new file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- /dev/null</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ b/rdf/base/rdfutil.h</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -0,0 +1,38 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+/*</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+  A bunch of useful RDF utility routines.  Many of these will</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineplus">+  eventually be exported outside of RDF.DLL via the nsIRDFService</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+  interface.</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+  TO DO</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+  1) Move the anonymous resource stuff to nsIRDFService?</span>
<a href="#l46.20"></a><span id="l46.20" class="difflineplus">+</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineplus">+  2) All that's left is rdf_PossiblyMakeRelative() and</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+     -Absolute(). Maybe those go on nsIRDFService, too.</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineplus">+</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineplus">+ */</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+</span>
<a href="#l46.26"></a><span id="l46.26" class="difflineplus">+#ifndef rdfutil_h__</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineplus">+#define rdfutil_h__</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineplus">+</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+#include &quot;nsStringFwd.h&quot;</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineplus">+</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+nsresult</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineplus">+rdf_MakeRelativeRef(const nsACString&amp; aBaseURI, nsCString&amp; aURI);</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+void</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+rdf_FormatDate(PRTime aTime, nsACString &amp;aResult);</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineplus">+PRTime</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+rdf_ParseDate(const nsACString &amp;aTime);</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+#endif // rdfutil_h__</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">new file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- /dev/null</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ b/rdf/build/moz.build</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+EXPORTS += [</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+    'nsRDFCID.h',</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+]</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+SOURCES += [</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+    'nsRDFModule.cpp',</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+]</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+FINAL_LIBRARY = 'xul'</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+LOCAL_INCLUDES += [</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineplus">+    '../base',</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineplus">+    '../datasource',</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">new file mode 100644</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineminus">--- /dev/null</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineplus">+++ b/rdf/build/nsRDFCID.h</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineat">@@ -0,0 +1,76 @@</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+/*</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineplus">+</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineplus">+  XPCOM Class IDs for RDF objects that can be constructed via the RDF</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+  factory.</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+ */</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+#ifndef nsRDFCID_h__</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+#define nsRDFCID_h__</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+// {0F78DA56-8321-11d2-8EAC-00805F29F370}</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+#define NS_RDFDEFAULTRESOURCE_CID \</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineplus">+{ 0xf78da56, 0x8321, 0x11d2, { 0x8e, 0xac, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineplus">+</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+// {BFD05264-834C-11d2-8EAC-00805F29F370}</span>
<a href="#l48.25"></a><span id="l48.25" class="difflineplus">+#define NS_RDFSERVICE_CID \</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineplus">+{ 0xbfd05264, 0x834c, 0x11d2, { 0x8e, 0xac, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+// {BFD0526D-834C-11d2-8EAC-00805F29F370}</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+#define NS_RDFINMEMORYDATASOURCE_CID \</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineplus">+{ 0xbfd0526d, 0x834c, 0x11d2, { 0x8e, 0xac, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+// {E638D760-8687-11d2-B530-000000000001}</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+#define NS_RDFFILESYSTEMDATASOURCE_CID \</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+{ 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x01 } }</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+// {6bd1d807-1c67-11d3-9820-ed1b357eb3c4}</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+#define NS_RDFSEARCHDATASOURCE_CID \</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineplus">+{ 0x6bd1d807, 0x1c67, 0x11d3, { 0x98, 0x20, 0xed, 0x1b, 0x35, 0x7e, 0xb3, 0xc4 } }</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineplus">+// {E638D760-8687-11d2-B530-000000000002}</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineplus">+#define NS_RDFFINDDATASOURCE_CID \</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineplus">+{ 0xe638d760, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x02 } }</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineplus">+</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineplus">+// {E638D761-8687-11d2-B530-000000000000}</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineplus">+#define NS_RDFCOMPOSITEDATASOURCE_CID \</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineplus">+{ 0xe638d761, 0x8687, 0x11d2, { 0xb5, 0x30, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 } }</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineplus">+</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineplus">+// {7BAF62E0-8E61-11d2-8EB1-00805F29F370}</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+#define NS_RDFXMLDATASOURCE_CID \</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineplus">+{ 0x7baf62e0, 0x8e61, 0x11d2, { 0x8e, 0xb1, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+// {0958B101-9ADA-11d2-8EBC-00805F29F370}</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+#define NS_RDFCONTENTSINK_CID \</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineplus">+{ 0x958b101, 0x9ada, 0x11d2, { 0x8e, 0xbc, 0x0, 0x80, 0x5f, 0x29, 0xf3, 0x70 } }</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+// {1EAAFD60-D596-11d2-80BE-006097B76B8E}</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+#define NS_RDFHISTORYDATASOURCE_CID \</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+{ 0x1eaafd60, 0xd596, 0x11d2, { 0x80, 0xbe, 0x0, 0x60, 0x97, 0xb7, 0x6b, 0x8e } }</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+// {D4214E92-FB94-11d2-BDD8-00104BDE6048}</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+#define NS_RDFCONTAINERUTILS_CID \</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+{ 0xd4214e92, 0xfb94, 0x11d2, { 0xbd, 0xd8, 0x0, 0x10, 0x4b, 0xde, 0x60, 0x48 } }</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+// {D4214E93-FB94-11d2-BDD8-00104BDE6048}</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+#define NS_RDFCONTAINER_CID \</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+{ 0xd4214e93, 0xfb94, 0x11d2, { 0xbd, 0xd8, 0x0, 0x10, 0x4b, 0xde, 0x60, 0x48 } }</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+// {0032d852-1dd2-11b2-95f7-e0a1910ed2da}</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+#define NS_RDFXMLSERIALIZER_CID \</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+{ 0x0032d852, 0x1dd2, 0x11b2, { 0x95, 0xf7, 0xe0, 0xa1, 0x91, 0x0e, 0xd2, 0xda } }</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineplus">+</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+// {a4048e94-1dd1-11b2-a676-8a06c086cc7d}</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+#define NS_RDFXMLPARSER_CID \</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+{ 0xa4048e94, 0x1dd1, 0x11b2, { 0xa6, 0x76, 0x8a, 0x06, 0xc0, 0x86, 0xcc, 0x7d } }</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+// {0a5cd734-eb65-4d14-88a0-9f0bb2aba206}</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineplus">+#define NS_RDFNTRIPLES_SERIALIZER_CID \</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+{ 0x0a5cd734, 0xeb65, 0x4d14, { 0x88, 0xa0, 0x9f, 0x0b, 0xb2, 0xab, 0xa2, 0x06 } }</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+#endif // nsRDFCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">new file mode 100644</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineminus">--- /dev/null</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineplus">+++ b/rdf/build/nsRDFModule.cpp</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineat">@@ -0,0 +1,120 @@</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l49.6"></a><span id="l49.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.7"></a><span id="l49.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.8"></a><span id="l49.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+#include &quot;mozilla/ModuleUtils.h&quot;</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineplus">+</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+#include &quot;nsIFactory.h&quot;</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+#include &quot;nsRDFService.h&quot;</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+#include &quot;nsIRDFContainer.h&quot;</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+#include &quot;nsIRDFContainerUtils.h&quot;</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+#include &quot;nsIRDFCompositeDataSource.h&quot;</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+#include &quot;nsIRDFContentSink.h&quot;</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+#include &quot;nsRDFBaseDataSources.h&quot;</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineplus">+#include &quot;nsRDFBuiltInDataSources.h&quot;</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineplus">+#include &quot;nsILocalStore.h&quot;</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineplus">+#include &quot;nsRDFXMLParser.h&quot;</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+#include &quot;nsRDFXMLSerializer.h&quot;</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+// Functions used to create new instances of a given object by the</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineplus">+// generic factory.</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+#define MAKE_CTOR(_func,_new,_ifname)                                \</span>
<a href="#l49.35"></a><span id="l49.35" class="difflineplus">+static nsresult                                                      \</span>
<a href="#l49.36"></a><span id="l49.36" class="difflineplus">+CreateNew##_func(nsISupports* aOuter, REFNSIID aIID, void **aResult) \</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineplus">+{                                                                    \</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+    if (!aResult) {                                                  \</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+        return NS_ERROR_INVALID_POINTER;                             \</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+    }                                                                \</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineplus">+    if (aOuter) {                                                    \</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineplus">+        *aResult = nullptr;                                           \</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineplus">+        return NS_ERROR_NO_AGGREGATION;                              \</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineplus">+    }                                                                \</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+    nsI##_ifname* inst;                                              \</span>
<a href="#l49.46"></a><span id="l49.46" class="difflineplus">+    nsresult rv = NS_New##_new(&amp;inst);                               \</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineplus">+    if (NS_FAILED(rv)) {                                             \</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+        *aResult = nullptr;                                           \</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineplus">+        return rv;                                                   \</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+    }                                                                \</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+    rv = inst-&gt;QueryInterface(aIID, aResult);                        \</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+    if (NS_FAILED(rv)) {                                             \</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineplus">+        *aResult = nullptr;                                           \</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+    }                                                                \</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineplus">+    NS_RELEASE(inst);             /* get rid of extra refcnt */      \</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineplus">+    return rv;                                                       \</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+}</span>
<a href="#l49.58"></a><span id="l49.58" class="difflineplus">+</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineplus">+extern nsresult</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineplus">+NS_NewDefaultResource(nsIRDFResource** aResult);</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineplus">+MAKE_CTOR(RDFXMLDataSource,RDFXMLDataSource,RDFDataSource)</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineplus">+MAKE_CTOR(RDFCompositeDataSource,RDFCompositeDataSource,RDFCompositeDataSource)</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+MAKE_CTOR(RDFContainer,RDFContainer,RDFContainer)</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+MAKE_CTOR(RDFContainerUtils,RDFContainerUtils,RDFContainerUtils)</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineplus">+</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineplus">+MAKE_CTOR(RDFContentSink,RDFContentSink,RDFContentSink)</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+MAKE_CTOR(RDFDefaultResource,DefaultResource,RDFResource)</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineplus">+</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFCOMPOSITEDATASOURCE_CID);</span>
<a href="#l49.72"></a><span id="l49.72" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFINMEMORYDATASOURCE_CID);</span>
<a href="#l49.73"></a><span id="l49.73" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFXMLDATASOURCE_CID);</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFDEFAULTRESOURCE_CID);</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFCONTENTSINK_CID);</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFCONTAINER_CID);</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFCONTAINERUTILS_CID);</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFSERVICE_CID);</span>
<a href="#l49.79"></a><span id="l49.79" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFXMLPARSER_CID);</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_RDFXMLSERIALIZER_CID);</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_LOCALSTORE_CID);</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineplus">+</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+static const mozilla::Module::CIDEntry kRDFCIDs[] = {</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+    { &amp;kNS_RDFCOMPOSITEDATASOURCE_CID, false, nullptr, CreateNewRDFCompositeDataSource },</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineplus">+    { &amp;kNS_RDFINMEMORYDATASOURCE_CID, false, nullptr, NS_NewRDFInMemoryDataSource },</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineplus">+    { &amp;kNS_RDFXMLDATASOURCE_CID, false, nullptr, CreateNewRDFXMLDataSource },</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+    { &amp;kNS_RDFDEFAULTRESOURCE_CID, false, nullptr, CreateNewRDFDefaultResource },</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+    { &amp;kNS_RDFCONTENTSINK_CID, false, nullptr, CreateNewRDFContentSink },</span>
<a href="#l49.90"></a><span id="l49.90" class="difflineplus">+    { &amp;kNS_RDFCONTAINER_CID, false, nullptr, CreateNewRDFContainer },</span>
<a href="#l49.91"></a><span id="l49.91" class="difflineplus">+    { &amp;kNS_RDFCONTAINERUTILS_CID, false, nullptr, CreateNewRDFContainerUtils },</span>
<a href="#l49.92"></a><span id="l49.92" class="difflineplus">+    { &amp;kNS_RDFSERVICE_CID, false, nullptr, RDFServiceImpl::CreateSingleton },</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineplus">+    { &amp;kNS_RDFXMLPARSER_CID, false, nullptr, nsRDFXMLParser::Create },</span>
<a href="#l49.94"></a><span id="l49.94" class="difflineplus">+    { &amp;kNS_RDFXMLSERIALIZER_CID, false, nullptr, nsRDFXMLSerializer::Create },</span>
<a href="#l49.95"></a><span id="l49.95" class="difflineplus">+    { &amp;kNS_LOCALSTORE_CID, false, nullptr, NS_NewLocalStore },</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineplus">+    { nullptr }</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineplus">+};</span>
<a href="#l49.98"></a><span id="l49.98" class="difflineplus">+</span>
<a href="#l49.99"></a><span id="l49.99" class="difflineplus">+static const mozilla::Module::ContractIDEntry kRDFContracts[] = {</span>
<a href="#l49.100"></a><span id="l49.100" class="difflineplus">+    { NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;composite-datasource&quot;, &amp;kNS_RDFCOMPOSITEDATASOURCE_CID },</span>
<a href="#l49.101"></a><span id="l49.101" class="difflineplus">+    { NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;in-memory-datasource&quot;, &amp;kNS_RDFINMEMORYDATASOURCE_CID },</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineplus">+    { NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;xml-datasource&quot;, &amp;kNS_RDFXMLDATASOURCE_CID },</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+    { NS_RDF_RESOURCE_FACTORY_CONTRACTID, &amp;kNS_RDFDEFAULTRESOURCE_CID },</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineplus">+    { NS_RDF_CONTRACTID &quot;/content-sink;1&quot;, &amp;kNS_RDFCONTENTSINK_CID },</span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+    { NS_RDF_CONTRACTID &quot;/container;1&quot;, &amp;kNS_RDFCONTAINER_CID },</span>
<a href="#l49.106"></a><span id="l49.106" class="difflineplus">+    { NS_RDF_CONTRACTID &quot;/container-utils;1&quot;, &amp;kNS_RDFCONTAINERUTILS_CID },</span>
<a href="#l49.107"></a><span id="l49.107" class="difflineplus">+    { NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;kNS_RDFSERVICE_CID },</span>
<a href="#l49.108"></a><span id="l49.108" class="difflineplus">+    { NS_RDF_CONTRACTID &quot;/xml-parser;1&quot;, &amp;kNS_RDFXMLPARSER_CID },</span>
<a href="#l49.109"></a><span id="l49.109" class="difflineplus">+    { NS_RDF_CONTRACTID &quot;/xml-serializer;1&quot;, &amp;kNS_RDFXMLSERIALIZER_CID },</span>
<a href="#l49.110"></a><span id="l49.110" class="difflineplus">+    { NS_LOCALSTORE_CONTRACTID, &amp;kNS_LOCALSTORE_CID },</span>
<a href="#l49.111"></a><span id="l49.111" class="difflineplus">+    { nullptr }</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineplus">+};</span>
<a href="#l49.113"></a><span id="l49.113" class="difflineplus">+</span>
<a href="#l49.114"></a><span id="l49.114" class="difflineplus">+static const mozilla::Module kRDFModule = {</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineplus">+    mozilla::Module::kVersion,</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineplus">+    kRDFCIDs,</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineplus">+    kRDFContracts,</span>
<a href="#l49.118"></a><span id="l49.118" class="difflineplus">+    nullptr,</span>
<a href="#l49.119"></a><span id="l49.119" class="difflineplus">+    nullptr,</span>
<a href="#l49.120"></a><span id="l49.120" class="difflineplus">+    nullptr,</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineplus">+    nullptr</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineplus">+};</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineplus">+</span>
<a href="#l49.124"></a><span id="l49.124" class="difflineplus">+NSMODULE_DEFN(nsRDFModule) = &amp;kRDFModule;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">new file mode 100644</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineminus">--- /dev/null</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineplus">+++ b/rdf/datasource/moz.build</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l50.6"></a><span id="l50.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l50.7"></a><span id="l50.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineplus">+</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+EXPORTS += [</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+    'nsILocalStore.h',</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+]</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineplus">+</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+UNIFIED_SOURCES += [</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+    'nsLocalStore.cpp',</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+]</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+FINAL_LIBRARY = 'xul'</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineplus">+</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+# &quot;This is a dependency on rdfutil.h: it'll go away once that becomes</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+# a first-class XPCOM interface.&quot;</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+LOCAL_INCLUDES += [</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+    '../base',</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">new file mode 100644</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineminus">--- /dev/null</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineplus">+++ b/rdf/datasource/nsILocalStore.h</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineat">@@ -0,0 +1,34 @@</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l51.6"></a><span id="l51.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l51.7"></a><span id="l51.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineplus">+</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineplus">+#ifndef nsILocalStore_h__</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+#define nsILocalStore_h__</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+// {DF71C6F1-EC53-11d2-BDCA-000064657374}</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+#define NS_ILOCALSTORE_IID \</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+{ 0xdf71c6f1, 0xec53, 0x11d2, { 0xbd, 0xca, 0x0, 0x0, 0x64, 0x65, 0x73, 0x74 } }</span>
<a href="#l51.19"></a><span id="l51.19" class="difflineplus">+</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineplus">+// {DF71C6F0-EC53-11d2-BDCA-000064657374}</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineplus">+#define NS_LOCALSTORE_CID \</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+{ 0xdf71c6f0, 0xec53, 0x11d2, { 0xbd, 0xca, 0x0, 0x0, 0x64, 0x65, 0x73, 0x74 } }</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+#define NS_LOCALSTORE_CONTRACTID NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;local-store&quot;</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineplus">+</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineplus">+class nsILocalStore : public nsISupports</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+{</span>
<a href="#l51.28"></a><span id="l51.28" class="difflineplus">+public:</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineplus">+    NS_DECLARE_STATIC_IID_ACCESSOR(NS_ILOCALSTORE_IID)</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineplus">+};</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+NS_DEFINE_STATIC_IID_ACCESSOR(nsILocalStore, NS_ILOCALSTORE_IID)</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+extern nsresult</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineplus">+NS_NewLocalStore(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineplus">+</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineplus">+#endif // nsILocalStore_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">new file mode 100644</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineminus">--- /dev/null</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineplus">+++ b/rdf/datasource/nsIRDFFTP.h</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineat">@@ -0,0 +1,33 @@</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l52.6"></a><span id="l52.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l52.7"></a><span id="l52.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l52.8"></a><span id="l52.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.9"></a><span id="l52.9" class="difflineplus">+</span>
<a href="#l52.10"></a><span id="l52.10" class="difflineplus">+#ifndef	nsIRDFFTP_h__</span>
<a href="#l52.11"></a><span id="l52.11" class="difflineplus">+#define	nsIRDFFTP_h__</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+#include &quot;nsISupports.h&quot;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+#include &quot;nsIRDFNode.h&quot;</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+#define NS_IRDFFTPDATAOURCE_IID \</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineplus">+{ 0x1222e6f0, 0xa5e3, 0x11d2, { 0x8b, 0x7c, 0x00, 0x80, 0x5f, 0x8a, 0x7d, 0xb7 } }</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineplus">+</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+class nsIRDFFTPDataSource : public nsIRDFDataSource</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+{</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+public:</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+};</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+#define NS_IRDFFTPDATASOURCECALLBACK_IID \</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineplus">+{ 0x204a1a00, 0xa5e4, 0x11d2, { 0x8b, 0x7c, 0x00, 0x80, 0x5f, 0x8a, 0x7d, 0xb8 } }</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineplus">+</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineplus">+class nsIRDFFTPDataSourceCallback : public nsIStreamListener</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+{</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+public:</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+};</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineplus">+</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineplus">+</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineplus">+#endif // nsIRDFFTP_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">new file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- /dev/null</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ b/rdf/datasource/nsLocalStore.cpp</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -0,0 +1,474 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineplus">+/* vim: set cindent tabstop=4 expandtab shiftwidth=4: */</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineplus">+/*</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+  Implementation for the local store</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineplus">+</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+ */</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+#include &quot;nsIURI.h&quot;</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+#include &quot;nsIIOService.h&quot;</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+#include &quot;nsIComponentManager.h&quot;</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+#include &quot;nsILocalStore.h&quot;</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+#include &quot;nsIRDFDataSource.h&quot;</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+#include &quot;nsIRDFRemoteDataSource.h&quot;</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+#include &quot;nsIRDFService.h&quot;</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineplus">+#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineplus">+#include &quot;nsRDFCID.h&quot;</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineplus">+#include &quot;nsString.h&quot;</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+#include &quot;plstr.h&quot;</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineplus">+#include &quot;rdf.h&quot;</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineplus">+#include &quot;nsWeakPtr.h&quot;</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineplus">+#include &quot;nsIObserver.h&quot;</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+#include &quot;nsIObserverService.h&quot;</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+#include &quot;nsWeakReference.h&quot;</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineplus">+#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineplus">+#include &quot;nsCycleCollectionParticipant.h&quot;</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineplus">+</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+class LocalStoreImpl : public nsILocalStore,</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineplus">+                       public nsIRDFDataSource,</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineplus">+                       public nsIRDFRemoteDataSource,</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+                       public nsIObserver,</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+                       public nsSupportsWeakReference</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineplus">+{</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+protected:</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+    nsCOMPtr&lt;nsIRDFDataSource&gt; mInner;</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineplus">+</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineplus">+    LocalStoreImpl();</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+    virtual ~LocalStoreImpl();</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineplus">+    nsresult Init();</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineplus">+    nsresult CreateLocalStore(nsIFile* aFile);</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+    nsresult LoadData();</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineplus">+</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineplus">+    friend nsresult</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineplus">+    NS_NewLocalStore(nsISupports* aOuter, REFNSIID aIID, void** aResult);</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+    nsCOMPtr&lt;nsIRDFService&gt;    mRDFService;</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+public:</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineplus">+    // nsISupports interface</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineplus">+    NS_DECL_CYCLE_COLLECTING_ISUPPORTS</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+    NS_DECL_CYCLE_COLLECTION_CLASS_AMBIGUOUS(LocalStoreImpl, nsILocalStore)</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineplus">+</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+    // nsILocalStore interface</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineplus">+</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineplus">+    // nsIRDFDataSource interface. Most of these are just delegated to</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineplus">+    // the inner, in-memory datasource.</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+    NS_IMETHOD GetURI(nsACString&amp; aURI) override;</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineplus">+</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineplus">+    NS_IMETHOD GetSource(nsIRDFResource* aProperty,</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+                         nsIRDFNode* aTarget,</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineplus">+                         bool aTruthValue,</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineplus">+                         nsIRDFResource** aSource) override {</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineplus">+        return mInner-&gt;GetSource(aProperty, aTarget, aTruthValue, aSource);</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineplus">+    }</span>
<a href="#l53.82"></a><span id="l53.82" class="difflineplus">+</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineplus">+    NS_IMETHOD GetSources(nsIRDFResource* aProperty,</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineplus">+                          nsIRDFNode* aTarget,</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineplus">+                          bool aTruthValue,</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineplus">+                          nsISimpleEnumerator** aSources) override {</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineplus">+        return mInner-&gt;GetSources(aProperty, aTarget, aTruthValue, aSources);</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineplus">+    }</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineplus">+</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineplus">+    NS_IMETHOD GetTarget(nsIRDFResource* aSource,</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineplus">+                         nsIRDFResource* aProperty,</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineplus">+                         bool aTruthValue,</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineplus">+                         nsIRDFNode** aTarget) override {</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineplus">+        return mInner-&gt;GetTarget(aSource, aProperty, aTruthValue, aTarget);</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineplus">+    }</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineplus">+</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineplus">+    NS_IMETHOD GetTargets(nsIRDFResource* aSource,</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineplus">+                          nsIRDFResource* aProperty,</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineplus">+                          bool aTruthValue,</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineplus">+                          nsISimpleEnumerator** aTargets) override {</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineplus">+        return mInner-&gt;GetTargets(aSource, aProperty, aTruthValue, aTargets);</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineplus">+    }</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineplus">+</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+    NS_IMETHOD Assert(nsIRDFResource* aSource,</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineplus">+                      nsIRDFResource* aProperty,</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineplus">+                      nsIRDFNode* aTarget,</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+                      bool aTruthValue) override {</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineplus">+        return mInner-&gt;Assert(aSource, aProperty, aTarget, aTruthValue);</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+    }</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineplus">+</span>
<a href="#l53.111"></a><span id="l53.111" class="difflineplus">+    NS_IMETHOD Unassert(nsIRDFResource* aSource,</span>
<a href="#l53.112"></a><span id="l53.112" class="difflineplus">+                        nsIRDFResource* aProperty,</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineplus">+                        nsIRDFNode* aTarget) override {</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineplus">+        return mInner-&gt;Unassert(aSource, aProperty, aTarget);</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineplus">+    }</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineplus">+</span>
<a href="#l53.117"></a><span id="l53.117" class="difflineplus">+    NS_IMETHOD Change(nsIRDFResource* aSource,</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineplus">+                      nsIRDFResource* aProperty,</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineplus">+                      nsIRDFNode* aOldTarget,</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineplus">+                      nsIRDFNode* aNewTarget) override {</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineplus">+        return mInner-&gt;Change(aSource, aProperty, aOldTarget, aNewTarget);</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineplus">+    }</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineplus">+</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineplus">+    NS_IMETHOD Move(nsIRDFResource* aOldSource,</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineplus">+                    nsIRDFResource* aNewSource,</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineplus">+                    nsIRDFResource* aProperty,</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineplus">+                    nsIRDFNode* aTarget) override {</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineplus">+        return mInner-&gt;Move(aOldSource, aNewSource, aProperty, aTarget);</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineplus">+    }</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineplus">+</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineplus">+    NS_IMETHOD HasAssertion(nsIRDFResource* aSource,</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineplus">+                            nsIRDFResource* aProperty,</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineplus">+                            nsIRDFNode* aTarget,</span>
<a href="#l53.134"></a><span id="l53.134" class="difflineplus">+                            bool aTruthValue,</span>
<a href="#l53.135"></a><span id="l53.135" class="difflineplus">+                            bool* hasAssertion) override {</span>
<a href="#l53.136"></a><span id="l53.136" class="difflineplus">+        return mInner-&gt;HasAssertion(aSource, aProperty, aTarget, aTruthValue, hasAssertion);</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineplus">+    }</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineplus">+</span>
<a href="#l53.139"></a><span id="l53.139" class="difflineplus">+    NS_IMETHOD AddObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l53.140"></a><span id="l53.140" class="difflineplus">+        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineplus">+    }</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineplus">+</span>
<a href="#l53.143"></a><span id="l53.143" class="difflineplus">+    NS_IMETHOD RemoveObserver(nsIRDFObserver* aObserver) override {</span>
<a href="#l53.144"></a><span id="l53.144" class="difflineplus">+        return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l53.145"></a><span id="l53.145" class="difflineplus">+    }</span>
<a href="#l53.146"></a><span id="l53.146" class="difflineplus">+</span>
<a href="#l53.147"></a><span id="l53.147" class="difflineplus">+    NS_IMETHOD HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l53.148"></a><span id="l53.148" class="difflineplus">+        return mInner-&gt;HasArcIn(aNode, aArc, _retval);</span>
<a href="#l53.149"></a><span id="l53.149" class="difflineplus">+    }</span>
<a href="#l53.150"></a><span id="l53.150" class="difflineplus">+</span>
<a href="#l53.151"></a><span id="l53.151" class="difflineplus">+    NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc, bool *_retval) override {</span>
<a href="#l53.152"></a><span id="l53.152" class="difflineplus">+        return mInner-&gt;HasArcOut(aSource, aArc, _retval);</span>
<a href="#l53.153"></a><span id="l53.153" class="difflineplus">+    }</span>
<a href="#l53.154"></a><span id="l53.154" class="difflineplus">+</span>
<a href="#l53.155"></a><span id="l53.155" class="difflineplus">+    NS_IMETHOD ArcLabelsIn(nsIRDFNode* aNode,</span>
<a href="#l53.156"></a><span id="l53.156" class="difflineplus">+                           nsISimpleEnumerator** aLabels) override {</span>
<a href="#l53.157"></a><span id="l53.157" class="difflineplus">+        return mInner-&gt;ArcLabelsIn(aNode, aLabels);</span>
<a href="#l53.158"></a><span id="l53.158" class="difflineplus">+    }</span>
<a href="#l53.159"></a><span id="l53.159" class="difflineplus">+</span>
<a href="#l53.160"></a><span id="l53.160" class="difflineplus">+    NS_IMETHOD ArcLabelsOut(nsIRDFResource* aSource,</span>
<a href="#l53.161"></a><span id="l53.161" class="difflineplus">+                            nsISimpleEnumerator** aLabels) override {</span>
<a href="#l53.162"></a><span id="l53.162" class="difflineplus">+        return mInner-&gt;ArcLabelsOut(aSource, aLabels);</span>
<a href="#l53.163"></a><span id="l53.163" class="difflineplus">+    }</span>
<a href="#l53.164"></a><span id="l53.164" class="difflineplus">+</span>
<a href="#l53.165"></a><span id="l53.165" class="difflineplus">+    NS_IMETHOD GetAllResources(nsISimpleEnumerator** aResult) override {</span>
<a href="#l53.166"></a><span id="l53.166" class="difflineplus">+        return mInner-&gt;GetAllResources(aResult);</span>
<a href="#l53.167"></a><span id="l53.167" class="difflineplus">+    }</span>
<a href="#l53.168"></a><span id="l53.168" class="difflineplus">+</span>
<a href="#l53.169"></a><span id="l53.169" class="difflineplus">+    NS_IMETHOD GetAllCmds(nsIRDFResource* aSource,</span>
<a href="#l53.170"></a><span id="l53.170" class="difflineplus">+                              nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** aCommands) override;</span>
<a href="#l53.171"></a><span id="l53.171" class="difflineplus">+</span>
<a href="#l53.172"></a><span id="l53.172" class="difflineplus">+    NS_IMETHOD IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l53.173"></a><span id="l53.173" class="difflineplus">+                                nsIRDFResource*   aCommand,</span>
<a href="#l53.174"></a><span id="l53.174" class="difflineplus">+                                nsISupports* aArguments,</span>
<a href="#l53.175"></a><span id="l53.175" class="difflineplus">+                                bool* aResult) override;</span>
<a href="#l53.176"></a><span id="l53.176" class="difflineplus">+</span>
<a href="#l53.177"></a><span id="l53.177" class="difflineplus">+    NS_IMETHOD DoCommand(nsISupports* aSources,</span>
<a href="#l53.178"></a><span id="l53.178" class="difflineplus">+                         nsIRDFResource*   aCommand,</span>
<a href="#l53.179"></a><span id="l53.179" class="difflineplus">+                         nsISupports* aArguments) override;</span>
<a href="#l53.180"></a><span id="l53.180" class="difflineplus">+</span>
<a href="#l53.181"></a><span id="l53.181" class="difflineplus">+    NS_IMETHOD BeginUpdateBatch() override {</span>
<a href="#l53.182"></a><span id="l53.182" class="difflineplus">+        return mInner-&gt;BeginUpdateBatch();</span>
<a href="#l53.183"></a><span id="l53.183" class="difflineplus">+    }</span>
<a href="#l53.184"></a><span id="l53.184" class="difflineplus">+</span>
<a href="#l53.185"></a><span id="l53.185" class="difflineplus">+    NS_IMETHOD EndUpdateBatch() override {</span>
<a href="#l53.186"></a><span id="l53.186" class="difflineplus">+        return mInner-&gt;EndUpdateBatch();</span>
<a href="#l53.187"></a><span id="l53.187" class="difflineplus">+    }</span>
<a href="#l53.188"></a><span id="l53.188" class="difflineplus">+</span>
<a href="#l53.189"></a><span id="l53.189" class="difflineplus">+    NS_IMETHOD GetLoaded(bool* _result) override;</span>
<a href="#l53.190"></a><span id="l53.190" class="difflineplus">+    NS_IMETHOD Init(const char *uri) override;</span>
<a href="#l53.191"></a><span id="l53.191" class="difflineplus">+    NS_IMETHOD Flush() override;</span>
<a href="#l53.192"></a><span id="l53.192" class="difflineplus">+    NS_IMETHOD FlushTo(const char *aURI) override;</span>
<a href="#l53.193"></a><span id="l53.193" class="difflineplus">+    NS_IMETHOD Refresh(bool sync) override;</span>
<a href="#l53.194"></a><span id="l53.194" class="difflineplus">+</span>
<a href="#l53.195"></a><span id="l53.195" class="difflineplus">+    // nsIObserver</span>
<a href="#l53.196"></a><span id="l53.196" class="difflineplus">+    NS_DECL_NSIOBSERVER</span>
<a href="#l53.197"></a><span id="l53.197" class="difflineplus">+};</span>
<a href="#l53.198"></a><span id="l53.198" class="difflineplus">+</span>
<a href="#l53.199"></a><span id="l53.199" class="difflineplus">+////////////////////////////////////////////////////////////////////////</span>
<a href="#l53.200"></a><span id="l53.200" class="difflineplus">+</span>
<a href="#l53.201"></a><span id="l53.201" class="difflineplus">+</span>
<a href="#l53.202"></a><span id="l53.202" class="difflineplus">+LocalStoreImpl::LocalStoreImpl(void)</span>
<a href="#l53.203"></a><span id="l53.203" class="difflineplus">+{</span>
<a href="#l53.204"></a><span id="l53.204" class="difflineplus">+}</span>
<a href="#l53.205"></a><span id="l53.205" class="difflineplus">+</span>
<a href="#l53.206"></a><span id="l53.206" class="difflineplus">+LocalStoreImpl::~LocalStoreImpl(void)</span>
<a href="#l53.207"></a><span id="l53.207" class="difflineplus">+{</span>
<a href="#l53.208"></a><span id="l53.208" class="difflineplus">+    if (mRDFService)</span>
<a href="#l53.209"></a><span id="l53.209" class="difflineplus">+        mRDFService-&gt;UnregisterDataSource(this);</span>
<a href="#l53.210"></a><span id="l53.210" class="difflineplus">+}</span>
<a href="#l53.211"></a><span id="l53.211" class="difflineplus">+</span>
<a href="#l53.212"></a><span id="l53.212" class="difflineplus">+</span>
<a href="#l53.213"></a><span id="l53.213" class="difflineplus">+nsresult</span>
<a href="#l53.214"></a><span id="l53.214" class="difflineplus">+NS_NewLocalStore(nsISupports* aOuter, REFNSIID aIID, void** aResult)</span>
<a href="#l53.215"></a><span id="l53.215" class="difflineplus">+{</span>
<a href="#l53.216"></a><span id="l53.216" class="difflineplus">+    NS_PRECONDITION(aOuter == nullptr, &quot;no aggregation&quot;);</span>
<a href="#l53.217"></a><span id="l53.217" class="difflineplus">+    if (aOuter)</span>
<a href="#l53.218"></a><span id="l53.218" class="difflineplus">+        return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l53.219"></a><span id="l53.219" class="difflineplus">+</span>
<a href="#l53.220"></a><span id="l53.220" class="difflineplus">+    NS_PRECONDITION(aResult != nullptr, &quot;null ptr&quot;);</span>
<a href="#l53.221"></a><span id="l53.221" class="difflineplus">+    if (! aResult)</span>
<a href="#l53.222"></a><span id="l53.222" class="difflineplus">+        return NS_ERROR_NULL_POINTER;</span>
<a href="#l53.223"></a><span id="l53.223" class="difflineplus">+</span>
<a href="#l53.224"></a><span id="l53.224" class="difflineplus">+    LocalStoreImpl* impl = new LocalStoreImpl();</span>
<a href="#l53.225"></a><span id="l53.225" class="difflineplus">+    if (! impl)</span>
<a href="#l53.226"></a><span id="l53.226" class="difflineplus">+        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l53.227"></a><span id="l53.227" class="difflineplus">+</span>
<a href="#l53.228"></a><span id="l53.228" class="difflineplus">+    NS_ADDREF(impl);</span>
<a href="#l53.229"></a><span id="l53.229" class="difflineplus">+</span>
<a href="#l53.230"></a><span id="l53.230" class="difflineplus">+    nsresult rv;</span>
<a href="#l53.231"></a><span id="l53.231" class="difflineplus">+    rv = impl-&gt;Init();</span>
<a href="#l53.232"></a><span id="l53.232" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l53.233"></a><span id="l53.233" class="difflineplus">+        // Set up the result pointer</span>
<a href="#l53.234"></a><span id="l53.234" class="difflineplus">+        rv = impl-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l53.235"></a><span id="l53.235" class="difflineplus">+    }</span>
<a href="#l53.236"></a><span id="l53.236" class="difflineplus">+</span>
<a href="#l53.237"></a><span id="l53.237" class="difflineplus">+    NS_RELEASE(impl);</span>
<a href="#l53.238"></a><span id="l53.238" class="difflineplus">+    return rv;</span>
<a href="#l53.239"></a><span id="l53.239" class="difflineplus">+}</span>
<a href="#l53.240"></a><span id="l53.240" class="difflineplus">+</span>
<a href="#l53.241"></a><span id="l53.241" class="difflineplus">+NS_IMPL_CYCLE_COLLECTION(LocalStoreImpl, mInner)</span>
<a href="#l53.242"></a><span id="l53.242" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_ADDREF(LocalStoreImpl)</span>
<a href="#l53.243"></a><span id="l53.243" class="difflineplus">+NS_IMPL_CYCLE_COLLECTING_RELEASE(LocalStoreImpl)</span>
<a href="#l53.244"></a><span id="l53.244" class="difflineplus">+</span>
<a href="#l53.245"></a><span id="l53.245" class="difflineplus">+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(LocalStoreImpl)</span>
<a href="#l53.246"></a><span id="l53.246" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsILocalStore)</span>
<a href="#l53.247"></a><span id="l53.247" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFDataSource)</span>
<a href="#l53.248"></a><span id="l53.248" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIRDFRemoteDataSource)</span>
<a href="#l53.249"></a><span id="l53.249" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsIObserver)</span>
<a href="#l53.250"></a><span id="l53.250" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY(nsISupportsWeakReference)</span>
<a href="#l53.251"></a><span id="l53.251" class="difflineplus">+    NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsILocalStore)</span>
<a href="#l53.252"></a><span id="l53.252" class="difflineplus">+NS_INTERFACE_MAP_END</span>
<a href="#l53.253"></a><span id="l53.253" class="difflineplus">+</span>
<a href="#l53.254"></a><span id="l53.254" class="difflineplus">+// nsILocalStore interface</span>
<a href="#l53.255"></a><span id="l53.255" class="difflineplus">+</span>
<a href="#l53.256"></a><span id="l53.256" class="difflineplus">+// nsIRDFDataSource interface</span>
<a href="#l53.257"></a><span id="l53.257" class="difflineplus">+</span>
<a href="#l53.258"></a><span id="l53.258" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.259"></a><span id="l53.259" class="difflineplus">+LocalStoreImpl::GetLoaded(bool* _result)</span>
<a href="#l53.260"></a><span id="l53.260" class="difflineplus">+{</span>
<a href="#l53.261"></a><span id="l53.261" class="difflineplus">+	nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l53.262"></a><span id="l53.262" class="difflineplus">+    NS_ASSERTION(remote != nullptr, &quot;not an nsIRDFRemoteDataSource&quot;);</span>
<a href="#l53.263"></a><span id="l53.263" class="difflineplus">+	if (! remote)</span>
<a href="#l53.264"></a><span id="l53.264" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l53.265"></a><span id="l53.265" class="difflineplus">+</span>
<a href="#l53.266"></a><span id="l53.266" class="difflineplus">+    return remote-&gt;GetLoaded(_result);</span>
<a href="#l53.267"></a><span id="l53.267" class="difflineplus">+}</span>
<a href="#l53.268"></a><span id="l53.268" class="difflineplus">+</span>
<a href="#l53.269"></a><span id="l53.269" class="difflineplus">+</span>
<a href="#l53.270"></a><span id="l53.270" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.271"></a><span id="l53.271" class="difflineplus">+LocalStoreImpl::Init(const char *uri)</span>
<a href="#l53.272"></a><span id="l53.272" class="difflineplus">+{</span>
<a href="#l53.273"></a><span id="l53.273" class="difflineplus">+	return(NS_OK);</span>
<a href="#l53.274"></a><span id="l53.274" class="difflineplus">+}</span>
<a href="#l53.275"></a><span id="l53.275" class="difflineplus">+</span>
<a href="#l53.276"></a><span id="l53.276" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.277"></a><span id="l53.277" class="difflineplus">+LocalStoreImpl::Flush()</span>
<a href="#l53.278"></a><span id="l53.278" class="difflineplus">+{</span>
<a href="#l53.279"></a><span id="l53.279" class="difflineplus">+	nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l53.280"></a><span id="l53.280" class="difflineplus">+    // FIXME Bug 340242: Temporarily make this a warning rather than an</span>
<a href="#l53.281"></a><span id="l53.281" class="difflineplus">+    // assertion until we sort out the ordering of how we write</span>
<a href="#l53.282"></a><span id="l53.282" class="difflineplus">+    // everything to the localstore, flush it, and disconnect it when</span>
<a href="#l53.283"></a><span id="l53.283" class="difflineplus">+    // we're getting profile-change notifications.</span>
<a href="#l53.284"></a><span id="l53.284" class="difflineplus">+    NS_WARNING_ASSERTION(remote != nullptr, &quot;not an nsIRDFRemoteDataSource&quot;);</span>
<a href="#l53.285"></a><span id="l53.285" class="difflineplus">+	if (! remote)</span>
<a href="#l53.286"></a><span id="l53.286" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l53.287"></a><span id="l53.287" class="difflineplus">+</span>
<a href="#l53.288"></a><span id="l53.288" class="difflineplus">+    return remote-&gt;Flush();</span>
<a href="#l53.289"></a><span id="l53.289" class="difflineplus">+}</span>
<a href="#l53.290"></a><span id="l53.290" class="difflineplus">+</span>
<a href="#l53.291"></a><span id="l53.291" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.292"></a><span id="l53.292" class="difflineplus">+LocalStoreImpl::FlushTo(const char *aURI)</span>
<a href="#l53.293"></a><span id="l53.293" class="difflineplus">+{</span>
<a href="#l53.294"></a><span id="l53.294" class="difflineplus">+  // Do not ever implement this (security)</span>
<a href="#l53.295"></a><span id="l53.295" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l53.296"></a><span id="l53.296" class="difflineplus">+}</span>
<a href="#l53.297"></a><span id="l53.297" class="difflineplus">+</span>
<a href="#l53.298"></a><span id="l53.298" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.299"></a><span id="l53.299" class="difflineplus">+LocalStoreImpl::Refresh(bool sync)</span>
<a href="#l53.300"></a><span id="l53.300" class="difflineplus">+{</span>
<a href="#l53.301"></a><span id="l53.301" class="difflineplus">+	nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l53.302"></a><span id="l53.302" class="difflineplus">+    NS_ASSERTION(remote != nullptr, &quot;not an nsIRDFRemoteDataSource&quot;);</span>
<a href="#l53.303"></a><span id="l53.303" class="difflineplus">+	if (! remote)</span>
<a href="#l53.304"></a><span id="l53.304" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l53.305"></a><span id="l53.305" class="difflineplus">+</span>
<a href="#l53.306"></a><span id="l53.306" class="difflineplus">+    return remote-&gt;Refresh(sync);</span>
<a href="#l53.307"></a><span id="l53.307" class="difflineplus">+}</span>
<a href="#l53.308"></a><span id="l53.308" class="difflineplus">+</span>
<a href="#l53.309"></a><span id="l53.309" class="difflineplus">+nsresult</span>
<a href="#l53.310"></a><span id="l53.310" class="difflineplus">+LocalStoreImpl::Init()</span>
<a href="#l53.311"></a><span id="l53.311" class="difflineplus">+{</span>
<a href="#l53.312"></a><span id="l53.312" class="difflineplus">+    nsresult rv;</span>
<a href="#l53.313"></a><span id="l53.313" class="difflineplus">+</span>
<a href="#l53.314"></a><span id="l53.314" class="difflineplus">+    rv = LoadData();</span>
<a href="#l53.315"></a><span id="l53.315" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.316"></a><span id="l53.316" class="difflineplus">+</span>
<a href="#l53.317"></a><span id="l53.317" class="difflineplus">+    // register this as a named data source with the RDF service</span>
<a href="#l53.318"></a><span id="l53.318" class="difflineplus">+    mRDFService = do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l53.319"></a><span id="l53.319" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.320"></a><span id="l53.320" class="difflineplus">+</span>
<a href="#l53.321"></a><span id="l53.321" class="difflineplus">+    mRDFService-&gt;RegisterDataSource(this, false);</span>
<a href="#l53.322"></a><span id="l53.322" class="difflineplus">+</span>
<a href="#l53.323"></a><span id="l53.323" class="difflineplus">+    // Register as an observer of profile changes</span>
<a href="#l53.324"></a><span id="l53.324" class="difflineplus">+    nsCOMPtr&lt;nsIObserverService&gt; obs =</span>
<a href="#l53.325"></a><span id="l53.325" class="difflineplus">+        do_GetService(&quot;@mozilla.org/observer-service;1&quot;);</span>
<a href="#l53.326"></a><span id="l53.326" class="difflineplus">+</span>
<a href="#l53.327"></a><span id="l53.327" class="difflineplus">+    if (obs) {</span>
<a href="#l53.328"></a><span id="l53.328" class="difflineplus">+        obs-&gt;AddObserver(this, &quot;profile-before-change&quot;, true);</span>
<a href="#l53.329"></a><span id="l53.329" class="difflineplus">+        obs-&gt;AddObserver(this, &quot;profile-do-change&quot;, true);</span>
<a href="#l53.330"></a><span id="l53.330" class="difflineplus">+    }</span>
<a href="#l53.331"></a><span id="l53.331" class="difflineplus">+</span>
<a href="#l53.332"></a><span id="l53.332" class="difflineplus">+    return NS_OK;</span>
<a href="#l53.333"></a><span id="l53.333" class="difflineplus">+}</span>
<a href="#l53.334"></a><span id="l53.334" class="difflineplus">+</span>
<a href="#l53.335"></a><span id="l53.335" class="difflineplus">+nsresult</span>
<a href="#l53.336"></a><span id="l53.336" class="difflineplus">+LocalStoreImpl::CreateLocalStore(nsIFile* aFile)</span>
<a href="#l53.337"></a><span id="l53.337" class="difflineplus">+{</span>
<a href="#l53.338"></a><span id="l53.338" class="difflineplus">+    nsresult rv;</span>
<a href="#l53.339"></a><span id="l53.339" class="difflineplus">+</span>
<a href="#l53.340"></a><span id="l53.340" class="difflineplus">+    rv = aFile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0666);</span>
<a href="#l53.341"></a><span id="l53.341" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.342"></a><span id="l53.342" class="difflineplus">+</span>
<a href="#l53.343"></a><span id="l53.343" class="difflineplus">+    nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l53.344"></a><span id="l53.344" class="difflineplus">+    rv = NS_NewLocalFileOutputStream(getter_AddRefs(outStream), aFile);</span>
<a href="#l53.345"></a><span id="l53.345" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.346"></a><span id="l53.346" class="difflineplus">+</span>
<a href="#l53.347"></a><span id="l53.347" class="difflineplus">+    const char defaultRDF[] =</span>
<a href="#l53.348"></a><span id="l53.348" class="difflineplus">+        &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot; \</span>
<a href="#l53.349"></a><span id="l53.349" class="difflineplus">+        &quot;&lt;RDF:RDF xmlns:RDF=\&quot;&quot; RDF_NAMESPACE_URI &quot;\&quot;\n&quot; \</span>
<a href="#l53.350"></a><span id="l53.350" class="difflineplus">+        &quot;         xmlns:NC=\&quot;&quot;  NC_NAMESPACE_URI &quot;\&quot;&gt;\n&quot; \</span>
<a href="#l53.351"></a><span id="l53.351" class="difflineplus">+        &quot;  &lt;!-- Empty --&gt;\n&quot; \</span>
<a href="#l53.352"></a><span id="l53.352" class="difflineplus">+        &quot;&lt;/RDF:RDF&gt;\n&quot;;</span>
<a href="#l53.353"></a><span id="l53.353" class="difflineplus">+</span>
<a href="#l53.354"></a><span id="l53.354" class="difflineplus">+    uint32_t count;</span>
<a href="#l53.355"></a><span id="l53.355" class="difflineplus">+    rv = outStream-&gt;Write(defaultRDF, sizeof(defaultRDF)-1, &amp;count);</span>
<a href="#l53.356"></a><span id="l53.356" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.357"></a><span id="l53.357" class="difflineplus">+</span>
<a href="#l53.358"></a><span id="l53.358" class="difflineplus">+    if (count != sizeof(defaultRDF)-1)</span>
<a href="#l53.359"></a><span id="l53.359" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l53.360"></a><span id="l53.360" class="difflineplus">+</span>
<a href="#l53.361"></a><span id="l53.361" class="difflineplus">+    // Okay, now see if the file exists _for real_. If it's still</span>
<a href="#l53.362"></a><span id="l53.362" class="difflineplus">+    // not there, it could be that the profile service gave us</span>
<a href="#l53.363"></a><span id="l53.363" class="difflineplus">+    // back a read-only directory. Whatever.</span>
<a href="#l53.364"></a><span id="l53.364" class="difflineplus">+    bool fileExistsFlag = false;</span>
<a href="#l53.365"></a><span id="l53.365" class="difflineplus">+    aFile-&gt;Exists(&amp;fileExistsFlag);</span>
<a href="#l53.366"></a><span id="l53.366" class="difflineplus">+    if (!fileExistsFlag)</span>
<a href="#l53.367"></a><span id="l53.367" class="difflineplus">+        return NS_ERROR_UNEXPECTED;</span>
<a href="#l53.368"></a><span id="l53.368" class="difflineplus">+</span>
<a href="#l53.369"></a><span id="l53.369" class="difflineplus">+    return NS_OK;</span>
<a href="#l53.370"></a><span id="l53.370" class="difflineplus">+}</span>
<a href="#l53.371"></a><span id="l53.371" class="difflineplus">+</span>
<a href="#l53.372"></a><span id="l53.372" class="difflineplus">+nsresult</span>
<a href="#l53.373"></a><span id="l53.373" class="difflineplus">+LocalStoreImpl::LoadData()</span>
<a href="#l53.374"></a><span id="l53.374" class="difflineplus">+{</span>
<a href="#l53.375"></a><span id="l53.375" class="difflineplus">+    nsresult rv;</span>
<a href="#l53.376"></a><span id="l53.376" class="difflineplus">+</span>
<a href="#l53.377"></a><span id="l53.377" class="difflineplus">+    // Look for localstore.rdf in the current profile</span>
<a href="#l53.378"></a><span id="l53.378" class="difflineplus">+    // directory. Bomb if we can't find it.</span>
<a href="#l53.379"></a><span id="l53.379" class="difflineplus">+</span>
<a href="#l53.380"></a><span id="l53.380" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; aFile;</span>
<a href="#l53.381"></a><span id="l53.381" class="difflineplus">+    rv = NS_GetSpecialDirectory(NS_APP_LOCALSTORE_50_FILE, getter_AddRefs(aFile));</span>
<a href="#l53.382"></a><span id="l53.382" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.383"></a><span id="l53.383" class="difflineplus">+</span>
<a href="#l53.384"></a><span id="l53.384" class="difflineplus">+    bool fileExistsFlag = false;</span>
<a href="#l53.385"></a><span id="l53.385" class="difflineplus">+    (void)aFile-&gt;Exists(&amp;fileExistsFlag);</span>
<a href="#l53.386"></a><span id="l53.386" class="difflineplus">+    if (!fileExistsFlag) {</span>
<a href="#l53.387"></a><span id="l53.387" class="difflineplus">+        // if file doesn't exist, create it</span>
<a href="#l53.388"></a><span id="l53.388" class="difflineplus">+        rv = CreateLocalStore(aFile);</span>
<a href="#l53.389"></a><span id="l53.389" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.390"></a><span id="l53.390" class="difflineplus">+    }</span>
<a href="#l53.391"></a><span id="l53.391" class="difflineplus">+</span>
<a href="#l53.392"></a><span id="l53.392" class="difflineplus">+    mInner = do_CreateInstance(NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;xml-datasource&quot;, &amp;rv);</span>
<a href="#l53.393"></a><span id="l53.393" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.394"></a><span id="l53.394" class="difflineplus">+</span>
<a href="#l53.395"></a><span id="l53.395" class="difflineplus">+    nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner, &amp;rv);</span>
<a href="#l53.396"></a><span id="l53.396" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.397"></a><span id="l53.397" class="difflineplus">+</span>
<a href="#l53.398"></a><span id="l53.398" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; aURI;</span>
<a href="#l53.399"></a><span id="l53.399" class="difflineplus">+    rv = NS_NewFileURI(getter_AddRefs(aURI), aFile);</span>
<a href="#l53.400"></a><span id="l53.400" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.401"></a><span id="l53.401" class="difflineplus">+</span>
<a href="#l53.402"></a><span id="l53.402" class="difflineplus">+    nsAutoCString spec;</span>
<a href="#l53.403"></a><span id="l53.403" class="difflineplus">+    rv = aURI-&gt;GetSpec(spec);</span>
<a href="#l53.404"></a><span id="l53.404" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.405"></a><span id="l53.405" class="difflineplus">+</span>
<a href="#l53.406"></a><span id="l53.406" class="difflineplus">+    rv = remote-&gt;Init(spec.get());</span>
<a href="#l53.407"></a><span id="l53.407" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.408"></a><span id="l53.408" class="difflineplus">+</span>
<a href="#l53.409"></a><span id="l53.409" class="difflineplus">+    // Read the datasource synchronously.</span>
<a href="#l53.410"></a><span id="l53.410" class="difflineplus">+    rv = remote-&gt;Refresh(true);</span>
<a href="#l53.411"></a><span id="l53.411" class="difflineplus">+</span>
<a href="#l53.412"></a><span id="l53.412" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l53.413"></a><span id="l53.413" class="difflineplus">+        // Load failed, delete and recreate a fresh localstore</span>
<a href="#l53.414"></a><span id="l53.414" class="difflineplus">+        aFile-&gt;Remove(true);</span>
<a href="#l53.415"></a><span id="l53.415" class="difflineplus">+        rv = CreateLocalStore(aFile);</span>
<a href="#l53.416"></a><span id="l53.416" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l53.417"></a><span id="l53.417" class="difflineplus">+</span>
<a href="#l53.418"></a><span id="l53.418" class="difflineplus">+        rv = remote-&gt;Refresh(true);</span>
<a href="#l53.419"></a><span id="l53.419" class="difflineplus">+    }</span>
<a href="#l53.420"></a><span id="l53.420" class="difflineplus">+</span>
<a href="#l53.421"></a><span id="l53.421" class="difflineplus">+    return rv;</span>
<a href="#l53.422"></a><span id="l53.422" class="difflineplus">+}</span>
<a href="#l53.423"></a><span id="l53.423" class="difflineplus">+</span>
<a href="#l53.424"></a><span id="l53.424" class="difflineplus">+</span>
<a href="#l53.425"></a><span id="l53.425" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.426"></a><span id="l53.426" class="difflineplus">+LocalStoreImpl::GetURI(nsACString&amp; aURI)</span>
<a href="#l53.427"></a><span id="l53.427" class="difflineplus">+{</span>
<a href="#l53.428"></a><span id="l53.428" class="difflineplus">+    aURI.AssignLiteral(&quot;rdf:local-store&quot;);</span>
<a href="#l53.429"></a><span id="l53.429" class="difflineplus">+    return NS_OK;</span>
<a href="#l53.430"></a><span id="l53.430" class="difflineplus">+}</span>
<a href="#l53.431"></a><span id="l53.431" class="difflineplus">+</span>
<a href="#l53.432"></a><span id="l53.432" class="difflineplus">+</span>
<a href="#l53.433"></a><span id="l53.433" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.434"></a><span id="l53.434" class="difflineplus">+LocalStoreImpl::GetAllCmds(nsIRDFResource* aSource,</span>
<a href="#l53.435"></a><span id="l53.435" class="difflineplus">+                               nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** aCommands)</span>
<a href="#l53.436"></a><span id="l53.436" class="difflineplus">+{</span>
<a href="#l53.437"></a><span id="l53.437" class="difflineplus">+	return(NS_NewEmptyEnumerator(aCommands));</span>
<a href="#l53.438"></a><span id="l53.438" class="difflineplus">+}</span>
<a href="#l53.439"></a><span id="l53.439" class="difflineplus">+</span>
<a href="#l53.440"></a><span id="l53.440" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.441"></a><span id="l53.441" class="difflineplus">+LocalStoreImpl::IsCommandEnabled(nsISupports* aSources,</span>
<a href="#l53.442"></a><span id="l53.442" class="difflineplus">+                                 nsIRDFResource*   aCommand,</span>
<a href="#l53.443"></a><span id="l53.443" class="difflineplus">+                                 nsISupports* aArguments,</span>
<a href="#l53.444"></a><span id="l53.444" class="difflineplus">+                                 bool* aResult)</span>
<a href="#l53.445"></a><span id="l53.445" class="difflineplus">+{</span>
<a href="#l53.446"></a><span id="l53.446" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l53.447"></a><span id="l53.447" class="difflineplus">+}</span>
<a href="#l53.448"></a><span id="l53.448" class="difflineplus">+</span>
<a href="#l53.449"></a><span id="l53.449" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.450"></a><span id="l53.450" class="difflineplus">+LocalStoreImpl::DoCommand(nsISupports* aSources,</span>
<a href="#l53.451"></a><span id="l53.451" class="difflineplus">+                          nsIRDFResource*   aCommand,</span>
<a href="#l53.452"></a><span id="l53.452" class="difflineplus">+                          nsISupports* aArguments)</span>
<a href="#l53.453"></a><span id="l53.453" class="difflineplus">+{</span>
<a href="#l53.454"></a><span id="l53.454" class="difflineplus">+    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l53.455"></a><span id="l53.455" class="difflineplus">+}</span>
<a href="#l53.456"></a><span id="l53.456" class="difflineplus">+</span>
<a href="#l53.457"></a><span id="l53.457" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l53.458"></a><span id="l53.458" class="difflineplus">+LocalStoreImpl::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l53.459"></a><span id="l53.459" class="difflineplus">+{</span>
<a href="#l53.460"></a><span id="l53.460" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l53.461"></a><span id="l53.461" class="difflineplus">+</span>
<a href="#l53.462"></a><span id="l53.462" class="difflineplus">+    if (!nsCRT::strcmp(aTopic, &quot;profile-before-change&quot;)) {</span>
<a href="#l53.463"></a><span id="l53.463" class="difflineplus">+        // Write out the old datasource's contents.</span>
<a href="#l53.464"></a><span id="l53.464" class="difflineplus">+        if (mInner) {</span>
<a href="#l53.465"></a><span id="l53.465" class="difflineplus">+            nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote = do_QueryInterface(mInner);</span>
<a href="#l53.466"></a><span id="l53.466" class="difflineplus">+            if (remote)</span>
<a href="#l53.467"></a><span id="l53.467" class="difflineplus">+                remote-&gt;Flush();</span>
<a href="#l53.468"></a><span id="l53.468" class="difflineplus">+        }</span>
<a href="#l53.469"></a><span id="l53.469" class="difflineplus">+</span>
<a href="#l53.470"></a><span id="l53.470" class="difflineplus">+        // Create an in-memory datasource for use while we're</span>
<a href="#l53.471"></a><span id="l53.471" class="difflineplus">+        // profile-less.</span>
<a href="#l53.472"></a><span id="l53.472" class="difflineplus">+        mInner = do_CreateInstance(NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;in-memory-datasource&quot;);</span>
<a href="#l53.473"></a><span id="l53.473" class="difflineplus">+    }</span>
<a href="#l53.474"></a><span id="l53.474" class="difflineplus">+    else if (!nsCRT::strcmp(aTopic, &quot;profile-do-change&quot;)) {</span>
<a href="#l53.475"></a><span id="l53.475" class="difflineplus">+        rv = LoadData();</span>
<a href="#l53.476"></a><span id="l53.476" class="difflineplus">+    }</span>
<a href="#l53.477"></a><span id="l53.477" class="difflineplus">+    return rv;</span>
<a href="#l53.478"></a><span id="l53.478" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">new file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineminus">--- /dev/null</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineplus">+++ b/rdf/datasource/nsRDFBuiltInDataSources.h</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineat">@@ -0,0 +1,27 @@</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l54.6"></a><span id="l54.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.7"></a><span id="l54.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.8"></a><span id="l54.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineplus">+</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineplus">+/*</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineplus">+</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+  This header file just contains prototypes for the factory methods</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+  for &quot;builtin&quot; data sources that are included in rdf.dll.</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+  Each of these data sources is exposed to the external world via its</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+  CID in ../include/nsRDFCID.h.</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+ */</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+#ifndef nsBuiltinDataSources_h__</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineplus">+#define nsBuiltinDataSources_h__</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+#include &quot;nsError.h&quot;</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineplus">+class nsIRDFDataSource;</span>
<a href="#l54.26"></a><span id="l54.26" class="difflineplus">+</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineplus">+// in nsFileSystemDataSource.cpp</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineplus">+nsresult NS_NewRDFFileSystemDataSource(nsIRDFDataSource** result);</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineplus">+</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineplus">+#endif // nsBuiltinDataSources_h__</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">new file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineminus">--- /dev/null</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineplus">+++ b/rdf/moz.build</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineat">@@ -0,0 +1,11 @@</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+with Files('**'):</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+    BUG_COMPONENT = ('MailNews Core', 'General')</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+DIRS += ['base', 'datasource', 'build']</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

