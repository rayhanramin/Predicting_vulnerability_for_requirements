<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6553:0c978b9551308d4ec20ec4025ede555a624137db</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0c978b9551308d4ec20ec4025ede555a624137db" />
<meta property="og:url" content="/comm-central/rev/0c978b9551308d4ec20ec4025ede555a624137db" />
<meta property="og:description" content="Bug 605140 - Composition content policy broken due to compartments landing. Refactor the composition part of the content policy to rely on checking against docShells and not windows. This gives us more flexibilty for protecting editor elements in other windows; r=bienvenu sr=Neil. Part of bustage fix for CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0c978b9551308d4ec20ec4025ede555a624137db 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0c978b9551308d4ec20ec4025ede555a624137db">shortlog</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0c978b9551308d4ec20ec4025ede555a624137db">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db">files</a> |
changeset |
<a href="/comm-central/raw-rev/0c978b9551308d4ec20ec4025ede555a624137db">raw</a>  | <a href="/comm-central/archive/0c978b9551308d4ec20ec4025ede555a624137db.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=605140">Bug 605140</a> - Composition content policy broken due to compartments landing. Refactor the composition part of the content policy to rely on checking against docShells and not windows. This gives us more flexibilty for protecting editor elements in other windows; r=bienvenu sr=Neil. Part of bustage fix for CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#32;&#66;&#97;&#110;&#110;&#101;&#114;&#32;&#60;&#98;&#117;&#103;&#122;&#105;&#108;&#108;&#97;&#64;&#115;&#116;&#97;&#110;&#100;&#97;&#114;&#100;&#56;&#46;&#112;&#108;&#117;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 Oct 2010 22:35:24 +0100</td></tr>

<tr>
 <td>changeset 6553</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0c978b9551308d4ec20ec4025ede555a624137db">0c978b9551308d4ec20ec4025ede555a624137db</a></td>
</tr>



<tr>
<td>parent 6552</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0c4e204d85750f12c71eb7356e45b3e90ab81001">0c4e204d85750f12c71eb7356e45b3e90ab81001</a>
</td>
</tr>

<tr>
<td>child 6554</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4abc23bbf32fdd8f6330ff2b1ad9325b6b912e0a">4abc23bbf32fdd8f6330ff2b1ad9325b6b912e0a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0c978b9551308d4ec20ec4025ede555a624137db">5055</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 19 Oct 2010 21:36:48 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0c978b955130 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c978b9551308d4ec20ec4025ede555a624137db">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c978b9551308d4ec20ec4025ede555a624137db&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c978b9551308d4ec20ec4025ede555a624137db&newProject=comm-central&newRevision=0c978b9551308d4ec20ec4025ede555a624137db&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c978b9551308d4ec20ec4025ede555a624137db&newProject=comm-central&newRevision=0c978b9551308d4ec20ec4025ede555a624137db&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c978b9551308d4ec20ec4025ede555a624137db&newProject=comm-central&newRevision=0c978b9551308d4ec20ec4025ede555a624137db&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=605140">605140</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=605140">Bug 605140</a> - Composition content policy broken due to compartments landing. Refactor the composition part of the content policy to rely on checking against docShells and not windows. This gives us more flexibilty for protecting editor elements in other windows; r=bienvenu sr=Neil. Part of bustage fix for CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.h">mailnews/base/src/nsMsgContentPolicy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.h">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.h">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.h">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.h">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/base/src/nsMsgContentPolicy.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgCompose.idl">mailnews/compose/public/nsIMsgCompose.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgCompose.idl">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgCompose.idl">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgCompose.idl">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgCompose.idl">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgCompose.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgComposeService.idl">mailnews/compose/public/nsIMsgComposeService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgComposeService.idl">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgComposeService.idl">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgComposeService.idl">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgComposeService.idl">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/public/nsIMsgComposeService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose1.js">mailnews/compose/test/unit/test_nsMsgCompose1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose1.js">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose1.js">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose1.js">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose1.js">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose3.js">mailnews/compose/test/unit/test_nsMsgCompose3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose3.js">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose3.js">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose3.js">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose3.js">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/compose/test/unit/test_nsMsgCompose3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c978b9551308d4ec20ec4025ede555a624137db/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/0c978b9551308d4ec20ec4025ede555a624137db/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/0c978b9551308d4ec20ec4025ede555a624137db/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/0c978b9551308d4ec20ec4025ede555a624137db/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/0c978b9551308d4ec20ec4025ede555a624137db/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1515,28 +1515,28 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l1.4"></a><span id="l1.4">       identities = gAccountManager.allIdentities;</span>
<a href="#l1.5"></a><span id="l1.5">     params.identity = identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l1.6"></a><span id="l1.6">   }</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   identityList.value = params.identity.key;</span>
<a href="#l1.9"></a><span id="l1.9">   LoadIdentity(true);</span>
<a href="#l1.10"></a><span id="l1.10">   var composeSvc = Components.classes[&quot;@mozilla.org/messengercompose;1&quot;]</span>
<a href="#l1.11"></a><span id="l1.11">                              .getService(Components.interfaces.nsIMsgComposeService);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  gMsgCompose = composeSvc.InitCompose(window, params);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  var editorElement = GetCurrentEditorElement();</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  gMsgCompose = composeSvc.initCompose(params, window, editorElement.docShell);</span>
<a href="#l1.17"></a><span id="l1.17">   if (gMsgCompose)</span>
<a href="#l1.18"></a><span id="l1.18">   {</span>
<a href="#l1.19"></a><span id="l1.19">     // set the close listener</span>
<a href="#l1.20"></a><span id="l1.20">     gMsgCompose.recyclingListener = gComposeRecyclingListener;</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">     //Lets the compose object knows that we are dealing with a recycled window</span>
<a href="#l1.23"></a><span id="l1.23">     gMsgCompose.recycledWindow = recycled;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    var editorElement = GetCurrentEditorElement();</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-</span>
<a href="#l1.28"></a><span id="l1.28">     document.getElementById(&quot;returnReceiptMenu&quot;)</span>
<a href="#l1.29"></a><span id="l1.29">             .setAttribute('checked', gMsgCompose.compFields.returnReceipt);</span>
<a href="#l1.30"></a><span id="l1.30">     document.getElementById(&quot;dsnMenu&quot;)</span>
<a href="#l1.31"></a><span id="l1.31">             .setAttribute('checked', gMsgCompose.compFields.DSN);</span>
<a href="#l1.32"></a><span id="l1.32">     document.getElementById(&quot;cmd_attachVCard&quot;)</span>
<a href="#l1.33"></a><span id="l1.33">             .setAttribute('checked', gMsgCompose.compFields.attachVCard);</span>
<a href="#l1.34"></a><span id="l1.34">     document.getElementById(&quot;menu_inlineSpellCheck&quot;)</span>
<a href="#l1.35"></a><span id="l1.35">             .setAttribute('checked', getPref(&quot;mail.spellcheck.inline&quot;));</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineat">@@ -2641,17 +2641,17 @@ function SetComposeWindowTitle()</span>
<a href="#l1.37"></a><span id="l1.37">   newTitle += GetCharsetUIString();</span>
<a href="#l1.38"></a><span id="l1.38">   document.title = bundle.getString(&quot;windowTitlePrefix&quot;) + &quot; &quot; + newTitle;</span>
<a href="#l1.39"></a><span id="l1.39"> }</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> // Check for changes to document and allow saving before closing</span>
<a href="#l1.42"></a><span id="l1.42"> // This is hooked up to the OS's window close widget (e.g., &quot;X&quot; for Windows)</span>
<a href="#l1.43"></a><span id="l1.43"> function ComposeCanClose()</span>
<a href="#l1.44"></a><span id="l1.44"> {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  // Do this early, so ldap sessions have a better chance to </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  // Do this early, so ldap sessions have a better chance to</span>
<a href="#l1.47"></a><span id="l1.47">   // cleanup after themselves.</span>
<a href="#l1.48"></a><span id="l1.48">   ReleaseAutoCompleteState();</span>
<a href="#l1.49"></a><span id="l1.49">   if (gSendOrSaveOperationInProgress)</span>
<a href="#l1.50"></a><span id="l1.50">   {</span>
<a href="#l1.51"></a><span id="l1.51">     var result;</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">     if (gPromptService)</span>
<a href="#l1.54"></a><span id="l1.54">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -50,17 +50,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsIMsgComposeService.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> // needed by the content load policy manager</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> // needed for mailnews content load policy manager</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -319,33 +318,22 @@ nsMsgContentPolicy::ShouldLoad(PRUint32 </span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">   // If we are allowing all remote content...</span>
<a href="#l2.24"></a><span id="l2.24">   if (!mBlockRemoteImages)</span>
<a href="#l2.25"></a><span id="l2.25">   {</span>
<a href="#l2.26"></a><span id="l2.26">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l2.27"></a><span id="l2.27">     return NS_OK;</span>
<a href="#l2.28"></a><span id="l2.28">   }</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  // Non-Thunderbird apps got this earlier.</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-#ifdef MOZ_THUNDERBIRD</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt; rootDocShell;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  rv = GetRootDocShellForContext(aRequestingContext,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-                                 getter_AddRefs(rootDocShell));</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-#endif</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-</span>
<a href="#l2.38"></a><span id="l2.38">   // Extract the windowtype to handle compose windows separately from mail</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  PRBool isComposeWindow = PR_FALSE;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-  rv = IsComposeWindow(rootDocShell, isComposeWindow);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = GetMsgComposeForContext(aRequestingContext);</span>
<a href="#l2.44"></a><span id="l2.44">   // Work out if we're in a compose window or not.</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-  if (isComposeWindow)</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  if (msgCompose)</span>
<a href="#l2.47"></a><span id="l2.47">   {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    ComposeShouldLoad(rootDocShell, aRequestingContext, aContentLocation,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    ComposeShouldLoad(msgCompose, aRequestingContext, aContentLocation,</span>
<a href="#l2.50"></a><span id="l2.50">                       aDecision);</span>
<a href="#l2.51"></a><span id="l2.51">     return NS_OK;</span>
<a href="#l2.52"></a><span id="l2.52">   }</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54">   // Find out the URI that originally initiated the set of requests for this</span>
<a href="#l2.55"></a><span id="l2.55">   // context.</span>
<a href="#l2.56"></a><span id="l2.56">   nsCOMPtr&lt;nsIURI&gt; originatorLocation;</span>
<a href="#l2.57"></a><span id="l2.57">   rv = GetOriginatingURIForContext(aRequestingContext,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineat">@@ -580,40 +568,31 @@ nsMsgContentPolicy::ShouldAcceptContentF</span>
<a href="#l2.59"></a><span id="l2.59">     }</span>
<a href="#l2.60"></a><span id="l2.60">   }</span>
<a href="#l2.61"></a><span id="l2.61"> }</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63"> /** </span>
<a href="#l2.64"></a><span id="l2.64">  * Content policy logic for compose windows</span>
<a href="#l2.65"></a><span id="l2.65">  * </span>
<a href="#l2.66"></a><span id="l2.66">  */</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-void nsMsgContentPolicy::ComposeShouldLoad(nsIDocShell * aRootDocShell, nsISupports * aRequestingContext,</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-                                               nsIURI * aContentLocation, PRInt16 * aDecision)</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+void nsMsgContentPolicy::ComposeShouldLoad(nsIMsgCompose *aMsgCompose,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+                                           nsISupports *aRequestingContext,</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+                                           nsIURI *aContentLocation,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+                                           PRInt16 *aDecision)</span>
<a href="#l2.73"></a><span id="l2.73"> {</span>
<a href="#l2.74"></a><span id="l2.74">   NS_PRECONDITION(*aDecision == nsIContentPolicy::REJECT_REQUEST,</span>
<a href="#l2.75"></a><span id="l2.75">                   &quot;ComposeShouldLoad expects default decision to be reject!&quot;);</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">   nsresult rv;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  nsCOMPtr&lt;nsIDOMWindowInternal&gt; window(do_GetInterface(aRootDocShell, &amp;rv));</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService (do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-  rv = composeService-&gt;GetMsgComposeForWindow(window, getter_AddRefs(msgCompose));</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-</span>
<a href="#l2.89"></a><span id="l2.89">   nsCString originalMsgURI;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-  msgCompose-&gt;GetOriginalMsgURI(getter_Copies(originalMsgURI));</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  rv = aMsgCompose-&gt;GetOriginalMsgURI(getter_Copies(originalMsgURI));</span>
<a href="#l2.92"></a><span id="l2.92">   NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">   MSG_ComposeType composeType;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  rv = msgCompose-&gt;GetType(&amp;composeType);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  rv = aMsgCompose-&gt;GetType(&amp;composeType);</span>
<a href="#l2.97"></a><span id="l2.97">   NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">   // Only allow remote content for new mail compositions or mailto</span>
<a href="#l2.100"></a><span id="l2.100">   // Block remote content for all other types (drafts, templates, forwards, replies, etc)</span>
<a href="#l2.101"></a><span id="l2.101">   // unless there is an associated msgHdr which allows the load, or unless the image is being</span>
<a href="#l2.102"></a><span id="l2.102">   // added by the user and not the quoted message content...</span>
<a href="#l2.103"></a><span id="l2.103">   if (composeType == nsIMsgCompType::New ||</span>
<a href="#l2.104"></a><span id="l2.104">       composeType == nsIMsgCompType::MailToUrl)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineat">@@ -630,55 +609,52 @@ void nsMsgContentPolicy::ComposeShouldLo</span>
<a href="#l2.106"></a><span id="l2.106">     // the user to add remote images to the message. But we don't want remote</span>
<a href="#l2.107"></a><span id="l2.107">     // images that are a part of the quoted content to load. Fortunately, after</span>
<a href="#l2.108"></a><span id="l2.108">     // the quoted message has been inserted into the document, mail compose</span>
<a href="#l2.109"></a><span id="l2.109">     // flags remote content elements that came from the original message with a</span>
<a href="#l2.110"></a><span id="l2.110">     // moz-do-not-send attribute. </span>
<a href="#l2.111"></a><span id="l2.111">     if (*aDecision == nsIContentPolicy::REJECT_REQUEST)</span>
<a href="#l2.112"></a><span id="l2.112">     {</span>
<a href="#l2.113"></a><span id="l2.113">       PRBool insertingQuotedContent = PR_TRUE;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-      msgCompose-&gt;GetInsertingQuotedContent(&amp;insertingQuotedContent);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+      aMsgCompose-&gt;GetInsertingQuotedContent(&amp;insertingQuotedContent);</span>
<a href="#l2.116"></a><span id="l2.116">       nsCOMPtr&lt;nsIDOMHTMLImageElement&gt; imageElement(do_QueryInterface(aRequestingContext));</span>
<a href="#l2.117"></a><span id="l2.117">       if (!insertingQuotedContent &amp;&amp; imageElement)</span>
<a href="#l2.118"></a><span id="l2.118">       {</span>
<a href="#l2.119"></a><span id="l2.119">         PRBool doNotSendAttrib;</span>
<a href="#l2.120"></a><span id="l2.120">         if (NS_SUCCEEDED(imageElement-&gt;HasAttribute(NS_LITERAL_STRING(&quot;moz-do-not-send&quot;), &amp;doNotSendAttrib)) &amp;&amp; </span>
<a href="#l2.121"></a><span id="l2.121">             !doNotSendAttrib)</span>
<a href="#l2.122"></a><span id="l2.122">           *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l2.123"></a><span id="l2.123">       }</span>
<a href="#l2.124"></a><span id="l2.124">     }</span>
<a href="#l2.125"></a><span id="l2.125">   }</span>
<a href="#l2.126"></a><span id="l2.126"> }</span>
<a href="#l2.127"></a><span id="l2.127"> </span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-/**</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">- * Uses the root docshell to determine if we're in a compose window or not.</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">- */</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-nsresult nsMsgContentPolicy::IsComposeWindow(nsIDocShell *aRootDocShell,</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                                             PRBool &amp;aIsComposeWindow)</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+already_AddRefed&lt;nsIMsgCompose&gt; nsMsgContentPolicy::GetMsgComposeForContext(nsISupports *aRequestingContext)</span>
<a href="#l2.134"></a><span id="l2.134"> {</span>
<a href="#l2.135"></a><span id="l2.135">   nsresult rv;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-  // get the dom document element</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-  nsCOMPtr&lt;nsIDOMDocument&gt; domDocument = do_GetInterface(aRootDocShell, &amp;rv);</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-  nsCOMPtr&lt;nsIDOMElement&gt; windowEl;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  rv = domDocument-&gt;GetDocumentElement(getter_AddRefs(windowEl));</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellTreeItem(do_QueryInterface(shell, &amp;rv));</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootItem;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  rv = docShellTreeItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootItem));</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-  nsAutoString windowType;</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-  // GetDocumentElement may succeed but return nsnull, if it does, we'll</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-  // treat the window as a non-msgcompose window.</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-  if (windowEl)</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-  {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-    rv = windowEl-&gt;GetAttribute(NS_LITERAL_STRING(&quot;windowtype&quot;), windowType);</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-  }</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(rootItem, &amp;rv));</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService(do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, nsnull);</span>
<a href="#l2.164"></a><span id="l2.164"> </span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-  aIsComposeWindow = windowType.Equals(NS_LITERAL_STRING(&quot;msgcompose&quot;));</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-  return NS_OK;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  nsIMsgCompose* msgCompose = nsnull;</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+  // Don't bother checking rv, as GetMsgComposeForDocShell returns NS_ERROR_FAILURE</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  // for not found. We default to nsnull, so we're still returning a valid value.</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  composeService-&gt;GetMsgComposeForDocShell(docShell, &amp;msgCompose);</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  return msgCompose;</span>
<a href="#l2.172"></a><span id="l2.172"> }</span>
<a href="#l2.173"></a><span id="l2.173"> </span>
<a href="#l2.174"></a><span id="l2.174"> nsresult nsMsgContentPolicy::DisableJSOnMailNewsUrlDocshells(</span>
<a href="#l2.175"></a><span id="l2.175">   nsIURI *aContentLocation, nsISupports *aRequestingContext)</span>
<a href="#l2.176"></a><span id="l2.176"> {</span>
<a href="#l2.177"></a><span id="l2.177">   // XXX if this class changes so that this method can be called from</span>
<a href="#l2.178"></a><span id="l2.178">   // ShouldProcess, and if it's possible for this to be null when called from</span>
<a href="#l2.179"></a><span id="l2.179">   // ShouldLoad, but not in the corresponding ShouldProcess call,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -48,16 +48,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #define _nsMsgContentPolicy_H_</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> /* DBFCFDF0-4489-4faa-8122-190FD1EFA16C */</span>
<a href="#l3.15"></a><span id="l3.15"> #define NS_MSGCONTENTPOLICY_CID \</span>
<a href="#l3.16"></a><span id="l3.16"> { 0xdbfcfdf0, 0x4489, 0x4faa, { 0x81, 0x22, 0x19, 0xf, 0xd1, 0xef, 0xa1, 0x6c } }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> #define NS_MSGCONTENTPOLICY_CONTRACTID &quot;@mozilla.org/messenger/content-policy;1&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> class nsIMsgDBHdr;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -92,20 +93,20 @@ protected:</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   PRBool ShouldAcceptRemoteContentForSender(nsIMsgDBHdr *aMsgHdr);</span>
<a href="#l3.24"></a><span id="l3.24">   PRInt16 ShouldAcceptRemoteContentForMsgHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l3.25"></a><span id="l3.25">                                              nsIURI *aRequestingLocation,</span>
<a href="#l3.26"></a><span id="l3.26">                                              nsIURI *aContentLocation);</span>
<a href="#l3.27"></a><span id="l3.27">   void ShouldAcceptContentForPotentialMsg(nsIURI *aOriginatorLocation,</span>
<a href="#l3.28"></a><span id="l3.28">                                           nsIURI *aContentLocation,</span>
<a href="#l3.29"></a><span id="l3.29">                                           PRInt16 *aDecision);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  void ComposeShouldLoad(nsIDocShell *aRootDocShell,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  void ComposeShouldLoad(nsIMsgCompose *aMsgCompose,</span>
<a href="#l3.32"></a><span id="l3.32">                          nsISupports *aRequestingContext, </span>
<a href="#l3.33"></a><span id="l3.33">                          nsIURI *aContentLocation, PRInt16 *aDecision);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  nsresult IsComposeWindow(nsIDocShell *aAppDocShell, PRBool &amp;isComposeWindow);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  already_AddRefed&lt;nsIMsgCompose&gt; GetMsgComposeForContext(nsISupports *aRequestingContext);</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   nsresult GetRootDocShellForContext(nsISupports *aRequestingContext,</span>
<a href="#l3.38"></a><span id="l3.38">                                      nsIDocShell **aDocShell);</span>
<a href="#l3.39"></a><span id="l3.39">   nsresult GetOriginatingURIForContext(nsISupports *aRequestingContext,</span>
<a href="#l3.40"></a><span id="l3.40">                                        nsIURI **aURI);</span>
<a href="#l3.41"></a><span id="l3.41">   nsresult DisableJSOnMailNewsUrlDocshells(nsIURI *aContentLocation,</span>
<a href="#l3.42"></a><span id="l3.42">                                            nsISupports *aRequestingContext);</span>
<a href="#l3.43"></a><span id="l3.43"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgCompose.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -43,16 +43,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> %{C++</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> %}</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIMsgSend;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIMsgIdentity;</span>
<a href="#l4.11"></a><span id="l4.11"> interface nsIMsgProgress;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+interface nsIDocShell;</span>
<a href="#l4.13"></a><span id="l4.13"> interface nsIDOMWindowInternal;</span>
<a href="#l4.14"></a><span id="l4.14"> interface nsIDOMWindow;</span>
<a href="#l4.15"></a><span id="l4.15"> interface nsIDOMNode;</span>
<a href="#l4.16"></a><span id="l4.16"> interface nsIEditor;</span>
<a href="#l4.17"></a><span id="l4.17"> interface nsIMsgWindow;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> typedef long MSG_ComposeSaveType;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineat">@@ -127,21 +128,31 @@ native nsString(nsString);</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> /* recycling listener interface */</span>
<a href="#l4.24"></a><span id="l4.24"> [scriptable, uuid(0b28cc56-1dd2-11b2-bbe4-99e6a314f8ba)]</span>
<a href="#l4.25"></a><span id="l4.25"> interface nsIMsgComposeRecyclingListener : nsISupports {</span>
<a href="#l4.26"></a><span id="l4.26">   void onClose();</span>
<a href="#l4.27"></a><span id="l4.27">   void onReopen(in nsIMsgComposeParams params);</span>
<a href="#l4.28"></a><span id="l4.28"> };</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-[scriptable, uuid(85d1f6be-6be3-4d55-8ef0-2c8c176dc5d5)]</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+[scriptable, uuid(fc9dc1dc-7726-4d29-bb92-a0227f526651)]</span>
<a href="#l4.32"></a><span id="l4.32"> interface nsIMsgCompose : nsIMsgSendListener {</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  /* ... */</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  void Initialize(in nsIDOMWindowInternal aWindow, in nsIMsgComposeParams aParams); </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  /**</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+   * Initializes the msg compose object.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+   *</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+   * @param aParams   An nsIMsgComposeParams object containing the initial</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+   *                  details for the compose.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+   * @param aWindow   The optional window associated with this compose object.</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+   * @param aDocShell The optional docShell of the editor element that is used</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+   *                  for composing.</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+   */</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  void initialize(in nsIMsgComposeParams aParams,</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+                  [optional] in nsIDOMWindowInternal aWindow,</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+                  [optional] in nsIDocShell aDocShell); </span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">   /* ... */</span>
<a href="#l4.50"></a><span id="l4.50">   void SetDocumentCharset(in string charset);</span>
<a href="#l4.51"></a><span id="l4.51">   </span>
<a href="#l4.52"></a><span id="l4.52">   /* ... */</span>
<a href="#l4.53"></a><span id="l4.53">   void RegisterStateListener(in nsIMsgComposeStateListener stateListener);</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   /* ... */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgComposeService.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -36,23 +36,23 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIMsgCompose.idl&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIMsgComposeParams.idl&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> interface nsIURI;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-interface nsIDOMWindowInternal;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+interface nsIDocShell;</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsIMsgWindow;</span>
<a href="#l5.15"></a><span id="l5.15"> interface nsIMsgIdentity;</span>
<a href="#l5.16"></a><span id="l5.16"> interface nsIMsgIncomingServer;</span>
<a href="#l5.17"></a><span id="l5.17"> interface nsIMsgDBHdr;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-[scriptable, uuid(dbf4b3a7-dc38-4362-a620-ff5d22b3777c)]</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+[scriptable, uuid(b73dae1e-7e97-45aa-8669-dacbb7e9fbd0)]</span>
<a href="#l5.21"></a><span id="l5.21"> interface nsIMsgComposeService : nsISupports {</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23">   /* we need a msg window because when we forward inline we may need progress */</span>
<a href="#l5.24"></a><span id="l5.24">   void OpenComposeWindow(in string msgComposeWindowURL,</span>
<a href="#l5.25"></a><span id="l5.25">                          in nsIMsgDBHdr msgHdr,</span>
<a href="#l5.26"></a><span id="l5.26">                          in string originalMsgURI,</span>
<a href="#l5.27"></a><span id="l5.27">                          in MSG_ComposeType type, </span>
<a href="#l5.28"></a><span id="l5.28">                          in MSG_ComposeFormat format,</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineat">@@ -64,20 +64,30 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l5.30"></a><span id="l5.30">      url you want to use in brining up a compose window, pass it in here. </span>
<a href="#l5.31"></a><span id="l5.31">      aURI --&gt; the mailto url you want to use as the foundation for the data inside</span>
<a href="#l5.32"></a><span id="l5.32">      the compose window  */</span>
<a href="#l5.33"></a><span id="l5.33">   void OpenComposeWindowWithURI(in string msgComposeWindowURL, in nsIURI aURI);</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">   /* ... */</span>
<a href="#l5.36"></a><span id="l5.36">   void OpenComposeWindowWithParams(in string msgComposeWindowURL, in nsIMsgComposeParams params);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  /* ... */</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  nsIMsgCompose InitCompose(in nsIDOMWindowInternal aWindow, in nsIMsgComposeParams params);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  /**</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   * Creates an nsIMsgCompose instance, initalizes it, and manages the window</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   * recycling cache.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+   *</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+   * @param aParams   An nsIMsgComposeParams object containing the initial</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+   *                  details for the compose.</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+   * @param aWindow   The optional window associated with this compose object.</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+   * @param aDocShell The optional docShell of the editor element that is used</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+   *                  for composing.</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+   */</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  nsIMsgCompose initCompose(in nsIMsgComposeParams aParams,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+                            [optional] in nsIDOMWindowInternal aWindow, </span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+                            [optional] in nsIDocShell aDocShell);</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  </span>
<a href="#l5.55"></a><span id="l5.55">   /**</span>
<a href="#l5.56"></a><span id="l5.56">   * defaultIdentity</span>
<a href="#l5.57"></a><span id="l5.57">   *</span>
<a href="#l5.58"></a><span id="l5.58">   * @return the default identity, in case no identity has been setup yet, will return null</span>
<a href="#l5.59"></a><span id="l5.59">   */</span>
<a href="#l5.60"></a><span id="l5.60">   readonly attribute nsIMsgIdentity defaultIdentity;</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">   /* This function is use for debugging purpose only and may go away at anytime without warning */</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineat">@@ -127,36 +137,38 @@ interface nsIMsgComposeService : nsISupp</span>
<a href="#l5.64"></a><span id="l5.64">    * @param templateUri uri of the template to base ther reply on</span>
<a href="#l5.65"></a><span id="l5.65">    * @param msgWindow message window to use</span>
<a href="#l5.66"></a><span id="l5.66">    * @param server server to use for determining which account to send from</span>
<a href="#l5.67"></a><span id="l5.67">    */</span>
<a href="#l5.68"></a><span id="l5.68">   void replyWithTemplate(in nsIMsgDBHdr msgHdr, in string templateUri,</span>
<a href="#l5.69"></a><span id="l5.69">                          in nsIMsgWindow msgWindow, in nsIMsgIncomingServer server);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">   /** </span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-   * Every open compose window registers itself with the compose service </span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-   * This allows consumers to get the msg compose object associated with a dom window</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+   * The docShell of each editor element used for composing should be registered</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+   * with this service. docShells passed to initCompose get registered</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+   * automatically. The registrations are typically used to get the msgCompose</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+   * window when determining what remote content to allow to be displayed.</span>
<a href="#l5.78"></a><span id="l5.78">    *</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-   * @param aWindow The DOM Window </span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+   * @param aDocShell The nsIDocShell of the editor element. </span>
<a href="#l5.81"></a><span id="l5.81">    * @param aMsgCompose The compose object associated with the compose window</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-   *</span>
<a href="#l5.83"></a><span id="l5.83">    */</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-  void registerComposeWindow(in nsIDOMWindowInternal aWindow, in nsIMsgCompose aMsgCompose);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+  void registerComposeDocShell(in nsIDocShell aDocShell,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+                               in nsIMsgCompose aMsgCompose);</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88">   /** </span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-   * When a compose window is being closed (or recyled), it unregisters itself</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-   * from the compose service. </span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+   * When an editor docShell is being closed (or recycled), you should</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+   * unregister it from this service. nsIMsgCompose normally calls this</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+   * automatically for items passed to initCompose.</span>
<a href="#l5.94"></a><span id="l5.94">    *</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-   * @param aWindow The DOM Window </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-   *</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+   * @param aDocShell The nsIDocShell of the editor element. </span>
<a href="#l5.98"></a><span id="l5.98">    */</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  void unregisterComposeWindow(in nsIDOMWindowInternal aWindow);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  void unregisterComposeDocShell(in nsIDocShell aDocShell);</span>
<a href="#l5.101"></a><span id="l5.101">   </span>
<a href="#l5.102"></a><span id="l5.102">   /**</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-   * For aWindow, returns the nsIMsgCompose object associated with the window.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+   * For a given docShell, returns the nsIMsgCompose object associated with it.</span>
<a href="#l5.105"></a><span id="l5.105">    *</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-   * @param aWindow The DOMWindow associated with the compose window.</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+   * @param aDocShell The nsIDocShell of the editor element. </span>
<a href="#l5.108"></a><span id="l5.108">    *</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-   * @return NS_ERROR_FAILURE if we could not find a nsIMsgCompose for the passed in</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-   *         DOM Window.</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+   * @return NS_ERROR_FAILURE if we could not find a nsIMsgCompose for</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+   *         the passed in docShell.</span>
<a href="#l5.113"></a><span id="l5.113">    */</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-  nsIMsgCompose getMsgComposeForWindow(in nsIDOMWindowInternal aWindow);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  nsIMsgCompose getMsgComposeForDocShell(in nsIDocShell aDocShell);</span>
<a href="#l5.116"></a><span id="l5.116"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -780,22 +780,24 @@ NS_IMETHODIMP</span>
<a href="#l6.4"></a><span id="l6.4"> nsMsgCompose::GetQuotingToFollow(PRBool* quotingToFollow)</span>
<a href="#l6.5"></a><span id="l6.5"> {</span>
<a href="#l6.6"></a><span id="l6.6">   NS_ENSURE_ARG(quotingToFollow);</span>
<a href="#l6.7"></a><span id="l6.7">   *quotingToFollow = mQuotingToFollow;</span>
<a href="#l6.8"></a><span id="l6.8">   return NS_OK;</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> NS_IMETHODIMP</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-nsMsgCompose::Initialize(nsIDOMWindowInternal *aWindow, nsIMsgComposeParams *params)</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+nsMsgCompose::Initialize(nsIMsgComposeParams *aParams,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                         nsIDOMWindowInternal *aWindow,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                         nsIDocShell *aDocShell)</span>
<a href="#l6.16"></a><span id="l6.16"> {</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  NS_ENSURE_ARG_POINTER(params);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aParams);</span>
<a href="#l6.19"></a><span id="l6.19">   nsresult rv;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  params-&gt;GetIdentity(getter_AddRefs(m_identity));</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  aParams-&gt;GetIdentity(getter_AddRefs(m_identity));</span>
<a href="#l6.23"></a><span id="l6.23"> </span>
<a href="#l6.24"></a><span id="l6.24">   if (aWindow)</span>
<a href="#l6.25"></a><span id="l6.25">   {</span>
<a href="#l6.26"></a><span id="l6.26">     m_window = aWindow;</span>
<a href="#l6.27"></a><span id="l6.27">     nsCOMPtr&lt;nsPIDOMWindow&gt; window(do_QueryInterface(aWindow));</span>
<a href="#l6.28"></a><span id="l6.28">     if (!window)</span>
<a href="#l6.29"></a><span id="l6.29">       return NS_ERROR_FAILURE;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineat">@@ -806,27 +808,27 @@ nsMsgCompose::Initialize(nsIDOMWindowInt</span>
<a href="#l6.32"></a><span id="l6.32">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">     m_baseWindow = do_QueryInterface(treeOwner);</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">     window-&gt;GetDocShell()-&gt;SetAppType(nsIDocShell::APP_TYPE_EDITOR);</span>
<a href="#l6.37"></a><span id="l6.37">   }</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39">   MSG_ComposeFormat format;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  params-&gt;GetFormat(&amp;format);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+  aParams-&gt;GetFormat(&amp;format);</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">   MSG_ComposeType type;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-  params-&gt;GetType(&amp;type);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  aParams-&gt;GetType(&amp;type);</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">   nsCString originalMsgURI;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  params-&gt;GetOriginalMsgURI(getter_Copies(originalMsgURI));</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  params-&gt;GetOrigMsgHdr(getter_AddRefs(mOrigMsgHdr));</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  aParams-&gt;GetOriginalMsgURI(getter_Copies(originalMsgURI));</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  aParams-&gt;GetOrigMsgHdr(getter_AddRefs(mOrigMsgHdr));</span>
<a href="#l6.52"></a><span id="l6.52"> </span>
<a href="#l6.53"></a><span id="l6.53">   nsCOMPtr&lt;nsIMsgCompFields&gt; composeFields;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  params-&gt;GetComposeFields(getter_AddRefs(composeFields));</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  aParams-&gt;GetComposeFields(getter_AddRefs(composeFields));</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   nsCOMPtr&lt;nsIMsgComposeService&gt; composeService = do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.58"></a><span id="l6.58">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60">   rv = composeService-&gt;DetermineComposeHTML(m_identity, format, &amp;m_composeHTML);</span>
<a href="#l6.61"></a><span id="l6.61">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63">   if (composeFields)</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineat">@@ -863,30 +865,31 @@ nsMsgCompose::Initialize(nsIDOMWindowInt</span>
<a href="#l6.65"></a><span id="l6.65">       rv = m_identity-&gt;GetAttachVCard(&amp;attachVCard);</span>
<a href="#l6.66"></a><span id="l6.66">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.67"></a><span id="l6.67">       rv = composeFields-&gt;SetAttachVCard(attachVCard);</span>
<a href="#l6.68"></a><span id="l6.68">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.69"></a><span id="l6.69">     }</span>
<a href="#l6.70"></a><span id="l6.70">   }</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  params-&gt;GetSendListener(getter_AddRefs(externalSendListener));</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  aParams-&gt;GetSendListener(getter_AddRefs(externalSendListener));</span>
<a href="#l6.75"></a><span id="l6.75">   if(externalSendListener)</span>
<a href="#l6.76"></a><span id="l6.76">     AddMsgSendListener( externalSendListener );</span>
<a href="#l6.77"></a><span id="l6.77"> </span>
<a href="#l6.78"></a><span id="l6.78">   nsCString smtpPassword;</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  params-&gt;GetSmtpPassword(getter_Copies(smtpPassword));</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+  aParams-&gt;GetSmtpPassword(getter_Copies(smtpPassword));</span>
<a href="#l6.81"></a><span id="l6.81">   mSmtpPassword = smtpPassword;</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  params-&gt;GetHtmlToQuote(mHtmlToQuote);</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  if (aWindow)</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineplus">+  aParams-&gt;GetHtmlToQuote(mHtmlToQuote);</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  if (aDocShell)</span>
<a href="#l6.89"></a><span id="l6.89">   {</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+    mDocShell = aDocShell;</span>
<a href="#l6.91"></a><span id="l6.91">     // register the compose object with the compose service</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    rv = composeService-&gt;RegisterComposeWindow(aWindow, this);</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineplus">+    rv = composeService-&gt;RegisterComposeDocShell(aDocShell, this);</span>
<a href="#l6.94"></a><span id="l6.94">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.95"></a><span id="l6.95">   }</span>
<a href="#l6.96"></a><span id="l6.96">   return CreateMessage(originalMsgURI.get(), type, composeFields);</span>
<a href="#l6.97"></a><span id="l6.97"> }</span>
<a href="#l6.98"></a><span id="l6.98"> </span>
<a href="#l6.99"></a><span id="l6.99"> nsresult nsMsgCompose::SetDocumentCharset(const char *aCharset)</span>
<a href="#l6.100"></a><span id="l6.100"> {</span>
<a href="#l6.101"></a><span id="l6.101">   // Set charset, this will be used for the MIME charset labeling.</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineat">@@ -1354,18 +1357,19 @@ PRBool nsMsgCompose::IsLastWindow()</span>
<a href="#l6.103"></a><span id="l6.103"> NS_IMETHODIMP nsMsgCompose::CloseWindow(PRBool recycleIt)</span>
<a href="#l6.104"></a><span id="l6.104"> {</span>
<a href="#l6.105"></a><span id="l6.105">   nsresult rv;</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107">   nsCOMPtr&lt;nsIMsgComposeService&gt; composeService = do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.108"></a><span id="l6.108">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110">   // unregister the compose object with the compose service</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  rv = composeService-&gt;UnregisterComposeWindow(m_window);</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+  rv = composeService-&gt;UnregisterComposeDocShell(mDocShell);</span>
<a href="#l6.113"></a><span id="l6.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+  mDocShell = nsnull;</span>
<a href="#l6.115"></a><span id="l6.115"> </span>
<a href="#l6.116"></a><span id="l6.116">   recycleIt = recycleIt &amp;&amp; !IsLastWindow();</span>
<a href="#l6.117"></a><span id="l6.117">   if (recycleIt)</span>
<a href="#l6.118"></a><span id="l6.118">   {</span>
<a href="#l6.119"></a><span id="l6.119">     rv = composeService-&gt;CacheWindow(m_window, m_composeHTML, mRecyclingListener);</span>
<a href="#l6.120"></a><span id="l6.120">     if (NS_SUCCEEDED(rv))</span>
<a href="#l6.121"></a><span id="l6.121">     {</span>
<a href="#l6.122"></a><span id="l6.122">       nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor (do_QueryInterface(m_editor));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -119,16 +119,17 @@ private:</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   PRBool IsLastWindow();</span>
<a href="#l7.6"></a><span id="l7.6">  </span>
<a href="#l7.7"></a><span id="l7.7">        // Helper function. Parameters are not checked.</span>
<a href="#l7.8"></a><span id="l7.8">   PRBool                                    mConvertStructs;    // for TagConvertible</span>
<a href="#l7.9"></a><span id="l7.9">   </span>
<a href="#l7.10"></a><span id="l7.10"> 	nsCOMPtr&lt;nsIEditor&gt;                       m_editor;</span>
<a href="#l7.11"></a><span id="l7.11"> 	nsIDOMWindowInternal                      *m_window;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt;                     mDocShell;</span>
<a href="#l7.13"></a><span id="l7.13">   nsCOMPtr&lt;nsIBaseWindow&gt;                   m_baseWindow;</span>
<a href="#l7.14"></a><span id="l7.14"> 	nsMsgCompFields                           *m_compFields;</span>
<a href="#l7.15"></a><span id="l7.15"> 	nsCOMPtr&lt;nsIMsgIdentity&gt;                  m_identity;</span>
<a href="#l7.16"></a><span id="l7.16"> 	PRBool						                        m_composeHTML;</span>
<a href="#l7.17"></a><span id="l7.17"> 	QuotingOutputStreamListener               *mQuoteStreamListener;</span>
<a href="#l7.18"></a><span id="l7.18"> 	nsCOMPtr&lt;nsIOutputStream&gt;                 mBaseStream;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   nsCOMPtr&lt;nsIMsgComposeRecyclingListener&gt;  mRecyclingListener;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -770,36 +770,36 @@ NS_IMETHODIMP nsMsgComposeService::OpenC</span>
<a href="#l8.4"></a><span id="l8.4"> {</span>
<a href="#l8.5"></a><span id="l8.5">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l8.6"></a><span id="l8.6">   nsresult rv = GetParamsForMailto(aURI, getter_AddRefs(pMsgComposeParams));</span>
<a href="#l8.7"></a><span id="l8.7">   if (NS_SUCCEEDED(rv))</span>
<a href="#l8.8"></a><span id="l8.8">     rv = OpenComposeWindowWithParams(aMsgComposeWindowURL, pMsgComposeParams);</span>
<a href="#l8.9"></a><span id="l8.9">   return rv;</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::InitCompose(nsIDOMWindowInternal *aWindow,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                                          nsIMsgComposeParams *params,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-                                          nsIMsgCompose **_retval)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+NS_IMETHODIMP nsMsgComposeService::InitCompose(nsIMsgComposeParams *aParams,</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                                               nsIDOMWindowInternal *aWindow,</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+                                               nsIDocShell *aDocShell,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+                                               nsIMsgCompose **_retval)</span>
<a href="#l8.19"></a><span id="l8.19"> {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-  nsresult rv;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  /* we need to remove the window from the cache</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  */</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  // We need to remove the window from the cache.</span>
<a href="#l8.25"></a><span id="l8.25">   PRInt32 i;</span>
<a href="#l8.26"></a><span id="l8.26">   for (i = 0; i &lt; mMaxRecycledWindows; i ++)</span>
<a href="#l8.27"></a><span id="l8.27">     if (mCachedWindows[i].window == aWindow)</span>
<a href="#l8.28"></a><span id="l8.28">     {</span>
<a href="#l8.29"></a><span id="l8.29">       mCachedWindows[i].Clear();</span>
<a href="#l8.30"></a><span id="l8.30">       break;</span>
<a href="#l8.31"></a><span id="l8.31">     }</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  nsCOMPtr &lt;nsIMsgCompose&gt; msgCompose = do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  nsresult rv;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose =</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv);</span>
<a href="#l8.37"></a><span id="l8.37">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  rv = msgCompose-&gt;Initialize(aWindow, params);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  rv = msgCompose-&gt;Initialize(aParams, aWindow, aDocShell);</span>
<a href="#l8.41"></a><span id="l8.41">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43">   NS_IF_ADDREF(*_retval = msgCompose);</span>
<a href="#l8.44"></a><span id="l8.44">   return rv;</span>
<a href="#l8.45"></a><span id="l8.45"> }</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47"> NS_IMETHODIMP</span>
<a href="#l8.48"></a><span id="l8.48"> nsMsgComposeService::GetDefaultIdentity(nsIMsgIdentity **_retval)</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineat">@@ -1038,17 +1038,17 @@ NS_IMETHODIMP nsMsgTemplateReplyHelper::</span>
<a href="#l8.50"></a><span id="l8.50">   pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l8.51"></a><span id="l8.51">   pMsgComposeParams-&gt;SetOriginalMsgURI(msgUri.get());</span>
<a href="#l8.52"></a><span id="l8.52">   // create the nsIMsgCompose object to send the object</span>
<a href="#l8.53"></a><span id="l8.53">   nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l8.54"></a><span id="l8.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.55"></a><span id="l8.55"> </span>
<a href="#l8.56"></a><span id="l8.56">   /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-  rv = pMsgCompose-&gt;Initialize(parentWindow, pMsgComposeParams) ;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+  rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, parentWindow, nsnull);</span>
<a href="#l8.60"></a><span id="l8.60">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">   Release();</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">   return pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nsnull, nsnull, nsnull) ;</span>
<a href="#l8.65"></a><span id="l8.65"> }</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67"> NS_IMETHODIMP</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineat">@@ -1285,17 +1285,17 @@ nsMsgComposeService::ForwardMessage(cons</span>
<a href="#l8.69"></a><span id="l8.69">   pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l8.70"></a><span id="l8.70">   pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l8.71"></a><span id="l8.71">   pMsgComposeParams-&gt;SetOriginalMsgURI(msgUri.get());</span>
<a href="#l8.72"></a><span id="l8.72">   // create the nsIMsgCompose object to send the object</span>
<a href="#l8.73"></a><span id="l8.73">   nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l8.74"></a><span id="l8.74">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76">   /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-  rv = pMsgCompose-&gt;Initialize(parentWindow, pMsgComposeParams) ;</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+  rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, parentWindow, nsnull);</span>
<a href="#l8.79"></a><span id="l8.79">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">   rv = pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nsnull, nsnull, nsnull);</span>
<a href="#l8.82"></a><span id="l8.82">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">   // nsMsgCompose::ProcessReplyFlags usually takes care of marking messages</span>
<a href="#l8.85"></a><span id="l8.85">   // as forwarded. ProcessReplyFlags is normally called from</span>
<a href="#l8.86"></a><span id="l8.86">   // nsMsgComposeSendListener::OnStopSending but for this case the msgCompose</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineat">@@ -1469,61 +1469,68 @@ nsresult nsMsgComposeService::AddGlobalH</span>
<a href="#l8.88"></a><span id="l8.88">       rv = prefBranch-&gt;SetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME, htmlDomainListCurrentVersion + 1);</span>
<a href="#l8.89"></a><span id="l8.89">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.90"></a><span id="l8.90">     }</span>
<a href="#l8.91"></a><span id="l8.91">   }</span>
<a href="#l8.92"></a><span id="l8.92">   return NS_OK;</span>
<a href="#l8.93"></a><span id="l8.93"> }</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95"> NS_IMETHODIMP</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-nsMsgComposeService::RegisterComposeWindow(nsIDOMWindowInternal * aWindow, nsIMsgCompose *aComposeObject)</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+nsMsgComposeService::RegisterComposeDocShell(nsIDocShell *aDocShell,</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+                                             nsIMsgCompose *aComposeObject)</span>
<a href="#l8.99"></a><span id="l8.99"> {</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDocShell);</span>
<a href="#l8.102"></a><span id="l8.102">   NS_ENSURE_ARG_POINTER(aComposeObject);</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">   nsresult rv;</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106">   // add the msg compose / dom window mapping to our hash table</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  nsCOMPtr&lt;nsIWeakReference&gt; weakDOMWindow = do_GetWeakReference(aWindow, &amp;rv);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  nsCOMPtr&lt;nsIWeakReference&gt; weakDocShell = do_GetWeakReference(aDocShell, &amp;rv);</span>
<a href="#l8.109"></a><span id="l8.109">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.110"></a><span id="l8.110">   nsCOMPtr&lt;nsIWeakReference&gt; weakMsgComposePtr = do_GetWeakReference(aComposeObject);</span>
<a href="#l8.111"></a><span id="l8.111">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-  mOpenComposeWindows.Put(weakDOMWindow, weakMsgComposePtr);</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  mOpenComposeWindows.Put(weakDocShell, weakMsgComposePtr);</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   return rv;</span>
<a href="#l8.116"></a><span id="l8.116"> }</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118"> NS_IMETHODIMP</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-nsMsgComposeService::UnregisterComposeWindow(nsIDOMWindowInternal * aWindow)</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+nsMsgComposeService::UnregisterComposeDocShell(nsIDocShell *aDocShell)</span>
<a href="#l8.121"></a><span id="l8.121"> {</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDocShell);</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">   nsresult rv;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  nsCOMPtr&lt;nsIWeakReference&gt; weakDOMWindow = do_GetWeakReference(aWindow, &amp;rv);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+  nsCOMPtr&lt;nsIWeakReference&gt; weakDocShell = do_GetWeakReference(aDocShell, &amp;rv);</span>
<a href="#l8.128"></a><span id="l8.128">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.129"></a><span id="l8.129"> </span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-  mOpenComposeWindows.Remove(weakDOMWindow);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  mOpenComposeWindows.Remove(weakDocShell);</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133">   return rv;</span>
<a href="#l8.134"></a><span id="l8.134"> }</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136"> NS_IMETHODIMP</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-nsMsgComposeService::GetMsgComposeForWindow(nsIDOMWindowInternal * aWindow, nsIMsgCompose ** aComposeObject)</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+nsMsgComposeService::GetMsgComposeForDocShell(nsIDocShell *aDocShell,</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+                                              nsIMsgCompose **aComposeObject)</span>
<a href="#l8.140"></a><span id="l8.140"> {</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDocShell);</span>
<a href="#l8.143"></a><span id="l8.143">   NS_ENSURE_ARG_POINTER(aComposeObject);</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+  if (!mOpenComposeWindows.Count())</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+</span>
<a href="#l8.148"></a><span id="l8.148">   // get the weak reference for our dom window</span>
<a href="#l8.149"></a><span id="l8.149">   nsresult rv;</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-  nsCOMPtr&lt;nsIWeakReference&gt; weakDOMWindow = do_GetWeakReference(aWindow, &amp;rv);</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+  nsCOMPtr&lt;nsIWeakReference&gt; weakDocShell = do_GetWeakReference(aDocShell, &amp;rv);</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.154"></a><span id="l8.154"> </span>
<a href="#l8.155"></a><span id="l8.155">   nsCOMPtr&lt;nsIWeakReference&gt; weakMsgComposePtr;</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-  NS_ENSURE_TRUE(mOpenComposeWindows.Get(weakDOMWindow, getter_AddRefs(weakMsgComposePtr)), NS_ERROR_FAILURE);</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+  if (!mOpenComposeWindows.Get(weakDocShell,</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+                               getter_AddRefs(weakMsgComposePtr)))</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l8.161"></a><span id="l8.161"> </span>
<a href="#l8.162"></a><span id="l8.162">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = do_QueryReferent(weakMsgComposePtr, &amp;rv);</span>
<a href="#l8.163"></a><span id="l8.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.164"></a><span id="l8.164"> </span>
<a href="#l8.165"></a><span id="l8.165">   NS_IF_ADDREF(*aComposeObject = msgCompose);</span>
<a href="#l8.166"></a><span id="l8.166">   return rv;</span>
<a href="#l8.167"></a><span id="l8.167"> }</span>
<a href="#l8.168"></a><span id="l8.168"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose1.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -23,17 +23,17 @@ function checkPopulate(aTo, aNonHTMLReci</span>
<a href="#l9.4"></a><span id="l9.4">   fields.to = aTo;</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6">   // Set up some params</span>
<a href="#l9.7"></a><span id="l9.7">   var params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l9.8"></a><span id="l9.8">                          .createInstance(nsIMsgComposeParams);</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10">   params.composeFields = fields;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  msgCompose.Initialize(null, params);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  msgCompose.initialize(params);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   var nonHTMLRecipients = new Object();</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l9.18"></a><span id="l9.18">                                                     nonHTMLRecipients),</span>
<a href="#l9.19"></a><span id="l9.19">               aPreferMailOut);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   do_check_eq(fields.to, aCheckTo);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -58,17 +58,17 @@ function run_test() {</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   var msgCompose = Components.classes[MsgComposeContractID]</span>
<a href="#l9.25"></a><span id="l9.25">                              .createInstance(nsIMsgCompose);</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   // Set up some params</span>
<a href="#l9.28"></a><span id="l9.28">   var params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l9.29"></a><span id="l9.29">                          .createInstance(nsIMsgComposeParams);</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  msgCompose.Initialize(null, params);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  msgCompose.initialize(params);</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">   // Test - checkAndPopulateRecipients basic functionality.</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">   // Re-initialize</span>
<a href="#l9.37"></a><span id="l9.37">   msgCompose = Components.classes[MsgComposeContractID]</span>
<a href="#l9.38"></a><span id="l9.38">                          .createInstance(nsIMsgCompose);</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">   // Set up some basic fields for compose.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -82,17 +82,17 @@ function run_test() {</span>
<a href="#l9.42"></a><span id="l9.42">   fields.bcc = &quot;test4@invalid1.com&quot;;</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44">   // Set up some params</span>
<a href="#l9.45"></a><span id="l9.45">   params = Components.classes[MsgComposeParamsContractID]</span>
<a href="#l9.46"></a><span id="l9.46">                      .createInstance(nsIMsgComposeParams);</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">   params.composeFields = fields;</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  msgCompose.Initialize(null, params);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  msgCompose.initialize(params);</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   var nonHTMLRecipients = new Object();</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55">   do_check_eq(msgCompose.checkAndPopulateRecipients(true, false,</span>
<a href="#l9.56"></a><span id="l9.56">                                                     nonHTMLRecipients),</span>
<a href="#l9.57"></a><span id="l9.57">               nsIAbPreferMailFormat.unknown);</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">   do_check_eq(nonHTMLRecipients.value, &quot;&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_nsMsgCompose3.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -42,17 +42,17 @@ function checkPopulate(aTo, aNonHTMLReci</span>
<a href="#l10.4"></a><span id="l10.4">   fields.to = aTo;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   // Set up some params</span>
<a href="#l10.7"></a><span id="l10.7">   let params = Cc[MsgComposeParamsContractID]</span>
<a href="#l10.8"></a><span id="l10.8">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">   params.composeFields = fields;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  msgCompose.Initialize(null, params);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  msgCompose.initialize(params);</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">   let nonHTMLRecipients = new Object();</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">   do_check_eq(msgCompose.checkAndPopulateRecipients(true, true,</span>
<a href="#l10.18"></a><span id="l10.18">                                                     nonHTMLRecipients),</span>
<a href="#l10.19"></a><span id="l10.19">               aPreferMailOut);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   do_check_eq(fields.to, aCheckTo);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -373,17 +373,17 @@ nsresult nsMapiHook::BlindSendMail (unsi</span>
<a href="#l11.4"></a><span id="l11.4">   pMsgComposeParams-&gt;SetSmtpPassword(smtpPassword.get());</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6">   // create the nsIMsgCompose object to send the object</span>
<a href="#l11.7"></a><span id="l11.7">   nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l11.8"></a><span id="l11.8">   if (NS_FAILED(rv) || (!pMsgCompose) ) return rv ;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  rv = pMsgCompose-&gt;Initialize(hiddenWindow, pMsgComposeParams) ;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, hiddenWindow, nsnull);</span>
<a href="#l11.14"></a><span id="l11.14">   if (NS_FAILED(rv)) return rv ;</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">   return pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, pMsgId, nsnull, nsnull, nsnull) ;</span>
<a href="#l11.17"></a><span id="l11.17">   if (NS_FAILED(rv)) return rv ;</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19">   // assign to interface pointer from nsCOMPtr to facilitate typecast below</span>
<a href="#l11.20"></a><span id="l11.20">   nsIMsgSendListener * pSendListener = sendListener ;</span>
<a href="#l11.21"></a><span id="l11.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -301,17 +301,17 @@ SendTheMessage(nsIMsgCompFields *   comp</span>
<a href="#l12.4"></a><span id="l12.4">   nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l12.5"></a><span id="l12.5">            do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l12.6"></a><span id="l12.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.7"></a><span id="l12.7">   // create the nsIMsgCompose object to send the object</span>
<a href="#l12.8"></a><span id="l12.8">   nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l12.9"></a><span id="l12.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">   /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  rv = pMsgCompose-&gt;Initialize(nsnull, pMsgComposeParams) ;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, nsnull, nsnull);</span>
<a href="#l12.14"></a><span id="l12.14">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">   return pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nsnull, nsnull, nsnull) ;</span>
<a href="#l12.17"></a><span id="l12.17"> }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> nsresult</span>
<a href="#l12.20"></a><span id="l12.20"> CreateCompositionFields(const char        *from,</span>
<a href="#l12.21"></a><span id="l12.21">                         const char        *reply_to,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1274,27 +1274,28 @@ function ComposeStartup(recycled, aParam</span>
<a href="#l13.4"></a><span id="l13.4">       identities = gAccountManager.allIdentities;</span>
<a href="#l13.5"></a><span id="l13.5">     params.identity = identities.QueryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l13.6"></a><span id="l13.6">   }</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">   identityList.value = params.identity.key;</span>
<a href="#l13.9"></a><span id="l13.9">   LoadIdentity(true);</span>
<a href="#l13.10"></a><span id="l13.10">   if (sMsgComposeService)</span>
<a href="#l13.11"></a><span id="l13.11">   {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    gMsgCompose = sMsgComposeService.InitCompose(window, params);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+    // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    var editorElement = GetCurrentEditorElement();</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    gMsgCompose = sMsgComposeService.initCompose(params, window,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+                                                 editorElement.docShell);</span>
<a href="#l13.17"></a><span id="l13.17">     if (gMsgCompose)</span>
<a href="#l13.18"></a><span id="l13.18">     {</span>
<a href="#l13.19"></a><span id="l13.19">       // set the close listener</span>
<a href="#l13.20"></a><span id="l13.20">       gMsgCompose.recyclingListener = gComposeRecyclingListener;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">       //Lets the compose object knows that we are dealing with a recycled window</span>
<a href="#l13.23"></a><span id="l13.23">       gMsgCompose.recycledWindow = recycled;</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-      // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-      var editorElement = GetCurrentEditorElement();</span>
<a href="#l13.27"></a><span id="l13.27">       if (!editorElement)</span>
<a href="#l13.28"></a><span id="l13.28">       {</span>
<a href="#l13.29"></a><span id="l13.29">         dump(&quot;Failed to get editor element!\n&quot;);</span>
<a href="#l13.30"></a><span id="l13.30">         return;</span>
<a href="#l13.31"></a><span id="l13.31">       }</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33">       document.getElementById(&quot;returnReceiptMenu&quot;).setAttribute('checked',</span>
<a href="#l13.34"></a><span id="l13.34">                                          gMsgCompose.compFields.returnReceipt);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

