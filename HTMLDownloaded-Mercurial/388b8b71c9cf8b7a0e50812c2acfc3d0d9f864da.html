<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28275:388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da" />
<meta property="og:url" content="/comm-central/rev/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da" />
<meta property="og:description" content="Bug 1594855 - Import JS needed for message reading, subset of reviewed patch. r=patrick DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">shortlog</a> |
<a href="/comm-central/log/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">files</a> |
changeset |
<a href="/comm-central/raw-rev/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">raw</a>  | <a href="/comm-central/archive/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594855">Bug 1594855</a> - Import JS needed for message reading, subset of reviewed patch. r=patrick DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 27 Nov 2019 11:17:35 +0100</td></tr>

<tr>
 <td>changeset 28275</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da</a></td>
</tr>



<tr>
<td>parent 28274</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5629275db993996f84626ca8ddbb5296fb42f8f5">5629275db993996f84626ca8ddbb5296fb42f8f5</a>
</td>
</tr>

<tr>
<td>child 28276</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/10abecc1ae80917bc510391bdaa96060e8401440">10abecc1ae80917bc510391bdaa96060e8401440</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">16733</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Wed, 27 Nov 2019 10:20:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@10abecc1ae80 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=10abecc1ae80917bc510391bdaa96060e8401440">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=10abecc1ae80917bc510391bdaa96060e8401440&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=10abecc1ae80917bc510391bdaa96060e8401440&newProject=comm-central&newRevision=4213d50b5bfcc46f65d4ac64903ff21ee0105e05&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=10abecc1ae80917bc510391bdaa96060e8401440&newProject=comm-central&newRevision=4213d50b5bfcc46f65d4ac64903ff21ee0105e05&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=10abecc1ae80917bc510391bdaa96060e8401440&newProject=comm-central&newRevision=4213d50b5bfcc46f65d4ac64903ff21ee0105e05&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28patrick%29&revcount=50">patrick</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594855">1594855</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594855">Bug 1594855</a> - Import JS needed for message reading, subset of reviewed patch. r=patrick DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,2615 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/*</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+ */</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+/* Globals from Thunderbird: */</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+/* global ReloadMessage: false, gDBView: false, gSignatureStatus: false, gEncryptionStatus: false, showMessageReadSecurityInfo: false */</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+/* global gFolderDisplay: false, messenger: false, currentAttachments: false, msgWindow: false, PanelUI: false */</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+/* global currentHeaderData: false, gViewAllHeaders: false, gExpandedHeaderList: false, goDoCommand: false, HandleSelectedAttachments: false */</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+/* global statusFeedback: false, displayAttachmentsForExpandedView: false, gMessageListeners: false, gExpandedHeaderView */</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+var EnigmailCompat = ChromeUtils.import(&quot;chrome://openpgp/content/modules/compat.jsm&quot;).EnigmailCompat;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+var EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+var EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+var EnigmailMsgRead = ChromeUtils.import(&quot;chrome://openpgp/content/modules/msgRead.jsm&quot;).EnigmailMsgRead;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+var EnigmailVerify = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mimeVerify.jsm&quot;).EnigmailVerify;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+var EnigmailVerifyAttachment = ChromeUtils.import(&quot;chrome://openpgp/content/modules/verify.jsm&quot;).EnigmailVerifyAttachment;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+var EnigmailFixExchangeMsg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/fixExchangeMsg.jsm&quot;).EnigmailFixExchangeMsg;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+var EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+var EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+var EnigmailOS = ChromeUtils.import(&quot;chrome://openpgp/content/modules/os.jsm&quot;).EnigmailOS;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+var EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+var EnigmailFiles = ChromeUtils.import(&quot;chrome://openpgp/content/modules/files.jsm&quot;).EnigmailFiles;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+var EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+var EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+var EnigmailApp = ChromeUtils.import(&quot;chrome://openpgp/content/modules/app.jsm&quot;).EnigmailApp;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+var EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+var EnigmailTimer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/timer.jsm&quot;).EnigmailTimer;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+var EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+var EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+var EnigmailPersistentCrypto = ChromeUtils.import(&quot;chrome://openpgp/content/modules/persistentCrypto.jsm&quot;).EnigmailPersistentCrypto;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+var EnigmailStreams = ChromeUtils.import(&quot;chrome://openpgp/content/modules/streams.jsm&quot;).EnigmailStreams;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+var EnigmailEvents = ChromeUtils.import(&quot;chrome://openpgp/content/modules/events.jsm&quot;).EnigmailEvents;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+var EnigmailDecryption = ChromeUtils.import(&quot;chrome://openpgp/content/modules/decryption.jsm&quot;).EnigmailDecryption;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+var EnigmailAttachment = ChromeUtils.import(&quot;chrome://openpgp/content/modules/attachment.jsm&quot;).EnigmailAttachment;</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+var EnigmailPassword = ChromeUtils.import(&quot;chrome://openpgp/content/modules/passwords.jsm&quot;).EnigmailPassword;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+var EnigmailKeyUsability = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyUsability.jsm&quot;).EnigmailKeyUsability;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+var EnigmailURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/uris.jsm&quot;).EnigmailURIs;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+var EnigmailProtocolHandler = ChromeUtils.import(&quot;chrome://openpgp/content/modules/protocolHandler.jsm&quot;).EnigmailProtocolHandler;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+var EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+var EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+var EnigmailArmor = ChromeUtils.import(&quot;chrome://openpgp/content/modules/armor.jsm&quot;).EnigmailArmor;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+var EnigmailWks = ChromeUtils.import(&quot;chrome://openpgp/content/modules/webKey.jsm&quot;).EnigmailWks;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+var EnigmailStdlib = ChromeUtils.import(&quot;chrome://openpgp/content/modules/stdlib.jsm&quot;).EnigmailStdlib;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+var EnigmailConfigure = ChromeUtils.import(&quot;chrome://openpgp/content/modules/configure.jsm&quot;).EnigmailConfigure;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+var Services = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;).Services;</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+var Enigmail;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+if (!Enigmail) {</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+  Enigmail = {};</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+}</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+Enigmail.getEnigmailSvc = function() {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+  return EnigmailCore.getService(window);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+};</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+Enigmail.msg = {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  createdURIs: [],</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  decryptedMessage: null,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  securityInfo: null,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  lastSaveDir: &quot;&quot;,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  messagePane: null,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+  noShowReload: false,</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  decryptButton: null,</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+  savedHeaders: null,</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+  removeListener: false,</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+  enableExperiments: false,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+  headersList: [&quot;content-transfer-encoding&quot;,</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+    &quot;x-enigmail-version&quot;, &quot;x-pgp-encoding-format&quot;,</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    &quot;autocrypt-setup-message&quot;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  ],</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  buggyExchangeEmailContent: null, // for HACK for MS-EXCHANGE-Server Problem</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  buggyMailType: null,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  changedAttributes: [],</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  lastSMimeReloadURI: &quot;&quot;,</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  messengerStartup: function() {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    let self = this;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    // private function to overwrite attributes</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    function overrideAttribute(elementIdList, attrName, prefix, suffix) {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+      for (var index = 0; index &lt; elementIdList.length; index++) {</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+        var elementId = elementIdList[index];</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+        var element = document.getElementById(elementId);</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+        if (element) {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+          try {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+            var oldValue = element.getAttribute(attrName);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+            EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: overrideAttribute &quot; + attrName + &quot;: oldValue=&quot; + oldValue + &quot;\n&quot;);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+            var newValue = prefix + elementId + suffix;</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+            element.setAttribute(attrName, newValue);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+            self.changedAttributes.push({</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+              id: elementId,</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+              attrib: attrName,</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+              value: oldValue</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+            });</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+          }</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+          catch (ex) {}</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+        }</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        else {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: *** UNABLE to override id=&quot; + elementId + &quot;\n&quot;);</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+        }</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+      }</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    }</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    let t = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+    if (t) {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+      // TB &gt;= 63</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+      t.addEventListener(&quot;pageshow&quot;, function(e) {</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+        if (e.type === &quot;pageshow&quot; &amp;&amp; e.target.URL === &quot;about:preferences&quot;) {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+          let Overlays = ChromeUtils.import(&quot;chrome://openpgp/content/modules/overlays.jsm&quot;, {}).Overlays;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+          Overlays.loadOverlays(&quot;Enigmail&quot;, e.target.defaultView, [&quot;chrome://openpgp/content/ui/enigmailPrivacyOverlay.xul&quot;]);</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+        }</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+      }, false);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+    }</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+    let customizeToolbar = document.getElementById(&quot;customizeToolbarSheetIFrame&quot;);</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    customizeToolbar.addEventListener(&quot;pageshow&quot;, function(event) {</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+      let Overlays = ChromeUtils.import(&quot;chrome://openpgp/content/modules/overlays.jsm&quot;, {}).Overlays;</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+      Overlays.loadOverlays(&quot;Enigmail&quot;, event.target.defaultView, [&quot;chrome://openpgp/content/ui/enigmailCustToolOverlay.xul&quot;]);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+    }, false);</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+    Enigmail.msg.messagePane = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: Startup\n&quot;);</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+    // Override SMIME ui</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+    overrideAttribute([&quot;cmd_viewSecurityStatus&quot;], &quot;Enigmail.msg.viewSecurityInfo(null, true);&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+    // Override print command</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+    var printElementIds = [&quot;cmd_print&quot;, &quot;cmd_printpreview&quot;, &quot;key_print&quot;, &quot;button-print&quot;,</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+      &quot;mailContext-print&quot;, &quot;mailContext-printpreview&quot;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    ];</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+    overrideAttribute(printElementIds, &quot;oncommand&quot;,</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+      &quot;Enigmail.msg.msgPrint('&quot;, &quot;');&quot;);</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    //Enigmail.msg.overrideLayoutChange();</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+    Enigmail.msg.prepareAppMenu();</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+    Enigmail.msg.setMainMenuLabel();</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+    let statusCol = document.getElementById(&quot;enigmailStatusCol&quot;);</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+    if (statusCol) {</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+      statusCol.setAttribute(&quot;label&quot;, EnigmailLocale.getString(&quot;enigmail.msgViewColumn.label&quot;));</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+    }</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    Enigmail.msg.savedHeaders = null;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    Enigmail.msg.decryptButton = document.getElementById(&quot;button-enigmail-decrypt&quot;);</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+    EnigmailTimer.setTimeout(function _f() {</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+      // if nothing happened, then load all keys after 1 hour</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+      // to trigger the key check</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+      EnigmailKeyRing.getAllKeys();</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+    }, 3600 * 1000); // 1 hour</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    // Need to add event listener to Enigmail.msg.messagePane to make it work</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+    // Adding to msgFrame doesn't seem to work</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+    Enigmail.msg.messagePane.addEventListener(&quot;unload&quot;, Enigmail.msg.messageFrameUnload.bind(Enigmail.msg), true);</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+    this.treeController = {</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+      supportsCommand: function(command) {</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+        // EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: treeCtrl: supportsCommand: &quot;+command+&quot;\n&quot;);</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+        switch (command) {</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+          case &quot;button_enigmail_decrypt&quot;:</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+            return true;</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+        }</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+        return false;</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+      },</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+      isCommandEnabled: function(command) {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+        // EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: treeCtrl: isCommandEnabled: &quot;+command+&quot;\n&quot;);</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+        try {</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+          if (gFolderDisplay.messageDisplay.visible) {</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+            if (gFolderDisplay.selectedCount != 1) {</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+              Enigmail.hdrView.statusBarHide();</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+            }</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+            return (gFolderDisplay.selectedCount == 1);</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+          }</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+          Enigmail.hdrView.statusBarHide();</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+        }</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+        catch (ex) {}</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+        return false;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+      },</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+      doCommand: function(command) {</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+        //EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: treeCtrl: doCommand: &quot;+command+&quot;\n&quot;);</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+        // nothing</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+      },</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+      onEvent: function(event) {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+        // EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: treeCtrl: onEvent: &quot;+command+&quot;\n&quot;);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+        // nothing</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+      }</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+    };</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+    top.controllers.appendController(this.treeController);</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;configuredVersion&quot;) === &quot;&quot;) {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+      EnigmailConfigure.configureEnigmail(window, false);</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+    }</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+    EnigmailMsgRead.ensureExtraAddonHeaders();</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+    gMessageListeners.push(Enigmail.msg.messageListener);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+    Enigmail.msg.messageListener.onEndHeaders();</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+  },</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+  messageListener: {</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+    onStartHeaders: function() {</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+      Enigmail.msg.mimeParts = null;</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+      if (&quot;autocrypt&quot; in gExpandedHeaderView) {</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+        delete gExpandedHeaderView.autocrypt;</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+      }</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+      if (&quot;openpgp&quot; in gExpandedHeaderView) {</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+        delete gExpandedHeaderView.openpgp;</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+      }</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+    },</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+    onEndHeaders: function() {},</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+    onEndAttachments: function() {}</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+  },</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+  viewSecurityInfo: function(event, displaySmimeMsg) {</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: viewSecurityInfo\n&quot;);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+    if (event &amp;&amp; event.button !== 0) {</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+      return;</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+    }</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+    if (gSignatureStatus &gt;= 0 || gEncryptionStatus &gt;= 0) {</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+      showMessageReadSecurityInfo();</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+    }</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+    else {</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+      if (Enigmail.msg.securityInfo) {</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+        this.viewOpenpgpInfo();</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+      }</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+      else {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+        showMessageReadSecurityInfo();</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+      }</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+    }</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+  },</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  viewOpenpgpInfo: function() {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+    if (Enigmail.msg.securityInfo) {</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+      // Thunderbird</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+      EnigmailDialog.info(window, EnigmailLocale.getString(&quot;securityInfo&quot;) + Enigmail.msg.securityInfo.statusInfo);</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+    }</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+  },</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineplus">+  clearLastMessage: function() {</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineplus">+    const {</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+      EnigmailSingletons</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+    } = ChromeUtils.import(&quot;chrome://openpgp/content/modules/singletons.jsm&quot;);</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+    EnigmailSingletons.clearLastDecryptedMessage();</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+  },</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineplus">+  messageReload: function(noShowReload) {</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageReload: &quot; + noShowReload + &quot;\n&quot;);</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+    Enigmail.msg.noShowReload = noShowReload;</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+    this.clearLastMessage();</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+    ReloadMessage();</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+  },</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineplus">+</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  messengerClose: function() {</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messengerClose()\n&quot;);</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineplus">+  },</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineplus">+</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineplus">+  reloadCompleteMsg: function() {</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+    this.clearLastMessage();</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+    gDBView.reloadMessageWithAllParts();</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+  },</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineplus">+</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+  setAttachmentReveal: function(attachmentList) {</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: setAttachmentReveal\n&quot;);</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineplus">+</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineplus">+    var revealBox = document.getElementById(&quot;enigmailRevealAttachments&quot;);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineplus">+    if (revealBox) {</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+      // there are situations when evealBox is not yet present</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+      revealBox.setAttribute(&quot;hidden&quot;, !attachmentList ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineplus">+    }</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineplus">+  },</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineplus">+</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineplus">+</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineplus">+  messageCleanup: function() {</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageCleanup\n&quot;);</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineplus">+</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineplus">+    var enigmailBox = document.getElementById(&quot;enigmailBox&quot;);</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineplus">+</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+    if (enigmailBox &amp;&amp; !enigmailBox.collapsed) {</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+      enigmailBox.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+      var statusText = document.getElementById(&quot;expandedEnigmailStatusText&quot;);</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+      if (statusText) {</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+        statusText.value = &quot;&quot;;</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+      }</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+    }</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+    let exchBox = document.getElementById(&quot;enigmailBrokenExchangeBox&quot;);</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+    if (exchBox) {</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineplus">+      exchBox.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineplus">+    }</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+    this.setAttachmentReveal(null);</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineplus">+    if (Enigmail.msg.createdURIs.length) {</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+      // Cleanup messages belonging to this window (just in case)</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+      var enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineplus">+      if (enigmailSvc) {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: Cleanup: Deleting messages\n&quot;);</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineplus">+        for (var index = 0; index &lt; Enigmail.msg.createdURIs.length; index++) {</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineplus">+          EnigmailURIs.deleteMessageURI(Enigmail.msg.createdURIs[index]);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineplus">+        }</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+        Enigmail.msg.createdURIs = [];</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineplus">+      }</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+    }</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+    Enigmail.msg.decryptedMessage = null;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineplus">+    Enigmail.msg.securityInfo = null;</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineplus">+  },</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineplus">+</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+  messageFrameUnload: function() {</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageFrameUnload\n&quot;);</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+    if (Enigmail.msg.noShowReload) {</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+      Enigmail.msg.noShowReload = false;</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineplus">+    }</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineplus">+    else {</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineplus">+      Enigmail.msg.savedHeaders = null;</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineplus">+</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineplus">+      Enigmail.msg.messageCleanup();</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+    }</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+  },</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineplus">+</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+  getCurrentMsgUriSpec: function() {</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+    try {</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+      // Thunderbird</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+      if (gFolderDisplay.selectedMessages.length != 1) {</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+        return &quot;&quot;;</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+      }</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineplus">+</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineplus">+      var uriSpec = gFolderDisplay.selectedMessageUris[0];</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineplus">+      //EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: getCurrentMsgUriSpec: uriSpec=&quot;+uriSpec+&quot;\n&quot;);</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+      return uriSpec;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineplus">+    }</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineplus">+    catch (ex) {</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineplus">+    }</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineplus">+  },</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineplus">+</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+  getCurrentMsgUrl: function() {</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+    var uriSpec = this.getCurrentMsgUriSpec();</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+    return EnigmailMsgRead.getUrlFromUriSpec(uriSpec);</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+  },</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+  updateOptionsDisplay: function() {</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: updateOptionsDisplay: \n&quot;);</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineplus">+    var optList = [&quot;autoDecrypt&quot;];</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineplus">+    for (let j = 0; j &lt; optList.length; j++) {</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineplus">+      let menuElement = document.getElementById(&quot;enigmail_&quot; + optList[j]);</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineplus">+      menuElement.setAttribute(&quot;checked&quot;, EnigmailPrefs.getPref(optList[j]) ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineplus">+      menuElement = document.getElementById(&quot;enigmail_&quot; + optList[j] + &quot;2&quot;);</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineplus">+      if (menuElement) {</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineplus">+        menuElement.setAttribute(&quot;checked&quot;, EnigmailPrefs.getPref(optList[j]) ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+      }</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineplus">+    }</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+    optList = [&quot;decryptverify&quot;];</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+    for (let j = 0; j &lt; optList.length; j++) {</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineplus">+      let menuElement = document.getElementById(&quot;enigmail_&quot; + optList[j]);</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineplus">+      if (Enigmail.msg.decryptButton &amp;&amp; Enigmail.msg.decryptButton.disabled) {</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+        menuElement.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+      }</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineplus">+      else {</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+        menuElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+      }</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+      menuElement = document.getElementById(&quot;enigmail_&quot; + optList[j] + &quot;2&quot;);</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineplus">+      if (menuElement) {</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineplus">+        if (Enigmail.msg.decryptButton &amp;&amp; Enigmail.msg.decryptButton.disabled) {</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineplus">+          menuElement.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineplus">+        }</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineplus">+        else {</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+          menuElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineplus">+        }</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineplus">+      }</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineplus">+    }</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineplus">+  },</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineplus">+</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+  setMainMenuLabel: function() {</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+    let o = [&quot;menu_Enigmail&quot;, &quot;appmenu-Enigmail&quot;];</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineplus">+    let m0 = document.getElementById(o[0]);</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+    let m1 = document.getElementById(o[1]);</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+    m1.setAttribute(&quot;enigmaillabel&quot;, m0.getAttribute(&quot;enigmaillabel&quot;));</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineplus">+    for (let menuId of o) {</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+      let menu = document.getElementById(menuId);</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+      if (menu) {</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineplus">+        let lbl = menu.getAttribute(&quot;enigmaillabel&quot;);</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+        menu.setAttribute(&quot;label&quot;, lbl);</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineplus">+      }</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+    }</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineplus">+  },</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineplus">+</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineplus">+  prepareAppMenu: function() {</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineplus">+    let menu = document.querySelector(&quot;#appMenu-mainView &gt; vbox&quot;);</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineplus">+    if (!menu) return;</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineplus">+</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+    // don't try to add Enigmail menu more than once</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+    if (document.getElementById(&quot;appmenu-Enigmail&quot;)) return;</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineplus">+    let tsk = document.getElementById(&quot;appmenu_tasksMenu&quot;);</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineplus">+    let e = document.createXULElement(&quot;toolbarbutton&quot;);</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineplus">+    e.setAttribute(&quot;label&quot;, &quot;xxEnigmail&quot;);</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineplus">+    e.id = &quot;appmenu-Enigmail&quot;;</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineplus">+    e.setAttribute(&quot;class&quot;, &quot;subviewbutton subviewbutton-nav subviewbutton-iconic&quot;);</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineplus">+    e.setAttribute(&quot;closemenu&quot;, &quot;none&quot;);</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+    e.setAttribute(&quot;oncommand&quot;, &quot;Enigmail.msg.displayAppmenu('appMenu-enigmailView', this)&quot;);</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineplus">+    e.setAttribute(&quot;overlay_source&quot;, &quot;enigmail&quot;);</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineplus">+    menu.insertBefore(e, tsk);</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+  },</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+  displayAppmenu: function(targetId, targetObj) {</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineplus">+    let menuElem = document.getElementById(&quot;appmenu_enigmailMenuPlaceholder&quot;);</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineplus">+    this.displayMainMenu(menuElem);</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineplus">+    PanelUI.showSubView(targetId, targetObj);</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineplus">+  },</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+  displayMainMenu: function(menuPopup) {</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineplus">+    let obj = menuPopup.firstChild;</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+    while (obj) {</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+      if (obj.getAttribute(&quot;enigmailtype&quot;) == &quot;enigmail&quot; || obj.getAttribute(&quot;advanced&quot;) == &quot;true&quot;) {</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+        obj.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineplus">+      }</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineplus">+</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineplus">+      obj = obj.nextSibling;</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineplus">+    }</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+    EnigmailFuncs.collapseAdvanced(menuPopup, 'hidden', Enigmail.msg.updateOptionsDisplay());</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineplus">+  },</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineplus">+</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineplus">+  toggleAttribute: function(attrName) {</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgessengerOverlay.js: toggleAttribute('&quot; + attrName + &quot;')\n&quot;);</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineplus">+</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineplus">+    var menuElement = document.getElementById(&quot;enigmail_&quot; + attrName);</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+    var oldValue = EnigmailPrefs.getPref(attrName);</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+    EnigmailPrefs.setPref(attrName, !oldValue);</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineplus">+    this.updateOptionsDisplay();</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineplus">+</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+    if (attrName == &quot;autoDecrypt&quot;) {</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineplus">+      this.messageReload(false);</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineplus">+    }</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineplus">+  },</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineplus">+</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineplus">+  /**</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineplus">+   * Determine if Autocrypt is enabled for the currently selected message</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+   */</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineplus">+  isAutocryptEnabled: function() {</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineplus">+    try {</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineplus">+      let email = EnigmailFuncs.stripEmail(gFolderDisplay.selectedMessage.recipients);</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineplus">+      let maybeIdent = EnigmailStdlib.getIdentityForEmail(email);</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+      if (maybeIdent &amp;&amp; maybeIdent.identity) {</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+        if (!maybeIdent.identity.getBoolAttribute(&quot;enablePgp&quot;)) {</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+          return false;</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+        }</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+        let acct = EnigmailFuncs.getAccountForIdentity(maybeIdent.identity);</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+        return acct.incomingServer.getBoolValue(&quot;enableAutocrypt&quot;);</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+      }</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+    }</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+    catch (ex) {}</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+    return false;</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+  },</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineplus">+</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+  messageImport: function() {</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageImport:\n&quot;);</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineplus">+</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+    return this.messageParse(true, true, &quot;&quot;, this.getCurrentMsgUriSpec(), false);</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+  },</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineplus">+  /***</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineplus">+   * check that handler for multipart/signed is set to Enigmail.</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineplus">+   * if handler is different, change it and reload message</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineplus">+   *</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineplus">+   * @return: - true if handler is OK</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+   *          - false if handler was changed and message is reloaded</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+   */</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+  checkPgpmimeHandler: function() {</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+    let uriSpec = this.getCurrentMsgUriSpec();</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+    if (uriSpec !== this.lastSMimeReloadURI) {</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+      if (EnigmailVerify.currentCtHandler !== EnigmailConstants.MIME_HANDLER_PGPMIME) {</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+        this.lastSMimeReloadURI = uriSpec;</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+        EnigmailVerify.registerContentTypeHandler();</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+        this.messageReload();</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+        return false;</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+      }</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+    }</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+    return true;</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineplus">+  },</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineplus">+</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineplus">+  // callback function for automatic decryption</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineplus">+  messageAutoDecrypt: function() {</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageAutoDecrypt:\n&quot;);</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+    Enigmail.msg.messageDecrypt(null, true);</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+  },</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineplus">+  // analyse message header and decrypt/verify message</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+  messageDecrypt: function(event, isAuto) {</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageDecrypt: &quot; + event + &quot;\n&quot;);</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineplus">+</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+    event = event ? true : false;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineplus">+    var cbObj = {</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineplus">+      event: event,</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineplus">+      isAuto: isAuto</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineplus">+    };</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+    this.mimeParts = null;</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineplus">+</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineplus">+    if (!isAuto) {</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineplus">+      EnigmailVerify.setManualUri(this.getCurrentMsgUriSpec());</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineplus">+    }</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineplus">+</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineplus">+    let contentType = &quot;text/plain&quot;;</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineplus">+    if ('content-type' in currentHeaderData) {</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineplus">+      contentType = currentHeaderData['content-type'].headerValue;</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineplus">+    }</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineplus">+</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineplus">+</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineplus">+    // don't parse message if we know it's a PGP/MIME message</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineplus">+    if (contentType.search(/^multipart\/encrypted(;|$)/i) === 0 &amp;&amp; contentType.search(/application\/pgp-encrypted/i) &gt; 0) {</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineplus">+      this.movePEPsubject();</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineplus">+      this.messageDecryptCb(event, isAuto, null);</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineplus">+      return;</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineplus">+    }</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+    else if (contentType.search(/^multipart\/signed(;|$)/i) === 0 &amp;&amp; contentType.search(/application\/pgp-signature/i) &gt; 0) {</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+      this.movePEPsubject();</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineplus">+      this.messageDecryptCb(event, isAuto, null);</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineplus">+      return;</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+    }</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineplus">+</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineplus">+    try {</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineplus">+      EnigmailMime.getMimeTreeFromUrl(this.getCurrentMsgUrl().spec, false,</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineplus">+        function _cb(mimeMsg) {</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+          Enigmail.msg.messageDecryptCb(event, isAuto, mimeMsg);</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineplus">+        });</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineplus">+    }</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineplus">+    catch (ex) {</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageDecrypt: exception: &quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineplus">+      this.messageDecryptCb(event, isAuto, null);</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineplus">+    }</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineplus">+  },</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineplus">+</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineplus">+  /***</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineplus">+   * walk through the (sub-) mime tree and determine PGP/MIME encrypted and signed message parts</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineplus">+   *</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineplus">+   * @param mimePart:  parent object to walk through</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+   * @param resultObj: object containing two arrays. The resultObj must be pre-initialized by the caller</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineplus">+   *                    - encrypted</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineplus">+   *                    - signed</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineplus">+   */</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineplus">+  enumerateMimeParts: function(mimePart, resultObj) {</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enumerateMimeParts: partNum=\&quot;&quot; + mimePart.partNum + &quot;\&quot;\n&quot;);</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineplus">+    EnigmailLog.DEBUG(&quot;                    &quot; + mimePart.fullContentType + &quot;\n&quot;);</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineplus">+    EnigmailLog.DEBUG(&quot;                    &quot; + mimePart.subParts.length + &quot; subparts\n&quot;);</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineplus">+</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineplus">+    try {</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineplus">+      var ct = mimePart.fullContentType;</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineplus">+      if (typeof(ct) == &quot;string&quot;) {</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineplus">+        ct = ct.replace(/[\r\n]/g, &quot; &quot;);</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineplus">+        if (ct.search(/multipart\/signed.*application\/pgp-signature/i) &gt;= 0) {</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineplus">+          resultObj.signed.push(mimePart.partNum);</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineplus">+        }</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineplus">+        else if (ct.search(/application\/pgp-encrypted/i) &gt;= 0) {</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+          resultObj.encrypted.push(mimePart.partNum);</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineplus">+        }</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineplus">+      }</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+    }</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineplus">+    catch (ex) {</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineplus">+      // catch exception if no headers or no content-type defined.</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineplus">+    }</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+    var i;</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineplus">+    for (i in mimePart.subParts) {</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineplus">+      this.enumerateMimeParts(mimePart.subParts[i], resultObj);</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineplus">+    }</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineplus">+  },</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineplus">+</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineplus">+  messageDecryptCb: function(event, isAuto, mimeMsg) {</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageDecryptCb:\n&quot;);</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineplus">+</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineplus">+    this.buggyExchangeEmailContent = null; // reinit HACK for MS-EXCHANGE-Server Problem</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineplus">+</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineplus">+    let enigmailSvc;</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineplus">+    let contentType = &quot;&quot;;</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineplus">+    try {</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineplus">+</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineplus">+      if (!mimeMsg) {</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageDecryptCb: mimeMsg is null\n&quot;);</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineplus">+        try {</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineplus">+          contentType = currentHeaderData['content-type'].headerValue;</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineplus">+        }</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+        catch (ex) {</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+          contentType = &quot;text/plain&quot;;</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineplus">+        }</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineplus">+        mimeMsg = {</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineplus">+          partNum: &quot;1&quot;,</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineplus">+          headers: {</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineplus">+            has: function() {</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineplus">+              return false;</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+            },</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineplus">+            contentType: {</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineplus">+              type: contentType,</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineplus">+              mediatype: &quot;&quot;,</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineplus">+              subtype: &quot;&quot;</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineplus">+            }</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineplus">+          },</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineplus">+          fullContentType: contentType,</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineplus">+          body: &quot;&quot;,</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineplus">+          parent: null,</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineplus">+          subParts: []</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineplus">+        };</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineplus">+      }</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineplus">+</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineplus">+      // Copy selected headers</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineplus">+      Enigmail.msg.savedHeaders = {</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+        autocrypt: []</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineplus">+      };</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineplus">+</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineplus">+      for (let h in currentHeaderData) {</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+        if (h.search(/^autocrypt\d*$/) === 0) {</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+          Enigmail.msg.savedHeaders.autocrypt.push(currentHeaderData[h].headerValue);</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+        }</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+      }</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineplus">+</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineplus">+      if (!mimeMsg.fullContentType) {</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+        mimeMsg.fullContentType = &quot;text/plain&quot;;</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+      }</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineplus">+      Enigmail.msg.savedHeaders[&quot;content-type&quot;] = mimeMsg.fullContentType;</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+      this.mimeParts = mimeMsg;</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineplus">+</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineplus">+      for (var index = 0; index &lt; Enigmail.msg.headersList.length; index++) {</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+        var headerName = Enigmail.msg.headersList[index];</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+        var headerValue = &quot;&quot;;</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineplus">+        if (mimeMsg.headers.has(headerName)) {</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+          let h = mimeMsg.headers.get(headerName);</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineplus">+          if (Array.isArray(h)) {</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineplus">+            headerValue = h.join(&quot;&quot;);</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineplus">+          }</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+          else {</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+            headerValue = h;</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+          }</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineplus">+        }</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+        Enigmail.msg.savedHeaders[headerName] = headerValue;</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: header &quot; + headerName + &quot;: '&quot; + headerValue + &quot;'\n&quot;);</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineplus">+      }</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineplus">+</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineplus">+      if ((&quot;autocrypt&quot; in Enigmail.msg.savedHeaders) &amp;&amp; Enigmail.msg.savedHeaders.autocrypt.length &gt; 0 &amp;&amp;</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineplus">+        (&quot;from&quot; in currentHeaderData)) {</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineplus">+</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineplus">+        let dateValue = &quot;&quot;;</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineplus">+        if (&quot;date&quot; in currentHeaderData) {</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineplus">+          dateValue = currentHeaderData.date.headerValue;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineplus">+        }</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineplus">+</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineplus">+        EnigmailAutocrypt.processAutocryptHeader(currentHeaderData.from.headerValue, Enigmail.msg.savedHeaders.autocrypt,</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineplus">+          dateValue, Enigmail.msg.isAutocryptEnabled());</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineplus">+      }</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineplus">+      else {</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineplus">+        Enigmail.msg.createArtificialAutocryptHeader();</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+      }</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+      var msgSigned = (mimeMsg.fullContentType.search(/^multipart\/signed/i) === 0 &amp;&amp;</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineplus">+        EnigmailMime.getProtocol(mimeMsg.fullContentType).search(/^application\/pgp-signature/i) === 0);</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineplus">+      var msgEncrypted = (mimeMsg.fullContentType.search(/^multipart\/encrypted/i) === 0 &amp;&amp;</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineplus">+        EnigmailMime.getProtocol(mimeMsg.fullContentType).search(/^application\/pgp-encrypted/i) === 0);</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineplus">+      var resultObj = {</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+        encrypted: [],</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+        signed: []</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineplus">+      };</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineplus">+</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineplus">+      if (mimeMsg.subParts.length &gt; 0) {</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+        this.enumerateMimeParts(mimeMsg, resultObj);</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: embedded objects: &quot; + resultObj.encrypted.join(&quot;, &quot;) + &quot; / &quot; + resultObj.signed.join(&quot;, &quot;) + &quot;\n&quot;);</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineplus">+</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineplus">+        msgSigned = msgSigned || resultObj.signed.length &gt; 0;</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineplus">+        msgEncrypted = msgEncrypted || resultObj.encrypted.length &gt; 0;</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineplus">+</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineplus">+        if (&quot;autocrypt-setup-message&quot; in Enigmail.msg.savedHeaders &amp;&amp; Enigmail.msg.savedHeaders[&quot;autocrypt-setup-message&quot;].toLowerCase() === &quot;v1&quot;) {</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineplus">+          if (currentAttachments[0].contentType.search(/^application\/autocrypt-setup$/i) === 0) {</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineplus">+            Enigmail.hdrView.displayAutoCryptSetupMsgHeader();</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineplus">+            return;</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineplus">+          }</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineplus">+        }</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineplus">+        // HACK for Zimbra OpenPGP Zimlet</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+        // Zimbra illegally changes attachment content-type to application/pgp-encrypted which interfers with below</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineplus">+        // see https://sourceforge.net/p/enigmail/bugs/600/</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineplus">+</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineplus">+        try {</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineplus">+</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineplus">+          if (mimeMsg.subParts.length &gt; 1 &amp;&amp;</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineplus">+            mimeMsg.headers.has(&quot;x-mailer&quot;) &amp;&amp; mimeMsg.headers.get(&quot;x-mailer&quot;)[0].indexOf(&quot;ZimbraWebClient&quot;) &gt;= 0 &amp;&amp;</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+            mimeMsg.subParts[0].fullContentType.indexOf(&quot;text/plain&quot;) &gt;= 0 &amp;&amp;</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineplus">+            mimeMsg.fullContentType.indexOf(&quot;multipart/mixed&quot;) &gt;= 0 &amp;&amp;</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+            mimeMsg.subParts[1].fullContentType.indexOf(&quot;application/pgp-encrypted&quot;) &gt;= 0) {</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineplus">+            this.messageParse(event, false, Enigmail.msg.savedHeaders[&quot;content-transfer-encoding&quot;], this.getCurrentMsgUriSpec(), isAuto);</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineplus">+            return;</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineplus">+          }</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+        }</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineplus">+        catch (ex) {}</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineplus">+</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineplus">+        // HACK for MS-EXCHANGE-Server Problem:</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineplus">+        // check for possible bad mime structure due to buggy exchange server:</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineplus">+        // - multipart/mixed Container with</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineplus">+        //   - application/pgp-encrypted Attachment with name &quot;PGPMIME Versions Identification&quot;</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineplus">+        //   - application/octet-stream Attachment with name &quot;encrypted.asc&quot; having the encrypted content in base64</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineplus">+        // - see:</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineplus">+        //   - http://www.mozilla-enigmail.org/forum/viewtopic.php?f=4&amp;t=425</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineplus">+        //   - http://sourceforge.net/p/enigmail/forum/support/thread/4add2b69/</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineplus">+</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineplus">+        // iPGMail produces a similar broken structure, see here:</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineplus">+        //   - https://sourceforge.net/p/enigmail/forum/support/thread/afc9c246/#5de7</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineplus">+</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineplus">+        if (mimeMsg.subParts.length == 3 &amp;&amp;</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineplus">+          mimeMsg.fullContentType.search(/multipart\/mixed/i) &gt;= 0 &amp;&amp;</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineplus">+          mimeMsg.subParts[0].fullContentType.search(/multipart\/encrypted/i) &lt; 0 &amp;&amp;</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineplus">+          mimeMsg.subParts[0].fullContentType.search(/text\/(plain|html)/i) &gt;= 0 &amp;&amp;</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineplus">+          mimeMsg.subParts[1].fullContentType.search(/application\/pgp-encrypted/i) &gt;= 0) {</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineplus">+          if (mimeMsg.subParts[1].fullContentType.search(/multipart\/encrypted/i) &lt; 0 &amp;&amp;</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineplus">+            mimeMsg.subParts[1].fullContentType.search(/PGP\/?MIME Versions? Identification/i) &gt;= 0 &amp;&amp;</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineplus">+            mimeMsg.subParts[2].fullContentType.search(/application\/octet-stream/i) &gt;= 0 &amp;&amp;</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineplus">+            mimeMsg.subParts[2].fullContentType.search(/encrypted.asc/i) &gt;= 0) {</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineplus">+            this.buggyMailType = &quot;exchange&quot;;</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineplus">+          }</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineplus">+          else {</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineplus">+            this.buggyMailType = &quot;iPGMail&quot;;</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineplus">+          }</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineplus">+</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineplus">+          // signal that the structure matches to save the content later on</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay: messageDecryptCb: enabling MS-Exchange hack\n&quot;);</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineplus">+          this.buggyExchangeEmailContent = &quot;???&quot;;</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineplus">+</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineplus">+          this.buggyMailHeader();</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineplus">+          return;</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineplus">+        }</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineplus">+      }</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineplus">+</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineplus">+      var contentEncoding = &quot;&quot;;</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineplus">+      var xEnigmailVersion = &quot;&quot;;</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineplus">+      var msgUriSpec = this.getCurrentMsgUriSpec();</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineplus">+</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineplus">+      if (Enigmail.msg.savedHeaders) {</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineplus">+        contentType = Enigmail.msg.savedHeaders[&quot;content-type&quot;];</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineplus">+        contentEncoding = Enigmail.msg.savedHeaders[&quot;content-transfer-encoding&quot;];</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineplus">+        xEnigmailVersion = Enigmail.msg.savedHeaders[&quot;x-enigmail-version&quot;];</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineplus">+      }</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineplus">+      let smime = (contentType.search(/multipart\/signed; protocol=&quot;application\/pkcs7-signature/i) &gt;= 0);</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineplus">+      if (!smime &amp;&amp; (msgSigned || msgEncrypted)) {</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineplus">+        // PGP/MIME messages</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineplus">+        enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineplus">+        if (!enigmailSvc) {</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineplus">+          return;</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineplus">+        }</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineplus">+</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineplus">+        if (!Enigmail.msg.checkPgpmimeHandler()) {</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineplus">+          return;</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineplus">+        }</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineplus">+</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineplus">+        if (isAuto &amp;&amp; (!EnigmailPrefs.getPref(&quot;autoDecrypt&quot;))) {</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineplus">+</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineplus">+          if (EnigmailVerify.getManualUri() != this.getCurrentMsgUriSpec()) {</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineplus">+            // decryption set to manual</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineplus">+            Enigmail.hdrView.updateHdrIcons(EnigmailConstants.POSSIBLE_PGPMIME, 0, // exitCode, statusFlags</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineplus">+              &quot;&quot;, &quot;&quot;, // keyId, userId</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineplus">+              &quot;&quot;, // sigDetails</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineplus">+              EnigmailLocale.getString(&quot;possiblyPgpMime&quot;), // infoMsg</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineplus">+              null, // blockSeparation</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineplus">+              &quot;&quot;, // encToDetails</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineplus">+              null); // xtraStatus</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineplus">+          }</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineplus">+        }</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineplus">+        else if (!isAuto) {</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineplus">+          Enigmail.msg.messageReload(false);</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineplus">+        }</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineplus">+        return;</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineplus">+      }</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineplus">+</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineplus">+      // inline-PGP messages</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineplus">+      if (!isAuto || EnigmailPrefs.getPref(&quot;autoDecrypt&quot;)) {</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineplus">+        this.messageParse(event, false, contentEncoding, msgUriSpec, isAuto);</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineplus">+      }</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineplus">+    }</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineplus">+    catch (ex) {</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineplus">+      EnigmailLog.writeException(&quot;enigmailMessengerOverlay.js: messageDecryptCb&quot;, ex);</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineplus">+    }</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineplus">+  },</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineplus">+</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineplus">+  // display header about reparing buggy MS-Exchange messages</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineplus">+  buggyMailHeader: function() {</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+    let uriStr = EnigmailURIs.createMessageURI(this.getCurrentMsgUrl(),</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineplus">+      &quot;message/rfc822&quot;,</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineplus">+      &quot;??&quot;,</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineplus">+      false);</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineplus">+</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineplus">+    let ph = new EnigmailProtocolHandler();</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineplus">+    let uri = ph.newURI(uriStr, &quot;&quot;, &quot;&quot;);</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineplus">+    Enigmail.hdrView.headerPane.updateSecurityStatus(&quot;&quot;, 0, 0, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, uri, &quot;&quot;, &quot;1&quot;);</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineplus">+  },</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineplus">+</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineplus">+  messageParse: function(interactive, importOnly, contentEncoding, msgUriSpec, isAuto, pbMessageIndex = '0') {</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParse: &quot; + interactive + &quot;\n&quot;);</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineplus">+</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineplus">+    var bodyElement = this.getBodyElement(pbMessageIndex);</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: bodyElement=&quot; + bodyElement + &quot;\n&quot;);</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineplus">+</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineplus">+    if (!bodyElement) {</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineplus">+      return;</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineplus">+    }</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineplus">+</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineplus">+    let topElement = bodyElement;</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineplus">+    var findStr = /* interactive ? null : */ &quot;-----BEGIN PGP&quot;;</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineplus">+    var msgText = null;</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineplus">+    var foundIndex = -1;</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineplus">+</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineplus">+    if (bodyElement.firstChild) {</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineplus">+      let node = bodyElement.firstChild;</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineplus">+      while (node) {</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineplus">+        if (node.firstChild &amp;&amp;</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineplus">+          node.firstChild.nodeName == &quot;LEGEND&quot; &amp;&amp;</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineplus">+          node.firstChild.className == &quot;mimeAttachmentHeaderName&quot;) {</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineplus">+          // we reached the area where inline attachments are displayed</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineplus">+          // --&gt; don't try to decrypt displayed inline attachments</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineplus">+          break;</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineplus">+        }</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineplus">+        if (node.firstChild &amp;&amp;</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineplus">+          node.firstChild.nodeName.toUpperCase() == &quot;LEGEND&quot; &amp;&amp;</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineplus">+          node.firstChild.className == &quot;mimeAttachmentHeaderName&quot;) {</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineplus">+          // we reached the area where inline attachments are displayed</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineplus">+          // --&gt; don't try to decrypt displayed inline attachments</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineplus">+          break;</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineplus">+        }</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineplus">+        if (node.nodeName === &quot;DIV&quot;) {</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineplus">+          foundIndex = node.textContent.indexOf(findStr);</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineplus">+</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineplus">+          if (foundIndex &gt;= 0) {</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineplus">+            if (node.textContent.indexOf(findStr + &quot; LICENSE AUTHORIZATION&quot;) == foundIndex) {</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineplus">+              foundIndex = -1;</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineplus">+            }</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineplus">+          }</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineplus">+</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineplus">+          if (foundIndex === 0) {</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineplus">+            bodyElement = node;</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineplus">+            break;</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineplus">+          }</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineplus">+          if (foundIndex &gt; 0 &amp;&amp; node.textContent.substr(foundIndex - 1, 1).search(/[\r\n]/) === 0) {</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineplus">+            bodyElement = node;</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineplus">+            break;</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineplus">+          }</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineplus">+        }</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineplus">+        node = node.nextSibling;</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineplus">+      }</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineplus">+    }</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineplus">+</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineplus">+    if (foundIndex &gt;= 0 &amp;&amp; (!this.hasInlineQuote(topElement))) {</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineplus">+      if (Enigmail.msg.savedHeaders[&quot;content-type&quot;].search(/^text\/html/i) === 0) {</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineplus">+        let p = Cc[&quot;@mozilla.org/parserutils;1&quot;].createInstance(Ci.nsIParserUtils);</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineplus">+        const de = Ci.nsIDocumentEncoder;</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineplus">+        msgText = p.convertToPlainText(topElement.innerHTML, de.OutputRaw | de.OutputBodyOnly, 0);</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineplus">+      }</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineplus">+      else {</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineplus">+        msgText = bodyElement.textContent;</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineplus">+      }</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineplus">+      msgText = EnigmailMsgRead.trimAllLines(msgText);</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineplus">+    }</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineplus">+</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineplus">+    if (!msgText) {</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineplus">+      // No PGP content</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineplus">+</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineplus">+      // but this might be caused by the HACK for MS-EXCHANGE-Server Problem</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineplus">+      // - so return only if:</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineplus">+      if (!this.buggyExchangeEmailContent || this.buggyExchangeEmailContent == &quot;???&quot;) {</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineplus">+        return;</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineplus">+      }</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineplus">+</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParse: got buggyExchangeEmailContent = &quot; + this.buggyExchangeEmailContent.substr(0, 50) + &quot;\n&quot;);</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineplus">+</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineplus">+      // fix the whole invalid email by replacing the contents by the decoded text</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineplus">+      // as plain inline format</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineplus">+      if (this.displayBuggyExchangeMail()) {</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineplus">+        return;</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineplus">+      }</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineplus">+      else {</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineplus">+        msgText = this.buggyExchangeEmailContent;</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineplus">+      }</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineplus">+</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineplus">+      msgText = msgText.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineplus">+      msgText = msgText.replace(/\r/g, &quot;\n&quot;);</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineplus">+</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineplus">+      // content is in encrypted.asc part:</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineplus">+      let idx = msgText.search(/Content-Type: application\/octet-stream; name=&quot;encrypted.asc&quot;/i);</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineplus">+      if (idx &gt;= 0) {</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineplus">+        msgText = msgText.slice(idx);</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineplus">+      }</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineplus">+      // check whether we have base64 encoding</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineplus">+      var isBase64 = false;</span>
<a href="#l1.934"></a><span id="l1.934" class="difflineplus">+      idx = msgText.search(/Content-Transfer-Encoding: base64/i);</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineplus">+      if (idx &gt;= 0) {</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineplus">+        isBase64 = true;</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineplus">+      }</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineplus">+      // find content behind part header</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineplus">+      idx = msgText.search(/\n\n/);</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineplus">+      if (idx &gt;= 0) {</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineplus">+        msgText = msgText.slice(idx);</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineplus">+      }</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineplus">+      // remove stuff behind content block (usually a final boundary row)</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineplus">+      idx = msgText.search(/\n\n--/);</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineplus">+      if (idx &gt;= 0) {</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineplus">+        msgText = msgText.slice(0, idx + 1);</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineplus">+      }</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineplus">+      // decode base64 if it is encoded that way</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineplus">+      if (isBase64) {</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineplus">+        try {</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineplus">+          msgText = EnigmailData.decodeBase64(msgText);</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineplus">+        }</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineplus">+        catch (ex) {</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineplus">+          EnigmailLog.writeException(&quot;enigmailMessengerOverlay.js: decodeBase64() &quot;, ex);</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineplus">+        }</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineplus">+        //EnigmailLog.DEBUG(&quot;nach base64 decode: \n&quot; + msgText + &quot;\n&quot;);</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineplus">+      }</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineplus">+    }</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineplus">+</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineplus">+    var charset = msgWindow ? msgWindow.mailCharacterSet : &quot;&quot;;</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineplus">+</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineplus">+    // Encode ciphertext to charset from unicode</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineplus">+    msgText = EnigmailData.convertFromUnicode(msgText, charset);</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineplus">+</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineplus">+    if (isAuto) {</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineplus">+      let ht = this.determineHeadAndTail(msgText);</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineplus">+      if (ht) {</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineplus">+        Enigmail.hdrView.updateHdrIcons(0, ht, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, null, &quot;&quot;, &quot;process-manually&quot;);</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineplus">+        return;</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineplus">+      }</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineplus">+    }</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineplus">+    var mozPlainText = bodyElement.innerHTML.search(/class=&quot;moz-text-plain&quot;/);</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineplus">+</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineplus">+    if ((mozPlainText &gt;= 0) &amp;&amp; (mozPlainText &lt; 40)) {</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineplus">+      // workaround for too much expanded emoticons in plaintext msg</span>
<a href="#l1.976"></a><span id="l1.976" class="difflineplus">+      var r = new RegExp(/( )(;-\)|:-\)|;\)|:\)|:-\(|:\(|:-\\|:-P|:-D|:-\[|:-\*|&gt;:o|8-\)|:-\$|:-X|=-O|:-!|O:-\)|:'\()( )/g);</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineplus">+      if (msgText.search(r) &gt;= 0) {</span>
<a href="#l1.978"></a><span id="l1.978" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParse: performing emoticons fixing\n&quot;);</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineplus">+        msgText = msgText.replace(r, &quot;$2&quot;);</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineplus">+      }</span>
<a href="#l1.981"></a><span id="l1.981" class="difflineplus">+    }</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineplus">+</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineplus">+    // extract text following armored block</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineplus">+    var head = &quot;&quot;;</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineplus">+    var tail = &quot;&quot;;</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineplus">+    if (findStr) {</span>
<a href="#l1.987"></a><span id="l1.987" class="difflineplus">+      var endStart = msgText.indexOf(&quot;-----END PGP&quot;);</span>
<a href="#l1.988"></a><span id="l1.988" class="difflineplus">+      var nextLine = msgText.substring(endStart).search(/[\n\r]/);</span>
<a href="#l1.989"></a><span id="l1.989" class="difflineplus">+      if (nextLine &gt; 0) {</span>
<a href="#l1.990"></a><span id="l1.990" class="difflineplus">+        tail = msgText.substring(endStart + nextLine).replace(/^[\n\r\s]*/, &quot;&quot;);</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineplus">+      }</span>
<a href="#l1.992"></a><span id="l1.992" class="difflineplus">+    }</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineplus">+</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineplus">+    //EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: msgText='&quot;+msgText+&quot;'\n&quot;);</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineplus">+</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineplus">+    var mailNewsUrl = EnigmailMsgRead.getUrlFromUriSpec(msgUriSpec);</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineplus">+</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineplus">+    var urlSpec = mailNewsUrl ? mailNewsUrl.spec : &quot;&quot;;</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineplus">+</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineplus">+    let retry = (charset != &quot;UTF-8&quot; ? 1 : 2);</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineplus">+</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineplus">+    Enigmail.msg.messageParseCallback(msgText, contentEncoding, charset, interactive,</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineplus">+      importOnly, urlSpec, &quot;&quot;, retry, head, tail,</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineplus">+      msgUriSpec, isAuto, pbMessageIndex);</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineplus">+  },</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineplus">+</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineplus">+  hasInlineQuote: function(node) {</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineplus">+    if (node.innerHTML.search(/&lt;blockquote.*-----BEGIN PGP /i) &lt; 0) {</span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineplus">+      return false;</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineplus">+    }</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineplus">+</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineplus">+    return EnigmailMsgRead.searchQuotedPgp(node);</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineplus">+  },</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineplus">+</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineplus">+  determineHeadAndTail: function(msgText) {</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineplus">+    let startIndex = msgText.search(/-----BEGIN PGP (SIGNED )?MESSAGE-----/m);</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineplus">+    let endIndex = msgText.indexOf(&quot;-----END PGP&quot;);</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineplus">+    let hasHead = false;</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineplus">+    let hasTail = false;</span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineplus">+    let crypto = 0;</span>
<a href="#l1.1021"></a><span id="l1.1021" class="difflineplus">+</span>
<a href="#l1.1022"></a><span id="l1.1022" class="difflineplus">+    if (startIndex &gt; 0) {</span>
<a href="#l1.1023"></a><span id="l1.1023" class="difflineplus">+      let pgpMsg = msgText.match(/(-----BEGIN PGP (SIGNED )?MESSAGE-----)/m)[0];</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineplus">+      if (pgpMsg.search(/SIGNED/) &gt; 0) {</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineplus">+        crypto = EnigmailConstants.UNVERIFIED_SIGNATURE;</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineplus">+      }</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineplus">+      else {</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineplus">+        crypto = EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineplus">+      }</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineplus">+      let startSection = msgText.substr(0, startIndex - 1);</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineplus">+      hasHead = (startSection.search(/\S/) &gt;= 0);</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineplus">+    }</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineplus">+</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineplus">+    if (endIndex &gt; startIndex) {</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineplus">+      let nextLine = msgText.substring(endIndex).search(/[\n\r]/);</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineplus">+      if (nextLine &gt; 0) {</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineplus">+        hasTail = (msgText.substring(endIndex + nextLine).search(/\S/) &gt;= 0);</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineplus">+      }</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineplus">+    }</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineplus">+</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineplus">+    if (hasHead || hasTail) {</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineplus">+      return EnigmailConstants.PARTIALLY_PGP | crypto;</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineplus">+    }</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineplus">+</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineplus">+    return 0;</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineplus">+  },</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineplus">+</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineplus">+  getBodyElement: function(pbMessageIndex = '0') {</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+    let bodyElement = null;</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineplus">+</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineplus">+    // Thunderbird</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineplus">+    let msgFrame = EnigmailWindows.getFrame(window, &quot;messagepane&quot;);</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineplus">+    if (msgFrame) {</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineplus">+      // TB &lt; 69</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineplus">+      bodyElement = msgFrame.document.getElementsByTagName(&quot;body&quot;)[0];</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineplus">+    }</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineplus">+    else {</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineplus">+      // TB &gt;= 69</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineplus">+      msgFrame = document.getElementById('messagepane');</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineplus">+      bodyElement = msgFrame.contentDocument.getElementsByTagName(&quot;body&quot;)[0];</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineplus">+    }</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineplus">+    return bodyElement;</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineplus">+  },</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineplus">+</span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineplus">+</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineplus">+  messageParseCallback: function(msgText, contentEncoding, charset, interactive,</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineplus">+    importOnly, messageUrl, signature, retry, head, tail, msgUriSpec, isAuto,</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineplus">+    pbMessageIndex) {</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParseCallback: &quot; + interactive + &quot;, &quot; + interactive + &quot;, importOnly=&quot; + importOnly + &quot;, charset=&quot; + charset + &quot;, msgUrl=&quot; +</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineplus">+      messageUrl +</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineplus">+      &quot;, retry=&quot; + retry + &quot;, signature='&quot; + signature + &quot;'\n&quot;);</span>
<a href="#l1.1072"></a><span id="l1.1072" class="difflineplus">+</span>
<a href="#l1.1073"></a><span id="l1.1073" class="difflineplus">+    if (!msgText) {</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineplus">+      return;</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineplus">+    }</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineplus">+</span>
<a href="#l1.1077"></a><span id="l1.1077" class="difflineplus">+    var enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.1078"></a><span id="l1.1078" class="difflineplus">+    if (!enigmailSvc) {</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineplus">+      return;</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineplus">+    }</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineplus">+</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineplus">+    var plainText;</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineplus">+    var exitCode;</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineplus">+    var newSignature = &quot;&quot;;</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineplus">+    var statusFlags = 0;</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineplus">+</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineplus">+    var errorMsgObj = {</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineplus">+      value: &quot;&quot;</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineplus">+    };</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineplus">+    var keyIdObj = {};</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineplus">+    var userIdObj = {};</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineplus">+    var sigDetailsObj = {};</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineplus">+    var encToDetailsObj = {};</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineplus">+</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineplus">+    var blockSeparationObj = {</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineplus">+      value: &quot;&quot;</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineplus">+    };</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineplus">+</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineplus">+    if (importOnly) {</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineplus">+      // Import public key</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineplus">+      this.importKeyFromMsgBody(msgText);</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineplus">+      return;</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineplus">+    }</span>
<a href="#l1.1104"></a><span id="l1.1104" class="difflineplus">+    else {</span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineplus">+</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineplus">+      let armorHeaders = EnigmailArmor.getArmorHeaders(msgText);</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineplus">+      if (&quot;charset&quot; in armorHeaders) {</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineplus">+        charset = armorHeaders.charset;</span>
<a href="#l1.1109"></a><span id="l1.1109" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParseCallback: OVERRIDING charset=&quot; + charset + &quot;\n&quot;);</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineplus">+      }</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineplus">+</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineplus">+      var exitCodeObj = {};</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineplus">+      var statusFlagsObj = {};</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineplus">+      var signatureObj = {};</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineplus">+      signatureObj.value = signature;</span>
<a href="#l1.1116"></a><span id="l1.1116" class="difflineplus">+</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineplus">+      var uiFlags = interactive ? (EnigmailConstants.UI_INTERACTIVE |</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineplus">+        EnigmailConstants.UI_ALLOW_KEY_IMPORT |</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineplus">+        EnigmailConstants.UI_UNVERIFIED_ENC_OK) : 0;</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineplus">+</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineplus">+      plainText = EnigmailDecryption.decryptMessage(window, uiFlags, msgText,</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineplus">+        signatureObj, exitCodeObj, statusFlagsObj,</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineplus">+        keyIdObj, userIdObj, sigDetailsObj,</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineplus">+        errorMsgObj, blockSeparationObj, encToDetailsObj);</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineplus">+</span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineplus">+      //EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParseCallback: plainText='&quot;+plainText+&quot;'\n&quot;);</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineplus">+</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineplus">+      exitCode = exitCodeObj.value;</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineplus">+      newSignature = signatureObj.value;</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineplus">+</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineplus">+      if (plainText === &quot;&quot; &amp;&amp; exitCode === 0) {</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineplus">+        plainText = &quot; &quot;;</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineplus">+      }</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineplus">+</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineplus">+      statusFlags = statusFlagsObj.value;</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineplus">+</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: messageParseCallback: newSignature='&quot; + newSignature + &quot;'\n&quot;);</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineplus">+    }</span>
<a href="#l1.1139"></a><span id="l1.1139" class="difflineplus">+</span>
<a href="#l1.1140"></a><span id="l1.1140" class="difflineplus">+    var errorMsg = errorMsgObj.value;</span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineplus">+</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineplus">+    if (importOnly) {</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineplus">+      if (interactive &amp;&amp; errorMsg) {</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineplus">+        EnigmailDialog.alert(window, errorMsg);</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineplus">+      }</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineplus">+      return;</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineplus">+    }</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineplus">+</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineplus">+    var displayedUriSpec = Enigmail.msg.getCurrentMsgUriSpec();</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineplus">+    if (!msgUriSpec || (displayedUriSpec == msgUriSpec)) {</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineplus">+      if (tail.length &gt; 0) {</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineplus">+        statusFlags |= EnigmailConstants.PARTIALLY_PGP;</span>
<a href="#l1.1153"></a><span id="l1.1153" class="difflineplus">+      }</span>
<a href="#l1.1154"></a><span id="l1.1154" class="difflineplus">+      Enigmail.hdrView.updateHdrIcons(exitCode, statusFlags, keyIdObj.value, userIdObj.value,</span>
<a href="#l1.1155"></a><span id="l1.1155" class="difflineplus">+        sigDetailsObj.value,</span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineplus">+        errorMsg,</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineplus">+        null, // blockSeparation</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineplus">+        encToDetailsObj.value,</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineplus">+        null); // xtraStatus</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineplus">+    }</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineplus">+</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineplus">+    var noSecondTry = EnigmailConstants.GOOD_SIGNATURE |</span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineplus">+      EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineplus">+      EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineplus">+      EnigmailConstants.EXPIRED_KEY |</span>
<a href="#l1.1166"></a><span id="l1.1166" class="difflineplus">+      EnigmailConstants.REVOKED_KEY |</span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineplus">+      EnigmailConstants.NO_PUBKEY |</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineplus">+      EnigmailConstants.NO_SECKEY |</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineplus">+      EnigmailConstants.IMPORTED_KEY |</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineplus">+      EnigmailConstants.MISSING_PASSPHRASE |</span>
<a href="#l1.1171"></a><span id="l1.1171" class="difflineplus">+      EnigmailConstants.BAD_PASSPHRASE |</span>
<a href="#l1.1172"></a><span id="l1.1172" class="difflineplus">+      EnigmailConstants.UNKNOWN_ALGO |</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineplus">+      EnigmailConstants.DECRYPTION_OKAY |</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineplus">+      EnigmailConstants.OVERFLOWED;</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineplus">+</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineplus">+    if ((exitCode !== 0) &amp;&amp; (!(statusFlags &amp; noSecondTry))) {</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineplus">+      // Bad signature/armor</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineplus">+      if (retry == 1) {</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineplus">+        msgText = EnigmailData.convertFromUnicode(msgText, &quot;UTF-8&quot;);</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineplus">+        Enigmail.msg.messageParseCallback(msgText, contentEncoding, charset,</span>
<a href="#l1.1181"></a><span id="l1.1181" class="difflineplus">+          interactive, importOnly, messageUrl,</span>
<a href="#l1.1182"></a><span id="l1.1182" class="difflineplus">+          signature, retry + 1,</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineplus">+          head, tail, msgUriSpec, isAuto, pbMessageIndex);</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineplus">+        return;</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineplus">+      }</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineplus">+      else if (retry == 2) {</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineplus">+        // Try to verify signature by accessing raw message text directly</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineplus">+        // (avoid recursion by setting retry parameter to false on callback)</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineplus">+        newSignature = &quot;&quot;;</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineplus">+        Enigmail.msg.msgDirectDecrypt(interactive, importOnly, contentEncoding, charset,</span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineplus">+          newSignature, 0, head, tail, msgUriSpec,</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineplus">+          Enigmail.msg.messageParseCallback, isAuto);</span>
<a href="#l1.1193"></a><span id="l1.1193" class="difflineplus">+        return;</span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineplus">+      }</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineplus">+      else if (retry == 3) {</span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineplus">+        msgText = EnigmailData.convertToUnicode(msgText, &quot;UTF-8&quot;);</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineplus">+        Enigmail.msg.messageParseCallback(msgText, contentEncoding, charset, interactive,</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineplus">+          importOnly, messageUrl, null, retry + 1,</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineplus">+          head, tail, msgUriSpec, isAuto, pbMessageIndex);</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineplus">+        return;</span>
<a href="#l1.1201"></a><span id="l1.1201" class="difflineplus">+      }</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineplus">+    }</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineplus">+</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineplus">+    if (!plainText) {</span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineplus">+      if (interactive &amp;&amp; Enigmail.msg.securityInfo &amp;&amp; Enigmail.msg.securityInfo.statusInfo) {</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineplus">+        EnigmailDialog.info(window, Enigmail.msg.securityInfo.statusInfo);</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineplus">+      }</span>
<a href="#l1.1208"></a><span id="l1.1208" class="difflineplus">+      return;</span>
<a href="#l1.1209"></a><span id="l1.1209" class="difflineplus">+    }</span>
<a href="#l1.1210"></a><span id="l1.1210" class="difflineplus">+</span>
<a href="#l1.1211"></a><span id="l1.1211" class="difflineplus">+    if (retry &gt;= 2) {</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineplus">+      plainText = EnigmailData.convertFromUnicode(EnigmailData.convertToUnicode(plainText, &quot;UTF-8&quot;), charset);</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineplus">+    }</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineplus">+</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineplus">+    if (blockSeparationObj.value.indexOf(&quot; &quot;) &gt;= 0) {</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineplus">+      var blocks = blockSeparationObj.value.split(/ /);</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineplus">+      var blockInfo = blocks[0].split(/:/);</span>
<a href="#l1.1218"></a><span id="l1.1218" class="difflineplus">+      plainText = EnigmailData.convertFromUnicode(EnigmailLocale.getString(&quot;notePartEncrypted&quot;), charset) +</span>
<a href="#l1.1219"></a><span id="l1.1219" class="difflineplus">+        &quot;\n\n&quot; + plainText.substr(0, blockInfo[1]) + &quot;\n\n&quot; + EnigmailLocale.getString(&quot;noteCutMessage&quot;);</span>
<a href="#l1.1220"></a><span id="l1.1220" class="difflineplus">+    }</span>
<a href="#l1.1221"></a><span id="l1.1221" class="difflineplus">+</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineplus">+    // Save decrypted message status, headers, and content</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineplus">+    var headerList = {</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineplus">+      &quot;subject&quot;: &quot;&quot;,</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineplus">+      &quot;from&quot;: &quot;&quot;,</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineplus">+      &quot;date&quot;: &quot;&quot;,</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineplus">+      &quot;to&quot;: &quot;&quot;,</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineplus">+      &quot;cc&quot;: &quot;&quot;</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineplus">+    };</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineplus">+</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineplus">+    var index,</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineplus">+      headerName;</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineplus">+</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineplus">+    if (!gViewAllHeaders) {</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineplus">+      for (index = 0; index &lt; headerList.length; index++) {</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineplus">+        headerList[index] = &quot;&quot;;</span>
<a href="#l1.1237"></a><span id="l1.1237" class="difflineplus">+      }</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineplus">+</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineplus">+    }</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineplus">+    else {</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineplus">+      for (index = 0; index &lt; gExpandedHeaderList.length; index++) {</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineplus">+        headerList[gExpandedHeaderList[index].name] = &quot;&quot;;</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineplus">+      }</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineplus">+</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineplus">+      for (headerName in currentHeaderData) {</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineplus">+        headerList[headerName] = &quot;&quot;;</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineplus">+      }</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineplus">+    }</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineplus">+</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineplus">+    for (headerName in headerList) {</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineplus">+      if (currentHeaderData[headerName]) {</span>
<a href="#l1.1252"></a><span id="l1.1252" class="difflineplus">+        headerList[headerName] = currentHeaderData[headerName].headerValue;</span>
<a href="#l1.1253"></a><span id="l1.1253" class="difflineplus">+      }</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineplus">+    }</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineplus">+</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineplus">+    // WORKAROUND</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineplus">+    if (headerList.cc == headerList.to) {</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineplus">+      headerList.cc = &quot;&quot;;</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineplus">+    }</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineplus">+</span>
<a href="#l1.1261"></a><span id="l1.1261" class="difflineplus">+    var hasAttachments = currentAttachments &amp;&amp; currentAttachments.length;</span>
<a href="#l1.1262"></a><span id="l1.1262" class="difflineplus">+    var attachmentsEncrypted = true;</span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineplus">+</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineplus">+    for (index in currentAttachments) {</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineplus">+      if (!Enigmail.msg.checkEncryptedAttach(currentAttachments[index])) {</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineplus">+        if (!EnigmailMsgRead.checkSignedAttachment(currentAttachments, index, currentAttachments)) {</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineplus">+          attachmentsEncrypted = false;</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineplus">+        }</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineplus">+      }</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineplus">+    }</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineplus">+</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineplus">+    var msgRfc822Text = &quot;&quot;;</span>
<a href="#l1.1273"></a><span id="l1.1273" class="difflineplus">+    if (tail) {</span>
<a href="#l1.1274"></a><span id="l1.1274" class="difflineplus">+      msgRfc822Text += EnigmailData.convertFromUnicode(EnigmailLocale.getString(&quot;beginPgpPart&quot;), charset) + &quot;\n\n&quot;;</span>
<a href="#l1.1275"></a><span id="l1.1275" class="difflineplus">+    }</span>
<a href="#l1.1276"></a><span id="l1.1276" class="difflineplus">+    msgRfc822Text += plainText;</span>
<a href="#l1.1277"></a><span id="l1.1277" class="difflineplus">+    if (tail) {</span>
<a href="#l1.1278"></a><span id="l1.1278" class="difflineplus">+      msgRfc822Text += &quot;\n\n&quot; + EnigmailData.convertFromUnicode(EnigmailLocale.getString(&quot;endPgpPart&quot;), charset) + &quot;\n\n&quot; + tail;</span>
<a href="#l1.1279"></a><span id="l1.1279" class="difflineplus">+    }</span>
<a href="#l1.1280"></a><span id="l1.1280" class="difflineplus">+</span>
<a href="#l1.1281"></a><span id="l1.1281" class="difflineplus">+    Enigmail.msg.decryptedMessage = {</span>
<a href="#l1.1282"></a><span id="l1.1282" class="difflineplus">+      url: messageUrl,</span>
<a href="#l1.1283"></a><span id="l1.1283" class="difflineplus">+      uri: msgUriSpec,</span>
<a href="#l1.1284"></a><span id="l1.1284" class="difflineplus">+      headerList: headerList,</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineplus">+      hasAttachments: hasAttachments,</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineplus">+      attachmentsEncrypted: attachmentsEncrypted,</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineplus">+      charset: charset,</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineplus">+      plainText: msgRfc822Text</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineplus">+    };</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineplus">+</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineplus">+    // don't display decrypted message if message selection has changed</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineplus">+    displayedUriSpec = Enigmail.msg.getCurrentMsgUriSpec();</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineplus">+    if (msgUriSpec &amp;&amp; displayedUriSpec &amp;&amp; (displayedUriSpec != msgUriSpec)) {</span>
<a href="#l1.1294"></a><span id="l1.1294" class="difflineplus">+      return;</span>
<a href="#l1.1295"></a><span id="l1.1295" class="difflineplus">+    }</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineplus">+</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineplus">+</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineplus">+    // Create and load one-time message URI</span>
<a href="#l1.1299"></a><span id="l1.1299" class="difflineplus">+    var messageContent = Enigmail.msg.getDecryptedMessage(&quot;message/rfc822&quot;, false);</span>
<a href="#l1.1300"></a><span id="l1.1300" class="difflineplus">+</span>
<a href="#l1.1301"></a><span id="l1.1301" class="difflineplus">+    Enigmail.msg.noShowReload = true;</span>
<a href="#l1.1302"></a><span id="l1.1302" class="difflineplus">+    var node;</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineplus">+    var bodyElement = Enigmail.msg.getBodyElement(pbMessageIndex);</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineplus">+</span>
<a href="#l1.1305"></a><span id="l1.1305" class="difflineplus">+    if (bodyElement.firstChild) {</span>
<a href="#l1.1306"></a><span id="l1.1306" class="difflineplus">+      node = bodyElement.firstChild;</span>
<a href="#l1.1307"></a><span id="l1.1307" class="difflineplus">+</span>
<a href="#l1.1308"></a><span id="l1.1308" class="difflineplus">+      while (node) {</span>
<a href="#l1.1309"></a><span id="l1.1309" class="difflineplus">+        if (node.nodeName == &quot;DIV&quot;) {</span>
<a href="#l1.1310"></a><span id="l1.1310" class="difflineplus">+          // for safety reasons, we replace the complete visible message with</span>
<a href="#l1.1311"></a><span id="l1.1311" class="difflineplus">+          // the decrypted or signed part (bug 983)</span>
<a href="#l1.1312"></a><span id="l1.1312" class="difflineplus">+          node.innerHTML = EnigmailFuncs.formatPlaintextMsg(EnigmailData.convertToUnicode(messageContent, charset));</span>
<a href="#l1.1313"></a><span id="l1.1313" class="difflineplus">+          Enigmail.msg.movePEPsubject();</span>
<a href="#l1.1314"></a><span id="l1.1314" class="difflineplus">+          return;</span>
<a href="#l1.1315"></a><span id="l1.1315" class="difflineplus">+        }</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineplus">+        node = node.nextSibling;</span>
<a href="#l1.1317"></a><span id="l1.1317" class="difflineplus">+      }</span>
<a href="#l1.1318"></a><span id="l1.1318" class="difflineplus">+</span>
<a href="#l1.1319"></a><span id="l1.1319" class="difflineplus">+      // if no &lt;DIV&gt; node is found, try with &lt;PRE&gt; (bug 24762)</span>
<a href="#l1.1320"></a><span id="l1.1320" class="difflineplus">+      node = bodyElement.firstChild;</span>
<a href="#l1.1321"></a><span id="l1.1321" class="difflineplus">+      while (node) {</span>
<a href="#l1.1322"></a><span id="l1.1322" class="difflineplus">+        if (node.nodeName == &quot;PRE&quot;) {</span>
<a href="#l1.1323"></a><span id="l1.1323" class="difflineplus">+          node.innerHTML = EnigmailFuncs.formatPlaintextMsg(EnigmailData.convertToUnicode(messageContent, charset));</span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineplus">+          Enigmail.msg.movePEPsubject();</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineplus">+          return;</span>
<a href="#l1.1326"></a><span id="l1.1326" class="difflineplus">+        }</span>
<a href="#l1.1327"></a><span id="l1.1327" class="difflineplus">+        node = node.nextSibling;</span>
<a href="#l1.1328"></a><span id="l1.1328" class="difflineplus">+      }</span>
<a href="#l1.1329"></a><span id="l1.1329" class="difflineplus">+</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineplus">+      // HACK for MS-EXCHANGE-Server Problem:</span>
<a href="#l1.1331"></a><span id="l1.1331" class="difflineplus">+      // - remove empty text/plain part</span>
<a href="#l1.1332"></a><span id="l1.1332" class="difflineplus">+      //   and set message content as inner text</span>
<a href="#l1.1333"></a><span id="l1.1333" class="difflineplus">+      // - missing:</span>
<a href="#l1.1334"></a><span id="l1.1334" class="difflineplus">+      //   - signal in statusFlags so that we warn in Enigmail.hdrView.updateHdrIcons()</span>
<a href="#l1.1335"></a><span id="l1.1335" class="difflineplus">+      if (this.buggyExchangeEmailContent) {</span>
<a href="#l1.1336"></a><span id="l1.1336" class="difflineplus">+        if (this.displayBuggyExchangeMail()) {</span>
<a href="#l1.1337"></a><span id="l1.1337" class="difflineplus">+          return;</span>
<a href="#l1.1338"></a><span id="l1.1338" class="difflineplus">+        }</span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineplus">+</span>
<a href="#l1.1340"></a><span id="l1.1340" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay: messageParseCallback: got broken MS-Exchange mime message\n&quot;);</span>
<a href="#l1.1341"></a><span id="l1.1341" class="difflineplus">+        messageContent = messageContent.replace(/^\s{0,2}Content-Transfer-Encoding: quoted-printable\s*Content-Type: text\/plain;\s*charset=windows-1252/i, &quot;&quot;);</span>
<a href="#l1.1342"></a><span id="l1.1342" class="difflineplus">+        node = bodyElement.firstChild;</span>
<a href="#l1.1343"></a><span id="l1.1343" class="difflineplus">+        while (node) {</span>
<a href="#l1.1344"></a><span id="l1.1344" class="difflineplus">+          if (node.nodeName == &quot;DIV&quot;) {</span>
<a href="#l1.1345"></a><span id="l1.1345" class="difflineplus">+            node.innerHTML = EnigmailFuncs.formatPlaintextMsg(EnigmailData.convertToUnicode(messageContent, charset));</span>
<a href="#l1.1346"></a><span id="l1.1346" class="difflineplus">+            Enigmail.hdrView.updateHdrIcons(exitCode, statusFlags, keyIdObj.value, userIdObj.value,</span>
<a href="#l1.1347"></a><span id="l1.1347" class="difflineplus">+              sigDetailsObj.value,</span>
<a href="#l1.1348"></a><span id="l1.1348" class="difflineplus">+              errorMsg,</span>
<a href="#l1.1349"></a><span id="l1.1349" class="difflineplus">+              null, // blockSeparation</span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineplus">+              encToDetailsObj.value,</span>
<a href="#l1.1351"></a><span id="l1.1351" class="difflineplus">+              &quot;buggyMailFormat&quot;);</span>
<a href="#l1.1352"></a><span id="l1.1352" class="difflineplus">+            return;</span>
<a href="#l1.1353"></a><span id="l1.1353" class="difflineplus">+          }</span>
<a href="#l1.1354"></a><span id="l1.1354" class="difflineplus">+          node = node.nextSibling;</span>
<a href="#l1.1355"></a><span id="l1.1355" class="difflineplus">+        }</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineplus">+      }</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineplus">+</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineplus">+    }</span>
<a href="#l1.1359"></a><span id="l1.1359" class="difflineplus">+</span>
<a href="#l1.1360"></a><span id="l1.1360" class="difflineplus">+    EnigmailLog.ERROR(&quot;enigmailMessengerOverlay.js: no node found to replace message display\n&quot;);</span>
<a href="#l1.1361"></a><span id="l1.1361" class="difflineplus">+</span>
<a href="#l1.1362"></a><span id="l1.1362" class="difflineplus">+    return;</span>
<a href="#l1.1363"></a><span id="l1.1363" class="difflineplus">+  },</span>
<a href="#l1.1364"></a><span id="l1.1364" class="difflineplus">+</span>
<a href="#l1.1365"></a><span id="l1.1365" class="difflineplus">+  importKeyFromMsgBody: function(msgData) {</span>
<a href="#l1.1366"></a><span id="l1.1366" class="difflineplus">+    let beginIndexObj = {};</span>
<a href="#l1.1367"></a><span id="l1.1367" class="difflineplus">+    let endIndexObj = {};</span>
<a href="#l1.1368"></a><span id="l1.1368" class="difflineplus">+    let indentStrObj = {};</span>
<a href="#l1.1369"></a><span id="l1.1369" class="difflineplus">+    let blockType = EnigmailArmor.locateArmoredBlock(msgData, 0, &quot;&quot;, beginIndexObj, endIndexObj, indentStrObj);</span>
<a href="#l1.1370"></a><span id="l1.1370" class="difflineplus">+    if (!blockType || blockType !== &quot;PUBLIC KEY BLOCK&quot;) {</span>
<a href="#l1.1371"></a><span id="l1.1371" class="difflineplus">+      return;</span>
<a href="#l1.1372"></a><span id="l1.1372" class="difflineplus">+    }</span>
<a href="#l1.1373"></a><span id="l1.1373" class="difflineplus">+</span>
<a href="#l1.1374"></a><span id="l1.1374" class="difflineplus">+    let keyData = msgData.substring(beginIndexObj.value, endIndexObj.value);</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineplus">+</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineplus">+    let errorMsgObj = {};</span>
<a href="#l1.1377"></a><span id="l1.1377" class="difflineplus">+    let preview = EnigmailKey.getKeyListFromKeyBlock(keyData, errorMsgObj);</span>
<a href="#l1.1378"></a><span id="l1.1378" class="difflineplus">+    if (errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineplus">+      this.importKeyDataWithConfirmation(preview, keyData);</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineplus">+    }</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineplus">+    else {</span>
<a href="#l1.1382"></a><span id="l1.1382" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;previewFailed&quot;) + &quot;\n&quot; + errorMsgObj.value);</span>
<a href="#l1.1383"></a><span id="l1.1383" class="difflineplus">+    }</span>
<a href="#l1.1384"></a><span id="l1.1384" class="difflineplus">+  },</span>
<a href="#l1.1385"></a><span id="l1.1385" class="difflineplus">+</span>
<a href="#l1.1386"></a><span id="l1.1386" class="difflineplus">+  importKeyDataWithConfirmation: function(preview, keyData) {</span>
<a href="#l1.1387"></a><span id="l1.1387" class="difflineplus">+    let exitStatus = -1,</span>
<a href="#l1.1388"></a><span id="l1.1388" class="difflineplus">+      errorMsgObj = {};</span>
<a href="#l1.1389"></a><span id="l1.1389" class="difflineplus">+    if (preview.length &gt; 0) {</span>
<a href="#l1.1390"></a><span id="l1.1390" class="difflineplus">+      if (preview.length == 1) {</span>
<a href="#l1.1391"></a><span id="l1.1391" class="difflineplus">+        exitStatus = EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;doImportOne&quot;, [preview[0].name, preview[0].id]));</span>
<a href="#l1.1392"></a><span id="l1.1392" class="difflineplus">+      }</span>
<a href="#l1.1393"></a><span id="l1.1393" class="difflineplus">+      else {</span>
<a href="#l1.1394"></a><span id="l1.1394" class="difflineplus">+        exitStatus = EnigmailDialog.confirmDlg(window,</span>
<a href="#l1.1395"></a><span id="l1.1395" class="difflineplus">+          EnigmailLocale.getString(&quot;doImportMultiple&quot;, [</span>
<a href="#l1.1396"></a><span id="l1.1396" class="difflineplus">+            preview.map(function(a) {</span>
<a href="#l1.1397"></a><span id="l1.1397" class="difflineplus">+              return &quot;\t&quot; + a.name + &quot; (&quot; + a.id + &quot;)&quot;;</span>
<a href="#l1.1398"></a><span id="l1.1398" class="difflineplus">+            }).join(&quot;\n&quot;)</span>
<a href="#l1.1399"></a><span id="l1.1399" class="difflineplus">+          ]));</span>
<a href="#l1.1400"></a><span id="l1.1400" class="difflineplus">+      }</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineplus">+</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineplus">+      if (exitStatus) {</span>
<a href="#l1.1403"></a><span id="l1.1403" class="difflineplus">+        try {</span>
<a href="#l1.1404"></a><span id="l1.1404" class="difflineplus">+          exitStatus = EnigmailKeyRing.importKey(window, false, keyData, &quot;&quot;, errorMsgObj);</span>
<a href="#l1.1405"></a><span id="l1.1405" class="difflineplus">+        }</span>
<a href="#l1.1406"></a><span id="l1.1406" class="difflineplus">+        catch (ex) {}</span>
<a href="#l1.1407"></a><span id="l1.1407" class="difflineplus">+</span>
<a href="#l1.1408"></a><span id="l1.1408" class="difflineplus">+        if (exitStatus === 0) {</span>
<a href="#l1.1409"></a><span id="l1.1409" class="difflineplus">+          var keyList = preview.map(function(a) {</span>
<a href="#l1.1410"></a><span id="l1.1410" class="difflineplus">+            return a.id;</span>
<a href="#l1.1411"></a><span id="l1.1411" class="difflineplus">+          });</span>
<a href="#l1.1412"></a><span id="l1.1412" class="difflineplus">+          EnigmailDialog.keyImportDlg(window, keyList);</span>
<a href="#l1.1413"></a><span id="l1.1413" class="difflineplus">+        }</span>
<a href="#l1.1414"></a><span id="l1.1414" class="difflineplus">+        else {</span>
<a href="#l1.1415"></a><span id="l1.1415" class="difflineplus">+          EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;failKeyImport&quot;) + &quot;\n&quot; + errorMsgObj.value);</span>
<a href="#l1.1416"></a><span id="l1.1416" class="difflineplus">+        }</span>
<a href="#l1.1417"></a><span id="l1.1417" class="difflineplus">+      }</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineplus">+    }</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineplus">+    else {</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;noKeyFound&quot;));</span>
<a href="#l1.1421"></a><span id="l1.1421" class="difflineplus">+    }</span>
<a href="#l1.1422"></a><span id="l1.1422" class="difflineplus">+  },</span>
<a href="#l1.1423"></a><span id="l1.1423" class="difflineplus">+</span>
<a href="#l1.1424"></a><span id="l1.1424" class="difflineplus">+  /**</span>
<a href="#l1.1425"></a><span id="l1.1425" class="difflineplus">+   * Extract the subject from the 1st content line and move it to the subject line</span>
<a href="#l1.1426"></a><span id="l1.1426" class="difflineplus">+   */</span>
<a href="#l1.1427"></a><span id="l1.1427" class="difflineplus">+  movePEPsubject: function() {</span>
<a href="#l1.1428"></a><span id="l1.1428" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: movePEPsubject:\n&quot;);</span>
<a href="#l1.1429"></a><span id="l1.1429" class="difflineplus">+</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineplus">+    let bodyElement = this.getBodyElement();</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineplus">+</span>
<a href="#l1.1432"></a><span id="l1.1432" class="difflineplus">+    if (bodyElement.textContent.search(/^\r?\n?Subject: [^\r\n]+\r?\n\r?\n/i) === 0 &amp;&amp;</span>
<a href="#l1.1433"></a><span id="l1.1433" class="difflineplus">+      (&quot;subject&quot; in currentHeaderData) &amp;&amp;</span>
<a href="#l1.1434"></a><span id="l1.1434" class="difflineplus">+      currentHeaderData.subject.headerValue === &quot;pEp&quot;) {</span>
<a href="#l1.1435"></a><span id="l1.1435" class="difflineplus">+</span>
<a href="#l1.1436"></a><span id="l1.1436" class="difflineplus">+      if (gFolderDisplay.selectedMessage) {</span>
<a href="#l1.1437"></a><span id="l1.1437" class="difflineplus">+        let m = EnigmailMime.extractSubjectFromBody(bodyElement.textContent);</span>
<a href="#l1.1438"></a><span id="l1.1438" class="difflineplus">+        if (m) {</span>
<a href="#l1.1439"></a><span id="l1.1439" class="difflineplus">+          let node = bodyElement.firstChild;</span>
<a href="#l1.1440"></a><span id="l1.1440" class="difflineplus">+          let found = false;</span>
<a href="#l1.1441"></a><span id="l1.1441" class="difflineplus">+</span>
<a href="#l1.1442"></a><span id="l1.1442" class="difflineplus">+          while ((!found) &amp;&amp; node) {</span>
<a href="#l1.1443"></a><span id="l1.1443" class="difflineplus">+            if (node.nodeName == &quot;DIV&quot;) {</span>
<a href="#l1.1444"></a><span id="l1.1444" class="difflineplus">+              node.innerHTML = EnigmailFuncs.formatPlaintextMsg(m.messageBody);</span>
<a href="#l1.1445"></a><span id="l1.1445" class="difflineplus">+              found = true;</span>
<a href="#l1.1446"></a><span id="l1.1446" class="difflineplus">+            }</span>
<a href="#l1.1447"></a><span id="l1.1447" class="difflineplus">+            node = node.nextSibling;</span>
<a href="#l1.1448"></a><span id="l1.1448" class="difflineplus">+          }</span>
<a href="#l1.1449"></a><span id="l1.1449" class="difflineplus">+</span>
<a href="#l1.1450"></a><span id="l1.1450" class="difflineplus">+          // if no &lt;DIV&gt; node is found, try with &lt;PRE&gt; (bug 24762)</span>
<a href="#l1.1451"></a><span id="l1.1451" class="difflineplus">+          node = bodyElement.firstChild;</span>
<a href="#l1.1452"></a><span id="l1.1452" class="difflineplus">+          while ((!found) &amp;&amp; node) {</span>
<a href="#l1.1453"></a><span id="l1.1453" class="difflineplus">+            if (node.nodeName == &quot;PRE&quot;) {</span>
<a href="#l1.1454"></a><span id="l1.1454" class="difflineplus">+              node.innerHTML = EnigmailFuncs.formatPlaintextMsg(m.messageBody);</span>
<a href="#l1.1455"></a><span id="l1.1455" class="difflineplus">+              found = true;</span>
<a href="#l1.1456"></a><span id="l1.1456" class="difflineplus">+            }</span>
<a href="#l1.1457"></a><span id="l1.1457" class="difflineplus">+            node = node.nextSibling;</span>
<a href="#l1.1458"></a><span id="l1.1458" class="difflineplus">+          }</span>
<a href="#l1.1459"></a><span id="l1.1459" class="difflineplus">+</span>
<a href="#l1.1460"></a><span id="l1.1460" class="difflineplus">+          Enigmail.hdrView.setSubject(m.subject);</span>
<a href="#l1.1461"></a><span id="l1.1461" class="difflineplus">+        }</span>
<a href="#l1.1462"></a><span id="l1.1462" class="difflineplus">+      }</span>
<a href="#l1.1463"></a><span id="l1.1463" class="difflineplus">+    }</span>
<a href="#l1.1464"></a><span id="l1.1464" class="difflineplus">+  },</span>
<a href="#l1.1465"></a><span id="l1.1465" class="difflineplus">+</span>
<a href="#l1.1466"></a><span id="l1.1466" class="difflineplus">+  /**</span>
<a href="#l1.1467"></a><span id="l1.1467" class="difflineplus">+   * Fix broken PGP/MIME messages from MS-Exchange by replacing the broken original</span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineplus">+   * message with a fixed copy.</span>
<a href="#l1.1469"></a><span id="l1.1469" class="difflineplus">+   *</span>
<a href="#l1.1470"></a><span id="l1.1470" class="difflineplus">+   * no return</span>
<a href="#l1.1471"></a><span id="l1.1471" class="difflineplus">+   */</span>
<a href="#l1.1472"></a><span id="l1.1472" class="difflineplus">+  fixBuggyExchangeMail: function() {</span>
<a href="#l1.1473"></a><span id="l1.1473" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: fixBuggyExchangeMail:\n&quot;);</span>
<a href="#l1.1474"></a><span id="l1.1474" class="difflineplus">+</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineplus">+    function hideAndResetExchangePane() {</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineplus">+      document.getElementById(&quot;enigmailBrokenExchangeBox&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineplus">+      document.getElementById(&quot;enigmailFixBrokenMessageProgress&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l1.1478"></a><span id="l1.1478" class="difflineplus">+      document.getElementById(&quot;enigmailFixBrokenMessageButton&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l1.1479"></a><span id="l1.1479" class="difflineplus">+    }</span>
<a href="#l1.1480"></a><span id="l1.1480" class="difflineplus">+</span>
<a href="#l1.1481"></a><span id="l1.1481" class="difflineplus">+    document.getElementById(&quot;enigmailFixBrokenMessageButton&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineplus">+    document.getElementById(&quot;enigmailFixBrokenMessageProgress&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineplus">+</span>
<a href="#l1.1484"></a><span id="l1.1484" class="difflineplus">+    let msg = gFolderDisplay.messageDisplay.displayedMessage;</span>
<a href="#l1.1485"></a><span id="l1.1485" class="difflineplus">+</span>
<a href="#l1.1486"></a><span id="l1.1486" class="difflineplus">+    let p = EnigmailFixExchangeMsg.fixExchangeMessage(msg, this.buggyMailType);</span>
<a href="#l1.1487"></a><span id="l1.1487" class="difflineplus">+    p.then(</span>
<a href="#l1.1488"></a><span id="l1.1488" class="difflineplus">+      function _success(msgKey) {</span>
<a href="#l1.1489"></a><span id="l1.1489" class="difflineplus">+        // display message with given msgKey</span>
<a href="#l1.1490"></a><span id="l1.1490" class="difflineplus">+</span>
<a href="#l1.1491"></a><span id="l1.1491" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: fixBuggyExchangeMail: _success: msgKey=&quot; + msgKey + &quot;\n&quot;);</span>
<a href="#l1.1492"></a><span id="l1.1492" class="difflineplus">+</span>
<a href="#l1.1493"></a><span id="l1.1493" class="difflineplus">+        if (msgKey) {</span>
<a href="#l1.1494"></a><span id="l1.1494" class="difflineplus">+          let index = gFolderDisplay.view.dbView.findIndexFromKey(msgKey, true);</span>
<a href="#l1.1495"></a><span id="l1.1495" class="difflineplus">+          EnigmailLog.DEBUG(&quot;  ** index = &quot; + index + &quot;\n&quot;);</span>
<a href="#l1.1496"></a><span id="l1.1496" class="difflineplus">+</span>
<a href="#l1.1497"></a><span id="l1.1497" class="difflineplus">+          EnigmailTimer.setTimeout(function() {</span>
<a href="#l1.1498"></a><span id="l1.1498" class="difflineplus">+            gFolderDisplay.view.dbView.selectMsgByKey(msgKey);</span>
<a href="#l1.1499"></a><span id="l1.1499" class="difflineplus">+          }, 750);</span>
<a href="#l1.1500"></a><span id="l1.1500" class="difflineplus">+        }</span>
<a href="#l1.1501"></a><span id="l1.1501" class="difflineplus">+</span>
<a href="#l1.1502"></a><span id="l1.1502" class="difflineplus">+        hideAndResetExchangePane();</span>
<a href="#l1.1503"></a><span id="l1.1503" class="difflineplus">+      }</span>
<a href="#l1.1504"></a><span id="l1.1504" class="difflineplus">+    );</span>
<a href="#l1.1505"></a><span id="l1.1505" class="difflineplus">+    p.catch(function _rejected() {</span>
<a href="#l1.1506"></a><span id="l1.1506" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;fixBrokenExchangeMsg.failed&quot;));</span>
<a href="#l1.1507"></a><span id="l1.1507" class="difflineplus">+      hideAndResetExchangePane();</span>
<a href="#l1.1508"></a><span id="l1.1508" class="difflineplus">+    });</span>
<a href="#l1.1509"></a><span id="l1.1509" class="difflineplus">+  },</span>
<a href="#l1.1510"></a><span id="l1.1510" class="difflineplus">+</span>
<a href="#l1.1511"></a><span id="l1.1511" class="difflineplus">+  /**</span>
<a href="#l1.1512"></a><span id="l1.1512" class="difflineplus">+   * Hide attachments containing OpenPGP keys</span>
<a href="#l1.1513"></a><span id="l1.1513" class="difflineplus">+   */</span>
<a href="#l1.1514"></a><span id="l1.1514" class="difflineplus">+  hidePgpKeys: function() {</span>
<a href="#l1.1515"></a><span id="l1.1515" class="difflineplus">+    let keys = [];</span>
<a href="#l1.1516"></a><span id="l1.1516" class="difflineplus">+    for (let i = 0; i &lt; currentAttachments.length; i++) {</span>
<a href="#l1.1517"></a><span id="l1.1517" class="difflineplus">+      if (currentAttachments[i].contentType.search(/^application\/pgp-keys/i) === 0) {</span>
<a href="#l1.1518"></a><span id="l1.1518" class="difflineplus">+        keys.push(i);</span>
<a href="#l1.1519"></a><span id="l1.1519" class="difflineplus">+      }</span>
<a href="#l1.1520"></a><span id="l1.1520" class="difflineplus">+    }</span>
<a href="#l1.1521"></a><span id="l1.1521" class="difflineplus">+</span>
<a href="#l1.1522"></a><span id="l1.1522" class="difflineplus">+    if (keys.length &gt; 0) {</span>
<a href="#l1.1523"></a><span id="l1.1523" class="difflineplus">+      let attachmentList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l1.1524"></a><span id="l1.1524" class="difflineplus">+</span>
<a href="#l1.1525"></a><span id="l1.1525" class="difflineplus">+      for (let i = keys.length; i &gt; 0; i--) {</span>
<a href="#l1.1526"></a><span id="l1.1526" class="difflineplus">+        currentAttachments.splice(keys[i - 1], 1);</span>
<a href="#l1.1527"></a><span id="l1.1527" class="difflineplus">+      }</span>
<a href="#l1.1528"></a><span id="l1.1528" class="difflineplus">+</span>
<a href="#l1.1529"></a><span id="l1.1529" class="difflineplus">+      if (attachmentList) {</span>
<a href="#l1.1530"></a><span id="l1.1530" class="difflineplus">+        // delete all keys from attachment list</span>
<a href="#l1.1531"></a><span id="l1.1531" class="difflineplus">+        while (attachmentList.firstChild) {</span>
<a href="#l1.1532"></a><span id="l1.1532" class="difflineplus">+          attachmentList.removeChild(attachmentList.firstChild);</span>
<a href="#l1.1533"></a><span id="l1.1533" class="difflineplus">+        }</span>
<a href="#l1.1534"></a><span id="l1.1534" class="difflineplus">+</span>
<a href="#l1.1535"></a><span id="l1.1535" class="difflineplus">+        // build new attachment list</span>
<a href="#l1.1536"></a><span id="l1.1536" class="difflineplus">+</span>
<a href="#l1.1537"></a><span id="l1.1537" class="difflineplus">+        /* global gBuildAttachmentsForCurrentMsg: true */</span>
<a href="#l1.1538"></a><span id="l1.1538" class="difflineplus">+        let orig = gBuildAttachmentsForCurrentMsg;</span>
<a href="#l1.1539"></a><span id="l1.1539" class="difflineplus">+        gBuildAttachmentsForCurrentMsg = false;</span>
<a href="#l1.1540"></a><span id="l1.1540" class="difflineplus">+        displayAttachmentsForExpandedView();</span>
<a href="#l1.1541"></a><span id="l1.1541" class="difflineplus">+        gBuildAttachmentsForCurrentMsg = orig;</span>
<a href="#l1.1542"></a><span id="l1.1542" class="difflineplus">+      }</span>
<a href="#l1.1543"></a><span id="l1.1543" class="difflineplus">+    }</span>
<a href="#l1.1544"></a><span id="l1.1544" class="difflineplus">+</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineplus">+  },</span>
<a href="#l1.1546"></a><span id="l1.1546" class="difflineplus">+</span>
<a href="#l1.1547"></a><span id="l1.1547" class="difflineplus">+  /**</span>
<a href="#l1.1548"></a><span id="l1.1548" class="difflineplus">+   * Attempt to work around bug with headers of MS-Exchange message.</span>
<a href="#l1.1549"></a><span id="l1.1549" class="difflineplus">+   * Reload message content</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineplus">+   *</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineplus">+   * @return: true:  message displayed</span>
<a href="#l1.1552"></a><span id="l1.1552" class="difflineplus">+   *          false: could not handle message</span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineplus">+   */</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineplus">+  displayBuggyExchangeMail: function() {</span>
<a href="#l1.1555"></a><span id="l1.1555" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: displayBuggyExchangeMail\n&quot;);</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineplus">+    let hdrs = Cc[&quot;@mozilla.org/messenger/mimeheaders;1&quot;].createInstance(Ci.nsIMimeHeaders);</span>
<a href="#l1.1557"></a><span id="l1.1557" class="difflineplus">+    hdrs.initialize(this.buggyExchangeEmailContent);</span>
<a href="#l1.1558"></a><span id="l1.1558" class="difflineplus">+    let ct = hdrs.extractHeader(&quot;content-type&quot;, true);</span>
<a href="#l1.1559"></a><span id="l1.1559" class="difflineplus">+</span>
<a href="#l1.1560"></a><span id="l1.1560" class="difflineplus">+    if (ct &amp;&amp; ct.search(/^text\/plain/i) === 0) {</span>
<a href="#l1.1561"></a><span id="l1.1561" class="difflineplus">+      let bi = this.buggyExchangeEmailContent.search(/\r?\n/);</span>
<a href="#l1.1562"></a><span id="l1.1562" class="difflineplus">+      let boundary = this.buggyExchangeEmailContent.substr(2, bi - 2);</span>
<a href="#l1.1563"></a><span id="l1.1563" class="difflineplus">+      let startMsg = this.buggyExchangeEmailContent.search(/\r?\n\r?\n/);</span>
<a href="#l1.1564"></a><span id="l1.1564" class="difflineplus">+      let msgText;</span>
<a href="#l1.1565"></a><span id="l1.1565" class="difflineplus">+</span>
<a href="#l1.1566"></a><span id="l1.1566" class="difflineplus">+      if (this.buggyMailType == &quot;exchange&quot;) {</span>
<a href="#l1.1567"></a><span id="l1.1567" class="difflineplus">+        msgText = 'Content-Type: multipart/encrypted; protocol=&quot;application/pgp-encrypted&quot;; boundary=&quot;' + boundary + '&quot;\r\n' +</span>
<a href="#l1.1568"></a><span id="l1.1568" class="difflineplus">+          this.buggyExchangeEmailContent.substr(startMsg);</span>
<a href="#l1.1569"></a><span id="l1.1569" class="difflineplus">+      }</span>
<a href="#l1.1570"></a><span id="l1.1570" class="difflineplus">+      else {</span>
<a href="#l1.1571"></a><span id="l1.1571" class="difflineplus">+        msgText = 'Content-Type: multipart/encrypted; protocol=&quot;application/pgp-encrypted&quot;; boundary=&quot;' + boundary + '&quot;\r\n' +</span>
<a href="#l1.1572"></a><span id="l1.1572" class="difflineplus">+          &quot;\r\n&quot; + boundary + &quot;\r\n&quot; +</span>
<a href="#l1.1573"></a><span id="l1.1573" class="difflineplus">+          &quot;Content-Type: application/pgp-encrypted\r\n&quot; +</span>
<a href="#l1.1574"></a><span id="l1.1574" class="difflineplus">+          &quot;Content-Description: PGP/MIME version identification\r\n\r\n&quot; +</span>
<a href="#l1.1575"></a><span id="l1.1575" class="difflineplus">+          &quot;Version: 1\r\n\r\n&quot; +</span>
<a href="#l1.1576"></a><span id="l1.1576" class="difflineplus">+          this.buggyExchangeEmailContent.substr(startMsg).replace(/^Content-Type: +application\/pgp-encrypted/im,</span>
<a href="#l1.1577"></a><span id="l1.1577" class="difflineplus">+            &quot;Content-Type: application/octet-stream&quot;);</span>
<a href="#l1.1578"></a><span id="l1.1578" class="difflineplus">+</span>
<a href="#l1.1579"></a><span id="l1.1579" class="difflineplus">+      }</span>
<a href="#l1.1580"></a><span id="l1.1580" class="difflineplus">+</span>
<a href="#l1.1581"></a><span id="l1.1581" class="difflineplus">+      let enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.1582"></a><span id="l1.1582" class="difflineplus">+      if (!enigmailSvc) {</span>
<a href="#l1.1583"></a><span id="l1.1583" class="difflineplus">+        return false;</span>
<a href="#l1.1584"></a><span id="l1.1584" class="difflineplus">+      }</span>
<a href="#l1.1585"></a><span id="l1.1585" class="difflineplus">+</span>
<a href="#l1.1586"></a><span id="l1.1586" class="difflineplus">+      let uri = EnigmailURIs.createMessageURI(this.getCurrentMsgUrl(),</span>
<a href="#l1.1587"></a><span id="l1.1587" class="difflineplus">+        &quot;message/rfc822&quot;,</span>
<a href="#l1.1588"></a><span id="l1.1588" class="difflineplus">+        &quot;&quot;,</span>
<a href="#l1.1589"></a><span id="l1.1589" class="difflineplus">+        msgText,</span>
<a href="#l1.1590"></a><span id="l1.1590" class="difflineplus">+        false);</span>
<a href="#l1.1591"></a><span id="l1.1591" class="difflineplus">+</span>
<a href="#l1.1592"></a><span id="l1.1592" class="difflineplus">+      EnigmailVerify.setMsgWindow(msgWindow, null);</span>
<a href="#l1.1593"></a><span id="l1.1593" class="difflineplus">+      messenger.loadURL(window, uri);</span>
<a href="#l1.1594"></a><span id="l1.1594" class="difflineplus">+</span>
<a href="#l1.1595"></a><span id="l1.1595" class="difflineplus">+      // Thunderbird</span>
<a href="#l1.1596"></a><span id="l1.1596" class="difflineplus">+      let atv = document.getElementById(&quot;attachmentView&quot;);</span>
<a href="#l1.1597"></a><span id="l1.1597" class="difflineplus">+      if (atv) {</span>
<a href="#l1.1598"></a><span id="l1.1598" class="difflineplus">+        atv.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l1.1599"></a><span id="l1.1599" class="difflineplus">+      }</span>
<a href="#l1.1600"></a><span id="l1.1600" class="difflineplus">+</span>
<a href="#l1.1601"></a><span id="l1.1601" class="difflineplus">+      return true;</span>
<a href="#l1.1602"></a><span id="l1.1602" class="difflineplus">+    }</span>
<a href="#l1.1603"></a><span id="l1.1603" class="difflineplus">+</span>
<a href="#l1.1604"></a><span id="l1.1604" class="difflineplus">+    return false;</span>
<a href="#l1.1605"></a><span id="l1.1605" class="difflineplus">+  },</span>
<a href="#l1.1606"></a><span id="l1.1606" class="difflineplus">+</span>
<a href="#l1.1607"></a><span id="l1.1607" class="difflineplus">+  // check if the attachment could be encrypted</span>
<a href="#l1.1608"></a><span id="l1.1608" class="difflineplus">+  checkEncryptedAttach: function(attachment) {</span>
<a href="#l1.1609"></a><span id="l1.1609" class="difflineplus">+    return (EnigmailMsgRead.getAttachmentName(attachment).match(/\.(gpg|pgp|asc)$/i) ||</span>
<a href="#l1.1610"></a><span id="l1.1610" class="difflineplus">+      (attachment.contentType.match(/^application\/pgp(-.*)?$/i)) &amp;&amp;</span>
<a href="#l1.1611"></a><span id="l1.1611" class="difflineplus">+      (attachment.contentType.search(/^application\/pgp-signature/i) &lt; 0));</span>
<a href="#l1.1612"></a><span id="l1.1612" class="difflineplus">+  },</span>
<a href="#l1.1613"></a><span id="l1.1613" class="difflineplus">+</span>
<a href="#l1.1614"></a><span id="l1.1614" class="difflineplus">+  getDecryptedMessage: function(contentType, includeHeaders) {</span>
<a href="#l1.1615"></a><span id="l1.1615" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: getDecryptedMessage: &quot; + contentType + &quot;, &quot; + includeHeaders + &quot;\n&quot;);</span>
<a href="#l1.1616"></a><span id="l1.1616" class="difflineplus">+</span>
<a href="#l1.1617"></a><span id="l1.1617" class="difflineplus">+    if (!Enigmail.msg.decryptedMessage) {</span>
<a href="#l1.1618"></a><span id="l1.1618" class="difflineplus">+      return &quot;No decrypted message found!\n&quot;;</span>
<a href="#l1.1619"></a><span id="l1.1619" class="difflineplus">+    }</span>
<a href="#l1.1620"></a><span id="l1.1620" class="difflineplus">+</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineplus">+    var enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.1622"></a><span id="l1.1622" class="difflineplus">+    if (!enigmailSvc) {</span>
<a href="#l1.1623"></a><span id="l1.1623" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l1.1624"></a><span id="l1.1624" class="difflineplus">+    }</span>
<a href="#l1.1625"></a><span id="l1.1625" class="difflineplus">+</span>
<a href="#l1.1626"></a><span id="l1.1626" class="difflineplus">+    var headerList = Enigmail.msg.decryptedMessage.headerList;</span>
<a href="#l1.1627"></a><span id="l1.1627" class="difflineplus">+    var statusLine = Enigmail.msg.securityInfo ? Enigmail.msg.securityInfo.statusLine : &quot;&quot;;</span>
<a href="#l1.1628"></a><span id="l1.1628" class="difflineplus">+    var contentData = &quot;&quot;;</span>
<a href="#l1.1629"></a><span id="l1.1629" class="difflineplus">+    var headerName;</span>
<a href="#l1.1630"></a><span id="l1.1630" class="difflineplus">+</span>
<a href="#l1.1631"></a><span id="l1.1631" class="difflineplus">+    if (contentType == &quot;message/rfc822&quot;) {</span>
<a href="#l1.1632"></a><span id="l1.1632" class="difflineplus">+      // message/rfc822</span>
<a href="#l1.1633"></a><span id="l1.1633" class="difflineplus">+</span>
<a href="#l1.1634"></a><span id="l1.1634" class="difflineplus">+      if (includeHeaders) {</span>
<a href="#l1.1635"></a><span id="l1.1635" class="difflineplus">+        try {</span>
<a href="#l1.1636"></a><span id="l1.1636" class="difflineplus">+</span>
<a href="#l1.1637"></a><span id="l1.1637" class="difflineplus">+          var msg = gFolderDisplay.selectedMessage;</span>
<a href="#l1.1638"></a><span id="l1.1638" class="difflineplus">+          if (msg) {</span>
<a href="#l1.1639"></a><span id="l1.1639" class="difflineplus">+            let msgHdr = {</span>
<a href="#l1.1640"></a><span id="l1.1640" class="difflineplus">+              &quot;From&quot;: msg.author,</span>
<a href="#l1.1641"></a><span id="l1.1641" class="difflineplus">+              &quot;Subject&quot;: msg.subject,</span>
<a href="#l1.1642"></a><span id="l1.1642" class="difflineplus">+              &quot;To&quot;: msg.recipients,</span>
<a href="#l1.1643"></a><span id="l1.1643" class="difflineplus">+              &quot;Cc&quot;: msg.ccList,</span>
<a href="#l1.1644"></a><span id="l1.1644" class="difflineplus">+              &quot;Date&quot;: EnigmailTime.getDateTime(msg.dateInSeconds, true, true)</span>
<a href="#l1.1645"></a><span id="l1.1645" class="difflineplus">+            };</span>
<a href="#l1.1646"></a><span id="l1.1646" class="difflineplus">+</span>
<a href="#l1.1647"></a><span id="l1.1647" class="difflineplus">+</span>
<a href="#l1.1648"></a><span id="l1.1648" class="difflineplus">+            if (gFolderDisplay.selectedMessageIsNews) {</span>
<a href="#l1.1649"></a><span id="l1.1649" class="difflineplus">+              if (currentHeaderData.newsgroups) {</span>
<a href="#l1.1650"></a><span id="l1.1650" class="difflineplus">+                msgHdr.Newsgroups = currentHeaderData.newsgroups.headerValue;</span>
<a href="#l1.1651"></a><span id="l1.1651" class="difflineplus">+              }</span>
<a href="#l1.1652"></a><span id="l1.1652" class="difflineplus">+            }</span>
<a href="#l1.1653"></a><span id="l1.1653" class="difflineplus">+</span>
<a href="#l1.1654"></a><span id="l1.1654" class="difflineplus">+            for (let headerName in msgHdr) {</span>
<a href="#l1.1655"></a><span id="l1.1655" class="difflineplus">+              if (msgHdr[headerName] &amp;&amp; msgHdr[headerName].length &gt; 0) {</span>
<a href="#l1.1656"></a><span id="l1.1656" class="difflineplus">+                contentData += headerName + &quot;: &quot; + msgHdr[headerName] + &quot;\r\n&quot;;</span>
<a href="#l1.1657"></a><span id="l1.1657" class="difflineplus">+              }</span>
<a href="#l1.1658"></a><span id="l1.1658" class="difflineplus">+            }</span>
<a href="#l1.1659"></a><span id="l1.1659" class="difflineplus">+</span>
<a href="#l1.1660"></a><span id="l1.1660" class="difflineplus">+          }</span>
<a href="#l1.1661"></a><span id="l1.1661" class="difflineplus">+        }</span>
<a href="#l1.1662"></a><span id="l1.1662" class="difflineplus">+        catch (ex) {</span>
<a href="#l1.1663"></a><span id="l1.1663" class="difflineplus">+          // the above seems to fail every now and then</span>
<a href="#l1.1664"></a><span id="l1.1664" class="difflineplus">+          // so, here is the fallback</span>
<a href="#l1.1665"></a><span id="l1.1665" class="difflineplus">+          for (let headerName in headerList) {</span>
<a href="#l1.1666"></a><span id="l1.1666" class="difflineplus">+            let headerValue = headerList[headerName];</span>
<a href="#l1.1667"></a><span id="l1.1667" class="difflineplus">+            contentData += headerName + &quot;: &quot; + headerValue + &quot;\r\n&quot;;</span>
<a href="#l1.1668"></a><span id="l1.1668" class="difflineplus">+          }</span>
<a href="#l1.1669"></a><span id="l1.1669" class="difflineplus">+        }</span>
<a href="#l1.1670"></a><span id="l1.1670" class="difflineplus">+</span>
<a href="#l1.1671"></a><span id="l1.1671" class="difflineplus">+        contentData += &quot;Content-Type: text/plain&quot;;</span>
<a href="#l1.1672"></a><span id="l1.1672" class="difflineplus">+</span>
<a href="#l1.1673"></a><span id="l1.1673" class="difflineplus">+        if (Enigmail.msg.decryptedMessage.charset) {</span>
<a href="#l1.1674"></a><span id="l1.1674" class="difflineplus">+          contentData += &quot;; charset=&quot; + Enigmail.msg.decryptedMessage.charset;</span>
<a href="#l1.1675"></a><span id="l1.1675" class="difflineplus">+        }</span>
<a href="#l1.1676"></a><span id="l1.1676" class="difflineplus">+</span>
<a href="#l1.1677"></a><span id="l1.1677" class="difflineplus">+        contentData += &quot;\r\n&quot;;</span>
<a href="#l1.1678"></a><span id="l1.1678" class="difflineplus">+      }</span>
<a href="#l1.1679"></a><span id="l1.1679" class="difflineplus">+</span>
<a href="#l1.1680"></a><span id="l1.1680" class="difflineplus">+      contentData += &quot;\r\n&quot;;</span>
<a href="#l1.1681"></a><span id="l1.1681" class="difflineplus">+</span>
<a href="#l1.1682"></a><span id="l1.1682" class="difflineplus">+      if (Enigmail.msg.decryptedMessage.hasAttachments &amp;&amp; (!Enigmail.msg.decryptedMessage.attachmentsEncrypted)) {</span>
<a href="#l1.1683"></a><span id="l1.1683" class="difflineplus">+        contentData += EnigmailData.convertFromUnicode(EnigmailLocale.getString(&quot;enigContentNote&quot;), Enigmail.msg.decryptedMessage.charset);</span>
<a href="#l1.1684"></a><span id="l1.1684" class="difflineplus">+      }</span>
<a href="#l1.1685"></a><span id="l1.1685" class="difflineplus">+</span>
<a href="#l1.1686"></a><span id="l1.1686" class="difflineplus">+      contentData += Enigmail.msg.decryptedMessage.plainText;</span>
<a href="#l1.1687"></a><span id="l1.1687" class="difflineplus">+    }</span>
<a href="#l1.1688"></a><span id="l1.1688" class="difflineplus">+    else {</span>
<a href="#l1.1689"></a><span id="l1.1689" class="difflineplus">+      // text/html or text/plain</span>
<a href="#l1.1690"></a><span id="l1.1690" class="difflineplus">+</span>
<a href="#l1.1691"></a><span id="l1.1691" class="difflineplus">+      if (contentType == &quot;text/html&quot;) {</span>
<a href="#l1.1692"></a><span id="l1.1692" class="difflineplus">+        contentData += &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=&quot; + Enigmail.msg.decryptedMessage.charset + &quot;\&quot;&gt;\r\n&quot;;</span>
<a href="#l1.1693"></a><span id="l1.1693" class="difflineplus">+        contentData += &quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;\r\n&quot;;</span>
<a href="#l1.1694"></a><span id="l1.1694" class="difflineplus">+      }</span>
<a href="#l1.1695"></a><span id="l1.1695" class="difflineplus">+</span>
<a href="#l1.1696"></a><span id="l1.1696" class="difflineplus">+      if (statusLine) {</span>
<a href="#l1.1697"></a><span id="l1.1697" class="difflineplus">+        if (contentType == &quot;text/html&quot;) {</span>
<a href="#l1.1698"></a><span id="l1.1698" class="difflineplus">+          contentData += &quot;&lt;b&gt;&quot; + EnigmailLocale.getString(&quot;enigHeader&quot;) + &quot;&lt;/b&gt; &quot; +</span>
<a href="#l1.1699"></a><span id="l1.1699" class="difflineplus">+            EnigmailMsgRead.escapeTextForHTML(statusLine, false) + &quot;&lt;br&gt;\r\n&lt;hr&gt;\r\n&quot;;</span>
<a href="#l1.1700"></a><span id="l1.1700" class="difflineplus">+        }</span>
<a href="#l1.1701"></a><span id="l1.1701" class="difflineplus">+        else {</span>
<a href="#l1.1702"></a><span id="l1.1702" class="difflineplus">+          contentData += EnigmailLocale.getString(&quot;enigHeader&quot;) + &quot; &quot; + statusLine + &quot;\r\n\r\n&quot;;</span>
<a href="#l1.1703"></a><span id="l1.1703" class="difflineplus">+        }</span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineplus">+      }</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineplus">+</span>
<a href="#l1.1706"></a><span id="l1.1706" class="difflineplus">+      if (includeHeaders) {</span>
<a href="#l1.1707"></a><span id="l1.1707" class="difflineplus">+        for (headerName in headerList) {</span>
<a href="#l1.1708"></a><span id="l1.1708" class="difflineplus">+          let headerValue = headerList[headerName];</span>
<a href="#l1.1709"></a><span id="l1.1709" class="difflineplus">+</span>
<a href="#l1.1710"></a><span id="l1.1710" class="difflineplus">+          if (headerValue) {</span>
<a href="#l1.1711"></a><span id="l1.1711" class="difflineplus">+            if (contentType == &quot;text/html&quot;) {</span>
<a href="#l1.1712"></a><span id="l1.1712" class="difflineplus">+              contentData += &quot;&lt;b&gt;&quot; + EnigmailMsgRead.escapeTextForHTML(headerName, false) + &quot;:&lt;/b&gt; &quot; +</span>
<a href="#l1.1713"></a><span id="l1.1713" class="difflineplus">+                EnigmailMsgRead.escapeTextForHTML(headerValue, false) + &quot;&lt;br&gt;\r\n&quot;;</span>
<a href="#l1.1714"></a><span id="l1.1714" class="difflineplus">+            }</span>
<a href="#l1.1715"></a><span id="l1.1715" class="difflineplus">+            else {</span>
<a href="#l1.1716"></a><span id="l1.1716" class="difflineplus">+              contentData += headerName + &quot;: &quot; + headerValue + &quot;\r\n&quot;;</span>
<a href="#l1.1717"></a><span id="l1.1717" class="difflineplus">+            }</span>
<a href="#l1.1718"></a><span id="l1.1718" class="difflineplus">+          }</span>
<a href="#l1.1719"></a><span id="l1.1719" class="difflineplus">+        }</span>
<a href="#l1.1720"></a><span id="l1.1720" class="difflineplus">+      }</span>
<a href="#l1.1721"></a><span id="l1.1721" class="difflineplus">+</span>
<a href="#l1.1722"></a><span id="l1.1722" class="difflineplus">+      if (contentType == &quot;text/html&quot;) {</span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineplus">+        contentData += &quot;&lt;pre&gt;&quot; + EnigmailMsgRead.escapeTextForHTML(Enigmail.msg.decryptedMessage.plainText, false) + &quot;&lt;/pre&gt;\r\n&quot;;</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineplus">+</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineplus">+        contentData += &quot;&lt;/body&gt;&lt;/html&gt;\r\n&quot;;</span>
<a href="#l1.1726"></a><span id="l1.1726" class="difflineplus">+      }</span>
<a href="#l1.1727"></a><span id="l1.1727" class="difflineplus">+      else {</span>
<a href="#l1.1728"></a><span id="l1.1728" class="difflineplus">+        contentData += &quot;\r\n&quot; + Enigmail.msg.decryptedMessage.plainText;</span>
<a href="#l1.1729"></a><span id="l1.1729" class="difflineplus">+      }</span>
<a href="#l1.1730"></a><span id="l1.1730" class="difflineplus">+</span>
<a href="#l1.1731"></a><span id="l1.1731" class="difflineplus">+      if (!(EnigmailOS.isDosLike)) {</span>
<a href="#l1.1732"></a><span id="l1.1732" class="difflineplus">+        contentData = contentData.replace(/\r\n/g, &quot;\n&quot;);</span>
<a href="#l1.1733"></a><span id="l1.1733" class="difflineplus">+      }</span>
<a href="#l1.1734"></a><span id="l1.1734" class="difflineplus">+    }</span>
<a href="#l1.1735"></a><span id="l1.1735" class="difflineplus">+</span>
<a href="#l1.1736"></a><span id="l1.1736" class="difflineplus">+    return contentData;</span>
<a href="#l1.1737"></a><span id="l1.1737" class="difflineplus">+  },</span>
<a href="#l1.1738"></a><span id="l1.1738" class="difflineplus">+</span>
<a href="#l1.1739"></a><span id="l1.1739" class="difflineplus">+</span>
<a href="#l1.1740"></a><span id="l1.1740" class="difflineplus">+  msgDefaultPrint: function(elementId) {</span>
<a href="#l1.1741"></a><span id="l1.1741" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: this.msgDefaultPrint: &quot; + elementId + &quot;\n&quot;);</span>
<a href="#l1.1742"></a><span id="l1.1742" class="difflineplus">+</span>
<a href="#l1.1743"></a><span id="l1.1743" class="difflineplus">+    goDoCommand(elementId.indexOf(&quot;printpreview&quot;) &gt;= 0 ? &quot;cmd_printpreview&quot; : &quot;cmd_print&quot;);</span>
<a href="#l1.1744"></a><span id="l1.1744" class="difflineplus">+  },</span>
<a href="#l1.1745"></a><span id="l1.1745" class="difflineplus">+</span>
<a href="#l1.1746"></a><span id="l1.1746" class="difflineplus">+  msgPrint: function(elementId) {</span>
<a href="#l1.1747"></a><span id="l1.1747" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: msgPrint: &quot; + elementId + &quot;\n&quot;);</span>
<a href="#l1.1748"></a><span id="l1.1748" class="difflineplus">+</span>
<a href="#l1.1749"></a><span id="l1.1749" class="difflineplus">+    var contextMenu = (elementId.search(&quot;Context&quot;) &gt; -1);</span>
<a href="#l1.1750"></a><span id="l1.1750" class="difflineplus">+</span>
<a href="#l1.1751"></a><span id="l1.1751" class="difflineplus">+    if (!Enigmail.msg.decryptedMessage || typeof(Enigmail.msg.decryptedMessage) == &quot;undefined&quot;) {</span>
<a href="#l1.1752"></a><span id="l1.1752" class="difflineplus">+      this.msgDefaultPrint(elementId);</span>
<a href="#l1.1753"></a><span id="l1.1753" class="difflineplus">+      return;</span>
<a href="#l1.1754"></a><span id="l1.1754" class="difflineplus">+    }</span>
<a href="#l1.1755"></a><span id="l1.1755" class="difflineplus">+</span>
<a href="#l1.1756"></a><span id="l1.1756" class="difflineplus">+    var mailNewsUrl = this.getCurrentMsgUrl();</span>
<a href="#l1.1757"></a><span id="l1.1757" class="difflineplus">+</span>
<a href="#l1.1758"></a><span id="l1.1758" class="difflineplus">+    if (!mailNewsUrl) {</span>
<a href="#l1.1759"></a><span id="l1.1759" class="difflineplus">+      this.msgDefaultPrint(elementId);</span>
<a href="#l1.1760"></a><span id="l1.1760" class="difflineplus">+      return;</span>
<a href="#l1.1761"></a><span id="l1.1761" class="difflineplus">+    }</span>
<a href="#l1.1762"></a><span id="l1.1762" class="difflineplus">+</span>
<a href="#l1.1763"></a><span id="l1.1763" class="difflineplus">+    if (Enigmail.msg.decryptedMessage.url != mailNewsUrl.spec) {</span>
<a href="#l1.1764"></a><span id="l1.1764" class="difflineplus">+      Enigmail.msg.decryptedMessage = null;</span>
<a href="#l1.1765"></a><span id="l1.1765" class="difflineplus">+      this.msgDefaultPrint(elementId);</span>
<a href="#l1.1766"></a><span id="l1.1766" class="difflineplus">+      return;</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineplus">+    }</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineplus">+</span>
<a href="#l1.1769"></a><span id="l1.1769" class="difflineplus">+    var enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.1770"></a><span id="l1.1770" class="difflineplus">+    if (!enigmailSvc) {</span>
<a href="#l1.1771"></a><span id="l1.1771" class="difflineplus">+      this.msgDefaultPrint(elementId);</span>
<a href="#l1.1772"></a><span id="l1.1772" class="difflineplus">+      return;</span>
<a href="#l1.1773"></a><span id="l1.1773" class="difflineplus">+    }</span>
<a href="#l1.1774"></a><span id="l1.1774" class="difflineplus">+</span>
<a href="#l1.1775"></a><span id="l1.1775" class="difflineplus">+    // Note: Trying to print text/html content does not seem to work with</span>
<a href="#l1.1776"></a><span id="l1.1776" class="difflineplus">+    //       non-ASCII chars</span>
<a href="#l1.1777"></a><span id="l1.1777" class="difflineplus">+    var msgContent = this.getDecryptedMessage(&quot;message/rfc822&quot;, true);</span>
<a href="#l1.1778"></a><span id="l1.1778" class="difflineplus">+</span>
<a href="#l1.1779"></a><span id="l1.1779" class="difflineplus">+    var uri = EnigmailURIs.createMessageURI(Enigmail.msg.decryptedMessage.url,</span>
<a href="#l1.1780"></a><span id="l1.1780" class="difflineplus">+      &quot;message/rfc822&quot;,</span>
<a href="#l1.1781"></a><span id="l1.1781" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l1.1782"></a><span id="l1.1782" class="difflineplus">+      msgContent,</span>
<a href="#l1.1783"></a><span id="l1.1783" class="difflineplus">+      false);</span>
<a href="#l1.1784"></a><span id="l1.1784" class="difflineplus">+    Enigmail.msg.createdURIs.push(uri);</span>
<a href="#l1.1785"></a><span id="l1.1785" class="difflineplus">+</span>
<a href="#l1.1786"></a><span id="l1.1786" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: msgPrint: uri=&quot; + uri + &quot;\n&quot;);</span>
<a href="#l1.1787"></a><span id="l1.1787" class="difflineplus">+</span>
<a href="#l1.1788"></a><span id="l1.1788" class="difflineplus">+    var messageList = [uri];</span>
<a href="#l1.1789"></a><span id="l1.1789" class="difflineplus">+    var printPreview = (elementId.indexOf(&quot;printpreview&quot;) &gt;= 0);</span>
<a href="#l1.1790"></a><span id="l1.1790" class="difflineplus">+</span>
<a href="#l1.1791"></a><span id="l1.1791" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;,</span>
<a href="#l1.1792"></a><span id="l1.1792" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineplus">+      &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineplus">+      1, messageList, statusFeedback,</span>
<a href="#l1.1795"></a><span id="l1.1795" class="difflineplus">+      printPreview, Ci.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_MSG,</span>
<a href="#l1.1796"></a><span id="l1.1796" class="difflineplus">+      window);</span>
<a href="#l1.1797"></a><span id="l1.1797" class="difflineplus">+</span>
<a href="#l1.1798"></a><span id="l1.1798" class="difflineplus">+    return;</span>
<a href="#l1.1799"></a><span id="l1.1799" class="difflineplus">+  },</span>
<a href="#l1.1800"></a><span id="l1.1800" class="difflineplus">+</span>
<a href="#l1.1801"></a><span id="l1.1801" class="difflineplus">+  msgDirectDecrypt: function(interactive, importOnly, contentEncoding, charset, signature,</span>
<a href="#l1.1802"></a><span id="l1.1802" class="difflineplus">+    bufferSize, head, tail, msgUriSpec, callbackFunction, isAuto) {</span>
<a href="#l1.1803"></a><span id="l1.1803" class="difflineplus">+    EnigmailLog.WRITE(&quot;enigmailMessengerOverlay.js: msgDirectDecrypt: contentEncoding=&quot; + contentEncoding + &quot;, signature=&quot; + signature + &quot;\n&quot;);</span>
<a href="#l1.1804"></a><span id="l1.1804" class="difflineplus">+    var mailNewsUrl = this.getCurrentMsgUrl();</span>
<a href="#l1.1805"></a><span id="l1.1805" class="difflineplus">+    if (!mailNewsUrl) {</span>
<a href="#l1.1806"></a><span id="l1.1806" class="difflineplus">+      return;</span>
<a href="#l1.1807"></a><span id="l1.1807" class="difflineplus">+    }</span>
<a href="#l1.1808"></a><span id="l1.1808" class="difflineplus">+</span>
<a href="#l1.1809"></a><span id="l1.1809" class="difflineplus">+    var callbackArg = {</span>
<a href="#l1.1810"></a><span id="l1.1810" class="difflineplus">+      interactive: interactive,</span>
<a href="#l1.1811"></a><span id="l1.1811" class="difflineplus">+      importOnly: importOnly,</span>
<a href="#l1.1812"></a><span id="l1.1812" class="difflineplus">+      contentEncoding: contentEncoding,</span>
<a href="#l1.1813"></a><span id="l1.1813" class="difflineplus">+      charset: charset,</span>
<a href="#l1.1814"></a><span id="l1.1814" class="difflineplus">+      messageUrl: mailNewsUrl.spec,</span>
<a href="#l1.1815"></a><span id="l1.1815" class="difflineplus">+      msgUriSpec: msgUriSpec,</span>
<a href="#l1.1816"></a><span id="l1.1816" class="difflineplus">+      signature: signature,</span>
<a href="#l1.1817"></a><span id="l1.1817" class="difflineplus">+      data: &quot;&quot;,</span>
<a href="#l1.1818"></a><span id="l1.1818" class="difflineplus">+      head: head,</span>
<a href="#l1.1819"></a><span id="l1.1819" class="difflineplus">+      tail: tail,</span>
<a href="#l1.1820"></a><span id="l1.1820" class="difflineplus">+      isAuto: isAuto,</span>
<a href="#l1.1821"></a><span id="l1.1821" class="difflineplus">+      callbackFunction: callbackFunction</span>
<a href="#l1.1822"></a><span id="l1.1822" class="difflineplus">+    };</span>
<a href="#l1.1823"></a><span id="l1.1823" class="difflineplus">+</span>
<a href="#l1.1824"></a><span id="l1.1824" class="difflineplus">+    var msgSvc = messenger.messageServiceFromURI(msgUriSpec);</span>
<a href="#l1.1825"></a><span id="l1.1825" class="difflineplus">+</span>
<a href="#l1.1826"></a><span id="l1.1826" class="difflineplus">+    var listener = {</span>
<a href="#l1.1827"></a><span id="l1.1827" class="difflineplus">+      QueryInterface: EnigmailCompat.generateQI([&quot;nsIStreamListener&quot;]),</span>
<a href="#l1.1828"></a><span id="l1.1828" class="difflineplus">+      onStartRequest: function() {</span>
<a href="#l1.1829"></a><span id="l1.1829" class="difflineplus">+        this.data = &quot;&quot;;</span>
<a href="#l1.1830"></a><span id="l1.1830" class="difflineplus">+        this.inStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineplus">+</span>
<a href="#l1.1832"></a><span id="l1.1832" class="difflineplus">+      },</span>
<a href="#l1.1833"></a><span id="l1.1833" class="difflineplus">+      onStopRequest: function() {</span>
<a href="#l1.1834"></a><span id="l1.1834" class="difflineplus">+        var start = this.data.indexOf(&quot;-----BEGIN PGP&quot;);</span>
<a href="#l1.1835"></a><span id="l1.1835" class="difflineplus">+        var end = this.data.indexOf(&quot;-----END PGP&quot;);</span>
<a href="#l1.1836"></a><span id="l1.1836" class="difflineplus">+</span>
<a href="#l1.1837"></a><span id="l1.1837" class="difflineplus">+        if (start &gt;= 0 &amp;&amp; end &gt; start) {</span>
<a href="#l1.1838"></a><span id="l1.1838" class="difflineplus">+          var tStr = this.data.substr(end);</span>
<a href="#l1.1839"></a><span id="l1.1839" class="difflineplus">+          var n = tStr.indexOf(&quot;\n&quot;);</span>
<a href="#l1.1840"></a><span id="l1.1840" class="difflineplus">+          var r = tStr.indexOf(&quot;\r&quot;);</span>
<a href="#l1.1841"></a><span id="l1.1841" class="difflineplus">+          var lEnd = -1;</span>
<a href="#l1.1842"></a><span id="l1.1842" class="difflineplus">+          if (n &gt;= 0 &amp;&amp; r &gt;= 0) {</span>
<a href="#l1.1843"></a><span id="l1.1843" class="difflineplus">+            lEnd = Math.min(r, n);</span>
<a href="#l1.1844"></a><span id="l1.1844" class="difflineplus">+          }</span>
<a href="#l1.1845"></a><span id="l1.1845" class="difflineplus">+          else if (r &gt;= 0) {</span>
<a href="#l1.1846"></a><span id="l1.1846" class="difflineplus">+            lEnd = r;</span>
<a href="#l1.1847"></a><span id="l1.1847" class="difflineplus">+          }</span>
<a href="#l1.1848"></a><span id="l1.1848" class="difflineplus">+          else if (n &gt;= 0) {</span>
<a href="#l1.1849"></a><span id="l1.1849" class="difflineplus">+            lEnd = n;</span>
<a href="#l1.1850"></a><span id="l1.1850" class="difflineplus">+          }</span>
<a href="#l1.1851"></a><span id="l1.1851" class="difflineplus">+</span>
<a href="#l1.1852"></a><span id="l1.1852" class="difflineplus">+          if (lEnd &gt;= 0) {</span>
<a href="#l1.1853"></a><span id="l1.1853" class="difflineplus">+            end += lEnd;</span>
<a href="#l1.1854"></a><span id="l1.1854" class="difflineplus">+          }</span>
<a href="#l1.1855"></a><span id="l1.1855" class="difflineplus">+</span>
<a href="#l1.1856"></a><span id="l1.1856" class="difflineplus">+          callbackArg.data = this.data.substring(start, end + 1);</span>
<a href="#l1.1857"></a><span id="l1.1857" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: data: &gt;&quot; + callbackArg.data.substr(0, 100) + &quot;&lt;\n&quot;);</span>
<a href="#l1.1858"></a><span id="l1.1858" class="difflineplus">+          Enigmail.msg.msgDirectCallback(callbackArg);</span>
<a href="#l1.1859"></a><span id="l1.1859" class="difflineplus">+        }</span>
<a href="#l1.1860"></a><span id="l1.1860" class="difflineplus">+      }</span>
<a href="#l1.1861"></a><span id="l1.1861" class="difflineplus">+    };</span>
<a href="#l1.1862"></a><span id="l1.1862" class="difflineplus">+</span>
<a href="#l1.1863"></a><span id="l1.1863" class="difflineplus">+    if (EnigmailCompat.isMessageUriInPgpMime()) {</span>
<a href="#l1.1864"></a><span id="l1.1864" class="difflineplus">+      // TB &gt;= 67</span>
<a href="#l1.1865"></a><span id="l1.1865" class="difflineplus">+      listener.onDataAvailable = function(req, stream, offset, count) {</span>
<a href="#l1.1866"></a><span id="l1.1866" class="difflineplus">+        this.inStream.init(stream);</span>
<a href="#l1.1867"></a><span id="l1.1867" class="difflineplus">+        this.data += this.inStream.read(count);</span>
<a href="#l1.1868"></a><span id="l1.1868" class="difflineplus">+      };</span>
<a href="#l1.1869"></a><span id="l1.1869" class="difflineplus">+    }</span>
<a href="#l1.1870"></a><span id="l1.1870" class="difflineplus">+    else {</span>
<a href="#l1.1871"></a><span id="l1.1871" class="difflineplus">+      listener.onDataAvailable = function(req, ctxt, stream, offset, count) {</span>
<a href="#l1.1872"></a><span id="l1.1872" class="difflineplus">+        this.inStream.init(stream);</span>
<a href="#l1.1873"></a><span id="l1.1873" class="difflineplus">+        this.data += this.inStream.read(count);</span>
<a href="#l1.1874"></a><span id="l1.1874" class="difflineplus">+      };</span>
<a href="#l1.1875"></a><span id="l1.1875" class="difflineplus">+    }</span>
<a href="#l1.1876"></a><span id="l1.1876" class="difflineplus">+</span>
<a href="#l1.1877"></a><span id="l1.1877" class="difflineplus">+</span>
<a href="#l1.1878"></a><span id="l1.1878" class="difflineplus">+    msgSvc.streamMessage(msgUriSpec,</span>
<a href="#l1.1879"></a><span id="l1.1879" class="difflineplus">+      listener,</span>
<a href="#l1.1880"></a><span id="l1.1880" class="difflineplus">+      msgWindow,</span>
<a href="#l1.1881"></a><span id="l1.1881" class="difflineplus">+      null,</span>
<a href="#l1.1882"></a><span id="l1.1882" class="difflineplus">+      false,</span>
<a href="#l1.1883"></a><span id="l1.1883" class="difflineplus">+      null,</span>
<a href="#l1.1884"></a><span id="l1.1884" class="difflineplus">+      false);</span>
<a href="#l1.1885"></a><span id="l1.1885" class="difflineplus">+</span>
<a href="#l1.1886"></a><span id="l1.1886" class="difflineplus">+  },</span>
<a href="#l1.1887"></a><span id="l1.1887" class="difflineplus">+</span>
<a href="#l1.1888"></a><span id="l1.1888" class="difflineplus">+</span>
<a href="#l1.1889"></a><span id="l1.1889" class="difflineplus">+  msgDirectCallback: function(callbackArg) {</span>
<a href="#l1.1890"></a><span id="l1.1890" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: msgDirectCallback: \n&quot;);</span>
<a href="#l1.1891"></a><span id="l1.1891" class="difflineplus">+</span>
<a href="#l1.1892"></a><span id="l1.1892" class="difflineplus">+    var mailNewsUrl = Enigmail.msg.getCurrentMsgUrl();</span>
<a href="#l1.1893"></a><span id="l1.1893" class="difflineplus">+    var urlSpec = mailNewsUrl ? mailNewsUrl.spec : &quot;&quot;;</span>
<a href="#l1.1894"></a><span id="l1.1894" class="difflineplus">+    var newBufferSize = 0;</span>
<a href="#l1.1895"></a><span id="l1.1895" class="difflineplus">+</span>
<a href="#l1.1896"></a><span id="l1.1896" class="difflineplus">+    var l = urlSpec.length;</span>
<a href="#l1.1897"></a><span id="l1.1897" class="difflineplus">+</span>
<a href="#l1.1898"></a><span id="l1.1898" class="difflineplus">+    if (urlSpec.substr(0, l) != callbackArg.messageUrl.substr(0, l)) {</span>
<a href="#l1.1899"></a><span id="l1.1899" class="difflineplus">+      EnigmailLog.ERROR(&quot;enigmailMessengerOverlay.js: msgDirectCallback: Message URL mismatch &quot; + mailNewsUrl.spec + &quot; vs. &quot; + callbackArg.messageUrl + &quot;\n&quot;);</span>
<a href="#l1.1900"></a><span id="l1.1900" class="difflineplus">+      return;</span>
<a href="#l1.1901"></a><span id="l1.1901" class="difflineplus">+    }</span>
<a href="#l1.1902"></a><span id="l1.1902" class="difflineplus">+</span>
<a href="#l1.1903"></a><span id="l1.1903" class="difflineplus">+    var msgText = callbackArg.data;</span>
<a href="#l1.1904"></a><span id="l1.1904" class="difflineplus">+    msgText = EnigmailData.convertFromUnicode(msgText, &quot;UTF-8&quot;);</span>
<a href="#l1.1905"></a><span id="l1.1905" class="difflineplus">+</span>
<a href="#l1.1906"></a><span id="l1.1906" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: msgDirectCallback: msgText='&quot; + msgText.substr(0, 100) + &quot;'\n&quot;);</span>
<a href="#l1.1907"></a><span id="l1.1907" class="difflineplus">+</span>
<a href="#l1.1908"></a><span id="l1.1908" class="difflineplus">+    var f = function(argList) {</span>
<a href="#l1.1909"></a><span id="l1.1909" class="difflineplus">+      var msgText = argList[0];</span>
<a href="#l1.1910"></a><span id="l1.1910" class="difflineplus">+      var cb = argList[1];</span>
<a href="#l1.1911"></a><span id="l1.1911" class="difflineplus">+      cb.callbackFunction(msgText, cb.contentEncoding,</span>
<a href="#l1.1912"></a><span id="l1.1912" class="difflineplus">+        cb.charset,</span>
<a href="#l1.1913"></a><span id="l1.1913" class="difflineplus">+        cb.interactive,</span>
<a href="#l1.1914"></a><span id="l1.1914" class="difflineplus">+        cb.importOnly,</span>
<a href="#l1.1915"></a><span id="l1.1915" class="difflineplus">+        cb.messageUrl,</span>
<a href="#l1.1916"></a><span id="l1.1916" class="difflineplus">+        cb.signature,</span>
<a href="#l1.1917"></a><span id="l1.1917" class="difflineplus">+        3,</span>
<a href="#l1.1918"></a><span id="l1.1918" class="difflineplus">+        cb.head,</span>
<a href="#l1.1919"></a><span id="l1.1919" class="difflineplus">+        cb.tail,</span>
<a href="#l1.1920"></a><span id="l1.1920" class="difflineplus">+        cb.msgUriSpec,</span>
<a href="#l1.1921"></a><span id="l1.1921" class="difflineplus">+        cb.isAuto);</span>
<a href="#l1.1922"></a><span id="l1.1922" class="difflineplus">+    };</span>
<a href="#l1.1923"></a><span id="l1.1923" class="difflineplus">+</span>
<a href="#l1.1924"></a><span id="l1.1924" class="difflineplus">+    EnigmailEvents.dispatchEvent(f, 0, [msgText, callbackArg]);</span>
<a href="#l1.1925"></a><span id="l1.1925" class="difflineplus">+  },</span>
<a href="#l1.1926"></a><span id="l1.1926" class="difflineplus">+</span>
<a href="#l1.1927"></a><span id="l1.1927" class="difflineplus">+</span>
<a href="#l1.1928"></a><span id="l1.1928" class="difflineplus">+  revealAttachments: function(index) {</span>
<a href="#l1.1929"></a><span id="l1.1929" class="difflineplus">+    if (!index) {</span>
<a href="#l1.1930"></a><span id="l1.1930" class="difflineplus">+      index = 0;</span>
<a href="#l1.1931"></a><span id="l1.1931" class="difflineplus">+    }</span>
<a href="#l1.1932"></a><span id="l1.1932" class="difflineplus">+</span>
<a href="#l1.1933"></a><span id="l1.1933" class="difflineplus">+    if (index &lt; currentAttachments.length) {</span>
<a href="#l1.1934"></a><span id="l1.1934" class="difflineplus">+      this.handleAttachment(&quot;revealName/&quot; + index.toString(), currentAttachments[index]);</span>
<a href="#l1.1935"></a><span id="l1.1935" class="difflineplus">+    }</span>
<a href="#l1.1936"></a><span id="l1.1936" class="difflineplus">+  },</span>
<a href="#l1.1937"></a><span id="l1.1937" class="difflineplus">+</span>
<a href="#l1.1938"></a><span id="l1.1938" class="difflineplus">+  // handle the attachment view toggle</span>
<a href="#l1.1939"></a><span id="l1.1939" class="difflineplus">+  handleAttchmentEvent: function() {</span>
<a href="#l1.1940"></a><span id="l1.1940" class="difflineplus">+    let attList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l1.1941"></a><span id="l1.1941" class="difflineplus">+</span>
<a href="#l1.1942"></a><span id="l1.1942" class="difflineplus">+    let clickFunc = function(event) {</span>
<a href="#l1.1943"></a><span id="l1.1943" class="difflineplus">+      Enigmail.msg.attachmentListClick('attachmentList', event);</span>
<a href="#l1.1944"></a><span id="l1.1944" class="difflineplus">+    };</span>
<a href="#l1.1945"></a><span id="l1.1945" class="difflineplus">+</span>
<a href="#l1.1946"></a><span id="l1.1946" class="difflineplus">+    if (attList &amp;&amp; attList.itemCount &gt; 0) {</span>
<a href="#l1.1947"></a><span id="l1.1947" class="difflineplus">+      for (let i = 0; i &lt; attList.itemCount; i++) {</span>
<a href="#l1.1948"></a><span id="l1.1948" class="difflineplus">+        let att = attList.getItemAtIndex(i);</span>
<a href="#l1.1949"></a><span id="l1.1949" class="difflineplus">+        att.addEventListener(&quot;click&quot;, clickFunc, true);</span>
<a href="#l1.1950"></a><span id="l1.1950" class="difflineplus">+      }</span>
<a href="#l1.1951"></a><span id="l1.1951" class="difflineplus">+    }</span>
<a href="#l1.1952"></a><span id="l1.1952" class="difflineplus">+  },</span>
<a href="#l1.1953"></a><span id="l1.1953" class="difflineplus">+</span>
<a href="#l1.1954"></a><span id="l1.1954" class="difflineplus">+  // handle a selected attachment (decrypt &amp; open or save)</span>
<a href="#l1.1955"></a><span id="l1.1955" class="difflineplus">+  handleAttachmentSel: function(actionType, selectedItem = null) {</span>
<a href="#l1.1956"></a><span id="l1.1956" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: handleAttachmentSel: actionType=&quot; + actionType + &quot;\n&quot;);</span>
<a href="#l1.1957"></a><span id="l1.1957" class="difflineplus">+</span>
<a href="#l1.1958"></a><span id="l1.1958" class="difflineplus">+    let selectedAttachments, anAttachment, contextMenu;</span>
<a href="#l1.1959"></a><span id="l1.1959" class="difflineplus">+</span>
<a href="#l1.1960"></a><span id="l1.1960" class="difflineplus">+    // Thunderbird</span>
<a href="#l1.1961"></a><span id="l1.1961" class="difflineplus">+    contextMenu = document.getElementById('attachmentItemContext');</span>
<a href="#l1.1962"></a><span id="l1.1962" class="difflineplus">+</span>
<a href="#l1.1963"></a><span id="l1.1963" class="difflineplus">+    if (contextMenu) {</span>
<a href="#l1.1964"></a><span id="l1.1964" class="difflineplus">+      // Thunderbird</span>
<a href="#l1.1965"></a><span id="l1.1965" class="difflineplus">+      selectedAttachments = contextMenu.attachments;</span>
<a href="#l1.1966"></a><span id="l1.1966" class="difflineplus">+      anAttachment = selectedAttachments[0];</span>
<a href="#l1.1967"></a><span id="l1.1967" class="difflineplus">+    }</span>
<a href="#l1.1968"></a><span id="l1.1968" class="difflineplus">+</span>
<a href="#l1.1969"></a><span id="l1.1969" class="difflineplus">+    switch (actionType) {</span>
<a href="#l1.1970"></a><span id="l1.1970" class="difflineplus">+      case &quot;saveAttachment&quot;:</span>
<a href="#l1.1971"></a><span id="l1.1971" class="difflineplus">+      case &quot;openAttachment&quot;:</span>
<a href="#l1.1972"></a><span id="l1.1972" class="difflineplus">+      case &quot;importKey&quot;:</span>
<a href="#l1.1973"></a><span id="l1.1973" class="difflineplus">+      case &quot;revealName&quot;:</span>
<a href="#l1.1974"></a><span id="l1.1974" class="difflineplus">+        this.handleAttachment(actionType, anAttachment);</span>
<a href="#l1.1975"></a><span id="l1.1975" class="difflineplus">+        break;</span>
<a href="#l1.1976"></a><span id="l1.1976" class="difflineplus">+      case &quot;verifySig&quot;:</span>
<a href="#l1.1977"></a><span id="l1.1977" class="difflineplus">+        this.verifyDetachedSignature(anAttachment);</span>
<a href="#l1.1978"></a><span id="l1.1978" class="difflineplus">+        break;</span>
<a href="#l1.1979"></a><span id="l1.1979" class="difflineplus">+    }</span>
<a href="#l1.1980"></a><span id="l1.1980" class="difflineplus">+  },</span>
<a href="#l1.1981"></a><span id="l1.1981" class="difflineplus">+</span>
<a href="#l1.1982"></a><span id="l1.1982" class="difflineplus">+  /**</span>
<a href="#l1.1983"></a><span id="l1.1983" class="difflineplus">+   * save the original file plus the signature file to disk and then verify the signature</span>
<a href="#l1.1984"></a><span id="l1.1984" class="difflineplus">+   */</span>
<a href="#l1.1985"></a><span id="l1.1985" class="difflineplus">+  verifyDetachedSignature: function(anAttachment) {</span>
<a href="#l1.1986"></a><span id="l1.1986" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: verifyDetachedSignature: url=&quot; + anAttachment.url + &quot;\n&quot;);</span>
<a href="#l1.1987"></a><span id="l1.1987" class="difflineplus">+</span>
<a href="#l1.1988"></a><span id="l1.1988" class="difflineplus">+    var enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.1989"></a><span id="l1.1989" class="difflineplus">+    if (!enigmailSvc) {</span>
<a href="#l1.1990"></a><span id="l1.1990" class="difflineplus">+      return;</span>
<a href="#l1.1991"></a><span id="l1.1991" class="difflineplus">+    }</span>
<a href="#l1.1992"></a><span id="l1.1992" class="difflineplus">+</span>
<a href="#l1.1993"></a><span id="l1.1993" class="difflineplus">+    var origAtt,</span>
<a href="#l1.1994"></a><span id="l1.1994" class="difflineplus">+      signatureAtt;</span>
<a href="#l1.1995"></a><span id="l1.1995" class="difflineplus">+    var isEncrypted = false;</span>
<a href="#l1.1996"></a><span id="l1.1996" class="difflineplus">+</span>
<a href="#l1.1997"></a><span id="l1.1997" class="difflineplus">+    if ((EnigmailMsgRead.getAttachmentName(anAttachment).search(/\.sig$/i) &gt; 0) ||</span>
<a href="#l1.1998"></a><span id="l1.1998" class="difflineplus">+      (anAttachment.contentType.search(/^application\/pgp-signature/i) === 0)) {</span>
<a href="#l1.1999"></a><span id="l1.1999" class="difflineplus">+      // we have the .sig file; need to know the original file;</span>
<a href="#l1.2000"></a><span id="l1.2000" class="difflineplus">+</span>
<a href="#l1.2001"></a><span id="l1.2001" class="difflineplus">+      signatureAtt = anAttachment;</span>
<a href="#l1.2002"></a><span id="l1.2002" class="difflineplus">+      var origName = EnigmailMsgRead.getAttachmentName(anAttachment).replace(/\.sig$/i, &quot;&quot;);</span>
<a href="#l1.2003"></a><span id="l1.2003" class="difflineplus">+</span>
<a href="#l1.2004"></a><span id="l1.2004" class="difflineplus">+      for (let i = 0; i &lt; currentAttachments.length; i++) {</span>
<a href="#l1.2005"></a><span id="l1.2005" class="difflineplus">+        if (origName == EnigmailMsgRead.getAttachmentName(currentAttachments[i])) {</span>
<a href="#l1.2006"></a><span id="l1.2006" class="difflineplus">+          origAtt = currentAttachments[i];</span>
<a href="#l1.2007"></a><span id="l1.2007" class="difflineplus">+          break;</span>
<a href="#l1.2008"></a><span id="l1.2008" class="difflineplus">+        }</span>
<a href="#l1.2009"></a><span id="l1.2009" class="difflineplus">+      }</span>
<a href="#l1.2010"></a><span id="l1.2010" class="difflineplus">+</span>
<a href="#l1.2011"></a><span id="l1.2011" class="difflineplus">+      if (!origAtt) {</span>
<a href="#l1.2012"></a><span id="l1.2012" class="difflineplus">+        for (let i = 0; i &lt; currentAttachments.length; i++) {</span>
<a href="#l1.2013"></a><span id="l1.2013" class="difflineplus">+          if (origName == EnigmailMsgRead.getAttachmentName(currentAttachments[i]).replace(/\.pgp$/i, &quot;&quot;)) {</span>
<a href="#l1.2014"></a><span id="l1.2014" class="difflineplus">+            isEncrypted = true;</span>
<a href="#l1.2015"></a><span id="l1.2015" class="difflineplus">+            origAtt = currentAttachments[i];</span>
<a href="#l1.2016"></a><span id="l1.2016" class="difflineplus">+            break;</span>
<a href="#l1.2017"></a><span id="l1.2017" class="difflineplus">+          }</span>
<a href="#l1.2018"></a><span id="l1.2018" class="difflineplus">+        }</span>
<a href="#l1.2019"></a><span id="l1.2019" class="difflineplus">+      }</span>
<a href="#l1.2020"></a><span id="l1.2020" class="difflineplus">+    }</span>
<a href="#l1.2021"></a><span id="l1.2021" class="difflineplus">+    else {</span>
<a href="#l1.2022"></a><span id="l1.2022" class="difflineplus">+      // we have a supposedly original file; need to know the .sig file;</span>
<a href="#l1.2023"></a><span id="l1.2023" class="difflineplus">+</span>
<a href="#l1.2024"></a><span id="l1.2024" class="difflineplus">+      origAtt = anAttachment;</span>
<a href="#l1.2025"></a><span id="l1.2025" class="difflineplus">+      var attachName = EnigmailMsgRead.getAttachmentName(anAttachment);</span>
<a href="#l1.2026"></a><span id="l1.2026" class="difflineplus">+      var sigName = attachName + &quot;.sig&quot;;</span>
<a href="#l1.2027"></a><span id="l1.2027" class="difflineplus">+</span>
<a href="#l1.2028"></a><span id="l1.2028" class="difflineplus">+      for (let i = 0; i &lt; currentAttachments.length; i++) {</span>
<a href="#l1.2029"></a><span id="l1.2029" class="difflineplus">+        if (sigName == EnigmailMsgRead.getAttachmentName(currentAttachments[i])) {</span>
<a href="#l1.2030"></a><span id="l1.2030" class="difflineplus">+          signatureAtt = currentAttachments[i];</span>
<a href="#l1.2031"></a><span id="l1.2031" class="difflineplus">+          break;</span>
<a href="#l1.2032"></a><span id="l1.2032" class="difflineplus">+        }</span>
<a href="#l1.2033"></a><span id="l1.2033" class="difflineplus">+      }</span>
<a href="#l1.2034"></a><span id="l1.2034" class="difflineplus">+</span>
<a href="#l1.2035"></a><span id="l1.2035" class="difflineplus">+      if (!signatureAtt &amp;&amp; attachName.search(/\.pgp$/i) &gt; 0) {</span>
<a href="#l1.2036"></a><span id="l1.2036" class="difflineplus">+        sigName = attachName.replace(/\.pgp$/i, '.sig');</span>
<a href="#l1.2037"></a><span id="l1.2037" class="difflineplus">+        for (let i = 0; i &lt; currentAttachments.length; i++) {</span>
<a href="#l1.2038"></a><span id="l1.2038" class="difflineplus">+          if (sigName == EnigmailMsgRead.getAttachmentName(currentAttachments[i])) {</span>
<a href="#l1.2039"></a><span id="l1.2039" class="difflineplus">+            isEncrypted = true;</span>
<a href="#l1.2040"></a><span id="l1.2040" class="difflineplus">+            signatureAtt = currentAttachments[i];</span>
<a href="#l1.2041"></a><span id="l1.2041" class="difflineplus">+            break;</span>
<a href="#l1.2042"></a><span id="l1.2042" class="difflineplus">+          }</span>
<a href="#l1.2043"></a><span id="l1.2043" class="difflineplus">+        }</span>
<a href="#l1.2044"></a><span id="l1.2044" class="difflineplus">+      }</span>
<a href="#l1.2045"></a><span id="l1.2045" class="difflineplus">+    }</span>
<a href="#l1.2046"></a><span id="l1.2046" class="difflineplus">+</span>
<a href="#l1.2047"></a><span id="l1.2047" class="difflineplus">+    if (!signatureAtt) {</span>
<a href="#l1.2048"></a><span id="l1.2048" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;attachment.noMatchToSignature&quot;, [EnigmailMsgRead.getAttachmentName(origAtt)]));</span>
<a href="#l1.2049"></a><span id="l1.2049" class="difflineplus">+      return;</span>
<a href="#l1.2050"></a><span id="l1.2050" class="difflineplus">+    }</span>
<a href="#l1.2051"></a><span id="l1.2051" class="difflineplus">+    if (!origAtt) {</span>
<a href="#l1.2052"></a><span id="l1.2052" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;attachment.noMatchFromSignature&quot;, [EnigmailMsgRead.getAttachmentName(signatureAtt)]));</span>
<a href="#l1.2053"></a><span id="l1.2053" class="difflineplus">+      return;</span>
<a href="#l1.2054"></a><span id="l1.2054" class="difflineplus">+    }</span>
<a href="#l1.2055"></a><span id="l1.2055" class="difflineplus">+</span>
<a href="#l1.2056"></a><span id="l1.2056" class="difflineplus">+    // open</span>
<a href="#l1.2057"></a><span id="l1.2057" class="difflineplus">+    var tmpDir = EnigmailFiles.getTempDir();</span>
<a href="#l1.2058"></a><span id="l1.2058" class="difflineplus">+    var outFile1,</span>
<a href="#l1.2059"></a><span id="l1.2059" class="difflineplus">+      outFile2;</span>
<a href="#l1.2060"></a><span id="l1.2060" class="difflineplus">+    outFile1 = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l1.2061"></a><span id="l1.2061" class="difflineplus">+    outFile1.initWithPath(tmpDir);</span>
<a href="#l1.2062"></a><span id="l1.2062" class="difflineplus">+    if (!(outFile1.isDirectory() &amp;&amp; outFile1.isWritable())) {</span>
<a href="#l1.2063"></a><span id="l1.2063" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;noTempDir&quot;));</span>
<a href="#l1.2064"></a><span id="l1.2064" class="difflineplus">+      return;</span>
<a href="#l1.2065"></a><span id="l1.2065" class="difflineplus">+    }</span>
<a href="#l1.2066"></a><span id="l1.2066" class="difflineplus">+    outFile1.append(EnigmailMsgRead.getAttachmentName(origAtt));</span>
<a href="#l1.2067"></a><span id="l1.2067" class="difflineplus">+    outFile1.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l1.2068"></a><span id="l1.2068" class="difflineplus">+    EnigmailFiles.writeUrlToFile(origAtt.url, outFile1);</span>
<a href="#l1.2069"></a><span id="l1.2069" class="difflineplus">+</span>
<a href="#l1.2070"></a><span id="l1.2070" class="difflineplus">+    if (isEncrypted) {</span>
<a href="#l1.2071"></a><span id="l1.2071" class="difflineplus">+      // Try to decrypt message if we suspect the message is encrypted. If it fails we will just verify the encrypted data.</span>
<a href="#l1.2072"></a><span id="l1.2072" class="difflineplus">+      EnigmailDecryption.decryptAttachment(window, outFile1,</span>
<a href="#l1.2073"></a><span id="l1.2073" class="difflineplus">+        EnigmailMsgRead.getAttachmentName(origAtt),</span>
<a href="#l1.2074"></a><span id="l1.2074" class="difflineplus">+        EnigmailFiles.readBinaryFile(outFile1), {}, {}, {});</span>
<a href="#l1.2075"></a><span id="l1.2075" class="difflineplus">+    }</span>
<a href="#l1.2076"></a><span id="l1.2076" class="difflineplus">+</span>
<a href="#l1.2077"></a><span id="l1.2077" class="difflineplus">+    outFile2 = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l1.2078"></a><span id="l1.2078" class="difflineplus">+    outFile2.initWithPath(tmpDir);</span>
<a href="#l1.2079"></a><span id="l1.2079" class="difflineplus">+    outFile2.append(EnigmailMsgRead.getAttachmentName(signatureAtt));</span>
<a href="#l1.2080"></a><span id="l1.2080" class="difflineplus">+    outFile2.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l1.2081"></a><span id="l1.2081" class="difflineplus">+    EnigmailFiles.writeUrlToFile(signatureAtt.url, outFile2);</span>
<a href="#l1.2082"></a><span id="l1.2082" class="difflineplus">+</span>
<a href="#l1.2083"></a><span id="l1.2083" class="difflineplus">+    var promise = EnigmailVerifyAttachment.attachment(outFile1, outFile2);</span>
<a href="#l1.2084"></a><span id="l1.2084" class="difflineplus">+    promise.then(function(message) {</span>
<a href="#l1.2085"></a><span id="l1.2085" class="difflineplus">+      EnigmailDialog.info(window, EnigmailLocale.getString(&quot;signature.verifiedOK&quot;, [EnigmailMsgRead.getAttachmentName(origAtt)]) + &quot;\n\n&quot; + message);</span>
<a href="#l1.2086"></a><span id="l1.2086" class="difflineplus">+    });</span>
<a href="#l1.2087"></a><span id="l1.2087" class="difflineplus">+    promise.catch(function(err) {</span>
<a href="#l1.2088"></a><span id="l1.2088" class="difflineplus">+      EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;signature.verifyFailed&quot;, [EnigmailMsgRead.getAttachmentName(origAtt)]) + &quot;\n\n&quot; +</span>
<a href="#l1.2089"></a><span id="l1.2089" class="difflineplus">+        err);</span>
<a href="#l1.2090"></a><span id="l1.2090" class="difflineplus">+    });</span>
<a href="#l1.2091"></a><span id="l1.2091" class="difflineplus">+</span>
<a href="#l1.2092"></a><span id="l1.2092" class="difflineplus">+    outFile1.remove(false);</span>
<a href="#l1.2093"></a><span id="l1.2093" class="difflineplus">+    outFile2.remove(false);</span>
<a href="#l1.2094"></a><span id="l1.2094" class="difflineplus">+  },</span>
<a href="#l1.2095"></a><span id="l1.2095" class="difflineplus">+</span>
<a href="#l1.2096"></a><span id="l1.2096" class="difflineplus">+  handleAttachment: function(actionType, anAttachment) {</span>
<a href="#l1.2097"></a><span id="l1.2097" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: handleAttachment: actionType=&quot; + actionType + &quot;, anAttachment(url)=&quot; + anAttachment.url + &quot;\n&quot;);</span>
<a href="#l1.2098"></a><span id="l1.2098" class="difflineplus">+</span>
<a href="#l1.2099"></a><span id="l1.2099" class="difflineplus">+    var argumentsObj = {</span>
<a href="#l1.2100"></a><span id="l1.2100" class="difflineplus">+      actionType: actionType,</span>
<a href="#l1.2101"></a><span id="l1.2101" class="difflineplus">+      attachment: anAttachment,</span>
<a href="#l1.2102"></a><span id="l1.2102" class="difflineplus">+      forceBrowser: false,</span>
<a href="#l1.2103"></a><span id="l1.2103" class="difflineplus">+      data: &quot;&quot;</span>
<a href="#l1.2104"></a><span id="l1.2104" class="difflineplus">+    };</span>
<a href="#l1.2105"></a><span id="l1.2105" class="difflineplus">+</span>
<a href="#l1.2106"></a><span id="l1.2106" class="difflineplus">+    var f = function _cb(data) {</span>
<a href="#l1.2107"></a><span id="l1.2107" class="difflineplus">+      argumentsObj.data = data;</span>
<a href="#l1.2108"></a><span id="l1.2108" class="difflineplus">+      Enigmail.msg.decryptAttachmentCallback([argumentsObj]);</span>
<a href="#l1.2109"></a><span id="l1.2109" class="difflineplus">+    };</span>
<a href="#l1.2110"></a><span id="l1.2110" class="difflineplus">+</span>
<a href="#l1.2111"></a><span id="l1.2111" class="difflineplus">+    var bufferListener = EnigmailStreams.newStringStreamListener(f);</span>
<a href="#l1.2112"></a><span id="l1.2112" class="difflineplus">+    var ioServ = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l1.2113"></a><span id="l1.2113" class="difflineplus">+    var msgUri = ioServ.newURI(argumentsObj.attachment.url, null, null);</span>
<a href="#l1.2114"></a><span id="l1.2114" class="difflineplus">+</span>
<a href="#l1.2115"></a><span id="l1.2115" class="difflineplus">+    var channel = EnigmailStreams.createChannel(msgUri);</span>
<a href="#l1.2116"></a><span id="l1.2116" class="difflineplus">+    channel.asyncOpen(bufferListener, msgUri);</span>
<a href="#l1.2117"></a><span id="l1.2117" class="difflineplus">+  },</span>
<a href="#l1.2118"></a><span id="l1.2118" class="difflineplus">+</span>
<a href="#l1.2119"></a><span id="l1.2119" class="difflineplus">+  setAttachmentName: function(attachment, newLabel, index) {</span>
<a href="#l1.2120"></a><span id="l1.2120" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: setAttachmentName (&quot; + newLabel + &quot;):\n&quot;);</span>
<a href="#l1.2121"></a><span id="l1.2121" class="difflineplus">+</span>
<a href="#l1.2122"></a><span id="l1.2122" class="difflineplus">+    var attList = document.getElementById(&quot;attachmentList&quot;);</span>
<a href="#l1.2123"></a><span id="l1.2123" class="difflineplus">+    if (attList) {</span>
<a href="#l1.2124"></a><span id="l1.2124" class="difflineplus">+      var attNode = attList.firstChild;</span>
<a href="#l1.2125"></a><span id="l1.2125" class="difflineplus">+      while (attNode) {</span>
<a href="#l1.2126"></a><span id="l1.2126" class="difflineplus">+        if (attNode.getAttribute(&quot;name&quot;) == attachment.name) {</span>
<a href="#l1.2127"></a><span id="l1.2127" class="difflineplus">+          attNode.setAttribute(&quot;name&quot;, newLabel);</span>
<a href="#l1.2128"></a><span id="l1.2128" class="difflineplus">+        }</span>
<a href="#l1.2129"></a><span id="l1.2129" class="difflineplus">+        attNode = attNode.nextSibling;</span>
<a href="#l1.2130"></a><span id="l1.2130" class="difflineplus">+      }</span>
<a href="#l1.2131"></a><span id="l1.2131" class="difflineplus">+    }</span>
<a href="#l1.2132"></a><span id="l1.2132" class="difflineplus">+</span>
<a href="#l1.2133"></a><span id="l1.2133" class="difflineplus">+    if (typeof(attachment.displayName) == &quot;undefined&quot;) {</span>
<a href="#l1.2134"></a><span id="l1.2134" class="difflineplus">+      attachment.name = newLabel;</span>
<a href="#l1.2135"></a><span id="l1.2135" class="difflineplus">+    }</span>
<a href="#l1.2136"></a><span id="l1.2136" class="difflineplus">+    else {</span>
<a href="#l1.2137"></a><span id="l1.2137" class="difflineplus">+      attachment.displayName = newLabel;</span>
<a href="#l1.2138"></a><span id="l1.2138" class="difflineplus">+    }</span>
<a href="#l1.2139"></a><span id="l1.2139" class="difflineplus">+</span>
<a href="#l1.2140"></a><span id="l1.2140" class="difflineplus">+    if (index &amp;&amp; index.length &gt; 0) {</span>
<a href="#l1.2141"></a><span id="l1.2141" class="difflineplus">+      this.revealAttachments(parseInt(index, 10) + 1);</span>
<a href="#l1.2142"></a><span id="l1.2142" class="difflineplus">+    }</span>
<a href="#l1.2143"></a><span id="l1.2143" class="difflineplus">+  },</span>
<a href="#l1.2144"></a><span id="l1.2144" class="difflineplus">+</span>
<a href="#l1.2145"></a><span id="l1.2145" class="difflineplus">+  decryptAttachmentCallback: function(cbArray) {</span>
<a href="#l1.2146"></a><span id="l1.2146" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: decryptAttachmentCallback:\n&quot;);</span>
<a href="#l1.2147"></a><span id="l1.2147" class="difflineplus">+</span>
<a href="#l1.2148"></a><span id="l1.2148" class="difflineplus">+    var callbackArg = cbArray[0];</span>
<a href="#l1.2149"></a><span id="l1.2149" class="difflineplus">+</span>
<a href="#l1.2150"></a><span id="l1.2150" class="difflineplus">+    var exitCodeObj = {};</span>
<a href="#l1.2151"></a><span id="l1.2151" class="difflineplus">+    var statusFlagsObj = {};</span>
<a href="#l1.2152"></a><span id="l1.2152" class="difflineplus">+    var errorMsgObj = {};</span>
<a href="#l1.2153"></a><span id="l1.2153" class="difflineplus">+    var exitStatus = -1;</span>
<a href="#l1.2154"></a><span id="l1.2154" class="difflineplus">+</span>
<a href="#l1.2155"></a><span id="l1.2155" class="difflineplus">+    var enigmailSvc = Enigmail.getEnigmailSvc();</span>
<a href="#l1.2156"></a><span id="l1.2156" class="difflineplus">+    var outFile;</span>
<a href="#l1.2157"></a><span id="l1.2157" class="difflineplus">+    var origFilename;</span>
<a href="#l1.2158"></a><span id="l1.2158" class="difflineplus">+    var rawFileName = EnigmailMsgRead.getAttachmentName(callbackArg.attachment).replace(/\.(asc|pgp|gpg)$/i, &quot;&quot;);</span>
<a href="#l1.2159"></a><span id="l1.2159" class="difflineplus">+</span>
<a href="#l1.2160"></a><span id="l1.2160" class="difflineplus">+    if (callbackArg.actionType != &quot;importKey&quot;) {</span>
<a href="#l1.2161"></a><span id="l1.2161" class="difflineplus">+      origFilename = EnigmailAttachment.getFileName(window, callbackArg.data);</span>
<a href="#l1.2162"></a><span id="l1.2162" class="difflineplus">+      if (origFilename &amp;&amp; origFilename.length &gt; rawFileName.length) {</span>
<a href="#l1.2163"></a><span id="l1.2163" class="difflineplus">+        rawFileName = origFilename;</span>
<a href="#l1.2164"></a><span id="l1.2164" class="difflineplus">+      }</span>
<a href="#l1.2165"></a><span id="l1.2165" class="difflineplus">+    }</span>
<a href="#l1.2166"></a><span id="l1.2166" class="difflineplus">+</span>
<a href="#l1.2167"></a><span id="l1.2167" class="difflineplus">+    if (callbackArg.actionType == &quot;saveAttachment&quot;) {</span>
<a href="#l1.2168"></a><span id="l1.2168" class="difflineplus">+      outFile = EnigmailDialog.filePicker(window, EnigmailLocale.getString(&quot;saveAttachmentHeader&quot;),</span>
<a href="#l1.2169"></a><span id="l1.2169" class="difflineplus">+        Enigmail.msg.lastSaveDir, true, &quot;&quot;,</span>
<a href="#l1.2170"></a><span id="l1.2170" class="difflineplus">+        rawFileName, null);</span>
<a href="#l1.2171"></a><span id="l1.2171" class="difflineplus">+      if (!outFile) {</span>
<a href="#l1.2172"></a><span id="l1.2172" class="difflineplus">+        return;</span>
<a href="#l1.2173"></a><span id="l1.2173" class="difflineplus">+      }</span>
<a href="#l1.2174"></a><span id="l1.2174" class="difflineplus">+    }</span>
<a href="#l1.2175"></a><span id="l1.2175" class="difflineplus">+    else if (callbackArg.actionType.substr(0, 10) == &quot;revealName&quot;) {</span>
<a href="#l1.2176"></a><span id="l1.2176" class="difflineplus">+      if (origFilename &amp;&amp; origFilename.length &gt; 0) {</span>
<a href="#l1.2177"></a><span id="l1.2177" class="difflineplus">+        Enigmail.msg.setAttachmentName(callbackArg.attachment, origFilename + &quot;.pgp&quot;, callbackArg.actionType.substr(11, 10));</span>
<a href="#l1.2178"></a><span id="l1.2178" class="difflineplus">+      }</span>
<a href="#l1.2179"></a><span id="l1.2179" class="difflineplus">+      Enigmail.msg.setAttachmentReveal(null);</span>
<a href="#l1.2180"></a><span id="l1.2180" class="difflineplus">+      return;</span>
<a href="#l1.2181"></a><span id="l1.2181" class="difflineplus">+    }</span>
<a href="#l1.2182"></a><span id="l1.2182" class="difflineplus">+    else {</span>
<a href="#l1.2183"></a><span id="l1.2183" class="difflineplus">+      // open</span>
<a href="#l1.2184"></a><span id="l1.2184" class="difflineplus">+      var tmpDir = EnigmailFiles.getTempDir();</span>
<a href="#l1.2185"></a><span id="l1.2185" class="difflineplus">+      try {</span>
<a href="#l1.2186"></a><span id="l1.2186" class="difflineplus">+        outFile = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l1.2187"></a><span id="l1.2187" class="difflineplus">+        outFile.initWithPath(tmpDir);</span>
<a href="#l1.2188"></a><span id="l1.2188" class="difflineplus">+        if (!(outFile.isDirectory() &amp;&amp; outFile.isWritable())) {</span>
<a href="#l1.2189"></a><span id="l1.2189" class="difflineplus">+          errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l1.2190"></a><span id="l1.2190" class="difflineplus">+          return;</span>
<a href="#l1.2191"></a><span id="l1.2191" class="difflineplus">+        }</span>
<a href="#l1.2192"></a><span id="l1.2192" class="difflineplus">+        outFile.append(rawFileName);</span>
<a href="#l1.2193"></a><span id="l1.2193" class="difflineplus">+        outFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l1.2194"></a><span id="l1.2194" class="difflineplus">+      }</span>
<a href="#l1.2195"></a><span id="l1.2195" class="difflineplus">+      catch (ex) {</span>
<a href="#l1.2196"></a><span id="l1.2196" class="difflineplus">+        errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l1.2197"></a><span id="l1.2197" class="difflineplus">+        return;</span>
<a href="#l1.2198"></a><span id="l1.2198" class="difflineplus">+      }</span>
<a href="#l1.2199"></a><span id="l1.2199" class="difflineplus">+    }</span>
<a href="#l1.2200"></a><span id="l1.2200" class="difflineplus">+</span>
<a href="#l1.2201"></a><span id="l1.2201" class="difflineplus">+    if (callbackArg.actionType == &quot;importKey&quot;) {</span>
<a href="#l1.2202"></a><span id="l1.2202" class="difflineplus">+      var preview = EnigmailKey.getKeyListFromKeyBlock(callbackArg.data, errorMsgObj);</span>
<a href="#l1.2203"></a><span id="l1.2203" class="difflineplus">+</span>
<a href="#l1.2204"></a><span id="l1.2204" class="difflineplus">+      if (errorMsgObj.value !== &quot;&quot; || preview.length === 0) {</span>
<a href="#l1.2205"></a><span id="l1.2205" class="difflineplus">+        // try decrypting the attachment</span>
<a href="#l1.2206"></a><span id="l1.2206" class="difflineplus">+        exitStatus = EnigmailDecryption.decryptAttachment(window, outFile,</span>
<a href="#l1.2207"></a><span id="l1.2207" class="difflineplus">+          EnigmailMsgRead.getAttachmentName(callbackArg.attachment),</span>
<a href="#l1.2208"></a><span id="l1.2208" class="difflineplus">+          callbackArg.data,</span>
<a href="#l1.2209"></a><span id="l1.2209" class="difflineplus">+          exitCodeObj, statusFlagsObj,</span>
<a href="#l1.2210"></a><span id="l1.2210" class="difflineplus">+          errorMsgObj);</span>
<a href="#l1.2211"></a><span id="l1.2211" class="difflineplus">+        if ((exitStatus) &amp;&amp; exitCodeObj.value === 0) {</span>
<a href="#l1.2212"></a><span id="l1.2212" class="difflineplus">+          // success decrypting, let's try again</span>
<a href="#l1.2213"></a><span id="l1.2213" class="difflineplus">+          callbackArg.data = EnigmailFiles.readBinaryFile(outFile);</span>
<a href="#l1.2214"></a><span id="l1.2214" class="difflineplus">+          preview = EnigmailKey.getKeyListFromKeyBlock(callbackArg.data, errorMsgObj);</span>
<a href="#l1.2215"></a><span id="l1.2215" class="difflineplus">+        }</span>
<a href="#l1.2216"></a><span id="l1.2216" class="difflineplus">+      }</span>
<a href="#l1.2217"></a><span id="l1.2217" class="difflineplus">+</span>
<a href="#l1.2218"></a><span id="l1.2218" class="difflineplus">+      if (errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l1.2219"></a><span id="l1.2219" class="difflineplus">+        this.importKeyDataWithConfirmation(preview, callbackArg.data);</span>
<a href="#l1.2220"></a><span id="l1.2220" class="difflineplus">+      }</span>
<a href="#l1.2221"></a><span id="l1.2221" class="difflineplus">+      else {</span>
<a href="#l1.2222"></a><span id="l1.2222" class="difflineplus">+        EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;previewFailed&quot;) + &quot;\n&quot; + errorMsgObj.value);</span>
<a href="#l1.2223"></a><span id="l1.2223" class="difflineplus">+      }</span>
<a href="#l1.2224"></a><span id="l1.2224" class="difflineplus">+      outFile.remove(true);</span>
<a href="#l1.2225"></a><span id="l1.2225" class="difflineplus">+      return;</span>
<a href="#l1.2226"></a><span id="l1.2226" class="difflineplus">+    }</span>
<a href="#l1.2227"></a><span id="l1.2227" class="difflineplus">+</span>
<a href="#l1.2228"></a><span id="l1.2228" class="difflineplus">+    exitStatus = EnigmailDecryption.decryptAttachment(window, outFile,</span>
<a href="#l1.2229"></a><span id="l1.2229" class="difflineplus">+      EnigmailMsgRead.getAttachmentName(callbackArg.attachment),</span>
<a href="#l1.2230"></a><span id="l1.2230" class="difflineplus">+      callbackArg.data,</span>
<a href="#l1.2231"></a><span id="l1.2231" class="difflineplus">+      exitCodeObj, statusFlagsObj,</span>
<a href="#l1.2232"></a><span id="l1.2232" class="difflineplus">+      errorMsgObj);</span>
<a href="#l1.2233"></a><span id="l1.2233" class="difflineplus">+</span>
<a href="#l1.2234"></a><span id="l1.2234" class="difflineplus">+    if ((!exitStatus) || exitCodeObj.value !== 0) {</span>
<a href="#l1.2235"></a><span id="l1.2235" class="difflineplus">+      exitStatus = false;</span>
<a href="#l1.2236"></a><span id="l1.2236" class="difflineplus">+      if ((statusFlagsObj.value &amp; EnigmailConstants.DECRYPTION_OKAY) &amp;&amp;</span>
<a href="#l1.2237"></a><span id="l1.2237" class="difflineplus">+        (statusFlagsObj.value &amp; EnigmailConstants.UNVERIFIED_SIGNATURE)) {</span>
<a href="#l1.2238"></a><span id="l1.2238" class="difflineplus">+</span>
<a href="#l1.2239"></a><span id="l1.2239" class="difflineplus">+        if (callbackArg.actionType == &quot;openAttachment&quot;) {</span>
<a href="#l1.2240"></a><span id="l1.2240" class="difflineplus">+          exitStatus = EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;decryptOkNoSig&quot;), EnigmailLocale.getString(&quot;msgOvl.button.contAnyway&quot;));</span>
<a href="#l1.2241"></a><span id="l1.2241" class="difflineplus">+        }</span>
<a href="#l1.2242"></a><span id="l1.2242" class="difflineplus">+        else {</span>
<a href="#l1.2243"></a><span id="l1.2243" class="difflineplus">+          EnigmailDialog.info(window, EnigmailLocale.getString(&quot;decryptOkNoSig&quot;));</span>
<a href="#l1.2244"></a><span id="l1.2244" class="difflineplus">+        }</span>
<a href="#l1.2245"></a><span id="l1.2245" class="difflineplus">+      }</span>
<a href="#l1.2246"></a><span id="l1.2246" class="difflineplus">+      else {</span>
<a href="#l1.2247"></a><span id="l1.2247" class="difflineplus">+        EnigmailDialog.info(window, EnigmailLocale.getString(&quot;failedDecrypt&quot;) + &quot;\n\n&quot; + errorMsgObj.value);</span>
<a href="#l1.2248"></a><span id="l1.2248" class="difflineplus">+        exitStatus = false;</span>
<a href="#l1.2249"></a><span id="l1.2249" class="difflineplus">+      }</span>
<a href="#l1.2250"></a><span id="l1.2250" class="difflineplus">+    }</span>
<a href="#l1.2251"></a><span id="l1.2251" class="difflineplus">+    if (exitStatus) {</span>
<a href="#l1.2252"></a><span id="l1.2252" class="difflineplus">+      if (statusFlagsObj.value &amp; EnigmailConstants.IMPORTED_KEY) {</span>
<a href="#l1.2253"></a><span id="l1.2253" class="difflineplus">+</span>
<a href="#l1.2254"></a><span id="l1.2254" class="difflineplus">+        if (exitCodeObj.keyList) {</span>
<a href="#l1.2255"></a><span id="l1.2255" class="difflineplus">+          let importKeyList = exitCodeObj.keyList.map(function(a) {</span>
<a href="#l1.2256"></a><span id="l1.2256" class="difflineplus">+            return a.id;</span>
<a href="#l1.2257"></a><span id="l1.2257" class="difflineplus">+          });</span>
<a href="#l1.2258"></a><span id="l1.2258" class="difflineplus">+          EnigmailDialog.keyImportDlg(window, importKeyList);</span>
<a href="#l1.2259"></a><span id="l1.2259" class="difflineplus">+        }</span>
<a href="#l1.2260"></a><span id="l1.2260" class="difflineplus">+      }</span>
<a href="#l1.2261"></a><span id="l1.2261" class="difflineplus">+      else if (statusFlagsObj.value &amp; EnigmailConstants.DISPLAY_MESSAGE) {</span>
<a href="#l1.2262"></a><span id="l1.2262" class="difflineplus">+        HandleSelectedAttachments('open');</span>
<a href="#l1.2263"></a><span id="l1.2263" class="difflineplus">+      }</span>
<a href="#l1.2264"></a><span id="l1.2264" class="difflineplus">+      else if ((statusFlagsObj.value &amp; EnigmailConstants.DISPLAY_MESSAGE) ||</span>
<a href="#l1.2265"></a><span id="l1.2265" class="difflineplus">+        (callbackArg.actionType == &quot;openAttachment&quot;)) {</span>
<a href="#l1.2266"></a><span id="l1.2266" class="difflineplus">+        var ioServ = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l1.2267"></a><span id="l1.2267" class="difflineplus">+        var outFileUri = ioServ.newFileURI(outFile);</span>
<a href="#l1.2268"></a><span id="l1.2268" class="difflineplus">+        var fileExt = outFile.leafName.replace(/(.*\.)(\w+)$/, &quot;$2&quot;);</span>
<a href="#l1.2269"></a><span id="l1.2269" class="difflineplus">+        if (fileExt &amp;&amp; !callbackArg.forceBrowser) {</span>
<a href="#l1.2270"></a><span id="l1.2270" class="difflineplus">+          var extAppLauncher = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsPIExternalAppLauncher);</span>
<a href="#l1.2271"></a><span id="l1.2271" class="difflineplus">+          extAppLauncher.deleteTemporaryFileOnExit(outFile);</span>
<a href="#l1.2272"></a><span id="l1.2272" class="difflineplus">+</span>
<a href="#l1.2273"></a><span id="l1.2273" class="difflineplus">+          try {</span>
<a href="#l1.2274"></a><span id="l1.2274" class="difflineplus">+            var mimeService = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsIMIMEService);</span>
<a href="#l1.2275"></a><span id="l1.2275" class="difflineplus">+            var fileMimeType = mimeService.getTypeFromFile(outFile);</span>
<a href="#l1.2276"></a><span id="l1.2276" class="difflineplus">+            var fileMimeInfo = mimeService.getFromTypeAndExtension(fileMimeType, fileExt);</span>
<a href="#l1.2277"></a><span id="l1.2277" class="difflineplus">+</span>
<a href="#l1.2278"></a><span id="l1.2278" class="difflineplus">+            fileMimeInfo.launchWithFile(outFile);</span>
<a href="#l1.2279"></a><span id="l1.2279" class="difflineplus">+          }</span>
<a href="#l1.2280"></a><span id="l1.2280" class="difflineplus">+          catch (ex) {</span>
<a href="#l1.2281"></a><span id="l1.2281" class="difflineplus">+            // if the attachment file type is unknown, an exception is thrown,</span>
<a href="#l1.2282"></a><span id="l1.2282" class="difflineplus">+            // so let it be handled by a browser window</span>
<a href="#l1.2283"></a><span id="l1.2283" class="difflineplus">+            Enigmail.msg.loadExternalURL(outFileUri.asciiSpec);</span>
<a href="#l1.2284"></a><span id="l1.2284" class="difflineplus">+          }</span>
<a href="#l1.2285"></a><span id="l1.2285" class="difflineplus">+        }</span>
<a href="#l1.2286"></a><span id="l1.2286" class="difflineplus">+        else {</span>
<a href="#l1.2287"></a><span id="l1.2287" class="difflineplus">+          // open the attachment using an external application</span>
<a href="#l1.2288"></a><span id="l1.2288" class="difflineplus">+          Enigmail.msg.loadExternalURL(outFileUri.asciiSpec);</span>
<a href="#l1.2289"></a><span id="l1.2289" class="difflineplus">+        }</span>
<a href="#l1.2290"></a><span id="l1.2290" class="difflineplus">+      }</span>
<a href="#l1.2291"></a><span id="l1.2291" class="difflineplus">+    }</span>
<a href="#l1.2292"></a><span id="l1.2292" class="difflineplus">+  },</span>
<a href="#l1.2293"></a><span id="l1.2293" class="difflineplus">+</span>
<a href="#l1.2294"></a><span id="l1.2294" class="difflineplus">+  loadExternalURL: function(url) {</span>
<a href="#l1.2295"></a><span id="l1.2295" class="difflineplus">+    messenger.launchExternalURL(url);</span>
<a href="#l1.2296"></a><span id="l1.2296" class="difflineplus">+  },</span>
<a href="#l1.2297"></a><span id="l1.2297" class="difflineplus">+</span>
<a href="#l1.2298"></a><span id="l1.2298" class="difflineplus">+  // retrieves the most recent navigator window (opens one if need be)</span>
<a href="#l1.2299"></a><span id="l1.2299" class="difflineplus">+  loadURLInNavigatorWindow: function(url, aOpenFlag) {</span>
<a href="#l1.2300"></a><span id="l1.2300" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: loadURLInNavigatorWindow: &quot; + url + &quot;, &quot; + aOpenFlag + &quot;\n&quot;);</span>
<a href="#l1.2301"></a><span id="l1.2301" class="difflineplus">+</span>
<a href="#l1.2302"></a><span id="l1.2302" class="difflineplus">+    var navWindow;</span>
<a href="#l1.2303"></a><span id="l1.2303" class="difflineplus">+</span>
<a href="#l1.2304"></a><span id="l1.2304" class="difflineplus">+    // if this is a browser window, just use it</span>
<a href="#l1.2305"></a><span id="l1.2305" class="difflineplus">+    if (&quot;document&quot; in top) {</span>
<a href="#l1.2306"></a><span id="l1.2306" class="difflineplus">+      var possibleNavigator = top.document.getElementById(&quot;main-window&quot;);</span>
<a href="#l1.2307"></a><span id="l1.2307" class="difflineplus">+      if (possibleNavigator &amp;&amp;</span>
<a href="#l1.2308"></a><span id="l1.2308" class="difflineplus">+        possibleNavigator.getAttribute(&quot;windowtype&quot;) == &quot;navigator:browser&quot;) {</span>
<a href="#l1.2309"></a><span id="l1.2309" class="difflineplus">+        navWindow = top;</span>
<a href="#l1.2310"></a><span id="l1.2310" class="difflineplus">+      }</span>
<a href="#l1.2311"></a><span id="l1.2311" class="difflineplus">+    }</span>
<a href="#l1.2312"></a><span id="l1.2312" class="difflineplus">+</span>
<a href="#l1.2313"></a><span id="l1.2313" class="difflineplus">+    // if not, get the most recently used browser window</span>
<a href="#l1.2314"></a><span id="l1.2314" class="difflineplus">+    if (!navWindow) {</span>
<a href="#l1.2315"></a><span id="l1.2315" class="difflineplus">+      var wm;</span>
<a href="#l1.2316"></a><span id="l1.2316" class="difflineplus">+      wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].getService(</span>
<a href="#l1.2317"></a><span id="l1.2317" class="difflineplus">+        Ci.nsIWindowMediator);</span>
<a href="#l1.2318"></a><span id="l1.2318" class="difflineplus">+      navWindow = wm.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l1.2319"></a><span id="l1.2319" class="difflineplus">+    }</span>
<a href="#l1.2320"></a><span id="l1.2320" class="difflineplus">+</span>
<a href="#l1.2321"></a><span id="l1.2321" class="difflineplus">+    if (navWindow) {</span>
<a href="#l1.2322"></a><span id="l1.2322" class="difflineplus">+</span>
<a href="#l1.2323"></a><span id="l1.2323" class="difflineplus">+      if (&quot;loadURI&quot; in navWindow) {</span>
<a href="#l1.2324"></a><span id="l1.2324" class="difflineplus">+        navWindow.loadURI(url);</span>
<a href="#l1.2325"></a><span id="l1.2325" class="difflineplus">+      }</span>
<a href="#l1.2326"></a><span id="l1.2326" class="difflineplus">+      else {</span>
<a href="#l1.2327"></a><span id="l1.2327" class="difflineplus">+        navWindow._content.location.href = url;</span>
<a href="#l1.2328"></a><span id="l1.2328" class="difflineplus">+      }</span>
<a href="#l1.2329"></a><span id="l1.2329" class="difflineplus">+</span>
<a href="#l1.2330"></a><span id="l1.2330" class="difflineplus">+    }</span>
<a href="#l1.2331"></a><span id="l1.2331" class="difflineplus">+    else if (aOpenFlag) {</span>
<a href="#l1.2332"></a><span id="l1.2332" class="difflineplus">+      // if no browser window available and it's ok to open a new one, do so</span>
<a href="#l1.2333"></a><span id="l1.2333" class="difflineplus">+      navWindow = window.open(url, &quot;Enigmail&quot;);</span>
<a href="#l1.2334"></a><span id="l1.2334" class="difflineplus">+    }</span>
<a href="#l1.2335"></a><span id="l1.2335" class="difflineplus">+</span>
<a href="#l1.2336"></a><span id="l1.2336" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: loadURLInNavigatorWindow: navWindow=&quot; + navWindow + &quot;\n&quot;);</span>
<a href="#l1.2337"></a><span id="l1.2337" class="difflineplus">+</span>
<a href="#l1.2338"></a><span id="l1.2338" class="difflineplus">+    return navWindow;</span>
<a href="#l1.2339"></a><span id="l1.2339" class="difflineplus">+  },</span>
<a href="#l1.2340"></a><span id="l1.2340" class="difflineplus">+</span>
<a href="#l1.2341"></a><span id="l1.2341" class="difflineplus">+  // handle double click events on Attachments</span>
<a href="#l1.2342"></a><span id="l1.2342" class="difflineplus">+  attachmentListClick: function(elementId, event) {</span>
<a href="#l1.2343"></a><span id="l1.2343" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: attachmentListClick: event=&quot; + event + &quot;\n&quot;);</span>
<a href="#l1.2344"></a><span id="l1.2344" class="difflineplus">+</span>
<a href="#l1.2345"></a><span id="l1.2345" class="difflineplus">+    var attachment = event.target.attachment;</span>
<a href="#l1.2346"></a><span id="l1.2346" class="difflineplus">+    if (this.checkEncryptedAttach(attachment)) {</span>
<a href="#l1.2347"></a><span id="l1.2347" class="difflineplus">+      if (event.button === 0 &amp;&amp; event.detail == 2) { // double click</span>
<a href="#l1.2348"></a><span id="l1.2348" class="difflineplus">+        this.handleAttachment(&quot;openAttachment&quot;, attachment);</span>
<a href="#l1.2349"></a><span id="l1.2349" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l1.2350"></a><span id="l1.2350" class="difflineplus">+      }</span>
<a href="#l1.2351"></a><span id="l1.2351" class="difflineplus">+    }</span>
<a href="#l1.2352"></a><span id="l1.2352" class="difflineplus">+  },</span>
<a href="#l1.2353"></a><span id="l1.2353" class="difflineplus">+</span>
<a href="#l1.2354"></a><span id="l1.2354" class="difflineplus">+  // create a decrypted copy of all selected messages in a target folder</span>
<a href="#l1.2355"></a><span id="l1.2355" class="difflineplus">+</span>
<a href="#l1.2356"></a><span id="l1.2356" class="difflineplus">+  decryptToFolder: function(destFolder) {</span>
<a href="#l1.2357"></a><span id="l1.2357" class="difflineplus">+    let msgHdrs = gFolderDisplay ? gFolderDisplay.selectedMessages : null;</span>
<a href="#l1.2358"></a><span id="l1.2358" class="difflineplus">+    if (!msgHdrs || msgHdrs.length === 0) {</span>
<a href="#l1.2359"></a><span id="l1.2359" class="difflineplus">+      return;</span>
<a href="#l1.2360"></a><span id="l1.2360" class="difflineplus">+    }</span>
<a href="#l1.2361"></a><span id="l1.2361" class="difflineplus">+</span>
<a href="#l1.2362"></a><span id="l1.2362" class="difflineplus">+    EnigmailPersistentCrypto.dispatchMessages(msgHdrs, destFolder.URI, false, false);</span>
<a href="#l1.2363"></a><span id="l1.2363" class="difflineplus">+  },</span>
<a href="#l1.2364"></a><span id="l1.2364" class="difflineplus">+</span>
<a href="#l1.2365"></a><span id="l1.2365" class="difflineplus">+  importAttachedKeys: function() {</span>
<a href="#l1.2366"></a><span id="l1.2366" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: importAttachedKeys\n&quot;);</span>
<a href="#l1.2367"></a><span id="l1.2367" class="difflineplus">+</span>
<a href="#l1.2368"></a><span id="l1.2368" class="difflineplus">+    let keyFound = false;</span>
<a href="#l1.2369"></a><span id="l1.2369" class="difflineplus">+</span>
<a href="#l1.2370"></a><span id="l1.2370" class="difflineplus">+    for (let i in currentAttachments) {</span>
<a href="#l1.2371"></a><span id="l1.2371" class="difflineplus">+      if (currentAttachments[i].contentType.search(/application\/pgp-keys/i) &gt;= 0 ||</span>
<a href="#l1.2372"></a><span id="l1.2372" class="difflineplus">+        EnigmailMsgRead.getAttachmentName(currentAttachments[i]).match(/\.asc\.(gpg|pgp)$/i)) {</span>
<a href="#l1.2373"></a><span id="l1.2373" class="difflineplus">+        // found attached key</span>
<a href="#l1.2374"></a><span id="l1.2374" class="difflineplus">+        this.handleAttachment(&quot;importKey&quot;, currentAttachments[i]);</span>
<a href="#l1.2375"></a><span id="l1.2375" class="difflineplus">+        keyFound = true;</span>
<a href="#l1.2376"></a><span id="l1.2376" class="difflineplus">+      }</span>
<a href="#l1.2377"></a><span id="l1.2377" class="difflineplus">+    }</span>
<a href="#l1.2378"></a><span id="l1.2378" class="difflineplus">+</span>
<a href="#l1.2379"></a><span id="l1.2379" class="difflineplus">+    return keyFound;</span>
<a href="#l1.2380"></a><span id="l1.2380" class="difflineplus">+  },</span>
<a href="#l1.2381"></a><span id="l1.2381" class="difflineplus">+</span>
<a href="#l1.2382"></a><span id="l1.2382" class="difflineplus">+  importKeyFromKeyserver: function() {</span>
<a href="#l1.2383"></a><span id="l1.2383" class="difflineplus">+    var pubKeyId = &quot;0x&quot; + Enigmail.msg.securityInfo.keyId;</span>
<a href="#l1.2384"></a><span id="l1.2384" class="difflineplus">+    var inputObj = {</span>
<a href="#l1.2385"></a><span id="l1.2385" class="difflineplus">+      searchList: [pubKeyId],</span>
<a href="#l1.2386"></a><span id="l1.2386" class="difflineplus">+      autoKeyServer: EnigmailPrefs.getPref(&quot;autoKeyServerSelection&quot;) ? EnigmailPrefs.getPref(&quot;keyserver&quot;).split(/[ ,;]/g)[0] : null</span>
<a href="#l1.2387"></a><span id="l1.2387" class="difflineplus">+    };</span>
<a href="#l1.2388"></a><span id="l1.2388" class="difflineplus">+    var resultObj = {};</span>
<a href="#l1.2389"></a><span id="l1.2389" class="difflineplus">+    EnigmailWindows.downloadKeys(window, inputObj, resultObj);</span>
<a href="#l1.2390"></a><span id="l1.2390" class="difflineplus">+</span>
<a href="#l1.2391"></a><span id="l1.2391" class="difflineplus">+</span>
<a href="#l1.2392"></a><span id="l1.2392" class="difflineplus">+    if (resultObj.importedKeys &gt; 0) {</span>
<a href="#l1.2393"></a><span id="l1.2393" class="difflineplus">+      return true;</span>
<a href="#l1.2394"></a><span id="l1.2394" class="difflineplus">+    }</span>
<a href="#l1.2395"></a><span id="l1.2395" class="difflineplus">+</span>
<a href="#l1.2396"></a><span id="l1.2396" class="difflineplus">+    return false;</span>
<a href="#l1.2397"></a><span id="l1.2397" class="difflineplus">+  },</span>
<a href="#l1.2398"></a><span id="l1.2398" class="difflineplus">+</span>
<a href="#l1.2399"></a><span id="l1.2399" class="difflineplus">+  // download or import keys</span>
<a href="#l1.2400"></a><span id="l1.2400" class="difflineplus">+  handleUnknownKey: function() {</span>
<a href="#l1.2401"></a><span id="l1.2401" class="difflineplus">+    let imported = false;</span>
<a href="#l1.2402"></a><span id="l1.2402" class="difflineplus">+    // handline keys embedded in message body</span>
<a href="#l1.2403"></a><span id="l1.2403" class="difflineplus">+</span>
<a href="#l1.2404"></a><span id="l1.2404" class="difflineplus">+    if (Enigmail.msg.securityInfo.statusFlags &amp; EnigmailConstants.INLINE_KEY) {</span>
<a href="#l1.2405"></a><span id="l1.2405" class="difflineplus">+      //return Enigmail.msg.messageDecrypt(true, false);</span>
<a href="#l1.2406"></a><span id="l1.2406" class="difflineplus">+      return Enigmail.msg.messageImport();</span>
<a href="#l1.2407"></a><span id="l1.2407" class="difflineplus">+    }</span>
<a href="#l1.2408"></a><span id="l1.2408" class="difflineplus">+</span>
<a href="#l1.2409"></a><span id="l1.2409" class="difflineplus">+    imported = this.importAttachedKeys();</span>
<a href="#l1.2410"></a><span id="l1.2410" class="difflineplus">+    if (!imported) {</span>
<a href="#l1.2411"></a><span id="l1.2411" class="difflineplus">+      imported = this.importKeyFromKeyserver();</span>
<a href="#l1.2412"></a><span id="l1.2412" class="difflineplus">+    }</span>
<a href="#l1.2413"></a><span id="l1.2413" class="difflineplus">+</span>
<a href="#l1.2414"></a><span id="l1.2414" class="difflineplus">+    if (imported) {</span>
<a href="#l1.2415"></a><span id="l1.2415" class="difflineplus">+      this.messageReload(false);</span>
<a href="#l1.2416"></a><span id="l1.2416" class="difflineplus">+    }</span>
<a href="#l1.2417"></a><span id="l1.2417" class="difflineplus">+</span>
<a href="#l1.2418"></a><span id="l1.2418" class="difflineplus">+    return null;</span>
<a href="#l1.2419"></a><span id="l1.2419" class="difflineplus">+  },</span>
<a href="#l1.2420"></a><span id="l1.2420" class="difflineplus">+</span>
<a href="#l1.2421"></a><span id="l1.2421" class="difflineplus">+  /**</span>
<a href="#l1.2422"></a><span id="l1.2422" class="difflineplus">+   * Create an artificial Autocrypt: header if there was no such header on the message</span>
<a href="#l1.2423"></a><span id="l1.2423" class="difflineplus">+   * and the message was signed</span>
<a href="#l1.2424"></a><span id="l1.2424" class="difflineplus">+   */</span>
<a href="#l1.2425"></a><span id="l1.2425" class="difflineplus">+  createArtificialAutocryptHeader: function() {</span>
<a href="#l1.2426"></a><span id="l1.2426" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: createArtificialAutocryptHeader\n&quot;);</span>
<a href="#l1.2427"></a><span id="l1.2427" class="difflineplus">+</span>
<a href="#l1.2428"></a><span id="l1.2428" class="difflineplus">+    if (&quot;autocrypt&quot; in currentHeaderData) {</span>
<a href="#l1.2429"></a><span id="l1.2429" class="difflineplus">+      return;</span>
<a href="#l1.2430"></a><span id="l1.2430" class="difflineplus">+    }</span>
<a href="#l1.2431"></a><span id="l1.2431" class="difflineplus">+</span>
<a href="#l1.2432"></a><span id="l1.2432" class="difflineplus">+    let created = false;</span>
<a href="#l1.2433"></a><span id="l1.2433" class="difflineplus">+    let dateValue = &quot;&quot;,</span>
<a href="#l1.2434"></a><span id="l1.2434" class="difflineplus">+      fromValue = &quot;&quot;;</span>
<a href="#l1.2435"></a><span id="l1.2435" class="difflineplus">+</span>
<a href="#l1.2436"></a><span id="l1.2436" class="difflineplus">+    if (&quot;date&quot; in currentHeaderData) {</span>
<a href="#l1.2437"></a><span id="l1.2437" class="difflineplus">+      dateValue = currentHeaderData.date.headerValue;</span>
<a href="#l1.2438"></a><span id="l1.2438" class="difflineplus">+    }</span>
<a href="#l1.2439"></a><span id="l1.2439" class="difflineplus">+    if (&quot;from&quot; in currentHeaderData) {</span>
<a href="#l1.2440"></a><span id="l1.2440" class="difflineplus">+      fromValue = currentHeaderData.from.headerValue;</span>
<a href="#l1.2441"></a><span id="l1.2441" class="difflineplus">+    }</span>
<a href="#l1.2442"></a><span id="l1.2442" class="difflineplus">+</span>
<a href="#l1.2443"></a><span id="l1.2443" class="difflineplus">+    if (Enigmail.msg.securityInfo &amp;&amp; Enigmail.msg.securityInfo.statusFlags) {</span>
<a href="#l1.2444"></a><span id="l1.2444" class="difflineplus">+      let securityInfo = Enigmail.msg.securityInfo;</span>
<a href="#l1.2445"></a><span id="l1.2445" class="difflineplus">+      let keyObj = EnigmailKeyRing.getKeyById(securityInfo.keyId);</span>
<a href="#l1.2446"></a><span id="l1.2446" class="difflineplus">+      if (keyObj &amp;&amp; keyObj.getEncryptionValidity().keyValid) {</span>
<a href="#l1.2447"></a><span id="l1.2447" class="difflineplus">+        if (securityInfo.statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE) {</span>
<a href="#l1.2448"></a><span id="l1.2448" class="difflineplus">+          let hdrData = &quot;addr=&quot; + EnigmailFuncs.stripEmail(fromValue) +</span>
<a href="#l1.2449"></a><span id="l1.2449" class="difflineplus">+            ((securityInfo.statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY) ||</span>
<a href="#l1.2450"></a><span id="l1.2450" class="difflineplus">+              (securityInfo.statusFlags &amp; EnigmailConstants.PGP_MIME_ENCRYPTED) ? &quot;; prefer-encrypt=mutual&quot; : &quot;&quot;) +</span>
<a href="#l1.2451"></a><span id="l1.2451" class="difflineplus">+            &quot;; _enigmail_artificial=yes; _enigmail_fpr=&quot; + keyObj.fpr + '; keydata=&quot;LQ==&quot;';</span>
<a href="#l1.2452"></a><span id="l1.2452" class="difflineplus">+</span>
<a href="#l1.2453"></a><span id="l1.2453" class="difflineplus">+          created = true;</span>
<a href="#l1.2454"></a><span id="l1.2454" class="difflineplus">+</span>
<a href="#l1.2455"></a><span id="l1.2455" class="difflineplus">+          EnigmailAutocrypt.processAutocryptHeader(fromValue, [hdrData], dateValue,</span>
<a href="#l1.2456"></a><span id="l1.2456" class="difflineplus">+            Enigmail.msg.isAutocryptEnabled());</span>
<a href="#l1.2457"></a><span id="l1.2457" class="difflineplus">+        }</span>
<a href="#l1.2458"></a><span id="l1.2458" class="difflineplus">+      }</span>
<a href="#l1.2459"></a><span id="l1.2459" class="difflineplus">+    }</span>
<a href="#l1.2460"></a><span id="l1.2460" class="difflineplus">+</span>
<a href="#l1.2461"></a><span id="l1.2461" class="difflineplus">+    if (!created) {</span>
<a href="#l1.2462"></a><span id="l1.2462" class="difflineplus">+      let hdrData = &quot;addr=&quot; + EnigmailFuncs.stripEmail(fromValue) +</span>
<a href="#l1.2463"></a><span id="l1.2463" class="difflineplus">+        '; prefer-encrypt=reset; _enigmail_artificial=yes; keydata=&quot;LQ==&quot;';</span>
<a href="#l1.2464"></a><span id="l1.2464" class="difflineplus">+</span>
<a href="#l1.2465"></a><span id="l1.2465" class="difflineplus">+      EnigmailAutocrypt.processAutocryptHeader(fromValue, [hdrData], dateValue,</span>
<a href="#l1.2466"></a><span id="l1.2466" class="difflineplus">+        Enigmail.msg.isAutocryptEnabled());</span>
<a href="#l1.2467"></a><span id="l1.2467" class="difflineplus">+    }</span>
<a href="#l1.2468"></a><span id="l1.2468" class="difflineplus">+  },</span>
<a href="#l1.2469"></a><span id="l1.2469" class="difflineplus">+</span>
<a href="#l1.2470"></a><span id="l1.2470" class="difflineplus">+  flexActionRequest: function() {</span>
<a href="#l1.2471"></a><span id="l1.2471" class="difflineplus">+    switch (Enigmail.msg.securityInfo.xtraStatus) {</span>
<a href="#l1.2472"></a><span id="l1.2472" class="difflineplus">+      case &quot;wks-request&quot;:</span>
<a href="#l1.2473"></a><span id="l1.2473" class="difflineplus">+        this.confirmWksRequest();</span>
<a href="#l1.2474"></a><span id="l1.2474" class="difflineplus">+        break;</span>
<a href="#l1.2475"></a><span id="l1.2475" class="difflineplus">+      case &quot;autocrypt-setup&quot;:</span>
<a href="#l1.2476"></a><span id="l1.2476" class="difflineplus">+        this.performAutocryptSetup();</span>
<a href="#l1.2477"></a><span id="l1.2477" class="difflineplus">+        break;</span>
<a href="#l1.2478"></a><span id="l1.2478" class="difflineplus">+      case &quot;process-manually&quot;:</span>
<a href="#l1.2479"></a><span id="l1.2479" class="difflineplus">+        this.messageDecrypt(null, false);</span>
<a href="#l1.2480"></a><span id="l1.2480" class="difflineplus">+        break;</span>
<a href="#l1.2481"></a><span id="l1.2481" class="difflineplus">+    }</span>
<a href="#l1.2482"></a><span id="l1.2482" class="difflineplus">+  },</span>
<a href="#l1.2483"></a><span id="l1.2483" class="difflineplus">+</span>
<a href="#l1.2484"></a><span id="l1.2484" class="difflineplus">+  confirmWksRequest: function() {</span>
<a href="#l1.2485"></a><span id="l1.2485" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: confirmWksRequest()\n&quot;);</span>
<a href="#l1.2486"></a><span id="l1.2486" class="difflineplus">+    try {</span>
<a href="#l1.2487"></a><span id="l1.2487" class="difflineplus">+      var msg = gFolderDisplay.selectedMessage;</span>
<a href="#l1.2488"></a><span id="l1.2488" class="difflineplus">+      if (!(!msg || !msg.folder)) {</span>
<a href="#l1.2489"></a><span id="l1.2489" class="difflineplus">+        var accMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Ci.nsIMsgAccountManager);</span>
<a href="#l1.2490"></a><span id="l1.2490" class="difflineplus">+        var msgHdr = msg.folder.GetMessageHeader(msg.messageKey);</span>
<a href="#l1.2491"></a><span id="l1.2491" class="difflineplus">+        let email = EnigmailFuncs.stripEmail(msgHdr.recipients);</span>
<a href="#l1.2492"></a><span id="l1.2492" class="difflineplus">+        let maybeIdent = EnigmailStdlib.getIdentityForEmail(email);</span>
<a href="#l1.2493"></a><span id="l1.2493" class="difflineplus">+</span>
<a href="#l1.2494"></a><span id="l1.2494" class="difflineplus">+        if (maybeIdent &amp;&amp; maybeIdent.identity) {</span>
<a href="#l1.2495"></a><span id="l1.2495" class="difflineplus">+          EnigmailStdlib.msgHdrsModifyRaw([msgHdr], function(data) {</span>
<a href="#l1.2496"></a><span id="l1.2496" class="difflineplus">+            EnigmailWks.confirmKey(maybeIdent.identity, data, window, function(ret) {</span>
<a href="#l1.2497"></a><span id="l1.2497" class="difflineplus">+              if (ret) {</span>
<a href="#l1.2498"></a><span id="l1.2498" class="difflineplus">+                EnigmailDialog.info(window, EnigmailLocale.getString(&quot;wksConfirmSuccess&quot;));</span>
<a href="#l1.2499"></a><span id="l1.2499" class="difflineplus">+              }</span>
<a href="#l1.2500"></a><span id="l1.2500" class="difflineplus">+              else {</span>
<a href="#l1.2501"></a><span id="l1.2501" class="difflineplus">+                EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;wksConfirmFailure&quot;));</span>
<a href="#l1.2502"></a><span id="l1.2502" class="difflineplus">+              }</span>
<a href="#l1.2503"></a><span id="l1.2503" class="difflineplus">+            });</span>
<a href="#l1.2504"></a><span id="l1.2504" class="difflineplus">+            return null;</span>
<a href="#l1.2505"></a><span id="l1.2505" class="difflineplus">+          });</span>
<a href="#l1.2506"></a><span id="l1.2506" class="difflineplus">+        }</span>
<a href="#l1.2507"></a><span id="l1.2507" class="difflineplus">+        else {</span>
<a href="#l1.2508"></a><span id="l1.2508" class="difflineplus">+          EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;wksNoIdentity&quot;, [email]));</span>
<a href="#l1.2509"></a><span id="l1.2509" class="difflineplus">+        }</span>
<a href="#l1.2510"></a><span id="l1.2510" class="difflineplus">+      }</span>
<a href="#l1.2511"></a><span id="l1.2511" class="difflineplus">+    }</span>
<a href="#l1.2512"></a><span id="l1.2512" class="difflineplus">+    catch (e) {</span>
<a href="#l1.2513"></a><span id="l1.2513" class="difflineplus">+      EnigmailLog.DEBUG(e + &quot;\n&quot;);</span>
<a href="#l1.2514"></a><span id="l1.2514" class="difflineplus">+    }</span>
<a href="#l1.2515"></a><span id="l1.2515" class="difflineplus">+  },</span>
<a href="#l1.2516"></a><span id="l1.2516" class="difflineplus">+</span>
<a href="#l1.2517"></a><span id="l1.2517" class="difflineplus">+  performAutocryptSetup: function(passwd = null) {</span>
<a href="#l1.2518"></a><span id="l1.2518" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: performAutocryptSetup()\n&quot;);</span>
<a href="#l1.2519"></a><span id="l1.2519" class="difflineplus">+    </span>
<a href="#l1.2520"></a><span id="l1.2520" class="difflineplus">+    EnigmailDialog.alert(window, &quot;EnigmailAutocrypt.handleBackupMessage not implemented&quot;);</span>
<a href="#l1.2521"></a><span id="l1.2521" class="difflineplus">+</span>
<a href="#l1.2522"></a><span id="l1.2522" class="difflineplus">+    /*</span>
<a href="#l1.2523"></a><span id="l1.2523" class="difflineplus">+    if ((&quot;message-id&quot; in currentHeaderData) &amp;&amp; EnigmailAutocrypt.isSelfCreatedSetupMessage(currentHeaderData[&quot;message-id&quot;].headerValue)) {</span>
<a href="#l1.2524"></a><span id="l1.2524" class="difflineplus">+      EnigmailDialog.info(window, EnigmailLocale.getString(&quot;autocrypt.importSetupKey.selfCreated&quot;));</span>
<a href="#l1.2525"></a><span id="l1.2525" class="difflineplus">+      return;</span>
<a href="#l1.2526"></a><span id="l1.2526" class="difflineplus">+    }</span>
<a href="#l1.2527"></a><span id="l1.2527" class="difflineplus">+</span>
<a href="#l1.2528"></a><span id="l1.2528" class="difflineplus">+    if (EnigmailAutocrypt.isAccountSetupForPgp(currentHeaderData.from.headerValue)) {</span>
<a href="#l1.2529"></a><span id="l1.2529" class="difflineplus">+      // Ask user what to do if the account is already correctly configured</span>
<a href="#l1.2530"></a><span id="l1.2530" class="difflineplus">+</span>
<a href="#l1.2531"></a><span id="l1.2531" class="difflineplus">+      if (!EnigmailDialog.confirmDlg(window,</span>
<a href="#l1.2532"></a><span id="l1.2532" class="difflineplus">+          EnigmailLocale.getString(&quot;autocrypt.importSetupKey.accountPreconfigured&quot;),</span>
<a href="#l1.2533"></a><span id="l1.2533" class="difflineplus">+          EnigmailLocale.getString(&quot;dlg.button.overwrite&quot;),</span>
<a href="#l1.2534"></a><span id="l1.2534" class="difflineplus">+          EnigmailLocale.getString(&quot;dlg.button.cancel&quot;)</span>
<a href="#l1.2535"></a><span id="l1.2535" class="difflineplus">+        )) {</span>
<a href="#l1.2536"></a><span id="l1.2536" class="difflineplus">+        return;</span>
<a href="#l1.2537"></a><span id="l1.2537" class="difflineplus">+      }</span>
<a href="#l1.2538"></a><span id="l1.2538" class="difflineplus">+    }</span>
<a href="#l1.2539"></a><span id="l1.2539" class="difflineplus">+</span>
<a href="#l1.2540"></a><span id="l1.2540" class="difflineplus">+    if (currentAttachments[0].contentType.search(/^application\/autocrypt-setup$/i) === 0) {</span>
<a href="#l1.2541"></a><span id="l1.2541" class="difflineplus">+</span>
<a href="#l1.2542"></a><span id="l1.2542" class="difflineplus">+      EnigmailAutocrypt.getSetupMessageData(currentAttachments[0].url).then(res =&gt; {</span>
<a href="#l1.2543"></a><span id="l1.2543" class="difflineplus">+        passwd = EnigmailWindows.autocryptSetupPasswd(window, &quot;input&quot;, res.passphraseFormat, passwd || res.passphraseHint);</span>
<a href="#l1.2544"></a><span id="l1.2544" class="difflineplus">+</span>
<a href="#l1.2545"></a><span id="l1.2545" class="difflineplus">+        if ((!passwd) || passwd == &quot;&quot;) {</span>
<a href="#l1.2546"></a><span id="l1.2546" class="difflineplus">+          throw &quot;noPasswd&quot;;</span>
<a href="#l1.2547"></a><span id="l1.2547" class="difflineplus">+        }</span>
<a href="#l1.2548"></a><span id="l1.2548" class="difflineplus">+</span>
<a href="#l1.2549"></a><span id="l1.2549" class="difflineplus">+        // TODO: return EnigmailAutocrypt.handleBackupMessage(passwd, res.attachmentData, currentHeaderData.from.headerValue);</span>
<a href="#l1.2550"></a><span id="l1.2550" class="difflineplus">+      }).then(res =&gt; {</span>
<a href="#l1.2551"></a><span id="l1.2551" class="difflineplus">+        EnigmailDialog.info(window, EnigmailLocale.getString(&quot;autocrypt.importSetupKey.success&quot;, currentHeaderData.from.headerValue));</span>
<a href="#l1.2552"></a><span id="l1.2552" class="difflineplus">+      }).catch(err =&gt; {</span>
<a href="#l1.2553"></a><span id="l1.2553" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: performAutocryptSetup got cancel status=&quot; + err + &quot;\n&quot;);</span>
<a href="#l1.2554"></a><span id="l1.2554" class="difflineplus">+</span>
<a href="#l1.2555"></a><span id="l1.2555" class="difflineplus">+        switch (err) {</span>
<a href="#l1.2556"></a><span id="l1.2556" class="difflineplus">+          case &quot;getSetupMessageData&quot;:</span>
<a href="#l1.2557"></a><span id="l1.2557" class="difflineplus">+            EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;autocrypt.importSetupKey.invalidMessage&quot;));</span>
<a href="#l1.2558"></a><span id="l1.2558" class="difflineplus">+            break;</span>
<a href="#l1.2559"></a><span id="l1.2559" class="difflineplus">+          case &quot;wrongPasswd&quot;:</span>
<a href="#l1.2560"></a><span id="l1.2560" class="difflineplus">+            if (EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;autocrypt.importSetupKey.wrongPasswd&quot;), EnigmailLocale.getString(&quot;dlg.button.retry&quot;),</span>
<a href="#l1.2561"></a><span id="l1.2561" class="difflineplus">+                EnigmailLocale.getString(&quot;dlg.button.cancel&quot;))) {</span>
<a href="#l1.2562"></a><span id="l1.2562" class="difflineplus">+              Enigmail.msg.performAutocryptSetup(passwd);</span>
<a href="#l1.2563"></a><span id="l1.2563" class="difflineplus">+            }</span>
<a href="#l1.2564"></a><span id="l1.2564" class="difflineplus">+            break;</span>
<a href="#l1.2565"></a><span id="l1.2565" class="difflineplus">+          case &quot;keyImportFailed&quot;:</span>
<a href="#l1.2566"></a><span id="l1.2566" class="difflineplus">+            EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;autocrypt.importSetupKey.invalidKey&quot;));</span>
<a href="#l1.2567"></a><span id="l1.2567" class="difflineplus">+            break;</span>
<a href="#l1.2568"></a><span id="l1.2568" class="difflineplus">+        }</span>
<a href="#l1.2569"></a><span id="l1.2569" class="difflineplus">+      });</span>
<a href="#l1.2570"></a><span id="l1.2570" class="difflineplus">+    }</span>
<a href="#l1.2571"></a><span id="l1.2571" class="difflineplus">+    */</span>
<a href="#l1.2572"></a><span id="l1.2572" class="difflineplus">+  },</span>
<a href="#l1.2573"></a><span id="l1.2573" class="difflineplus">+</span>
<a href="#l1.2574"></a><span id="l1.2574" class="difflineplus">+  onUnloadEnigmail: function() {</span>
<a href="#l1.2575"></a><span id="l1.2575" class="difflineplus">+    //EnigmailLog.DEBUG(&quot;enigmailMessengerOverlay.js: onUnloadEnigmail()\n&quot;);</span>
<a href="#l1.2576"></a><span id="l1.2576" class="difflineplus">+</span>
<a href="#l1.2577"></a><span id="l1.2577" class="difflineplus">+    window.removeEventListener(&quot;unload&quot;, Enigmail.msg.messengerClose, false);</span>
<a href="#l1.2578"></a><span id="l1.2578" class="difflineplus">+    window.removeEventListener(&quot;unload-enigmail&quot;, Enigmail.msg.onUnloadEnigmail, false);</span>
<a href="#l1.2579"></a><span id="l1.2579" class="difflineplus">+    window.removeEventListener(&quot;load-enigmail&quot;, Enigmail.msg.messengerStartup, false);</span>
<a href="#l1.2580"></a><span id="l1.2580" class="difflineplus">+</span>
<a href="#l1.2581"></a><span id="l1.2581" class="difflineplus">+    this.messageCleanup();</span>
<a href="#l1.2582"></a><span id="l1.2582" class="difflineplus">+</span>
<a href="#l1.2583"></a><span id="l1.2583" class="difflineplus">+    if (this.messagePane) {</span>
<a href="#l1.2584"></a><span id="l1.2584" class="difflineplus">+      this.messagePane.removeEventListener(&quot;unload&quot;, Enigmail.msg.messageFrameUnload, true);</span>
<a href="#l1.2585"></a><span id="l1.2585" class="difflineplus">+    }</span>
<a href="#l1.2586"></a><span id="l1.2586" class="difflineplus">+</span>
<a href="#l1.2587"></a><span id="l1.2587" class="difflineplus">+    for (let c of this.changedAttributes) {</span>
<a href="#l1.2588"></a><span id="l1.2588" class="difflineplus">+      let elem = document.getElementById(c.id);</span>
<a href="#l1.2589"></a><span id="l1.2589" class="difflineplus">+      if (elem) {</span>
<a href="#l1.2590"></a><span id="l1.2590" class="difflineplus">+        elem.setAttribute(c.attrib, c.value);</span>
<a href="#l1.2591"></a><span id="l1.2591" class="difflineplus">+      }</span>
<a href="#l1.2592"></a><span id="l1.2592" class="difflineplus">+    }</span>
<a href="#l1.2593"></a><span id="l1.2593" class="difflineplus">+</span>
<a href="#l1.2594"></a><span id="l1.2594" class="difflineplus">+    if (this.treeController) {</span>
<a href="#l1.2595"></a><span id="l1.2595" class="difflineplus">+      top.controllers.removeController(this.treeController);</span>
<a href="#l1.2596"></a><span id="l1.2596" class="difflineplus">+    }</span>
<a href="#l1.2597"></a><span id="l1.2597" class="difflineplus">+</span>
<a href="#l1.2598"></a><span id="l1.2598" class="difflineplus">+    for (let i = 0; i &lt; gMessageListeners.length; i++) {</span>
<a href="#l1.2599"></a><span id="l1.2599" class="difflineplus">+      if (gMessageListeners[i] === Enigmail.msg.messageListener) {</span>
<a href="#l1.2600"></a><span id="l1.2600" class="difflineplus">+        gMessageListeners.splice(i, 1);</span>
<a href="#l1.2601"></a><span id="l1.2601" class="difflineplus">+        break;</span>
<a href="#l1.2602"></a><span id="l1.2602" class="difflineplus">+      }</span>
<a href="#l1.2603"></a><span id="l1.2603" class="difflineplus">+    }</span>
<a href="#l1.2604"></a><span id="l1.2604" class="difflineplus">+    this.messengerClose();</span>
<a href="#l1.2605"></a><span id="l1.2605" class="difflineplus">+</span>
<a href="#l1.2606"></a><span id="l1.2606" class="difflineplus">+    if (Enigmail.columnHandler) {</span>
<a href="#l1.2607"></a><span id="l1.2607" class="difflineplus">+      Enigmail.columnHandler.onUnloadEnigmail();</span>
<a href="#l1.2608"></a><span id="l1.2608" class="difflineplus">+    }</span>
<a href="#l1.2609"></a><span id="l1.2609" class="difflineplus">+    if (Enigmail.hdrView) {</span>
<a href="#l1.2610"></a><span id="l1.2610" class="difflineplus">+      Enigmail.hdrView.onUnloadEnigmail();</span>
<a href="#l1.2611"></a><span id="l1.2611" class="difflineplus">+    }</span>
<a href="#l1.2612"></a><span id="l1.2612" class="difflineplus">+</span>
<a href="#l1.2613"></a><span id="l1.2613" class="difflineplus">+    Enigmail = undefined;</span>
<a href="#l1.2614"></a><span id="l1.2614" class="difflineplus">+  }</span>
<a href="#l1.2615"></a><span id="l1.2615" class="difflineplus">+};</span>
<a href="#l1.2616"></a><span id="l1.2616" class="difflineplus">+</span>
<a href="#l1.2617"></a><span id="l1.2617" class="difflineplus">+window.addEventListener(&quot;load-enigmail&quot;, Enigmail.msg.messengerStartup.bind(Enigmail.msg), false);</span>
<a href="#l1.2618"></a><span id="l1.2618" class="difflineplus">+window.addEventListener(&quot;unload&quot;, Enigmail.msg.messengerClose.bind(Enigmail.msg), false);</span>
<a href="#l1.2619"></a><span id="l1.2619" class="difflineplus">+window.addEventListener(&quot;unload-enigmail&quot;, Enigmail.msg.onUnloadEnigmail.bind(Enigmail.msg), false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMsgHdrViewOverlay.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,1406 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/*global EnigmailWindows: false, EnigmailLocale: false, EnigmailPrefs: false, EnigmailTime: false */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+/*</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ * file, You can obtain one at https://mozilla.org/MPL/2.0/.</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ */</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+/* Globals from Thunderbird: */</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+/* global gFolderDisplay: false, currentAttachments: false, gSMIMEContainer: false, gSignedUINode: false, gEncryptedUINode: false */</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+/* global gDBView: false, msgWindow: false, messageHeaderSink: false, gMessageListeners: false, findEmailNodeFromPopupNode: true */</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+/* global gExpandedHeaderView: false, CanDetachAttachments: true, gEncryptedURIService: false, FillAttachmentListPopup: false */</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+/* global attachmentList: false, MailOfflineMgr: false, currentHeaderData: false, ContentTypeIsSMIME: false */</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+var EnigmailCore = ChromeUtils.import(&quot;chrome://openpgp/content/modules/core.jsm&quot;).EnigmailCore;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+var EnigmailFuncs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/funcs.jsm&quot;).EnigmailFuncs;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+var EnigmailVerify = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mimeVerify.jsm&quot;).EnigmailVerify;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+var EnigmailLog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/log.jsm&quot;).EnigmailLog;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+var EnigmailPrefs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/prefs.jsm&quot;).EnigmailPrefs;</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+var EnigmailLocale = ChromeUtils.import(&quot;chrome://openpgp/content/modules/locale.jsm&quot;).EnigmailLocale;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+var EnigmailWindows = ChromeUtils.import(&quot;chrome://openpgp/content/modules/windows.jsm&quot;).EnigmailWindows;</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+var EnigmailDialog = ChromeUtils.import(&quot;chrome://openpgp/content/modules/dialog.jsm&quot;).EnigmailDialog;</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+var EnigmailTime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/time.jsm&quot;).EnigmailTime;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+var EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+var EnigmailKey = ChromeUtils.import(&quot;chrome://openpgp/content/modules/key.jsm&quot;).EnigmailKey;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+var EnigmailKeyRing = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyRing.jsm&quot;).EnigmailKeyRing;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+var EnigmailURIs = ChromeUtils.import(&quot;chrome://openpgp/content/modules/uris.jsm&quot;).EnigmailURIs;</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+var EnigmailConstants = ChromeUtils.import(&quot;chrome://openpgp/content/modules/constants.jsm&quot;).EnigmailConstants;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+var EnigmailData = ChromeUtils.import(&quot;chrome://openpgp/content/modules/data.jsm&quot;).EnigmailData;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+var EnigmailClipboard = ChromeUtils.import(&quot;chrome://openpgp/content/modules/clipboard.jsm&quot;).EnigmailClipboard;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+var EnigmailStdlib = ChromeUtils.import(&quot;chrome://openpgp/content/modules/stdlib.jsm&quot;).EnigmailStdlib;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+var EnigmailWks = ChromeUtils.import(&quot;chrome://openpgp/content/modules/webKey.jsm&quot;).EnigmailWks;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+var EnigmailMime = ChromeUtils.import(&quot;chrome://openpgp/content/modules/mime.jsm&quot;).EnigmailMime;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+var EnigmailMsgRead = ChromeUtils.import(&quot;chrome://openpgp/content/modules/msgRead.jsm&quot;).EnigmailMsgRead;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+var EnigmailSingletons = ChromeUtils.import(&quot;chrome://openpgp/content/modules/singletons.jsm&quot;).EnigmailSingletons;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+var EnigmailAutocrypt = ChromeUtils.import(&quot;chrome://openpgp/content/modules/autocrypt.jsm&quot;).EnigmailAutocrypt;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+var EnigmailCompat = ChromeUtils.import(&quot;chrome://openpgp/content/modules/compat.jsm&quot;).EnigmailCompat;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+if (!Enigmail) var Enigmail = {};</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+Enigmail.hdrView = {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  statusBar: null,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  enigmailBox: null,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  lastEncryptedMsgKey: null,</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  lastEncryptedUri: null,</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  flexbuttonAction: null,</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  hdrViewLoad: function() {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.hdrViewLoad\n&quot;);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    // THE FOLLOWING OVERRIDES CODE IN msgHdrViewOverlay.js</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    // which wouldn't work otherwise</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    this.origCanDetachAttachments = CanDetachAttachments;</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    CanDetachAttachments = function() {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      return Enigmail.hdrView.origCanDetachAttachments() &amp;&amp; Enigmail.hdrView.enigCanDetachAttachments();</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    };</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    this.msgHdrViewLoad();</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    // Override SMIME ui</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    let signedHdrElement = document.getElementById(&quot;signedHdrIcon&quot;);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    if (signedHdrElement) {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      signedHdrElement.setAttribute(&quot;onclick&quot;, &quot;Enigmail.msg.viewSecurityInfo(event, true);&quot;);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    }</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    let encryptedHdrElement = document.getElementById(&quot;encryptedHdrIcon&quot;);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    if (encryptedHdrElement) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+      encryptedHdrElement.setAttribute(&quot;onclick&quot;, &quot;Enigmail.msg.viewSecurityInfo(event, true);&quot;);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+    }</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    this.statusBar = document.getElementById(&quot;enigmail-status-bar&quot;);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+    this.enigmailBox = document.getElementById(&quot;enigmailBox&quot;);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    let addrPopup = document.getElementById(&quot;emailAddressPopup&quot;);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    if (addrPopup) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      addrPopup.addEventListener(&quot;popupshowing&quot;, Enigmail.hdrView.displayAddressPopup.bind(addrPopup), false);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    }</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+    // Thunderbird</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    let attCtx = document.getElementById(&quot;attachmentItemContext&quot;);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+    if (attCtx) {</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+      attCtx.addEventListener(&quot;popupshowing&quot;, this.onShowAttachmentContextMenu.bind(Enigmail.hdrView), false);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+    }</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  },</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  displayAddressPopup: function(event) {</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    let target = event.target;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    EnigmailFuncs.collapseAdvanced(target, 'hidden');</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  },</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  statusBarHide: function() {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+    try {</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+      this.statusBar.removeAttribute(&quot;signed&quot;);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+      this.statusBar.removeAttribute(&quot;encrypted&quot;);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+      this.enigmailBox.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+      Enigmail.msg.setAttachmentReveal(null);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+      if (Enigmail.msg.securityInfo) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+        Enigmail.msg.securityInfo.statusFlags = 0;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+        Enigmail.msg.securityInfo.msgSigned = 0;</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+        Enigmail.msg.securityInfo.msgEncrypted = 0;</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+      }</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+      let enigMsgPane = document.getElementById(&quot;enigmailMsgDisplay&quot;);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      let bodyElement = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+      enigMsgPane.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+      bodyElement.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+    }</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+    catch (ex) {}</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  },</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+  setStatusText: function(txt) {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    let s = document.getElementById(&quot;enigmailStatusText&quot;);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+    if (s) {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+      s.firstChild.data = txt;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+    }</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  },</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  updateHdrIcons: function(exitCode, statusFlags, keyId, userId, sigDetails, errorMsg, blockSeparation, encToDetails, xtraStatus, encMimePartNumber) {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.updateHdrIcons: exitCode=&quot; + exitCode + &quot;, statusFlags=&quot; + statusFlags + &quot;, keyId=&quot; + keyId + &quot;, userId=&quot; + userId + &quot;, &quot; + errorMsg +</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+      &quot;\n&quot;);</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+    if (Enigmail.msg.securityInfo &amp;&amp; Enigmail.msg.securityInfo.xtraStatus &amp;&amp; Enigmail.msg.securityInfo.xtraStatus === &quot;wks-request&quot;) {</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+      return;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    }</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    this.statusBar = document.getElementById(&quot;enigmail-status-bar&quot;);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    this.enigmailBox = document.getElementById(&quot;enigmailBox&quot;);</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    if (gFolderDisplay.selectedMessageUris &amp;&amp; gFolderDisplay.selectedMessageUris.length &gt; 0) {</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+      this.lastEncryptedMsgKey = gFolderDisplay.selectedMessageUris[0];</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+    }</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+    if (!errorMsg)</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+      errorMsg = &quot;&quot;;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    var replaceUid = null;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+    if (keyId &amp;&amp; gFolderDisplay.selectedMessage) {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+      replaceUid = EnigmailMsgRead.matchUidToSender(keyId, gFolderDisplay.selectedMessage);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+    }</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    if (!replaceUid) {</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+      replaceUid = userId.replace(/\n.*$/gm, &quot;&quot;);</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    }</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    if (Enigmail.msg.savedHeaders &amp;&amp; &quot;x-pgp-encoding-format&quot; in Enigmail.msg.savedHeaders &amp;&amp;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+      (Enigmail.msg.savedHeaders[&quot;x-pgp-encoding-format&quot;].search(/partitioned/i) === 0)) {</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+      if (currentAttachments &amp;&amp; currentAttachments.length) {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+        Enigmail.msg.setAttachmentReveal(currentAttachments);</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+      }</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+    }</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    if (userId &amp;&amp; replaceUid) {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+      // no EnigConvertGpgToUnicode() here; strings are already UTF-8</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+      replaceUid = replaceUid.replace(/\\[xe]3a/gi, &quot;:&quot;);</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+      errorMsg = errorMsg.replace(userId, replaceUid);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    }</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    var errorLines = &quot;&quot;;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+    var fullStatusInfo = &quot;&quot;;</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+    if (exitCode == EnigmailConstants.POSSIBLE_PGPMIME) {</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+      exitCode = 0;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+    }</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+    else {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+      if (errorMsg) {</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+        // no EnigConvertGpgToUnicode() here; strings are already UTF-8</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+        errorLines = errorMsg.split(/\r?\n/);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+        fullStatusInfo = errorMsg;</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+      }</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+    }</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    if (errorLines &amp;&amp; (errorLines.length &gt; 22)) {</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+      // Retain only first twenty lines and last two lines of error message</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+      var lastLines = errorLines[errorLines.length - 2] + &quot;\n&quot; +</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+        errorLines[errorLines.length - 1] + &quot;\n&quot;;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+      while (errorLines.length &gt; 20)</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+        errorLines.pop();</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+      errorMsg = errorLines.join(&quot;\n&quot;) + &quot;\n...\n&quot; + lastLines;</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    }</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+    var statusInfo = &quot;&quot;;</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+    var statusLine = &quot;&quot;;</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+    var statusArr = [];</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+    if (statusFlags &amp; EnigmailConstants.NODATA) {</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.PGP_MIME_SIGNED)</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+        statusFlags |= EnigmailConstants.UNVERIFIED_SIGNATURE;</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.PGP_MIME_ENCRYPTED)</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+        statusFlags |= EnigmailConstants.DECRYPTION_INCOMPLETE;</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+    }</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+    if (!(statusFlags &amp; EnigmailConstants.PGP_MIME_ENCRYPTED)) {</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+      encMimePartNumber = &quot;&quot;;</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+    }</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+    if (!EnigmailPrefs.getPref(&quot;displayPartiallySigned&quot;)) {</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+      if ((statusFlags &amp; (EnigmailConstants.PARTIALLY_PGP)) &amp;&amp;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+        (statusFlags &amp; (EnigmailConstants.BAD_SIGNATURE))) {</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+        statusFlags &amp;= ~(EnigmailConstants.BAD_SIGNATURE | EnigmailConstants.PARTIALLY_PGP);</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+        if (statusFlags === 0) {</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+          errorMsg = &quot;&quot;;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+          fullStatusInfo = &quot;&quot;;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+        }</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+      }</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+    }</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+    var msgSigned = (statusFlags &amp; (EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+      EnigmailConstants.GOOD_SIGNATURE |</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+      EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+      EnigmailConstants.UNVERIFIED_SIGNATURE |</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+      EnigmailConstants.REVOKED_KEY |</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+      EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+      EnigmailConstants.EXPIRED_SIGNATURE));</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+    var msgEncrypted = (statusFlags &amp; (EnigmailConstants.DECRYPTION_OKAY |</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+      EnigmailConstants.DECRYPTION_INCOMPLETE |</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+      EnigmailConstants.DECRYPTION_FAILED));</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+    if (msgSigned &amp;&amp; (statusFlags &amp; EnigmailConstants.IMPORTED_KEY)) {</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+      statusFlags &amp;= (~EnigmailConstants.IMPORTED_KEY);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+    }</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+    if (!(statusFlags &amp; EnigmailConstants.DECRYPTION_FAILED) &amp;&amp;</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+      ((!(statusFlags &amp; (EnigmailConstants.DECRYPTION_INCOMPLETE |</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+          EnigmailConstants.UNVERIFIED_SIGNATURE |</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+          EnigmailConstants.DECRYPTION_FAILED |</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+          EnigmailConstants.BAD_SIGNATURE))) ||</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+        (statusFlags &amp; EnigmailConstants.DISPLAY_MESSAGE) &amp;&amp;</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+        !(statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE)) &amp;&amp;</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+      !(statusFlags &amp; EnigmailConstants.IMPORTED_KEY)) {</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+      // normal exit / display message</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+      statusLine = errorMsg;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+      statusInfo = statusLine;</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineplus">+      if (sigDetails) {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+        var detailArr = sigDetails.split(/ /);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+        let dateTime = EnigmailTime.getDateTime(detailArr[2], true, true);</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+        var txt = EnigmailLocale.getString(&quot;keyAndSigDate&quot;, [keyId, dateTime]);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+        statusArr.push(txt);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+        statusInfo += &quot;\n&quot; + txt;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+        var fpr = &quot;&quot;;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+        if (detailArr.length &gt;= 10) {</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+          fpr = EnigmailKey.formatFpr(detailArr[9]);</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+        }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+        else {</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+          fpr = EnigmailKey.formatFpr(detailArr[0]);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineplus">+        }</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineplus">+        if (fpr) {</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineplus">+          statusInfo += &quot;\n&quot; + EnigmailLocale.getString(&quot;keyFpr&quot;, [fpr]);</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+        }</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+        if (detailArr.length &gt; 7) {</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineplus">+          var signingAlg = EnigmailGpg.signingAlgIdToString(detailArr[6]);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+          var hashAlg = EnigmailGpg.hashAlgIdToString(detailArr[7]);</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+          statusInfo += &quot;\n\n&quot; + EnigmailLocale.getString(&quot;usedAlgorithms&quot;, [signingAlg, hashAlg]);</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+        }</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+      }</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+      fullStatusInfo = statusInfo;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+    }</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+    else {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+      // no normal exit / don't display message</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+      // - process failed decryptions first because they imply bad signature handling</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.BAD_PASSPHRASE) {</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+        statusInfo = EnigmailLocale.getString(&quot;badPhrase&quot;);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+        statusLine = statusInfo + EnigmailLocale.getString(&quot;clickDecryptRetry&quot;);</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+      }</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+      else if (statusFlags &amp; EnigmailConstants.DECRYPTION_FAILED) {</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+        if (statusFlags &amp; EnigmailConstants.MISSING_MDC) {</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;missingMdcError&quot;);</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+          statusLine = statusInfo;</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+        }</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+        else if (statusFlags &amp; EnigmailConstants.MISSING_PASSPHRASE) {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;missingPassphrase&quot;);</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+          statusLine = statusInfo + EnigmailLocale.getString(&quot;clickDecryptRetry&quot;);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+        }</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+        else if (statusFlags &amp; EnigmailConstants.NO_SECKEY) {</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;needKey&quot;);</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+        }</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+        else {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;failedDecrypt&quot;);</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+        }</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+        statusLine = statusInfo + EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+      }</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+      else if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+        statusInfo = EnigmailLocale.getString(&quot;unverifiedSig&quot;);</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+        if (keyId) {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+          statusLine = statusInfo + EnigmailLocale.getString(&quot;clickImportButton&quot;);</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+        }</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+        else {</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+          statusLine = statusInfo + EnigmailLocale.getString(&quot;keyTypeUnsupported&quot;);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+        }</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+      }</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+      else if (statusFlags &amp; (EnigmailConstants.BAD_SIGNATURE |</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+          EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+          EnigmailConstants.EXPIRED_KEY_SIGNATURE)) {</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+        statusInfo = EnigmailLocale.getString(&quot;unverifiedSig&quot;);</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+        statusLine = statusInfo + EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+      }</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+      else if (statusFlags &amp; EnigmailConstants.DECRYPTION_INCOMPLETE) {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+        statusInfo = EnigmailLocale.getString(&quot;incompleteDecrypt&quot;);</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+        statusLine = statusInfo + EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+      }</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+      else if (statusFlags &amp; EnigmailConstants.IMPORTED_KEY) {</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+        statusLine = &quot;&quot;;</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+        statusInfo = &quot;&quot;;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+        EnigmailDialog.info(window, errorMsg);</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+      }</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+      else {</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+        // TODO: can we ever get to this point anymore?</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+        // FIXME: the viewInfo string is outdated</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+        statusInfo = EnigmailLocale.getString(&quot;failedDecryptVerify&quot;);</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+        statusLine = statusInfo + EnigmailLocale.getString(&quot;viewInfo&quot;);</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+      }</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+      // add key infos if available</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+      if (keyId) {</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+        var si = EnigmailLocale.getString(&quot;unverifiedSig&quot;); // &quot;Unverified signature&quot;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+        if (statusInfo === &quot;&quot;) {</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+          statusInfo += si;</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+          statusLine = si + EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+        }</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+        if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+          statusInfo += &quot;\n&quot; + EnigmailLocale.getString(&quot;keyNeeded&quot;, [keyId]); // &quot;public key ... needed&quot;</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+        }</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+        else {</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+          statusInfo += &quot;\n&quot; + EnigmailLocale.getString(&quot;keyUsed&quot;, [keyId]); // &quot;public key ... used&quot;</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+        }</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+      }</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+      statusInfo += &quot;\n\n&quot; + errorMsg;</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+    }</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+    if (statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY ||</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+      (this.statusBar.getAttribute(&quot;encrypted&quot;) == &quot;ok&quot;)) {</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+      var statusMsg;</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+      if (xtraStatus &amp;&amp; xtraStatus == &quot;buggyMailFormat&quot;) {</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+        statusMsg = EnigmailLocale.getString(&quot;decryptedMsgWithFormatError&quot;);</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+      }</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+      else {</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+        statusMsg = EnigmailLocale.getString(&quot;decryptedMsg&quot;);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+      }</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+      if (!statusInfo) {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+        statusInfo = statusMsg;</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+      }</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+      else {</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+        statusInfo = statusMsg + &quot;\n&quot; + statusInfo;</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+      }</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+      if (!statusLine) {</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+        statusLine = statusInfo;</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+      }</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+      else {</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+        statusLine = statusMsg + &quot;; &quot; + statusLine;</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+      }</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+    }</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+    if (EnigmailPrefs.getPref(&quot;displayPartiallySigned&quot;)) {</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.PARTIALLY_PGP) {</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+        if (msgSigned &amp;&amp; msgEncrypted) {</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+          statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgSignedAndEnc&quot;)]);</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+          statusLine += EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgSigned&quot;)]) +</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+            &quot;\n&quot; + statusInfo;</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+        }</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+        else if (msgEncrypted) {</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+          statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgEncrypted&quot;)]);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+          statusLine += EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgEncrypted&quot;)]) +</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+            &quot;\n&quot; + statusInfo;</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+        }</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+        else if (msgSigned) {</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+          if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+            statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgSignedUnkownKey&quot;)]);</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+            if (keyId) {</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+              statusLine += EnigmailLocale.getString(&quot;clickImportButton&quot;);</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+            }</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+            else {</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+              statusLine += EnigmailLocale.getString(&quot;keyTypeUnsupported&quot;);</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+            }</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+          }</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+          else {</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+            statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgSigned&quot;)]);</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+            statusLine += EnigmailLocale.getString(&quot;clickDetailsButton&quot;);</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+          }</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+          statusInfo = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgSigned&quot;)]) +</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+            &quot;\n&quot; + statusInfo;</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+        }</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+      }</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+    }</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+    // if we have parsed ENC_TO entries, add them as status info</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+    if (encToDetails &amp;&amp; encToDetails.length &gt; 0) {</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+      statusInfo += &quot;\n\n&quot; + EnigmailLocale.getString(&quot;encryptKeysNote&quot;, [encToDetails]);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+    }</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+    if (xtraStatus === &quot;process-manually&quot;) {</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+      let buttonLabel = &quot;&quot;;</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+        statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgSigned&quot;)]);</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+        statusLine += EnigmailLocale.getString(&quot;verifyManually&quot;);</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+        buttonLabel = EnigmailLocale.getString(&quot;headerView.button.verify&quot;);</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+      }</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+      else {</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+        statusLine = EnigmailLocale.getString(&quot;msgPart&quot;, [EnigmailLocale.getString(&quot;msgEncrypted&quot;)]);</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+        statusLine += EnigmailLocale.getString(&quot;decryptManually&quot;);</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+        buttonLabel = EnigmailLocale.getString(&quot;headerView.button.decrypt&quot;);</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+      }</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+      Enigmail.msg.securityInfo = {};</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+      this.displayFlexAction(statusLine, buttonLabel, xtraStatus);</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+      return;</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+    }</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+    if (!statusLine) {</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+      return;</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+    }</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+    Enigmail.msg.securityInfo = {</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+      statusFlags: statusFlags,</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+      keyId: keyId,</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+      userId: userId,</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+      statusLine: statusLine,</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+      msgSigned: msgSigned,</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+      statusArr: statusArr,</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+      statusInfo: statusInfo,</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+      fullStatusInfo: fullStatusInfo,</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+      blockSeparation: blockSeparation,</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineplus">+      xtraStatus: xtraStatus,</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+      encryptedMimePart: encMimePartNumber</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+    };</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineplus">+</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+    Enigmail.msg.createArtificialAutocryptHeader();</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+    if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+      this.tryImportAutocryptHeader();</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+    }</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+    this.displayStatusBar();</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+    this.updateMsgDb();</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+  },</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineplus">+  /**</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+   * Check whether we got a WKS request</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+   */</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineplus">+  checkWksConfirmRequest: function(jsonStr) {</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineplus">+    let requestObj;</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineplus">+    try {</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineplus">+      requestObj = JSON.parse(jsonStr);</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineplus">+    }</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineplus">+    catch (ex) {</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: checkWksConfirmRequest parsing JSON failed\n&quot;);</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+      return;</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+    }</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+    if (&quot;type&quot; in requestObj &amp;&amp; requestObj.type.toLowerCase() === &quot;confirmation-request&quot;) {</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+      EnigmailWks.getWksClientPathAsync(window, function _res(wksClientPath) {</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+        if (!wksClientPath) return;</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+        Enigmail.hdrView.displayFlexAction(EnigmailLocale.getString(&quot;wksConfirmationReq&quot;),</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+          EnigmailLocale.getString(&quot;wksConfirmationReq.button.label&quot;), &quot;wks-request&quot;);</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+        Enigmail.hdrView.displayWksMessage();</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+      });</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+    }</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+    else {</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: checkWksConfirmRequest failed condition\n&quot;);</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+    }</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+  },</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+  /**</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+   * Display Enigmail header with text and specific button</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+   *</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineplus">+   * @param {String} hdrMessage: Message to be displayed in header</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+   * @param {String} buttonLabel: Label of button</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+   * @param {String} requestType: action to be performed</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+   */</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+  displayFlexAction: function(hdrMessage, buttonLabel, requestType) {</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+    if (!Enigmail.msg.securityInfo) {</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+      Enigmail.msg.securityInfo = {};</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+    }</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineplus">+    Enigmail.msg.securityInfo.xtraStatus = requestType;</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineplus">+    Enigmail.msg.securityInfo.statusInfo = hdrMessage;</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineplus">+</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+    // Thunderbird</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+    this.setStatusText(hdrMessage);</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+    this.enigmailBox.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineplus">+    let button = document.getElementById(&quot;enigmail_flexActionButton&quot;);</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+    button.setAttribute(&quot;label&quot;, buttonLabel);</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+    button.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+    document.getElementById(&quot;enigmail_importKey&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineplus">+</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineplus">+    this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureUnknown&quot;);</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineplus">+  },</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineplus">+</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+  /**</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineplus">+   * Display a localized message in lieu of the original message text</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineplus">+   */</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineplus">+  displayWksMessage: function() {</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: displayWksMessage()\n&quot;);</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineplus">+    if (Enigmail.msg.securityInfo.xtraStatus === &quot;wks-request&quot;) {</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+      let enigMsgPane = document.getElementById(&quot;enigmailMsgDisplay&quot;);</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+      let bodyElement = document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineplus">+      bodyElement.setAttribute(&quot;collapsed&quot;, true);</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineplus">+      enigMsgPane.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineplus">+      enigMsgPane.textContent = EnigmailLocale.getString(&quot;wksConfirmationReq.message&quot;);</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineplus">+    }</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineplus">+  },</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineplus">+</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineplus">+  /**</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineplus">+   * Try to import an autocrypt header from an unverified signature</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineplus">+   * (i.e. the sender's key is not available)</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+   */</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineplus">+  tryImportAutocryptHeader: function() {</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: tryImportAutocryptHeader()\n&quot;);</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineplus">+</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineplus">+    if (!(&quot;autocrypt&quot; in currentHeaderData)) return;</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineplus">+    if (!Enigmail.msg.isAutocryptEnabled()) return;</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineplus">+    if (!(&quot;from&quot; in currentHeaderData)) return;</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineplus">+</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineplus">+    let fromEmail = &quot;&quot;;</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+    try {</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+      fromEmail = EnigmailFuncs.stripEmail(currentHeaderData.from.headerValue).toLowerCase();</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    }</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineplus">+    catch (ex) {}</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+    let keys = EnigmailKeyRing.getKeysByUserId(fromEmail, true);</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineplus">+    if (keys.length &gt; 0) return;</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+    EnigmailAutocrypt.importAutocryptKeys([fromEmail]).then(foundKeys =&gt; {</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgComposeOverlay.js: tryImportAutocryptHeader: got &quot; +</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+        foundKeys.length + &quot; autocrypt keys\n&quot;);</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+      if (foundKeys.length &gt; 0) {</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+        let k = EnigmailKeyRing.getKeyById(Enigmail.msg.securityInfo.keyId);</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+        if (k) gDBView.reloadMessageWithAllParts();</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+      }</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+    });</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+  },</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+  /**</span>
<a href="#l2.554"></a><span id="l2.554" class="difflineplus">+   * Display the Enigmail status bar and ask for handling the Setup Message</span>
<a href="#l2.555"></a><span id="l2.555" class="difflineplus">+   */</span>
<a href="#l2.556"></a><span id="l2.556" class="difflineplus">+  displayAutoCryptSetupMsgHeader: function() {</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineplus">+    Enigmail.hdrView.displayFlexAction(EnigmailLocale.getString(&quot;autocryptSetupReq&quot;),</span>
<a href="#l2.558"></a><span id="l2.558" class="difflineplus">+      EnigmailLocale.getString(&quot;autocryptSetupReq.button.label&quot;), &quot;autocrypt-setup&quot;);</span>
<a href="#l2.559"></a><span id="l2.559" class="difflineplus">+    //view.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureUnknown&quot;);</span>
<a href="#l2.560"></a><span id="l2.560" class="difflineplus">+    this.displayAutocryptMessage(true);</span>
<a href="#l2.561"></a><span id="l2.561" class="difflineplus">+  },</span>
<a href="#l2.562"></a><span id="l2.562" class="difflineplus">+</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineplus">+  displayAutocryptMessage: function(allowImport) {</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: displayAutocryptMessage()\n&quot;);</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineplus">+  },</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+  displayStatusBar: function() {</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+    let statusText = document.getElementById(&quot;enigmailStatusText&quot;);</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineplus">+    let expStatusText = document.getElementById(&quot;expandedEnigmailStatusText&quot;);</span>
<a href="#l2.570"></a><span id="l2.570" class="difflineplus">+    let icon = document.getElementById(&quot;enigToggleHeaderView2&quot;);</span>
<a href="#l2.571"></a><span id="l2.571" class="difflineplus">+    let bodyElement = document.getElementById(&quot;messagepanebox&quot;);</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineplus">+</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+    let secInfo = Enigmail.msg.securityInfo;</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+    let statusFlags = secInfo.statusFlags;</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+    let sMimeContainer, encryptedUINode, signedUINode;</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+    if (secInfo.statusArr.length &gt; 0) {</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+      expStatusText.value = secInfo.statusArr[0];</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+      expStatusText.setAttribute(&quot;state&quot;, &quot;true&quot;);</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineplus">+      icon.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineplus">+    }</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineplus">+    else {</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineplus">+      expStatusText.value = &quot;&quot;;</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineplus">+      expStatusText.setAttribute(&quot;state&quot;, &quot;false&quot;);</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineplus">+      icon.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineplus">+    }</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineplus">+    if (secInfo.statusLine) {</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+      this.setStatusText(secInfo.statusLine + &quot; &quot;);</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineplus">+      this.enigmailBox.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineplus">+      this.displayExtendedStatus(true);</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineplus">+</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineplus">+      if ((secInfo.keyId &amp;&amp; (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE)) ||</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineplus">+        (statusFlags &amp; EnigmailConstants.INLINE_KEY)) {</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineplus">+        document.getElementById(&quot;enigmail_importKey&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+      }</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+      else {</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+        document.getElementById(&quot;enigmail_importKey&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineplus">+      }</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineplus">+      document.getElementById(&quot;enigmail_flexActionButton&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.601"></a><span id="l2.601" class="difflineplus">+    }</span>
<a href="#l2.602"></a><span id="l2.602" class="difflineplus">+    else {</span>
<a href="#l2.603"></a><span id="l2.603" class="difflineplus">+      this.setStatusText(&quot;&quot;);</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineplus">+      this.enigmailBox.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineplus">+      this.displayExtendedStatus(false);</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineplus">+    }</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineplus">+</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineplus">+    sMimeContainer = gSMIMEContainer;</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+    signedUINode = gSignedUINode;</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineplus">+    encryptedUINode = gEncryptedUINode;</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+    /* eslint block-scoped-var: 0*/</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineplus">+    if (typeof(sMimeContainer) !== &quot;object&quot;)</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+      return;</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+    if (!sMimeContainer)</span>
<a href="#l2.616"></a><span id="l2.616" class="difflineplus">+      return;</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineplus">+</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineplus">+    // Update icons and header-box css-class</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineplus">+    try {</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineplus">+      sMimeContainer.collapsed = false;</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineplus">+      signedUINode.collapsed = false;</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+      encryptedUINode.collapsed = false;</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+      if ((statusFlags &amp; EnigmailConstants.BAD_SIGNATURE) &amp;&amp;</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineplus">+        !(statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE)) {</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineplus">+        // Display untrusted/bad signature icon</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineplus">+        signedUINode.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureUnknown&quot;);</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+        this.statusBar.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+      }</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+      else if ((statusFlags &amp; EnigmailConstants.GOOD_SIGNATURE) &amp;&amp;</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+        (statusFlags &amp; EnigmailConstants.TRUSTED_IDENTITY) &amp;&amp;</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+        !(statusFlags &amp; (EnigmailConstants.REVOKED_KEY |</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineplus">+          EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+          EnigmailConstants.EXPIRED_SIGNATURE))) {</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+        // Display trusted good signature icon</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+        signedUINode.setAttribute(&quot;signed&quot;, &quot;ok&quot;);</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureOk&quot;);</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineplus">+        this.statusBar.setAttribute(&quot;signed&quot;, &quot;ok&quot;);</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineplus">+        bodyElement.setAttribute(&quot;enigSigned&quot;, &quot;ok&quot;);</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineplus">+      }</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineplus">+      else if (statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineplus">+        // Display unverified signature icon</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineplus">+        signedUINode.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureUnknown&quot;);</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineplus">+        this.statusBar.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineplus">+      }</span>
<a href="#l2.648"></a><span id="l2.648" class="difflineplus">+      else if (statusFlags &amp; (EnigmailConstants.REVOKED_KEY |</span>
<a href="#l2.649"></a><span id="l2.649" class="difflineplus">+          EnigmailConstants.EXPIRED_KEY_SIGNATURE |</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineplus">+          EnigmailConstants.EXPIRED_SIGNATURE |</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineplus">+          EnigmailConstants.GOOD_SIGNATURE)) {</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineplus">+        // Display unverified signature icon</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineplus">+        signedUINode.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureVerified&quot;);</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineplus">+        this.statusBar.setAttribute(&quot;signed&quot;, &quot;unknown&quot;);</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+      }</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+      else if (statusFlags &amp; EnigmailConstants.INLINE_KEY) {</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureUnknown&quot;);</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineplus">+      }</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineplus">+      else {</span>
<a href="#l2.661"></a><span id="l2.661" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelNoSignature&quot;);</span>
<a href="#l2.662"></a><span id="l2.662" class="difflineplus">+      }</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineplus">+</span>
<a href="#l2.664"></a><span id="l2.664" class="difflineplus">+      if (statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineplus">+        EnigmailURIs.rememberEncryptedUri(this.lastEncryptedMsgKey);</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineplus">+</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineplus">+        // Display encrypted icon</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineplus">+        encryptedUINode.setAttribute(&quot;encrypted&quot;, &quot;ok&quot;);</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineplus">+        this.statusBar.setAttribute(&quot;encrypted&quot;, &quot;ok&quot;);</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+      }</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineplus">+      else if (statusFlags &amp;</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+        (EnigmailConstants.DECRYPTION_INCOMPLETE | EnigmailConstants.DECRYPTION_FAILED)) {</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+        // Display un-encrypted icon</span>
<a href="#l2.674"></a><span id="l2.674" class="difflineplus">+        encryptedUINode.setAttribute(&quot;encrypted&quot;, &quot;notok&quot;);</span>
<a href="#l2.675"></a><span id="l2.675" class="difflineplus">+        this.statusBar.setAttribute(&quot;encrypted&quot;, &quot;notok&quot;);</span>
<a href="#l2.676"></a><span id="l2.676" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureNotOk&quot;);</span>
<a href="#l2.677"></a><span id="l2.677" class="difflineplus">+      }</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineplus">+</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineplus">+      // special handling after trying to fix buggy mail format (see buggyExchangeEmailContent in code)</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+      if (secInfo.xtraStatus &amp;&amp; secInfo.xtraStatus == &quot;buggyMailFormat&quot;) {</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineplus">+        this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelBuggyMailFormat&quot;);</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineplus">+      }</span>
<a href="#l2.683"></a><span id="l2.683" class="difflineplus">+    }</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineplus">+    catch (ex) {</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineplus">+      EnigmailLog.writeException(&quot;displayStatusBar&quot;, ex);</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineplus">+    }</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineplus">+  },</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineplus">+</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineplus">+  dispSecurityContext: function() {</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineplus">+</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineplus">+    try {</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+      if (Enigmail.msg.securityInfo) {</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineplus">+        if ((Enigmail.msg.securityInfo.statusFlags &amp; EnigmailConstants.NODATA) &amp;&amp;</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineplus">+          (Enigmail.msg.securityInfo.statusFlags &amp;</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineplus">+            (EnigmailConstants.PGP_MIME_SIGNED | EnigmailConstants.PGP_MIME_ENCRYPTED))) {</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineplus">+          document.getElementById(&quot;enigmail_reloadMessage&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.697"></a><span id="l2.697" class="difflineplus">+        }</span>
<a href="#l2.698"></a><span id="l2.698" class="difflineplus">+        else {</span>
<a href="#l2.699"></a><span id="l2.699" class="difflineplus">+          document.getElementById(&quot;enigmail_reloadMessage&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l2.700"></a><span id="l2.700" class="difflineplus">+        }</span>
<a href="#l2.701"></a><span id="l2.701" class="difflineplus">+      }</span>
<a href="#l2.702"></a><span id="l2.702" class="difflineplus">+</span>
<a href="#l2.703"></a><span id="l2.703" class="difflineplus">+      var optList = [&quot;pgpSecurityInfo&quot;, &quot;copySecurityInfo&quot;];</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineplus">+      for (var j = 0; j &lt; optList.length; j++) {</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+        var menuElement = document.getElementById(&quot;enigmail_&quot; + optList[j]);</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+        if (Enigmail.msg.securityInfo) {</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+          menuElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l2.708"></a><span id="l2.708" class="difflineplus">+        }</span>
<a href="#l2.709"></a><span id="l2.709" class="difflineplus">+        else {</span>
<a href="#l2.710"></a><span id="l2.710" class="difflineplus">+          menuElement.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l2.711"></a><span id="l2.711" class="difflineplus">+        }</span>
<a href="#l2.712"></a><span id="l2.712" class="difflineplus">+      }</span>
<a href="#l2.713"></a><span id="l2.713" class="difflineplus">+</span>
<a href="#l2.714"></a><span id="l2.714" class="difflineplus">+      this.setSenderStatus(&quot;signSenderKey&quot;, &quot;editSenderKeyTrust&quot;, &quot;showPhoto&quot;, &quot;dispKeyDetails&quot;);</span>
<a href="#l2.715"></a><span id="l2.715" class="difflineplus">+    }</span>
<a href="#l2.716"></a><span id="l2.716" class="difflineplus">+    catch (ex) {</span>
<a href="#l2.717"></a><span id="l2.717" class="difflineplus">+      EnigmailLog.ERROR(&quot;error on displaying Security menu:\n&quot; + ex.toString() + &quot;\n&quot;);</span>
<a href="#l2.718"></a><span id="l2.718" class="difflineplus">+    }</span>
<a href="#l2.719"></a><span id="l2.719" class="difflineplus">+  },</span>
<a href="#l2.720"></a><span id="l2.720" class="difflineplus">+</span>
<a href="#l2.721"></a><span id="l2.721" class="difflineplus">+</span>
<a href="#l2.722"></a><span id="l2.722" class="difflineplus">+  updateSendersKeyMenu: function() {</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineplus">+    this.setSenderStatus(&quot;keyMgmtSignKey&quot;,</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineplus">+      &quot;keyMgmtKeyTrust&quot;,</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineplus">+      &quot;keyMgmtShowPhoto&quot;,</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineplus">+      &quot;keyMgmtDispKeyDetails&quot;,</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineplus">+      &quot;importpublickey&quot;);</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineplus">+  },</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineplus">+</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineplus">+  setSenderStatus: function(elemSign, elemTrust, elemPhoto, elemKeyProps, elemImportKey) {</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineplus">+</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+    function setElemStatus(elemName, disabledValue) {</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+      document.getElementById(&quot;enigmail_&quot; + elemName).setAttribute(&quot;disabled&quot;, !disabledValue);</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineplus">+</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineplus">+      let secondElem = document.getElementById(&quot;enigmail_&quot; + elemName + &quot;2&quot;);</span>
<a href="#l2.736"></a><span id="l2.736" class="difflineplus">+      if (secondElem) secondElem.setAttribute(&quot;disabled&quot;, !disabledValue);</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineplus">+    }</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineplus">+</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineplus">+    var photo = false;</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineplus">+    var sign = false;</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineplus">+    var trust = false;</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineplus">+    var unknown = false;</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineplus">+    var signedMsg = false;</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineplus">+    var keyObj = null;</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineplus">+</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineplus">+    if (Enigmail.msg.securityInfo) {</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineplus">+      if (Enigmail.msg.securityInfo.statusFlags &amp; EnigmailConstants.PHOTO_AVAILABLE) {</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+        photo = true;</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+      }</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineplus">+      if (Enigmail.msg.securityInfo.keyId) {</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineplus">+        keyObj = EnigmailKeyRing.getKeyById(Enigmail.msg.securityInfo.keyId);</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineplus">+      }</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineplus">+      if (Enigmail.msg.securityInfo.msgSigned) {</span>
<a href="#l2.754"></a><span id="l2.754" class="difflineplus">+        signedMsg = true;</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineplus">+        if (!(Enigmail.msg.securityInfo.statusFlags &amp;</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineplus">+            (EnigmailConstants.REVOKED_KEY | EnigmailConstants.EXPIRED_KEY_SIGNATURE | EnigmailConstants.UNVERIFIED_SIGNATURE))) {</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineplus">+          sign = true;</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineplus">+        }</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineplus">+        if (keyObj &amp;&amp; keyObj.isOwnerTrustUseful()) {</span>
<a href="#l2.760"></a><span id="l2.760" class="difflineplus">+          trust = true;</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineplus">+        }</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineplus">+</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineplus">+        if (Enigmail.msg.securityInfo.statusFlags &amp; EnigmailConstants.UNVERIFIED_SIGNATURE) {</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineplus">+          unknown = true;</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineplus">+        }</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineplus">+      }</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineplus">+    }</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineplus">+</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineplus">+    if (elemTrust) setElemStatus(elemTrust, trust);</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineplus">+    if (elemSign) setElemStatus(elemSign, sign);</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineplus">+    if (elemPhoto) setElemStatus(elemPhoto, photo);</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineplus">+    if (elemKeyProps) setElemStatus(elemKeyProps, (signedMsg &amp;&amp; !unknown));</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineplus">+    if (elemImportKey) setElemStatus(elemImportKey, unknown);</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineplus">+  },</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineplus">+</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineplus">+  editKeyExpiry: function() {</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineplus">+    EnigmailWindows.editKeyExpiry(window, [Enigmail.msg.securityInfo.userId], [Enigmail.msg.securityInfo.keyId]);</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineplus">+    gDBView.reloadMessageWithAllParts();</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+  },</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineplus">+</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineplus">+  editKeyTrust: function() {</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+    let enigmailSvc = EnigmailCore.getService();</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineplus">+    let key = EnigmailKeyRing.getKeyById(Enigmail.msg.securityInfo.keyId);</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineplus">+</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+    EnigmailWindows.editKeyTrust(window, [Enigmail.msg.securityInfo.userId], [key.keyId]);</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineplus">+    gDBView.reloadMessageWithAllParts();</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineplus">+  },</span>
<a href="#l2.788"></a><span id="l2.788" class="difflineplus">+</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineplus">+  signKey: function() {</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineplus">+    let enigmailSvc = EnigmailCore.getService();</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineplus">+    let key = EnigmailKeyRing.getKeyById(Enigmail.msg.securityInfo.keyId);</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineplus">+</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineplus">+    EnigmailWindows.signKey(window, Enigmail.msg.securityInfo.userId, key.keyId, null);</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineplus">+    gDBView.reloadMessageWithAllParts();</span>
<a href="#l2.795"></a><span id="l2.795" class="difflineplus">+  },</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineplus">+</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineplus">+  msgHdrViewLoad: function() {</span>
<a href="#l2.798"></a><span id="l2.798" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.msgHdrViewLoad\n&quot;);</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineplus">+</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineplus">+    this.messageListener = {</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineplus">+      enigmailBox: document.getElementById(&quot;enigmailBox&quot;),</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineplus">+      onStartHeaders: function _listener_onStartHeaders() {</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: _listener_onStartHeaders\n&quot;);</span>
<a href="#l2.804"></a><span id="l2.804" class="difflineplus">+</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+        try {</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineplus">+          Enigmail.hdrView.statusBarHide();</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineplus">+          EnigmailVerify.setMsgWindow(msgWindow, Enigmail.msg.getCurrentMsgUriSpec());</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineplus">+          Enigmail.hdrView.setStatusText(&quot;&quot;);</span>
<a href="#l2.810"></a><span id="l2.810" class="difflineplus">+          this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureOk&quot;);</span>
<a href="#l2.811"></a><span id="l2.811" class="difflineplus">+</span>
<a href="#l2.812"></a><span id="l2.812" class="difflineplus">+          let msgFrame = EnigmailWindows.getFrame(window, &quot;messagepane&quot;);</span>
<a href="#l2.813"></a><span id="l2.813" class="difflineplus">+          if (!msgFrame) {</span>
<a href="#l2.814"></a><span id="l2.814" class="difflineplus">+            // TB &gt;= 69</span>
<a href="#l2.815"></a><span id="l2.815" class="difflineplus">+            msgFrame = document.getElementById('messagepane').contentDocument;</span>
<a href="#l2.816"></a><span id="l2.816" class="difflineplus">+          }</span>
<a href="#l2.817"></a><span id="l2.817" class="difflineplus">+</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineplus">+          if (msgFrame) {</span>
<a href="#l2.819"></a><span id="l2.819" class="difflineplus">+            msgFrame.addEventListener(&quot;unload&quot;, Enigmail.hdrView.messageUnload.bind(Enigmail.hdrView), true);</span>
<a href="#l2.820"></a><span id="l2.820" class="difflineplus">+            msgFrame.addEventListener(&quot;load&quot;, Enigmail.hdrView.messageLoad.bind(Enigmail.hdrView), true);</span>
<a href="#l2.821"></a><span id="l2.821" class="difflineplus">+          }</span>
<a href="#l2.822"></a><span id="l2.822" class="difflineplus">+</span>
<a href="#l2.823"></a><span id="l2.823" class="difflineplus">+          Enigmail.hdrView.forgetEncryptedMsgKey();</span>
<a href="#l2.824"></a><span id="l2.824" class="difflineplus">+          Enigmail.hdrView.setWindowCallback();</span>
<a href="#l2.825"></a><span id="l2.825" class="difflineplus">+        }</span>
<a href="#l2.826"></a><span id="l2.826" class="difflineplus">+        catch (ex) {}</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineplus">+      },</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineplus">+</span>
<a href="#l2.829"></a><span id="l2.829" class="difflineplus">+      onEndHeaders: function _listener_onEndHeaders() {</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: _listener_onEndHeaders\n&quot;);</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineplus">+</span>
<a href="#l2.832"></a><span id="l2.832" class="difflineplus">+        try {</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineplus">+          Enigmail.hdrView.statusBarHide();</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineplus">+</span>
<a href="#l2.835"></a><span id="l2.835" class="difflineplus">+          this.enigmailBox.setAttribute(&quot;class&quot;, &quot;expandedEnigmailBox enigmailHeaderBoxLabelSignatureOk&quot;);</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineplus">+        }</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineplus">+        catch (ex) {}</span>
<a href="#l2.838"></a><span id="l2.838" class="difflineplus">+      },</span>
<a href="#l2.839"></a><span id="l2.839" class="difflineplus">+</span>
<a href="#l2.840"></a><span id="l2.840" class="difflineplus">+      beforeStartHeaders: function _listener_beforeStartHeaders() {</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineplus">+        return true;</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineplus">+      }</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineplus">+    };</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineplus">+</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineplus">+    gMessageListeners.push(this.messageListener);</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineplus">+</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineplus">+    // fire the handlers since some windows open directly with a visible message</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineplus">+    this.messageListener.onStartHeaders();</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineplus">+    this.messageListener.onEndHeaders();</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineplus">+  },</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineplus">+</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineplus">+  messageUnload: function(event) {</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.messageUnload\n&quot;);</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineplus">+    if (Enigmail.hdrView.flexbuttonAction === null) {</span>
<a href="#l2.855"></a><span id="l2.855" class="difflineplus">+      if (Enigmail.msg.securityInfo &amp;&amp; Enigmail.msg.securityInfo.xtraStatus) {</span>
<a href="#l2.856"></a><span id="l2.856" class="difflineplus">+        Enigmail.msg.securityInfo.xtraStatus = &quot;&quot;;</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineplus">+      }</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineplus">+      this.forgetEncryptedMsgKey();</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineplus">+    }</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineplus">+  },</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineplus">+</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineplus">+  messageLoad: function(event) {</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.messageLoad\n&quot;);</span>
<a href="#l2.864"></a><span id="l2.864" class="difflineplus">+</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineplus">+    Enigmail.msg.messageAutoDecrypt();</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineplus">+    Enigmail.msg.handleAttchmentEvent();</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineplus">+  },</span>
<a href="#l2.868"></a><span id="l2.868" class="difflineplus">+</span>
<a href="#l2.869"></a><span id="l2.869" class="difflineplus">+  copyStatusInfo: function() {</span>
<a href="#l2.870"></a><span id="l2.870" class="difflineplus">+    if (Enigmail.msg.securityInfo) {</span>
<a href="#l2.871"></a><span id="l2.871" class="difflineplus">+      EnigmailClipboard.setClipboardContent(Enigmail.msg.securityInfo.statusInfo);</span>
<a href="#l2.872"></a><span id="l2.872" class="difflineplus">+    }</span>
<a href="#l2.873"></a><span id="l2.873" class="difflineplus">+  },</span>
<a href="#l2.874"></a><span id="l2.874" class="difflineplus">+</span>
<a href="#l2.875"></a><span id="l2.875" class="difflineplus">+  showPhoto: function() {</span>
<a href="#l2.876"></a><span id="l2.876" class="difflineplus">+    if (!Enigmail.msg.securityInfo) return;</span>
<a href="#l2.877"></a><span id="l2.877" class="difflineplus">+</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineplus">+    let enigmailSvc = EnigmailCore.getService();</span>
<a href="#l2.879"></a><span id="l2.879" class="difflineplus">+    let key = EnigmailKeyRing.getKeyById(Enigmail.msg.securityInfo.keyId);</span>
<a href="#l2.880"></a><span id="l2.880" class="difflineplus">+</span>
<a href="#l2.881"></a><span id="l2.881" class="difflineplus">+    EnigmailWindows.showPhoto(window, key.keyId, Enigmail.msg.securityInfo.userId);</span>
<a href="#l2.882"></a><span id="l2.882" class="difflineplus">+  },</span>
<a href="#l2.883"></a><span id="l2.883" class="difflineplus">+</span>
<a href="#l2.884"></a><span id="l2.884" class="difflineplus">+</span>
<a href="#l2.885"></a><span id="l2.885" class="difflineplus">+  dispKeyDetails: function() {</span>
<a href="#l2.886"></a><span id="l2.886" class="difflineplus">+    if (!Enigmail.msg.securityInfo) return;</span>
<a href="#l2.887"></a><span id="l2.887" class="difflineplus">+</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineplus">+    let enigmailSvc = EnigmailCore.getService();</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineplus">+    let key = EnigmailKeyRing.getKeyById(Enigmail.msg.securityInfo.keyId);</span>
<a href="#l2.890"></a><span id="l2.890" class="difflineplus">+</span>
<a href="#l2.891"></a><span id="l2.891" class="difflineplus">+    EnigmailWindows.openKeyDetails(window, key.keyId, false);</span>
<a href="#l2.892"></a><span id="l2.892" class="difflineplus">+  },</span>
<a href="#l2.893"></a><span id="l2.893" class="difflineplus">+</span>
<a href="#l2.894"></a><span id="l2.894" class="difflineplus">+  createRuleFromAddress: function(emailAddressNode) {</span>
<a href="#l2.895"></a><span id="l2.895" class="difflineplus">+    if (emailAddressNode) {</span>
<a href="#l2.896"></a><span id="l2.896" class="difflineplus">+      if (typeof(findEmailNodeFromPopupNode) == &quot;function&quot;) {</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineplus">+        emailAddressNode = findEmailNodeFromPopupNode(emailAddressNode, 'emailAddressPopup');</span>
<a href="#l2.898"></a><span id="l2.898" class="difflineplus">+      }</span>
<a href="#l2.899"></a><span id="l2.899" class="difflineplus">+      EnigmailWindows.createNewRule(window, emailAddressNode.getAttribute(&quot;emailAddress&quot;));</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineplus">+    }</span>
<a href="#l2.901"></a><span id="l2.901" class="difflineplus">+  },</span>
<a href="#l2.902"></a><span id="l2.902" class="difflineplus">+</span>
<a href="#l2.903"></a><span id="l2.903" class="difflineplus">+  forgetEncryptedMsgKey: function() {</span>
<a href="#l2.904"></a><span id="l2.904" class="difflineplus">+    if (Enigmail.hdrView.lastEncryptedMsgKey) {</span>
<a href="#l2.905"></a><span id="l2.905" class="difflineplus">+      EnigmailURIs.forgetEncryptedUri(Enigmail.hdrView.lastEncryptedMsgKey);</span>
<a href="#l2.906"></a><span id="l2.906" class="difflineplus">+      Enigmail.hdrView.lastEncryptedMsgKey = null;</span>
<a href="#l2.907"></a><span id="l2.907" class="difflineplus">+    }</span>
<a href="#l2.908"></a><span id="l2.908" class="difflineplus">+</span>
<a href="#l2.909"></a><span id="l2.909" class="difflineplus">+    if (Enigmail.hdrView.lastEncryptedUri &amp;&amp; gEncryptedURIService) {</span>
<a href="#l2.910"></a><span id="l2.910" class="difflineplus">+      gEncryptedURIService.forgetEncrypted(Enigmail.hdrView.lastEncryptedUri);</span>
<a href="#l2.911"></a><span id="l2.911" class="difflineplus">+      Enigmail.hdrView.lastEncryptedUri = null;</span>
<a href="#l2.912"></a><span id="l2.912" class="difflineplus">+    }</span>
<a href="#l2.913"></a><span id="l2.913" class="difflineplus">+  },</span>
<a href="#l2.914"></a><span id="l2.914" class="difflineplus">+</span>
<a href="#l2.915"></a><span id="l2.915" class="difflineplus">+  displayExtendedStatus: function(displayOn) {</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineplus">+    var expStatusText = document.getElementById(&quot;expandedEnigmailStatusText&quot;);</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineplus">+    if (displayOn &amp;&amp; expStatusText.getAttribute(&quot;state&quot;) == &quot;true&quot;) {</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineplus">+      if (expStatusText.getAttribute(&quot;display&quot;) == &quot;true&quot;) {</span>
<a href="#l2.919"></a><span id="l2.919" class="difflineplus">+        expStatusText.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.920"></a><span id="l2.920" class="difflineplus">+      }</span>
<a href="#l2.921"></a><span id="l2.921" class="difflineplus">+      else {</span>
<a href="#l2.922"></a><span id="l2.922" class="difflineplus">+        expStatusText.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l2.923"></a><span id="l2.923" class="difflineplus">+      }</span>
<a href="#l2.924"></a><span id="l2.924" class="difflineplus">+    }</span>
<a href="#l2.925"></a><span id="l2.925" class="difflineplus">+    else {</span>
<a href="#l2.926"></a><span id="l2.926" class="difflineplus">+      expStatusText.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l2.927"></a><span id="l2.927" class="difflineplus">+    }</span>
<a href="#l2.928"></a><span id="l2.928" class="difflineplus">+  },</span>
<a href="#l2.929"></a><span id="l2.929" class="difflineplus">+</span>
<a href="#l2.930"></a><span id="l2.930" class="difflineplus">+  toggleHeaderView: function() {</span>
<a href="#l2.931"></a><span id="l2.931" class="difflineplus">+    var viewToggle = document.getElementById(&quot;enigToggleHeaderView2&quot;);</span>
<a href="#l2.932"></a><span id="l2.932" class="difflineplus">+    var expandedText = document.getElementById(&quot;expandedEnigmailStatusText&quot;);</span>
<a href="#l2.933"></a><span id="l2.933" class="difflineplus">+    var state = viewToggle.getAttribute(&quot;state&quot;);</span>
<a href="#l2.934"></a><span id="l2.934" class="difflineplus">+</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineplus">+    if (state == &quot;true&quot;) {</span>
<a href="#l2.936"></a><span id="l2.936" class="difflineplus">+      viewToggle.setAttribute(&quot;state&quot;, &quot;false&quot;);</span>
<a href="#l2.937"></a><span id="l2.937" class="difflineplus">+      viewToggle.setAttribute(&quot;class&quot;, &quot;enigmailExpandViewButton&quot;);</span>
<a href="#l2.938"></a><span id="l2.938" class="difflineplus">+      expandedText.setAttribute(&quot;display&quot;, &quot;false&quot;);</span>
<a href="#l2.939"></a><span id="l2.939" class="difflineplus">+      this.displayExtendedStatus(false);</span>
<a href="#l2.940"></a><span id="l2.940" class="difflineplus">+    }</span>
<a href="#l2.941"></a><span id="l2.941" class="difflineplus">+    else {</span>
<a href="#l2.942"></a><span id="l2.942" class="difflineplus">+      viewToggle.setAttribute(&quot;state&quot;, &quot;true&quot;);</span>
<a href="#l2.943"></a><span id="l2.943" class="difflineplus">+      viewToggle.setAttribute(&quot;class&quot;, &quot;enigmailCollapseViewButton&quot;);</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineplus">+      expandedText.setAttribute(&quot;display&quot;, &quot;true&quot;);</span>
<a href="#l2.945"></a><span id="l2.945" class="difflineplus">+      this.displayExtendedStatus(true);</span>
<a href="#l2.946"></a><span id="l2.946" class="difflineplus">+    }</span>
<a href="#l2.947"></a><span id="l2.947" class="difflineplus">+  },</span>
<a href="#l2.948"></a><span id="l2.948" class="difflineplus">+</span>
<a href="#l2.949"></a><span id="l2.949" class="difflineplus">+  onShowAttachmentContextMenu: function(event) {</span>
<a href="#l2.950"></a><span id="l2.950" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.onShowAttachmentContextMenu\n&quot;);</span>
<a href="#l2.951"></a><span id="l2.951" class="difflineplus">+</span>
<a href="#l2.952"></a><span id="l2.952" class="difflineplus">+    let contextMenu, selectedAttachments;</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineplus">+    // Thunderbird</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineplus">+    contextMenu = document.getElementById('attachmentItemContext');</span>
<a href="#l2.955"></a><span id="l2.955" class="difflineplus">+    selectedAttachments = contextMenu.attachments;</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineplus">+</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineplus">+    var decryptOpenMenu = document.getElementById('enigmail_ctxDecryptOpen');</span>
<a href="#l2.958"></a><span id="l2.958" class="difflineplus">+    var decryptSaveMenu = document.getElementById('enigmail_ctxDecryptSave');</span>
<a href="#l2.959"></a><span id="l2.959" class="difflineplus">+    var importMenu = document.getElementById('enigmail_ctxImportKey');</span>
<a href="#l2.960"></a><span id="l2.960" class="difflineplus">+    var verifyMenu = document.getElementById('enigmail_ctxVerifyAtt');</span>
<a href="#l2.961"></a><span id="l2.961" class="difflineplus">+</span>
<a href="#l2.962"></a><span id="l2.962" class="difflineplus">+    if (selectedAttachments.length &gt; 0) {</span>
<a href="#l2.963"></a><span id="l2.963" class="difflineplus">+      this.enableContextMenuEntries(selectedAttachments[0], decryptOpenMenu, decryptSaveMenu, importMenu, verifyMenu);</span>
<a href="#l2.964"></a><span id="l2.964" class="difflineplus">+    }</span>
<a href="#l2.965"></a><span id="l2.965" class="difflineplus">+    else {</span>
<a href="#l2.966"></a><span id="l2.966" class="difflineplus">+      openMenu.setAttribute('disabled', true); /* global openMenu: false */</span>
<a href="#l2.967"></a><span id="l2.967" class="difflineplus">+      saveMenu.setAttribute('disabled', true); /* global saveMenu: false */</span>
<a href="#l2.968"></a><span id="l2.968" class="difflineplus">+      decryptOpenMenu.setAttribute('disabled', true);</span>
<a href="#l2.969"></a><span id="l2.969" class="difflineplus">+      decryptSaveMenu.setAttribute('disabled', true);</span>
<a href="#l2.970"></a><span id="l2.970" class="difflineplus">+      importMenu.setAttribute('disabled', true);</span>
<a href="#l2.971"></a><span id="l2.971" class="difflineplus">+      verifyMenu.setAttribute('disabled', true);</span>
<a href="#l2.972"></a><span id="l2.972" class="difflineplus">+    }</span>
<a href="#l2.973"></a><span id="l2.973" class="difflineplus">+  },</span>
<a href="#l2.974"></a><span id="l2.974" class="difflineplus">+</span>
<a href="#l2.975"></a><span id="l2.975" class="difflineplus">+  enableContextMenuEntries: function(attachment, decryptOpenMenu, decryptSaveMenu, importMenu, verifyMenu) {</span>
<a href="#l2.976"></a><span id="l2.976" class="difflineplus">+    if (attachment.contentType.search(/^application\/pgp-keys/i) === 0) {</span>
<a href="#l2.977"></a><span id="l2.977" class="difflineplus">+      importMenu.removeAttribute('disabled');</span>
<a href="#l2.978"></a><span id="l2.978" class="difflineplus">+      decryptOpenMenu.setAttribute('disabled', true);</span>
<a href="#l2.979"></a><span id="l2.979" class="difflineplus">+      decryptSaveMenu.setAttribute('disabled', true);</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineplus">+      verifyMenu.setAttribute('disabled', true);</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineplus">+    }</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineplus">+    else if (Enigmail.msg.checkEncryptedAttach(attachment)) {</span>
<a href="#l2.983"></a><span id="l2.983" class="difflineplus">+      if ((typeof(attachment.name) !== 'undefined' &amp;&amp; attachment.name.match(/\.asc\.(gpg|pgp)$/i)) ||</span>
<a href="#l2.984"></a><span id="l2.984" class="difflineplus">+        (typeof(attachment.displayName) !== 'undefined' &amp;&amp; attachment.displayName.match(/\.asc\.(gpg|pgp)$/i))) {</span>
<a href="#l2.985"></a><span id="l2.985" class="difflineplus">+        importMenu.removeAttribute('disabled');</span>
<a href="#l2.986"></a><span id="l2.986" class="difflineplus">+      }</span>
<a href="#l2.987"></a><span id="l2.987" class="difflineplus">+      else {</span>
<a href="#l2.988"></a><span id="l2.988" class="difflineplus">+        importMenu.setAttribute('disabled', true);</span>
<a href="#l2.989"></a><span id="l2.989" class="difflineplus">+      }</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineplus">+      decryptOpenMenu.removeAttribute('disabled');</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineplus">+      decryptSaveMenu.removeAttribute('disabled');</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineplus">+      if (EnigmailMsgRead.checkSignedAttachment(attachment, null, currentAttachments)) {</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineplus">+        verifyMenu.removeAttribute('disabled');</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineplus">+      }</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineplus">+      else {</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineplus">+        verifyMenu.setAttribute('disabled', true);</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineplus">+      }</span>
<a href="#l2.998"></a><span id="l2.998" class="difflineplus">+      if (typeof(attachment.displayName) == &quot;undefined&quot;) {</span>
<a href="#l2.999"></a><span id="l2.999" class="difflineplus">+        if (!attachment.name) {</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineplus">+          attachment.name = &quot;message.pgp&quot;;</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineplus">+        }</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineplus">+      }</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineplus">+      else if (!attachment.displayName) {</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineplus">+        attachment.displayName = &quot;message.pgp&quot;;</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineplus">+      }</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+    }</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineplus">+    else if (EnigmailMsgRead.checkSignedAttachment(attachment, null, currentAttachments)) {</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineplus">+      importMenu.setAttribute('disabled', true);</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineplus">+      decryptOpenMenu.setAttribute('disabled', true);</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+      decryptSaveMenu.setAttribute('disabled', true);</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineplus">+      verifyMenu.removeAttribute('disabled');</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineplus">+    }</span>
<a href="#l2.1013"></a><span id="l2.1013" class="difflineplus">+    else {</span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineplus">+      importMenu.setAttribute('disabled', true);</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineplus">+      decryptOpenMenu.setAttribute('disabled', true);</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineplus">+      decryptSaveMenu.setAttribute('disabled', true);</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineplus">+      verifyMenu.setAttribute('disabled', true);</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineplus">+    }</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineplus">+  },</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineplus">+</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineplus">+  updateMsgDb: function() {</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.updateMsgDb\n&quot;);</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineplus">+    var msg = gFolderDisplay.selectedMessage;</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineplus">+    if (!msg || !msg.folder) return;</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineplus">+</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineplus">+    var msgHdr = msg.folder.GetMessageHeader(msg.messageKey);</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineplus">+</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineplus">+    if (this.statusBar.getAttribute(&quot;encrypted&quot;) == &quot;ok&quot;)</span>
<a href="#l2.1029"></a><span id="l2.1029" class="difflineplus">+      Enigmail.msg.securityInfo.statusFlags |= EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineplus">+    msgHdr.setUint32Property(&quot;enigmail&quot;, Enigmail.msg.securityInfo.statusFlags);</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineplus">+  },</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineplus">+</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineplus">+  enigCanDetachAttachments: function() {</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: this.enigCanDetachAttachments\n&quot;);</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineplus">+</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineplus">+    var canDetach = true;</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+    if (Enigmail.msg.securityInfo &amp;&amp; (typeof(Enigmail.msg.securityInfo.statusFlags) != &quot;undefined&quot;)) {</span>
<a href="#l2.1038"></a><span id="l2.1038" class="difflineplus">+      canDetach = ((Enigmail.msg.securityInfo.statusFlags &amp;</span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineplus">+        (EnigmailConstants.PGP_MIME_SIGNED | EnigmailConstants.PGP_MIME_ENCRYPTED)) ? false : true);</span>
<a href="#l2.1040"></a><span id="l2.1040" class="difflineplus">+    }</span>
<a href="#l2.1041"></a><span id="l2.1041" class="difflineplus">+    return canDetach;</span>
<a href="#l2.1042"></a><span id="l2.1042" class="difflineplus">+  },</span>
<a href="#l2.1043"></a><span id="l2.1043" class="difflineplus">+</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineplus">+  fillAttachmentListPopup: function(item) {</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: Enigmail.hdrView.fillAttachmentListPopup\n&quot;);</span>
<a href="#l2.1046"></a><span id="l2.1046" class="difflineplus">+    FillAttachmentListPopup(item);</span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineplus">+</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineplus">+    if (!this.enigCanDetachAttachments()) {</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineplus">+      for (var i = 0; i &lt; item.childNodes.length; i++) {</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineplus">+        if (item.childNodes[i].className == &quot;menu-iconic&quot;) {</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineplus">+          var mnu = item.childNodes[i].firstChild.firstChild;</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineplus">+          while (mnu) {</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineplus">+            if (mnu.getAttribute(&quot;oncommand&quot;).search(/(detachAttachment|deleteAttachment)/) &gt;= 0) {</span>
<a href="#l2.1054"></a><span id="l2.1054" class="difflineplus">+              mnu.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineplus">+            }</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineplus">+            mnu = mnu.nextSibling;</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineplus">+          }</span>
<a href="#l2.1058"></a><span id="l2.1058" class="difflineplus">+        }</span>
<a href="#l2.1059"></a><span id="l2.1059" class="difflineplus">+      }</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineplus">+    }</span>
<a href="#l2.1061"></a><span id="l2.1061" class="difflineplus">+  },</span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineplus">+</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineplus">+  setSubject: function(subject) {</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineplus">+    if (gFolderDisplay.selectedMessages.length === 1 &amp;&amp; gFolderDisplay.selectedMessage) {</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineplus">+      let subj = EnigmailData.convertFromUnicode(subject, &quot;utf-8&quot;);</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineplus">+      if (gFolderDisplay.selectedMessage.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe) {</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineplus">+        subj = subj.replace(/^(Re: )+(.*)/, &quot;$2&quot;);</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineplus">+      }</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineplus">+      gFolderDisplay.selectedMessage.subject = subj;</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineplus">+      this.updateHdrBox(&quot;subject&quot;, subject); // this needs to be the unmodified subject</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineplus">+</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineplus">+      let tt = document.getElementById(&quot;threadTree&quot;);</span>
<a href="#l2.1073"></a><span id="l2.1073" class="difflineplus">+      if (tt &amp;&amp; (&quot;invalidate&quot; in tt)) {</span>
<a href="#l2.1074"></a><span id="l2.1074" class="difflineplus">+        tt.invalidate();</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineplus">+      }</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineplus">+    }</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineplus">+  },</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineplus">+</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineplus">+  updateHdrBox: function(header, value) {</span>
<a href="#l2.1080"></a><span id="l2.1080" class="difflineplus">+    let e = document.getElementById(&quot;expanded&quot; + header + &quot;Box&quot;);</span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineplus">+    if (e) {</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineplus">+      e.headerValue = value;</span>
<a href="#l2.1083"></a><span id="l2.1083" class="difflineplus">+    }</span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineplus">+  },</span>
<a href="#l2.1085"></a><span id="l2.1085" class="difflineplus">+</span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineplus">+  setWindowCallback: function() {</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineplus">+    EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: setWindowCallback\n&quot;);</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineplus">+</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineplus">+    EnigmailSingletons.messageReader = this.headerPane;</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineplus">+  },</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineplus">+</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineplus">+  headerPane: {</span>
<a href="#l2.1093"></a><span id="l2.1093" class="difflineplus">+</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineplus">+    isCurrentMessage: function(uri) {</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineplus">+      let uriSpec = (uri ? uri.spec : null);</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineplus">+</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.isCurrentMessage: uri.spec=&quot; + uriSpec + &quot;\n&quot;);</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+</span>
<a href="#l2.1099"></a><span id="l2.1099" class="difflineplus">+      if (!uriSpec || uriSpec.search(/^enigmail:/) === 0) {</span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineplus">+        // we cannot compare if no URI given or if URI is Enigmail-internal;</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+        // therefore assuming it's the current message</span>
<a href="#l2.1102"></a><span id="l2.1102" class="difflineplus">+        return true;</span>
<a href="#l2.1103"></a><span id="l2.1103" class="difflineplus">+      }</span>
<a href="#l2.1104"></a><span id="l2.1104" class="difflineplus">+</span>
<a href="#l2.1105"></a><span id="l2.1105" class="difflineplus">+      let msgUriSpec = Enigmail.msg.getCurrentMsgUriSpec();</span>
<a href="#l2.1106"></a><span id="l2.1106" class="difflineplus">+</span>
<a href="#l2.1107"></a><span id="l2.1107" class="difflineplus">+      let currUrl = EnigmailCompat.getUrlFromUriSpec(msgUriSpec);</span>
<a href="#l2.1108"></a><span id="l2.1108" class="difflineplus">+      if (!currUrl) {</span>
<a href="#l2.1109"></a><span id="l2.1109" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.isCurrentMessage: could not determine URL\n&quot;);</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineplus">+        currUrl = {</span>
<a href="#l2.1111"></a><span id="l2.1111" class="difflineplus">+          host: &quot;invalid&quot;,</span>
<a href="#l2.1112"></a><span id="l2.1112" class="difflineplus">+          path: &quot;/message&quot;,</span>
<a href="#l2.1113"></a><span id="l2.1113" class="difflineplus">+          scheme: &quot;enigmail&quot;,</span>
<a href="#l2.1114"></a><span id="l2.1114" class="difflineplus">+          spec: &quot;enigmail://invalid/message&quot;,</span>
<a href="#l2.1115"></a><span id="l2.1115" class="difflineplus">+          schemeIs: function(s) {</span>
<a href="#l2.1116"></a><span id="l2.1116" class="difflineplus">+            return s === this.scheme;</span>
<a href="#l2.1117"></a><span id="l2.1117" class="difflineplus">+          }</span>
<a href="#l2.1118"></a><span id="l2.1118" class="difflineplus">+        };</span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineplus">+      }</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineplus">+</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineplus">+      let currMsgId = EnigmailURIs.msgIdentificationFromUrl(currUrl);</span>
<a href="#l2.1122"></a><span id="l2.1122" class="difflineplus">+      let gotMsgId = EnigmailURIs.msgIdentificationFromUrl(uri);</span>
<a href="#l2.1123"></a><span id="l2.1123" class="difflineplus">+</span>
<a href="#l2.1124"></a><span id="l2.1124" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.isCurrentMessage: url=&quot; + currUrl.spec + &quot;\n&quot;);</span>
<a href="#l2.1125"></a><span id="l2.1125" class="difflineplus">+</span>
<a href="#l2.1126"></a><span id="l2.1126" class="difflineplus">+      if (uri.host == currUrl.host &amp;&amp;</span>
<a href="#l2.1127"></a><span id="l2.1127" class="difflineplus">+        currMsgId.folder === gotMsgId.folder &amp;&amp;</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineplus">+        currMsgId.msgNum === gotMsgId.msgNum) {</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.isCurrentMessage: true\n&quot;);</span>
<a href="#l2.1130"></a><span id="l2.1130" class="difflineplus">+        return true;</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineplus">+      }</span>
<a href="#l2.1132"></a><span id="l2.1132" class="difflineplus">+</span>
<a href="#l2.1133"></a><span id="l2.1133" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.isCurrentMessage: false\n&quot;);</span>
<a href="#l2.1134"></a><span id="l2.1134" class="difflineplus">+      return false;</span>
<a href="#l2.1135"></a><span id="l2.1135" class="difflineplus">+    },</span>
<a href="#l2.1136"></a><span id="l2.1136" class="difflineplus">+</span>
<a href="#l2.1137"></a><span id="l2.1137" class="difflineplus">+    /**</span>
<a href="#l2.1138"></a><span id="l2.1138" class="difflineplus">+     * Determine if a given MIME part number is a multipart/related message or a child thereof</span>
<a href="#l2.1139"></a><span id="l2.1139" class="difflineplus">+     *</span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineplus">+     * @param mimePart:      Object - The MIME Part object to evaluate from the MIME tree</span>
<a href="#l2.1141"></a><span id="l2.1141" class="difflineplus">+     * @param searchPartNum: String - The part number to determine</span>
<a href="#l2.1142"></a><span id="l2.1142" class="difflineplus">+     */</span>
<a href="#l2.1143"></a><span id="l2.1143" class="difflineplus">+    isMultipartRelated: function(mimePart, searchPartNum) {</span>
<a href="#l2.1144"></a><span id="l2.1144" class="difflineplus">+      if (searchPartNum.indexOf(mimePart.partNum) == 0 &amp;&amp; mimePart.partNum.length &lt;= searchPartNum.length) {</span>
<a href="#l2.1145"></a><span id="l2.1145" class="difflineplus">+        if (mimePart.fullContentType.search(/^multipart\/related/i) === 0) return true;</span>
<a href="#l2.1146"></a><span id="l2.1146" class="difflineplus">+</span>
<a href="#l2.1147"></a><span id="l2.1147" class="difflineplus">+        for (let i in mimePart.subParts) {</span>
<a href="#l2.1148"></a><span id="l2.1148" class="difflineplus">+          if (this.isMultipartRelated(mimePart.subParts[i], searchPartNum)) return true;</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineplus">+        }</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineplus">+      }</span>
<a href="#l2.1151"></a><span id="l2.1151" class="difflineplus">+      return false;</span>
<a href="#l2.1152"></a><span id="l2.1152" class="difflineplus">+    },</span>
<a href="#l2.1153"></a><span id="l2.1153" class="difflineplus">+</span>
<a href="#l2.1154"></a><span id="l2.1154" class="difflineplus">+    /**</span>
<a href="#l2.1155"></a><span id="l2.1155" class="difflineplus">+     * Determine if a given mime part number should be displayed.</span>
<a href="#l2.1156"></a><span id="l2.1156" class="difflineplus">+     * Returns true if one of these conditions is true:</span>
<a href="#l2.1157"></a><span id="l2.1157" class="difflineplus">+     *  - this is the 1st displayed block of the message</span>
<a href="#l2.1158"></a><span id="l2.1158" class="difflineplus">+     *  - the message part displayed corresonds to the decrypted part</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineplus">+     *</span>
<a href="#l2.1160"></a><span id="l2.1160" class="difflineplus">+     * @param mimePartNumber: String - the MIME part number that was decrypted/verified</span>
<a href="#l2.1161"></a><span id="l2.1161" class="difflineplus">+     * @param uriSpec:        String - the URI spec that is being displayed</span>
<a href="#l2.1162"></a><span id="l2.1162" class="difflineplus">+     */</span>
<a href="#l2.1163"></a><span id="l2.1163" class="difflineplus">+    displaySubPart: function(mimePartNumber, uriSpec) {</span>
<a href="#l2.1164"></a><span id="l2.1164" class="difflineplus">+      if ((!mimePartNumber) || (!uriSpec)) return true;</span>
<a href="#l2.1165"></a><span id="l2.1165" class="difflineplus">+      let part = EnigmailMime.getMimePartNumber(uriSpec);</span>
<a href="#l2.1166"></a><span id="l2.1166" class="difflineplus">+</span>
<a href="#l2.1167"></a><span id="l2.1167" class="difflineplus">+      if (part.length === 0) {</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineplus">+        // only display header if 1st message part</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineplus">+        if (mimePartNumber.search(/^1(\.1)*$/) &lt; 0) return false;</span>
<a href="#l2.1170"></a><span id="l2.1170" class="difflineplus">+      }</span>
<a href="#l2.1171"></a><span id="l2.1171" class="difflineplus">+      else {</span>
<a href="#l2.1172"></a><span id="l2.1172" class="difflineplus">+        let r = EnigmailFuncs.compareMimePartLevel(mimePartNumber, part);</span>
<a href="#l2.1173"></a><span id="l2.1173" class="difflineplus">+</span>
<a href="#l2.1174"></a><span id="l2.1174" class="difflineplus">+        // analyzed mime part is contained in viewed message part</span>
<a href="#l2.1175"></a><span id="l2.1175" class="difflineplus">+        if (r === 2) {</span>
<a href="#l2.1176"></a><span id="l2.1176" class="difflineplus">+          if (mimePartNumber.substr(part.length).search(/^\.1(\.1)*$/) &lt; 0) return false;</span>
<a href="#l2.1177"></a><span id="l2.1177" class="difflineplus">+        }</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineplus">+        else if (r !== 0) return false;</span>
<a href="#l2.1179"></a><span id="l2.1179" class="difflineplus">+</span>
<a href="#l2.1180"></a><span id="l2.1180" class="difflineplus">+        if (Enigmail.msg.mimeParts) {</span>
<a href="#l2.1181"></a><span id="l2.1181" class="difflineplus">+          if (this.isMultipartRelated(Enigmail.msg.mimeParts, mimePartNumber)) return false;</span>
<a href="#l2.1182"></a><span id="l2.1182" class="difflineplus">+        }</span>
<a href="#l2.1183"></a><span id="l2.1183" class="difflineplus">+      }</span>
<a href="#l2.1184"></a><span id="l2.1184" class="difflineplus">+      return true;</span>
<a href="#l2.1185"></a><span id="l2.1185" class="difflineplus">+    },</span>
<a href="#l2.1186"></a><span id="l2.1186" class="difflineplus">+</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineplus">+    /**</span>
<a href="#l2.1188"></a><span id="l2.1188" class="difflineplus">+     * Determine if there are message parts that are not signed/encrypted</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineplus">+     *</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineplus">+     * @param mimePartNumber String - the MIME part number that was authenticated</span>
<a href="#l2.1191"></a><span id="l2.1191" class="difflineplus">+     *</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineplus">+     * @return Boolean: true: there are siblings / false: no siblings</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineplus">+     */</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+    hasUnauthenticatedParts: function(mimePartNumber) {</span>
<a href="#l2.1195"></a><span id="l2.1195" class="difflineplus">+      function hasSiblings(mimePart, searchPartNum, parentNum) {</span>
<a href="#l2.1196"></a><span id="l2.1196" class="difflineplus">+        if (mimePart.partNum === parentNum) {</span>
<a href="#l2.1197"></a><span id="l2.1197" class="difflineplus">+          // if we're a direct child of a PGP/MIME encrypted message, we know that everything</span>
<a href="#l2.1198"></a><span id="l2.1198" class="difflineplus">+          // is authenticated on this level</span>
<a href="#l2.1199"></a><span id="l2.1199" class="difflineplus">+          if (mimePart.fullContentType.search(/^multipart\/encrypted.{1,255}protocol=&quot;?application\/pgp-encrypted&quot;?/i) === 0) return false;</span>
<a href="#l2.1200"></a><span id="l2.1200" class="difflineplus">+        }</span>
<a href="#l2.1201"></a><span id="l2.1201" class="difflineplus">+        if (mimePart.partNum.indexOf(parentNum) == 0 &amp;&amp; mimePart.partNum !== searchPartNum) return true;</span>
<a href="#l2.1202"></a><span id="l2.1202" class="difflineplus">+</span>
<a href="#l2.1203"></a><span id="l2.1203" class="difflineplus">+        for (let i in mimePart.subParts) {</span>
<a href="#l2.1204"></a><span id="l2.1204" class="difflineplus">+          if (hasSiblings(mimePart.subParts[i], searchPartNum, parentNum)) return true;</span>
<a href="#l2.1205"></a><span id="l2.1205" class="difflineplus">+        }</span>
<a href="#l2.1206"></a><span id="l2.1206" class="difflineplus">+</span>
<a href="#l2.1207"></a><span id="l2.1207" class="difflineplus">+        return false;</span>
<a href="#l2.1208"></a><span id="l2.1208" class="difflineplus">+      }</span>
<a href="#l2.1209"></a><span id="l2.1209" class="difflineplus">+</span>
<a href="#l2.1210"></a><span id="l2.1210" class="difflineplus">+      let parentNum = mimePartNumber.replace(/\.\d+$/, &quot;&quot;);</span>
<a href="#l2.1211"></a><span id="l2.1211" class="difflineplus">+      if (mimePartNumber.search(/\./) &lt; 0) {</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineplus">+        parentNum = &quot;&quot;;</span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineplus">+      }</span>
<a href="#l2.1214"></a><span id="l2.1214" class="difflineplus">+</span>
<a href="#l2.1215"></a><span id="l2.1215" class="difflineplus">+      if (mimePartNumber &amp;&amp; Enigmail.msg.mimeParts) {</span>
<a href="#l2.1216"></a><span id="l2.1216" class="difflineplus">+        if (hasSiblings(Enigmail.msg.mimeParts, mimePartNumber, parentNum)) return true;</span>
<a href="#l2.1217"></a><span id="l2.1217" class="difflineplus">+      }</span>
<a href="#l2.1218"></a><span id="l2.1218" class="difflineplus">+</span>
<a href="#l2.1219"></a><span id="l2.1219" class="difflineplus">+      return false;</span>
<a href="#l2.1220"></a><span id="l2.1220" class="difflineplus">+    },</span>
<a href="#l2.1221"></a><span id="l2.1221" class="difflineplus">+</span>
<a href="#l2.1222"></a><span id="l2.1222" class="difflineplus">+    updateSecurityStatus: function(unusedUriSpec, exitCode, statusFlags, keyId, userId, sigDetails, errorMsg, blockSeparation, uri, extraDetails, mimePartNumber) {</span>
<a href="#l2.1223"></a><span id="l2.1223" class="difflineplus">+      // uriSpec is not used for Enigmail anymore. It is here becaue other addons and pEp rely on it</span>
<a href="#l2.1224"></a><span id="l2.1224" class="difflineplus">+</span>
<a href="#l2.1225"></a><span id="l2.1225" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: updateSecurityStatus: mimePart=&quot; + mimePartNumber + &quot;\n&quot;);</span>
<a href="#l2.1226"></a><span id="l2.1226" class="difflineplus">+</span>
<a href="#l2.1227"></a><span id="l2.1227" class="difflineplus">+</span>
<a href="#l2.1228"></a><span id="l2.1228" class="difflineplus">+      let uriSpec = (uri ? uri.spec : null);</span>
<a href="#l2.1229"></a><span id="l2.1229" class="difflineplus">+</span>
<a href="#l2.1230"></a><span id="l2.1230" class="difflineplus">+      if (this.isCurrentMessage(uri)) {</span>
<a href="#l2.1231"></a><span id="l2.1231" class="difflineplus">+</span>
<a href="#l2.1232"></a><span id="l2.1232" class="difflineplus">+        if (statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY) {</span>
<a href="#l2.1233"></a><span id="l2.1233" class="difflineplus">+          if (gEncryptedURIService) {</span>
<a href="#l2.1234"></a><span id="l2.1234" class="difflineplus">+            // remember encrypted message URI to enable TB prevention against EFAIL attack</span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineplus">+            Enigmail.hdrView.lastEncryptedUri = gFolderDisplay.selectedMessageUris[0];</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineplus">+            gEncryptedURIService.rememberEncrypted(Enigmail.hdrView.lastEncryptedUri);</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineplus">+          }</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineplus">+        }</span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineplus">+</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineplus">+        if (!this.displaySubPart(mimePartNumber, uriSpec)) return;</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineplus">+        if (this.hasUnauthenticatedParts(mimePartNumber)) {</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineplus">+          EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: updateSecurityStatus: found unauthenticated part\n&quot;);</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineplus">+          statusFlags |= EnigmailConstants.PARTIALLY_PGP;</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineplus">+        }</span>
<a href="#l2.1245"></a><span id="l2.1245" class="difflineplus">+</span>
<a href="#l2.1246"></a><span id="l2.1246" class="difflineplus">+        let encToDetails = &quot;&quot;;</span>
<a href="#l2.1247"></a><span id="l2.1247" class="difflineplus">+        if (extraDetails &amp;&amp; extraDetails.length &gt; 0) {</span>
<a href="#l2.1248"></a><span id="l2.1248" class="difflineplus">+          try {</span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineplus">+            let o = JSON.parse(extraDetails);</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineplus">+            if (&quot;encryptedTo&quot; in o) {</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineplus">+              encToDetails = o.encryptedTo;</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineplus">+            }</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineplus">+          }</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineplus">+          catch (x) {}</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineplus">+        }</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineplus">+</span>
<a href="#l2.1257"></a><span id="l2.1257" class="difflineplus">+        Enigmail.hdrView.updateHdrIcons(exitCode, statusFlags, keyId, userId, sigDetails,</span>
<a href="#l2.1258"></a><span id="l2.1258" class="difflineplus">+          errorMsg, blockSeparation, encToDetails,</span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineplus">+          null, mimePartNumber);</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineplus">+      }</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineplus">+</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineplus">+      if (uriSpec &amp;&amp; uriSpec.search(/^enigmail:message\//) === 0) {</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineplus">+        // display header for broken MS-Exchange message</span>
<a href="#l2.1264"></a><span id="l2.1264" class="difflineplus">+        // Thunderbird</span>
<a href="#l2.1265"></a><span id="l2.1265" class="difflineplus">+        let ebeb = document.getElementById(&quot;enigmailBrokenExchangeBox&quot;);</span>
<a href="#l2.1266"></a><span id="l2.1266" class="difflineplus">+        ebeb.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l2.1267"></a><span id="l2.1267" class="difflineplus">+      }</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineplus">+</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineplus">+      return;</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineplus">+    },</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineplus">+</span>
<a href="#l2.1272"></a><span id="l2.1272" class="difflineplus">+    processDecryptionResult: function(uri, actionType, processData, mimePartNumber) {</span>
<a href="#l2.1273"></a><span id="l2.1273" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.processDecryptionResult:\n&quot;);</span>
<a href="#l2.1274"></a><span id="l2.1274" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: actionType= &quot; + actionType + &quot;, mimePart=&quot; + mimePartNumber + &quot;\n&quot;);</span>
<a href="#l2.1275"></a><span id="l2.1275" class="difflineplus">+</span>
<a href="#l2.1276"></a><span id="l2.1276" class="difflineplus">+      let msg = gFolderDisplay.selectedMessage;</span>
<a href="#l2.1277"></a><span id="l2.1277" class="difflineplus">+      if (!msg) return;</span>
<a href="#l2.1278"></a><span id="l2.1278" class="difflineplus">+      if (!this.isCurrentMessage(uri) || gFolderDisplay.selectedMessages.length !== 1) return;</span>
<a href="#l2.1279"></a><span id="l2.1279" class="difflineplus">+</span>
<a href="#l2.1280"></a><span id="l2.1280" class="difflineplus">+      switch (actionType) {</span>
<a href="#l2.1281"></a><span id="l2.1281" class="difflineplus">+        case &quot;modifyMessageHeaders&quot;:</span>
<a href="#l2.1282"></a><span id="l2.1282" class="difflineplus">+          this.modifyMessageHeaders(uri, processData, mimePartNumber);</span>
<a href="#l2.1283"></a><span id="l2.1283" class="difflineplus">+          return;</span>
<a href="#l2.1284"></a><span id="l2.1284" class="difflineplus">+        case &quot;wksConfirmRequest&quot;:</span>
<a href="#l2.1285"></a><span id="l2.1285" class="difflineplus">+          Enigmail.hdrView.checkWksConfirmRequest(processData);</span>
<a href="#l2.1286"></a><span id="l2.1286" class="difflineplus">+          return;</span>
<a href="#l2.1287"></a><span id="l2.1287" class="difflineplus">+      }</span>
<a href="#l2.1288"></a><span id="l2.1288" class="difflineplus">+    },</span>
<a href="#l2.1289"></a><span id="l2.1289" class="difflineplus">+</span>
<a href="#l2.1290"></a><span id="l2.1290" class="difflineplus">+    modifyMessageHeaders: function(uri, headerData, mimePartNumber) {</span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.modifyMessageHeaders:\n&quot;);</span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineplus">+</span>
<a href="#l2.1293"></a><span id="l2.1293" class="difflineplus">+      let updateHdrBox = Enigmail.hdrView.updateHdrBox;</span>
<a href="#l2.1294"></a><span id="l2.1294" class="difflineplus">+      let uriSpec = (uri ? uri.spec : null);</span>
<a href="#l2.1295"></a><span id="l2.1295" class="difflineplus">+      let hdr;</span>
<a href="#l2.1296"></a><span id="l2.1296" class="difflineplus">+</span>
<a href="#l2.1297"></a><span id="l2.1297" class="difflineplus">+      try {</span>
<a href="#l2.1298"></a><span id="l2.1298" class="difflineplus">+        hdr = JSON.parse(headerData);</span>
<a href="#l2.1299"></a><span id="l2.1299" class="difflineplus">+      }</span>
<a href="#l2.1300"></a><span id="l2.1300" class="difflineplus">+      catch (ex) {</span>
<a href="#l2.1301"></a><span id="l2.1301" class="difflineplus">+        EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: modifyMessageHeaders: - no headers to display\n&quot;);</span>
<a href="#l2.1302"></a><span id="l2.1302" class="difflineplus">+        return;</span>
<a href="#l2.1303"></a><span id="l2.1303" class="difflineplus">+      }</span>
<a href="#l2.1304"></a><span id="l2.1304" class="difflineplus">+</span>
<a href="#l2.1305"></a><span id="l2.1305" class="difflineplus">+      if (typeof(hdr) !== &quot;object&quot;) return;</span>
<a href="#l2.1306"></a><span id="l2.1306" class="difflineplus">+      if (!this.displaySubPart(mimePartNumber, uriSpec)) return;</span>
<a href="#l2.1307"></a><span id="l2.1307" class="difflineplus">+</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineplus">+      let msg = gFolderDisplay.selectedMessage;</span>
<a href="#l2.1309"></a><span id="l2.1309" class="difflineplus">+</span>
<a href="#l2.1310"></a><span id="l2.1310" class="difflineplus">+      if (&quot;subject&quot; in hdr) {</span>
<a href="#l2.1311"></a><span id="l2.1311" class="difflineplus">+        Enigmail.hdrView.setSubject(hdr.subject);</span>
<a href="#l2.1312"></a><span id="l2.1312" class="difflineplus">+      }</span>
<a href="#l2.1313"></a><span id="l2.1313" class="difflineplus">+</span>
<a href="#l2.1314"></a><span id="l2.1314" class="difflineplus">+      if (&quot;date&quot; in hdr) {</span>
<a href="#l2.1315"></a><span id="l2.1315" class="difflineplus">+        msg.date = Date.parse(hdr.date) * 1000;</span>
<a href="#l2.1316"></a><span id="l2.1316" class="difflineplus">+      }</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineplus">+      /*</span>
<a href="#l2.1318"></a><span id="l2.1318" class="difflineplus">+            if (&quot;newsgroups&quot; in hdr) {</span>
<a href="#l2.1319"></a><span id="l2.1319" class="difflineplus">+              updateHdrBox(&quot;newsgroups&quot;, hdr.newsgroups);</span>
<a href="#l2.1320"></a><span id="l2.1320" class="difflineplus">+            }</span>
<a href="#l2.1321"></a><span id="l2.1321" class="difflineplus">+</span>
<a href="#l2.1322"></a><span id="l2.1322" class="difflineplus">+            if (&quot;followup-to&quot; in hdr) {</span>
<a href="#l2.1323"></a><span id="l2.1323" class="difflineplus">+              updateHdrBox(&quot;followup-to&quot;, hdr[&quot;followup-to&quot;]);</span>
<a href="#l2.1324"></a><span id="l2.1324" class="difflineplus">+            }</span>
<a href="#l2.1325"></a><span id="l2.1325" class="difflineplus">+</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineplus">+            if (&quot;from&quot; in hdr) {</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineplus">+              gExpandedHeaderView.from.outputFunction(gExpandedHeaderView.from, hdr.from);</span>
<a href="#l2.1328"></a><span id="l2.1328" class="difflineplus">+              msg.setStringProperty(&quot;Enigmail-From&quot;, hdr.from);</span>
<a href="#l2.1329"></a><span id="l2.1329" class="difflineplus">+            }</span>
<a href="#l2.1330"></a><span id="l2.1330" class="difflineplus">+</span>
<a href="#l2.1331"></a><span id="l2.1331" class="difflineplus">+            if (&quot;to&quot; in hdr) {</span>
<a href="#l2.1332"></a><span id="l2.1332" class="difflineplus">+              gExpandedHeaderView.to.outputFunction(gExpandedHeaderView.to, hdr.to);</span>
<a href="#l2.1333"></a><span id="l2.1333" class="difflineplus">+              msg.setStringProperty(&quot;Enigmail-To&quot;, hdr.to);</span>
<a href="#l2.1334"></a><span id="l2.1334" class="difflineplus">+            }</span>
<a href="#l2.1335"></a><span id="l2.1335" class="difflineplus">+</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineplus">+            if (&quot;cc&quot; in hdr) {</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineplus">+              gExpandedHeaderView.cc.outputFunction(gExpandedHeaderView.cc, hdr.cc);</span>
<a href="#l2.1338"></a><span id="l2.1338" class="difflineplus">+              msg.setStringProperty(&quot;Enigmail-Cc&quot;, hdr.cc);</span>
<a href="#l2.1339"></a><span id="l2.1339" class="difflineplus">+            }</span>
<a href="#l2.1340"></a><span id="l2.1340" class="difflineplus">+</span>
<a href="#l2.1341"></a><span id="l2.1341" class="difflineplus">+            if (&quot;reply-to&quot; in hdr) {</span>
<a href="#l2.1342"></a><span id="l2.1342" class="difflineplus">+              gExpandedHeaderView[&quot;reply-to&quot;].outputFunction(gExpandedHeaderView[&quot;reply-to&quot;], hdr[&quot;reply-to&quot;]);</span>
<a href="#l2.1343"></a><span id="l2.1343" class="difflineplus">+              msg.setStringProperty(&quot;Enigmail-ReplyTo&quot;, hdr[&quot;reply-to&quot;]);</span>
<a href="#l2.1344"></a><span id="l2.1344" class="difflineplus">+            }</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineplus">+      */</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineplus">+    },</span>
<a href="#l2.1347"></a><span id="l2.1347" class="difflineplus">+</span>
<a href="#l2.1348"></a><span id="l2.1348" class="difflineplus">+    handleSMimeMessage: function(uri) {</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineplus">+      if (this.isCurrentMessage(uri)) {</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineplus">+        EnigmailVerify.unregisterContentTypeHandler();</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineplus">+        Enigmail.msg.messageReload(false);</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+      }</span>
<a href="#l2.1353"></a><span id="l2.1353" class="difflineplus">+    },</span>
<a href="#l2.1354"></a><span id="l2.1354" class="difflineplus">+</span>
<a href="#l2.1355"></a><span id="l2.1355" class="difflineplus">+    maxWantedNesting: function() {</span>
<a href="#l2.1356"></a><span id="l2.1356" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.maxWantedNesting:\n&quot;);</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineplus">+      return this._smimeHeaderSink.maxWantedNesting();</span>
<a href="#l2.1358"></a><span id="l2.1358" class="difflineplus">+    },</span>
<a href="#l2.1359"></a><span id="l2.1359" class="difflineplus">+</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineplus">+    signedStatus: function(aNestingLevel, aSignatureStatus, aSignerCert) {</span>
<a href="#l2.1361"></a><span id="l2.1361" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.signedStatus:\n&quot;);</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineplus">+      return this._smimeHeaderSink.signedStatus(aNestingLevel, aSignatureStatus, aSignerCert);</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineplus">+    },</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineplus">+</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineplus">+    encryptionStatus: function(aNestingLevel, aEncryptionStatus, aRecipientCert) {</span>
<a href="#l2.1366"></a><span id="l2.1366" class="difflineplus">+      EnigmailLog.DEBUG(&quot;enigmailMsgHdrViewOverlay.js: EnigMimeHeaderSink.encryptionStatus:\n&quot;);</span>
<a href="#l2.1367"></a><span id="l2.1367" class="difflineplus">+      return this._smimeHeaderSink.encryptionStatus(aNestingLevel, aEncryptionStatus, aRecipientCert);</span>
<a href="#l2.1368"></a><span id="l2.1368" class="difflineplus">+    }</span>
<a href="#l2.1369"></a><span id="l2.1369" class="difflineplus">+  },</span>
<a href="#l2.1370"></a><span id="l2.1370" class="difflineplus">+</span>
<a href="#l2.1371"></a><span id="l2.1371" class="difflineplus">+  onUnloadEnigmail: function() {</span>
<a href="#l2.1372"></a><span id="l2.1372" class="difflineplus">+    window.removeEventListener(&quot;load-enigmail&quot;, Enigmail.hdrView.hdrViewLoad, false);</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineplus">+    for (let i = 0; i &lt; gMessageListeners.length; i++) {</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineplus">+      if (gMessageListeners[i] === Enigmail.hdrView.messageListener) {</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineplus">+        gMessageListeners.splice(i, 1);</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineplus">+        break;</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineplus">+      }</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineplus">+    }</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineplus">+</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+    let signedHdrElement = document.getElementById(&quot;signedHdrIcon&quot;);</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineplus">+    if (signedHdrElement) {</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+      signedHdrElement.setAttribute(&quot;onclick&quot;, &quot;showMessageReadSecurityInfo();&quot;);</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+    }</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+    let encryptedHdrElement = document.getElementById(&quot;encryptedHdrIcon&quot;);</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineplus">+    if (encryptedHdrElement) {</span>
<a href="#l2.1387"></a><span id="l2.1387" class="difflineplus">+      encryptedHdrElement.setAttribute(&quot;onclick&quot;, &quot;showMessageReadSecurityInfo();&quot;);</span>
<a href="#l2.1388"></a><span id="l2.1388" class="difflineplus">+    }</span>
<a href="#l2.1389"></a><span id="l2.1389" class="difflineplus">+</span>
<a href="#l2.1390"></a><span id="l2.1390" class="difflineplus">+    let addrPopup = document.getElementById(&quot;emailAddressPopup&quot;);</span>
<a href="#l2.1391"></a><span id="l2.1391" class="difflineplus">+    if (addrPopup) {</span>
<a href="#l2.1392"></a><span id="l2.1392" class="difflineplus">+      addrPopup.removeEventListener(&quot;popupshowing&quot;, Enigmail.hdrView.displayAddressPopup, false);</span>
<a href="#l2.1393"></a><span id="l2.1393" class="difflineplus">+    }</span>
<a href="#l2.1394"></a><span id="l2.1394" class="difflineplus">+</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineplus">+    let attCtx = document.getElementById(&quot;attachmentItemContext&quot;);</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineplus">+    if (attCtx) {</span>
<a href="#l2.1397"></a><span id="l2.1397" class="difflineplus">+      attCtx.removeEventListener(&quot;popupshowing&quot;, this.onShowAttachmentContextMenu, false);</span>
<a href="#l2.1398"></a><span id="l2.1398" class="difflineplus">+    }</span>
<a href="#l2.1399"></a><span id="l2.1399" class="difflineplus">+</span>
<a href="#l2.1400"></a><span id="l2.1400" class="difflineplus">+    let msgFrame = EnigmailWindows.getFrame(window, &quot;messagepane&quot;);</span>
<a href="#l2.1401"></a><span id="l2.1401" class="difflineplus">+    if (msgFrame) {</span>
<a href="#l2.1402"></a><span id="l2.1402" class="difflineplus">+      msgFrame.removeEventListener(&quot;unload&quot;, Enigmail.hdrView.messageUnload, true);</span>
<a href="#l2.1403"></a><span id="l2.1403" class="difflineplus">+      msgFrame.removeEventListener(&quot;load&quot;, Enigmail.hdrView.messageLoad, false);</span>
<a href="#l2.1404"></a><span id="l2.1404" class="difflineplus">+    }</span>
<a href="#l2.1405"></a><span id="l2.1405" class="difflineplus">+</span>
<a href="#l2.1406"></a><span id="l2.1406" class="difflineplus">+    CanDetachAttachments = Enigmail.hdrView.origCanDetachAttachments;</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineplus">+  }</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineplus">+};</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineplus">+</span>
<a href="#l2.1410"></a><span id="l2.1410" class="difflineplus">+window.addEventListener(&quot;load-enigmail&quot;, Enigmail.hdrView.hdrViewLoad.bind(Enigmail.hdrView), false);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

