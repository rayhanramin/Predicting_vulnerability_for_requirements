<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14781:b3f560c1484bf872f0d604856781678ee7c41db8</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b3f560c1484bf872f0d604856781678ee7c41db8" />
<meta property="og:url" content="/comm-central/rev/b3f560c1484bf872f0d604856781678ee7c41db8" />
<meta property="og:description" content="Bug 954603 - Add a JavaScript implementation of the XMPP protocol; use it for Google Talk and Facebook Chat. Based on the code developed by Varuna JAYASIRI for Google Summer of Code 2011. Partial reviews by Mook, clokep, aleth, Mic." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b3f560c1484bf872f0d604856781678ee7c41db8 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b3f560c1484bf872f0d604856781678ee7c41db8">shortlog</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b3f560c1484bf872f0d604856781678ee7c41db8">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8">files</a> |
changeset |
<a href="/comm-central/raw-rev/b3f560c1484bf872f0d604856781678ee7c41db8">raw</a>  | <a href="/comm-central/archive/b3f560c1484bf872f0d604856781678ee7c41db8.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954603">Bug 954603</a> - Add a JavaScript implementation of the XMPP protocol; use it for Google Talk and Facebook Chat. Based on the code developed by Varuna JAYASIRI for Google Summer of Code 2011. Partial reviews by Mook, clokep, aleth, Mic.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 06 Dec 2011 19:02:39 +0100</td></tr>

<tr>
 <td>changeset 14781</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b3f560c1484bf872f0d604856781678ee7c41db8">b3f560c1484bf872f0d604856781678ee7c41db8</a></td>
</tr>



<tr>
<td>parent 14780</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/88e2f1caaf2502d76d24938104bb5eea7f369a4e">88e2f1caaf2502d76d24938104bb5eea7f369a4e</a>
</td>
</tr>

<tr>
<td>child 14782</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e6e65ceac1df0d672baf375659f001ca75953dc2">e6e65ceac1df0d672baf375659f001ca75953dc2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b3f560c1484bf872f0d604856781678ee7c41db8">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954603">954603</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=954603">Bug 954603</a> - Add a JavaScript implementation of the XMPP protocol; use it for Google Talk and Facebook Chat. Based on the code developed by Varuna JAYASIRI for Google Summer of Code 2011. Partial reviews by Mook, clokep, aleth, Mic.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/Makefile.in">chat/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/Makefile.in">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/Makefile.in">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/public/imIAccount.idl">chat/components/public/imIAccount.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/public/imIAccount.idl">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/public/imIAccount.idl">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/public/imIAccount.idl">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/public/imIAccount.idl">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/public/imIAccount.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/facebook.properties">chat/locales/en-US/facebook.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/facebook.properties">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/facebook.properties">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/facebook.properties">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/facebook.properties">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/facebook.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/xmpp.properties">chat/locales/en-US/xmpp.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/xmpp.properties">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/xmpp.properties">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/xmpp.properties">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/xmpp.properties">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/en-US/xmpp.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/jar.mn">chat/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/makefiles.sh">chat/makefiles.sh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/makefiles.sh">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/makefiles.sh">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/makefiles.sh">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/makefiles.sh">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/makefiles.sh">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/Makefile.in">chat/protocols/facebook/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/Makefile.in">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/Makefile.in">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.js">chat/protocols/facebook/facebook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.manifest">chat/protocols/facebook/facebook.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.manifest">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.manifest">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.manifest">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.manifest">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/facebook.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-32.png">chat/protocols/facebook/icons/prpl-facebook-32.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-32.png">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-32.png">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-32.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-32.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-32.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-48.png">chat/protocols/facebook/icons/prpl-facebook-48.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-48.png">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-48.png">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-48.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-48.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook-48.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook.png">chat/protocols/facebook/icons/prpl-facebook.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook.png">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook.png">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/icons/prpl-facebook.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/jar.mn">chat/protocols/facebook/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/jar.mn">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/jar.mn">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/jar.mn">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/jar.mn">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/facebook/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/Makefile.in">chat/protocols/gtalk/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/Makefile.in">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/Makefile.in">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.js">chat/protocols/gtalk/gtalk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.manifest">chat/protocols/gtalk/gtalk.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.manifest">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.manifest">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.manifest">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.manifest">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/gtalk.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-32.png">chat/protocols/gtalk/icons/prpl-gtalk-32.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-32.png">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-32.png">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-32.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-32.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-32.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-48.png">chat/protocols/gtalk/icons/prpl-gtalk-48.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-48.png">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-48.png">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-48.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-48.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk-48.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk.png">chat/protocols/gtalk/icons/prpl-gtalk.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk.png">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk.png">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/icons/prpl-gtalk.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/jar.mn">chat/protocols/gtalk/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/jar.mn">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/jar.mn">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/jar.mn">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/jar.mn">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/gtalk/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/jsTest/jsTestProtocol.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/jsTest/jsTestProtocol.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/Makefile.in">chat/protocols/overrides/Makefile.in</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/Makefile.in">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/facebookOverrideProtocol.js">chat/protocols/overrides/facebookOverrideProtocol.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/facebookOverrideProtocol.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/facebookOverrideProtocol.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/facebookOverrideProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/gtalkOverrideProtocol.js">chat/protocols/overrides/gtalkOverrideProtocol.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/gtalkOverrideProtocol.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/gtalkOverrideProtocol.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/gtalkOverrideProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-32.png">chat/protocols/overrides/icons/prpl-facebook-32.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-32.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-32.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-32.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-48.png">chat/protocols/overrides/icons/prpl-facebook-48.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-48.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-48.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook-48.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook.png">chat/protocols/overrides/icons/prpl-facebook.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-facebook.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-32.png">chat/protocols/overrides/icons/prpl-gtalk-32.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-32.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-32.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-32.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-48.png">chat/protocols/overrides/icons/prpl-gtalk-48.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-48.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-48.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk-48.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk.png">chat/protocols/overrides/icons/prpl-gtalk.png</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk.png">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk.png">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/icons/prpl-gtalk.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/jar.mn">chat/protocols/overrides/jar.mn</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/jar.mn">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/jar.mn">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/overrideProtocols.manifest">chat/protocols/overrides/overrideProtocols.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/overrideProtocols.manifest">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/overrideProtocols.manifest">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/overrides/overrideProtocols.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/Makefile.in">chat/protocols/xmpp/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/Makefile.in">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/Makefile.in">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/Makefile.in">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/Makefile.in">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-xml.jsm">chat/protocols/xmpp/xmpp-xml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-xml.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-xml.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-xml.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-xml.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp-xml.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.js">chat/protocols/xmpp/xmpp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.manifest">chat/protocols/xmpp/xmpp.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.manifest">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.manifest">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.manifest">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.manifest">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/chat/protocols/xmpp/xmpp.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/account.js">im/content/account.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/account.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/account.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/account.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/account.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/account.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/accountWizard.js">im/content/accountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/accountWizard.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/accountWizard.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/accountWizard.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/accountWizard.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/accountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/buddytooltip.xml">im/content/buddytooltip.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/buddytooltip.xml">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/buddytooltip.xml">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/buddytooltip.xml">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/buddytooltip.xml">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/buddytooltip.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/conversation.xml">im/content/conversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/conversation.xml">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/conversation.xml">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/conversation.xml">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/conversation.xml">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/conversation.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/joinchat.js">im/content/joinchat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/joinchat.js">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/joinchat.js">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/joinchat.js">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/joinchat.js">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/im/content/joinchat.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/installer/package-manifest.in">im/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/im/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/im/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/im/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/im/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/im/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/purple/purplexpcom/public/purpleIPref.idl">purple/purplexpcom/public/purpleIPref.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b3f560c1484bf872f0d604856781678ee7c41db8/purple/purplexpcom/public/purpleIPref.idl">file</a> |
<a href="/comm-central/annotate/b3f560c1484bf872f0d604856781678ee7c41db8/purple/purplexpcom/public/purpleIPref.idl">annotate</a> |
<a href="/comm-central/diff/b3f560c1484bf872f0d604856781678ee7c41db8/purple/purplexpcom/public/purpleIPref.idl">diff</a> |
<a href="/comm-central/comparison/b3f560c1484bf872f0d604856781678ee7c41db8/purple/purplexpcom/public/purpleIPref.idl">comparison</a> |
<a href="/comm-central/log/b3f560c1484bf872f0d604856781678ee7c41db8/purple/purplexpcom/public/purpleIPref.idl">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -36,17 +36,22 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> DEPTH		= ..</span>
<a href="#l1.6"></a><span id="l1.6"> topsrcdir	= @top_srcdir@</span>
<a href="#l1.7"></a><span id="l1.7"> srcdir		= @srcdir@</span>
<a href="#l1.8"></a><span id="l1.8"> VPATH		= @srcdir@</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-PROTOCOLS = twitter overrides</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+PROTOCOLS = \</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+		facebook \</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+		gtalk \</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+		twitter \</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+		xmpp \</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+		$(NULL)</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> ifdef MOZ_DEBUG</span>
<a href="#l1.21"></a><span id="l1.21"> PROTOCOLS += jsTest</span>
<a href="#l1.22"></a><span id="l1.22"> endif</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24"> PARALLEL_DIRS	= \</span>
<a href="#l1.25"></a><span id="l1.25"> 		components/public \</span>
<a href="#l1.26"></a><span id="l1.26"> 		components/src \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/public/imIAccount.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/public/imIAccount.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -158,16 +158,20 @@ interface prplIAccount: nsISupports {</span>
<a href="#l2.4"></a><span id="l2.4">   const short ERROR_OTHER_ERROR = 16;</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   /* From PurpleConnectionFlags */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   //   PURPLE_CONNECTION_HTML</span>
<a href="#l2.9"></a><span id="l2.9">   //    Connection sends/receives in 'HTML'.</span>
<a href="#l2.10"></a><span id="l2.10">   readonly attribute boolean HTMLEnabled;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  // libpurple expects messages to be HTML escaped even when HTML</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  // isn't enabled. Our js-prpls most likely don't want that behavior.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  readonly attribute boolean HTMLEscapePlainText;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16">   //   PURPLE_CONNECTION_NO_BGCOLOR</span>
<a href="#l2.17"></a><span id="l2.17">   //    Connection does not send/receive background colors.</span>
<a href="#l2.18"></a><span id="l2.18">   readonly attribute boolean noBackgroundColors;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   //   PURPLE_CONNECTION_AUTO_RESP</span>
<a href="#l2.21"></a><span id="l2.21">   //    Send auto responses when away.</span>
<a href="#l2.22"></a><span id="l2.22">   readonly attribute boolean autoResponses;</span>
<a href="#l2.23"></a><span id="l2.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -472,16 +472,17 @@ imAccount.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">     this.prefBranch.setCharPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l3.5"></a><span id="l3.5">     if (this.prplAccount)</span>
<a href="#l3.6"></a><span id="l3.6">       this.prplAccount.setString(aName, aVal);</span>
<a href="#l3.7"></a><span id="l3.7">     SavePrefTimer.initTimer();</span>
<a href="#l3.8"></a><span id="l3.8">   },</span>
<a href="#l3.9"></a><span id="l3.9">   save: function() { SavePrefTimer.saveNow(); },</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11">   get HTMLEnabled() this._ensurePrplAccount.HTMLEnabled,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  get HTMLEscapePlainText() this._ensurePrplAccount.HTMLEscapePlainText,</span>
<a href="#l3.13"></a><span id="l3.13">   get noBackgroundColors() this._ensurePrplAccount.noBackgroundColors,</span>
<a href="#l3.14"></a><span id="l3.14">   get autoResponses() this._ensurePrplAccount.autoResponses,</span>
<a href="#l3.15"></a><span id="l3.15">   get singleFormatting() this._ensurePrplAccount.singleFormatting,</span>
<a href="#l3.16"></a><span id="l3.16">   get noNewlines() this._ensurePrplAccount.noNewlines,</span>
<a href="#l3.17"></a><span id="l3.17">   get noFontSizes() this._ensurePrplAccount.noFontSizes,</span>
<a href="#l3.18"></a><span id="l3.18">   get noUrlDesc() this._ensurePrplAccount.noUrlDesc,</span>
<a href="#l3.19"></a><span id="l3.19">   get noImages() this._ensurePrplAccount.noImages,</span>
<a href="#l3.20"></a><span id="l3.20">   get maxMessageLength() this._ensurePrplAccount.maxMessageLength,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/src/imCore.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -153,17 +153,17 @@ UserStatus.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">   set idleTime(aIdleTime) {</span>
<a href="#l4.5"></a><span id="l4.5">     this._idleTime = aIdleTime;</span>
<a href="#l4.6"></a><span id="l4.6">     this._notifyObservers(&quot;idle-time-changed&quot;, aIdleTime);</span>
<a href="#l4.7"></a><span id="l4.7">   },</span>
<a href="#l4.8"></a><span id="l4.8">   _idle: false,</span>
<a href="#l4.9"></a><span id="l4.9">   _idleStatusText: &quot;&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">   _idleStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l4.11"></a><span id="l4.11">   _checkIdle: function() {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let idleTime = this._idleService.idleTime / 1000;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    let idleTime = Math.floor(this._idleService.idleTime / 1000);</span>
<a href="#l4.14"></a><span id="l4.14">     let idle = this._timeBeforeIdle &amp;&amp; idleTime &gt;= this._timeBeforeIdle;</span>
<a href="#l4.15"></a><span id="l4.15">     if (idle == this._idle)</span>
<a href="#l4.16"></a><span id="l4.16">       return;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">     let statusType = this.statusType;</span>
<a href="#l4.19"></a><span id="l4.19">     let statusText = this.statusText;</span>
<a href="#l4.20"></a><span id="l4.20">     this._idle = idle;</span>
<a href="#l4.21"></a><span id="l4.21">     if (idle) {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -202,17 +202,17 @@ UserStatus.prototype = {</span>
<a href="#l4.23"></a><span id="l4.23">   setUserIcon: function(aIconFile) {</span>
<a href="#l4.24"></a><span id="l4.24">     let folder = this._getProfileDir();</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">     let newName = &quot;&quot;;</span>
<a href="#l4.27"></a><span id="l4.27">     if (aIconFile) {</span>
<a href="#l4.28"></a><span id="l4.28">       // Get the extension (remove trailing dots - invalid Windows extension).</span>
<a href="#l4.29"></a><span id="l4.29">       let ext = aIconFile.leafName.replace(/.*(\.[a-z0-9]+)\.*/i, &quot;$1&quot;);</span>
<a href="#l4.30"></a><span id="l4.30">       // newName = userIcon-&lt;timestamp(now)&gt;.&lt;aIconFile.extension&gt;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      newName = &quot;userIcon-&quot; + (Date.now() / 1000) + ext;</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      newName = &quot;userIcon-&quot; + Math.floor(Date.now() / 1000) + ext;</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">       // Copy the new icon file to newName in the profile folder.</span>
<a href="#l4.35"></a><span id="l4.35">       aIconFile.copyTo(folder, newName);</span>
<a href="#l4.36"></a><span id="l4.36">     }</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">     // Get the previous file name before saving the new file name.</span>
<a href="#l4.39"></a><span id="l4.39">     let oldFileName = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l4.40"></a><span id="l4.40">     Services.prefs.setCharPref(kPrefUserIconFilename, newName);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -348,22 +348,30 @@ CoreService.prototype = {</span>
<a href="#l4.42"></a><span id="l4.42">       return null; // no protocol registered for this id.</span>
<a href="#l4.43"></a><span id="l4.43">     }</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">     let proto = null;</span>
<a href="#l4.46"></a><span id="l4.46">     try {</span>
<a href="#l4.47"></a><span id="l4.47">       proto = Cc[cid].createInstance(Ci.prplIProtocol);</span>
<a href="#l4.48"></a><span id="l4.48">     } catch (e) {</span>
<a href="#l4.49"></a><span id="l4.49">       // This is a real error, the protocol is registered and failed to init.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-      Cu.reportError(e);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      let error = &quot;failed to create an instance of &quot; + cid + &quot;: &quot; + e;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+      dump(error + &quot;\n&quot;);</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+      Cu.reportError(error);</span>
<a href="#l4.54"></a><span id="l4.54">     }</span>
<a href="#l4.55"></a><span id="l4.55">     if (!proto)</span>
<a href="#l4.56"></a><span id="l4.56">       return null;</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-    proto.init(aPrplId);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+    try {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+      proto.init(aPrplId);</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+      return null;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+</span>
<a href="#l4.66"></a><span id="l4.66">     this._protos[aPrplId] = proto;</span>
<a href="#l4.67"></a><span id="l4.67">     return proto;</span>
<a href="#l4.68"></a><span id="l4.68">   },</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70">   QueryInterface: XPCOMUtils.generateQI([Ci.imICoreService]),</span>
<a href="#l4.71"></a><span id="l4.71">   classDescription: &quot;Core&quot;,</span>
<a href="#l4.72"></a><span id="l4.72">   classID: Components.ID(&quot;{073f5953-853c-4a38-bd81-255510c31c2e}&quot;),</span>
<a href="#l4.73"></a><span id="l4.73">   contractID: &quot;@instantbird.org/purple/core-service;1&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/chat/locales/en-US/facebook.properties</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+connection.error.useUsernameNotEmailAddress=Please use your Facebook username, not an email address</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/chat/locales/en-US/xmpp.properties</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,66 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+# LOCALIZATION NOTE (connection.*)</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineplus">+#   These will be displayed in the account manager in order to show the progress</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineplus">+#   of the connection.</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+#   (These will be displayed in account.connection.progress from</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+#    accounts.properties, which adds  at the end, so do not include</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+#    periods at the end of these messages.)</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+connection.initializingStream=Initializing stream</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+connection.initializingEncryption=Initializing encryption</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+connection.authenticating=Authenticating</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+connection.gettingResource=Getting resource</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+connection.downloadingRoster=Downloading contact list</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+# LOCALIZATION NOTE (connection.error.*)</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+#   These will show in the account manager if an error occurs during the</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+#   connection attempt.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+connection.error.failedToCreateASocket=Failed to create a socket (offline?)</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+connection.error.serverClosedConnection=The server closed the connection</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+connection.error.resetByPeer=Connection reset by peer</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+connection.error.timedOut=The connection timed out</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+connection.error.receivedUnexpectedData=Received unexpected data</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+connection.error.incorrectResponse=Received an incorrect response</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+connection.error.startTLSRequired=The server requires encryption but you disabled it</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+connection.error.startTLSNotSupported=The server doesn't support encryption but your configuration requires it</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+connection.error.failedToStartTLS=Failed to start encryption</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+connection.error.noAuthMec=No authentication mechanism offered by the server</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+connection.error.noCompatibleAuthMec=None of the authentication mechanisms offered by the server is supported</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+connection.error.notSendingPasswordInClear=The server only supports authentication by sending the password in clear</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+connection.error.authenticationFailure=Authentication failure</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+connection.error.notAuthorized=Not authorized (wrong password?)</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+connection.error.failedToGetAResource=Failed to get a resource</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+# LOCALIZATION NOTE (tooltip.*):</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+#   These are the titles of lines of information that will appear in</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+#   the tooltip showing details about a contact or conversation.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+# LOCALIZATION NOTE (tooltip.status):</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+#   %S will be replaced by the XMPP resource identifier</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+tooltip.status=Status (%S)</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+tooltip.statusNoResource=Status</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+tooltip.subscription=Subscription</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+# LOCALIZATION NOTE (chatRoomField.*):</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+#   These are the name of fields displayed in the 'Join Chat' dialog</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+#   for XMPP accounts.</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+#   The _ character won't be displayed; it indicates the next</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+#   character of the string should be used as the access key for this</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+#   field.</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+chatRoomField.room=_Room</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+chatRoomField.server=_Server</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+chatRoomField.nick=_Nick</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+chatRoomField.password=_Password</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+# LOCALIZATION NOTE</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+#  Buddies that aren't in any group on the server will appear in this group.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+#  Try to use the same translation as for defaultGroup in instantbird.properties</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+defaultGroup=Contacts</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineplus">+</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineplus">+# LOCALIZATION NOTE (options.*):</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+#   These are the protocol specific options shown in the account manager and</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+#   account wizard windows.</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+options.resource=Resource</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineplus">+options.connectionSecurity=Connection security</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineplus">+options.connectionSecurity.requireEncryption=Require encryption</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+options.connectionSecurity.opportunisticTLS=Use encryption if available</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+options.connectionSecurity.allowUnencryptedAuth=Accept sending the password unencrypted</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+options.connectServer=Server</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+options.connectPort=Port</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/locales/jar.mn</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/locales/jar.mn</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,8 +1,10 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #filter substitution</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> @AB_CD@.jar:</span>
<a href="#l7.7"></a><span id="l7.7"> % locale purple @AB_CD@ %locale/@AB_CD@/purple/</span>
<a href="#l7.8"></a><span id="l7.8"> 	locale/@AB_CD@/purple/commands.properties (%commands.properties)</span>
<a href="#l7.9"></a><span id="l7.9"> 	locale/@AB_CD@/purple/conversations.properties (%conversations.properties)</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+	locale/@AB_CD@/purple/facebook.properties	(%facebook.properties)</span>
<a href="#l7.11"></a><span id="l7.11"> 	locale/@AB_CD@/purple/status.properties (%status.properties)</span>
<a href="#l7.12"></a><span id="l7.12"> 	locale/@AB_CD@/purple/twitter.properties	(%twitter.properties)</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+	locale/@AB_CD@/purple/xmpp.properties	(%xmpp.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/makefiles.sh</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/makefiles.sh</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -36,13 +36,15 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> add_makefiles &quot;</span>
<a href="#l8.6"></a><span id="l8.6"> chat/Makefile</span>
<a href="#l8.7"></a><span id="l8.7"> chat/components/public/Makefile</span>
<a href="#l8.8"></a><span id="l8.8"> chat/components/src/Makefile</span>
<a href="#l8.9"></a><span id="l8.9"> chat/content/Makefile</span>
<a href="#l8.10"></a><span id="l8.10"> chat/locales/Makefile</span>
<a href="#l8.11"></a><span id="l8.11"> chat/modules/Makefile</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+chat/protocols/facebook/Makefile</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+chat/protocols/gtalk/Makefile</span>
<a href="#l8.14"></a><span id="l8.14"> chat/protocols/jsTest/Makefile</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-chat/protocols/overrides/Makefile</span>
<a href="#l8.16"></a><span id="l8.16"> chat/protocols/twitter/Makefile</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+chat/protocols/xmpp/Makefile</span>
<a href="#l8.18"></a><span id="l8.18"> chat/themes/Makefile</span>
<a href="#l8.19"></a><span id="l8.19"> &quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -60,16 +60,18 @@ const DEBUG_WARNING = 3;</span>
<a href="#l9.4"></a><span id="l9.4"> const DEBUG_ERROR = 4;</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> function scriptError(aModule, aLevel, aMessage) {</span>
<a href="#l9.7"></a><span id="l9.7">   // Only continue if we want to see this level of logging.</span>
<a href="#l9.8"></a><span id="l9.8">   let logLevel = Services.prefs.getIntPref(&quot;purple.debug.loglevel&quot;);</span>
<a href="#l9.9"></a><span id="l9.9">   if (logLevel &gt; aLevel)</span>
<a href="#l9.10"></a><span id="l9.10">     return;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  dump(aModule + &quot;: &quot; + aMessage + &quot;\n&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+</span>
<a href="#l9.14"></a><span id="l9.14">   // Log a debug statement.</span>
<a href="#l9.15"></a><span id="l9.15">   if (aLevel == DEBUG_INFO &amp;&amp; logLevel == DEBUG_INFO) {</span>
<a href="#l9.16"></a><span id="l9.16">     Services.console.logStringMessage(aMessage);</span>
<a href="#l9.17"></a><span id="l9.17">     return;</span>
<a href="#l9.18"></a><span id="l9.18">   }</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   let flag = Ci.nsIScriptError.warningFlag;</span>
<a href="#l9.21"></a><span id="l9.21">   if (aLevel &gt;= DEBUG_ERROR)</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -164,21 +166,27 @@ ClassInfo.prototype = {</span>
<a href="#l9.23"></a><span id="l9.23">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.24"></a><span id="l9.24">   flags: 0</span>
<a href="#l9.25"></a><span id="l9.25"> };</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> function l10nHelper(aChromeURL)</span>
<a href="#l9.28"></a><span id="l9.28"> {</span>
<a href="#l9.29"></a><span id="l9.29">   let bundle = Services.strings.createBundle(aChromeURL);</span>
<a href="#l9.30"></a><span id="l9.30">   return function (aStringId) {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    if (arguments.length == 1)</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-      return bundle.GetStringFromName(aStringId);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    return bundle.formatStringFromName(aStringId,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-                                       Array.prototype.slice.call(arguments, 1),</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-                                       arguments.length - 1);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+    try {</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+      if (arguments.length == 1)</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+        return bundle.GetStringFromName(aStringId);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+      return bundle.formatStringFromName(aStringId,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                                         Array.prototype.slice.call(arguments, 1),</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+                                         arguments.length - 1);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+      dump(&quot;Failed to get &quot; + aStringId + &quot;\n&quot;);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+      return aStringId;</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    }</span>
<a href="#l9.47"></a><span id="l9.47">   };</span>
<a href="#l9.48"></a><span id="l9.48"> }</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50"> /**</span>
<a href="#l9.51"></a><span id="l9.51">  * Constructs an nsISimpleEnumerator for the given array of items.</span>
<a href="#l9.52"></a><span id="l9.52">  * Copied from netwerk/test/httpserver/httpd.js</span>
<a href="#l9.53"></a><span id="l9.53">  *</span>
<a href="#l9.54"></a><span id="l9.54">  * @param items : Array</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -193,17 +193,18 @@ const GenericAccountPrototype = {</span>
<a href="#l10.4"></a><span id="l10.4">   get prefs() this._prefs ||</span>
<a href="#l10.5"></a><span id="l10.5">     (this._prefs = Services.prefs.getBranch(&quot;messenger.account.&quot; +</span>
<a href="#l10.6"></a><span id="l10.6">                                             this.imAccount.id + &quot;.options.&quot;)),</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   get normalizedName() normalize(this.name),</span>
<a href="#l10.9"></a><span id="l10.9">   get proxyInfo() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l10.10"></a><span id="l10.10">   set proxyInfo(val) { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  get HTMLEnabled() true,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  get HTMLEnabled() false,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  get HTMLEscapePlainText() false,</span>
<a href="#l10.15"></a><span id="l10.15">   get noBackgroundColors() true,</span>
<a href="#l10.16"></a><span id="l10.16">   get autoResponses() false,</span>
<a href="#l10.17"></a><span id="l10.17">   get singleFormatting() false,</span>
<a href="#l10.18"></a><span id="l10.18">   get noNewlines() false,</span>
<a href="#l10.19"></a><span id="l10.19">   get noFontSizes() false,</span>
<a href="#l10.20"></a><span id="l10.20">   get noUrlDesc() false,</span>
<a href="#l10.21"></a><span id="l10.21">   get noImages() true,</span>
<a href="#l10.22"></a><span id="l10.22">   get maxMessageLength() 0</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -212,22 +213,27 @@ const GenericAccountPrototype = {</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> const GenericAccountBuddyPrototype = {</span>
<a href="#l10.26"></a><span id="l10.26">   __proto__: ClassInfo(&quot;imIAccountBuddy&quot;, &quot;generic account buddy object&quot;),</span>
<a href="#l10.27"></a><span id="l10.27">   _init: function(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l10.28"></a><span id="l10.28">     if (!aBuddy &amp;&amp; !aUserName)</span>
<a href="#l10.29"></a><span id="l10.29">       throw &quot;aUserName is required when aBuddy is null&quot;;</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31">     this._tag = aTag;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-    this._account = aAccount.imAccount;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    this._account = aAccount;</span>
<a href="#l10.34"></a><span id="l10.34">     this._buddy = aBuddy;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+    if (aBuddy) {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+      let displayName = aBuddy.displayName;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+      if (displayName != aUserName)</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+        this._serverAlias = displayName;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+    }</span>
<a href="#l10.40"></a><span id="l10.40">     this._userName = aUserName;</span>
<a href="#l10.41"></a><span id="l10.41">   },</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  get account() this._account,</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  get account() this._account.imAccount,</span>
<a href="#l10.45"></a><span id="l10.45">   set buddy(aBuddy) {</span>
<a href="#l10.46"></a><span id="l10.46">     if (this._buddy)</span>
<a href="#l10.47"></a><span id="l10.47">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l10.48"></a><span id="l10.48">     this._buddy = aBuddy;</span>
<a href="#l10.49"></a><span id="l10.49">   },</span>
<a href="#l10.50"></a><span id="l10.50">   get buddy() this._buddy,</span>
<a href="#l10.51"></a><span id="l10.51">   get tag() this._tag,</span>
<a href="#l10.52"></a><span id="l10.52">   set tag(aNewTag) {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineat">@@ -379,17 +385,17 @@ function Message(aWho, aMessage, aObject</span>
<a href="#l10.54"></a><span id="l10.54"> Message.prototype = GenericMessagePrototype;</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57"> const GenericConversationPrototype = {</span>
<a href="#l10.58"></a><span id="l10.58">   __proto__: ClassInfo(&quot;purpleIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l10.59"></a><span id="l10.59">   flags: Ci.nsIClassInfo.DOM_OBJECT,</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">   _init: function(aAccount, aName) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-    this.account = aAccount.imAccount;</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+    this._account = aAccount;</span>
<a href="#l10.64"></a><span id="l10.64">     this._name = aName;</span>
<a href="#l10.65"></a><span id="l10.65">     this._observers = [];</span>
<a href="#l10.66"></a><span id="l10.66">     Services.conversations.addConversation(this);</span>
<a href="#l10.67"></a><span id="l10.67">   },</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69">   _id: 0,</span>
<a href="#l10.70"></a><span id="l10.70">   get id() this._id,</span>
<a href="#l10.71"></a><span id="l10.71">   set id(aId) {</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineat">@@ -420,20 +426,20 @@ const GenericConversationPrototype = {</span>
<a href="#l10.73"></a><span id="l10.73">     Services.conversations.removeConversation(this);</span>
<a href="#l10.74"></a><span id="l10.74">   },</span>
<a href="#l10.75"></a><span id="l10.75">   unInit: function() { },</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">   writeMessage: function(aWho, aText, aProperties) {</span>
<a href="#l10.78"></a><span id="l10.78">     (new Message(aWho, aText, aProperties)).conversation = this;</span>
<a href="#l10.79"></a><span id="l10.79">   },</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  get account() this._account.imAccount,</span>
<a href="#l10.82"></a><span id="l10.82">   get name() this._name,</span>
<a href="#l10.83"></a><span id="l10.83">   get normalizedName() normalize(this.name),</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  get title() this.name,</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-  account: null</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  get title() this.name</span>
<a href="#l10.87"></a><span id="l10.87"> };</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89"> const GenericConvIMPrototype = {</span>
<a href="#l10.90"></a><span id="l10.90">   __proto__: GenericConversationPrototype,</span>
<a href="#l10.91"></a><span id="l10.91">   _interfaces: [Ci.purpleIConversation, Ci.purpleIConvIM],</span>
<a href="#l10.92"></a><span id="l10.92">   classDescription: &quot;generic ConvIM object&quot;,</span>
<a href="#l10.93"></a><span id="l10.93"> </span>
<a href="#l10.94"></a><span id="l10.94">   updateTyping: function(aState) {</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineat">@@ -526,41 +532,73 @@ function TooltipInfo(aLabel, aValue)</span>
<a href="#l10.96"></a><span id="l10.96">     else {</span>
<a href="#l10.97"></a><span id="l10.97">       this.type = Ci.purpleITooltipInfo.pair;</span>
<a href="#l10.98"></a><span id="l10.98">       this.value = aValue;</span>
<a href="#l10.99"></a><span id="l10.99">     }</span>
<a href="#l10.100"></a><span id="l10.100">   }</span>
<a href="#l10.101"></a><span id="l10.101"> }</span>
<a href="#l10.102"></a><span id="l10.102"> TooltipInfo.prototype = ClassInfo(&quot;purpleITooltipInfo&quot;, &quot;generic tooltip info&quot;);</span>
<a href="#l10.103"></a><span id="l10.103"> </span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-function purplePref(aName, aLabel, aType, aDefaultValue, aMasked) {</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+/* aOption is an object containing:</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+ *  - label: localized text to display (recommended: use a getter with _)</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+ *  - default: the default value for this option. The type of the</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+ *      option will be determined based on the type of the default value.</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+ *      If the default value is a string, the option will be of type</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+ *      list if listValues has been provided. In that case the default</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+ *      value should be one of the listed values.</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+ *  - [optional] listValues: only if this option can only take a list of</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+ *      predefined values. This is an object of the form:</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+ *        {value1: localizedLabel, value2: ...}.</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+ *  - [optional] masked: boolean, if true the UI shouldn't display the value.</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineplus">+ *      This could typically be used for password field.</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineplus">+ *      Warning: The UI currently doesn't support this.</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineplus">+ */</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineplus">+function purplePref(aName, aOption) {</span>
<a href="#l10.120"></a><span id="l10.120">   this.name = aName; // Preference name</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-  this.label = aLabel; // Text to display</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-  this.type = aType;</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-  this._defaultValue = aDefaultValue;</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-  this.masked = !!aMasked; // Obscured from view, ensure boolean</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineplus">+  this.label = aOption.label; // Text to display</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineplus">+</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+  if (aOption.default === undefined || aOption.default === null)</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+    throw &quot;A default value for the option is required to determine its type.&quot;;</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineplus">+  this._defaultValue = aOption.default;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineplus">+</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineplus">+  const types = {boolean: &quot;Bool&quot;, string: &quot;String&quot;, number: &quot;Int&quot;};</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineplus">+  let type = types[typeof aOption.default];</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineplus">+  if (!type)</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineplus">+    throw &quot;Invalid option type&quot;;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+  if (type == &quot;String&quot; &amp;&amp; (&quot;listValues&quot; in aOption)) {</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+    type = &quot;List&quot;;</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+    this._listValues = aOption.listValues;</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+  }</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+  this.type = Ci.purpleIPref[&quot;type&quot; + type];</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+  if (&quot;masked&quot; in aOption &amp;&amp; aOption.masked)</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    this.masked = true;</span>
<a href="#l10.144"></a><span id="l10.144"> }</span>
<a href="#l10.145"></a><span id="l10.145"> purplePref.prototype = {</span>
<a href="#l10.146"></a><span id="l10.146">   __proto__: ClassInfo(&quot;purpleIPref&quot;, &quot;generic account option preference&quot;),</span>
<a href="#l10.147"></a><span id="l10.147"> </span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  masked: false,</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineplus">+</span>
<a href="#l10.150"></a><span id="l10.150">   // Default value</span>
<a href="#l10.151"></a><span id="l10.151">   getBool: function() this._defaultValue,</span>
<a href="#l10.152"></a><span id="l10.152">   getInt: function() this._defaultValue,</span>
<a href="#l10.153"></a><span id="l10.153">   getString: function() this._defaultValue,</span>
<a href="#l10.154"></a><span id="l10.154">   getList: function() {</span>
<a href="#l10.155"></a><span id="l10.155">     // Convert a JavaScript object map {&quot;value 1&quot;: &quot;label 1&quot;, ...}</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-    let keys = Object.keys(this._defaultValue);</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+    let keys = Object.keys(this._listValues);</span>
<a href="#l10.158"></a><span id="l10.158">     if (!keys.length)</span>
<a href="#l10.159"></a><span id="l10.159">       return EmptyEnumerator;</span>
<a href="#l10.160"></a><span id="l10.160"> </span>
<a href="#l10.161"></a><span id="l10.161">     return new nsSimpleEnumerator(</span>
<a href="#l10.162"></a><span id="l10.162">       keys.map(function(key) new purpleKeyValuePair(this[key], key),</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-               this._defaultValue)</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+               this._listValues)</span>
<a href="#l10.165"></a><span id="l10.165">     );</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-  }</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+  },</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+  getListDefault: function() this._defaultValue</span>
<a href="#l10.169"></a><span id="l10.169"> };</span>
<a href="#l10.170"></a><span id="l10.170"> </span>
<a href="#l10.171"></a><span id="l10.171"> function purpleKeyValuePair(aName, aValue) {</span>
<a href="#l10.172"></a><span id="l10.172">   this.name = aName;</span>
<a href="#l10.173"></a><span id="l10.173">   this.value = aValue;</span>
<a href="#l10.174"></a><span id="l10.174"> }</span>
<a href="#l10.175"></a><span id="l10.175"> purpleKeyValuePair.prototype =</span>
<a href="#l10.176"></a><span id="l10.176">   ClassInfo(&quot;purpleIKeyValuePair&quot;, &quot;generic Key Value Pair&quot;);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineat">@@ -627,29 +665,19 @@ const GenericProtocolPrototype = {</span>
<a href="#l10.178"></a><span id="l10.178">     if (this.options &amp;&amp; this.options.hasOwnProperty(aName))</span>
<a href="#l10.179"></a><span id="l10.179">       return this.options[aName].default;</span>
<a href="#l10.180"></a><span id="l10.180">     throw aName + &quot; has no default value in &quot; + this.id + &quot;.&quot;;</span>
<a href="#l10.181"></a><span id="l10.181">   },</span>
<a href="#l10.182"></a><span id="l10.182">   getOptions: function() {</span>
<a href="#l10.183"></a><span id="l10.183">     if (!this.options)</span>
<a href="#l10.184"></a><span id="l10.184">       return EmptyEnumerator;</span>
<a href="#l10.185"></a><span id="l10.185"> </span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-    const types =</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-      {boolean: &quot;Bool&quot;, string: &quot;String&quot;, number: &quot;Int&quot;, object: &quot;List&quot;};</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-</span>
<a href="#l10.189"></a><span id="l10.189">     let purplePrefs = [];</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-    for (let optionName in this.options) {</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-      let option = this.options[optionName];</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-      if (!((typeof option.default) in types))</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-        throw &quot;Invalid type for preference: &quot; + optionName + &quot;.&quot;;</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-      let type = Ci.purpleIPref[&quot;type&quot; + types[typeof option.default]];</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-      purplePrefs.push(new purplePref(optionName, option.label, type,</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-                                      option.default, option.masked));</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-    }</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+    for (let [name, option] in Iterator(this.options))</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineplus">+      purplePrefs.push(new purplePref(name, option));</span>
<a href="#l10.201"></a><span id="l10.201">     return new nsSimpleEnumerator(purplePrefs);</span>
<a href="#l10.202"></a><span id="l10.202">   },</span>
<a href="#l10.203"></a><span id="l10.203">   getUsernameSplit: function() {</span>
<a href="#l10.204"></a><span id="l10.204">     if (!this.usernameSplits || !this.usernameSplits.length)</span>
<a href="#l10.205"></a><span id="l10.205">       return EmptyEnumerator;</span>
<a href="#l10.206"></a><span id="l10.206"> </span>
<a href="#l10.207"></a><span id="l10.207">     return new nsSimpleEnumerator(</span>
<a href="#l10.208"></a><span id="l10.208">       this.usernameSplits.map(function(split) new UsernameSplit(split)));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -108,16 +108,19 @@ const ScriptableInputStream =</span>
<a href="#l11.4"></a><span id="l11.4">   Components.Constructor(&quot;@mozilla.org/scriptableinputstream;1&quot;,</span>
<a href="#l11.5"></a><span id="l11.5">                          &quot;nsIScriptableInputStream&quot;, &quot;init&quot;);</span>
<a href="#l11.6"></a><span id="l11.6"> const ServerSocket =</span>
<a href="#l11.7"></a><span id="l11.7">   Components.Constructor(&quot;@mozilla.org/network/server-socket;1&quot;,</span>
<a href="#l11.8"></a><span id="l11.8">                          &quot;nsIServerSocket&quot;, &quot;init&quot;);</span>
<a href="#l11.9"></a><span id="l11.9"> const InputStreamPump =</span>
<a href="#l11.10"></a><span id="l11.10">   Components.Constructor(&quot;@mozilla.org/network/input-stream-pump;1&quot;,</span>
<a href="#l11.11"></a><span id="l11.11">                          &quot;nsIInputStreamPump&quot;, &quot;init&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+const ScriptableUnicodeConverter =</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  Components.Constructor(&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+                         &quot;nsIScriptableUnicodeConverter&quot;);</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> const Socket = {</span>
<a href="#l11.17"></a><span id="l11.17">   // Use this to use binary mode for the</span>
<a href="#l11.18"></a><span id="l11.18">   binaryMode: false,</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   // Set this for non-binary mode to automatically parse the stream into chunks</span>
<a href="#l11.21"></a><span id="l11.21">   // separated by delimiter.</span>
<a href="#l11.22"></a><span id="l11.22">   delimiter: &quot;&quot;,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineat">@@ -233,16 +236,29 @@ const Socket = {</span>
<a href="#l11.24"></a><span id="l11.24">     try {</span>
<a href="#l11.25"></a><span id="l11.25">       this._outputStream.write(aData + this.delimiter,</span>
<a href="#l11.26"></a><span id="l11.26">                                aData.length + this.delimiter.length);</span>
<a href="#l11.27"></a><span id="l11.27">     } catch(e) {</span>
<a href="#l11.28"></a><span id="l11.28">       Cu.reportError(e);</span>
<a href="#l11.29"></a><span id="l11.29">     }</span>
<a href="#l11.30"></a><span id="l11.30">   },</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  sendString: function(aString, aEncoding) {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    this.log(&quot;Sending:\n&quot; + aString + &quot;\n&quot;);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    let converter = new ScriptableUnicodeConverter();</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+    converter.charset = aEncoding || &quot;UTF-8&quot;;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+    try {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+      let stream = converter.convertToInputStream(aString);</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+      this._outputStream.writeFrom(stream, stream.available());</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+    } catch(e) {</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+    }</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  },</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span>
<a href="#l11.45"></a><span id="l11.45">   sendBinaryData: function(/* ArrayBuffer */ aData) {</span>
<a href="#l11.46"></a><span id="l11.46">     this.log(&quot;Sending binary data data: &lt;&quot; + aData + &quot;&gt;&quot;);</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">     let uint8 = Uint8Array(aData);</span>
<a href="#l11.49"></a><span id="l11.49"> </span>
<a href="#l11.50"></a><span id="l11.50">     // Since there doesn't seem to be a uint8.get() method for the byte array</span>
<a href="#l11.51"></a><span id="l11.51">     let byteArray = [];</span>
<a href="#l11.52"></a><span id="l11.52">     for (let i = 0; i &lt; uint8.byteLength; i++)</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineat">@@ -372,16 +388,38 @@ const Socket = {</span>
<a href="#l11.54"></a><span id="l11.54">   notifyCertProblem: function(aSocketInfo, aStatus, aTargetSite) true,</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">   /*</span>
<a href="#l11.57"></a><span id="l11.57">    * nsISSLErrorListener</span>
<a href="#l11.58"></a><span id="l11.58">    */</span>
<a href="#l11.59"></a><span id="l11.59">   notifySSLError: function(aSocketInfo, aError, aTargetSite) true,</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">   /*</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+   * nsITransportEventSink methods</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+   */</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+  onTransportStatus: function(aTransport, aStatus, aProgress, aProgressmax) {</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    const nsITransportEventSinkStatus = {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+         0x804b0003: &quot;STATUS_RESOLVING&quot;,</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+         0x804b000b: &quot;STATUS_RESOLVED&quot;,</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+         0x804b0007: &quot;STATUS_CONNECTING_TO&quot;,</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+         0x804b0004: &quot;STATUS_CONNECTED_TO&quot;,</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+         0x804b0005: &quot;STATUS_SENDING_TO&quot;,</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+         0x804b000a: &quot;STATUS_WAITING_FOR&quot;,</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+         0x804b0006: &quot;STATUS_RECEIVING_FROM&quot;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+    };</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+    let status = nsITransportEventSinkStatus[aStatus];</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    this.log(&quot;onTransportStatus(&quot; + (status || (&quot;0x&quot; + aStatus.toString(16))) +&quot;)&quot;);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+    if (status == &quot;STATUS_CONNECTED_TO&quot;) {</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+      // Notify that the connection has been established.</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+      this.onConnection();</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+    }</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+  },</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  /*</span>
<a href="#l11.84"></a><span id="l11.84">    *****************************************************************************</span>
<a href="#l11.85"></a><span id="l11.85">    ****************************** Private methods ******************************</span>
<a href="#l11.86"></a><span id="l11.86">    *****************************************************************************</span>
<a href="#l11.87"></a><span id="l11.87">    */</span>
<a href="#l11.88"></a><span id="l11.88">   _resetBuffers: function() {</span>
<a href="#l11.89"></a><span id="l11.89">     this._incomingDataBuffer = this.binaryMode ? [] : &quot;&quot;;</span>
<a href="#l11.90"></a><span id="l11.90">     this._outgoingDataBuffer = [];</span>
<a href="#l11.91"></a><span id="l11.91">   },</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineat">@@ -397,17 +435,17 @@ const Socket = {</span>
<a href="#l11.93"></a><span id="l11.93">                       .getService(Ci.nsISocketTransportService);</span>
<a href="#l11.94"></a><span id="l11.94">     this.transport = socketTS.createTransport(this.security,</span>
<a href="#l11.95"></a><span id="l11.95">                                               this.security.length, this.host,</span>
<a href="#l11.96"></a><span id="l11.96">                                               this.port, this.proxy);</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98">     this._openStreams();</span>
<a href="#l11.99"></a><span id="l11.99">   },</span>
<a href="#l11.100"></a><span id="l11.100"> </span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  // Open the incoming and outgoing sockets.</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+  // Open the incoming and outgoing streams, and init the nsISocketTransport.</span>
<a href="#l11.103"></a><span id="l11.103">   _openStreams: function() {</span>
<a href="#l11.104"></a><span id="l11.104">     // Security notification callbacks (must support nsIBadCertListener2 and</span>
<a href="#l11.105"></a><span id="l11.105">     // nsISSLErrorListener for SSL connections, and possibly other interfaces).</span>
<a href="#l11.106"></a><span id="l11.106">     this.transport.securityCallbacks = this;</span>
<a href="#l11.107"></a><span id="l11.107"> </span>
<a href="#l11.108"></a><span id="l11.108">     // Set the timeouts for the nsISocketTransport for both a connect event and</span>
<a href="#l11.109"></a><span id="l11.109">     // a read/write. Only set them if the user has provided them.</span>
<a href="#l11.110"></a><span id="l11.110">     if (this.connectTimeout) {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineat">@@ -446,19 +484,16 @@ const Socket = {</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113">     this.pump = new InputStreamPump(this._inputStream, // Data to read</span>
<a href="#l11.114"></a><span id="l11.114">                                     -1, // Current offset</span>
<a href="#l11.115"></a><span id="l11.115">                                     -1, // Read all data</span>
<a href="#l11.116"></a><span id="l11.116">                                     0, // Use default segment size</span>
<a href="#l11.117"></a><span id="l11.117">                                     0, // Use default segment length</span>
<a href="#l11.118"></a><span id="l11.118">                                     false); // Do not close when done</span>
<a href="#l11.119"></a><span id="l11.119">     this.pump.asyncRead(this, this);</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-    // Notify that the connection has been established.</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-    this.onConnection();</span>
<a href="#l11.123"></a><span id="l11.123">   },</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125">   /*</span>
<a href="#l11.126"></a><span id="l11.126">    *****************************************************************************</span>
<a href="#l11.127"></a><span id="l11.127">    ********************* Methods for subtypes to override **********************</span>
<a href="#l11.128"></a><span id="l11.128">    *****************************************************************************</span>
<a href="#l11.129"></a><span id="l11.129">    */</span>
<a href="#l11.130"></a><span id="l11.130">   log: function(aString) { },</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineat">@@ -474,21 +509,17 @@ const Socket = {</span>
<a href="#l11.132"></a><span id="l11.132">   onConnectionClosed: function() { },</span>
<a href="#l11.133"></a><span id="l11.133"> </span>
<a href="#l11.134"></a><span id="l11.134">   // Called when ASCII data is available.</span>
<a href="#l11.135"></a><span id="l11.135">   onDataReceived: function(/* string */ aData) { },</span>
<a href="#l11.136"></a><span id="l11.136"> </span>
<a href="#l11.137"></a><span id="l11.137">   // Called when binary data is available.</span>
<a href="#l11.138"></a><span id="l11.138">   onBinaryDataReceived: function(/* ArrayBuffer */ aData) { },</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-  /*</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-   * nsITransportEventSink methods</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-   */</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-  onTransportStatus: function(aTransport, aStatus, aProgress, aProgressmax) { },</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  /* QueryInterface and nsIInterfaceRequestor implementations */</span>
<a href="#l11.146"></a><span id="l11.146">   _interfaces: [Ci.nsIServerSocketListener, Ci.nsIStreamListener,</span>
<a href="#l11.147"></a><span id="l11.147">                 Ci.nsIRequestObserver, Ci.nsITransportEventSink,</span>
<a href="#l11.148"></a><span id="l11.148">                 Ci.nsIBadCertListener2, Ci.nsISSLErrorListener,</span>
<a href="#l11.149"></a><span id="l11.149">                 Ci.nsIProtocolProxyCallback],</span>
<a href="#l11.150"></a><span id="l11.150">   QueryInterface: function(iid) {</span>
<a href="#l11.151"></a><span id="l11.151">     if (iid.equals(Ci.nsISupports) ||</span>
<a href="#l11.152"></a><span id="l11.152">         this._interfaces.some(function(i) i.equals(iid)))</span>
<a href="#l11.153"></a><span id="l11.153">       return this;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/chat/protocols/facebook/Makefile.in</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,49 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+#</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+# License.</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+#</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+#</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+# Florian Quze &lt;florian@queze.net&gt;.</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+#</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+#</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+#</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+DEPTH		= ../../..</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+EXTRA_COMPONENTS = \</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+		facebook.js \</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+		facebook.manifest \</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+		$(NULL)</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/chat/protocols/facebook/facebook.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,85 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ *</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+ *</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+ * License.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ *</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+ *</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+ * Florian Quze &lt;florian@queze.net&gt;.</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+ *</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+ *</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+ *</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  l10nHelper(&quot;chrome://purple/locale/facebook.properties&quot;)</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+function FacebookAccount(aProtoInstance, aImAccount) {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+}</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+FacebookAccount.prototype = {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  __proto__: XMPPAccountPrototype,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+  get canJoinChat() false,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+  connect: function() {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+    if (this.name.indexOf(&quot;@&quot;) == -1)</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      this._jid = this._parseJID(this.name + &quot;@chat.facebook.com/instantbird&quot;);</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+    else {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+      this._jid = this._parseJID(this.name);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+      if (this._jid.domain != &quot;chat.facebook.com&quot;) {</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+        // We can't use this.onError because this._connection doesn't exist.</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+        this.reportDisconnecting(Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+                                 _(&quot;connection.error.useUsernameNotEmailAddress&quot;));</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+        this.reportDisconnected();</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+        return;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+      }</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    }</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+    this._connection = new XMPPSession(&quot;chat.facebook.com&quot;, 5222,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+                                       &quot;opportunistic_tls&quot;, this._jid,</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+                                       this.imAccount.password, this);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  }</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+};</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+function FacebookProtocol() {</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+}</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+FacebookProtocol.prototype = {</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+  get normalizedName() &quot;facebook&quot;,</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  get name() &quot;Facebook Chat&quot;,</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  get iconBaseURI() &quot;chrome://prpl-facebook/skin/&quot;,</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+  getAccount: function(aImAccount) new FacebookAccount(this, aImAccount),</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+  classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;)</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+};</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([FacebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/chat/protocols/facebook/facebook.manifest</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+component {1d1d0bc5-610c-472f-b2cb-4b89857d80dc} facebook.js</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+contract @instantbird.org/purple/facebook;1 {1d1d0bc5-610c-472f-b2cb-4b89857d80dc}</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+category im-protocol-plugin prpl-facebook @instantbird.org/purple/facebook;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">rename from chat/protocols/overrides/icons/prpl-facebook-32.png</span>
<a href="#l15.2"></a><span id="l15.2">rename to chat/protocols/facebook/icons/prpl-facebook-32.png</span>
<a href="#l15.3"></a><span id="l15.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">rename from chat/protocols/overrides/icons/prpl-facebook-48.png</span>
<a href="#l16.2"></a><span id="l16.2">rename to chat/protocols/facebook/icons/prpl-facebook-48.png</span>
<a href="#l16.3"></a><span id="l16.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">rename from chat/protocols/overrides/icons/prpl-facebook.png</span>
<a href="#l17.2"></a><span id="l17.2">rename to chat/protocols/facebook/icons/prpl-facebook.png</span>
<a href="#l17.3"></a><span id="l17.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/chat/protocols/facebook/jar.mn</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+instantbird.jar:</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+% skin prpl-facebook classic/1.0 %skin/classic/prpl/facebook/</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+	skin/classic/prpl/facebook/icon32.png	(icons/prpl-facebook-32.png)</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+	skin/classic/prpl/facebook/icon48.png	(icons/prpl-facebook-48.png)</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+	skin/classic/prpl/facebook/icon.png	(icons/prpl-facebook.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/chat/protocols/gtalk/Makefile.in</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,49 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+#</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+#</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+# License.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+#</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+#</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+# Florian Quze &lt;florian@queze.net&gt;.</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+#</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+#</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+#</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+DEPTH		= ../../..</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+EXTRA_COMPONENTS = \</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+		gtalk.js \</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+		gtalk.manifest \</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+		$(NULL)</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.js</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,92 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ *</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+ *</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ * License.</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+ *</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+ *</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+ * Varuna JAYASIRI &lt;vpjayasiri@gmail.com&gt;.</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+ *</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+ *   Florian Quze &lt;florian@queze.net&gt;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+ *</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+ *</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+  l10nHelper(&quot;chrome://purple/locale/xmpp.properties&quot;)</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+);</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+function GTalkAccount(aProtoInstance, aImAccount) {</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+}</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+GTalkAccount.prototype = {</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+  __proto__: XMPPAccountPrototype,</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+  connect: function() {</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+    this._jid = this._parseJID(this.name);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+    // For the resource, if the user has edited the option to a non</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+    // empty value, use that.</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+      let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+      if (resource)</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+        this._jid.resource = resource;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    }</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+    // Otherwise, if the username doesn't contain a resource, use the</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+    // value of the resource option (it will be the default value).</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+    // If we set an empty resource, XMPPSession will fallback to &quot;instantbird&quot;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+    if (!this._jid.resource)</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+      this._jid.resource = this.getString(&quot;resource&quot;);</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+    this._connection =</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+      new XMPPSession(&quot;talk.google.com&quot;, 443,</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+                      &quot;require_tls&quot;, this._jid,</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+                      this.imAccount.password, this);</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+  }</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+};</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+function GTalkProtocol() {</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+}</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+GTalkProtocol.prototype = {</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+  get normalizedName() &quot;gtalk&quot;,</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+  get name() &quot;Google Talk&quot;,</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  get iconBaseURI() &quot;chrome://prpl-gtalk/skin/&quot;,</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+  getAccount: function(aImAccount) new GTalkAccount(this, aImAccount),</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  options: {</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+    resource: {get label() _(&quot;options.resource&quot;), default: &quot;instantbird&quot;}</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+  },</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+  get chatHasTopic() true,</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+  classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;)</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+};</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([GTalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.manifest</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+component {38a224c1-6748-49a9-8ab2-efc362b1000d} gtalk.js</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+contract @instantbird.org/purple/gtalk;1 {38a224c1-6748-49a9-8ab2-efc362b1000d}</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+category im-protocol-plugin prpl-gtalk @instantbird.org/purple/gtalk;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">rename from chat/protocols/overrides/icons/prpl-gtalk-32.png</span>
<a href="#l22.2"></a><span id="l22.2">rename to chat/protocols/gtalk/icons/prpl-gtalk-32.png</span>
<a href="#l22.3"></a><span id="l22.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">rename from chat/protocols/overrides/icons/prpl-gtalk-48.png</span>
<a href="#l23.2"></a><span id="l23.2">rename to chat/protocols/gtalk/icons/prpl-gtalk-48.png</span>
<a href="#l23.3"></a><span id="l23.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">rename from chat/protocols/overrides/icons/prpl-gtalk.png</span>
<a href="#l24.2"></a><span id="l24.2">rename to chat/protocols/gtalk/icons/prpl-gtalk.png</span>
<a href="#l24.3"></a><span id="l24.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/chat/protocols/gtalk/jar.mn</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+instantbird.jar:</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+% skin prpl-gtalk classic/1.0 %skin/classic/prpl/gtalk/</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+	skin/classic/prpl/gtalk/icon32.png	(icons/prpl-gtalk-32.png)</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+	skin/classic/prpl/gtalk/icon48.png	(icons/prpl-gtalk-48.png)</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+	skin/classic/prpl/gtalk/icon.png	(icons/prpl-gtalk.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -106,18 +106,20 @@ Account.prototype.__proto__ = GenericAcc</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5"> function jsTestProtocol() { }</span>
<a href="#l26.6"></a><span id="l26.6"> jsTestProtocol.prototype = {</span>
<a href="#l26.7"></a><span id="l26.7">   get name() &quot;JS Test&quot;,</span>
<a href="#l26.8"></a><span id="l26.8">   options: {</span>
<a href="#l26.9"></a><span id="l26.9">     &quot;text&quot;: {label: &quot;Text option&quot;,    default: &quot;foo&quot;},</span>
<a href="#l26.10"></a><span id="l26.10">     &quot;bool&quot;: {label: &quot;Boolean option&quot;, default: true},</span>
<a href="#l26.11"></a><span id="l26.11">     &quot;int&quot; : {label: &quot;Integer option&quot;, default: 42},</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    &quot;list&quot;: {label: &quot;Select option&quot;,  default: {&quot;option1&quot;: &quot;Default option&quot;,</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-                                                &quot;option2&quot;: &quot;Other option&quot;}}</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+    &quot;list&quot;: {label: &quot;Select option&quot;,  default: &quot;option2&quot;,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+             listValues: {&quot;option1&quot;: &quot;First option&quot;,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+                          &quot;option2&quot;: &quot;Default option&quot;,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+                          &quot;option3&quot;: &quot;Other option&quot;}}</span>
<a href="#l26.18"></a><span id="l26.18">   },</span>
<a href="#l26.19"></a><span id="l26.19">   usernameSplits: [</span>
<a href="#l26.20"></a><span id="l26.20">     {label: &quot;Server&quot;, separator: &quot;@&quot;, defaultValue: &quot;default.server&quot;,</span>
<a href="#l26.21"></a><span id="l26.21">      reverse: true}</span>
<a href="#l26.22"></a><span id="l26.22">   ],</span>
<a href="#l26.23"></a><span id="l26.23">   getAccount: function(aImAccount) new Account(this, aImAccount),</span>
<a href="#l26.24"></a><span id="l26.24">   classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l26.25"></a><span id="l26.25"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/chat/protocols/overrides/Makefile.in</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,50 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">-#</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-# License.</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-#</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-# The Original Code is mozilla.org code.</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-#</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-#</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-# Contributor(s):</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-#</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-#</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-DEPTH		= ../../..</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-topsrcdir	= @top_srcdir@</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-srcdir		= @srcdir@</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-VPATH		= @srcdir@</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-include $(DEPTH)/config/autoconf.mk</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-EXTRA_COMPONENTS = \</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-		gtalkOverrideProtocol.js \</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-		facebookOverrideProtocol.js \</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-		overrideProtocols.manifest \</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-		$(NULL)</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- a/chat/protocols/overrides/facebookOverrideProtocol.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ /dev/null</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -1,87 +0,0 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineminus">- *</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">- *</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">- * License.</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">- *</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">- * The Original Code is the Instantbird messenging client, released</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">- * 2009.</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">- *</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">- * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineminus">- *</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">- *</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l28.33"></a><span id="l28.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineminus">- *</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineminus">-</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineminus">-Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-function UsernameSplit(aBase, aDefaultValue)</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-{</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-  this.base = aBase;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-  this.defaultValue = aDefaultValue;</span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-}</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-UsernameSplit.prototype = {</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-  __proto__: ClassInfo(&quot;purpleIUsernameSplit&quot;, &quot;username split object&quot;),</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineminus">-</span>
<a href="#l28.55"></a><span id="l28.55" class="difflineminus">-  get reverse() this.base.reverse,</span>
<a href="#l28.56"></a><span id="l28.56" class="difflineminus">-  get separator() this.base.separator,</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineminus">-  get label() this.base.label</span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-}</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-function facebookProtocol() { }</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-facebookProtocol.prototype = {</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-  __proto__: ForwardProtocolPrototype,</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-  get normalizedName() &quot;facebook&quot;,</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-  get name() &quot;Facebook Chat&quot;,</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-facebook/skin/&quot;,</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-  get baseId() &quot;prpl-jabber&quot;,</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineminus">-  getAccount: function(aImAccount) {</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineminus">-    let account = ForwardProtocolPrototype.getAccount.call(this, aImAccount);</span>
<a href="#l28.70"></a><span id="l28.70" class="difflineminus">-    account.__defineGetter__(&quot;canJoinChat&quot;, function() false);</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-    aImAccount.setString(&quot;connection_security&quot;, &quot;opportunistic_tls&quot;);</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-    return account;</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineminus">-  },</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-  getOptions: function() EmptyEnumerator,</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineminus">-  getUsernameSplit: function() {</span>
<a href="#l28.76"></a><span id="l28.76" class="difflineminus">-    var splits = this.base.getUsernameSplit();</span>
<a href="#l28.77"></a><span id="l28.77" class="difflineminus">-    let newSplits = [];</span>
<a href="#l28.78"></a><span id="l28.78" class="difflineminus">-    while (splits.hasMoreElements()) {</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-      let split = splits.getNext();</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-      if (split.defaultValue != &quot;gmail.com&quot;)</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-        newSplits.push(split);</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-      else</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-        newSplits.push(new UsernameSplit(split, &quot;chat.facebook.com&quot;));</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineminus">-    }</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineminus">-    return new nsSimpleEnumerator(newSplits);</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineminus">-  },</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineminus">-</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineminus">-  classID: Components.ID(&quot;{61bc3528-df53-4481-a61a-74c3a2e8c9fd}&quot;)</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineminus">-};</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-const NSGetFactory = XPCOMUtils.generateNSGetFactory([facebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">deleted file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- a/chat/protocols/overrides/gtalkOverrideProtocol.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ /dev/null</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -1,65 +0,0 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineminus">-/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineminus">- * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineminus">- *</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineminus">- * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">- * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">- * the License. You may obtain a copy of the License at</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineminus">- * http://www.mozilla.org/MPL/</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">- *</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">- * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">- * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">- * for the specific language governing rights and limitations under the</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">- * License.</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">- *</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">- * The Original Code is the Instantbird messenging client, released</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">- * 2009.</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">- *</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">- * The Initial Developer of the Original Code is</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">- * Florian QUEZE &lt;florian@instantbird.org&gt;.</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">- * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">- * the Initial Developer. All Rights Reserved.</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">- *</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">- * Contributor(s):</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">- *</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">- * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">- * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">- * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">- * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">- * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">- * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">- * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">- * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineminus">- * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">- * the provisions above, a recipient may use your version of this file under</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">- * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineminus">- *</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineminus">- * ***** END LICENSE BLOCK ***** */</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-const Cu = Components.utils;</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineminus">-</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-function gtalkProtocol() {</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-  this.registerCommands();</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-}</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-gtalkProtocol.prototype = {</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineminus">-  __proto__: ForwardProtocolPrototype,</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineminus">-  get normalizedName() &quot;gtalk&quot;,</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-  get name() &quot;Google Talk&quot;,</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-  get iconBaseURI() &quot;chrome://prpl-gtalk/skin/&quot;,</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-  get baseId() &quot;prpl-jabber&quot;,</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineminus">-</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineminus">-  getAccount: function(aImAccount) {</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineminus">-    let account = ForwardProtocolPrototype.getAccount.call(this, aImAccount);</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-    let connectServer =</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-      /@g(oogle)?mail.com(\/|$)/.test(aImAccount.name) ? &quot;&quot; : &quot;talk.google.com&quot;;</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-    aImAccount.setString(&quot;connect_server&quot;, connectServer);</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-    return account;</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineminus">-  },</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-  getOptions: function() EmptyEnumerator,</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineminus">-</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-  classID: Components.ID(&quot;{ad8a6454-2f5a-40c2-86ca-30062408125e}&quot;)</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-};</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-const NSGetFactory = XPCOMUtils.generateNSGetFactory([gtalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">deleted file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- a/chat/protocols/overrides/jar.mn</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ /dev/null</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineminus">-instantbird.jar:</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">-% skin prpl-gtalk classic/1.0 %skin/classic/prpl/gtalk/</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">-	skin/classic/prpl/gtalk/icon32.png	(icons/prpl-gtalk-32.png)</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">-	skin/classic/prpl/gtalk/icon48.png	(icons/prpl-gtalk-48.png)</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineminus">-	skin/classic/prpl/gtalk/icon.png	(icons/prpl-gtalk.png)</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineminus">-% skin prpl-facebook classic/1.0 %skin/classic/prpl/facebook/</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-	skin/classic/prpl/facebook/icon32.png	(icons/prpl-facebook-32.png)</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-	skin/classic/prpl/facebook/icon48.png	(icons/prpl-facebook-48.png)</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-	skin/classic/prpl/facebook/icon.png	(icons/prpl-facebook.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">deleted file mode 100644</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineminus">--- a/chat/protocols/overrides/overrideProtocols.manifest</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineplus">+++ /dev/null</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">-component {ad8a6454-2f5a-40c2-86ca-30062408125e} gtalkOverrideProtocol.js</span>
<a href="#l31.6"></a><span id="l31.6" class="difflineminus">-contract @instantbird.org/purple/gtalk;1 {ad8a6454-2f5a-40c2-86ca-30062408125e}</span>
<a href="#l31.7"></a><span id="l31.7" class="difflineminus">-category im-protocol-plugin prpl-gtalk @instantbird.org/purple/gtalk;1</span>
<a href="#l31.8"></a><span id="l31.8" class="difflineminus">-component {61bc3528-df53-4481-a61a-74c3a2e8c9fd} facebookOverrideProtocol.js</span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">-contract @instantbird.org/purple/facebook;1 {61bc3528-df53-4481-a61a-74c3a2e8c9fd}</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-category im-protocol-plugin prpl-facebook @instantbird.org/purple/facebook;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -110,17 +110,16 @@ function Action(aLabel, aAction, aTweet)</span>
<a href="#l32.4"></a><span id="l32.4"> }</span>
<a href="#l32.5"></a><span id="l32.5"> Action.prototype = {</span>
<a href="#l32.6"></a><span id="l32.6">   __proto__: ClassInfo(&quot;purpleIMessageAction&quot;, &quot;generic message action object&quot;),</span>
<a href="#l32.7"></a><span id="l32.7">   get run() this._action.bind(this._tweet)</span>
<a href="#l32.8"></a><span id="l32.8"> };</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> function Conversation(aAccount)</span>
<a href="#l32.11"></a><span id="l32.11"> {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  this._account = aAccount;</span>
<a href="#l32.13"></a><span id="l32.13">   this._init(aAccount);</span>
<a href="#l32.14"></a><span id="l32.14">   this._ensureParticipantExists(aAccount.name);</span>
<a href="#l32.15"></a><span id="l32.15"> }</span>
<a href="#l32.16"></a><span id="l32.16"> Conversation.prototype = {</span>
<a href="#l32.17"></a><span id="l32.17">   __proto__: GenericConvChatPrototype,</span>
<a href="#l32.18"></a><span id="l32.18">   unInit: function() { delete this._account._timeline; },</span>
<a href="#l32.19"></a><span id="l32.19">   inReplyToStatusId: null,</span>
<a href="#l32.20"></a><span id="l32.20">   startReply: function(aTweet) {</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineat">@@ -323,17 +322,16 @@ function Account(aProtocol, aImAccount)</span>
<a href="#l32.22"></a><span id="l32.22"> {</span>
<a href="#l32.23"></a><span id="l32.23">   this._init(aProtocol, aImAccount);</span>
<a href="#l32.24"></a><span id="l32.24">   this._knownMessageIds = {};</span>
<a href="#l32.25"></a><span id="l32.25">   this._userInfo = {};</span>
<a href="#l32.26"></a><span id="l32.26"> }</span>
<a href="#l32.27"></a><span id="l32.27"> Account.prototype = {</span>
<a href="#l32.28"></a><span id="l32.28">   __proto__: GenericAccountPrototype,</span>
<a href="#l32.29"></a><span id="l32.29"> </span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-  get HTMLEnabled() false,</span>
<a href="#l32.31"></a><span id="l32.31">   get maxMessageLength() 140,</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33">   consumerKey: &quot;TSuyS1ieRAkB3qWv8yyEw&quot;,</span>
<a href="#l32.34"></a><span id="l32.34">   consumerSecret: &quot;DKtKaSf5a7pBNhdBsSZHTnI5Y03hRlPFYWmb4xXBlkU&quot;,</span>
<a href="#l32.35"></a><span id="l32.35">   completionURI: &quot;http://oauthcallback.local/&quot;,</span>
<a href="#l32.36"></a><span id="l32.36">   baseURI: &quot;https://api.twitter.com/&quot;,</span>
<a href="#l32.37"></a><span id="l32.37"> </span>
<a href="#l32.38"></a><span id="l32.38">   // Use this to keep track of the pending timeline requests. We attempt to fetch</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">new file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- /dev/null</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ b/chat/protocols/xmpp/Makefile.in</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -0,0 +1,56 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineplus">+#</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+#</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+# License.</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+#</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+# The Original Code is mozilla.org code.</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+#</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+# Florian Quze &lt;florian@queze.net&gt;.</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineplus">+#</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+#</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+# either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+# or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+#</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+DEPTH		= ../../..</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+EXTRA_COMPONENTS = \</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+		xmpp.js \</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+		xmpp.manifest \</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+		$(NULL)</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+		xmpp.jsm \</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineplus">+		xmpp-authmechs.jsm \</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+		xmpp-session.jsm \</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+		xmpp-xml.jsm \</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+		$(NULL)</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,149 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+ *</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+ *</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+ * License.</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+ *</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+ *</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+ * Varuna JAYASIRI &lt;vpjayasiri@gmail.com&gt;.</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+ *</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+ *   Florian Quze &lt;florian@queze.net&gt;</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+ *</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+ *</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+// This module exports XMPPAuthMechanisms, an object containing all</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+// the supported SASL authentication mechanisms.</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+// By default we currently support the PLAIN and the DIGEST-MD5 mechanisms.</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+// As this is only used by XMPPSession, it may seem like an internal</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+// detail of the XMPP implementation, but exporting it is valuable so that</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+// add-ons can add support for more auth mechanisms easily by adding them</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+// in XMPPAuthMechanisms without having to modify XMPPSession.</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;XMPPAuthMechanisms&quot;];</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+/* Handle PLAIN authorization mechanism */</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+function PlainAuth(username, password, domain) {</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+  this._username = username;</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+  this._password = password;</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+}</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+PlainAuth.prototype = {</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+  next: function(aStanza) ({</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+    done: true,</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+                      btoa(&quot;\0&quot;+ this._username + &quot;\0&quot; + this._password))</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+  })</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+};</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+/* Handles DIGEST-MD5 authorization mechanism */</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+// md5 function adapted from netwerk/test/unit/test_authentication.js</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+function md5(aString) {</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+  let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+  ch.init(ch.MD5);</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+  let data = [aString.charCodeAt(i) for (i in aString)];</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+  ch.update(data, data.length);</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+  return ch.finish(false);</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+}</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+function md5hex(aString) {</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+  let hash = md5(aString);</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+  function toHexString(charCode) (&quot;0&quot; + charCode.toString(16)).slice(-2)</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+  return [toHexString(hash.charCodeAt(i)) for (i in hash)].join(&quot;&quot;);</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+}</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+function digestMD5(aName, aRealm, aPassword, aNonce, aCnonce, aDigestUri) {</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+  let y = md5(aName + &quot;:&quot; + aRealm + &quot;:&quot; + aPassword);</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  return md5hex(md5hex(y + &quot;:&quot; + aNonce + &quot;:&quot; + aCnonce) +</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+                &quot;:&quot; + aNonce + &quot;:00000001:&quot; + aCnonce + &quot;:auth:&quot; +</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+                md5hex(&quot;AUTHENTICATE:&quot; + aDigestUri));</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineplus">+}</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineplus">+</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+function DigestMD5Auth(username, password, domain) {</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+  this._username = username;</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+  this._password = password;</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+  this._domain = domain;</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+  this.next = this._init;</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+}</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+DigestMD5Auth.prototype = {</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+  _init: function(aStanza) {</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+    this.next = this._generateResponse;</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+    return {</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+      done: false,</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+      send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;DIGEST-MD5&quot;})</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+    };</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+  },</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+  _generateResponse: function(aStanza) {</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+    let decoded = atob(aStanza.innerText.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineplus">+    let data = {realm: &quot;&quot;};</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+    for each (let elem in decoded.split(&quot;,&quot;)) {</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+      let e = elem.split(&quot;=&quot;);</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+      if (e.length != 2)</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+        throw &quot;Error decoding: &quot; + elem;</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+      data[e[0]] = e[1].replace(/&quot;|'/g, &quot;&quot;);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+    }</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+    data.username = this._username;</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+    data.cnonce = md5hex(Math.random() * 1234567890);</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+    data.nc = &quot;00000001&quot;;</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineplus">+    data.qop = &quot;auth&quot;,</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+    data[&quot;digest-uri&quot;] = &quot;xmpp/&quot; + this._domain + (data.host ? &quot;/&quot; + host : &quot;&quot;);</span>
<a href="#l34.125"></a><span id="l34.125" class="difflineplus">+    data.response = digestMD5(this._username, data.realm, this._password,</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineplus">+                              data.nonce, data.cnonce, data[&quot;digest-uri&quot;]);</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineplus">+    data.charset = &quot;utf-8&quot;;</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineplus">+</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineplus">+    let response =</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineplus">+      [&quot;username&quot;, &quot;realm&quot;, &quot;nonce&quot;, &quot;cnonce&quot;, &quot;nc&quot;, &quot;qop&quot;, &quot;digest-uri&quot;,</span>
<a href="#l34.131"></a><span id="l34.131" class="difflineplus">+       &quot;response&quot;, &quot;charset&quot;].map(function(key) key + &quot;=\&quot;&quot; + data[key] + &quot;\&quot;&quot;)</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineplus">+                             .join(&quot;,&quot;);</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineplus">+</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineplus">+    this.next = this._finish;</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineplus">+</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineplus">+    return {</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+      done: false,</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineplus">+      send: Stanza.node(&quot;response&quot;, Stanza.NS.sasl, null, btoa(response))</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineplus">+    };</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineplus">+  },</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineplus">+</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineplus">+  _finish: function(aStanza) {</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineplus">+    if (aStanza.localName != &quot;challenge&quot;)</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineplus">+      throw &quot;Not authorized&quot;;</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineplus">+</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineplus">+    return {</span>
<a href="#l34.147"></a><span id="l34.147" class="difflineplus">+      done: true,</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineplus">+      send: Stanza.node(&quot;response&quot;, Stanza.NS.sasl)</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineplus">+    };</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineplus">+  }</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineplus">+};</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineplus">+</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineplus">+var XMPPAuthMechanisms = {&quot;PLAIN&quot;: PlainAuth, &quot;DIGEST-MD5&quot;: DigestMD5Auth};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,378 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+ *</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+ *</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ * License.</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+ *</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+ *</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+ * Varuna JAYASIRI &lt;vpjayasiri@gmail.com&gt;.</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+ *</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+ *   Florian Quze &lt;florian@queze.net&gt;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+ *</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineplus">+ *</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineplus">+</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;XMPPSession&quot;];</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+</span>
<a href="#l35.44"></a><span id="l35.44" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineplus">+const Ci = Components.interfaces;</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineplus">+Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-authmechs.jsm&quot;);</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+initLogModule(&quot;xmpp-session&quot;, this);</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+  l10nHelper(&quot;chrome://purple/locale/xmpp.properties&quot;)</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineplus">+);</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineplus">+</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+function XMPPSession(aHost, aPort, aSecurity, aJID, aPassword, aAccount) {</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+  this._host = aHost;</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineplus">+  this._port = aPort;</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+  this._connectionSecurity = aSecurity;</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineplus">+  if (this._connectionSecurity == &quot;old_ssl&quot;)</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+    this._security = [&quot;ssl&quot;];</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineplus">+  else if (this._connectionSecurity != &quot;none&quot;)</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineplus">+    this._security = [(aPort == 5223 || aPort == 443) ? &quot;ssl&quot; : &quot;starttls&quot;];</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineplus">+  this._jid = aJID;</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineplus">+  this._domain = aJID.domain;</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineplus">+  this._password = aPassword;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l35.72"></a><span id="l35.72" class="difflineplus">+</span>
<a href="#l35.73"></a><span id="l35.73" class="difflineplus">+  this._auth = null;</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  this._resource = aJID.resource || &quot;instantbird&quot;;</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineplus">+  this._handlers = {};</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+  this._stanzaId = 0;</span>
<a href="#l35.77"></a><span id="l35.77" class="difflineplus">+</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineplus">+  this._account.reportConnecting();</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+  try {</span>
<a href="#l35.80"></a><span id="l35.80" class="difflineplus">+    this.connect(this._host, this._port, this._security);</span>
<a href="#l35.81"></a><span id="l35.81" class="difflineplus">+  } catch (e) {</span>
<a href="#l35.82"></a><span id="l35.82" class="difflineplus">+    Cu.reportError(e);</span>
<a href="#l35.83"></a><span id="l35.83" class="difflineplus">+    // We can't use _networkError because this._account._connection</span>
<a href="#l35.84"></a><span id="l35.84" class="difflineplus">+    // isn't set until we return from the XMPPSession constructor.</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+    this._account.reportDisconnecting(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+                                      _(&quot;connection.error.failedToCreateASocket&quot;));</span>
<a href="#l35.87"></a><span id="l35.87" class="difflineplus">+    this._account.reportDisconnected();</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+  }</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+}</span>
<a href="#l35.90"></a><span id="l35.90" class="difflineplus">+</span>
<a href="#l35.91"></a><span id="l35.91" class="difflineplus">+XMPPSession.prototype = {</span>
<a href="#l35.92"></a><span id="l35.92" class="difflineplus">+  /* for the socket.jsm helper */</span>
<a href="#l35.93"></a><span id="l35.93" class="difflineplus">+  __proto__: Socket,</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineplus">+  connectTimeout: 60,</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+  readWriteTimeout: 0,</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineplus">+  _security: null,</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+  _encrypted: false,</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineplus">+</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineplus">+  /* Disconnect from the server */</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+  disconnect: function() {</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+    if (this.onXmppStanza == this.stanzaListeners.accountListening)</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+      this.send(&quot;&lt;/stream:stream&gt;&quot;);</span>
<a href="#l35.104"></a><span id="l35.104" class="difflineplus">+    delete this.onXmppStanza;</span>
<a href="#l35.105"></a><span id="l35.105" class="difflineplus">+    Socket.disconnect.call(this);</span>
<a href="#l35.106"></a><span id="l35.106" class="difflineplus">+  },</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineplus">+</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+  /* Report errors to the account */</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+  onError: function(aError, aException) {</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+    this._account.onError(aError, aException);</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+  },</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+  /* Send a text message to the server */</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+  send: function(aMsg) {</span>
<a href="#l35.115"></a><span id="l35.115" class="difflineplus">+    this.sendString(aMsg);</span>
<a href="#l35.116"></a><span id="l35.116" class="difflineplus">+  },</span>
<a href="#l35.117"></a><span id="l35.117" class="difflineplus">+</span>
<a href="#l35.118"></a><span id="l35.118" class="difflineplus">+  /* Send a stanza to the server.</span>
<a href="#l35.119"></a><span id="l35.119" class="difflineplus">+   * Can set a callback if required, which will be called</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineplus">+   * when the server responds to the stanza with</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineplus">+   * a stanza of the same id. */</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+  sendStanza: function(aStanza, aCallback, aObject) {</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineplus">+    if (!aStanza.attributes.hasOwnProperty(&quot;id&quot;))</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineplus">+      aStanza.attributes[&quot;id&quot;] = ++this._stanzaId;</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineplus">+    if (aCallback)</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+      this.addHandler(aStanza.attributes.id, aCallback.bind(aObject));</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineplus">+    this.send(aStanza.getXML());</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+    return aStanza.attributes.id;</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  },</span>
<a href="#l35.130"></a><span id="l35.130" class="difflineplus">+</span>
<a href="#l35.131"></a><span id="l35.131" class="difflineplus">+</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineplus">+  /* these 3 methods handle callbacks for specific ids. */</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineplus">+  addHandler: function(aId, aCallback) {</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+    this._handlers[aId] = aCallback;</span>
<a href="#l35.135"></a><span id="l35.135" class="difflineplus">+  },</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineplus">+  removeHandler: function(aId) {</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+    delete this._handlers[aId];</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineplus">+  },</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineplus">+  execHandler: function(aId, aStanza) {</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+    if (!this._handlers.hasOwnProperty(aId))</span>
<a href="#l35.141"></a><span id="l35.141" class="difflineplus">+      return;</span>
<a href="#l35.142"></a><span id="l35.142" class="difflineplus">+    this._handlers[aId](aStanza);</span>
<a href="#l35.143"></a><span id="l35.143" class="difflineplus">+    this.removeHandler(aId);</span>
<a href="#l35.144"></a><span id="l35.144" class="difflineplus">+  },</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineplus">+</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineplus">+  /* Start the XMPP stream */</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+  startStream: function() {</span>
<a href="#l35.148"></a><span id="l35.148" class="difflineplus">+    this._parser = new XMPPParser(this);</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineplus">+    this.send('&lt;?xml version=&quot;1.0&quot;?&gt;&lt;stream:stream to=&quot;' + this._domain +</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineplus">+              '&quot; xmlns=&quot;jabber:client&quot; xmlns:stream=&quot;http://etherx.jabber.org/streams&quot; version=&quot;1.0&quot;&gt;');</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+  },</span>
<a href="#l35.152"></a><span id="l35.152" class="difflineplus">+</span>
<a href="#l35.153"></a><span id="l35.153" class="difflineplus">+  /* Log a message (called by the socket code) */</span>
<a href="#l35.154"></a><span id="l35.154" class="difflineplus">+  log: LOG,</span>
<a href="#l35.155"></a><span id="l35.155" class="difflineplus">+</span>
<a href="#l35.156"></a><span id="l35.156" class="difflineplus">+  /* Socket events */</span>
<a href="#l35.157"></a><span id="l35.157" class="difflineplus">+  /* The connection is established */</span>
<a href="#l35.158"></a><span id="l35.158" class="difflineplus">+  onConnection: function() {</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineplus">+    if (this._security.indexOf(&quot;ssl&quot;) != -1) {</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l35.161"></a><span id="l35.161" class="difflineplus">+      this._encrypted = true;</span>
<a href="#l35.162"></a><span id="l35.162" class="difflineplus">+    }</span>
<a href="#l35.163"></a><span id="l35.163" class="difflineplus">+    else</span>
<a href="#l35.164"></a><span id="l35.164" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.initStream;</span>
<a href="#l35.165"></a><span id="l35.165" class="difflineplus">+    this._account.reportConnecting(_(&quot;connection.initializingStream&quot;));</span>
<a href="#l35.166"></a><span id="l35.166" class="difflineplus">+    this.startStream();</span>
<a href="#l35.167"></a><span id="l35.167" class="difflineplus">+  },</span>
<a href="#l35.168"></a><span id="l35.168" class="difflineplus">+</span>
<a href="#l35.169"></a><span id="l35.169" class="difflineplus">+  /* When incoming data is available to be read */</span>
<a href="#l35.170"></a><span id="l35.170" class="difflineplus">+  onDataAvailable: function(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l35.171"></a><span id="l35.171" class="difflineplus">+    try {</span>
<a href="#l35.172"></a><span id="l35.172" class="difflineplus">+      this._parser.onDataAvailable(aInputStream, aOffset, aCount);</span>
<a href="#l35.173"></a><span id="l35.173" class="difflineplus">+    } catch(e) {</span>
<a href="#l35.174"></a><span id="l35.174" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l35.175"></a><span id="l35.175" class="difflineplus">+      this.onXMLError(&quot;parser-exception&quot;, e);</span>
<a href="#l35.176"></a><span id="l35.176" class="difflineplus">+    }</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineplus">+  },</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineplus">+</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+  /* The connection got disconnected without us closing it. */</span>
<a href="#l35.180"></a><span id="l35.180" class="difflineplus">+  onConnectionClosed: function() {</span>
<a href="#l35.181"></a><span id="l35.181" class="difflineplus">+    this._networkError(_(&quot;connection.error.serverClosedConnection&quot;));</span>
<a href="#l35.182"></a><span id="l35.182" class="difflineplus">+  },</span>
<a href="#l35.183"></a><span id="l35.183" class="difflineplus">+  onConnectionReset: function() {</span>
<a href="#l35.184"></a><span id="l35.184" class="difflineplus">+    this._networkError(_(&quot;connection.error.resetByPeer&quot;));</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineplus">+  },</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineplus">+  onConnectionTimedOut: function() {</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+    this._networkError(_(&quot;connection.error.timedOut&quot;));</span>
<a href="#l35.188"></a><span id="l35.188" class="difflineplus">+  },</span>
<a href="#l35.189"></a><span id="l35.189" class="difflineplus">+  _networkError: function(aMessage) {</span>
<a href="#l35.190"></a><span id="l35.190" class="difflineplus">+    this.onError(Ci.prplIAccount.ERROR_NETWORK_ERROR, aMessage);</span>
<a href="#l35.191"></a><span id="l35.191" class="difflineplus">+  },</span>
<a href="#l35.192"></a><span id="l35.192" class="difflineplus">+</span>
<a href="#l35.193"></a><span id="l35.193" class="difflineplus">+</span>
<a href="#l35.194"></a><span id="l35.194" class="difflineplus">+  /* Methods called by the XMPPParser instance */</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineplus">+  onXMLError: function(aError, aException) {</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineplus">+    if (aError == &quot;parsing-characters&quot;)</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineplus">+      WARN(aError + &quot;: &quot; + aException);</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+    else</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+      ERROR(aError + &quot;: &quot; + aException);</span>
<a href="#l35.200"></a><span id="l35.200" class="difflineplus">+    if (aError != &quot;parse-warning&quot; &amp;&amp; aError != &quot;parsing-characters&quot;)</span>
<a href="#l35.201"></a><span id="l35.201" class="difflineplus">+      this._networkError(_(&quot;connection.error.receivedUnexpectedData&quot;));</span>
<a href="#l35.202"></a><span id="l35.202" class="difflineplus">+  },</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineplus">+</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineplus">+  // All the functions in stanzaListeners are used as onXmppStanza</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+  // implementations at various steps of establishing the session.</span>
<a href="#l35.206"></a><span id="l35.206" class="difflineplus">+  stanzaListeners: {</span>
<a href="#l35.207"></a><span id="l35.207" class="difflineplus">+    initStream: function(aStanza) {</span>
<a href="#l35.208"></a><span id="l35.208" class="difflineplus">+      if (aStanza.localName != &quot;features&quot;) {</span>
<a href="#l35.209"></a><span id="l35.209" class="difflineplus">+        ERROR(&quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;);</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineplus">+        this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+        return;</span>
<a href="#l35.212"></a><span id="l35.212" class="difflineplus">+      }</span>
<a href="#l35.213"></a><span id="l35.213" class="difflineplus">+</span>
<a href="#l35.214"></a><span id="l35.214" class="difflineplus">+      let starttls = aStanza.getElement([&quot;starttls&quot;]);</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineplus">+      if (starttls &amp;&amp; this._security.indexOf(&quot;starttls&quot;) != -1) {</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineplus">+        this._account.reportConnecting(_(&quot;connection.initializingEncryption&quot;));</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+        this.sendStanza(Stanza.node(&quot;starttls&quot;, Stanza.NS.tls));</span>
<a href="#l35.218"></a><span id="l35.218" class="difflineplus">+        this.onXmppStanza = this.stanzaListeners.startTLS;</span>
<a href="#l35.219"></a><span id="l35.219" class="difflineplus">+        return;</span>
<a href="#l35.220"></a><span id="l35.220" class="difflineplus">+      }</span>
<a href="#l35.221"></a><span id="l35.221" class="difflineplus">+      if (starttls &amp;&amp;</span>
<a href="#l35.222"></a><span id="l35.222" class="difflineplus">+          starttls.children.some(function (c) c.localName == &quot;required&quot;)) {</span>
<a href="#l35.223"></a><span id="l35.223" class="difflineplus">+        this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l35.224"></a><span id="l35.224" class="difflineplus">+                     _(&quot;connection.error.startTLSRequired&quot;));</span>
<a href="#l35.225"></a><span id="l35.225" class="difflineplus">+        return;</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineplus">+      }</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineplus">+      if (!starttls &amp;&amp; this._connectionSecurity == &quot;require_tls&quot;) {</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+        this.onError(Ci.prplIAccount.ERROR_ENCRYPTION_ERROR,</span>
<a href="#l35.229"></a><span id="l35.229" class="difflineplus">+                     _(&quot;connection.error.startTLSNotSupported&quot;));</span>
<a href="#l35.230"></a><span id="l35.230" class="difflineplus">+        return;</span>
<a href="#l35.231"></a><span id="l35.231" class="difflineplus">+      }</span>
<a href="#l35.232"></a><span id="l35.232" class="difflineplus">+</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineplus">+      // If we aren't starting TLS, jump to the auth step.</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineplus">+      this.onXmppStanza(aStanza);</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+    },</span>
<a href="#l35.237"></a><span id="l35.237" class="difflineplus">+    startTLS: function(aStanza) {</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineplus">+      if (aStanza.localName != &quot;proceed&quot;) {</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+        this._networkError(_(&quot;connection.error.failedToStartTLS&quot;));</span>
<a href="#l35.240"></a><span id="l35.240" class="difflineplus">+        return;</span>
<a href="#l35.241"></a><span id="l35.241" class="difflineplus">+      }</span>
<a href="#l35.242"></a><span id="l35.242" class="difflineplus">+</span>
<a href="#l35.243"></a><span id="l35.243" class="difflineplus">+      this.startTLS();</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineplus">+      this._encrypted = true;</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineplus">+      this.startStream();</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.startAuth;</span>
<a href="#l35.247"></a><span id="l35.247" class="difflineplus">+    },</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineplus">+    startAuth: function(aStanza) {</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineplus">+      if (aStanza.localName != &quot;features&quot;) {</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineplus">+        ERROR(&quot;Unexpected stanza &quot; + aStanza.localName + &quot;, expected 'features'&quot;);</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+        this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+        return;</span>
<a href="#l35.253"></a><span id="l35.253" class="difflineplus">+      }</span>
<a href="#l35.254"></a><span id="l35.254" class="difflineplus">+</span>
<a href="#l35.255"></a><span id="l35.255" class="difflineplus">+      let mechs = aStanza.getElement([&quot;mechanisms&quot;]);</span>
<a href="#l35.256"></a><span id="l35.256" class="difflineplus">+      if (!mechs) {</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+        this._networkError(_(&quot;connection.error.noAuthMec&quot;));</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+        return;</span>
<a href="#l35.259"></a><span id="l35.259" class="difflineplus">+      }</span>
<a href="#l35.260"></a><span id="l35.260" class="difflineplus">+</span>
<a href="#l35.261"></a><span id="l35.261" class="difflineplus">+      // Select the auth mechanism we will use. PLAIN will be treated</span>
<a href="#l35.262"></a><span id="l35.262" class="difflineplus">+      // a bit differently as we want to avoid it over an unencrypted</span>
<a href="#l35.263"></a><span id="l35.263" class="difflineplus">+      // connection, except if the user has explicly allowed that</span>
<a href="#l35.264"></a><span id="l35.264" class="difflineplus">+      // behavior.</span>
<a href="#l35.265"></a><span id="l35.265" class="difflineplus">+      let selectedMech = &quot;&quot;;</span>
<a href="#l35.266"></a><span id="l35.266" class="difflineplus">+      let canUsePlain = false;</span>
<a href="#l35.267"></a><span id="l35.267" class="difflineplus">+      mechs = mechs.getChildren(&quot;mechanism&quot;);</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineplus">+      for each (let m in mechs) {</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineplus">+        let mech = m.innerText;</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+        if (mech == &quot;PLAIN&quot; &amp;&amp; !this._encrypted)</span>
<a href="#l35.271"></a><span id="l35.271" class="difflineplus">+          canUsePlain = true;</span>
<a href="#l35.272"></a><span id="l35.272" class="difflineplus">+        else if (XMPPAuthMechanisms.hasOwnProperty(mech)) {</span>
<a href="#l35.273"></a><span id="l35.273" class="difflineplus">+          selectedMech = mech;</span>
<a href="#l35.274"></a><span id="l35.274" class="difflineplus">+          break;</span>
<a href="#l35.275"></a><span id="l35.275" class="difflineplus">+        }</span>
<a href="#l35.276"></a><span id="l35.276" class="difflineplus">+      }</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineplus">+      if (!selectedMech &amp;&amp; canUsePlain) {</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineplus">+        if (this._security == &quot;allow_unencrypted_plain_auth&quot;)</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+          selectedMech = &quot;PLAIN&quot;;</span>
<a href="#l35.280"></a><span id="l35.280" class="difflineplus">+        else {</span>
<a href="#l35.281"></a><span id="l35.281" class="difflineplus">+          this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineplus">+                       _(&quot;connection.error.notSendingPasswordInClear&quot;));</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineplus">+          return;</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+        }</span>
<a href="#l35.285"></a><span id="l35.285" class="difflineplus">+      }</span>
<a href="#l35.286"></a><span id="l35.286" class="difflineplus">+      if (!selectedMech) {</span>
<a href="#l35.287"></a><span id="l35.287" class="difflineplus">+        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l35.288"></a><span id="l35.288" class="difflineplus">+                     _(&quot;connection.error.noCompatibleAuthMec&quot;));</span>
<a href="#l35.289"></a><span id="l35.289" class="difflineplus">+        return;</span>
<a href="#l35.290"></a><span id="l35.290" class="difflineplus">+      }</span>
<a href="#l35.291"></a><span id="l35.291" class="difflineplus">+      this._auth = new XMPPAuthMechanisms[selectedMech](this._jid.node,</span>
<a href="#l35.292"></a><span id="l35.292" class="difflineplus">+                                                        this._password,</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineplus">+                                                        this._domain);</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineplus">+</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+      this._account.reportConnecting(_(&quot;connection.authenticating&quot;));</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.authDialog;</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+      this.onXmppStanza(null); // the first auth step doesn't read anything</span>
<a href="#l35.298"></a><span id="l35.298" class="difflineplus">+    },</span>
<a href="#l35.299"></a><span id="l35.299" class="difflineplus">+    authDialog: function(aStanza) {</span>
<a href="#l35.300"></a><span id="l35.300" class="difflineplus">+      if (aStanza &amp;&amp; aStanza.localName == &quot;failure&quot;) {</span>
<a href="#l35.301"></a><span id="l35.301" class="difflineplus">+        let errorMsg = &quot;authenticationFailure&quot;;</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineplus">+        if (aStanza.getElement([&quot;not-authorized&quot;]))</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineplus">+          errorMsg = &quot;notAuthorized&quot;;</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l35.305"></a><span id="l35.305" class="difflineplus">+                     _(&quot;connection.error.&quot; + errorMsg));</span>
<a href="#l35.306"></a><span id="l35.306" class="difflineplus">+        return;</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineplus">+      }</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineplus">+</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineplus">+      let rv;</span>
<a href="#l35.310"></a><span id="l35.310" class="difflineplus">+      try {</span>
<a href="#l35.311"></a><span id="l35.311" class="difflineplus">+        rv = this._auth.next(aStanza);</span>
<a href="#l35.312"></a><span id="l35.312" class="difflineplus">+      } catch(e) {</span>
<a href="#l35.313"></a><span id="l35.313" class="difflineplus">+        ERROR(e);</span>
<a href="#l35.314"></a><span id="l35.314" class="difflineplus">+        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l35.315"></a><span id="l35.315" class="difflineplus">+                     _(&quot;connection.error.authenticationFailure&quot;));</span>
<a href="#l35.316"></a><span id="l35.316" class="difflineplus">+        return;</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineplus">+      }</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineplus">+</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineplus">+      if (rv.send)</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineplus">+        this.send(rv.send.getXML());</span>
<a href="#l35.321"></a><span id="l35.321" class="difflineplus">+      if (rv.done)</span>
<a href="#l35.322"></a><span id="l35.322" class="difflineplus">+        this.onXmppStanza = this.stanzaListeners.authResult;</span>
<a href="#l35.323"></a><span id="l35.323" class="difflineplus">+    },</span>
<a href="#l35.324"></a><span id="l35.324" class="difflineplus">+    authResult: function(aStanza) {</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineplus">+      if (aStanza.localName != &quot;success&quot;) {</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineplus">+        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l35.327"></a><span id="l35.327" class="difflineplus">+                     _(&quot;connection.error.notAuthorized&quot;));</span>
<a href="#l35.328"></a><span id="l35.328" class="difflineplus">+        return;</span>
<a href="#l35.329"></a><span id="l35.329" class="difflineplus">+      }</span>
<a href="#l35.330"></a><span id="l35.330" class="difflineplus">+</span>
<a href="#l35.331"></a><span id="l35.331" class="difflineplus">+      this.startStream();</span>
<a href="#l35.332"></a><span id="l35.332" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.startBind;</span>
<a href="#l35.333"></a><span id="l35.333" class="difflineplus">+    },</span>
<a href="#l35.334"></a><span id="l35.334" class="difflineplus">+    startBind: function(aStanza) {</span>
<a href="#l35.335"></a><span id="l35.335" class="difflineplus">+      if (!aStanza.getElement([&quot;bind&quot;])) {</span>
<a href="#l35.336"></a><span id="l35.336" class="difflineplus">+        ERROR(&quot;Unexpected lack of the bind feature&quot;);</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineplus">+        this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineplus">+        return;</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+      }</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineplus">+</span>
<a href="#l35.341"></a><span id="l35.341" class="difflineplus">+      this._account.reportConnecting(_(&quot;connection.gettingResource&quot;));</span>
<a href="#l35.342"></a><span id="l35.342" class="difflineplus">+      this.sendStanza(Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l35.343"></a><span id="l35.343" class="difflineplus">+                                Stanza.node(&quot;bind&quot;, Stanza.NS.bind, null,</span>
<a href="#l35.344"></a><span id="l35.344" class="difflineplus">+                                            Stanza.node(&quot;resource&quot;, null, null,</span>
<a href="#l35.345"></a><span id="l35.345" class="difflineplus">+                                                        this._resource))));</span>
<a href="#l35.346"></a><span id="l35.346" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.bindResult;</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineplus">+    },</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineplus">+    bindResult: function(aStanza) {</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineplus">+      let jid = aStanza.getElement([&quot;bind&quot;, &quot;jid&quot;]);</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineplus">+      if (!jid) {</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineplus">+        this._networkError(_(&quot;connection.error.failedToGetAResource&quot;));</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineplus">+        return;</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineplus">+      }</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineplus">+      jid = jid.innerText;</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+      DEBUG(&quot;jid = &quot; + jid);</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineplus">+      this._jid = this._account._parseJID(jid);</span>
<a href="#l35.357"></a><span id="l35.357" class="difflineplus">+      this.sendStanza(Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l35.358"></a><span id="l35.358" class="difflineplus">+                                Stanza.node(&quot;session&quot;, Stanza.NS.session)));</span>
<a href="#l35.359"></a><span id="l35.359" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.sessionStarted;</span>
<a href="#l35.360"></a><span id="l35.360" class="difflineplus">+    },</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineplus">+    sessionStarted: function(aStanza) {</span>
<a href="#l35.362"></a><span id="l35.362" class="difflineplus">+      this._account.onConnection();</span>
<a href="#l35.363"></a><span id="l35.363" class="difflineplus">+      this.onXmppStanza = this.stanzaListeners.accountListening;</span>
<a href="#l35.364"></a><span id="l35.364" class="difflineplus">+    },</span>
<a href="#l35.365"></a><span id="l35.365" class="difflineplus">+    accountListening: function(aStanza) {</span>
<a href="#l35.366"></a><span id="l35.366" class="difflineplus">+      this._account.onXmppStanza(aStanza);</span>
<a href="#l35.367"></a><span id="l35.367" class="difflineplus">+      let name = aStanza.qName;</span>
<a href="#l35.368"></a><span id="l35.368" class="difflineplus">+      if (name == &quot;presence&quot;)</span>
<a href="#l35.369"></a><span id="l35.369" class="difflineplus">+        this._account.onPresenceStanza(aStanza);</span>
<a href="#l35.370"></a><span id="l35.370" class="difflineplus">+      else if (name == &quot;message&quot;)</span>
<a href="#l35.371"></a><span id="l35.371" class="difflineplus">+        this._account.onMessageStanza(aStanza);</span>
<a href="#l35.372"></a><span id="l35.372" class="difflineplus">+      else if (name == &quot;iq&quot;)</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineplus">+        this._account.onIQStanza(aStanza);</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineplus">+</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineplus">+      if (aStanza.attributes.id)</span>
<a href="#l35.376"></a><span id="l35.376" class="difflineplus">+        this.execHandler(aStanza.attributes.id, aStanza);</span>
<a href="#l35.377"></a><span id="l35.377" class="difflineplus">+    }</span>
<a href="#l35.378"></a><span id="l35.378" class="difflineplus">+  },</span>
<a href="#l35.379"></a><span id="l35.379" class="difflineplus">+  onXmppStanza: function(aStanza) {</span>
<a href="#l35.380"></a><span id="l35.380" class="difflineplus">+    ERROR(&quot;should not be reached\n&quot;);</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineplus">+  }</span>
<a href="#l35.382"></a><span id="l35.382" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,422 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+ *</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+ *</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+ * License.</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+ *</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+ *</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+ * Varuna JAYASIRI &lt;vpjayasiri@gmail.com&gt;.</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+ *</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+ *   Florian Quze &lt;florian@queze.net&gt;</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+ *</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l36.36"></a><span id="l36.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l36.37"></a><span id="l36.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+ *</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineplus">+</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;Stanza&quot;, &quot;XMPPParser&quot;];</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+const {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+const NS = {</span>
<a href="#l36.47"></a><span id="l36.47" class="difflineplus">+  xml                       : &quot;http://www.w3.org/XML/1998/namespace&quot;,</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineplus">+  xhtml                     : &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+  xhtml_im                  : &quot;http://jabber.org/protocol/xhtml-im&quot;,</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+  //auth</span>
<a href="#l36.52"></a><span id="l36.52" class="difflineplus">+  client                    : &quot;jabber:client&quot;,</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineplus">+  streams                   : &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+  stream                    : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;,</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineplus">+  sasl                      : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineplus">+  tls                       : &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineplus">+  bind                      : &quot;urn:ietf:params:xml:ns:xmpp-bind&quot;,</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+  session                   : &quot;urn:ietf:params:xml:ns:xmpp-session&quot;,</span>
<a href="#l36.59"></a><span id="l36.59" class="difflineplus">+  auth                      : &quot;jabber:iq:auth&quot;,</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineplus">+  http_bind                 : &quot;http://jabber.org/protocol/httpbind&quot;,</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+  http_auth                 : &quot;http://jabber.org/protocol/http-auth&quot;,</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  xbosh                     : &quot;urn:xmpp:xbosh&quot;,</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineplus">+</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+  &quot;private&quot;                 : &quot;jabber:iq:private&quot;,</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+  xdata                     : &quot;jabber:x:data&quot;,</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+  //roster</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineplus">+  roster                    : &quot;jabber:iq:roster&quot;,</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+  roster_versioning         : &quot;urn:xmpp:features:rosterver&quot;,</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+  roster_delimiter          : &quot;roster:delimiter&quot;,</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+  //privacy lists</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+  privacy                   : &quot;jabber:iq:privacy&quot;,</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineplus">+  //discovering</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineplus">+  disco_info                : &quot;http://jabber.org/protocol/disco#info&quot;,</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineplus">+  disco_items               : &quot;http://jabber.org/protocol/disco#items&quot;,</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+  caps                      : &quot;http://jabber.org/protocol/caps&quot;,</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+  //addressing</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+  address                   : &quot;http://jabber.org/protocol/address&quot;,</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+  muc_user                  : &quot;http://jabber.org/protocol/muc#user&quot;,</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+  muc                       : &quot;http://jabber.org/protocol/muc&quot;,</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+  register                  : &quot;jabber:iq:register&quot;,</span>
<a href="#l36.86"></a><span id="l36.86" class="difflineplus">+  delay                     : &quot;urn:xmpp:delay&quot;,</span>
<a href="#l36.87"></a><span id="l36.87" class="difflineplus">+  delay_legacy              : &quot;jabber:x:delay&quot;,</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineplus">+  bookmarks                 : &quot;storage:bookmarks&quot;,</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+  chatstates                : &quot;http://jabber.org/protocol/chatstates&quot;,</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineplus">+  event                     : &quot;jabber:x:event&quot;,</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineplus">+  stanzas                   : &quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;,</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+  vcard                     : &quot;vcard-temp&quot;,</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+  vcard_update              : &quot;vcard-temp:x:update&quot;,</span>
<a href="#l36.94"></a><span id="l36.94" class="difflineplus">+  ping                      : &quot;urn:xmpp:ping&quot;,</span>
<a href="#l36.95"></a><span id="l36.95" class="difflineplus">+</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineplus">+  geoloc                    : &quot;http://jabber.org/protocol/geoloc&quot;,</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineplus">+  geoloc_notify             : &quot;http://jabber.org/protocol/geoloc+notify&quot;,</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineplus">+  mood                      : &quot;http://jabber.org/protocol/mood&quot;,</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineplus">+  tune                      : &quot;http://jabber.org/protocol/tune&quot;,</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineplus">+  nick                      : &quot;http://jabber.org/protocol/nick&quot;,</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineplus">+  nick_notify               : &quot;http://jabber.org/protocol/nick+notify&quot;,</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineplus">+  activity                  : &quot;http://jabber.org/protocol/activity&quot;,</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+  last                      : &quot;jabber:iq:last&quot;,</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineplus">+  avatar_data               : &quot;urn:xmpp:avatar:data&quot;,</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+  avatar_data_notify        : &quot;urn:xmpp:avatar:data+notify&quot;,</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+  avatar_metadata           : &quot;urn:xmpp:avatar:metadata&quot;,</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+  avatar_metadata_notify    : &quot;urn:xmpp:avatar:metadata+notify&quot;,</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+  pubsub                    : &quot;http://jabber.org/protocol/pubsub&quot;,</span>
<a href="#l36.109"></a><span id="l36.109" class="difflineplus">+  pubsub_event              : &quot;http://jabber.org/protocol/pubsub#event&quot;</span>
<a href="#l36.110"></a><span id="l36.110" class="difflineplus">+};</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineplus">+</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineplus">+</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+var TOP_LEVEL_ELEMENTS = {</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+  &quot;message&quot;             : &quot;jabber:client&quot;,</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+  &quot;presence&quot;            : &quot;jabber:client&quot;,</span>
<a href="#l36.116"></a><span id="l36.116" class="difflineplus">+  &quot;iq&quot;                  : &quot;jabber:client&quot;,</span>
<a href="#l36.117"></a><span id="l36.117" class="difflineplus">+  &quot;stream:features&quot;     : &quot;http://etherx.jabber.org/streams&quot;,</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+  &quot;proceed&quot;             : &quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+  &quot;failure&quot;             : [&quot;urn:ietf:params:xml:ns:xmpp-tls&quot;,</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+                           &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;],</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+  &quot;success&quot;             : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineplus">+  &quot;challenge&quot;           : &quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;,</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+  &quot;error&quot;               : &quot;urn:ietf:params:xml:ns:xmpp-streams&quot;</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineplus">+};</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+/* Stanza Builder */</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+const Stanza = {</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+  NS: NS,</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+  /* Create a presence stanza */</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+  presence: function(aAttr, aData) Stanza.node(&quot;presence&quot;, null, aAttr, aData),</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineplus">+</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+  /* Create a message stanza */</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineplus">+  message: function(aTo, aMsg, aState, aAttr, aData) {</span>
<a href="#l36.135"></a><span id="l36.135" class="difflineplus">+    if (!aAttr)</span>
<a href="#l36.136"></a><span id="l36.136" class="difflineplus">+      aAttr = {};</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineplus">+</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+    aAttr.to = aTo;</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineplus">+    if (!(&quot;type&quot; in aAttr))</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineplus">+      aAttr.type = &quot;chat&quot;;</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineplus">+    if (!aData)</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+      aData = [];</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineplus">+</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+    if (aMsg)</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+      aData.push(Stanza.node(&quot;body&quot;, null, null, aMsg));</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+    if (aState)</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineplus">+      aData.push(Stanza.node(aState, Stanza.NS.chatstates));</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineplus">+</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineplus">+    return Stanza.node(&quot;message&quot;, null, aAttr, aData);</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+  },</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+  /* Create a iq stanza */</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+  iq: function(aType, aId, aTo, aData) {</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+    let attrs = {type: aType};</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+    if (aId)</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+      attrs.id = aId;</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+    if (aTo)</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+      attrs.to = aTo;</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+    return this.node(&quot;iq&quot;, null, attrs, aData);</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+  },</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+  /* Create a XML node */</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+  node: function(aName, aNs, aAttr, aData) {</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+    let n = new XMLNode(null, aNs, aName, aName, null);</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineplus">+</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineplus">+    if (aAttr) {</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineplus">+      for (let at in aAttr)</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineplus">+        n.attributes[at] = aAttr[at];</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineplus">+    }</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+    if (aData) {</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+      if (!Array.isArray(aData))</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+        aData = [aData];</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+      for each (let child in aData)</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+         n[typeof(child) == &quot;string&quot; ? &quot;addText&quot; : &quot;addChild&quot;](child);</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+    }</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+    return n;</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+  }</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+};</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+/* Text node</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+ * Contains a text */</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+function TextNode(aText) {</span>
<a href="#l36.187"></a><span id="l36.187" class="difflineplus">+  this.text = aText;</span>
<a href="#l36.188"></a><span id="l36.188" class="difflineplus">+}</span>
<a href="#l36.189"></a><span id="l36.189" class="difflineplus">+</span>
<a href="#l36.190"></a><span id="l36.190" class="difflineplus">+TextNode.prototype = {</span>
<a href="#l36.191"></a><span id="l36.191" class="difflineplus">+  get type() &quot;text&quot;,</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineplus">+</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineplus">+  append: function(aText) {</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineplus">+    this.text += aText;</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+  },</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+  /* For debug purposes, returns an indented (unencoded) string */</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+  convertToString: function(aIndent) aIndent + this.text + &quot;\n&quot;,</span>
<a href="#l36.199"></a><span id="l36.199" class="difflineplus">+</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineplus">+  /* Returns the encoded XML */</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineplus">+  getXML: function()</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineplus">+    Components.classes[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineplus">+              .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l36.204"></a><span id="l36.204" class="difflineplus">+              .scanTXT(this.text, Ci.mozITXTToHTMLConv.kEntities),</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineplus">+</span>
<a href="#l36.206"></a><span id="l36.206" class="difflineplus">+  /* To read the unencoded data. */</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineplus">+  get innerText() this.text</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineplus">+};</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineplus">+</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineplus">+/* XML node */</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineplus">+function XMLNode(aParentNode, aUri, aLocalName, aQName, aAttr) {</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineplus">+  this._parentNode = aParentNode; // Used only for parsing</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineplus">+  this.uri = aUri;</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineplus">+  this.localName = aLocalName;</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+  this.qName = aQName;</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineplus">+  this.attributes = {};</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineplus">+  this.children = [];</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineplus">+  if (aAttr) {</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+    for (let i = 0; i &lt; aAttr.length; ++i)</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineplus">+      this.attributes[aAttr.getQName(i)] = aAttr.getValue(i);</span>
<a href="#l36.222"></a><span id="l36.222" class="difflineplus">+  }</span>
<a href="#l36.223"></a><span id="l36.223" class="difflineplus">+}</span>
<a href="#l36.224"></a><span id="l36.224" class="difflineplus">+</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineplus">+XMLNode.prototype = {</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+  get type() &quot;node&quot;,</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+  /* Add a new child node */</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+  addChild: function(aNode) {</span>
<a href="#l36.230"></a><span id="l36.230" class="difflineplus">+    this.children.push(aNode);</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineplus">+  },</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineplus">+</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+  /* Add text node */</span>
<a href="#l36.234"></a><span id="l36.234" class="difflineplus">+  addText: function(aText) {</span>
<a href="#l36.235"></a><span id="l36.235" class="difflineplus">+    let lastIndex = this.children.length - 1;</span>
<a href="#l36.236"></a><span id="l36.236" class="difflineplus">+    if (lastIndex &gt;= 0 &amp;&amp; this.children[lastIndex] instanceof TextNode)</span>
<a href="#l36.237"></a><span id="l36.237" class="difflineplus">+      this.children[lastIndex].append(aText);</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineplus">+    else</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineplus">+      this.children.push(new TextNode(aText));</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineplus">+  },</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineplus">+</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineplus">+  /* Get child elements by namespace */</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineplus">+  getChildrenByNS: function(aNS)</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineplus">+    this.children.filter(function(c) c.uri == aNS),</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineplus">+</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineplus">+  /* Get the first element inside the node that matches a query. */</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+  getElement: function(aQuery) {</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+   if (aQuery.length == 0)</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineplus">+     return this;</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineplus">+   let nq = aQuery.slice(1);</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+   for each (let child in this.children) {</span>
<a href="#l36.253"></a><span id="l36.253" class="difflineplus">+     if (child.qName != aQuery[0])</span>
<a href="#l36.254"></a><span id="l36.254" class="difflineplus">+       continue;</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+     let n = child.getElement(nq);</span>
<a href="#l36.256"></a><span id="l36.256" class="difflineplus">+     if (n)</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineplus">+       return n;</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineplus">+   }</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineplus">+</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineplus">+   return null;</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineplus">+  },</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineplus">+</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineplus">+  /* Get all elements matching the query */</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineplus">+  getElements: function(aQuery) {</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineplus">+   if (aQuery.length == 0)</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineplus">+     return [this];</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineplus">+</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineplus">+   let c = this.getChildren(aQuery[0]);</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineplus">+   let nq = aQuery.slice(1);</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineplus">+   let res = [];</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineplus">+   for each (let child in c) {</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineplus">+     let n = child.getElements(nq);</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+     res = res.concat(n);</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineplus">+   }</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineplus">+</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineplus">+   return res;</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineplus">+  },</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineplus">+</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineplus">+  /* Get immediate children by the node name */</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineplus">+  getChildren: function(aName)</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineplus">+    this.children.filter(function(c) c.qName == aName),</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineplus">+</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineplus">+  /* Test if the node is a stanza */</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineplus">+  isXmppStanza: function() {</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+    if (!TOP_LEVEL_ELEMENTS.hasOwnProperty(this.qName))</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+      return false;</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineplus">+    let ns = TOP_LEVEL_ELEMENTS[this.qName];</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineplus">+    return ns == this.uri || (Array.isArray(ns) &amp;&amp; ns.indexOf(this.uri) != -1);</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineplus">+  },</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineplus">+</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineplus">+  /* Returns indented XML */</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineplus">+  convertToString: function(aIndent) {</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineplus">+    if (!aIndent)</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineplus">+      aIndent = &quot;&quot;;</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineplus">+</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+    let s =</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineplus">+      aIndent + &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineplus">+    let content = &quot;&quot;;</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineplus">+    for each (let child in this.children)</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineplus">+      content += child.convertToString(aIndent + &quot; &quot;);</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineplus">+    return s + (content ? &quot;&gt;\n&quot; + content + aIndent + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;\n&quot;;</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineplus">+  },</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineplus">+</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineplus">+  /* Returns the XML */</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineplus">+  getXML: function() {</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineplus">+    let s = &quot;&lt;&quot; + this.qName + this._getXmlns() + this._getAttributeText();</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineplus">+    let innerXML = this.children.map(function(c) c.getXML()).join(&quot;&quot;);</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineplus">+    return s + (innerXML ? &quot;&gt;&quot; + innerXML + &quot;&lt;/&quot; + this.qName : &quot;/&quot;) + &quot;&gt;&quot;;</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineplus">+  },</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineplus">+</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineplus">+  get innerText() this.children.map(function(c) c.innerText).join(&quot;&quot;),</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineplus">+</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineplus">+  /* Private methods */</span>
<a href="#l36.314"></a><span id="l36.314" class="difflineplus">+  _getXmlns: function() this.uri ? &quot; xmlns=\&quot;&quot; + this.uri + &quot;\&quot;&quot; : &quot;&quot;,</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineplus">+  _getAttributeText: function() {</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineplus">+    let s = &quot;&quot;;</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineplus">+    for (let name in this.attributes)</span>
<a href="#l36.318"></a><span id="l36.318" class="difflineplus">+      s += &quot; &quot; +name + &quot;=\&quot;&quot; + this.attributes[name] + &quot;\&quot;&quot;;</span>
<a href="#l36.319"></a><span id="l36.319" class="difflineplus">+    return s;</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineplus">+  }</span>
<a href="#l36.321"></a><span id="l36.321" class="difflineplus">+};</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineplus">+</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineplus">+function XMPPParser(aListener) {</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineplus">+  this._parser = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;]</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineplus">+                 .createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineplus">+  this._parser.contentHandler = this;</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineplus">+  this._parser.errorHandler = this;</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineplus">+  this._parser.parseAsync(null);</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineplus">+  this._listener = aListener;</span>
<a href="#l36.330"></a><span id="l36.330" class="difflineplus">+  this._parser.onStartRequest(this._dummyRequest, null);</span>
<a href="#l36.331"></a><span id="l36.331" class="difflineplus">+}</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineplus">+XMPPParser.prototype = {</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineplus">+  _dummyRequest: {</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineplus">+    cancel: function() { },</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineplus">+    isPending: function() { },</span>
<a href="#l36.336"></a><span id="l36.336" class="difflineplus">+    resume: function() { },</span>
<a href="#l36.337"></a><span id="l36.337" class="difflineplus">+    suspend: function() { }</span>
<a href="#l36.338"></a><span id="l36.338" class="difflineplus">+  },</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineplus">+</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineplus">+  onDataAvailable: function(aInputStream, aOffset, aCount) {</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineplus">+    this._parser.onDataAvailable(this._dummyRequest, null,</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineplus">+                                 aInputStream, aOffset, aCount);</span>
<a href="#l36.343"></a><span id="l36.343" class="difflineplus">+  },</span>
<a href="#l36.344"></a><span id="l36.344" class="difflineplus">+</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineplus">+  /* nsISAXContentHandler implementation */</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineplus">+  startDocument: function() { },</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineplus">+  endDocument: function() { },</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineplus">+</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineplus">+  startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineplus">+    if (aQName == &quot;stream:stream&quot;) {</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineplus">+      if (&quot;_node&quot; in this)</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineplus">+        this._listener.onXMLError(&quot;unexpected-stream-start&quot;,</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineplus">+                                  &quot;stream:stream inside an already started stream&quot;);</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineplus">+      this._node = null;</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineplus">+      return;</span>
<a href="#l36.356"></a><span id="l36.356" class="difflineplus">+    }</span>
<a href="#l36.357"></a><span id="l36.357" class="difflineplus">+</span>
<a href="#l36.358"></a><span id="l36.358" class="difflineplus">+    let node = new XMLNode(this._node, aUri, aLocalName, aQName, aAttributes);</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineplus">+    if (this._node)</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineplus">+      this._node.addChild(node);</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineplus">+</span>
<a href="#l36.362"></a><span id="l36.362" class="difflineplus">+    this._node = node;</span>
<a href="#l36.363"></a><span id="l36.363" class="difflineplus">+  },</span>
<a href="#l36.364"></a><span id="l36.364" class="difflineplus">+</span>
<a href="#l36.365"></a><span id="l36.365" class="difflineplus">+  characters: function(aCharacters) {</span>
<a href="#l36.366"></a><span id="l36.366" class="difflineplus">+    if (!this._node) {</span>
<a href="#l36.367"></a><span id="l36.367" class="difflineplus">+      // Ignore whitespace received on the stream to keep the connection alive.</span>
<a href="#l36.368"></a><span id="l36.368" class="difflineplus">+      if (aCharacters.trim()) {</span>
<a href="#l36.369"></a><span id="l36.369" class="difflineplus">+        this._listener.onXMLError(&quot;parsing-characters&quot;,</span>
<a href="#l36.370"></a><span id="l36.370" class="difflineplus">+                                  &quot;No parent for characters: &quot; + aCharacters);</span>
<a href="#l36.371"></a><span id="l36.371" class="difflineplus">+      }</span>
<a href="#l36.372"></a><span id="l36.372" class="difflineplus">+      return;</span>
<a href="#l36.373"></a><span id="l36.373" class="difflineplus">+    }</span>
<a href="#l36.374"></a><span id="l36.374" class="difflineplus">+</span>
<a href="#l36.375"></a><span id="l36.375" class="difflineplus">+    this._node.addText(aCharacters);</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineplus">+  },</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineplus">+</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineplus">+  endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l36.379"></a><span id="l36.379" class="difflineplus">+    if (aQName == &quot;stream:stream&quot;) {</span>
<a href="#l36.380"></a><span id="l36.380" class="difflineplus">+      delete this._node;</span>
<a href="#l36.381"></a><span id="l36.381" class="difflineplus">+      return;</span>
<a href="#l36.382"></a><span id="l36.382" class="difflineplus">+    }</span>
<a href="#l36.383"></a><span id="l36.383" class="difflineplus">+</span>
<a href="#l36.384"></a><span id="l36.384" class="difflineplus">+    if (!this._node) {</span>
<a href="#l36.385"></a><span id="l36.385" class="difflineplus">+      this._listener.onXMLError(&quot;parsing-node&quot;,</span>
<a href="#l36.386"></a><span id="l36.386" class="difflineplus">+                                &quot;No parent for node : &quot; + aLocalName);</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineplus">+      return;</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineplus">+    }</span>
<a href="#l36.389"></a><span id="l36.389" class="difflineplus">+</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineplus">+    if (this._node.isXmppStanza()) {</span>
<a href="#l36.391"></a><span id="l36.391" class="difflineplus">+      this._listener.log(&quot;received:\n&quot; + this._node.convertToString());</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineplus">+      try {</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineplus">+        this._listener.onXmppStanza(this._node);</span>
<a href="#l36.394"></a><span id="l36.394" class="difflineplus">+      } catch (e) {</span>
<a href="#l36.395"></a><span id="l36.395" class="difflineplus">+        Cu.reportError(e);</span>
<a href="#l36.396"></a><span id="l36.396" class="difflineplus">+        dump(e + &quot;\n&quot;);</span>
<a href="#l36.397"></a><span id="l36.397" class="difflineplus">+      }</span>
<a href="#l36.398"></a><span id="l36.398" class="difflineplus">+    }</span>
<a href="#l36.399"></a><span id="l36.399" class="difflineplus">+</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineplus">+    this._node = this._node._parentNode;</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+  },</span>
<a href="#l36.402"></a><span id="l36.402" class="difflineplus">+</span>
<a href="#l36.403"></a><span id="l36.403" class="difflineplus">+  processingInstruction: function(aTarget, aData) { },</span>
<a href="#l36.404"></a><span id="l36.404" class="difflineplus">+  ignorableWhitespace: function(aWhitespace) { },</span>
<a href="#l36.405"></a><span id="l36.405" class="difflineplus">+  startPrefixMapping: function(aPrefix, aUri) { },</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineplus">+  endPrefixMapping: function(aPrefix) { },</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineplus">+</span>
<a href="#l36.408"></a><span id="l36.408" class="difflineplus">+  /* nsISAXErrorHandler implementation */</span>
<a href="#l36.409"></a><span id="l36.409" class="difflineplus">+  error: function(aLocator, aError) {</span>
<a href="#l36.410"></a><span id="l36.410" class="difflineplus">+    this._listener.onXMLError(&quot;parse-error&quot;, aError);</span>
<a href="#l36.411"></a><span id="l36.411" class="difflineplus">+  },</span>
<a href="#l36.412"></a><span id="l36.412" class="difflineplus">+  fatalError: function(aLocator, aError) {</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineplus">+    this._listener.onXMLError(&quot;parse-fatal-error&quot;, aError);</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineplus">+  },</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineplus">+  ignorableWarning: function(aLocator, aError) {</span>
<a href="#l36.416"></a><span id="l36.416" class="difflineplus">+    this._listener.onXMLError(&quot;parse-warning&quot;, aError);</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineplus">+  },</span>
<a href="#l36.418"></a><span id="l36.418" class="difflineplus">+</span>
<a href="#l36.419"></a><span id="l36.419" class="difflineplus">+  QueryInterface: function(aInterfaceId) {</span>
<a href="#l36.420"></a><span id="l36.420" class="difflineplus">+    if (!aInterfaceId.equals(Ci.nsISupports) &amp;&amp;</span>
<a href="#l36.421"></a><span id="l36.421" class="difflineplus">+        !aInterfaceId.equals(Ci.nsISAXContentHandler) &amp;&amp;</span>
<a href="#l36.422"></a><span id="l36.422" class="difflineplus">+        !aInterfaceId.equals(Ci.nsISAXErrorHandler))</span>
<a href="#l36.423"></a><span id="l36.423" class="difflineplus">+      throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l36.424"></a><span id="l36.424" class="difflineplus">+    return this;</span>
<a href="#l36.425"></a><span id="l36.425" class="difflineplus">+  }</span>
<a href="#l36.426"></a><span id="l36.426" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">new file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- /dev/null</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.js</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineplus">+ *</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+ *</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+ * License.</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+ *</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+ *</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+ * Varuna JAYASIRI &lt;vpjayasiri@gmail.com&gt;.</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+ *</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+ *   Florian Quze &lt;florian@queze.net&gt;</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+ *</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineplus">+ *</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp.jsm&quot;);</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+  l10nHelper(&quot;chrome://purple/locale/xmpp.properties&quot;)</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineplus">+);</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineplus">+function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineplus">+}</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineplus">+</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineplus">+function XMPPProtocol() {</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineplus">+}</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineplus">+XMPPProtocol.prototype = {</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineplus">+  get normalizedName() &quot;jabber&quot;,</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineplus">+  get name() &quot;XMPP (JS)&quot;,</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineplus">+  get iconBaseURI() &quot;chrome://prpl-jabber/skin/&quot;,</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineplus">+  getAccount: function(aImAccount) new XMPPAccount(this, aImAccount),</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+  options: {</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineplus">+    resource: {get label() _(&quot;options.resource&quot;), default: &quot;instantbird&quot;},</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineplus">+    connection_security: {</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+      get label() _(&quot;options.connectionSecurity&quot;),</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+      listValues: {</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+        get require_tls() _(&quot;options.connectionSecurity.requireEncryption&quot;),</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+        get opportunistic_tls() _(&quot;options.connectionSecurity.opportunisticTLS&quot;),</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineplus">+        get allow_unencrypted_plain_auth() _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;),</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineplus">+        // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineplus">+        // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+      },</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+      default: &quot;opportunistic_tls&quot;</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+    },</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+    server: {get label() _(&quot;options.connectServer&quot;), default: &quot;&quot;},</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+    port: {get label() _(&quot;options.connectPort&quot;), default: 5222}</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineplus">+  },</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineplus">+  get chatHasTopic() true,</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineplus">+</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+  classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;)</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+};</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([XMPPProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">new file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- /dev/null</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -0,0 +1,900 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineplus">+ *</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+ *</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+ * License.</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+ *</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+ *</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+ * Varuna JAYASIRI &lt;vpjayasiri@gmail.com&gt;.</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineplus">+ *</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+ *   Florian Quze &lt;florian@queze.net&gt;</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineplus">+ *</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+ *</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;XMPPConversationPrototype&quot;,</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+                        &quot;XMPPMUCConversationPrototype&quot;,</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+                        &quot;XMPPAccountBuddyPrototype&quot;,</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+                        &quot;XMPPAccountPrototype&quot;];</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+const {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+Cu.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+Cu.import(&quot;resource:///modules/xmpp-session.jsm&quot;);</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;DownloadUtils&quot;, function() {</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+  Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l38.59"></a><span id="l38.59" class="difflineplus">+  return DownloadUtils;</span>
<a href="#l38.60"></a><span id="l38.60" class="difflineplus">+});</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;FileUtils&quot;, function() {</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineplus">+  Components.utils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+  return FileUtils;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+});</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;NetUtil&quot;, function() {</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+  Components.utils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+  return NetUtil;</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+});</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+initLogModule(&quot;xmpp&quot;, this);</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineplus">+  l10nHelper(&quot;chrome://purple/locale/xmpp.properties&quot;)</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineplus">+);</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineplus">+/* This is an ordered list, used to determine chat buddy flags:</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+ *  index &lt; member    -&gt; noFlags</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+ *  index = member    -&gt; voiced</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+ *          moderator -&gt; halfOp</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+ *          admin     -&gt; op</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+ *          owner     -&gt; founder</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+ */</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+const kRoles = [&quot;outcast&quot;, &quot;visitor&quot;, &quot;participant&quot;, &quot;member&quot;, &quot;moderator&quot;,</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineplus">+                &quot;admin&quot;, &quot;owner&quot;];</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineplus">+</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineplus">+function MUCParticipant(aNick, aName, aStanza)</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineplus">+{</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+  this._jid = aName;</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+  this.name = aNick;</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+  this.stanza = aStanza;</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+}</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineplus">+MUCParticipant.prototype = {</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineplus">+  __proto__: ClassInfo(&quot;purpleIConvChatBuddy&quot;, &quot;XMPP ConvChatBuddy object&quot;),</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineplus">+</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineplus">+  buddy: false,</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+  get alias() this.name,</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineplus">+</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineplus">+  role: 2, // &quot;participant&quot; by default</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineplus">+  set stanza(aStanza) {</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineplus">+    this._stanza = aStanza;</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+    let x =</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+      aStanza.getChildren(&quot;x&quot;).filter(function (c) c.uri == Stanza.NS.muc_user);</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+    if (x.length == 0)</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+      return;</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+    x = x[0];</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+    let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+    if (!item)</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+      return;</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+    this.role = Math.max(kRoles.indexOf(item.attributes[&quot;role&quot;]),</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+                         kRoles.indexOf(item.attributes[&quot;affiliation&quot;]));</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+  },</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+  get noFlags() this.role &lt; kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+  get voiced() this.role == kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+  get halfOp() this.role == kRoles.indexOf(&quot;moderator&quot;),</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+  get op() this.role == kRoles.indexOf(&quot;admin&quot;),</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+  get founder() this.role == kRoles.indexOf(&quot;owner&quot;),</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+  typing: false</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+};</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+const XMPPMUCConversationPrototype = {</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+  __proto__: GenericConvChatPrototype,</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineplus">+</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+  _init: function(aAccount, aJID, aNick) {</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+    GenericConvChatPrototype._init.call(this, aAccount, aJID, aNick);</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+  },</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineplus">+  get normalizedName() this.name,</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+  _targetResource: &quot;&quot;,</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineplus">+</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+  /* Called when the user enters a chat message */</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+  sendMsg: function (aMsg) {</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+    let s = Stanza.message(this.name, aMsg, null, {type: &quot;groupchat&quot;});</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+    this._account.sendStanza(s);</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+  },</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+  /* Called by the account when a presence stanza is received for this muc */</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+  onPresenceStanza: function(aStanza) {</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+    let nick = this._account._parseJID(from).resource;</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineplus">+    if (aStanza.attributes[&quot;type&quot;] == &quot;unavailable&quot;) {</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineplus">+      if (!(nick in this._participants)) {</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+        WARN(&quot;received unavailable presence for an unknown MUC participant: &quot; +</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineplus">+             from);</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+        return;</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineplus">+      }</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineplus">+      delete this._participants[nick];</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineplus">+      let nickString = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineplus">+                       .createInstance(Ci.nsISupportsString);</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineplus">+      nickString.data = nick;</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineplus">+      this.notifyObservers(new nsSimpleEnumerator([nickString]),</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineplus">+                           &quot;chat-buddy-remove&quot;);</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineplus">+      return;</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineplus">+    }</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+    if (!hasOwnProperty(this._participants, nick)) {</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+      this._participants[nick] = new MUCParticipant(nick, from, aStanza);</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineplus">+      this.notifyObservers(new nsSimpleEnumerator([this._participants[nick]]),</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineplus">+                           &quot;chat-buddy-add&quot;);</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineplus">+    }</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineplus">+    else {</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineplus">+      this._participants[nick].stanza = aStanza;</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+      this.notifyObservers(this._participants[nick], &quot;chat-buddy-update&quot;);</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineplus">+    }</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+  },</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineplus">+  /* Called by the account when a messsage is received for this muc */</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineplus">+  incomingMessage: function(aMsg, aStanza, aDate) {</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineplus">+    let from = this._account._parseJID(aStanza.attributes[&quot;from&quot;]).resource;</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineplus">+    let flags = {};</span>
<a href="#l38.173"></a><span id="l38.173" class="difflineplus">+    if (!from) {</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineplus">+      flags.system = true;</span>
<a href="#l38.175"></a><span id="l38.175" class="difflineplus">+      from = this.name;</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineplus">+    }</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineplus">+    else if (from == this._nick)</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineplus">+      flags.outgoing = true;</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineplus">+    else</span>
<a href="#l38.180"></a><span id="l38.180" class="difflineplus">+      flags.incoming = true;</span>
<a href="#l38.181"></a><span id="l38.181" class="difflineplus">+    if (aDate) {</span>
<a href="#l38.182"></a><span id="l38.182" class="difflineplus">+      flags.time = aDate / 1000;</span>
<a href="#l38.183"></a><span id="l38.183" class="difflineplus">+      flags.delayed = true;</span>
<a href="#l38.184"></a><span id="l38.184" class="difflineplus">+    }</span>
<a href="#l38.185"></a><span id="l38.185" class="difflineplus">+    this.writeMessage(from, aMsg, flags);</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineplus">+  },</span>
<a href="#l38.187"></a><span id="l38.187" class="difflineplus">+</span>
<a href="#l38.188"></a><span id="l38.188" class="difflineplus">+  getNormalizedChatBuddyName: function(aNick) this.name + &quot;/&quot; + aNick,</span>
<a href="#l38.189"></a><span id="l38.189" class="difflineplus">+</span>
<a href="#l38.190"></a><span id="l38.190" class="difflineplus">+  /* Called when the user closed the conversation */</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineplus">+  close: function() {</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineplus">+    this._account.sendStanza(Stanza.presence({to: this.name + &quot;/&quot; + this._nick,</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineplus">+                                             type: &quot;unavailable&quot;}));</span>
<a href="#l38.194"></a><span id="l38.194" class="difflineplus">+    GenericConvChatPrototype.close.call(this);</span>
<a href="#l38.195"></a><span id="l38.195" class="difflineplus">+    this._account.removeConversation(this.name);</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineplus">+  }</span>
<a href="#l38.197"></a><span id="l38.197" class="difflineplus">+};</span>
<a href="#l38.198"></a><span id="l38.198" class="difflineplus">+function XMPPMUCConversation(aAccount, aJID, aNick)</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineplus">+{</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineplus">+  this._init(aAccount, aJID, aNick);</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineplus">+}</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineplus">+XMPPMUCConversation.prototype = XMPPMUCConversationPrototype;</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineplus">+</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineplus">+/* Helper class for buddy conversations */</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineplus">+const XMPPConversationPrototype = {</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineplus">+  __proto__: GenericConvIMPrototype,</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineplus">+</span>
<a href="#l38.208"></a><span id="l38.208" class="difflineplus">+  _typingTimer: null,</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineplus">+  _supportChatStateNotifications: true,</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineplus">+  _typingState: &quot;active&quot;,</span>
<a href="#l38.211"></a><span id="l38.211" class="difflineplus">+</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineplus">+  _init: function(aAccount, aBuddy) {</span>
<a href="#l38.213"></a><span id="l38.213" class="difflineplus">+    this.buddy = aBuddy;</span>
<a href="#l38.214"></a><span id="l38.214" class="difflineplus">+    GenericConvIMPrototype._init.call(this, aAccount, aBuddy.normalizedName);</span>
<a href="#l38.215"></a><span id="l38.215" class="difflineplus">+  },</span>
<a href="#l38.216"></a><span id="l38.216" class="difflineplus">+</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineplus">+  get title() this.buddy.contactDisplayName,</span>
<a href="#l38.218"></a><span id="l38.218" class="difflineplus">+  get normalizedName() this.buddy.normalizedName,</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineplus">+</span>
<a href="#l38.220"></a><span id="l38.220" class="difflineplus">+  set supportChatStateNotifications(val) {</span>
<a href="#l38.221"></a><span id="l38.221" class="difflineplus">+    this._supportChatStateNotifications = val;</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineplus">+  },</span>
<a href="#l38.223"></a><span id="l38.223" class="difflineplus">+</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineplus">+  /* Called when the user is typing a message</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineplus">+   * aLength - length of the typed message */</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineplus">+  sendTyping: function(aLength) {</span>
<a href="#l38.227"></a><span id="l38.227" class="difflineplus">+    if (!this._supportChatStateNotifications)</span>
<a href="#l38.228"></a><span id="l38.228" class="difflineplus">+      return;</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineplus">+</span>
<a href="#l38.230"></a><span id="l38.230" class="difflineplus">+    this._cancelTypingTimer();</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineplus">+    if (aLength)</span>
<a href="#l38.232"></a><span id="l38.232" class="difflineplus">+      this._typingTimer = setTimeout(this.finishedComposing.bind(this), 10000);</span>
<a href="#l38.233"></a><span id="l38.233" class="difflineplus">+</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineplus">+    this._setTypingState(aLength ? &quot;composing&quot; : &quot;active&quot;);</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineplus">+  },</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineplus">+</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineplus">+  finishedComposing: function() {</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineplus">+    if (!this._supportChatStateNotifications)</span>
<a href="#l38.239"></a><span id="l38.239" class="difflineplus">+      return;</span>
<a href="#l38.240"></a><span id="l38.240" class="difflineplus">+</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineplus">+    this._setTypingState(&quot;paused&quot;);</span>
<a href="#l38.242"></a><span id="l38.242" class="difflineplus">+  },</span>
<a href="#l38.243"></a><span id="l38.243" class="difflineplus">+</span>
<a href="#l38.244"></a><span id="l38.244" class="difflineplus">+  _setTypingState: function(aNewState) {</span>
<a href="#l38.245"></a><span id="l38.245" class="difflineplus">+    if (this._typingState == aNewState)</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineplus">+      return;</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineplus">+</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineplus">+    /* to, msg, state, attrib, data */</span>
<a href="#l38.249"></a><span id="l38.249" class="difflineplus">+    let s = Stanza.message(this.to, null, aNewState);</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineplus">+    this._account.sendStanza(s);</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineplus">+    this._typingState = aNewState;</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineplus">+  },</span>
<a href="#l38.253"></a><span id="l38.253" class="difflineplus">+  _cancelTypingTimer: function() {</span>
<a href="#l38.254"></a><span id="l38.254" class="difflineplus">+    if (this._typingTimer) {</span>
<a href="#l38.255"></a><span id="l38.255" class="difflineplus">+      clearTimeout(this._typingTimer);</span>
<a href="#l38.256"></a><span id="l38.256" class="difflineplus">+      delete this._typingTimer;</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineplus">+    }</span>
<a href="#l38.258"></a><span id="l38.258" class="difflineplus">+  },</span>
<a href="#l38.259"></a><span id="l38.259" class="difflineplus">+</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineplus">+  _targetResource: &quot;&quot;,</span>
<a href="#l38.261"></a><span id="l38.261" class="difflineplus">+  get to() {</span>
<a href="#l38.262"></a><span id="l38.262" class="difflineplus">+    let to = this.buddy.userName;</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineplus">+    if (this._targetResource)</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineplus">+      to += &quot;/&quot; + this._targetResource;</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineplus">+    return to;</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineplus">+  },</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineplus">+</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineplus">+  /* Called when the user enters a chat message */</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineplus">+  sendMsg: function (aMsg) {</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineplus">+    this._cancelTypingTimer();</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineplus">+    let cs = this._supportChatStateNotifications ? &quot;active&quot; : null;</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineplus">+    let s = Stanza.message(this.to, aMsg, cs);</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineplus">+    this._account.sendStanza(s);</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineplus">+    let who;</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineplus">+    if (this._account._connection)</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineplus">+      who = this._account._connection._jid.jid;</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineplus">+    if (!who)</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineplus">+      who = this._account.name;</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineplus">+    let alias = this.account.alias || this.account.statusInfo.displayName;</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineplus">+    let msg = Components.classes[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineplus">+                        .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l38.282"></a><span id="l38.282" class="difflineplus">+                        .scanTXT(aMsg, Ci.mozITXTToHTMLConv.kEntities);</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineplus">+    this.writeMessage(who, msg, {outgoing: true, _alias: alias});</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineplus">+    delete this._typingState;</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineplus">+  },</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineplus">+</span>
<a href="#l38.287"></a><span id="l38.287" class="difflineplus">+  /* Called by the account when a messsage is received from the buddy */</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineplus">+  incomingMessage: function(aMsg, aStanza, aDate) {</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineplus">+    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineplus">+    this._targetResource = this._account._parseJID(from).resource;</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineplus">+    let flags = {incoming: true, _alias: this.buddy.contactDisplayName};</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineplus">+    if (aDate) {</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineplus">+      flags.time = aDate / 1000;</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineplus">+      flags.delayed = true;</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineplus">+    }</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineplus">+    this.writeMessage(from, aMsg, flags);</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineplus">+  },</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineplus">+</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineplus">+  /* Called when the user closed the conversation */</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineplus">+  close: function() {</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineplus">+    GenericConvIMPrototype.close.call(this);</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineplus">+    this._account.removeConversation(this.buddy.normalizedName);</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineplus">+  }</span>
<a href="#l38.304"></a><span id="l38.304" class="difflineplus">+};</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineplus">+function XMPPConversation(aAccount, aBuddy)</span>
<a href="#l38.306"></a><span id="l38.306" class="difflineplus">+{</span>
<a href="#l38.307"></a><span id="l38.307" class="difflineplus">+  this._init(aAccount, aBuddy);</span>
<a href="#l38.308"></a><span id="l38.308" class="difflineplus">+}</span>
<a href="#l38.309"></a><span id="l38.309" class="difflineplus">+XMPPConversation.prototype = XMPPConversationPrototype;</span>
<a href="#l38.310"></a><span id="l38.310" class="difflineplus">+</span>
<a href="#l38.311"></a><span id="l38.311" class="difflineplus">+/* Helper class for buddies */</span>
<a href="#l38.312"></a><span id="l38.312" class="difflineplus">+const XMPPAccountBuddyPrototype = {</span>
<a href="#l38.313"></a><span id="l38.313" class="difflineplus">+  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineplus">+</span>
<a href="#l38.315"></a><span id="l38.315" class="difflineplus">+  subscription: &quot;none&quot;,</span>
<a href="#l38.316"></a><span id="l38.316" class="difflineplus">+  /* Returns a list of TooltipInfo objects to be displayed when the user hovers over the buddy */</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineplus">+  getTooltipInfo: function() {</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineplus">+    if (!this._account.connected)</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineplus">+      return null;</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineplus">+</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineplus">+    let tooltipInfo = [];</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineplus">+    if (this._resources) {</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+      for (let r in this._resources) {</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+        let status = this._resources[r];</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineplus">+        let statusString = Status.toLabel(status.statusType);</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineplus">+        if (status.statusType == Ci.imIStatusInfo.STATUS_IDLE &amp;&amp;</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineplus">+            status.idleSince) {</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineplus">+          let now = Math.floor(Date.now() / 1000);</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+          let valuesAndUnits =</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineplus">+            DownloadUtils.convertTimeUnits(now - status.idleSince);</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineplus">+          if (!valuesAndUnits[2])</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineplus">+            valuesAndUnits.splice(2, 2);</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineplus">+          statusString += &quot; (&quot; + valuesAndUnits.join(&quot; &quot;) + &quot;)&quot;;</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineplus">+        }</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineplus">+        if (status.statusText)</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+          statusString += &quot; - &quot; + status.statusText;</span>
<a href="#l38.337"></a><span id="l38.337" class="difflineplus">+        let label = r ? _(&quot;tooltip.status&quot;, r) : _(&quot;tooltip.statusNoResource&quot;);</span>
<a href="#l38.338"></a><span id="l38.338" class="difflineplus">+        tooltipInfo.push(new TooltipInfo(label, statusString));</span>
<a href="#l38.339"></a><span id="l38.339" class="difflineplus">+      }</span>
<a href="#l38.340"></a><span id="l38.340" class="difflineplus">+    }</span>
<a href="#l38.341"></a><span id="l38.341" class="difflineplus">+</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineplus">+    // The subscription value is interesting to display only in unusual cases.</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineplus">+    if (this.subscription != &quot;both&quot;) {</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineplus">+      tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.subscription&quot;),</span>
<a href="#l38.345"></a><span id="l38.345" class="difflineplus">+                                       this.subscription));</span>
<a href="#l38.346"></a><span id="l38.346" class="difflineplus">+    }</span>
<a href="#l38.347"></a><span id="l38.347" class="difflineplus">+</span>
<a href="#l38.348"></a><span id="l38.348" class="difflineplus">+    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineplus">+  },</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineplus">+</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineplus">+  get normalizedName() this.userName,</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineplus">+  /* Display name of the buddy */</span>
<a href="#l38.353"></a><span id="l38.353" class="difflineplus">+  get contactDisplayName() this.buddy.contact.displayName || this.displayName,</span>
<a href="#l38.354"></a><span id="l38.354" class="difflineplus">+</span>
<a href="#l38.355"></a><span id="l38.355" class="difflineplus">+  _saveIcon: function(aPhotoNode) {</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineplus">+    let type = aPhotoNode.getElement([&quot;TYPE&quot;]).innerText;</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineplus">+    const ext = {&quot;image/gif&quot;: &quot;gif&quot;, &quot;image/jpeg&quot;: &quot;jpg&quot;, &quot;image/png&quot;: &quot;png&quot;};</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineplus">+    if (!ext.hasOwnProperty(type))</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineplus">+      return;</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineplus">+</span>
<a href="#l38.361"></a><span id="l38.361" class="difflineplus">+    let data = aPhotoNode.getElement([&quot;BINVAL&quot;]).innerText;</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineplus">+    let content = atob(data.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l38.363"></a><span id="l38.363" class="difflineplus">+    let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l38.364"></a><span id="l38.364" class="difflineplus">+                  .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l38.365"></a><span id="l38.365" class="difflineplus">+    istream.setData(content, content.length);</span>
<a href="#l38.366"></a><span id="l38.366" class="difflineplus">+</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineplus">+    let fileName = this.normalizedName + &quot;.&quot; + ext[type];</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineplus">+    let file = FileUtils.getFile(&quot;ProfD&quot;, [&quot;icons&quot;,</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineplus">+                                           this.account.protocol.normalizedName,</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineplus">+                                           this.account.normalizedName,</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineplus">+                                           fileName]);</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineplus">+    let ostream = FileUtils.openSafeFileOutputStream(file);</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineplus">+    let buddy = this;</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineplus">+    NetUtil.asyncCopy(istream, ostream, function(rc) {</span>
<a href="#l38.375"></a><span id="l38.375" class="difflineplus">+      if (Components.isSuccessCode(rc))</span>
<a href="#l38.376"></a><span id="l38.376" class="difflineplus">+        buddy.buddyIconFilename = Services.io.newFileURI(file).spec;</span>
<a href="#l38.377"></a><span id="l38.377" class="difflineplus">+    });</span>
<a href="#l38.378"></a><span id="l38.378" class="difflineplus">+  },</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineplus">+</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineplus">+  _preferredResource: undefined,</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineplus">+  _resources: null,</span>
<a href="#l38.382"></a><span id="l38.382" class="difflineplus">+  // Called by the account when a presence stanza is received for this buddy.</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineplus">+  onPresenceStanza: function(aStanza) {</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineplus">+    let preferred = this._preferredResource;</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineplus">+</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineplus">+    // Facebook chat's XMPP server doesn't send resources, let's</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+    // replace undefined resources with empty resources.</span>
<a href="#l38.388"></a><span id="l38.388" class="difflineplus">+    let resource =</span>
<a href="#l38.389"></a><span id="l38.389" class="difflineplus">+      this._account._parseJID(aStanza.attributes[&quot;from&quot;]).resource || &quot;&quot;;</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineplus">+</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineplus">+    if (aStanza.attributes[&quot;type&quot;] == &quot;unavailable&quot;) {</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineplus">+      if (!this._resources || !(resource in this._resources))</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineplus">+        return; // ignore for already offline resources.</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+      delete this._resources[resource];</span>
<a href="#l38.395"></a><span id="l38.395" class="difflineplus">+      if (preferred == resource)</span>
<a href="#l38.396"></a><span id="l38.396" class="difflineplus">+        preferred = undefined;</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineplus">+    }</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineplus">+    else {</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineplus">+      let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineplus">+      let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineplus">+      if (show) {</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineplus">+        show = show.innerText;</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineplus">+        if (show == &quot;away&quot;)</span>
<a href="#l38.404"></a><span id="l38.404" class="difflineplus">+          statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l38.405"></a><span id="l38.405" class="difflineplus">+        else if (show == &quot;chat&quot;)</span>
<a href="#l38.406"></a><span id="l38.406" class="difflineplus">+          statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; //FIXME</span>
<a href="#l38.407"></a><span id="l38.407" class="difflineplus">+        else if (show == &quot;dnd&quot;)</span>
<a href="#l38.408"></a><span id="l38.408" class="difflineplus">+          statusType = Ci.imIStatusInfo.STATUS_UNAVAILABLE;</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineplus">+        else if (show == &quot;xa&quot;)</span>
<a href="#l38.410"></a><span id="l38.410" class="difflineplus">+          statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l38.411"></a><span id="l38.411" class="difflineplus">+      }</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineplus">+</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineplus">+      let idleSince = 0;</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineplus">+      let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l38.415"></a><span id="l38.415" class="difflineplus">+      if (query &amp;&amp; query.uri == Stanza.NS.last) {</span>
<a href="#l38.416"></a><span id="l38.416" class="difflineplus">+        let now = Math.floor(Date.now() / 1000);</span>
<a href="#l38.417"></a><span id="l38.417" class="difflineplus">+        idleSince = now - parseInt(query.attributes[&quot;seconds&quot;], 10);</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineplus">+        statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineplus">+      }</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineplus">+</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineplus">+      let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineplus">+      if (status)</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineplus">+        status = status.innerText;</span>
<a href="#l38.424"></a><span id="l38.424" class="difflineplus">+</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineplus">+      let priority = aStanza.getElement([&quot;priority&quot;]);</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineplus">+      priority = priority ? parseInt(priority.innerText, 10) : 0;</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineplus">+</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineplus">+      if (!this._resources)</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineplus">+        this._resources = {};</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineplus">+      this._resources[resource] = {</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineplus">+        statusType: statusType,</span>
<a href="#l38.432"></a><span id="l38.432" class="difflineplus">+        statusText: status,</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineplus">+        idleSince: idleSince,</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineplus">+        priority: priority,</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineplus">+        stanza: aStanza</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineplus">+      };</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineplus">+    }</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineplus">+</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineplus">+    for (let r in this._resources) {</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineplus">+      if (preferred === undefined ||</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineplus">+          this._resources[r].statusType &gt; this._resources[preferred].statusType)</span>
<a href="#l38.442"></a><span id="l38.442" class="difflineplus">+        // FIXME also compare priorities...</span>
<a href="#l38.443"></a><span id="l38.443" class="difflineplus">+        preferred = r;</span>
<a href="#l38.444"></a><span id="l38.444" class="difflineplus">+    }</span>
<a href="#l38.445"></a><span id="l38.445" class="difflineplus">+</span>
<a href="#l38.446"></a><span id="l38.446" class="difflineplus">+    if (preferred == this._preferredResource &amp;&amp; resource != preferred) {</span>
<a href="#l38.447"></a><span id="l38.447" class="difflineplus">+      // The presence information change is only for an unused resource,</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineplus">+      // only potential buddy tooltips need to be refreshed.</span>
<a href="#l38.449"></a><span id="l38.449" class="difflineplus">+      this._notifyObservers(&quot;status-detail-changed&quot;);</span>
<a href="#l38.450"></a><span id="l38.450" class="difflineplus">+      return;</span>
<a href="#l38.451"></a><span id="l38.451" class="difflineplus">+    }</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineplus">+</span>
<a href="#l38.453"></a><span id="l38.453" class="difflineplus">+    // Presence info has changed enough that if we are having a</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineplus">+    // conversation with one resource of this buddy, we should send</span>
<a href="#l38.455"></a><span id="l38.455" class="difflineplus">+    // the next message to all resources.</span>
<a href="#l38.456"></a><span id="l38.456" class="difflineplus">+    // FIXME: the test here isn't exactly right...</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineplus">+    if (this._preferredResource != preferred &amp;&amp;</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineplus">+        this._account._conv.hasOwnProperty(this.normalizedName))</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineplus">+      delete this._account._conv[this.normalizedName]._targetResource;</span>
<a href="#l38.460"></a><span id="l38.460" class="difflineplus">+</span>
<a href="#l38.461"></a><span id="l38.461" class="difflineplus">+    this._preferredResource = preferred;</span>
<a href="#l38.462"></a><span id="l38.462" class="difflineplus">+    if (preferred === undefined)</span>
<a href="#l38.463"></a><span id="l38.463" class="difflineplus">+      this.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l38.464"></a><span id="l38.464" class="difflineplus">+    else {</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineplus">+      preferred = this._resources[preferred];</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineplus">+      this.setStatus(preferred.statusType, preferred.statusText);</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineplus">+    }</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineplus">+  },</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineplus">+</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineplus">+  /* Can send messages to buddies who appear offline */</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineplus">+  get canSendMessage() this.account.connected,</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineplus">+</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineplus">+  /* Called when the user wants to chat with the buddy */</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineplus">+  createConversation: function()</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineplus">+    this._account.createConversation(this.normalizedName)</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineplus">+};</span>
<a href="#l38.477"></a><span id="l38.477" class="difflineplus">+function XMPPAccountBuddy(aAccount, aBuddy, aTag, aUserName)</span>
<a href="#l38.478"></a><span id="l38.478" class="difflineplus">+{</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineplus">+  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l38.480"></a><span id="l38.480" class="difflineplus">+}</span>
<a href="#l38.481"></a><span id="l38.481" class="difflineplus">+XMPPAccountBuddy.prototype = XMPPAccountBuddyPrototype;</span>
<a href="#l38.482"></a><span id="l38.482" class="difflineplus">+</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineplus">+/* Helper class for account */</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineplus">+const XMPPAccountPrototype = {</span>
<a href="#l38.485"></a><span id="l38.485" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l38.486"></a><span id="l38.486" class="difflineplus">+</span>
<a href="#l38.487"></a><span id="l38.487" class="difflineplus">+  _jid: null, // parsed Jabber ID: node, domain, resource</span>
<a href="#l38.488"></a><span id="l38.488" class="difflineplus">+  _connection: null, // XMPP Connection</span>
<a href="#l38.489"></a><span id="l38.489" class="difflineplus">+</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineplus">+  _init: function(aProtoInstance, aImAccount) {</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineplus">+    GenericAccountPrototype._init.call(this, aProtoInstance, aImAccount);</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineplus">+</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineplus">+    /* Ongoing conversations */</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineplus">+    this._conv = {};</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineplus">+    this._buddies = {};</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineplus">+    this._mucs = {};</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineplus">+  },</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineplus">+</span>
<a href="#l38.499"></a><span id="l38.499" class="difflineplus">+  get canJoinChat() true,</span>
<a href="#l38.500"></a><span id="l38.500" class="difflineplus">+  chatRoomFields: {</span>
<a href="#l38.501"></a><span id="l38.501" class="difflineplus">+    room: {get label() _(&quot;chatRoomField.room&quot;), required: true},</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineplus">+    server: {get label() _(&quot;chatRoomField.server&quot;), required: true},</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineplus">+    nick: {get label() _(&quot;chatRoomField.nick&quot;), required: true},</span>
<a href="#l38.504"></a><span id="l38.504" class="difflineplus">+    password: {get label() _(&quot;chatRoomField.password&quot;), isPassword: true}</span>
<a href="#l38.505"></a><span id="l38.505" class="difflineplus">+  },</span>
<a href="#l38.506"></a><span id="l38.506" class="difflineplus">+  parseDefaultChatName: function(aDefaultChatName) {</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineplus">+    if (!aDefaultChatName)</span>
<a href="#l38.508"></a><span id="l38.508" class="difflineplus">+      return {nick: this._jid.node};</span>
<a href="#l38.509"></a><span id="l38.509" class="difflineplus">+</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineplus">+    let jid = this._parseJID(aDefaultChatName);</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineplus">+    return {</span>
<a href="#l38.512"></a><span id="l38.512" class="difflineplus">+      room: jid.node,</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineplus">+      server: jid.domain,</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineplus">+      nick: jid.resource || this._jid.node</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineplus">+    };</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineplus">+  },</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineplus">+  getChatRoomDefaultFieldValues: function(aDefaultChatName) {</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineplus">+    let rv = GenericAccountPrototype.getChatRoomDefaultFieldValues</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineplus">+                                    .call(this, aDefaultChatName);</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineplus">+    if (!rv.values.nick)</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineplus">+      rv.values.nick = this._jid.node;</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineplus">+</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineplus">+    return rv;</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineplus">+  },</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineplus">+  joinChat: function(aComponents) {</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineplus">+    let jid =</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineplus">+      aComponents.getValue(&quot;room&quot;) + &quot;@&quot; + aComponents.getValue(&quot;server&quot;);</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineplus">+    let nick = aComponents.getValue(&quot;nick&quot;);</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineplus">+    if (jid in this._mucs)</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineplus">+      return; // FIXME, check if we need to rejoin</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineplus">+</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineplus">+    let x;</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineplus">+    let password = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineplus">+    if (password) {</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineplus">+      x = Stanza.node(&quot;x&quot;, Stanza.NS.muc, null,</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineplus">+                      Stanza.node(&quot;password&quot;, null, null, password));</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineplus">+    }</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineplus">+    this._mucs[jid] = nick;</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineplus">+    this._connection.sendStanza(Stanza.presence({to: jid + &quot;/&quot; + nick}, x));</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineplus">+  },</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineplus">+</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineplus">+  get normalizedName() this._normalizeJID(this.name),</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineplus">+</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineplus">+  _idleSince: 0,</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineplus">+    if (aTopic == &quot;idle-time-changed&quot;) {</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineplus">+      let idleTime = parseInt(aData, 10);</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineplus">+      if (idleTime)</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineplus">+        this._idleSince = Math.floor(Date.now() / 1000) - idleTime;</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineplus">+      else</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineplus">+        delete this._idleSince;</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineplus">+      this._shouldSendPresenceForIdlenessChange = true;</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineplus">+      executeSoon((function() {</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineplus">+        if (&quot;_shouldSendPresenceForIdlenessChange&quot; in this)</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineplus">+          this._sendPresence();</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineplus">+      }).bind(this));</span>
<a href="#l38.557"></a><span id="l38.557" class="difflineplus">+    }</span>
<a href="#l38.558"></a><span id="l38.558" class="difflineplus">+</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineplus">+    if (aTopic != &quot;status-changed&quot;)</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineplus">+      return;</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineplus">+</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineplus">+    this._sendPresence();</span>
<a href="#l38.563"></a><span id="l38.563" class="difflineplus">+  },</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineplus">+</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineplus">+  /* GenericAccountPrototype events */</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineplus">+  /* Connect to the server */</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineplus">+  connect: function() {</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineplus">+    this._jid = this._parseJID(this.name);</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineplus">+</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineplus">+    // For the resource, if the user has edited the option to a non</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineplus">+    // empty value, use that.</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l38.573"></a><span id="l38.573" class="difflineplus">+      let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l38.574"></a><span id="l38.574" class="difflineplus">+      if (resource)</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineplus">+        this._jid.resource = resource;</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineplus">+    }</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineplus">+    // Otherwise, if the username doesn't contain a resource, use the</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineplus">+    // value of the resource option (it will be the default value).</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineplus">+    // If we set an empty resource, XMPPSession will fallback to &quot;instantbird&quot;</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineplus">+    if (!this._jid.resource)</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineplus">+      this._jid.resource = this.getString(&quot;resource&quot;);</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineplus">+</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineplus">+    //FIXME if we have changed this._jid.resource, then this._jid.jid</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineplus">+    // needs to be updated. This value is however never used because</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineplus">+    // while connected it's the jid of the session that's interesting.</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineplus">+</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineplus">+    this._connection =</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineplus">+      new XMPPSession(this.getString(&quot;server&quot;) || this._jid.domain,</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineplus">+                      this.getInt(&quot;port&quot;) || 5222,</span>
<a href="#l38.590"></a><span id="l38.590" class="difflineplus">+                      this.getString(&quot;connection_security&quot;), this._jid,</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineplus">+                      this.imAccount.password, this);</span>
<a href="#l38.592"></a><span id="l38.592" class="difflineplus">+  },</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineplus">+</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineplus">+  /* Disconnect from the server */</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineplus">+  disconnect: function() {</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineplus">+    this._disconnect();</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineplus">+  },</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineplus">+</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineplus">+  /* Loads a buddy from the local storage.</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineplus">+   * Called for each buddy locally stored before connecting</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineplus">+   * to the server. */</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineplus">+  loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineplus">+    let buddy = new this._accountBuddyConstructor(this, aBuddy, aTag);</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineplus">+    this._buddies[buddy.normalizedName] = buddy;</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineplus">+    return buddy;</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineplus">+  },</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineplus">+</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineplus">+  /* XMPPSession events */</span>
<a href="#l38.609"></a><span id="l38.609" class="difflineplus">+  /* Called when the XMPP session is started */</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineplus">+  onConnection: function() {</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineplus">+    this.reportConnecting(_(&quot;connection.downloadingRoster&quot;));</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineplus">+    let s = Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;query&quot;, Stanza.NS.roster));</span>
<a href="#l38.613"></a><span id="l38.613" class="difflineplus">+</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineplus">+    /* Set the call back onRoster */</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineplus">+    this._connection.sendStanza(s, this.onRoster, this);</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineplus">+  },</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineplus">+</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineplus">+</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineplus">+  /* Called whenever a stanza is received */</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineplus">+  onXmppStanza: function(aStanza) {</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineplus">+  },</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineplus">+</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineplus">+  /* Called when a iq stanza is received */</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineplus">+  onIQStanza: function(aStanza) {</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineplus">+    if (aStanza.attributes[&quot;from&quot;] == this._jid.domain) {</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineplus">+      let ping = aStanza.getElement([&quot;ping&quot;]);</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineplus">+      if (ping &amp;&amp; ping.uri == Stanza.NS.ping) {</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineplus">+        let s = Stanza.iq(&quot;result&quot;, aStanza.attributes[&quot;id&quot;], this._jid.domain);</span>
<a href="#l38.629"></a><span id="l38.629" class="difflineplus">+        this._connection.sendStanza(s);</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineplus">+      }</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineplus">+    }</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineplus">+  },</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineplus">+</span>
<a href="#l38.634"></a><span id="l38.634" class="difflineplus">+  /* Called when a presence stanza is received */</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineplus">+  onPresenceStanza: function(aStanza) {</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineplus">+    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineplus">+    DEBUG(&quot;Received presence stanza for &quot; + from);</span>
<a href="#l38.638"></a><span id="l38.638" class="difflineplus">+</span>
<a href="#l38.639"></a><span id="l38.639" class="difflineplus">+    let jid = this._normalizeJID(from);</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineplus">+    if (jid in this._buddies)</span>
<a href="#l38.641"></a><span id="l38.641" class="difflineplus">+      this._buddies[jid].onPresenceStanza(aStanza);</span>
<a href="#l38.642"></a><span id="l38.642" class="difflineplus">+    else if (jid in this._mucs) {</span>
<a href="#l38.643"></a><span id="l38.643" class="difflineplus">+      if (typeof(this._mucs[jid]) == &quot;string&quot;) {</span>
<a href="#l38.644"></a><span id="l38.644" class="difflineplus">+        // We have attempted to join, but not created the conversation yet.</span>
<a href="#l38.645"></a><span id="l38.645" class="difflineplus">+        if (aStanza.attributes[&quot;type&quot;] == &quot;error&quot;) {</span>
<a href="#l38.646"></a><span id="l38.646" class="difflineplus">+          delete this._mucs[jid];</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineplus">+          ERROR(&quot;Failed to join MUC: &quot; + aStanza.convertToString());</span>
<a href="#l38.648"></a><span id="l38.648" class="difflineplus">+          return;</span>
<a href="#l38.649"></a><span id="l38.649" class="difflineplus">+        }</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineplus">+        let nick = this._mucs[jid];</span>
<a href="#l38.651"></a><span id="l38.651" class="difflineplus">+        this._mucs[jid] = new this._MUCConversationConstructor(this, jid, nick);</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineplus">+      }</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineplus">+      this._mucs[jid].onPresenceStanza(aStanza);</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineplus">+    }</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineplus">+    else if (from != this._connection._jid.jid)</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineplus">+      WARN(&quot;received presence stanza for unknown buddy &quot; + from);</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineplus">+  },</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineplus">+</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineplus">+  /* Called when a message stanza is received */</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineplus">+  onMessageStanza: function(aStanza) {</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineplus">+    let norm = this._normalizeJID(aStanza.attributes[&quot;from&quot;]);</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineplus">+</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineplus">+    let body;</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineplus">+    let b = aStanza.getElement([&quot;body&quot;]);</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineplus">+    if (b)</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineplus">+      body = b.getXML();</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineplus">+    if (body) {</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineplus">+      let date;</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineplus">+      let delay = aStanza.getElement([&quot;delay&quot;]);</span>
<a href="#l38.670"></a><span id="l38.670" class="difflineplus">+      if (delay &amp;&amp; delay.uri == Stanza.NS.delay) {</span>
<a href="#l38.671"></a><span id="l38.671" class="difflineplus">+        if (delay.attributes[&quot;stamp&quot;])</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineplus">+          date = new Date(delay.attributes[&quot;stamp&quot;]);</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineplus">+      }</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineplus">+      if (date &amp;&amp; isNaN(date))</span>
<a href="#l38.675"></a><span id="l38.675" class="difflineplus">+        date = undefined;</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineplus">+      if (aStanza.attributes[&quot;type&quot;] == &quot;groupchat&quot;) {</span>
<a href="#l38.677"></a><span id="l38.677" class="difflineplus">+        if (!this._mucs.hasOwnProperty(norm)) {</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineplus">+          WARN(&quot;Received a groupchat message for unknown MUC &quot; + norm);</span>
<a href="#l38.679"></a><span id="l38.679" class="difflineplus">+          return;</span>
<a href="#l38.680"></a><span id="l38.680" class="difflineplus">+        }</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineplus">+        this._mucs[norm].incomingMessage(body, aStanza, date);</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineplus">+        return;</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineplus">+      }</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineplus">+</span>
<a href="#l38.685"></a><span id="l38.685" class="difflineplus">+      if (!this.createConversation(norm))</span>
<a href="#l38.686"></a><span id="l38.686" class="difflineplus">+        return;</span>
<a href="#l38.687"></a><span id="l38.687" class="difflineplus">+      this._conv[norm].incomingMessage(body, aStanza, date);</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineplus">+    }</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineplus">+</span>
<a href="#l38.690"></a><span id="l38.690" class="difflineplus">+    // Don't create a conversation to only display the typing notifications.</span>
<a href="#l38.691"></a><span id="l38.691" class="difflineplus">+    if (!this._conv.hasOwnProperty(norm))</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineplus">+      return;</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineplus">+</span>
<a href="#l38.694"></a><span id="l38.694" class="difflineplus">+    let state;</span>
<a href="#l38.695"></a><span id="l38.695" class="difflineplus">+    let s = aStanza.getChildrenByNS(Stanza.NS.chatstates);</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineplus">+    if (s.length &gt; 0)</span>
<a href="#l38.697"></a><span id="l38.697" class="difflineplus">+      state = s[0].localName;</span>
<a href="#l38.698"></a><span id="l38.698" class="difflineplus">+    if (state) {</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineplus">+      DEBUG(state);</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineplus">+      if (state == &quot;active&quot;)</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineplus">+        this._conv[norm].updateTyping(Ci.purpleIConvIM.NOT_TYPING);</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineplus">+      else if (state == &quot;composing&quot;)</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineplus">+        this._conv[norm].updateTyping(Ci.purpleIConvIM.TYPING);</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineplus">+      else if (state == &quot;paused&quot;)</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineplus">+        this._conv[norm].updateTyping(Ci.purpleIConvIM.TYPED);</span>
<a href="#l38.706"></a><span id="l38.706" class="difflineplus">+    }</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineplus">+    else</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineplus">+      this._conv[norm].supportChatStateNotifications = false;</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineplus">+  },</span>
<a href="#l38.710"></a><span id="l38.710" class="difflineplus">+</span>
<a href="#l38.711"></a><span id="l38.711" class="difflineplus">+  /* Called when there is an error in the xmpp session */</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineplus">+  onError: function(aError, aException) {</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineplus">+    if (aError === null || aError === undefined)</span>
<a href="#l38.714"></a><span id="l38.714" class="difflineplus">+      aError = Ci.prplIAccount.ERROR_OTHER_ERROR;</span>
<a href="#l38.715"></a><span id="l38.715" class="difflineplus">+    this._disconnect(aError, aException.toString());</span>
<a href="#l38.716"></a><span id="l38.716" class="difflineplus">+  },</span>
<a href="#l38.717"></a><span id="l38.717" class="difflineplus">+</span>
<a href="#l38.718"></a><span id="l38.718" class="difflineplus">+  /* Callbacks for Query stanzas */</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineplus">+  /* When a vCard is recieved */</span>
<a href="#l38.720"></a><span id="l38.720" class="difflineplus">+  onVCard: function(aStanza) {</span>
<a href="#l38.721"></a><span id="l38.721" class="difflineplus">+    let jid = this._normalizeJID(aStanza.attributes[&quot;from&quot;]);</span>
<a href="#l38.722"></a><span id="l38.722" class="difflineplus">+    if (!jid || !this._buddies.hasOwnProperty(jid))</span>
<a href="#l38.723"></a><span id="l38.723" class="difflineplus">+      return;</span>
<a href="#l38.724"></a><span id="l38.724" class="difflineplus">+    let buddy = this._buddies[jid];</span>
<a href="#l38.725"></a><span id="l38.725" class="difflineplus">+</span>
<a href="#l38.726"></a><span id="l38.726" class="difflineplus">+    let vCard = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l38.727"></a><span id="l38.727" class="difflineplus">+    if (!vCard)</span>
<a href="#l38.728"></a><span id="l38.728" class="difflineplus">+      return;</span>
<a href="#l38.729"></a><span id="l38.729" class="difflineplus">+</span>
<a href="#l38.730"></a><span id="l38.730" class="difflineplus">+    for each (let c in vCard.children) {</span>
<a href="#l38.731"></a><span id="l38.731" class="difflineplus">+      if (c.type != &quot;node&quot;)</span>
<a href="#l38.732"></a><span id="l38.732" class="difflineplus">+        continue;</span>
<a href="#l38.733"></a><span id="l38.733" class="difflineplus">+      if (c.localName == &quot;FN&quot;)</span>
<a href="#l38.734"></a><span id="l38.734" class="difflineplus">+        buddy.serverAlias = c.innerText;</span>
<a href="#l38.735"></a><span id="l38.735" class="difflineplus">+      if (c.localName == &quot;PHOTO&quot;)</span>
<a href="#l38.736"></a><span id="l38.736" class="difflineplus">+        buddy._saveIcon(c);</span>
<a href="#l38.737"></a><span id="l38.737" class="difflineplus">+    }</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineplus">+  },</span>
<a href="#l38.739"></a><span id="l38.739" class="difflineplus">+</span>
<a href="#l38.740"></a><span id="l38.740" class="difflineplus">+  _normalizeJID: function(aJID) {</span>
<a href="#l38.741"></a><span id="l38.741" class="difflineplus">+    let slashIndex = aJID.indexOf(&quot;/&quot;);</span>
<a href="#l38.742"></a><span id="l38.742" class="difflineplus">+    if (slashIndex != -1)</span>
<a href="#l38.743"></a><span id="l38.743" class="difflineplus">+      aJID = aJID.substr(0, slashIndex);</span>
<a href="#l38.744"></a><span id="l38.744" class="difflineplus">+    return aJID.toLowerCase();</span>
<a href="#l38.745"></a><span id="l38.745" class="difflineplus">+  },</span>
<a href="#l38.746"></a><span id="l38.746" class="difflineplus">+</span>
<a href="#l38.747"></a><span id="l38.747" class="difflineplus">+  _parseJID: function(aJid) {</span>
<a href="#l38.748"></a><span id="l38.748" class="difflineplus">+    let match =</span>
<a href="#l38.749"></a><span id="l38.749" class="difflineplus">+      /^(?:([^@/&lt;&gt;'\&quot;]+)@)?([^@/&lt;&gt;'\&quot;]+)(?:\/([^&lt;&gt;'\&quot;]*))?$/.exec(aJid);</span>
<a href="#l38.750"></a><span id="l38.750" class="difflineplus">+    if (!match)</span>
<a href="#l38.751"></a><span id="l38.751" class="difflineplus">+      return null;</span>
<a href="#l38.752"></a><span id="l38.752" class="difflineplus">+</span>
<a href="#l38.753"></a><span id="l38.753" class="difflineplus">+    return {jid: match[0], node: match[1], domain: match[2],</span>
<a href="#l38.754"></a><span id="l38.754" class="difflineplus">+            resource: match[3]};</span>
<a href="#l38.755"></a><span id="l38.755" class="difflineplus">+  },</span>
<a href="#l38.756"></a><span id="l38.756" class="difflineplus">+</span>
<a href="#l38.757"></a><span id="l38.757" class="difflineplus">+  /* When the roster is received */</span>
<a href="#l38.758"></a><span id="l38.758" class="difflineplus">+  onRoster: function(aStanza) {</span>
<a href="#l38.759"></a><span id="l38.759" class="difflineplus">+    for each (let qe in aStanza.getChildren(&quot;query&quot;)) {</span>
<a href="#l38.760"></a><span id="l38.760" class="difflineplus">+      if (qe.uri != Stanza.NS.roster)</span>
<a href="#l38.761"></a><span id="l38.761" class="difflineplus">+        continue;</span>
<a href="#l38.762"></a><span id="l38.762" class="difflineplus">+</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineplus">+      for each (let item in qe.getChildren(&quot;item&quot;)) {</span>
<a href="#l38.764"></a><span id="l38.764" class="difflineplus">+        let jid = item.attributes[&quot;jid&quot;];</span>
<a href="#l38.765"></a><span id="l38.765" class="difflineplus">+        if (!jid) {</span>
<a href="#l38.766"></a><span id="l38.766" class="difflineplus">+          WARN(&quot;Received a roster item without jid: &quot; + item.getXML());</span>
<a href="#l38.767"></a><span id="l38.767" class="difflineplus">+          continue;</span>
<a href="#l38.768"></a><span id="l38.768" class="difflineplus">+        }</span>
<a href="#l38.769"></a><span id="l38.769" class="difflineplus">+        jid = this._normalizeJID(jid);</span>
<a href="#l38.770"></a><span id="l38.770" class="difflineplus">+</span>
<a href="#l38.771"></a><span id="l38.771" class="difflineplus">+        let subscription =  &quot;&quot;;</span>
<a href="#l38.772"></a><span id="l38.772" class="difflineplus">+        if (&quot;subscription&quot; in item.attributes)</span>
<a href="#l38.773"></a><span id="l38.773" class="difflineplus">+          subscription = item.attributes[&quot;subscription&quot;];</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineplus">+        if (subscription == &quot;both&quot; || subscription == &quot;to&quot;) {</span>
<a href="#l38.775"></a><span id="l38.775" class="difflineplus">+          let s = Stanza.iq(&quot;get&quot;, null, jid,</span>
<a href="#l38.776"></a><span id="l38.776" class="difflineplus">+                            Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l38.777"></a><span id="l38.777" class="difflineplus">+          this._connection.sendStanza(s, this.onVCard, this);</span>
<a href="#l38.778"></a><span id="l38.778" class="difflineplus">+        }</span>
<a href="#l38.779"></a><span id="l38.779" class="difflineplus">+        else</span>
<a href="#l38.780"></a><span id="l38.780" class="difflineplus">+          DEBUG(&quot;not subscribed to &quot; + jid + &quot;'s presence&quot;);</span>
<a href="#l38.781"></a><span id="l38.781" class="difflineplus">+</span>
<a href="#l38.782"></a><span id="l38.782" class="difflineplus">+        let buddy;</span>
<a href="#l38.783"></a><span id="l38.783" class="difflineplus">+        if (this._buddies.hasOwnProperty(jid))</span>
<a href="#l38.784"></a><span id="l38.784" class="difflineplus">+          buddy = this._buddies[jid];</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineplus">+        else {</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineplus">+          let tagName = _(&quot;defaultGroup&quot;);</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineplus">+          for each (let group in item.getChildren(&quot;group&quot;)) {</span>
<a href="#l38.788"></a><span id="l38.788" class="difflineplus">+            let name = group.innerText;</span>
<a href="#l38.789"></a><span id="l38.789" class="difflineplus">+            if (name) {</span>
<a href="#l38.790"></a><span id="l38.790" class="difflineplus">+              tagName = name;</span>
<a href="#l38.791"></a><span id="l38.791" class="difflineplus">+              break; // TODO we should create an accountBuddy per group,</span>
<a href="#l38.792"></a><span id="l38.792" class="difflineplus">+                     // but this._buddies would probably not like that...</span>
<a href="#l38.793"></a><span id="l38.793" class="difflineplus">+            }</span>
<a href="#l38.794"></a><span id="l38.794" class="difflineplus">+          }</span>
<a href="#l38.795"></a><span id="l38.795" class="difflineplus">+          let tag = Services.tags.createTag(tagName);</span>
<a href="#l38.796"></a><span id="l38.796" class="difflineplus">+          buddy = new this._accountBuddyConstructor(this, null, tag, jid);</span>
<a href="#l38.797"></a><span id="l38.797" class="difflineplus">+        }</span>
<a href="#l38.798"></a><span id="l38.798" class="difflineplus">+</span>
<a href="#l38.799"></a><span id="l38.799" class="difflineplus">+        let alias = &quot;name&quot; in item.attributes ? item.attributes[&quot;name&quot;] : &quot;&quot;;</span>
<a href="#l38.800"></a><span id="l38.800" class="difflineplus">+        if (alias)</span>
<a href="#l38.801"></a><span id="l38.801" class="difflineplus">+          buddy._serverAlias = alias;</span>
<a href="#l38.802"></a><span id="l38.802" class="difflineplus">+        if (subscription)</span>
<a href="#l38.803"></a><span id="l38.803" class="difflineplus">+          buddy.subscription = subscription;</span>
<a href="#l38.804"></a><span id="l38.804" class="difflineplus">+        if (!this._buddies.hasOwnProperty(jid)) {</span>
<a href="#l38.805"></a><span id="l38.805" class="difflineplus">+          this._buddies[jid] = buddy;</span>
<a href="#l38.806"></a><span id="l38.806" class="difflineplus">+          Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l38.807"></a><span id="l38.807" class="difflineplus">+        }</span>
<a href="#l38.808"></a><span id="l38.808" class="difflineplus">+      }</span>
<a href="#l38.809"></a><span id="l38.809" class="difflineplus">+    }</span>
<a href="#l38.810"></a><span id="l38.810" class="difflineplus">+</span>
<a href="#l38.811"></a><span id="l38.811" class="difflineplus">+    this._sendPresence();</span>
<a href="#l38.812"></a><span id="l38.812" class="difflineplus">+    for each (let b in this._buddies) {</span>
<a href="#l38.813"></a><span id="l38.813" class="difflineplus">+      if (b.subscription == &quot;both&quot; || b.subscription == &quot;to&quot;)</span>
<a href="#l38.814"></a><span id="l38.814" class="difflineplus">+        b.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l38.815"></a><span id="l38.815" class="difflineplus">+    }</span>
<a href="#l38.816"></a><span id="l38.816" class="difflineplus">+    this.reportConnected();</span>
<a href="#l38.817"></a><span id="l38.817" class="difflineplus">+  },</span>
<a href="#l38.818"></a><span id="l38.818" class="difflineplus">+</span>
<a href="#l38.819"></a><span id="l38.819" class="difflineplus">+  /* Public methods */</span>
<a href="#l38.820"></a><span id="l38.820" class="difflineplus">+  /* Send a stanza to a buddy */</span>
<a href="#l38.821"></a><span id="l38.821" class="difflineplus">+  sendStanza: function(aStanza) {</span>
<a href="#l38.822"></a><span id="l38.822" class="difflineplus">+    this._connection.sendStanza(aStanza);</span>
<a href="#l38.823"></a><span id="l38.823" class="difflineplus">+  },</span>
<a href="#l38.824"></a><span id="l38.824" class="difflineplus">+</span>
<a href="#l38.825"></a><span id="l38.825" class="difflineplus">+  // Variations of the XMPP protocol can change these default constructors:</span>
<a href="#l38.826"></a><span id="l38.826" class="difflineplus">+  _conversationConstructor: XMPPConversation,</span>
<a href="#l38.827"></a><span id="l38.827" class="difflineplus">+  _MUCConversationConstructor: XMPPMUCConversation,</span>
<a href="#l38.828"></a><span id="l38.828" class="difflineplus">+  _accountBuddyConstructor: XMPPAccountBuddy,</span>
<a href="#l38.829"></a><span id="l38.829" class="difflineplus">+</span>
<a href="#l38.830"></a><span id="l38.830" class="difflineplus">+  /* Create a new conversation */</span>
<a href="#l38.831"></a><span id="l38.831" class="difflineplus">+  createConversation: function(aNormalizedName) {</span>
<a href="#l38.832"></a><span id="l38.832" class="difflineplus">+    if (!this._buddies.hasOwnProperty(aNormalizedName)) {</span>
<a href="#l38.833"></a><span id="l38.833" class="difflineplus">+      ERROR(&quot;Trying to create a conversation; buddy not present: &quot; + aNormalizedName);</span>
<a href="#l38.834"></a><span id="l38.834" class="difflineplus">+      return null;</span>
<a href="#l38.835"></a><span id="l38.835" class="difflineplus">+    }</span>
<a href="#l38.836"></a><span id="l38.836" class="difflineplus">+</span>
<a href="#l38.837"></a><span id="l38.837" class="difflineplus">+    if (!this._conv.hasOwnProperty(aNormalizedName)) {</span>
<a href="#l38.838"></a><span id="l38.838" class="difflineplus">+      this._conv[aNormalizedName] =</span>
<a href="#l38.839"></a><span id="l38.839" class="difflineplus">+        new this._conversationConstructor(this, this._buddies[aNormalizedName]);</span>
<a href="#l38.840"></a><span id="l38.840" class="difflineplus">+    }</span>
<a href="#l38.841"></a><span id="l38.841" class="difflineplus">+</span>
<a href="#l38.842"></a><span id="l38.842" class="difflineplus">+    return this._conv[aNormalizedName];</span>
<a href="#l38.843"></a><span id="l38.843" class="difflineplus">+  },</span>
<a href="#l38.844"></a><span id="l38.844" class="difflineplus">+</span>
<a href="#l38.845"></a><span id="l38.845" class="difflineplus">+  /* Remove an existing conversation */</span>
<a href="#l38.846"></a><span id="l38.846" class="difflineplus">+  removeConversation: function(aNormalizedName) {</span>
<a href="#l38.847"></a><span id="l38.847" class="difflineplus">+    if (aNormalizedName in this._conv)</span>
<a href="#l38.848"></a><span id="l38.848" class="difflineplus">+      delete this._conv[aNormalizedName];</span>
<a href="#l38.849"></a><span id="l38.849" class="difflineplus">+    else if (aNormalizedName in this._mucs)</span>
<a href="#l38.850"></a><span id="l38.850" class="difflineplus">+      delete this._mucs[aNormalizedName];</span>
<a href="#l38.851"></a><span id="l38.851" class="difflineplus">+  },</span>
<a href="#l38.852"></a><span id="l38.852" class="difflineplus">+</span>
<a href="#l38.853"></a><span id="l38.853" class="difflineplus">+  /* Private methods */</span>
<a href="#l38.854"></a><span id="l38.854" class="difflineplus">+</span>
<a href="#l38.855"></a><span id="l38.855" class="difflineplus">+  /* Disconnect from the server */</span>
<a href="#l38.856"></a><span id="l38.856" class="difflineplus">+  _disconnect: function(aError, aErrorMessage) {</span>
<a href="#l38.857"></a><span id="l38.857" class="difflineplus">+    if (!this._connection)</span>
<a href="#l38.858"></a><span id="l38.858" class="difflineplus">+      return;</span>
<a href="#l38.859"></a><span id="l38.859" class="difflineplus">+</span>
<a href="#l38.860"></a><span id="l38.860" class="difflineplus">+    if (aError === undefined)</span>
<a href="#l38.861"></a><span id="l38.861" class="difflineplus">+      aError = Ci.prplIAccount.NO_ERROR;</span>
<a href="#l38.862"></a><span id="l38.862" class="difflineplus">+    this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l38.863"></a><span id="l38.863" class="difflineplus">+</span>
<a href="#l38.864"></a><span id="l38.864" class="difflineplus">+    for each (let b in this._buddies)</span>
<a href="#l38.865"></a><span id="l38.865" class="difflineplus">+      b.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;);</span>
<a href="#l38.866"></a><span id="l38.866" class="difflineplus">+</span>
<a href="#l38.867"></a><span id="l38.867" class="difflineplus">+    this._connection.disconnect();</span>
<a href="#l38.868"></a><span id="l38.868" class="difflineplus">+    delete this._connection;</span>
<a href="#l38.869"></a><span id="l38.869" class="difflineplus">+</span>
<a href="#l38.870"></a><span id="l38.870" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l38.871"></a><span id="l38.871" class="difflineplus">+  },</span>
<a href="#l38.872"></a><span id="l38.872" class="difflineplus">+</span>
<a href="#l38.873"></a><span id="l38.873" class="difflineplus">+  /* Set the user status on the server */</span>
<a href="#l38.874"></a><span id="l38.874" class="difflineplus">+  _sendPresence: function() {</span>
<a href="#l38.875"></a><span id="l38.875" class="difflineplus">+    delete this._shouldSendPresenceForIdlenessChange;</span>
<a href="#l38.876"></a><span id="l38.876" class="difflineplus">+</span>
<a href="#l38.877"></a><span id="l38.877" class="difflineplus">+    if (!this._connection)</span>
<a href="#l38.878"></a><span id="l38.878" class="difflineplus">+      return;</span>
<a href="#l38.879"></a><span id="l38.879" class="difflineplus">+</span>
<a href="#l38.880"></a><span id="l38.880" class="difflineplus">+    let si = this.imAccount.statusInfo;</span>
<a href="#l38.881"></a><span id="l38.881" class="difflineplus">+    let statusType = si.statusType;</span>
<a href="#l38.882"></a><span id="l38.882" class="difflineplus">+    let show = &quot;&quot;;</span>
<a href="#l38.883"></a><span id="l38.883" class="difflineplus">+    if (statusType == Ci.imIStatusInfo.STATUS_UNAVAILABLE)</span>
<a href="#l38.884"></a><span id="l38.884" class="difflineplus">+      show = &quot;dnd&quot;;</span>
<a href="#l38.885"></a><span id="l38.885" class="difflineplus">+    else if (statusType == Ci.imIStatusInfo.STATUS_AWAY ||</span>
<a href="#l38.886"></a><span id="l38.886" class="difflineplus">+             statusType == Ci.imIStatusInfo.STATUS_IDLE)</span>
<a href="#l38.887"></a><span id="l38.887" class="difflineplus">+      show = &quot;away&quot;;</span>
<a href="#l38.888"></a><span id="l38.888" class="difflineplus">+    else if (statusType == Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l38.889"></a><span id="l38.889" class="difflineplus">+      this.disconnect();</span>
<a href="#l38.890"></a><span id="l38.890" class="difflineplus">+      return;</span>
<a href="#l38.891"></a><span id="l38.891" class="difflineplus">+    }</span>
<a href="#l38.892"></a><span id="l38.892" class="difflineplus">+    let children = [];</span>
<a href="#l38.893"></a><span id="l38.893" class="difflineplus">+    if (show)</span>
<a href="#l38.894"></a><span id="l38.894" class="difflineplus">+      children.push(Stanza.node(&quot;show&quot;, null, null, show));</span>
<a href="#l38.895"></a><span id="l38.895" class="difflineplus">+    let statusText = si.statusText;</span>
<a href="#l38.896"></a><span id="l38.896" class="difflineplus">+    if (statusText)</span>
<a href="#l38.897"></a><span id="l38.897" class="difflineplus">+      children.push(Stanza.node(&quot;status&quot;, null, null, statusText));</span>
<a href="#l38.898"></a><span id="l38.898" class="difflineplus">+    if (this._idleSince) {</span>
<a href="#l38.899"></a><span id="l38.899" class="difflineplus">+      let time = Math.floor(Date.now() / 1000) - this._idleSince;</span>
<a href="#l38.900"></a><span id="l38.900" class="difflineplus">+      children.push(Stanza.node(&quot;query&quot;, Stanza.NS.last, {seconds: time}));</span>
<a href="#l38.901"></a><span id="l38.901" class="difflineplus">+    }</span>
<a href="#l38.902"></a><span id="l38.902" class="difflineplus">+    this._connection.sendStanza(Stanza.presence({&quot;xml:lang&quot;: &quot;en&quot;}, children));</span>
<a href="#l38.903"></a><span id="l38.903" class="difflineplus">+  }</span>
<a href="#l38.904"></a><span id="l38.904" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.manifest</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+component {dde786d1-6f59-43d0-9bc8-b505a757fb30} xmpp.js</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+contract @instantbird.org/purple/xmpp;1 {dde786d1-6f59-43d0-9bc8-b505a757fb30}</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+#category im-protocol-plugin prpl-jabber @instantbird.org/purple/xmpp;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/im/content/account.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/im/content/account.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -204,19 +204,17 @@ var account = {</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5">     return aOpt.getString();</span>
<a href="#l40.6"></a><span id="l40.6">   },</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8">   getListValue: function account_getListValue(aOpt) {</span>
<a href="#l40.9"></a><span id="l40.9">     if (this.prefs.prefHasUserValue(aOpt.name))</span>
<a href="#l40.10"></a><span id="l40.10">       return this.prefs.getCharPref(aOpt.name);</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-    var list = aOpt.getList().QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-    return list.hasMoreElements() &amp;&amp;</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-           list.getNext().value || &quot;&quot;;</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+    return aOpt.getListDefault();</span>
<a href="#l40.16"></a><span id="l40.16">   },</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18">   populateProtoSpecificBox: function account_populate() {</span>
<a href="#l40.19"></a><span id="l40.19">     var gbox = document.getElementById(&quot;protoSpecific&quot;);</span>
<a href="#l40.20"></a><span id="l40.20">     var id = this.proto.id;</span>
<a href="#l40.21"></a><span id="l40.21">     for (let opt in this.getProtoOptions()) {</span>
<a href="#l40.22"></a><span id="l40.22">       var text = opt.label;</span>
<a href="#l40.23"></a><span id="l40.23">       var name = id + &quot;-&quot; + opt.name;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/im/content/accountWizard.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/im/content/accountWizard.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -324,16 +324,17 @@ var accountWizard = {</span>
<a href="#l41.4"></a><span id="l41.4">         box.appendChild(this.createTextbox(&quot;number&quot;, opt.getInt(),</span>
<a href="#l41.5"></a><span id="l41.5">                                            text, name));</span>
<a href="#l41.6"></a><span id="l41.6">         break;</span>
<a href="#l41.7"></a><span id="l41.7">       case opt.typeString:</span>
<a href="#l41.8"></a><span id="l41.8">         box.appendChild(this.createTextbox(null, opt.getString(), text, name));</span>
<a href="#l41.9"></a><span id="l41.9">         break;</span>
<a href="#l41.10"></a><span id="l41.10">       case opt.typeList:</span>
<a href="#l41.11"></a><span id="l41.11">         box.appendChild(this.createMenulist(opt.getList(), text, name));</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+        document.getElementById(name).value = opt.getListDefault();</span>
<a href="#l41.13"></a><span id="l41.13">         break;</span>
<a href="#l41.14"></a><span id="l41.14">       default:</span>
<a href="#l41.15"></a><span id="l41.15">         throw &quot;unknown preference type &quot; + opt.type;</span>
<a href="#l41.16"></a><span id="l41.16">       }</span>
<a href="#l41.17"></a><span id="l41.17">       visible = true;</span>
<a href="#l41.18"></a><span id="l41.18">     }</span>
<a href="#l41.19"></a><span id="l41.19">     document.getElementById(&quot;protoSpecificGroupbox&quot;).hidden = !visible;</span>
<a href="#l41.20"></a><span id="l41.20">     if (visible) {</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineat">@@ -415,20 +416,17 @@ var accountWizard = {</span>
<a href="#l41.22"></a><span id="l41.22">         if (val != opt.getInt())</span>
<a href="#l41.23"></a><span id="l41.23">           this.prefs.push({opt: opt, name: name, value: val});</span>
<a href="#l41.24"></a><span id="l41.24">         break;</span>
<a href="#l41.25"></a><span id="l41.25">       case opt.typeString:</span>
<a href="#l41.26"></a><span id="l41.26">         if (val != opt.getString())</span>
<a href="#l41.27"></a><span id="l41.27">           this.prefs.push({opt: opt, name: name, value: val});</span>
<a href="#l41.28"></a><span id="l41.28">         break;</span>
<a href="#l41.29"></a><span id="l41.29">       case opt.typeList:</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-        var list = opt.getList().QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-        var defaultVal = list.hasMoreElements() &amp;&amp;</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineminus">-          list.getNext().value || &quot;&quot;;</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-        if (val != defaultVal)</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+        if (val != opt.getListDefault())</span>
<a href="#l41.35"></a><span id="l41.35">           this.prefs.push({opt: opt, name: name, value: val});</span>
<a href="#l41.36"></a><span id="l41.36">         break;</span>
<a href="#l41.37"></a><span id="l41.37">       default:</span>
<a href="#l41.38"></a><span id="l41.38">         throw &quot;unknown preference type &quot; + opt.type;</span>
<a href="#l41.39"></a><span id="l41.39">       }</span>
<a href="#l41.40"></a><span id="l41.40">     }</span>
<a href="#l41.41"></a><span id="l41.41"> </span>
<a href="#l41.42"></a><span id="l41.42">     for (let i = 0; i &lt; this.prefs.length; ++i) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/im/content/buddytooltip.xml</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/im/content/buddytooltip.xml</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -377,16 +377,17 @@</span>
<a href="#l42.4"></a><span id="l42.4">      &lt;method name=&quot;observe&quot;&gt;</span>
<a href="#l42.5"></a><span id="l42.5">        &lt;parameter name=&quot;aSubject&quot;/&gt;</span>
<a href="#l42.6"></a><span id="l42.6">        &lt;parameter name=&quot;aTopic&quot;/&gt;</span>
<a href="#l42.7"></a><span id="l42.7">        &lt;parameter name=&quot;aData&quot;/&gt;</span>
<a href="#l42.8"></a><span id="l42.8">        &lt;body&gt;</span>
<a href="#l42.9"></a><span id="l42.9">        &lt;![CDATA[</span>
<a href="#l42.10"></a><span id="l42.10">          if (aSubject == this.buddy &amp;&amp;</span>
<a href="#l42.11"></a><span id="l42.11">              (aTopic == &quot;account-buddy-status-changed&quot; ||</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+              aTopic == &quot;account-buddy-status-detail-changed&quot; ||</span>
<a href="#l42.13"></a><span id="l42.13">               aTopic == &quot;account-buddy-display-name-changed&quot; ||</span>
<a href="#l42.14"></a><span id="l42.14">               aTopic == &quot;account-buddy-icon-changed&quot;))</span>
<a href="#l42.15"></a><span id="l42.15">            this.updateTooltipFromBuddy(this.buddy, this.elt);</span>
<a href="#l42.16"></a><span id="l42.16">          else if (aTopic == &quot;contact-preferred-buddy-changed&quot; &amp;&amp;</span>
<a href="#l42.17"></a><span id="l42.17">                   aSubject.id == this.contact.id) {</span>
<a href="#l42.18"></a><span id="l42.18">            let buddy = this.contact.preferredBuddy;</span>
<a href="#l42.19"></a><span id="l42.19">            this.updateTooltipFromBuddy(buddy.preferredAccountBuddy, this.elt);</span>
<a href="#l42.20"></a><span id="l42.20">          }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/im/content/conversation.xml</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/im/content/conversation.xml</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -347,17 +347,17 @@</span>
<a href="#l43.4"></a><span id="l43.4">               style = styleProperties.join(&quot;; &quot;);</span>
<a href="#l43.5"></a><span id="l43.5">               if (style)</span>
<a href="#l43.6"></a><span id="l43.6">                 msg = &quot;&lt;span style=\&quot;&quot; + style + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l43.7"></a><span id="l43.7">             }</span>
<a href="#l43.8"></a><span id="l43.8">           }</span>
<a href="#l43.9"></a><span id="l43.9">           this._conv.sendMsg(msg);</span>
<a href="#l43.10"></a><span id="l43.10">         }</span>
<a href="#l43.11"></a><span id="l43.11">         else</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-          this._conv.sendMsg(msg);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+          this._conv.sendMsg(account.HTMLEscapePlainText ? msg : aMsg);</span>
<a href="#l43.14"></a><span id="l43.14">         // reset the textbox to its original size</span>
<a href="#l43.15"></a><span id="l43.15">         this.resetInput();</span>
<a href="#l43.16"></a><span id="l43.16">       ]]&gt;</span>
<a href="#l43.17"></a><span id="l43.17">       &lt;/body&gt;</span>
<a href="#l43.18"></a><span id="l43.18">      &lt;/method&gt;</span>
<a href="#l43.19"></a><span id="l43.19"> </span>
<a href="#l43.20"></a><span id="l43.20">      &lt;method name=&quot;_onSplitterChange&quot;&gt;</span>
<a href="#l43.21"></a><span id="l43.21">       &lt;parameter name=&quot;aEvent&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/im/content/joinchat.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/im/content/joinchat.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -66,19 +66,19 @@ var joinChat = {</span>
<a href="#l44.4"></a><span id="l44.4">     let acc = document.getElementById(&quot;accountlist&quot;).selectedItem.account;</span>
<a href="#l44.5"></a><span id="l44.5">     let sep = document.getElementById(&quot;separatorRow2&quot;);</span>
<a href="#l44.6"></a><span id="l44.6">     let defaultValues = acc.getChatRoomDefaultFieldValues();</span>
<a href="#l44.7"></a><span id="l44.7">     joinChat._values = defaultValues;</span>
<a href="#l44.8"></a><span id="l44.8">     joinChat._fields = [];</span>
<a href="#l44.9"></a><span id="l44.9">     joinChat._account = acc;</span>
<a href="#l44.10"></a><span id="l44.10"> </span>
<a href="#l44.11"></a><span id="l44.11">     let protoId = acc.protocol.id;</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    document.getElementById(&quot;autojoin&quot;).visible = </span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-      protoId == &quot;prpl-irc&quot; || protoId == &quot;prpl-jabber&quot; ||</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-      protoId == &quot;prpl-gtalk&quot;;</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+    document.getElementById(&quot;autojoin&quot;).hidden =</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+      !(protoId == &quot;prpl-irc&quot; || protoId == &quot;prpl-jabber&quot; ||</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+      protoId == &quot;prpl-gtalk&quot;);</span>
<a href="#l44.18"></a><span id="l44.18"> </span>
<a href="#l44.19"></a><span id="l44.19">     for (let field in getIter(acc.getChatRoomFields())) {</span>
<a href="#l44.20"></a><span id="l44.20">       let row = document.createElement(&quot;row&quot;);</span>
<a href="#l44.21"></a><span id="l44.21"> </span>
<a href="#l44.22"></a><span id="l44.22">       let label = document.createElement(&quot;label&quot;);</span>
<a href="#l44.23"></a><span id="l44.23">       let text = field.label;</span>
<a href="#l44.24"></a><span id="l44.24">       let match = /_(.)/.exec(text);</span>
<a href="#l44.25"></a><span id="l44.25">       if (match) {</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineat">@@ -148,17 +148,19 @@ var joinChat = {</span>
<a href="#l44.27"></a><span id="l44.27"> </span>
<a href="#l44.28"></a><span id="l44.28">     let conv = Services.conversations.getConversationByNameAndAccount(name,</span>
<a href="#l44.29"></a><span id="l44.29">                                                                       account,</span>
<a href="#l44.30"></a><span id="l44.30">                                                                       true);</span>
<a href="#l44.31"></a><span id="l44.31">     if (conv)</span>
<a href="#l44.32"></a><span id="l44.32">       Conversations.focusConversation(conv);</span>
<a href="#l44.33"></a><span id="l44.33"> </span>
<a href="#l44.34"></a><span id="l44.34">     if (document.getElementById(&quot;autojoin&quot;).checked) {</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-      if (protoId != &quot;prpl-irc&quot;)</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+      if (protoId == &quot;prpl-gtalk&quot;)</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineplus">+        name += &quot;/&quot; + values.getValue(&quot;nick&quot;);</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+      else if (protoId != &quot;prpl-irc&quot;)</span>
<a href="#l44.39"></a><span id="l44.39">         name += &quot;/&quot; + values.getValue(&quot;handle&quot;);</span>
<a href="#l44.40"></a><span id="l44.40"> </span>
<a href="#l44.41"></a><span id="l44.41">       let prefBranch =</span>
<a href="#l44.42"></a><span id="l44.42">         Services.prefs.getBranch(&quot;messenger.account.&quot; + account.id + &quot;.&quot;);</span>
<a href="#l44.43"></a><span id="l44.43">       let autojoin = [ ];</span>
<a href="#l44.44"></a><span id="l44.44">       if (prefBranch.prefHasUserValue(autoJoinPref)) {</span>
<a href="#l44.45"></a><span id="l44.45">         let prefValue = prefBranch.getCharPref(autoJoinPref);</span>
<a href="#l44.46"></a><span id="l44.46">         if (prefValue)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/im/installer/package-manifest.in</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/im/installer/package-manifest.in</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -423,21 +423,24 @@</span>
<a href="#l45.4"></a><span id="l45.4"> @BINPATH@/components/profileMigrator.manifest</span>
<a href="#l45.5"></a><span id="l45.5"> #endif</span>
<a href="#l45.6"></a><span id="l45.6"> @BINPATH@/components/contentHandler.js</span>
<a href="#l45.7"></a><span id="l45.7"> @BINPATH@/components/contentHandler.manifest</span>
<a href="#l45.8"></a><span id="l45.8"> @BINPATH@/components/ibCommandLineHandler.js</span>
<a href="#l45.9"></a><span id="l45.9"> @BINPATH@/components/ibCommandLineHandler.manifest</span>
<a href="#l45.10"></a><span id="l45.10"> @BINPATH@/components/ibStatusCommandLineHandler.js</span>
<a href="#l45.11"></a><span id="l45.11"> @BINPATH@/components/ibStatusCommandLineHandler.manifest</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-@BINPATH@/components/facebookOverrideProtocol.js</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-@BINPATH@/components/gtalkOverrideProtocol.js</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-@BINPATH@/components/overrideProtocols.manifest</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+@BINPATH@/components/facebook.js</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineplus">+@BINPATH@/components/facebook.manifest</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+@BINPATH@/components/gtalk.js</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+@BINPATH@/components/gtalk.manifest</span>
<a href="#l45.19"></a><span id="l45.19"> @BINPATH@/components/twitter.js</span>
<a href="#l45.20"></a><span id="l45.20"> @BINPATH@/components/twitter.manifest</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+@BINPATH@/components/xmpp.js</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineplus">+@BINPATH@/components/xmpp.manifest</span>
<a href="#l45.23"></a><span id="l45.23"> @BINPATH@/components/smileProtocolHandler.js</span>
<a href="#l45.24"></a><span id="l45.24"> @BINPATH@/components/smileProtocolHandler.manifest</span>
<a href="#l45.25"></a><span id="l45.25"> @BINPATH@/components/logger.js</span>
<a href="#l45.26"></a><span id="l45.26"> @BINPATH@/components/logger.manifest</span>
<a href="#l45.27"></a><span id="l45.27"> </span>
<a href="#l45.28"></a><span id="l45.28"> ; [Default Preferences]</span>
<a href="#l45.29"></a><span id="l45.29"> ; All the pref files must be part of base to prevent migration bugs</span>
<a href="#l45.30"></a><span id="l45.30"> @BINPATH@/@PREF_DIR@/all-instantbird.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/purple/purplexpcom/public/purpleIPref.idl</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/purple/purplexpcom/public/purpleIPref.idl</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -54,15 +54,16 @@ interface purpleIPref: nsISupports {</span>
<a href="#l46.4"></a><span id="l46.4">   readonly attribute short type;</span>
<a href="#l46.5"></a><span id="l46.5">   readonly attribute boolean masked;</span>
<a href="#l46.6"></a><span id="l46.6"> </span>
<a href="#l46.7"></a><span id="l46.7">   boolean     getBool();</span>
<a href="#l46.8"></a><span id="l46.8">   long        getInt();</span>
<a href="#l46.9"></a><span id="l46.9">   AUTF8String getString();</span>
<a href="#l46.10"></a><span id="l46.10">   // enumerator of purpleIKeyValuePair</span>
<a href="#l46.11"></a><span id="l46.11">   nsISimpleEnumerator getList();</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+  AUTF8String getListDefault();</span>
<a href="#l46.13"></a><span id="l46.13"> };</span>
<a href="#l46.14"></a><span id="l46.14"> </span>
<a href="#l46.15"></a><span id="l46.15"> [scriptable, uuid(8fc16882-ba8e-432a-999f-0d4dc104234b)]</span>
<a href="#l46.16"></a><span id="l46.16"> interface purpleIKeyValuePair: nsISupports {</span>
<a href="#l46.17"></a><span id="l46.17">   readonly attribute AUTF8String name;</span>
<a href="#l46.18"></a><span id="l46.18">   readonly attribute AUTF8String value;</span>
<a href="#l46.19"></a><span id="l46.19"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

