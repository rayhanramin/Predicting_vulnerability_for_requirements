<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18241:c06a2023ecf3d130de6a3f1768336bde4ab75ff2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c06a2023ecf3d130de6a3f1768336bde4ab75ff2" />
<meta property="og:url" content="/comm-central/rev/c06a2023ecf3d130de6a3f1768336bde4ab75ff2" />
<meta property="og:description" content="Bug 1171691 - Implement requestBuddyInfo for JS-XMPP. r=aleth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c06a2023ecf3d130de6a3f1768336bde4ab75ff2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c06a2023ecf3d130de6a3f1768336bde4ab75ff2">shortlog</a> |
<a href="/comm-central/log/c06a2023ecf3d130de6a3f1768336bde4ab75ff2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c06a2023ecf3d130de6a3f1768336bde4ab75ff2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c06a2023ecf3d130de6a3f1768336bde4ab75ff2">files</a> |
changeset |
<a href="/comm-central/raw-rev/c06a2023ecf3d130de6a3f1768336bde4ab75ff2">raw</a>  | <a href="/comm-central/archive/c06a2023ecf3d130de6a3f1768336bde4ab75ff2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171691">Bug 1171691</a> - Implement requestBuddyInfo for JS-XMPP. r=aleth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#98;&#100;&#101;&#108;&#114;&#104;&#109;&#97;&#110;&#32;&#65;&#104;&#109;&#101;&#100;&#32;&#60;&#97;&#46;&#97;&#104;&#109;&#101;&#100;&#49;&#48;&#50;&#54;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 10 Aug 2015 07:12:00 +0200</td></tr>

<tr>
 <td>changeset 18241</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c06a2023ecf3d130de6a3f1768336bde4ab75ff2">c06a2023ecf3d130de6a3f1768336bde4ab75ff2</a></td>
</tr>



<tr>
<td>parent 18240</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1bd91d73c2e581c5cd4f2506c3d5540cfc77ba13">1bd91d73c2e581c5cd4f2506c3d5540cfc77ba13</a>
</td>
</tr>

<tr>
<td>child 18242</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2a346480be3947faa5b50f66e6513f04359d3276">2a346480be3947faa5b50f66e6513f04359d3276</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c06a2023ecf3d130de6a3f1768336bde4ab75ff2">11200</a></td></tr>
<tr><td>push user</td><td>aleth@instantbird.org</td></tr>
<tr><td>push date</td><td class="date age">Mon, 10 Aug 2015 20:45:40 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0343aadfcfbc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0343aadfcfbc44e9967da869573caf04a4cf5c6e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0343aadfcfbc44e9967da869573caf04a4cf5c6e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0343aadfcfbc44e9967da869573caf04a4cf5c6e&newProject=comm-central&newRevision=c06a2023ecf3d130de6a3f1768336bde4ab75ff2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0343aadfcfbc44e9967da869573caf04a4cf5c6e&newProject=comm-central&newRevision=c06a2023ecf3d130de6a3f1768336bde4ab75ff2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0343aadfcfbc44e9967da869573caf04a4cf5c6e&newProject=comm-central&newRevision=c06a2023ecf3d130de6a3f1768336bde4ab75ff2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171691">1171691</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1171691">Bug 1171691</a> - Implement requestBuddyInfo for JS-XMPP. r=aleth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/content/imtooltip.xml">chat/content/imtooltip.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/content/imtooltip.xml">file</a> |
<a href="/comm-central/annotate/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/content/imtooltip.xml">annotate</a> |
<a href="/comm-central/diff/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/content/imtooltip.xml">diff</a> |
<a href="/comm-central/comparison/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/content/imtooltip.xml">comparison</a> |
<a href="/comm-central/log/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/content/imtooltip.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/locales/en-US/xmpp.properties">chat/locales/en-US/xmpp.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/locales/en-US/xmpp.properties">file</a> |
<a href="/comm-central/annotate/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/locales/en-US/xmpp.properties">annotate</a> |
<a href="/comm-central/diff/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/locales/en-US/xmpp.properties">diff</a> |
<a href="/comm-central/comparison/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/locales/en-US/xmpp.properties">comparison</a> |
<a href="/comm-central/log/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/locales/en-US/xmpp.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/c06a2023ecf3d130de6a3f1768336bde4ab75ff2/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/content/imtooltip.xml</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/content/imtooltip.xml</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -218,21 +218,24 @@</span>
<a href="#l1.4"></a><span id="l1.4">          this.setAttribute(&quot;status&quot;, Status.toAttribute(statusType));</span>
<a href="#l1.5"></a><span id="l1.5">          this.setMessage(Status.toLabel(statusType, aBuddy.statusText));</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">          if (displayName != name)</span>
<a href="#l1.8"></a><span id="l1.8">            this.addRow(this.bundle.GetStringFromName(&quot;buddy.username&quot;), name);</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">          this.addRow(this.bundle.GetStringFromName(&quot;buddy.account&quot;), account.name);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-         // Technically there is no reason to restrict this to JS-IRC. But</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-         // there is currently no filtering mechanism in place to select which</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-         // of the returned fields are to be added to the tooltip for the other</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+         // Technically there is no reason to restrict this. But there is</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+         // currently no filtering mechanism in place to select which of the</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+         // returned fields are to be added to the tooltip for the other</span>
<a href="#l1.18"></a><span id="l1.18">          // protocols (libpurple in particular).</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-         if (account.protocol.id == &quot;prpl-irc&quot;)</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+         let forcePurple = Services.prefs.getCharPref(&quot;chat.prpls.forcePurple&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+         let protocolId = account.protocol.id;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+         if (protocolId == &quot;prpl-irc&quot; ||</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+             (!forcePurple.includes(&quot;prpl-jabber&quot;) &amp;&amp; protocolId == &quot;prpl-jabber&quot;))</span>
<a href="#l1.24"></a><span id="l1.24">            this.requestBuddyInfo(account, aBuddy.normalizedName);</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">          var tooltipInfo = aBuddy.getTooltipInfo();</span>
<a href="#l1.27"></a><span id="l1.27">          if (tooltipInfo)</span>
<a href="#l1.28"></a><span id="l1.28">            this.appendTooltipInfo(tooltipInfo);</span>
<a href="#l1.29"></a><span id="l1.29">          return true;</span>
<a href="#l1.30"></a><span id="l1.30">        ]]&gt;</span>
<a href="#l1.31"></a><span id="l1.31">        &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/locales/en-US/xmpp.properties</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/locales/en-US/xmpp.properties</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -72,16 +72,25 @@ conversation.error.unknownError=Unknown </span>
<a href="#l2.4"></a><span id="l2.4"> # LOCALIZATION NOTE (tooltip.*):</span>
<a href="#l2.5"></a><span id="l2.5"> #   These are the titles of lines of information that will appear in</span>
<a href="#l2.6"></a><span id="l2.6"> #   the tooltip showing details about a contact or conversation.</span>
<a href="#l2.7"></a><span id="l2.7"> # LOCALIZATION NOTE (tooltip.status):</span>
<a href="#l2.8"></a><span id="l2.8"> #   %S will be replaced by the XMPP resource identifier</span>
<a href="#l2.9"></a><span id="l2.9"> tooltip.status=Status (%S)</span>
<a href="#l2.10"></a><span id="l2.10"> tooltip.statusNoResource=Status</span>
<a href="#l2.11"></a><span id="l2.11"> tooltip.subscription=Subscription</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+tooltip.fullName=Full Name</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+tooltip.nickname=Nickname</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+tooltip.email=Email</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+tooltip.birthday=Birthday</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+tooltip.userName=Username</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+tooltip.title=Title</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+tooltip.organization=Organization</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+tooltip.locality=Locality</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+tooltip.country=Country</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> # LOCALIZATION NOTE (chatRoomField.*):</span>
<a href="#l2.23"></a><span id="l2.23"> #   These are the name of fields displayed in the 'Join Chat' dialog</span>
<a href="#l2.24"></a><span id="l2.24"> #   for XMPP accounts.</span>
<a href="#l2.25"></a><span id="l2.25"> #   The _ character won't be displayed; it indicates the next</span>
<a href="#l2.26"></a><span id="l2.26"> #   character of the string should be used as the access key for this</span>
<a href="#l2.27"></a><span id="l2.27"> #   field.</span>
<a href="#l2.28"></a><span id="l2.28"> chatRoomField.room=_Room</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -37,53 +37,112 @@ XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, f</span>
<a href="#l3.4"></a><span id="l3.4">   l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l3.5"></a><span id="l3.5"> );</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l3.8"></a><span id="l3.8">   let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l3.9"></a><span id="l3.9">   return function(aTxt) cs.scanTXT(aTxt, cs.kEntities);</span>
<a href="#l3.10"></a><span id="l3.10"> });</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+// Parses the status from a presence stanza into an object of statusType,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+// statusText and idleSince.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+function parseStatus(aStanza) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  if (show) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    show = show.innerText;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    if (show == &quot;away&quot;)</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    else if (show == &quot;chat&quot;)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; //FIXME</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    else if (show == &quot;dnd&quot;)</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_UNAVAILABLE;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    else if (show == &quot;xa&quot;)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  }</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  let idleSince = 0;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  if (query &amp;&amp; query.uri == Stanza.NS.last) {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+    let now = Math.floor(Date.now() / 1000);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    idleSince = now - parseInt(query.attributes[&quot;seconds&quot;], 10);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+    statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  }</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  // Mark official Android clients as mobile.</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  const kAndroidNodeURI = &quot;http://www.android.com/gtalk/client/caps&quot;;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  if (aStanza.getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+             .some(function(s) s.localName == &quot;c&quot; &amp;&amp;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+                               s.attributes[&quot;node&quot;] == kAndroidNodeURI))</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    statusType = Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  status = status ? status.innerText : &quot;&quot;;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  return {statusType: statusType, statusText: status, idleSince: idleSince};</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+};</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+</span>
<a href="#l3.50"></a><span id="l3.50"> /* This is an ordered list, used to determine chat buddy flags:</span>
<a href="#l3.51"></a><span id="l3.51">  *  index &lt; member    -&gt; noFlags</span>
<a href="#l3.52"></a><span id="l3.52">  *  index = member    -&gt; voiced</span>
<a href="#l3.53"></a><span id="l3.53">  *          moderator -&gt; halfOp</span>
<a href="#l3.54"></a><span id="l3.54">  *          admin     -&gt; op</span>
<a href="#l3.55"></a><span id="l3.55">  *          owner     -&gt; founder</span>
<a href="#l3.56"></a><span id="l3.56">  */</span>
<a href="#l3.57"></a><span id="l3.57"> const kRoles = [&quot;outcast&quot;, &quot;visitor&quot;, &quot;participant&quot;, &quot;member&quot;, &quot;moderator&quot;,</span>
<a href="#l3.58"></a><span id="l3.58">                 &quot;admin&quot;, &quot;owner&quot;];</span>
<a href="#l3.59"></a><span id="l3.59"> </span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-function MUCParticipant(aNick, aName, aStanza)</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+function MUCParticipant(aNick, aJid, aPresenceStanza)</span>
<a href="#l3.62"></a><span id="l3.62"> {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  this._jid = aName;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+  this._jid = aJid;</span>
<a href="#l3.65"></a><span id="l3.65">   this.name = aNick;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-  this.stanza = aStanza;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  this.onPresenceStanza(aPresenceStanza);</span>
<a href="#l3.68"></a><span id="l3.68"> }</span>
<a href="#l3.69"></a><span id="l3.69"> MUCParticipant.prototype = {</span>
<a href="#l3.70"></a><span id="l3.70">   __proto__: ClassInfo(&quot;prplIConvChatBuddy&quot;, &quot;XMPP ConvChatBuddy object&quot;),</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">   buddy: false,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  // The occupant jid of the participant which is of the form room@domain/nick.</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  _jid: null,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  // The real jid of the participant which is of the form local@domain/resource.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  accountJid: null,</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+  statusType: null,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  statusText: null,</span>
<a href="#l3.82"></a><span id="l3.82">   get alias() this.name,</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84">   role: 2, // &quot;participant&quot; by default</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  set stanza(aStanza) {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    this._stanza = aStanza;</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    let x =</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-      aStanza.getChildren(&quot;x&quot;).filter(function (c) c.uri == Stanza.NS.muc_user);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  // Called when a presence stanza is received for this participant.</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  onPresenceStanza: function(aStanza) {</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    let statusInfo = parseStatus(aStanza);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+    this.statusType = statusInfo.statusType;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    this.statusText = statusInfo.statusText;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    let x = aStanza.children.filter(child =&gt; child.localName == &quot;x&quot; &amp;&amp;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+                                             child.uri == Stanza.NS.muc_user);</span>
<a href="#l3.98"></a><span id="l3.98">     if (x.length == 0)</span>
<a href="#l3.99"></a><span id="l3.99">       return;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+    // XEP-0045 (7.2.3): We only expect a single &lt;x/&gt; element of this namespace,</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+    // so we ignore any others.</span>
<a href="#l3.103"></a><span id="l3.103">     x = x[0];</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+</span>
<a href="#l3.105"></a><span id="l3.105">     let item = x.getElement([&quot;item&quot;]);</span>
<a href="#l3.106"></a><span id="l3.106">     if (!item)</span>
<a href="#l3.107"></a><span id="l3.107">       return;</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">     this.role = Math.max(kRoles.indexOf(item.attributes[&quot;role&quot;]),</span>
<a href="#l3.110"></a><span id="l3.110">                          kRoles.indexOf(item.attributes[&quot;affiliation&quot;]));</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+    let accountJid = item.attributes[&quot;jid&quot;];</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    if (accountJid)</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+      this.accountJid = accountJid;</span>
<a href="#l3.115"></a><span id="l3.115">   },</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">   get noFlags() this.role &lt; kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l3.118"></a><span id="l3.118">   get voiced() this.role == kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l3.119"></a><span id="l3.119">   get halfOp() this.role == kRoles.indexOf(&quot;moderator&quot;),</span>
<a href="#l3.120"></a><span id="l3.120">   get op() this.role == kRoles.indexOf(&quot;admin&quot;),</span>
<a href="#l3.121"></a><span id="l3.121">   get founder() this.role == kRoles.indexOf(&quot;owner&quot;),</span>
<a href="#l3.122"></a><span id="l3.122">   typing: false</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineat">@@ -253,17 +312,17 @@ const XMPPMUCConversationPrototype = {</span>
<a href="#l3.124"></a><span id="l3.124"> </span>
<a href="#l3.125"></a><span id="l3.125">     if (!this._participants.get(nick)) {</span>
<a href="#l3.126"></a><span id="l3.126">       let participant = new MUCParticipant(nick, from, aStanza);</span>
<a href="#l3.127"></a><span id="l3.127">       this._participants.set(nick, participant);</span>
<a href="#l3.128"></a><span id="l3.128">       this.notifyObservers(new nsSimpleEnumerator([participant]),</span>
<a href="#l3.129"></a><span id="l3.129">                            &quot;chat-buddy-add&quot;);</span>
<a href="#l3.130"></a><span id="l3.130">     }</span>
<a href="#l3.131"></a><span id="l3.131">     else {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      this._participants.get(nick).stanza = aStanza;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+      this._participants.get(nick).onPresenceStanza(aStanza);</span>
<a href="#l3.134"></a><span id="l3.134">       this.notifyObservers(this._participants.get(nick), &quot;chat-buddy-update&quot;);</span>
<a href="#l3.135"></a><span id="l3.135">     }</span>
<a href="#l3.136"></a><span id="l3.136">   },</span>
<a href="#l3.137"></a><span id="l3.137"> </span>
<a href="#l3.138"></a><span id="l3.138">   /* Called by the account when a messsage is received for this muc */</span>
<a href="#l3.139"></a><span id="l3.139">   incomingMessage: function(aMsg, aStanza, aDate) {</span>
<a href="#l3.140"></a><span id="l3.140">     let from = this._account._parseJID(aStanza.attributes[&quot;from&quot;]).resource;</span>
<a href="#l3.141"></a><span id="l3.141">     let id = aStanza.attributes[&quot;id&quot;];</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineat">@@ -755,57 +814,26 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l3.143"></a><span id="l3.143">     if (type == &quot;unavailable&quot; || type == &quot;error&quot;) {</span>
<a href="#l3.144"></a><span id="l3.144">       if (!this._resources || !(resource in this._resources))</span>
<a href="#l3.145"></a><span id="l3.145">         return; // ignore for already offline resources.</span>
<a href="#l3.146"></a><span id="l3.146">       delete this._resources[resource];</span>
<a href="#l3.147"></a><span id="l3.147">       if (preferred == resource)</span>
<a href="#l3.148"></a><span id="l3.148">         preferred = undefined;</span>
<a href="#l3.149"></a><span id="l3.149">     }</span>
<a href="#l3.150"></a><span id="l3.150">     else {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-      let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-      let show = aStanza.getElement([&quot;show&quot;]);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-      if (show) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-        show = show.innerText;</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-        if (show == &quot;away&quot;)</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-          statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-        else if (show == &quot;chat&quot;)</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-          statusType = Ci.imIStatusInfo.STATUS_AVAILABLE; //FIXME</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-        else if (show == &quot;dnd&quot;)</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-          statusType = Ci.imIStatusInfo.STATUS_UNAVAILABLE;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-        else if (show == &quot;xa&quot;)</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-          statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-      }</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-      let idleSince = 0;</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-      let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-      if (query &amp;&amp; query.uri == Stanza.NS.last) {</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-        let now = Math.floor(Date.now() / 1000);</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-        idleSince = now - parseInt(query.attributes[&quot;seconds&quot;], 10);</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-        statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-      }</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-      // Mark official Android clients as mobile.</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-      const kAndroidNodeURI = &quot;http://www.android.com/gtalk/client/caps&quot;;</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-      if (aStanza.getChildrenByNS(Stanza.NS.caps)</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-                 .some(function(s) s.localName == &quot;c&quot; &amp;&amp;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-                                   s.attributes[&quot;node&quot;] == kAndroidNodeURI))</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-        statusType = Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-      let status = aStanza.getElement([&quot;status&quot;]);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-      status = status ? status.innerText : &quot;&quot;;</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+      let statusInfo = parseStatus(aStanza);</span>
<a href="#l3.184"></a><span id="l3.184">       let priority = aStanza.getElement([&quot;priority&quot;]);</span>
<a href="#l3.185"></a><span id="l3.185">       priority = priority ? parseInt(priority.innerText, 10) : 0;</span>
<a href="#l3.186"></a><span id="l3.186"> </span>
<a href="#l3.187"></a><span id="l3.187">       if (!this._resources)</span>
<a href="#l3.188"></a><span id="l3.188">         this._resources = {};</span>
<a href="#l3.189"></a><span id="l3.189">       this._resources[resource] = {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-        statusType: statusType,</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-        statusText: status,</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-        idleSince: idleSince,</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+        statusType: statusInfo.statusType,</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+        statusText: statusInfo.statusText,</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+        idleSince: statusInfo.idleSince,</span>
<a href="#l3.196"></a><span id="l3.196">         priority: priority,</span>
<a href="#l3.197"></a><span id="l3.197">         stanza: aStanza</span>
<a href="#l3.198"></a><span id="l3.198">       };</span>
<a href="#l3.199"></a><span id="l3.199">     }</span>
<a href="#l3.200"></a><span id="l3.200"> </span>
<a href="#l3.201"></a><span id="l3.201">     let photo = aStanza.getElement([&quot;x&quot;, &quot;photo&quot;]);</span>
<a href="#l3.202"></a><span id="l3.202">     if (photo &amp;&amp; photo.uri == Stanza.NS.vcard_update) {</span>
<a href="#l3.203"></a><span id="l3.203">       let hash = photo.innerText;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineat">@@ -1080,16 +1108,115 @@ const XMPPAccountPrototype = {</span>
<a href="#l3.205"></a><span id="l3.205">   replyToBuddyRequest: function(aReply, aRequest) {</span>
<a href="#l3.206"></a><span id="l3.206">     if (!this._connection)</span>
<a href="#l3.207"></a><span id="l3.207">       return;</span>
<a href="#l3.208"></a><span id="l3.208">     let s = Stanza.presence({to: aRequest.userName, type: aReply})</span>
<a href="#l3.209"></a><span id="l3.209">     this.sendStanza(s);</span>
<a href="#l3.210"></a><span id="l3.210">     this.removeBuddyRequest(aRequest);</span>
<a href="#l3.211"></a><span id="l3.211">   },</span>
<a href="#l3.212"></a><span id="l3.212"> </span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  requestBuddyInfo: function(aJid) {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+    if (!this.connected) {</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+      Services.obs.notifyObservers(EmptyEnumerator, &quot;user-info-received&quot;, aJid);</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+      return;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+    }</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+    let userName;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    let tooltipInfo = [];</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+    let jid = this._parseJID(aJid);</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+    let muc = this._mucs.get(jid.node + &quot;@&quot; + jid.domain);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+    if (muc) {</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+      let participant = muc._participants.get(jid.resource);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+      if (participant) {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+        if (participant.accountJid)</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+          userName = participant.accountJid;</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+        if (!muc.left) {</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+          let statusType = participant.statusType;</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+          let statusText = participant.statusText;</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+          tooltipInfo.push(new TooltipInfo(statusType, statusText, true));</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+        }</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+      }</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    }</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+    let iq = Stanza.iq(&quot;get&quot;, null, aJid, Stanza.node(&quot;vCard&quot;, Stanza.NS.vcard));</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+    this.sendStanza(iq, aStanza =&gt; {</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+      let vCardInfo = {};</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+      let vCardNode = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+      // In the case of an error response, we just notify the observers with</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      // what info we already have.</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      if (aStanza.attributes[&quot;type&quot;] == &quot;result&quot; &amp;&amp; vCardNode)</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+        vCardInfo = this.parseVCard(vCardNode);</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+      // The real jid of participant which is of the form local@domain/resource.</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+      // We consider the jid is provided by server is more correct than jid is</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+      // set by the user.</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+      if (userName)</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+        vCardInfo.userName = userName;</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+      // vCard fields we want to display in the tooltip.</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+      const kTooltipFields = [&quot;userName&quot;, &quot;fullName&quot;, &quot;nickname&quot;, &quot;title&quot;,</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+                              &quot;organization&quot;, &quot;email&quot;, &quot;birthday&quot;, &quot;locality&quot;,</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+                              &quot;country&quot;];</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+      for (let field of kTooltipFields) {</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+        if (vCardInfo.hasOwnProperty(field))</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+          tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), vCardInfo[field]));</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+      }</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+      Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+                                   &quot;user-info-received&quot;, aJid);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+    });</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  },</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  // Parses the vCard into the properties of the returned object.</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  parseVCard: function(aVCardNode) {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+    // XEP-0054: vcard-temp.</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+    let aResult = {};</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+    for (let node of aVCardNode.children.filter(child =&gt; child.type == &quot;node&quot;)) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+      let localName = node.localName;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+      let innerText = node.innerText;</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+      if (innerText) {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+        if (localName == &quot;FN&quot;)</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+          aResult.fullName = innerText;</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+        else if (localName == &quot;NICKNAME&quot;)</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+          aResult.nickname = innerText;</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+        else if (localName == &quot;TITLE&quot;)</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+          aResult.title = innerText;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+        else if (localName == &quot;BDAY&quot;)</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+          aResult.birthday = innerText;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+        else if (localName == &quot;JABBERID&quot;)</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+          aResult.userName = innerText;</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+      }</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+      if (localName == &quot;ORG&quot;) {</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+        let organization = node.getElement([&quot;ORGNAME&quot;]);</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+        if (organization &amp;&amp; organization.innerText)</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+          aResult.organization = organization.innerText;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+      }</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+      else if (localName == &quot;EMAIL&quot;) {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+        let userID = node.getElement([&quot;USERID&quot;]);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+        if (userID &amp;&amp; userID.innerText)</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+          aResult.email = userID.innerText;</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+      }</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+      else if (localName == &quot;ADR&quot;) {</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+        let locality = node.getElement([&quot;LOCALITY&quot;]);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+        if (locality &amp;&amp; locality.innerText)</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+          aResult.locality = locality.innerText;</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+        let country = node.getElement([&quot;CTRY&quot;]);</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+        if (country &amp;&amp; country.innerText)</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+          aResult.country = country.innerText;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+      }</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+      else if (localName == &quot;PHOTO&quot;)</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+        aResult.photo = node;</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+      // TODO: Parse the other fields of vCard and display it in system messages</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+      // in response to /whois.</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+    }</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+    return aResult;</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+  },</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+</span>
<a href="#l3.312"></a><span id="l3.312">   // Returns undefined if not an error stanza, and an object</span>
<a href="#l3.313"></a><span id="l3.313">   // describing the error otherwise:</span>
<a href="#l3.314"></a><span id="l3.314">   parseError(aStanza) {</span>
<a href="#l3.315"></a><span id="l3.315">     if (aStanza.attributes[&quot;type&quot;] != &quot;error&quot;)</span>
<a href="#l3.316"></a><span id="l3.316">       return undefined;</span>
<a href="#l3.317"></a><span id="l3.317"> </span>
<a href="#l3.318"></a><span id="l3.318">     let retval = {stanza: aStanza};</span>
<a href="#l3.319"></a><span id="l3.319">     let error = aStanza.getElement([&quot;error&quot;]);</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineat">@@ -1508,26 +1635,23 @@ const XMPPAccountPrototype = {</span>
<a href="#l3.321"></a><span id="l3.321">       return;</span>
<a href="#l3.322"></a><span id="l3.322">     let buddy = this._buddies.get(jid);</span>
<a href="#l3.323"></a><span id="l3.323"> </span>
<a href="#l3.324"></a><span id="l3.324">     let vCard = aStanza.getElement([&quot;vCard&quot;]);</span>
<a href="#l3.325"></a><span id="l3.325">     if (!vCard)</span>
<a href="#l3.326"></a><span id="l3.326">       return;</span>
<a href="#l3.327"></a><span id="l3.327"> </span>
<a href="#l3.328"></a><span id="l3.328">     let foundFormattedName = false;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-    for each (let c in vCard.children) {</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-      if (c.type != &quot;node&quot;)</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-        continue;</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-      if (c.localName == &quot;FN&quot;) {</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-        buddy.vCardFormattedName = c.innerText;</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-        foundFormattedName = true;</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-      }</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-      if (c.localName == &quot;PHOTO&quot;)</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-        buddy._saveIcon(c);</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+    let vCardInfo = this.parseVCard(vCard);</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+    if (vCardInfo.fullName) {</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+      buddy.vCardFormattedName = vCardInfo.fullName;</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+      foundFormattedName = true;</span>
<a href="#l3.342"></a><span id="l3.342">     }</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+    if (vCardInfo.photo)</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+      buddy._saveIcon(vCardInfo.photo);</span>
<a href="#l3.345"></a><span id="l3.345">     if (!foundFormattedName &amp;&amp; buddy._vCardFormattedName)</span>
<a href="#l3.346"></a><span id="l3.346">       buddy.vCardFormattedName = &quot;&quot;;</span>
<a href="#l3.347"></a><span id="l3.347">     buddy._vCardReceived = true;</span>
<a href="#l3.348"></a><span id="l3.348">   },</span>
<a href="#l3.349"></a><span id="l3.349"> </span>
<a href="#l3.350"></a><span id="l3.350">   // XEP-0029 (Section 2) and RFC 6122 (Section 2): The node and domain are</span>
<a href="#l3.351"></a><span id="l3.351">   // lowercase, while resources are case sensitive and can contain spaces.</span>
<a href="#l3.352"></a><span id="l3.352">   normalizeFullJid: function(aJID) this._parseJID(aJID.trim()).jid,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

