<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 793:67040cc96e525c09df10aea6ad007b26f6925936</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 67040cc96e525c09df10aea6ad007b26f6925936" />
<meta property="og:url" content="/comm-central/rev/67040cc96e525c09df10aea6ad007b26f6925936" />
<meta property="og:description" content="Fix bug 461166 - e4x parser borks on surrounding white spaces and certain response elements. r=dbo" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 67040cc96e525c09df10aea6ad007b26f6925936 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/67040cc96e525c09df10aea6ad007b26f6925936">shortlog</a> |
<a href="/comm-central/log/67040cc96e525c09df10aea6ad007b26f6925936">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/67040cc96e525c09df10aea6ad007b26f6925936">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/67040cc96e525c09df10aea6ad007b26f6925936">files</a> |
changeset |
<a href="/comm-central/raw-rev/67040cc96e525c09df10aea6ad007b26f6925936">raw</a>  | <a href="/comm-central/archive/67040cc96e525c09df10aea6ad007b26f6925936.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=461166">bug 461166</a> - e4x parser borks on surrounding white spaces and certain response elements. r=dbo
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 02 Nov 2008 19:33:12 +0100</td></tr>

<tr>
 <td>changeset 793</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/67040cc96e525c09df10aea6ad007b26f6925936">67040cc96e525c09df10aea6ad007b26f6925936</a></td>
</tr>



<tr>
<td>parent 792</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f6aeb77d722f8652e82facb0c77d4f7cba1e43da">f6aeb77d722f8652e82facb0c77d4f7cba1e43da</a>
</td>
</tr>

<tr>
<td>child 794</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/093282385810477a6776cda35acce28a17799650">093282385810477a6776cda35acce28a17799650</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=67040cc96e525c09df10aea6ad007b26f6925936">718</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Sun, 02 Nov 2008 18:33:34 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@67040cc96e52 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=67040cc96e525c09df10aea6ad007b26f6925936">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=67040cc96e525c09df10aea6ad007b26f6925936&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=67040cc96e525c09df10aea6ad007b26f6925936&newProject=comm-central&newRevision=67040cc96e525c09df10aea6ad007b26f6925936&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=67040cc96e525c09df10aea6ad007b26f6925936&newProject=comm-central&newRevision=67040cc96e525c09df10aea6ad007b26f6925936&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=67040cc96e525c09df10aea6ad007b26f6925936&newProject=comm-central&newRevision=67040cc96e525c09df10aea6ad007b26f6925936&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28dbo%29&revcount=50">dbo</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=461166">461166</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=461166">bug 461166</a> - e4x parser borks on surrounding white spaces and certain response elements. r=dbo</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/67040cc96e525c09df10aea6ad007b26f6925936/calendar/base/src/calProviderUtils.js">calendar/base/src/calProviderUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67040cc96e525c09df10aea6ad007b26f6925936/calendar/base/src/calProviderUtils.js">file</a> |
<a href="/comm-central/annotate/67040cc96e525c09df10aea6ad007b26f6925936/calendar/base/src/calProviderUtils.js">annotate</a> |
<a href="/comm-central/diff/67040cc96e525c09df10aea6ad007b26f6925936/calendar/base/src/calProviderUtils.js">diff</a> |
<a href="/comm-central/comparison/67040cc96e525c09df10aea6ad007b26f6925936/calendar/base/src/calProviderUtils.js">comparison</a> |
<a href="/comm-central/log/67040cc96e525c09df10aea6ad007b26f6925936/calendar/base/src/calProviderUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/67040cc96e525c09df10aea6ad007b26f6925936/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/67040cc96e525c09df10aea6ad007b26f6925936/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/67040cc96e525c09df10aea6ad007b26f6925936/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/67040cc96e525c09df10aea6ad007b26f6925936/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/67040cc96e525c09df10aea6ad007b26f6925936/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/67040cc96e525c09df10aea6ad007b26f6925936/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/src/calProviderUtils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/src/calProviderUtils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -100,16 +100,22 @@ function convertByteArray(aResult, aResu</span>
<a href="#l1.4"></a><span id="l1.4">     } catch (e) {</span>
<a href="#l1.5"></a><span id="l1.5">         if (aThrow) {</span>
<a href="#l1.6"></a><span id="l1.6">             throw e;</span>
<a href="#l1.7"></a><span id="l1.7">         }</span>
<a href="#l1.8"></a><span id="l1.8">     }</span>
<a href="#l1.9"></a><span id="l1.9">     return null;</span>
<a href="#l1.10"></a><span id="l1.10"> }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+function safeNewXML(aStr) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // Strip &lt;?xml and surrounding whitespaces</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    return new XML(aStr.replace(/(^\s*(&lt;\?xml[^&gt;]*&gt;)?\s*|\s+$)/g, &quot;&quot;));</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+}</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18"> /**</span>
<a href="#l1.19"></a><span id="l1.19">  * getInterface method for providers. This should be called in the context of</span>
<a href="#l1.20"></a><span id="l1.20">  * the respective provider, i.e</span>
<a href="#l1.21"></a><span id="l1.21">  *</span>
<a href="#l1.22"></a><span id="l1.22">  * return calInterfaceRequestor_getInterface.apply(this, arguments);</span>
<a href="#l1.23"></a><span id="l1.23">  *</span>
<a href="#l1.24"></a><span id="l1.24">  * or</span>
<a href="#l1.25"></a><span id="l1.25">  * ...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -850,21 +850,18 @@ calDavCalendar.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">             var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.6"></a><span id="l2.6">             if (!str) {</span>
<a href="#l2.7"></a><span id="l2.7">                 LOG(&quot;CalDAV: Failed to get ctag from server&quot;);</span>
<a href="#l2.8"></a><span id="l2.8">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.9"></a><span id="l2.9">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.10"></a><span id="l2.10">             }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-            if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                    str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-            }</span>
<a href="#l2.15"></a><span id="l2.15">             try {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-                var multistatus = new XML(str);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                var multistatus = safeNewXML(str);</span>
<a href="#l2.18"></a><span id="l2.18">             } catch (ex) {</span>
<a href="#l2.19"></a><span id="l2.19">                 LOG(&quot;CalDAV: Failed to get ctag from server&quot;);</span>
<a href="#l2.20"></a><span id="l2.20">                 return;</span>
<a href="#l2.21"></a><span id="l2.21">             }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">             var ctag = multistatus..CS::getctag.toString();</span>
<a href="#l2.24"></a><span id="l2.24">             if (!ctag.length || ctag != thisCalendar.mCtag) {</span>
<a href="#l2.25"></a><span id="l2.25">                 // ctag mismatch, need to fetch calendar-data</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineat">@@ -978,22 +975,18 @@ calDavCalendar.prototype = {</span>
<a href="#l2.27"></a><span id="l2.27">                 // server error (i.e 50x).</span>
<a href="#l2.28"></a><span id="l2.28">                 var str = convertByteArray(aResult, aResultLength);</span>
<a href="#l2.29"></a><span id="l2.29">                 if (!str) {</span>
<a href="#l2.30"></a><span id="l2.30">                     LOG(&quot;CAlDAV: Failed to parse getetag PROPFIND&quot;);</span>
<a href="#l2.31"></a><span id="l2.31">                 } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.32"></a><span id="l2.32">                     LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.33"></a><span id="l2.33">                 }</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-                if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-                    str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                }</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-                var multistatus = new XML(str);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                for (var i = 0; i &lt; multistatus.*.length(); i++) {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-                    var response = new XML(multistatus.*[i]);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+                var multistatus = safeNewXML(str);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                for each (let response in multistatus.*::response) {</span>
<a href="#l2.43"></a><span id="l2.43">                     var etag = response..D::[&quot;getetag&quot;];</span>
<a href="#l2.44"></a><span id="l2.44">                     if (etag.length() == 0) {</span>
<a href="#l2.45"></a><span id="l2.45">                         continue;</span>
<a href="#l2.46"></a><span id="l2.46">                     }</span>
<a href="#l2.47"></a><span id="l2.47">                     var contenttype = null;</span>
<a href="#l2.48"></a><span id="l2.48">                     contenttype = response..D::[&quot;getcontenttype&quot;];</span>
<a href="#l2.49"></a><span id="l2.49">                     // workaround for a Scalix bug which causes incorrect</span>
<a href="#l2.50"></a><span id="l2.50">                     // contenttype to be returned. Remove when that's fixed</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineat">@@ -1164,33 +1157,27 @@ calDavCalendar.prototype = {</span>
<a href="#l2.52"></a><span id="l2.52">                 if (thisCalendar.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l2.53"></a><span id="l2.53">                     aChangeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l2.54"></a><span id="l2.54">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l2.55"></a><span id="l2.55">                 }</span>
<a href="#l2.56"></a><span id="l2.56">                 return;</span>
<a href="#l2.57"></a><span id="l2.57">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.58"></a><span id="l2.58">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.59"></a><span id="l2.59">             }</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-            if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-                str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-            }</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-</span>
<a href="#l2.64"></a><span id="l2.64">             if (thisCalendar.isCached) {</span>
<a href="#l2.65"></a><span id="l2.65">                 thisCalendar.superCalendar.startBatch();</span>
<a href="#l2.66"></a><span id="l2.66">             }</span>
<a href="#l2.67"></a><span id="l2.67">             try {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-                var multistatus = new XML(str);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-                for (var j = 0; j &lt; multistatus.*.length(); j++) {</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                    var response = new XML(multistatus.*[j]);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+                var multistatus = safeNewXML(str);</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+                for each (let response in multistatus.*::response) {</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74">                     var hasNon200 = false;</span>
<a href="#l2.75"></a><span id="l2.75">                     var non200Statuses = [];</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-                    for (var k = 0; k &lt; response..D::[&quot;status&quot;].*.length(); k++) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-                      var itemStatus = &quot;&quot; + response..D::[&quot;status&quot;].*[k];</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                      var status = itemStatus.split(&quot; &quot;)[1];</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+                    for each (let itemStatus in response..D::[&quot;status&quot;]) {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+                      var status = itemStatus.toString().split(&quot; &quot;)[1];</span>
<a href="#l2.81"></a><span id="l2.81">                       if (status != 200) {</span>
<a href="#l2.82"></a><span id="l2.82">                           hasNon200 = true;</span>
<a href="#l2.83"></a><span id="l2.83">                           if (non200Statuses.indexOf(status) &lt; 0) {</span>
<a href="#l2.84"></a><span id="l2.84">                               non200Statuses.push(status);</span>
<a href="#l2.85"></a><span id="l2.85">                           }</span>
<a href="#l2.86"></a><span id="l2.86">                       }</span>
<a href="#l2.87"></a><span id="l2.87">                     }</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89" class="difflineat">@@ -1386,21 +1373,18 @@ calDavCalendar.prototype = {</span>
<a href="#l2.90"></a><span id="l2.90">                 LOG(&quot;CalDAV: Failed to determine resource type&quot;);</span>
<a href="#l2.91"></a><span id="l2.91">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l2.92"></a><span id="l2.92">                                                      Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l2.93"></a><span id="l2.93">                 return;</span>
<a href="#l2.94"></a><span id="l2.94">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.95"></a><span id="l2.95">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.96"></a><span id="l2.96">             }</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-            if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-            }</span>
<a href="#l2.101"></a><span id="l2.101">             try {</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-                var multistatus = new XML(str);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+                var multistatus = safeNewXML(str);</span>
<a href="#l2.104"></a><span id="l2.104">             } catch (ex) {</span>
<a href="#l2.105"></a><span id="l2.105">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l2.106"></a><span id="l2.106">                                                      Components.interfaces.calIErrors.DAV_NOT_DAV);</span>
<a href="#l2.107"></a><span id="l2.107">                 return;</span>
<a href="#l2.108"></a><span id="l2.108">             }</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110">             // check for server-side ctag support</span>
<a href="#l2.111"></a><span id="l2.111">             var ctag = multistatus..CS::[&quot;getctag&quot;].toString();</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineat">@@ -1587,20 +1571,17 @@ calDavCalendar.prototype = {</span>
<a href="#l2.113"></a><span id="l2.113">                 LOG(&quot;CalDAV: Failed to propstat principal namespace&quot;);</span>
<a href="#l2.114"></a><span id="l2.114">                 thisCalendar.completeCheckServerInfo(aChangeLogListener,</span>
<a href="#l2.115"></a><span id="l2.115">                                                      Components.results.NS_ERROR_FAILURE);</span>
<a href="#l2.116"></a><span id="l2.116">                 return;</span>
<a href="#l2.117"></a><span id="l2.117">             } else if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.118"></a><span id="l2.118">                 LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.119"></a><span id="l2.119">             }</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-            if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-                str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-            }</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-            var multistatus = new XML(str);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+            var multistatus = safeNewXML(str);</span>
<a href="#l2.126"></a><span id="l2.126">             var pcs = multistatus..D::[&quot;principal-collection-set&quot;]..D::href;</span>
<a href="#l2.127"></a><span id="l2.127">             var nsList = [];</span>
<a href="#l2.128"></a><span id="l2.128">             for (var ns in pcs) {</span>
<a href="#l2.129"></a><span id="l2.129">                 var nsString = pcs[ns].toString();</span>
<a href="#l2.130"></a><span id="l2.130">                 var nsPath = thisCalendar.ensurePath(nsString);</span>
<a href="#l2.131"></a><span id="l2.131">                 nsList.push(nsPath);</span>
<a href="#l2.132"></a><span id="l2.132">             }</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134" class="difflineat">@@ -1717,24 +1698,20 @@ calDavCalendar.prototype = {</span>
<a href="#l2.135"></a><span id="l2.135"> </span>
<a href="#l2.136"></a><span id="l2.136">             if (aContext.responseStatus != 207) {</span>
<a href="#l2.137"></a><span id="l2.137">                 LOG(&quot;CalDAV: Bad response to in/outbox query, status &quot; +</span>
<a href="#l2.138"></a><span id="l2.138">                     aContext.responseStatus);</span>
<a href="#l2.139"></a><span id="l2.139">                 doesntSupportScheduling();</span>
<a href="#l2.140"></a><span id="l2.140">                 return;</span>
<a href="#l2.141"></a><span id="l2.141">             }</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-            if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-                    str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-            }</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-            var multistatus = new XML(str);</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-            var multistatusLength = multistatus.*.length();</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+            var multistatus = safeNewXML(str);</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+            var multistatusLength = multistatus.*::response.length();</span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-            for (var i = 0; i &lt; multistatusLength; i++) {</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-                var response = multistatus.*[i];</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+            for each (let response in multistatus.*::response) {</span>
<a href="#l2.154"></a><span id="l2.154"> </span>
<a href="#l2.155"></a><span id="l2.155">                 var responseCHS = response..C::[&quot;calendar-home-set&quot;]..D::href[0];</span>
<a href="#l2.156"></a><span id="l2.156">                 if (!responseCHS) {</span>
<a href="#l2.157"></a><span id="l2.157">                     responseCHS = response..D::[&quot;calendar-home-set&quot;]..D::href[0];</span>
<a href="#l2.158"></a><span id="l2.158">                 }</span>
<a href="#l2.159"></a><span id="l2.159"> </span>
<a href="#l2.160"></a><span id="l2.160">                 try {</span>
<a href="#l2.161"></a><span id="l2.161">                     if (responseCHS.charAt(responseCHS.toString().length -1) != &quot;/&quot;) {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineat">@@ -1751,19 +1728,19 @@ calDavCalendar.prototype = {</span>
<a href="#l2.163"></a><span id="l2.163">                     continue;</span>
<a href="#l2.164"></a><span id="l2.164">                 }</span>
<a href="#l2.165"></a><span id="l2.165">                 var addrHrefs =</span>
<a href="#l2.166"></a><span id="l2.166">                     response..C::[&quot;calendar-user-address-set&quot;]..D::href;</span>
<a href="#l2.167"></a><span id="l2.167">                 if (!addrHrefs.toString().length) {</span>
<a href="#l2.168"></a><span id="l2.168">                     addrHrefs =</span>
<a href="#l2.169"></a><span id="l2.169">                         response..D::propstat..D::[&quot;calendar-user-address-set&quot;]..D::href;</span>
<a href="#l2.170"></a><span id="l2.170">                 }</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-                for (var j = 0; j &lt; addrHrefs.*.length(); j++) {</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-                    if (addrHrefs[j].substr(0,7).toLowerCase() == &quot;mailto:&quot;) {</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-                        thisCalendar.mCalendarUserAddress = addrHrefs[j].toString();</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+                for each (let addrHref in addrHrefs) {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+                    if (addrHref.toString().substr(0,7).toLowerCase() == &quot;mailto:&quot;) {</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+                        thisCalendar.mCalendarUserAddress = addrHref.toString();</span>
<a href="#l2.177"></a><span id="l2.177">                     }</span>
<a href="#l2.178"></a><span id="l2.178">                 }</span>
<a href="#l2.179"></a><span id="l2.179">                 var ibUrl = thisCalendar.mUri.clone();</span>
<a href="#l2.180"></a><span id="l2.180">                 var ibPath =</span>
<a href="#l2.181"></a><span id="l2.181">                     response..C::[&quot;schedule-inbox-URL&quot;]..D::href[0];</span>
<a href="#l2.182"></a><span id="l2.182">                 if (!ibPath) {</span>
<a href="#l2.183"></a><span id="l2.183">                     var ibPath = response..D::[&quot;schedule-inbox-URL&quot;]..D::href[0];</span>
<a href="#l2.184"></a><span id="l2.184">                 }</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineat">@@ -1974,21 +1951,17 @@ calDavCalendar.prototype = {</span>
<a href="#l2.186"></a><span id="l2.186">                 var fbTypeMap = {};</span>
<a href="#l2.187"></a><span id="l2.187">                 fbTypeMap[&quot;FREE&quot;] = calIFreeBusyInterval.FREE;</span>
<a href="#l2.188"></a><span id="l2.188">                 fbTypeMap[&quot;BUSY&quot;] = calIFreeBusyInterval.BUSY;</span>
<a href="#l2.189"></a><span id="l2.189">                 fbTypeMap[&quot;BUSY-UNAVAILABLE&quot;] = calIFreeBusyInterval.BUSY_UNAVAILABLE;</span>
<a href="#l2.190"></a><span id="l2.190">                 fbTypeMap[&quot;BUSY-TENTATIVE&quot;] = calIFreeBusyInterval.BUSY_TENTATIVE;</span>
<a href="#l2.191"></a><span id="l2.191">                 var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l2.192"></a><span id="l2.192">                 var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l2.193"></a><span id="l2.193"> </span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-                if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-                    str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-                }</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-                var response = new XML(str);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+                var response = safeNewXML(str);</span>
<a href="#l2.200"></a><span id="l2.200">                 var status = response..C::response..C::[&quot;request-status&quot;];</span>
<a href="#l2.201"></a><span id="l2.201">                 if (status.substr(0,1) != 2) {</span>
<a href="#l2.202"></a><span id="l2.202">                     LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to freebusy query&quot;);</span>
<a href="#l2.203"></a><span id="l2.203">                     aListener.onResult(null, null);</span>
<a href="#l2.204"></a><span id="l2.204">                     return;</span>
<a href="#l2.205"></a><span id="l2.205">                 }</span>
<a href="#l2.206"></a><span id="l2.206">                 if (status.substr(0,3) != &quot;2.0&quot;) {</span>
<a href="#l2.207"></a><span id="l2.207">                     LOG(&quot;CalDAV: Got status &quot; + status + &quot; in response to freebusy query&quot;);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineat">@@ -2225,27 +2198,23 @@ calDavCalendar.prototype = {</span>
<a href="#l2.209"></a><span id="l2.209">                     var str = convertByteArray(aResult, aResultLength, &quot;UTF-8&quot;, false);</span>
<a href="#l2.210"></a><span id="l2.210">                     if (str) {</span>
<a href="#l2.211"></a><span id="l2.211">                         if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.212"></a><span id="l2.212">                             LOG(&quot;CalDAV: recv: &quot; + str);</span>
<a href="#l2.213"></a><span id="l2.213">                         }</span>
<a href="#l2.214"></a><span id="l2.214">                     } else {</span>
<a href="#l2.215"></a><span id="l2.215">                         LOG(&quot;CalDAV: Failed to parse iTIP response.&quot;);</span>
<a href="#l2.216"></a><span id="l2.216">                     }</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-                    if (str.substr(0,6) == &quot;&lt;?xml &quot;) {</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-                        str = str.substring(str.indexOf('&lt;', 2));</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-                    }</span>
<a href="#l2.220"></a><span id="l2.220"> </span>
<a href="#l2.221"></a><span id="l2.221">                     var C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l2.222"></a><span id="l2.222">                     var D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-                    var responseXML = new XML(str);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+                    var responseXML = safeNewXML(str);</span>
<a href="#l2.225"></a><span id="l2.225"> </span>
<a href="#l2.226"></a><span id="l2.226">                     var remainingAttendees = [];</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-                    for (var i = 0; i &lt; responseXML.*.length(); i++) {</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-                        var response = new XML(responseXML.*[i]);</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+                    for each (let response in responseXML.*::response) {</span>
<a href="#l2.230"></a><span id="l2.230">                         var recip = response..C::recipient..D::href;</span>
<a href="#l2.231"></a><span id="l2.231">                         var status = response..C::[&quot;request-status&quot;];</span>
<a href="#l2.232"></a><span id="l2.232">                         if (status.substr(0, 1) != &quot;2&quot;) {</span>
<a href="#l2.233"></a><span id="l2.233">                             if (thisCalendar.verboseLogging()) {</span>
<a href="#l2.234"></a><span id="l2.234">                                 LOG(&quot;CalDAV: failed delivery to &quot; + recip);</span>
<a href="#l2.235"></a><span id="l2.235">                             }</span>
<a href="#l2.236"></a><span id="l2.236">                             for each (var att in aRecipients) {</span>
<a href="#l2.237"></a><span id="l2.237">                                 if (att.id.toLowerCase() == recip.toLowerCase()) {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

