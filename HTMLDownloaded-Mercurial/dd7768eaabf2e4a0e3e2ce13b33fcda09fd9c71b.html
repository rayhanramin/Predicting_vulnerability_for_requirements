<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7317:dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b" />
<meta property="og:url" content="/comm-central/rev/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b" />
<meta property="og:description" content="Bug 633498 - Provide structured context information about mozmill failures." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">shortlog</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">files</a> |
changeset |
<a href="/comm-central/raw-rev/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">raw</a>  | <a href="/comm-central/archive/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=633498">Bug 633498</a> - Provide structured context information about mozmill failures.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 10 Mar 2011 11:53:36 -0800</td></tr>

<tr>
 <td>changeset 7317</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b</a></td>
</tr>



<tr>
<td>parent 7316</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/141c656b38ea3cca9da1caef32153c9eb9dc266a">141c656b38ea3cca9da1caef32153c9eb9dc266a</a>
</td>
</tr>

<tr>
<td>child 7318</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6609dcc741a7c1b64ddb375a1155db718723ac75">6609dcc741a7c1b64ddb375a1155db718723ac75</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">5603</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Mar 2011 19:53:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dd7768eaabf2 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&newProject=comm-central&newRevision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&newProject=comm-central&newRevision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&newProject=comm-central&newRevision=dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=633498">633498</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=633498">Bug 633498</a> - Provide structured context information about mozmill failures.

For the time being, browse to http://arbpl.visophyte.org/ to see the fruits of
the structured data.

The code that powers that site can be found at:
https://github.com/asutherland/arbitrarypushlog</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/test/unit/resources/viewWrapperTestUtils.js">mail/base/test/unit/resources/viewWrapperTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/test/unit/resources/viewWrapperTestUtils.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/test/unit/resources/viewWrapperTestUtils.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/test/unit/resources/viewWrapperTestUtils.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/test/unit/resources/viewWrapperTestUtils.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/base/test/unit/resources/viewWrapperTestUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/content-tabs/test-content-tab.js">mail/test/mozmill/content-tabs/test-content-tab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/content-tabs/test-content-tab.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/content-tabs/test-content-tab.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/content-tabs/test-content-tab.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/content-tabs/test-content-tab.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/content-tabs/test-content-tab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-columns.js">mail/test/mozmill/folder-display/test-columns.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-columns.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-columns.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-columns.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-columns.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-columns.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-message-commands.js">mail/test/mozmill/folder-display/test-message-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-message-commands.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-message-commands.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-message-commands.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-message-commands.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-message-commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/message-header/test-message-header.js">mail/test/mozmill/message-header/test-message-header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/message-header/test-message-header.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/message-header/test-message-header.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/message-header/test-message-header.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/message-header/test-message-header.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/message-header/test-message-header.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">mail/test/mozmill/quick-filter-bar/test-display-issues.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/quick-filter-bar/test-display-issues.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/runtest.py">mail/test/mozmill/runtest.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/runtest.py">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/runtest.py">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/runtest.py">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/runtest.py">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/runtest.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/search-window/test-search-window.js">mail/test/mozmill/search-window/test-search-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/search-window/test-search-window.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/search-window/test-search-window.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/search-window/test-search-window.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/search-window/test-search-window.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/search-window/test-search-window.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">mail/test/mozmill/shared-modules/test-account-manager-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-migration-helpers.js">mail/test/mozmill/shared-modules/test-migration-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-migration-helpers.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-migration-helpers.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-migration-helpers.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-migration-helpers.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-migration-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-search-window-helpers.js">mail/test/mozmill/shared-modules/test-search-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-search-window-helpers.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-search-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-search-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-search-window-helpers.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-search-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/db/gloda/modules/log4moz.js">mailnews/db/gloda/modules/log4moz.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/db/gloda/modules/log4moz.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/db/gloda/modules/log4moz.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/db/gloda/modules/log4moz.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/db/gloda/modules/log4moz.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/db/gloda/modules/log4moz.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/logHelper.js">mailnews/test/resources/logHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/logHelper.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/logHelper.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/logHelper.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/logHelper.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/logHelper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/messageInjection.js">mailnews/test/resources/messageInjection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/messageInjection.js">file</a> |
<a href="/comm-central/annotate/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/messageInjection.js">annotate</a> |
<a href="/comm-central/diff/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/messageInjection.js">diff</a> |
<a href="/comm-central/comparison/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/messageInjection.js">comparison</a> |
<a href="/comm-central/log/dd7768eaabf2e4a0e3e2ce13b33fcda09fd9c71b/mailnews/test/resources/messageInjection.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -576,17 +576,17 @@ var messageHeaderSink = {</span>
<a href="#l1.4"></a><span id="l1.4">         try {</span>
<a href="#l1.5"></a><span id="l1.5">           size = fileHandler.getFileFromURLSpec(url).fileSize;</span>
<a href="#l1.6"></a><span id="l1.6">         }</span>
<a href="#l1.7"></a><span id="l1.7">         catch(e) {</span>
<a href="#l1.8"></a><span id="l1.8">           dump(&quot;Couldn't open external attachment!&quot;);</span>
<a href="#l1.9"></a><span id="l1.9">         }</span>
<a href="#l1.10"></a><span id="l1.10">       }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      currentAttachments.push (new createNewAttachmentInfo(contentType, url, displayName, </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      currentAttachments.push (new createNewAttachmentInfo(contentType, url, displayName,</span>
<a href="#l1.14"></a><span id="l1.14">                                                            uri, isExternalAttachment, size));</span>
<a href="#l1.15"></a><span id="l1.15">       // If we have an attachment, set the nsMsgMessageFlags.Attachment flag</span>
<a href="#l1.16"></a><span id="l1.16">       // on the hdr to cause the &quot;message with attachment&quot; icon to show up</span>
<a href="#l1.17"></a><span id="l1.17">       // in the thread pane.</span>
<a href="#l1.18"></a><span id="l1.18">       // We only need to do this on the first attachment.</span>
<a href="#l1.19"></a><span id="l1.19">       var numAttachments = currentAttachments.length;</span>
<a href="#l1.20"></a><span id="l1.20">       if (numAttachments == 1) {</span>
<a href="#l1.21"></a><span id="l1.21">         // we also have to enable the File/Attachments menuitem</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -618,26 +618,32 @@ var messageHeaderSink = {</span>
<a href="#l1.23"></a><span id="l1.23">         last.size = null;</span>
<a href="#l1.24"></a><span id="l1.24">       }</span>
<a href="#l1.25"></a><span id="l1.25">     },</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">     onEndAllAttachments: function()</span>
<a href="#l1.28"></a><span id="l1.28">     {</span>
<a href="#l1.29"></a><span id="l1.29">       displayAttachmentsForExpandedView();</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-      gMessageDisplay.onLoadCompleted();</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-</span>
<a href="#l1.33"></a><span id="l1.33">       for each (let [, listener] in Iterator(gMessageListeners)) {</span>
<a href="#l1.34"></a><span id="l1.34">         if (&quot;onEndAttachments&quot; in listener)</span>
<a href="#l1.35"></a><span id="l1.35">           listener.onEndAttachments();</span>
<a href="#l1.36"></a><span id="l1.36">       }</span>
<a href="#l1.37"></a><span id="l1.37">     },</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    /**</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+     * This event is generated by nsMsgStatusFeedback when it gets an</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+     * OnStateChange event for STATE_STOP.  This is the same event that</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+     * generates the &quot;msgLoaded&quot; property flag change event.  This best</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+     * corresponds to the end of the streaming process.</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+     */</span>
<a href="#l1.45"></a><span id="l1.45">     onEndMsgDownload: function(url)</span>
<a href="#l1.46"></a><span id="l1.46">     {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+      gMessageDisplay.onLoadCompleted();</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+</span>
<a href="#l1.49"></a><span id="l1.49">       // if we don't have any attachments, turn off the attachments flag</span>
<a href="#l1.50"></a><span id="l1.50">       if (!this.mSaveHdr)</span>
<a href="#l1.51"></a><span id="l1.51">       {</span>
<a href="#l1.52"></a><span id="l1.52">         var messageUrl = url.QueryInterface(Components.interfaces.nsIMsgMessageUrl);</span>
<a href="#l1.53"></a><span id="l1.53">         this.mSaveHdr = messenger.msgHdrFromURI(messageUrl.uri);</span>
<a href="#l1.54"></a><span id="l1.54">       }</span>
<a href="#l1.55"></a><span id="l1.55">       if (!currentAttachments.length &amp;&amp; this.mSaveHdr)</span>
<a href="#l1.56"></a><span id="l1.56">         this.mSaveHdr.markHasAttachments(false);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineat">@@ -1588,17 +1594,17 @@ function CopyNewsgroupURL(newsgroupNode)</span>
<a href="#l1.58"></a><span id="l1.58"> }</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60"> /**</span>
<a href="#l1.61"></a><span id="l1.61">  * Create a new attachment object which goes into the data attachment array.</span>
<a href="#l1.62"></a><span id="l1.62">  * This method checks whether the passed attachment is empty or not.</span>
<a href="#l1.63"></a><span id="l1.63">  *</span>
<a href="#l1.64"></a><span id="l1.64">  * @param contentType The attachment's mimetype</span>
<a href="#l1.65"></a><span id="l1.65">  * @param url The URL for the attachment</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">- * @param displayName The name to be displayed for this attachment (usually the </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+ * @param displayName The name to be displayed for this attachment (usually the</span>
<a href="#l1.68"></a><span id="l1.68">           filename)</span>
<a href="#l1.69"></a><span id="l1.69">  * @param uri The URI for the message containing the attachment</span>
<a href="#l1.70"></a><span id="l1.70">  * @param isExternalAttachment True if the attachment has been detached</span>
<a href="#l1.71"></a><span id="l1.71">  * @param size The size in bytes of the attachment</span>
<a href="#l1.72"></a><span id="l1.72">  */</span>
<a href="#l1.73"></a><span id="l1.73"> function createNewAttachmentInfo(contentType, url, displayName, uri,</span>
<a href="#l1.74"></a><span id="l1.74">                                  isExternalAttachment, size)</span>
<a href="#l1.75"></a><span id="l1.75"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/test/unit/resources/viewWrapperTestUtils.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -440,30 +440,32 @@ function verify_messages_in_view(aSynSet</span>
<a href="#l2.4"></a><span id="l2.4">     }</span>
<a href="#l2.5"></a><span id="l2.5">     // the view is showing a message that should not be shown, explode.</span>
<a href="#l2.6"></a><span id="l2.6">     else {</span>
<a href="#l2.7"></a><span id="l2.7">       dump(&quot;The view is showing the following message header and should not&quot; +</span>
<a href="#l2.8"></a><span id="l2.8">            &quot; be:\n&quot;);</span>
<a href="#l2.9"></a><span id="l2.9">       dump_message_header(msgHdr);</span>
<a href="#l2.10"></a><span id="l2.10">       dump(&quot;View State:\n&quot;);</span>
<a href="#l2.11"></a><span id="l2.11">       dump_view_state(aViewWrapper);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      do_throw(&quot;view contains header that should not be present!&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      mark_failure([&quot;view contains header that should not be present!&quot;,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+                    msgHdr]);</span>
<a href="#l2.15"></a><span id="l2.15">     }</span>
<a href="#l2.16"></a><span id="l2.16">   }</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   // - Iterate over our URI set and make sure every message got nulled out.</span>
<a href="#l2.19"></a><span id="l2.19">   for each (let [, msgHdr] in Iterator(synMessageURIs)) {</span>
<a href="#l2.20"></a><span id="l2.20">     if (msgHdr != null) {</span>
<a href="#l2.21"></a><span id="l2.21">       dump(&quot;************************\n&quot;);</span>
<a href="#l2.22"></a><span id="l2.22">       dump(&quot;The view should have included the following message header but&quot; +</span>
<a href="#l2.23"></a><span id="l2.23">            &quot; did not:\n&quot;);</span>
<a href="#l2.24"></a><span id="l2.24">       dump_message_header(msgHdr);</span>
<a href="#l2.25"></a><span id="l2.25">       dump(&quot;View State:\n&quot;);</span>
<a href="#l2.26"></a><span id="l2.26">       dump_view_state(aViewWrapper);</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-      do_throw(&quot;view does not contain a header that should be present!&quot;);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+      mark_failure([&quot;view does not contain a header that should be present!&quot;,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+                    msgHdr]);</span>
<a href="#l2.30"></a><span id="l2.30">     }</span>
<a href="#l2.31"></a><span id="l2.31">   }</span>
<a href="#l2.32"></a><span id="l2.32"> }</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> /**</span>
<a href="#l2.35"></a><span id="l2.35">  * Assert if the view wrapper is displaying any messages.</span>
<a href="#l2.36"></a><span id="l2.36">  */</span>
<a href="#l2.37"></a><span id="l2.37"> function verify_empty_view(aViewWrapper) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -86,44 +86,45 @@ function test_content_tab_open() {</span>
<a href="#l3.4"></a><span id="l3.4"> /**</span>
<a href="#l3.5"></a><span id="l3.5">  * Just make sure that the context menu does what we expect in content tabs wrt.</span>
<a href="#l3.6"></a><span id="l3.6">  * spell checking options.</span>
<a href="#l3.7"></a><span id="l3.7">  */</span>
<a href="#l3.8"></a><span id="l3.8"> function test_spellcheck_in_content_tabs() {</span>
<a href="#l3.9"></a><span id="l3.9">   let tabmail = mc.tabmail;</span>
<a href="#l3.10"></a><span id="l3.10">   let w = tabmail.selectedTab.browser.contentWindow;</span>
<a href="#l3.11"></a><span id="l3.11">   let textarea = w.document.getElementsByTagName(&quot;textarea&quot;)[0];</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  let eidMailContext = mc.eid(&quot;mailContext&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14">   // Test a few random items</span>
<a href="#l3.15"></a><span id="l3.15">   mc.rightClick(new elementslib.Elem(textarea));</span>
<a href="#l3.16"></a><span id="l3.16">   assert_element_visible(&quot;mailContext-spell-dictionaries&quot;);</span>
<a href="#l3.17"></a><span id="l3.17">   assert_element_visible(&quot;mailContext-spell-check-enabled&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">   assert_element_not_visible(&quot;mailContext-replySender&quot;); // we're in a content tab!</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  close_popup();</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  close_popup(mc, eidMailContext);</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">   // Different test</span>
<a href="#l3.23"></a><span id="l3.23">   mc.rightClick(new elementslib.Elem(w.document.body.firstElementChild));</span>
<a href="#l3.24"></a><span id="l3.24">   assert_element_not_visible(&quot;mailContext-spell-dictionaries&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">   assert_element_not_visible(&quot;mailContext-spell-check-enabled&quot;);</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-  close_popup();</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  close_popup(mc, eidMailContext);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   // Right-click on &quot;zombocom&quot; and add to dictionary</span>
<a href="#l3.30"></a><span id="l3.30">   EventUtils.synthesizeMouse(textarea, 5, 5,</span>
<a href="#l3.31"></a><span id="l3.31">                              {type: &quot;contextmenu&quot;, button: 2}, w);</span>
<a href="#l3.32"></a><span id="l3.32">   let suggestions = mc.window.document.getElementsByClassName(&quot;spell-suggestion&quot;);</span>
<a href="#l3.33"></a><span id="l3.33">   assert_true(suggestions.length &gt; 0, &quot;What, is zombocom a registered word now?&quot;);</span>
<a href="#l3.34"></a><span id="l3.34">   mc.click(mc.eid(&quot;mailContext-spell-add-to-dictionary&quot;));</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  close_popup();</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  close_popup(mc, eidMailContext);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38">   // Now check we don't have any suggestionss</span>
<a href="#l3.39"></a><span id="l3.39">   EventUtils.synthesizeMouse(textarea, 5, 5,</span>
<a href="#l3.40"></a><span id="l3.40">                              {type: &quot;contextmenu&quot;, button: 2}, w);</span>
<a href="#l3.41"></a><span id="l3.41">   let suggestions = mc.window.document.getElementsByClassName(&quot;spell-suggestion&quot;);</span>
<a href="#l3.42"></a><span id="l3.42">   assert_true(suggestions.length == 0, &quot;But I just taught you this word!&quot;);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  close_popup();</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  close_popup(mc, eidMailContext);</span>
<a href="#l3.45"></a><span id="l3.45"> }</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47"> function test_content_tab_open_same() {</span>
<a href="#l3.48"></a><span id="l3.48">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50">   mc.click(new elementslib.Elem(mc.menus.helpMenu.whatsNew));</span>
<a href="#l3.51"></a><span id="l3.51"> </span>
<a href="#l3.52"></a><span id="l3.52">   controller.sleep(0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -363,18 +363,20 @@ function invoke_column_picker_option(aAc</span>
<a href="#l4.4"></a><span id="l4.4">   //  treadCols</span>
<a href="#l4.5"></a><span id="l4.5">   //   |- hbox                item 0</span>
<a href="#l4.6"></a><span id="l4.6">   //   |- treecolpicker   &lt;-- item 1 this is the one we want</span>
<a href="#l4.7"></a><span id="l4.7">   let threadCols = mc.window.document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l4.8"></a><span id="l4.8">   let colPicker = mc.window.document.getAnonymousNodes(threadCols).item(1);</span>
<a href="#l4.9"></a><span id="l4.9">   let colPickerPopup = mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l4.10"></a><span id="l4.10">                          colPicker, &quot;anonid&quot;, &quot;popup&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  mc.click(new elib.Elem(colPicker), 10, 10);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  mc.click(new elib.Elem(colPicker));</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  wait_for_popup_to_open(colPickerPopup);</span>
<a href="#l4.15"></a><span id="l4.15">   mc.click_menus_in_sequence(colPickerPopup, aActions);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  close_popup(mc, new elib.Elem(colPickerPopup));</span>
<a href="#l4.17"></a><span id="l4.17"> }</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> /**</span>
<a href="#l4.21"></a><span id="l4.21">  * The column picker's &quot;reset columns to default&quot; option should set our state</span>
<a href="#l4.22"></a><span id="l4.22">  *  back to inbox state.</span>
<a href="#l4.23"></a><span id="l4.23">  */</span>
<a href="#l4.24"></a><span id="l4.24"> function test_reset_to_inbox() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-display-message-with-folder-modes.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -66,17 +66,18 @@ function setupModule(module) {</span>
<a href="#l5.4"></a><span id="l5.4">   inboxFolder.createSubfolder(&quot;DisplayMessageWithFolderModesA&quot;, null);</span>
<a href="#l5.5"></a><span id="l5.5">   folder = inboxFolder.getChildNamed(&quot;DisplayMessageWithFolderModesA&quot;);</span>
<a href="#l5.6"></a><span id="l5.6">   // This second folder is meant to act as a dummy folder to switch to when we</span>
<a href="#l5.7"></a><span id="l5.7">   // want to not be in folder.</span>
<a href="#l5.8"></a><span id="l5.8">   inboxFolder.createSubfolder(&quot;DisplayMessageWithFolderModesB&quot;, null);</span>
<a href="#l5.9"></a><span id="l5.9">   dummyFolder = inboxFolder.getChildNamed(&quot;DisplayMessageWithFolderModesB&quot;);</span>
<a href="#l5.10"></a><span id="l5.10">   make_new_sets_in_folder(folder, [{count: 5}]);</span>
<a href="#l5.11"></a><span id="l5.11">   // The message itself doesn't really matter, as long as there's at least one</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  // in the inbox.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  // in the inbox.  We will delete this in teardownModule because the inbox</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  // is a shared resource and it's not okay to leave stuff in there.</span>
<a href="#l5.15"></a><span id="l5.15">   make_new_sets_in_folder(inboxFolder, [{count: 1}]);</span>
<a href="#l5.16"></a><span id="l5.16"> }</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> /**</span>
<a href="#l5.19"></a><span id="l5.19">  * Test that displaying a message causes a switch to the default folder mode if</span>
<a href="#l5.20"></a><span id="l5.20">  * the folder isn't present in the current folder mode.</span>
<a href="#l5.21"></a><span id="l5.21">  */</span>
<a href="#l5.22"></a><span id="l5.22"> function test_display_message_with_folder_not_present_in_current_folder_mode() {</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -198,8 +199,14 @@ function test_display_inbox_message_in_s</span>
<a href="#l5.24"></a><span id="l5.24"> }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> /**</span>
<a href="#l5.27"></a><span id="l5.27">  * Move back to the all folders mode.</span>
<a href="#l5.28"></a><span id="l5.28">  */</span>
<a href="#l5.29"></a><span id="l5.29"> function test_switch_to_all_folders() {</span>
<a href="#l5.30"></a><span id="l5.30">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l5.31"></a><span id="l5.31"> }</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+function teardownModule() {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  be_in_folder(inboxFolder);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  select_click_row(0);</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  press_delete();</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -86,25 +86,22 @@ function check_read_status(messages, rea</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> /**</span>
<a href="#l6.6"></a><span id="l6.6">  * Ensures that the mark read/unread menu items are enabled/disabled properly</span>
<a href="#l6.7"></a><span id="l6.7">  * @param canMarkRead true if the mark read item should be enabled</span>
<a href="#l6.8"></a><span id="l6.8">  * @param canMarkUnread true if the mark unread item should be enabled</span>
<a href="#l6.9"></a><span id="l6.9">  */</span>
<a href="#l6.10"></a><span id="l6.10"> function check_read_menuitems(index, canMarkRead, canMarkUnread) {</span>
<a href="#l6.11"></a><span id="l6.11">   right_click_on_row(index);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l6.13"></a><span id="l6.13">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [{id: &quot;mailContext-mark&quot;}]);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">   let readEnabled = !mc.e(&quot;mailContext-markRead&quot;).disabled;</span>
<a href="#l6.16"></a><span id="l6.16">   let unreadEnabled = !mc.e(&quot;mailContext-markUnread&quot;).disabled;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  // Close both the mark submenu and the main context menu</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  close_popup();</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  close_popup();</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-</span>
<a href="#l6.22"></a><span id="l6.22">   assert_true(readEnabled == canMarkRead,</span>
<a href="#l6.23"></a><span id="l6.23">               &quot;Mark read menu item &quot; + (canMarkRead ? &quot;dis&quot; : &quot;en&quot;) +</span>
<a href="#l6.24"></a><span id="l6.24">               &quot;abled when it shouldn't be!&quot;);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   assert_true(unreadEnabled == canMarkUnread,</span>
<a href="#l6.27"></a><span id="l6.27">               &quot;Mark unread menu item &quot; + (canMarkUnread ? &quot;dis&quot; : &quot;en&quot;) +</span>
<a href="#l6.28"></a><span id="l6.28">               &quot;abled when it shouldn't be!&quot;);</span>
<a href="#l6.29"></a><span id="l6.29"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -78,77 +78,77 @@ function test_right_click_folder_with_no</span>
<a href="#l7.4"></a><span id="l7.4">   select_no_folders();</span>
<a href="#l7.5"></a><span id="l7.5">   assert_no_folders_selected();</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">   right_click_on_folder(folderB);</span>
<a href="#l7.8"></a><span id="l7.8">   assert_folder_selected(folderB);</span>
<a href="#l7.9"></a><span id="l7.9">   // The displayed folder shouldn't change</span>
<a href="#l7.10"></a><span id="l7.10">   assert_folder_displayed(folderA);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  close_popup();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l7.14"></a><span id="l7.14">   assert_no_folders_selected();</span>
<a href="#l7.15"></a><span id="l7.15"> }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> /**</span>
<a href="#l7.18"></a><span id="l7.18">  * One-thing selected, right-click on something else.</span>
<a href="#l7.19"></a><span id="l7.19">  */</span>
<a href="#l7.20"></a><span id="l7.20"> function test_right_click_folder_with_one_thing_selected() {</span>
<a href="#l7.21"></a><span id="l7.21">   select_click_folder(folderB);</span>
<a href="#l7.22"></a><span id="l7.22">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   right_click_on_folder(folderA);</span>
<a href="#l7.25"></a><span id="l7.25">   assert_folder_selected(folderA);</span>
<a href="#l7.26"></a><span id="l7.26">   assert_folder_displayed(folderB);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  close_popup();</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l7.30"></a><span id="l7.30">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l7.31"></a><span id="l7.31"> }</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33"> /**</span>
<a href="#l7.34"></a><span id="l7.34">  * Many things selected, right-click on something that is not in that selection.</span>
<a href="#l7.35"></a><span id="l7.35">  */</span>
<a href="#l7.36"></a><span id="l7.36"> function test_right_click_folder_with_many_things_selected() {</span>
<a href="#l7.37"></a><span id="l7.37">   select_click_folder(folderA);</span>
<a href="#l7.38"></a><span id="l7.38">   select_shift_click_folder(folderB);</span>
<a href="#l7.39"></a><span id="l7.39">   assert_folders_selected_and_displayed(folderA, folderB);</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41">   right_click_on_folder(folderC);</span>
<a href="#l7.42"></a><span id="l7.42">   assert_folder_selected(folderC);</span>
<a href="#l7.43"></a><span id="l7.43">   assert_folder_displayed(folderA);</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-  close_popup();</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l7.47"></a><span id="l7.47">   assert_folders_selected_and_displayed(folderA, folderB);</span>
<a href="#l7.48"></a><span id="l7.48"> }</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50"> /**</span>
<a href="#l7.51"></a><span id="l7.51">  * One thing selected, right-click on that.</span>
<a href="#l7.52"></a><span id="l7.52">  */</span>
<a href="#l7.53"></a><span id="l7.53"> function test_right_click_folder_on_existing_single_selection() {</span>
<a href="#l7.54"></a><span id="l7.54">   select_click_folder(folderA);</span>
<a href="#l7.55"></a><span id="l7.55">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">   right_click_on_folder(folderA);</span>
<a href="#l7.58"></a><span id="l7.58">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  close_popup();</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l7.62"></a><span id="l7.62">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l7.63"></a><span id="l7.63"> }</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65"> /**</span>
<a href="#l7.66"></a><span id="l7.66">  * Many things selected, right-click somewhere in the selection.</span>
<a href="#l7.67"></a><span id="l7.67">  */</span>
<a href="#l7.68"></a><span id="l7.68"> function test_right_click_folder_on_existing_multi_selection() {</span>
<a href="#l7.69"></a><span id="l7.69">   select_click_folder(folderB);</span>
<a href="#l7.70"></a><span id="l7.70">   select_shift_click_folder(folderC);</span>
<a href="#l7.71"></a><span id="l7.71">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73">   right_click_on_folder(folderC);</span>
<a href="#l7.74"></a><span id="l7.74">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  close_popup();</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l7.78"></a><span id="l7.78">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l7.79"></a><span id="l7.79"> }</span>
<a href="#l7.80"></a><span id="l7.80"> </span>
<a href="#l7.81"></a><span id="l7.81"> /**</span>
<a href="#l7.82"></a><span id="l7.82">  * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l7.83"></a><span id="l7.83">  */</span>
<a href="#l7.84"></a><span id="l7.84"> function _middle_click_folder_with_nothing_selected_helper(aBackground) {</span>
<a href="#l7.85"></a><span id="l7.85">   // This should cause folderA to be displayed</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -30,16 +30,19 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.5"></a><span id="l8.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.6"></a><span id="l8.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.7"></a><span id="l8.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.8"></a><span id="l8.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.9"></a><span id="l8.9">  *</span>
<a href="#l8.10"></a><span id="l8.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+var elib = {};</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+</span>
<a href="#l8.15"></a><span id="l8.15"> /*</span>
<a href="#l8.16"></a><span id="l8.16">  * Test the many horrors involving right-clicks, middle clicks, and selections.</span>
<a href="#l8.17"></a><span id="l8.17">  */</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> var MODULE_NAME = 'test-right-click-middle-click-messages';</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l8.22"></a><span id="l8.22"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -78,63 +81,66 @@ function setupModule(module) {</span>
<a href="#l8.24"></a><span id="l8.24">  */</span>
<a href="#l8.25"></a><span id="l8.25"> function test_right_click_with_nothing_selected() {</span>
<a href="#l8.26"></a><span id="l8.26">   be_in_folder(folder);</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   select_none();</span>
<a href="#l8.29"></a><span id="l8.29">   assert_nothing_selected();</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">   right_click_on_row(1);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  // Check that the popup opens.</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+</span>
<a href="#l8.35"></a><span id="l8.35">   assert_selected(1);</span>
<a href="#l8.36"></a><span id="l8.36">   assert_displayed();</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  close_popup();</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+  close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l8.40"></a><span id="l8.40">   assert_nothing_selected();</span>
<a href="#l8.41"></a><span id="l8.41"> }</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43"> /**</span>
<a href="#l8.44"></a><span id="l8.44">  * Test that clicking on the column header shows the column picker.</span>
<a href="#l8.45"></a><span id="l8.45">  */</span>
<a href="#l8.46"></a><span id="l8.46"> function test_right_click_column_header_shows_col_picker() {</span>
<a href="#l8.47"></a><span id="l8.47">   be_in_folder(folder);</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  // Right click the subject columen header (must use 10 10 offset to make it work!)</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  // This should show the column picker popup.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  mc.rightClick(mc.eid(&quot;subjectCol&quot;), 10, 10);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-</span>
<a href="#l8.53"></a><span id="l8.53">   // The treecolpicker element itself doesn't have an id, so we have to walk</span>
<a href="#l8.54"></a><span id="l8.54">   // down from the parent to find it.</span>
<a href="#l8.55"></a><span id="l8.55">   //  treadCols</span>
<a href="#l8.56"></a><span id="l8.56">   //   |- hbox                item 0</span>
<a href="#l8.57"></a><span id="l8.57">   //   |- treecolpicker   &lt;-- item 1 this is the one we want</span>
<a href="#l8.58"></a><span id="l8.58">   let threadCols = mc.window.document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l8.59"></a><span id="l8.59">   let treeColPicker = mc.window.document.getAnonymousNodes(threadCols).item(1);</span>
<a href="#l8.60"></a><span id="l8.60">   let popup = mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l8.61"></a><span id="l8.61">                 treeColPicker, &quot;anonid&quot;, &quot;popup&quot;);</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+  // Right click the subject column header</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  // This should show the column picker popup.</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  mc.rightClick(mc.eid(&quot;subjectCol&quot;));</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+</span>
<a href="#l8.67"></a><span id="l8.67">   // Check that the popup opens.</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  mc.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 100, popup);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  wait_for_popup_to_open(popup);</span>
<a href="#l8.70"></a><span id="l8.70">   // Hide it again, we just wanted to know it was gonna be shown.</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-  popup.hidePopup();</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  close_popup(mc, new elib.Elem(popup));</span>
<a href="#l8.73"></a><span id="l8.73"> }</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75"> /**</span>
<a href="#l8.76"></a><span id="l8.76">  * One-thing selected, right-click on something else.</span>
<a href="#l8.77"></a><span id="l8.77">  */</span>
<a href="#l8.78"></a><span id="l8.78"> function test_right_click_with_one_thing_selected() {</span>
<a href="#l8.79"></a><span id="l8.79">   be_in_folder(folder);</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">   select_click_row(0);</span>
<a href="#l8.82"></a><span id="l8.82">   assert_selected_and_displayed(0);</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">   right_click_on_row(1);</span>
<a href="#l8.85"></a><span id="l8.85">   assert_selected(1);</span>
<a href="#l8.86"></a><span id="l8.86">   assert_displayed(0);</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  close_popup();</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+  close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l8.90"></a><span id="l8.90">   assert_selected_and_displayed(0);</span>
<a href="#l8.91"></a><span id="l8.91"> }</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93"> /**</span>
<a href="#l8.94"></a><span id="l8.94">  * Many things selected, right-click on something that is not in that selection.</span>
<a href="#l8.95"></a><span id="l8.95">  */</span>
<a href="#l8.96"></a><span id="l8.96"> function test_right_click_with_many_things_selected() {</span>
<a href="#l8.97"></a><span id="l8.97">   be_in_folder(folder);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineat">@@ -142,50 +148,50 @@ function test_right_click_with_many_thin</span>
<a href="#l8.99"></a><span id="l8.99">   select_click_row(0);</span>
<a href="#l8.100"></a><span id="l8.100">   select_shift_click_row(5);</span>
<a href="#l8.101"></a><span id="l8.101">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">   right_click_on_row(6);</span>
<a href="#l8.104"></a><span id="l8.104">   assert_selected(6);</span>
<a href="#l8.105"></a><span id="l8.105">   assert_displayed([0, 5]);</span>
<a href="#l8.106"></a><span id="l8.106"> </span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  close_popup();</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l8.109"></a><span id="l8.109">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l8.110"></a><span id="l8.110"> }</span>
<a href="#l8.111"></a><span id="l8.111"> </span>
<a href="#l8.112"></a><span id="l8.112"> /**</span>
<a href="#l8.113"></a><span id="l8.113">  * One thing selected, right-click on that.</span>
<a href="#l8.114"></a><span id="l8.114">  */</span>
<a href="#l8.115"></a><span id="l8.115"> function test_right_click_on_existing_single_selection() {</span>
<a href="#l8.116"></a><span id="l8.116">   be_in_folder(folder);</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118">   select_click_row(3);</span>
<a href="#l8.119"></a><span id="l8.119">   assert_selected_and_displayed(3);</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121">   right_click_on_row(3);</span>
<a href="#l8.122"></a><span id="l8.122">   assert_selected_and_displayed(3);</span>
<a href="#l8.123"></a><span id="l8.123"> </span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  close_popup();</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+  close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l8.126"></a><span id="l8.126">   assert_selected_and_displayed(3);</span>
<a href="#l8.127"></a><span id="l8.127"> }</span>
<a href="#l8.128"></a><span id="l8.128"> </span>
<a href="#l8.129"></a><span id="l8.129"> /**</span>
<a href="#l8.130"></a><span id="l8.130">  * Many things selected, right-click somewhere in the selection.</span>
<a href="#l8.131"></a><span id="l8.131">  */</span>
<a href="#l8.132"></a><span id="l8.132"> function test_right_click_on_existing_multi_selection() {</span>
<a href="#l8.133"></a><span id="l8.133">   be_in_folder(folder);</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135">   select_click_row(3);</span>
<a href="#l8.136"></a><span id="l8.136">   select_shift_click_row(6);</span>
<a href="#l8.137"></a><span id="l8.137">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l8.138"></a><span id="l8.138"> </span>
<a href="#l8.139"></a><span id="l8.139">   right_click_on_row(5);</span>
<a href="#l8.140"></a><span id="l8.140">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l8.141"></a><span id="l8.141"> </span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-  close_popup();</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+  close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l8.144"></a><span id="l8.144">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l8.145"></a><span id="l8.145"> }</span>
<a href="#l8.146"></a><span id="l8.146"> </span>
<a href="#l8.147"></a><span id="l8.147"> /**</span>
<a href="#l8.148"></a><span id="l8.148">  * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l8.149"></a><span id="l8.149">  */</span>
<a href="#l8.150"></a><span id="l8.150"> function _middle_click_with_nothing_selected_helper(aBackground) {</span>
<a href="#l8.151"></a><span id="l8.151">   be_in_folder(folder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -50,17 +50,17 @@ var folderInbox, folderVirtual;</span>
<a href="#l9.4"></a><span id="l9.4"> function setupModule(module) {</span>
<a href="#l9.5"></a><span id="l9.5">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l9.6"></a><span id="l9.6">   fdh.installInto(module);</span>
<a href="#l9.7"></a><span id="l9.7">   let wh = collector.getModule('window-helpers');</span>
<a href="#l9.8"></a><span id="l9.8">   wh.installInto(module);</span>
<a href="#l9.9"></a><span id="l9.9"> }</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">- * Add some messages to a folder, delete the first one, and create a saved </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+ * Add some messages to a folder, delete the first one, and create a saved</span>
<a href="#l9.14"></a><span id="l9.14">  * search over the inbox and the folder. Then, compact folders.</span>
<a href="#l9.15"></a><span id="l9.15">  */</span>
<a href="#l9.16"></a><span id="l9.16"> function test_setup_virtual_folder_and_compact() {</span>
<a href="#l9.17"></a><span id="l9.17">   otherFolder = create_folder(&quot;otherFolder&quot;);</span>
<a href="#l9.18"></a><span id="l9.18">   let [msgSet] = make_new_sets_in_folder(otherFolder, [{count: 2}]);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20">   /**</span>
<a href="#l9.21"></a><span id="l9.21">    * We delete the first message in the local folder, so compaction of the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -72,17 +72,19 @@ function test_switch_to_test_mode() {</span>
<a href="#l10.4"></a><span id="l10.4">   assert_folder_visible(folder);</span>
<a href="#l10.5"></a><span id="l10.5"> }</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> /**</span>
<a href="#l10.8"></a><span id="l10.8">  * Open a new 3-pane window while the custom mode is selected, and make sure</span>
<a href="#l10.9"></a><span id="l10.9">  * that the mode displayed in the new window is the custom mode.</span>
<a href="#l10.10"></a><span id="l10.10">  */</span>
<a href="#l10.11"></a><span id="l10.11"> function test_open_new_window_with_custom_mode() {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  // Our selection may get lost while changing modes, and be_in_folder is</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  // not sufficient to ensure actual selection.</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  mc.folderTreeView.selectFolder(folder);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">   plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l10.18"></a><span id="l10.18">   mc.window.MsgOpenNewWindowForFolder(null, -1);</span>
<a href="#l10.19"></a><span id="l10.19">   let mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   assert_folder_mode(kTestModeID, mc2);</span>
<a href="#l10.22"></a><span id="l10.22">   assert_folder_visible(folder, mc2);</span>
<a href="#l10.23"></a><span id="l10.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -329,23 +329,23 @@ function test_add_contact_from_context_m</span>
<a href="#l11.4"></a><span id="l11.4">     throw new Error(&quot;addToAddressBookItem is hidden for unknown contact&quot;);</span>
<a href="#l11.5"></a><span id="l11.5">   var editContactItem = mc.window.document.getElementById(&quot;editContactItem&quot;);</span>
<a href="#l11.6"></a><span id="l11.6">   if (!editContactItem.getAttribute(&quot;hidden&quot;))</span>
<a href="#l11.7"></a><span id="l11.7">     throw new Error(&quot;editContactItem is NOT hidden for unknown contact&quot;);</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   // Click the Add to Address Book context menu entry.</span>
<a href="#l11.10"></a><span id="l11.10">   mc.click(mc.eid(&quot;addToAddressBookItem&quot;));</span>
<a href="#l11.11"></a><span id="l11.11">   // (for reasons unknown, the pop-up does not close itself)</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  close_popup();</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  close_popup(mc, mc.eid(&quot;emailAddressPopup&quot;));</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">   // Now click the contact again, the context menu should now show the</span>
<a href="#l11.16"></a><span id="l11.16">   // Edit Contact menu instead.</span>
<a href="#l11.17"></a><span id="l11.17">   mc.click(mc.aid(&quot;expandedfromBox&quot;, {tagName: &quot;mail-emailaddress&quot;}));</span>
<a href="#l11.18"></a><span id="l11.18">   // (for reasons unknown, the pop-up does not close itself)</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  close_popup();</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  close_popup(mc, mc.eid(&quot;emailAddressPopup&quot;));</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">   addToAddressBookItem = mc.window.document.getElementById(&quot;addToAddressBookItem&quot;);</span>
<a href="#l11.23"></a><span id="l11.23">   if (!addToAddressBookItem.hidden)</span>
<a href="#l11.24"></a><span id="l11.24">     throw new Error(&quot;addToAddressBookItem is NOT hidden for known contact&quot;);</span>
<a href="#l11.25"></a><span id="l11.25">   editContactItem = mc.window.document.getElementById(&quot;editContactItem&quot;);</span>
<a href="#l11.26"></a><span id="l11.26">   if (editContactItem.hidden)</span>
<a href="#l11.27"></a><span id="l11.27">     throw new Error(&quot;editContactItem is hidden for known contact&quot;);</span>
<a href="#l11.28"></a><span id="l11.28"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -55,87 +55,106 @@ function setupModule(module) {</span>
<a href="#l12.4"></a><span id="l12.4">   wh.installInto(module);</span>
<a href="#l12.5"></a><span id="l12.5">   let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l12.6"></a><span id="l12.6">   qfb.installInto(module);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8">   folder = create_folder(&quot;QuickFilterBarDisplayIssues&quot;);</span>
<a href="#l12.9"></a><span id="l12.9">   be_in_folder(folder);</span>
<a href="#l12.10"></a><span id="l12.10"> }</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+function resize_to(width, height) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  mark_action(&quot;test&quot;, &quot;resize_to&quot;, [width, &quot;x&quot;, height]);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+  mc.window.resizeTo(width, height);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  // Give the event loop a spin in order to let the reality of an asynchronously</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  //  interacting window manager have its impact.  This still may not be</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+  //  sufficient.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  mc.waitForEval(&quot;subject.outerWidth == &quot; + width + &quot; &amp;&amp; &quot; +</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+                 &quot; subject.outerHeight == &quot; + height,</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+                 1000, 50, mc.window);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+}</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+function collapse_folder_pane(shouldBeCollapsed) {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+  mark_action(&quot;test&quot;, &quot;collapse_folder_pane&quot;,</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+              [shouldBeCollapsed]);</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+  mc.e(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;,</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+                                           shouldBeCollapsed ? &quot;collapsed&quot;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+                                                             : &quot;open&quot;);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+}</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+</span>
<a href="#l12.33"></a><span id="l12.33"> /**</span>
<a href="#l12.34"></a><span id="l12.34">  * When the window gets too narrow the collapsible button labels need to get</span>
<a href="#l12.35"></a><span id="l12.35">  *  gone.  Then they need to come back when we get large enough again.</span>
<a href="#l12.36"></a><span id="l12.36">  *</span>
<a href="#l12.37"></a><span id="l12.37">  * Because the mozmill window sizing is weird and confusing, we force our size</span>
<a href="#l12.38"></a><span id="l12.38">  *  in both cases but do save/restore around our test.</span>
<a href="#l12.39"></a><span id="l12.39">  */</span>
<a href="#l12.40"></a><span id="l12.40"> function test_buttons_collapse_and_expand() {</span>
<a href="#l12.41"></a><span id="l12.41">   assert_quick_filter_bar_visible(true); // precondition</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  try {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-    let qfbCollapsy = mc.e(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-    let qfbExemplarButton = mc.e(&quot;qfb-unread&quot;); // (arbitrary labeled button)</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    let qfbExemplarLabel = mc.window</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-                             .document.getAnonymousNodes(qfbExemplarButton)[1];</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  let qfbCollapsy = mc.e(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  let qfbExemplarButton = mc.e(&quot;qfb-unread&quot;); // (arbitrary labeled button)</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+  let qfbExemplarLabel = mc.window</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+                           .document.getAnonymousNodes(qfbExemplarButton)[1];</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    function logState(aWhen) {</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-      dump(&quot;\n\n*********** &quot; + aWhen + &quot;\n&quot;);</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-      dump(&quot;Current window location: &quot; + mc.window.screenX + &quot;, &quot; +</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-           mc.window.screenY + &quot;\n&quot;);</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-      dump(&quot;Current window dimensions: &quot; + mc.window.outerWidth + &quot;, &quot; +</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-           mc.window.outerHeight + &quot;\n&quot;);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-      dump(&quot;Collapsy bar width: &quot; + qfbCollapsy.clientWidth + &quot;\n&quot;);</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-      dump(&quot;***********\n\n&quot;);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-    }</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+  function logState(aWhen) {</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+    mark_action(&quot;test&quot;, &quot;log_window_state&quot;,</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+                [aWhen,</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+                 &quot;location:&quot;, mc.window.screenX, mc.window.screenY,</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+                 &quot;dims:&quot;, mc.window.outerWidth, mc.window.outerHeight,</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+                 &quot;Collapsy bar width:&quot;, qfbCollapsy.clientWidth,</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+                 &quot;shrunk?&quot;, qfbCollapsy.getAttribute(&quot;shrink&quot;)]);</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+  }</span>
<a href="#l12.70"></a><span id="l12.70"> </span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-    function assertCollapsed() {</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-      // The bar should be shrunken and the button should be the same size as its</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-      // image!</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-      if (qfbCollapsy.getAttribute(&quot;shrink&quot;) != &quot;true&quot;)</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-        throw new Error(&quot;The collapsy bar should be shrunk!&quot;);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-      if (qfbExemplarLabel.clientWidth != 0)</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-        throw new Error(&quot;The exemplar label should be collapsed!&quot;);</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-    }</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-    function assertExpanded() {</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-      // The bar should not be shrunken and the button should be smaller than its</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-      // label!</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-      if (qfbCollapsy.hasAttribute(&quot;shrink&quot;))</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-        throw new Error(&quot;The collapsy bar should not be shrunk!&quot;);</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-      if (qfbExemplarLabel.clientWidth == 0)</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-        throw new Error(&quot;The exemplar label should not be collapsed!&quot;);</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-    }</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  function assertCollapsed() {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    // The bar should be shrunken and the button should be the same size as its</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+    // image!</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+    if (qfbCollapsy.getAttribute(&quot;shrink&quot;) != &quot;true&quot;)</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+      throw new Error(&quot;The collapsy bar should be shrunk!&quot;);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    if (qfbExemplarLabel.clientWidth != 0)</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+      throw new Error(&quot;The exemplar label should be collapsed!&quot;);</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  }</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+  function assertExpanded() {</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+    // The bar should not be shrunken and the button should be smaller than its</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+    // label!</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+    if (qfbCollapsy.hasAttribute(&quot;shrink&quot;))</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+      throw new Error(&quot;The collapsy bar should not be shrunk!&quot;);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+    if (qfbExemplarLabel.clientWidth == 0)</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+      throw new Error(&quot;The exemplar label should not be collapsed!&quot;);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+  }</span>
<a href="#l12.103"></a><span id="l12.103"> </span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-    logState(&quot;entry&quot;);</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  logState(&quot;entry&quot;);</span>
<a href="#l12.106"></a><span id="l12.106"> </span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    // -- GIANT!</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-    mc.window.resizeTo(1200, 600);</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-    // Right, so resizeTo caps us at the display size limit, so we may end up</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-    // smaller than we want.  So let's turn off the folder pane too.</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-    mc.e(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;, &quot;collapsed&quot;);</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-    // spin the event loop once</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-    mc.sleep(0);</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-    logState(&quot;giant&quot;);</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-    assertExpanded();</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+  // -- GIANT!</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  resize_to(1200, 600);</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+  // Right, so resizeTo caps us at the display size limit, so we may end up</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  // smaller than we want.  So let's turn off the folder pane too.</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+  collapse_folder_pane(true);</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  // spin the event loop once</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  logState(&quot;giant&quot;);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+  assertExpanded();</span>
<a href="#l12.125"></a><span id="l12.125"> </span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-    // -- tiny.</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-    mc.e(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">-    mc.window.resizeTo(600, 600);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">-    // spin the event loop once</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">-    mc.sleep(0);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">-    logState(&quot;tiny&quot;);</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-    assertCollapsed();</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+  // -- tiny.</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+  collapse_folder_pane(false);</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+  resize_to(600, 600);</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+  // spin the event loop once</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+  logState(&quot;tiny&quot;);</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  assertCollapsed();</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-    // -- GIANT again!</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-    mc.window.resizeTo(1200, 600);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-    mc.e(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;, &quot;collapsed&quot;);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-    // spin the event loop once</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-    mc.sleep(0);</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-    logState(&quot;giant again!&quot;);</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-    assertExpanded();</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-  }</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-  finally {</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-    // restore window to nominal dimensions; saving was not working out</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-    //  See also: message-header/test-message-header.js if we change the</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-    //            default window size.</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-    mc.window.resizeTo(1024, 768);</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-    mc.e(&quot;folderpane_splitter&quot;).setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-  }</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+  // -- GIANT again!</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+  resize_to(1200, 600);</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+  collapse_folder_pane(true);</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+  // spin the event loop once</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+  mc.sleep(0);</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+  logState(&quot;giant again!&quot;);</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  assertExpanded();</span>
<a href="#l12.163"></a><span id="l12.163"> }</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+function teardownModule() {</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+  // restore window to nominal dimensions; saving was not working out</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  //  See also: message-header/test-message-header.js if we change the</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  //            default window size.</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+  resize_to(1024, 768);</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+  collapse_folder_pane(false);</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -305,17 +305,18 @@ class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l13.4"></a><span id="l13.4">         jsbridge.CLI.__init__(self, *args, **kwargs)</span>
<a href="#l13.5"></a><span id="l13.5">         SYMBOLS_PATH = self.options.symbols</span>
<a href="#l13.6"></a><span id="l13.6">         TEST_NAME = os.path.basename(self.options.test)</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">         self._load_wrapper()</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">         self.mozmill = self.mozmill_class(runner_class=self.runner_class,</span>
<a href="#l13.11"></a><span id="l13.11">                                           profile_class=self.profile_class,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-                                          jsbridge_port=int(self.options.port))</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+                                          jsbridge_port=int(self.options.port),</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+                                          jsbridge_timeout=300)</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16">         self.mozmill.add_global_listener(mozmill.LoggerListener())</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18">     def _load_wrapper(self):</span>
<a href="#l13.19"></a><span id="l13.19">         global wrapper</span>
<a href="#l13.20"></a><span id="l13.20">         &quot;&quot;&quot;</span>
<a href="#l13.21"></a><span id="l13.21">         Load the wrapper module if it is present in the test directory.</span>
<a href="#l13.22"></a><span id="l13.22">         &quot;&quot;&quot;</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineat">@@ -335,31 +336,37 @@ class ThunderTestCLI(mozmill.CLI):</span>
<a href="#l13.24"></a><span id="l13.24">             finally:</span>
<a href="#l13.25"></a><span id="l13.25">                 if fd is not None:</span>
<a href="#l13.26"></a><span id="l13.26">                     fd.close()</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> TEST_RESULTS = []</span>
<a href="#l13.29"></a><span id="l13.29"> # Versions of MozMill prior to 1.5 did not output test-pass /</span>
<a href="#l13.30"></a><span id="l13.30"> # TEST-UNEXPECTED-FAIL. Since 1.5 happened this gets output, so we only want</span>
<a href="#l13.31"></a><span id="l13.31"> # a summary at the end to make it easy for developers.</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-# override mozmill's default logging case, which I hate.</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-def logFailure(obj):</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    if isinstance(obj, basestring):</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-        obj = json.loads(obj)</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    FAILURE_LIST.append(obj)</span>
<a href="#l13.37"></a><span id="l13.37"> def logEndTest(obj):</span>
<a href="#l13.38"></a><span id="l13.38">     # If we've got a string here, we know we're later than 1.5, and we can just</span>
<a href="#l13.39"></a><span id="l13.39">     # display a summary at the end as 1.5 will do TEST-UNEXPECTED-FAIL for us.</span>
<a href="#l13.40"></a><span id="l13.40">     if isinstance(obj, str):</span>
<a href="#l13.41"></a><span id="l13.41">         obj = json.loads(obj)</span>
<a href="#l13.42"></a><span id="l13.42">         obj['summary'] = True</span>
<a href="#l13.43"></a><span id="l13.43">     TEST_RESULTS.append(obj)</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-#mozmill.LoggerListener.cases['mozmill.fail'] = logFailure</span>
<a href="#l13.45"></a><span id="l13.45"> mozmill.LoggerListener.cases['mozmill.endTest'] = logEndTest</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+# We now send extended meta-data about failures.  We do not want the entire</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+# message dumped with this extra data, so clobber the default mozmill.fail</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+# with one that wraps it and only tells it the exception message rather than</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+# the whole JSON blob.</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+ORIGINAL_FAILURE_LOGGER = mozmill.LoggerListener.cases['mozmill.fail']</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+def logFailure(obj):</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    if isinstance(obj, basestring):</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+        obj = json.loads(obj)</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+    ORIGINAL_FAILURE_LOGGER(obj[&quot;exception&quot;][&quot;message&quot;])</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+mozmill.LoggerListener.cases['mozmill.fail'] = logFailure</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+</span>
<a href="#l13.59"></a><span id="l13.59"> def prettifyFilename(path):</span>
<a href="#l13.60"></a><span id="l13.60">     lslash = path.rfind('/')</span>
<a href="#l13.61"></a><span id="l13.61">     if lslash != -1:</span>
<a href="#l13.62"></a><span id="l13.62">         return path[lslash+1:]</span>
<a href="#l13.63"></a><span id="l13.63">     else:</span>
<a href="#l13.64"></a><span id="l13.64">         return path</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66"> def prettyPrintException(e):</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineat">@@ -388,34 +395,43 @@ def prettyPrintException(e):</span>
<a href="#l13.68"></a><span id="l13.68">                 print '      ', funcname, prettifyFilename(path), line</span>
<a href="#l13.69"></a><span id="l13.69">             else:</span>
<a href="#l13.70"></a><span id="l13.70">                 print '           ', prettifyFilename(path), line</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73"> # Tests that are useless and shouldn't be printed if successful</span>
<a href="#l13.74"></a><span id="l13.74"> TEST_BLACKLIST = [&quot;setupModule&quot;, &quot;setupTest&quot;, &quot;teardownTest&quot;, &quot;teardownModule&quot;]</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-import pprint</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+import pprint, atexit</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+@atexit.register</span>
<a href="#l13.79"></a><span id="l13.79"> def prettyPrintResults():</span>
<a href="#l13.80"></a><span id="l13.80">     for result in TEST_RESULTS:</span>
<a href="#l13.81"></a><span id="l13.81">         #pprint.pprint(result)</span>
<a href="#l13.82"></a><span id="l13.82">         testOrSummary = 'TEST'</span>
<a href="#l13.83"></a><span id="l13.83">         if 'summary' in result:</span>
<a href="#l13.84"></a><span id="l13.84">             testOrSummary = 'SUMMARY'</span>
<a href="#l13.85"></a><span id="l13.85">         if len(result['fails']) == 0:</span>
<a href="#l13.86"></a><span id="l13.86">             if result['name'] not in TEST_BLACKLIST:</span>
<a href="#l13.87"></a><span id="l13.87">                 print '%s-PASS | %s' % (testOrSummary, result['name'])</span>
<a href="#l13.88"></a><span id="l13.88">         else:</span>
<a href="#l13.89"></a><span id="l13.89">             print '%s-UNEXPECTED-FAIL | %s | %s' % (testOrSummary, prettifyFilename(result['filename']), result['name'])</span>
<a href="#l13.90"></a><span id="l13.90">         for failure in result['fails']:</span>
<a href="#l13.91"></a><span id="l13.91">             if 'exception' in failure:</span>
<a href="#l13.92"></a><span id="l13.92">                 prettyPrintException(failure['exception'])</span>
<a href="#l13.93"></a><span id="l13.93"> </span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-import atexit</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-atexit.register(prettyPrintResults)</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+@atexit.register</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+def dumpRichResults():</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+    print '##### MOZMILL-RICH-FAILURES-BEGIN #####'</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+    for result in TEST_RESULTS:</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+        if len(result['fails']) &gt; 0:</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+            for failure in result['fails']:</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+                failure['fileName'] = prettifyFilename(result['filename'])</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+                failure['testName'] = result['name']</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+                print json.dumps(failure)</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+    print '##### MOZMILL-RICH-FAILURES-END #####'</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107"> def checkCrashesAtExit():</span>
<a href="#l13.108"></a><span id="l13.108">     if checkForCrashes(os.path.join(PROFILE_DIR, 'minidumps'), SYMBOLS_PATH,</span>
<a href="#l13.109"></a><span id="l13.109">                        TEST_NAME):</span>
<a href="#l13.110"></a><span id="l13.110">         print &gt;&gt; sys.stderr, 'TinderboxPrint: ' + TEST_NAME + '&lt;br/&gt;&lt;em class=&quot;testfail&quot;&gt;CRASH&lt;/em&gt;'</span>
<a href="#l13.111"></a><span id="l13.111">         sys.exit(1)</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113"> if __name__ == '__main__':</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -140,16 +140,17 @@ function test_go_search() {</span>
<a href="#l14.4"></a><span id="l14.4">  */</span>
<a href="#l14.5"></a><span id="l14.5"> function test_open_single_search_result_in_tab() {</span>
<a href="#l14.6"></a><span id="l14.6">   swc.window.focus();</span>
<a href="#l14.7"></a><span id="l14.7">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l14.8"></a><span id="l14.8">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l14.9"></a><span id="l14.9">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11">   // Select one message</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+  swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l14.13"></a><span id="l14.13">   let msgHdr = select_click_row(1, swc);</span>
<a href="#l14.14"></a><span id="l14.14">   // Open the selected message</span>
<a href="#l14.15"></a><span id="l14.15">   open_selected_message(swc);</span>
<a href="#l14.16"></a><span id="l14.16">   // This is going to trigger a message display in the main 3pane window</span>
<a href="#l14.17"></a><span id="l14.17">   wait_for_message_display_completion(mc);</span>
<a href="#l14.18"></a><span id="l14.18">   // Check that the tab count has increased by 1</span>
<a href="#l14.19"></a><span id="l14.19">   assert_number_of_tabs_open(preCount + 1);</span>
<a href="#l14.20"></a><span id="l14.20">   // Check that the currently displayed tab is a message tab (i.e. our newly</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -168,16 +169,17 @@ function test_open_single_search_result_</span>
<a href="#l14.22"></a><span id="l14.22">  */</span>
<a href="#l14.23"></a><span id="l14.23"> function test_open_multiple_search_results_in_new_tabs() {</span>
<a href="#l14.24"></a><span id="l14.24">   swc.window.focus();</span>
<a href="#l14.25"></a><span id="l14.25">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l14.26"></a><span id="l14.26">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l14.27"></a><span id="l14.27">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   // Select a bunch of messages</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l14.31"></a><span id="l14.31">   select_click_row(1, swc);</span>
<a href="#l14.32"></a><span id="l14.32">   let selectedMessages = select_shift_click_row(NUM_MESSAGES_TO_OPEN, swc);</span>
<a href="#l14.33"></a><span id="l14.33">   // Open them</span>
<a href="#l14.34"></a><span id="l14.34">   open_selected_messages(swc);</span>
<a href="#l14.35"></a><span id="l14.35">   // This is going to trigger a message display in the main 3pane window</span>
<a href="#l14.36"></a><span id="l14.36">   wait_for_message_display_completion(mc, true);</span>
<a href="#l14.37"></a><span id="l14.37">   // Check that the tab count has increased by the correct number</span>
<a href="#l14.38"></a><span id="l14.38">   assert_number_of_tabs_open(preCount + NUM_MESSAGES_TO_OPEN);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineat">@@ -204,16 +206,17 @@ function test_open_multiple_search_resul</span>
<a href="#l14.40"></a><span id="l14.40"> /**</span>
<a href="#l14.41"></a><span id="l14.41">  * Test opening a search result in a new window.</span>
<a href="#l14.42"></a><span id="l14.42">  */</span>
<a href="#l14.43"></a><span id="l14.43"> function test_open_search_result_in_new_window() {</span>
<a href="#l14.44"></a><span id="l14.44">   swc.window.focus();</span>
<a href="#l14.45"></a><span id="l14.45">   set_open_message_behavior(&quot;NEW_WINDOW&quot;);</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   // Select a message</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+  swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l14.49"></a><span id="l14.49">   let msgHdr = select_click_row(1, swc);</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l14.52"></a><span id="l14.52">   // Open it</span>
<a href="#l14.53"></a><span id="l14.53">   open_selected_message(swc);</span>
<a href="#l14.54"></a><span id="l14.54">   let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l14.55"></a><span id="l14.55">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57" class="difflineat">@@ -226,16 +229,17 @@ function test_open_search_result_in_new_</span>
<a href="#l14.58"></a><span id="l14.58"> /**</span>
<a href="#l14.59"></a><span id="l14.59">  * Test reusing an existing window to open another search result.</span>
<a href="#l14.60"></a><span id="l14.60">  */</span>
<a href="#l14.61"></a><span id="l14.61"> function test_open_search_result_in_existing_window() {</span>
<a href="#l14.62"></a><span id="l14.62">   swc.window.focus();</span>
<a href="#l14.63"></a><span id="l14.63">   set_open_message_behavior(&quot;EXISTING_WINDOW&quot;);</span>
<a href="#l14.64"></a><span id="l14.64"> </span>
<a href="#l14.65"></a><span id="l14.65">   // Open up a window</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l14.67"></a><span id="l14.67">   select_click_row(1, swc);</span>
<a href="#l14.68"></a><span id="l14.68">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l14.69"></a><span id="l14.69">   open_selected_message(swc);</span>
<a href="#l14.70"></a><span id="l14.70">   let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l14.71"></a><span id="l14.71">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l14.72"></a><span id="l14.72"> </span>
<a href="#l14.73"></a><span id="l14.73">   // Select another message and open it</span>
<a href="#l14.74"></a><span id="l14.74">   let msgHdr = select_click_row(2, swc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -72,20 +72,17 @@ function installInto(module) {</span>
<a href="#l15.4"></a><span id="l15.4">  *</span>
<a href="#l15.5"></a><span id="l15.5">  * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l15.6"></a><span id="l15.6">  */</span>
<a href="#l15.7"></a><span id="l15.7"> function open_advanced_settings(aCallback, aController) {</span>
<a href="#l15.8"></a><span id="l15.8">   if (aController === undefined)</span>
<a href="#l15.9"></a><span id="l15.9">     aController = mc;</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11">   wh.plan_for_modal_dialog(&quot;mailnews:accountmanager&quot;, aCallback);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  if (mozmill.isLinux)</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    aController.click(new elib.Elem(mc.menus.menu_Edit.menu_accountmgr));</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-  else</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-    aController.click(new elib.Elem(mc.menus.tasksMenu.menu_accountmgr));</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+  aController.click(mc.eid(&quot;menu_accountmgr&quot;));</span>
<a href="#l15.17"></a><span id="l15.17">   return wh.wait_for_modal_dialog(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l15.18"></a><span id="l15.18"> }</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> /**</span>
<a href="#l15.21"></a><span id="l15.21">  * Opens the Account Manager from the mail account setup wizard.</span>
<a href="#l15.22"></a><span id="l15.22">  *</span>
<a href="#l15.23"></a><span id="l15.23">  * @param callback Callback for the modal dialog that is opened.</span>
<a href="#l15.24"></a><span id="l15.24">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -46,16 +46,18 @@ var mozmill = {};</span>
<a href="#l16.4"></a><span id="l16.4"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l16.5"></a><span id="l16.5"> var controller = {};</span>
<a href="#l16.6"></a><span id="l16.6"> Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l16.7"></a><span id="l16.7"> var frame = {};</span>
<a href="#l16.8"></a><span id="l16.8"> Cu.import('resource://mozmill/modules/frame.js', frame);</span>
<a href="#l16.9"></a><span id="l16.9"> var os = {};</span>
<a href="#l16.10"></a><span id="l16.10"> Cu.import('resource://mozmill/stdlib/os.js', os);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+</span>
<a href="#l16.14"></a><span id="l16.14"> const MODULE_NAME = 'folder-display-helpers';</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> const RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l16.17"></a><span id="l16.17"> // we need window-helpers for augment_controller</span>
<a href="#l16.18"></a><span id="l16.18"> const MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> const nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l16.21"></a><span id="l16.21"> Cu.import('resource:///modules/MailUtils.js');</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -140,37 +142,87 @@ function setupModule() {</span>
<a href="#l16.23"></a><span id="l16.23">     do_throw: function(aMsg) {</span>
<a href="#l16.24"></a><span id="l16.24">       throw new Error(aMsg);</span>
<a href="#l16.25"></a><span id="l16.25">     },</span>
<a href="#l16.26"></a><span id="l16.26">     do_check_eq: function() {},</span>
<a href="#l16.27"></a><span id="l16.27">     do_check_neq: function() {},</span>
<a href="#l16.28"></a><span id="l16.28">     gDEPTH: &quot;../../&quot;,</span>
<a href="#l16.29"></a><span id="l16.29">   };</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+  // -- logging</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+</span>
<a href="#l16.33"></a><span id="l16.33">   // The xpcshell test resources assume they are loaded into a single global</span>
<a href="#l16.34"></a><span id="l16.34">   //  namespace, so we need to help them out to maintain their delusion.</span>
<a href="#l16.35"></a><span id="l16.35">   load_via_src_path('logHelper.js', testHelperModule);</span>
<a href="#l16.36"></a><span id="l16.36">   mark_action = testHelperModule.mark_action;</span>
<a href="#l16.37"></a><span id="l16.37">   mark_failure = testHelperModule.mark_failure;</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  // Hook-up logHelper to the mozmill event system...</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+  // Remove the dump appender that got appended; it just adds noise.</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+  testHelperModule._testLogger._appenders.splice(</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+    testHelperModule._testLogger._appenders.length - 1, 1);</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+  // Add a bucketing appender to the root.</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+  let rootLogger = Log4Moz.repository.rootLogger;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+  let bucketAppender = new Log4Moz.TimeAwareMemoryBucketAppender();</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+  bucketAppender.level = Log4Moz.Level.All;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+  rootLogger.addAppender(bucketAppender);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  // Indicate to any fancy helpers (just folderEventLogHelper right now) that</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  //  we want them to log extra stuff.</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+  testHelperModule._logHelperInterestedListeners = true;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  // - Hook-up logHelper to the mozmill event system...</span>
<a href="#l16.55"></a><span id="l16.55">   let curTestFile = null;</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+  // Listen for setTest so we can change buckets and generate logHelper test</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+  //  begin/end notifications.</span>
<a href="#l16.58"></a><span id="l16.58">   frame.events.addListener(&quot;setTest&quot;, function(obj) {</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+      // ignore setupModule and teardownModule</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+      if (obj.name == &quot;setupModule&quot; ||</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+          obj.name == &quot;teardownModule&quot;)</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+        return;</span>
<a href="#l16.63"></a><span id="l16.63">       if (obj.filename != curTestFile) {</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+        testHelperModule.mark_test_end();  </span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+        bucketAppender.newBucket();</span>
<a href="#l16.66"></a><span id="l16.66">         testHelperModule.mark_test_start(obj.filename);</span>
<a href="#l16.67"></a><span id="l16.67">         curTestFile = obj.filename;</span>
<a href="#l16.68"></a><span id="l16.68">       }</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+      else {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+        testHelperModule.mark_test_end(1);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+        bucketAppender.newBucket();</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+      }</span>
<a href="#l16.73"></a><span id="l16.73">       testHelperModule.mark_sub_test_start(obj.name);</span>
<a href="#l16.74"></a><span id="l16.74">     });</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+  // Listen for the fail event so that we can annotate the failure object</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  //  with additional metadata.  This works out because we are directly handed</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  //  a reference to the object that will be provided to the jsbridge and we</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  //  can mutate it.  (The jsbridge is a global listener and so is guaranteed</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  //  to be invoked after our specific named listener.)</span>
<a href="#l16.80"></a><span id="l16.80">   frame.events.addListener(&quot;fail&quot;, function(obj) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+      // generate the failure notification now so it shows up in the event log</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+      //  bucket for presentation purposes.</span>
<a href="#l16.83"></a><span id="l16.83">       testHelperModule._xpcshellLogger.info(</span>
<a href="#l16.84"></a><span id="l16.84">         testHelperModule._testLoggerActiveContext,</span>
<a href="#l16.85"></a><span id="l16.85">         new testHelperModule._Failure(obj.exception.message, obj.exception));</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+      try {</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+        obj.failureContext = {</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+          preEvents: bucketAppender.getPreviousBucketEvents(10000),</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+          events: bucketAppender.getBucketEvents(),</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+          windows: windowHelper.captureWindowStatesForErrorReporting(</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+                     testHelperModule._normalize_for_json),</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+        };</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+      }</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+      catch(ex) {</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+        dump(&quot;!!!!!!!!EX: &quot; + ex);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+        mark_action(&quot;fdh&quot;, &quot;fail fail marking!&quot;, [ex]);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+      }</span>
<a href="#l16.99"></a><span id="l16.99">     });</span>
<a href="#l16.100"></a><span id="l16.100"> </span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+  // -- the rest of the asyncTestUtils framework (but not actually async)</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+</span>
<a href="#l16.103"></a><span id="l16.103">   load_via_src_path('asyncTestUtils.js', testHelperModule);</span>
<a href="#l16.104"></a><span id="l16.104">   load_via_src_path('messageGenerator.js', testHelperModule);</span>
<a href="#l16.105"></a><span id="l16.105">   load_via_src_path('messageModifier.js', testHelperModule);</span>
<a href="#l16.106"></a><span id="l16.106">   load_via_src_path('messageInjection.js', testHelperModule);</span>
<a href="#l16.107"></a><span id="l16.107">   load_via_src_path('viewWrapperTestUtils.js', testHelperModule);</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109">   // provide super helpful folder event info (when logHelper cares)</span>
<a href="#l16.110"></a><span id="l16.110">   load_via_src_path('folderEventLogHelper.js', testHelperModule);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineat">@@ -191,16 +243,25 @@ function setupModule() {</span>
<a href="#l16.112"></a><span id="l16.112">   delete_message_set = testHelperModule.async_delete_messages;</span>
<a href="#l16.113"></a><span id="l16.113"> </span>
<a href="#l16.114"></a><span id="l16.114">   // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l16.115"></a><span id="l16.115">   //  we need.</span>
<a href="#l16.116"></a><span id="l16.116">   windowHelper = collector.getModule('window-helpers');</span>
<a href="#l16.117"></a><span id="l16.117">   mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l16.118"></a><span id="l16.118">   windowHelper.augment_controller(mc);</span>
<a href="#l16.119"></a><span id="l16.119"> </span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  // Tell window-helper about the true mark_action function in order to try</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+  // and further complicate this horrid seven-dimensional rats' nest.</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+  windowHelper.hereIsMarkAction(mark_action,</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+                                testHelperModule._normalize_for_json);</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;startup completed&quot;,</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+              [(mc.window.msgWindow != null) ? &quot;3pane looks initialized&quot;</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+               : &quot;3pane does not appear to have fully loaded yet!&quot;]);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+</span>
<a href="#l16.129"></a><span id="l16.129">   setupAccountStuff();</span>
<a href="#l16.130"></a><span id="l16.130"> }</span>
<a href="#l16.131"></a><span id="l16.131"> </span>
<a href="#l16.132"></a><span id="l16.132"> /**</span>
<a href="#l16.133"></a><span id="l16.133">  * Install this module into the provided module.</span>
<a href="#l16.134"></a><span id="l16.134">  */</span>
<a href="#l16.135"></a><span id="l16.135"> function installInto(module) {</span>
<a href="#l16.136"></a><span id="l16.136">   setupModule();</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineat">@@ -284,31 +345,41 @@ function teardownImporter(customTeardown</span>
<a href="#l16.138"></a><span id="l16.138">       if (!mc || mc.window.closed)</span>
<a href="#l16.139"></a><span id="l16.139">         mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l16.140"></a><span id="l16.140">     }</span>
<a href="#l16.141"></a><span id="l16.141"> </span>
<a href="#l16.142"></a><span id="l16.142">     // Run through all open windows, closing any that aren't assigned to mc.</span>
<a href="#l16.143"></a><span id="l16.143">     let enumerator = windowMediator.getEnumerator(null);</span>
<a href="#l16.144"></a><span id="l16.144">     while (enumerator.hasMoreElements()) {</span>
<a href="#l16.145"></a><span id="l16.145">       let win = enumerator.getNext();</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineminus">-      if (win != mc.window)</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+      if (win != mc.window) {</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+        mark_action(&quot;fdh&quot;, &quot;teardown&quot;,</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+                    [&quot;cleanup closing non-mc window&quot;, win.toString(),</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+                     &quot;window type&quot;,</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+                     windowHelper.getWindowTypeForXulWindow(win)]);</span>
<a href="#l16.152"></a><span id="l16.152">         win.close();</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+      }</span>
<a href="#l16.154"></a><span id="l16.154">     }</span>
<a href="#l16.155"></a><span id="l16.155"> </span>
<a href="#l16.156"></a><span id="l16.156">     // At this point we should have exactly one window open.</span>
<a href="#l16.157"></a><span id="l16.157">     // - Close all tabs other than the first one.</span>
<a href="#l16.158"></a><span id="l16.158">     mc.tabmail.closeOtherTabs(mc.tabmail.tabInfo[0]);</span>
<a href="#l16.159"></a><span id="l16.159"> </span>
<a href="#l16.160"></a><span id="l16.160">     // - Set the mode to All Folders.</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-    if (mc.folderTreeView.mode != &quot;all&quot;)</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+    if (mc.folderTreeView.mode != &quot;all&quot;) {</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+      mark_action(&quot;fdh&quot;, &quot;teardown&quot;,</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+                  [&quot;resetting folderTreeView mode&quot;, mc.folderTreeView.mode]);</span>
<a href="#l16.165"></a><span id="l16.165">       mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+    }</span>
<a href="#l16.167"></a><span id="l16.167"> </span>
<a href="#l16.168"></a><span id="l16.168">     // - Make sure the message pane is visible.</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineminus">-    if (mc.window.IsMessagePaneCollapsed())</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+    if (mc.window.IsMessagePaneCollapsed()) {</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+      mark_action(&quot;fdh&quot;, &quot;teardown&quot;, [&quot;toggling message pane on again&quot;]);</span>
<a href="#l16.172"></a><span id="l16.172">       mc.window.MsgToggleMessagePane();</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+    }</span>
<a href="#l16.174"></a><span id="l16.174">   };</span>
<a href="#l16.175"></a><span id="l16.175">   // Another internal mozmill thing, again figured out too early for it to have</span>
<a href="#l16.176"></a><span id="l16.176">   // a chance.</span>
<a href="#l16.177"></a><span id="l16.177">   teardownModule.__name__ = &quot;teardownModule&quot;;</span>
<a href="#l16.178"></a><span id="l16.178">   return teardownModule;</span>
<a href="#l16.179"></a><span id="l16.179"> }</span>
<a href="#l16.180"></a><span id="l16.180"> </span>
<a href="#l16.181"></a><span id="l16.181"> /*</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineat">@@ -443,20 +514,20 @@ function open_folder_in_new_tab(aFolder)</span>
<a href="#l16.183"></a><span id="l16.183">  *</span>
<a href="#l16.184"></a><span id="l16.184">  * Since we don't know where this is going to trigger a message load, you're</span>
<a href="#l16.185"></a><span id="l16.185">  * going to have to wait for message display completion yourself.</span>
<a href="#l16.186"></a><span id="l16.186">  *</span>
<a href="#l16.187"></a><span id="l16.187">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l16.188"></a><span id="l16.188">  *     |mc| if omitted.</span>
<a href="#l16.189"></a><span id="l16.189">  */</span>
<a href="#l16.190"></a><span id="l16.190"> function open_selected_messages(aController) {</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.193"></a><span id="l16.193">     aController = mc;</span>
<a href="#l16.194"></a><span id="l16.194">   // Focus the thread tree</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-  aController.threadTree.focus();</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+  focus_thread_tree();</span>
<a href="#l16.197"></a><span id="l16.197">   mark_action(&quot;fdh&quot;, &quot;open_selected_messages&quot;,</span>
<a href="#l16.198"></a><span id="l16.198">               mc.folderDisplay.selectedMessages);</span>
<a href="#l16.199"></a><span id="l16.199">   // Open whatever's selected</span>
<a href="#l16.200"></a><span id="l16.200">   press_enter(aController);</span>
<a href="#l16.201"></a><span id="l16.201"> }</span>
<a href="#l16.202"></a><span id="l16.202"> </span>
<a href="#l16.203"></a><span id="l16.203"> var open_selected_message = open_selected_messages;</span>
<a href="#l16.204"></a><span id="l16.204"> </span>
<a href="#l16.205"></a><span id="l16.205" class="difflineat">@@ -723,17 +794,17 @@ function close_message_window(aControlle</span>
<a href="#l16.206"></a><span id="l16.206">   windowHelper.close_window(aController);</span>
<a href="#l16.207"></a><span id="l16.207"> }</span>
<a href="#l16.208"></a><span id="l16.208"> </span>
<a href="#l16.209"></a><span id="l16.209"> /**</span>
<a href="#l16.210"></a><span id="l16.210">  * Clear the selection.  I'm not sure how we're pretending we did that.</span>
<a href="#l16.211"></a><span id="l16.211">  */</span>
<a href="#l16.212"></a><span id="l16.212"> function select_none(aController) {</span>
<a href="#l16.213"></a><span id="l16.213">   mark_action(&quot;fdh&quot;, &quot;select_none&quot;, []);</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.216"></a><span id="l16.216">     aController = mc;</span>
<a href="#l16.217"></a><span id="l16.217">   wait_for_message_display_completion();</span>
<a href="#l16.218"></a><span id="l16.218">   aController.dbView.selection.clearSelection();</span>
<a href="#l16.219"></a><span id="l16.219">   // Because the selection event may not be generated immediately, we need to</span>
<a href="#l16.220"></a><span id="l16.220">   //  spin until the message display thinks it is not displaying a message,</span>
<a href="#l16.221"></a><span id="l16.221">   //  which is the sign that the event actually happened.</span>
<a href="#l16.222"></a><span id="l16.222">   function noMessageChecker() {</span>
<a href="#l16.223"></a><span id="l16.223">     return aController.messageDisplay.displayedMessage == null;</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineat">@@ -747,17 +818,17 @@ function select_none(aController) {</span>
<a href="#l16.225"></a><span id="l16.225">  * Normalize a view index to be an absolute index, handling slice-style negative</span>
<a href="#l16.226"></a><span id="l16.226">  *  references as well as piercing complex things like message headers and</span>
<a href="#l16.227"></a><span id="l16.227">  *  synthetic message sets.</span>
<a href="#l16.228"></a><span id="l16.228">  *</span>
<a href="#l16.229"></a><span id="l16.229">  * @param aViewIndex An absolute index (integer &gt;= 0), slice-style index (&lt; 0),</span>
<a href="#l16.230"></a><span id="l16.230">  *     or a SyntheticMessageSet (we only care about the first message in it).</span>
<a href="#l16.231"></a><span id="l16.231">  */</span>
<a href="#l16.232"></a><span id="l16.232"> function _normalize_view_index(aViewIndex, aController) {</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.235"></a><span id="l16.235">     aController = mc;</span>
<a href="#l16.236"></a><span id="l16.236">   // SyntheticMessageSet special-case</span>
<a href="#l16.237"></a><span id="l16.237">   if (typeof(aViewIndex) != &quot;number&quot;) {</span>
<a href="#l16.238"></a><span id="l16.238">     let msgHdrIter = aViewIndex.msgHdrs;</span>
<a href="#l16.239"></a><span id="l16.239">     let msgHdr = msgHdrIter.next();</span>
<a href="#l16.240"></a><span id="l16.240">     msgHdrIter.close();</span>
<a href="#l16.241"></a><span id="l16.241">     // do not expand</span>
<a href="#l16.242"></a><span id="l16.242">     aViewIndex = aController.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineat">@@ -776,17 +847,17 @@ function _normalize_view_index(aViewInde</span>
<a href="#l16.244"></a><span id="l16.244">  *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l16.245"></a><span id="l16.245">  *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l16.246"></a><span id="l16.246">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l16.247"></a><span id="l16.247">  *     |mc| if omitted.</span>
<a href="#l16.248"></a><span id="l16.248">  *</span>
<a href="#l16.249"></a><span id="l16.249">  * @return The message header selected.</span>
<a href="#l16.250"></a><span id="l16.250">  */</span>
<a href="#l16.251"></a><span id="l16.251"> function select_click_row(aViewIndex, aController) {</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.254"></a><span id="l16.254">     aController = mc;</span>
<a href="#l16.255"></a><span id="l16.255">   let hasMessageDisplay = &quot;messageDisplay&quot; in aController;</span>
<a href="#l16.256"></a><span id="l16.256">   if (hasMessageDisplay)</span>
<a href="#l16.257"></a><span id="l16.257">     wait_for_message_display_completion(aController);</span>
<a href="#l16.258"></a><span id="l16.258">   aViewIndex = _normalize_view_index(aViewIndex, aController);</span>
<a href="#l16.259"></a><span id="l16.259"> </span>
<a href="#l16.260"></a><span id="l16.260">   mark_action(&quot;fdh&quot;, &quot;select_click_row&quot;, [aViewIndex]);</span>
<a href="#l16.261"></a><span id="l16.261"> </span>
<a href="#l16.262"></a><span id="l16.262" class="difflineat">@@ -851,17 +922,17 @@ function select_control_click_row(aViewI</span>
<a href="#l16.263"></a><span id="l16.263">  *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l16.264"></a><span id="l16.264">  *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l16.265"></a><span id="l16.265">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l16.266"></a><span id="l16.266">  *     |mc| if omitted.</span>
<a href="#l16.267"></a><span id="l16.267">  *</span>
<a href="#l16.268"></a><span id="l16.268">  * @return The message headers for all messages that are now selected.</span>
<a href="#l16.269"></a><span id="l16.269">  */</span>
<a href="#l16.270"></a><span id="l16.270"> function select_shift_click_row(aViewIndex, aController) {</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.273"></a><span id="l16.273">     aController = mc;</span>
<a href="#l16.274"></a><span id="l16.274">   let hasMessageDisplay = &quot;messageDisplay&quot; in aController;</span>
<a href="#l16.275"></a><span id="l16.275">   if (hasMessageDisplay)</span>
<a href="#l16.276"></a><span id="l16.276">     wait_for_message_display_completion(aController);</span>
<a href="#l16.277"></a><span id="l16.277">   aViewIndex = _normalize_view_index(aViewIndex, aController);</span>
<a href="#l16.278"></a><span id="l16.278"> </span>
<a href="#l16.279"></a><span id="l16.279">   // Passing -1 as the start range checks the shift-pivot, which should be -1,</span>
<a href="#l16.280"></a><span id="l16.280">   //  so it should fall over to the current index, which is what we want.  It</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineat">@@ -894,22 +965,32 @@ function _row_click_helper(aTree, aViewI</span>
<a href="#l16.282"></a><span id="l16.282">   let rowY = treeBox.rowHeight * (aViewIndex - treeBox.getFirstVisibleRow());</span>
<a href="#l16.283"></a><span id="l16.283">   if (treeBox.getRowAt(x + rowX, y + rowY) != aViewIndex) {</span>
<a href="#l16.284"></a><span id="l16.284">     throw new Error(&quot;Thought we would find row &quot; + aViewIndex + &quot; at &quot; +</span>
<a href="#l16.285"></a><span id="l16.285">                     rowX + &quot;,&quot; + rowY + &quot; but we found &quot; +</span>
<a href="#l16.286"></a><span id="l16.286">                     treeBox.getRowAt(rowX, rowY));</span>
<a href="#l16.287"></a><span id="l16.287">   }</span>
<a href="#l16.288"></a><span id="l16.288">   let tx = aTree.boxObject.x;</span>
<a href="#l16.289"></a><span id="l16.289">   let ty = aTree.boxObject.y;</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+  // Generate a mouse-down for all click types; the transient selection</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+  // logic happens on mousedown which our tests assume is happening.  (If you</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+  // are using a keybinding to trigger the event, that will not happen, but</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+  // we don't test that.)</span>
<a href="#l16.294"></a><span id="l16.294">   EventUtils.synthesizeMouse(aTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l16.295"></a><span id="l16.295">                              {type: &quot;mousedown&quot;, button: aButton}, mc.window);</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+  // For right-clicks, the platform code generates a &quot;contextmenu&quot; event</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+  // when it sees the mouse press/down event. We are not synthesizing a platform</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+  // level event (though it is in our power; we just historically have not),</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+  // so we need to be the people to create the context menu.</span>
<a href="#l16.301"></a><span id="l16.301">   if (aButton == 2)</span>
<a href="#l16.302"></a><span id="l16.302">     EventUtils.synthesizeMouse(aTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l16.303"></a><span id="l16.303">                                {type: &quot;contextmenu&quot;, button: aButton},</span>
<a href="#l16.304"></a><span id="l16.304">                                mc.window);</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+</span>
<a href="#l16.306"></a><span id="l16.306">   EventUtils.synthesizeMouse(aTree, x + rowX - tx, y + rowY - ty,</span>
<a href="#l16.307"></a><span id="l16.307">                              {type: &quot;mouseup&quot;, button: aButton}, mc.window);</span>
<a href="#l16.308"></a><span id="l16.308"> }</span>
<a href="#l16.309"></a><span id="l16.309"> </span>
<a href="#l16.310"></a><span id="l16.310"> /**</span>
<a href="#l16.311"></a><span id="l16.311">  * Right-click on the tree-view in question.  With any luck, this will have</span>
<a href="#l16.312"></a><span id="l16.312">  *  the side-effect of opening up a pop-up which it is then on _your_ head</span>
<a href="#l16.313"></a><span id="l16.313">  *  to do something with or close.  However, we have helpful popup function</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineat">@@ -956,17 +1037,17 @@ function assert_row_visible(aViewIndex) </span>
<a href="#l16.315"></a><span id="l16.315"> /**</span>
<a href="#l16.316"></a><span id="l16.316">  * Assert that the given folder mode is the current one.</span>
<a href="#l16.317"></a><span id="l16.317">  *</span>
<a href="#l16.318"></a><span id="l16.318">  * @param aMode The expected folder mode.</span>
<a href="#l16.319"></a><span id="l16.319">  * @param [aController] The controller in whose context to do this, defaults to</span>
<a href="#l16.320"></a><span id="l16.320">  *     |mc| if omitted.</span>
<a href="#l16.321"></a><span id="l16.321">  */</span>
<a href="#l16.322"></a><span id="l16.322"> function assert_folder_mode(aMode, aController) {</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.325"></a><span id="l16.325">     aController = mc;</span>
<a href="#l16.326"></a><span id="l16.326">   let actualMode = aController.folderTreeView.mode;</span>
<a href="#l16.327"></a><span id="l16.327">   if (actualMode != aMode)</span>
<a href="#l16.328"></a><span id="l16.328">     throw new Error(&quot;The folder mode should be &quot; + aMode +</span>
<a href="#l16.329"></a><span id="l16.329">                     &quot;, but is actually &quot; + actualMode);</span>
<a href="#l16.330"></a><span id="l16.330"> }</span>
<a href="#l16.331"></a><span id="l16.331"> </span>
<a href="#l16.332"></a><span id="l16.332"> /**</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineat">@@ -988,17 +1069,17 @@ function assert_folder_child_in_view(aCh</span>
<a href="#l16.334"></a><span id="l16.334">  * Assert that the given folder is in the current folder mode and is visible.</span>
<a href="#l16.335"></a><span id="l16.335">  *</span>
<a href="#l16.336"></a><span id="l16.336">  * @param aFolder The folder to assert as visible</span>
<a href="#l16.337"></a><span id="l16.337">  * @param [aController] The controller in whose context to do this, defaults to</span>
<a href="#l16.338"></a><span id="l16.338">  *     |mc| if omitted.</span>
<a href="#l16.339"></a><span id="l16.339">  * @returns The index of the folder, if it is visible.</span>
<a href="#l16.340"></a><span id="l16.340">  */</span>
<a href="#l16.341"></a><span id="l16.341"> function assert_folder_visible(aFolder, aController) {</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.344"></a><span id="l16.344">     aController = mc;</span>
<a href="#l16.345"></a><span id="l16.345">   let folderIndex = aController.folderTreeView.getIndexOfFolder(aFolder);</span>
<a href="#l16.346"></a><span id="l16.346">   if (folderIndex == null)</span>
<a href="#l16.347"></a><span id="l16.347">     throw new Error(&quot;Folder: &quot; + aFolder.URI + &quot; should be visible, but isn't&quot;);</span>
<a href="#l16.348"></a><span id="l16.348"> </span>
<a href="#l16.349"></a><span id="l16.349">   return folderIndex;</span>
<a href="#l16.350"></a><span id="l16.350"> }</span>
<a href="#l16.351"></a><span id="l16.351"> </span>
<a href="#l16.352"></a><span id="l16.352" class="difflineat">@@ -1174,113 +1255,140 @@ function get_smart_folder_named(aFolderN</span>
<a href="#l16.353"></a><span id="l16.353">  */</span>
<a href="#l16.354"></a><span id="l16.354"> function delete_via_popup() {</span>
<a href="#l16.355"></a><span id="l16.355">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l16.356"></a><span id="l16.356">                                  &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l16.357"></a><span id="l16.357">   mark_action(&quot;fdh&quot;, &quot;delete_via_popup&quot;,</span>
<a href="#l16.358"></a><span id="l16.358">               [&quot;selected messages:&quot;, mc.folderDisplay.selectedMessages]);</span>
<a href="#l16.359"></a><span id="l16.359">   mc.click(mc.eid(&quot;mailContext-delete&quot;));</span>
<a href="#l16.360"></a><span id="l16.360">   // for reasons unknown, the pop-up does not close itself?</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineminus">-  close_popup();</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+  close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l16.363"></a><span id="l16.363">   wait_for_folder_events();</span>
<a href="#l16.364"></a><span id="l16.364"> }</span>
<a href="#l16.365"></a><span id="l16.365"> </span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+function wait_for_popup_to_open(popupElem) {</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_popup_to_open&quot;, [popupElem]);</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+  mc.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 50, popupElem);</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+}</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+</span>
<a href="#l16.371"></a><span id="l16.371"> /**</span>
<a href="#l16.372"></a><span id="l16.372">  * Close the open pop-up.</span>
<a href="#l16.373"></a><span id="l16.373">  */</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineminus">-function close_popup(aController) {</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+function close_popup(aController, eid) {</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.378"></a><span id="l16.378">     aController = mc;</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineminus">-  mark_action(&quot;fdh&quot;, &quot;close_popup&quot;, []);</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineminus">-  aController.keypress(aController.eid(&quot;mailContext&quot;), &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineminus">-  // drain event queue</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineminus">-  aController.sleep(0);</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+  let elem = eid.getNode();</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+  // if it was already closing, just leave</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+  if (elem.state == &quot;closed&quot;) {</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+    mark_action(&quot;fdh&quot;, &quot;close_popup&quot;, [&quot;popup suspiciously already closed!&quot;,</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+                                       elem]);</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+    return;</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+  }</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;close_popup&quot;, [elem]);</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+  // if it's in the process of closing, don't push escape</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+  if (elem.state == &quot;hiding&quot;)</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+    mark_action(&quot;fdh&quot;, &quot;close_popup&quot;,</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+                [&quot;popup suspiciously already closing...&quot;]);</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+  else // actually push escape because it's not closing/closed</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+    aController.keypress(eid, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+   if (!controller.waitForEval(&quot;subject.state == 'closed'&quot;, 1000, 50,</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+                               elem))</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+     throw new Error(&quot;Popup did not close!&quot;);</span>
<a href="#l16.400"></a><span id="l16.400"> }</span>
<a href="#l16.401"></a><span id="l16.401"> </span>
<a href="#l16.402"></a><span id="l16.402"> /**</span>
<a href="#l16.403"></a><span id="l16.403">  * Pretend we are pressing the delete key, triggering message deletion of the</span>
<a href="#l16.404"></a><span id="l16.404">  *  selected messages.</span>
<a href="#l16.405"></a><span id="l16.405">  *</span>
<a href="#l16.406"></a><span id="l16.406">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l16.407"></a><span id="l16.407">  *     |mc| if omitted.</span>
<a href="#l16.408"></a><span id="l16.408">  */</span>
<a href="#l16.409"></a><span id="l16.409"> function press_delete(aController) {</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.412"></a><span id="l16.412">     aController = mc;</span>
<a href="#l16.413"></a><span id="l16.413">   // if something is loading, make sure it finishes loading...</span>
<a href="#l16.414"></a><span id="l16.414">   wait_for_message_display_completion(aController);</span>
<a href="#l16.415"></a><span id="l16.415">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l16.416"></a><span id="l16.416">                                  &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l16.417"></a><span id="l16.417">   mark_action(&quot;fdh&quot;, &quot;press_delete&quot;,</span>
<a href="#l16.418"></a><span id="l16.418">               [&quot;selected messages:&quot;,</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineminus">-               aController.folderDisplay.selectedMessages]);</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+               aController.folderDisplay.selectedMessages,</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+               &quot;currently focused element:&quot;,</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+               aController.focusedElement]);</span>
<a href="#l16.423"></a><span id="l16.423">   aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l16.424"></a><span id="l16.424">                        &quot;VK_DELETE&quot;, {});</span>
<a href="#l16.425"></a><span id="l16.425">   wait_for_folder_events();</span>
<a href="#l16.426"></a><span id="l16.426"> }</span>
<a href="#l16.427"></a><span id="l16.427"> </span>
<a href="#l16.428"></a><span id="l16.428"> /**</span>
<a href="#l16.429"></a><span id="l16.429">  * Archive the selected messages, and wait for it to complete.</span>
<a href="#l16.430"></a><span id="l16.430">  *</span>
<a href="#l16.431"></a><span id="l16.431">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l16.432"></a><span id="l16.432">  *     |mc| if omitted.</span>
<a href="#l16.433"></a><span id="l16.433">  */</span>
<a href="#l16.434"></a><span id="l16.434"> function archive_selected_messages(aController) {</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.437"></a><span id="l16.437">     aController = mc;</span>
<a href="#l16.438"></a><span id="l16.438">   let expectedCount = aController.dbView.rowCount - aController.dbView.numSelected;</span>
<a href="#l16.439"></a><span id="l16.439">   // XXX We seem to sometimes have focus issues on trunk; this works around it.</span>
<a href="#l16.440"></a><span id="l16.440">   focus_thread_tree();</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;archive_selected_messages&quot;,</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+              [&quot;selected messages:&quot;,</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+               aController.folderDisplay.selectedMessages,</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+               &quot;currently focused element:&quot;,</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+               aController.focusedElement]);</span>
<a href="#l16.447"></a><span id="l16.447">   aController.keypress(null, &quot;a&quot;, {});</span>
<a href="#l16.448"></a><span id="l16.448"> </span>
<a href="#l16.449"></a><span id="l16.449">   // Wait for the view rowCount to decrease by the number of selected messages.</span>
<a href="#l16.450"></a><span id="l16.450">   let messagesDeletedFromView = function() {</span>
<a href="#l16.451"></a><span id="l16.451">     return aController.dbView.rowCount == expectedCount;</span>
<a href="#l16.452"></a><span id="l16.452">   };</span>
<a href="#l16.453"></a><span id="l16.453">   controller.waitForEval('subject()',</span>
<a href="#l16.454"></a><span id="l16.454">                          NORMAL_TIMEOUT,</span>
<a href="#l16.455"></a><span id="l16.455">                          FAST_INTERVAL, messagesDeletedFromView);</span>
<a href="#l16.456"></a><span id="l16.456">   // The above may return immediately, meaning the event queue might not get a</span>
<a href="#l16.457"></a><span id="l16.457">   //  chance.  give it a chance now.</span>
<a href="#l16.458"></a><span id="l16.458">   aController.sleep(0);</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineminus">-</span>
<a href="#l16.460"></a><span id="l16.460"> }</span>
<a href="#l16.461"></a><span id="l16.461"> </span>
<a href="#l16.462"></a><span id="l16.462"> /**</span>
<a href="#l16.463"></a><span id="l16.463">  * Pretend we are pressing the Enter key, triggering opening selected messages.</span>
<a href="#l16.464"></a><span id="l16.464">  * Note that since we don't know where this is going to trigger a message load,</span>
<a href="#l16.465"></a><span id="l16.465">  * you're going to have to wait for message display completion yourself.</span>
<a href="#l16.466"></a><span id="l16.466">  *</span>
<a href="#l16.467"></a><span id="l16.467">  * @param aController The controller in whose context to do this, defaults to</span>
<a href="#l16.468"></a><span id="l16.468">  *     |mc| if omitted.</span>
<a href="#l16.469"></a><span id="l16.469">  */</span>
<a href="#l16.470"></a><span id="l16.470"> function press_enter(aController) {</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.473"></a><span id="l16.473">     aController = mc;</span>
<a href="#l16.474"></a><span id="l16.474">   // if something is loading, make sure it finishes loading...</span>
<a href="#l16.475"></a><span id="l16.475">   if (&quot;messageDisplay&quot; in aController)</span>
<a href="#l16.476"></a><span id="l16.476">     wait_for_message_display_completion(aController);</span>
<a href="#l16.477"></a><span id="l16.477">   mark_action(&quot;fdh&quot;, &quot;press_enter&quot;,</span>
<a href="#l16.478"></a><span id="l16.478">               [&quot;selected messages:&quot;,</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineminus">-               aController.folderDisplay.selectedMessages]);</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+               aController.folderDisplay.selectedMessages,</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+               &quot;currently focused element:&quot;,</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+               aController.focusedElement]);</span>
<a href="#l16.483"></a><span id="l16.483">   aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l16.484"></a><span id="l16.484">                        &quot;VK_RETURN&quot;, {});</span>
<a href="#l16.485"></a><span id="l16.485">   // The caller's going to have to wait for message display completion</span>
<a href="#l16.486"></a><span id="l16.486"> }</span>
<a href="#l16.487"></a><span id="l16.487"> </span>
<a href="#l16.488"></a><span id="l16.488"> /**</span>
<a href="#l16.489"></a><span id="l16.489">  * Wait for the |folderDisplay| on aController (defaults to mc if omitted) to</span>
<a href="#l16.490"></a><span id="l16.490">  *  finish loading.  This generally only matters for folders that have an active</span>
<a href="#l16.491"></a><span id="l16.491">  *  search.</span>
<a href="#l16.492"></a><span id="l16.492">  * This method is generally called automatically most of the time, and you</span>
<a href="#l16.493"></a><span id="l16.493">  *  should not need to call it yourself unless you are operating outside the</span>
<a href="#l16.494"></a><span id="l16.494">  *  helper methods in this file.</span>
<a href="#l16.495"></a><span id="l16.495">  */</span>
<a href="#l16.496"></a><span id="l16.496"> function wait_for_all_messages_to_load(aController) {</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.499"></a><span id="l16.499">     aController = mc;</span>
<a href="#l16.500"></a><span id="l16.500">   if (!controller.waitForEval('subject.allMessagesLoaded', NORMAL_TIMEOUT,</span>
<a href="#l16.501"></a><span id="l16.501">                               FAST_INTERVAL, aController.folderDisplay))</span>
<a href="#l16.502"></a><span id="l16.502">     mark_failure([&quot;Messages never finished loading.  Timed Out.&quot;]);</span>
<a href="#l16.503"></a><span id="l16.503">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l16.504"></a><span id="l16.504">   //  chance.  give it a chance now.</span>
<a href="#l16.505"></a><span id="l16.505">   aController.sleep(0);</span>
<a href="#l16.506"></a><span id="l16.506"> }</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineat">@@ -1292,18 +1400,19 @@ function wait_for_all_messages_to_load(a</span>
<a href="#l16.508"></a><span id="l16.508">  *  displayed for the given controller that state is sufficiently cleaned up</span>
<a href="#l16.509"></a><span id="l16.509">  *  so it doesn't trick us into thinking that there is no need to wait.</span>
<a href="#l16.510"></a><span id="l16.510">  *</span>
<a href="#l16.511"></a><span id="l16.511">  * @param [aControllerOrTab] optional controller or tab, defaulting to |mc|. If</span>
<a href="#l16.512"></a><span id="l16.512">  *     the message display is going to be caused by a tab switch, a reference to</span>
<a href="#l16.513"></a><span id="l16.513">  *     the tab to switch to should be passed in.</span>
<a href="#l16.514"></a><span id="l16.514">  */</span>
<a href="#l16.515"></a><span id="l16.515"> function plan_for_message_display(aControllerOrTab) {</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineminus">-  if (aControllerOrTab === undefined)</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineplus">+  if (aControllerOrTab == null)</span>
<a href="#l16.518"></a><span id="l16.518">     aControllerOrTab = mc;</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;plan_for_message_display&quot;, []);</span>
<a href="#l16.520"></a><span id="l16.520">   // We're relying on duck typing here -- both controllers and tabs expose their</span>
<a href="#l16.521"></a><span id="l16.521">   // message displays as the property |messageDisplay|.</span>
<a href="#l16.522"></a><span id="l16.522">   aControllerOrTab.messageDisplay.messageLoaded = false;</span>
<a href="#l16.523"></a><span id="l16.523"> }</span>
<a href="#l16.524"></a><span id="l16.524"> </span>
<a href="#l16.525"></a><span id="l16.525"> /**</span>
<a href="#l16.526"></a><span id="l16.526">  * If a message or summary is in the process of loading, let it finish;</span>
<a href="#l16.527"></a><span id="l16.527">  *  optionally, be sure to wait for a load to happen (assuming</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineat">@@ -1336,18 +1445,19 @@ function plan_for_message_display(aContr</span>
<a href="#l16.529"></a><span id="l16.529">  * @param [aController] optional controller, defaulting to |mc|.</span>
<a href="#l16.530"></a><span id="l16.530">  * @param [aLoadDemanded=false] Should we require that we wait for a message to</span>
<a href="#l16.531"></a><span id="l16.531">  *     be loaded?  You should use this in conjunction with</span>
<a href="#l16.532"></a><span id="l16.532">  *     |plan_for_message_display| as per the documentation above.  If you do</span>
<a href="#l16.533"></a><span id="l16.533">  *     not pass true and there is no message load in process, this method will</span>
<a href="#l16.534"></a><span id="l16.534">  *     return immediately.</span>
<a href="#l16.535"></a><span id="l16.535">  */</span>
<a href="#l16.536"></a><span id="l16.536"> function wait_for_message_display_completion(aController, aLoadDemanded) {</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.539"></a><span id="l16.539">     aController = mc;</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_message_display_completion&quot;, []);</span>
<a href="#l16.541"></a><span id="l16.541">   let contentPane = aController.contentPane;</span>
<a href="#l16.542"></a><span id="l16.542">   let oldHref = null;</span>
<a href="#l16.543"></a><span id="l16.543"> </span>
<a href="#l16.544"></a><span id="l16.544">   // There are a couple possible states the universe can be in:</span>
<a href="#l16.545"></a><span id="l16.545">   // 1) No message load happened or is going to happen.</span>
<a href="#l16.546"></a><span id="l16.546">   // 2) The only message load that is going to happened has happened.</span>
<a href="#l16.547"></a><span id="l16.547">   // 3) A message load is happening right now.</span>
<a href="#l16.548"></a><span id="l16.548">   // 4) A message load should happen in the near future.</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineat">@@ -1380,39 +1490,42 @@ function wait_for_message_display_comple</span>
<a href="#l16.550"></a><span id="l16.550">     return !docShell.busyFlags;</span>
<a href="#l16.551"></a><span id="l16.551">   };</span>
<a href="#l16.552"></a><span id="l16.552">   if (!controller.waitForEval('subject()', NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l16.553"></a><span id="l16.553">                               isLoadedChecker))</span>
<a href="#l16.554"></a><span id="l16.554">     mark_failure([&quot;Timed out waiting for message display completion.&quot;]);</span>
<a href="#l16.555"></a><span id="l16.555">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l16.556"></a><span id="l16.556">   //  chance.  give it a chance now.</span>
<a href="#l16.557"></a><span id="l16.557">   aController.sleep(0);</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;/wait_for_message_display_completion&quot;, []);</span>
<a href="#l16.559"></a><span id="l16.559"> }</span>
<a href="#l16.560"></a><span id="l16.560"> </span>
<a href="#l16.561"></a><span id="l16.561"> /**</span>
<a href="#l16.562"></a><span id="l16.562">  * Wait for the content pane to be blank because no message is to be displayed.</span>
<a href="#l16.563"></a><span id="l16.563">  * You would not want to call this once folder summaries land and if they are</span>
<a href="#l16.564"></a><span id="l16.564">  *  enabled.</span>
<a href="#l16.565"></a><span id="l16.565">  *</span>
<a href="#l16.566"></a><span id="l16.566">  * @param aController optional controller, defaulting to |mc|.</span>
<a href="#l16.567"></a><span id="l16.567">  */</span>
<a href="#l16.568"></a><span id="l16.568"> function wait_for_blank_content_pane(aController) {</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.571"></a><span id="l16.571">     aController = mc;</span>
<a href="#l16.572"></a><span id="l16.572" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_blank_content_pane&quot;, []);</span>
<a href="#l16.573"></a><span id="l16.573"> </span>
<a href="#l16.574"></a><span id="l16.574">   let isBlankChecker = function() {</span>
<a href="#l16.575"></a><span id="l16.575">     return aController.window.content.location.href == &quot;about:blank&quot;;</span>
<a href="#l16.576"></a><span id="l16.576">   };</span>
<a href="#l16.577"></a><span id="l16.577">   if (!controller.waitForEval('subject()', NORMAL_TIMEOUT, FAST_INTERVAL,</span>
<a href="#l16.578"></a><span id="l16.578">                               isBlankChecker))</span>
<a href="#l16.579"></a><span id="l16.579">     mark_failure([&quot;Timeout waiting for blank content pane.  Current location:&quot;,</span>
<a href="#l16.580"></a><span id="l16.580">                   aController.window.content.location.href]);</span>
<a href="#l16.581"></a><span id="l16.581">   // the above may return immediately, meaning the event queue might not get a</span>
<a href="#l16.582"></a><span id="l16.582">   //  chance.  give it a chance now.</span>
<a href="#l16.583"></a><span id="l16.583">   aController.sleep(0);</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;/wait_for_blank_content_pane&quot;, []);</span>
<a href="#l16.585"></a><span id="l16.585"> }</span>
<a href="#l16.586"></a><span id="l16.586"> </span>
<a href="#l16.587"></a><span id="l16.587"> </span>
<a href="#l16.588"></a><span id="l16.588"> var FolderListener = {</span>
<a href="#l16.589"></a><span id="l16.589">   _inited: false,</span>
<a href="#l16.590"></a><span id="l16.590">   ensureInited: function() {</span>
<a href="#l16.591"></a><span id="l16.591">     if (this._inited)</span>
<a href="#l16.592"></a><span id="l16.592">       return;</span>
<a href="#l16.593"></a><span id="l16.593" class="difflineat">@@ -1478,28 +1591,28 @@ function wait_for_folder_events() {</span>
<a href="#l16.594"></a><span id="l16.594">  * Assert that the given synthetic message sets are present in the folder</span>
<a href="#l16.595"></a><span id="l16.595">  *  display.</span>
<a href="#l16.596"></a><span id="l16.596">  *</span>
<a href="#l16.597"></a><span id="l16.597">  * @param aSynSets Either a single SyntheticMessageSet or a list of them.</span>
<a href="#l16.598"></a><span id="l16.598">  * @param aController Optional controller, which we get the folderDisplay</span>
<a href="#l16.599"></a><span id="l16.599">  *     property from.  If omitted, we use mc.</span>
<a href="#l16.600"></a><span id="l16.600">  */</span>
<a href="#l16.601"></a><span id="l16.601"> function assert_messages_in_view(aSynSets, aController) {</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.604"></a><span id="l16.604">     aController = mc;</span>
<a href="#l16.605"></a><span id="l16.605">   testHelperModule.verify_messages_in_view(aSynSets,</span>
<a href="#l16.606"></a><span id="l16.606">                                            aController.folderDisplay.view);</span>
<a href="#l16.607"></a><span id="l16.607"> }</span>
<a href="#l16.608"></a><span id="l16.608"> </span>
<a href="#l16.609"></a><span id="l16.609"> /**</span>
<a href="#l16.610"></a><span id="l16.610">  * Assert the the given message/messages are not present in the view.</span>
<a href="#l16.611"></a><span id="l16.611">  * @param aMessages Either a single nsIMsgDBHdr or a list of them.</span>
<a href="#l16.612"></a><span id="l16.612">  */</span>
<a href="#l16.613"></a><span id="l16.613"> function assert_messages_not_in_view(aMessages, aController) {</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.615"></a><span id="l16.615" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.616"></a><span id="l16.616">     aController = mc;</span>
<a href="#l16.617"></a><span id="l16.617">   if (aMessages instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l16.618"></a><span id="l16.618">     aMessages = [aMessages];</span>
<a href="#l16.619"></a><span id="l16.619">   for each (let [, msgHdr] in Iterator(aMessages)) {</span>
<a href="#l16.620"></a><span id="l16.620">     if (mc.dbView.findIndexOfMsgHdr(msgHdr, true) != nsMsgViewIndex_None)</span>
<a href="#l16.621"></a><span id="l16.621">       mark_failure([&quot;Message header is present in view but should not be:&quot;,</span>
<a href="#l16.622"></a><span id="l16.622">                     msgHdr, &quot;index:&quot;,</span>
<a href="#l16.623"></a><span id="l16.623">                     mc.dbView.findIndexOfMsgHdr(msgHdr, true)]);</span>
<a href="#l16.624"></a><span id="l16.624" class="difflineat">@@ -2103,17 +2216,17 @@ function assert_message_pane_focused() {</span>
<a href="#l16.625"></a><span id="l16.625">  * Assert that the multimessage pane is focused.</span>
<a href="#l16.626"></a><span id="l16.626">  */</span>
<a href="#l16.627"></a><span id="l16.627"> function assert_multimessage_pane_focused() {</span>
<a href="#l16.628"></a><span id="l16.628">   _assert_thing_focused(&quot;multimessage&quot;);</span>
<a href="#l16.629"></a><span id="l16.629"> }</span>
<a href="#l16.630"></a><span id="l16.630"> </span>
<a href="#l16.631"></a><span id="l16.631"> </span>
<a href="#l16.632"></a><span id="l16.632"> function _normalize_folder_view_index(aViewIndex, aController) {</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineminus">-  if (aController === undefined)</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineplus">+  if (aController == null)</span>
<a href="#l16.635"></a><span id="l16.635">     aController = mc;</span>
<a href="#l16.636"></a><span id="l16.636">   if (aViewIndex &lt; 0)</span>
<a href="#l16.637"></a><span id="l16.637">     return aController.folderTreeView.QueryInterface(Ci.nsITreeView).rowCount +</span>
<a href="#l16.638"></a><span id="l16.638">       aViewIndex;</span>
<a href="#l16.639"></a><span id="l16.639">   return aViewIndex;</span>
<a href="#l16.640"></a><span id="l16.640"> }</span>
<a href="#l16.641"></a><span id="l16.641"> </span>
<a href="#l16.642"></a><span id="l16.642"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-migration-helpers.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-migration-helpers.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -120,11 +120,19 @@ function close_migration_assistant(fc) {</span>
<a href="#l17.4"></a><span id="l17.4">  *</span>
<a href="#l17.5"></a><span id="l17.5">  * @param fc the migration assistant window wrapped in a MozmillController.</span>
<a href="#l17.6"></a><span id="l17.6">  *</span>
<a href="#l17.7"></a><span id="l17.7">  * @return The subpage's window wrapped in a MozmillController with the</span>
<a href="#l17.8"></a><span id="l17.8">  *     contentFrame displaying the appropriate pane.</span>
<a href="#l17.9"></a><span id="l17.9">  */</span>
<a href="#l17.10"></a><span id="l17.10"> function get_subpage(fc) {</span>
<a href="#l17.11"></a><span id="l17.11">   let contentWindow = fc.e(&quot;contentFrame&quot;).contentWindow;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  // XXX this is not my fault, but I'm not going to fix it.  just make it less</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  // broken:</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  // Lie to mozmill to convince it to not explode because these frames never</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+  // get a documentLoaded attribute.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  contentWindow.documentLoaded = true;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  // And sleep so the page has a chance to load</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  controller.sleep(1000);</span>
<a href="#l17.20"></a><span id="l17.20">   let aController = new controller.MozMillController(contentWindow);</span>
<a href="#l17.21"></a><span id="l17.21">   return wh.augment_controller(aController);</span>
<a href="#l17.22"></a><span id="l17.22"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-search-window-helpers.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-search-window-helpers.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -92,17 +92,17 @@ function open_search_window() {</span>
<a href="#l18.4"></a><span id="l18.4">  */</span>
<a href="#l18.5"></a><span id="l18.5"> function open_search_window_from_context_menu(aFolder) {</span>
<a href="#l18.6"></a><span id="l18.6">   folderDisplayHelper.right_click_on_folder(aFolder);</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8">   windowHelper.plan_for_new_window(&quot;mailnews:search&quot;);</span>
<a href="#l18.9"></a><span id="l18.9">   mc.folderTreeController.searchMessages();</span>
<a href="#l18.10"></a><span id="l18.10">   let swc = windowHelper.wait_for_new_window(&quot;mailnews:search&quot;);</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  folderDisplayHelper.close_popup();</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  folderDisplayHelper.close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15">   return swc;</span>
<a href="#l18.16"></a><span id="l18.16"> }</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> /**</span>
<a href="#l18.19"></a><span id="l18.19">  * Close a search window by calling window.close() on the controller.</span>
<a href="#l18.20"></a><span id="l18.20">  */</span>
<a href="#l18.21"></a><span id="l18.21"> function close_search_window(aController) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -90,16 +90,29 @@ const WINDOW_FOCUS_TIMEOUT_MS = 10000;</span>
<a href="#l19.4"></a><span id="l19.4"> const focusManager = Cc[&quot;@mozilla.org/focus-manager;1&quot;].</span>
<a href="#l19.5"></a><span id="l19.5">                        getService(Ci.nsIFocusManager);</span>
<a href="#l19.6"></a><span id="l19.6"> const threadManager = Cc[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l19.7"></a><span id="l19.7">                         .getService(Ci.nsIThreadManager);</span>
<a href="#l19.8"></a><span id="l19.8"> const hiddenWindow = Cc[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l19.9"></a><span id="l19.9">                        .getService(Ci.nsIAppShellService)</span>
<a href="#l19.10"></a><span id="l19.10">                        .hiddenDOMWindow;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+// Have a dummy mark_action function in case test-folder-display-helpers does</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+// not provide us with one.</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+var mark_action = function() {};</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+var normalize_for_json = function() {};</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+/**</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+ * This is used by test-folder-display-helpers to provide us with a reference</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+ * to logHelper's mark_action because of ugliness in the module system.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+ */</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+function hereIsMarkAction(mark_action_impl, normalize_for_json_impl) {</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  mark_action = mark_action_impl;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+  normalize_for_json = normalize_for_json_impl;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+}</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+</span>
<a href="#l19.25"></a><span id="l19.25"> function setupModule() {</span>
<a href="#l19.26"></a><span id="l19.26">   // do nothing</span>
<a href="#l19.27"></a><span id="l19.27"> }</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29"> function installInto(module) {</span>
<a href="#l19.30"></a><span id="l19.30">   module.plan_for_new_window = plan_for_new_window;</span>
<a href="#l19.31"></a><span id="l19.31">   module.wait_for_new_window = wait_for_new_window;</span>
<a href="#l19.32"></a><span id="l19.32">   module.plan_for_modal_dialog = plan_for_modal_dialog;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineat">@@ -110,16 +123,55 @@ function installInto(module) {</span>
<a href="#l19.34"></a><span id="l19.34">   module.wait_for_existing_window = wait_for_existing_window;</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36">   module.plan_for_observable_event = plan_for_observable_event;</span>
<a href="#l19.37"></a><span id="l19.37">   module.wait_for_observable_event = wait_for_observable_event;</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39">   module.augment_controller = augment_controller;</span>
<a href="#l19.40"></a><span id="l19.40"> }</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+/**</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+ * Return the &quot;windowtype&quot; or &quot;id&quot; for the given xul window if it is available.</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+ * If not, return null.</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+ */</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+function getWindowTypeForXulWindow(aXULWindow) {</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+  // Sometimes we are given HTML windows, for which the logic below will</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+  //  bail.  So we use a fast-path here that should work for HTML and should</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+  //  maybe also work with XUL.  I'm not going to go into it...</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  if (aXULWindow.document &amp;&amp;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+      aXULWindow.document.documentElement &amp;&amp;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+      aXULWindow.document.documentElement.hasAttribute(&quot;windowtype&quot;))</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    return aXULWindow.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+  let docshell = aXULWindow.docShell;</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  // we need the docshell to exist...</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+  if (!docshell)</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+    return null;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  // we can't know if it's the right document until it's not busy</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+  if (docshell.busyFlags)</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+    return null;</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  // it also needs to have content loaded (it starts out not busy with no</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  //  content viewer.)</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+  if (docshell.contentViewer == null)</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+    return null;</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+  // now we're cooking! let's get the document...</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+  let outerDoc = docshell.contentViewer.DOMDocument;</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+  // and make sure it's not blank.  that's also an intermediate state.</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  if (outerDoc.location.href == &quot;about:blank&quot;)</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+    return null;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+  // finally, we can now have a windowtype!</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  let windowType = outerDoc.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+                   outerDoc.documentElement.getAttribute(&quot;id&quot;);</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+  return windowType;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+}</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+</span>
<a href="#l19.81"></a><span id="l19.81"> var WindowWatcher = {</span>
<a href="#l19.82"></a><span id="l19.82">   _inited: false,</span>
<a href="#l19.83"></a><span id="l19.83">   _firstWindowOpened: false,</span>
<a href="#l19.84"></a><span id="l19.84">   ensureInited: function WindowWatcher_ensureInited() {</span>
<a href="#l19.85"></a><span id="l19.85">     if (this._inited)</span>
<a href="#l19.86"></a><span id="l19.86">       return;</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88">     // Add ourselves as an nsIWindowMediatorListener so we can here about when</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineat">@@ -195,17 +247,21 @@ var WindowWatcher = {</span>
<a href="#l19.90"></a><span id="l19.90">     let xulWindow = this.waitingList[aWindowType];</span>
<a href="#l19.91"></a><span id="l19.91">     let domWindow = xulWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l19.92"></a><span id="l19.92">                                       .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l19.93"></a><span id="l19.93">     delete this.waitingList[aWindowType];</span>
<a href="#l19.94"></a><span id="l19.94">     // spin the event loop to make sure any setTimeout 0 calls have gotten their</span>
<a href="#l19.95"></a><span id="l19.95">     //  time in the sun.</span>
<a href="#l19.96"></a><span id="l19.96">     controller.sleep(0);</span>
<a href="#l19.97"></a><span id="l19.97">     this._firstWindowOpened = true;</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-    return new controller.MozMillController(domWindow);</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+    // wrap the creation because </span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    mark_action(&quot;winhelp&quot;, &quot;new MozMillController()&quot;, [aWindowType]);</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+    let c = new controller.MozMillController(domWindow);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+    mark_action(&quot;winhelp&quot;, &quot;/new MozMillController()&quot;, [aWindowType]);</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+    return c;</span>
<a href="#l19.104"></a><span id="l19.104">   },</span>
<a href="#l19.105"></a><span id="l19.105"> </span>
<a href="#l19.106"></a><span id="l19.106">   /**</span>
<a href="#l19.107"></a><span id="l19.107">    * Because the modal dialog spins its own event loop, the mozmill idiom of</span>
<a href="#l19.108"></a><span id="l19.108">    *  spinning your own event-loop as performed by waitForEval is no good.  We</span>
<a href="#l19.109"></a><span id="l19.109">    *  use this timer to generate our events so that we can have a waitForEval</span>
<a href="#l19.110"></a><span id="l19.110">    *  equivalent.</span>
<a href="#l19.111"></a><span id="l19.111">    *</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineat">@@ -316,16 +372,19 @@ var WindowWatcher = {</span>
<a href="#l19.113"></a><span id="l19.113"> </span>
<a href="#l19.114"></a><span id="l19.114">   /**</span>
<a href="#l19.115"></a><span id="l19.115">    * This notification gets called when windows tell the widnow mediator when</span>
<a href="#l19.116"></a><span id="l19.116">    *  the window title gets changed.  In theory, we could use this to be</span>
<a href="#l19.117"></a><span id="l19.117">    *  event driven with less polling (effort), but it is not to be.</span>
<a href="#l19.118"></a><span id="l19.118">    */</span>
<a href="#l19.119"></a><span id="l19.119">   onWindowTitleChange: function WindowWatcher_onWindowTitleChange(</span>
<a href="#l19.120"></a><span id="l19.120">       aXULWindow, aNewTitle) {</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+    mark_action(&quot;winhelp&quot;, &quot;onWindowTitleChange&quot;,</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+                [aXULWindow.toString(), getWindowTypeForXulWindow(aXULWindow),</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+                 &quot;changed title to&quot;, aNewTitle]);</span>
<a href="#l19.124"></a><span id="l19.124">   },</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126">   /**</span>
<a href="#l19.127"></a><span id="l19.127">    * Used by waitForWindowOpen to check all of the windows we are monitoring and</span>
<a href="#l19.128"></a><span id="l19.128">    *  then check if we have any results.</span>
<a href="#l19.129"></a><span id="l19.129">    *</span>
<a href="#l19.130"></a><span id="l19.130">    * @return true if we found what we were |waitingForOpen|, false otherwise.</span>
<a href="#l19.131"></a><span id="l19.131">    */</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineat">@@ -363,53 +422,38 @@ var WindowWatcher = {</span>
<a href="#l19.133"></a><span id="l19.133">   },</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135">   /**</span>
<a href="#l19.136"></a><span id="l19.136">    * nsIWindowMediatorListener notification that a XUL window was opened.  We</span>
<a href="#l19.137"></a><span id="l19.137">    *  check out the window, and if we were not able to fully consider it, we</span>
<a href="#l19.138"></a><span id="l19.138">    *  add it to our monitoring list.</span>
<a href="#l19.139"></a><span id="l19.139">    */</span>
<a href="#l19.140"></a><span id="l19.140">   onOpenWindow: function WindowWatcher_onOpenWindow(aXULWindow) {</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+    // It would be great to be able to indicate if the window is modal or not,</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+    //  but nothing is really jumping out at me to enable that...</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+    mark_action(&quot;winhelp&quot;, &quot;onOpenWindow&quot;,</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+                [aXULWindow.toString(),</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+                 &quot;window type&quot;, getWindowTypeForXulWindow(aXULWindow)]);</span>
<a href="#l19.146"></a><span id="l19.146">     if (!this.consider(aXULWindow))</span>
<a href="#l19.147"></a><span id="l19.147">       this.monitorWindowLoad(aXULWindow);</span>
<a href="#l19.148"></a><span id="l19.148">   },</span>
<a href="#l19.149"></a><span id="l19.149"> </span>
<a href="#l19.150"></a><span id="l19.150">   /**</span>
<a href="#l19.151"></a><span id="l19.151">    * Consider if the given window is something in our |waitingList|.</span>
<a href="#l19.152"></a><span id="l19.152">    *</span>
<a href="#l19.153"></a><span id="l19.153">    * @return true if we were able to fully consider the object, false if we were</span>
<a href="#l19.154"></a><span id="l19.154">    *     not and need to be called again on the window later.  This has no</span>
<a href="#l19.155"></a><span id="l19.155">    *     relation to whether the window was one in our waitingList or not.</span>
<a href="#l19.156"></a><span id="l19.156">    *     Check the waitingList structure for that.</span>
<a href="#l19.157"></a><span id="l19.157">    */</span>
<a href="#l19.158"></a><span id="l19.158">   consider: function (aXULWindow) {</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-    let docshell = aXULWindow.docShell;</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-    // we need the docshell to exist...</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-    if (!docshell)</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-      return false;</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-    // we can't know if it's the right document until it's not busy</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-    if (docshell.busyFlags)</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+    let windowType = getWindowTypeForXulWindow(aXULWindow);</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+    if (windowType == null)</span>
<a href="#l19.168"></a><span id="l19.168">       return false;</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-    // it also needs to have content loaded (it starts out not busy with no</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-    //  content viewer.)</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-    if (docshell.contentViewer == null)</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-      return false;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-    // now we're cooking! let's get the document...</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-    let outerDoc = docshell.contentViewer.DOMDocument;</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-    // and make sure it's not blank.  that's also an intermediate state.</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-    if (outerDoc.location.href == &quot;about:blank&quot;)</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-      return false;</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-    // finally, we can now have a windowtype!</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-    let windowType = outerDoc.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-                     outerDoc.documentElement.getAttribute(&quot;id&quot;);</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-</span>
<a href="#l19.185"></a><span id="l19.185">     // stash the window if we were watching for it</span>
<a href="#l19.186"></a><span id="l19.186">     if (windowType in this.waitingList) {</span>
<a href="#l19.187"></a><span id="l19.187">       this.waitingList[windowType] = aXULWindow;</span>
<a href="#l19.188"></a><span id="l19.188">     }</span>
<a href="#l19.189"></a><span id="l19.189"> </span>
<a href="#l19.190"></a><span id="l19.190">     return true;</span>
<a href="#l19.191"></a><span id="l19.191">   },</span>
<a href="#l19.192"></a><span id="l19.192"> </span>
<a href="#l19.193"></a><span id="l19.193" class="difflineat">@@ -418,16 +462,18 @@ var WindowWatcher = {</span>
<a href="#l19.194"></a><span id="l19.194">    *  so things like their windowtype are immediately available.</span>
<a href="#l19.195"></a><span id="l19.195">    */</span>
<a href="#l19.196"></a><span id="l19.196">   onCloseWindow: function WindowWatcher_onCloseWindow(aXULWindow) {</span>
<a href="#l19.197"></a><span id="l19.197">     let domWindow = aXULWindow.docShell.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l19.198"></a><span id="l19.198">                                        .getInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l19.199"></a><span id="l19.199">     let windowType =</span>
<a href="#l19.200"></a><span id="l19.200">       domWindow.document.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l19.201"></a><span id="l19.201">       domWindow.document.documentElement.getAttribute(&quot;id&quot;);</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+    mark_action(&quot;winhelp&quot;, &quot;onCloseWindow&quot;,</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+                [aXULWindow.toString(), &quot;window type&quot;, windowType]);</span>
<a href="#l19.204"></a><span id="l19.204">     // XXX because of how we dance with things, equivalence is not gonna</span>
<a href="#l19.205"></a><span id="l19.205">     //  happen for us.  This is most pragmatic.</span>
<a href="#l19.206"></a><span id="l19.206">     if (this.waitingList[windowType] !== null)</span>
<a href="#l19.207"></a><span id="l19.207">       this.waitingList[windowType] = null;</span>
<a href="#l19.208"></a><span id="l19.208">   },</span>
<a href="#l19.209"></a><span id="l19.209"> };</span>
<a href="#l19.210"></a><span id="l19.210"> </span>
<a href="#l19.211"></a><span id="l19.211"> /**</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineat">@@ -439,16 +485,17 @@ var WindowWatcher = {</span>
<a href="#l19.213"></a><span id="l19.213">  * @param aWindowType the window type that will be created.  This is literally</span>
<a href="#l19.214"></a><span id="l19.214">  *     the value of the &quot;windowtype&quot; attribute on the window.  The values tend</span>
<a href="#l19.215"></a><span id="l19.215">  *     to look like &quot;app:windowname&quot;, for example &quot;mailnews:search&quot;.</span>
<a href="#l19.216"></a><span id="l19.216">  *</span>
<a href="#l19.217"></a><span id="l19.217">  * @return The loaded window of the given type wrapped in a MozmillController</span>
<a href="#l19.218"></a><span id="l19.218">  *     that is augmented using augment_controller.</span>
<a href="#l19.219"></a><span id="l19.219">  */</span>
<a href="#l19.220"></a><span id="l19.220"> function wait_for_existing_window(aWindowType) {</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_existing_window&quot;, [aWindowType]);</span>
<a href="#l19.222"></a><span id="l19.222">   WindowWatcher.ensureInited();</span>
<a href="#l19.223"></a><span id="l19.223">   WindowWatcher.planForAlreadyOpenWindow(aWindowType);</span>
<a href="#l19.224"></a><span id="l19.224">   return augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l19.225"></a><span id="l19.225">                             aWindowType);</span>
<a href="#l19.226"></a><span id="l19.226"> }</span>
<a href="#l19.227"></a><span id="l19.227"> </span>
<a href="#l19.228"></a><span id="l19.228"> /**</span>
<a href="#l19.229"></a><span id="l19.229">  * Call this just before you trigger the event that will cause a window to be</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineat">@@ -459,32 +506,40 @@ function wait_for_existing_window(aWindo</span>
<a href="#l19.231"></a><span id="l19.231">  *  resilient in the face of multiple windows of the same type as long as you</span>
<a href="#l19.232"></a><span id="l19.232">  *  don't try and open them all at the same time.</span>
<a href="#l19.233"></a><span id="l19.233">  *</span>
<a href="#l19.234"></a><span id="l19.234">  * @param aWindowType the window type that will be created.  This is literally</span>
<a href="#l19.235"></a><span id="l19.235">  *     the value of the &quot;windowtype&quot; attribute on the window.  The values tend</span>
<a href="#l19.236"></a><span id="l19.236">  *     to look like &quot;app:windowname&quot;, for example &quot;mailnews:search&quot;.</span>
<a href="#l19.237"></a><span id="l19.237">  */</span>
<a href="#l19.238"></a><span id="l19.238"> function plan_for_new_window(aWindowType) {</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;plan_for_new_window&quot;, [aWindowType]);</span>
<a href="#l19.240"></a><span id="l19.240">   WindowWatcher.ensureInited();</span>
<a href="#l19.241"></a><span id="l19.241">   WindowWatcher.planForWindowOpen(aWindowType);</span>
<a href="#l19.242"></a><span id="l19.242"> }</span>
<a href="#l19.243"></a><span id="l19.243"> </span>
<a href="#l19.244"></a><span id="l19.244"> </span>
<a href="#l19.245"></a><span id="l19.245"> /**</span>
<a href="#l19.246"></a><span id="l19.246">  * Wait for the loading of the given window type to complete (that you</span>
<a href="#l19.247"></a><span id="l19.247">  *  previously told us about via |plan_for_new_window|), returning it wrapped</span>
<a href="#l19.248"></a><span id="l19.248">  *  in a MozmillController.</span>
<a href="#l19.249"></a><span id="l19.249">  *</span>
<a href="#l19.250"></a><span id="l19.250">  * @return The loaded window of the given type wrapped in a MozmillController</span>
<a href="#l19.251"></a><span id="l19.251">  *     that is augmented using augment_controller.</span>
<a href="#l19.252"></a><span id="l19.252">  */</span>
<a href="#l19.253"></a><span id="l19.253"> function wait_for_new_window(aWindowType) {</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-  return augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-                            aWindowType);</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_new_window&quot;, [aWindowType]);</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+  let c = augment_controller(WindowWatcher.waitForWindowOpen(aWindowType),</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+                             aWindowType);</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+  // A nested event loop can get spun inside the Controller's constructor</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+  //  (which is arguably not a great idea), so it's important that we denote</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineplus">+  //  when we're actually leaving this function in case something crazy</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+  //  happens.</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;/wait_for_new_window&quot;, [aWindowType]);</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+  return c;</span>
<a href="#l19.265"></a><span id="l19.265"> }</span>
<a href="#l19.266"></a><span id="l19.266"> </span>
<a href="#l19.267"></a><span id="l19.267"> /**</span>
<a href="#l19.268"></a><span id="l19.268">  * Plan for the imminent display of a modal dialog.  Modal dialogs spin their</span>
<a href="#l19.269"></a><span id="l19.269">  *  own event loop which means that either that control flow will not return</span>
<a href="#l19.270"></a><span id="l19.270">  *  to the caller until the modal dialog finishes running.  This means that</span>
<a href="#l19.271"></a><span id="l19.271">  *  you need to provide a sub-test function to be run inside the modal dialog</span>
<a href="#l19.272"></a><span id="l19.272">  *  (and it should not start with &quot;test&quot; or mozmill will also try and run it.)</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineat">@@ -492,47 +547,54 @@ function wait_for_new_window(aWindowType</span>
<a href="#l19.274"></a><span id="l19.274">  * @param aWindowType The window type that you expect the modal dialog to have</span>
<a href="#l19.275"></a><span id="l19.275">  *                    or the id of the window if there is no window type</span>
<a href="#l19.276"></a><span id="l19.276">  *                    available.</span>
<a href="#l19.277"></a><span id="l19.277">  * @param aSubTestFunction The sub-test function that will be run once the modal</span>
<a href="#l19.278"></a><span id="l19.278">  *     dialog appears and is loaded.  This function should take one argument,</span>
<a href="#l19.279"></a><span id="l19.279">  *     a MozmillController against the modal dialog.</span>
<a href="#l19.280"></a><span id="l19.280">  */</span>
<a href="#l19.281"></a><span id="l19.281"> function plan_for_modal_dialog(aWindowType, aSubTestFunction) {</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;plan_for_modal_dialog&quot;, [aWindowType]);</span>
<a href="#l19.283"></a><span id="l19.283">   WindowWatcher.ensureInited();</span>
<a href="#l19.284"></a><span id="l19.284">   WindowWatcher.planForModalDialog(aWindowType, aSubTestFunction);</span>
<a href="#l19.285"></a><span id="l19.285"> }</span>
<a href="#l19.286"></a><span id="l19.286"> /**</span>
<a href="#l19.287"></a><span id="l19.287">  * In case the dialog might be stuck for a long time, you can pass an optional</span>
<a href="#l19.288"></a><span id="l19.288">  *  timeout.</span>
<a href="#l19.289"></a><span id="l19.289">  *</span>
<a href="#l19.290"></a><span id="l19.290">  * @param aTimeout Your custom timeout (default is WINDOW_OPEN_TIMEOUT_MS)</span>
<a href="#l19.291"></a><span id="l19.291">  */</span>
<a href="#l19.292"></a><span id="l19.292"> function wait_for_modal_dialog(aWindowType, aTimeout) {</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_modal_dialog&quot;, [aWindowType, aTimeout]);</span>
<a href="#l19.294"></a><span id="l19.294">   WindowWatcher.waitForModalDialog(aWindowType, aTimeout);</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;/wait_for_modal_dialog&quot;, [aWindowType, aTimeout]);</span>
<a href="#l19.296"></a><span id="l19.296"> }</span>
<a href="#l19.297"></a><span id="l19.297"> </span>
<a href="#l19.298"></a><span id="l19.298"> /**</span>
<a href="#l19.299"></a><span id="l19.299">  * Call this just before you trigger the event that will cause the provided</span>
<a href="#l19.300"></a><span id="l19.300">  *  controller's window to disappear.  You then follow this with a call to</span>
<a href="#l19.301"></a><span id="l19.301">  *  |wait_for_window_close| when you want to block on verifying the close.</span>
<a href="#l19.302"></a><span id="l19.302">  *</span>
<a href="#l19.303"></a><span id="l19.303">  * @param aController The MozmillController, potentially returned from a call to</span>
<a href="#l19.304"></a><span id="l19.304">  *     wait_for_new_window, whose window should be disappearing.</span>
<a href="#l19.305"></a><span id="l19.305">  */</span>
<a href="#l19.306"></a><span id="l19.306"> function plan_for_window_close(aController) {</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;plan_for_window_close&quot;,</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineplus">+              [getWindowTypeForXulWindow(aController.window)]);</span>
<a href="#l19.309"></a><span id="l19.309">   WindowWatcher.ensureInited();</span>
<a href="#l19.310"></a><span id="l19.310">   WindowWatcher.planForWindowClose(aController.window);</span>
<a href="#l19.311"></a><span id="l19.311"> }</span>
<a href="#l19.312"></a><span id="l19.312"> </span>
<a href="#l19.313"></a><span id="l19.313"> /**</span>
<a href="#l19.314"></a><span id="l19.314">  * Wait for the closure of the window you noted you would listen for its close</span>
<a href="#l19.315"></a><span id="l19.315">  *  in plan_for_window_close.</span>
<a href="#l19.316"></a><span id="l19.316">  */</span>
<a href="#l19.317"></a><span id="l19.317"> function wait_for_window_close() {</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_window_close&quot;,</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineplus">+              [&quot;(using window from plan_for_window_close)&quot;]);</span>
<a href="#l19.320"></a><span id="l19.320">   WindowWatcher.waitForWindowClose();</span>
<a href="#l19.321"></a><span id="l19.321"> }</span>
<a href="#l19.322"></a><span id="l19.322"> </span>
<a href="#l19.323"></a><span id="l19.323"> /**</span>
<a href="#l19.324"></a><span id="l19.324">  * Close a window by calling window.close() on the controller.</span>
<a href="#l19.325"></a><span id="l19.325">  *</span>
<a href="#l19.326"></a><span id="l19.326">  * @param aController the controller whose window is to be closed.</span>
<a href="#l19.327"></a><span id="l19.327">  */</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineat">@@ -548,32 +610,35 @@ let obsService = Cc[&quot;@mozilla.org/observ</span>
<a href="#l19.329"></a><span id="l19.329"> let observationWaitFuncs = {};</span>
<a href="#l19.330"></a><span id="l19.330"> let observationSaw = {};</span>
<a href="#l19.331"></a><span id="l19.331"> /**</span>
<a href="#l19.332"></a><span id="l19.332">  * Plan for a notification to be sent via the observer service.</span>
<a href="#l19.333"></a><span id="l19.333">  *</span>
<a href="#l19.334"></a><span id="l19.334">  * @param aTopic The topic that will be sent via the observer service.</span>
<a href="#l19.335"></a><span id="l19.335">  */</span>
<a href="#l19.336"></a><span id="l19.336"> function plan_for_observable_event(aTopic) {</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;plan_for_observable_event&quot;, [aTopic]);</span>
<a href="#l19.338"></a><span id="l19.338">   observationSaw[aTopic] = false;</span>
<a href="#l19.339"></a><span id="l19.339">   let waiter = observationWaitFuncs[aTopic] = {</span>
<a href="#l19.340"></a><span id="l19.340">     observe: function() {</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineplus">+      mark_action(&quot;winhelp&quot;, &quot;observed event&quot;, [aTopic]);</span>
<a href="#l19.342"></a><span id="l19.342">       observationSaw[aTopic] = true;</span>
<a href="#l19.343"></a><span id="l19.343">     }</span>
<a href="#l19.344"></a><span id="l19.344">   };</span>
<a href="#l19.345"></a><span id="l19.345">   obsService.addObserver(waiter, aTopic, false);</span>
<a href="#l19.346"></a><span id="l19.346"> }</span>
<a href="#l19.347"></a><span id="l19.347"> </span>
<a href="#l19.348"></a><span id="l19.348"> /**</span>
<a href="#l19.349"></a><span id="l19.349">  * Wait for a notification (previously planned for via</span>
<a href="#l19.350"></a><span id="l19.350">  *  |plan_for_observable_event|) to fire.</span>
<a href="#l19.351"></a><span id="l19.351">  *</span>
<a href="#l19.352"></a><span id="l19.352">  * @param aTopic The topic sent via the observer service.</span>
<a href="#l19.353"></a><span id="l19.353">  */</span>
<a href="#l19.354"></a><span id="l19.354"> function wait_for_observable_event(aTopic) {</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+  mark_action(&quot;fdh&quot;, &quot;wait_for_observable_event&quot;, [aTopic]);</span>
<a href="#l19.356"></a><span id="l19.356">   try {</span>
<a href="#l19.357"></a><span id="l19.357">     function areWeThereYet() {</span>
<a href="#l19.358"></a><span id="l19.358">       return observationSaw[aTopic];</span>
<a href="#l19.359"></a><span id="l19.359">     }</span>
<a href="#l19.360"></a><span id="l19.360">     if (!controller.waitForEval(</span>
<a href="#l19.361"></a><span id="l19.361">           'subject()',</span>
<a href="#l19.362"></a><span id="l19.362">           3000, 50,</span>
<a href="#l19.363"></a><span id="l19.363">           areWeThereYet))</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineat">@@ -730,21 +795,24 @@ var AugmentEverybodyWith = {</span>
<a href="#l19.365"></a><span id="l19.365">      *     attribute with a single value.  We pick the menu option whose DOM</span>
<a href="#l19.366"></a><span id="l19.366">      *     node has an attribute with that name and value.  We click whatever we</span>
<a href="#l19.367"></a><span id="l19.367">      *     find.  We throw if we don't find what you were asking for.</span>
<a href="#l19.368"></a><span id="l19.368">      */</span>
<a href="#l19.369"></a><span id="l19.369">     click_menus_in_sequence: function _click_menus(aRootPopup, aActions) {</span>
<a href="#l19.370"></a><span id="l19.370">       if (aRootPopup.state == &quot;closed&quot;)</span>
<a href="#l19.371"></a><span id="l19.371">         aRootPopup.openPopup(null, &quot;&quot;, 0, 0, true, true);</span>
<a href="#l19.372"></a><span id="l19.372">       if (aRootPopup.state != &quot;open&quot;) { // handle &quot;showing&quot;</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineminus">-        if (!controller.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 100,</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineplus">+        if (!controller.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 50,</span>
<a href="#l19.375"></a><span id="l19.375">                                     aRootPopup)) {</span>
<a href="#l19.376"></a><span id="l19.376">           throw new Error(&quot;Popup never opened!&quot;);</span>
<a href="#l19.377"></a><span id="l19.377">         }</span>
<a href="#l19.378"></a><span id="l19.378">       }</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+      // These popups sadly do not close themselves, so we need to keep track</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineplus">+      //  of them so we can make sure they end up closed.</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineplus">+      let closeStack = [aRootPopup];</span>
<a href="#l19.382"></a><span id="l19.382"> </span>
<a href="#l19.383"></a><span id="l19.383">       let curPopup = aRootPopup;</span>
<a href="#l19.384"></a><span id="l19.384">       for each (let [iAction, actionObj] in Iterator(aActions)) {</span>
<a href="#l19.385"></a><span id="l19.385">         let matchingNode = null;</span>
<a href="#l19.386"></a><span id="l19.386"> </span>
<a href="#l19.387"></a><span id="l19.387">         let kids = curPopup.children;</span>
<a href="#l19.388"></a><span id="l19.388">         for (let iKid=0; iKid &lt; kids.length; iKid++) {</span>
<a href="#l19.389"></a><span id="l19.389">           let node = kids[iKid];</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineat">@@ -765,45 +833,64 @@ var AugmentEverybodyWith = {</span>
<a href="#l19.391"></a><span id="l19.391"> </span>
<a href="#l19.392"></a><span id="l19.392">         if (!matchingNode)</span>
<a href="#l19.393"></a><span id="l19.393">           throw new Error(&quot;Did not find matching menu item for action index &quot; +</span>
<a href="#l19.394"></a><span id="l19.394">                           iAction);</span>
<a href="#l19.395"></a><span id="l19.395"> </span>
<a href="#l19.396"></a><span id="l19.396">         this.click(new elib.Elem(matchingNode));</span>
<a href="#l19.397"></a><span id="l19.397">         if (&quot;menupopup&quot; in matchingNode) {</span>
<a href="#l19.398"></a><span id="l19.398">           curPopup = matchingNode.menupopup;</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-          if (!controller.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 100,</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineplus">+          closeStack.push(curPopup);</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineplus">+          if (!controller.waitForEval(&quot;subject.state == 'open'&quot;, 1000, 50,</span>
<a href="#l19.402"></a><span id="l19.402">                                       curPopup)) {</span>
<a href="#l19.403"></a><span id="l19.403">             throw new Error(&quot;Popup never opened at action depth: &quot; + iAction);</span>
<a href="#l19.404"></a><span id="l19.404">           }</span>
<a href="#l19.405"></a><span id="l19.405">         }</span>
<a href="#l19.406"></a><span id="l19.406">       }</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+      while (closeStack.length) {</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineplus">+        curPopup = closeStack.pop();</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineplus">+        this.keypress(new elib.Elem(curPopup), &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineplus">+        if (!controller.waitForEval(&quot;subject.state == 'closed'&quot;, 1000, 50,</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineplus">+                                    curPopup))</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineplus">+          throw new Error(&quot;Popup did not close!&quot;);</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineplus">+      }</span>
<a href="#l19.415"></a><span id="l19.415">     }</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineplus">+  },</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineplus">+  getters: {</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+    focusedElement: function() {</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineplus">+      let ignoredFocusedWindow = {};</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineplus">+      return focusManager.getFocusedElementForWindow(this.window, true,</span>
<a href="#l19.422"></a><span id="l19.422" class="difflineplus">+                                                     ignoredFocusedWindow);</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineplus">+    },</span>
<a href="#l19.424"></a><span id="l19.424">   },</span>
<a href="#l19.425"></a><span id="l19.425"> };</span>
<a href="#l19.426"></a><span id="l19.426"> </span>
<a href="#l19.427"></a><span id="l19.427"> /**</span>
<a href="#l19.428"></a><span id="l19.428">  * Clicks and other mouse operations used to be recognized just outside a curved</span>
<a href="#l19.429"></a><span id="l19.429">  * border but are no longer so (bug 595652), so we need these wrappers to</span>
<a href="#l19.430"></a><span id="l19.430">  * perform the operations at the center when aLeft or aTop aren't passed in.</span>
<a href="#l19.431"></a><span id="l19.431">  */</span>
<a href="#l19.432"></a><span id="l19.432"> const MOUSE_OPS_TO_WRAP = [</span>
<a href="#l19.433"></a><span id="l19.433">   &quot;click&quot;, &quot;doubleClick&quot;, &quot;mouseDown&quot;, &quot;mouseOut&quot;, &quot;mouseOver&quot;, &quot;mouseUp&quot;,</span>
<a href="#l19.434"></a><span id="l19.434">   &quot;middleClick&quot;, &quot;rightClick&quot;,</span>
<a href="#l19.435"></a><span id="l19.435"> ];</span>
<a href="#l19.436"></a><span id="l19.436"> </span>
<a href="#l19.437"></a><span id="l19.437"> for (let [, mouseOp] in Iterator(MOUSE_OPS_TO_WRAP)) {</span>
<a href="#l19.438"></a><span id="l19.438">   let thisMouseOp = mouseOp;</span>
<a href="#l19.439"></a><span id="l19.439">   let wrapperFunc = function (aElem, aLeft, aTop) {</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineminus">-    let rect = aElem.getNode().getBoundingClientRect();</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineplus">+    let el = aElem.getNode();</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineplus">+    let rect = el.getBoundingClientRect();</span>
<a href="#l19.443"></a><span id="l19.443">     if (aLeft === undefined)</span>
<a href="#l19.444"></a><span id="l19.444">       aLeft = rect.width / 2;</span>
<a href="#l19.445"></a><span id="l19.445">     if (aTop === undefined)</span>
<a href="#l19.446"></a><span id="l19.446">       aTop = rect.height / 2;</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+    // claim to be folder-display-helper since this is an explicit action</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineplus">+    mark_action(&quot;fdh&quot;, thisMouseOp,</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineplus">+                [normalize_for_json(el), &quot;x:&quot;, aLeft, &quot;y:&quot;, aTop]);</span>
<a href="#l19.450"></a><span id="l19.450">     // |this| refers to the window that gets augmented, which is what we want</span>
<a href="#l19.451"></a><span id="l19.451">     this.__proto__[thisMouseOp](aElem, aLeft, aTop);</span>
<a href="#l19.452"></a><span id="l19.452">   };</span>
<a href="#l19.453"></a><span id="l19.453">   AugmentEverybodyWith.methods[thisMouseOp] = wrapperFunc;</span>
<a href="#l19.454"></a><span id="l19.454"> }</span>
<a href="#l19.455"></a><span id="l19.455"> </span>
<a href="#l19.456"></a><span id="l19.456"> /**</span>
<a href="#l19.457"></a><span id="l19.457">  * Per-windowtype augmentations.  Please use the documentation and general</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineat">@@ -864,17 +951,60 @@ var PerWindowTypeAugmentations = {</span>
<a href="#l19.459"></a><span id="l19.459">     onAugment: function(aController) {</span>
<a href="#l19.460"></a><span id="l19.460">       // -- turn off summarization's stabilization logic for now by setting the</span>
<a href="#l19.461"></a><span id="l19.461">       //  timer interval to 0.  We do need to make sure that we drain the event</span>
<a href="#l19.462"></a><span id="l19.462">       //  queue after performing anything that will summarize, but use of</span>
<a href="#l19.463"></a><span id="l19.463">       //  assert_selected_and_displayed in test-folder-display-helpers should</span>
<a href="#l19.464"></a><span id="l19.464">       //  handle that.</span>
<a href="#l19.465"></a><span id="l19.465">       aController.window.MessageDisplayWidget.prototype</span>
<a href="#l19.466"></a><span id="l19.466">                  .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 0;</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineminus">-    }</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineplus">+    },</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineplus">+    </span>
<a href="#l19.470"></a><span id="l19.470" class="difflineplus">+    /**</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineplus">+     * Used to wrap methods on a class prototype in order to generate</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineplus">+     *  mark_action data about the call.</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineplus">+     */         </span>
<a href="#l19.474"></a><span id="l19.474" class="difflineplus">+    debugTrace: [</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineplus">+      // goDoCommand command gobbling notification</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineplus">+      {</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineplus">+        method: &quot;goDoCommand&quot;,</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineplus">+        onGlobal: true,</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineplus">+        doBefore: function(command) {</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineplus">+          let controller = this.top.document</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineplus">+                             .commandDispatcher</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineplus">+                             .getControllerForCommand(command);</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineplus">+          if (controller &amp;&amp; !controller.isCommandEnabled(command))</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineplus">+            mark_action(&quot;winhelp&quot;, &quot;goDoCommand&quot;,</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineplus">+                        [&quot;about to ignore command because it's disabled:&quot;,</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineplus">+                         command]);</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineplus">+        }</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+      },</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineplus">+      // DefaultController command gobbling notification</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineplus">+      {</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineplus">+        method: &quot;doCommand&quot;,</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineplus">+        onObject: &quot;DefaultController&quot;,</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineplus">+        doBefore: function(command) {</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+          if (!this.isCommandEnabled(command))</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineplus">+            mark_action(&quot;winhelp&quot;, &quot;DC_doCommand&quot;,</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineplus">+                        [&quot;about to ignore command because it's disabled:&quot;,</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineplus">+                         command]);</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineplus">+        }</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineplus">+      },</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineplus">+      // FolderDisplayWidget command invocations</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineplus">+      {</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineplus">+        method: &quot;doCommand&quot;,</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineplus">+        onConstructor: &quot;FolderDisplayWidget&quot;,</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineplus">+        reportAs: &quot;FDW_doCommand&quot;,</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineplus">+      },</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineplus">+      {</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineplus">+        method: &quot;doCommandWithFolder&quot;,</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineplus">+        onConstructor: &quot;FolderDisplayWidget&quot;,</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineplus">+        reportAs: &quot;FDW_doCommandWithFolder&quot;,</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineplus">+      },</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineplus">+    ],</span>
<a href="#l19.512"></a><span id="l19.512">   },</span>
<a href="#l19.513"></a><span id="l19.513"> </span>
<a href="#l19.514"></a><span id="l19.514">   /**</span>
<a href="#l19.515"></a><span id="l19.515">    * Standalone message window.</span>
<a href="#l19.516"></a><span id="l19.516">    */</span>
<a href="#l19.517"></a><span id="l19.517">   &quot;mail:messageWindow&quot;: {</span>
<a href="#l19.518"></a><span id="l19.518">     elementsToExpose: {</span>
<a href="#l19.519"></a><span id="l19.519">       contentPane: &quot;messagepane&quot;,</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineat">@@ -945,29 +1075,340 @@ function _augment_helper(aController, aA</span>
<a href="#l19.521"></a><span id="l19.521">     }</span>
<a href="#l19.522"></a><span id="l19.522">   }</span>
<a href="#l19.523"></a><span id="l19.523">   if (aAugmentDef.methods) {</span>
<a href="#l19.524"></a><span id="l19.524">     for each (let [key, value] in Iterator(aAugmentDef.methods)) {</span>
<a href="#l19.525"></a><span id="l19.525">       aController[key] = value;</span>
<a href="#l19.526"></a><span id="l19.526">     }</span>
<a href="#l19.527"></a><span id="l19.527">   }</span>
<a href="#l19.528"></a><span id="l19.528"> </span>
<a href="#l19.529"></a><span id="l19.529" class="difflineplus">+  if (aAugmentDef.debugTrace) {</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineplus">+    let win = aController.window;</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineplus">+    for each (let [, traceDef] in Iterator(aAugmentDef.debugTrace)) {</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineplus">+      let baseObj, useThis;</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineplus">+      // - Get the object that actually has the method to wrap</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineplus">+      if (traceDef.hasOwnProperty(&quot;onGlobal&quot;)) {</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineplus">+        baseObj = win;</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineplus">+        useThis = false;</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineplus">+      }</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineplus">+      else if (traceDef.hasOwnProperty(&quot;onConstructor&quot;)) {</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineplus">+        baseObj = win[traceDef.onConstructor].prototype;</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+        useThis = true;</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineplus">+      }</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineplus">+      else if (traceDef.hasOwnProperty(&quot;onObject&quot;)) {</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineplus">+        baseObj = win[traceDef.onObject];</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineplus">+        useThis = false;</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineplus">+      }</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineplus">+      else // ignore/bail if unsupported type</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineplus">+        continue;</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineplus">+</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+      // - compute/set the wrapped attr, bailing if it's already there</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+      let wrappedName = &quot;__traceWrapped_&quot; + traceDef.method;</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineplus">+      // bail if we/someone have already wrapped it.</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineplus">+      if (baseObj.hasOwnProperty(wrappedName))</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineplus">+        continue;</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineplus">+      let origFunc = baseObj[traceDef.method];</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineplus">+      let reportAs = traceDef.reportAs; // latch</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineplus">+      baseObj[wrappedName] = origFunc;</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineplus">+</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineplus">+      // - create the trace func based on the definition and apply</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineplus">+      let traceFunc;</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineplus">+      if (traceDef.hasOwnProperty(&quot;doBefore&quot;)) {</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineplus">+        let beforeFunc = traceDef.doBefore;</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineplus">+        traceFunc = function() {</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineplus">+          beforeFunc.apply(useThis ? this : baseObj, arguments);</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineplus">+          return origFunc.apply(this, arguments);</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineplus">+        }</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineplus">+      }</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineplus">+      else {</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineplus">+        traceFunc = function() {</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineplus">+          mark_action(&quot;winhelp&quot;, reportAs,</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineplus">+                      Array.prototype.slice.call(arguments));</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineplus">+          return origFunc.apply(this, arguments);</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineplus">+        }</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineplus">+      }</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineplus">+      baseObj[traceDef.method] = traceFunc;</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineplus">+    }</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineplus">+  }</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineplus">+</span>
<a href="#l19.578"></a><span id="l19.578">   if (aAugmentDef.onAugment) {</span>
<a href="#l19.579"></a><span id="l19.579">     aAugmentDef.onAugment(aController);</span>
<a href="#l19.580"></a><span id="l19.580">   }</span>
<a href="#l19.581"></a><span id="l19.581"> }</span>
<a href="#l19.582"></a><span id="l19.582"> </span>
<a href="#l19.583"></a><span id="l19.583" class="difflineplus">+var INPUT_PEEK_EVENTS = [&quot;click&quot;, &quot;keypress&quot;];</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineplus">+</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineplus">+function getWindowDescribeyFromEvent(event) {</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineplus">+  var win = event.target.ownerDocument.defaultView;</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineplus">+  var owningWin =</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineplus">+    win.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineplus">+       .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineplus">+       .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineplus">+       .rootTreeItem</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineplus">+       .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineplus">+       .getInterface(Ci.nsIDOMWindow);</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineplus">+  var docElem = owningWin.document.documentElement;</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineplus">+  return docElem.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineplus">+         docElem.getAttribute(&quot;id&quot;);</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineplus">+}</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineplus">+</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineplus">+function __peek_click_handler(event) {</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineplus">+  mark_action(&quot;winhelp&quot;, event.type,</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineplus">+              [&quot;mouse button&quot;, event.button,</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+               &quot;in&quot;, getWindowDescribeyFromEvent(event),</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineplus">+               &quot;original target:&quot;, normalize_for_json(event.originalTarget)]);</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+  return true;</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+}</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineplus">+</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+function __bubbled_click_handler(event) {</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineplus">+  mark_action(&quot;winhelp&quot;, &quot;bubbled &quot; + event.type,</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+              [&quot;mouse button&quot;, event.button,</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+               &quot;in&quot;, getWindowDescribeyFromEvent(event),</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+               &quot;original target:&quot;, normalize_for_json(event.originalTarget)]);</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+  return true;</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+}</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineplus">+</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+function __peek_keypress_handler(event) {</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+  mark_action(&quot;winhelp&quot;, event.type,</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineplus">+              [&quot;keycode&quot;, event.keyCode, &quot;char&quot;, event.charCode,</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineplus">+               &quot;in&quot;, getWindowDescribeyFromEvent(event)]);</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineplus">+  return true;</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineplus">+}</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineplus">+</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineplus">+</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineplus">+function __popup_showing(event) {</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineplus">+  mark_action(&quot;winhelp&quot;, &quot;popupShowing&quot;,</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineplus">+              [this,</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineplus">+               &quot;current target:&quot;, normalize_for_json(event.target)]);</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineplus">+  return true;</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineplus">+}</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineplus">+function __popup_shown(event) {</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineplus">+  mark_action(&quot;winhelp&quot;, &quot;popupShown&quot;,</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineplus">+              [this,</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+               &quot;current target:&quot;, normalize_for_json(event.target)]);</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineplus">+  return true;</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineplus">+}</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineplus">+</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineplus">+function __popup_hiding(event) {</span>
<a href="#l19.643"></a><span id="l19.643" class="difflineplus">+  mark_action(&quot;winhelp&quot;, &quot;popupHiding&quot;,</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineplus">+              [this,</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineplus">+               &quot;current target:&quot;, normalize_for_json(event.target)]);</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineplus">+  return true;</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineplus">+}</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineplus">+</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineplus">+function __popup_hidden(event) {</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+  mark_action(&quot;winhelp&quot;, &quot;popupHidden&quot;,</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+              [this,</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+               &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l19.654"></a><span id="l19.654" class="difflineplus">+               &quot;current target:&quot;, normalize_for_json(event.target)]);</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineplus">+  return true;</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineplus">+}</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineplus">+</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineplus">+</span>
<a href="#l19.659"></a><span id="l19.659"> /**</span>
<a href="#l19.660"></a><span id="l19.660">  * controller.js in mozmill actually has its own extension mechanism,</span>
<a href="#l19.661"></a><span id="l19.661">  *  controllerAdditions.  Unfortunately, it does not make its stuff public at</span>
<a href="#l19.662"></a><span id="l19.662">  *  this time.  In the future we can change ourselves to just use that</span>
<a href="#l19.663"></a><span id="l19.663">  *  mechanism.</span>
<a href="#l19.664"></a><span id="l19.664">  */</span>
<a href="#l19.665"></a><span id="l19.665"> function augment_controller(aController, aWindowType) {</span>
<a href="#l19.666"></a><span id="l19.666">   if (aWindowType === undefined)</span>
<a href="#l19.667"></a><span id="l19.667">     aWindowType =</span>
<a href="#l19.668"></a><span id="l19.668">       aController.window.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l19.669"></a><span id="l19.669"> </span>
<a href="#l19.670"></a><span id="l19.670">   _augment_helper(aController, AugmentEverybodyWith);</span>
<a href="#l19.671"></a><span id="l19.671">   if (PerWindowTypeAugmentations[aWindowType])</span>
<a href="#l19.672"></a><span id="l19.672">     _augment_helper(aController, PerWindowTypeAugmentations[aWindowType]);</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineplus">+</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineplus">+  // for debugging purposes, add our listener that sneaks a peek at clicks and</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineplus">+  //  key events</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineplus">+  try {</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+    let doc = aController.window.document;</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineplus">+</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineplus">+    doc.addEventListener(&quot;mousedown&quot;, __peek_click_handler, true);</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+    doc.addEventListener(&quot;click&quot;, __peek_click_handler, true);</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+    doc.addEventListener(&quot;contextmenu&quot;, __peek_click_handler, true);</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineplus">+    doc.addEventListener(&quot;mouseup&quot;, __peek_click_handler, true);</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineplus">+</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineplus">+    doc.addEventListener(&quot;mousedown&quot;, __bubbled_click_handler, false);</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineplus">+    doc.addEventListener(&quot;click&quot;, __bubbled_click_handler, false);</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+    doc.addEventListener(&quot;contextmenu&quot;, __bubbled_click_handler, false);</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineplus">+    doc.addEventListener(&quot;mouseup&quot;, __bubbled_click_handler, false);</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineplus">+</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineplus">+    doc.addEventListener(&quot;keypress&quot;, __peek_keypress_handler, true);</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineplus">+</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineplus">+    // - also, add pop-up shown/hidden events....</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+    // We need to add these directly to the popups themselves in order to</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+    //  see anything.</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineplus">+    let popups = doc.documentElement.getElementsByTagName(&quot;menupopup&quot;);</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineplus">+    for (let i = 0; i &lt; popups.length; i++) {</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineplus">+      let popup = popups[i];</span>
<a href="#l19.697"></a><span id="l19.697" class="difflineplus">+      popup.addEventListener(&quot;popupshowing&quot;, __popup_showing, true);</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineplus">+      popup.addEventListener(&quot;popupshown&quot;, __popup_shown, true);</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineplus">+      popup.addEventListener(&quot;popuphiding&quot;, __popup_hiding, true);</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineplus">+      popup.addEventListener(&quot;popuphidden&quot;, __popup_hidden, true);</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineplus">+    }</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineplus">+    // Now go find the anonymous popups for tree column pickers that the</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineplus">+    //  above selector could not find because they live in anonymous</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineplus">+    //  content pocket universes.</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineplus">+    let treecolses = doc.documentElement.getElementsByTagName(&quot;treecols&quot;);</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineplus">+    for (let i = 0; i &lt; treecolses.length; i++) {</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineplus">+      let treecols = treecolses[i];</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+      // The treecolpicker element itself doesn't have an id, so we have to walk</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+      // down from the parent to find it.</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+      //  treadCols</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+      //   |- hbox                item 0</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+      //   |- treecolpicker   &lt;-- item 1 this is the one we want</span>
<a href="#l19.713"></a><span id="l19.713" class="difflineplus">+      let treeColPicker = doc.getAnonymousNodes(treecols).item(1);</span>
<a href="#l19.714"></a><span id="l19.714" class="difflineplus">+      let popup = doc.getAnonymousElementByAttribute(treeColPicker,</span>
<a href="#l19.715"></a><span id="l19.715" class="difflineplus">+                                                     &quot;anonid&quot;, &quot;popup&quot;);</span>
<a href="#l19.716"></a><span id="l19.716" class="difflineplus">+      popup.addEventListener(&quot;popupshowing&quot;, __popup_showing, true);</span>
<a href="#l19.717"></a><span id="l19.717" class="difflineplus">+      popup.addEventListener(&quot;popupshown&quot;, __popup_shown, true);</span>
<a href="#l19.718"></a><span id="l19.718" class="difflineplus">+      popup.addEventListener(&quot;popuphiding&quot;, __popup_hiding, true);</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineplus">+      popup.addEventListener(&quot;popuphidden&quot;, __popup_hidden, true);</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineplus">+    }</span>
<a href="#l19.721"></a><span id="l19.721" class="difflineplus">+</span>
<a href="#l19.722"></a><span id="l19.722" class="difflineplus">+  }</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineplus">+  catch(ex) {</span>
<a href="#l19.724"></a><span id="l19.724" class="difflineplus">+    dump(&quot;!!!! failure augmenting controller: &quot; + ex + &quot;\n&quot; + ex.stack);</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineplus">+  }</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineplus">+</span>
<a href="#l19.727"></a><span id="l19.727" class="difflineplus">+</span>
<a href="#l19.728"></a><span id="l19.728">   return aController;</span>
<a href="#l19.729"></a><span id="l19.729"> }</span>
<a href="#l19.730"></a><span id="l19.730" class="difflineplus">+</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineplus">+/**</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineplus">+ * Render the contents of a window to a data URL.  Every effort is made to</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineplus">+ * make the screenshot as real as possible, but currently this is all done using</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineplus">+ * canvas-based rendering which is not the same thing as a real screenshot.</span>
<a href="#l19.735"></a><span id="l19.735" class="difflineplus">+ *</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineplus">+ * @param aWindow The window to render</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineplus">+ */</span>
<a href="#l19.738"></a><span id="l19.738" class="difflineplus">+function screenshotToDataURL(aWindow) {</span>
<a href="#l19.739"></a><span id="l19.739" class="difflineplus">+  // -- render to canvas</span>
<a href="#l19.740"></a><span id="l19.740" class="difflineplus">+  let win = aWindow;</span>
<a href="#l19.741"></a><span id="l19.741" class="difflineplus">+  let doc = win.document;</span>
<a href="#l19.742"></a><span id="l19.742" class="difflineplus">+  let canvas = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;canvas&quot;);</span>
<a href="#l19.743"></a><span id="l19.743" class="difflineplus">+  let width = win.innerWidth;</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineplus">+  let height = win.innerHeight;</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineplus">+</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineplus">+  canvas.style.width = width + &quot;px&quot;;</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineplus">+  canvas.style.height = height + &quot;px&quot;;</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineplus">+  canvas.width = width;</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineplus">+  canvas.height = height;</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineplus">+  let ctx = canvas.getContext(&quot;2d&quot;);</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineplus">+  // We use the following flags, which appear to avoid us needing to</span>
<a href="#l19.752"></a><span id="l19.752" class="difflineplus">+  // recursively render the contained iframes/browsers.  Or the behaviour</span>
<a href="#l19.753"></a><span id="l19.753" class="difflineplus">+  // changed a while ago and we never noticed.</span>
<a href="#l19.754"></a><span id="l19.754" class="difflineplus">+  //  DRAWWINDOW_DRAW_VIEW = 0x04</span>
<a href="#l19.755"></a><span id="l19.755" class="difflineplus">+  //  DRAWWINDOW_USE_WIDGET_LAYERS = 0x08</span>
<a href="#l19.756"></a><span id="l19.756" class="difflineplus">+  ctx.drawWindow(win, 0, 0, width, height, &quot;rgb(0,0,0)&quot;,</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineplus">+                 0x04 | 0x08);</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineplus">+</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineplus">+  // As per the note about flags above, we no longer appear to need to do</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineplus">+  // the following, so it is commented out.  It is left around rather than</span>
<a href="#l19.761"></a><span id="l19.761" class="difflineplus">+  // deleted because in the event we do need it again, this has some</span>
<a href="#l19.762"></a><span id="l19.762" class="difflineplus">+  // improvements on the other variations a search might turn up.</span>
<a href="#l19.763"></a><span id="l19.763" class="difflineplus">+  //</span>
<a href="#l19.764"></a><span id="l19.764" class="difflineplus">+  // (We may need to do this for popups...)</span>
<a href="#l19.765"></a><span id="l19.765" class="difflineplus">+  /*</span>
<a href="#l19.766"></a><span id="l19.766" class="difflineplus">+  // - find all the sub-windows and render them</span>
<a href="#l19.767"></a><span id="l19.767" class="difflineplus">+  function isVisible(aElem) {</span>
<a href="#l19.768"></a><span id="l19.768" class="difflineplus">+    if (aElem.hidden || aElem.collapsed)</span>
<a href="#l19.769"></a><span id="l19.769" class="difflineplus">+      return false;</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineplus">+    let parent = aElem.parentNode;</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineplus">+    if (parent == null)</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineplus">+      return true;</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineplus">+    if ((&quot;selectedPanel&quot; in parent) &amp;&amp;</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineplus">+        parent.selectedPanel != aElem)</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineplus">+      return false;</span>
<a href="#l19.776"></a><span id="l19.776" class="difflineplus">+    return isVisible(parent);</span>
<a href="#l19.777"></a><span id="l19.777" class="difflineplus">+  }</span>
<a href="#l19.778"></a><span id="l19.778" class="difflineplus">+</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineplus">+  function subrenderCandidates(aElements) {</span>
<a href="#l19.780"></a><span id="l19.780" class="difflineplus">+    for (let i = 0; i &lt; aElements.length; i++) {</span>
<a href="#l19.781"></a><span id="l19.781" class="difflineplus">+      let elem = aElements[i];</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineplus">+      if (isVisible(elem)) {</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineplus">+        let rect = elem.getBoundingClientRect();</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineplus">+        ctx.save();</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineplus">+        ctx.translate(rect.left, rect.top);</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineplus">+        ctx.drawWindow(elem.contentWindow,</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineplus">+                       0, 0,</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineplus">+                       rect.right - rect.left, rect.bottom - rect.top,</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineplus">+                       &quot;rgb(255,255,255)&quot;);</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineplus">+        ctx.restore();</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineplus">+      }</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineplus">+    }</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineplus">+  }</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineplus">+  subrenderCandidates(doc.documentElement.getElementsByTagName(&quot;iframe&quot;));</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineplus">+  subrenderCandidates(doc.documentElement.getElementsByTagName(&quot;browser&quot;));</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineplus">+  */</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineplus">+</span>
<a href="#l19.798"></a><span id="l19.798" class="difflineplus">+  return canvas.toDataURL(&quot;image/png&quot;, &quot;&quot;);</span>
<a href="#l19.799"></a><span id="l19.799" class="difflineplus">+}</span>
<a href="#l19.800"></a><span id="l19.800" class="difflineplus">+</span>
<a href="#l19.801"></a><span id="l19.801" class="difflineplus">+/**</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineplus">+ * Render the contents of a window to a base64-encoded string.</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineplus">+ */</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineplus">+function screenshotToBase64(aWindow) {</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineplus">+  let dataUrl = screenshotToDataURL(aWindow);</span>
<a href="#l19.806"></a><span id="l19.806" class="difflineplus">+  return dataUrl.substring(dataUrl.indexOf(&quot;base64,&quot;) + 7);</span>
<a href="#l19.807"></a><span id="l19.807" class="difflineplus">+}</span>
<a href="#l19.808"></a><span id="l19.808" class="difflineplus">+</span>
<a href="#l19.809"></a><span id="l19.809" class="difflineplus">+/**</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineplus">+ * Capture general information on the state of all open windows and provide</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineplus">+ *  them in a JSON-serializable object blob.</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineplus">+ *</span>
<a href="#l19.813"></a><span id="l19.813" class="difflineplus">+ * Specific details for each window:</span>
<a href="#l19.814"></a><span id="l19.814" class="difflineplus">+ * - Screen coordinates and dimensions of the window.</span>
<a href="#l19.815"></a><span id="l19.815" class="difflineplus">+ * - Is the window active/focused?</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineplus">+ * - The focused element in the window; we leave this up to logHelper to</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineplus">+ *    describe.</span>
<a href="#l19.818"></a><span id="l19.818" class="difflineplus">+ */</span>
<a href="#l19.819"></a><span id="l19.819" class="difflineplus">+function captureWindowStatesForErrorReporting(normalizeForJsonFunc) {</span>
<a href="#l19.820"></a><span id="l19.820" class="difflineplus">+  let info = {};</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineplus">+  let windows = info.windows = [];</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineplus">+</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineplus">+  let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineplus">+                         .getService(Ci.nsIWindowMediator);</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineplus">+</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineplus">+  let enumerator = windowMediator.getEnumerator(null);</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineplus">+  let iWin=0;</span>
<a href="#l19.828"></a><span id="l19.828" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l19.829"></a><span id="l19.829" class="difflineplus">+    let win = enumerator.getNext().QueryInterface(Ci.nsIDOMWindowInternal);</span>
<a href="#l19.830"></a><span id="l19.830" class="difflineplus">+</span>
<a href="#l19.831"></a><span id="l19.831" class="difflineplus">+    let winId = win.document.documentElement.getAttribute(&quot;windowtype&quot;) ||</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineplus">+                win.document.documentElement.getAttribute(&quot;id&quot;) ||</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineplus">+                (&quot;unnamed:&quot; + iWin);</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineplus">+</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineplus">+    let openPopups =</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineplus">+      Array.prototype.slice.call(</span>
<a href="#l19.837"></a><span id="l19.837" class="difflineplus">+          win.document.documentElement.getElementsByTagName(&quot;menupopup&quot;))</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineplus">+        .filter(function(x) x.state != &quot;closed&quot;)</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineplus">+        .map(function (x) normalizeForJsonFunc(x));</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineplus">+</span>
<a href="#l19.841"></a><span id="l19.841" class="difflineplus">+    let ignoredFocusedWindow = {};</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineplus">+    let winfo = {</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineplus">+      id: winId,</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineplus">+      title: win.document.title,</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineplus">+      coords: {x: win.screenX, y: win.screenY},</span>
<a href="#l19.846"></a><span id="l19.846" class="difflineplus">+      dims: {width: win.outerWidth, height: win.outerHeight},</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineplus">+      pageOffsets: {x: win.pageXOffset, y: win.pageYOffset},</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineplus">+      screenshotDataUrl: screenshotToDataURL(win),</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineplus">+      isActive: focusManager.activeWindow == win,</span>
<a href="#l19.850"></a><span id="l19.850" class="difflineplus">+      focusedElem: normalizeForJsonFunc(</span>
<a href="#l19.851"></a><span id="l19.851" class="difflineplus">+        focusManager.getFocusedElementForWindow(win, true,</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineplus">+                                                ignoredFocusedWindow)),</span>
<a href="#l19.853"></a><span id="l19.853" class="difflineplus">+      openPopups: openPopups,</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineplus">+    };</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineplus">+</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineplus">+    windows.push(winfo);</span>
<a href="#l19.857"></a><span id="l19.857" class="difflineplus">+  }</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineplus">+</span>
<a href="#l19.859"></a><span id="l19.859" class="difflineplus">+  return info;</span>
<a href="#l19.860"></a><span id="l19.860" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/db/gloda/modules/log4moz.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/log4moz.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -187,16 +187,17 @@ let Log4Moz = {</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5">   get Formatter() { return Formatter; },</span>
<a href="#l20.6"></a><span id="l20.6">   get BasicFormatter() { return BasicFormatter; },</span>
<a href="#l20.7"></a><span id="l20.7">   get XMLFormatter() { return XMLFormatter; },</span>
<a href="#l20.8"></a><span id="l20.8">   get JSONFormatter() { return JSONFormatter; },</span>
<a href="#l20.9"></a><span id="l20.9">   get Appender() { return Appender; },</span>
<a href="#l20.10"></a><span id="l20.10">   get DumpAppender() { return DumpAppender; },</span>
<a href="#l20.11"></a><span id="l20.11">   get ConsoleAppender() { return ConsoleAppender; },</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+  get TimeAwareMemoryBucketAppender() { return TimeAwareMemoryBucketAppender; },</span>
<a href="#l20.13"></a><span id="l20.13">   get FileAppender() { return FileAppender; },</span>
<a href="#l20.14"></a><span id="l20.14">   get SocketAppender() { return SocketAppender; },</span>
<a href="#l20.15"></a><span id="l20.15">   get RotatingFileAppender() { return RotatingFileAppender; },</span>
<a href="#l20.16"></a><span id="l20.16">   get ThrowingAppender() { return ThrowingAppender; },</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">   // Logging helper:</span>
<a href="#l20.19"></a><span id="l20.19">   // let logger = Log4Moz.repository.getLogger(&quot;foo&quot;);</span>
<a href="#l20.20"></a><span id="l20.20">   // logger.info(Log4Moz.enumerateInterfaces(someObject).join(&quot;,&quot;));</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineat">@@ -233,17 +234,17 @@ let Log4Moz = {</span>
<a href="#l20.22"></a><span id="l20.22">       }</span>
<a href="#l20.23"></a><span id="l20.23">     }</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25">     return properties;</span>
<a href="#l20.26"></a><span id="l20.26">   }</span>
<a href="#l20.27"></a><span id="l20.27"> };</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29"> function LoggerContext() {</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  this._started = this.lastStateChange = Date.now();</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+  this._started = this._lastStateChange = Date.now();</span>
<a href="#l20.32"></a><span id="l20.32">   this._state = &quot;started&quot;;</span>
<a href="#l20.33"></a><span id="l20.33"> }</span>
<a href="#l20.34"></a><span id="l20.34"> LoggerContext.prototype = {</span>
<a href="#l20.35"></a><span id="l20.35">   _jsonMe: true,</span>
<a href="#l20.36"></a><span id="l20.36">   _id: &quot;unknown&quot;,</span>
<a href="#l20.37"></a><span id="l20.37">   setState: function LoggerContext_state(aState) {</span>
<a href="#l20.38"></a><span id="l20.38">     this._state = aState;</span>
<a href="#l20.39"></a><span id="l20.39">     this._lastStateChange = Date.now();</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineat">@@ -525,16 +526,22 @@ XMLFormatter.prototype = {</span>
<a href="#l20.41"></a><span id="l20.41"> };</span>
<a href="#l20.42"></a><span id="l20.42"> </span>
<a href="#l20.43"></a><span id="l20.43"> function JSONFormatter() {</span>
<a href="#l20.44"></a><span id="l20.44"> }</span>
<a href="#l20.45"></a><span id="l20.45"> JSONFormatter.prototype = {</span>
<a href="#l20.46"></a><span id="l20.46">   __proto__: Formatter.prototype,</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48">   format: function JF_format(message) {</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+    // XXX I did all kinds of questionable things in here; they should be</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+    //  resolved...</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    // 1) JSON does not walk the __proto__ chain; there is no need to clobber</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+    //   it.</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+    // 2) Our net mutation is sorta redundant messageObjects alongside</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+    //   msgObjects, although we only serialize one.</span>
<a href="#l20.55"></a><span id="l20.55">     let origMessageObjects = message.messageObjects;</span>
<a href="#l20.56"></a><span id="l20.56">     message.messageObjects = [];</span>
<a href="#l20.57"></a><span id="l20.57">     let reProto = [];</span>
<a href="#l20.58"></a><span id="l20.58">     for each (let [, messageObject] in Iterator(origMessageObjects)) {</span>
<a href="#l20.59"></a><span id="l20.59">       if (messageObject)</span>
<a href="#l20.60"></a><span id="l20.60">         if (messageObject._jsonMe) {</span>
<a href="#l20.61"></a><span id="l20.61">           message.messageObjects.push(messageObject);</span>
<a href="#l20.62"></a><span id="l20.62">           // temporarily strip the prototype to avoid JSONing the impl.</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineat">@@ -596,16 +603,75 @@ function DumpAppender(formatter) {</span>
<a href="#l20.64"></a><span id="l20.64"> DumpAppender.prototype = {</span>
<a href="#l20.65"></a><span id="l20.65">   __proto__: Appender.prototype,</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">   doAppend: function DApp_doAppend(message) {</span>
<a href="#l20.68"></a><span id="l20.68">     dump(message);</span>
<a href="#l20.69"></a><span id="l20.69">   }</span>
<a href="#l20.70"></a><span id="l20.70"> };</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+/**</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+ * An in-memory appender that always logs to its in-memory bucket and associates</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+ * each message with a timestamp.  Whoever creates us is responsible for causing</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+ * us to switch to a new bucket using whatever criteria is appropriate.</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+ *</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+ * This is intended to be used roughly like an in-memory circular buffer.  The</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+ * expectation is that we are being used for unit tests and that each unit test</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+ * function will get its own bucket.  In the event that a test fails we would</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+ * be asked for the contents of the current bucket and some portion of the</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+ * previous bucket using up to some duration.</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+ */</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+function TimeAwareMemoryBucketAppender() {</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+  this._name = &quot;TimeAwareMemoryBucketAppender&quot;;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+  this._level = Log4Moz.Level.All;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  this._lastBucket = null;</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+  // to minimize object construction, even indices are timestamps, odd indices</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  //  are the message objects.</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+  this._curBucket = [];</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+  this._curBucketStartedAt = Date.now();</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+}</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+TimeAwareMemoryBucketAppender.prototype = {</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+  get level() { return this._level; },</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+  set level(level) { this._level = level; },</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+  append: function TAMBA_append(message) {</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+    if (this._level &lt;= message.level)</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+      this._curBucket.push(message);</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+  },</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+  newBucket: function() {</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+    this._lastBucket = this._curBucket;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+    this._curBucketStartedAt = Date.now();</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+    this._curBucket = [];</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  },</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+  getPreviousBucketEvents: function(aNumMS) {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+    let lastBucket = this._lastBucket;</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+    if (lastBucket == null || !lastBucket.length)</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+      return [];</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+    let timeBound = this._curBucketStartedAt - aNumMS;</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+    // seek backwards through the list...</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+    let i;</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+    for (i = lastBucket.length - 1; i &gt;= 0; i --) {</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+      if (lastBucket[i].time &lt; timeBound)</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+        break;</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+    }</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+    return lastBucket.slice(i+1);</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+  },</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+  getBucketEvents: function() {</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+    return this._curBucket.concat();</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+  },</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+  toString: function() {</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+    return &quot;[TimeAwareMemoryBucketAppender]&quot;;</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+  },</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+};</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+</span>
<a href="#l20.131"></a><span id="l20.131"> /*</span>
<a href="#l20.132"></a><span id="l20.132">  * ConsoleAppender</span>
<a href="#l20.133"></a><span id="l20.133">  * Logs to the javascript console</span>
<a href="#l20.134"></a><span id="l20.134">  */</span>
<a href="#l20.135"></a><span id="l20.135"> </span>
<a href="#l20.136"></a><span id="l20.136"> function ConsoleAppender(formatter) {</span>
<a href="#l20.137"></a><span id="l20.137">   this._name = &quot;ConsoleAppender&quot;;</span>
<a href="#l20.138"></a><span id="l20.138">   this._formatter = formatter;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/test/resources/logHelper.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/test/resources/logHelper.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -295,17 +295,18 @@ function __simple_obj_copy(aObj, aDepthA</span>
<a href="#l21.4"></a><span id="l21.4">     }</span>
<a href="#l21.5"></a><span id="l21.5">     else if (typeof(value) != &quot;object&quot;) {</span>
<a href="#l21.6"></a><span id="l21.6">       oot[key] = value;</span>
<a href="#l21.7"></a><span id="l21.7">     }</span>
<a href="#l21.8"></a><span id="l21.8">     // steal control flow if no more depth is allowed</span>
<a href="#l21.9"></a><span id="l21.9">     else if (!aDepthAllowed) {</span>
<a href="#l21.10"></a><span id="l21.10">       oot[key] = &quot;truncated, string rep: &quot; + value.toString();</span>
<a href="#l21.11"></a><span id="l21.11">     }</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    // array?  we don't count that as depth for now.</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+    // array?  (not directly counted, but we will terminate because the</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+    //  child copying occurs using nextDepth...)</span>
<a href="#l21.15"></a><span id="l21.15">     else if (Array.isArray(value)) {</span>
<a href="#l21.16"></a><span id="l21.16">       oot[key] = [__value_copy(v, nextDepth) for each</span>
<a href="#l21.17"></a><span id="l21.17">                    ([, v] in Iterator(value))];</span>
<a href="#l21.18"></a><span id="l21.18">     }</span>
<a href="#l21.19"></a><span id="l21.19">     // it's another object! woo!</span>
<a href="#l21.20"></a><span id="l21.20">     else {</span>
<a href="#l21.21"></a><span id="l21.21">       oot[key] = _normalize_for_json(value, nextDepth, true);</span>
<a href="#l21.22"></a><span id="l21.22">     }</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineat">@@ -340,16 +341,21 @@ function _normalize_for_json(aObj, aDept</span>
<a href="#l21.24"></a><span id="l21.24">     aDepthAllowed = 2;</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26">   // if it's a simple type just return it direct</span>
<a href="#l21.27"></a><span id="l21.27">   if (typeof(aObj) != &quot;object&quot;)</span>
<a href="#l21.28"></a><span id="l21.28">     return aObj;</span>
<a href="#l21.29"></a><span id="l21.29">   else if (aObj == null)</span>
<a href="#l21.30"></a><span id="l21.30">     return aObj;</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+  // recursively transform arrays outright</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+  if (Array.isArray(aObj))</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+      return [__value_copy(v, aDepthAllowed - 1) for each</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+              ([, v] in Iterator(aObj))];</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+</span>
<a href="#l21.37"></a><span id="l21.37">   // === Mail Specific ===</span>
<a href="#l21.38"></a><span id="l21.38">   // (but common and few enough to not split out)</span>
<a href="#l21.39"></a><span id="l21.39">   if (aObj instanceof Ci.nsIMsgFolder) {</span>
<a href="#l21.40"></a><span id="l21.40">     let flags = aObj.flags;</span>
<a href="#l21.41"></a><span id="l21.41">     return {</span>
<a href="#l21.42"></a><span id="l21.42">       type: &quot;folder&quot;,</span>
<a href="#l21.43"></a><span id="l21.43">       name: aObj.prettiestName,</span>
<a href="#l21.44"></a><span id="l21.44">       uri: aObj.URI,</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineat">@@ -382,21 +388,30 @@ function _normalize_for_json(aObj, aDept</span>
<a href="#l21.46"></a><span id="l21.46">   }</span>
<a href="#l21.47"></a><span id="l21.47">   // === Generic ===</span>
<a href="#l21.48"></a><span id="l21.48">   // DOM nodes, including elements</span>
<a href="#l21.49"></a><span id="l21.49">   else if (aObj instanceof Ci.nsIDOMNode) {</span>
<a href="#l21.50"></a><span id="l21.50">     let name = aObj.nodeName;</span>
<a href="#l21.51"></a><span id="l21.51">     if (aObj instanceof Ci.nsIDOMElement)</span>
<a href="#l21.52"></a><span id="l21.52">       name += &quot;#&quot; + aObj.getAttribute(&quot;id&quot;);</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+    let nodeAttrs = aObj.attributes, objAttrs = {};</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+    for (let iAttr = 0; iAttr &lt; nodeAttrs.length; iAttr++) {</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+      objAttrs[nodeAttrs[iAttr].name] = nodeAttrs[iAttr].value;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+    }</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+    let bounds = aObj.getBoundingClientRect();</span>
<a href="#l21.60"></a><span id="l21.60">     return {</span>
<a href="#l21.61"></a><span id="l21.61">       type: &quot;domNode&quot;,</span>
<a href="#l21.62"></a><span id="l21.62">       name: name,</span>
<a href="#l21.63"></a><span id="l21.63">       value: aObj.nodeValue,</span>
<a href="#l21.64"></a><span id="l21.64">       namespace: aObj.namespaceURI,</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+      boundingClientRect: {left: bounds.left, top: bounds.top,</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+                           width: bounds.width, height: bounds.height},</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+      attrs: objAttrs,</span>
<a href="#l21.68"></a><span id="l21.68">     };</span>
<a href="#l21.69"></a><span id="l21.69">   }</span>
<a href="#l21.70"></a><span id="l21.70">   // Although straight JS exceptions should serialize pretty well, we can</span>
<a href="#l21.71"></a><span id="l21.71">   //  improve things by making &quot;stack&quot; more friendly.</span>
<a href="#l21.72"></a><span id="l21.72">   else if (aObj instanceof Error) {</span>
<a href="#l21.73"></a><span id="l21.73">     return {</span>
<a href="#l21.74"></a><span id="l21.74">       type: &quot;error&quot;,</span>
<a href="#l21.75"></a><span id="l21.75">       message: aObj.message,</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineat">@@ -496,17 +511,18 @@ function _MarkAction(aWho, aWhat, aArgs)</span>
<a href="#l21.77"></a><span id="l21.77">  * @param aArgs A list of arguments, which could each be something like an</span>
<a href="#l21.78"></a><span id="l21.78">  *     nsIMsgFolder or nsIMsgDBHdr or something like that.  It uses</span>
<a href="#l21.79"></a><span id="l21.79">  *     |_normalize_for_json| which can handle some native objects, be extended</span>
<a href="#l21.80"></a><span id="l21.80">  *     to handle more, and does a fair job on straight JS objects.</span>
<a href="#l21.81"></a><span id="l21.81">  */</span>
<a href="#l21.82"></a><span id="l21.82"> function mark_action(aWho, aWhat, aArgs) {</span>
<a href="#l21.83"></a><span id="l21.83">   let logger = Log4Moz.repository.getLogger(&quot;test.&quot; + aWho);</span>
<a href="#l21.84"></a><span id="l21.84"> </span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-  aArgs = [_normalize_for_json(arg) for each ([, arg] in Iterator(aArgs))];</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+  aArgs = [_normalize_for_json(arg, undefined, true) for each</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+           ([, arg] in Iterator(aArgs))];</span>
<a href="#l21.88"></a><span id="l21.88">   logger.info(_testLoggerActiveContext, new _MarkAction(aWho, aWhat, aArgs));</span>
<a href="#l21.89"></a><span id="l21.89"> }</span>
<a href="#l21.90"></a><span id="l21.90"> </span>
<a href="#l21.91"></a><span id="l21.91"> /*</span>
<a href="#l21.92"></a><span id="l21.92">  * Wrap the xpcshell test functions that do interesting things.  The idea is</span>
<a href="#l21.93"></a><span id="l21.93">  *  that we clobber these only if we're going to value-add; that decision</span>
<a href="#l21.94"></a><span id="l21.94">  *  gets made up top in the initialization function.</span>
<a href="#l21.95"></a><span id="l21.95">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/test/resources/messageInjection.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/test/resources/messageInjection.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -445,16 +445,21 @@ function get_trash_folder() {</span>
<a href="#l22.4"></a><span id="l22.4">  *     those attribute things.</span>
<a href="#l22.5"></a><span id="l22.5">  * @param aBooleanAnd Should the search terms be and-ed together.</span>
<a href="#l22.6"></a><span id="l22.6">  * @param [aName] Name to use.</span>
<a href="#l22.7"></a><span id="l22.7">  */</span>
<a href="#l22.8"></a><span id="l22.8"> function make_virtual_folder(aFolders, aSearchDef, aBooleanAnd, aName) {</span>
<a href="#l22.9"></a><span id="l22.9">   let mis = _messageInjectionSetup;</span>
<a href="#l22.10"></a><span id="l22.10">   let name = aName ? aName : &quot;virt&quot; + mis._nextUniqueFolderId++;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+  mark_action(&quot;messageInjection&quot;, &quot;make_virtual_folder&quot;,</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+              [&quot;creating folder named&quot;, name,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+               &quot;from folders&quot;, aFolders, &quot;anding?&quot;, aBooleanAnd,</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+               &quot;using search def&quot;, aSearchDef]);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+</span>
<a href="#l22.17"></a><span id="l22.17">   let terms = [];</span>
<a href="#l22.18"></a><span id="l22.18">   let termCreator = Components.classes[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l22.19"></a><span id="l22.19">                               .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l22.20"></a><span id="l22.20">   for each (let [key, val] in Iterator(aSearchDef)) {</span>
<a href="#l22.21"></a><span id="l22.21">     let term = termCreator.createTerm();</span>
<a href="#l22.22"></a><span id="l22.22">     let value = term.value;</span>
<a href="#l22.23"></a><span id="l22.23">     value.str = val;</span>
<a href="#l22.24"></a><span id="l22.24">     term.value = value;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

