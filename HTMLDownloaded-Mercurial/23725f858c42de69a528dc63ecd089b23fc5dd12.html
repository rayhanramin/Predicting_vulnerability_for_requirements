<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22201:23725f858c42de69a528dc63ecd089b23fc5dd12</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 23725f858c42de69a528dc63ecd089b23fc5dd12" />
<meta property="og:url" content="/comm-central/rev/23725f858c42de69a528dc63ecd089b23fc5dd12" />
<meta property="og:description" content="Bug 312593 - Allow unicode in passwords. r=neil,standard8,jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 23725f858c42de69a528dc63ecd089b23fc5dd12 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/23725f858c42de69a528dc63ecd089b23fc5dd12">shortlog</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/23725f858c42de69a528dc63ecd089b23fc5dd12">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12">files</a> |
changeset |
<a href="/comm-central/raw-rev/23725f858c42de69a528dc63ecd089b23fc5dd12">raw</a>  | <a href="/comm-central/archive/23725f858c42de69a528dc63ecd089b23fc5dd12.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=312593">Bug 312593</a> - Allow unicode in passwords. r=neil,standard8,jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#100;&#97;&#118;&#105;&#100;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Jul 2012 16:52:00 +0200</td></tr>

<tr>
 <td>changeset 22201</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/23725f858c42de69a528dc63ecd089b23fc5dd12">23725f858c42de69a528dc63ecd089b23fc5dd12</a></td>
</tr>



<tr>
<td>parent 22200</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d2b98c955e08bcd938971ab2950ebef8307df156">d2b98c955e08bcd938971ab2950ebef8307df156</a>
</td>
</tr>

<tr>
<td>child 22202</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/61251d6ba888a140ce843319b86a8050164cb9ed">61251d6ba888a140ce843319b86a8050164cb9ed</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=23725f858c42de69a528dc63ecd089b23fc5dd12">13549</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 23 Sep 2017 23:12:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@23725f858c42 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=23725f858c42de69a528dc63ecd089b23fc5dd12">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=23725f858c42de69a528dc63ecd089b23fc5dd12&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=23725f858c42de69a528dc63ecd089b23fc5dd12&newProject=comm-central&newRevision=d2b98c955e08bcd938971ab2950ebef8307df156&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=23725f858c42de69a528dc63ecd089b23fc5dd12&newProject=comm-central&newRevision=d2b98c955e08bcd938971ab2950ebef8307df156&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=23725f858c42de69a528dc63ecd089b23fc5dd12&newProject=comm-central&newRevision=d2b98c955e08bcd938971ab2950ebef8307df156&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a>, <a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=312593">312593</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=312593">Bug 312593</a> - Allow unicode in passwords. r=neil,standard8,jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/public/nsIMsgIncomingServer.idl">mailnews/base/public/nsIMsgIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/public/nsIMsgIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/public/nsIMsgIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/public/nsIMsgIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/public/nsIMsgIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/public/nsIMsgIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.h">mailnews/base/util/nsMsgIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.h">mailnews/base/util/nsMsgProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/base/util/nsMsgProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgComposeParams.idl">mailnews/compose/public/nsIMsgComposeParams.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgComposeParams.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgComposeParams.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgComposeParams.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgComposeParams.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgComposeParams.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpServer.idl">mailnews/compose/public/nsISmtpServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpServer.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpServer.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpServer.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpServer.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpService.idl">mailnews/compose/public/nsISmtpService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpService.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpService.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpService.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpService.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/public/nsISmtpService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.cpp">mailnews/compose/src/nsMsgComposeParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.h">mailnews/compose/src/nsMsgComposeParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgComposeParams.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.h">mailnews/compose/src/nsSmtpServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIIMAPHostSessionList.h">mailnews/imap/public/nsIIMAPHostSessionList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIIMAPHostSessionList.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIIMAPHostSessionList.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIIMAPHostSessionList.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIIMAPHostSessionList.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIIMAPHostSessionList.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapIncomingServer.idl">mailnews/imap/public/nsIImapIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapProtocol.idl">mailnews/imap/public/nsIImapProtocol.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapProtocol.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapProtocol.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapProtocol.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapProtocol.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapProtocol.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapServerSink.idl">mailnews/imap/public/nsIImapServerSink.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapServerSink.idl">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapServerSink.idl">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapServerSink.idl">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapServerSink.idl">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/public/nsIImapServerSink.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.cpp">mailnews/imap/src/nsIMAPHostSessionList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.h">mailnews/imap/src/nsIMAPHostSessionList.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsIMAPHostSessionList.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsSyncRunnableHelpers.cpp">mailnews/imap/src/nsSyncRunnableHelpers.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsSyncRunnableHelpers.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsSyncRunnableHelpers.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsSyncRunnableHelpers.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsSyncRunnableHelpers.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/imap/src/nsSyncRunnableHelpers.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.h">mailnews/local/src/nsPop3Protocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.h">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.h">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.h">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.h">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/src/nsPop3Protocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/test/unit/test_pop3PasswordFailure.js">mailnews/local/test/unit/test_pop3PasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/test/unit/test_pop3PasswordFailure.js">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/test/unit/test_pop3PasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/test/unit/test_pop3PasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/test/unit/test_pop3PasswordFailure.js">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/local/test/unit/test_pop3PasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/mapi/mapihook/src/msgMapiHook.cpp">mailnews/mapi/mapihook/src/msgMapiHook.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/mapi/mapihook/src/msgMapiHook.cpp">file</a> |
<a href="/comm-central/annotate/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/mapi/mapihook/src/msgMapiHook.cpp">annotate</a> |
<a href="/comm-central/diff/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/mapi/mapihook/src/msgMapiHook.cpp">diff</a> |
<a href="/comm-central/comparison/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/mapi/mapihook/src/msgMapiHook.cpp">comparison</a> |
<a href="/comm-central/log/23725f858c42de69a528dc63ecd089b23fc5dd12/mailnews/mapi/mapihook/src/msgMapiHook.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -97,18 +97,18 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l1.4"></a><span id="l1.4">    * message folders associated with this server.</span>
<a href="#l1.5"></a><span id="l1.5">    */</span>
<a href="#l1.6"></a><span id="l1.6">   readonly attribute ACString localDatabaseType;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   // Perform specific tasks (reset flags, remove files, etc) for account user/server name changes.</span>
<a href="#l1.9"></a><span id="l1.9">   void onUserOrHostNameChanged(in ACString oldName, in ACString newName,</span>
<a href="#l1.10"></a><span id="l1.10">                                in bool hostnameChanged);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  /* cleartext version of the password */</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  attribute ACString password;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  /// cleartext utf16 version of the password</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  attribute AString password;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   /**</span>
<a href="#l1.18"></a><span id="l1.18">    * Attempts to get the password first from the password manager, if that</span>
<a href="#l1.19"></a><span id="l1.19">    * fails it will attempt to get it from the user if aMsgWindow is supplied.</span>
<a href="#l1.20"></a><span id="l1.20">    *</span>
<a href="#l1.21"></a><span id="l1.21">    * @param aPromptString  The text of the prompt if the user is prompted for</span>
<a href="#l1.22"></a><span id="l1.22">    *                       password.</span>
<a href="#l1.23"></a><span id="l1.23">    * @param aPromptTitle   The title of the prompt if the user is prompted.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -116,17 +116,17 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l1.25"></a><span id="l1.25">    * @return               The obtained password. Could be an empty password.</span>
<a href="#l1.26"></a><span id="l1.26">    *</span>
<a href="#l1.27"></a><span id="l1.27">    * @exception NS_ERROR_FAILURE  The password could not be obtained.</span>
<a href="#l1.28"></a><span id="l1.28">    *</span>
<a href="#l1.29"></a><span id="l1.29">    * @note NS_MSG_PASSWORD_PROMPT_CANCELLED is a success code that is returned</span>
<a href="#l1.30"></a><span id="l1.30">    *       if the prompt was presented to the user but the user cancelled the</span>
<a href="#l1.31"></a><span id="l1.31">    *       prompt.</span>
<a href="#l1.32"></a><span id="l1.32">    */</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  ACString getPasswordWithUI(in AString aPromptString, in AString aPromptTitle,</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  AString getPasswordWithUI(in AString aPromptString, in AString aPromptTitle,</span>
<a href="#l1.35"></a><span id="l1.35">                              in nsIMsgWindow aMsgWindow);</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   /* forget the password in memory and in single signon database */</span>
<a href="#l1.38"></a><span id="l1.38">   void forgetPassword();</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40">   /* forget the password in memory which is cached for the session */</span>
<a href="#l1.41"></a><span id="l1.41">   void forgetSessionPassword();</span>
<a href="#l1.42"></a><span id="l1.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1599,17 +1599,17 @@ nsMsgAccountManager::CleanupOnExit()</span>
<a href="#l2.4"></a><span id="l2.4">       nsCString type;</span>
<a href="#l2.5"></a><span id="l2.5">       server-&gt;GetType(type);</span>
<a href="#l2.6"></a><span id="l2.6">       if (root)</span>
<a href="#l2.7"></a><span id="l2.7">       {</span>
<a href="#l2.8"></a><span id="l2.8">         nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l2.9"></a><span id="l2.9">         folder = do_QueryInterface(root);</span>
<a href="#l2.10"></a><span id="l2.10">         if (folder)</span>
<a href="#l2.11"></a><span id="l2.11">         {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-          nsCString passwd;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+          nsString passwd;</span>
<a href="#l2.14"></a><span id="l2.14">           bool serverRequiresPasswordForAuthentication = true;</span>
<a href="#l2.15"></a><span id="l2.15">           bool isImap = type.EqualsLiteral(&quot;imap&quot;);</span>
<a href="#l2.16"></a><span id="l2.16">           if (isImap)</span>
<a href="#l2.17"></a><span id="l2.17">           {</span>
<a href="#l2.18"></a><span id="l2.18">             server-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPasswordForAuthentication);</span>
<a href="#l2.19"></a><span id="l2.19">             server-&gt;GetPassword(passwd);</span>
<a href="#l2.20"></a><span id="l2.20">           }</span>
<a href="#l2.21"></a><span id="l2.21">           if (!isImap || (isImap &amp;&amp; (!serverRequiresPasswordForAuthentication || !passwd.IsEmpty())))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -641,23 +641,23 @@ NS_IMETHODIMP</span>
<a href="#l3.4"></a><span id="l3.4"> nsMsgIncomingServer::ToString(nsAString&amp; aResult)</span>
<a href="#l3.5"></a><span id="l3.5"> {</span>
<a href="#l3.6"></a><span id="l3.6">   aResult.AssignLiteral(&quot;[nsIMsgIncomingServer: &quot;);</span>
<a href="#l3.7"></a><span id="l3.7">   aResult.Append(NS_ConvertASCIItoUTF16(m_serverKey));</span>
<a href="#l3.8"></a><span id="l3.8">   aResult.AppendLiteral(&quot;]&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">   return NS_OK;</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::SetPassword(const nsACString&amp; aPassword)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::SetPassword(const nsAString&amp; aPassword)</span>
<a href="#l3.14"></a><span id="l3.14"> {</span>
<a href="#l3.15"></a><span id="l3.15">   m_password = aPassword;</span>
<a href="#l3.16"></a><span id="l3.16">   return NS_OK;</span>
<a href="#l3.17"></a><span id="l3.17"> }</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-NS_IMETHODIMP nsMsgIncomingServer::GetPassword(nsACString&amp; aPassword)</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+NS_IMETHODIMP nsMsgIncomingServer::GetPassword(nsAString&amp; aPassword)</span>
<a href="#l3.21"></a><span id="l3.21"> {</span>
<a href="#l3.22"></a><span id="l3.22">   aPassword = m_password;</span>
<a href="#l3.23"></a><span id="l3.23">   return NS_OK;</span>
<a href="#l3.24"></a><span id="l3.24"> }</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> NS_IMETHODIMP nsMsgIncomingServer::GetServerRequiresPasswordForBiff(bool *aServerRequiresPasswordForBiff)</span>
<a href="#l3.27"></a><span id="l3.27"> {</span>
<a href="#l3.28"></a><span id="l3.28">   NS_ENSURE_ARG_POINTER(aServerRequiresPasswordForBiff);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineat">@@ -716,30 +716,30 @@ nsresult nsMsgIncomingServer::GetPasswor</span>
<a href="#l3.30"></a><span id="l3.30">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">       if (username.Equals(serverUsername))</span>
<a href="#l3.33"></a><span id="l3.33">       {</span>
<a href="#l3.34"></a><span id="l3.34">         nsString password;</span>
<a href="#l3.35"></a><span id="l3.35">         rv = logins[i]-&gt;GetPassword(password);</span>
<a href="#l3.36"></a><span id="l3.36">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-        m_password = NS_LossyConvertUTF16toASCII(password);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        m_password = password;</span>
<a href="#l3.40"></a><span id="l3.40">         break;</span>
<a href="#l3.41"></a><span id="l3.41">       }</span>
<a href="#l3.42"></a><span id="l3.42">     }</span>
<a href="#l3.43"></a><span id="l3.43">     NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numLogins, logins);</span>
<a href="#l3.44"></a><span id="l3.44">   }</span>
<a href="#l3.45"></a><span id="l3.45">   return NS_OK;</span>
<a href="#l3.46"></a><span id="l3.46"> }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48"> NS_IMETHODIMP</span>
<a href="#l3.49"></a><span id="l3.49"> nsMsgIncomingServer::GetPasswordWithUI(const nsAString&amp; aPromptMessage, const</span>
<a href="#l3.50"></a><span id="l3.50">                                        nsAString&amp; aPromptTitle,</span>
<a href="#l3.51"></a><span id="l3.51">                                        nsIMsgWindow* aMsgWindow,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-                                       nsACString&amp; aPassword)</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+                                       nsAString&amp; aPassword)</span>
<a href="#l3.54"></a><span id="l3.54"> {</span>
<a href="#l3.55"></a><span id="l3.55">   nsresult rv = NS_OK;</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57">   if (m_password.IsEmpty())</span>
<a href="#l3.58"></a><span id="l3.58">   {</span>
<a href="#l3.59"></a><span id="l3.59">     // let's see if we have the password in the password manager and</span>
<a href="#l3.60"></a><span id="l3.60">     // can avoid this prompting thing. This makes it easier to get embedders</span>
<a href="#l3.61"></a><span id="l3.61">     // to get up and running w/o a password prompting UI.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineat">@@ -784,37 +784,37 @@ nsMsgIncomingServer::GetPasswordWithUI(c</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64">       serverUri.Append(temp);</span>
<a href="#l3.65"></a><span id="l3.65"> </span>
<a href="#l3.66"></a><span id="l3.66">       // we pass in the previously used password, if any, into PromptPassword</span>
<a href="#l3.67"></a><span id="l3.67">       // so that it will appear as ******. This means we can't use an nsString</span>
<a href="#l3.68"></a><span id="l3.68">       // and getter_Copies.</span>
<a href="#l3.69"></a><span id="l3.69">       char16_t *uniPassword = nullptr;</span>
<a href="#l3.70"></a><span id="l3.70">       if (!aPassword.IsEmpty())</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-        uniPassword = ToNewUnicode(NS_ConvertASCIItoUTF16(aPassword));</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+        uniPassword = ToNewUnicode(aPassword);</span>
<a href="#l3.73"></a><span id="l3.73"> </span>
<a href="#l3.74"></a><span id="l3.74">       bool okayValue = true;</span>
<a href="#l3.75"></a><span id="l3.75">       rv = dialog-&gt;PromptPassword(PromiseFlatString(aPromptTitle).get(),</span>
<a href="#l3.76"></a><span id="l3.76">                                   PromiseFlatString(aPromptMessage).get(),</span>
<a href="#l3.77"></a><span id="l3.77">                                   NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l3.78"></a><span id="l3.78">                                   nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l3.79"></a><span id="l3.79">                                   &amp;uniPassword, &amp;okayValue);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-      nsAutoString uniPasswordAdopted;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-      uniPasswordAdopted.Adopt(uniPassword);</span>
<a href="#l3.82"></a><span id="l3.82">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.83"></a><span id="l3.83"> </span>
<a href="#l3.84"></a><span id="l3.84">       if (!okayValue) // if the user pressed cancel, just return an empty string;</span>
<a href="#l3.85"></a><span id="l3.85">       {</span>
<a href="#l3.86"></a><span id="l3.86">         aPassword.Truncate();</span>
<a href="#l3.87"></a><span id="l3.87">         return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l3.88"></a><span id="l3.88">       }</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">       // we got a password back...so remember it</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-      rv = SetPassword(NS_LossyConvertUTF16toASCII(uniPasswordAdopted));</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+      rv = SetPassword(nsDependentString(uniPassword));</span>
<a href="#l3.93"></a><span id="l3.93">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+      PR_FREEIF(uniPassword);</span>
<a href="#l3.96"></a><span id="l3.96">     } // if we got a prompt dialog</span>
<a href="#l3.97"></a><span id="l3.97">     else</span>
<a href="#l3.98"></a><span id="l3.98">       return NS_ERROR_FAILURE;</span>
<a href="#l3.99"></a><span id="l3.99">   } // if the password is empty</span>
<a href="#l3.100"></a><span id="l3.100">   return GetPassword(aPassword);</span>
<a href="#l3.101"></a><span id="l3.101"> }</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103"> NS_IMETHODIMP</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineat">@@ -863,17 +863,17 @@ nsMsgIncomingServer::ForgetPassword()</span>
<a href="#l3.105"></a><span id="l3.105">     {</span>
<a href="#l3.106"></a><span id="l3.106">       // If this fails, just continue, we'll still want to remove the password</span>
<a href="#l3.107"></a><span id="l3.107">       // from our local cache.</span>
<a href="#l3.108"></a><span id="l3.108">       loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l3.109"></a><span id="l3.109">     }</span>
<a href="#l3.110"></a><span id="l3.110">   }</span>
<a href="#l3.111"></a><span id="l3.111">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l3.112"></a><span id="l3.112"> </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-  return SetPassword(EmptyCString());</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+  return SetPassword(EmptyString());</span>
<a href="#l3.115"></a><span id="l3.115"> }</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117"> NS_IMETHODIMP</span>
<a href="#l3.118"></a><span id="l3.118"> nsMsgIncomingServer::ForgetSessionPassword()</span>
<a href="#l3.119"></a><span id="l3.119"> {</span>
<a href="#l3.120"></a><span id="l3.120">   m_password.Truncate();</span>
<a href="#l3.121"></a><span id="l3.121">   return NS_OK;</span>
<a href="#l3.122"></a><span id="l3.122"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -86,17 +86,17 @@ protected:</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> private:</span>
<a href="#l4.6"></a><span id="l4.6">   uint32_t m_biffState;</span>
<a href="#l4.7"></a><span id="l4.7">   bool m_serverBusy;</span>
<a href="#l4.8"></a><span id="l4.8">   nsCOMPtr &lt;nsISpamSettings&gt; mSpamSettings;</span>
<a href="#l4.9"></a><span id="l4.9">   nsCOMPtr&lt;nsIMsgFilterPlugin&gt; mFilterPlugin;  // XXX should be a list</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> protected:</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsCString m_password;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsString m_password;</span>
<a href="#l4.14"></a><span id="l4.14">   bool m_canHaveFilters;</span>
<a href="#l4.15"></a><span id="l4.15">   bool m_displayStartupPage;</span>
<a href="#l4.16"></a><span id="l4.16">   bool mPerformingBiff;</span>
<a href="#l4.17"></a><span id="l4.17"> };</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> #undef  IMETHOD_VISIBILITY</span>
<a href="#l4.20"></a><span id="l4.20"> #define IMETHOD_VISIBILITY NS_VISIBILITY_HIDDEN</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -936,27 +936,27 @@ nsresult nsMsgProtocol::DoGSSAPIStep2(ns</span>
<a href="#l5.4"></a><span id="l5.4">     }</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> #ifdef DEBUG_BenB</span>
<a href="#l5.7"></a><span id="l5.7">     printf(NS_SUCCEEDED(rv) ? &quot;GSSAPI step 2 succeeded\n&quot; : &quot;GSSAPI step 2 failed\n&quot;);</span>
<a href="#l5.8"></a><span id="l5.8"> #endif</span>
<a href="#l5.9"></a><span id="l5.9">     return rv;</span>
<a href="#l5.10"></a><span id="l5.10"> }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsresult nsMsgProtocol::DoNtlmStep1(const char *username, const char *password, nsCString &amp;response)</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+nsresult nsMsgProtocol::DoNtlmStep1(const nsACString &amp;username, const nsAString &amp;password, nsCString &amp;response)</span>
<a href="#l5.14"></a><span id="l5.14"> {</span>
<a href="#l5.15"></a><span id="l5.15">     nsresult rv;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">     m_authModule = do_CreateInstance(NS_AUTH_MODULE_CONTRACTID_PREFIX &quot;ntlm&quot;, &amp;rv);</span>
<a href="#l5.18"></a><span id="l5.18">     // if this fails, then it means that we cannot do NTLM auth.</span>
<a href="#l5.19"></a><span id="l5.19">     if (NS_FAILED(rv) || !m_authModule)</span>
<a href="#l5.20"></a><span id="l5.20">         return rv;</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">     m_authModule-&gt;Init(nullptr, 0, nullptr, NS_ConvertUTF8toUTF16(username).get(),</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-                       NS_ConvertUTF8toUTF16(password).get());</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+                       nsPromiseFlatString(password).get());</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">     void *outBuf;</span>
<a href="#l5.27"></a><span id="l5.27">     uint32_t outBufLen;</span>
<a href="#l5.28"></a><span id="l5.28">     rv = m_authModule-&gt;GetNextToken((void *)nullptr, 0, &amp;outBuf, &amp;outBufLen);</span>
<a href="#l5.29"></a><span id="l5.29">     if (NS_SUCCEEDED(rv) &amp;&amp; outBuf)</span>
<a href="#l5.30"></a><span id="l5.30">     {</span>
<a href="#l5.31"></a><span id="l5.31">         char *base64Str = PL_Base64Encode((char *)outBuf, outBufLen, nullptr);</span>
<a href="#l5.32"></a><span id="l5.32">         if (base64Str)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -111,17 +111,17 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4">   // stream, etc).</span>
<a href="#l6.5"></a><span id="l6.5">     // aSuppressLogging is a hint that sensitive data is being sent and should not be logged</span>
<a href="#l6.6"></a><span id="l6.6">   virtual nsresult SendData(const char * dataBuffer, bool aSuppressLogging = false);</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   virtual nsresult PostMessage(nsIURI* url, nsIFile* aPostFile);</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   virtual nsresult InitFromURI(nsIURI *aUrl);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsresult DoNtlmStep1(const char *username, const char *password, nsCString &amp;response);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsresult DoNtlmStep1(const nsACString &amp;username, const nsAString &amp;password, nsCString &amp;response);</span>
<a href="#l6.14"></a><span id="l6.14">   nsresult DoNtlmStep2(nsCString &amp;commandResponse, nsCString &amp;response);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   nsresult DoGSSAPIStep1(const char *service, const char *username, nsCString &amp;response);</span>
<a href="#l6.17"></a><span id="l6.17">   nsresult DoGSSAPIStep2(nsCString &amp;commandResponse, nsCString &amp;response);</span>
<a href="#l6.18"></a><span id="l6.18">   // Ouput stream for writing commands to the socket</span>
<a href="#l6.19"></a><span id="l6.19">   nsCOMPtr&lt;nsIOutputStream&gt;   m_outputStream;   // this will be obtained from the transport interface</span>
<a href="#l6.20"></a><span id="l6.20">   nsCOMPtr&lt;nsIInputStream&gt;    m_inputStream;</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -152,17 +152,17 @@ protected:</span>
<a href="#l6.23"></a><span id="l6.23">   nsCOMPtr&lt;nsIProgressEventSink&gt; mProgressEventSink;</span>
<a href="#l6.24"></a><span id="l6.24">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; mCallbacks;</span>
<a href="#l6.25"></a><span id="l6.25">   nsCOMPtr&lt;nsISupports&gt;       mOwner;</span>
<a href="#l6.26"></a><span id="l6.26">   nsCString                   mContentType;</span>
<a href="#l6.27"></a><span id="l6.27">   nsCString                   mCharset;</span>
<a href="#l6.28"></a><span id="l6.28">   int64_t                     mContentLength;</span>
<a href="#l6.29"></a><span id="l6.29">   nsCOMPtr&lt;nsILoadInfo&gt;       m_loadInfo;</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  nsCString m_lastPasswordSent; // used to prefill the password prompt</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  nsString m_lastPasswordSent; // used to prefill the password prompt</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // private helper routine used by subclasses to quickly get a reference to the correct prompt dialog</span>
<a href="#l6.35"></a><span id="l6.35">   // for a mailnews url.</span>
<a href="#l6.36"></a><span id="l6.36">   nsresult GetPromptDialogFromUrl(nsIMsgMailNewsUrl * aMsgUrl, nsIPrompt ** aPromptDialog);</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   // if a url isn't going to result in any content then we want to suppress calls to</span>
<a href="#l6.39"></a><span id="l6.39">   // OnStartRequest, OnDataAvailable and OnStopRequest</span>
<a href="#l6.40"></a><span id="l6.40">   bool mSuppressListenerNotifications;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgComposeParams.idl</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgComposeParams.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -69,18 +69,18 @@ interface nsIMsgComposeParams : nsISuppo</span>
<a href="#l7.4"></a><span id="l7.4">   attribute MSG_ComposeType       type;</span>
<a href="#l7.5"></a><span id="l7.5">   attribute MSG_ComposeFormat     format;</span>
<a href="#l7.6"></a><span id="l7.6">   attribute string                originalMsgURI;</span>
<a href="#l7.7"></a><span id="l7.7">   attribute nsIMsgIdentity        identity;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9">   attribute nsIMsgCompFields      composeFields;</span>
<a href="#l7.10"></a><span id="l7.10">   attribute boolean               bodyIsLink;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  attribute nsIMsgSendListener	  sendListener;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  attribute string                smtpPassword;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  attribute nsIMsgSendListener    sendListener;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  attribute AString               smtpPassword;</span>
<a href="#l7.16"></a><span id="l7.16">   attribute nsIMsgDBHdr           origMsgHdr;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   /**</span>
<a href="#l7.19"></a><span id="l7.19">    * HTML-formatted content to quote in the body of the message.</span>
<a href="#l7.20"></a><span id="l7.20">    * Set this to get different content than what would normally</span>
<a href="#l7.21"></a><span id="l7.21">    * appear in the body, e.g. the original message body in a reply.</span>
<a href="#l7.22"></a><span id="l7.22">    */</span>
<a href="#l7.23"></a><span id="l7.23">   attribute AUTF8String           htmlToQuote;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -214,17 +214,17 @@ interface nsIMsgSend : nsISupports</span>
<a href="#l8.4"></a><span id="l8.4">                               in nsIMsgDBHdr aMsgToReplace,</span>
<a href="#l8.5"></a><span id="l8.5">                               in string aBodyType,</span>
<a href="#l8.6"></a><span id="l8.6">                               in ACString aBody,</span>
<a href="#l8.7"></a><span id="l8.7">                               in nsIArray aAttachments,</span>
<a href="#l8.8"></a><span id="l8.8">                               in nsIArray aPreloadedAttachments,</span>
<a href="#l8.9"></a><span id="l8.9">                               in mozIDOMWindowProxy aParentWindow,</span>
<a href="#l8.10"></a><span id="l8.10">                               in nsIMsgProgress aProgress,</span>
<a href="#l8.11"></a><span id="l8.11">                               in nsIMsgSendListener aListener,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                              in string aPassword,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                              in AString aPassword,</span>
<a href="#l8.14"></a><span id="l8.14">                               in AUTF8String aOriginalMsgURI,</span>
<a href="#l8.15"></a><span id="l8.15">                               in MSG_ComposeType aType);</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17">   /**</span>
<a href="#l8.18"></a><span id="l8.18">    * Creates a file containing an rfc822 message, using the passed information.</span>
<a href="#l8.19"></a><span id="l8.19">    * aListener's OnStopSending method will get called with the file the message</span>
<a href="#l8.20"></a><span id="l8.20">    * was stored in. OnStopSending may be called sync or async, depending on</span>
<a href="#l8.21"></a><span id="l8.21">    * content, so you need to handle both cases.</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -288,17 +288,17 @@ interface nsIMsgSend : nsISupports</span>
<a href="#l8.23"></a><span id="l8.23">                        in nsIMsgCompFields     aFields,</span>
<a href="#l8.24"></a><span id="l8.24">                        in nsIFile              aSendIFile,</span>
<a href="#l8.25"></a><span id="l8.25">                        in boolean              aDeleteSendFileOnCompletion,</span>
<a href="#l8.26"></a><span id="l8.26">                        in boolean              aDigest_p,</span>
<a href="#l8.27"></a><span id="l8.27">                        in nsMsgDeliverMode     aMode,</span>
<a href="#l8.28"></a><span id="l8.28">                        in nsIMsgDBHdr          aMsgToReplace,</span>
<a href="#l8.29"></a><span id="l8.29">                        in nsIMsgSendListener   aListener,</span>
<a href="#l8.30"></a><span id="l8.30">                        in nsIMsgStatusFeedback aStatusFeedback,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-                       in string               aPassword</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+                       in wstring              aPassword</span>
<a href="#l8.33"></a><span id="l8.33">                        ); </span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">     /* Abort current send/save operation */</span>
<a href="#l8.36"></a><span id="l8.36">     void abort();</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">     /**</span>
<a href="#l8.39"></a><span id="l8.39">      * Report a send failure.</span>
<a href="#l8.40"></a><span id="l8.40">      *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/public/nsISmtpServer.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/public/nsISmtpServer.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -38,17 +38,17 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   /**</span>
<a href="#l9.6"></a><span id="l9.6">    * The password to access the server with (if required).</span>
<a href="#l9.7"></a><span id="l9.7">    *</span>
<a href="#l9.8"></a><span id="l9.8">    * @note this is stored within the server instance but not within preferences.</span>
<a href="#l9.9"></a><span id="l9.9">    * It can be specified/saved here to avoid prompting the user constantly for</span>
<a href="#l9.10"></a><span id="l9.10">    * the sending password.</span>
<a href="#l9.11"></a><span id="l9.11">    */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  attribute ACString password;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  attribute AString password;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   /// Returns a displayname of the format hostname:port or just hostname</span>
<a href="#l9.16"></a><span id="l9.16">   readonly attribute string displayname;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   /**</span>
<a href="#l9.19"></a><span id="l9.19">    * Authentication mechanism.</span>
<a href="#l9.20"></a><span id="l9.20">    *</span>
<a href="#l9.21"></a><span id="l9.21">    * @see nsMsgAuthMethod (in MailNewsTypes2.idl)</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -84,17 +84,17 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l9.23"></a><span id="l9.23">    * @param promptString  The string to prompt the user with when asking for</span>
<a href="#l9.24"></a><span id="l9.24">    *                      the password.</span>
<a href="#l9.25"></a><span id="l9.25">    * @param promptTitle   The title of the prompt.</span>
<a href="#l9.26"></a><span id="l9.26">    * @param netPrompt     An nsIAuthPrompt instance to use for the password</span>
<a href="#l9.27"></a><span id="l9.27">    *                      prompt.</span>
<a href="#l9.28"></a><span id="l9.28">    * @return              The password to use (may be null if no password was</span>
<a href="#l9.29"></a><span id="l9.29">    *                      obtained).</span>
<a href="#l9.30"></a><span id="l9.30">    */  </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  ACString getPasswordWithUI(in wstring promptString, in wstring promptTitle,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  AString getPasswordWithUI(in wstring promptString, in wstring promptTitle,</span>
<a href="#l9.33"></a><span id="l9.33">                            in nsIAuthPrompt netPrompt);</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">   /**</span>
<a href="#l9.36"></a><span id="l9.36">    * Gets a username and password for this server, using a UI prompt if</span>
<a href="#l9.37"></a><span id="l9.37">    * necessary.</span>
<a href="#l9.38"></a><span id="l9.38">    *</span>
<a href="#l9.39"></a><span id="l9.39">    * @param promptString  The string to prompt the user with when asking for</span>
<a href="#l9.40"></a><span id="l9.40">    *                      the password.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -103,17 +103,17 @@ interface nsISmtpServer : nsISupports {</span>
<a href="#l9.42"></a><span id="l9.42">    *                      prompt.</span>
<a href="#l9.43"></a><span id="l9.43">    * @param userid        The username to use (may be null if no password was</span>
<a href="#l9.44"></a><span id="l9.44">    *                      obtained).</span>
<a href="#l9.45"></a><span id="l9.45">    * @param password      The password to use (may be empty if no password was</span>
<a href="#l9.46"></a><span id="l9.46">    *                      obtained).</span>
<a href="#l9.47"></a><span id="l9.47">    */  </span>
<a href="#l9.48"></a><span id="l9.48">   void getUsernamePasswordWithUI(in wstring promptString, in wstring promptTitle,</span>
<a href="#l9.49"></a><span id="l9.49">                                  in nsIAuthPrompt netPrompt, out ACString userid,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-                                 out ACString password);</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+                                 out AString password);</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   /**</span>
<a href="#l9.54"></a><span id="l9.54">    * Calling this will *remove* the saved password for this server from the</span>
<a href="#l9.55"></a><span id="l9.55">    * password manager and from the stored value.</span>
<a href="#l9.56"></a><span id="l9.56">    */</span>
<a href="#l9.57"></a><span id="l9.57">   void forgetPassword();</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/public/nsISmtpService.idl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/public/nsISmtpService.idl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -49,17 +49,17 @@ interface nsISmtpService : nsISupports {</span>
<a href="#l10.4"></a><span id="l10.4">    *                                netlib service manager to interrupt the url</span>
<a href="#l10.5"></a><span id="l10.5">    *                                you are given back. This parameter may be</span>
<a href="#l10.6"></a><span id="l10.6">    *                                null.</span>
<a href="#l10.7"></a><span id="l10.7">    * @param aRequest                Provides a handle to the running request.</span>
<a href="#l10.8"></a><span id="l10.8">    *                                This parameter may be null.</span>
<a href="#l10.9"></a><span id="l10.9">    */</span>
<a href="#l10.10"></a><span id="l10.10">   void sendMailMessage(in nsIFile aFilePath, in string aRecipients, </span>
<a href="#l10.11"></a><span id="l10.11">                        in nsIMsgIdentity aSenderIdentity,</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-                       in string aPassword,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+                       in AString aPassword,</span>
<a href="#l10.14"></a><span id="l10.14">                        in nsIUrlListener aUrlListener, </span>
<a href="#l10.15"></a><span id="l10.15">                        in nsIMsgStatusFeedback aStatusListener, </span>
<a href="#l10.16"></a><span id="l10.16">                        in nsIInterfaceRequestor aNotificationCallbacks,</span>
<a href="#l10.17"></a><span id="l10.17">                        in boolean aRequestDSN,</span>
<a href="#l10.18"></a><span id="l10.18">                        out nsIURI aURL,</span>
<a href="#l10.19"></a><span id="l10.19">                        out nsIRequest aRequest);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1089,18 +1089,18 @@ nsMsgCompose::Initialize(nsIMsgComposePa</span>
<a href="#l11.4"></a><span id="l11.4">     }</span>
<a href="#l11.5"></a><span id="l11.5">   }</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l11.8"></a><span id="l11.8">   aParams-&gt;GetSendListener(getter_AddRefs(externalSendListener));</span>
<a href="#l11.9"></a><span id="l11.9">   if(externalSendListener)</span>
<a href="#l11.10"></a><span id="l11.10">     AddMsgSendListener( externalSendListener );</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  nsCString smtpPassword;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-  aParams-&gt;GetSmtpPassword(getter_Copies(smtpPassword));</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  nsString smtpPassword;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  aParams-&gt;GetSmtpPassword(smtpPassword);</span>
<a href="#l11.16"></a><span id="l11.16">   mSmtpPassword = smtpPassword;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   aParams-&gt;GetHtmlToQuote(mHtmlToQuote);</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   if (aDocShell)</span>
<a href="#l11.21"></a><span id="l11.21">   {</span>
<a href="#l11.22"></a><span id="l11.22">     mDocShell = aDocShell;</span>
<a href="#l11.23"></a><span id="l11.23">     // register the compose object with the compose service</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -1265,17 +1265,17 @@ nsMsgCompose::SendMsgToServer(MSG_Delive</span>
<a href="#l11.25"></a><span id="l11.25">                     nullptr,</span>
<a href="#l11.26"></a><span id="l11.26">                     m_composeHTML ? TEXT_HTML : TEXT_PLAIN,</span>
<a href="#l11.27"></a><span id="l11.27">                     bodyString,</span>
<a href="#l11.28"></a><span id="l11.28">                     nullptr,</span>
<a href="#l11.29"></a><span id="l11.29">                     nullptr,</span>
<a href="#l11.30"></a><span id="l11.30">                     m_window,</span>
<a href="#l11.31"></a><span id="l11.31">                     mProgress,</span>
<a href="#l11.32"></a><span id="l11.32">                     sendListener,</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-                    mSmtpPassword.get(),</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+                    mSmtpPassword,</span>
<a href="#l11.35"></a><span id="l11.35">                     mOriginalMsgURI,</span>
<a href="#l11.36"></a><span id="l11.36">                     mType);</span>
<a href="#l11.37"></a><span id="l11.37">     }</span>
<a href="#l11.38"></a><span id="l11.38">     else</span>
<a href="#l11.39"></a><span id="l11.39">         rv = NS_ERROR_FAILURE;</span>
<a href="#l11.40"></a><span id="l11.40">   }</span>
<a href="#l11.41"></a><span id="l11.41">   else</span>
<a href="#l11.42"></a><span id="l11.42">     rv = NS_ERROR_NOT_INITIALIZED;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -127,17 +127,17 @@ protected:</span>
<a href="#l12.4"></a><span id="l12.4">   bool                                      mQuotingToFollow;   // Quoting indicator</span>
<a href="#l12.5"></a><span id="l12.5">   MSG_ComposeType                           mType;              // Message type</span>
<a href="#l12.6"></a><span id="l12.6">   bool                                      mCharsetOverride;</span>
<a href="#l12.7"></a><span id="l12.7">   bool                                      mAnswerDefaultCharset;</span>
<a href="#l12.8"></a><span id="l12.8">   bool                                      mDeleteDraft;</span>
<a href="#l12.9"></a><span id="l12.9">   nsMsgDispositionState                     mDraftDisposition;</span>
<a href="#l12.10"></a><span id="l12.10">   nsCOMPtr &lt;nsIMsgDBHdr&gt;                    mOrigMsgHdr;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  nsCString                                 mSmtpPassword;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  nsString                                  mSmtpPassword;</span>
<a href="#l12.14"></a><span id="l12.14">   nsCString                                 mHtmlToQuote;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgComposeStateListener&gt; &gt; mStateListeners;</span>
<a href="#l12.17"></a><span id="l12.17">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt; mExternalSendListeners;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   bool                                      mInsertingQuotedContent;</span>
<a href="#l12.20"></a><span id="l12.20">   MSG_DeliverMode                           mDeliverMode;  // nsIMsgCompDeliverMode long.</span>
<a href="#l12.21"></a><span id="l12.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -148,21 +148,19 @@ NS_IMETHODIMP nsMsgComposeParams::GetSen</span>
<a href="#l13.4"></a><span id="l13.4"> }</span>
<a href="#l13.5"></a><span id="l13.5"> NS_IMETHODIMP nsMsgComposeParams::SetSendListener(nsIMsgSendListener * aSendListener)</span>
<a href="#l13.6"></a><span id="l13.6"> {</span>
<a href="#l13.7"></a><span id="l13.7">   mSendListener = aSendListener;</span>
<a href="#l13.8"></a><span id="l13.8">   return NS_OK;</span>
<a href="#l13.9"></a><span id="l13.9"> }</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> /* attribute string smtpPassword; */</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetSmtpPassword(char * *aSmtpPassword)</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetSmtpPassword(nsAString &amp;aSmtpPassword)</span>
<a href="#l13.14"></a><span id="l13.14"> {</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aSmtpPassword);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  *aSmtpPassword = ToNewCString(mSMTPPassword);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  aSmtpPassword = mSMTPPassword;</span>
<a href="#l13.19"></a><span id="l13.19">   return NS_OK;</span>
<a href="#l13.20"></a><span id="l13.20"> }</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetSmtpPassword(const char * aSmtpPassword)</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetSmtpPassword(const nsAString &amp;aSmtpPassword)</span>
<a href="#l13.23"></a><span id="l13.23"> {</span>
<a href="#l13.24"></a><span id="l13.24">   mSMTPPassword = aSmtpPassword;</span>
<a href="#l13.25"></a><span id="l13.25">   return NS_OK;</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -19,12 +19,12 @@ private:</span>
<a href="#l14.4"></a><span id="l14.4">   virtual ~nsMsgComposeParams();</span>
<a href="#l14.5"></a><span id="l14.5">   MSG_ComposeType               mType;</span>
<a href="#l14.6"></a><span id="l14.6">   MSG_ComposeFormat             mFormat;</span>
<a href="#l14.7"></a><span id="l14.7">   nsCString                     mOriginalMsgUri;</span>
<a href="#l14.8"></a><span id="l14.8">   nsCOMPtr&lt;nsIMsgIdentity&gt;      mIdentity;</span>
<a href="#l14.9"></a><span id="l14.9">   nsCOMPtr&lt;nsIMsgCompFields&gt;    mComposeFields;</span>
<a href="#l14.10"></a><span id="l14.10">   bool                          mBodyIsLink;</span>
<a href="#l14.11"></a><span id="l14.11">   nsCOMPtr&lt;nsIMsgSendListener&gt;  mSendListener;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  nsCString                     mSMTPPassword;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  nsString                     mSMTPPassword;</span>
<a href="#l14.14"></a><span id="l14.14">   nsCOMPtr&lt;nsIMsgDBHdr&gt;         mOrigMsgHdr;</span>
<a href="#l14.15"></a><span id="l14.15">   nsCString                     mHtmlToQuote;</span>
<a href="#l14.16"></a><span id="l14.16"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3030,17 +3030,17 @@ nsMsgComposeAndSend::Init(</span>
<a href="#l15.4"></a><span id="l15.4">               bool digest_p,</span>
<a href="#l15.5"></a><span id="l15.5">               bool dont_deliver_p,</span>
<a href="#l15.6"></a><span id="l15.6">               nsMsgDeliverMode mode,</span>
<a href="#l15.7"></a><span id="l15.7">               nsIMsgDBHdr *msgToReplace,</span>
<a href="#l15.8"></a><span id="l15.8">               const char *attachment1_type,</span>
<a href="#l15.9"></a><span id="l15.9">               const nsACString &amp;attachment1_body,</span>
<a href="#l15.10"></a><span id="l15.10">               nsIArray *attachments,</span>
<a href="#l15.11"></a><span id="l15.11">               nsIArray *preloaded_attachments,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-              const char *password,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+              const nsAString &amp;password,</span>
<a href="#l15.14"></a><span id="l15.14">               const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l15.15"></a><span id="l15.15">               MSG_ComposeType aType)</span>
<a href="#l15.16"></a><span id="l15.16"> {</span>
<a href="#l15.17"></a><span id="l15.17">   nsresult      rv = NS_OK;</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">   //Let make sure we retreive the correct number of related parts. It may have changed since last time</span>
<a href="#l15.20"></a><span id="l15.20">   GetMultipartRelatedCount(true);</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -3422,17 +3422,17 @@ nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l15.23"></a><span id="l15.23">     SetStatusMessage(msg);</span>
<a href="#l15.24"></a><span id="l15.24">     nsCOMPtr&lt;nsIMsgStatusFeedback&gt; msgStatus (do_QueryInterface(mSendProgress));</span>
<a href="#l15.25"></a><span id="l15.25">     // if the sendProgress isn't set, let's use the member variable.</span>
<a href="#l15.26"></a><span id="l15.26">     if (!msgStatus)</span>
<a href="#l15.27"></a><span id="l15.27">       msgStatus = do_QueryInterface(mStatusFeedback);</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">     nsCOMPtr&lt;nsIURI&gt; runningUrl;</span>
<a href="#l15.30"></a><span id="l15.30">     rv = smtpService-&gt;SendMailMessage(mTempFile, buf, mUserIdentity,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-                                      mSmtpPassword.get(), deliveryListener, msgStatus,</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+                                      mSmtpPassword, deliveryListener, msgStatus,</span>
<a href="#l15.33"></a><span id="l15.33">                                       callbacks, mCompFields-&gt;GetDSN(),</span>
<a href="#l15.34"></a><span id="l15.34">                                       getter_AddRefs(runningUrl),</span>
<a href="#l15.35"></a><span id="l15.35">                                       getter_AddRefs(mRunningRequest));</span>
<a href="#l15.36"></a><span id="l15.36">     // set envid on the returned URL</span>
<a href="#l15.37"></a><span id="l15.37">     if (NS_SUCCEEDED(rv))</span>
<a href="#l15.38"></a><span id="l15.38">     {</span>
<a href="#l15.39"></a><span id="l15.39">       nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(runningUrl, &amp;rv));</span>
<a href="#l15.40"></a><span id="l15.40">       if (NS_SUCCEEDED(rv))</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -4140,17 +4140,17 @@ nsMsgComposeAndSend::CreateAndSendMessag</span>
<a href="#l15.42"></a><span id="l15.42">               nsIMsgDBHdr                       *msgToReplace,</span>
<a href="#l15.43"></a><span id="l15.43">               const char                        *attachment1_type,</span>
<a href="#l15.44"></a><span id="l15.44">               const nsACString                  &amp;attachment1_body,</span>
<a href="#l15.45"></a><span id="l15.45">               nsIArray *attachments,</span>
<a href="#l15.46"></a><span id="l15.46">               nsIArray *preloaded_attachments,</span>
<a href="#l15.47"></a><span id="l15.47">               mozIDOMWindowProxy                *parentWindow,</span>
<a href="#l15.48"></a><span id="l15.48">               nsIMsgProgress                    *progress,</span>
<a href="#l15.49"></a><span id="l15.49">               nsIMsgSendListener                *aListener,</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-              const char                        *password,</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+              const nsAString                   &amp;password,</span>
<a href="#l15.52"></a><span id="l15.52">               const nsACString                  &amp;aOriginalMsgURI,</span>
<a href="#l15.53"></a><span id="l15.53">               MSG_ComposeType                   aType</span>
<a href="#l15.54"></a><span id="l15.54">               )</span>
<a href="#l15.55"></a><span id="l15.55"> {</span>
<a href="#l15.56"></a><span id="l15.56">   nsresult      rv;</span>
<a href="#l15.57"></a><span id="l15.57">   /* First thing to do is to reset the send errors report */</span>
<a href="#l15.58"></a><span id="l15.58">   mSendReport-&gt;Reset();</span>
<a href="#l15.59"></a><span id="l15.59">   mSendReport-&gt;SetDeliveryMode(mode);</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineat">@@ -4200,17 +4200,17 @@ nsMsgComposeAndSend::CreateRFC822Message</span>
<a href="#l15.61"></a><span id="l15.61">   mListener = aListener;</span>
<a href="#l15.62"></a><span id="l15.62">   mEmbeddedObjectList = aEmbeddedObjects;</span>
<a href="#l15.63"></a><span id="l15.63"> </span>
<a href="#l15.64"></a><span id="l15.64">   rv = Init(aUserIdentity, nullptr, (nsMsgCompFields *)aFields, nullptr,</span>
<a href="#l15.65"></a><span id="l15.65">             false, true, mode, nullptr,</span>
<a href="#l15.66"></a><span id="l15.66">             aMsgType,</span>
<a href="#l15.67"></a><span id="l15.67">             aMsgBody,</span>
<a href="#l15.68"></a><span id="l15.68">             nullptr, aAttachments,</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-            nullptr, EmptyCString(), nsIMsgCompType::New);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+            EmptyString(), EmptyCString(), nsIMsgCompType::New);</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72">   if (NS_FAILED(rv) &amp;&amp; mSendReport)</span>
<a href="#l15.73"></a><span id="l15.73">     mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, rv, false);</span>
<a href="#l15.74"></a><span id="l15.74"> </span>
<a href="#l15.75"></a><span id="l15.75">   return rv;</span>
<a href="#l15.76"></a><span id="l15.76"> }</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78"> nsresult</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineat">@@ -4220,17 +4220,17 @@ nsMsgComposeAndSend::SendMessageFile(</span>
<a href="#l15.80"></a><span id="l15.80">               nsIMsgCompFields                  *fields,</span>
<a href="#l15.81"></a><span id="l15.81">               nsIFile                           *sendIFile,</span>
<a href="#l15.82"></a><span id="l15.82">               bool                              deleteSendFileOnCompletion,</span>
<a href="#l15.83"></a><span id="l15.83">               bool                              digest_p,</span>
<a href="#l15.84"></a><span id="l15.84">               nsMsgDeliverMode                  mode,</span>
<a href="#l15.85"></a><span id="l15.85">               nsIMsgDBHdr                       *msgToReplace,</span>
<a href="#l15.86"></a><span id="l15.86">               nsIMsgSendListener                *aListener,</span>
<a href="#l15.87"></a><span id="l15.87">               nsIMsgStatusFeedback              *aStatusFeedback,</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-              const char                        *password</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+              const char16_t                    *password</span>
<a href="#l15.90"></a><span id="l15.90">               )</span>
<a href="#l15.91"></a><span id="l15.91"> {</span>
<a href="#l15.92"></a><span id="l15.92">   NS_ENSURE_ARG_POINTER(fields);</span>
<a href="#l15.93"></a><span id="l15.93">   NS_ENSURE_ARG_POINTER(sendIFile);</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95">   nsresult      rv;</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97">   /* First thing to do is to reset the send errors report */</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineat">@@ -4254,17 +4254,18 @@ nsMsgComposeAndSend::SendMessageFile(</span>
<a href="#l15.99"></a><span id="l15.99">   // Should we delete the temp file when done?</span>
<a href="#l15.100"></a><span id="l15.100">   if (!deleteSendFileOnCompletion)</span>
<a href="#l15.101"></a><span id="l15.101">     mReturnFile = sendIFile;</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103">   rv = Init(aUserIndentity, aAccountKey, (nsMsgCompFields *)fields, sendIFile,</span>
<a href="#l15.104"></a><span id="l15.104">             digest_p, false, mode, msgToReplace,</span>
<a href="#l15.105"></a><span id="l15.105">             nullptr, EmptyCString(),</span>
<a href="#l15.106"></a><span id="l15.106">             nullptr, nullptr,</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-            password, EmptyCString(), nsIMsgCompType::New);</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+            password ? nsDependentString(password) : EmptyString(),</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+            EmptyCString(), nsIMsgCompType::New);</span>
<a href="#l15.110"></a><span id="l15.110"> </span>
<a href="#l15.111"></a><span id="l15.111">   if (NS_SUCCEEDED(rv))</span>
<a href="#l15.112"></a><span id="l15.112">     rv = DeliverMessage();</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114">   if (NS_FAILED(rv) &amp;&amp; mSendReport)</span>
<a href="#l15.115"></a><span id="l15.115">     mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, rv, false);</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -225,17 +225,17 @@ public:</span>
<a href="#l16.4"></a><span id="l16.4">                    bool             digest_p,</span>
<a href="#l16.5"></a><span id="l16.5">                    bool             dont_deliver_p,</span>
<a href="#l16.6"></a><span id="l16.6">                    nsMsgDeliverMode mode,</span>
<a href="#l16.7"></a><span id="l16.7">                    nsIMsgDBHdr      *msgToReplace,</span>
<a href="#l16.8"></a><span id="l16.8">                    const char       *attachment1_type,</span>
<a href="#l16.9"></a><span id="l16.9">                    const nsACString &amp;attachment1_body,</span>
<a href="#l16.10"></a><span id="l16.10">                    nsIArray   *attachments,</span>
<a href="#l16.11"></a><span id="l16.11">                    nsIArray     *preloaded_attachments,</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-                   const char       *password,</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+                   const nsAString &amp;password,</span>
<a href="#l16.14"></a><span id="l16.14">                    const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l16.15"></a><span id="l16.15">                    MSG_ComposeType  aType);</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17">   //</span>
<a href="#l16.18"></a><span id="l16.18">   // Setup the composition fields</span>
<a href="#l16.19"></a><span id="l16.19">   //</span>
<a href="#l16.20"></a><span id="l16.20">   nsresult    InitCompositionFields(nsMsgCompFields *fields,</span>
<a href="#l16.21"></a><span id="l16.21">                                     const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineat">@@ -390,17 +390,17 @@ protected:</span>
<a href="#l16.23"></a><span id="l16.23">   nsresult AddDefaultCustomHeaders();</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25">   // add Mail-Followup-To and Mail-Reply-To header</span>
<a href="#l16.26"></a><span id="l16.26">   nsresult AddMailFollowupToHeader();</span>
<a href="#l16.27"></a><span id="l16.27">   nsresult AddMailReplyToHeader();</span>
<a href="#l16.28"></a><span id="l16.28">   nsresult AddXForwardedMessageIdHeader();</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30">   nsCOMPtr&lt;nsIMsgSendReport&gt;  mSendReport;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-  nsCString                   mSmtpPassword;            // store the smtp Password use during a send</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  nsString                    mSmtpPassword;            // store the smtp Password use during a send</span>
<a href="#l16.33"></a><span id="l16.33"> };</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35"> //</span>
<a href="#l16.36"></a><span id="l16.36"> // These C routines should only be used by the nsMsgSendPart class.</span>
<a href="#l16.37"></a><span id="l16.37"> //</span>
<a href="#l16.38"></a><span id="l16.38"> extern nsresult mime_write_message_body(nsIMsgSend *state, const char *buf, uint32_t size);</span>
<a href="#l16.39"></a><span id="l16.39"> extern char   *mime_get_stream_write_buffer(void);</span>
<a href="#l16.40"></a><span id="l16.40"> extern nsresult mime_encoder_output_fn (const char *buf, int32_t size, void *closure);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1431,17 +1431,17 @@ void nsSmtpProtocol::AuthLoginStep0Respo</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> nsresult nsSmtpProtocol::AuthLoginStep1()</span>
<a href="#l17.6"></a><span id="l17.6"> {</span>
<a href="#l17.7"></a><span id="l17.7">   char buffer[512]; // TODO nsAutoCString</span>
<a href="#l17.8"></a><span id="l17.8">   nsresult rv;</span>
<a href="#l17.9"></a><span id="l17.9">   nsresult status = NS_OK;</span>
<a href="#l17.10"></a><span id="l17.10">   nsCString username;</span>
<a href="#l17.11"></a><span id="l17.11">   char *base64Str = nullptr;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  nsAutoCString password;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  nsAutoString password;</span>
<a href="#l17.14"></a><span id="l17.14">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l17.15"></a><span id="l17.15">   rv = m_runningURL-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l17.16"></a><span id="l17.16">   if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18">   rv = smtpServer-&gt;GetUsername(username);</span>
<a href="#l17.19"></a><span id="l17.19">   if (username.IsEmpty())</span>
<a href="#l17.20"></a><span id="l17.20">   {</span>
<a href="#l17.21"></a><span id="l17.21">     rv = GetUsernamePassword(username, password);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -1458,43 +1458,44 @@ nsresult nsSmtpProtocol::AuthLoginStep1(</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   GetPassword(password);</span>
<a href="#l17.25"></a><span id="l17.25">   if (password.IsEmpty())</span>
<a href="#l17.26"></a><span id="l17.26">   {</span>
<a href="#l17.27"></a><span id="l17.27">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;SMTP: password undefined&quot;));</span>
<a href="#l17.28"></a><span id="l17.28">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l17.29"></a><span id="l17.29">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l17.30"></a><span id="l17.30">   }</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  NS_ConvertUTF16toUTF8 uniPassword(password);</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33">   if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l17.34"></a><span id="l17.34">   {</span>
<a href="#l17.35"></a><span id="l17.35">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Error, (&quot;CRAM auth, step 1&quot;));</span>
<a href="#l17.36"></a><span id="l17.36">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH CRAM-MD5&quot; CRLF);</span>
<a href="#l17.37"></a><span id="l17.37">   }</span>
<a href="#l17.38"></a><span id="l17.38">   else if (m_currentAuthMethod == SMTP_AUTH_NTLM_ENABLED ||</span>
<a href="#l17.39"></a><span id="l17.39">            m_currentAuthMethod == SMTP_AUTH_MSN_ENABLED)</span>
<a href="#l17.40"></a><span id="l17.40">   {</span>
<a href="#l17.41"></a><span id="l17.41">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;NTLM/MSN auth, step 1&quot;));</span>
<a href="#l17.42"></a><span id="l17.42">     nsAutoCString response;</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-    rv = DoNtlmStep1(username.get(), password.get(), response);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+    rv = DoNtlmStep1(username, password, response);</span>
<a href="#l17.45"></a><span id="l17.45">     PR_snprintf(buffer, sizeof(buffer), TestFlag(SMTP_AUTH_NTLM_ENABLED) ?</span>
<a href="#l17.46"></a><span id="l17.46">                                         &quot;AUTH NTLM %.256s&quot; CRLF :</span>
<a href="#l17.47"></a><span id="l17.47">                                         &quot;%.256s&quot; CRLF, response.get());</span>
<a href="#l17.48"></a><span id="l17.48">   }</span>
<a href="#l17.49"></a><span id="l17.49">   else if (m_currentAuthMethod == SMTP_AUTH_PLAIN_ENABLED)</span>
<a href="#l17.50"></a><span id="l17.50">   {</span>
<a href="#l17.51"></a><span id="l17.51">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;PLAIN auth&quot;));</span>
<a href="#l17.52"></a><span id="l17.52">     char plain_string[512];</span>
<a href="#l17.53"></a><span id="l17.53">     int len = 1; /* first &lt;NUL&gt; char */</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55">     memset(plain_string, 0, 512);</span>
<a href="#l17.56"></a><span id="l17.56">     PR_snprintf(&amp;plain_string[1], 510, &quot;%s&quot;, username.get());</span>
<a href="#l17.57"></a><span id="l17.57">     len += username.Length();</span>
<a href="#l17.58"></a><span id="l17.58">     len++; /* second &lt;NUL&gt; char */</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-    PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, password.get());</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, uniPassword.get());</span>
<a href="#l17.61"></a><span id="l17.61">     len += password.Length();</span>
<a href="#l17.62"></a><span id="l17.62"> </span>
<a href="#l17.63"></a><span id="l17.63">     base64Str = PL_Base64Encode(plain_string, len, nullptr);</span>
<a href="#l17.64"></a><span id="l17.64">     PR_snprintf(buffer, sizeof(buffer), &quot;AUTH PLAIN %.256s&quot; CRLF, base64Str);</span>
<a href="#l17.65"></a><span id="l17.65">   }</span>
<a href="#l17.66"></a><span id="l17.66">   else if (m_currentAuthMethod == SMTP_AUTH_LOGIN_ENABLED)</span>
<a href="#l17.67"></a><span id="l17.67">   {</span>
<a href="#l17.68"></a><span id="l17.68">     MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;LOGIN auth&quot;));</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineat">@@ -1518,24 +1519,25 @@ nsresult nsSmtpProtocol::AuthLoginStep2(</span>
<a href="#l17.70"></a><span id="l17.70"> {</span>
<a href="#l17.71"></a><span id="l17.71">   /* use cached smtp password first</span>
<a href="#l17.72"></a><span id="l17.72">   * if not then use cached pop password</span>
<a href="#l17.73"></a><span id="l17.73">   * if pop password undefined</span>
<a href="#l17.74"></a><span id="l17.74">   * sync with smtp password</span>
<a href="#l17.75"></a><span id="l17.75">   */</span>
<a href="#l17.76"></a><span id="l17.76">   nsresult status = NS_OK;</span>
<a href="#l17.77"></a><span id="l17.77">   nsresult rv;</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-  nsAutoCString password;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  nsAutoString uniPassword;</span>
<a href="#l17.80"></a><span id="l17.80"> </span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-  GetPassword(password);</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineminus">-  if (password.IsEmpty())</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+  GetPassword(uniPassword);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+  if (uniPassword.IsEmpty())</span>
<a href="#l17.85"></a><span id="l17.85">   {</span>
<a href="#l17.86"></a><span id="l17.86">     m_urlErrorState = NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l17.87"></a><span id="l17.87">     return NS_ERROR_SMTP_PASSWORD_UNDEFINED;</span>
<a href="#l17.88"></a><span id="l17.88">   }</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  NS_ConvertUTF16toUTF8 password(uniPassword);</span>
<a href="#l17.90"></a><span id="l17.90">   MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;SMTP AuthLoginStep2&quot;));</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92">   if (!password.IsEmpty())</span>
<a href="#l17.93"></a><span id="l17.93">   {</span>
<a href="#l17.94"></a><span id="l17.94">     char buffer[512];</span>
<a href="#l17.95"></a><span id="l17.95">     if (m_currentAuthMethod == SMTP_AUTH_CRAM_MD5_ENABLED)</span>
<a href="#l17.96"></a><span id="l17.96">     {</span>
<a href="#l17.97"></a><span id="l17.97">       MOZ_LOG(SMTPLogModule, mozilla::LogLevel::Debug, (&quot;CRAM auth, step 2&quot;));</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineat">@@ -2143,17 +2145,17 @@ nsresult nsSmtpProtocol::ProcessProtocol</span>
<a href="#l17.99"></a><span id="l17.99">       }</span>
<a href="#l17.100"></a><span id="l17.100">     }</span>
<a href="#l17.101"></a><span id="l17.101">   } /* while(!SMTP_PAUSE_FOR_READ) */</span>
<a href="#l17.102"></a><span id="l17.102"> </span>
<a href="#l17.103"></a><span id="l17.103">   return NS_OK;</span>
<a href="#l17.104"></a><span id="l17.104"> }</span>
<a href="#l17.105"></a><span id="l17.105"> </span>
<a href="#l17.106"></a><span id="l17.106"> nsresult</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-nsSmtpProtocol::GetPassword(nsCString &amp;aPassword)</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+nsSmtpProtocol::GetPassword(nsString &amp;aPassword)</span>
<a href="#l17.109"></a><span id="l17.109"> {</span>
<a href="#l17.110"></a><span id="l17.110">     nsresult rv;</span>
<a href="#l17.111"></a><span id="l17.111">     nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l17.112"></a><span id="l17.112">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l17.115"></a><span id="l17.115">     rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l17.116"></a><span id="l17.116">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineat">@@ -2196,17 +2198,18 @@ nsSmtpProtocol::GetPassword(nsCString &amp;a</span>
<a href="#l17.118"></a><span id="l17.118">     return rv;</span>
<a href="#l17.119"></a><span id="l17.119"> }</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121"> /**</span>
<a href="#l17.122"></a><span id="l17.122">  * formatStrings is an array for the prompts, item 0 is the hostname, item 1</span>
<a href="#l17.123"></a><span id="l17.123">  * is the username.</span>
<a href="#l17.124"></a><span id="l17.124">  */</span>
<a href="#l17.125"></a><span id="l17.125"> nsresult</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-nsSmtpProtocol::PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl, const char16_t **formatStrings, nsACString &amp;aPassword)</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+nsSmtpProtocol::PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl,</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+                                  const char16_t **formatStrings, nsAString &amp;aPassword)</span>
<a href="#l17.129"></a><span id="l17.129"> {</span>
<a href="#l17.130"></a><span id="l17.130">   nsCOMPtr&lt;nsIStringBundleService&gt; stringService =</span>
<a href="#l17.131"></a><span id="l17.131">     mozilla::services::GetStringBundleService();</span>
<a href="#l17.132"></a><span id="l17.132">   NS_ENSURE_TRUE(stringService, NS_ERROR_UNEXPECTED);</span>
<a href="#l17.133"></a><span id="l17.133"> </span>
<a href="#l17.134"></a><span id="l17.134">   nsCOMPtr&lt;nsIStringBundle&gt; composeStringBundle;</span>
<a href="#l17.135"></a><span id="l17.135">   nsresult rv = stringService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(composeStringBundle));</span>
<a href="#l17.136"></a><span id="l17.136">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineat">@@ -2235,17 +2238,17 @@ nsSmtpProtocol::PromptForPassword(nsISmt</span>
<a href="#l17.138"></a><span id="l17.138">   rv = aSmtpServer-&gt;GetPasswordWithUI(passwordPromptString.get(), passwordTitle.get(),</span>
<a href="#l17.139"></a><span id="l17.139">     netPrompt, aPassword);</span>
<a href="#l17.140"></a><span id="l17.140">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.141"></a><span id="l17.141">   return rv;</span>
<a href="#l17.142"></a><span id="l17.142"> }</span>
<a href="#l17.143"></a><span id="l17.143"> </span>
<a href="#l17.144"></a><span id="l17.144"> nsresult</span>
<a href="#l17.145"></a><span id="l17.145"> nsSmtpProtocol::GetUsernamePassword(nsACString &amp;aUsername,</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-                                    nsACString &amp;aPassword)</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+                                    nsAString &amp;aPassword)</span>
<a href="#l17.148"></a><span id="l17.148"> {</span>
<a href="#l17.149"></a><span id="l17.149">     nsresult rv;</span>
<a href="#l17.150"></a><span id="l17.150">     nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l17.151"></a><span id="l17.151">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.152"></a><span id="l17.152"> </span>
<a href="#l17.153"></a><span id="l17.153">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l17.154"></a><span id="l17.154">     rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l17.155"></a><span id="l17.155">     NS_ENSURE_SUCCESS(rv,rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -200,21 +200,21 @@ private:</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.6"></a><span id="l18.6">     // End of Protocol Methods</span>
<a href="#l18.7"></a><span id="l18.7">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">     void SendMessageInFile();</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">     void AppendHelloArgument(nsACString&amp; aResult);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    nsresult GetPassword(nsCString &amp;aPassword);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-    nsresult GetUsernamePassword(nsACString &amp;aUsername, nsACString &amp;aPassword);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+    nsresult GetPassword(nsString &amp;aPassword);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+    nsresult GetUsernamePassword(nsACString &amp;aUsername, nsAString &amp;aPassword);</span>
<a href="#l18.16"></a><span id="l18.16">     nsresult PromptForPassword(nsISmtpServer *aSmtpServer, nsISmtpUrl *aSmtpUrl,</span>
<a href="#l18.17"></a><span id="l18.17">                                const char16_t **formatStrings,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-                               nsACString &amp;aPassword);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+                               nsAString &amp;aPassword);</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">     void    InitPrefAuthMethods(int32_t authMethodPrefValue);</span>
<a href="#l18.22"></a><span id="l18.22">     nsresult ChooseAuthMethod();</span>
<a href="#l18.23"></a><span id="l18.23">     void    MarkAuthMethodAsFailed(int32_t failedAuthMethod);</span>
<a href="#l18.24"></a><span id="l18.24">     void    ResetAuthMethods();</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26">     virtual const char* GetType() override {return &quot;smtp&quot;;}</span>
<a href="#l18.27"></a><span id="l18.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -249,17 +249,17 @@ nsSmtpServer::SetUsername(const nsACStri</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5">   // If the pref value is already empty, ClearUserPref will return</span>
<a href="#l19.6"></a><span id="l19.6">   // NS_ERROR_UNEXPECTED, so don't check the rv here.</span>
<a href="#l19.7"></a><span id="l19.7">   mPrefBranch-&gt;ClearUserPref(&quot;username&quot;);</span>
<a href="#l19.8"></a><span id="l19.8">   return NS_OK;</span>
<a href="#l19.9"></a><span id="l19.9"> }</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11"> NS_IMETHODIMP</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-nsSmtpServer::GetPassword(nsACString&amp; aPassword)</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+nsSmtpServer::GetPassword(nsAString&amp; aPassword)</span>
<a href="#l19.14"></a><span id="l19.14"> {</span>
<a href="#l19.15"></a><span id="l19.15">     if (m_password.IsEmpty() &amp;&amp; !m_logonFailed)</span>
<a href="#l19.16"></a><span id="l19.16">     {</span>
<a href="#l19.17"></a><span id="l19.17">       // try to avoid prompting the user for another password. If the user has set</span>
<a href="#l19.18"></a><span id="l19.18">       // the appropriate pref, we'll use the password from an incoming server, if</span>
<a href="#l19.19"></a><span id="l19.19">       // the user has already logged onto that server.</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21">       // if this is set, we'll only use this, and not the other prefs</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineat">@@ -355,17 +355,17 @@ nsSmtpServer::VerifyLogon(nsIUrlListener</span>
<a href="#l19.23"></a><span id="l19.23">   nsresult rv;</span>
<a href="#l19.24"></a><span id="l19.24">   nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l19.25"></a><span id="l19.25">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.26"></a><span id="l19.26">   return smtpService-&gt;VerifyLogon(this, aUrlListener, aMsgWindow, aURL);</span>
<a href="#l19.27"></a><span id="l19.27"> }</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30"> NS_IMETHODIMP</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-nsSmtpServer::SetPassword(const nsACString&amp; aPassword)</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+nsSmtpServer::SetPassword(const nsAString&amp; aPassword)</span>
<a href="#l19.33"></a><span id="l19.33"> {</span>
<a href="#l19.34"></a><span id="l19.34">   m_password = aPassword;</span>
<a href="#l19.35"></a><span id="l19.35">   return NS_OK;</span>
<a href="#l19.36"></a><span id="l19.36"> }</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38"> nsresult</span>
<a href="#l19.39"></a><span id="l19.39"> nsSmtpServer::GetPasswordWithoutUI()</span>
<a href="#l19.40"></a><span id="l19.40"> {</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineat">@@ -401,30 +401,30 @@ nsSmtpServer::GetPasswordWithoutUI()</span>
<a href="#l19.42"></a><span id="l19.42">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.43"></a><span id="l19.43"> </span>
<a href="#l19.44"></a><span id="l19.44">       if (username.Equals(serverUsername))</span>
<a href="#l19.45"></a><span id="l19.45">       {</span>
<a href="#l19.46"></a><span id="l19.46">         nsString password;</span>
<a href="#l19.47"></a><span id="l19.47">         rv = logins[i]-&gt;GetPassword(password);</span>
<a href="#l19.48"></a><span id="l19.48">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.49"></a><span id="l19.49"> </span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-        LossyCopyUTF16toASCII(password, m_password);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+        m_password = password;</span>
<a href="#l19.52"></a><span id="l19.52">         break;</span>
<a href="#l19.53"></a><span id="l19.53">       }</span>
<a href="#l19.54"></a><span id="l19.54">     }</span>
<a href="#l19.55"></a><span id="l19.55">   }</span>
<a href="#l19.56"></a><span id="l19.56">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numLogins, logins);</span>
<a href="#l19.57"></a><span id="l19.57">   return NS_OK;</span>
<a href="#l19.58"></a><span id="l19.58"> }</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60"> NS_IMETHODIMP</span>
<a href="#l19.61"></a><span id="l19.61"> nsSmtpServer::GetPasswordWithUI(const char16_t *aPromptMessage,</span>
<a href="#l19.62"></a><span id="l19.62">                                 const char16_t *aPromptTitle,</span>
<a href="#l19.63"></a><span id="l19.63">                                 nsIAuthPrompt* aDialog,</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-                                nsACString &amp;aPassword)</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+                                nsAString &amp;aPassword)</span>
<a href="#l19.66"></a><span id="l19.66"> {</span>
<a href="#l19.67"></a><span id="l19.67">   if (!m_password.IsEmpty())</span>
<a href="#l19.68"></a><span id="l19.68">     return GetPassword(aPassword);</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70">   // We need to get a password, but see if we can get it from the password</span>
<a href="#l19.71"></a><span id="l19.71">   // manager without requiring a prompt.</span>
<a href="#l19.72"></a><span id="l19.72">   nsresult rv = GetPasswordWithoutUI();</span>
<a href="#l19.73"></a><span id="l19.73">   if (rv == NS_ERROR_ABORT)</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineat">@@ -439,46 +439,41 @@ nsSmtpServer::GetPasswordWithUI(const ch</span>
<a href="#l19.75"></a><span id="l19.75">   }</span>
<a href="#l19.76"></a><span id="l19.76"> </span>
<a href="#l19.77"></a><span id="l19.77">   NS_ENSURE_ARG_POINTER(aDialog);</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79">   // PromptPassword needs the username as well.</span>
<a href="#l19.80"></a><span id="l19.80">   nsCString serverUri(GetServerURIInternal(true));</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82">   bool okayValue = true;</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-  nsString uniPassword;</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85">   rv = aDialog-&gt;PromptPassword(aPromptTitle, aPromptMessage,</span>
<a href="#l19.86"></a><span id="l19.86">                                NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l19.87"></a><span id="l19.87">                                nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-                               getter_Copies(uniPassword), &amp;okayValue);</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+                               getter_Copies(aPassword), &amp;okayValue);</span>
<a href="#l19.90"></a><span id="l19.90">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.91"></a><span id="l19.91"> </span>
<a href="#l19.92"></a><span id="l19.92">   // If the user pressed cancel, just return an empty string.</span>
<a href="#l19.93"></a><span id="l19.93">   if (!okayValue)</span>
<a href="#l19.94"></a><span id="l19.94">   {</span>
<a href="#l19.95"></a><span id="l19.95">     aPassword.Truncate();</span>
<a href="#l19.96"></a><span id="l19.96">     return NS_MSG_PASSWORD_PROMPT_CANCELLED;</span>
<a href="#l19.97"></a><span id="l19.97">   }</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-  NS_LossyConvertUTF16toASCII password(uniPassword);</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-  rv = SetPassword(password);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+  rv = SetPassword(aPassword);</span>
<a href="#l19.103"></a><span id="l19.103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.104"></a><span id="l19.104"> </span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-  aPassword = password;</span>
<a href="#l19.106"></a><span id="l19.106">   return NS_OK;</span>
<a href="#l19.107"></a><span id="l19.107"> }</span>
<a href="#l19.108"></a><span id="l19.108"> </span>
<a href="#l19.109"></a><span id="l19.109"> NS_IMETHODIMP</span>
<a href="#l19.110"></a><span id="l19.110"> nsSmtpServer::GetUsernamePasswordWithUI(const char16_t * aPromptMessage, const</span>
<a href="#l19.111"></a><span id="l19.111">                                 char16_t *aPromptTitle,</span>
<a href="#l19.112"></a><span id="l19.112">                                 nsIAuthPrompt* aDialog,</span>
<a href="#l19.113"></a><span id="l19.113">                                 nsACString &amp;aUsername,</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-                                nsACString &amp;aPassword)</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+                                nsAString &amp;aPassword)</span>
<a href="#l19.116"></a><span id="l19.116"> {</span>
<a href="#l19.117"></a><span id="l19.117">   nsresult rv;</span>
<a href="#l19.118"></a><span id="l19.118">   if (!m_password.IsEmpty())</span>
<a href="#l19.119"></a><span id="l19.119">   {</span>
<a href="#l19.120"></a><span id="l19.120">     rv = GetUsername(aUsername);</span>
<a href="#l19.121"></a><span id="l19.121">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.122"></a><span id="l19.122"> </span>
<a href="#l19.123"></a><span id="l19.123">     return GetPassword(aPassword);</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineat">@@ -486,24 +481,23 @@ nsSmtpServer::GetUsernamePasswordWithUI(</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126">   NS_ENSURE_ARG_POINTER(aDialog);</span>
<a href="#l19.127"></a><span id="l19.127"> </span>
<a href="#l19.128"></a><span id="l19.128">   nsCString serverUri;</span>
<a href="#l19.129"></a><span id="l19.129">   rv = GetServerURI(serverUri);</span>
<a href="#l19.130"></a><span id="l19.130">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.131"></a><span id="l19.131"> </span>
<a href="#l19.132"></a><span id="l19.132">   nsString uniUsername;</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-  nsString uniPassword;</span>
<a href="#l19.134"></a><span id="l19.134">   bool okayValue = true;</span>
<a href="#l19.135"></a><span id="l19.135"> </span>
<a href="#l19.136"></a><span id="l19.136">   rv = aDialog-&gt;PromptUsernameAndPassword(aPromptTitle, aPromptMessage,</span>
<a href="#l19.137"></a><span id="l19.137">                                           NS_ConvertASCIItoUTF16(serverUri).get(),</span>
<a href="#l19.138"></a><span id="l19.138">                                           nsIAuthPrompt::SAVE_PASSWORD_PERMANENTLY,</span>
<a href="#l19.139"></a><span id="l19.139">                                           getter_Copies(uniUsername),</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-                                          getter_Copies(uniPassword),</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+                                          getter_Copies(aPassword),</span>
<a href="#l19.142"></a><span id="l19.142">                                           &amp;okayValue);</span>
<a href="#l19.143"></a><span id="l19.143">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.144"></a><span id="l19.144"> </span>
<a href="#l19.145"></a><span id="l19.145">   // If the user pressed cancel, just return emtpy strings.</span>
<a href="#l19.146"></a><span id="l19.146">   if (!okayValue)</span>
<a href="#l19.147"></a><span id="l19.147">   {</span>
<a href="#l19.148"></a><span id="l19.148">     aUsername.Truncate();</span>
<a href="#l19.149"></a><span id="l19.149">     aPassword.Truncate();</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineat">@@ -511,23 +505,20 @@ nsSmtpServer::GetUsernamePasswordWithUI(</span>
<a href="#l19.151"></a><span id="l19.151">   }</span>
<a href="#l19.152"></a><span id="l19.152"> </span>
<a href="#l19.153"></a><span id="l19.153">   // We got a username and password back...so remember them.</span>
<a href="#l19.154"></a><span id="l19.154">   NS_LossyConvertUTF16toASCII username(uniUsername);</span>
<a href="#l19.155"></a><span id="l19.155"> </span>
<a href="#l19.156"></a><span id="l19.156">   rv = SetUsername(username);</span>
<a href="#l19.157"></a><span id="l19.157">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-  NS_LossyConvertUTF16toASCII password(uniPassword);</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-  rv = SetPassword(password);</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+  rv = SetPassword(aPassword);</span>
<a href="#l19.163"></a><span id="l19.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.164"></a><span id="l19.164"> </span>
<a href="#l19.165"></a><span id="l19.165">   aUsername = username;</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-  aPassword = password;</span>
<a href="#l19.167"></a><span id="l19.167">   return NS_OK;</span>
<a href="#l19.168"></a><span id="l19.168"> }</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170"> NS_IMETHODIMP</span>
<a href="#l19.171"></a><span id="l19.171"> nsSmtpServer::ForgetPassword()</span>
<a href="#l19.172"></a><span id="l19.172"> {</span>
<a href="#l19.173"></a><span id="l19.173">   nsresult rv;</span>
<a href="#l19.174"></a><span id="l19.174">   nsCOMPtr&lt;nsILoginManager&gt; loginMgr =</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineat">@@ -572,17 +563,17 @@ nsSmtpServer::ForgetPassword()</span>
<a href="#l19.176"></a><span id="l19.176">     {</span>
<a href="#l19.177"></a><span id="l19.177">       // If this fails, just continue, we'll still want to remove the password</span>
<a href="#l19.178"></a><span id="l19.178">       // from our local cache.</span>
<a href="#l19.179"></a><span id="l19.179">       loginMgr-&gt;RemoveLogin(logins[i]);</span>
<a href="#l19.180"></a><span id="l19.180">     }</span>
<a href="#l19.181"></a><span id="l19.181">   }</span>
<a href="#l19.182"></a><span id="l19.182">   NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(count, logins);</span>
<a href="#l19.183"></a><span id="l19.183"> </span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-  rv = SetPassword(EmptyCString());</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+  rv = SetPassword(EmptyString());</span>
<a href="#l19.186"></a><span id="l19.186">   m_logonFailed = true;</span>
<a href="#l19.187"></a><span id="l19.187">   return rv;</span>
<a href="#l19.188"></a><span id="l19.188"> }</span>
<a href="#l19.189"></a><span id="l19.189"> </span>
<a href="#l19.190"></a><span id="l19.190"> NS_IMETHODIMP</span>
<a href="#l19.191"></a><span id="l19.191"> nsSmtpServer::GetServerURI(nsACString &amp;aResult)</span>
<a href="#l19.192"></a><span id="l19.192"> {</span>
<a href="#l19.193"></a><span id="l19.193">   aResult = GetServerURIInternal(true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -28,13 +28,13 @@ private:</span>
<a href="#l20.4"></a><span id="l20.4">     nsCOMPtr&lt;nsIPrefBranch&gt; mDefPrefBranch;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6">     nsresult getPrefs();</span>
<a href="#l20.7"></a><span id="l20.7">     void getIntPrefWithDefault(const char *prefName, int32_t *val,</span>
<a href="#l20.8"></a><span id="l20.8">                                int32_t defval);</span>
<a href="#l20.9"></a><span id="l20.9">     nsresult GetPasswordWithoutUI();</span>
<a href="#l20.10"></a><span id="l20.10">     nsCString GetServerURIInternal(const bool aIncludeUsername);</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    nsCString m_password;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    nsString m_password;</span>
<a href="#l20.14"></a><span id="l20.14">     bool m_logonFailed;</span>
<a href="#l20.15"></a><span id="l20.15"> };</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -75,34 +75,34 @@ nsSmtpService::~nsSmtpService()</span>
<a href="#l21.4"></a><span id="l21.4"> }</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> NS_IMPL_ISUPPORTS(nsSmtpService, nsISmtpService, nsIProtocolHandler)</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> NS_IMETHODIMP nsSmtpService::SendMailMessage(nsIFile * aFilePath,</span>
<a href="#l21.10"></a><span id="l21.10">                                         const char * aRecipients,</span>
<a href="#l21.11"></a><span id="l21.11">                                         nsIMsgIdentity * aSenderIdentity,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-                                        const char * aPassword,</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+                                        const nsAString &amp; aPassword,</span>
<a href="#l21.14"></a><span id="l21.14">                                         nsIUrlListener * aUrlListener,</span>
<a href="#l21.15"></a><span id="l21.15">                                         nsIMsgStatusFeedback *aStatusFeedback,</span>
<a href="#l21.16"></a><span id="l21.16">                                         nsIInterfaceRequestor* aNotificationCallbacks,</span>
<a href="#l21.17"></a><span id="l21.17">                                         bool aRequestDSN,</span>
<a href="#l21.18"></a><span id="l21.18">                                         nsIURI ** aURL,</span>
<a href="#l21.19"></a><span id="l21.19">                                         nsIRequest ** aRequest)</span>
<a href="#l21.20"></a><span id="l21.20"> {</span>
<a href="#l21.21"></a><span id="l21.21">   nsIURI * urlToRun = nullptr;</span>
<a href="#l21.22"></a><span id="l21.22">   nsresult rv = NS_OK;</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l21.25"></a><span id="l21.25">   rv = GetServerByIdentity(aSenderIdentity, getter_AddRefs(smtpServer));</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer)</span>
<a href="#l21.28"></a><span id="l21.28">   {</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    if (aPassword &amp;&amp; *aPassword)</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-      smtpServer-&gt;SetPassword(nsDependentCString(aPassword));</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+    if (!aPassword.IsEmpty())</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+      smtpServer-&gt;SetPassword(aPassword);</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34">     // this ref counts urlToRun</span>
<a href="#l21.35"></a><span id="l21.35">     rv = NS_MsgBuildSmtpUrl(aFilePath, smtpServer, aRecipients, aSenderIdentity,</span>
<a href="#l21.36"></a><span id="l21.36">                             aUrlListener, aStatusFeedback,</span>
<a href="#l21.37"></a><span id="l21.37">                             aNotificationCallbacks, &amp;urlToRun, aRequestDSN);</span>
<a href="#l21.38"></a><span id="l21.38">     if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)	</span>
<a href="#l21.39"></a><span id="l21.39">       rv = NS_MsgLoadSmtpUrl(urlToRun, nullptr, aRequest);</span>
<a href="#l21.40"></a><span id="l21.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -850,17 +850,17 @@ nsresult nsMsgMdnGenerator::SendMdnMsg()</span>
<a href="#l22.4"></a><span id="l22.4"> {</span>
<a href="#l22.5"></a><span id="l22.5">     DEBUG_MDN(&quot;nsMsgMdnGenerator::SendMdnMsg&quot;);</span>
<a href="#l22.6"></a><span id="l22.6">     nsresult rv;</span>
<a href="#l22.7"></a><span id="l22.7">     nsCOMPtr&lt;nsISmtpService&gt; smtpService = do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.8"></a><span id="l22.8">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10">     nsCOMPtr&lt;nsIRequest&gt; aRequest;</span>
<a href="#l22.11"></a><span id="l22.11">     smtpService-&gt;SendMailMessage(m_file, m_dntRrt.get(), m_identity,</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-                                     nullptr, this, nullptr, nullptr, false, nullptr,</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+                                     EmptyString(), this, nullptr, nullptr, false, nullptr,</span>
<a href="#l22.14"></a><span id="l22.14">                                      getter_AddRefs(aRequest));</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16">     return NS_OK;</span>
<a href="#l22.17"></a><span id="l22.17"> }</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> nsresult nsMsgMdnGenerator::WriteString( const char *str )</span>
<a href="#l22.20"></a><span id="l22.20"> {</span>
<a href="#l22.21"></a><span id="l22.21">   NS_ENSURE_ARG (str);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/public/nsIIMAPHostSessionList.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/public/nsIIMAPHostSessionList.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -31,17 +31,17 @@ public:</span>
<a href="#l23.4"></a><span id="l23.4">   NS_IMETHOD  GetHostHasAdminURL(const char *serverKey, bool &amp;result) = 0;</span>
<a href="#l23.5"></a><span id="l23.5">   NS_IMETHOD  SetHostHasAdminURL(const char *serverKey, bool hasAdminUrl) = 0;</span>
<a href="#l23.6"></a><span id="l23.6">   // Subscription</span>
<a href="#l23.7"></a><span id="l23.7">   NS_IMETHOD  GetHostIsUsingSubscription(const char *serverKey, bool &amp;result) = 0;</span>
<a href="#l23.8"></a><span id="l23.8">   NS_IMETHOD  SetHostIsUsingSubscription(const char *serverKey, bool usingSubscription) = 0;</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10">   // Passwords</span>
<a href="#l23.11"></a><span id="l23.11">   NS_IMETHOD  GetPasswordForHost(const char *serverKey, nsString &amp;result) = 0;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  NS_IMETHOD  SetPasswordForHost(const char *serverKey, const char *password) = 0;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  NS_IMETHOD  SetPasswordForHost(const char *serverKey, const nsAString &amp;password) = 0;</span>
<a href="#l23.14"></a><span id="l23.14">   NS_IMETHOD  GetPasswordVerifiedOnline(const char *serverKey, bool &amp;result) = 0;</span>
<a href="#l23.15"></a><span id="l23.15">   NS_IMETHOD  SetPasswordVerifiedOnline(const char *serverKey) = 0;</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">   // OnlineDir</span>
<a href="#l23.18"></a><span id="l23.18">   NS_IMETHOD GetOnlineDirForHost(const char *serverKey,</span>
<a href="#l23.19"></a><span id="l23.19">                                  nsString &amp;result) = 0;</span>
<a href="#l23.20"></a><span id="l23.20">   NS_IMETHOD SetOnlineDirForHost(const char *serverKey,</span>
<a href="#l23.21"></a><span id="l23.21">                                  const char *onlineDir) = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapIncomingServer.idl</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapIncomingServer.idl</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -92,14 +92,14 @@ interface nsIImapIncomingServer : nsISup</span>
<a href="#l24.4"></a><span id="l24.4">    * server object.</span>
<a href="#l24.5"></a><span id="l24.5">    * @param aWindow  msgWindow to associate the password prompt with</span>
<a href="#l24.6"></a><span id="l24.6">    * @return Password string.</span>
<a href="#l24.7"></a><span id="l24.7">    * @exception NS_ERROR_FAILURE  The password could not be obtained.</span>
<a href="#l24.8"></a><span id="l24.8">    * @note NS_MSG_PASSWORD_PROMPT_CANCELLED is a success code that is returned</span>
<a href="#l24.9"></a><span id="l24.9">    *       if the prompt was presented to the user but the user cancelled the</span>
<a href="#l24.10"></a><span id="l24.10">    *       prompt.</span>
<a href="#l24.11"></a><span id="l24.11">    */</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  ACString PromptPassword(in nsIMsgWindow aWindow);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  AString PromptPassword(in nsIMsgWindow aWindow);</span>
<a href="#l24.14"></a><span id="l24.14">   attribute boolean doingLsub;</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16">   ACString getUriWithNamespacePrefixIfNecessary(in long namespaceType, in ACString originalUri);</span>
<a href="#l24.17"></a><span id="l24.17">   attribute boolean shuttingDown;</span>
<a href="#l24.18"></a><span id="l24.18"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapProtocol.idl</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -60,12 +60,10 @@ interface nsIImapProtocol : nsISupports </span>
<a href="#l25.4"></a><span id="l25.4"> </span>
<a href="#l25.5"></a><span id="l25.5">   // Get last active time stamp</span>
<a href="#l25.6"></a><span id="l25.6">   void GetLastActiveTimeStamp(out PRTime aTimeStamp);</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   void pseudoInterruptMsgLoad(in nsIMsgFolder imapFolder, in nsIMsgWindow aMsgWindow, out boolean interrupted);</span>
<a href="#l25.9"></a><span id="l25.9">   void GetSelectedMailboxName(out string folderName);</span>
<a href="#l25.10"></a><span id="l25.10">   // Reset folder connection to authenticated state</span>
<a href="#l25.11"></a><span id="l25.11">   void ResetToAuthenticatedState();</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  void OverrideConnectionInfo(in wstring pHost, in unsigned short pPort, in string pCookieData);</span>
<a href="#l25.14"></a><span id="l25.14"> };</span>
<a href="#l25.15"></a><span id="l25.15"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapServerSink.idl</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -126,17 +126,17 @@ interface nsIImapServerSink : nsISupport</span>
<a href="#l26.4"></a><span id="l26.4">    *</span>
<a href="#l26.5"></a><span id="l26.5">    * @param aProtocol imap protocol object requesting the password.</span>
<a href="#l26.6"></a><span id="l26.6">    * @param aNewPasswordRequested Forces password prompt immediately</span>
<a href="#l26.7"></a><span id="l26.7">    * @param aPassword returns the password, unless we had to prompt or use the,</span>
<a href="#l26.8"></a><span id="l26.8">    *                  login manager and there was already a prompt up.</span>
<a href="#l26.9"></a><span id="l26.9">    */</span>
<a href="#l26.10"></a><span id="l26.10">   void asyncGetPassword(in nsIImapProtocol aProtocol,</span>
<a href="#l26.11"></a><span id="l26.11">                         in boolean aNewPasswordRequested,</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-                        out ACString aPassword);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+                        out AString aPassword);</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15">   attribute boolean userAuthenticated;</span>
<a href="#l26.16"></a><span id="l26.16">   void setMailServerUrls(in ACString manageMailAccount, in ACString manageLists, in ACString manageFilters);</span>
<a href="#l26.17"></a><span id="l26.17"> </span>
<a href="#l26.18"></a><span id="l26.18">   /** Used by the imap thread when upgrading from the socketType</span>
<a href="#l26.19"></a><span id="l26.19">    * trySTARTTLS.</span>
<a href="#l26.20"></a><span id="l26.20">    * @param aSucceeded whether STARTTLS succeeded. If it did, the server</span>
<a href="#l26.21"></a><span id="l26.21">    * will set the socket type to alwaysSTARTTLS, otherwise plain.</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -150,17 +150,17 @@ interface nsIImapServerSink : nsISupport</span>
<a href="#l26.23"></a><span id="l26.23">   string cramMD5Hash(in string decodedChallenge, in string key);</span>
<a href="#l26.24"></a><span id="l26.24">   /// String to send to the imap server as the login user name.</span>
<a href="#l26.25"></a><span id="l26.25">   readonly attribute ACString loginUsername;</span>
<a href="#l26.26"></a><span id="l26.26">   /// String to send to the imap server as the user name.</span>
<a href="#l26.27"></a><span id="l26.27">   readonly attribute ACString originalUsername;</span>
<a href="#l26.28"></a><span id="l26.28">   /// Internal pref key, unique over all servers</span>
<a href="#l26.29"></a><span id="l26.29">   readonly attribute ACString serverKey;</span>
<a href="#l26.30"></a><span id="l26.30">   /// password for server login</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-  readonly attribute ACString serverPassword;</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+  readonly attribute AString serverPassword;</span>
<a href="#l26.33"></a><span id="l26.33">   /// remove a connection to the server</span>
<a href="#l26.34"></a><span id="l26.34">   void removeServerConnection(in nsIImapProtocol aProtocol);</span>
<a href="#l26.35"></a><span id="l26.35">   /// is the imap server shutting down?</span>
<a href="#l26.36"></a><span id="l26.36">   readonly attribute boolean serverShuttingDown;</span>
<a href="#l26.37"></a><span id="l26.37">   /// reset the connection for a particular folder</span>
<a href="#l26.38"></a><span id="l26.38">   void resetServerConnection(in ACString aFolderName);</span>
<a href="#l26.39"></a><span id="l26.39">   /// tell the server if listing using lsub command</span>
<a href="#l26.40"></a><span id="l26.40">   void setServerDoingLsub(in boolean aDoingLsub);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPHostSessionList.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPHostSessionList.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -18,17 +18,16 @@</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> nsIMAPHostInfo::nsIMAPHostInfo(const char *serverKey,</span>
<a href="#l27.6"></a><span id="l27.6">                                nsIImapIncomingServer *server)</span>
<a href="#l27.7"></a><span id="l27.7"> {</span>
<a href="#l27.8"></a><span id="l27.8">   fServerKey = serverKey;</span>
<a href="#l27.9"></a><span id="l27.9">   NS_ASSERTION(server, &quot;*** Fatal null imap incoming server...\n&quot;);</span>
<a href="#l27.10"></a><span id="l27.10">   server-&gt;GetServerDirectory(fOnlineDir);</span>
<a href="#l27.11"></a><span id="l27.11">   fNextHost = NULL;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  fCachedPassword = NULL;</span>
<a href="#l27.13"></a><span id="l27.13">   fCapabilityFlags = kCapabilityUndefined;</span>
<a href="#l27.14"></a><span id="l27.14">   fHierarchyDelimiters = NULL;</span>
<a href="#l27.15"></a><span id="l27.15"> #ifdef DEBUG_bienvenu1</span>
<a href="#l27.16"></a><span id="l27.16">   fHaveWeEverDiscoveredFolders = true; // try this, see what bad happens - we'll need to</span>
<a href="#l27.17"></a><span id="l27.17">   // figure out a way to make new accounts have it be false</span>
<a href="#l27.18"></a><span id="l27.18"> #else</span>
<a href="#l27.19"></a><span id="l27.19">   fHaveWeEverDiscoveredFolders = false; // try this, see what bad happens</span>
<a href="#l27.20"></a><span id="l27.20"> #endif</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineat">@@ -46,17 +45,16 @@ nsIMAPHostInfo::nsIMAPHostInfo(const cha</span>
<a href="#l27.22"></a><span id="l27.22">   fHaveAdminURL = false;</span>
<a href="#l27.23"></a><span id="l27.23">   fNamespacesOverridable = true;</span>
<a href="#l27.24"></a><span id="l27.24">   server-&gt;GetOverrideNamespaces(&amp;fNamespacesOverridable);</span>
<a href="#l27.25"></a><span id="l27.25">   fTempNamespaceList = nsIMAPNamespaceList::CreatensIMAPNamespaceList();</span>
<a href="#l27.26"></a><span id="l27.26"> }</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28"> nsIMAPHostInfo::~nsIMAPHostInfo()</span>
<a href="#l27.29"></a><span id="l27.29"> {</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-  PR_Free(fCachedPassword);</span>
<a href="#l27.31"></a><span id="l27.31">   PR_Free(fHierarchyDelimiters);</span>
<a href="#l27.32"></a><span id="l27.32">   delete fNamespaceList;</span>
<a href="#l27.33"></a><span id="l27.33">   delete fTempNamespaceList;</span>
<a href="#l27.34"></a><span id="l27.34">   delete fShellCache;</span>
<a href="#l27.35"></a><span id="l27.35"> }</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37"> NS_IMPL_ISUPPORTS(nsIMAPHostSessionList,</span>
<a href="#l27.38"></a><span id="l27.38">                               nsIImapHostSessionList,</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineat">@@ -150,31 +148,27 @@ nsIMAPHostSessionList::AddHostToList(con</span>
<a href="#l27.40"></a><span id="l27.40">   return (newHost == NULL) ? NS_ERROR_ILLEGAL_VALUE : NS_OK;</span>
<a href="#l27.41"></a><span id="l27.41"> }</span>
<a href="#l27.42"></a><span id="l27.42"> </span>
<a href="#l27.43"></a><span id="l27.43"> NS_IMETHODIMP nsIMAPHostSessionList::GetPasswordForHost(const char *serverKey, nsString &amp;result)</span>
<a href="#l27.44"></a><span id="l27.44"> {</span>
<a href="#l27.45"></a><span id="l27.45">   PR_EnterMonitor(gCachedHostInfoMonitor);</span>
<a href="#l27.46"></a><span id="l27.46">   nsIMAPHostInfo *host = FindHost(serverKey);</span>
<a href="#l27.47"></a><span id="l27.47">   if (host)</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-    CopyASCIItoUTF16(nsDependentCString(host-&gt;fCachedPassword), result);</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+    result = host-&gt;fCachedPassword;</span>
<a href="#l27.50"></a><span id="l27.50">   PR_ExitMonitor(gCachedHostInfoMonitor);</span>
<a href="#l27.51"></a><span id="l27.51">   return (host == NULL) ? NS_ERROR_ILLEGAL_VALUE : NS_OK;</span>
<a href="#l27.52"></a><span id="l27.52"> }</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-NS_IMETHODIMP nsIMAPHostSessionList::SetPasswordForHost(const char *serverKey, const char *password)</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+NS_IMETHODIMP nsIMAPHostSessionList::SetPasswordForHost(const char *serverKey, const nsAString &amp;password)</span>
<a href="#l27.56"></a><span id="l27.56"> {</span>
<a href="#l27.57"></a><span id="l27.57">   PR_EnterMonitor(gCachedHostInfoMonitor);</span>
<a href="#l27.58"></a><span id="l27.58">   nsIMAPHostInfo *host = FindHost(serverKey);</span>
<a href="#l27.59"></a><span id="l27.59">   if (host)</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-  {</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-    PR_FREEIF(host-&gt;fCachedPassword);</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-    if (password)</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineminus">-      host-&gt;fCachedPassword = NS_strdup(password);</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineminus">-  }</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineplus">+    host-&gt;fCachedPassword = password;</span>
<a href="#l27.66"></a><span id="l27.66">   PR_ExitMonitor(gCachedHostInfoMonitor);</span>
<a href="#l27.67"></a><span id="l27.67">   return (host == NULL) ? NS_ERROR_ILLEGAL_VALUE : NS_OK;</span>
<a href="#l27.68"></a><span id="l27.68"> }</span>
<a href="#l27.69"></a><span id="l27.69"> </span>
<a href="#l27.70"></a><span id="l27.70"> NS_IMETHODIMP nsIMAPHostSessionList::SetPasswordVerifiedOnline(const char *serverKey)</span>
<a href="#l27.71"></a><span id="l27.71"> {</span>
<a href="#l27.72"></a><span id="l27.72">   PR_EnterMonitor(gCachedHostInfoMonitor);</span>
<a href="#l27.73"></a><span id="l27.73">   nsIMAPHostInfo *host = FindHost(serverKey);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPHostSessionList.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPHostSessionList.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -20,17 +20,17 @@ class nsIMAPHostInfo</span>
<a href="#l28.4"></a><span id="l28.4"> {</span>
<a href="#l28.5"></a><span id="l28.5"> public:</span>
<a href="#l28.6"></a><span id="l28.6">   friend class nsIMAPHostSessionList;</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8">   nsIMAPHostInfo(const char *serverKey, nsIImapIncomingServer *server);</span>
<a href="#l28.9"></a><span id="l28.9">   ~nsIMAPHostInfo();</span>
<a href="#l28.10"></a><span id="l28.10"> protected:</span>
<a href="#l28.11"></a><span id="l28.11">   nsCString fServerKey;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  char *fCachedPassword;</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+  nsString fCachedPassword;</span>
<a href="#l28.14"></a><span id="l28.14">   nsCString fOnlineDir;</span>
<a href="#l28.15"></a><span id="l28.15">   nsIMAPHostInfo *fNextHost;</span>
<a href="#l28.16"></a><span id="l28.16">   eIMAPCapabilityFlags fCapabilityFlags;</span>
<a href="#l28.17"></a><span id="l28.17">   char *fHierarchyDelimiters;// string of top-level hierarchy delimiters</span>
<a href="#l28.18"></a><span id="l28.18">   bool fHaveWeEverDiscoveredFolders;</span>
<a href="#l28.19"></a><span id="l28.19">   char *fCanonicalOnlineSubDir;</span>
<a href="#l28.20"></a><span id="l28.20">   nsIMAPNamespaceList *fNamespaceList, *fTempNamespaceList;</span>
<a href="#l28.21"></a><span id="l28.21">   bool fNamespacesOverridable;</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineat">@@ -63,17 +63,17 @@ public:</span>
<a href="#l28.23"></a><span id="l28.23">   NS_IMETHOD GetHostHasAdminURL(const char *serverKey, bool &amp;result) override;</span>
<a href="#l28.24"></a><span id="l28.24">   NS_IMETHOD SetHostHasAdminURL(const char *serverKey, bool hasAdminUrl) override;</span>
<a href="#l28.25"></a><span id="l28.25">   // Subscription</span>
<a href="#l28.26"></a><span id="l28.26">   NS_IMETHOD GetHostIsUsingSubscription(const char *serverKey, bool &amp;result) override;</span>
<a href="#l28.27"></a><span id="l28.27">   NS_IMETHOD SetHostIsUsingSubscription(const char *serverKey, bool usingSubscription) override;</span>
<a href="#l28.28"></a><span id="l28.28"> </span>
<a href="#l28.29"></a><span id="l28.29">   // Passwords</span>
<a href="#l28.30"></a><span id="l28.30">   NS_IMETHOD GetPasswordForHost(const char *serverKey, nsString &amp;result) override;</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-  NS_IMETHOD SetPasswordForHost(const char *serverKey, const char *password) override;</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+  NS_IMETHOD SetPasswordForHost(const char *serverKey, const nsAString &amp;password) override;</span>
<a href="#l28.33"></a><span id="l28.33">   NS_IMETHOD GetPasswordVerifiedOnline(const char *serverKey, bool &amp;result) override;</span>
<a href="#l28.34"></a><span id="l28.34">   NS_IMETHOD SetPasswordVerifiedOnline(const char *serverKey) override;</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36">   // OnlineDir</span>
<a href="#l28.37"></a><span id="l28.37">   NS_IMETHOD GetOnlineDirForHost(const char *serverKey,</span>
<a href="#l28.38"></a><span id="l28.38">                                  nsString &amp;result) override;</span>
<a href="#l28.39"></a><span id="l28.39">   NS_IMETHOD SetOnlineDirForHost(const char *serverKey,</span>
<a href="#l28.40"></a><span id="l28.40">                                  const char *onlineDir) override;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -952,17 +952,17 @@ NS_IMETHODIMP nsImapIncomingServer::Rese</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5">   PR_CExitMonitor(this);</span>
<a href="#l29.6"></a><span id="l29.6">   return rv;</span>
<a href="#l29.7"></a><span id="l29.7"> }</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> NS_IMETHODIMP</span>
<a href="#l29.10"></a><span id="l29.10"> nsImapIncomingServer::PerformExpand(nsIMsgWindow *aMsgWindow)</span>
<a href="#l29.11"></a><span id="l29.11"> {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  nsCString password;</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  nsString password;</span>
<a href="#l29.14"></a><span id="l29.14">   nsresult rv;</span>
<a href="#l29.15"></a><span id="l29.15">   rv = GetPassword(password);</span>
<a href="#l29.16"></a><span id="l29.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18">   if (password.IsEmpty())</span>
<a href="#l29.19"></a><span id="l29.19">     return NS_OK;</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21">   rv = ResetFoldersToUnverified(nullptr);</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -2145,17 +2145,17 @@ NS_IMETHODIMP nsImapIncomingServer::Forg</span>
<a href="#l29.23"></a><span id="l29.23"> {</span>
<a href="#l29.24"></a><span id="l29.24">   return nsMsgIncomingServer::ForgetPassword();</span>
<a href="#l29.25"></a><span id="l29.25"> }</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27"> </span>
<a href="#l29.28"></a><span id="l29.28"> NS_IMETHODIMP</span>
<a href="#l29.29"></a><span id="l29.29"> nsImapIncomingServer::AsyncGetPassword(nsIImapProtocol *aProtocol,</span>
<a href="#l29.30"></a><span id="l29.30">                                        bool aNewPasswordRequested,</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-                                       nsACString &amp;aPassword)</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+                                       nsAString &amp;aPassword)</span>
<a href="#l29.33"></a><span id="l29.33"> {</span>
<a href="#l29.34"></a><span id="l29.34">   if (m_password.IsEmpty())</span>
<a href="#l29.35"></a><span id="l29.35">   {</span>
<a href="#l29.36"></a><span id="l29.36">     // We're now going to need to do something that will end up with us either</span>
<a href="#l29.37"></a><span id="l29.37">     // poking login manager or prompting the user. We need to ensure we only</span>
<a href="#l29.38"></a><span id="l29.38">     // do one prompt at a time (and login manager could cause a master password</span>
<a href="#l29.39"></a><span id="l29.39">     // prompt), so we need to use the async prompter.</span>
<a href="#l29.40"></a><span id="l29.40">     nsresult rv;</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineat">@@ -2171,17 +2171,17 @@ nsImapIncomingServer::AsyncGetPassword(n</span>
<a href="#l29.42"></a><span id="l29.42">   }</span>
<a href="#l29.43"></a><span id="l29.43">   if (!m_password.IsEmpty())</span>
<a href="#l29.44"></a><span id="l29.44">     aPassword = m_password;</span>
<a href="#l29.45"></a><span id="l29.45">   return NS_OK;</span>
<a href="#l29.46"></a><span id="l29.46"> }</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48"> NS_IMETHODIMP</span>
<a href="#l29.49"></a><span id="l29.49"> nsImapIncomingServer::PromptPassword(nsIMsgWindow *aMsgWindow,</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-                                     nsACString &amp;aPassword)</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+                                     nsAString &amp;aPassword)</span>
<a href="#l29.52"></a><span id="l29.52"> {</span>
<a href="#l29.53"></a><span id="l29.53">   nsString passwordTitle;</span>
<a href="#l29.54"></a><span id="l29.54">   GetImapStringByName(&quot;imapEnterPasswordPromptTitle&quot;, passwordTitle);</span>
<a href="#l29.55"></a><span id="l29.55">   NS_ENSURE_STATE(m_stringBundle);</span>
<a href="#l29.56"></a><span id="l29.56"> </span>
<a href="#l29.57"></a><span id="l29.57">   nsAutoCString userName;</span>
<a href="#l29.58"></a><span id="l29.58">   GetRealUsername(userName);</span>
<a href="#l29.59"></a><span id="l29.59"> </span>
<a href="#l29.60"></a><span id="l29.60" class="difflineat">@@ -3337,17 +3337,17 @@ nsImapIncomingServer::GetOriginalUsernam</span>
<a href="#l29.61"></a><span id="l29.61"> </span>
<a href="#l29.62"></a><span id="l29.62"> NS_IMETHODIMP</span>
<a href="#l29.63"></a><span id="l29.63"> nsImapIncomingServer::GetServerKey(nsACString &amp;aServerKey)</span>
<a href="#l29.64"></a><span id="l29.64"> {</span>
<a href="#l29.65"></a><span id="l29.65">   return GetKey(aServerKey);</span>
<a href="#l29.66"></a><span id="l29.66"> }</span>
<a href="#l29.67"></a><span id="l29.67"> </span>
<a href="#l29.68"></a><span id="l29.68"> NS_IMETHODIMP</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineminus">-nsImapIncomingServer::GetServerPassword(nsACString &amp;aPassword)</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+nsImapIncomingServer::GetServerPassword(nsAString &amp;aPassword)</span>
<a href="#l29.71"></a><span id="l29.71"> {</span>
<a href="#l29.72"></a><span id="l29.72">   return GetPassword(aPassword);</span>
<a href="#l29.73"></a><span id="l29.73"> }</span>
<a href="#l29.74"></a><span id="l29.74"> </span>
<a href="#l29.75"></a><span id="l29.75"> NS_IMETHODIMP</span>
<a href="#l29.76"></a><span id="l29.76"> nsImapIncomingServer::RemoveServerConnection(nsIImapProtocol* aProtocol)</span>
<a href="#l29.77"></a><span id="l29.77"> {</span>
<a href="#l29.78"></a><span id="l29.78">   return RemoveConnection(aProtocol);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -476,17 +476,16 @@ nsImapProtocol::nsImapProtocol() : nsMsg</span>
<a href="#l30.4"></a><span id="l30.4">   m_fetchBodyListIsNew = false;</span>
<a href="#l30.5"></a><span id="l30.5">   m_flagChangeCount = 0;</span>
<a href="#l30.6"></a><span id="l30.6">   m_lastCheckTime = PR_Now();</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8">   m_checkForNewMailDownloadsHeaders = true;  // this should be on by default</span>
<a href="#l30.9"></a><span id="l30.9">   m_hierarchyNameState = kNoOperationInProgress;</span>
<a href="#l30.10"></a><span id="l30.10">   m_discoveryStatus = eContinue;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-  m_overRideUrlConnectionInfo = false;</span>
<a href="#l30.13"></a><span id="l30.13">   // m_dataOutputBuf is used by Send Data</span>
<a href="#l30.14"></a><span id="l30.14">   m_dataOutputBuf = (char *) PR_CALLOC(sizeof(char) * OUTPUT_BUFFER_SIZE);</span>
<a href="#l30.15"></a><span id="l30.15">   m_allocatedSize = OUTPUT_BUFFER_SIZE;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17">   // used to buffer incoming data by ReadNextLine</span>
<a href="#l30.18"></a><span id="l30.18">   m_inputStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true /* allocate new lines */, false /* leave CRLFs on the returned string */);</span>
<a href="#l30.19"></a><span id="l30.19">   m_currentBiffState = nsIMsgFolder::nsMsgBiffState_Unknown;</span>
<a href="#l30.20"></a><span id="l30.20">   m_progressStringName.Truncate();</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineat">@@ -889,44 +888,31 @@ nsresult nsImapProtocol::SetupWithUrlCal</span>
<a href="#l30.22"></a><span id="l30.22">     connectionType = &quot;ssl&quot;;</span>
<a href="#l30.23"></a><span id="l30.23">   else if (m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l30.24"></a><span id="l30.24">     connectionType = &quot;starttls&quot;;</span>
<a href="#l30.25"></a><span id="l30.25">   // This can go away once we think everyone is migrated</span>
<a href="#l30.26"></a><span id="l30.26">   // away from the trySTARTTLS socket type.</span>
<a href="#l30.27"></a><span id="l30.27">   else if (m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l30.28"></a><span id="l30.28">     connectionType = &quot;starttls&quot;;</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-  const nsACString *socketHost;</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-  uint16_t socketPort;</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-  if (m_overRideUrlConnectionInfo)</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-  {</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-    socketHost = &amp;m_logonHost;</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-    socketPort = m_logonPort;</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-  }</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-  else</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-  {</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-    socketHost = &amp;m_realHostName;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-    int32_t port = -1;</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-      return rv;</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineminus">-    uri-&gt;GetPort(&amp;port);</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineminus">-    socketPort = port;</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-  }</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+  int32_t port = -1;</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+    return rv;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+  uri-&gt;GetPort(&amp;port);</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54">   rv = socketService-&gt;CreateTransport(&amp;connectionType, connectionType != nullptr,</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-                                      *socketHost, socketPort, aProxyInfo,</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+                                      m_realHostName, port, aProxyInfo,</span>
<a href="#l30.57"></a><span id="l30.57">                                       getter_AddRefs(m_transport));</span>
<a href="#l30.58"></a><span id="l30.58">   if (NS_FAILED(rv) &amp;&amp; m_socketType == nsMsgSocketType::trySTARTTLS)</span>
<a href="#l30.59"></a><span id="l30.59">   {</span>
<a href="#l30.60"></a><span id="l30.60">     connectionType = nullptr;</span>
<a href="#l30.61"></a><span id="l30.61">     m_socketType = nsMsgSocketType::plain;</span>
<a href="#l30.62"></a><span id="l30.62">     rv = socketService-&gt;CreateTransport(&amp;connectionType, connectionType != nullptr,</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-                                        *socketHost, socketPort, aProxyInfo,</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+                                        m_realHostName, port, aProxyInfo,</span>
<a href="#l30.65"></a><span id="l30.65">                                         getter_AddRefs(m_transport));</span>
<a href="#l30.66"></a><span id="l30.66">   }</span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68">   // remember so we can know whether we can issue a start tls or not...</span>
<a href="#l30.69"></a><span id="l30.69">   m_connectionType = connectionType;</span>
<a href="#l30.70"></a><span id="l30.70">   if (m_transport &amp;&amp; m_mockChannel)</span>
<a href="#l30.71"></a><span id="l30.71">   {</span>
<a href="#l30.72"></a><span id="l30.72">     uint8_t qos;</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineat">@@ -5753,24 +5739,24 @@ void nsImapProtocol::MarkAuthMethodAsFai</span>
<a href="#l30.74"></a><span id="l30.74">  */</span>
<a href="#l30.75"></a><span id="l30.75"> void nsImapProtocol::ResetAuthMethods()</span>
<a href="#l30.76"></a><span id="l30.76"> {</span>
<a href="#l30.77"></a><span id="l30.77">   MOZ_LOG(IMAP, LogLevel::Debug, (&quot;resetting (failed) auth methods&quot;));</span>
<a href="#l30.78"></a><span id="l30.78">   m_currentAuthMethod = kCapabilityUndefined;</span>
<a href="#l30.79"></a><span id="l30.79">   m_failedAuthMethods = 0;</span>
<a href="#l30.80"></a><span id="l30.80"> }</span>
<a href="#l30.81"></a><span id="l30.81"> </span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-nsresult nsImapProtocol::AuthLogin(const char *userName, const nsCString &amp;password, eIMAPCapabilityFlag flag)</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+nsresult nsImapProtocol::AuthLogin(const char *userName, const nsString &amp;aPassword, eIMAPCapabilityFlag flag)</span>
<a href="#l30.84"></a><span id="l30.84"> {</span>
<a href="#l30.85"></a><span id="l30.85">   ProgressEventFunctionUsingName(&quot;imapStatusSendingAuthLogin&quot;);</span>
<a href="#l30.86"></a><span id="l30.86">   IncrementCommandTagNumber();</span>
<a href="#l30.87"></a><span id="l30.87"> </span>
<a href="#l30.88"></a><span id="l30.88">   char * currentCommand=nullptr;</span>
<a href="#l30.89"></a><span id="l30.89">   nsresult rv;</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineminus">-</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+  NS_ConvertUTF16toUTF8 password(aPassword);</span>
<a href="#l30.92"></a><span id="l30.92">   MOZ_LOG(IMAP, LogLevel::Debug, (&quot;IMAP: trying auth method 0x%&quot; PRIx64, m_currentAuthMethod));</span>
<a href="#l30.93"></a><span id="l30.93"> </span>
<a href="#l30.94"></a><span id="l30.94">   if (flag &amp; kHasAuthExternalCapability)</span>
<a href="#l30.95"></a><span id="l30.95">   {</span>
<a href="#l30.96"></a><span id="l30.96">       char *base64UserName = PL_Base64Encode(userName, strlen(userName), nullptr);</span>
<a href="#l30.97"></a><span id="l30.97">       nsAutoCString command (GetServerCommandTag());</span>
<a href="#l30.98"></a><span id="l30.98">       command.Append(&quot; authenticate EXTERNAL &quot; );</span>
<a href="#l30.99"></a><span id="l30.99">       command.Append(base64UserName);</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineat">@@ -5878,17 +5864,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l30.101"></a><span id="l30.101">     nsAutoCString command (GetServerCommandTag());</span>
<a href="#l30.102"></a><span id="l30.102">     command.Append((flag &amp; kHasAuthNTLMCapability) ? &quot; authenticate NTLM&quot; CRLF</span>
<a href="#l30.103"></a><span id="l30.103">                                                    : &quot; authenticate MSN&quot; CRLF);</span>
<a href="#l30.104"></a><span id="l30.104">     rv = SendData(command.get());</span>
<a href="#l30.105"></a><span id="l30.105">     ParseIMAPandCheckForNewMail(&quot;AUTH NTLM&quot;); // this just waits for ntlm step 1</span>
<a href="#l30.106"></a><span id="l30.106">     if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l30.107"></a><span id="l30.107">     {</span>
<a href="#l30.108"></a><span id="l30.108">       nsAutoCString cmd;</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineminus">-      rv = DoNtlmStep1(userName, password.get(), cmd);</span>
<a href="#l30.110"></a><span id="l30.110" class="difflineplus">+      rv = DoNtlmStep1(nsDependentCString(userName), aPassword, cmd);</span>
<a href="#l30.111"></a><span id="l30.111">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.112"></a><span id="l30.112">       cmd += CRLF;</span>
<a href="#l30.113"></a><span id="l30.113">       rv = SendData(cmd.get());</span>
<a href="#l30.114"></a><span id="l30.114">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.115"></a><span id="l30.115">       ParseIMAPandCheckForNewMail(command.get());</span>
<a href="#l30.116"></a><span id="l30.116">       if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l30.117"></a><span id="l30.117">       {</span>
<a href="#l30.118"></a><span id="l30.118">         nsCString challengeStr(GetServerStateParser().fAuthChallenge);</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineat">@@ -5968,17 +5954,19 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l30.120"></a><span id="l30.120">     command.Append(&quot; login \&quot;&quot;);</span>
<a href="#l30.121"></a><span id="l30.121">     EscapeUserNamePasswordString(userName, &amp;escapedUserName);</span>
<a href="#l30.122"></a><span id="l30.122">     command.Append(escapedUserName);</span>
<a href="#l30.123"></a><span id="l30.123">     command.Append(&quot;\&quot; \&quot;&quot;);</span>
<a href="#l30.124"></a><span id="l30.124"> </span>
<a href="#l30.125"></a><span id="l30.125">     // if the password contains a \, login will fail</span>
<a href="#l30.126"></a><span id="l30.126">     // turn foo\bar into foo\\bar</span>
<a href="#l30.127"></a><span id="l30.127">     nsAutoCString correctedPassword;</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-    EscapeUserNamePasswordString(password.get(), &amp;correctedPassword);</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+    // We're assuming old style login doesn't want UTF-8</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+    EscapeUserNamePasswordString(NS_LossyConvertUTF16toASCII(aPassword).get(),</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+                                 &amp;correctedPassword);</span>
<a href="#l30.132"></a><span id="l30.132">     command.Append(correctedPassword);</span>
<a href="#l30.133"></a><span id="l30.133">     command.Append(&quot;\&quot;&quot; CRLF);</span>
<a href="#l30.134"></a><span id="l30.134">     rv = SendData(command.get(), true /* suppress logging */);</span>
<a href="#l30.135"></a><span id="l30.135">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.136"></a><span id="l30.136">     ParseIMAPandCheckForNewMail();</span>
<a href="#l30.137"></a><span id="l30.137">   }</span>
<a href="#l30.138"></a><span id="l30.138">   else if (flag &amp; kHasXOAuth2Capability)</span>
<a href="#l30.139"></a><span id="l30.139">   {</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineat">@@ -6016,17 +6004,17 @@ nsresult nsImapProtocol::AuthLogin(const</span>
<a href="#l30.141"></a><span id="l30.141">   {</span>
<a href="#l30.142"></a><span id="l30.142">     MOZ_LOG(IMAP, LogLevel::Error, (&quot;flags param has no auth scheme selected&quot;));</span>
<a href="#l30.143"></a><span id="l30.143">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l30.144"></a><span id="l30.144">   }</span>
<a href="#l30.145"></a><span id="l30.145"> </span>
<a href="#l30.146"></a><span id="l30.146">   PR_Free(currentCommand);</span>
<a href="#l30.147"></a><span id="l30.147">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.148"></a><span id="l30.148">   return GetServerStateParser().LastCommandSuccessful() ?</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-        NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+           NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l30.151"></a><span id="l30.151"> }</span>
<a href="#l30.152"></a><span id="l30.152"> </span>
<a href="#l30.153"></a><span id="l30.153"> void nsImapProtocol::OnLSubFolders()</span>
<a href="#l30.154"></a><span id="l30.154"> {</span>
<a href="#l30.155"></a><span id="l30.155">   // **** use to find out whether Drafts, Sent, &amp; Templates folder</span>
<a href="#l30.156"></a><span id="l30.156">   // exists or not even the user didn't subscribe to it</span>
<a href="#l30.157"></a><span id="l30.157">   char *mailboxName = OnCreateServerSourceFolderPathString();</span>
<a href="#l30.158"></a><span id="l30.158">   if (mailboxName)</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineat">@@ -8455,44 +8443,36 @@ nsresult nsImapProtocol::GetMsgWindow(ns</span>
<a href="#l30.160"></a><span id="l30.160"> }</span>
<a href="#l30.161"></a><span id="l30.161"> </span>
<a href="#l30.162"></a><span id="l30.162"> /**</span>
<a href="#l30.163"></a><span id="l30.163">  * Get password from RAM, disk (password manager) or user (dialog)</span>
<a href="#l30.164"></a><span id="l30.164">  * @return NS_MSG_PASSWORD_PROMPT_CANCELLED</span>
<a href="#l30.165"></a><span id="l30.165">  *    (which is NS_SUCCEEDED!) when user cancelled</span>
<a href="#l30.166"></a><span id="l30.166">  *    NS_FAILED(rv) for other errors</span>
<a href="#l30.167"></a><span id="l30.167">  */</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-nsresult nsImapProtocol::GetPassword(nsCString &amp;password,</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineplus">+nsresult nsImapProtocol::GetPassword(nsString &amp;password,</span>
<a href="#l30.170"></a><span id="l30.170">                                      bool newPasswordRequested)</span>
<a href="#l30.171"></a><span id="l30.171"> {</span>
<a href="#l30.172"></a><span id="l30.172">   // we are in the imap thread so *NEVER* try to extract the password with UI</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-  // if logon redirection has changed the password, use the cookie as the password</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-  if (m_overRideUrlConnectionInfo)</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-  {</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineminus">-    password.Assign(m_logonCookie);</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-  }</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-</span>
<a href="#l30.180"></a><span id="l30.180">   NS_ENSURE_TRUE(m_imapServerSink, NS_ERROR_NULL_POINTER);</span>
<a href="#l30.181"></a><span id="l30.181">   NS_ENSURE_TRUE(m_server, NS_ERROR_NULL_POINTER);</span>
<a href="#l30.182"></a><span id="l30.182">   nsresult rv;</span>
<a href="#l30.183"></a><span id="l30.183"> </span>
<a href="#l30.184"></a><span id="l30.184">   // Get the password already stored in mem</span>
<a href="#l30.185"></a><span id="l30.185">   rv = m_imapServerSink-&gt;GetServerPassword(password);</span>
<a href="#l30.186"></a><span id="l30.186">   if (NS_FAILED(rv) || password.IsEmpty())</span>
<a href="#l30.187"></a><span id="l30.187">   {</span>
<a href="#l30.188"></a><span id="l30.188">     AutoProxyReleaseMsgWindow msgWindow;</span>
<a href="#l30.189"></a><span id="l30.189">     GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l30.190"></a><span id="l30.190">     NS_ENSURE_TRUE(msgWindow, NS_ERROR_NOT_AVAILABLE); // biff case</span>
<a href="#l30.191"></a><span id="l30.191"> </span>
<a href="#l30.192"></a><span id="l30.192">     // Get the password from pw manager (harddisk) or user (dialog)</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineminus">-    nsAutoCString pwd; // GetPasswordWithUI truncates the password on Cancel</span>
<a href="#l30.194"></a><span id="l30.194" class="difflineminus">-    rv = m_imapServerSink-&gt;AsyncGetPassword(this,</span>
<a href="#l30.195"></a><span id="l30.195" class="difflineminus">-                                                     newPasswordRequested,</span>
<a href="#l30.196"></a><span id="l30.196" class="difflineminus">-                                                     password);</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineplus">+    nsAutoString pwd; // GetPasswordWithUI truncates the password on Cancel</span>
<a href="#l30.198"></a><span id="l30.198" class="difflineplus">+    rv = m_imapServerSink-&gt;AsyncGetPassword(this, newPasswordRequested,</span>
<a href="#l30.199"></a><span id="l30.199" class="difflineplus">+                                            password);</span>
<a href="#l30.200"></a><span id="l30.200">     if (password.IsEmpty())</span>
<a href="#l30.201"></a><span id="l30.201">     {</span>
<a href="#l30.202"></a><span id="l30.202">       PRIntervalTime sleepTime = kImapSleepTime;</span>
<a href="#l30.203"></a><span id="l30.203">       m_passwordStatus = NS_OK;</span>
<a href="#l30.204"></a><span id="l30.204">       ReentrantMonitorAutoEnter mon(m_passwordReadyMonitor);</span>
<a href="#l30.205"></a><span id="l30.205">       while (m_password.IsEmpty() &amp;&amp; !NS_FAILED(m_passwordStatus) &amp;&amp;</span>
<a href="#l30.206"></a><span id="l30.206">              m_passwordStatus != NS_MSG_PASSWORD_PROMPT_CANCELLED &amp;&amp;</span>
<a href="#l30.207"></a><span id="l30.207">              !DeathSignalReceived())</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineat">@@ -8512,17 +8492,17 @@ nsImapProtocol::OnPromptStart(bool *aRes</span>
<a href="#l30.209"></a><span id="l30.209"> {</span>
<a href="#l30.210"></a><span id="l30.210">   nsresult rv;</span>
<a href="#l30.211"></a><span id="l30.211">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryReferent(m_server, &amp;rv);</span>
<a href="#l30.212"></a><span id="l30.212">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l30.213"></a><span id="l30.213">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l30.214"></a><span id="l30.214"> </span>
<a href="#l30.215"></a><span id="l30.215">   *aResult = false;</span>
<a href="#l30.216"></a><span id="l30.216">   GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineminus">-  nsCString password = m_lastPasswordSent;</span>
<a href="#l30.218"></a><span id="l30.218" class="difflineplus">+  nsString password = m_lastPasswordSent;</span>
<a href="#l30.219"></a><span id="l30.219">   rv = imapServer-&gt;PromptPassword(msgWindow, password);</span>
<a href="#l30.220"></a><span id="l30.220">   m_password = password;</span>
<a href="#l30.221"></a><span id="l30.221">   m_passwordStatus = rv;</span>
<a href="#l30.222"></a><span id="l30.222">   if (!m_password.IsEmpty())</span>
<a href="#l30.223"></a><span id="l30.223">     *aResult = true;</span>
<a href="#l30.224"></a><span id="l30.224"> </span>
<a href="#l30.225"></a><span id="l30.225">   // Notify the imap thread that we have a password.</span>
<a href="#l30.226"></a><span id="l30.226">   ReentrantMonitorAutoEnter passwordMon(m_passwordReadyMonitor);</span>
<a href="#l30.227"></a><span id="l30.227" class="difflineat">@@ -8554,17 +8534,17 @@ nsImapProtocol::OnPromptCanceled()</span>
<a href="#l30.228"></a><span id="l30.228"> }</span>
<a href="#l30.229"></a><span id="l30.229"> </span>
<a href="#l30.230"></a><span id="l30.230"> bool nsImapProtocol::TryToLogon()</span>
<a href="#l30.231"></a><span id="l30.231"> {</span>
<a href="#l30.232"></a><span id="l30.232">   MOZ_LOG(IMAP, LogLevel::Debug, (&quot;try to log in&quot;));</span>
<a href="#l30.233"></a><span id="l30.233">   NS_ENSURE_TRUE(m_imapServerSink, false);</span>
<a href="#l30.234"></a><span id="l30.234">   bool loginSucceeded = false;</span>
<a href="#l30.235"></a><span id="l30.235">   bool skipLoop = false;</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">-  nsAutoCString password;</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+  nsAutoString password;</span>
<a href="#l30.238"></a><span id="l30.238">   nsAutoCString userName;</span>
<a href="#l30.239"></a><span id="l30.239"> </span>
<a href="#l30.240"></a><span id="l30.240">   nsresult rv = ChooseAuthMethod();</span>
<a href="#l30.241"></a><span id="l30.241">   if (NS_FAILED(rv)) // all methods failed</span>
<a href="#l30.242"></a><span id="l30.242">   {</span>
<a href="#l30.243"></a><span id="l30.243">     // are there any matching login schemes at all?</span>
<a href="#l30.244"></a><span id="l30.244">     if (!(GetServerStateParser().GetCapabilityFlag() &amp; m_prefAuthMethods))</span>
<a href="#l30.245"></a><span id="l30.245">     {</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineat">@@ -8708,17 +8688,17 @@ bool nsImapProtocol::TryToLogon()</span>
<a href="#l30.247"></a><span id="l30.247">                                                     &amp;buttonPressed);</span>
<a href="#l30.248"></a><span id="l30.248">           if (NS_FAILED(rv))</span>
<a href="#l30.249"></a><span id="l30.249">             break;</span>
<a href="#l30.250"></a><span id="l30.250">           if (buttonPressed == 2) // 'New password' button</span>
<a href="#l30.251"></a><span id="l30.251">           {</span>
<a href="#l30.252"></a><span id="l30.252">             MOZ_LOG(IMAP, LogLevel::Warning, (&quot;new password button pressed.&quot;));</span>
<a href="#l30.253"></a><span id="l30.253">             // Forget the current password</span>
<a href="#l30.254"></a><span id="l30.254">             password.Truncate();</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-            m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), nullptr);</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+            m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), EmptyString());</span>
<a href="#l30.257"></a><span id="l30.257">             m_imapServerSink-&gt;ForgetPassword();</span>
<a href="#l30.258"></a><span id="l30.258">             m_password.Truncate();</span>
<a href="#l30.259"></a><span id="l30.259">             MOZ_LOG(IMAP, LogLevel::Warning, (&quot;password resetted (nulled)&quot;));</span>
<a href="#l30.260"></a><span id="l30.260">             newPasswordRequested = true;</span>
<a href="#l30.261"></a><span id="l30.261">             // Will call GetPassword() in beginning of next loop</span>
<a href="#l30.262"></a><span id="l30.262"> </span>
<a href="#l30.263"></a><span id="l30.263">             // Try all possible auth methods again with the new password.</span>
<a href="#l30.264"></a><span id="l30.264">             ResetAuthMethods();</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineat">@@ -8741,17 +8721,17 @@ bool nsImapProtocol::TryToLogon()</span>
<a href="#l30.266"></a><span id="l30.266">         } // all methods failed</span>
<a href="#l30.267"></a><span id="l30.267">       } // login failed</span>
<a href="#l30.268"></a><span id="l30.268">   } // while</span>
<a href="#l30.269"></a><span id="l30.269"> </span>
<a href="#l30.270"></a><span id="l30.270">   if (loginSucceeded)</span>
<a href="#l30.271"></a><span id="l30.271">   {</span>
<a href="#l30.272"></a><span id="l30.272">     MOZ_LOG(IMAP, LogLevel::Debug, (&quot;login succeeded&quot;));</span>
<a href="#l30.273"></a><span id="l30.273">     bool passwordAlreadyVerified;</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineminus">-    m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), password.get());</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+    m_hostSessionList-&gt;SetPasswordForHost(GetImapServerKey(), password);</span>
<a href="#l30.276"></a><span id="l30.276">     rv = m_hostSessionList-&gt;GetPasswordVerifiedOnline(GetImapServerKey(), passwordAlreadyVerified);</span>
<a href="#l30.277"></a><span id="l30.277">     if (NS_SUCCEEDED(rv) &amp;&amp; !passwordAlreadyVerified)</span>
<a href="#l30.278"></a><span id="l30.278">       m_hostSessionList-&gt;SetPasswordVerifiedOnline(GetImapServerKey());</span>
<a href="#l30.279"></a><span id="l30.279">     bool imapPasswordIsNew = !passwordAlreadyVerified;</span>
<a href="#l30.280"></a><span id="l30.280">     if (imapPasswordIsNew)</span>
<a href="#l30.281"></a><span id="l30.281">     {</span>
<a href="#l30.282"></a><span id="l30.282">       if (m_currentBiffState == nsIMsgFolder::nsMsgBiffState_Unknown)</span>
<a href="#l30.283"></a><span id="l30.283">       {</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineat">@@ -8827,25 +8807,16 @@ bool</span>
<a href="#l30.285"></a><span id="l30.285"> nsImapProtocol::GetShowDeletedMessages()</span>
<a href="#l30.286"></a><span id="l30.286"> {</span>
<a href="#l30.287"></a><span id="l30.287">     bool rv = false;</span>
<a href="#l30.288"></a><span id="l30.288">     if (m_hostSessionList)</span>
<a href="#l30.289"></a><span id="l30.289">         m_hostSessionList-&gt;GetShowDeletedMessagesForHost(GetImapServerKey(), rv);</span>
<a href="#l30.290"></a><span id="l30.290">     return rv;</span>
<a href="#l30.291"></a><span id="l30.291"> }</span>
<a href="#l30.292"></a><span id="l30.292"> </span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-NS_IMETHODIMP nsImapProtocol::OverrideConnectionInfo(const char16_t *pHost, uint16_t pPort, const char *pCookieData)</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-{</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-  m_logonHost = NS_LossyConvertUTF16toASCII(pHost);</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-  m_logonPort = pPort;</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineminus">-  m_logonCookie = pCookieData;</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineminus">-  m_overRideUrlConnectionInfo = true;</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineminus">-  return NS_OK;</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineminus">-}</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineminus">-</span>
<a href="#l30.302"></a><span id="l30.302"> bool nsImapProtocol::CheckNeeded()</span>
<a href="#l30.303"></a><span id="l30.303"> {</span>
<a href="#l30.304"></a><span id="l30.304">   if (m_flagChangeCount &gt;= kFlagChangesBeforeCheck)</span>
<a href="#l30.305"></a><span id="l30.305">     return true;</span>
<a href="#l30.306"></a><span id="l30.306"> </span>
<a href="#l30.307"></a><span id="l30.307">   int32_t deltaInSeconds;</span>
<a href="#l30.308"></a><span id="l30.308"> </span>
<a href="#l30.309"></a><span id="l30.309">   PRTime2Seconds(PR_Now() - m_lastCheckTime, &amp;deltaInSeconds);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -364,17 +364,17 @@ private:</span>
<a href="#l31.4"></a><span id="l31.4">   mozilla::ReentrantMonitor m_threadDeathMonitor;</span>
<a href="#l31.5"></a><span id="l31.5">   mozilla::ReentrantMonitor m_waitForBodyIdsMonitor;</span>
<a href="#l31.6"></a><span id="l31.6">   mozilla::ReentrantMonitor m_fetchBodyListMonitor;</span>
<a href="#l31.7"></a><span id="l31.7">   mozilla::ReentrantMonitor m_passwordReadyMonitor;</span>
<a href="#l31.8"></a><span id="l31.8">   mozilla::Mutex mLock;</span>
<a href="#l31.9"></a><span id="l31.9">   // If we get an async password prompt, this is where the UI thread</span>
<a href="#l31.10"></a><span id="l31.10">   // stores the password, before notifying the imap thread of the password</span>
<a href="#l31.11"></a><span id="l31.11">   // via the m_passwordReadyMonitor.</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  nsCString m_password;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  nsString m_password;</span>
<a href="#l31.14"></a><span id="l31.14">   // Set to the result of nsImapServer::PromptPassword</span>
<a href="#l31.15"></a><span id="l31.15">   nsresult    m_passwordStatus;</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17">   bool         m_imapThreadIsRunning;</span>
<a href="#l31.18"></a><span id="l31.18">   void ImapThreadMainLoop(void);</span>
<a href="#l31.19"></a><span id="l31.19">   nsresult    m_connectionStatus;</span>
<a href="#l31.20"></a><span id="l31.20">   nsCString   m_connectionType;</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -473,33 +473,33 @@ private:</span>
<a href="#l31.23"></a><span id="l31.23">   char m_currentServerCommandTag[11];</span>
<a href="#l31.24"></a><span id="l31.24">   uint32_t m_currentServerCommandTagNumber;</span>
<a href="#l31.25"></a><span id="l31.25">   void IncrementCommandTagNumber();</span>
<a href="#l31.26"></a><span id="l31.26">   const char *GetServerCommandTag();</span>
<a href="#l31.27"></a><span id="l31.27"> </span>
<a href="#l31.28"></a><span id="l31.28">   void StartTLS();</span>
<a href="#l31.29"></a><span id="l31.29"> </span>
<a href="#l31.30"></a><span id="l31.30">   // login related methods.</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-  nsresult GetPassword(nsCString &amp;password, bool aNewPasswordRequested);</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+  nsresult GetPassword(nsString &amp;password, bool aNewPasswordRequested);</span>
<a href="#l31.33"></a><span id="l31.33">   void InitPrefAuthMethods(int32_t authMethodPrefValue,</span>
<a href="#l31.34"></a><span id="l31.34">                            nsIMsgIncomingServer *aServer);</span>
<a href="#l31.35"></a><span id="l31.35">   nsresult ChooseAuthMethod();</span>
<a href="#l31.36"></a><span id="l31.36">   void MarkAuthMethodAsFailed(eIMAPCapabilityFlags failedAuthMethod);</span>
<a href="#l31.37"></a><span id="l31.37">   void ResetAuthMethods();</span>
<a href="#l31.38"></a><span id="l31.38"> </span>
<a href="#l31.39"></a><span id="l31.39">   // All of these methods actually issue protocol</span>
<a href="#l31.40"></a><span id="l31.40">   void Capability(); // query host for capabilities.</span>
<a href="#l31.41"></a><span id="l31.41">   void ID(); // send RFC 2971 app info to server</span>
<a href="#l31.42"></a><span id="l31.42">   void EnableCondStore(); </span>
<a href="#l31.43"></a><span id="l31.43">   void StartCompressDeflate();</span>
<a href="#l31.44"></a><span id="l31.44">   nsresult BeginCompressing();</span>
<a href="#l31.45"></a><span id="l31.45">   void Language(); // set the language on the server if it supports it</span>
<a href="#l31.46"></a><span id="l31.46">   void Namespace();</span>
<a href="#l31.47"></a><span id="l31.47">   void InsecureLogin(const char *userName, const nsCString &amp;password);</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineminus">-  nsresult AuthLogin(const char *userName, const nsCString &amp;password, eIMAPCapabilityFlag flag);</span>
<a href="#l31.49"></a><span id="l31.49" class="difflineplus">+  nsresult AuthLogin(const char *userName, const nsString &amp;password, eIMAPCapabilityFlag flag);</span>
<a href="#l31.50"></a><span id="l31.50">   void ProcessAuthenticatedStateURL();</span>
<a href="#l31.51"></a><span id="l31.51">   void ProcessAfterAuthenticated();</span>
<a href="#l31.52"></a><span id="l31.52">   void ProcessSelectedStateURL();</span>
<a href="#l31.53"></a><span id="l31.53">   bool TryToLogon();</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55">   // Process Authenticated State Url used to be one giant if statement. I've broken out a set of actions</span>
<a href="#l31.56"></a><span id="l31.56">   // based on the imap action passed into the url. The following functions are imap protocol handlers for</span>
<a href="#l31.57"></a><span id="l31.57">   // each action. They are called by ProcessAuthenticatedStateUrl.</span>
<a href="#l31.58"></a><span id="l31.58" class="difflineat">@@ -628,23 +628,16 @@ private:</span>
<a href="#l31.59"></a><span id="l31.59">   // mapping between special xlist mailboxes and the corresponding folder flags</span>
<a href="#l31.60"></a><span id="l31.60">   nsDataHashtable&lt;nsCStringHashKey, int32_t&gt; m_specialXListMailboxes;</span>
<a href="#l31.61"></a><span id="l31.61"> </span>
<a href="#l31.62"></a><span id="l31.62"> </span>
<a href="#l31.63"></a><span id="l31.63">   nsIImapHostSessionList * m_hostSessionList;</span>
<a href="#l31.64"></a><span id="l31.64"> </span>
<a href="#l31.65"></a><span id="l31.65">   bool m_fromHeaderSeen;</span>
<a href="#l31.66"></a><span id="l31.66"> </span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-  // these settings allow clients to override various pieces of the connection info from the url</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-  bool m_overRideUrlConnectionInfo;</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineminus">-  nsCString m_logonHost;</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-  nsCString m_logonCookie;</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineminus">-  int16_t m_logonPort;</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-  </span>
<a href="#l31.74"></a><span id="l31.74">   nsString mAcceptLanguages;</span>
<a href="#l31.75"></a><span id="l31.75">   </span>
<a href="#l31.76"></a><span id="l31.76">   // progress stuff</span>
<a href="#l31.77"></a><span id="l31.77">   void SetProgressString(uint32_t aStringIndex);</span>
<a href="#l31.78"></a><span id="l31.78">   </span>
<a href="#l31.79"></a><span id="l31.79">   nsCString     m_progressStringName;</span>
<a href="#l31.80"></a><span id="l31.80">   uint32_t      m_stringIndex;</span>
<a href="#l31.81"></a><span id="l31.81">   int32_t       m_progressCurrentNumber[IMAP_NUMBER_OF_PROGRESS_STRINGS];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -435,28 +435,28 @@ NS_SYNCRUNNABLEMETHOD1(ImapServerSink, S</span>
<a href="#l32.4"></a><span id="l32.4"> NS_SYNCRUNNABLEMETHOD2(ImapServerSink, RetryUrl, nsIImapUrl *, nsIImapMockChannel *)</span>
<a href="#l32.5"></a><span id="l32.5"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, AbortQueuedUrls)</span>
<a href="#l32.6"></a><span id="l32.6"> NS_SYNCRUNNABLEMETHOD2(ImapServerSink, GetImapStringByName, const char*, nsAString &amp;)</span>
<a href="#l32.7"></a><span id="l32.7"> NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PromptLoginFailed, nsIMsgWindow *, int32_t *)</span>
<a href="#l32.8"></a><span id="l32.8"> NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlert, const nsAString &amp;, nsIMsgMailNewsUrl *)</span>
<a href="#l32.9"></a><span id="l32.9"> NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertWithName, const char*, nsIMsgMailNewsUrl *)</span>
<a href="#l32.10"></a><span id="l32.10"> NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertFromServer, const nsACString &amp;, nsIMsgMailNewsUrl *)</span>
<a href="#l32.11"></a><span id="l32.11"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, CommitNamespaces)</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AsyncGetPassword, nsIImapProtocol *, bool, nsACString &amp;)</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AsyncGetPassword, nsIImapProtocol *, bool, nsAString &amp;)</span>
<a href="#l32.14"></a><span id="l32.14"> NS_SYNCRUNNABLEATTRIBUTE(ImapServerSink, UserAuthenticated, bool)</span>
<a href="#l32.15"></a><span id="l32.15"> NS_SYNCRUNNABLEMETHOD3(ImapServerSink, SetMailServerUrls, const nsACString &amp;, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l32.16"></a><span id="l32.16"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetArbitraryHeaders, nsACString &amp;)</span>
<a href="#l32.17"></a><span id="l32.17"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, ForgetPassword)</span>
<a href="#l32.18"></a><span id="l32.18"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetShowAttachmentsInline, bool *)</span>
<a href="#l32.19"></a><span id="l32.19"> NS_SYNCRUNNABLEMETHOD3(ImapServerSink, CramMD5Hash, const char *, const char *, char **)</span>
<a href="#l32.20"></a><span id="l32.20"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetLoginUsername, nsACString &amp;)</span>
<a href="#l32.21"></a><span id="l32.21"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, UpdateTrySTARTTLSPref, bool)</span>
<a href="#l32.22"></a><span id="l32.22"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetOriginalUsername, nsACString &amp;)</span>
<a href="#l32.23"></a><span id="l32.23"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerKey, nsACString &amp;)</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerPassword, nsACString &amp;)</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerPassword, nsAString &amp;)</span>
<a href="#l32.26"></a><span id="l32.26"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, RemoveServerConnection, nsIImapProtocol *)</span>
<a href="#l32.27"></a><span id="l32.27"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerShuttingDown, bool *)</span>
<a href="#l32.28"></a><span id="l32.28"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, ResetServerConnection, const nsACString &amp;)</span>
<a href="#l32.29"></a><span id="l32.29"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetServerDoingLsub, bool)</span>
<a href="#l32.30"></a><span id="l32.30"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetServerForceSelect, const nsACString &amp;)</span>
<a href="#l32.31"></a><span id="l32.31"> </span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33"> namespace mozilla {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -770,17 +770,17 @@ NS_IMETHODIMP nsPop3Protocol::OnPromptSt</span>
<a href="#l33.4"></a><span id="l33.4">   MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;OnPromptStart()&quot;)));</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6">   *aResult = false;</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">   nsresult rv;</span>
<a href="#l33.9"></a><span id="l33.9">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server, &amp;rv);</span>
<a href="#l33.10"></a><span id="l33.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  nsAutoCString passwordResult;</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  nsAutoString passwordResult;</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15">   // pass the failed password into the password prompt so that</span>
<a href="#l33.16"></a><span id="l33.16">   // it will be pre-filled, in case it failed because of a</span>
<a href="#l33.17"></a><span id="l33.17">   // server problem and not because it was wrong.</span>
<a href="#l33.18"></a><span id="l33.18">   if (!m_lastPasswordSent.IsEmpty())</span>
<a href="#l33.19"></a><span id="l33.19">     passwordResult = m_lastPasswordSent;</span>
<a href="#l33.20"></a><span id="l33.20"> </span>
<a href="#l33.21"></a><span id="l33.21">   // Set up some items that we're going to need for the prompting.</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -2139,17 +2139,17 @@ int32_t nsPop3Protocol::SendUsername()</span>
<a href="#l33.23"></a><span id="l33.23">       m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l33.24"></a><span id="l33.24">       return Error(&quot;pop3PasswordUndefined&quot;);</span>
<a href="#l33.25"></a><span id="l33.25">     }</span>
<a href="#l33.26"></a><span id="l33.26">     // &lt;/copied&gt;</span>
<a href="#l33.27"></a><span id="l33.27"> </span>
<a href="#l33.28"></a><span id="l33.28">     nsAutoCString cmd;</span>
<a href="#l33.29"></a><span id="l33.29"> </span>
<a href="#l33.30"></a><span id="l33.30">     if (m_currentAuthMethod == POP3_HAS_AUTH_NTLM)</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-        (void) DoNtlmStep1(m_username.get(), m_passwordResult.get(), cmd);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+        (void) DoNtlmStep1(m_username, m_passwordResult, cmd);</span>
<a href="#l33.33"></a><span id="l33.33">     else if (m_currentAuthMethod == POP3_HAS_AUTH_CRAM_MD5)</span>
<a href="#l33.34"></a><span id="l33.34">         cmd = &quot;AUTH CRAM-MD5&quot;;</span>
<a href="#l33.35"></a><span id="l33.35">     else if (m_currentAuthMethod == POP3_HAS_AUTH_PLAIN)</span>
<a href="#l33.36"></a><span id="l33.36">         cmd = &quot;AUTH PLAIN&quot;;</span>
<a href="#l33.37"></a><span id="l33.37">     else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l33.38"></a><span id="l33.38">     {</span>
<a href="#l33.39"></a><span id="l33.39">         char *base64Str = PL_Base64Encode(m_username.get(), m_username.Length(), nullptr);</span>
<a href="#l33.40"></a><span id="l33.40">         cmd = base64Str;</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineat">@@ -2207,17 +2207,18 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l33.42"></a><span id="l33.42">     char buffer[512]; // TODO nsAutoCString</span>
<a href="#l33.43"></a><span id="l33.43">     unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l33.44"></a><span id="l33.44"> </span>
<a href="#l33.45"></a><span id="l33.45">     char *decodedChallenge = PL_Base64Decode(m_commandResponse.get(),</span>
<a href="#l33.46"></a><span id="l33.46">     m_commandResponse.Length(), nullptr);</span>
<a href="#l33.47"></a><span id="l33.47"> </span>
<a href="#l33.48"></a><span id="l33.48">     if (decodedChallenge)</span>
<a href="#l33.49"></a><span id="l33.49">       rv = MSGCramMD5(decodedChallenge, strlen(decodedChallenge),</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineminus">-                      m_passwordResult.get(), m_passwordResult.Length(), digest);</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+                      NS_ConvertUTF16toUTF8(m_passwordResult).get(),</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+                      m_passwordResult.Length(), digest);</span>
<a href="#l33.53"></a><span id="l33.53">     else</span>
<a href="#l33.54"></a><span id="l33.54">       rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l33.55"></a><span id="l33.55"> </span>
<a href="#l33.56"></a><span id="l33.56">     if (NS_SUCCEEDED(rv))</span>
<a href="#l33.57"></a><span id="l33.57">     {</span>
<a href="#l33.58"></a><span id="l33.58">       nsAutoCString encodedDigest;</span>
<a href="#l33.59"></a><span id="l33.59">       char hexVal[8];</span>
<a href="#l33.60"></a><span id="l33.60"> </span>
<a href="#l33.61"></a><span id="l33.61" class="difflineat">@@ -2239,17 +2240,18 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l33.62"></a><span id="l33.62">   }</span>
<a href="#l33.63"></a><span id="l33.63">   else if (m_currentAuthMethod == POP3_HAS_AUTH_APOP)</span>
<a href="#l33.64"></a><span id="l33.64">   {</span>
<a href="#l33.65"></a><span id="l33.65">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;APOP login&quot;)));</span>
<a href="#l33.66"></a><span id="l33.66">     char buffer[512];</span>
<a href="#l33.67"></a><span id="l33.67">     unsigned char digest[DIGEST_LENGTH];</span>
<a href="#l33.68"></a><span id="l33.68"> </span>
<a href="#l33.69"></a><span id="l33.69">     rv = MSGApopMD5(m_ApopTimestamp.get(), m_ApopTimestamp.Length(),</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-                    m_passwordResult.get(), m_passwordResult.Length(), digest);</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+                    NS_ConvertUTF16toUTF8(m_passwordResult).get(),  // Or ASCII?</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+                    m_passwordResult.Length(), digest);</span>
<a href="#l33.73"></a><span id="l33.73"> </span>
<a href="#l33.74"></a><span id="l33.74">     if (NS_SUCCEEDED(rv))</span>
<a href="#l33.75"></a><span id="l33.75">     {</span>
<a href="#l33.76"></a><span id="l33.76">       nsAutoCString encodedDigest;</span>
<a href="#l33.77"></a><span id="l33.77">       char hexVal[8];</span>
<a href="#l33.78"></a><span id="l33.78"> </span>
<a href="#l33.79"></a><span id="l33.79">       for (uint32_t j=0; j&lt;16; j++)</span>
<a href="#l33.80"></a><span id="l33.80">       {</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineat">@@ -2285,37 +2287,38 @@ int32_t nsPop3Protocol::SendPassword()</span>
<a href="#l33.82"></a><span id="l33.82">     }</span>
<a href="#l33.83"></a><span id="l33.83"> </span>
<a href="#l33.84"></a><span id="l33.84">     char plain_string[512]; // TODO nsCString</span>
<a href="#l33.85"></a><span id="l33.85">     int len = 1; /* first &lt;NUL&gt; char */</span>
<a href="#l33.86"></a><span id="l33.86">     memset(plain_string, 0, 512);</span>
<a href="#l33.87"></a><span id="l33.87">     PR_snprintf(&amp;plain_string[1], 510, &quot;%s&quot;, m_username.get());</span>
<a href="#l33.88"></a><span id="l33.88">     len += m_username.Length();</span>
<a href="#l33.89"></a><span id="l33.89">     len++; /* second &lt;NUL&gt; char */</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineminus">-    PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, m_passwordResult.get());</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineminus">-    len += m_passwordResult.Length();</span>
<a href="#l33.92"></a><span id="l33.92" class="difflineplus">+    NS_ConvertUTF16toUTF8 uniPassword(m_passwordResult);</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+    PR_snprintf(&amp;plain_string[len], 511-len, &quot;%s&quot;, uniPassword.get());</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+    len += uniPassword.Length();</span>
<a href="#l33.95"></a><span id="l33.95"> </span>
<a href="#l33.96"></a><span id="l33.96">     char *base64Str = PL_Base64Encode(plain_string, len, nullptr);</span>
<a href="#l33.97"></a><span id="l33.97">     cmd = base64Str;</span>
<a href="#l33.98"></a><span id="l33.98">     PR_Free(base64Str);</span>
<a href="#l33.99"></a><span id="l33.99">   }</span>
<a href="#l33.100"></a><span id="l33.100">   else if (m_currentAuthMethod == POP3_HAS_AUTH_LOGIN)</span>
<a href="#l33.101"></a><span id="l33.101">   {</span>
<a href="#l33.102"></a><span id="l33.102">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;LOGIN password&quot;)));</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineminus">-    char * base64Str =</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-        PL_Base64Encode(m_passwordResult.get(), m_passwordResult.Length(),</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-                        nullptr);</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+    NS_LossyConvertUTF16toASCII asciiPassword(m_passwordResult);</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+    char * base64Str = PL_Base64Encode(asciiPassword.get(),</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+                                       asciiPassword.Length(), nullptr);</span>
<a href="#l33.109"></a><span id="l33.109">     cmd = base64Str;</span>
<a href="#l33.110"></a><span id="l33.110">     PR_Free(base64Str);</span>
<a href="#l33.111"></a><span id="l33.111">   }</span>
<a href="#l33.112"></a><span id="l33.112">   else if (m_currentAuthMethod == POP3_HAS_AUTH_USER)</span>
<a href="#l33.113"></a><span id="l33.113">   {</span>
<a href="#l33.114"></a><span id="l33.114">     MOZ_LOG(POP3LOGMODULE, LogLevel::Debug, (POP3LOG(&quot;PASS password&quot;)));</span>
<a href="#l33.115"></a><span id="l33.115">     cmd = &quot;PASS &quot;;</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-    cmd += m_passwordResult;</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+    cmd += NS_LossyConvertUTF16toASCII(m_passwordResult);</span>
<a href="#l33.118"></a><span id="l33.118">   }</span>
<a href="#l33.119"></a><span id="l33.119">   else</span>
<a href="#l33.120"></a><span id="l33.120">   {</span>
<a href="#l33.121"></a><span id="l33.121">     MOZ_LOG(POP3LOGMODULE, LogLevel::Error,</span>
<a href="#l33.122"></a><span id="l33.122">             (POP3LOG(&quot;In nsPop3Protocol::SendPassword(), m_currentAuthMethod is %X, &quot;</span>
<a href="#l33.123"></a><span id="l33.123">                      &quot;but that is unexpected&quot;), m_currentAuthMethod));</span>
<a href="#l33.124"></a><span id="l33.124">     return Error(&quot;pop3AuthInternalError&quot;);</span>
<a href="#l33.125"></a><span id="l33.125">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.h</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -290,17 +290,17 @@ private:</span>
<a href="#l34.4"></a><span id="l34.4">   nsCOMPtr&lt;nsIStringBundle&gt; mLocalBundle;</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6">   nsCString m_username;</span>
<a href="#l34.7"></a><span id="l34.7">   nsCString m_senderInfo;</span>
<a href="#l34.8"></a><span id="l34.8">   nsCString m_commandResponse;</span>
<a href="#l34.9"></a><span id="l34.9">   nsCString m_GSSAPICache;</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11">   // Used for asynchronous password prompts to store the password temporarily.</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  nsCString m_passwordResult;</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  nsString m_passwordResult;</span>
<a href="#l34.14"></a><span id="l34.14"> </span>
<a href="#l34.15"></a><span id="l34.15">   // progress state information</span>
<a href="#l34.16"></a><span id="l34.16">   void UpdateProgressPercent(int64_t totalDone, int64_t total);</span>
<a href="#l34.17"></a><span id="l34.17">   void UpdateStatus(const char *aStatusName);</span>
<a href="#l34.18"></a><span id="l34.18">   void UpdateStatusWithString(const char16_t *aString);</span>
<a href="#l34.19"></a><span id="l34.19">   nsresult FormatCounterString(const nsString &amp;stringName,</span>
<a href="#l34.20"></a><span id="l34.20">                                uint32_t count1,</span>
<a href="#l34.21"></a><span id="l34.21">                                uint32_t count2,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -8,18 +8,21 @@</span>
<a href="#l35.4"></a><span id="l35.4">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l35.5"></a><span id="l35.5">  *     we get a new password prompt and can enter the password.</span>
<a href="#l35.6"></a><span id="l35.6">  */</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l35.9"></a><span id="l35.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.10"></a><span id="l35.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l35.13"></a><span id="l35.13"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l35.14"></a><span id="l35.14"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18"> var test = null;</span>
<a href="#l35.19"></a><span id="l35.19"> var server;</span>
<a href="#l35.20"></a><span id="l35.20"> var daemon;</span>
<a href="#l35.21"></a><span id="l35.21"> var incomingServer;</span>
<a href="#l35.22"></a><span id="l35.22"> var attempt = 0;</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24"> var kUserName = &quot;testpop3&quot;;</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineat">@@ -88,68 +91,91 @@ var urlListener =</span>
<a href="#l35.26"></a><span id="l35.26">       var transaction = server.playTransaction();</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28">       // On the last attempt, we should have successfully got one mail.</span>
<a href="#l35.29"></a><span id="l35.29">       do_check_eq(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l35.30"></a><span id="l35.30">                   attempt == 4 ? 1 : 0);</span>
<a href="#l35.31"></a><span id="l35.31"> </span>
<a href="#l35.32"></a><span id="l35.32">       // If we've just cancelled, expect binding aborted rather than success.</span>
<a href="#l35.33"></a><span id="l35.33">       do_check_eq(result, attempt == 2 ? Cr.NS_BINDING_ABORTED : 0);</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+      async_driver();</span>
<a href="#l35.35"></a><span id="l35.35">     }</span>
<a href="#l35.36"></a><span id="l35.36">     catch (e) {</span>
<a href="#l35.37"></a><span id="l35.37">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l35.38"></a><span id="l35.38">       server.stop();</span>
<a href="#l35.39"></a><span id="l35.39"> </span>
<a href="#l35.40"></a><span id="l35.40">       var thread = gThreadManager.currentThread;</span>
<a href="#l35.41"></a><span id="l35.41">       while (thread.hasPendingEvents())</span>
<a href="#l35.42"></a><span id="l35.42">         thread.processNextEvent(true);</span>
<a href="#l35.43"></a><span id="l35.43"> </span>
<a href="#l35.44"></a><span id="l35.44">       do_throw(e);</span>
<a href="#l35.45"></a><span id="l35.45">     }</span>
<a href="#l35.46"></a><span id="l35.46">   }</span>
<a href="#l35.47"></a><span id="l35.47"> };</span>
<a href="#l35.48"></a><span id="l35.48"> </span>
<a href="#l35.49"></a><span id="l35.49" class="difflineplus">+// Definition of tests</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineplus">+var tests = [</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+  getMail1,</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineplus">+  getMail2,</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineplus">+  end_test</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+]</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineplus">+</span>
<a href="#l35.56"></a><span id="l35.56"> function actually_run_test() {</span>
<a href="#l35.57"></a><span id="l35.57">   daemon.setMessages([&quot;message1.eml&quot;]);</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineplus">+  async_run_tests(tests);</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineplus">+}</span>
<a href="#l35.60"></a><span id="l35.60"> </span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+function* getMail1()</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineplus">+{</span>
<a href="#l35.63"></a><span id="l35.63">   dump(&quot;\nGet Mail 1\n&quot;);</span>
<a href="#l35.64"></a><span id="l35.64"> </span>
<a href="#l35.65"></a><span id="l35.65">   // Now get mail</span>
<a href="#l35.66"></a><span id="l35.66">   getPopMail();</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineplus">+  yield false;</span>
<a href="#l35.68"></a><span id="l35.68"> </span>
<a href="#l35.69"></a><span id="l35.69">   dump(&quot;\nGot Mail 1\n&quot;);</span>
<a href="#l35.70"></a><span id="l35.70"> </span>
<a href="#l35.71"></a><span id="l35.71">   do_check_eq(attempt, 2);</span>
<a href="#l35.72"></a><span id="l35.72"> </span>
<a href="#l35.73"></a><span id="l35.73" class="difflineminus">-  // Check that we haven't forgetton the login even though we've retried and</span>
<a href="#l35.74"></a><span id="l35.74" class="difflineplus">+  // Check that we haven't forgotten the login even though we've retried and</span>
<a href="#l35.75"></a><span id="l35.75">   // canceled.</span>
<a href="#l35.76"></a><span id="l35.76">   let count = {};</span>
<a href="#l35.77"></a><span id="l35.77">   let logins = Services.logins.findLogins(count, &quot;mailbox://localhost&quot;, null,</span>
<a href="#l35.78"></a><span id="l35.78">                                           &quot;mailbox://localhost&quot;);</span>
<a href="#l35.79"></a><span id="l35.79"> </span>
<a href="#l35.80"></a><span id="l35.80">   do_check_eq(count.value, 1);</span>
<a href="#l35.81"></a><span id="l35.81">   do_check_eq(logins[0].username, kUserName);</span>
<a href="#l35.82"></a><span id="l35.82">   do_check_eq(logins[0].password, kInvalidPassword);</span>
<a href="#l35.83"></a><span id="l35.83"> </span>
<a href="#l35.84"></a><span id="l35.84">   server.resetTest();</span>
<a href="#l35.85"></a><span id="l35.85" class="difflineplus">+  yield true;</span>
<a href="#l35.86"></a><span id="l35.86" class="difflineplus">+}</span>
<a href="#l35.87"></a><span id="l35.87"> </span>
<a href="#l35.88"></a><span id="l35.88" class="difflineplus">+function* getMail2()</span>
<a href="#l35.89"></a><span id="l35.89" class="difflineplus">+{</span>
<a href="#l35.90"></a><span id="l35.90">   dump(&quot;\nGet Mail 2\n&quot;);</span>
<a href="#l35.91"></a><span id="l35.91"> </span>
<a href="#l35.92"></a><span id="l35.92">   // Now get the mail</span>
<a href="#l35.93"></a><span id="l35.93">   getPopMail();</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineplus">+  yield false;</span>
<a href="#l35.96"></a><span id="l35.96">   dump(&quot;\nGot Mail 2\n&quot;);</span>
<a href="#l35.97"></a><span id="l35.97"> </span>
<a href="#l35.98"></a><span id="l35.98">   // Now check the new one has been saved.</span>
<a href="#l35.99"></a><span id="l35.99" class="difflineminus">-  logins = Services.logins.findLogins(count, &quot;mailbox://localhost&quot;, null,</span>
<a href="#l35.100"></a><span id="l35.100" class="difflineminus">-                                      &quot;mailbox://localhost&quot;);</span>
<a href="#l35.101"></a><span id="l35.101" class="difflineplus">+  let count = {};</span>
<a href="#l35.102"></a><span id="l35.102" class="difflineplus">+  let logins = Services.logins.findLogins(count, &quot;mailbox://localhost&quot;, null,</span>
<a href="#l35.103"></a><span id="l35.103" class="difflineplus">+                                          &quot;mailbox://localhost&quot;);</span>
<a href="#l35.104"></a><span id="l35.104"> </span>
<a href="#l35.105"></a><span id="l35.105">   do_check_eq(count.value, 1);</span>
<a href="#l35.106"></a><span id="l35.106">   do_check_eq(logins[0].username, kUserName);</span>
<a href="#l35.107"></a><span id="l35.107">   do_check_eq(logins[0].password, kValidPassword);</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineplus">+  yield true;</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineplus">+}</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineplus">+</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineplus">+function* end_test()</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+{</span>
<a href="#l35.113"></a><span id="l35.113">   do_test_finished();</span>
<a href="#l35.114"></a><span id="l35.114"> }</span>
<a href="#l35.115"></a><span id="l35.115"> </span>
<a href="#l35.116"></a><span id="l35.116"> add_task(function *() {</span>
<a href="#l35.117"></a><span id="l35.117">   // Disable new mail notifications</span>
<a href="#l35.118"></a><span id="l35.118">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l35.119"></a><span id="l35.119">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l35.120"></a><span id="l35.120">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiHook.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -280,19 +280,16 @@ nsresult nsMapiHook::BlindSendMail (unsi</span>
<a href="#l36.4"></a><span id="l36.4">   if (NS_FAILED(rv)|| (!appService) ) return rv ;</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6">   rv = appService-&gt;GetHiddenDOMWindow(getter_AddRefs(hiddenWindow));</span>
<a href="#l36.7"></a><span id="l36.7">   if ( NS_FAILED(rv) ) return rv ;</span>
<a href="#l36.8"></a><span id="l36.8">   // smtp password and Logged in used IdKey from MapiConfig (session obj)</span>
<a href="#l36.9"></a><span id="l36.9">   nsMAPIConfiguration * pMapiConfig = nsMAPIConfiguration::GetMAPIConfiguration() ;</span>
<a href="#l36.10"></a><span id="l36.10">   if (!pMapiConfig) return NS_ERROR_FAILURE ;  // get the singelton obj</span>
<a href="#l36.11"></a><span id="l36.11">   char16_t * password = pMapiConfig-&gt;GetPassword(aSession) ;</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  // password</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-  nsAutoCString smtpPassword;</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-  LossyCopyUTF16toASCII(password, smtpPassword);</span>
<a href="#l36.15"></a><span id="l36.15"> </span>
<a href="#l36.16"></a><span id="l36.16">   // Id key</span>
<a href="#l36.17"></a><span id="l36.17">   nsCString MsgIdKey;</span>
<a href="#l36.18"></a><span id="l36.18">   pMapiConfig-&gt;GetIdKey(aSession, MsgIdKey);</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20">   // get the MsgIdentity for the above key using AccountManager</span>
<a href="#l36.21"></a><span id="l36.21">   nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager = do_GetService (NS_MSGACCOUNTMANAGER_CONTRACTID) ;</span>
<a href="#l36.22"></a><span id="l36.22">   if (NS_FAILED(rv) || (!accountManager) ) return rv ;</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineat">@@ -313,17 +310,17 @@ nsresult nsMapiHook::BlindSendMail (unsi</span>
<a href="#l36.24"></a><span id="l36.24">   // populate the compose params</span>
<a href="#l36.25"></a><span id="l36.25">   bool forcePlainText;</span>
<a href="#l36.26"></a><span id="l36.26">   aCompFields-&gt;GetForcePlainText(&amp;forcePlainText);</span>
<a href="#l36.27"></a><span id="l36.27">   pMsgComposeParams-&gt;SetType(nsIMsgCompType::New);</span>
<a href="#l36.28"></a><span id="l36.28">   pMsgComposeParams-&gt;SetFormat(forcePlainText ? nsIMsgCompFormat::PlainText : nsIMsgCompFormat::HTML);</span>
<a href="#l36.29"></a><span id="l36.29">   pMsgComposeParams-&gt;SetIdentity(pMsgId);</span>
<a href="#l36.30"></a><span id="l36.30">   pMsgComposeParams-&gt;SetComposeFields(aCompFields);</span>
<a href="#l36.31"></a><span id="l36.31">   pMsgComposeParams-&gt;SetSendListener(sendListener) ;</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-  pMsgComposeParams-&gt;SetSmtpPassword(smtpPassword.get());</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+  pMsgComposeParams-&gt;SetSmtpPassword(nsDependentString(password));</span>
<a href="#l36.34"></a><span id="l36.34"> </span>
<a href="#l36.35"></a><span id="l36.35">   // create the nsIMsgCompose object to send the object</span>
<a href="#l36.36"></a><span id="l36.36">   nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l36.37"></a><span id="l36.37">   if (NS_FAILED(rv) || (!pMsgCompose) ) return rv ;</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39">   /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l36.40"></a><span id="l36.40"> </span>
<a href="#l36.41"></a><span id="l36.41">   rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, hiddenWindow, nullptr);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

