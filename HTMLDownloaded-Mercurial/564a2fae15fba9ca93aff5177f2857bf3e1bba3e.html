<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26195:564a2fae15fba9ca93aff5177f2857bf3e1bba3e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 564a2fae15fba9ca93aff5177f2857bf3e1bba3e" />
<meta property="og:url" content="/comm-central/rev/564a2fae15fba9ca93aff5177f2857bf3e1bba3e" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/base/test. r=jorgk DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 564a2fae15fba9ca93aff5177f2857bf3e1bba3e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/564a2fae15fba9ca93aff5177f2857bf3e1bba3e">shortlog</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/564a2fae15fba9ca93aff5177f2857bf3e1bba3e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e">files</a> |
changeset |
<a href="/comm-central/raw-rev/564a2fae15fba9ca93aff5177f2857bf3e1bba3e">raw</a>  | <a href="/comm-central/archive/564a2fae15fba9ca93aff5177f2857bf3e1bba3e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/base/test. r=jorgk DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 29 Mar 2019 18:25:29 +0100</td></tr>

<tr>
 <td>changeset 26195</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/564a2fae15fba9ca93aff5177f2857bf3e1bba3e">564a2fae15fba9ca93aff5177f2857bf3e1bba3e</a></td>
</tr>



<tr>
<td>parent 26194</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0cffb1aa9e14fcad79b9a7c9467dc5aa8e019dbf">0cffb1aa9e14fcad79b9a7c9467dc5aa8e019dbf</a>
</td>
</tr>

<tr>
<td>child 26196</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0db6d6cc4f92d52ab2b254995d98f2ee9552ee3d">0db6d6cc4f92d52ab2b254995d98f2ee9552ee3d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=564a2fae15fba9ca93aff5177f2857bf3e1bba3e">15719</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 29 Mar 2019 17:27:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@564a2fae15fb [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&newProject=comm-central&newRevision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&newProject=comm-central&newRevision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&newProject=comm-central&newRevision=564a2fae15fba9ca93aff5177f2857bf3e1bba3e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/base/test. r=jorgk DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/.eslintignore">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/.eslintignore">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/.eslintignore">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/.eslintignore">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/.eslintrc.js">mailnews/base/test/unit/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgr.js">mailnews/base/test/unit/test_accountMgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgr.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgr.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgr.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgr.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgrCustomTypes.js">mailnews/base/test/unit/test_accountMgrCustomTypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgrCustomTypes.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgrCustomTypes.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgrCustomTypes.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgrCustomTypes.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMgrCustomTypes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMigration.js">mailnews/base/test/unit/test_accountMigration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMigration.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMigration.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMigration.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMigration.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_accountMigration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_acctRepair.js">mailnews/base/test/unit/test_acctRepair.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_acctRepair.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_acctRepair.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_acctRepair.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_acctRepair.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_acctRepair.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_base64_decoding.js">mailnews/base/test/unit/test_base64_decoding.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_base64_decoding.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_base64_decoding.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_base64_decoding.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_base64_decoding.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_base64_decoding.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bccInDatabase.js">mailnews/base/test/unit/test_bccInDatabase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bccInDatabase.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bccInDatabase.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bccInDatabase.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bccInDatabase.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bccInDatabase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug366491.js">mailnews/base/test/unit/test_bug366491.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug366491.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug366491.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug366491.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug366491.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug366491.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug404489.js">mailnews/base/test/unit/test_bug404489.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug404489.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug404489.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug404489.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug404489.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug404489.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug428427.js">mailnews/base/test/unit/test_bug428427.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug428427.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug428427.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug428427.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug428427.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug428427.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug434810.js">mailnews/base/test/unit/test_bug434810.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug434810.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug434810.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug434810.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug434810.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug434810.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug471682.js">mailnews/base/test/unit/test_bug471682.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug471682.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug471682.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug471682.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug471682.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug471682.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug514945.js">mailnews/base/test/unit/test_bug514945.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug514945.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug514945.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug514945.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug514945.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_bug514945.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactColumnSave.js">mailnews/base/test/unit/test_compactColumnSave.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactColumnSave.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactColumnSave.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactColumnSave.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactColumnSave.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactColumnSave.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactFailure.js">mailnews/base/test/unit/test_compactFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactFailure.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactFailure.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactFailure.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactFailure.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_compactFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_converterDeferredAccount.js">mailnews/base/test/unit/test_converterDeferredAccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_converterDeferredAccount.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_converterDeferredAccount.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_converterDeferredAccount.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_converterDeferredAccount.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_converterDeferredAccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyChaining.js">mailnews/base/test/unit/test_copyChaining.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyChaining.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyChaining.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyChaining.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyChaining.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyChaining.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyThenMoveManual.js">mailnews/base/test/unit/test_copyThenMoveManual.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyThenMoveManual.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyThenMoveManual.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyThenMoveManual.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyThenMoveManual.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyThenMoveManual.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyToInvalidDB.js">mailnews/base/test/unit/test_copyToInvalidDB.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyToInvalidDB.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyToInvalidDB.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyToInvalidDB.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyToInvalidDB.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_copyToInvalidDB.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_detachToFile.js">mailnews/base/test/unit/test_detachToFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_detachToFile.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_detachToFile.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_detachToFile.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_detachToFile.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_detachToFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_emptyTrash.js">mailnews/base/test/unit/test_emptyTrash.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_emptyTrash.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_emptyTrash.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_emptyTrash.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_emptyTrash.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_emptyTrash.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_fix_deferred_accounts.js">mailnews/base/test/unit/test_fix_deferred_accounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_fix_deferred_accounts.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_fix_deferred_accounts.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_fix_deferred_accounts.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_fix_deferred_accounts.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_fix_deferred_accounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderCompact.js">mailnews/base/test/unit/test_folderCompact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderCompact.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderCompact.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderCompact.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderCompact.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderCompact.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderLookupService.js">mailnews/base/test/unit/test_folderLookupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderLookupService.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderLookupService.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderLookupService.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderLookupService.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_folderLookupService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_formatFileSize.js">mailnews/base/test/unit/test_formatFileSize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_formatFileSize.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_formatFileSize.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_formatFileSize.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_formatFileSize.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_formatFileSize.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_getMsgTextFromStream.js">mailnews/base/test/unit/test_getMsgTextFromStream.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_getMsgTextFromStream.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_getMsgTextFromStream.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_getMsgTextFromStream.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_getMsgTextFromStream.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_getMsgTextFromStream.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_headerFoldingInDatabase.js">mailnews/base/test/unit/test_headerFoldingInDatabase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_headerFoldingInDatabase.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_headerFoldingInDatabase.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_headerFoldingInDatabase.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_headerFoldingInDatabase.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_headerFoldingInDatabase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_hostnameUtils.js">mailnews/base/test/unit/test_hostnameUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_hostnameUtils.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_hostnameUtils.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_hostnameUtils.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_hostnameUtils.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_hostnameUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_imapPump.js">mailnews/base/test/unit/test_imapPump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_imapPump.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_imapPump.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_imapPump.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_imapPump.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_imapPump.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_inheritedFolderProperties.js">mailnews/base/test/unit/test_inheritedFolderProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_inheritedFolderProperties.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_inheritedFolderProperties.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_inheritedFolderProperties.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_inheritedFolderProperties.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_inheritedFolderProperties.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_iteratorUtils.js">mailnews/base/test/unit/test_iteratorUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_iteratorUtils.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_iteratorUtils.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_iteratorUtils.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_iteratorUtils.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_iteratorUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_jsTreeSelection.js">mailnews/base/test/unit/test_jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkWhitelisting.js">mailnews/base/test/unit/test_junkWhitelisting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkWhitelisting.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkWhitelisting.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkWhitelisting.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkWhitelisting.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkWhitelisting.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkingWhenDisabled.js">mailnews/base/test/unit/test_junkingWhenDisabled.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkingWhenDisabled.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkingWhenDisabled.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkingWhenDisabled.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkingWhenDisabled.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_junkingWhenDisabled.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_loadVirtualFolders.js">mailnews/base/test/unit/test_loadVirtualFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_loadVirtualFolders.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_loadVirtualFolders.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_loadVirtualFolders.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_loadVirtualFolders.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_loadVirtualFolders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mailstoreConverter.js">mailnews/base/test/unit/test_mailstoreConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mailstoreConverter.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mailstoreConverter.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mailstoreConverter.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mailstoreConverter.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mailstoreConverter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mimemaltdetach.js">mailnews/base/test/unit/test_mimemaltdetach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mimemaltdetach.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mimemaltdetach.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mimemaltdetach.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mimemaltdetach.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_mimemaltdetach.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_newMailNotification.js">mailnews/base/test/unit/test_newMailNotification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_newMailNotification.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_newMailNotification.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_newMailNotification.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_newMailNotification.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_newMailNotification.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIFolderListener.js">mailnews/base/test/unit/test_nsIFolderListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIFolderListener.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIFolderListener.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIFolderListener.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIFolderListener.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIFolderListener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">mailnews/base/test/unit/test_nsIMsgContentPolicy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolder.js">mailnews/base/test/unit/test_nsIMsgFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolder.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolder.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolder.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolder.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListener.js">mailnews/base/test/unit/test_nsIMsgFolderListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListener.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListener.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListener.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListener.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgTagService.js">mailnews/base/test/unit/test_nsIMsgTagService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgTagService.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgTagService.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgTagService.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgTagService.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsIMsgTagService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMailDirProvider.js">mailnews/base/test/unit/test_nsMailDirProvider.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMailDirProvider.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMailDirProvider.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMailDirProvider.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMailDirProvider.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMailDirProvider.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView.js">mailnews/base/test/unit/test_nsMsgDBView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js">mailnews/base/test/unit/test_nsMsgDBView_headerValues.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgTraitService.js">mailnews/base/test/unit/test_nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_postPluginFilters.js">mailnews/base/test/unit/test_postPluginFilters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_postPluginFilters.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_postPluginFilters.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_postPluginFilters.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_postPluginFilters.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_postPluginFilters.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_quarantineFilterMove.js">mailnews/base/test/unit/test_quarantineFilterMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_quarantineFilterMove.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_quarantineFilterMove.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_quarantineFilterMove.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_quarantineFilterMove.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_quarantineFilterMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_retention.js">mailnews/base/test/unit/test_retention.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_retention.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_retention.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_retention.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_retention.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_retention.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_search.js">mailnews/base/test/unit/test_search.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_search.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_search.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_search.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_search.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_search.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchAddressInAb.js">mailnews/base/test/unit/test_searchAddressInAb.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchAddressInAb.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchAddressInAb.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchAddressInAb.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchAddressInAb.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchAddressInAb.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBody.js">mailnews/base/test/unit/test_searchBody.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBody.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBody.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBody.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBody.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBody.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBoolean.js">mailnews/base/test/unit/test_searchBoolean.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBoolean.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBoolean.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBoolean.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBoolean.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchBoolean.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchChaining.js">mailnews/base/test/unit/test_searchChaining.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchChaining.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchChaining.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchChaining.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchChaining.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchChaining.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchCustomTerm.js">mailnews/base/test/unit/test_searchCustomTerm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchCustomTerm.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchCustomTerm.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchCustomTerm.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchCustomTerm.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchCustomTerm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchJunk.js">mailnews/base/test/unit/test_searchJunk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchJunk.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchJunk.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchJunk.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchJunk.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchJunk.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchLocalizationStrings.js">mailnews/base/test/unit/test_searchLocalizationStrings.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchLocalizationStrings.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchLocalizationStrings.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchLocalizationStrings.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchLocalizationStrings.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchLocalizationStrings.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchTag.js">mailnews/base/test/unit/test_searchTag.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchTag.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchTag.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchTag.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchTag.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchTag.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchUint32HdrProperty.js">mailnews/base/test/unit/test_searchUint32HdrProperty.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchUint32HdrProperty.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchUint32HdrProperty.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchUint32HdrProperty.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchUint32HdrProperty.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_searchUint32HdrProperty.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_base64.js">mailnews/base/test/unit/test_testsuite_base64.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_base64.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_base64.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_base64.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_base64.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_base64.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">mailnews/base/test/unit/test_testsuite_fakeserverAuth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_viewSortByAddresses.js">mailnews/base/test/unit/test_viewSortByAddresses.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_viewSortByAddresses.js">file</a> |
<a href="/comm-central/annotate/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_viewSortByAddresses.js">annotate</a> |
<a href="/comm-central/diff/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_viewSortByAddresses.js">diff</a> |
<a href="/comm-central/comparison/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_viewSortByAddresses.js">comparison</a> |
<a href="/comm-central/log/564a2fae15fba9ca93aff5177f2857bf3e1bba3e/mailnews/base/test/unit/test_viewSortByAddresses.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -30,17 +30,21 @@ chat/chat-prefs.js</span>
<a href="#l1.4"></a><span id="l1.4"> chat/modules/BigInteger.jsm</span>
<a href="#l1.5"></a><span id="l1.5"> chat/protocols/matrix/matrix-sdk/**</span>
<a href="#l1.6"></a><span id="l1.6"> chat/protocols/twitter/twitter-text.jsm</span>
<a href="#l1.7"></a><span id="l1.7"> # preprocessed files</span>
<a href="#l1.8"></a><span id="l1.8"> chat/content/imtooltip.xml</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> # mailnews exclusions</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/mailnews.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/base/*</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+mailnews/base/content/*</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+mailnews/base/prefs/*</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+mailnews/base/search/*</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+mailnews/base/src/*</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+mailnews/base/util/*</span>
<a href="#l1.18"></a><span id="l1.18"> mailnews/build/*</span>
<a href="#l1.19"></a><span id="l1.19"> mailnews/compose/*</span>
<a href="#l1.20"></a><span id="l1.20"> mailnews/db/*</span>
<a href="#l1.21"></a><span id="l1.21"> mailnews/imap/*</span>
<a href="#l1.22"></a><span id="l1.22"> mailnews/import/*</span>
<a href="#l1.23"></a><span id="l1.23"> mailnews/intl/*</span>
<a href="#l1.24"></a><span id="l1.24"> mailnews/jsaccount/*</span>
<a href="#l1.25"></a><span id="l1.25"> mailnews/mime/*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/base/test/unit/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+module.exports = {</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    }],</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  },</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgr.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgr.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -5,18 +5,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /**</span>
<a href="#l3.5"></a><span id="l3.5">  * This tests that we cleanup the account prefs when the account manager is</span>
<a href="#l3.6"></a><span id="l3.6">  * loaded. This entails removing duplicate accounts from</span>
<a href="#l3.7"></a><span id="l3.7">  * mail.accountmanager.accounts list, and removing duplicate accounts with</span>
<a href="#l3.8"></a><span id="l3.8">  * the same server.</span>
<a href="#l3.9"></a><span id="l3.9">  */</span>
<a href="#l3.10"></a><span id="l3.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-function run_test()</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-{</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+function run_test() {</span>
<a href="#l3.15"></a><span id="l3.15">   // Create account prefs with both kinds of duplication.</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   Services.prefs.setCharPref(&quot;mail.account.account1.identities&quot;, &quot;id1&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l3.19"></a><span id="l3.19">   Services.prefs.setCharPref(&quot;mail.account.account2.identities&quot;, &quot;id2&quot;);</span>
<a href="#l3.20"></a><span id="l3.20">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server2&quot;);</span>
<a href="#l3.21"></a><span id="l3.21">   Services.prefs.setCharPref(&quot;mail.account.account4.identities&quot;, &quot;id2&quot;);</span>
<a href="#l3.22"></a><span id="l3.22">   Services.prefs.setCharPref(&quot;mail.account.account4.server&quot;, &quot;server4&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -66,17 +65,17 @@ function run_test()</span>
<a href="#l3.24"></a><span id="l3.24">   Assert.equal(defaultAccount, null);</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   // Remove an account, and verify that the account list pref looks OK:</span>
<a href="#l3.27"></a><span id="l3.27">   let server = MailServices.accounts.getIncomingServer(&quot;server4&quot;);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   // We need to get the root folder to read from the folder cache</span>
<a href="#l3.30"></a><span id="l3.30">   // before it gets removed or else we'll assert, because we're</span>
<a href="#l3.31"></a><span id="l3.31">   // not completely initialized...</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  let flags = server.rootFolder.flags;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  server.rootFolder.flags;</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">   MailServices.accounts.removeAccount(MailServices.accounts.FindAccountForServer(server));</span>
<a href="#l3.36"></a><span id="l3.36">   Assert.equal(MailServices.accounts.accounts.length, 2);</span>
<a href="#l3.37"></a><span id="l3.37">   Assert.equal(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l3.38"></a><span id="l3.38">                &quot;account1,account5&quot;);</span>
<a href="#l3.39"></a><span id="l3.39">   // make sure cleaning up duplicate accounts didn't hork accounts</span>
<a href="#l3.40"></a><span id="l3.40">   Assert.equal(Services.prefs.getCharPref(&quot;mail.account.account1.server&quot;),</span>
<a href="#l3.41"></a><span id="l3.41">                &quot;server1&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgrCustomTypes.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgrCustomTypes.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,18 +5,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /**</span>
<a href="#l4.5"></a><span id="l4.5">  * This tests that accounts with invalid types, such as could be created</span>
<a href="#l4.6"></a><span id="l4.6">  *  from an extension, do not disappear immediately when the extension</span>
<a href="#l4.7"></a><span id="l4.7">  *  is unloaded.</span>
<a href="#l4.8"></a><span id="l4.8">  *</span>
<a href="#l4.9"></a><span id="l4.9">  * Adapted from test_AccountMgr.js by Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l4.10"></a><span id="l4.10">  */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function run_test()</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+function run_test() {</span>
<a href="#l4.15"></a><span id="l4.15">   Services.prefs.setCharPref(&quot;mail.account.account1.identities&quot;, &quot;id1&quot;);</span>
<a href="#l4.16"></a><span id="l4.16">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l4.17"></a><span id="l4.17">   Services.prefs.setCharPref(&quot;mail.account.account2.identities&quot;, &quot;id2&quot;);</span>
<a href="#l4.18"></a><span id="l4.18">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server2&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">   Services.prefs.setCharPref(&quot;mail.server.server1.hostname&quot;, &quot;Local Folders&quot;);</span>
<a href="#l4.20"></a><span id="l4.20">   Services.prefs.setCharPref(&quot;mail.server.server1.type&quot;, &quot;none&quot;);</span>
<a href="#l4.21"></a><span id="l4.21">   Services.prefs.setCharPref(&quot;mail.server.server1.userName&quot;, &quot;nobody&quot;);</span>
<a href="#l4.22"></a><span id="l4.22">   Services.prefs.setCharPref(&quot;mail.server.server1.directory-rel&quot;,</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -67,17 +66,17 @@ function run_test()</span>
<a href="#l4.24"></a><span id="l4.24">   // make it bad again, and reload it to restart the timeout before delete</span>
<a href="#l4.25"></a><span id="l4.25">   MailServices.accounts.UnloadAccounts();</span>
<a href="#l4.26"></a><span id="l4.26">   Services.prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;invalid&quot;);</span>
<a href="#l4.27"></a><span id="l4.27">   Assert.equal(MailServices.accounts.accounts.length, 2);</span>
<a href="#l4.28"></a><span id="l4.28">   MailServices.accounts.UnloadAccounts();</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">   // now let the bad type timeout, and watch it magically disappear!</span>
<a href="#l4.31"></a><span id="l4.31">   do_test_pending();</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  do_timeout(3000, function () {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  do_timeout(3000, function() {</span>
<a href="#l4.34"></a><span id="l4.34">     Assert.equal(MailServices.accounts.accounts.length, 2);</span>
<a href="#l4.35"></a><span id="l4.35"> </span>
<a href="#l4.36"></a><span id="l4.36">     // it is now gone</span>
<a href="#l4.37"></a><span id="l4.37">     Assert.equal(Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;),</span>
<a href="#l4.38"></a><span id="l4.38">                  &quot;account1,&quot; + newAccount.key);</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">     do_test_finished();</span>
<a href="#l4.41"></a><span id="l4.41">   });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMigration.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMigration.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -2,20 +2,19 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.5"></a><span id="l5.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> /**</span>
<a href="#l5.8"></a><span id="l5.8">  * This tests that we don't try to reset the mail.server.server&lt;n&gt;.authMethod</span>
<a href="#l5.9"></a><span id="l5.9">  * preference every time we run the migration code, and other migration stuff</span>
<a href="#l5.10"></a><span id="l5.10">  */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-// make xpcshell-tests TEST_PATH=mailnews/base/test/unit/test_accountMigration.js</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-</span>
<a href="#l5.14"></a><span id="l5.14"> var {migrateMailnews} = ChromeUtils.import(&quot;resource:///modules/mailnewsMigrator.js&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l5.17"></a><span id="l5.17"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19"> function run_test() {</span>
<a href="#l5.20"></a><span id="l5.20">   // Set up some basic accounts with limited prefs - enough to satisfy the</span>
<a href="#l5.21"></a><span id="l5.21">   // migrator.</span>
<a href="#l5.22"></a><span id="l5.22">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l5.23"></a><span id="l5.23">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server2&quot;);</span>
<a href="#l5.24"></a><span id="l5.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/test/unit/test_acctRepair.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_acctRepair.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,18 +4,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> /**</span>
<a href="#l6.6"></a><span id="l6.6">  * This tests that we recover from having a local folders server</span>
<a href="#l6.7"></a><span id="l6.7">  * without having an account that points at it.</span>
<a href="#l6.8"></a><span id="l6.8">  */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-function run_test()</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+function run_test() {</span>
<a href="#l6.15"></a><span id="l6.15">   // Create account prefs with both kinds of duplication.</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">   Services.prefs.setCharPref(&quot;mail.account.account2.identities&quot;, &quot;id2&quot;);</span>
<a href="#l6.18"></a><span id="l6.18">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server1&quot;);</span>
<a href="#l6.19"></a><span id="l6.19">   Services.prefs.setCharPref(&quot;mail.account.account6.identities&quot;, &quot;id3&quot;);</span>
<a href="#l6.20"></a><span id="l6.20">   Services.prefs.setCharPref(&quot;mail.account.account6.server&quot;, &quot;server5&quot;);</span>
<a href="#l6.21"></a><span id="l6.21">   Services.prefs.setCharPref(&quot;mail.server.server1.hostname&quot;,</span>
<a href="#l6.22"></a><span id="l6.22">                              &quot;Local Folders&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/test/unit/test_base64_decoding.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_base64_decoding.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1,96 +1,81 @@</span>
<a href="#l7.4"></a><span id="l7.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.5"></a><span id="l7.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.6"></a><span id="l7.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> // This tests that we do not crash when loading the email bodySearchCrash,</span>
<a href="#l7.9"></a><span id="l7.9"> // which was fixed in bug 465805</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l7.12"></a><span id="l7.12"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l7.13"></a><span id="l7.13"> </span>
<a href="#l7.14"></a><span id="l7.14"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+var Body = Ci.nsMsgSearchAttrib.Body;</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-var offlineMailFilter = nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-var Body = nsMsgSearchAttrib.Body;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-var Files =</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-[</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+var Files = [</span>
<a href="#l7.32"></a><span id="l7.32">   &quot;../../../data/bugmail1&quot;,</span>
<a href="#l7.33"></a><span id="l7.33">   &quot;../../../data/bodySearchCrash&quot;,            // Test for bug 465805.</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  &quot;../../../data/base64-with-whitespace.eml&quot;  // Test for bug 1487421.</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-]</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  &quot;../../../data/base64-with-whitespace.eml&quot;, // Test for bug 1487421.</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+];</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-var Tests =</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-[</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-// this number appears in bugmail1</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  { value: &quot;432710&quot;,</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+var Tests = [</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+    // this number appears in bugmail1</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+    value: &quot;432710&quot;,</span>
<a href="#l7.48"></a><span id="l7.48">     attrib: Body,</span>
<a href="#l7.49"></a><span id="l7.49">     op: Contains,</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    count: 1 },</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-// this appears in base64-with-whitespace.eml</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  { value: &quot;abcdefghijklmnopqrstuvwxyz&quot;,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    count: 1,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  }, {</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+    // this appears in base64-with-whitespace.eml</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+    value: &quot;abcdefghijklmnopqrstuvwxyz&quot;,</span>
<a href="#l7.58"></a><span id="l7.58">     attrib: Body,</span>
<a href="#l7.59"></a><span id="l7.59">     op: Contains,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-    count: 1 },</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-]</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    count: 1,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  },</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+];</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-function run_test()</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-{</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+function run_test() {</span>
<a href="#l7.69"></a><span id="l7.69">   // Setup local mail accounts.</span>
<a href="#l7.70"></a><span id="l7.70">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72">   // Get a message into the local filestore. function testBodySearch() continues the testing after the copy.</span>
<a href="#l7.73"></a><span id="l7.73">   do_test_pending();</span>
<a href="#l7.74"></a><span id="l7.74">   copyListener.OnStopCopy(null);</span>
<a href="#l7.75"></a><span id="l7.75">   return true;</span>
<a href="#l7.76"></a><span id="l7.76"> }</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-var copyListener =</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-{</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+var copyListener = {</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l7.92"></a><span id="l7.92">     let fileName = Files.shift();</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-    if (fileName)</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    {</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+    if (fileName) {</span>
<a href="#l7.96"></a><span id="l7.96">       let file = do_get_file(fileName);</span>
<a href="#l7.97"></a><span id="l7.97">       MailServices.copy.CopyFileMessage(file, localAccountUtils.inboxFolder, null,</span>
<a href="#l7.98"></a><span id="l7.98">                                         false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    } else {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+      testBodySearch();</span>
<a href="#l7.101"></a><span id="l7.101">     }</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-    else</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-      testBodySearch();</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-  }</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  },</span>
<a href="#l7.106"></a><span id="l7.106"> };</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108"> // Runs at completion of copy</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-var testObject;</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-function testBodySearch()</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-{</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+function testBodySearch() {</span>
<a href="#l7.115"></a><span id="l7.115">   print(&quot;Test Body Search&quot;);</span>
<a href="#l7.116"></a><span id="l7.116">   var test = Tests.shift();</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-  if (test)</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-                         test.value,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-                         test.attrib,</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-                         test.op,</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-                         test.count,</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-                         testBodySearch);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  if (test) {</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+                   test.value,</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+                   test.attrib,</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+                   test.op,</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+                   test.count,</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+                   testBodySearch);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  } else {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+    do_test_finished();</span>
<a href="#l7.134"></a><span id="l7.134">   }</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-  else</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-    do_test_finished();</span>
<a href="#l7.137"></a><span id="l7.137"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bccInDatabase.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bccInDatabase.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -5,42 +5,39 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /*</span>
<a href="#l8.5"></a><span id="l8.5">  * Testing of bcc in message summary file added in bug 481667</span>
<a href="#l8.6"></a><span id="l8.6">  */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> var hdr;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-function run_test()</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+function run_test() {</span>
<a href="#l8.15"></a><span id="l8.15">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  var copyListener =</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-    SetMessageKey: function(aKey) {</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  var copyListener = {</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    SetMessageKey(aKey) {</span>
<a href="#l8.26"></a><span id="l8.26">       hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l8.27"></a><span id="l8.27">     },</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-    OnStopCopy: function(aStatus) { continueTest();}</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    OnStopCopy(aStatus) { continueTest(); },</span>
<a href="#l8.32"></a><span id="l8.32">   };</span>
<a href="#l8.33"></a><span id="l8.33"> </span>
<a href="#l8.34"></a><span id="l8.34">   // Get a message into the local filestore.</span>
<a href="#l8.35"></a><span id="l8.35">   var draft = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l8.36"></a><span id="l8.36">   do_test_pending();</span>
<a href="#l8.37"></a><span id="l8.37">   MailServices.copy.CopyFileMessage(draft, localAccountUtils.inboxFolder, null, false, 0,</span>
<a href="#l8.38"></a><span id="l8.38">                                     &quot;&quot;, copyListener, null);</span>
<a href="#l8.39"></a><span id="l8.39"> }</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-function continueTest()</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-{</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  //dump(&quot;\nbccList &gt;&quot; + hdr.bccList);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  //dump(&quot;\nccList &gt;&quot; + hdr.ccList);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  //dump(&quot;\n&quot;);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+function continueTest() {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  // dump(&quot;\nbccList &gt;&quot; + hdr.bccList);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  // dump(&quot;\nccList &gt;&quot; + hdr.ccList);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  // dump(&quot;\n&quot;);</span>
<a href="#l8.50"></a><span id="l8.50">   Assert.ok(hdr.bccList.includes(&quot;Another Person&quot;));</span>
<a href="#l8.51"></a><span id="l8.51">   Assert.ok(hdr.bccList.includes(&quot;&lt;u1@example.com&gt;&quot;));</span>
<a href="#l8.52"></a><span id="l8.52">   Assert.ok(!hdr.bccList.includes(&quot;IDoNotExist&quot;));</span>
<a href="#l8.53"></a><span id="l8.53">   hdr = null;</span>
<a href="#l8.54"></a><span id="l8.54">   do_test_finished();</span>
<a href="#l8.55"></a><span id="l8.55"> }</span>
<a href="#l8.56"></a><span id="l8.56"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug366491.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug366491.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -2,98 +2,93 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.5"></a><span id="l9.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> // tests return of junk percent from bayesian filter</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> // main setup</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> // only needed during debug</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-//do_import_script(&quot;mailnews/extensions/bayesian-spam-filter/test/resources/trainingfile.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+// do_import_script(&quot;mailnews/extensions/bayesian-spam-filter/test/resources/trainingfile.js&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> // local constants</span>
<a href="#l9.18"></a><span id="l9.18"> var kUnclassified = MailServices.junk.UNCLASSIFIED;</span>
<a href="#l9.19"></a><span id="l9.19"> var kJunk = MailServices.junk.JUNK;</span>
<a href="#l9.20"></a><span id="l9.20"> var kGood = MailServices.junk.GOOD;</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22"> /*</span>
<a href="#l9.23"></a><span id="l9.23">  * This test is not intended to check the spam calculations,</span>
<a href="#l9.24"></a><span id="l9.24">  * but only that the junk percent is transmitted (particularly</span>
<a href="#l9.25"></a><span id="l9.25">  * for intermediate values). The test</span>
<a href="#l9.26"></a><span id="l9.26">  * junkPercent values below were calculated by the plugin,</span>
<a href="#l9.27"></a><span id="l9.27">  * not indepedently verified.</span>
<a href="#l9.28"></a><span id="l9.28">  */</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-var tests =</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-[</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-  {fileName: &quot;ham2.eml&quot;,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-   junkPercent: 8},</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  {fileName: &quot;spam2.eml&quot;,</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-   junkPercent: 81},</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+var tests = [</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+    fileName: &quot;ham2.eml&quot;,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+    junkPercent: 8,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  }, {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    fileName: &quot;spam2.eml&quot;,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+    junkPercent: 81,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+  },</span>
<a href="#l9.44"></a><span id="l9.44"> ];</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-var emails =</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-[</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-  {fileName: &quot;ham1.eml&quot;,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-   classification: kGood},</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-  {fileName: &quot;spam1.eml&quot;,</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-   classification: kJunk},</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+var emails = [</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  {</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+    fileName: &quot;ham1.eml&quot;,</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    classification: kGood,</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+  }, {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+    fileName: &quot;spam1.eml&quot;,</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    classification: kJunk,</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  },</span>
<a href="#l9.60"></a><span id="l9.60"> ];</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62"> // main test</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-function run_test()</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-{</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+function run_test() {</span>
<a href="#l9.66"></a><span id="l9.66">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l9.67"></a><span id="l9.67">   do_test_pending();</span>
<a href="#l9.68"></a><span id="l9.68">   doTestingListener.onMessageClassified(null, null, null);</span>
<a href="#l9.69"></a><span id="l9.69">   return true;</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-};</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+}</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73"> var haveClassification = false;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-var doTestingListener =</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-{</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  onMessageClassified: function(aMsgURI, aClassification, aJunkPercent)</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  {</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+var doTestingListener = {</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  onMessageClassified(aMsgURI, aClassification, aJunkPercent) {</span>
<a href="#l9.80"></a><span id="l9.80">     // Do we have more training emails? If so, train</span>
<a href="#l9.81"></a><span id="l9.81">     var email = emails.shift();</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-    if (email)</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-    {</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    if (email) {</span>
<a href="#l9.85"></a><span id="l9.85">       MailServices.junk.setMessageClassification(getSpec(email.fileName),</span>
<a href="#l9.86"></a><span id="l9.86">         kUnclassified, email.classification, null, doTestingListener);</span>
<a href="#l9.87"></a><span id="l9.87">       return;</span>
<a href="#l9.88"></a><span id="l9.88">     }</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">     if (!aMsgURI)</span>
<a href="#l9.91"></a><span id="l9.91">       return; // ignore end of batch</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">     // Have we completed a classification? If so, test</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-    if (haveClassification)</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-    {</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    if (haveClassification) {</span>
<a href="#l9.97"></a><span id="l9.97">       let test = tests.shift();</span>
<a href="#l9.98"></a><span id="l9.98">       Assert.equal(getSpec(test.fileName), aMsgURI);</span>
<a href="#l9.99"></a><span id="l9.99">       Assert.equal(test.junkPercent, aJunkPercent);</span>
<a href="#l9.100"></a><span id="l9.100">     }</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102">     // Do we have more classifications to do? Then classify the first one.</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-    if (tests.length)</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-    {</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+    if (tests.length) {</span>
<a href="#l9.106"></a><span id="l9.106">       haveClassification = true;</span>
<a href="#l9.107"></a><span id="l9.107">       MailServices.junk.classifyMessage(getSpec(tests[0].fileName),</span>
<a href="#l9.108"></a><span id="l9.108">         null, doTestingListener);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-      return;</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    } else {</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+      do_test_finished();</span>
<a href="#l9.112"></a><span id="l9.112">     }</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-    else</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-      do_test_finished();</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-  }</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  },</span>
<a href="#l9.118"></a><span id="l9.118"> };</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120"> // helper functions</span>
<a href="#l9.121"></a><span id="l9.121"> </span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-function getSpec(aFileName)</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-{</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+function getSpec(aFileName) {</span>
<a href="#l9.125"></a><span id="l9.125">   var file = do_get_file(&quot;../../../extensions/bayesian-spam-filter/test/unit/resources/&quot; + aFileName);</span>
<a href="#l9.126"></a><span id="l9.126">   var uri = Services.io.newFileURI(file).QueryInterface(Ci.nsIURL);</span>
<a href="#l9.127"></a><span id="l9.127">   uri = uri.mutate().setQuery(&quot;type=application/x-message-display&quot;).finalize();</span>
<a href="#l9.128"></a><span id="l9.128">   return uri.spec;</span>
<a href="#l9.129"></a><span id="l9.129"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug404489.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug404489.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,68 +1,70 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> // Tests that custom headers like &quot;Sender&quot; work (bug 404489)</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l10.18"></a><span id="l10.18"> var gArrayHdrs = [&quot;X-Bugzilla-Who&quot;, &quot;Sender&quot;];</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-var gFirstHeader = nsMsgSearchAttrib.OtherHeader + 1;</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+var gFirstHeader = Ci.nsMsgSearchAttrib.OtherHeader + 1;</span>
<a href="#l10.21"></a><span id="l10.21"> var fileName = &quot;../../../data/SenderHeader&quot;;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-var Tests =</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-[</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+var Tests = [</span>
<a href="#l10.26"></a><span id="l10.26">   /* test header:</span>
<a href="#l10.27"></a><span id="l10.27">   X-Bugzilla-Who: bugmail@example.org</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">   This just shows that normal custom headers work</span>
<a href="#l10.30"></a><span id="l10.30">   */</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  { testValue: &quot;bugmail&quot;,</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+  {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+    testValue: &quot;bugmail&quot;,</span>
<a href="#l10.34"></a><span id="l10.34">     attrib: gFirstHeader,</span>
<a href="#l10.35"></a><span id="l10.35">     op: Contains,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    count: 1},</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  { testValue: &quot;ThisIsNotThere&quot;,</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+    count: 1,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+  }, {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+    testValue: &quot;ThisIsNotThere&quot;,</span>
<a href="#l10.41"></a><span id="l10.41">     attrib: gFirstHeader,</span>
<a href="#l10.42"></a><span id="l10.42">     op: Contains,</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-    count: 0},</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+    count: 0,</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  },</span>
<a href="#l10.46"></a><span id="l10.46">   /* test header:</span>
<a href="#l10.47"></a><span id="l10.47">   Sender: iamthesender@example.com</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">   This is the main fix of bug 404489, that we can use Sender as a header</span>
<a href="#l10.50"></a><span id="l10.50">   */</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  { testValue: &quot;iamthesender&quot;,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+    testValue: &quot;iamthesender&quot;,</span>
<a href="#l10.54"></a><span id="l10.54">     attrib: gFirstHeader + 1,</span>
<a href="#l10.55"></a><span id="l10.55">     op: Contains,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    count: 1},</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+    count: 1,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  },</span>
<a href="#l10.59"></a><span id="l10.59">   /* test header:</span>
<a href="#l10.60"></a><span id="l10.60">   From: bugzilla-daemon@mozilla.invalid</span>
<a href="#l10.61"></a><span id="l10.61"> </span>
<a href="#l10.62"></a><span id="l10.62">   Here we show that the &quot;From&quot; header does not fire tests for the</span>
<a href="#l10.63"></a><span id="l10.63">   &quot;Sender&quot; arbitrary headers, but does fire the standard test</span>
<a href="#l10.64"></a><span id="l10.64">   for nsMsgSenderAttrib.Sender</span>
<a href="#l10.65"></a><span id="l10.65">   */</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  { testValue: &quot;bugzilla&quot;,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+  {</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    testValue: &quot;bugzilla&quot;,</span>
<a href="#l10.69"></a><span id="l10.69">     attrib: gFirstHeader + 1,</span>
<a href="#l10.70"></a><span id="l10.70">     op: Contains,</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    count: 0},</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  { testValue: &quot;bugzilla&quot;,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    count: 0,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+  }, {</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    testValue: &quot;bugzilla&quot;,</span>
<a href="#l10.76"></a><span id="l10.76">     attrib: Ci.nsMsgSearchAttrib.Sender,</span>
<a href="#l10.77"></a><span id="l10.77">     op: Contains,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-    count: 1}</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+    count: 1,</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  },</span>
<a href="#l10.81"></a><span id="l10.81"> ];</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-function run_test()</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-{</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+function run_test() {</span>
<a href="#l10.86"></a><span id="l10.86">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88">   // add the custom headers into the preferences file, &quot;:&quot; delimited</span>
<a href="#l10.89"></a><span id="l10.89"> </span>
<a href="#l10.90"></a><span id="l10.90">   var hdrs;</span>
<a href="#l10.91"></a><span id="l10.91">   if (gArrayHdrs.length == 1)</span>
<a href="#l10.92"></a><span id="l10.92">     hdrs = gArrayHdrs;</span>
<a href="#l10.93"></a><span id="l10.93">   else</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineat">@@ -72,41 +74,36 @@ function run_test()</span>
<a href="#l10.95"></a><span id="l10.95">   // Get a message into the local filestore. function continue_test() continues the testing after the copy.</span>
<a href="#l10.96"></a><span id="l10.96">   do_test_pending();</span>
<a href="#l10.97"></a><span id="l10.97">   var file = do_get_file(fileName);</span>
<a href="#l10.98"></a><span id="l10.98">   MailServices.copy.CopyFileMessage(file, localAccountUtils.inboxFolder, null, false, 0,</span>
<a href="#l10.99"></a><span id="l10.99">                                     &quot;&quot;, copyListener, null);</span>
<a href="#l10.100"></a><span id="l10.100">   return true;</span>
<a href="#l10.101"></a><span id="l10.101"> }</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-var copyListener =</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-{</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-  SetMessageKey: function(aKey) { },</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-  OnStopCopy: function(aStatus) { continue_test();}</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+var copyListener = {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+  SetMessageKey(aKey) { },</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+  OnStopCopy(aStatus) { continue_test(); },</span>
<a href="#l10.116"></a><span id="l10.116"> };</span>
<a href="#l10.117"></a><span id="l10.117"> </span>
<a href="#l10.118"></a><span id="l10.118"> // Runs at completion of each copy</span>
<a href="#l10.119"></a><span id="l10.119"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-var testObject;</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-function continue_test()</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-{</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+function continue_test() {</span>
<a href="#l10.124"></a><span id="l10.124">   var test = Tests.shift();</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-  if (test)</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-    testObject = new TestSearchx(localAccountUtils.inboxFolder,</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-                                 test.testValue,</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-                                 test.attrib,</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-                                 test.op,</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-                                 test.count,</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-                                 continue_test);</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-  else</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-  {</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    testObject = null;</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineplus">+  if (test) {</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineplus">+    new TestSearchx(localAccountUtils.inboxFolder,</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineplus">+                    test.testValue,</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineplus">+                    test.attrib,</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+                    test.op,</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+                    test.count,</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineplus">+                    continue_test);</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineplus">+  } else {</span>
<a href="#l10.143"></a><span id="l10.143">     do_test_finished();</span>
<a href="#l10.144"></a><span id="l10.144">   }</span>
<a href="#l10.145"></a><span id="l10.145"> }</span>
<a href="#l10.146"></a><span id="l10.146"> </span>
<a href="#l10.147"></a><span id="l10.147"> /*</span>
<a href="#l10.148"></a><span id="l10.148">  * TestSearchx: Class to test number of search hits</span>
<a href="#l10.149"></a><span id="l10.149">  *</span>
<a href="#l10.150"></a><span id="l10.150">  * @param aFolder:   the folder to search</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineat">@@ -118,30 +115,27 @@ function continue_test()</span>
<a href="#l10.152"></a><span id="l10.152">  *</span>
<a href="#l10.153"></a><span id="l10.153">  * @param aAttrib:   attribute for the search (Ci.nsMsgSearchAttrib.Size, etc.)</span>
<a href="#l10.154"></a><span id="l10.154">  * @param aOp:       operation for the search (Ci.nsMsgSearchOp.Contains, etc.)</span>
<a href="#l10.155"></a><span id="l10.155">  * @param aHitCount: expected number of search hits</span>
<a href="#l10.156"></a><span id="l10.156">  * @param onDone:    function to call on completion of search</span>
<a href="#l10.157"></a><span id="l10.157">  *</span>
<a href="#l10.158"></a><span id="l10.158">  */</span>
<a href="#l10.159"></a><span id="l10.159"> </span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-function TestSearchx(aFolder, aValue, aAttrib, aOp, aHitCount, onDone)</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-{</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-  var searchListener =</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-  {</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-    onSearchHit: function(dbHdr, folder) { hitCount++; },</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-    onSearchDone: function(status)</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-    {</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+function TestSearchx(aFolder, aValue, aAttrib, aOp, aHitCount, onDone) {</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+  var searchListener = {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+    onSearchHit(dbHdr, folder) { hitCount++; },</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+    onSearchDone(status) {</span>
<a href="#l10.171"></a><span id="l10.171">       print(&quot;Finished search does &quot; + aHitCount + &quot; equal &quot; + hitCount + &quot;?&quot;);</span>
<a href="#l10.172"></a><span id="l10.172">       searchSession = null;</span>
<a href="#l10.173"></a><span id="l10.173">       Assert.equal(aHitCount, hitCount);</span>
<a href="#l10.174"></a><span id="l10.174">       if (onDone)</span>
<a href="#l10.175"></a><span id="l10.175">         onDone();</span>
<a href="#l10.176"></a><span id="l10.176">     },</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-    onNewSearch: function() {hitCount = 0;}</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    onNewSearch() { hitCount = 0; },</span>
<a href="#l10.179"></a><span id="l10.179">   };</span>
<a href="#l10.180"></a><span id="l10.180"> </span>
<a href="#l10.181"></a><span id="l10.181">   // define and initiate the search session</span>
<a href="#l10.182"></a><span id="l10.182"> </span>
<a href="#l10.183"></a><span id="l10.183">   var hitCount;</span>
<a href="#l10.184"></a><span id="l10.184">   var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l10.185"></a><span id="l10.185">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l10.186"></a><span id="l10.186">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, aFolder);</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineat">@@ -171,17 +165,17 @@ function TestSearchx(aFolder, aValue, aA</span>
<a href="#l10.188"></a><span id="l10.188">     value.label = aValue;</span>
<a href="#l10.189"></a><span id="l10.189">   else if (aAttrib == Ci.nsMsgSearchAttrib.JunkStatus)</span>
<a href="#l10.190"></a><span id="l10.190">     value.junkStatus = aValue;</span>
<a href="#l10.191"></a><span id="l10.191">   else if (aAttrib == Ci.nsMsgSearchAttrib.HasAttachmentStatus)</span>
<a href="#l10.192"></a><span id="l10.192">     value.status = Ci.nsMsgMessageFlags.Attachment;</span>
<a href="#l10.193"></a><span id="l10.193">   else</span>
<a href="#l10.194"></a><span id="l10.194">     value.str = aValue;</span>
<a href="#l10.195"></a><span id="l10.195">   searchTerm.value = value;</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-  if (aAttrib &gt; nsMsgSearchAttrib.OtherHeader)</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-    searchTerm.arbitraryHeader = gArrayHdrs[aAttrib - 1 - nsMsgSearchAttrib.OtherHeader];</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineplus">+  if (aAttrib &gt; Ci.nsMsgSearchAttrib.OtherHeader)</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineplus">+    searchTerm.arbitraryHeader = gArrayHdrs[aAttrib - 1 - Ci.nsMsgSearchAttrib.OtherHeader];</span>
<a href="#l10.200"></a><span id="l10.200">   searchTerm.op = aOp;</span>
<a href="#l10.201"></a><span id="l10.201">   searchTerm.booleanAnd = false;</span>
<a href="#l10.202"></a><span id="l10.202">   searchSession.appendTerm(searchTerm);</span>
<a href="#l10.203"></a><span id="l10.203">   searchSession.registerListener(searchListener);</span>
<a href="#l10.204"></a><span id="l10.204">   searchSession.search(null);</span>
<a href="#l10.205"></a><span id="l10.205"> }</span>
<a href="#l10.206"></a><span id="l10.206"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,74 +1,69 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> // Test of message count changes in virtual folder views</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-var dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot; + &quot;quicksearch&quot;;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-var dbView = Cc[dbviewContractId].createInstance(Ci.nsIMsgDBView);</span>
<a href="#l11.14"></a><span id="l11.14"> var bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l11.15"></a><span id="l11.15"> // main test</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> // the headers for the test messages. All messages are identical, but</span>
<a href="#l11.18"></a><span id="l11.18"> // have different properties set on them.</span>
<a href="#l11.19"></a><span id="l11.19"> var hdrs = [];</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> // how many identical messages to load</span>
<a href="#l11.22"></a><span id="l11.22"> var messageCount = 5;</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> // tag used with test messages</span>
<a href="#l11.25"></a><span id="l11.25"> var tag1 = &quot;istag&quot;;</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-function run_test()</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-{</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+function run_test() {</span>
<a href="#l11.30"></a><span id="l11.30">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32">   // Get messageCount messages into the local filestore.</span>
<a href="#l11.33"></a><span id="l11.33">   do_test_pending();</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35">   // function setupVirtualFolder() continues the testing after CopyFileMessage.</span>
<a href="#l11.36"></a><span id="l11.36">   MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null, false,</span>
<a href="#l11.37"></a><span id="l11.37">                                     0, &quot;&quot;, copyListener, null);</span>
<a href="#l11.38"></a><span id="l11.38">   return true;</span>
<a href="#l11.39"></a><span id="l11.39"> }</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-var copyListener =</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-{</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  {</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+var copyListener = {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l11.52"></a><span id="l11.52">     hdrs.push(localAccountUtils.inboxFolder.GetMessageHeader(aKey));</span>
<a href="#l11.53"></a><span id="l11.53">   },</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    if (--messageCount)</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+    if (--messageCount) {</span>
<a href="#l11.61"></a><span id="l11.61">       MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null,</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-                                  false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    else {</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+                                        false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    } else {</span>
<a href="#l11.66"></a><span id="l11.66">       try {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-      setupVirtualFolder();</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-      } catch (ex) {dump(ex);}</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+        setupVirtualFolder();</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+      } catch (ex) {</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+        dump(ex);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+      }</span>
<a href="#l11.73"></a><span id="l11.73">     }</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  }</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  },</span>
<a href="#l11.76"></a><span id="l11.76"> };</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78"> var virtualFolder;</span>
<a href="#l11.79"></a><span id="l11.79"> var numTotalMessages;</span>
<a href="#l11.80"></a><span id="l11.80"> var numUnreadMessages;</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82"> // virtual folder setup</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-function setupVirtualFolder()</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-{</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+function setupVirtualFolder() {</span>
<a href="#l11.86"></a><span id="l11.86">   // add as valid tag tag1, though probably not really necessary</span>
<a href="#l11.87"></a><span id="l11.87">   MailServices.tags.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l11.88"></a><span id="l11.88"> </span>
<a href="#l11.89"></a><span id="l11.89">   // add tag1 to 4 messages</span>
<a href="#l11.90"></a><span id="l11.90">   var messages0to3 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.91"></a><span id="l11.91">   for (var i = 0; i &lt;= 3; i++)</span>
<a href="#l11.92"></a><span id="l11.92">     messages0to3.appendElement(hdrs[i]);</span>
<a href="#l11.93"></a><span id="l11.93">   localAccountUtils.inboxFolder.addKeywordsToMessages(messages0to3, tag1);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineat">@@ -87,79 +82,74 @@ function setupVirtualFolder()</span>
<a href="#l11.95"></a><span id="l11.95">   // search will look for tag tag1 in the inbox folder</span>
<a href="#l11.96"></a><span id="l11.96">   var searchTerm = makeSearchTerm(localAccountUtils.inboxFolder, tag1,</span>
<a href="#l11.97"></a><span id="l11.97">     Ci.nsMsgSearchAttrib.Keywords, Ci.nsMsgSearchOp.Contains);</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99">   dump(&quot;creating virtual folder\n&quot;);</span>
<a href="#l11.100"></a><span id="l11.100">   var rootFolder = localAccountUtils.incomingServer.rootMsgFolder;</span>
<a href="#l11.101"></a><span id="l11.101">   virtualFolder = CreateVirtualFolder(&quot;VfTest&quot;, rootFolder,</span>
<a href="#l11.102"></a><span id="l11.102">                                       localAccountUtils.inboxFolder.URI, searchTerm, false);</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  var count= new Object;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105">   // Setup search session. Execution continues with testVirtualFolder()</span>
<a href="#l11.106"></a><span id="l11.106">   // after search is done.</span>
<a href="#l11.107"></a><span id="l11.107"> </span>
<a href="#l11.108"></a><span id="l11.108">   var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l11.109"></a><span id="l11.109">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l11.110"></a><span id="l11.110">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail,</span>
<a href="#l11.111"></a><span id="l11.111">                              localAccountUtils.inboxFolder);</span>
<a href="#l11.112"></a><span id="l11.112">   searchSession.appendTerm(searchTerm, false);</span>
<a href="#l11.113"></a><span id="l11.113">   searchSession.registerListener(searchListener);</span>
<a href="#l11.114"></a><span id="l11.114">   dump(&quot;starting search of vf\n&quot;);</span>
<a href="#l11.115"></a><span id="l11.115">   searchSession.search(null);</span>
<a href="#l11.116"></a><span id="l11.116"> }</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118"> // partially based on gSearchNotificationListener in searchBar.js</span>
<a href="#l11.119"></a><span id="l11.119"> // nsIMsgSearchNotify implementation</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-var searchListener =</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-{</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-  onNewSearch: function()</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-  {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+var searchListener = {</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+  onNewSearch() {</span>
<a href="#l11.126"></a><span id="l11.126">     dump(&quot;in onnewsearch\n&quot;);</span>
<a href="#l11.127"></a><span id="l11.127">     numTotalMessages = 0;</span>
<a href="#l11.128"></a><span id="l11.128">     numUnreadMessages = 0;</span>
<a href="#l11.129"></a><span id="l11.129">   },</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  onSearchHit: function(dbHdr, folder)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-  {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+  onSearchHit(dbHdr, folder) {</span>
<a href="#l11.133"></a><span id="l11.133">     print(&quot;Search hit, isRead is &quot; + dbHdr.isRead);</span>
<a href="#l11.134"></a><span id="l11.134">     numTotalMessages++;</span>
<a href="#l11.135"></a><span id="l11.135">     if (!dbHdr.isRead)</span>
<a href="#l11.136"></a><span id="l11.136">       numUnreadMessages++;</span>
<a href="#l11.137"></a><span id="l11.137">   },</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  onSearchDone: function(status)</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-  {</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  onSearchDone(status) {</span>
<a href="#l11.141"></a><span id="l11.141">     print(&quot;Finished search hitCount = &quot; + numTotalMessages);</span>
<a href="#l11.142"></a><span id="l11.142">     var db = virtualFolder.msgDatabase;</span>
<a href="#l11.143"></a><span id="l11.143">     var dbFolderInfo = db.dBFolderInfo;</span>
<a href="#l11.144"></a><span id="l11.144">     dbFolderInfo.numMessages = numTotalMessages;</span>
<a href="#l11.145"></a><span id="l11.145">     dbFolderInfo.numUnreadMessages = numUnreadMessages;</span>
<a href="#l11.146"></a><span id="l11.146">     virtualFolder.updateSummaryTotals(true);</span>
<a href="#l11.147"></a><span id="l11.147">     print(&quot;virtual folder unread is &quot; + virtualFolder.getNumUnread(false));</span>
<a href="#l11.148"></a><span id="l11.148">     testVirtualFolder();</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-  }</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+  },</span>
<a href="#l11.151"></a><span id="l11.151"> };</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-function testVirtualFolder()</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-{</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-  /*** basic functionality tests ***/</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+function testVirtualFolder() {</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  // basic functionality tests</span>
<a href="#l11.158"></a><span id="l11.158"> </span>
<a href="#l11.159"></a><span id="l11.159">   // total messages matching search</span>
<a href="#l11.160"></a><span id="l11.160">   Assert.equal(4, virtualFolder.getTotalMessages(false));</span>
<a href="#l11.161"></a><span id="l11.161"> </span>
<a href="#l11.162"></a><span id="l11.162">   // total unread messages in search</span>
<a href="#l11.163"></a><span id="l11.163">   Assert.equal(3, virtualFolder.getNumUnread(false));</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165">   // change unread of one item in search to decrease count</span>
<a href="#l11.166"></a><span id="l11.166">   var message0 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.167"></a><span id="l11.167">   message0.appendElement(hdrs[0]);</span>
<a href="#l11.168"></a><span id="l11.168">   localAccountUtils.inboxFolder.markMessagesRead(message0, true);</span>
<a href="#l11.169"></a><span id="l11.169">   virtualFolder.updateSummaryTotals(true);</span>
<a href="#l11.170"></a><span id="l11.170"> </span>
<a href="#l11.171"></a><span id="l11.171">   Assert.equal(2, virtualFolder.getNumUnread(false));</span>
<a href="#l11.172"></a><span id="l11.172"> </span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-  /*** failures fixed in this bug ***/</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+  // failures fixed in this bug</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176">   // remove tag from one item to decrease count</span>
<a href="#l11.177"></a><span id="l11.177">   var message1 = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.178"></a><span id="l11.178">   message1.appendElement(hdrs[1]);</span>
<a href="#l11.179"></a><span id="l11.179"> </span>
<a href="#l11.180"></a><span id="l11.180">   localAccountUtils.inboxFolder.removeKeywordsFromMessages(message1, tag1);</span>
<a href="#l11.181"></a><span id="l11.181">   virtualFolder.updateSummaryTotals(true);</span>
<a href="#l11.182"></a><span id="l11.182">   Assert.equal(3, virtualFolder.getTotalMessages(false));</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineat">@@ -170,58 +160,54 @@ function testVirtualFolder()</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185">   do_test_finished();</span>
<a href="#l11.186"></a><span id="l11.186">   return true;</span>
<a href="#l11.187"></a><span id="l11.187"> }</span>
<a href="#l11.188"></a><span id="l11.188"> </span>
<a href="#l11.189"></a><span id="l11.189"> // helper functions</span>
<a href="#l11.190"></a><span id="l11.190"> </span>
<a href="#l11.191"></a><span id="l11.191"> // adapted from commandglue.js</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-function CreateVirtualFolder(newName, parentFolder, searchFolderURIs, searchTerm, searchOnline)</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-{</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+function CreateVirtualFolder(newName, parentFolder, searchFolderURIs, searchTerm, searchOnline) {</span>
<a href="#l11.195"></a><span id="l11.195">   var newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l11.196"></a><span id="l11.196">   newFolder.setFlag(Ci.nsMsgFolderFlags.Virtual);</span>
<a href="#l11.197"></a><span id="l11.197">   var vfdb = newFolder.msgDatabase;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-  var searchTerms = [];</span>
<a href="#l11.199"></a><span id="l11.199">   var searchTermString = getSearchTermString(searchTerm);</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201">   var dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l11.202"></a><span id="l11.202">   // set the view string as a property of the db folder info</span>
<a href="#l11.203"></a><span id="l11.203">   // set the original folder name as well.</span>
<a href="#l11.204"></a><span id="l11.204">   dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l11.205"></a><span id="l11.205">   dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l11.206"></a><span id="l11.206">   dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l11.207"></a><span id="l11.207">   // This fails because the folder doesn't exist - why were we doing it?</span>
<a href="#l11.208"></a><span id="l11.208">   //  vfdb.summaryValid = true;</span>
<a href="#l11.209"></a><span id="l11.209">   vfdb.Close(true);</span>
<a href="#l11.210"></a><span id="l11.210">   // use acctMgr to setup the virtual folder listener</span>
<a href="#l11.211"></a><span id="l11.211">   var acctMgr = MailServices.accounts.QueryInterface(Ci.nsIFolderListener);</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-  //print(acctMgr);</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+  // print(acctMgr);</span>
<a href="#l11.214"></a><span id="l11.214">   acctMgr.OnItemAdded(null, newFolder);</span>
<a href="#l11.215"></a><span id="l11.215">   return newFolder;</span>
<a href="#l11.216"></a><span id="l11.216"> }</span>
<a href="#l11.217"></a><span id="l11.217"> </span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-function getSearchTermString(term)</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-{</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+function getSearchTermString(term) {</span>
<a href="#l11.221"></a><span id="l11.221">   var condition = &quot;&quot;;</span>
<a href="#l11.222"></a><span id="l11.222"> </span>
<a href="#l11.223"></a><span id="l11.223">   if (condition.length &gt; 1)</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-    condition += ' ';</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+    condition += &quot; &quot;;</span>
<a href="#l11.226"></a><span id="l11.226"> </span>
<a href="#l11.227"></a><span id="l11.227">   if (term.matchAll)</span>
<a href="#l11.228"></a><span id="l11.228">     condition = &quot;ALL&quot;;</span>
<a href="#l11.229"></a><span id="l11.229">   condition += (term.booleanAnd) ? &quot;AND (&quot; : &quot;OR (&quot;;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-  condition += term.termAsString + ')';</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+  condition += term.termAsString + &quot;)&quot;;</span>
<a href="#l11.232"></a><span id="l11.232">   return condition;</span>
<a href="#l11.233"></a><span id="l11.233"> }</span>
<a href="#l11.234"></a><span id="l11.234"> </span>
<a href="#l11.235"></a><span id="l11.235"> // Create a search term for searching aFolder</span>
<a href="#l11.236"></a><span id="l11.236"> //   using aAttrib, aOp, and string aStrValue</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-function makeSearchTerm(aFolder, aStrValue, aAttrib, aOp)</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-{</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+function makeSearchTerm(aFolder, aStrValue, aAttrib, aOp) {</span>
<a href="#l11.240"></a><span id="l11.240">   // use a temporary search session</span>
<a href="#l11.241"></a><span id="l11.241">   var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l11.242"></a><span id="l11.242">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l11.243"></a><span id="l11.243">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, aFolder);</span>
<a href="#l11.244"></a><span id="l11.244">   var searchTerm = searchSession.createTerm();</span>
<a href="#l11.245"></a><span id="l11.245">   var value = searchTerm.value;</span>
<a href="#l11.246"></a><span id="l11.246">   value.str = aStrValue;</span>
<a href="#l11.247"></a><span id="l11.247">   searchTerm.value = value;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug434810.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug434810.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> // Test of setup of localMailFolders</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-function run_test()</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+function run_test() {</span>
<a href="#l12.15"></a><span id="l12.15">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">   var rootFolder = localAccountUtils.incomingServer.rootFolder;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19">   var msgProps = Services.strings.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   var expectedFolders = [ &quot;Inbox&quot; ]; // Inbox hard-coded in localAccountUtils.js</span>
<a href="#l12.22"></a><span id="l12.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -12,93 +12,83 @@ var {MailServices} = ChromeUtils.import(</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> var bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l13.6"></a><span id="l13.6"> var gHdr; // header of test message in local folder</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> localAccountUtils.loadLocalMailAccount();</span>
<a href="#l13.9"></a><span id="l13.9"> // create a subfolder as a target for copies</span>
<a href="#l13.10"></a><span id="l13.10"> var gSubfolder = localAccountUtils.inboxFolder.createLocalSubfolder(&quot;subfolder&quot;);</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-function run_test()</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+function run_test() {</span>
<a href="#l13.15"></a><span id="l13.15">   // make sure we're using berkeley mailbox format here since this test</span>
<a href="#l13.16"></a><span id="l13.16">   // assumes berkeley mailbox format.</span>
<a href="#l13.17"></a><span id="l13.17">   if (Services.prefs.getCharPref(&quot;mail.serverDefaultStoreContractID&quot;) !=</span>
<a href="#l13.18"></a><span id="l13.18">       &quot;@mozilla.org/msgstore/berkeleystore;1&quot;)</span>
<a href="#l13.19"></a><span id="l13.19">     return;</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">   do_test_pending();</span>
<a href="#l13.22"></a><span id="l13.22">   // step 1: copy a message into the local inbox</span>
<a href="#l13.23"></a><span id="l13.23">   MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null,</span>
<a href="#l13.24"></a><span id="l13.24">                                     false, 0, &quot;&quot;, step2, null);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  return;</span>
<a href="#l13.26"></a><span id="l13.26"> }</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28"> // step 2: copy one message into a subfolder to establish an</span>
<a href="#l13.29"></a><span id="l13.29"> //         mbox file time and size</span>
<a href="#l13.30"></a><span id="l13.30"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-var step2 =</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-{</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-  {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+var step2 = {</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l13.41"></a><span id="l13.41">     dump(&quot;in set message key\n&quot;);</span>
<a href="#l13.42"></a><span id="l13.42">     gHdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l13.43"></a><span id="l13.43">   },</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-  {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l13.49"></a><span id="l13.49">     Assert.notEqual(gHdr, null);</span>
<a href="#l13.50"></a><span id="l13.50">     // copy the message into the subfolder</span>
<a href="#l13.51"></a><span id="l13.51">     var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.52"></a><span id="l13.52">     messages.appendElement(gHdr);</span>
<a href="#l13.53"></a><span id="l13.53">     MailServices.copy.CopyMessages(localAccountUtils.inboxFolder, messages, gSubfolder,</span>
<a href="#l13.54"></a><span id="l13.54">                                    false, step3, null, false);</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-  }</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  },</span>
<a href="#l13.57"></a><span id="l13.57"> };</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59"> // step 3: after the copy, delay to allow copy to complete and allow possible</span>
<a href="#l13.60"></a><span id="l13.60"> //         file error time</span>
<a href="#l13.61"></a><span id="l13.61"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-var step3 =</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-{</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-  {</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+var step3 = {</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l13.76"></a><span id="l13.76">     do_timeout(2000, step4);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-  }</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineminus">-}</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+  },</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+};</span>
<a href="#l13.81"></a><span id="l13.81"> </span>
<a href="#l13.82"></a><span id="l13.82"> // step 4: start a second copy</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-function step4()</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-{</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+function step4() {</span>
<a href="#l13.86"></a><span id="l13.86">   var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.87"></a><span id="l13.87">   messages.appendElement(gHdr);</span>
<a href="#l13.88"></a><span id="l13.88">   MailServices.copy.CopyMessages(localAccountUtils.inboxFolder, messages, gSubfolder,</span>
<a href="#l13.89"></a><span id="l13.89">                                  false, step5, null, false);</span>
<a href="#l13.90"></a><span id="l13.90"> }</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92"> // step 5:  actual tests of file size and date</span>
<a href="#l13.93"></a><span id="l13.93"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-var step5 =</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-{</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-  {</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+var step5 = {</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l13.108"></a><span id="l13.108">     var dbSize = gSubfolder.msgDatabase.dBFolderInfo.folderSize;</span>
<a href="#l13.109"></a><span id="l13.109">     var dbDate = gSubfolder.msgDatabase.dBFolderInfo.folderDate;</span>
<a href="#l13.110"></a><span id="l13.110">     var filePath = gSubfolder.filePath;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-    var date = parseInt(filePath.lastModifiedTime/1000);</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+    var date = parseInt(filePath.lastModifiedTime / 1000);</span>
<a href="#l13.113"></a><span id="l13.113">     var size = filePath.fileSize;</span>
<a href="#l13.114"></a><span id="l13.114">     Assert.equal(size, dbSize);</span>
<a href="#l13.115"></a><span id="l13.115">     Assert.equal(date, dbDate);</span>
<a href="#l13.116"></a><span id="l13.116">     // End of test, so release our header reference</span>
<a href="#l13.117"></a><span id="l13.117">     gHdr = null;</span>
<a href="#l13.118"></a><span id="l13.118">     do_test_finished();</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-  }</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-}</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+  },</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug514945.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug514945.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,36 +1,36 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> /*</span>
<a href="#l14.9"></a><span id="l14.9">  * Testing of GetAvailable crashes in bug 514945</span>
<a href="#l14.10"></a><span id="l14.10">  */</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-function run_test()</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-  const kValidityManager = Cc['@mozilla.org/mail/search/validityManager;1']</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+function run_test() {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+  const kValidityManager = Cc[&quot;@mozilla.org/mail/search/validityManager;1&quot;]</span>
<a href="#l14.17"></a><span id="l14.17">                              .getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">   let validityTable = kValidityManager.getTable(Ci.nsMsgSearchScope.offlineMail);</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   // When we try to access a bad value of getAvailable, it should give an error,</span>
<a href="#l14.22"></a><span id="l14.22">   //  not crash.</span>
<a href="#l14.23"></a><span id="l14.23">   let BAD_VALUE = 1000000; // some large value that is beyond the array bounds</span>
<a href="#l14.24"></a><span id="l14.24">   let haveExpectedError = false;</span>
<a href="#l14.25"></a><span id="l14.25">   try {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    let isAvailable = validityTable.getAvailable(Ci.nsMsgSearchAttrib.Subject, BAD_VALUE);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineminus">-  } catch (e) { dump('Error but no crash, this is what we want:' + e + '\n');</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-                haveExpectedError = true;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-              }</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+    validityTable.getAvailable(Ci.nsMsgSearchAttrib.Subject, BAD_VALUE);</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  } catch (e) {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    dump(&quot;Error but no crash, this is what we want:&quot; + e + &quot;\n&quot;);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+    haveExpectedError = true;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+  }</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">   Assert.ok(haveExpectedError);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-// One of the causes of this is that search term operators are not being</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-//  initialized, resulting in random values of the operator. Make sure that is</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-//  fixed.</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  // One of the causes of this is that search term operators are not being</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  // initialized, resulting in random values of the operator. Make sure that is</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+  // fixed.</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">   const kSearchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l14.46"></a><span id="l14.46">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l14.47"></a><span id="l14.47">   let searchTerm = kSearchSession.createTerm();</span>
<a href="#l14.48"></a><span id="l14.48">   Assert.equal(searchTerm.op, Ci.nsMsgSearchOp.Contains);</span>
<a href="#l14.49"></a><span id="l14.49"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/test/unit/test_compactColumnSave.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_compactColumnSave.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -30,159 +30,144 @@ Services.prefs.setCharPref(&quot;mail.serverD</span>
<a href="#l15.4"></a><span id="l15.4">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> // Globals</span>
<a href="#l15.7"></a><span id="l15.7"> var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l15.8"></a><span id="l15.8"> var gLocalFolder2;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> var gCurTestNum;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-var gMsgHdrs = new Array();</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+var gMsgHdrs = [];</span>
<a href="#l15.14"></a><span id="l15.14"> </span>
<a href="#l15.15"></a><span id="l15.15"> var PERSISTED_COLUMN_PROPERTY_NAME = &quot;columnStates&quot;;</span>
<a href="#l15.16"></a><span id="l15.16"> var columnJSON = '{&quot;threadCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;1&quot;},&quot;flaggedCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;4&quot;},&quot;attachmentCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;5&quot;},&quot;subjectCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;7&quot;},&quot;unreadButtonColHeader&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;9&quot;},&quot;senderCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;11&quot;},&quot;recipientCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;13&quot;},&quot;junkStatusCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;15&quot;},&quot;receivedCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;17&quot;},&quot;dateCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;19&quot;},&quot;statusCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;21&quot;},&quot;sizeCol&quot;:{&quot;visible&quot;:true,&quot;ordinal&quot;:&quot;23&quot;},&quot;tagsCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;25&quot;},&quot;accountCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;27&quot;},&quot;priorityCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;29&quot;},&quot;unreadCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;31&quot;},&quot;totalCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;33&quot;},&quot;locationCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;35&quot;},&quot;idCol&quot;:{&quot;visible&quot;:false,&quot;ordinal&quot;:&quot;37&quot;}}';</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> function setColumnStates(folder) {</span>
<a href="#l15.19"></a><span id="l15.19">   let msgDatabase = folder.msgDatabase;</span>
<a href="#l15.20"></a><span id="l15.20">   let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  dbFolderInfo.setCharProperty(this.PERSISTED_COLUMN_PROPERTY_NAME, columnJSON);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+  dbFolderInfo.setCharProperty(PERSISTED_COLUMN_PROPERTY_NAME, columnJSON);</span>
<a href="#l15.23"></a><span id="l15.23">   msgDatabase.Commit(Ci.nsMsgDBCommitType.kLargeCommit);</span>
<a href="#l15.24"></a><span id="l15.24"> }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> function checkPersistentState(folder) {</span>
<a href="#l15.27"></a><span id="l15.27">   let msgDatabase = folder.msgDatabase;</span>
<a href="#l15.28"></a><span id="l15.28">   let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-  let state = dbFolderInfo.getCharProperty(this.PERSISTED_COLUMN_PROPERTY_NAME);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  let state = dbFolderInfo.getCharProperty(PERSISTED_COLUMN_PROPERTY_NAME);</span>
<a href="#l15.31"></a><span id="l15.31">   Assert.equal(state, columnJSON);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l15.34"></a><span id="l15.34"> }</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-var copyListener =</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-{</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  {</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+var copyListener = {</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l15.48"></a><span id="l15.48">     try {</span>
<a href="#l15.49"></a><span id="l15.49">       let hdr = gLocalFolder2.GetMessageHeader(aKey);</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-      gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-    }</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-    catch(e) {</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+      gMsgHdrs.push({hdr, ID: hdr.messageId});</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+    } catch (e) {</span>
<a href="#l15.55"></a><span id="l15.55">       dump(&quot;SetMessageKey failed: &quot; + e + &quot;\n&quot;);</span>
<a href="#l15.56"></a><span id="l15.56">     }</span>
<a href="#l15.57"></a><span id="l15.57">   },</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l15.63"></a><span id="l15.63">     // Check: message successfully copied.</span>
<a href="#l15.64"></a><span id="l15.64">     Assert.equal(aStatus, 0);</span>
<a href="#l15.65"></a><span id="l15.65">     // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l15.66"></a><span id="l15.66">     // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l15.67"></a><span id="l15.67">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l15.68"></a><span id="l15.68">     // to return</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-  }</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+    do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  },</span>
<a href="#l15.73"></a><span id="l15.73"> };</span>
<a href="#l15.74"></a><span id="l15.74"> </span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-var urlListener =</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-{</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+var urlListener = {</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l15.80"></a><span id="l15.80">   },</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l15.83"></a><span id="l15.83">     // Check: message successfully copied.</span>
<a href="#l15.84"></a><span id="l15.84">     Assert.equal(aExitCode, 0);</span>
<a href="#l15.85"></a><span id="l15.85">     // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l15.86"></a><span id="l15.86">     // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l15.87"></a><span id="l15.87">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l15.88"></a><span id="l15.88">     // to return</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  }</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+    do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  },</span>
<a href="#l15.93"></a><span id="l15.93"> };</span>
<a href="#l15.94"></a><span id="l15.94"> </span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-{</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate) {</span>
<a href="#l15.98"></a><span id="l15.98">   MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l15.99"></a><span id="l15.99"> }</span>
<a href="#l15.100"></a><span id="l15.100"> </span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-function deleteMessages(srcFolder, items)</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-{</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+function deleteMessages(srcFolder, items) {</span>
<a href="#l15.104"></a><span id="l15.104">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l15.107"></a><span id="l15.107">     array.appendElement(item);</span>
<a href="#l15.108"></a><span id="l15.108">   });</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110">   srcFolder.deleteMessages(array, null, false, true, copyListener, true);</span>
<a href="#l15.111"></a><span id="l15.111"> }</span>
<a href="#l15.112"></a><span id="l15.112"> </span>
<a href="#l15.113"></a><span id="l15.113"> /*</span>
<a href="#l15.114"></a><span id="l15.114">  * TESTS</span>
<a href="#l15.115"></a><span id="l15.115">  */</span>
<a href="#l15.116"></a><span id="l15.116"> </span>
<a href="#l15.117"></a><span id="l15.117"> // Beware before commenting out a test -- later tests might just depend on earlier ones</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-var gTestArray =</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-[</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+var gTestArray = [</span>
<a href="#l15.121"></a><span id="l15.121">   // Copying messages from files</span>
<a href="#l15.122"></a><span id="l15.122">   function testCopyFileMessage1() { copyFileMessage(gMsgFile1, gLocalFolder2, false); },</span>
<a href="#l15.123"></a><span id="l15.123">   function testCopyFileMessage2() { copyFileMessage(gMsgFile2, gLocalFolder2, false); },</span>
<a href="#l15.124"></a><span id="l15.124">   function testCopyFileMessage3() { copyFileMessage(gMsgFile3, gLocalFolder2, true); },</span>
<a href="#l15.125"></a><span id="l15.125"> </span>
<a href="#l15.126"></a><span id="l15.126">   // Deleting messages</span>
<a href="#l15.127"></a><span id="l15.127">   function testDeleteMessages1() { // delete to trash</span>
<a href="#l15.128"></a><span id="l15.128">     deleteMessages(gLocalFolder2, [gMsgHdrs[0].hdr], false, false);</span>
<a href="#l15.129"></a><span id="l15.129">   },</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  function checkBeforeCompact()</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-  {</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  function checkBeforeCompact() {</span>
<a href="#l15.133"></a><span id="l15.133">     checkPersistentState(gLocalFolder2);</span>
<a href="#l15.134"></a><span id="l15.134">   },</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-  function compactFolder()</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-  {</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  function compactFolder() {</span>
<a href="#l15.138"></a><span id="l15.138">     gLocalFolder2.compact(urlListener, null);</span>
<a href="#l15.139"></a><span id="l15.139">   },</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-  function checkAfterCompact()</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-  {</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+  function checkAfterCompact() {</span>
<a href="#l15.143"></a><span id="l15.143">     checkPersistentState(gLocalFolder2);</span>
<a href="#l15.144"></a><span id="l15.144">   },</span>
<a href="#l15.145"></a><span id="l15.145"> ];</span>
<a href="#l15.146"></a><span id="l15.146"> </span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-function run_test()</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-{</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+function run_test() {</span>
<a href="#l15.150"></a><span id="l15.150">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l15.151"></a><span id="l15.151">   // Load up some messages so that we can copy them in later.</span>
<a href="#l15.152"></a><span id="l15.152">   gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l15.153"></a><span id="l15.153">   gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l15.154"></a><span id="l15.154">   gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l15.155"></a><span id="l15.155"> </span>
<a href="#l15.156"></a><span id="l15.156">   // Create another folder to move and copy messages around, and force initialization.</span>
<a href="#l15.157"></a><span id="l15.157">   gLocalFolder2 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;folder2&quot;);</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineminus">-  let folderName = gLocalFolder2.prettyName;</span>
<a href="#l15.159"></a><span id="l15.159">   setColumnStates(gLocalFolder2);</span>
<a href="#l15.160"></a><span id="l15.160"> </span>
<a href="#l15.161"></a><span id="l15.161">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of all the operations.</span>
<a href="#l15.162"></a><span id="l15.162">   do_test_pending();</span>
<a href="#l15.163"></a><span id="l15.163"> </span>
<a href="#l15.164"></a><span id="l15.164"> //  do_test_finished();</span>
<a href="#l15.165"></a><span id="l15.165">   // Do the test.</span>
<a href="#l15.166"></a><span id="l15.166">   doTest(1);</span>
<a href="#l15.167"></a><span id="l15.167"> }</span>
<a href="#l15.168"></a><span id="l15.168"> </span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-function doTest(test)</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-{</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-  {</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+function doTest(test) {</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+  if (test &lt;= gTestArray.length) {</span>
<a href="#l15.175"></a><span id="l15.175">     gCurTestNum = test;</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+    var testFn = gTestArray[test - 1];</span>
<a href="#l15.178"></a><span id="l15.178">     // Set a limit of 10 seconds; if the notifications haven't arrived by</span>
<a href="#l15.179"></a><span id="l15.179">     // then, there's a problem.</span>
<a href="#l15.180"></a><span id="l15.180">     do_timeout(10000, function() {</span>
<a href="#l15.181"></a><span id="l15.181">       if (gCurTestNum == test)</span>
<a href="#l15.182"></a><span id="l15.182">         do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l15.183"></a><span id="l15.183">     });</span>
<a href="#l15.184"></a><span id="l15.184">     try {</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-    testFn();</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-    } catch(ex) {dump(ex);}</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-  }</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-  else</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-  {</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+      testFn();</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+    } catch (ex) {</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+      dump(ex);</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+    }</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+  } else {</span>
<a href="#l15.195"></a><span id="l15.195">     do_test_finished(); // for the one in run_test()</span>
<a href="#l15.196"></a><span id="l15.196">   }</span>
<a href="#l15.197"></a><span id="l15.197"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/test/unit/test_compactFailure.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_compactFailure.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> const {toXPCOMArray} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l16.6"></a><span id="l16.6"> const {MockFactory} = ChromeUtils.import(&quot;resource://testing-common/mailnews/MockFactory.js&quot;);</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l16.11"></a><span id="l16.11"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l16.12"></a><span id="l16.12"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l16.16"></a><span id="l16.16">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> var gTargetFolder;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineat">@@ -17,55 +20,55 @@ logHelperAllowedErrors.push(Cr.NS_ERROR_</span>
<a href="#l16.20"></a><span id="l16.20"> logHelperAllowedErrors.push(Cr.NS_ERROR_FILE_TARGET_DOES_NOT_EXIST);</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22"> function LockedFileOutputStream() {</span>
<a href="#l16.23"></a><span id="l16.23"> }</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25"> LockedFileOutputStream.prototype = {</span>
<a href="#l16.26"></a><span id="l16.26">   QueryInterface: ChromeUtils.generateQI([Ci.nsIFileOutputStream]),</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-  init: function(file, ioFlags, perm, behaviorFlags) {</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+  init(file, ioFlags, perm, behaviorFlags) {</span>
<a href="#l16.30"></a><span id="l16.30">     throw Cr.NS_ERROR_FILE_IS_LOCKED;</span>
<a href="#l16.31"></a><span id="l16.31">   },</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-}</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+};</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35"> var MsgDBServiceFailure = {</span>
<a href="#l16.36"></a><span id="l16.36">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgDBService]),</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  openMailDBFromFile: function(file, folder, create, leaveInvalidDB) {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+  openMailDBFromFile(file, folder, create, leaveInvalidDB) {</span>
<a href="#l16.40"></a><span id="l16.40">     if (folder.name == &quot;ShouldFail&quot;)</span>
<a href="#l16.41"></a><span id="l16.41">       throw Cr.NS_ERROR_FILE_TARGET_DOES_NOT_EXIST;</span>
<a href="#l16.42"></a><span id="l16.42">     return this._genuine.openMailDBFromFile(file, folder, create, leaveInvalidDB);</span>
<a href="#l16.43"></a><span id="l16.43">   },</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-  openFolderDB: function(folder, leaveInvalidDB) {</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+  openFolderDB(folder, leaveInvalidDB) {</span>
<a href="#l16.47"></a><span id="l16.47">     return this._genuine.openFolderDB(folder, leaveInvalidDB);</span>
<a href="#l16.48"></a><span id="l16.48">   },</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  asyncOpenFolderDB: function(folder, leaveInvalidDB) {</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  asyncOpenFolderDB(folder, leaveInvalidDB) {</span>
<a href="#l16.51"></a><span id="l16.51">     return this._genuine.asyncOpenFolderDB(folder, leaveInvalidDB);</span>
<a href="#l16.52"></a><span id="l16.52">   },</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-  openMore: function(db, timeHint) {</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  openMore(db, timeHint) {</span>
<a href="#l16.55"></a><span id="l16.55">     return this._genuine.openMore(db, timeHint);</span>
<a href="#l16.56"></a><span id="l16.56">   },</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-  createNewDB: function(folder) {</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+  createNewDB(folder) {</span>
<a href="#l16.59"></a><span id="l16.59">     return this._genuine.createNewDB(folder);</span>
<a href="#l16.60"></a><span id="l16.60">   },</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  registerPendingListener: function(folder, listener) {</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  registerPendingListener(folder, listener) {</span>
<a href="#l16.63"></a><span id="l16.63">     this._genuine.registerPendingListener(folder, listener);</span>
<a href="#l16.64"></a><span id="l16.64">   },</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-  unregisterPendingListener: function(listener) {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  unregisterPendingListener(listener) {</span>
<a href="#l16.67"></a><span id="l16.67">     this._genuine.unregisterPendingListener(listener);</span>
<a href="#l16.68"></a><span id="l16.68">   },</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-  cachedDBForFolder: function(folder) {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+  cachedDBForFolder(folder) {</span>
<a href="#l16.71"></a><span id="l16.71">     return this._genuine.cachedDBFolder(folder);</span>
<a href="#l16.72"></a><span id="l16.72">   },</span>
<a href="#l16.73"></a><span id="l16.73">   get openDBs() {</span>
<a href="#l16.74"></a><span id="l16.74">     return this._genuine.oenDBs;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  }</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-}</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  },</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+};</span>
<a href="#l16.79"></a><span id="l16.79"> </span>
<a href="#l16.80"></a><span id="l16.80"> function setup_output_stream_stub() {</span>
<a href="#l16.81"></a><span id="l16.81">   gUuid = MockFactory.register(&quot;@mozilla.org/network/file-output-stream;1&quot;,</span>
<a href="#l16.82"></a><span id="l16.82">                               LockedFileOutputStream);</span>
<a href="#l16.83"></a><span id="l16.83"> }</span>
<a href="#l16.84"></a><span id="l16.84"> </span>
<a href="#l16.85"></a><span id="l16.85"> function teardown_output_stream_stub() {</span>
<a href="#l16.86"></a><span id="l16.86">   MockFactory.unregister(gUuid);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineat">@@ -120,17 +123,17 @@ function compact_with_exception(expected</span>
<a href="#l16.88"></a><span id="l16.88">   let compactor = Cc[&quot;@mozilla.org/messenger/localfoldercompactor;1&quot;]</span>
<a href="#l16.89"></a><span id="l16.89">                     .createInstance(Ci.nsIMsgFolderCompactor);</span>
<a href="#l16.90"></a><span id="l16.90">   let listener = new AsyncUrlListener(null, function(url, exitCode) {</span>
<a href="#l16.91"></a><span id="l16.91">     do_throw(&quot;This listener should not be called back.&quot;);</span>
<a href="#l16.92"></a><span id="l16.92">   });</span>
<a href="#l16.93"></a><span id="l16.93">   try {</span>
<a href="#l16.94"></a><span id="l16.94">     compactor.compact(gTargetFolder, false, listener, null);</span>
<a href="#l16.95"></a><span id="l16.95">     do_throw(&quot;nsIMsgFolderCompactor.compact did not fail.&quot;);</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-  } catch(ex) {</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+  } catch (ex) {</span>
<a href="#l16.98"></a><span id="l16.98">     Assert.equal(expectedException, ex.result);</span>
<a href="#l16.99"></a><span id="l16.99">   }</span>
<a href="#l16.100"></a><span id="l16.100"> }</span>
<a href="#l16.101"></a><span id="l16.101"> </span>
<a href="#l16.102"></a><span id="l16.102"> function test_compact_without_crash() {</span>
<a href="#l16.103"></a><span id="l16.103">   compact_with_exception(Cr.NS_ERROR_FILE_IS_LOCKED);</span>
<a href="#l16.104"></a><span id="l16.104"> }</span>
<a href="#l16.105"></a><span id="l16.105"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/test/unit/test_converterDeferredAccount.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_converterDeferredAccount.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -12,48 +12,46 @@ const {allAccountsSorted} = ChromeUtils.</span>
<a href="#l17.4"></a><span id="l17.4"> // XXX: merge into test_converter.js</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l17.9"></a><span id="l17.9">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> // No. of messages/files and folders copied.</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-var gProgressValue = 0;</span>
<a href="#l17.13"></a><span id="l17.13"> var gMsgHdrs = [];</span>
<a href="#l17.14"></a><span id="l17.14"> // {nsIMsgLocalMailFolder} folder carrying messages for the pop server.</span>
<a href="#l17.15"></a><span id="l17.15"> var gInbox;</span>
<a href="#l17.16"></a><span id="l17.16"> // {nsIMsgIncomingServer} server for first deferred pop account.</span>
<a href="#l17.17"></a><span id="l17.17"> var gServer1;</span>
<a href="#l17.18"></a><span id="l17.18"> // {nsIMsgIncomingServer} server for second deferred pop account.</span>
<a href="#l17.19"></a><span id="l17.19"> var gServer2;</span>
<a href="#l17.20"></a><span id="l17.20"> // {nsIMsgIncomingServer} server to convert.</span>
<a href="#l17.21"></a><span id="l17.21"> var gServer;</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> var copyListenerWrap = {</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l17.26"></a><span id="l17.26">     let hdr = gInbox.GetMessageHeader(aKey);</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+    gMsgHdrs.push({hdr, ID: hdr.messageId});</span>
<a href="#l17.29"></a><span id="l17.29">   },</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l17.32"></a><span id="l17.32">     // Check: message successfully copied.</span>
<a href="#l17.33"></a><span id="l17.33">     Assert.equal(aStatus, 0);</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-  }</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  },</span>
<a href="#l17.36"></a><span id="l17.36"> };</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-var EventTarget = function () {</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-  this.dispatchEvent = function (event) {</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+var EventTarget = function() {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+  this.dispatchEvent = function(event) {</span>
<a href="#l17.42"></a><span id="l17.42">     if (event.type == &quot;progress&quot;) {</span>
<a href="#l17.43"></a><span id="l17.43">       log.trace(&quot;Progress: &quot; + event.detail);</span>
<a href="#l17.44"></a><span id="l17.44">     }</span>
<a href="#l17.45"></a><span id="l17.45">   };</span>
<a href="#l17.46"></a><span id="l17.46"> };</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48" class="difflineminus">-function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-{</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate) {</span>
<a href="#l17.51"></a><span id="l17.51">   let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l17.52"></a><span id="l17.52">   MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate,</span>
<a href="#l17.53"></a><span id="l17.53">                                     0, &quot;&quot;, listener, null);</span>
<a href="#l17.54"></a><span id="l17.54">   return listener.promise;</span>
<a href="#l17.55"></a><span id="l17.55"> }</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57"> /**</span>
<a href="#l17.58"></a><span id="l17.58">  * Check that conversion worked for the given source.</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineat">@@ -62,34 +60,34 @@ function copyFileMessage(file, destFolde</span>
<a href="#l17.60"></a><span id="l17.60">  */</span>
<a href="#l17.61"></a><span id="l17.61"> function checkConversion(source, target) {</span>
<a href="#l17.62"></a><span id="l17.62">   let sourceContents = source.directoryEntries;</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64">   while (sourceContents.hasMoreElements()) {</span>
<a href="#l17.65"></a><span id="l17.65">     let sourceContent = sourceContents.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l17.66"></a><span id="l17.66">     let sourceContentName = sourceContent.leafName;</span>
<a href="#l17.67"></a><span id="l17.67">     let ext = sourceContentName.substr(-4);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-    let targetFile = FileUtils.File(OS.Path.join(target.path,sourceContentName));</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    let targetFile = FileUtils.File(OS.Path.join(target.path, sourceContentName));</span>
<a href="#l17.70"></a><span id="l17.70">     log.debug(&quot;Checking path: &quot; + targetFile.path);</span>
<a href="#l17.71"></a><span id="l17.71">     if (ext == &quot;.dat&quot;) {</span>
<a href="#l17.72"></a><span id="l17.72">       Assert.ok(targetFile.exists());</span>
<a href="#l17.73"></a><span id="l17.73">     } else if (sourceContent.isDirectory()) {</span>
<a href="#l17.74"></a><span id="l17.74">       Assert.ok(targetFile.exists());</span>
<a href="#l17.75"></a><span id="l17.75">       checkConversion(sourceContent, targetFile);</span>
<a href="#l17.76"></a><span id="l17.76">     } else if (ext != &quot;.msf&quot;) {</span>
<a href="#l17.77"></a><span id="l17.77">       Assert.ok(targetFile.exists());</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-      let cur = FileUtils.File(OS.Path.join(targetFile.path,&quot;cur&quot;));</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+      let cur = FileUtils.File(OS.Path.join(targetFile.path, &quot;cur&quot;));</span>
<a href="#l17.80"></a><span id="l17.80">       Assert.ok(cur.exists());</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-      let tmp = FileUtils.File(OS.Path.join(targetFile.path,&quot;tmp&quot;));</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+      let tmp = FileUtils.File(OS.Path.join(targetFile.path, &quot;tmp&quot;));</span>
<a href="#l17.83"></a><span id="l17.83">       Assert.ok(tmp.exists());</span>
<a href="#l17.84"></a><span id="l17.84">       if (targetFile.leafName == &quot;Inbox&quot;) {</span>
<a href="#l17.85"></a><span id="l17.85">         let curContents = cur.directoryEntries;</span>
<a href="#l17.86"></a><span id="l17.86">         let curContentsCount = 0;</span>
<a href="#l17.87"></a><span id="l17.87">         while (curContents.hasMoreElements()) {</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-          let curContent = curContents.getNext();</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+          curContents.getNext();</span>
<a href="#l17.90"></a><span id="l17.90">           curContentsCount++;</span>
<a href="#l17.91"></a><span id="l17.91">         }</span>
<a href="#l17.92"></a><span id="l17.92">         Assert.equal(curContentsCount, 1000);</span>
<a href="#l17.93"></a><span id="l17.93">       }</span>
<a href="#l17.94"></a><span id="l17.94">     }</span>
<a href="#l17.95"></a><span id="l17.95">   }</span>
<a href="#l17.96"></a><span id="l17.96"> }</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98" class="difflineat">@@ -167,13 +165,13 @@ add_task(function testMaildirConversion(</span>
<a href="#l17.99"></a><span id="l17.99">                                       new EventTarget());</span>
<a href="#l17.100"></a><span id="l17.100">   let originalRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">   pConverted.then(function(val) {</span>
<a href="#l17.103"></a><span id="l17.103">     log.debug(&quot;Conversion done: &quot; + originalRootFolder.path + &quot; =&gt; &quot; + val);</span>
<a href="#l17.104"></a><span id="l17.104">     let newRootFolder = gServer.rootFolder.filePath;</span>
<a href="#l17.105"></a><span id="l17.105">     checkConversion(originalRootFolder, newRootFolder);</span>
<a href="#l17.106"></a><span id="l17.106">     do_test_finished();</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineminus">-  }).catch (function(reason) {</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+  }).catch(function(reason) {</span>
<a href="#l17.109"></a><span id="l17.109">     log.error(&quot;Conversion failed: &quot; + reason.error);</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-    ok(false); //Fail the test!</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+    ok(false); // Fail the test!</span>
<a href="#l17.112"></a><span id="l17.112">   });</span>
<a href="#l17.113"></a><span id="l17.113"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/test/unit/test_copyChaining.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_copyChaining.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,60 +1,56 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> // Test of chaining copies between the same folders</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l18.11"></a><span id="l18.11"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l18.12"></a><span id="l18.12"> </span>
<a href="#l18.13"></a><span id="l18.13"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> var gCopySource;</span>
<a href="#l18.16"></a><span id="l18.16"> var gCopyDest;</span>
<a href="#l18.17"></a><span id="l18.17"> var gMsgEnumerator;</span>
<a href="#l18.18"></a><span id="l18.18"> var gCurTestNum = 1;</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> // main test</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-var hdrs = [];</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-var gTestArray =</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-[</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+var gTestArray = [</span>
<a href="#l18.27"></a><span id="l18.27">   function copyMsg1() {</span>
<a href="#l18.28"></a><span id="l18.28">     gMsgEnumerator = gCopySource.msgDatabase.EnumerateMessages();</span>
<a href="#l18.29"></a><span id="l18.29">     CopyNextMessage();</span>
<a href="#l18.30"></a><span id="l18.30">   },</span>
<a href="#l18.31"></a><span id="l18.31">   function copyMsg2() {</span>
<a href="#l18.32"></a><span id="l18.32">     CopyNextMessage();</span>
<a href="#l18.33"></a><span id="l18.33">   },</span>
<a href="#l18.34"></a><span id="l18.34">   function copyMsg3() {</span>
<a href="#l18.35"></a><span id="l18.35">     CopyNextMessage();</span>
<a href="#l18.36"></a><span id="l18.36">   },</span>
<a href="#l18.37"></a><span id="l18.37">   function copyMsg4() {</span>
<a href="#l18.38"></a><span id="l18.38">     CopyNextMessage();</span>
<a href="#l18.39"></a><span id="l18.39">   },</span>
<a href="#l18.40"></a><span id="l18.40"> ];</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-function CopyNextMessage()</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-{</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+function CopyNextMessage() {</span>
<a href="#l18.45"></a><span id="l18.45">   if (gMsgEnumerator.hasMoreElements()) {</span>
<a href="#l18.46"></a><span id="l18.46">     let msgHdr = gMsgEnumerator.getNext().QueryInterface(</span>
<a href="#l18.47"></a><span id="l18.47">       Ci.nsIMsgDBHdr);</span>
<a href="#l18.48"></a><span id="l18.48">     var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l18.49"></a><span id="l18.49">     messages.appendElement(msgHdr);</span>
<a href="#l18.50"></a><span id="l18.50">     MailServices.copy.CopyMessages(gCopySource, messages, gCopyDest, true,</span>
<a href="#l18.51"></a><span id="l18.51">                                    copyListener, null, false);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  } else {</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+    do_throw(&quot;TEST FAILED - out of messages&quot;);</span>
<a href="#l18.54"></a><span id="l18.54">   }</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  else</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    do_throw ('TEST FAILED - out of messages');</span>
<a href="#l18.57"></a><span id="l18.57"> }</span>
<a href="#l18.58"></a><span id="l18.58"> </span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-function run_test()</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-{</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+function run_test() {</span>
<a href="#l18.62"></a><span id="l18.62">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l18.63"></a><span id="l18.63">   let messageGenerator = new MessageGenerator();</span>
<a href="#l18.64"></a><span id="l18.64">   let scenarioFactory = new MessageScenarioFactory(messageGenerator);</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l18.67"></a><span id="l18.67">   // all the operations.</span>
<a href="#l18.68"></a><span id="l18.68">   do_test_pending();</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70" class="difflineat">@@ -64,50 +60,45 @@ function run_test()</span>
<a href="#l18.71"></a><span id="l18.71">   messages = messages.concat(scenarioFactory.directReply(10));</span>
<a href="#l18.72"></a><span id="l18.72">   gCopySource = localAccountUtils.rootFolder.createLocalSubfolder(&quot;copySource&quot;);</span>
<a href="#l18.73"></a><span id="l18.73">   addMessagesToFolder(messages, gCopySource);</span>
<a href="#l18.74"></a><span id="l18.74"> </span>
<a href="#l18.75"></a><span id="l18.75">   mailTestUtils.updateFolderAndNotify(gCopySource, doTest);</span>
<a href="#l18.76"></a><span id="l18.76">   return true;</span>
<a href="#l18.77"></a><span id="l18.77"> }</span>
<a href="#l18.78"></a><span id="l18.78"> </span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-function doTest()</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-{</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+function doTest() {</span>
<a href="#l18.82"></a><span id="l18.82">   var test = gCurTestNum;</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-  {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  if (test &lt;= gTestArray.length) {</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+    var testFn = gTestArray[test - 1];</span>
<a href="#l18.88"></a><span id="l18.88">     dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l18.89"></a><span id="l18.89"> </span>
<a href="#l18.90"></a><span id="l18.90">     try {</span>
<a href="#l18.91"></a><span id="l18.91">       testFn();</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-    } catch(ex) {</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+    } catch (ex) {</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+      do_throw(&quot;TEST FAILED &quot; + ex);</span>
<a href="#l18.96"></a><span id="l18.96">     }</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  } else {</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+    endTest();</span>
<a href="#l18.99"></a><span id="l18.99">   }</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-  else</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-    endTest();</span>
<a href="#l18.102"></a><span id="l18.102"> }</span>
<a href="#l18.103"></a><span id="l18.103"> </span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-function endTest()</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-{</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+function endTest() {</span>
<a href="#l18.107"></a><span id="l18.107">   // Cleanup, null out everything</span>
<a href="#l18.108"></a><span id="l18.108">   dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l18.109"></a><span id="l18.109">   gMsgEnumerator = null;</span>
<a href="#l18.110"></a><span id="l18.110">   do_test_finished(); // for the one in run_test()</span>
<a href="#l18.111"></a><span id="l18.111"> }</span>
<a href="#l18.112"></a><span id="l18.112"> </span>
<a href="#l18.113"></a><span id="l18.113"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-var copyListener =</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-{</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-  {</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+var copyListener = {</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l18.128"></a><span id="l18.128">     // Check: message successfully copied.</span>
<a href="#l18.129"></a><span id="l18.129">     Assert.equal(aStatus, 0);</span>
<a href="#l18.130"></a><span id="l18.130">     ++gCurTestNum;</span>
<a href="#l18.131"></a><span id="l18.131">     doTest();</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-  }</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+  },</span>
<a href="#l18.134"></a><span id="l18.134"> };</span>
<a href="#l18.135"></a><span id="l18.135"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/test/unit/test_copyThenMoveManual.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_copyThenMoveManual.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,27 +1,27 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /*</span>
<a href="#l19.5"></a><span id="l19.5">  * This file tests copy followed by a move in a single filter.</span>
<a href="#l19.6"></a><span id="l19.6">  * Tests fix from bug 448337.</span>
<a href="#l19.7"></a><span id="l19.7">  *</span>
<a href="#l19.8"></a><span id="l19.8">  * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l19.9"></a><span id="l19.9">  */</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l19.12"></a><span id="l19.12"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13"> </span>
<a href="#l19.14"></a><span id="l19.14"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> const {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> var gFiles = [&quot;../../../data/bugmail1&quot;];</span>
<a href="#l19.18"></a><span id="l19.18"> var gCopyFolder;</span>
<a href="#l19.19"></a><span id="l19.19"> var gMoveFolder;</span>
<a href="#l19.20"></a><span id="l19.20"> var gFilter; // the test filter</span>
<a href="#l19.21"></a><span id="l19.21"> var gFilterList;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-var gTestArray =</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-[</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+var gTestArray = [</span>
<a href="#l19.25"></a><span id="l19.25">   function createFilters() {</span>
<a href="#l19.26"></a><span id="l19.26">     // setup manual copy then move mail filters on the inbox</span>
<a href="#l19.27"></a><span id="l19.27">     gFilterList = localAccountUtils.incomingServer.getFilterList(null);</span>
<a href="#l19.28"></a><span id="l19.28">     gFilter = gFilterList.createFilter(&quot;copyThenMoveAll&quot;);</span>
<a href="#l19.29"></a><span id="l19.29">     let searchTerm = gFilter.createTerm();</span>
<a href="#l19.30"></a><span id="l19.30">     searchTerm.matchAll = true;</span>
<a href="#l19.31"></a><span id="l19.31">     gFilter.appendTerm(searchTerm);</span>
<a href="#l19.32"></a><span id="l19.32">     let copyAction = gFilter.createAction();</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineat">@@ -85,33 +85,30 @@ var gTestArray =</span>
<a href="#l19.34"></a><span id="l19.34">     // operation was a move</span>
<a href="#l19.35"></a><span id="l19.35">     Assert.equal(folderCount(localAccountUtils.inboxFolder), 0);</span>
<a href="#l19.36"></a><span id="l19.36">   },</span>
<a href="#l19.37"></a><span id="l19.37">   function endTest() {</span>
<a href="#l19.38"></a><span id="l19.38">     // Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l19.39"></a><span id="l19.39">     // server</span>
<a href="#l19.40"></a><span id="l19.40">     dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l19.41"></a><span id="l19.41">     gPOP3Pump = null;</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-  }</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  },</span>
<a href="#l19.44"></a><span id="l19.44"> ];</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-function folderCount(folder)</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-{</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l19.49"></a><span id="l19.49">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l19.50"></a><span id="l19.50">   let count = 0;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-  {</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l19.54"></a><span id="l19.54">     count++;</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l19.57"></a><span id="l19.57">   }</span>
<a href="#l19.58"></a><span id="l19.58">   return count;</span>
<a href="#l19.59"></a><span id="l19.59"> }</span>
<a href="#l19.60"></a><span id="l19.60"> </span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-function run_test()</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-{</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+function run_test() {</span>
<a href="#l19.64"></a><span id="l19.64">   if (!localAccountUtils.inboxFolder)</span>
<a href="#l19.65"></a><span id="l19.65">     localAccountUtils.loadLocalMailAccount();</span>
<a href="#l19.66"></a><span id="l19.66"> </span>
<a href="#l19.67"></a><span id="l19.67">   gCopyFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;CopyFolder&quot;);</span>
<a href="#l19.68"></a><span id="l19.68">   gMoveFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70">   gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l19.71"></a><span id="l19.71"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/test/unit/test_copyToInvalidDB.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_copyToInvalidDB.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,25 +1,28 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /*</span>
<a href="#l20.5"></a><span id="l20.5">  * Simple tests for copying local messages to a folder whose db is missing</span>
<a href="#l20.6"></a><span id="l20.6">  * or invalid</span>
<a href="#l20.7"></a><span id="l20.7">  */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l20.11"></a><span id="l20.11"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l20.12"></a><span id="l20.12"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l20.17"></a><span id="l20.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l20.18"></a><span id="l20.18"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l20.19"></a><span id="l20.19"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23"> var gMsg1;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-var gCurTestNum;</span>
<a href="#l20.26"></a><span id="l20.26"> var gMsgId1;</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28"> var gTestFolder, gTestFolder2;</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30"> function* setup_globals(aNextFunc) {</span>
<a href="#l20.31"></a><span id="l20.31">   var messageGenerator = new MessageGenerator();</span>
<a href="#l20.32"></a><span id="l20.32">   gMsg1 = messageGenerator.makeMessage();</span>
<a href="#l20.33"></a><span id="l20.33">   let msg2 = messageGenerator.makeMessage({inReplyTo: gMsg1});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,68 +1,66 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> /*</span>
<a href="#l21.9"></a><span id="l21.9">  * Tests nsIMessenger's detachAttachmentsWOPrompts</span>
<a href="#l21.10"></a><span id="l21.10">  */</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l21.14"></a><span id="l21.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l21.15"></a><span id="l21.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l21.16"></a><span id="l21.16"> </span>
<a href="#l21.17"></a><span id="l21.17"> // javascript mime emitter functions</span>
<a href="#l21.18"></a><span id="l21.18"> var mimeMsg = {};</span>
<a href="#l21.19"></a><span id="l21.19"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l21.20"></a><span id="l21.20"> ChromeUtils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22"> var tests = [</span>
<a href="#l21.23"></a><span id="l21.23">   startCopy,</span>
<a href="#l21.24"></a><span id="l21.24">   startMime,</span>
<a href="#l21.25"></a><span id="l21.25">   startDetach,</span>
<a href="#l21.26"></a><span id="l21.26">   testDetach,</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-]</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+];</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-function* startCopy()</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-{</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+function* startCopy() {</span>
<a href="#l21.33"></a><span id="l21.33">   // Get a message into the local filestore.</span>
<a href="#l21.34"></a><span id="l21.34">   var mailFile = do_get_file(&quot;../../../data/external-attach-test&quot;);</span>
<a href="#l21.35"></a><span id="l21.35">   MailServices.copy.CopyFileMessage(mailFile, localAccountUtils.inboxFolder, null,</span>
<a href="#l21.36"></a><span id="l21.36">                                     false, 0, &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l21.37"></a><span id="l21.37">   yield false;</span>
<a href="#l21.38"></a><span id="l21.38"> }</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40"> // process the message through mime</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-function* startMime()</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-{</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+function* startMime() {</span>
<a href="#l21.44"></a><span id="l21.44">   let msgHdr = mailTestUtils.firstMsgHdr(localAccountUtils.inboxFolder);</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">   mimeMsg.MsgHdrToMimeMessage(msgHdr, gCallbackObject, gCallbackObject.callback,</span>
<a href="#l21.47"></a><span id="l21.47">                               true /* allowDownload */);</span>
<a href="#l21.48"></a><span id="l21.48">   yield false;</span>
<a href="#l21.49"></a><span id="l21.49"> }</span>
<a href="#l21.50"></a><span id="l21.50"> </span>
<a href="#l21.51"></a><span id="l21.51"> // detach any found attachments</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineminus">-function* startDetach()</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineminus">-{</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+function* startDetach() {</span>
<a href="#l21.55"></a><span id="l21.55">   let msgHdr = mailTestUtils.firstMsgHdr(localAccountUtils.inboxFolder);</span>
<a href="#l21.56"></a><span id="l21.56">   let msgURI = msgHdr.folder.generateMessageURI(msgHdr.messageKey);</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l21.59"></a><span id="l21.59">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l21.60"></a><span id="l21.60"> </span>
<a href="#l21.61"></a><span id="l21.61">   messenger.detachAttachmentsWOPrompts(do_get_profile(), 1,</span>
<a href="#l21.62"></a><span id="l21.62">                                        [attachment.contentType], [attachment.url],</span>
<a href="#l21.63"></a><span id="l21.63">                                        [attachment.name], [msgURI], asyncUrlListener);</span>
<a href="#l21.64"></a><span id="l21.64">   yield false;</span>
<a href="#l21.65"></a><span id="l21.65"> }</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67"> // test that the detachment was successful</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-function* testDetach()</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-{</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+function* testDetach() {</span>
<a href="#l21.71"></a><span id="l21.71">   // This test seems to fail on Linux without the following delay.</span>
<a href="#l21.72"></a><span id="l21.72">   do_timeout(200, async_driver);</span>
<a href="#l21.73"></a><span id="l21.73">   yield false;</span>
<a href="#l21.74"></a><span id="l21.74">   // The message contained a file &quot;check.pdf&quot; which should</span>
<a href="#l21.75"></a><span id="l21.75">   //  now exist in the profile directory.</span>
<a href="#l21.76"></a><span id="l21.76">   let checkFile = do_get_profile().clone();</span>
<a href="#l21.77"></a><span id="l21.77">   checkFile.append(&quot;check.pdf&quot;);</span>
<a href="#l21.78"></a><span id="l21.78">   Assert.ok(checkFile.exists());</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineat">@@ -80,22 +78,21 @@ function* testDetach()</span>
<a href="#l21.80"></a><span id="l21.80"> function SaveAttachmentCallback() {</span>
<a href="#l21.81"></a><span id="l21.81">   this.attachments = null;</span>
<a href="#l21.82"></a><span id="l21.82"> }</span>
<a href="#l21.83"></a><span id="l21.83"> </span>
<a href="#l21.84"></a><span id="l21.84"> SaveAttachmentCallback.prototype = {</span>
<a href="#l21.85"></a><span id="l21.85">   callback: function saveAttachmentCallback_callback(aMsgHdr, aMimeMessage) {</span>
<a href="#l21.86"></a><span id="l21.86">     this.attachments = aMimeMessage.allAttachments;</span>
<a href="#l21.87"></a><span id="l21.87">     async_driver();</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-  }</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-}</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+  },</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+};</span>
<a href="#l21.92"></a><span id="l21.92"> var gCallbackObject = new SaveAttachmentCallback();</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94" class="difflineminus">-function run_test()</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-{</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+function run_test() {</span>
<a href="#l21.97"></a><span id="l21.97">   if (!localAccountUtils.inboxFolder)</span>
<a href="#l21.98"></a><span id="l21.98">     localAccountUtils.loadLocalMailAccount();</span>
<a href="#l21.99"></a><span id="l21.99">   async_run_tests(tests);</span>
<a href="#l21.100"></a><span id="l21.100"> }</span>
<a href="#l21.101"></a><span id="l21.101"> </span>
<a href="#l21.102"></a><span id="l21.102"> /*</span>
<a href="#l21.103"></a><span id="l21.103">  * Get the full message content.</span>
<a href="#l21.104"></a><span id="l21.104">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/test/unit/test_emptyTrash.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_emptyTrash.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -16,158 +16,143 @@</span>
<a href="#l22.4"></a><span id="l22.4">   */</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6"> // Globals</span>
<a href="#l22.7"></a><span id="l22.7"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> var gMsgFile1;</span>
<a href="#l22.10"></a><span id="l22.10"> var gLocalTrashFolder;</span>
<a href="#l22.11"></a><span id="l22.11"> var gCurTestNum;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var gMsgHdrs = new Array();</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+var gMsgHdrs = [];</span>
<a href="#l22.14"></a><span id="l22.14"> var gRootFolder;</span>
<a href="#l22.15"></a><span id="l22.15"> </span>
<a href="#l22.16"></a><span id="l22.16"> var nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-var nsIMFListener = Ci.nsIMsgFolderListener;</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-var copyListener =</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-{</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  {</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+var copyListener = {</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l22.30"></a><span id="l22.30">     let hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    gMsgHdrs.push({hdr, ID: hdr.messageId});</span>
<a href="#l22.33"></a><span id="l22.33">   },</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  {</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l22.39"></a><span id="l22.39">     // Check: message successfully copied.</span>
<a href="#l22.40"></a><span id="l22.40">     Assert.equal(aStatus, 0);</span>
<a href="#l22.41"></a><span id="l22.41">     // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l22.42"></a><span id="l22.42">     // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l22.43"></a><span id="l22.43">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l22.44"></a><span id="l22.44">     // to return</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-  }</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+    do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+  },</span>
<a href="#l22.49"></a><span id="l22.49"> };</span>
<a href="#l22.50"></a><span id="l22.50"> </span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-var urlListener =</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-{</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+var urlListener = {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l22.56"></a><span id="l22.56">   },</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l22.59"></a><span id="l22.59">     // Check: message successfully copied.</span>
<a href="#l22.60"></a><span id="l22.60">     Assert.equal(aExitCode, 0);</span>
<a href="#l22.61"></a><span id="l22.61">     // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l22.62"></a><span id="l22.62">     // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l22.63"></a><span id="l22.63">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l22.64"></a><span id="l22.64">     // to return</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-  }</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+    do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+  },</span>
<a href="#l22.69"></a><span id="l22.69"> };</span>
<a href="#l22.70"></a><span id="l22.70"> </span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-{</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate) {</span>
<a href="#l22.74"></a><span id="l22.74">   MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l22.75"></a><span id="l22.75"> }</span>
<a href="#l22.76"></a><span id="l22.76"> </span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-function deleteMessages(srcFolder, items)</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-{</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+function deleteMessages(srcFolder, items) {</span>
<a href="#l22.80"></a><span id="l22.80">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l22.83"></a><span id="l22.83">     array.appendElement(item);</span>
<a href="#l22.84"></a><span id="l22.84">   });</span>
<a href="#l22.85"></a><span id="l22.85"> </span>
<a href="#l22.86"></a><span id="l22.86">   srcFolder.deleteMessages(array, null, false, true, copyListener, true);</span>
<a href="#l22.87"></a><span id="l22.87"> }</span>
<a href="#l22.88"></a><span id="l22.88"> </span>
<a href="#l22.89"></a><span id="l22.89"> /*</span>
<a href="#l22.90"></a><span id="l22.90">  * TESTS</span>
<a href="#l22.91"></a><span id="l22.91">  */</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93"> // Beware before commenting out a test -- later tests might just depend on earlier ones</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-var gTestArray =</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-[</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+var gTestArray = [</span>
<a href="#l22.97"></a><span id="l22.97">   // Copying message from file</span>
<a href="#l22.98"></a><span id="l22.98">   function testCopyFileMessage1() {</span>
<a href="#l22.99"></a><span id="l22.99">     copyFileMessage(gMsgFile1, localAccountUtils.inboxFolder, false);</span>
<a href="#l22.100"></a><span id="l22.100">   },</span>
<a href="#l22.101"></a><span id="l22.101"> </span>
<a href="#l22.102"></a><span id="l22.102">   // Delete message</span>
<a href="#l22.103"></a><span id="l22.103">   function testDeleteMessage() { // delete to trash</span>
<a href="#l22.104"></a><span id="l22.104">     // Let's take a moment to re-initialize stuff that got moved</span>
<a href="#l22.105"></a><span id="l22.105">     let inboxDB = localAccountUtils.inboxFolder.msgDatabase;</span>
<a href="#l22.106"></a><span id="l22.106">     gMsgHdrs[0].hdr = inboxDB.getMsgHdrForMessageID(gMsgHdrs[0].ID);</span>
<a href="#l22.107"></a><span id="l22.107"> </span>
<a href="#l22.108"></a><span id="l22.108">     // Now delete the message</span>
<a href="#l22.109"></a><span id="l22.109">     deleteMessages(localAccountUtils.inboxFolder, [gMsgHdrs[0].hdr], false, false);</span>
<a href="#l22.110"></a><span id="l22.110">   },</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-  function emptyTrash()</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-  {</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+  function emptyTrash() {</span>
<a href="#l22.114"></a><span id="l22.114">     gRootFolder = localAccountUtils.incomingServer.rootMsgFolder;</span>
<a href="#l22.115"></a><span id="l22.115">     gLocalTrashFolder = gRootFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l22.116"></a><span id="l22.116">     // hold onto a db to make sure that empty trash deals with the case</span>
<a href="#l22.117"></a><span id="l22.117">     // of someone holding onto the db, but the trash folder has a null db.</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-    let gLocalTrashDB = gLocalTrashFolder.msgDatabase;</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+    let gLocalTrashDB = gLocalTrashFolder.msgDatabase; // eslint-disable-line no-unused-vars</span>
<a href="#l22.120"></a><span id="l22.120">     gLocalTrashFolder.msgDatabase = null;</span>
<a href="#l22.121"></a><span id="l22.121">     // this is synchronous</span>
<a href="#l22.122"></a><span id="l22.122">     gLocalTrashFolder.emptyTrash(null, null);</span>
<a href="#l22.123"></a><span id="l22.123">     // check that the trash folder is 0 size, that the db has a 0 message count</span>
<a href="#l22.124"></a><span id="l22.124">     // and has no messages.</span>
<a href="#l22.125"></a><span id="l22.125">     Assert.equal(0, gLocalTrashFolder.filePath.fileSize);</span>
<a href="#l22.126"></a><span id="l22.126">     Assert.equal(0, gLocalTrashFolder.msgDatabase.dBFolderInfo.numMessages);</span>
<a href="#l22.127"></a><span id="l22.127">     let enumerator = gLocalTrashFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l22.128"></a><span id="l22.128">     Assert.equal(false, enumerator.hasMoreElements());</span>
<a href="#l22.129"></a><span id="l22.129">     urlListener.OnStopRunningUrl(null, 0);</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-  }</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+  },</span>
<a href="#l22.132"></a><span id="l22.132"> ];</span>
<a href="#l22.133"></a><span id="l22.133"> </span>
<a href="#l22.134"></a><span id="l22.134"> // Our listener, which captures events.</span>
<a href="#l22.135"></a><span id="l22.135"> function gMFListener() {}</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-gMFListener.prototype =</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-{</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-  folderDeleted: function (aFolder)</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-  {</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+gMFListener.prototype = {</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+  folderDeleted(aFolder) {</span>
<a href="#l22.142"></a><span id="l22.142">     aFolder.msgDatabase = null;</span>
<a href="#l22.143"></a><span id="l22.143">   },</span>
<a href="#l22.144"></a><span id="l22.144"> };</span>
<a href="#l22.145"></a><span id="l22.145"> </span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-function run_test()</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-{</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+function run_test() {</span>
<a href="#l22.149"></a><span id="l22.149">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l22.150"></a><span id="l22.150">   // Load up a message so that we can copy it in later.</span>
<a href="#l22.151"></a><span id="l22.151">   gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l22.152"></a><span id="l22.152">   // our front end code clears the msg db when it gets told the folder for</span>
<a href="#l22.153"></a><span id="l22.153">   // an open view has been deleted - so simulate that.</span>
<a href="#l22.154"></a><span id="l22.154">   var folderDeletedListener = new gMFListener();</span>
<a href="#l22.155"></a><span id="l22.155">   MailServices.mfn.addListener(folderDeletedListener, nsIMFNService.folderDeleted);</span>
<a href="#l22.156"></a><span id="l22.156"> </span>
<a href="#l22.157"></a><span id="l22.157">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of all the operations.</span>
<a href="#l22.158"></a><span id="l22.158">   do_test_pending();</span>
<a href="#l22.159"></a><span id="l22.159"> </span>
<a href="#l22.160"></a><span id="l22.160">   // Do the test.</span>
<a href="#l22.161"></a><span id="l22.161">   doTest(1);</span>
<a href="#l22.162"></a><span id="l22.162"> }</span>
<a href="#l22.163"></a><span id="l22.163"> </span>
<a href="#l22.164"></a><span id="l22.164" class="difflineminus">-function doTest(test)</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-{</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-  {</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+function doTest(test) {</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+  if (test &lt;= gTestArray.length) {</span>
<a href="#l22.170"></a><span id="l22.170">     gCurTestNum = test;</span>
<a href="#l22.171"></a><span id="l22.171"> </span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+    var testFn = gTestArray[test - 1];</span>
<a href="#l22.174"></a><span id="l22.174">     // Set a limit of three seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-        }</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-      );</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+      if (gCurTestNum == test)</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+        do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+    });</span>
<a href="#l22.184"></a><span id="l22.184">     try {</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-    testFn();</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-    } catch(ex) {dump(ex);}</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineminus">-  }</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineminus">-  else</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineminus">-  {</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+      testFn();</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+    } catch (ex) {</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+      dump(ex);</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+    }</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+  } else {</span>
<a href="#l22.195"></a><span id="l22.195">     gMsgHdrs = null;</span>
<a href="#l22.196"></a><span id="l22.196">     do_test_finished(); // for the one in run_test()</span>
<a href="#l22.197"></a><span id="l22.197">   }</span>
<a href="#l22.198"></a><span id="l22.198"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_fix_deferred_accounts.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -3,18 +3,17 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.5"></a><span id="l23.5"> </span>
<a href="#l23.6"></a><span id="l23.6"> /**</span>
<a href="#l23.7"></a><span id="l23.7">  * This tests that we cleanup the account prefs when a pop3 account has</span>
<a href="#l23.8"></a><span id="l23.8">  * been deferred to a hidden account.</span>
<a href="#l23.9"></a><span id="l23.9">  */</span>
<a href="#l23.10"></a><span id="l23.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-function run_test()</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-{</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+function run_test() {</span>
<a href="#l23.15"></a><span id="l23.15">   // Create account prefs with a pop3 account deferred to a hidden account.</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">   Services.prefs.setCharPref(&quot;mail.account.account1.identities&quot;, &quot;id1&quot;);</span>
<a href="#l23.18"></a><span id="l23.18">   Services.prefs.setCharPref(&quot;mail.account.account1.server&quot;, &quot;server1&quot;);</span>
<a href="#l23.19"></a><span id="l23.19">   Services.prefs.setCharPref(&quot;mail.account.account2.server&quot;, &quot;server2&quot;);</span>
<a href="#l23.20"></a><span id="l23.20">   Services.prefs.setCharPref(&quot;mail.account.account4.identities&quot;, &quot;id2&quot;);</span>
<a href="#l23.21"></a><span id="l23.21">   Services.prefs.setCharPref(&quot;mail.account.account4.server&quot;, &quot;server4&quot;);</span>
<a href="#l23.22"></a><span id="l23.22">   Services.prefs.setCharPref(&quot;mail.account.account5.identities&quot;, &quot;id3&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/test/unit/test_folderCompact.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_folderCompact.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -18,146 +18,129 @@</span>
<a href="#l24.4"></a><span id="l24.4"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l24.5"></a><span id="l24.5"> const {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l24.8"></a><span id="l24.8">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> // Globals</span>
<a href="#l24.11"></a><span id="l24.11"> var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-var gMsg1ID = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l24.13"></a><span id="l24.13"> var gMsg2ID = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l24.14"></a><span id="l24.14"> var gMsg3ID = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l24.15"></a><span id="l24.15"> var gLocalFolder2;</span>
<a href="#l24.16"></a><span id="l24.16"> var gLocalFolder3;</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-var gLocalTrashFolder;</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-var gCurTestNum;</span>
<a href="#l24.19"></a><span id="l24.19"> // After a compact (or other operation), this is what we expect the</span>
<a href="#l24.20"></a><span id="l24.20"> // folder size to be.</span>
<a href="#l24.21"></a><span id="l24.21"> var gExpectedFolderSize;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-var gMsgHdrs = new Array();</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+var gMsgHdrs = [];</span>
<a href="#l24.24"></a><span id="l24.24"> var gExpectedInboxSize;</span>
<a href="#l24.25"></a><span id="l24.25"> var gExpectedFolder2Size;</span>
<a href="#l24.26"></a><span id="l24.26"> var gExpectedFolder3Size;</span>
<a href="#l24.27"></a><span id="l24.27"> var gMsgLinebreak = &quot;&quot;;</span>
<a href="#l24.28"></a><span id="l24.28"> </span>
<a href="#l24.29"></a><span id="l24.29"> // Transfer message keys between function calls.</span>
<a href="#l24.30"></a><span id="l24.30"> var gMsgKeys = [];</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-var copyListenerWrap =</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-{</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-  SetMessageKey: function(aKey)</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-  {</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+var copyListenerWrap = {</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l24.39"></a><span id="l24.39">     let hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-    gMsgHdrs.push({hdr: hdr, ID: hdr.messageId});</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+    gMsgHdrs.push({hdr, ID: hdr.messageId});</span>
<a href="#l24.42"></a><span id="l24.42">   },</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-  {</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l24.46"></a><span id="l24.46">     // Check: message successfully copied.</span>
<a href="#l24.47"></a><span id="l24.47">     Assert.equal(aStatus, 0);</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-  }</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+  },</span>
<a href="#l24.50"></a><span id="l24.50"> };</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-var urlListenerWrap =</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-{</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+var urlListenerWrap = {</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l24.57"></a><span id="l24.57">     // Check: message successfully copied.</span>
<a href="#l24.58"></a><span id="l24.58">     Assert.equal(aExitCode, 0);</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60">     if (gMsgKeys.length &gt; 0) {</span>
<a href="#l24.61"></a><span id="l24.61">       // Bug 854798: Check if the new message keys are the same as before compaction.</span>
<a href="#l24.62"></a><span id="l24.62">       let folderMsgs = gMsgKeys.folder.messages;</span>
<a href="#l24.63"></a><span id="l24.63">       // First message was deleted so skip it in the old array.</span>
<a href="#l24.64"></a><span id="l24.64">       for (let i = 1; i &lt; gMsgKeys.length; i++) {</span>
<a href="#l24.65"></a><span id="l24.65">         Assert.ok(folderMsgs.hasMoreElements());</span>
<a href="#l24.66"></a><span id="l24.66">         let header = folderMsgs.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l24.67"></a><span id="l24.67">         Assert.equal(header.messageKey, gMsgKeys[i]);</span>
<a href="#l24.68"></a><span id="l24.68">       }</span>
<a href="#l24.69"></a><span id="l24.69">       Assert.ok(!folderMsgs.hasMoreElements());</span>
<a href="#l24.70"></a><span id="l24.70">       gMsgKeys.length = 0;</span>
<a href="#l24.71"></a><span id="l24.71">     }</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-  }</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  },</span>
<a href="#l24.74"></a><span id="l24.74"> };</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-{</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate) {</span>
<a href="#l24.79"></a><span id="l24.79">   let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l24.80"></a><span id="l24.80">   MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;, listener, null);</span>
<a href="#l24.81"></a><span id="l24.81">   return listener.promise;</span>
<a href="#l24.82"></a><span id="l24.82"> }</span>
<a href="#l24.83"></a><span id="l24.83"> </span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-function copyMessages(items, isMove, srcFolder, destFolder)</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-{</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+function copyMessages(items, isMove, srcFolder, destFolder) {</span>
<a href="#l24.87"></a><span id="l24.87">   let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l24.88"></a><span id="l24.88">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l24.91"></a><span id="l24.91">     array.appendElement(item);</span>
<a href="#l24.92"></a><span id="l24.92">   });</span>
<a href="#l24.93"></a><span id="l24.93">   MailServices.copy.CopyMessages(srcFolder, array, destFolder, isMove, listener, null, true);</span>
<a href="#l24.94"></a><span id="l24.94">   return listener.promise;</span>
<a href="#l24.95"></a><span id="l24.95"> }</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97" class="difflineminus">-function deleteMessages(srcFolder, items)</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineminus">-{</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+function deleteMessages(srcFolder, items) {</span>
<a href="#l24.100"></a><span id="l24.100">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l24.102"></a><span id="l24.102" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l24.103"></a><span id="l24.103">     array.appendElement(item);</span>
<a href="#l24.104"></a><span id="l24.104">   });</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106">   let listener = new PromiseTestUtils.PromiseCopyListener(copyListenerWrap);</span>
<a href="#l24.107"></a><span id="l24.107">   srcFolder.deleteMessages(array, null, false, true, listener, true);</span>
<a href="#l24.108"></a><span id="l24.108">   return listener.promise;</span>
<a href="#l24.109"></a><span id="l24.109"> }</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-function calculateFolderSize(folder)</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-{</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+function calculateFolderSize(folder) {</span>
<a href="#l24.114"></a><span id="l24.114">   let msgDB = folder.msgDatabase;</span>
<a href="#l24.115"></a><span id="l24.115">   let enumerator = msgDB.EnumerateMessages();</span>
<a href="#l24.116"></a><span id="l24.116">   let totalSize = 0;</span>
<a href="#l24.117"></a><span id="l24.117" class="difflineminus">-  if (enumerator)</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineminus">-  {</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineplus">+  if (enumerator) {</span>
<a href="#l24.120"></a><span id="l24.120">     if (gMsgLinebreak == &quot;&quot;) {</span>
<a href="#l24.121"></a><span id="l24.121">       // Figure out what the linebreak sequence is on the platform running the tests.</span>
<a href="#l24.122"></a><span id="l24.122">       gMsgLinebreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l24.123"></a><span id="l24.123">     }</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-    {</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l24.127"></a><span id="l24.127">       var header = enumerator.getNext();</span>
<a href="#l24.128"></a><span id="l24.128">       if (header instanceof Ci.nsIMsgDBHdr)</span>
<a href="#l24.129"></a><span id="l24.129">         totalSize += header.messageSize + gMsgLinebreak.length;</span>
<a href="#l24.130"></a><span id="l24.130">     }</span>
<a href="#l24.131"></a><span id="l24.131">   }</span>
<a href="#l24.132"></a><span id="l24.132">   return totalSize;</span>
<a href="#l24.133"></a><span id="l24.133"> }</span>
<a href="#l24.134"></a><span id="l24.134"> </span>
<a href="#l24.135"></a><span id="l24.135" class="difflineminus">-function verifyMsgOffsets(folder)</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-{</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+function verifyMsgOffsets(folder) {</span>
<a href="#l24.138"></a><span id="l24.138">   let msgDB = folder.msgDatabase;</span>
<a href="#l24.139"></a><span id="l24.139">   let enumerator = msgDB.EnumerateMessages();</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-  if (enumerator)</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-  {</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineminus">-    {</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineplus">+  if (enumerator) {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l24.146"></a><span id="l24.146">       let header = enumerator.getNext();</span>
<a href="#l24.147"></a><span id="l24.147">       if (header instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l24.148"></a><span id="l24.148">         let storeToken = header.getStringProperty(&quot;storeToken&quot;);</span>
<a href="#l24.149"></a><span id="l24.149">         Assert.equal(storeToken, header.messageOffset);</span>
<a href="#l24.150"></a><span id="l24.150">       }</span>
<a href="#l24.151"></a><span id="l24.151">     }</span>
<a href="#l24.152"></a><span id="l24.152">   }</span>
<a href="#l24.153"></a><span id="l24.153"> }</span>
<a href="#l24.154"></a><span id="l24.154"> </span>
<a href="#l24.155"></a><span id="l24.155"> /*</span>
<a href="#l24.156"></a><span id="l24.156">  * TESTS</span>
<a href="#l24.157"></a><span id="l24.157">  */</span>
<a href="#l24.158"></a><span id="l24.158"> </span>
<a href="#l24.159"></a><span id="l24.159"> // Beware before commenting out a test -- later tests might just depend on earlier ones</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineminus">-var gTestArray =</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineminus">-[</span>
<a href="#l24.162"></a><span id="l24.162" class="difflineplus">+var gTestArray = [</span>
<a href="#l24.163"></a><span id="l24.163">   // Copying messages from files</span>
<a href="#l24.164"></a><span id="l24.164">   async function testCopyFileMessage1() {</span>
<a href="#l24.165"></a><span id="l24.165">     await copyFileMessage(gMsgFile1, localAccountUtils.inboxFolder, false);</span>
<a href="#l24.166"></a><span id="l24.166">   },</span>
<a href="#l24.167"></a><span id="l24.167">   async function testCopyFileMessage2() {</span>
<a href="#l24.168"></a><span id="l24.168">     await copyFileMessage(gMsgFile2, localAccountUtils.inboxFolder, false);</span>
<a href="#l24.169"></a><span id="l24.169">   },</span>
<a href="#l24.170"></a><span id="l24.170">   async function testCopyFileMessage3() {</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineat">@@ -194,18 +177,17 @@ var gTestArray =</span>
<a href="#l24.172"></a><span id="l24.172">       gMsgKeys.push(header.messageKey);</span>
<a href="#l24.173"></a><span id="l24.173">     }</span>
<a href="#l24.174"></a><span id="l24.174"> </span>
<a href="#l24.175"></a><span id="l24.175">     // Now delete the message</span>
<a href="#l24.176"></a><span id="l24.176">     await deleteMessages(gLocalFolder3, [gMsgHdrs[0].hdr], false, false);</span>
<a href="#l24.177"></a><span id="l24.177"> </span>
<a href="#l24.178"></a><span id="l24.178">     showMessages(gLocalFolder3, &quot;after deleting 1 message to trash&quot;);</span>
<a href="#l24.179"></a><span id="l24.179">   },</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-  async function compactFolder()</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-  {</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+  async function compactFolder() {</span>
<a href="#l24.183"></a><span id="l24.183">     gExpectedFolderSize = calculateFolderSize(gLocalFolder3);</span>
<a href="#l24.184"></a><span id="l24.184">     Assert.notEqual(gLocalFolder3.expungedBytes, 0);</span>
<a href="#l24.185"></a><span id="l24.185">     let listener = new PromiseTestUtils.PromiseUrlListener(urlListenerWrap);</span>
<a href="#l24.186"></a><span id="l24.186">     gLocalFolder3.compact(listener, null);</span>
<a href="#l24.187"></a><span id="l24.187">     await listener.promise;</span>
<a href="#l24.188"></a><span id="l24.188"> </span>
<a href="#l24.189"></a><span id="l24.189">     showMessages(gLocalFolder3, &quot;after compact&quot;);</span>
<a href="#l24.190"></a><span id="l24.190">   },</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineat">@@ -223,29 +205,28 @@ var gTestArray =</span>
<a href="#l24.192"></a><span id="l24.192">       gMsgKeys.push(header.messageKey);</span>
<a href="#l24.193"></a><span id="l24.193">     }</span>
<a href="#l24.194"></a><span id="l24.194"> </span>
<a href="#l24.195"></a><span id="l24.195">     // Now delete the message</span>
<a href="#l24.196"></a><span id="l24.196">     await deleteMessages(gLocalFolder2, [gMsgHdrs[0].hdr], false, false);</span>
<a href="#l24.197"></a><span id="l24.197"> </span>
<a href="#l24.198"></a><span id="l24.198">     showMessages(gLocalFolder2, &quot;after deleting 1 message&quot;);</span>
<a href="#l24.199"></a><span id="l24.199">   },</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-  async function compactAllFolders()</span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-  {</span>
<a href="#l24.202"></a><span id="l24.202" class="difflineplus">+  async function compactAllFolders() {</span>
<a href="#l24.203"></a><span id="l24.203">     gExpectedInboxSize = calculateFolderSize(localAccountUtils.inboxFolder);</span>
<a href="#l24.204"></a><span id="l24.204">     gExpectedFolder2Size = calculateFolderSize(gLocalFolder2);</span>
<a href="#l24.205"></a><span id="l24.205">     gExpectedFolder3Size = calculateFolderSize(gLocalFolder3);</span>
<a href="#l24.206"></a><span id="l24.206"> </span>
<a href="#l24.207"></a><span id="l24.207">     // Save the first message key, which will change after compact with</span>
<a href="#l24.208"></a><span id="l24.208">     // rebuild.</span>
<a href="#l24.209"></a><span id="l24.209">     let f2m2Key =</span>
<a href="#l24.210"></a><span id="l24.210">       gLocalFolder2.msgDatabase.getMsgHdrForMessageID(gMsg2ID).messageKey;</span>
<a href="#l24.211"></a><span id="l24.211"> </span>
<a href="#l24.212"></a><span id="l24.212">     // force expunged bytes count to get cached.</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-    let localFolder2ExpungedBytes = gLocalFolder2.expungedBytes;</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+    gLocalFolder2.expungedBytes;</span>
<a href="#l24.215"></a><span id="l24.215">     // mark localFolder2 as having an invalid db, and remove it</span>
<a href="#l24.216"></a><span id="l24.216">     // for good measure.</span>
<a href="#l24.217"></a><span id="l24.217">     gLocalFolder2.msgDatabase.summaryValid = false;</span>
<a href="#l24.218"></a><span id="l24.218">     gLocalFolder2.msgDatabase = null;</span>
<a href="#l24.219"></a><span id="l24.219">     gLocalFolder2.ForceDBClosed();</span>
<a href="#l24.220"></a><span id="l24.220">     let dbPath = gLocalFolder2.filePath;</span>
<a href="#l24.221"></a><span id="l24.221">     dbPath.leafName = dbPath.leafName + &quot;.msf&quot;;</span>
<a href="#l24.222"></a><span id="l24.222">     dbPath.remove(false);</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineat">@@ -258,20 +239,20 @@ var gTestArray =</span>
<a href="#l24.224"></a><span id="l24.224">                                            .messageKey;</span>
<a href="#l24.225"></a><span id="l24.225"> </span>
<a href="#l24.226"></a><span id="l24.226">     // We used to check here that the keys did not change during rebuild.</span>
<a href="#l24.227"></a><span id="l24.227">     // But that is no true in general, it was only conicidental since the</span>
<a href="#l24.228"></a><span id="l24.228">     // checked folder had never been compacted, so the key equaled the offset.</span>
<a href="#l24.229"></a><span id="l24.229">     // We do not in guarantee that, indeed after rebuild we expect the keys</span>
<a href="#l24.230"></a><span id="l24.230">     // to change.</span>
<a href="#l24.231"></a><span id="l24.231">     let checkResult = {</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineminus">-      OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineminus">-      // Check: message successfully compacted.</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-      Assert.equal(aExitCode, 0);</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineminus">-      }</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineplus">+      OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineplus">+        // Check: message successfully compacted.</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineplus">+        Assert.equal(aExitCode, 0);</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineplus">+      },</span>
<a href="#l24.240"></a><span id="l24.240">     };</span>
<a href="#l24.241"></a><span id="l24.241">     let listener = new PromiseTestUtils.PromiseUrlListener(checkResult);</span>
<a href="#l24.242"></a><span id="l24.242">     localAccountUtils.inboxFolder.compactAll(listener, null, true);</span>
<a href="#l24.243"></a><span id="l24.243">     await listener.promise;</span>
<a href="#l24.244"></a><span id="l24.244"> </span>
<a href="#l24.245"></a><span id="l24.245">     showMessages(localAccountUtils.inboxFolder, &quot;after compactAll&quot;);</span>
<a href="#l24.246"></a><span id="l24.246">     showMessages(gLocalFolder2, &quot;after compactAll&quot;);</span>
<a href="#l24.247"></a><span id="l24.247"> </span>
<a href="#l24.248"></a><span id="l24.248" class="difflineat">@@ -285,49 +266,45 @@ var gTestArray =</span>
<a href="#l24.249"></a><span id="l24.249">     let message2 = gLocalFolder2.msgDatabase.getMsgHdrForMessageID(gMsg2ID);</span>
<a href="#l24.250"></a><span id="l24.250">     Assert.ok(message2);</span>
<a href="#l24.251"></a><span id="l24.251">     Assert.ok(gLocalFolder2.msgDatabase.getMsgHdrForMessageID(gMsg3ID));</span>
<a href="#l24.252"></a><span id="l24.252"> </span>
<a href="#l24.253"></a><span id="l24.253">     // In folder2, gMsg2ID is the first message. After compact with database</span>
<a href="#l24.254"></a><span id="l24.254">     // rebuild, that key has now changed.</span>
<a href="#l24.255"></a><span id="l24.255">     Assert.notEqual(message2.messageKey, f2m2Key);</span>
<a href="#l24.256"></a><span id="l24.256">   },</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-  function lastTestCheck()</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-  {</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineplus">+  function lastTestCheck() {</span>
<a href="#l24.260"></a><span id="l24.260">     Assert.equal(gExpectedInboxSize, localAccountUtils.inboxFolder.filePath.fileSize);</span>
<a href="#l24.261"></a><span id="l24.261">     Assert.equal(gExpectedFolder2Size, gLocalFolder2.filePath.fileSize);</span>
<a href="#l24.262"></a><span id="l24.262">     Assert.equal(gExpectedFolder3Size, gLocalFolder3.filePath.fileSize);</span>
<a href="#l24.263"></a><span id="l24.263">     verifyMsgOffsets(gLocalFolder2);</span>
<a href="#l24.264"></a><span id="l24.264">     verifyMsgOffsets(gLocalFolder3);</span>
<a href="#l24.265"></a><span id="l24.265">     verifyMsgOffsets(localAccountUtils.inboxFolder);</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineminus">-  }</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineplus">+  },</span>
<a href="#l24.268"></a><span id="l24.268"> ];</span>
<a href="#l24.269"></a><span id="l24.269"> </span>
<a href="#l24.270"></a><span id="l24.270" class="difflineminus">-function run_test()</span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-{</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineplus">+function run_test() {</span>
<a href="#l24.273"></a><span id="l24.273">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l24.274"></a><span id="l24.274">   // Load up some messages so that we can copy them in later.</span>
<a href="#l24.275"></a><span id="l24.275">   gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l24.276"></a><span id="l24.276">   gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l24.277"></a><span id="l24.277">   gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l24.278"></a><span id="l24.278"> </span>
<a href="#l24.279"></a><span id="l24.279">   // Create another folder to move and copy messages around, and force initialization.</span>
<a href="#l24.280"></a><span id="l24.280">   gLocalFolder2 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;folder2&quot;);</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-  let folderName = gLocalFolder2.prettyName;</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineplus">+</span>
<a href="#l24.283"></a><span id="l24.283">   // Create a third folder for more testing.</span>
<a href="#l24.284"></a><span id="l24.284">   gLocalFolder3 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;folder3&quot;);</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineminus">-  folderName = gLocalFolder3.prettyName;</span>
<a href="#l24.286"></a><span id="l24.286"> </span>
<a href="#l24.287"></a><span id="l24.287">   gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l24.288"></a><span id="l24.288">   run_next_test();</span>
<a href="#l24.289"></a><span id="l24.289"> }</span>
<a href="#l24.290"></a><span id="l24.290"> </span>
<a href="#l24.291"></a><span id="l24.291"> // debug utility to show the key/offset/ID relationship of messages in a folder</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineminus">-function showMessages(folder, text)</span>
<a href="#l24.293"></a><span id="l24.293" class="difflineminus">-{</span>
<a href="#l24.294"></a><span id="l24.294" class="difflineplus">+function showMessages(folder, text) {</span>
<a href="#l24.295"></a><span id="l24.295">   dump(&quot;Show messages for folder &lt;&quot; + folder.name + &quot;&gt; &quot; + text + &quot;\n&quot;);</span>
<a href="#l24.296"></a><span id="l24.296">   let folderMsgs = folder.messages;</span>
<a href="#l24.297"></a><span id="l24.297">   while (folderMsgs.hasMoreElements()) {</span>
<a href="#l24.298"></a><span id="l24.298">     let header = folderMsgs.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l24.299"></a><span id="l24.299">     dump(&quot;key: &quot; + header.messageKey +</span>
<a href="#l24.300"></a><span id="l24.300">           &quot; offset: &quot; + header.messageOffset +</span>
<a href="#l24.301"></a><span id="l24.301">           &quot; ID: &quot; + header.messageId +</span>
<a href="#l24.302"></a><span id="l24.302">           &quot;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/test/unit/test_folderLookupService.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_folderLookupService.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,17 +1,15 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> /**</span>
<a href="#l25.9"></a><span id="l25.9">  * This tests that nsIFolderLookupService works according to specification.</span>
<a href="#l25.10"></a><span id="l25.10">  */</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-</span>
<a href="#l25.13"></a><span id="l25.13"> var kRootURI = &quot;mailbox://nobody@Local%20Folders&quot;;</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> function run_test() {</span>
<a href="#l25.16"></a><span id="l25.16">   let fls = Cc[&quot;@mozilla.org/mail/folder-lookup;1&quot;]</span>
<a href="#l25.17"></a><span id="l25.17">               .getService(Ci.nsIFolderLookupService);</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19">   // Make sure that the local mail account exists.</span>
<a href="#l25.20"></a><span id="l25.20">   localAccountUtils.loadLocalMailAccount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/test/unit/test_formatFileSize.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_formatFileSize.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,27 +1,29 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.5"></a><span id="l26.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.6"></a><span id="l26.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> /*</span>
<a href="#l26.9"></a><span id="l26.9">  * Tests for the formatFileSize method.</span>
<a href="#l26.10"></a><span id="l26.10">  */</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-load(&quot;../../../../mailnews/resources/logHelper.js&quot;);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-load(&quot;../../../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> var gStringBundle = Services.strings.createBundle(</span>
<a href="#l26.20"></a><span id="l26.20">   &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22"> var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l26.23"></a><span id="l26.23">                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25"> function isDigit(c) {</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-  return &quot;0123456789&quot;.indexOf(c) != -1;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+  return &quot;0123456789&quot;.includes(c);</span>
<a href="#l26.28"></a><span id="l26.28"> }</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30"> function test_formatFileSize(aArgs) {</span>
<a href="#l26.31"></a><span id="l26.31">   const strings = {  b: &quot;byteAbbreviation2&quot;,</span>
<a href="#l26.32"></a><span id="l26.32">                     kb: &quot;kiloByteAbbreviation2&quot;,</span>
<a href="#l26.33"></a><span id="l26.33">                     mb: &quot;megaByteAbbreviation2&quot;,</span>
<a href="#l26.34"></a><span id="l26.34">                     gb: &quot;gigaByteAbbreviation2&quot; };</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36" class="difflineat">@@ -37,39 +39,39 @@ function test_formatFileSize(aArgs) {</span>
<a href="#l26.37"></a><span id="l26.37">     actual = actual.substring(0, separatorPos) + &quot;.&quot; + actual.substr(separatorPos + 1);</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39">   Assert.equal(actual, expected);</span>
<a href="#l26.40"></a><span id="l26.40"> }</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42"> /* ===== Driver ===== */</span>
<a href="#l26.43"></a><span id="l26.43"> </span>
<a href="#l26.44"></a><span id="l26.44"> var test_data = [</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-  { bytes:                   0, useKB: false, mantissa:    &quot;0&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-  { bytes:                   1, useKB: false, mantissa:    &quot;1&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-  { bytes:                  10, useKB: false, mantissa:   &quot;10&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-  { bytes:                 999, useKB: false, mantissa:  &quot;999&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  { bytes:                1000, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-  { bytes:                1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-  { bytes:             10*1024, useKB: false, mantissa: &quot;10.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-  { bytes:            999*1024, useKB: false, mantissa:  &quot;999&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  { bytes:           1000*1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-  { bytes:           1024*1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  { bytes:        10*1024*1024, useKB: false, mantissa: &quot;10.0&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-  { bytes:       999*1024*1024, useKB: false, mantissa:  &quot;999&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-  { bytes:      1000*1024*1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-  { bytes:      1024*1024*1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineminus">-  { bytes:   10*1024*1024*1024, useKB: false, mantissa: &quot;10.0&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineminus">-  { bytes:  999*1024*1024*1024, useKB: false, mantissa:  &quot;999&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-  { bytes: 1000*1024*1024*1024, useKB: false, mantissa: &quot;1000&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+  { bytes:                         0, useKB: false, mantissa:    &quot;0&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+  { bytes:                         1, useKB: false, mantissa:    &quot;1&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+  { bytes:                        10, useKB: false, mantissa:   &quot;10&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineplus">+  { bytes:                       999, useKB: false, mantissa:  &quot;999&quot;, units:  &quot;b&quot; },</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  { bytes:                      1000, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+  { bytes:                      1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  { bytes:                 10 * 1024, useKB: false, mantissa: &quot;10.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+  { bytes:                999 * 1024, useKB: false, mantissa:  &quot;999&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+  { bytes:               1000 * 1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineplus">+  { bytes:               1024 * 1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  { bytes:          10 * 1024 * 1024, useKB: false, mantissa: &quot;10.0&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+  { bytes:         999 * 1024 * 1024, useKB: false, mantissa:  &quot;999&quot;, units: &quot;mb&quot; },</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+  { bytes:        1000 * 1024 * 1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  { bytes:        1024 * 1024 * 1024, useKB: false, mantissa:  &quot;1.0&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+  { bytes:   10 * 1024 * 1024 * 1024, useKB: false, mantissa: &quot;10.0&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+  { bytes:  999 * 1024 * 1024 * 1024, useKB: false, mantissa:  &quot;999&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineplus">+  { bytes: 1000 * 1024 * 1024 * 1024, useKB: false, mantissa: &quot;1000&quot;, units: &quot;gb&quot; },</span>
<a href="#l26.79"></a><span id="l26.79"> </span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-  { bytes:                   0, useKB: true,  mantissa:    &quot;0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-  { bytes:                   1, useKB: true,  mantissa:  &quot;0.1&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-  { bytes:                 500, useKB: true,  mantissa:  &quot;0.5&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineminus">-  { bytes:                 999, useKB: true,  mantissa:  &quot;1.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineplus">+  { bytes:                         0, useKB: true,  mantissa:    &quot;0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.85"></a><span id="l26.85" class="difflineplus">+  { bytes:                         1, useKB: true,  mantissa:  &quot;0.1&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineplus">+  { bytes:                       500, useKB: true,  mantissa:  &quot;0.5&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+  { bytes:                       999, useKB: true,  mantissa:  &quot;1.0&quot;, units: &quot;kb&quot; },</span>
<a href="#l26.88"></a><span id="l26.88"> ];</span>
<a href="#l26.89"></a><span id="l26.89"> </span>
<a href="#l26.90"></a><span id="l26.90"> var tests = [</span>
<a href="#l26.91"></a><span id="l26.91" class="difflineminus">-  parameterizeTest(test_formatFileSize, test_data)</span>
<a href="#l26.92"></a><span id="l26.92" class="difflineplus">+  parameterizeTest(test_formatFileSize, test_data),</span>
<a href="#l26.93"></a><span id="l26.93"> ];</span>
<a href="#l26.94"></a><span id="l26.94"> </span>
<a href="#l26.95"></a><span id="l26.95"> function run_test() {</span>
<a href="#l26.96"></a><span id="l26.96">   async_run_tests(tests);</span>
<a href="#l26.97"></a><span id="l26.97"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/test/unit/test_getMsgTextFromStream.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_getMsgTextFromStream.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -9,26 +9,29 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /**</span>
<a href="#l27.5"></a><span id="l27.5">  * Test suite for GetMsgTextFromStream.</span>
<a href="#l27.6"></a><span id="l27.6">  *</span>
<a href="#l27.7"></a><span id="l27.7">  * Currently tests: text/plain, text/html -- with tags stripped and without,</span>
<a href="#l27.8"></a><span id="l27.8">  * base64, multipart.</span>
<a href="#l27.9"></a><span id="l27.9">  * Does not currently test: quoted-printable, stripping quotes, UTF-8, small values of</span>
<a href="#l27.10"></a><span id="l27.10">  * bytesToRead.</span>
<a href="#l27.11"></a><span id="l27.11">  */</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-var kDataRoot = &quot;../../../data/&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+var kDataRoot = &quot;../../../data/&quot;;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-function create(fileName, bytes, compressQuotes, stripHTML, outContentType)</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-{</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-  return {name: fileName, bytesToRead: bytes, compressQuotes: compressQuotes, stripHTML: stripHTML,</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-          contentType: outContentType};</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+function create(fileName, bytes, compressQuotes, stripHTML, outContentType) {</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+  return {</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+    name: fileName,</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+    bytesToRead: bytes,</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+    compressQuotes,</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+    stripHTML,</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+    contentType: outContentType,</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+  };</span>
<a href="#l27.27"></a><span id="l27.27"> }</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-var gTestFiles =</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-[</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+var gTestFiles = [</span>
<a href="#l27.32"></a><span id="l27.32">   create(&quot;basic1&quot;, 1024, false, false, &quot;text/plain&quot;), // Simple plain text</span>
<a href="#l27.33"></a><span id="l27.33">   create(&quot;basic1&quot;, 1024, false, true, &quot;text/plain&quot;), // should be same as above</span>
<a href="#l27.34"></a><span id="l27.34">   create(&quot;basic2&quot;, 1024, false, false, &quot;text/html&quot;), // Simple HTML</span>
<a href="#l27.35"></a><span id="l27.35">   create(&quot;basic3&quot;, 1024, false, true, &quot;text/html&quot;), // HTML with tags stripped out</span>
<a href="#l27.36"></a><span id="l27.36">   create(&quot;basic4&quot;, 1024, false, false, &quot;text/plain&quot;), // No content type, should be assumed to be text/plain</span>
<a href="#l27.37"></a><span id="l27.37">   create(&quot;basic4&quot;, 1024, false, true, &quot;text/plain&quot;),</span>
<a href="#l27.38"></a><span id="l27.38">   create(&quot;basic5&quot;, 1024, false, false, &quot;text/plain&quot;), // HTML content in text/plain</span>
<a href="#l27.39"></a><span id="l27.39">   create(&quot;basic5&quot;, 1024, false, true, &quot;text/plain&quot;),</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineat">@@ -44,26 +47,24 @@ var gTestFiles =</span>
<a href="#l27.41"></a><span id="l27.41">   create(&quot;multipart4&quot;, 1024, false, true, &quot;text/plain&quot;),</span>
<a href="#l27.42"></a><span id="l27.42">   create(&quot;multipart-base64-1&quot;, 1024, false, false, &quot;text/plain&quot;), // base64 encoded text</span>
<a href="#l27.43"></a><span id="l27.43">   create(&quot;multipart-base64-1&quot;, 1024, false, true, &quot;text/plain&quot;),</span>
<a href="#l27.44"></a><span id="l27.44">   create(&quot;multipart-base64-2&quot;, 1024, false, false, &quot;text/html&quot;),</span>
<a href="#l27.45"></a><span id="l27.45">   create(&quot;multipart-base64-3&quot;, 1024, false, true, &quot;text/html&quot;),</span>
<a href="#l27.46"></a><span id="l27.46">   create(&quot;multipart-complex1&quot;, 1024, false, true, &quot;text/html&quot;), // Things get more complex here</span>
<a href="#l27.47"></a><span id="l27.47">   create(&quot;multipart-complex2&quot;, 1024, false, false, &quot;text/plain&quot;),</span>
<a href="#l27.48"></a><span id="l27.48">   create(&quot;multipart-complex2&quot;, 1024, false, true, &quot;text/plain&quot;),</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-]</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+];</span>
<a href="#l27.51"></a><span id="l27.51"> </span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-function run_test()</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-{</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+function run_test() {</span>
<a href="#l27.55"></a><span id="l27.55">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l27.56"></a><span id="l27.56">   var folder = localAccountUtils.incomingServer.rootMsgFolder;</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-  gTestFiles.forEach(function (test)</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-  {</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-    dump(&quot;Testing &quot;+test.name+&quot;\n&quot;);</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+  gTestFiles.forEach(function(test) {</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+    dump(&quot;Testing &quot; + test.name + &quot;\n&quot;);</span>
<a href="#l27.63"></a><span id="l27.63">     var inFile = do_get_file(kDataRoot + test.name);</span>
<a href="#l27.64"></a><span id="l27.64">     var inStream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l27.65"></a><span id="l27.65">                      .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l27.66"></a><span id="l27.66">     inStream.init(inFile, -1, -1, Ci.nsIFileInputStream.CLOSE_ON_EOF);</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68">     // Now get the message body using getMsgTextFromStream</span>
<a href="#l27.69"></a><span id="l27.69">     var contentType = {};</span>
<a href="#l27.70"></a><span id="l27.70">     var body = folder.getMsgTextFromStream(inStream, &quot;&quot;, test.bytesToRead, 65536,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/test/unit/test_headerFoldingInDatabase.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_headerFoldingInDatabase.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -6,39 +6,36 @@</span>
<a href="#l28.4"></a><span id="l28.4">  * Testing header folding in nsParseMailMessageState::ParseHeaders(),</span>
<a href="#l28.5"></a><span id="l28.5">  * see bug 1454257 and bug 1456001.</span>
<a href="#l28.6"></a><span id="l28.6">  */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> var hdr;</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-function run_test()</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-{</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+function run_test() {</span>
<a href="#l28.15"></a><span id="l28.15">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-  var copyListener =</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-  {</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-    SetMessageKey: function(aKey) {</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+  var copyListener = {</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+    SetMessageKey(aKey) {</span>
<a href="#l28.26"></a><span id="l28.26">       hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l28.27"></a><span id="l28.27">     },</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-    OnStopCopy: function(aStatus) { continueTest();}</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+    OnStopCopy(aStatus) { continueTest(); },</span>
<a href="#l28.32"></a><span id="l28.32">   };</span>
<a href="#l28.33"></a><span id="l28.33"> </span>
<a href="#l28.34"></a><span id="l28.34">   // Get a message into the local filestore.</span>
<a href="#l28.35"></a><span id="l28.35">   var message = do_get_file(&quot;../../../data/badly-folded-headers.eml&quot;);</span>
<a href="#l28.36"></a><span id="l28.36">   do_test_pending();</span>
<a href="#l28.37"></a><span id="l28.37">   MailServices.copy.CopyFileMessage(message, localAccountUtils.inboxFolder, null, false, 0,</span>
<a href="#l28.38"></a><span id="l28.38">                                     &quot;&quot;, copyListener, null);</span>
<a href="#l28.39"></a><span id="l28.39"> }</span>
<a href="#l28.40"></a><span id="l28.40"> </span>
<a href="#l28.41"></a><span id="l28.41" class="difflineminus">-function continueTest()</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineminus">-{</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+function continueTest() {</span>
<a href="#l28.44"></a><span id="l28.44">   Assert.equal(hdr.author, &quot;sender@example.com&quot;);</span>
<a href="#l28.45"></a><span id="l28.45">   Assert.equal(hdr.recipients, &quot;\&quot;Recipient  with  spaces\&quot; &lt;recipient@example.com&gt;&quot;);</span>
<a href="#l28.46"></a><span id="l28.46">   Assert.equal(hdr.subject, &quot;Badly folded headers, one line with   space   between   To and From&quot;);</span>
<a href="#l28.47"></a><span id="l28.47">   hdr = null;</span>
<a href="#l28.48"></a><span id="l28.48">   do_test_finished();</span>
<a href="#l28.49"></a><span id="l28.49"> }</span>
<a href="#l28.50"></a><span id="l28.50"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/test/unit/test_hostnameUtils.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_hostnameUtils.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -93,17 +93,17 @@ function test_IPaddresses() {</span>
<a href="#l29.4"></a><span id="l29.4">     [ true, &quot;0x7f.100.1000&quot;,                              false,    true,    true,   &quot;127.100.3.232&quot; ],</span>
<a href="#l29.5"></a><span id="l29.5">     [ true, &quot;0xff.100.1024&quot;,                              false,    false,    true,   &quot;255.100.4.0&quot; ],</span>
<a href="#l29.6"></a><span id="l29.6">     [ true, &quot;0xC0.0xA8.0x2A48&quot;,                           false,    true,    true,   &quot;192.168.42.72&quot; ],</span>
<a href="#l29.7"></a><span id="l29.7">     [ true, &quot;0xC0.0xA82A48&quot;,                              false,    true,    true,   &quot;192.168.42.72&quot; ],</span>
<a href="#l29.8"></a><span id="l29.8">     [ true, &quot;0xC0A82A48&quot;,                                 false,    true,    true,   &quot;192.168.42.72&quot; ],</span>
<a href="#l29.9"></a><span id="l29.9">     [ true, &quot;0324.062477106&quot;,                             false,    false,    true,   &quot;212.202.126.70&quot; ],</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11">     [ false, &quot;0.0.1000&quot;,                                  false,    false,    true ],</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    [ false, &quot;0324.06247710677&quot;,                          false,    false,    true ]</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+    [ false, &quot;0324.06247710677&quot;,                          false,    false,    true ],</span>
<a href="#l29.14"></a><span id="l29.14">   ];</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">   for (let item of kIPsToTest) {</span>
<a href="#l29.17"></a><span id="l29.17">     let result = null;</span>
<a href="#l29.18"></a><span id="l29.18">     let [isValid, address, isIPv6, isLocal, isExtended, wantedResult] = item;</span>
<a href="#l29.19"></a><span id="l29.19">     if (!wantedResult)</span>
<a href="#l29.20"></a><span id="l29.20">       wantedResult = isValid ? address : null;</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -168,17 +168,17 @@ function test_hostnames() {</span>
<a href="#l29.23"></a><span id="l29.23">     [ false, &quot;server.badcompany-.invalid&quot; ],</span>
<a href="#l29.24"></a><span id="l29.24">     [ false, &quot;server.bad company.invalid&quot; ],</span>
<a href="#l29.25"></a><span id="l29.25">     [ false, &quot;server.bdcompany.invalid&quot; ],</span>
<a href="#l29.26"></a><span id="l29.26">     [ false, &quot;.server.badcompany.invalid&quot; ],</span>
<a href="#l29.27"></a><span id="l29.27">     [ false, &quot;make-this-a-long-host-name-component-that-is-over-63-characters-long.invalid&quot; ],</span>
<a href="#l29.28"></a><span id="l29.28">     [ false, &quot;append-strings-to-make-this-a-too-long-host-name.that-is-really-over-255-characters-long.invalid.&quot; +</span>
<a href="#l29.29"></a><span id="l29.29">              &quot;append-strings-to-make-this-a-too-long-host-name.that-is-really-over-255-characters-long.invalid.&quot; +</span>
<a href="#l29.30"></a><span id="l29.30">              &quot;append-strings-to-make-this-a-too-long-host-name.that-is-really-over-255-characters-long.invalid.&quot; +</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-             &quot;append-strings-to-make-this-a-too-long-host-name.that-is-really-over-255-characters-long.invalid&quot; ]</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+             &quot;append-strings-to-make-this-a-too-long-host-name.that-is-really-over-255-characters-long.invalid&quot; ],</span>
<a href="#l29.33"></a><span id="l29.33">   ];</span>
<a href="#l29.34"></a><span id="l29.34"> </span>
<a href="#l29.35"></a><span id="l29.35">   for (let item of kHostsToTest) {</span>
<a href="#l29.36"></a><span id="l29.36">     let result = null;</span>
<a href="#l29.37"></a><span id="l29.37">     let [wantedResult, hostname] = item;</span>
<a href="#l29.38"></a><span id="l29.38">     wantedResult = wantedResult ? hostname : null;</span>
<a href="#l29.39"></a><span id="l29.39"> </span>
<a href="#l29.40"></a><span id="l29.40">     result = isLegalHostName(hostname);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -2,69 +2,55 @@</span>
<a href="#l30.4"></a><span id="l30.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.5"></a><span id="l30.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7"> /**</span>
<a href="#l30.8"></a><span id="l30.8">  * Simple demonstration of the imap pump test method.</span>
<a href="#l30.9"></a><span id="l30.9">  */</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11"> // async support</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l30.14"></a><span id="l30.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l30.15"></a><span id="l30.15"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l30.16"></a><span id="l30.16"> const {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18"> // IMAP pump</span>
<a href="#l30.19"></a><span id="l30.19"> var {</span>
<a href="#l30.20"></a><span id="l30.20">   IMAPPump,</span>
<a href="#l30.21"></a><span id="l30.21">   setupIMAPPump,</span>
<a href="#l30.22"></a><span id="l30.22">   teardownIMAPPump,</span>
<a href="#l30.23"></a><span id="l30.23"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l30.24"></a><span id="l30.24"> var {</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-  imapDaemon,</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-  imapMailbox,</span>
<a href="#l30.27"></a><span id="l30.27">   imapMessage,</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-  IMAP_RFC3501_handler,</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-  configurations,</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-  mixinExtension,</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-  IMAP_GMAIL_extension,</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-  IMAP_MOVE_extension,</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-  IMAP_CUSTOM_extension,</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-  IMAP_RFC2197_extension,</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-  IMAP_RFC2342_extension,</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-  IMAP_RFC3348_extension,</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineminus">-  IMAP_RFC4315_extension,</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-  IMAP_RFC5258_extension,</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-  IMAP_RFC2195_extension,</span>
<a href="#l30.40"></a><span id="l30.40"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l30.41"></a><span id="l30.41"> </span>
<a href="#l30.42"></a><span id="l30.42"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.43"></a><span id="l30.43"> var {fsDebugAll} = ChromeUtils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45"> // Globals</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47"> // Messages to load must have CRLF line endings, that is Windows style</span>
<a href="#l30.48"></a><span id="l30.48"> var gMessage = &quot;bugmail10&quot;; // message file used as the test message</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50"> // Definition of tests</span>
<a href="#l30.51"></a><span id="l30.51"> </span>
<a href="#l30.52"></a><span id="l30.52"> // load and update a message in the imap fake server</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-var gTestArray =</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-[</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+var gTestArray = [</span>
<a href="#l30.57"></a><span id="l30.57">   // initial setup of IMAP environment</span>
<a href="#l30.58"></a><span id="l30.58">   setupIMAPPump,</span>
<a href="#l30.59"></a><span id="l30.59"> </span>
<a href="#l30.60"></a><span id="l30.60">   // optionally set server parameters, here enabling debug messages</span>
<a href="#l30.61"></a><span id="l30.61">   function serverParms() {</span>
<a href="#l30.62"></a><span id="l30.62">     IMAPPump.server.setDebugLevel(fsDebugAll);</span>
<a href="#l30.63"></a><span id="l30.63">   },</span>
<a href="#l30.64"></a><span id="l30.64"> </span>
<a href="#l30.65"></a><span id="l30.65">   // the main test</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-  async function loadImapMessage()</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-  {</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+  async function loadImapMessage() {</span>
<a href="#l30.69"></a><span id="l30.69">     IMAPPump.mailbox.addMessage(</span>
<a href="#l30.70"></a><span id="l30.70">       new imapMessage(specForFileName(gMessage),</span>
<a href="#l30.71"></a><span id="l30.71">                       IMAPPump.mailbox.uidnext++, []));</span>
<a href="#l30.72"></a><span id="l30.72">     let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l30.73"></a><span id="l30.73">     IMAPPump.inbox.updateFolderWithListener(gDummyMsgWindow, promiseUrlListener);</span>
<a href="#l30.74"></a><span id="l30.74">     await promiseUrlListener.promise;</span>
<a href="#l30.75"></a><span id="l30.75"> </span>
<a href="#l30.76"></a><span id="l30.76">     Assert.equal(1, IMAPPump.inbox.getTotalMessages(false));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/test/unit/test_inheritedFolderProperties.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_inheritedFolderProperties.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,18 +1,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.5"></a><span id="l31.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.6"></a><span id="l31.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> /*</span>
<a href="#l31.9"></a><span id="l31.9">  * Testing of inherited folder properties</span>
<a href="#l31.10"></a><span id="l31.10">  */</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-function run_test()</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-{</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+function run_test() {</span>
<a href="#l31.15"></a><span id="l31.15">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l31.16"></a><span id="l31.16">   var rootFolder = localAccountUtils.incomingServer.rootMsgFolder;</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18">   // add subfolders to the inbox</span>
<a href="#l31.19"></a><span id="l31.19">   const subFolder11 = localAccountUtils.inboxFolder.createLocalSubfolder(&quot;subfolder11&quot;)</span>
<a href="#l31.20"></a><span id="l31.20">                          .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l31.21"></a><span id="l31.21">   const subFolder12 = localAccountUtils.inboxFolder.createLocalSubfolder(&quot;subfolder12&quot;)</span>
<a href="#l31.22"></a><span id="l31.22">                          .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineat">@@ -99,10 +98,9 @@ function run_test()</span>
<a href="#l31.24"></a><span id="l31.24">   // clear the global value and the root value</span>
<a href="#l31.25"></a><span id="l31.25">   Services.prefs.clearUserPref(globalPref);</span>
<a href="#l31.26"></a><span id="l31.26">   localAccountUtils.incomingServer.setCharValue(propertyName, &quot;&quot;);</span>
<a href="#l31.27"></a><span id="l31.27">   Assert.equal(rootFolder.getInheritedStringProperty(propertyName), null);</span>
<a href="#l31.28"></a><span id="l31.28">   Assert.equal(subFolder11.getInheritedStringProperty(propertyName), folderValue);</span>
<a href="#l31.29"></a><span id="l31.29">   Assert.equal(subFolder12.getInheritedStringProperty(propertyName), null);</span>
<a href="#l31.30"></a><span id="l31.30">   Assert.equal(subFolder21.getInheritedStringProperty(propertyName), folderValue2);</span>
<a href="#l31.31"></a><span id="l31.31">   Assert.equal(subFolder22.getInheritedStringProperty(propertyName), null);</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-</span>
<a href="#l31.33"></a><span id="l31.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/test/unit/test_iteratorUtils.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_iteratorUtils.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -6,17 +6,16 @@</span>
<a href="#l32.4"></a><span id="l32.4">  * Tests for iteratorUtils.jsm. Currently this tests:</span>
<a href="#l32.5"></a><span id="l32.5">  * - toArray</span>
<a href="#l32.6"></a><span id="l32.6">  * - toXPCOMArray</span>
<a href="#l32.7"></a><span id="l32.7">  * - fixIterator</span>
<a href="#l32.8"></a><span id="l32.8">  */</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> var iteratorUtils = {};</span>
<a href="#l32.11"></a><span id="l32.11"> ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, iteratorUtils);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-Cu.importGlobalProperties([&quot;DOMParser&quot;]);</span>
<a href="#l32.13"></a><span id="l32.13"> </span>
<a href="#l32.14"></a><span id="l32.14"> var gDOMParser = new DOMParser();</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16"> /**</span>
<a href="#l32.17"></a><span id="l32.17">  * Given the name of an XML file, returns the node representation of the file.</span>
<a href="#l32.18"></a><span id="l32.18">  */</span>
<a href="#l32.19"></a><span id="l32.19"> function parse_xml_file(aFileName) {</span>
<a href="#l32.20"></a><span id="l32.20">   let file = do_get_file(aFileName);</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineat">@@ -95,17 +94,17 @@ function test_fixIterator() {</span>
<a href="#l32.22"></a><span id="l32.22">     // A specific exception is the correct behaviour here.</span>
<a href="#l32.23"></a><span id="l32.23">     if (e.message == &quot;An unsupported object sent to fixIterator: [object Object]&quot;)</span>
<a href="#l32.24"></a><span id="l32.24">       thrown = true;</span>
<a href="#l32.25"></a><span id="l32.25">   }</span>
<a href="#l32.26"></a><span id="l32.26">   Assert.ok(thrown);</span>
<a href="#l32.27"></a><span id="l32.27"> </span>
<a href="#l32.28"></a><span id="l32.28">   thrown = false;</span>
<a href="#l32.29"></a><span id="l32.29">   try {</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-    let result = iteratorUtils.toXPCOMArray(tryIterate, Ci.nsIArray);</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+    iteratorUtils.toXPCOMArray(tryIterate, Ci.nsIArray);</span>
<a href="#l32.32"></a><span id="l32.32">   } catch (e) {</span>
<a href="#l32.33"></a><span id="l32.33">     // A specific exception is the correct behaviour here.</span>
<a href="#l32.34"></a><span id="l32.34">     if (e.message == &quot;An unsupported interface requested from toXPCOMArray: nsIArray&quot;)</span>
<a href="#l32.35"></a><span id="l32.35">       thrown = true;</span>
<a href="#l32.36"></a><span id="l32.36">   }</span>
<a href="#l32.37"></a><span id="l32.37">   Assert.ok(thrown);</span>
<a href="#l32.38"></a><span id="l32.38"> }</span>
<a href="#l32.39"></a><span id="l32.39"> </span>
<a href="#l32.40"></a><span id="l32.40" class="difflineat">@@ -127,33 +126,33 @@ function test_toArray_NodeList() {</span>
<a href="#l32.41"></a><span id="l32.41">     Assert.equal(node, childArray[i]);</span>
<a href="#l32.42"></a><span id="l32.42"> }</span>
<a href="#l32.43"></a><span id="l32.43"> </span>
<a href="#l32.44"></a><span id="l32.44"> /**</span>
<a href="#l32.45"></a><span id="l32.45">  * Test that toArray works correctly with the build-in generator construct.</span>
<a href="#l32.46"></a><span id="l32.46">  */</span>
<a href="#l32.47"></a><span id="l32.47"> function test_toArray_builtin_generator() {</span>
<a href="#l32.48"></a><span id="l32.48">   let arr = [11, 12, 13, 14, 15, 16, 17, 18, 19, 20];</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  let generator = function*() {</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+  let generator = function* () {</span>
<a href="#l32.51"></a><span id="l32.51">     for (let elem of arr) {</span>
<a href="#l32.52"></a><span id="l32.52">       yield elem;</span>
<a href="#l32.53"></a><span id="l32.53">     }</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-  }</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineplus">+  };</span>
<a href="#l32.56"></a><span id="l32.56">   // The resulting array should be the same as 'arr'.</span>
<a href="#l32.57"></a><span id="l32.57">   let generatorArray = iteratorUtils.toArray(generator);</span>
<a href="#l32.58"></a><span id="l32.58">   Assert.equal(arr.length, generatorArray.length);</span>
<a href="#l32.59"></a><span id="l32.59">   for (let i in arr) {</span>
<a href="#l32.60"></a><span id="l32.60">     Assert.equal(arr[i], generatorArray[i]);</span>
<a href="#l32.61"></a><span id="l32.61">   }</span>
<a href="#l32.62"></a><span id="l32.62"> </span>
<a href="#l32.63"></a><span id="l32.63">   // Bug 1126509, test that toArray rejects unknown objects.</span>
<a href="#l32.64"></a><span id="l32.64">   let thrown = false;</span>
<a href="#l32.65"></a><span id="l32.65">   let tryIterate = { item: &quot;An object, that is not supported by toArray.&quot; };</span>
<a href="#l32.66"></a><span id="l32.66">   try {</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-    let result = iteratorUtils.toArray(tryIterate);</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+    iteratorUtils.toArray(tryIterate);</span>
<a href="#l32.69"></a><span id="l32.69">   } catch (e) {</span>
<a href="#l32.70"></a><span id="l32.70">     // A specific exception is the correct behaviour here.</span>
<a href="#l32.71"></a><span id="l32.71">     if (e.message == &quot;An unsupported object sent to toArray: [object Object]&quot;)</span>
<a href="#l32.72"></a><span id="l32.72">       thrown = true;</span>
<a href="#l32.73"></a><span id="l32.73">   }</span>
<a href="#l32.74"></a><span id="l32.74">   Assert.ok(thrown);</span>
<a href="#l32.75"></a><span id="l32.75"> }</span>
<a href="#l32.76"></a><span id="l32.76"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/test/unit/test_jsTreeSelection.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_jsTreeSelection.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,30 +1,29 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.5"></a><span id="l33.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.6"></a><span id="l33.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> const {JSTreeSelection} = ChromeUtils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> var fakeView = {</span>
<a href="#l33.12"></a><span id="l33.12">   rowCount: 101,</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  selectionChanged: function() {</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+  selectionChanged() {</span>
<a href="#l33.15"></a><span id="l33.15">   },</span>
<a href="#l33.16"></a><span id="l33.16">   QueryInterface: ChromeUtils.generateQI(</span>
<a href="#l33.17"></a><span id="l33.17">     [Ci.nsITreeView]),</span>
<a href="#l33.18"></a><span id="l33.18"> };</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20"> var sel = new JSTreeSelection(null);</span>
<a href="#l33.21"></a><span id="l33.21"> sel.view = fakeView;</span>
<a href="#l33.22"></a><span id="l33.22"> </span>
<a href="#l33.23"></a><span id="l33.23"> function bad_ranges(aMsg, aExpected) {</span>
<a href="#l33.24"></a><span id="l33.24">   let s = &quot;\x1b[1;31m!!! BAD RANGES: &quot; + aMsg + &quot;\n&quot;;</span>
<a href="#l33.25"></a><span id="l33.25">   s += &quot;Selection ranges: &quot; + sel._ranges.length + &quot;:&quot;;</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-  for (let [low,high] of sel._ranges) {</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+  for (let [low, high] of sel._ranges) {</span>
<a href="#l33.28"></a><span id="l33.28">     s += &quot; &quot; + low + &quot;-&quot; + high;</span>
<a href="#l33.29"></a><span id="l33.29">   }</span>
<a href="#l33.30"></a><span id="l33.30"> </span>
<a href="#l33.31"></a><span id="l33.31">   s += &quot;\nExpected ranges: &quot; + aExpected.length + &quot;:&quot;;</span>
<a href="#l33.32"></a><span id="l33.32">   for (let i = 0; i &lt; aExpected.length; i++) {</span>
<a href="#l33.33"></a><span id="l33.33">     s += &quot; &quot; + aExpected[i][0] + &quot;-&quot; + aExpected[i][1];</span>
<a href="#l33.34"></a><span id="l33.34">   }</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36" class="difflineat">@@ -35,17 +34,17 @@ function bad_ranges(aMsg, aExpected) {</span>
<a href="#l33.37"></a><span id="l33.37"> }</span>
<a href="#l33.38"></a><span id="l33.38"> </span>
<a href="#l33.39"></a><span id="l33.39"> function assert_selection_ranges(...aArgs) {</span>
<a href="#l33.40"></a><span id="l33.40">   if (sel._ranges.length != aArgs.length)</span>
<a href="#l33.41"></a><span id="l33.41">     bad_ranges(&quot;Wrong number of ranges!&quot;, aArgs);</span>
<a href="#l33.42"></a><span id="l33.42"> </span>
<a href="#l33.43"></a><span id="l33.43">   let i = 0;</span>
<a href="#l33.44"></a><span id="l33.44">   let ourCount = 0;</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-  for (let [slow,shigh] of sel._ranges) {</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+  for (let [slow, shigh] of sel._ranges) {</span>
<a href="#l33.47"></a><span id="l33.47">     let [dlow, dhigh] = aArgs[i++];</span>
<a href="#l33.48"></a><span id="l33.48">     if (dlow != slow || dhigh != shigh)</span>
<a href="#l33.49"></a><span id="l33.49">       bad_ranges(&quot;Range mis-match on index &quot; + i, aArgs);</span>
<a href="#l33.50"></a><span id="l33.50">     ourCount += shigh - slow + 1;</span>
<a href="#l33.51"></a><span id="l33.51">   }</span>
<a href="#l33.52"></a><span id="l33.52"> </span>
<a href="#l33.53"></a><span id="l33.53">   if (ourCount != sel.count)</span>
<a href="#l33.54"></a><span id="l33.54">     bad_ranges(&quot;Count was wrong! We counted &quot; + ourCount + &quot; but they say &quot; +</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineat">@@ -80,24 +79,24 @@ function assert_not_selected(aIndex) {</span>
<a href="#l33.56"></a><span id="l33.56"> var ansel = assert_not_selected;</span>
<a href="#l33.57"></a><span id="l33.57"> </span>
<a href="#l33.58"></a><span id="l33.58"> function run_test() {</span>
<a href="#l33.59"></a><span id="l33.59">   // -- select</span>
<a href="#l33.60"></a><span id="l33.60">   sel.select(1);</span>
<a href="#l33.61"></a><span id="l33.61">   asel(1);</span>
<a href="#l33.62"></a><span id="l33.62">   ansel(0);</span>
<a href="#l33.63"></a><span id="l33.63">   ansel(2);</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-  asr([1,1]);</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+  asr([1, 1]);</span>
<a href="#l33.66"></a><span id="l33.66">   aci(1);</span>
<a href="#l33.67"></a><span id="l33.67"> </span>
<a href="#l33.68"></a><span id="l33.68">   sel.select(2);</span>
<a href="#l33.69"></a><span id="l33.69">   asel(2);</span>
<a href="#l33.70"></a><span id="l33.70">   ansel(1);</span>
<a href="#l33.71"></a><span id="l33.71">   ansel(3);</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-  asr([2,2]);</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+  asr([2, 2]);</span>
<a href="#l33.74"></a><span id="l33.74">   aci(2);</span>
<a href="#l33.75"></a><span id="l33.75"> </span>
<a href="#l33.76"></a><span id="l33.76">   // -- clearSelection</span>
<a href="#l33.77"></a><span id="l33.77">   sel.clearSelection();</span>
<a href="#l33.78"></a><span id="l33.78">   asr();</span>
<a href="#l33.79"></a><span id="l33.79">   aci(2); // should still be the same...</span>
<a href="#l33.80"></a><span id="l33.80"> </span>
<a href="#l33.81"></a><span id="l33.81">   // -- toggleSelect</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/test/unit/test_junkWhitelisting.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_junkWhitelisting.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -2,19 +2,21 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.5"></a><span id="l34.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> /*</span>
<a href="#l34.8"></a><span id="l34.8">  * Testing of junk whitelisting</span>
<a href="#l34.9"></a><span id="l34.9">  */</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11"> // add address book setup</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l34.13"></a><span id="l34.13"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l34.14"></a><span id="l34.14"> </span>
<a href="#l34.15"></a><span id="l34.15"> // add fake POP3 server driver</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l34.17"></a><span id="l34.17"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21"> /*</span>
<a href="#l34.22"></a><span id="l34.22">  * The address available in the test address book is &quot;PrimaryEmail1@test.invalid&quot;</span>
<a href="#l34.23"></a><span id="l34.23">  * Test emails may also include the address &quot;invalid@example.com&quot;</span>
<a href="#l34.24"></a><span id="l34.24">  *</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineat">@@ -25,59 +27,54 @@ var {MailServices} = ChromeUtils.import(</span>
<a href="#l34.26"></a><span id="l34.26">  *    1        3          I</span>
<a href="#l34.27"></a><span id="l34.27">  *</span>
<a href="#l34.28"></a><span id="l34.28">  */</span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30"> // indices into hdrs[] of email by domain</span>
<a href="#l34.31"></a><span id="l34.31"> var kDomainTest = 0;</span>
<a href="#l34.32"></a><span id="l34.32"> var kDomainExample = 1;</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34" class="difflineminus">-var Files =</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineminus">-[</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+var Files = [</span>
<a href="#l34.37"></a><span id="l34.37">   &quot;../../../data/bugmail1&quot;,</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-  &quot;../../../data/bugmail3&quot;</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-]</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+  &quot;../../../data/bugmail3&quot;,</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+];</span>
<a href="#l34.42"></a><span id="l34.42"> </span>
<a href="#l34.43"></a><span id="l34.43"> var hdrs = [];</span>
<a href="#l34.44"></a><span id="l34.44"> </span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-function run_test()</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-{</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+function run_test() {</span>
<a href="#l34.49"></a><span id="l34.49">   // Test setup - copy the data file into place</span>
<a href="#l34.50"></a><span id="l34.50">   var testAB = do_get_file(&quot;../../../addrbook/test/unit/data/cardForEmail.mab&quot;);</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   // Copy the file to the profile directory for a PAB (this is the personal address book)</span>
<a href="#l34.53"></a><span id="l34.53">   testAB.copyTo(do_get_profile(), kPABData.fileName);</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55">   do_test_pending();</span>
<a href="#l34.56"></a><span id="l34.56"> </span>
<a href="#l34.57"></a><span id="l34.57">   // kick off copying</span>
<a href="#l34.58"></a><span id="l34.58">   gPOP3Pump.files = Files;</span>
<a href="#l34.59"></a><span id="l34.59">   gPOP3Pump.onDone = continueTest;</span>
<a href="#l34.60"></a><span id="l34.60">   gPOP3Pump.run();</span>
<a href="#l34.61"></a><span id="l34.61"> }</span>
<a href="#l34.62"></a><span id="l34.62"> </span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-function continueTest()</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineminus">-{</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+function continueTest() {</span>
<a href="#l34.66"></a><span id="l34.66">   // get the message headers</span>
<a href="#l34.67"></a><span id="l34.67">   let headerEnum = localAccountUtils.inboxFolder.messages;</span>
<a href="#l34.68"></a><span id="l34.68">   while (headerEnum.hasMoreElements())</span>
<a href="#l34.69"></a><span id="l34.69">     hdrs.push(headerEnum.getNext().QueryInterface(Ci.nsIMsgDBHdr));</span>
<a href="#l34.70"></a><span id="l34.70"> </span>
<a href="#l34.71"></a><span id="l34.71">   // check with spam properties set on the local server</span>
<a href="#l34.72"></a><span id="l34.72">   doChecks(localAccountUtils.incomingServer);</span>
<a href="#l34.73"></a><span id="l34.73"> </span>
<a href="#l34.74"></a><span id="l34.74">   // Free our globals</span>
<a href="#l34.75"></a><span id="l34.75">   hdrs = null;</span>
<a href="#l34.76"></a><span id="l34.76">   gPOP3Pump = null;</span>
<a href="#l34.77"></a><span id="l34.77">   do_test_finished();</span>
<a href="#l34.78"></a><span id="l34.78"> }</span>
<a href="#l34.79"></a><span id="l34.79"> </span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-function doChecks(server)</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-{</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+function doChecks(server) {</span>
<a href="#l34.83"></a><span id="l34.83">   let spamSettings = server.spamSettings;</span>
<a href="#l34.84"></a><span id="l34.84"> </span>
<a href="#l34.85"></a><span id="l34.85">   // default is to use the whitelist</span>
<a href="#l34.86"></a><span id="l34.86">   Assert.ok(spamSettings.useWhiteList);</span>
<a href="#l34.87"></a><span id="l34.87"> </span>
<a href="#l34.88"></a><span id="l34.88">   // check email with the address PrimaryEmail1@test.invalid</span>
<a href="#l34.89"></a><span id="l34.89">   Assert.ok(spamSettings.checkWhiteList(hdrs[kDomainTest]));</span>
<a href="#l34.90"></a><span id="l34.90"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/test/unit/test_junkingWhenDisabled.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_junkingWhenDisabled.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,75 +1,68 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /*</span>
<a href="#l35.5"></a><span id="l35.5">  * Test that junk actions work even when the bayes filtering of incoming</span>
<a href="#l35.6"></a><span id="l35.6">  *  messages is disabled, as fixed in bug 487610. Test developed by Kent</span>
<a href="#l35.7"></a><span id="l35.7">  *  James using test_nsMsgDBView.js as a base.</span>
<a href="#l35.8"></a><span id="l35.8">  */</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l35.12"></a><span id="l35.12"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l35.13"></a><span id="l35.13"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l35.14"></a><span id="l35.14"> </span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l35.18"></a><span id="l35.18"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l35.19"></a><span id="l35.19"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l35.20"></a><span id="l35.20"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22"> const {JSTreeSelection} = ChromeUtils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l35.26"></a><span id="l35.26"> </span>
<a href="#l35.27"></a><span id="l35.27"> var nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29"> // fake objects needed to get nsMsgDBView to operate on selected messages.</span>
<a href="#l35.30"></a><span id="l35.30"> // Warning: these are partial implementations. If someone adds additional</span>
<a href="#l35.31"></a><span id="l35.31"> // calls to these objects in nsMsgDBView and friends, it will also</span>
<a href="#l35.32"></a><span id="l35.32"> // be necessary to add fake versions of those calls here.</span>
<a href="#l35.33"></a><span id="l35.33"> </span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-var gFakeView = {</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-  rowCount: 1,</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineminus">-  selectionChanged: function() {</span>
<a href="#l35.37"></a><span id="l35.37" class="difflineminus">-  },</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsITreeView]),</span>
<a href="#l35.39"></a><span id="l35.39" class="difflineminus">-};</span>
<a href="#l35.40"></a><span id="l35.40" class="difflineminus">-</span>
<a href="#l35.41"></a><span id="l35.41"> var gFakeSelection = new JSTreeSelection(null);</span>
<a href="#l35.42"></a><span id="l35.42"> </span>
<a href="#l35.43"></a><span id="l35.43"> // Items used to add messages to the folder</span>
<a href="#l35.44"></a><span id="l35.44"> </span>
<a href="#l35.45"></a><span id="l35.45"> var gMessageGenerator = new MessageGenerator();</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l35.47"></a><span id="l35.47"> </span>
<a href="#l35.48"></a><span id="l35.48"> var gLocalInboxFolder;</span>
<a href="#l35.49"></a><span id="l35.49"> var gListener;</span>
<a href="#l35.50"></a><span id="l35.50"> </span>
<a href="#l35.51"></a><span id="l35.51"> function setup_globals(aNextFunc) {</span>
<a href="#l35.52"></a><span id="l35.52">   // build up a message</span>
<a href="#l35.53"></a><span id="l35.53">   let messages = [];</span>
<a href="#l35.54"></a><span id="l35.54">   let msg1 = gMessageGenerator.makeMessage();</span>
<a href="#l35.55"></a><span id="l35.55">   messages = messages.concat([msg1]);</span>
<a href="#l35.56"></a><span id="l35.56">   let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l35.57"></a><span id="l35.57"> </span>
<a href="#l35.58"></a><span id="l35.58">   return add_sets_to_folders(gLocalInboxFolder, [msgSet]);</span>
<a href="#l35.59"></a><span id="l35.59"> }</span>
<a href="#l35.60"></a><span id="l35.60"> </span>
<a href="#l35.61"></a><span id="l35.61"> var gCommandUpdater = {</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-  {</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineplus">+  updateCommandStatus() {</span>
<a href="#l35.65"></a><span id="l35.65">     // the back end is smart and is only telling us to update command status</span>
<a href="#l35.66"></a><span id="l35.66">     // when the # of items in the selection has actually changed.</span>
<a href="#l35.67"></a><span id="l35.67">   },</span>
<a href="#l35.68"></a><span id="l35.68"> </span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-  {</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  displayMessageChanged(aFolder, aSubject, aKeywords) {</span>
<a href="#l35.72"></a><span id="l35.72">   },</span>
<a href="#l35.73"></a><span id="l35.73"> </span>
<a href="#l35.74"></a><span id="l35.74" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-  {</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+  updateNextMessageAfterDelete() {</span>
<a href="#l35.77"></a><span id="l35.77">   },</span>
<a href="#l35.78"></a><span id="l35.78" class="difflineminus">-  summarizeSelection : function() {return false;}</span>
<a href="#l35.79"></a><span id="l35.79" class="difflineplus">+  summarizeSelection() { return false; },</span>
<a href="#l35.80"></a><span id="l35.80"> };</span>
<a href="#l35.81"></a><span id="l35.81"> </span>
<a href="#l35.82"></a><span id="l35.82"> var gDBView;</span>
<a href="#l35.83"></a><span id="l35.83"> var gTreeView;</span>
<a href="#l35.84"></a><span id="l35.84"> </span>
<a href="#l35.85"></a><span id="l35.85"> var SortType = Ci.nsMsgViewSortType;</span>
<a href="#l35.86"></a><span id="l35.86"> var SortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l35.87"></a><span id="l35.87"> var ViewFlags = Ci.nsMsgViewFlagsType;</span>
<a href="#l35.88"></a><span id="l35.88" class="difflineat">@@ -96,53 +89,49 @@ var tests_for_all_views = [</span>
<a href="#l35.89"></a><span id="l35.89">   // In the proposed fix for bug 487610, the first call to junk messages</span>
<a href="#l35.90"></a><span id="l35.90">   //  only creates the junk folder, it does not actually successfully move</span>
<a href="#l35.91"></a><span id="l35.91">   //  messages. So we junk messages twice so we can really see a move. But</span>
<a href="#l35.92"></a><span id="l35.92">   //  if that gets fixed and the messages actually move on the first call,</span>
<a href="#l35.93"></a><span id="l35.93">   //  I want this test to succeed as well. So I don't actually count how</span>
<a href="#l35.94"></a><span id="l35.94">   //  many messages get moved, just that some do on the second move.</span>
<a href="#l35.95"></a><span id="l35.95">   junkMessages,</span>
<a href="#l35.96"></a><span id="l35.96">   addMessages,</span>
<a href="#l35.97"></a><span id="l35.97" class="difflineminus">-  junkMessages</span>
<a href="#l35.98"></a><span id="l35.98" class="difflineplus">+  junkMessages,</span>
<a href="#l35.99"></a><span id="l35.99"> ];</span>
<a href="#l35.100"></a><span id="l35.100"> </span>
<a href="#l35.101"></a><span id="l35.101"> function addMessages() {</span>
<a href="#l35.102"></a><span id="l35.102">   // add another message in case the first one moved</span>
<a href="#l35.103"></a><span id="l35.103">   let messages = [];</span>
<a href="#l35.104"></a><span id="l35.104">   let msg1 = gMessageGenerator.makeMessage();</span>
<a href="#l35.105"></a><span id="l35.105">   messages = messages.concat([msg1]);</span>
<a href="#l35.106"></a><span id="l35.106">   let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l35.107"></a><span id="l35.107">   return add_sets_to_folders(gLocalInboxFolder, [msgSet]);</span>
<a href="#l35.108"></a><span id="l35.108"> }</span>
<a href="#l35.109"></a><span id="l35.109"> </span>
<a href="#l35.110"></a><span id="l35.110"> function* junkMessages() {</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineminus">-</span>
<a href="#l35.112"></a><span id="l35.112">   // select and junk all messages</span>
<a href="#l35.113"></a><span id="l35.113">   gDBView.doCommand(Ci.nsMsgViewCommandType.selectAll);</span>
<a href="#l35.114"></a><span id="l35.114">   gDBView.doCommand(Ci.nsMsgViewCommandType.junk);</span>
<a href="#l35.115"></a><span id="l35.115">   yield false;</span>
<a href="#l35.116"></a><span id="l35.116"> }</span>
<a href="#l35.117"></a><span id="l35.117"> </span>
<a href="#l35.118"></a><span id="l35.118"> // Our listener, which captures events and does the real tests.</span>
<a href="#l35.119"></a><span id="l35.119"> function gMFListener() {}</span>
<a href="#l35.120"></a><span id="l35.120" class="difflineminus">-gMFListener.prototype =</span>
<a href="#l35.121"></a><span id="l35.121" class="difflineminus">-{</span>
<a href="#l35.122"></a><span id="l35.122" class="difflineplus">+gMFListener.prototype = {</span>
<a href="#l35.123"></a><span id="l35.123"> </span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineminus">-  {</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l35.127"></a><span id="l35.127">     Assert.ok(aDestFolder.getFlag(Ci.nsMsgFolderFlags.Junk));</span>
<a href="#l35.128"></a><span id="l35.128">     // I tried to test this by counting messages in the folder, didn't work.</span>
<a href="#l35.129"></a><span id="l35.129">     //  Maybe all updates are not completed yet. Anyway I do it by just</span>
<a href="#l35.130"></a><span id="l35.130">     //  making sure there is something in the destination array.</span>
<a href="#l35.131"></a><span id="l35.131">     Assert.ok(aDestMsgs.length &gt; 0);</span>
<a href="#l35.132"></a><span id="l35.132">     async_driver();</span>
<a href="#l35.133"></a><span id="l35.133">   },</span>
<a href="#l35.134"></a><span id="l35.134"> </span>
<a href="#l35.135"></a><span id="l35.135" class="difflineminus">-  folderAdded: function (aFolder)</span>
<a href="#l35.136"></a><span id="l35.136" class="difflineminus">-  {</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l35.138"></a><span id="l35.138">     // this should be a junk folder</span>
<a href="#l35.139"></a><span id="l35.139">     Assert.ok(aFolder.getFlag(Ci.nsMsgFolderFlags.Junk));</span>
<a href="#l35.140"></a><span id="l35.140">     async_driver();</span>
<a href="#l35.141"></a><span id="l35.141">   },</span>
<a href="#l35.142"></a><span id="l35.142"> </span>
<a href="#l35.143"></a><span id="l35.143"> };</span>
<a href="#l35.144"></a><span id="l35.144"> </span>
<a href="#l35.145"></a><span id="l35.145"> function run_test() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/base/test/unit/test_loadVirtualFolders.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_loadVirtualFolders.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -8,18 +8,17 @@</span>
<a href="#l36.4"></a><span id="l36.4"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> // As currently written, this test will only work with Berkeley store.</span>
<a href="#l36.7"></a><span id="l36.7"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l36.8"></a><span id="l36.8">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> // main test</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-function run_test()</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-{</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+function run_test() {</span>
<a href="#l36.15"></a><span id="l36.15">   let vfdat = do_get_file(&quot;../../../data/test_virtualFolders.dat&quot;);</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17">   vfdat.copyTo(do_get_profile(), &quot;virtualFolders.dat&quot;);</span>
<a href="#l36.18"></a><span id="l36.18">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l36.19"></a><span id="l36.19">   let localMailDir = do_get_profile().clone();</span>
<a href="#l36.20"></a><span id="l36.20">   localMailDir.append(&quot;Mail&quot;);</span>
<a href="#l36.21"></a><span id="l36.21">   localMailDir.append(&quot;Local Folders&quot;);</span>
<a href="#l36.22"></a><span id="l36.22">   localMailDir.append(&quot;unread-local&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/base/test/unit/test_mailstoreConverter.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_mailstoreConverter.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -1,19 +1,15 @@</span>
<a href="#l37.4"></a><span id="l37.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.5"></a><span id="l37.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.6"></a><span id="l37.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8" class="difflineminus">-var {FileUtils} = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l37.9"></a><span id="l37.9"> const {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineminus">-var {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineminus">-var {convertMailStoreTo, terminateWorkers} = ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-const {Log} = ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+var {convertMailStoreTo} = ChromeUtils.import(&quot;resource:///modules/mailstoreConverter.jsm&quot;);</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-var log = Log.repository.getLogger(&quot;MailStoreConverter&quot;);</span>
<a href="#l37.16"></a><span id="l37.16"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l37.17"></a><span id="l37.17">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> // Test data for round-trip test.</span>
<a href="#l37.20"></a><span id="l37.20"> let testEmails = [</span>
<a href="#l37.21"></a><span id="l37.21">   // Base64 encoded bodies.</span>
<a href="#l37.22"></a><span id="l37.22">   &quot;../../../data/01-plaintext.eml&quot;,</span>
<a href="#l37.23"></a><span id="l37.23">   &quot;../../../data/02-plaintext+attachment.eml&quot;,</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineat">@@ -169,33 +165,16 @@ async function tempDir(prefix) {</span>
<a href="#l37.25"></a><span id="l37.25">       if (!(e instanceof OS.File.Error &amp;&amp; e.becauseExists)) {</span>
<a href="#l37.26"></a><span id="l37.26">         throw e;</span>
<a href="#l37.27"></a><span id="l37.27">       }</span>
<a href="#l37.28"></a><span id="l37.28">     }</span>
<a href="#l37.29"></a><span id="l37.29">   }</span>
<a href="#l37.30"></a><span id="l37.30"> }</span>
<a href="#l37.31"></a><span id="l37.31"> </span>
<a href="#l37.32"></a><span id="l37.32"> /**</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">- * Create a temporary (and empty) file. The caller is responsible for deleting it.</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">- *</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">- * @param {String} baseName - name to base the temp filename upon</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">- *                            (eg &quot;...tmpdir/&lt;baseName&gt;-&lt;randomhexdigits&gt;&quot;)</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">- * @returns {String} full path of new file.</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">- */</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-async function tempFile(baseName) {</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-  if (!baseName) {</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-    baseName = &quot;tmp&quot;;</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-  }</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-  let tmpDir = OS.Constants.Path.tmpDir;</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-  let u = await OS.File.openUnique(OS.Path.join(tmpDir, baseName));</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-  u.file.close();</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-  return u.path;</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-}</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineminus">-/**</span>
<a href="#l37.50"></a><span id="l37.50">  * Test that messages survive unscathed in a roundtrip conversion,</span>
<a href="#l37.51"></a><span id="l37.51">  * maildir -&gt; mbox -&gt; maildir.</span>
<a href="#l37.52"></a><span id="l37.52">  * The final mailbox should have an identical set of files to the initial one,</span>
<a href="#l37.53"></a><span id="l37.53">  * albeit with different filenames.</span>
<a href="#l37.54"></a><span id="l37.54">  * Purely filesystem based.</span>
<a href="#l37.55"></a><span id="l37.55">  *</span>
<a href="#l37.56"></a><span id="l37.56">  * Would be nice to do a mbox-&gt;maildir-&gt;mbox roundtrip too, but that'd involve</span>
<a href="#l37.57"></a><span id="l37.57">  * parsing the mbox files to compare them (can't just compare mbox files because</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -2,68 +2,66 @@</span>
<a href="#l38.4"></a><span id="l38.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.5"></a><span id="l38.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> /*</span>
<a href="#l38.8"></a><span id="l38.8">  * Tests nsIMessenger's detachAttachmentsWOPrompts of Mime multi-part</span>
<a href="#l38.9"></a><span id="l38.9">  * alternative messages.</span>
<a href="#l38.10"></a><span id="l38.10">  */</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l38.14"></a><span id="l38.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l38.15"></a><span id="l38.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l38.16"></a><span id="l38.16"> </span>
<a href="#l38.17"></a><span id="l38.17"> // javascript mime emitter functions</span>
<a href="#l38.18"></a><span id="l38.18"> var mimeMsg = {};</span>
<a href="#l38.19"></a><span id="l38.19"> ChromeUtils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;, mimeMsg);</span>
<a href="#l38.20"></a><span id="l38.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l38.21"></a><span id="l38.21"> </span>
<a href="#l38.22"></a><span id="l38.22"> var tests = [</span>
<a href="#l38.23"></a><span id="l38.23">   startCopy,</span>
<a href="#l38.24"></a><span id="l38.24">   startMime,</span>
<a href="#l38.25"></a><span id="l38.25">   startDetach,</span>
<a href="#l38.26"></a><span id="l38.26">   testDetach,</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-]</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+];</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-function* startCopy()</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-{</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+function* startCopy() {</span>
<a href="#l38.33"></a><span id="l38.33">   // Get a message into the local filestore.</span>
<a href="#l38.34"></a><span id="l38.34">   let mailFile = do_get_file(&quot;../../../data/multipartmalt-detach&quot;);</span>
<a href="#l38.35"></a><span id="l38.35">   MailServices.copy.CopyFileMessage(mailFile, localAccountUtils.inboxFolder, null,</span>
<a href="#l38.36"></a><span id="l38.36">                                     false, 0, &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l38.37"></a><span id="l38.37">   yield false;</span>
<a href="#l38.38"></a><span id="l38.38"> }</span>
<a href="#l38.39"></a><span id="l38.39"> </span>
<a href="#l38.40"></a><span id="l38.40"> // process the message through mime</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-function* startMime()</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-{</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+function* startMime() {</span>
<a href="#l38.44"></a><span id="l38.44">   let msgHdr = mailTestUtils.firstMsgHdr(localAccountUtils.inboxFolder);</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46">   mimeMsg.MsgHdrToMimeMessage(msgHdr, gCallbackObject, gCallbackObject.callback,</span>
<a href="#l38.47"></a><span id="l38.47">                               true /* allowDownload */);</span>
<a href="#l38.48"></a><span id="l38.48">   yield false;</span>
<a href="#l38.49"></a><span id="l38.49"> }</span>
<a href="#l38.50"></a><span id="l38.50"> </span>
<a href="#l38.51"></a><span id="l38.51"> // detach any found attachments</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-function* startDetach()</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-{</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+function* startDetach() {</span>
<a href="#l38.55"></a><span id="l38.55">   let msgHdr = mailTestUtils.firstMsgHdr(localAccountUtils.inboxFolder);</span>
<a href="#l38.56"></a><span id="l38.56">   let msgURI = msgHdr.folder.generateMessageURI(msgHdr.messageKey);</span>
<a href="#l38.57"></a><span id="l38.57"> </span>
<a href="#l38.58"></a><span id="l38.58">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l38.59"></a><span id="l38.59">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l38.60"></a><span id="l38.60"> </span>
<a href="#l38.61"></a><span id="l38.61">   messenger.detachAttachmentsWOPrompts(do_get_profile(), 1,</span>
<a href="#l38.62"></a><span id="l38.62">                                        [attachment.contentType], [attachment.url],</span>
<a href="#l38.63"></a><span id="l38.63">                                        [attachment.name], [msgURI], asyncUrlListener);</span>
<a href="#l38.64"></a><span id="l38.64">   yield false;</span>
<a href="#l38.65"></a><span id="l38.65"> }</span>
<a href="#l38.66"></a><span id="l38.66"> </span>
<a href="#l38.67"></a><span id="l38.67"> // test that the detachment was successful</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-function* testDetach()</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-{</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+function* testDetach() {</span>
<a href="#l38.71"></a><span id="l38.71">   // This test seems to fail on Linux without the following delay.</span>
<a href="#l38.72"></a><span id="l38.72">   do_timeout(200, async_driver);</span>
<a href="#l38.73"></a><span id="l38.73">   yield false;</span>
<a href="#l38.74"></a><span id="l38.74">   // The message contained a file &quot;head_update.txt&quot; which should</span>
<a href="#l38.75"></a><span id="l38.75">   //  now exist in the profile directory.</span>
<a href="#l38.76"></a><span id="l38.76">   let checkFile = do_get_profile().clone();</span>
<a href="#l38.77"></a><span id="l38.77">   checkFile.append(&quot;head_update.txt&quot;);</span>
<a href="#l38.78"></a><span id="l38.78">   Assert.ok(checkFile.exists());</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineat">@@ -84,22 +82,21 @@ function* testDetach()</span>
<a href="#l38.80"></a><span id="l38.80"> function SaveAttachmentCallback() {</span>
<a href="#l38.81"></a><span id="l38.81">   this.attachments = null;</span>
<a href="#l38.82"></a><span id="l38.82"> }</span>
<a href="#l38.83"></a><span id="l38.83"> </span>
<a href="#l38.84"></a><span id="l38.84"> SaveAttachmentCallback.prototype = {</span>
<a href="#l38.85"></a><span id="l38.85">   callback: function saveAttachmentCallback_callback(aMsgHdr, aMimeMessage) {</span>
<a href="#l38.86"></a><span id="l38.86">     this.attachments = aMimeMessage.allAttachments;</span>
<a href="#l38.87"></a><span id="l38.87">     async_driver();</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-  }</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-}</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+  },</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineplus">+};</span>
<a href="#l38.92"></a><span id="l38.92"> var gCallbackObject = new SaveAttachmentCallback();</span>
<a href="#l38.93"></a><span id="l38.93"> </span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-function run_test()</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-{</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineplus">+function run_test() {</span>
<a href="#l38.97"></a><span id="l38.97">   if (!localAccountUtils.inboxFolder)</span>
<a href="#l38.98"></a><span id="l38.98">     localAccountUtils.loadLocalMailAccount();</span>
<a href="#l38.99"></a><span id="l38.99">   async_run_tests(tests);</span>
<a href="#l38.100"></a><span id="l38.100"> }</span>
<a href="#l38.101"></a><span id="l38.101"> </span>
<a href="#l38.102"></a><span id="l38.102"> /*</span>
<a href="#l38.103"></a><span id="l38.103">  * Get the full message content.</span>
<a href="#l38.104"></a><span id="l38.104">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/base/test/unit/test_newMailNotification.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_newMailNotification.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -65,51 +65,47 @@ add_test(function testMultiListeners() {</span>
<a href="#l39.4"></a><span id="l39.4"> });</span>
<a href="#l39.5"></a><span id="l39.5"> </span>
<a href="#l39.6"></a><span id="l39.6"> var countInboxesPref = &quot;mail.notification.count.inbox_only&quot;;</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> /* Make sure we get a notification call when the unread count changes on an Inbox */</span>
<a href="#l39.9"></a><span id="l39.9"> add_test(function testNotifyInbox() {</span>
<a href="#l39.10"></a><span id="l39.10">   let notified = false;</span>
<a href="#l39.11"></a><span id="l39.11">   let mockListener = {</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-    onCountChanged: function TNU_onCountChanged(count) {notified = true;}</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+    onCountChanged: function TNU_onCountChanged(count) { notified = true; },</span>
<a href="#l39.14"></a><span id="l39.14">   };</span>
<a href="#l39.15"></a><span id="l39.15">   let folder = {</span>
<a href="#l39.16"></a><span id="l39.16">     URI: &quot;Test Inbox&quot;,</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-    flags: Ci.nsMsgFolderFlags.Mail | Ci.nsMsgFolderFlags.Inbox</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+    flags: Ci.nsMsgFolderFlags.Mail | Ci.nsMsgFolderFlags.Inbox,</span>
<a href="#l39.19"></a><span id="l39.19">   };</span>
<a href="#l39.20"></a><span id="l39.20"> </span>
<a href="#l39.21"></a><span id="l39.21">   let notif = MailServices.newMailNotification.wrappedJSObject;</span>
<a href="#l39.22"></a><span id="l39.22">   notif.addListener(mockListener, iNMNS.count);</span>
<a href="#l39.23"></a><span id="l39.23"> </span>
<a href="#l39.24"></a><span id="l39.24">   notif.OnItemIntPropertyChanged(folder, &quot;TotalUnreadMessages&quot;, 0, 2);</span>
<a href="#l39.25"></a><span id="l39.25">   Assert.ok(notified);</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27">   // Special folders should never count</span>
<a href="#l39.28"></a><span id="l39.28">   let special = {</span>
<a href="#l39.29"></a><span id="l39.29">     URI: &quot;Test Special&quot;,</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-    flags: Ci.nsMsgFolderFlags.Mail | Ci.nsMsgFolderFlags.Junk</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+    flags: Ci.nsMsgFolderFlags.Mail | Ci.nsMsgFolderFlags.Junk,</span>
<a href="#l39.32"></a><span id="l39.32">   };</span>
<a href="#l39.33"></a><span id="l39.33">   notified = false;</span>
<a href="#l39.34"></a><span id="l39.34">   notif.OnItemIntPropertyChanged(special, &quot;TotalUnreadMessages&quot;, 0, 2);</span>
<a href="#l39.35"></a><span id="l39.35">   Assert.ok(!notified);</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37">   // by default, non-inbox should not count</span>
<a href="#l39.38"></a><span id="l39.38">   let nonInbox = {</span>
<a href="#l39.39"></a><span id="l39.39">     URI: &quot;Test Non-Inbox&quot;,</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-    flags: Ci.nsMsgFolderFlags.Mail</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+    flags: Ci.nsMsgFolderFlags.Mail,</span>
<a href="#l39.42"></a><span id="l39.42">   };</span>
<a href="#l39.43"></a><span id="l39.43">   notified = false;</span>
<a href="#l39.44"></a><span id="l39.44">   notif.OnItemIntPropertyChanged(nonInbox, &quot;TotalUnreadMessages&quot;, 0, 2);</span>
<a href="#l39.45"></a><span id="l39.45">   Assert.ok(!notified);</span>
<a href="#l39.46"></a><span id="l39.46"> </span>
<a href="#l39.47"></a><span id="l39.47">   // Try setting the pref to count non-inboxes and notifying a non-inbox</span>
<a href="#l39.48"></a><span id="l39.48">   Services.prefs.setBoolPref(countInboxesPref, false);</span>
<a href="#l39.49"></a><span id="l39.49">   notified = false;</span>
<a href="#l39.50"></a><span id="l39.50">   notif.OnItemIntPropertyChanged(nonInbox, &quot;TotalUnreadMessages&quot;, 0, 2);</span>
<a href="#l39.51"></a><span id="l39.51">   Assert.ok(notified);</span>
<a href="#l39.52"></a><span id="l39.52"> </span>
<a href="#l39.53"></a><span id="l39.53">   run_next_test();</span>
<a href="#l39.54"></a><span id="l39.54"> });</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineminus">-</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineminus">-function run_test() {</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineminus">-  run_next_test();</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIFolderListener.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIFolderListener.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,45 +1,49 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /*</span>
<a href="#l40.5"></a><span id="l40.5">  * Test that adding nsIFolderListener in js does not cause any crash.</span>
<a href="#l40.6"></a><span id="l40.6">  */</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l40.14"></a><span id="l40.14"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l40.15"></a><span id="l40.15"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l40.16"></a><span id="l40.16"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l40.17"></a><span id="l40.17"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l40.18"></a><span id="l40.18"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20"> var folderListener = {</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-  OnItemAdded: function() {},</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-  OnItemRemoved: function() {},</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">-  OnItemPropertyChanged: function() {},</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-  OnItemIntPropertyChanged: function() {},</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-  OnItemBoolPropertyChanged: function() {},</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-  OnItemUnicharPropertyChanged: function() {},</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-  OnItemPropertyFlagChanged: function() {},</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-  OnItemEvent: function() {},</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineminus">-}</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+  OnItemAdded() {},</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineplus">+  OnItemRemoved() {},</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+  OnItemPropertyChanged() {},</span>
<a href="#l40.33"></a><span id="l40.33" class="difflineplus">+  OnItemIntPropertyChanged() {},</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineplus">+  OnItemBoolPropertyChanged() {},</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineplus">+  OnItemUnicharPropertyChanged() {},</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+  OnItemPropertyFlagChanged() {},</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+  OnItemEvent() {},</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+};</span>
<a href="#l40.39"></a><span id="l40.39"> </span>
<a href="#l40.40"></a><span id="l40.40"> var targetFolder;</span>
<a href="#l40.41"></a><span id="l40.41"> </span>
<a href="#l40.42"></a><span id="l40.42"> var tests = [</span>
<a href="#l40.43"></a><span id="l40.43">   function setup() {</span>
<a href="#l40.44"></a><span id="l40.44">     gMessageGenerator = new MessageGenerator();</span>
<a href="#l40.45"></a><span id="l40.45"> </span>
<a href="#l40.46"></a><span id="l40.46">     configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l40.47"></a><span id="l40.47"> </span>
<a href="#l40.48"></a><span id="l40.48">     targetFolder = make_empty_folder();</span>
<a href="#l40.49"></a><span id="l40.49">     targetFolder.AddFolderListener(folderListener);</span>
<a href="#l40.50"></a><span id="l40.50">     registerCleanupFunction(function() {</span>
<a href="#l40.51"></a><span id="l40.51">       targetFolder.RemoveFolderListener(folderListener);</span>
<a href="#l40.52"></a><span id="l40.52">     });</span>
<a href="#l40.53"></a><span id="l40.53">   },</span>
<a href="#l40.54"></a><span id="l40.54">   async function create_new_message() {</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineminus">-    let [msgSet] = make_new_sets_in_folder(targetFolder, [{count: 1}]);</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineplus">+    make_new_sets_in_folder(targetFolder, [{count: 1}]);</span>
<a href="#l40.57"></a><span id="l40.57">     await wait_for_message_injection();</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">-  }</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+  },</span>
<a href="#l40.60"></a><span id="l40.60"> ];</span>
<a href="#l40.61"></a><span id="l40.61"> </span>
<a href="#l40.62"></a><span id="l40.62"> function run_test() {</span>
<a href="#l40.63"></a><span id="l40.63">   async_run_tests(tests);</span>
<a href="#l40.64"></a><span id="l40.64"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgContentPolicy.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgContentPolicy.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,19 +1,17 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* -*- mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l41.5"></a><span id="l41.5"> /*</span>
<a href="#l41.6"></a><span id="l41.6">  * Test suite for nsIMsgContentPolicy to check we could add/remove customized protocol to</span>
<a href="#l41.7"></a><span id="l41.7">  * nsMsgContentPolicy.</span>
<a href="#l41.8"></a><span id="l41.8">  */</span>
<a href="#l41.9"></a><span id="l41.9"> const {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l41.10"></a><span id="l41.10"> </span>
<a href="#l41.11"></a><span id="l41.11"> function makeURI(aURL) {</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-                    .getService(Ci.nsIIOService);</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-  return ioService.newURI(aURL);</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+  return Services.io.newURI(aURL);</span>
<a href="#l41.16"></a><span id="l41.16"> }</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18"> function run_test() {</span>
<a href="#l41.19"></a><span id="l41.19">   var content_policy = Cc[&quot;@mozilla.org/messenger/content-policy;1&quot;]</span>
<a href="#l41.20"></a><span id="l41.20">                          .getService(Ci.nsIContentPolicy);</span>
<a href="#l41.21"></a><span id="l41.21"> </span>
<a href="#l41.22"></a><span id="l41.22">   Assert.ok(content_policy);</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24" class="difflineat">@@ -27,17 +25,17 @@ function run_test() {</span>
<a href="#l41.25"></a><span id="l41.25">   var content_uri = makeURI(&quot;custom-scheme://custom_content_url/1.jsp&quot;);</span>
<a href="#l41.26"></a><span id="l41.26">   Assert.ok(content_uri);</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28">   let tmpChannel = NetUtil.newChannel({</span>
<a href="#l41.29"></a><span id="l41.29">     uri: content_uri,</span>
<a href="#l41.30"></a><span id="l41.30">     // Needs one of 'loadingNode', 'loadingPrincipal' or 'loadUsingSystemPrincipal' which we don't have.</span>
<a href="#l41.31"></a><span id="l41.31">     // Even with `loadUsingSystemPrincipal: true` this fails with &quot;unknown protocol&quot;. See bug 1446587.</span>
<a href="#l41.32"></a><span id="l41.32">     securityFlags: Ci.nsILoadInfo.SEC_ONLY_FOR_EXPLICIT_CONTENTSEC_CHECK,</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-    contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+    contentPolicyType: Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l41.35"></a><span id="l41.35">   });</span>
<a href="#l41.36"></a><span id="l41.36">   let tmpLoadInfo = tmpChannel.loadInfo;</span>
<a href="#l41.37"></a><span id="l41.37"> </span>
<a href="#l41.38"></a><span id="l41.38">   var decision = content_policy.shouldLoad(content_uri, tmpLoadInfo, &quot;img/jpeg&quot;);</span>
<a href="#l41.39"></a><span id="l41.39">   Assert.notEqual(decision,</span>
<a href="#l41.40"></a><span id="l41.40">                   Ci.nsIContentPolicy.ACCEPT,</span>
<a href="#l41.41"></a><span id="l41.41">                   &quot;customized protocol should not load&quot;);</span>
<a href="#l41.42"></a><span id="l41.42"> </span>
<a href="#l41.43"></a><span id="l41.43" class="difflineat">@@ -49,10 +47,10 @@ function run_test() {</span>
<a href="#l41.44"></a><span id="l41.44">                &quot;customized protocol should load&quot;);</span>
<a href="#l41.45"></a><span id="l41.45"> </span>
<a href="#l41.46"></a><span id="l41.46">   msg_content_policy.removeExposedProtocol(&quot;custom-scheme&quot;);</span>
<a href="#l41.47"></a><span id="l41.47"> </span>
<a href="#l41.48"></a><span id="l41.48">   decision = content_policy.shouldLoad(content_uri, tmpLoadInfo, &quot;img/jpeg&quot;);</span>
<a href="#l41.49"></a><span id="l41.49">   Assert.notEqual(decision,</span>
<a href="#l41.50"></a><span id="l41.50">                   Ci.nsIContentPolicy.ACCEPT,</span>
<a href="#l41.51"></a><span id="l41.51">                   &quot;customized protocol should not load&quot;);</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-};</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+}</span>
<a href="#l41.54"></a><span id="l41.54"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolder.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolder.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -18,27 +18,25 @@ function run_test() {</span>
<a href="#l42.4"></a><span id="l42.4">   // Add a sub folder to ensure that we have some folders created</span>
<a href="#l42.5"></a><span id="l42.5">   root.createSubfolder(&quot;folder1&quot;, null);</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7">   // Test - getChildNamed</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9">   var caught = false;</span>
<a href="#l42.10"></a><span id="l42.10">   try {</span>
<a href="#l42.11"></a><span id="l42.11">     root.getChildNamed(&quot;folder&quot;);</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  }</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-  catch (e) {</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+  } catch (e) {</span>
<a href="#l42.15"></a><span id="l42.15">     caught = true;</span>
<a href="#l42.16"></a><span id="l42.16">   }</span>
<a href="#l42.17"></a><span id="l42.17">   Assert.equal(caught, true);</span>
<a href="#l42.18"></a><span id="l42.18"> </span>
<a href="#l42.19"></a><span id="l42.19">   caught = false;</span>
<a href="#l42.20"></a><span id="l42.20">   try {</span>
<a href="#l42.21"></a><span id="l42.21">     root.getChildNamed(&quot;Trash1&quot;);</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-  }</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-  catch (e) {</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineplus">+  } catch (e) {</span>
<a href="#l42.25"></a><span id="l42.25">     caught = true;</span>
<a href="#l42.26"></a><span id="l42.26">   }</span>
<a href="#l42.27"></a><span id="l42.27">   Assert.equal(caught, true);</span>
<a href="#l42.28"></a><span id="l42.28"> </span>
<a href="#l42.29"></a><span id="l42.29">   var folder1 = root.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l42.30"></a><span id="l42.30"> </span>
<a href="#l42.31"></a><span id="l42.31">   Assert.notEqual(folder1, folder2);</span>
<a href="#l42.32"></a><span id="l42.32">   Assert.equal(folder1.prettyName, &quot;folder1&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListener.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -8,169 +8,153 @@</span>
<a href="#l43.4"></a><span id="l43.4"> </span>
<a href="#l43.5"></a><span id="l43.5"> /*</span>
<a href="#l43.6"></a><span id="l43.6">  * Test suite for basic functionality with nsIMsgFolderListeners.</span>
<a href="#l43.7"></a><span id="l43.7">  */</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11"> var nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-var nsIMFListener = Ci.nsIMsgFolderListener;</span>
<a href="#l43.13"></a><span id="l43.13"> </span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-var gIndividualFlags =</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineminus">-[</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineplus">+var gIndividualFlags = [</span>
<a href="#l43.18"></a><span id="l43.18">   nsIMFNService.msgAdded,</span>
<a href="#l43.19"></a><span id="l43.19">   nsIMFNService.msgsClassified,</span>
<a href="#l43.20"></a><span id="l43.20">   nsIMFNService.msgsDeleted,</span>
<a href="#l43.21"></a><span id="l43.21">   nsIMFNService.msgsMoveCopyCompleted,</span>
<a href="#l43.22"></a><span id="l43.22">   nsIMFNService.msgKeyChanged,</span>
<a href="#l43.23"></a><span id="l43.23">   nsIMFNService.folderAdded,</span>
<a href="#l43.24"></a><span id="l43.24">   nsIMFNService.folderDeleted,</span>
<a href="#l43.25"></a><span id="l43.25">   nsIMFNService.folderMoveCopyCompleted,</span>
<a href="#l43.26"></a><span id="l43.26">   nsIMFNService.folderRenamed,</span>
<a href="#l43.27"></a><span id="l43.27">   nsIMFNService.itemEvent,</span>
<a href="#l43.28"></a><span id="l43.28"> ];</span>
<a href="#l43.29"></a><span id="l43.29"> </span>
<a href="#l43.30"></a><span id="l43.30"> // Our listener, which captures events.</span>
<a href="#l43.31"></a><span id="l43.31"> function gMFListener() {}</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">-gMFListener.prototype =</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-{</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+gMFListener.prototype = {</span>
<a href="#l43.35"></a><span id="l43.35">   mReceived: 0,</span>
<a href="#l43.36"></a><span id="l43.36">   mRemoveSelf: false,</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineminus">-  msgAdded: function (aMsg)</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineminus">-  {</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l43.40"></a><span id="l43.40">     Assert.equal(this.mReceived &amp; nsIMFNService.msgAdded, 0);</span>
<a href="#l43.41"></a><span id="l43.41">     this.mReceived |= nsIMFNService.msgAdded;</span>
<a href="#l43.42"></a><span id="l43.42">     if (this.mRemoveSelf)</span>
<a href="#l43.43"></a><span id="l43.43">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.44"></a><span id="l43.44">   },</span>
<a href="#l43.45"></a><span id="l43.45"> </span>
<a href="#l43.46"></a><span id="l43.46" class="difflineminus">-  msgsClassified: function (aMsgs, aJunkProcessed, aTraitProcessed)</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineminus">-  {</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+  msgsClassified(aMsgs, aJunkProcessed, aTraitProcessed) {</span>
<a href="#l43.49"></a><span id="l43.49">     Assert.equal(this.mReceived &amp; nsIMFNService.msgsClassified, 0);</span>
<a href="#l43.50"></a><span id="l43.50">     this.mReceived |= nsIMFNService.msgsClassified;</span>
<a href="#l43.51"></a><span id="l43.51">     if (this.mRemoveSelf)</span>
<a href="#l43.52"></a><span id="l43.52">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.53"></a><span id="l43.53">   },</span>
<a href="#l43.54"></a><span id="l43.54"> </span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-  msgsDeleted: function (aMsgs)</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-  {</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+  msgsDeleted(aMsgs) {</span>
<a href="#l43.58"></a><span id="l43.58">     Assert.equal(this.mReceived &amp; nsIMFNService.msgsDeleted, 0);</span>
<a href="#l43.59"></a><span id="l43.59">     this.mReceived |= nsIMFNService.msgsDeleted;</span>
<a href="#l43.60"></a><span id="l43.60">     if (this.mRemoveSelf)</span>
<a href="#l43.61"></a><span id="l43.61">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.62"></a><span id="l43.62">   },</span>
<a href="#l43.63"></a><span id="l43.63"> </span>
<a href="#l43.64"></a><span id="l43.64" class="difflineminus">-  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineminus">-  {</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+  msgsMoveCopyCompleted(aMove, aSrcMsgs, aDestFolder, aDestMsgs) {</span>
<a href="#l43.67"></a><span id="l43.67">     Assert.equal(this.mReceived &amp; nsIMFNService.msgsMoveCopyCompleted, 0);</span>
<a href="#l43.68"></a><span id="l43.68">     this.mReceived |= nsIMFNService.msgsMoveCopyCompleted;</span>
<a href="#l43.69"></a><span id="l43.69">     if (this.mRemoveSelf)</span>
<a href="#l43.70"></a><span id="l43.70">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.71"></a><span id="l43.71">   },</span>
<a href="#l43.72"></a><span id="l43.72"> </span>
<a href="#l43.73"></a><span id="l43.73" class="difflineminus">-  msgKeyChanged: function(aOldMsgKey, aNewMsgHdr)</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineminus">-  {</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+  msgKeyChanged(aOldMsgKey, aNewMsgHdr) {</span>
<a href="#l43.76"></a><span id="l43.76">     Assert.equal(this.mReceived &amp; nsIMFNService.msgKeyChanged, 0);</span>
<a href="#l43.77"></a><span id="l43.77">     this.mReceived |= nsIMFNService.msgKeyChanged;</span>
<a href="#l43.78"></a><span id="l43.78">     if (this.mRemoveSelf)</span>
<a href="#l43.79"></a><span id="l43.79">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.80"></a><span id="l43.80">   },</span>
<a href="#l43.81"></a><span id="l43.81"> </span>
<a href="#l43.82"></a><span id="l43.82" class="difflineminus">-  folderAdded: function (aFolder)</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineminus">-  {</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineplus">+  folderAdded(aFolder) {</span>
<a href="#l43.85"></a><span id="l43.85">     Assert.equal(this.mReceived &amp; nsIMFNService.folderAdded, 0);</span>
<a href="#l43.86"></a><span id="l43.86">     this.mReceived |= nsIMFNService.folderAdded;</span>
<a href="#l43.87"></a><span id="l43.87">     if (this.mRemoveSelf)</span>
<a href="#l43.88"></a><span id="l43.88">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.89"></a><span id="l43.89">   },</span>
<a href="#l43.90"></a><span id="l43.90"> </span>
<a href="#l43.91"></a><span id="l43.91" class="difflineminus">-  folderDeleted: function (aFolder)</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineminus">-  {</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+  folderDeleted(aFolder) {</span>
<a href="#l43.94"></a><span id="l43.94">     Assert.equal(this.mReceived &amp; nsIMFNService.folderDeleted, 0);</span>
<a href="#l43.95"></a><span id="l43.95">     this.mReceived |= nsIMFNService.folderDeleted;</span>
<a href="#l43.96"></a><span id="l43.96">     if (this.mRemoveSelf)</span>
<a href="#l43.97"></a><span id="l43.97">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.98"></a><span id="l43.98">   },</span>
<a href="#l43.99"></a><span id="l43.99"> </span>
<a href="#l43.100"></a><span id="l43.100" class="difflineminus">-  folderMoveCopyCompleted: function (aMove, aSrcFolder, aDestFolder)</span>
<a href="#l43.101"></a><span id="l43.101" class="difflineminus">-  {</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+  folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l43.103"></a><span id="l43.103">     Assert.equal(this.mReceived &amp; nsIMFNService.folderMoveCopyCompleted, 0);</span>
<a href="#l43.104"></a><span id="l43.104">     this.mReceived |= nsIMFNService.folderMoveCopyCompleted;</span>
<a href="#l43.105"></a><span id="l43.105">     if (this.mRemoveSelf)</span>
<a href="#l43.106"></a><span id="l43.106">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.107"></a><span id="l43.107">   },</span>
<a href="#l43.108"></a><span id="l43.108"> </span>
<a href="#l43.109"></a><span id="l43.109" class="difflineminus">-  folderRenamed: function (aOrigFolder, aNewFolder)</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineminus">-  {</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+  folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l43.112"></a><span id="l43.112">     Assert.equal(this.mReceived &amp; nsIMFNService.folderRenamed, 0);</span>
<a href="#l43.113"></a><span id="l43.113">     this.mReceived |= nsIMFNService.folderRenamed;</span>
<a href="#l43.114"></a><span id="l43.114">     if (this.mRemoveSelf)</span>
<a href="#l43.115"></a><span id="l43.115">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.116"></a><span id="l43.116">   },</span>
<a href="#l43.117"></a><span id="l43.117"> </span>
<a href="#l43.118"></a><span id="l43.118" class="difflineminus">-  itemEvent: function (aItem, aEvent, aData, aString)</span>
<a href="#l43.119"></a><span id="l43.119" class="difflineminus">-  {</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineplus">+  itemEvent(aItem, aEvent, aData, aString) {</span>
<a href="#l43.121"></a><span id="l43.121">     Assert.equal(this.mReceived &amp; nsIMFNService.itemEvent, 0);</span>
<a href="#l43.122"></a><span id="l43.122">     this.mReceived |= nsIMFNService.itemEvent;</span>
<a href="#l43.123"></a><span id="l43.123">     if (this.mRemoveSelf)</span>
<a href="#l43.124"></a><span id="l43.124">       MailServices.mfn.removeListener(this);</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineminus">-  }</span>
<a href="#l43.126"></a><span id="l43.126" class="difflineplus">+  },</span>
<a href="#l43.127"></a><span id="l43.127"> };</span>
<a href="#l43.128"></a><span id="l43.128"> </span>
<a href="#l43.129"></a><span id="l43.129" class="difflineminus">-function NotifyMsgFolderListeners()</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineminus">-{</span>
<a href="#l43.131"></a><span id="l43.131" class="difflineplus">+function NotifyMsgFolderListeners() {</span>
<a href="#l43.132"></a><span id="l43.132">   MailServices.mfn.notifyMsgAdded(null);</span>
<a href="#l43.133"></a><span id="l43.133">   MailServices.mfn.notifyMsgsClassified(null, null, null);</span>
<a href="#l43.134"></a><span id="l43.134">   MailServices.mfn.notifyMsgsDeleted(null);</span>
<a href="#l43.135"></a><span id="l43.135">   MailServices.mfn.notifyMsgsMoveCopyCompleted(null, null, null, null);</span>
<a href="#l43.136"></a><span id="l43.136">   MailServices.mfn.notifyMsgKeyChanged(null, null);</span>
<a href="#l43.137"></a><span id="l43.137">   MailServices.mfn.notifyFolderAdded(null);</span>
<a href="#l43.138"></a><span id="l43.138">   MailServices.mfn.notifyFolderDeleted(null);</span>
<a href="#l43.139"></a><span id="l43.139">   MailServices.mfn.notifyFolderMoveCopyCompleted(null, null, null);</span>
<a href="#l43.140"></a><span id="l43.140">   MailServices.mfn.notifyFolderRenamed(null, null);</span>
<a href="#l43.141"></a><span id="l43.141">   MailServices.mfn.notifyItemEvent(null, null, null, null);</span>
<a href="#l43.142"></a><span id="l43.142"> }</span>
<a href="#l43.143"></a><span id="l43.143"> </span>
<a href="#l43.144"></a><span id="l43.144" class="difflineminus">-function run_test()</span>
<a href="#l43.145"></a><span id="l43.145" class="difflineminus">-{</span>
<a href="#l43.146"></a><span id="l43.146" class="difflineplus">+function run_test() {</span>
<a href="#l43.147"></a><span id="l43.147">   // Test: Add listeners</span>
<a href="#l43.148"></a><span id="l43.148">   var singleListeners = [];</span>
<a href="#l43.149"></a><span id="l43.149"> </span>
<a href="#l43.150"></a><span id="l43.150" class="difflineminus">-  var addAListener = function (flag) {</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineplus">+  var addAListener = function(flag) {</span>
<a href="#l43.152"></a><span id="l43.152">     var listener = new gMFListener();</span>
<a href="#l43.153"></a><span id="l43.153">     MailServices.mfn.addListener(listener, flag);</span>
<a href="#l43.154"></a><span id="l43.154">     singleListeners.push(listener);</span>
<a href="#l43.155"></a><span id="l43.155">   };</span>
<a href="#l43.156"></a><span id="l43.156"> </span>
<a href="#l43.157"></a><span id="l43.157">   gIndividualFlags.forEach(addAListener);</span>
<a href="#l43.158"></a><span id="l43.158"> </span>
<a href="#l43.159"></a><span id="l43.159">   // Test: Notify the listeners of all events.</span>
<a href="#l43.160"></a><span id="l43.160">   NotifyMsgFolderListeners();</span>
<a href="#l43.161"></a><span id="l43.161"> </span>
<a href="#l43.162"></a><span id="l43.162">   // Test: check whether the correct number of notifications have been received.</span>
<a href="#l43.163"></a><span id="l43.163">   // Then remove the listeners</span>
<a href="#l43.164"></a><span id="l43.164" class="difflineminus">-  var checkFlag = function (flag) {</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+  var checkFlag = function(flag) {</span>
<a href="#l43.166"></a><span id="l43.166">     var listener = singleListeners.shift();</span>
<a href="#l43.167"></a><span id="l43.167">     Assert.equal(listener.mReceived, flag);</span>
<a href="#l43.168"></a><span id="l43.168">     listener.mRemoveSelf = true;</span>
<a href="#l43.169"></a><span id="l43.169">     listener.mReceived = 0;</span>
<a href="#l43.170"></a><span id="l43.170">     singleListeners.push(listener);</span>
<a href="#l43.171"></a><span id="l43.171">   };</span>
<a href="#l43.172"></a><span id="l43.172">   gIndividualFlags.forEach(checkFlag);</span>
<a href="#l43.173"></a><span id="l43.173"> </span>
<a href="#l43.174"></a><span id="l43.174">   // We'll do one more set of notifications, and remove ourselves in the middle of them</span>
<a href="#l43.175"></a><span id="l43.175">   NotifyMsgFolderListeners();</span>
<a href="#l43.176"></a><span id="l43.176"> </span>
<a href="#l43.177"></a><span id="l43.177">   // Test: all listeners should be removed at this point</span>
<a href="#l43.178"></a><span id="l43.178">   Assert.ok(!MailServices.mfn.hasListeners);</span>
<a href="#l43.179"></a><span id="l43.179"> </span>
<a href="#l43.180"></a><span id="l43.180">   // Test: Send notifications again. Check that we don't receive any notifications.</span>
<a href="#l43.181"></a><span id="l43.181" class="difflineminus">-  singleListeners.forEach(function (listener) { listener.mReceived = 0; });</span>
<a href="#l43.182"></a><span id="l43.182" class="difflineplus">+  singleListeners.forEach(function(listener) { listener.mReceived = 0; });</span>
<a href="#l43.183"></a><span id="l43.183"> </span>
<a href="#l43.184"></a><span id="l43.184">   NotifyMsgFolderListeners();</span>
<a href="#l43.185"></a><span id="l43.185"> </span>
<a href="#l43.186"></a><span id="l43.186">   var checkNotReceived = function() {</span>
<a href="#l43.187"></a><span id="l43.187">     Assert.equal(singleListeners.shift().mReceived, 0);</span>
<a href="#l43.188"></a><span id="l43.188" class="difflineminus">-  }</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineplus">+  };</span>
<a href="#l43.190"></a><span id="l43.190">   gIndividualFlags.forEach(checkNotReceived);</span>
<a href="#l43.191"></a><span id="l43.191"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -14,121 +14,114 @@</span>
<a href="#l44.4"></a><span id="l44.4">   * - Adding new folders</span>
<a href="#l44.5"></a><span id="l44.5">   * - Copy messages from files into the db</span>
<a href="#l44.6"></a><span id="l44.6">   * - Moving and copying one or more messages from one local folder to another</span>
<a href="#l44.7"></a><span id="l44.7">   * - Moving folders, with and without subfolders</span>
<a href="#l44.8"></a><span id="l44.8">   * - Renaming folders</span>
<a href="#l44.9"></a><span id="l44.9">   * - Deleting messages and folders, to trash and from trash (permanently)</span>
<a href="#l44.10"></a><span id="l44.10">   */</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+/* import-globals-from ../../../test/resources/msgFolderListenerSetup.js */</span>
<a href="#l44.13"></a><span id="l44.13"> load(&quot;../../../resources/msgFolderListenerSetup.js&quot;);</span>
<a href="#l44.14"></a><span id="l44.14"> </span>
<a href="#l44.15"></a><span id="l44.15"> // Globals</span>
<a href="#l44.16"></a><span id="l44.16"> var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l44.17"></a><span id="l44.17"> var gRootFolder;</span>
<a href="#l44.18"></a><span id="l44.18"> var gLocalFolder2;</span>
<a href="#l44.19"></a><span id="l44.19"> var gLocalFolder3;</span>
<a href="#l44.20"></a><span id="l44.20"> var gLocalTrashFolder;</span>
<a href="#l44.21"></a><span id="l44.21"> </span>
<a href="#l44.22"></a><span id="l44.22"> // storeIn takes a string containing the variable to store the new folder in</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineminus">-function addFolder(parent, folderName, storeIn)</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineminus">-{</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+function addFolder(parent, folderName, storeIn) {</span>
<a href="#l44.26"></a><span id="l44.26">   gExpectedEvents = [[MailServices.mfn.folderAdded, parent, folderName, storeIn]];</span>
<a href="#l44.27"></a><span id="l44.27">   // We won't receive a copy listener notification for this</span>
<a href="#l44.28"></a><span id="l44.28">   gCurrStatus |= kStatus.onStopCopyDone;</span>
<a href="#l44.29"></a><span id="l44.29">   parent.createSubfolder(folderName, null);</span>
<a href="#l44.30"></a><span id="l44.30">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.31"></a><span id="l44.31">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.32"></a><span id="l44.32">     resetStatusAndProceed();</span>
<a href="#l44.33"></a><span id="l44.33"> }</span>
<a href="#l44.34"></a><span id="l44.34"> </span>
<a href="#l44.35"></a><span id="l44.35"> /**</span>
<a href="#l44.36"></a><span id="l44.36">  * This will introduce a new message to the system which will generate an added</span>
<a href="#l44.37"></a><span id="l44.37">  * notification and subsequently a classification notification.  For the</span>
<a href="#l44.38"></a><span id="l44.38">  * classification because no messages have yet been marked as junk and there</span>
<a href="#l44.39"></a><span id="l44.39">  * are no traits configured, aJunkProcessed and aTraitProcessed will be false.</span>
<a href="#l44.40"></a><span id="l44.40">  */</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineminus">-function copyFileMessage(file, destFolder, isDraftOrTemplate)</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineminus">-{</span>
<a href="#l44.43"></a><span id="l44.43" class="difflineplus">+function copyFileMessage(file, destFolder, isDraftOrTemplate) {</span>
<a href="#l44.44"></a><span id="l44.44">   copyListener.mFolderStoredIn = destFolder;</span>
<a href="#l44.45"></a><span id="l44.45">   gExpectedEvents = [[MailServices.mfn.msgAdded, gHdrsReceived],</span>
<a href="#l44.46"></a><span id="l44.46">                      [MailServices.mfn.msgsClassified, gHdrsReceived, false, false]];</span>
<a href="#l44.47"></a><span id="l44.47">   MailServices.copy.CopyFileMessage(file, destFolder, null, isDraftOrTemplate, 0, &quot;&quot;,</span>
<a href="#l44.48"></a><span id="l44.48">                                     copyListener, null);</span>
<a href="#l44.49"></a><span id="l44.49">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.50"></a><span id="l44.50">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.51"></a><span id="l44.51">     resetStatusAndProceed();</span>
<a href="#l44.52"></a><span id="l44.52"> }</span>
<a href="#l44.53"></a><span id="l44.53"> </span>
<a href="#l44.54"></a><span id="l44.54" class="difflineminus">-function copyMessages(items, isMove, srcFolder, destFolder)</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineminus">-{</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+function copyMessages(items, isMove, srcFolder, destFolder) {</span>
<a href="#l44.57"></a><span id="l44.57">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l44.60"></a><span id="l44.60">     array.appendElement(item);</span>
<a href="#l44.61"></a><span id="l44.61">   });</span>
<a href="#l44.62"></a><span id="l44.62">   gExpectedEvents = [</span>
<a href="#l44.63"></a><span id="l44.63">     [MailServices.mfn.msgsMoveCopyCompleted, isMove, items, destFolder, true]];</span>
<a href="#l44.64"></a><span id="l44.64">   MailServices.copy.CopyMessages(srcFolder, array, destFolder, isMove, copyListener,</span>
<a href="#l44.65"></a><span id="l44.65">                                  null, true);</span>
<a href="#l44.66"></a><span id="l44.66">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.67"></a><span id="l44.67">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.68"></a><span id="l44.68">     resetStatusAndProceed();</span>
<a href="#l44.69"></a><span id="l44.69"> }</span>
<a href="#l44.70"></a><span id="l44.70"> </span>
<a href="#l44.71"></a><span id="l44.71" class="difflineminus">-function copyFolders(items, isMove, destFolder)</span>
<a href="#l44.72"></a><span id="l44.72" class="difflineminus">-{</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineplus">+function copyFolders(items, isMove, destFolder) {</span>
<a href="#l44.74"></a><span id="l44.74">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l44.75"></a><span id="l44.75" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l44.76"></a><span id="l44.76" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l44.77"></a><span id="l44.77">     array.appendElement(item);</span>
<a href="#l44.78"></a><span id="l44.78">   });</span>
<a href="#l44.79"></a><span id="l44.79">   gExpectedEvents = [[MailServices.mfn.folderMoveCopyCompleted, isMove, items, destFolder]];</span>
<a href="#l44.80"></a><span id="l44.80">   MailServices.copy.CopyFolders(array, destFolder, isMove, copyListener, null);</span>
<a href="#l44.81"></a><span id="l44.81">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.82"></a><span id="l44.82">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.83"></a><span id="l44.83">     resetStatusAndProceed();</span>
<a href="#l44.84"></a><span id="l44.84"> }</span>
<a href="#l44.85"></a><span id="l44.85"> </span>
<a href="#l44.86"></a><span id="l44.86" class="difflineminus">-function deleteMessages(srcFolder, items, deleteStorage, isMove)</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineminus">-{</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineplus">+function deleteMessages(srcFolder, items, deleteStorage, isMove) {</span>
<a href="#l44.89"></a><span id="l44.89">   var array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-  items.forEach(function (item) {</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineplus">+  items.forEach(function(item) {</span>
<a href="#l44.92"></a><span id="l44.92">     array.appendElement(item);</span>
<a href="#l44.93"></a><span id="l44.93">   });</span>
<a href="#l44.94"></a><span id="l44.94">   // We should only get the delete notification only if we are not moving, and are deleting from</span>
<a href="#l44.95"></a><span id="l44.95">   // the storage/trash. We should get only the move/copy notification if we aren't.</span>
<a href="#l44.96"></a><span id="l44.96">   var isTrashFolder = srcFolder.getFlag(Ci.nsMsgFolderFlags.Trash);</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineminus">-  if (!isMove &amp;&amp; (deleteStorage || isTrashFolder))</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineminus">-  {</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+  if (!isMove &amp;&amp; (deleteStorage || isTrashFolder)) {</span>
<a href="#l44.100"></a><span id="l44.100">     // We won't be getting any OnStopCopy notification in this case</span>
<a href="#l44.101"></a><span id="l44.101">     gCurrStatus = kStatus.onStopCopyDone;</span>
<a href="#l44.102"></a><span id="l44.102">     gExpectedEvents = [[MailServices.mfn.msgsDeleted, items]];</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineminus">-  }</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineminus">-  else</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+  } else {</span>
<a href="#l44.106"></a><span id="l44.106">     // We have to be getting a move notification, even if isMove is false</span>
<a href="#l44.107"></a><span id="l44.107">     gExpectedEvents = [[MailServices.mfn.msgsMoveCopyCompleted, true, items,</span>
<a href="#l44.108"></a><span id="l44.108">                         gLocalTrashFolder, true]];</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+  }</span>
<a href="#l44.110"></a><span id="l44.110"> </span>
<a href="#l44.111"></a><span id="l44.111">   srcFolder.deleteMessages(array, null, deleteStorage, isMove, copyListener, true);</span>
<a href="#l44.112"></a><span id="l44.112">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.113"></a><span id="l44.113">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.114"></a><span id="l44.114">     resetStatusAndProceed();</span>
<a href="#l44.115"></a><span id="l44.115"> }</span>
<a href="#l44.116"></a><span id="l44.116"> </span>
<a href="#l44.117"></a><span id="l44.117" class="difflineminus">-function renameFolder(folder, newName)</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineminus">-{</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+function renameFolder(folder, newName) {</span>
<a href="#l44.120"></a><span id="l44.120">   gExpectedEvents = [[MailServices.mfn.folderRenamed, [folder], newName]];</span>
<a href="#l44.121"></a><span id="l44.121">   gCurrStatus = kStatus.onStopCopyDone;</span>
<a href="#l44.122"></a><span id="l44.122">   folder.rename(newName, null);</span>
<a href="#l44.123"></a><span id="l44.123">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.124"></a><span id="l44.124">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.125"></a><span id="l44.125">     resetStatusAndProceed();</span>
<a href="#l44.126"></a><span id="l44.126"> }</span>
<a href="#l44.127"></a><span id="l44.127"> </span>
<a href="#l44.128"></a><span id="l44.128" class="difflineminus">-function deleteFolder(folder, child)</span>
<a href="#l44.129"></a><span id="l44.129" class="difflineminus">-{</span>
<a href="#l44.130"></a><span id="l44.130" class="difflineplus">+function deleteFolder(folder, child) {</span>
<a href="#l44.131"></a><span id="l44.131">   var array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l44.132"></a><span id="l44.132">                 .createInstance(Ci.nsIMutableArray);</span>
<a href="#l44.133"></a><span id="l44.133">   array.appendElement(folder);</span>
<a href="#l44.134"></a><span id="l44.134">   // We won't be getting any OnStopCopy notification at all</span>
<a href="#l44.135"></a><span id="l44.135">   // XXX delete to trash should get one, but we'll need to pass the listener</span>
<a href="#l44.136"></a><span id="l44.136">   // somehow to deleteSubFolders</span>
<a href="#l44.137"></a><span id="l44.137">   gCurrStatus = kStatus.onStopCopyDone;</span>
<a href="#l44.138"></a><span id="l44.138">   // If ancestor is trash, expect a folderDeleted, otherwise expect</span>
<a href="#l44.139"></a><span id="l44.139" class="difflineat">@@ -144,35 +137,33 @@ function deleteFolder(folder, child)</span>
<a href="#l44.140"></a><span id="l44.140">                         [folder], gLocalTrashFolder]];</span>
<a href="#l44.141"></a><span id="l44.141"> </span>
<a href="#l44.142"></a><span id="l44.142">   folder.parent.deleteSubFolders(array, null);</span>
<a href="#l44.143"></a><span id="l44.143">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.144"></a><span id="l44.144">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.145"></a><span id="l44.145">     resetStatusAndProceed();</span>
<a href="#l44.146"></a><span id="l44.146"> }</span>
<a href="#l44.147"></a><span id="l44.147"> </span>
<a href="#l44.148"></a><span id="l44.148" class="difflineminus">-function compactFolder(folder)</span>
<a href="#l44.149"></a><span id="l44.149" class="difflineminus">-{</span>
<a href="#l44.150"></a><span id="l44.150" class="difflineplus">+function compactFolder(folder) {</span>
<a href="#l44.151"></a><span id="l44.151">   gExpectedEvents = [[MailServices.mfn.itemEvent, folder, &quot;FolderCompactStart&quot;],</span>
<a href="#l44.152"></a><span id="l44.152">                      [MailServices.mfn.itemEvent, folder, &quot;FolderCompactFinish&quot;]];</span>
<a href="#l44.153"></a><span id="l44.153">   // We won't receive a copy listener notification for this</span>
<a href="#l44.154"></a><span id="l44.154">   gCurrStatus |= kStatus.onStopCopyDone;</span>
<a href="#l44.155"></a><span id="l44.155">   folder.compact(null, null);</span>
<a href="#l44.156"></a><span id="l44.156">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l44.157"></a><span id="l44.157">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l44.158"></a><span id="l44.158">     resetStatusAndProceed();</span>
<a href="#l44.159"></a><span id="l44.159"> }</span>
<a href="#l44.160"></a><span id="l44.160"> </span>
<a href="#l44.161"></a><span id="l44.161"> /*</span>
<a href="#l44.162"></a><span id="l44.162">  * TESTS</span>
<a href="#l44.163"></a><span id="l44.163">  */</span>
<a href="#l44.164"></a><span id="l44.164"> </span>
<a href="#l44.165"></a><span id="l44.165"> // Beware before commenting out a test -- later tests might just depend on earlier ones</span>
<a href="#l44.166"></a><span id="l44.166" class="difflineminus">-var gTestArray =</span>
<a href="#l44.167"></a><span id="l44.167" class="difflineminus">-[</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineplus">+var gTestArray = [</span>
<a href="#l44.169"></a><span id="l44.169">   // Adding folders</span>
<a href="#l44.170"></a><span id="l44.170">   // Create another folder to move and copy messages around, and force initialization.</span>
<a href="#l44.171"></a><span id="l44.171">   function addFolder1() {</span>
<a href="#l44.172"></a><span id="l44.172">     addFolder(gRootFolder, &quot;folder2&quot;, function(folder) { gLocalFolder2 = folder; });</span>
<a href="#l44.173"></a><span id="l44.173">   },</span>
<a href="#l44.174"></a><span id="l44.174">   // Create a third folder for more testing.</span>
<a href="#l44.175"></a><span id="l44.175">   function addFolder2() {</span>
<a href="#l44.176"></a><span id="l44.176">     addFolder(gRootFolder, &quot;folder3&quot;, function(folder) { gLocalFolder3 = folder; });</span>
<a href="#l44.177"></a><span id="l44.177" class="difflineat">@@ -293,30 +284,30 @@ var gTestArray =</span>
<a href="#l44.178"></a><span id="l44.178">   // Inbox</span>
<a href="#l44.179"></a><span id="l44.179">   // Trash</span>
<a href="#l44.180"></a><span id="l44.180">   // -folder2</span>
<a href="#l44.181"></a><span id="l44.181">   // --folder3</span>
<a href="#l44.182"></a><span id="l44.182">   function deleteFolder4() {</span>
<a href="#l44.183"></a><span id="l44.183">     // Let's take a moment to re-initialize stuff that got moved</span>
<a href="#l44.184"></a><span id="l44.184">     gLocalFolder2 = gLocalTrashFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l44.185"></a><span id="l44.185">     gLocalFolder3 = gLocalFolder2.getChildNamed(&quot;folder3&quot;);</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineminus">-    deleteFolder(gLocalFolder2, gLocalFolder3); },</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineplus">+    deleteFolder(gLocalFolder2, gLocalFolder3);</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+  },</span>
<a href="#l44.189"></a><span id="l44.189">   function compactInbox() {</span>
<a href="#l44.190"></a><span id="l44.190">     if (localAccountUtils.inboxFolder.msgStore.supportsCompaction)</span>
<a href="#l44.191"></a><span id="l44.191">       compactFolder(localAccountUtils.inboxFolder);</span>
<a href="#l44.192"></a><span id="l44.192">     else</span>
<a href="#l44.193"></a><span id="l44.193">       doTest(++gTest);</span>
<a href="#l44.194"></a><span id="l44.194" class="difflineminus">-  }</span>
<a href="#l44.195"></a><span id="l44.195" class="difflineplus">+  },</span>
<a href="#l44.196"></a><span id="l44.196"> ];</span>
<a href="#l44.197"></a><span id="l44.197">   // Folder structure should just be</span>
<a href="#l44.198"></a><span id="l44.198">   // Inbox</span>
<a href="#l44.199"></a><span id="l44.199">   // Trash</span>
<a href="#l44.200"></a><span id="l44.200"> </span>
<a href="#l44.201"></a><span id="l44.201" class="difflineminus">-function run_test()</span>
<a href="#l44.202"></a><span id="l44.202" class="difflineminus">-{</span>
<a href="#l44.203"></a><span id="l44.203" class="difflineplus">+function run_test() {</span>
<a href="#l44.204"></a><span id="l44.204">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l44.205"></a><span id="l44.205"> </span>
<a href="#l44.206"></a><span id="l44.206">   // Add a listener.</span>
<a href="#l44.207"></a><span id="l44.207">   MailServices.mfn.addListener(gMFListener, allTestedEvents);</span>
<a href="#l44.208"></a><span id="l44.208"> </span>
<a href="#l44.209"></a><span id="l44.209">   // Load up some messages so that we can copy them in later.</span>
<a href="#l44.210"></a><span id="l44.210">   gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l44.211"></a><span id="l44.211">   gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineat">@@ -328,31 +319,27 @@ function run_test()</span>
<a href="#l44.213"></a><span id="l44.213"> </span>
<a href="#l44.214"></a><span id="l44.214">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of all the operations.</span>
<a href="#l44.215"></a><span id="l44.215">   do_test_pending();</span>
<a href="#l44.216"></a><span id="l44.216"> </span>
<a href="#l44.217"></a><span id="l44.217">   // Do the test.</span>
<a href="#l44.218"></a><span id="l44.218">   doTest(1);</span>
<a href="#l44.219"></a><span id="l44.219"> }</span>
<a href="#l44.220"></a><span id="l44.220"> </span>
<a href="#l44.221"></a><span id="l44.221" class="difflineminus">-function doTest(test)</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineminus">-{</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineminus">-  {</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineminus">-    var testFn = gTestArray[test-1];</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineplus">+function doTest(test) {</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineplus">+  if (test &lt;= gTestArray.length) {</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineplus">+    var testFn = gTestArray[test - 1];</span>
<a href="#l44.229"></a><span id="l44.229">     // Set a limit of 10 seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l44.232"></a><span id="l44.232">         if (gTest == test)</span>
<a href="#l44.233"></a><span id="l44.233">           do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name +</span>
<a href="#l44.234"></a><span id="l44.234">             &quot;, current status is &quot; + gCurrStatus);</span>
<a href="#l44.235"></a><span id="l44.235">         }</span>
<a href="#l44.236"></a><span id="l44.236">       );</span>
<a href="#l44.237"></a><span id="l44.237">     dump(&quot;=== Test: &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l44.238"></a><span id="l44.238">     testFn();</span>
<a href="#l44.239"></a><span id="l44.239" class="difflineminus">-  }</span>
<a href="#l44.240"></a><span id="l44.240" class="difflineminus">-  else</span>
<a href="#l44.241"></a><span id="l44.241" class="difflineminus">-  {</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineplus">+  } else {</span>
<a href="#l44.243"></a><span id="l44.243">     gHdrsReceived = null;</span>
<a href="#l44.244"></a><span id="l44.244">     gMsgHdrs = null;</span>
<a href="#l44.245"></a><span id="l44.245">     MailServices.mfn.removeListener(gMFListener);</span>
<a href="#l44.246"></a><span id="l44.246">     do_test_finished(); // for the one in run_test()</span>
<a href="#l44.247"></a><span id="l44.247">   }</span>
<a href="#l44.248"></a><span id="l44.248"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgTagService.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgTagService.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -7,18 +7,17 @@</span>
<a href="#l45.4"></a><span id="l45.4">  *</span>
<a href="#l45.5"></a><span id="l45.5">  * Specifically tests changes implemented in bug 217034</span>
<a href="#l45.6"></a><span id="l45.6">  * Does not do comprehensive testing.</span>
<a href="#l45.7"></a><span id="l45.7">  *</span>
<a href="#l45.8"></a><span id="l45.8">  */</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-function run_test()</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-{</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+function run_test() {</span>
<a href="#l45.15"></a><span id="l45.15">   // These are both tags and keys. Note keys are forced to be lower case</span>
<a href="#l45.16"></a><span id="l45.16">   const tag1 = &quot;istag&quot;;</span>
<a href="#l45.17"></a><span id="l45.17">   const tag2 = &quot;notistag&quot;;</span>
<a href="#l45.18"></a><span id="l45.18">   const tag3 = &quot;istagnot&quot;;</span>
<a href="#l45.19"></a><span id="l45.19">   const tag4 = &quot;istagtoo&quot;;</span>
<a href="#l45.20"></a><span id="l45.20"> </span>
<a href="#l45.21"></a><span id="l45.21">   // add a tag</span>
<a href="#l45.22"></a><span id="l45.22">   MailServices.tags.addTagForKey(tag1, tag1, null, null);</span>
<a href="#l45.23"></a><span id="l45.23" class="difflineat">@@ -53,18 +52,17 @@ function run_test()</span>
<a href="#l45.24"></a><span id="l45.24">   // add many tags and check again</span>
<a href="#l45.25"></a><span id="l45.25">   for (i = 0; i &lt; 100; i++)</span>
<a href="#l45.26"></a><span id="l45.26">     MailServices.tags.addTagForKey(i, &quot;lotsatags&quot; + i, null, null);</span>
<a href="#l45.27"></a><span id="l45.27">   Assert.ok(!MailServices.tags.isValidKey(tag1));</span>
<a href="#l45.28"></a><span id="l45.28">   Assert.ok(!MailServices.tags.isValidKey(tag2));</span>
<a href="#l45.29"></a><span id="l45.29">   Assert.ok(!MailServices.tags.isValidKey(tag3));</span>
<a href="#l45.30"></a><span id="l45.30">   Assert.ok(MailServices.tags.isValidKey(tag4));</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-  for (i = 0; i &lt; 100; i++)</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineminus">-  {</span>
<a href="#l45.34"></a><span id="l45.34" class="difflineplus">+  for (i = 0; i &lt; 100; i++) {</span>
<a href="#l45.35"></a><span id="l45.35">     Assert.ok(MailServices.tags.isValidKey(i));</span>
<a href="#l45.36"></a><span id="l45.36">     // make sure it knows the difference betweens tags and keys</span>
<a href="#l45.37"></a><span id="l45.37">     Assert.ok(!MailServices.tags.isValidKey(&quot;lotsatags&quot; + i));</span>
<a href="#l45.38"></a><span id="l45.38">     // are we confused by key at start of tag?</span>
<a href="#l45.39"></a><span id="l45.39">     Assert.ok(!MailServices.tags.isValidKey(i + &quot;lotsatags&quot;));</span>
<a href="#l45.40"></a><span id="l45.40">   }</span>
<a href="#l45.41"></a><span id="l45.41"> }</span>
<a href="#l45.42"></a><span id="l45.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMailDirProvider.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMailDirProvider.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -14,9 +14,9 @@ function run_test() {</span>
<a href="#l46.4"></a><span id="l46.4"> </span>
<a href="#l46.5"></a><span id="l46.5">   items.forEach(function(item) {</span>
<a href="#l46.6"></a><span id="l46.6">     var dir = Services.dirsvc.get(item.key, Ci.nsIFile);</span>
<a href="#l46.7"></a><span id="l46.7">     dump(do_get_profile().path + &quot; &quot; + dir.path + &quot;\n&quot;);</span>
<a href="#l46.8"></a><span id="l46.8">     Assert.ok(do_get_profile().equals(dir.parent));</span>
<a href="#l46.9"></a><span id="l46.9"> </span>
<a href="#l46.10"></a><span id="l46.10">     Assert.equal(dir.leafName, item.value);</span>
<a href="#l46.11"></a><span id="l46.11">   });</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-};</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgDBView.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgDBView.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -4,20 +4,26 @@</span>
<a href="#l47.4"></a><span id="l47.4">  *</span>
<a href="#l47.5"></a><span id="l47.5">  * Things we really should do:</span>
<a href="#l47.6"></a><span id="l47.6">  * - Test that secondary sorting works, especially when the primary column is</span>
<a href="#l47.7"></a><span id="l47.7">  *   a custom column.</span>
<a href="#l47.8"></a><span id="l47.8">  *</span>
<a href="#l47.9"></a><span id="l47.9">  * You may also want to look into the test_viewWrapper_*.js tests as well.</span>
<a href="#l47.10"></a><span id="l47.10">  */</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l47.15"></a><span id="l47.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l47.16"></a><span id="l47.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l47.17"></a><span id="l47.17"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l47.18"></a><span id="l47.18"> </span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l47.22"></a><span id="l47.22"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l47.23"></a><span id="l47.23"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l47.24"></a><span id="l47.24"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l47.25"></a><span id="l47.25"> </span>
<a href="#l47.26"></a><span id="l47.26"> const {JSTreeSelection} = ChromeUtils.import(&quot;resource:///modules/jsTreeSelection.js&quot;);</span>
<a href="#l47.27"></a><span id="l47.27"> </span>
<a href="#l47.28"></a><span id="l47.28"> // Items used to add messages to the folder</span>
<a href="#l47.29"></a><span id="l47.29"> var gMessageGenerator = new MessageGenerator();</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineat">@@ -30,24 +36,25 @@ function setup_globals(aNextFunc) {</span>
<a href="#l47.31"></a><span id="l47.31">   // build up a diverse list of messages</span>
<a href="#l47.32"></a><span id="l47.32">   let messages = [];</span>
<a href="#l47.33"></a><span id="l47.33">   messages = messages.concat(gScenarioFactory.directReply(10));</span>
<a href="#l47.34"></a><span id="l47.34">   // the message generator uses a constanty incrementing counter, so we need to</span>
<a href="#l47.35"></a><span id="l47.35">   //  mix up the order of messages ourselves to ensure that the timestamp</span>
<a href="#l47.36"></a><span id="l47.36">   //  ordering is not already in order.  (a poor test of sorting otherwise.)</span>
<a href="#l47.37"></a><span id="l47.37">   messages = gScenarioFactory.directReply(6).concat(messages);</span>
<a href="#l47.38"></a><span id="l47.38"> </span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-  messages = messages.concat(gScenarioFactory.fullPyramid(3,3));</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineplus">+  messages = messages.concat(gScenarioFactory.fullPyramid(3, 3));</span>
<a href="#l47.41"></a><span id="l47.41">   let siblingMessages = gScenarioFactory.siblingsMissingParent();</span>
<a href="#l47.42"></a><span id="l47.42">   // cut off &quot;Re: &quot; part</span>
<a href="#l47.43"></a><span id="l47.43">   gSiblingsMissingParentsSubject = siblingMessages[0].subject.slice(4);</span>
<a href="#l47.44"></a><span id="l47.44">   dump(&quot;siblings subect = &quot; + gSiblingsMissingParentsSubject + &quot;\n&quot;);</span>
<a href="#l47.45"></a><span id="l47.45">   messages = messages.concat(siblingMessages);</span>
<a href="#l47.46"></a><span id="l47.46">   messages = messages.concat(gScenarioFactory.missingIntermediary());</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-  messages.concat(gMessageGenerator.makeMessage({age: {days: 2, hours: 1}}));</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+  // This next line was found to be faulty during linting, but fixing it breaks the test.</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+  // messages.concat(gMessageGenerator.makeMessage({age: {days: 2, hours: 1}}));</span>
<a href="#l47.50"></a><span id="l47.50"> </span>
<a href="#l47.51"></a><span id="l47.51">   // build a hierarchy like this (the UID order corresponds to the date order)</span>
<a href="#l47.52"></a><span id="l47.52">   //   1</span>
<a href="#l47.53"></a><span id="l47.53">   //    2</span>
<a href="#l47.54"></a><span id="l47.54">   //     4</span>
<a href="#l47.55"></a><span id="l47.55">   //    3</span>
<a href="#l47.56"></a><span id="l47.56">   let msg1 = gMessageGenerator.makeMessage();</span>
<a href="#l47.57"></a><span id="l47.57">   let msg2 = gMessageGenerator.makeMessage({inReplyTo: msg1});</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineat">@@ -61,30 +68,27 @@ function setup_globals(aNextFunc) {</span>
<a href="#l47.59"></a><span id="l47.59">   messages = messages.concat([msgSmallerKey, msgBiggerKey]);</span>
<a href="#l47.60"></a><span id="l47.60">   let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l47.61"></a><span id="l47.61"> </span>
<a href="#l47.62"></a><span id="l47.62">   gTestFolder = make_empty_folder();</span>
<a href="#l47.63"></a><span id="l47.63">   return add_sets_to_folders(gTestFolder, [msgSet]);</span>
<a href="#l47.64"></a><span id="l47.64"> }</span>
<a href="#l47.65"></a><span id="l47.65"> </span>
<a href="#l47.66"></a><span id="l47.66"> var gCommandUpdater = {</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineminus">-  {</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineplus">+  updateCommandStatus() {</span>
<a href="#l47.70"></a><span id="l47.70">     // the back end is smart and is only telling us to update command status</span>
<a href="#l47.71"></a><span id="l47.71">     // when the # of items in the selection has actually changed.</span>
<a href="#l47.72"></a><span id="l47.72">   },</span>
<a href="#l47.73"></a><span id="l47.73"> </span>
<a href="#l47.74"></a><span id="l47.74" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineminus">-  {</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+  displayMessageChanged(aFolder, aSubject, aKeywords) {</span>
<a href="#l47.77"></a><span id="l47.77">   },</span>
<a href="#l47.78"></a><span id="l47.78"> </span>
<a href="#l47.79"></a><span id="l47.79" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">-  {</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineplus">+  updateNextMessageAfterDelete() {</span>
<a href="#l47.82"></a><span id="l47.82">   },</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-  summarizeSelection : function() {return false;}</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+  summarizeSelection() { return false; },</span>
<a href="#l47.85"></a><span id="l47.85"> };</span>
<a href="#l47.86"></a><span id="l47.86"> </span>
<a href="#l47.87"></a><span id="l47.87"> /**</span>
<a href="#l47.88"></a><span id="l47.88">  * Create a synthetic message by passing the provided aMessageArgs to</span>
<a href="#l47.89"></a><span id="l47.89">  *  the message generator, then add the resulting message to the given</span>
<a href="#l47.90"></a><span id="l47.90">  *  folder (or gTestFolder if no folder is provided).</span>
<a href="#l47.91"></a><span id="l47.91">  *</span>
<a href="#l47.92"></a><span id="l47.92">  * @TODO change callers to use more generic messageInjection mechanisms.</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineat">@@ -102,27 +106,26 @@ function make_and_add_message(aMessageAr</span>
<a href="#l47.94"></a><span id="l47.94"> var WHITESPACE = &quot;                                              &quot;;</span>
<a href="#l47.95"></a><span id="l47.95"> /**</span>
<a href="#l47.96"></a><span id="l47.96">  * Print out the current db view as best we can.</span>
<a href="#l47.97"></a><span id="l47.97">  */</span>
<a href="#l47.98"></a><span id="l47.98"> function dump_view_contents() {</span>
<a href="#l47.99"></a><span id="l47.99">   dump(&quot;********* Current View State\n&quot;);</span>
<a href="#l47.100"></a><span id="l47.100">   for (let iViewIndex = 0; iViewIndex &lt; gTreeView.rowCount; iViewIndex++) {</span>
<a href="#l47.101"></a><span id="l47.101">     let level = gTreeView.getLevel(iViewIndex);</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineminus">-    let viewFlags = gDBView.viewFlags;</span>
<a href="#l47.103"></a><span id="l47.103">     let flags = gDBView.getFlagsAt(iViewIndex);</span>
<a href="#l47.104"></a><span id="l47.104"> </span>
<a href="#l47.105"></a><span id="l47.105">     let s = WHITESPACE.substr(0, level * 2);</span>
<a href="#l47.106"></a><span id="l47.106">     if (gTreeView.isContainer(iViewIndex))</span>
<a href="#l47.107"></a><span id="l47.107">       s += gTreeView.isContainerOpen(iViewIndex) ? &quot;- &quot; : &quot;+ &quot;;</span>
<a href="#l47.108"></a><span id="l47.108">     else</span>
<a href="#l47.109"></a><span id="l47.109">       s += &quot;. &quot;;</span>
<a href="#l47.110"></a><span id="l47.110">     if (flags &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l47.111"></a><span id="l47.111">       s += &quot;dummy: &quot;;</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-    s += gDBView.cellTextForColumn(iViewIndex, &quot;subject&quot;)</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineplus">+    s += gDBView.cellTextForColumn(iViewIndex, &quot;subject&quot;);</span>
<a href="#l47.114"></a><span id="l47.114">     dump(s + &quot;\n&quot;);</span>
<a href="#l47.115"></a><span id="l47.115">   }</span>
<a href="#l47.116"></a><span id="l47.116">   dump(&quot;********* end view state\n&quot;);</span>
<a href="#l47.117"></a><span id="l47.117"> }</span>
<a href="#l47.118"></a><span id="l47.118"> </span>
<a href="#l47.119"></a><span id="l47.119"> function view_throw(why) {</span>
<a href="#l47.120"></a><span id="l47.120">   dump_view_contents();</span>
<a href="#l47.121"></a><span id="l47.121">   do_throw(why);</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineat">@@ -190,56 +193,51 @@ function assert_view_message_at_indices(</span>
<a href="#l47.123"></a><span id="l47.123">       let hdrAt = gDBView.getMsgHdrAt(thing);</span>
<a href="#l47.124"></a><span id="l47.124">       if (curHdr != hdrAt) {</span>
<a href="#l47.125"></a><span id="l47.125">         view_throw(&quot;Expected hdr at &quot; + thing + &quot; to be &quot; +</span>
<a href="#l47.126"></a><span id="l47.126">                   curHdr.messageKey + &quot;:&quot; +</span>
<a href="#l47.127"></a><span id="l47.127">                    curHdr.mime2DecodedSubject.substr(0, 30) + &quot; not &quot; +</span>
<a href="#l47.128"></a><span id="l47.128">                   hdrAt.messageKey + &quot;:&quot; +</span>
<a href="#l47.129"></a><span id="l47.129">                     hdrAt.mime2DecodedSubject.substr(0, 30));</span>
<a href="#l47.130"></a><span id="l47.130">       }</span>
<a href="#l47.131"></a><span id="l47.131" class="difflineplus">+    } else {</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineplus">+      // synthetic message, get the header...</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineplus">+      curHdr = gTestFolder.msgDatabase.getMsgHdrForMessageID(thing.messageId);</span>
<a href="#l47.134"></a><span id="l47.134">     }</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineminus">-</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineminus">-    // synthetic message, get the header...</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineminus">-    else</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineminus">-      curHdr = gTestFolder.msgDatabase.getMsgHdrForMessageID(thing.messageId);</span>
<a href="#l47.139"></a><span id="l47.139">   }</span>
<a href="#l47.140"></a><span id="l47.140"> }</span>
<a href="#l47.141"></a><span id="l47.141"> </span>
<a href="#l47.142"></a><span id="l47.142"> var authorFirstLetterCustomColumn = {</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineminus">-  getCellText: function(row, col) {</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineminus">-    let folder = this.dbView.getFolderForViewIndex(row);</span>
<a href="#l47.145"></a><span id="l47.145" class="difflineplus">+  getCellText(row, col) {</span>
<a href="#l47.146"></a><span id="l47.146">     let msgHdr = this.dbView.getMsgHdrAt(row);</span>
<a href="#l47.147"></a><span id="l47.147">     return msgHdr.mime2DecodedAuthor.charAt(0).toUpperCase() || &quot;?&quot;;</span>
<a href="#l47.148"></a><span id="l47.148">   },</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineminus">-  getSortStringForRow: function(msgHdr) {</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+  getSortStringForRow(msgHdr) {</span>
<a href="#l47.151"></a><span id="l47.151">     // charAt(0) is a quote, charAt(1) is the first letter!</span>
<a href="#l47.152"></a><span id="l47.152">     return msgHdr.mime2DecodedAuthor.charAt(1).toUpperCase() || &quot;?&quot;;</span>
<a href="#l47.153"></a><span id="l47.153">   },</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineminus">-  isString: function() {</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineplus">+  isString() {</span>
<a href="#l47.156"></a><span id="l47.156">     return true;</span>
<a href="#l47.157"></a><span id="l47.157">   },</span>
<a href="#l47.158"></a><span id="l47.158"> </span>
<a href="#l47.159"></a><span id="l47.159" class="difflineminus">-  getCellProperties:   function(row, col) { return &quot;&quot;; },</span>
<a href="#l47.160"></a><span id="l47.160" class="difflineminus">-  getRowProperties:    function(row) { return &quot;&quot;; },</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineminus">-  getImageSrc:         function(row, col) {return null;},</span>
<a href="#l47.162"></a><span id="l47.162" class="difflineminus">-  getSortLongForRow:   function(hdr) {return 0;}</span>
<a href="#l47.163"></a><span id="l47.163" class="difflineplus">+  getCellProperties(row, col) { return &quot;&quot;; },</span>
<a href="#l47.164"></a><span id="l47.164" class="difflineplus">+  getRowProperties(row) { return &quot;&quot;; },</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineplus">+  getImageSrc(row, col) { return null; },</span>
<a href="#l47.166"></a><span id="l47.166" class="difflineplus">+  getSortLongForRow(hdr) { return 0; },</span>
<a href="#l47.167"></a><span id="l47.167"> };</span>
<a href="#l47.168"></a><span id="l47.168"> </span>
<a href="#l47.169"></a><span id="l47.169"> var gDBView;</span>
<a href="#l47.170"></a><span id="l47.170"> var gTreeView;</span>
<a href="#l47.171"></a><span id="l47.171"> </span>
<a href="#l47.172"></a><span id="l47.172"> var ViewType = Ci.nsMsgViewType;</span>
<a href="#l47.173"></a><span id="l47.173"> var SortType = Ci.nsMsgViewSortType;</span>
<a href="#l47.174"></a><span id="l47.174"> var SortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l47.175"></a><span id="l47.175"> var ViewFlags = Ci.nsMsgViewFlagsType;</span>
<a href="#l47.176"></a><span id="l47.176" class="difflineminus">-var MsgFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l47.177"></a><span id="l47.177"> </span>
<a href="#l47.178"></a><span id="l47.178"> var MSG_VIEW_FLAG_DUMMY = 0x20000000;</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineminus">-var MSG_VIEW_FLAG_HASCHILDREN = 0x40000000;</span>
<a href="#l47.180"></a><span id="l47.180" class="difflineminus">-var MSG_VIEW_FLAG_ISTHREAD = 0x8000000;</span>
<a href="#l47.181"></a><span id="l47.181"> </span>
<a href="#l47.182"></a><span id="l47.182"> var gFakeSelection = new JSTreeSelection(null);</span>
<a href="#l47.183"></a><span id="l47.183"> </span>
<a href="#l47.184"></a><span id="l47.184"> function setup_view(aViewType, aViewFlags, aTestFolder) {</span>
<a href="#l47.185"></a><span id="l47.185">   let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot; + aViewType;</span>
<a href="#l47.186"></a><span id="l47.186"> </span>
<a href="#l47.187"></a><span id="l47.187">   if (aTestFolder == null)</span>
<a href="#l47.188"></a><span id="l47.188">     aTestFolder = gTestFolder;</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineat">@@ -313,18 +311,17 @@ function setup_group_view(aSortType, aSo</span>
<a href="#l47.190"></a><span id="l47.190"> /**</span>
<a href="#l47.191"></a><span id="l47.191">  * Comparison func for built-in types (including strings, so no subtraction.)</span>
<a href="#l47.192"></a><span id="l47.192">  */</span>
<a href="#l47.193"></a><span id="l47.193"> function generalCmp(a, b) {</span>
<a href="#l47.194"></a><span id="l47.194">   if (a &lt; b)</span>
<a href="#l47.195"></a><span id="l47.195">     return -1;</span>
<a href="#l47.196"></a><span id="l47.196">   else if (a &gt; b)</span>
<a href="#l47.197"></a><span id="l47.197">     return 1;</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineminus">-  else</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineminus">-    return 0;</span>
<a href="#l47.200"></a><span id="l47.200" class="difflineplus">+  return 0;</span>
<a href="#l47.201"></a><span id="l47.201"> }</span>
<a href="#l47.202"></a><span id="l47.202"> </span>
<a href="#l47.203"></a><span id="l47.203"> /**</span>
<a href="#l47.204"></a><span id="l47.204">  * Check that sort order and grouping logic (if applicable) are doing the right</span>
<a href="#l47.205"></a><span id="l47.205">  *  thing.</span>
<a href="#l47.206"></a><span id="l47.206">  *</span>
<a href="#l47.207"></a><span id="l47.207">  * In the case of groups (indicated by dummy headers), we want to ignore the</span>
<a href="#l47.208"></a><span id="l47.208">  *  dummies and 1) make sure all the values in the group have the same value,</span>
<a href="#l47.209"></a><span id="l47.209" class="difflineat">@@ -359,18 +356,17 @@ function ensure_view_ordering(aSortBy, a</span>
<a href="#l47.210"></a><span id="l47.210">   //  realize that it shouldn't do the right thing, so it can just change the</span>
<a href="#l47.211"></a><span id="l47.211">   //  sort.  (of course, under the hood, it is actually creating a new view...)</span>
<a href="#l47.212"></a><span id="l47.212">   if ((gDBView.viewFlags &amp; ViewFlags.kGroupBySort) &amp;&amp;</span>
<a href="#l47.213"></a><span id="l47.213">       (gDBView.viewType != ViewType.eShowSearch)) {</span>
<a href="#l47.214"></a><span id="l47.214">     // we must close to re-open (or we could just use a new view)</span>
<a href="#l47.215"></a><span id="l47.215">     let msgFolder = gDBView.msgFolder;</span>
<a href="#l47.216"></a><span id="l47.216">     gDBView.close();</span>
<a href="#l47.217"></a><span id="l47.217">     gDBView.open(msgFolder, aSortBy, aDirection, gDBView.viewFlags, {});</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-  }</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineminus">-  else {</span>
<a href="#l47.220"></a><span id="l47.220" class="difflineplus">+  } else {</span>
<a href="#l47.221"></a><span id="l47.221">     gDBView.sort(aSortBy, aDirection);</span>
<a href="#l47.222"></a><span id="l47.222">   }</span>
<a href="#l47.223"></a><span id="l47.223"> </span>
<a href="#l47.224"></a><span id="l47.224">   let comparisonValuesByLevel = [];</span>
<a href="#l47.225"></a><span id="l47.225">   let expectedLevel0CmpResult = (aDirection == SortOrder.ascending ? 1 : -1);</span>
<a href="#l47.226"></a><span id="l47.226">   let comparator = generalCmp;</span>
<a href="#l47.227"></a><span id="l47.227"> </span>
<a href="#l47.228"></a><span id="l47.228">   let dummyCount = 0, emptyDummyCount = 0;</span>
<a href="#l47.229"></a><span id="l47.229" class="difflineat">@@ -427,19 +423,18 @@ function ensure_view_ordering(aSortBy, a</span>
<a href="#l47.230"></a><span id="l47.230">     }</span>
<a href="#l47.231"></a><span id="l47.231"> </span>
<a href="#l47.232"></a><span id="l47.232">     // is this level new to our comparisons?  then track it...</span>
<a href="#l47.233"></a><span id="l47.233">     if (level &gt;= comparisonValuesByLevel.length) {</span>
<a href="#l47.234"></a><span id="l47.234">       // null-fill any gaps (due to, say, dummy nodes)</span>
<a href="#l47.235"></a><span id="l47.235">       while (comparisonValuesByLevel.length &lt;= level)</span>
<a href="#l47.236"></a><span id="l47.236">         comparisonValuesByLevel.push(null);</span>
<a href="#l47.237"></a><span id="l47.237">       comparisonValuesByLevel.push(curValue);</span>
<a href="#l47.238"></a><span id="l47.238" class="difflineminus">-    }</span>
<a href="#l47.239"></a><span id="l47.239" class="difflineminus">-    else { // otherwise compare it</span>
<a href="#l47.240"></a><span id="l47.240" class="difflineminus">-      let prevValue = comparisonValuesByLevel[level-1];</span>
<a href="#l47.241"></a><span id="l47.241" class="difflineplus">+    } else { // otherwise compare it</span>
<a href="#l47.242"></a><span id="l47.242" class="difflineplus">+      let prevValue = comparisonValuesByLevel[level - 1];</span>
<a href="#l47.243"></a><span id="l47.243">       let cmpResult = comparator(curValue, prevValue);</span>
<a href="#l47.244"></a><span id="l47.244">       let expectedCmpResult = (level &gt; 0) ? 1 : expectedLevel0CmpResult;</span>
<a href="#l47.245"></a><span id="l47.245">       if (cmpResult &amp;&amp; cmpResult != expectedCmpResult)</span>
<a href="#l47.246"></a><span id="l47.246">         do_throw(&quot;Ordering failure on key &quot; + msgHdr.messageKey + &quot;. &quot; +</span>
<a href="#l47.247"></a><span id="l47.247">                  curValue + &quot; should have been &quot; +</span>
<a href="#l47.248"></a><span id="l47.248">                  (expectedCmpResult == 1 ? &quot;&gt;=&quot; : &quot;&lt;=&quot;) + &quot; &quot; +</span>
<a href="#l47.249"></a><span id="l47.249">                  prevValue + &quot; but was not.&quot;);</span>
<a href="#l47.250"></a><span id="l47.250">     }</span>
<a href="#l47.251"></a><span id="l47.251" class="difflineat">@@ -451,53 +446,53 @@ function ensure_view_ordering(aSortBy, a</span>
<a href="#l47.252"></a><span id="l47.252">     dump(&quot;  saw &quot; + dummyCount + &quot; dummy headers (&quot; + emptyDummyCount +</span>
<a href="#l47.253"></a><span id="l47.253">          &quot; empty).\n&quot;);</span>
<a href="#l47.254"></a><span id="l47.254"> }</span>
<a href="#l47.255"></a><span id="l47.255"> </span>
<a href="#l47.256"></a><span id="l47.256"> /**</span>
<a href="#l47.257"></a><span id="l47.257">  * Test sorting functionality.</span>
<a href="#l47.258"></a><span id="l47.258">  */</span>
<a href="#l47.259"></a><span id="l47.259"> function test_sort_columns() {</span>
<a href="#l47.260"></a><span id="l47.260" class="difflineminus">-  ensure_view_ordering(SortType.byDate, SortOrder.descending, 'date',</span>
<a href="#l47.261"></a><span id="l47.261" class="difflineplus">+  ensure_view_ordering(SortType.byDate, SortOrder.descending, &quot;date&quot;,</span>
<a href="#l47.262"></a><span id="l47.262">     function getDateAgeBucket(msgHdr) {</span>
<a href="#l47.263"></a><span id="l47.263">       // so, this is a cop-out, but we know that the date age bucket for our</span>
<a href="#l47.264"></a><span id="l47.264">       //  generated messages is always more than 2-weeks ago!</span>
<a href="#l47.265"></a><span id="l47.265">       return 5;</span>
<a href="#l47.266"></a><span id="l47.266">     });</span>
<a href="#l47.267"></a><span id="l47.267" class="difflineminus">-  ensure_view_ordering(SortType.byDate, SortOrder.ascending, 'date',</span>
<a href="#l47.268"></a><span id="l47.268" class="difflineplus">+  ensure_view_ordering(SortType.byDate, SortOrder.ascending, &quot;date&quot;,</span>
<a href="#l47.269"></a><span id="l47.269">     function getDateAgeBucket(msgHdr) {</span>
<a href="#l47.270"></a><span id="l47.270">       // so, this is a cop-out, but we know that the date age bucket for our</span>
<a href="#l47.271"></a><span id="l47.271">       //  generated messages is always more than 2-weeks ago!</span>
<a href="#l47.272"></a><span id="l47.272">       return 5;</span>
<a href="#l47.273"></a><span id="l47.273">     });</span>
<a href="#l47.274"></a><span id="l47.274">   // (note, subject doesn't use dummy groups and so won't have grouping tested)</span>
<a href="#l47.275"></a><span id="l47.275" class="difflineminus">-  ensure_view_ordering(SortType.bySubject, SortOrder.ascending, 'mime2DecodedSubject');</span>
<a href="#l47.276"></a><span id="l47.276" class="difflineminus">-  ensure_view_ordering(SortType.byAuthor, SortOrder.ascending, 'mime2DecodedAuthor');</span>
<a href="#l47.277"></a><span id="l47.277" class="difflineplus">+  ensure_view_ordering(SortType.bySubject, SortOrder.ascending, &quot;mime2DecodedSubject&quot;);</span>
<a href="#l47.278"></a><span id="l47.278" class="difflineplus">+  ensure_view_ordering(SortType.byAuthor, SortOrder.ascending, &quot;mime2DecodedAuthor&quot;);</span>
<a href="#l47.279"></a><span id="l47.279">   // Id</span>
<a href="#l47.280"></a><span id="l47.280">   // Thread</span>
<a href="#l47.281"></a><span id="l47.281">   // Priority</span>
<a href="#l47.282"></a><span id="l47.282">   // Status</span>
<a href="#l47.283"></a><span id="l47.283">   // Size</span>
<a href="#l47.284"></a><span id="l47.284">   // Flagged</span>
<a href="#l47.285"></a><span id="l47.285">   // Unread</span>
<a href="#l47.286"></a><span id="l47.286" class="difflineminus">-  ensure_view_ordering(SortType.byRecipient, SortOrder.ascending, 'mime2DecodedRecipients');</span>
<a href="#l47.287"></a><span id="l47.287" class="difflineplus">+  ensure_view_ordering(SortType.byRecipient, SortOrder.ascending, &quot;mime2DecodedRecipients&quot;);</span>
<a href="#l47.288"></a><span id="l47.288">   // Location</span>
<a href="#l47.289"></a><span id="l47.289">   // Tags</span>
<a href="#l47.290"></a><span id="l47.290">   // JunkStatus</span>
<a href="#l47.291"></a><span id="l47.291">   // Attachments</span>
<a href="#l47.292"></a><span id="l47.292">   // Account</span>
<a href="#l47.293"></a><span id="l47.293">   // Custom</span>
<a href="#l47.294"></a><span id="l47.294">   ensure_view_ordering(SortType.byCustom, SortOrder.ascending,</span>
<a href="#l47.295"></a><span id="l47.295" class="difflineminus">-    function (msgHdr) {</span>
<a href="#l47.296"></a><span id="l47.296" class="difflineplus">+    function(msgHdr) {</span>
<a href="#l47.297"></a><span id="l47.297">       return authorFirstLetterCustomColumn.getSortStringForRow(msgHdr);</span>
<a href="#l47.298"></a><span id="l47.298">     });</span>
<a href="#l47.299"></a><span id="l47.299">   // Received</span>
<a href="#l47.300"></a><span id="l47.300"> }</span>
<a href="#l47.301"></a><span id="l47.301"> </span>
<a href="#l47.302"></a><span id="l47.302" class="difflineminus">-function  test_number_of_messages() {</span>
<a href="#l47.303"></a><span id="l47.303" class="difflineplus">+function test_number_of_messages() {</span>
<a href="#l47.304"></a><span id="l47.304">   // Bug 574799</span>
<a href="#l47.305"></a><span id="l47.305">   if (gDBView.numMsgsInView != gTestFolder.getTotalMessages(false))</span>
<a href="#l47.306"></a><span id="l47.306">     do_throw(&quot;numMsgsInView is &quot; + gDBView.numMsgsInView + &quot; but should be &quot; +</span>
<a href="#l47.307"></a><span id="l47.307">              gTestFolder.getTotalMessages(false) + &quot;\n&quot;);</span>
<a href="#l47.308"></a><span id="l47.308">   // Bug 600140</span>
<a href="#l47.309"></a><span id="l47.309">   // Maybe elided so open it, now only consider the first one</span>
<a href="#l47.310"></a><span id="l47.310">   if (gDBView.isContainer(0) &amp;&amp; !gDBView.isContainerOpen(0))</span>
<a href="#l47.311"></a><span id="l47.311">     gDBView.toggleOpenState(0);</span>
<a href="#l47.312"></a><span id="l47.312" class="difflineat">@@ -519,35 +514,35 @@ function test_selected_messages() {</span>
<a href="#l47.313"></a><span id="l47.313">   // Select one message</span>
<a href="#l47.314"></a><span id="l47.314">   gTreeView.selection.select(1);</span>
<a href="#l47.315"></a><span id="l47.315">   let selectedMessages = gDBView.getSelectedMsgHdrs();</span>
<a href="#l47.316"></a><span id="l47.316"> </span>
<a href="#l47.317"></a><span id="l47.317">   if (selectedMessages.length != 1)</span>
<a href="#l47.318"></a><span id="l47.318">     do_throw(&quot;getSelectedMsgHdrs.length is &quot; + selectedMessages.length +</span>
<a href="#l47.319"></a><span id="l47.319">              &quot; but should be 1\n&quot;);</span>
<a href="#l47.320"></a><span id="l47.320"> </span>
<a href="#l47.321"></a><span id="l47.321" class="difflineminus">-  let firstSelectedMsg = gDBView.hdrForFirstSelectedMessage</span>
<a href="#l47.322"></a><span id="l47.322" class="difflineplus">+  let firstSelectedMsg = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l47.323"></a><span id="l47.323">   if (selectedMessages[0] != firstSelectedMsg)</span>
<a href="#l47.324"></a><span id="l47.324">     do_throw(&quot;getSelectedMsgHdrs[0] is &quot; + selectedMessages[0].messageKey +</span>
<a href="#l47.325"></a><span id="l47.325" class="difflineminus">-             &quot; but should be &quot; + firstSelectedMsg.messageKey +&quot;\n&quot;);</span>
<a href="#l47.326"></a><span id="l47.326" class="difflineplus">+             &quot; but should be &quot; + firstSelectedMsg.messageKey + &quot;\n&quot;);</span>
<a href="#l47.327"></a><span id="l47.327"> </span>
<a href="#l47.328"></a><span id="l47.328">   // Select all messages</span>
<a href="#l47.329"></a><span id="l47.329">   gTreeView.selection.selectAll();</span>
<a href="#l47.330"></a><span id="l47.330">   if (gDBView.numSelected != gTreeView.rowCount)</span>
<a href="#l47.331"></a><span id="l47.331">     do_throw(&quot;numSelected is &quot; + gDBView.numSelected + &quot; but should be &quot; +</span>
<a href="#l47.332"></a><span id="l47.332">              gTreeView.rowCount + &quot;\n&quot;);</span>
<a href="#l47.333"></a><span id="l47.333"> </span>
<a href="#l47.334"></a><span id="l47.334">   selectedMessages = gDBView.getSelectedMsgHdrs();</span>
<a href="#l47.335"></a><span id="l47.335">   if (selectedMessages.length != gTestFolder.getTotalMessages(false))</span>
<a href="#l47.336"></a><span id="l47.336">     do_throw(&quot;getSelectedMsgHdrs.length is &quot; + selectedMessages.length +</span>
<a href="#l47.337"></a><span id="l47.337">              &quot; but should be &quot; + gTestFolder.getTotalMessages(false) + &quot;\n&quot;);</span>
<a href="#l47.338"></a><span id="l47.338"> </span>
<a href="#l47.339"></a><span id="l47.339">   for (let i = 0; i &lt; selectedMessages.length; i++) {</span>
<a href="#l47.340"></a><span id="l47.340">     let expectedHdr = gDBView.getMsgHdrAt(i);</span>
<a href="#l47.341"></a><span id="l47.341" class="difflineminus">-    if (selectedMessages.indexOf(expectedHdr) == -1) {</span>
<a href="#l47.342"></a><span id="l47.342" class="difflineplus">+    if (!selectedMessages.includes(expectedHdr)) {</span>
<a href="#l47.343"></a><span id="l47.343">       view_throw(&quot;Expected &quot; + expectedHdr.messageKey + &quot;:&quot; +</span>
<a href="#l47.344"></a><span id="l47.344">                  expectedHdr.mime2DecodedSubject.substr(0, 30) +</span>
<a href="#l47.345"></a><span id="l47.345">                  &quot; to be selected, but it wasn't\n&quot;);</span>
<a href="#l47.346"></a><span id="l47.346">     }</span>
<a href="#l47.347"></a><span id="l47.347">   }</span>
<a href="#l47.348"></a><span id="l47.348"> </span>
<a href="#l47.349"></a><span id="l47.349">   gTreeView.selection.clearSelection();</span>
<a href="#l47.350"></a><span id="l47.350"> }</span>
<a href="#l47.351"></a><span id="l47.351" class="difflineat">@@ -573,40 +568,37 @@ function test_insert_remove_view_rows() </span>
<a href="#l47.352"></a><span id="l47.352">     view_throw(&quot;msgKey is &quot; + key + &quot; but should be &quot; + msgKey + &quot;\n&quot;);</span>
<a href="#l47.353"></a><span id="l47.353">   gDBView.removeTreeRows(index, rows);</span>
<a href="#l47.354"></a><span id="l47.354">   assert_view_row_count(startCount);</span>
<a href="#l47.355"></a><span id="l47.355"> </span>
<a href="#l47.356"></a><span id="l47.356">   // These should fail.</span>
<a href="#l47.357"></a><span id="l47.357">   try {</span>
<a href="#l47.358"></a><span id="l47.358">     gDBView.insertTreeRows(startCount + 10, rows, msgKey, flags, level, folder);</span>
<a href="#l47.359"></a><span id="l47.359">     view_throw(&quot;expected exception not caught; inserting at illegal index \n&quot;);</span>
<a href="#l47.360"></a><span id="l47.360" class="difflineminus">-  }</span>
<a href="#l47.361"></a><span id="l47.361" class="difflineminus">-  catch (ex) {}</span>
<a href="#l47.362"></a><span id="l47.362" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l47.363"></a><span id="l47.363">   try {</span>
<a href="#l47.364"></a><span id="l47.364">     gDBView.insertTreeRows(index, rows, msgKey, flags, level, folder);</span>
<a href="#l47.365"></a><span id="l47.365">     gDBView.removeTreeRows(index, gTreeView.rowCount + 10);</span>
<a href="#l47.366"></a><span id="l47.366">     view_throw(&quot;expected exception not caught; removing illegal rows \n&quot;);</span>
<a href="#l47.367"></a><span id="l47.367" class="difflineminus">-  }</span>
<a href="#l47.368"></a><span id="l47.368" class="difflineminus">-  catch (ex) {</span>
<a href="#l47.369"></a><span id="l47.369" class="difflineplus">+  } catch (ex) {</span>
<a href="#l47.370"></a><span id="l47.370">     gDBView.removeTreeRows(index, rows);</span>
<a href="#l47.371"></a><span id="l47.371">   }</span>
<a href="#l47.372"></a><span id="l47.372">   if (xfview)</span>
<a href="#l47.373"></a><span id="l47.373">     try {</span>
<a href="#l47.374"></a><span id="l47.374">       gDBView.insertTreeRows(index, rows, msgKey, flags, level, null);</span>
<a href="#l47.375"></a><span id="l47.375">       view_throw(&quot;expected exception not caught; folder required for xfvf view \n&quot;);</span>
<a href="#l47.376"></a><span id="l47.376" class="difflineminus">-    }</span>
<a href="#l47.377"></a><span id="l47.377" class="difflineminus">-    catch (ex) {}</span>
<a href="#l47.378"></a><span id="l47.378" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l47.379"></a><span id="l47.379"> }</span>
<a href="#l47.380"></a><span id="l47.380"> </span>
<a href="#l47.381"></a><span id="l47.381"> function test_msg_added_to_search_view() {</span>
<a href="#l47.382"></a><span id="l47.382">   // if the view is a non-grouped search view, test adding a header to</span>
<a href="#l47.383"></a><span id="l47.383">   // the search results, and verify it gets put at top.</span>
<a href="#l47.384"></a><span id="l47.384" class="difflineminus">-  if (! (gDBView.viewFlags &amp; ViewFlags.kGroupBySort)) {</span>
<a href="#l47.385"></a><span id="l47.385" class="difflineplus">+  if (!(gDBView.viewFlags &amp; ViewFlags.kGroupBySort)) {</span>
<a href="#l47.386"></a><span id="l47.386">     gDBView.sort(SortType.byDate, SortOrder.descending);</span>
<a href="#l47.387"></a><span id="l47.387" class="difflineminus">-    let [synMsg, synSet] = make_and_add_message();</span>
<a href="#l47.388"></a><span id="l47.388" class="difflineplus">+    let [synMsg] = make_and_add_message();</span>
<a href="#l47.389"></a><span id="l47.389">     let msgHdr = gTestFolder.msgDatabase.getMsgHdrForMessageID(synMsg.messageId);</span>
<a href="#l47.390"></a><span id="l47.390">     gDBView.QueryInterface(Ci.nsIMsgSearchNotify)</span>
<a href="#l47.391"></a><span id="l47.391">             .onSearchHit(msgHdr, msgHdr.folder);</span>
<a href="#l47.392"></a><span id="l47.392">     assert_view_message_at_indices(synMsg, 0);</span>
<a href="#l47.393"></a><span id="l47.393">   }</span>
<a href="#l47.394"></a><span id="l47.394"> }</span>
<a href="#l47.395"></a><span id="l47.395"> </span>
<a href="#l47.396"></a><span id="l47.396"> function IsHdrChildOf(possibleParent, possibleChild) {</span>
<a href="#l47.397"></a><span id="l47.397" class="difflineat">@@ -617,22 +609,21 @@ function IsHdrChildOf(possibleParent, po</span>
<a href="#l47.398"></a><span id="l47.398">       return true;</span>
<a href="#l47.399"></a><span id="l47.399">   }</span>
<a href="#l47.400"></a><span id="l47.400">   return false;</span>
<a href="#l47.401"></a><span id="l47.401"> }</span>
<a href="#l47.402"></a><span id="l47.402"> </span>
<a href="#l47.403"></a><span id="l47.403"> // This could be part of ensure_view_ordering() but I don't want to make that</span>
<a href="#l47.404"></a><span id="l47.404"> // function any harder to read.</span>
<a href="#l47.405"></a><span id="l47.405"> function test_threading_levels() {</span>
<a href="#l47.406"></a><span id="l47.406" class="difflineminus">-</span>
<a href="#l47.407"></a><span id="l47.407">   if (!gTreeView.rowCount)</span>
<a href="#l47.408"></a><span id="l47.408">     do_throw(&quot;There are no rows in my folder! I can't test anything!&quot;);</span>
<a href="#l47.409"></a><span id="l47.409">   // only look at threaded, non-grouped views.</span>
<a href="#l47.410"></a><span id="l47.410">   if ((gDBView.viewFlags &amp; ViewFlags.kGroupBySort) ||</span>
<a href="#l47.411"></a><span id="l47.411" class="difflineminus">-      ! (gDBView.viewFlags &amp; ViewFlags.kThreadedDisplay))</span>
<a href="#l47.412"></a><span id="l47.412" class="difflineplus">+      !(gDBView.viewFlags &amp; ViewFlags.kThreadedDisplay))</span>
<a href="#l47.413"></a><span id="l47.413">     return;</span>
<a href="#l47.414"></a><span id="l47.414"> </span>
<a href="#l47.415"></a><span id="l47.415">   let prevLevel = 1;</span>
<a href="#l47.416"></a><span id="l47.416">   let prevMsgHdr;</span>
<a href="#l47.417"></a><span id="l47.417">   for (let iViewIndex = 0; iViewIndex &lt; gTreeView.rowCount; iViewIndex++) {</span>
<a href="#l47.418"></a><span id="l47.418">     let msgHdr = gDBView.getMsgHdrAt(iViewIndex);</span>
<a href="#l47.419"></a><span id="l47.419">     let level = gTreeView.getLevel(iViewIndex);</span>
<a href="#l47.420"></a><span id="l47.420">     if (level &gt; prevLevel &amp;&amp; msgHdr.subject != gSiblingsMissingParentsSubject) {</span>
<a href="#l47.421"></a><span id="l47.421" class="difflineat">@@ -672,32 +663,31 @@ function test_qs_results() {</span>
<a href="#l47.422"></a><span id="l47.422">     view_throw(&quot;second message should be at level 1&quot;);</span>
<a href="#l47.423"></a><span id="l47.423">   if (gTreeView.getLevel(2) != 2)</span>
<a href="#l47.424"></a><span id="l47.424">     view_throw(&quot;third message should be at level 2&quot;);</span>
<a href="#l47.425"></a><span id="l47.425">   test_threading_levels();</span>
<a href="#l47.426"></a><span id="l47.426"> }</span>
<a href="#l47.427"></a><span id="l47.427"> </span>
<a href="#l47.428"></a><span id="l47.428"> function test_group_sort_collapseAll_expandAll_threading() {</span>
<a href="#l47.429"></a><span id="l47.429">   // - start with an empty folder</span>
<a href="#l47.430"></a><span id="l47.430" class="difflineminus">-  let save_gTestFolder = gTestFolder;</span>
<a href="#l47.431"></a><span id="l47.431">   gTestFolder = make_empty_folder();</span>
<a href="#l47.432"></a><span id="l47.432"> </span>
<a href="#l47.433"></a><span id="l47.433">   // - create a normal unthreaded view</span>
<a href="#l47.434"></a><span id="l47.434">   setup_view(&quot;threaded&quot;, 0);</span>
<a href="#l47.435"></a><span id="l47.435"> </span>
<a href="#l47.436"></a><span id="l47.436">   // - ensure it's empty</span>
<a href="#l47.437"></a><span id="l47.437">   assert_view_empty();</span>
<a href="#l47.438"></a><span id="l47.438"> </span>
<a href="#l47.439"></a><span id="l47.439">   // - add 3 messages:</span>
<a href="#l47.440"></a><span id="l47.440">   // msg1: from A, custom column val A, to be starred</span>
<a href="#l47.441"></a><span id="l47.441">   // msg2: from A, custom column val A</span>
<a href="#l47.442"></a><span id="l47.442">   // msg3: from B, custom column val B</span>
<a href="#l47.443"></a><span id="l47.443" class="difflineminus">-  let [smsg1, synSet1] = make_and_add_message({from: [&quot;A&quot;, &quot;A@a.invalid&quot;]});</span>
<a href="#l47.444"></a><span id="l47.444" class="difflineminus">-  let [smsg2, synSet2] = make_and_add_message({from: [&quot;A&quot;, &quot;A@a.invalid&quot;]});</span>
<a href="#l47.445"></a><span id="l47.445" class="difflineminus">-  let [smsg3, synSet3] = make_and_add_message({from: [&quot;B&quot;, &quot;B@b.invalid&quot;]});</span>
<a href="#l47.446"></a><span id="l47.446" class="difflineplus">+  let [smsg1] = make_and_add_message({from: [&quot;A&quot;, &quot;A@a.invalid&quot;]});</span>
<a href="#l47.447"></a><span id="l47.447" class="difflineplus">+  make_and_add_message({from: [&quot;A&quot;, &quot;A@a.invalid&quot;]});</span>
<a href="#l47.448"></a><span id="l47.448" class="difflineplus">+  let [smsg3] = make_and_add_message({from: [&quot;B&quot;, &quot;B@b.invalid&quot;]});</span>
<a href="#l47.449"></a><span id="l47.449"> </span>
<a href="#l47.450"></a><span id="l47.450">   assert_view_row_count(3);</span>
<a href="#l47.451"></a><span id="l47.451">   gDBView.getMsgHdrAt(0).markFlagged(true);</span>
<a href="#l47.452"></a><span id="l47.452">   if (!gDBView.getMsgHdrAt(0).isFlagged)</span>
<a href="#l47.453"></a><span id="l47.453">     view_throw(&quot;Expected smsg1 to be flagged&quot;);</span>
<a href="#l47.454"></a><span id="l47.454"> </span>
<a href="#l47.455"></a><span id="l47.455">   // - create grouped view; open folder in byFlagged AZ sort</span>
<a href="#l47.456"></a><span id="l47.456">   setup_group_view(SortType.byFlagged, SortOrder.ascending, gTestFolder);</span>
<a href="#l47.457"></a><span id="l47.457" class="difflineat">@@ -755,17 +745,16 @@ function test_group_sort_collapseAll_exp</span>
<a href="#l47.458"></a><span id="l47.458">   assert_view_index_is_not_dummy(3);</span>
<a href="#l47.459"></a><span id="l47.459">   assert_view_index_is_not_dummy(4);</span>
<a href="#l47.460"></a><span id="l47.460">   if (authorFirstLetterCustomColumn.getSortStringForRow(gDBView.getMsgHdrAt(4)) != &quot;A&quot;)</span>
<a href="#l47.461"></a><span id="l47.461">     view_throw(&quot;Expected grouped by custom column, ZA sortOrder smsg2 value to be A&quot;);</span>
<a href="#l47.462"></a><span id="l47.462"> }</span>
<a href="#l47.463"></a><span id="l47.463"> </span>
<a href="#l47.464"></a><span id="l47.464"> function* test_group_dummies_under_mutation_by_date() {</span>
<a href="#l47.465"></a><span id="l47.465">   // - start with an empty folder</span>
<a href="#l47.466"></a><span id="l47.466" class="difflineminus">-  let save_gTestFolder = gTestFolder;</span>
<a href="#l47.467"></a><span id="l47.467">   gTestFolder = make_empty_folder();</span>
<a href="#l47.468"></a><span id="l47.468"> </span>
<a href="#l47.469"></a><span id="l47.469">   // - create the view</span>
<a href="#l47.470"></a><span id="l47.470">   setup_view(&quot;group&quot;, ViewFlags.kGroupBySort);</span>
<a href="#l47.471"></a><span id="l47.471">   gDBView.sort(SortType.byDate, SortOrder.ascending);</span>
<a href="#l47.472"></a><span id="l47.472"> </span>
<a href="#l47.473"></a><span id="l47.473">   // - ensure it's empty</span>
<a href="#l47.474"></a><span id="l47.474">   assert_view_empty();</span>
<a href="#l47.475"></a><span id="l47.475" class="difflineat">@@ -791,17 +780,17 @@ function* test_group_dummies_under_mutat</span>
<a href="#l47.476"></a><span id="l47.476">   // - move the messages to the trash</span>
<a href="#l47.477"></a><span id="l47.477">   yield async_trash_messages(synSet);</span>
<a href="#l47.478"></a><span id="l47.478"> </span>
<a href="#l47.479"></a><span id="l47.479">   // - make sure the message and dummy disappear</span>
<a href="#l47.480"></a><span id="l47.480">   assert_view_empty();</span>
<a href="#l47.481"></a><span id="l47.481"> </span>
<a href="#l47.482"></a><span id="l47.482">   // - add two messages from this week (same date bucket concerns)</span>
<a href="#l47.483"></a><span id="l47.483">   let [newer, newerSet] = make_and_add_message({age: {days: 2, hours: 1}});</span>
<a href="#l47.484"></a><span id="l47.484" class="difflineminus">-  let [older, olderSet] = make_and_add_message({age: {days: 2, hours: 2}});</span>
<a href="#l47.485"></a><span id="l47.485" class="difflineplus">+  let [older] = make_and_add_message({age: {days: 2, hours: 2}});</span>
<a href="#l47.486"></a><span id="l47.486"> </span>
<a href="#l47.487"></a><span id="l47.487">   // - sanity check addition</span>
<a href="#l47.488"></a><span id="l47.488">   assert_view_row_count(3); // 2 messages + 1 dummy</span>
<a href="#l47.489"></a><span id="l47.489">   assert_view_index_is_dummy(0);</span>
<a href="#l47.490"></a><span id="l47.490">   assert_view_index_is_not_dummy(1, 2);</span>
<a href="#l47.491"></a><span id="l47.491">   // the dummy should be based off the older guy</span>
<a href="#l47.492"></a><span id="l47.492">   assert_view_message_at_indices(older, 0, 1);</span>
<a href="#l47.493"></a><span id="l47.493">   assert_view_message_at_indices(newer, 2);</span>
<a href="#l47.494"></a><span id="l47.494" class="difflineat">@@ -923,44 +912,44 @@ function test_thread_sorting() {</span>
<a href="#l47.495"></a><span id="l47.495"> </span>
<a href="#l47.496"></a><span id="l47.496"> var view_types = [</span>
<a href="#l47.497"></a><span id="l47.497">   [&quot;threaded&quot;, ViewFlags.kThreadedDisplay],</span>
<a href="#l47.498"></a><span id="l47.498">   [&quot;quicksearch&quot;, ViewFlags.kThreadedDisplay],</span>
<a href="#l47.499"></a><span id="l47.499">   [&quot;search&quot;, ViewFlags.kThreadedDisplay],</span>
<a href="#l47.500"></a><span id="l47.500">   [&quot;search&quot;, ViewFlags.kGroupBySort],</span>
<a href="#l47.501"></a><span id="l47.501">   [&quot;xfvf&quot;, ViewFlags.kNone],</span>
<a href="#l47.502"></a><span id="l47.502">    // group does unspeakable things to gTestFolder, so put it last.</span>
<a href="#l47.503"></a><span id="l47.503" class="difflineminus">-  [&quot;group&quot;, ViewFlags.kGroupBySort]</span>
<a href="#l47.504"></a><span id="l47.504" class="difflineplus">+  [&quot;group&quot;, ViewFlags.kGroupBySort],</span>
<a href="#l47.505"></a><span id="l47.505"> ];</span>
<a href="#l47.506"></a><span id="l47.506"> </span>
<a href="#l47.507"></a><span id="l47.507"> var tests_for_all_views = [</span>
<a href="#l47.508"></a><span id="l47.508">   test_sort_columns,</span>
<a href="#l47.509"></a><span id="l47.509">   test_number_of_messages,</span>
<a href="#l47.510"></a><span id="l47.510">   test_selected_messages,</span>
<a href="#l47.511"></a><span id="l47.511" class="difflineminus">-  test_insert_remove_view_rows</span>
<a href="#l47.512"></a><span id="l47.512" class="difflineplus">+  test_insert_remove_view_rows,</span>
<a href="#l47.513"></a><span id="l47.513"> ];</span>
<a href="#l47.514"></a><span id="l47.514"> </span>
<a href="#l47.515"></a><span id="l47.515"> var tests_for_specific_views = {</span>
<a href="#l47.516"></a><span id="l47.516">   group: [</span>
<a href="#l47.517"></a><span id="l47.517">     test_group_sort_collapseAll_expandAll_threading,</span>
<a href="#l47.518"></a><span id="l47.518" class="difflineminus">-    test_group_dummies_under_mutation_by_date</span>
<a href="#l47.519"></a><span id="l47.519" class="difflineplus">+    test_group_dummies_under_mutation_by_date,</span>
<a href="#l47.520"></a><span id="l47.520">   ],</span>
<a href="#l47.521"></a><span id="l47.521">   threaded: [</span>
<a href="#l47.522"></a><span id="l47.522">     test_expand_collapse,</span>
<a href="#l47.523"></a><span id="l47.523" class="difflineminus">-    test_thread_sorting</span>
<a href="#l47.524"></a><span id="l47.524" class="difflineplus">+    test_thread_sorting,</span>
<a href="#l47.525"></a><span id="l47.525">   ],</span>
<a href="#l47.526"></a><span id="l47.526">   search: [</span>
<a href="#l47.527"></a><span id="l47.527" class="difflineminus">-    test_msg_added_to_search_view</span>
<a href="#l47.528"></a><span id="l47.528" class="difflineplus">+    test_msg_added_to_search_view,</span>
<a href="#l47.529"></a><span id="l47.529">   ],</span>
<a href="#l47.530"></a><span id="l47.530">   quicksearch: [</span>
<a href="#l47.531"></a><span id="l47.531" class="difflineminus">-    test_qs_results</span>
<a href="#l47.532"></a><span id="l47.532" class="difflineplus">+    test_qs_results,</span>
<a href="#l47.533"></a><span id="l47.533">   ],</span>
<a href="#l47.534"></a><span id="l47.534">   xfvf: [</span>
<a href="#l47.535"></a><span id="l47.535" class="difflineminus">-    test_xfvf_threading</span>
<a href="#l47.536"></a><span id="l47.536" class="difflineminus">-  ]</span>
<a href="#l47.537"></a><span id="l47.537" class="difflineplus">+    test_xfvf_threading,</span>
<a href="#l47.538"></a><span id="l47.538" class="difflineplus">+  ],</span>
<a href="#l47.539"></a><span id="l47.539"> };</span>
<a href="#l47.540"></a><span id="l47.540"> </span>
<a href="#l47.541"></a><span id="l47.541"> function run_test() {</span>
<a href="#l47.542"></a><span id="l47.542">   configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l47.543"></a><span id="l47.543">   do_test_pending();</span>
<a href="#l47.544"></a><span id="l47.544">   async_run({func: actually_run_test});</span>
<a href="#l47.545"></a><span id="l47.545"> }</span>
<a href="#l47.546"></a><span id="l47.546"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgDBView_headerValues.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1,51 +1,86 @@</span>
<a href="#l48.4"></a><span id="l48.4"> /* Test that nsMsgDBView properly reports the values of messages in the display.</span>
<a href="#l48.5"></a><span id="l48.5">  */</span>
<a href="#l48.6"></a><span id="l48.6" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l48.7"></a><span id="l48.7" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l48.8"></a><span id="l48.8" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l48.9"></a><span id="l48.9"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l48.10"></a><span id="l48.10"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l48.11"></a><span id="l48.11"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l48.12"></a><span id="l48.12"> </span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l48.16"></a><span id="l48.16"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l48.17"></a><span id="l48.17"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l48.18"></a><span id="l48.18"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-var ViewType = Ci.nsMsgViewType;</span>
<a href="#l48.21"></a><span id="l48.21"> var SortType = Ci.nsMsgViewSortType;</span>
<a href="#l48.22"></a><span id="l48.22"> var SortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l48.23"></a><span id="l48.23"> </span>
<a href="#l48.24"></a><span id="l48.24"> // This is an array of the actual test data. Each test datum is an array of two</span>
<a href="#l48.25"></a><span id="l48.25"> // elements: the first element is the argument into a simple message generator,</span>
<a href="#l48.26"></a><span id="l48.26"> // and the second element is a map of column names to expected values when</span>
<a href="#l48.27"></a><span id="l48.27"> // requesting the cell text for a given column name.</span>
<a href="#l48.28"></a><span id="l48.28"> var tests = [</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineminus">-  [{from: &quot;John Doe &lt;db@tinderbox.invalid&gt;&quot;}, {senderCol: &quot;John Doe&quot;}],</span>
<a href="#l48.30"></a><span id="l48.30" class="difflineminus">-  [{from: &quot;\&quot;Doe, John\&quot; &lt;db@tinderbox.invalid&gt;&quot;}, {senderCol: &quot;Doe, John&quot;}],</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+  [</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+    {from: &quot;John Doe &lt;db@tinderbox.invalid&gt;&quot;},</span>
<a href="#l48.33"></a><span id="l48.33" class="difflineplus">+    {senderCol: &quot;John Doe&quot;},</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+  ],</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+  [</span>
<a href="#l48.36"></a><span id="l48.36" class="difflineplus">+    {from: &quot;\&quot;Doe, John\&quot; &lt;db@tinderbox.invalid&gt;&quot;},</span>
<a href="#l48.37"></a><span id="l48.37" class="difflineplus">+    {senderCol: &quot;Doe, John&quot;},</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineplus">+  ],</span>
<a href="#l48.39"></a><span id="l48.39">   // Multiple senders are indicated with 'et al.' suffix.</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineminus">-  [{from: &quot;John Doe &lt;db@tinderbox.invalid&gt;, Sally Ann &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-    {senderCol: &quot;John Doe et al.&quot;}],</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-  [{from: &quot;=?UTF-8?Q?David_H=C3=A5s=C3=A4ther?= &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineminus">-    {senderCol: &quot;David Hsther&quot;}],</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineminus">-  [{from: &quot;=?UTF-8?Q?H=C3=A5s=C3=A4ther=2C_David?= &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineminus">-    {senderCol: &quot;Hsther, David&quot;}],</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineminus">-  [{from: &quot;\&quot;Hsther, David\&quot; &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-    {senderCol: &quot;Hsther, David&quot;}],</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-  [{from: &quot;David Hsther &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-    {senderCol: &quot;David Hsther&quot;}],</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-  [{from: &quot;\xC2\xAB\xCE\xA0\xCE\x9F\xCE\x9B\xCE\x99\xCE\xA4\xCE\x97\xCE\xA3\xC2\xBB&quot;},</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-    {senderCol: &quot;&quot;}],</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-  [{from: &quot;John Doe \xF5  &lt;db@null.invalid&gt;&quot;,</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineminus">-     clobberHeaders: { &quot;Content-type&quot; : &quot;text/plain; charset=ISO-8859-1&quot; }},</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineminus">-    {senderCol: &quot;John Doe &quot;}],</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineminus">-  [{from: &quot;John Doe \xF5 &lt;db@null.invalid&gt;&quot;,</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineminus">-     clobberHeaders: { &quot;Content-type&quot; : &quot;text/plain; charset=ISO-8859-2&quot; }},</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineminus">-    {senderCol: &quot;John Doe &quot;}],</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineminus">-  [{from: &quot;=?UTF-8?Q?H=C3=A5s=C3=A4ther=2C_David?= &lt;db@null.invalid&gt;&quot;,</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineminus">-     clobberHeaders: { &quot;Content-type&quot; : &quot;text/plain; charset=ISO-8859-2&quot; }},</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineminus">-    {senderCol: &quot;Hsther, David&quot;}],</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+  [</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+    {from: &quot;John Doe &lt;db@tinderbox.invalid&gt;, Sally Ann &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+    {senderCol: &quot;John Doe et al.&quot;},</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+  ],</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+  [</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+    {from: &quot;=?UTF-8?Q?David_H=C3=A5s=C3=A4ther?= &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+    {senderCol: &quot;David Hsther&quot;},</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+  ],</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+  [</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+    {from: &quot;=?UTF-8?Q?H=C3=A5s=C3=A4ther=2C_David?= &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineplus">+    {senderCol: &quot;Hsther, David&quot;},</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+  ],</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+  [</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+    {from: &quot;\&quot;Hsther, David\&quot; &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+    {senderCol: &quot;Hsther, David&quot;},</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+  ],</span>
<a href="#l48.77"></a><span id="l48.77" class="difflineplus">+  [</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineplus">+    {from: &quot;David Hsther &lt;db@null.invalid&gt;&quot;},</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+    {senderCol: &quot;David Hsther&quot;},</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineplus">+  ],</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+  [</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineplus">+    {from: &quot;\xC2\xAB\xCE\xA0\xCE\x9F\xCE\x9B\xCE\x99\xCE\xA4\xCE\x97\xCE\xA3\xC2\xBB&quot;},</span>
<a href="#l48.83"></a><span id="l48.83" class="difflineplus">+    {senderCol: &quot;&quot;},</span>
<a href="#l48.84"></a><span id="l48.84" class="difflineplus">+  ],</span>
<a href="#l48.85"></a><span id="l48.85" class="difflineplus">+  [</span>
<a href="#l48.86"></a><span id="l48.86" class="difflineplus">+    {</span>
<a href="#l48.87"></a><span id="l48.87" class="difflineplus">+      from: &quot;John Doe \xF5  &lt;db@null.invalid&gt;&quot;,</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineplus">+      clobberHeaders: { &quot;Content-type&quot;: &quot;text/plain; charset=ISO-8859-1&quot; },</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineplus">+    },</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+    {senderCol: &quot;John Doe &quot;},</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+  ],</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+  [</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineplus">+    {</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineplus">+      from: &quot;John Doe \xF5 &lt;db@null.invalid&gt;&quot;,</span>
<a href="#l48.95"></a><span id="l48.95" class="difflineplus">+      clobberHeaders: { &quot;Content-type&quot;: &quot;text/plain; charset=ISO-8859-2&quot; },</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineplus">+    },</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineplus">+    {senderCol: &quot;John Doe &quot;},</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+  ],</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+  [</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+    {</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+      from: &quot;=?UTF-8?Q?H=C3=A5s=C3=A4ther=2C_David?= &lt;db@null.invalid&gt;&quot;,</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineplus">+      clobberHeaders: { &quot;Content-type&quot;: &quot;text/plain; charset=ISO-8859-2&quot; },</span>
<a href="#l48.103"></a><span id="l48.103" class="difflineplus">+    },</span>
<a href="#l48.104"></a><span id="l48.104" class="difflineplus">+    {senderCol: &quot;Hsther, David&quot;},</span>
<a href="#l48.105"></a><span id="l48.105" class="difflineplus">+  ],</span>
<a href="#l48.106"></a><span id="l48.106"> ];</span>
<a href="#l48.107"></a><span id="l48.107"> </span>
<a href="#l48.108"></a><span id="l48.108"> function* real_test() {</span>
<a href="#l48.109"></a><span id="l48.109">   // Add the messages to the folder</span>
<a href="#l48.110"></a><span id="l48.110">   let msgGenerator = new MessageGenerator();</span>
<a href="#l48.111"></a><span id="l48.111">   let genMessages = tests.map(data =&gt; msgGenerator.makeMessage(data[0]));</span>
<a href="#l48.112"></a><span id="l48.112">   let folder = make_empty_folder();</span>
<a href="#l48.113"></a><span id="l48.113">   yield add_sets_to_folder(folder, [new SyntheticMessageSet(genMessages)]);</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineat">@@ -58,17 +93,17 @@ function* real_test() {</span>
<a href="#l48.115"></a><span id="l48.115">   var outCount = {};</span>
<a href="#l48.116"></a><span id="l48.116">   dbView.open(folder, SortType.byDate, SortOrder.ascending, 0, outCount);</span>
<a href="#l48.117"></a><span id="l48.117"> </span>
<a href="#l48.118"></a><span id="l48.118">   // Did we add all the messages properly?</span>
<a href="#l48.119"></a><span id="l48.119">   let treeView = dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l48.120"></a><span id="l48.120">   Assert.equal(treeView.rowCount, tests.length);</span>
<a href="#l48.121"></a><span id="l48.121"> </span>
<a href="#l48.122"></a><span id="l48.122">   // For each test, make sure that the display is correct.</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineminus">-  tests.forEach(function (data, i) {</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineplus">+  tests.forEach(function(data, i) {</span>
<a href="#l48.125"></a><span id="l48.125">     info(&quot;Checking data for &quot; + uneval(data));</span>
<a href="#l48.126"></a><span id="l48.126">     let expected = data[1];</span>
<a href="#l48.127"></a><span id="l48.127">     for (let column in expected) {</span>
<a href="#l48.128"></a><span id="l48.128">       Assert.equal(dbView.cellTextForColumn(i, column), expected[column]);</span>
<a href="#l48.129"></a><span id="l48.129">     }</span>
<a href="#l48.130"></a><span id="l48.130">   });</span>
<a href="#l48.131"></a><span id="l48.131"> }</span>
<a href="#l48.132"></a><span id="l48.132"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgMailSession_Alerts.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,78 +1,78 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l49.5"></a><span id="l49.5"> /*</span>
<a href="#l49.6"></a><span id="l49.6">  * Test suite for nsMsgMailSession functions relating to alerts and their</span>
<a href="#l49.7"></a><span id="l49.7">  * listeners.</span>
<a href="#l49.8"></a><span id="l49.8">  */</span>
<a href="#l49.9"></a><span id="l49.9"> </span>
<a href="#l49.10"></a><span id="l49.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l49.12"></a><span id="l49.12"> </span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l49.14"></a><span id="l49.14"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l49.15"></a><span id="l49.15"> </span>
<a href="#l49.16"></a><span id="l49.16"> var gDialogTitle = null;</span>
<a href="#l49.17"></a><span id="l49.17"> var gText = null;</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19"> function reset() {</span>
<a href="#l49.20"></a><span id="l49.20">   gDialogTitle = null;</span>
<a href="#l49.21"></a><span id="l49.21">   gText = null;</span>
<a href="#l49.22"></a><span id="l49.22"> }</span>
<a href="#l49.23"></a><span id="l49.23"> </span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+/* exported alert */// Used in alertTestUtils.</span>
<a href="#l49.25"></a><span id="l49.25"> function alert(aDialogTitle, aText) {</span>
<a href="#l49.26"></a><span id="l49.26">   Assert.equal(gDialogTitle, null);</span>
<a href="#l49.27"></a><span id="l49.27">   Assert.equal(gText, null);</span>
<a href="#l49.28"></a><span id="l49.28"> </span>
<a href="#l49.29"></a><span id="l49.29">   gDialogTitle = aDialogTitle;</span>
<a href="#l49.30"></a><span id="l49.30">   gText = aText;</span>
<a href="#l49.31"></a><span id="l49.31"> }</span>
<a href="#l49.32"></a><span id="l49.32"> </span>
<a href="#l49.33"></a><span id="l49.33"> var msgWindow = {</span>
<a href="#l49.34"></a><span id="l49.34">   get promptDialog() {</span>
<a href="#l49.35"></a><span id="l49.35">     return alertUtilsPrompts;</span>
<a href="#l49.36"></a><span id="l49.36">   },</span>
<a href="#l49.37"></a><span id="l49.37"> </span>
<a href="#l49.38"></a><span id="l49.38" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgWindow])</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgWindow]),</span>
<a href="#l49.40"></a><span id="l49.40"> };</span>
<a href="#l49.41"></a><span id="l49.41"> </span>
<a href="#l49.42"></a><span id="l49.42"> var msgUrl = {</span>
<a href="#l49.43"></a><span id="l49.43">   _msgWindow: null,</span>
<a href="#l49.44"></a><span id="l49.44"> </span>
<a href="#l49.45"></a><span id="l49.45">   get msgWindow() {</span>
<a href="#l49.46"></a><span id="l49.46">     return this._msgWindow;</span>
<a href="#l49.47"></a><span id="l49.47">   },</span>
<a href="#l49.48"></a><span id="l49.48"> </span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgMailNewsUrl])</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgMailNewsUrl]),</span>
<a href="#l49.51"></a><span id="l49.51"> };</span>
<a href="#l49.52"></a><span id="l49.52"> </span>
<a href="#l49.53"></a><span id="l49.53"> function alertListener() {}</span>
<a href="#l49.54"></a><span id="l49.54"> </span>
<a href="#l49.55"></a><span id="l49.55"> alertListener.prototype = {</span>
<a href="#l49.56"></a><span id="l49.56">   mReturn: false,</span>
<a href="#l49.57"></a><span id="l49.57">   mMessage: null,</span>
<a href="#l49.58"></a><span id="l49.58">   mMsgWindow: null,</span>
<a href="#l49.59"></a><span id="l49.59"> </span>
<a href="#l49.60"></a><span id="l49.60" class="difflineminus">-  reset: function () {</span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+  reset() {</span>
<a href="#l49.62"></a><span id="l49.62">     this.mMessage = null;</span>
<a href="#l49.63"></a><span id="l49.63">     this.mMsgWindow = null;</span>
<a href="#l49.64"></a><span id="l49.64">   },</span>
<a href="#l49.65"></a><span id="l49.65"> </span>
<a href="#l49.66"></a><span id="l49.66" class="difflineminus">-  onAlert: function (aMessage, aMsgWindow) {</span>
<a href="#l49.67"></a><span id="l49.67" class="difflineplus">+  onAlert(aMessage, aMsgWindow) {</span>
<a href="#l49.68"></a><span id="l49.68">     Assert.equal(this.mMessage, null);</span>
<a href="#l49.69"></a><span id="l49.69">     Assert.equal(this.mMsgWindow, null);</span>
<a href="#l49.70"></a><span id="l49.70"> </span>
<a href="#l49.71"></a><span id="l49.71">     this.mMessage = aMessage;</span>
<a href="#l49.72"></a><span id="l49.72">     this.mMsgWindow = aMsgWindow;</span>
<a href="#l49.73"></a><span id="l49.73"> </span>
<a href="#l49.74"></a><span id="l49.74">     return this.mReturn;</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineminus">-  }</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineplus">+  },</span>
<a href="#l49.77"></a><span id="l49.77"> };</span>
<a href="#l49.78"></a><span id="l49.78"> </span>
<a href="#l49.79"></a><span id="l49.79" class="difflineminus">-function run_test()</span>
<a href="#l49.80"></a><span id="l49.80" class="difflineminus">-{</span>
<a href="#l49.81"></a><span id="l49.81" class="difflineplus">+function run_test() {</span>
<a href="#l49.82"></a><span id="l49.82">   // Test - No listeners, check alert tries to alert the user.</span>
<a href="#l49.83"></a><span id="l49.83"> </span>
<a href="#l49.84"></a><span id="l49.84">   reset();</span>
<a href="#l49.85"></a><span id="l49.85"> </span>
<a href="#l49.86"></a><span id="l49.86">   msgUrl._msgWindow = msgWindow;</span>
<a href="#l49.87"></a><span id="l49.87"> </span>
<a href="#l49.88"></a><span id="l49.88">   MailServices.mailSession.alertUser(&quot;test message&quot;, msgUrl);</span>
<a href="#l49.89"></a><span id="l49.89"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgMailSession_Listeners.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -1,69 +1,68 @@</span>
<a href="#l50.4"></a><span id="l50.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l50.5"></a><span id="l50.5"> /*</span>
<a href="#l50.6"></a><span id="l50.6">  * Test suite for nsMsgMailSession functions relating to listeners.</span>
<a href="#l50.7"></a><span id="l50.7">  */</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l50.10"></a><span id="l50.10"> </span>
<a href="#l50.11"></a><span id="l50.11" class="difflineminus">-var nsIFolderListener = Ci.nsIFolderListener;</span>
<a href="#l50.12"></a><span id="l50.12"> var numListenerFunctions = 8;</span>
<a href="#l50.13"></a><span id="l50.13"> </span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-var gMailSessionNotifier = MailServices.mailSession.QueryInterface(nsIFolderListener);</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+var gMailSessionNotifier = MailServices.mailSession.QueryInterface(Ci.nsIFolderListener);</span>
<a href="#l50.16"></a><span id="l50.16"> </span>
<a href="#l50.17"></a><span id="l50.17"> var gFLAll;</span>
<a href="#l50.18"></a><span id="l50.18"> var gFLSingle = new Array(numListenerFunctions);</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20"> function fL() {}</span>
<a href="#l50.21"></a><span id="l50.21"> </span>
<a href="#l50.22"></a><span id="l50.22"> fL.prototype = {</span>
<a href="#l50.23"></a><span id="l50.23">   mReceived: 0,</span>
<a href="#l50.24"></a><span id="l50.24">   mAutoRemoveItem: false,</span>
<a href="#l50.25"></a><span id="l50.25"> </span>
<a href="#l50.26"></a><span id="l50.26" class="difflineminus">-  OnItemAdded: function (parentItem, item) {</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineminus">-    this.mReceived |= nsIFolderListener.added;</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+  OnItemAdded(parentItem, item) {</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.added;</span>
<a href="#l50.30"></a><span id="l50.30">     if (this.mAutoRemoveItem)</span>
<a href="#l50.31"></a><span id="l50.31">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.32"></a><span id="l50.32">   },</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-  OnItemRemoved: function (parentItem, item) {</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-    this.mReceived |= nsIFolderListener.removed;</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+  OnItemRemoved(parentItem, item) {</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.removed;</span>
<a href="#l50.37"></a><span id="l50.37">     if (this.mAutoRemoveItem)</span>
<a href="#l50.38"></a><span id="l50.38">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.39"></a><span id="l50.39">   },</span>
<a href="#l50.40"></a><span id="l50.40" class="difflineminus">-  OnItemPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineminus">-    this.mReceived |= nsIFolderListener.propertyChanged;</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineplus">+  OnItemPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l50.43"></a><span id="l50.43" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.propertyChanged;</span>
<a href="#l50.44"></a><span id="l50.44">     if (this.mAutoRemoveItem)</span>
<a href="#l50.45"></a><span id="l50.45">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.46"></a><span id="l50.46">   },</span>
<a href="#l50.47"></a><span id="l50.47" class="difflineminus">-  OnItemIntPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l50.48"></a><span id="l50.48" class="difflineminus">-    this.mReceived |= nsIFolderListener.intPropertyChanged;</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineplus">+  OnItemIntPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.intPropertyChanged;</span>
<a href="#l50.51"></a><span id="l50.51">     if (this.mAutoRemoveItem)</span>
<a href="#l50.52"></a><span id="l50.52">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.53"></a><span id="l50.53">   },</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-  OnItemBoolPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineminus">-    this.mReceived |= nsIFolderListener.boolPropertyChanged;</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+  OnItemBoolPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.boolPropertyChanged;</span>
<a href="#l50.58"></a><span id="l50.58">     if (this.mAutoRemoveItem)</span>
<a href="#l50.59"></a><span id="l50.59">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.60"></a><span id="l50.60">   },</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-  OnItemUnicharPropertyChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-    this.mReceived |= nsIFolderListener.unicharPropertyChanged;</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+  OnItemUnicharPropertyChanged(item, property, oldValue, newValue) {</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.unicharPropertyChanged;</span>
<a href="#l50.65"></a><span id="l50.65">     if (this.mAutoRemoveItem)</span>
<a href="#l50.66"></a><span id="l50.66">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.67"></a><span id="l50.67">   },</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineminus">-  OnItemPropertyFlagChanged: function (item, property, oldValue, newValue) {</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-    this.mReceived |= nsIFolderListener.propertyFlagChanged;</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+  OnItemPropertyFlagChanged(item, property, oldValue, newValue) {</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.propertyFlagChanged;</span>
<a href="#l50.72"></a><span id="l50.72">     if (this.mAutoRemoveItem)</span>
<a href="#l50.73"></a><span id="l50.73">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.74"></a><span id="l50.74">   },</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineminus">-  OnItemEvent: function (parentItem, item) {</span>
<a href="#l50.76"></a><span id="l50.76" class="difflineminus">-    this.mReceived |= nsIFolderListener.event;</span>
<a href="#l50.77"></a><span id="l50.77" class="difflineplus">+  OnItemEvent(parentItem, item) {</span>
<a href="#l50.78"></a><span id="l50.78" class="difflineplus">+    this.mReceived |= Ci.nsIFolderListener.event;</span>
<a href="#l50.79"></a><span id="l50.79">     if (this.mAutoRemoveItem)</span>
<a href="#l50.80"></a><span id="l50.80">       MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l50.81"></a><span id="l50.81" class="difflineminus">-  }</span>
<a href="#l50.82"></a><span id="l50.82" class="difflineplus">+  },</span>
<a href="#l50.83"></a><span id="l50.83"> };</span>
<a href="#l50.84"></a><span id="l50.84"> </span>
<a href="#l50.85"></a><span id="l50.85"> function NotifyMailSession() {</span>
<a href="#l50.86"></a><span id="l50.86">     gMailSessionNotifier.OnItemAdded(null, null);</span>
<a href="#l50.87"></a><span id="l50.87">     gMailSessionNotifier.OnItemRemoved(null, null);</span>
<a href="#l50.88"></a><span id="l50.88">     gMailSessionNotifier.OnItemPropertyChanged(null, null, null, null);</span>
<a href="#l50.89"></a><span id="l50.89">     gMailSessionNotifier.OnItemIntPropertyChanged(null, null, null, null);</span>
<a href="#l50.90"></a><span id="l50.90">     gMailSessionNotifier.OnItemBoolPropertyChanged(null, null, null, null);</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineat">@@ -76,17 +75,17 @@ function run_test() {</span>
<a href="#l50.92"></a><span id="l50.92">   var i;</span>
<a href="#l50.93"></a><span id="l50.93"> </span>
<a href="#l50.94"></a><span id="l50.94">   Assert.ok(MailServices.mailSession != null);</span>
<a href="#l50.95"></a><span id="l50.95"> </span>
<a href="#l50.96"></a><span id="l50.96">   // Test - Add a listener</span>
<a href="#l50.97"></a><span id="l50.97"> </span>
<a href="#l50.98"></a><span id="l50.98">   gFLAll = new fL;</span>
<a href="#l50.99"></a><span id="l50.99"> </span>
<a href="#l50.100"></a><span id="l50.100" class="difflineminus">-  MailServices.mailSession.AddFolderListener(gFLAll, nsIFolderListener.all);</span>
<a href="#l50.101"></a><span id="l50.101" class="difflineplus">+  MailServices.mailSession.AddFolderListener(gFLAll, Ci.nsIFolderListener.all);</span>
<a href="#l50.102"></a><span id="l50.102"> </span>
<a href="#l50.103"></a><span id="l50.103">   for (i = 0; i &lt; numListenerFunctions; ++i) {</span>
<a href="#l50.104"></a><span id="l50.104">     gFLSingle[i] = new fL;</span>
<a href="#l50.105"></a><span id="l50.105">     MailServices.mailSession.AddFolderListener(gFLSingle[i], Math.pow(2, i));</span>
<a href="#l50.106"></a><span id="l50.106">   }</span>
<a href="#l50.107"></a><span id="l50.107"> </span>
<a href="#l50.108"></a><span id="l50.108">   // Test - Notify listener on all available items</span>
<a href="#l50.109"></a><span id="l50.109"> </span>
<a href="#l50.110"></a><span id="l50.110" class="difflineat">@@ -125,9 +124,9 @@ function run_test() {</span>
<a href="#l50.111"></a><span id="l50.111">   gFLAll.mReceived = 0;</span>
<a href="#l50.112"></a><span id="l50.112"> </span>
<a href="#l50.113"></a><span id="l50.113">   for (i = 0; i &lt; numListenerFunctions; ++i)</span>
<a href="#l50.114"></a><span id="l50.114">     Assert.equal(gFLSingle[i].mReceived, 0);</span>
<a href="#l50.115"></a><span id="l50.115"> </span>
<a href="#l50.116"></a><span id="l50.116">   // Test - Remove main listener</span>
<a href="#l50.117"></a><span id="l50.117"> </span>
<a href="#l50.118"></a><span id="l50.118">   MailServices.mailSession.RemoveFolderListener(gFLAll);</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineminus">-};</span>
<a href="#l50.120"></a><span id="l50.120" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsMsgTraitService.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsMsgTraitService.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -10,20 +10,18 @@ var kJunkId = &quot;mailnews@mozilla.org#junk</span>
<a href="#l51.4"></a><span id="l51.4"> var kGoodId = &quot;mailnews@mozilla.org#good&quot;;</span>
<a href="#l51.5"></a><span id="l51.5"> var kGoodIndex = Ci.nsIJunkMailPlugin.GOOD_TRAIT;</span>
<a href="#l51.6"></a><span id="l51.6"> var kJunkIndex = Ci.nsIJunkMailPlugin.JUNK_TRAIT;</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> // a dummy set of traits</span>
<a href="#l51.9"></a><span id="l51.9"> var proId = &quot;TheProTrait&quot;;</span>
<a href="#l51.10"></a><span id="l51.10"> var proName = &quot;ProName&quot;;</span>
<a href="#l51.11"></a><span id="l51.11"> var antiId = &quot;TheAntiTrait&quot;;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-var antiName = &quot;AntiName&quot;;</span>
<a href="#l51.13"></a><span id="l51.13"> </span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-function run_test()</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-{</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+function run_test() {</span>
<a href="#l51.17"></a><span id="l51.17">   // Check lastIndex prior to adding, 3 - 1000 are reserved for mailnews</span>
<a href="#l51.18"></a><span id="l51.18">   Assert.equal(ts.lastIndex, 1000);</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20">   // basic junk as traits should be setup automatically</span>
<a href="#l51.21"></a><span id="l51.21">   Assert.equal(kGoodId,</span>
<a href="#l51.22"></a><span id="l51.22">                Services.prefs.getCharPref(&quot;mailnews.traits.id.&quot; + kGoodIndex));</span>
<a href="#l51.23"></a><span id="l51.23">   Assert.equal(kJunkId,</span>
<a href="#l51.24"></a><span id="l51.24">                Services.prefs.getCharPref(&quot;mailnews.traits.id.&quot; + kJunkIndex));</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineat">@@ -94,29 +92,25 @@ function run_test()</span>
<a href="#l51.26"></a><span id="l51.26">   // remove the pro trait</span>
<a href="#l51.27"></a><span id="l51.27">   ts.unRegisterTrait(proId);</span>
<a href="#l51.28"></a><span id="l51.28">   Assert.ok(!ts.isRegistered(proId));</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30">   // check that this is also removed from prefs. The get calls should fail</span>
<a href="#l51.31"></a><span id="l51.31">   try {</span>
<a href="#l51.32"></a><span id="l51.32">     Services.prefs.getCharPref(&quot;mailnews.traits.id.&quot; + proIndex);</span>
<a href="#l51.33"></a><span id="l51.33">     Assert.ok(false);</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineminus">-  }</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineminus">-  catch (e) {}</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+  } catch (e) {}</span>
<a href="#l51.37"></a><span id="l51.37"> </span>
<a href="#l51.38"></a><span id="l51.38">   try {</span>
<a href="#l51.39"></a><span id="l51.39">     Services.prefs.getCharPref(&quot;mailnews.traits.name.&quot; + proIndex);</span>
<a href="#l51.40"></a><span id="l51.40">     Assert.ok(false);</span>
<a href="#l51.41"></a><span id="l51.41" class="difflineminus">-  }</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineminus">-  catch (e) {}</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+  } catch (e) {}</span>
<a href="#l51.44"></a><span id="l51.44"> </span>
<a href="#l51.45"></a><span id="l51.45">   try {</span>
<a href="#l51.46"></a><span id="l51.46">     Services.prefs.getBoolPref(&quot;mailnews.traits.enabled.&quot; + proIndex);</span>
<a href="#l51.47"></a><span id="l51.47">     Assert.ok(false);</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineminus">-  }</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineminus">-  catch (e) {}</span>
<a href="#l51.50"></a><span id="l51.50" class="difflineplus">+  } catch (e) {}</span>
<a href="#l51.51"></a><span id="l51.51"> </span>
<a href="#l51.52"></a><span id="l51.52">   try {</span>
<a href="#l51.53"></a><span id="l51.53">     Services.prefs.getCharPref(&quot;mailnews.traits.antiId.&quot; + proIndex);</span>
<a href="#l51.54"></a><span id="l51.54">     Assert.ok(false);</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineminus">-  }</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineminus">-  catch(e) {}</span>
<a href="#l51.57"></a><span id="l51.57" class="difflineplus">+  } catch (e) {}</span>
<a href="#l51.58"></a><span id="l51.58"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/base/test/unit/test_postPluginFilters.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_postPluginFilters.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l52.4"></a><span id="l52.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l52.5"></a><span id="l52.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l52.6"></a><span id="l52.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.7"></a><span id="l52.7"> </span>
<a href="#l52.8"></a><span id="l52.8"> /*</span>
<a href="#l52.9"></a><span id="l52.9">  * tests post-plugin message filters as implemented in bug 198100</span>
<a href="#l52.10"></a><span id="l52.10">  */</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l52.13"></a><span id="l52.13"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l52.14"></a><span id="l52.14"> </span>
<a href="#l52.15"></a><span id="l52.15"> // Globals</span>
<a href="#l52.16"></a><span id="l52.16"> </span>
<a href="#l52.17"></a><span id="l52.17"> var gDbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l52.18"></a><span id="l52.18">                      .getService(Ci.nsIMsgDBService);</span>
<a href="#l52.19"></a><span id="l52.19"> </span>
<a href="#l52.20"></a><span id="l52.20"> // command functions for test data</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineat">@@ -22,52 +23,45 @@ var gMsgHdr; // current message header</span>
<a href="#l52.22"></a><span id="l52.22"> </span>
<a href="#l52.23"></a><span id="l52.23"> var kJunkFile = &quot;../../../data/bugmail1&quot;;</span>
<a href="#l52.24"></a><span id="l52.24"> var kGoodFile = &quot;../../../data/draft1&quot;;</span>
<a href="#l52.25"></a><span id="l52.25"> </span>
<a href="#l52.26"></a><span id="l52.26"> var kPriorityLow = 3;</span>
<a href="#l52.27"></a><span id="l52.27"> var kPriorityHigh = 5;</span>
<a href="#l52.28"></a><span id="l52.28"> var gInboxListener; // database listener object</span>
<a href="#l52.29"></a><span id="l52.29"> </span>
<a href="#l52.30"></a><span id="l52.30" class="difflineminus">-var gTests =</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineminus">-[</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineminus">-  // train two different messages</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+var gTests = [</span>
<a href="#l52.34"></a><span id="l52.34">   {</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineplus">+    // train two different messages</span>
<a href="#l52.36"></a><span id="l52.36">     command: kTrain,</span>
<a href="#l52.37"></a><span id="l52.37">     fileName: kGoodFile,</span>
<a href="#l52.38"></a><span id="l52.38">     traitId: MailServices.junk.GOOD_TRAIT,</span>
<a href="#l52.39"></a><span id="l52.39" class="difflineminus">-  },</span>
<a href="#l52.40"></a><span id="l52.40" class="difflineminus">-  {</span>
<a href="#l52.41"></a><span id="l52.41" class="difflineplus">+  }, {</span>
<a href="#l52.42"></a><span id="l52.42">     command: kTrain,</span>
<a href="#l52.43"></a><span id="l52.43">     fileName: kJunkFile,</span>
<a href="#l52.44"></a><span id="l52.44">     traitId: MailServices.junk.JUNK_TRAIT,</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineminus">-  },</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineminus">-  // test a filter that acts on GOOD messages</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineminus">-  {</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineplus">+  }, {</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineplus">+    // test a filter that acts on GOOD messages</span>
<a href="#l52.50"></a><span id="l52.50">     command: kClass,</span>
<a href="#l52.51"></a><span id="l52.51">     fileName: kGoodFile,</span>
<a href="#l52.52"></a><span id="l52.52" class="difflineminus">-    test: function testClassGood() {</span>
<a href="#l52.53"></a><span id="l52.53" class="difflineplus">+    test() {</span>
<a href="#l52.54"></a><span id="l52.54">       Assert.equal(kPriorityHigh, gMsgHdr.priority);</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-    }</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-  },</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineminus">-  // test a filter that acts on JUNK messages</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineminus">-  {</span>
<a href="#l52.59"></a><span id="l52.59" class="difflineplus">+    },</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineplus">+  }, {</span>
<a href="#l52.61"></a><span id="l52.61" class="difflineplus">+    // test a filter that acts on JUNK messages</span>
<a href="#l52.62"></a><span id="l52.62">     command: kClass,</span>
<a href="#l52.63"></a><span id="l52.63">     fileName: kJunkFile,</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineminus">-    test: function testClassJunk() {</span>
<a href="#l52.65"></a><span id="l52.65" class="difflineplus">+    test() {</span>
<a href="#l52.66"></a><span id="l52.66">       Assert.equal(kPriorityLow, gMsgHdr.priority);</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineminus">-    }</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+    },</span>
<a href="#l52.69"></a><span id="l52.69">   },</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineminus">-  /**/</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineminus">-]</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+];</span>
<a href="#l52.73"></a><span id="l52.73"> </span>
<a href="#l52.74"></a><span id="l52.74"> // main test</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineminus">-function run_test()</span>
<a href="#l52.76"></a><span id="l52.76" class="difflineminus">-{</span>
<a href="#l52.77"></a><span id="l52.77" class="difflineminus">-</span>
<a href="#l52.78"></a><span id="l52.78" class="difflineplus">+function run_test() {</span>
<a href="#l52.79"></a><span id="l52.79">   // Setup some incoming filters, setting junk priority low, and good high.</span>
<a href="#l52.80"></a><span id="l52.80"> </span>
<a href="#l52.81"></a><span id="l52.81">   // Can't use the fake server, must use the deferredTo local server!</span>
<a href="#l52.82"></a><span id="l52.82">   let filterList = localAccountUtils.incomingServer.getFilterList(null);</span>
<a href="#l52.83"></a><span id="l52.83"> </span>
<a href="#l52.84"></a><span id="l52.84">   // junkIsLow filter</span>
<a href="#l52.85"></a><span id="l52.85">   let filter = filterList.createFilter(&quot;junkIsLow&quot;);</span>
<a href="#l52.86"></a><span id="l52.86">   let searchTerm = filter.createTerm();</span>
<a href="#l52.87"></a><span id="l52.87" class="difflineat">@@ -111,145 +105,115 @@ function run_test()</span>
<a href="#l52.88"></a><span id="l52.88">   gInboxListener = new DBListener();</span>
<a href="#l52.89"></a><span id="l52.89">   gDbService.registerPendingListener(localAccountUtils.inboxFolder, gInboxListener);</span>
<a href="#l52.90"></a><span id="l52.90"> </span>
<a href="#l52.91"></a><span id="l52.91">   do_test_pending();</span>
<a href="#l52.92"></a><span id="l52.92"> </span>
<a href="#l52.93"></a><span id="l52.93">   startCommand();</span>
<a href="#l52.94"></a><span id="l52.94"> }</span>
<a href="#l52.95"></a><span id="l52.95"> </span>
<a href="#l52.96"></a><span id="l52.96" class="difflineminus">-function endTest()</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineminus">-{</span>
<a href="#l52.98"></a><span id="l52.98" class="difflineplus">+function endTest() {</span>
<a href="#l52.99"></a><span id="l52.99">   // Cleanup</span>
<a href="#l52.100"></a><span id="l52.100">   dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l52.101"></a><span id="l52.101">   if (gInboxListener)</span>
<a href="#l52.102"></a><span id="l52.102">     gDbService.unregisterPendingListener(gInboxListener);</span>
<a href="#l52.103"></a><span id="l52.103"> </span>
<a href="#l52.104"></a><span id="l52.104">   gPOP3Pump = null;</span>
<a href="#l52.105"></a><span id="l52.105"> </span>
<a href="#l52.106"></a><span id="l52.106">   do_test_finished(); // for the one in run_test()</span>
<a href="#l52.107"></a><span id="l52.107"> }</span>
<a href="#l52.108"></a><span id="l52.108"> </span>
<a href="#l52.109"></a><span id="l52.109" class="difflineminus">-var classifyListener =</span>
<a href="#l52.110"></a><span id="l52.110" class="difflineminus">-{</span>
<a href="#l52.111"></a><span id="l52.111" class="difflineminus">-  //nsIMsgTraitClassificationListener implementation</span>
<a href="#l52.112"></a><span id="l52.112" class="difflineminus">-  onMessageTraitsClassified: function(aMsgURI, {}, aTraits, aPercents)</span>
<a href="#l52.113"></a><span id="l52.113" class="difflineminus">-  {</span>
<a href="#l52.114"></a><span id="l52.114" class="difflineminus">-    //print(&quot;Message URI is &quot; + aMsgURI);</span>
<a href="#l52.115"></a><span id="l52.115" class="difflineplus">+var classifyListener = {</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineplus">+  // nsIMsgTraitClassificationListener implementation</span>
<a href="#l52.117"></a><span id="l52.117" class="difflineplus">+  onMessageTraitsClassified(aMsgURI, aTraitCount, aTraits, aPercents) {</span>
<a href="#l52.118"></a><span id="l52.118" class="difflineplus">+    // print(&quot;Message URI is &quot; + aMsgURI);</span>
<a href="#l52.119"></a><span id="l52.119">     if (!aMsgURI)</span>
<a href="#l52.120"></a><span id="l52.120" class="difflineminus">-      return; //ignore end-of-batch signal</span>
<a href="#l52.121"></a><span id="l52.121" class="difflineplus">+      return; // ignore end-of-batch signal</span>
<a href="#l52.122"></a><span id="l52.122"> </span>
<a href="#l52.123"></a><span id="l52.123">     startCommand();</span>
<a href="#l52.124"></a><span id="l52.124" class="difflineminus">-  }</span>
<a href="#l52.125"></a><span id="l52.125" class="difflineplus">+  },</span>
<a href="#l52.126"></a><span id="l52.126"> };</span>
<a href="#l52.127"></a><span id="l52.127"> </span>
<a href="#l52.128"></a><span id="l52.128"> // nsIDBChangeListener implementation.</span>
<a href="#l52.129"></a><span id="l52.129" class="difflineminus">-function DBListener()</span>
<a href="#l52.130"></a><span id="l52.130" class="difflineminus">-{</span>
<a href="#l52.131"></a><span id="l52.131" class="difflineplus">+function DBListener() {</span>
<a href="#l52.132"></a><span id="l52.132"> }</span>
<a href="#l52.133"></a><span id="l52.133"> </span>
<a href="#l52.134"></a><span id="l52.134" class="difflineminus">-DBListener.prototype =</span>
<a href="#l52.135"></a><span id="l52.135" class="difflineminus">-{</span>
<a href="#l52.136"></a><span id="l52.136" class="difflineminus">-  onHdrFlagsChanged:</span>
<a href="#l52.137"></a><span id="l52.137" class="difflineminus">-    function onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator)</span>
<a href="#l52.138"></a><span id="l52.138" class="difflineminus">-    {</span>
<a href="#l52.139"></a><span id="l52.139" class="difflineminus">-    },</span>
<a href="#l52.140"></a><span id="l52.140" class="difflineplus">+DBListener.prototype = {</span>
<a href="#l52.141"></a><span id="l52.141" class="difflineplus">+  onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator) {</span>
<a href="#l52.142"></a><span id="l52.142" class="difflineplus">+  },</span>
<a href="#l52.143"></a><span id="l52.143" class="difflineplus">+</span>
<a href="#l52.144"></a><span id="l52.144" class="difflineplus">+  onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator) {</span>
<a href="#l52.145"></a><span id="l52.145" class="difflineplus">+  },</span>
<a href="#l52.146"></a><span id="l52.146"> </span>
<a href="#l52.147"></a><span id="l52.147" class="difflineminus">-  onHdrDeleted:</span>
<a href="#l52.148"></a><span id="l52.148" class="difflineminus">-    function onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator)</span>
<a href="#l52.149"></a><span id="l52.149" class="difflineminus">-    {</span>
<a href="#l52.150"></a><span id="l52.150" class="difflineminus">-    },</span>
<a href="#l52.151"></a><span id="l52.151" class="difflineplus">+  onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator) {</span>
<a href="#l52.152"></a><span id="l52.152" class="difflineplus">+    gMsgHdr = aHdrChanged;</span>
<a href="#l52.153"></a><span id="l52.153" class="difflineplus">+  },</span>
<a href="#l52.154"></a><span id="l52.154"> </span>
<a href="#l52.155"></a><span id="l52.155" class="difflineminus">-  onHdrAdded:</span>
<a href="#l52.156"></a><span id="l52.156" class="difflineminus">-    function onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator)</span>
<a href="#l52.157"></a><span id="l52.157" class="difflineminus">-    {</span>
<a href="#l52.158"></a><span id="l52.158" class="difflineminus">-      gMsgHdr = aHdrChanged;</span>
<a href="#l52.159"></a><span id="l52.159" class="difflineminus">-    },</span>
<a href="#l52.160"></a><span id="l52.160" class="difflineminus">-</span>
<a href="#l52.161"></a><span id="l52.161" class="difflineminus">-  onParentChanged:</span>
<a href="#l52.162"></a><span id="l52.162" class="difflineminus">-    function onParentChanged(aKeyChanged, oldParent, newParent, aInstigator)</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineminus">-    {</span>
<a href="#l52.164"></a><span id="l52.164" class="difflineminus">-    },</span>
<a href="#l52.165"></a><span id="l52.165" class="difflineplus">+  onParentChanged(aKeyChanged, oldParent, newParent, aInstigator) {</span>
<a href="#l52.166"></a><span id="l52.166" class="difflineplus">+  },</span>
<a href="#l52.167"></a><span id="l52.167"> </span>
<a href="#l52.168"></a><span id="l52.168" class="difflineminus">-  onAnnouncerGoingAway:</span>
<a href="#l52.169"></a><span id="l52.169" class="difflineminus">-    function onAnnouncerGoingAway(instigator)</span>
<a href="#l52.170"></a><span id="l52.170" class="difflineminus">-    {</span>
<a href="#l52.171"></a><span id="l52.171" class="difflineminus">-      if (gInboxListener)</span>
<a href="#l52.172"></a><span id="l52.172" class="difflineminus">-      {</span>
<a href="#l52.173"></a><span id="l52.173" class="difflineminus">-        try {</span>
<a href="#l52.174"></a><span id="l52.174" class="difflineminus">-          IMAPPump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l52.175"></a><span id="l52.175" class="difflineminus">-        }</span>
<a href="#l52.176"></a><span id="l52.176" class="difflineminus">-        catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l52.177"></a><span id="l52.177" class="difflineplus">+  onAnnouncerGoingAway(instigator) {</span>
<a href="#l52.178"></a><span id="l52.178" class="difflineplus">+    if (gInboxListener) {</span>
<a href="#l52.179"></a><span id="l52.179" class="difflineplus">+      try {</span>
<a href="#l52.180"></a><span id="l52.180" class="difflineplus">+        POP3Pump.inbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l52.181"></a><span id="l52.181" class="difflineplus">+      } catch (e) {</span>
<a href="#l52.182"></a><span id="l52.182" class="difflineplus">+        dump(&quot;listener not found\n&quot;);</span>
<a href="#l52.183"></a><span id="l52.183">       }</span>
<a href="#l52.184"></a><span id="l52.184" class="difflineminus">-    },</span>
<a href="#l52.185"></a><span id="l52.185" class="difflineplus">+    }</span>
<a href="#l52.186"></a><span id="l52.186" class="difflineplus">+  },</span>
<a href="#l52.187"></a><span id="l52.187"> </span>
<a href="#l52.188"></a><span id="l52.188" class="difflineminus">-  onReadChanged:</span>
<a href="#l52.189"></a><span id="l52.189" class="difflineminus">-    function onReadChanged(aInstigator)</span>
<a href="#l52.190"></a><span id="l52.190" class="difflineminus">-    {</span>
<a href="#l52.191"></a><span id="l52.191" class="difflineminus">-    },</span>
<a href="#l52.192"></a><span id="l52.192" class="difflineminus">-</span>
<a href="#l52.193"></a><span id="l52.193" class="difflineminus">-  onJunkScoreChanged:</span>
<a href="#l52.194"></a><span id="l52.194" class="difflineminus">-    function onJunkScoreChanged(aInstigator)</span>
<a href="#l52.195"></a><span id="l52.195" class="difflineminus">-    {</span>
<a href="#l52.196"></a><span id="l52.196" class="difflineminus">-    },</span>
<a href="#l52.197"></a><span id="l52.197" class="difflineplus">+  onReadChanged(aInstigator) {</span>
<a href="#l52.198"></a><span id="l52.198" class="difflineplus">+  },</span>
<a href="#l52.199"></a><span id="l52.199"> </span>
<a href="#l52.200"></a><span id="l52.200" class="difflineminus">-  onHdrPropertyChanged:</span>
<a href="#l52.201"></a><span id="l52.201" class="difflineminus">-    function onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator)</span>
<a href="#l52.202"></a><span id="l52.202" class="difflineminus">-    {</span>
<a href="#l52.203"></a><span id="l52.203" class="difflineminus">-    },</span>
<a href="#l52.204"></a><span id="l52.204" class="difflineminus">-  onEvent:</span>
<a href="#l52.205"></a><span id="l52.205" class="difflineminus">-    function onEvent(aDB, aEvent)</span>
<a href="#l52.206"></a><span id="l52.206" class="difflineminus">-    {</span>
<a href="#l52.207"></a><span id="l52.207" class="difflineminus">-    },</span>
<a href="#l52.208"></a><span id="l52.208" class="difflineplus">+  onJunkScoreChanged(aInstigator) {</span>
<a href="#l52.209"></a><span id="l52.209" class="difflineplus">+  },</span>
<a href="#l52.210"></a><span id="l52.210"> </span>
<a href="#l52.211"></a><span id="l52.211" class="difflineplus">+  onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator) {</span>
<a href="#l52.212"></a><span id="l52.212" class="difflineplus">+  },</span>
<a href="#l52.213"></a><span id="l52.213" class="difflineplus">+  onEvent(aDB, aEvent) {</span>
<a href="#l52.214"></a><span id="l52.214" class="difflineplus">+  },</span>
<a href="#l52.215"></a><span id="l52.215"> };</span>
<a href="#l52.216"></a><span id="l52.216"> </span>
<a href="#l52.217"></a><span id="l52.217" class="difflineminus">-</span>
<a href="#l52.218"></a><span id="l52.218"> // start the next test command</span>
<a href="#l52.219"></a><span id="l52.219" class="difflineminus">-function startCommand()</span>
<a href="#l52.220"></a><span id="l52.220" class="difflineminus">-{</span>
<a href="#l52.221"></a><span id="l52.221" class="difflineminus">-  if (gTest &amp;&amp; gTest.test)</span>
<a href="#l52.222"></a><span id="l52.222" class="difflineminus">-  {</span>
<a href="#l52.223"></a><span id="l52.223" class="difflineplus">+function startCommand() {</span>
<a href="#l52.224"></a><span id="l52.224" class="difflineplus">+  if (gTest &amp;&amp; gTest.test) {</span>
<a href="#l52.225"></a><span id="l52.225">     dump(&quot;doing test &quot; + gTest.test.name + &quot;\n&quot;);</span>
<a href="#l52.226"></a><span id="l52.226">     gTest.test();</span>
<a href="#l52.227"></a><span id="l52.227">   }</span>
<a href="#l52.228"></a><span id="l52.228" class="difflineminus">-  if (!gTests.length)       // Do we have more commands?</span>
<a href="#l52.229"></a><span id="l52.229" class="difflineminus">-  {</span>
<a href="#l52.230"></a><span id="l52.230" class="difflineplus">+  if (!gTests.length) { // Do we have more commands?</span>
<a href="#l52.231"></a><span id="l52.231">     // no, all done</span>
<a href="#l52.232"></a><span id="l52.232">     endTest();</span>
<a href="#l52.233"></a><span id="l52.233">     return;</span>
<a href="#l52.234"></a><span id="l52.234">   }</span>
<a href="#l52.235"></a><span id="l52.235"> </span>
<a href="#l52.236"></a><span id="l52.236">   gTest = gTests.shift();</span>
<a href="#l52.237"></a><span id="l52.237" class="difflineminus">-  switch (gTest.command)</span>
<a href="#l52.238"></a><span id="l52.238" class="difflineminus">-  {</span>
<a href="#l52.239"></a><span id="l52.239" class="difflineplus">+  switch (gTest.command) {</span>
<a href="#l52.240"></a><span id="l52.240">     case kTrain:</span>
<a href="#l52.241"></a><span id="l52.241">       // train message</span>
<a href="#l52.242"></a><span id="l52.242">       var proArray = [];</span>
<a href="#l52.243"></a><span id="l52.243">       proArray.push(gTest.traitId);</span>
<a href="#l52.244"></a><span id="l52.244"> </span>
<a href="#l52.245"></a><span id="l52.245">       MailServices.junk.setMsgTraitClassification(</span>
<a href="#l52.246"></a><span id="l52.246" class="difflineminus">-        getSpec(gTest.fileName), //in string aMsgURI</span>
<a href="#l52.247"></a><span id="l52.247" class="difflineplus">+        getSpec(gTest.fileName), // in string aMsgURI</span>
<a href="#l52.248"></a><span id="l52.248">         0,</span>
<a href="#l52.249"></a><span id="l52.249">         null,         // in nsIArray aOldTraits</span>
<a href="#l52.250"></a><span id="l52.250">         proArray.length,</span>
<a href="#l52.251"></a><span id="l52.251">         proArray,     // in nsIArray aNewTraits</span>
<a href="#l52.252"></a><span id="l52.252">         classifyListener); // [optional] in nsIMsgTraitClassificationListener aTraitListener</span>
<a href="#l52.253"></a><span id="l52.253">         // null,      // [optional] in nsIMsgWindow aMsgWindow</span>
<a href="#l52.254"></a><span id="l52.254">         // null,      // [optional] in nsIJunkMailClassificationListener aJunkListener</span>
<a href="#l52.255"></a><span id="l52.255">       break;</span>
<a href="#l52.256"></a><span id="l52.256"> </span>
<a href="#l52.257"></a><span id="l52.257">     case kClass:</span>
<a href="#l52.258"></a><span id="l52.258">       // classify message</span>
<a href="#l52.259"></a><span id="l52.259">       gPOP3Pump.files = [gTest.fileName];</span>
<a href="#l52.260"></a><span id="l52.260" class="difflineminus">-      gPOP3Pump.onDone = function(){do_timeout(100, startCommand);};</span>
<a href="#l52.261"></a><span id="l52.261" class="difflineplus">+      gPOP3Pump.onDone = function() { do_timeout(100, startCommand); };</span>
<a href="#l52.262"></a><span id="l52.262">       gPOP3Pump.run();</span>
<a href="#l52.263"></a><span id="l52.263">       break;</span>
<a href="#l52.264"></a><span id="l52.264">   }</span>
<a href="#l52.265"></a><span id="l52.265"> }</span>
<a href="#l52.266"></a><span id="l52.266"> </span>
<a href="#l52.267"></a><span id="l52.267" class="difflineminus">-function getSpec(aFileName)</span>
<a href="#l52.268"></a><span id="l52.268" class="difflineminus">-{</span>
<a href="#l52.269"></a><span id="l52.269" class="difflineplus">+function getSpec(aFileName) {</span>
<a href="#l52.270"></a><span id="l52.270">   var file = do_get_file(aFileName);</span>
<a href="#l52.271"></a><span id="l52.271">   var uri = Services.io.newFileURI(file).QueryInterface(Ci.nsIURL);</span>
<a href="#l52.272"></a><span id="l52.272">   uri = uri.mutate().setQuery(&quot;type=application/x-message-display&quot;).finalize();</span>
<a href="#l52.273"></a><span id="l52.273">   return uri.spec;</span>
<a href="#l52.274"></a><span id="l52.274"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/base/test/unit/test_quarantineFilterMove.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_quarantineFilterMove.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -6,25 +6,26 @@</span>
<a href="#l53.4"></a><span id="l53.4">  * tests message moves with filter and quarantine enabled per bug 582918.</span>
<a href="#l53.5"></a><span id="l53.5">  * It then tests that subsequent moves of the filtered messages work.</span>
<a href="#l53.6"></a><span id="l53.6">  *</span>
<a href="#l53.7"></a><span id="l53.7">  * adapted from test_copyThenMoveManual.js</span>
<a href="#l53.8"></a><span id="l53.8">  */</span>
<a href="#l53.9"></a><span id="l53.9"> </span>
<a href="#l53.10"></a><span id="l53.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l53.11"></a><span id="l53.11"> const {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l53.14"></a><span id="l53.14"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l53.15"></a><span id="l53.15"> </span>
<a href="#l53.16"></a><span id="l53.16"> var gFiles = [&quot;../../../data/bugmail1&quot;, &quot;../../../data/bugmail10&quot;];</span>
<a href="#l53.17"></a><span id="l53.17"> </span>
<a href="#l53.18"></a><span id="l53.18"> var gMoveFolder, gMoveFolder2;</span>
<a href="#l53.19"></a><span id="l53.19"> var gFilter; // the test filter</span>
<a href="#l53.20"></a><span id="l53.20"> var gFilterList;</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineminus">-var gTestArray =</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-[</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+var gTestArray = [</span>
<a href="#l53.24"></a><span id="l53.24">   function createFilters() {</span>
<a href="#l53.25"></a><span id="l53.25">     gFilterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l53.26"></a><span id="l53.26">     gFilter = gFilterList.createFilter(&quot;MoveAll&quot;);</span>
<a href="#l53.27"></a><span id="l53.27">     let searchTerm = gFilter.createTerm();</span>
<a href="#l53.28"></a><span id="l53.28">     searchTerm.matchAll = true;</span>
<a href="#l53.29"></a><span id="l53.29">     gFilter.appendTerm(searchTerm);</span>
<a href="#l53.30"></a><span id="l53.30">     let moveAction = gFilter.createAction();</span>
<a href="#l53.31"></a><span id="l53.31">     moveAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineat">@@ -80,35 +81,32 @@ var gTestArray =</span>
<a href="#l53.33"></a><span id="l53.33">     let messageContent = getContentFromMessage(firstMsgHdr);</span>
<a href="#l53.34"></a><span id="l53.34">     Assert.ok(messageContent.includes(&quot;Some User &lt;bugmail@example.org&gt; changed&quot;));</span>
<a href="#l53.35"></a><span id="l53.35">     messageContent = getContentFromMessage(secondMsgHdr);</span>
<a href="#l53.36"></a><span id="l53.36">     Assert.ok(messageContent.includes(&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=436880&quot;));</span>
<a href="#l53.37"></a><span id="l53.37">   },</span>
<a href="#l53.38"></a><span id="l53.38">   function endTest() {</span>
<a href="#l53.39"></a><span id="l53.39">     dump(&quot;Exiting mail tests\n&quot;);</span>
<a href="#l53.40"></a><span id="l53.40">     gPOP3Pump = null;</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineminus">-  }</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+  },</span>
<a href="#l53.43"></a><span id="l53.43"> ];</span>
<a href="#l53.44"></a><span id="l53.44"> </span>
<a href="#l53.45"></a><span id="l53.45" class="difflineminus">-function folderCount(folder)</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineminus">-{</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l53.48"></a><span id="l53.48">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l53.49"></a><span id="l53.49">   let count = 0;</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineminus">-  {</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l53.53"></a><span id="l53.53">     count++;</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l53.56"></a><span id="l53.56">   }</span>
<a href="#l53.57"></a><span id="l53.57">   return count;</span>
<a href="#l53.58"></a><span id="l53.58"> }</span>
<a href="#l53.59"></a><span id="l53.59"> </span>
<a href="#l53.60"></a><span id="l53.60" class="difflineminus">-function run_test()</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineminus">-{</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+function run_test() {</span>
<a href="#l53.63"></a><span id="l53.63">   /* may not work in Linux */</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineminus">-  //if (&quot;@mozilla.org/gnome-gconf-service;1&quot; in Cc)</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+  // if (&quot;@mozilla.org/gnome-gconf-service;1&quot; in Cc)</span>
<a href="#l53.66"></a><span id="l53.66">   //  return;</span>
<a href="#l53.67"></a><span id="l53.67">   /**/</span>
<a href="#l53.68"></a><span id="l53.68">   // quarantine messages</span>
<a href="#l53.69"></a><span id="l53.69">   Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, true);</span>
<a href="#l53.70"></a><span id="l53.70">   if (!localAccountUtils.inboxFolder)</span>
<a href="#l53.71"></a><span id="l53.71">     localAccountUtils.loadLocalMailAccount();</span>
<a href="#l53.72"></a><span id="l53.72"> </span>
<a href="#l53.73"></a><span id="l53.73">   gMoveFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;MoveFolder&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/base/test/unit/test_retention.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_retention.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,15 +1,20 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /*</span>
<a href="#l54.5"></a><span id="l54.5">  * Simple tests for retention settings. In particular, we'd like to make</span>
<a href="#l54.6"></a><span id="l54.6">  * sure that applying retention settings works with the new code that avoids</span>
<a href="#l54.7"></a><span id="l54.7">  * opening db's to apply retention settings if the folder doesn't override</span>
<a href="#l54.8"></a><span id="l54.8">  * the server defaults.</span>
<a href="#l54.9"></a><span id="l54.9">  */</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l54.16"></a><span id="l54.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l54.17"></a><span id="l54.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l54.18"></a><span id="l54.18"> </span>
<a href="#l54.19"></a><span id="l54.19"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l54.20"></a><span id="l54.20"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l54.21"></a><span id="l54.21"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l54.22"></a><span id="l54.22"> </span>
<a href="#l54.23"></a><span id="l54.23"> var gMessageGenerator = new MessageGenerator();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/base/test/unit/test_search.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_search.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -3,479 +3,536 @@</span>
<a href="#l55.4"></a><span id="l55.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.5"></a><span id="l55.5"> </span>
<a href="#l55.6"></a><span id="l55.6"> /*</span>
<a href="#l55.7"></a><span id="l55.7">  * Testing of general mail search features.</span>
<a href="#l55.8"></a><span id="l55.8">  *</span>
<a href="#l55.9"></a><span id="l55.9">  * This tests some search attributes not tested by other specific tests,</span>
<a href="#l55.10"></a><span id="l55.10">  * e.g., test_searchTag.js or test_searchJunk.js</span>
<a href="#l55.11"></a><span id="l55.11">  */</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l55.13"></a><span id="l55.13"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l55.14"></a><span id="l55.14"> </span>
<a href="#l55.15"></a><span id="l55.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineminus">-</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-var IsEmpty = nsMsgSearchOp.IsEmpty;</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-var IsntEmpty = nsMsgSearchOp.IsntEmpty;</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineminus">-var DoesntContain = nsMsgSearchOp.DoesntContain;</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineminus">-var BeginsWith = nsMsgSearchOp.BeginsWith;</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineminus">-var EndsWith = nsMsgSearchOp.EndsWith;</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineminus">-var IsBefore = nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-var IsAfter = nsMsgSearchOp.IsAfter;</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-var IsHigherThan = nsMsgSearchOp.IsHigherThan;</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineminus">-var IsLowerThan = nsMsgSearchOp.IsLowerThan;</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+var DoesntContain = Ci.nsMsgSearchOp.DoesntContain;</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineplus">+var BeginsWith = Ci.nsMsgSearchOp.BeginsWith;</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineplus">+var EndsWith = Ci.nsMsgSearchOp.EndsWith;</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineplus">+var IsBefore = Ci.nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineplus">+var IsAfter = Ci.nsMsgSearchOp.IsAfter;</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineplus">+var IsHigherThan = Ci.nsMsgSearchOp.IsHigherThan;</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+var IsLowerThan = Ci.nsMsgSearchOp.IsLowerThan;</span>
<a href="#l55.43"></a><span id="l55.43"> </span>
<a href="#l55.44"></a><span id="l55.44" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineminus">-var onlineMail = nsMsgSearchScope.onlineMail;</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineminus">-var offlineMailFilter = nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineminus">-var onlineMailFilter = nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineminus">-var news = nsMsgSearchScope.news; // control entry not enabled</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+var OtherHeader = Ci.nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+var From = Ci.nsMsgSearchAttrib.Sender;</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+var Subject = Ci.nsMsgSearchAttrib.Subject;</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineplus">+var Priority = Ci.nsMsgSearchAttrib.Priority;</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+var SDate = Ci.nsMsgSearchAttrib.Date;</span>
<a href="#l55.54"></a><span id="l55.54"> </span>
<a href="#l55.55"></a><span id="l55.55" class="difflineminus">-var OtherHeader = nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineminus">-var From = nsMsgSearchAttrib.Sender;</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineminus">-var Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineminus">-var Priority = nsMsgSearchAttrib.Priority;</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineminus">-var SDate = nsMsgSearchAttrib.Date;</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineminus">-</span>
<a href="#l55.61"></a><span id="l55.61" class="difflineminus">-var Tests =</span>
<a href="#l55.62"></a><span id="l55.62" class="difflineminus">-[</span>
<a href="#l55.63"></a><span id="l55.63" class="difflineplus">+var Tests = [</span>
<a href="#l55.64"></a><span id="l55.64">   // test the To: header</span>
<a href="#l55.65"></a><span id="l55.65" class="difflineminus">-  { testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l55.66"></a><span id="l55.66" class="difflineplus">+  {</span>
<a href="#l55.67"></a><span id="l55.67" class="difflineplus">+    testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l55.68"></a><span id="l55.68">     testAttribute: From,</span>
<a href="#l55.69"></a><span id="l55.69">     op: Is,</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineminus">-    count: 1 },</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineminus">-  { testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+    count: 1,</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineplus">+  }, {</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+    testString: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l55.75"></a><span id="l55.75">     testAttribute: From,</span>
<a href="#l55.76"></a><span id="l55.76">     op: Isnt,</span>
<a href="#l55.77"></a><span id="l55.77" class="difflineminus">-    count: 0 },</span>
<a href="#l55.78"></a><span id="l55.78" class="difflineminus">-  { testString: &quot;PrimaryEmail&quot;,</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineplus">+    count: 0,</span>
<a href="#l55.80"></a><span id="l55.80" class="difflineplus">+  }, {</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineplus">+    testString: &quot;PrimaryEmail&quot;,</span>
<a href="#l55.82"></a><span id="l55.82">     testAttribute: From,</span>
<a href="#l55.83"></a><span id="l55.83">     op: BeginsWith,</span>
<a href="#l55.84"></a><span id="l55.84" class="difflineminus">-    count: 1 },</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineminus">-  { testString: &quot;invalid&quot;,</span>
<a href="#l55.86"></a><span id="l55.86" class="difflineplus">+    count: 1,</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineplus">+  }, {</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineplus">+    testString: &quot;invalid&quot;,</span>
<a href="#l55.89"></a><span id="l55.89">     testAttribute: From,</span>
<a href="#l55.90"></a><span id="l55.90">     op: BeginsWith,</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineminus">-    count: 0 },</span>
<a href="#l55.92"></a><span id="l55.92" class="difflineminus">-  { testString: &quot;invalid&quot;,</span>
<a href="#l55.93"></a><span id="l55.93" class="difflineplus">+    count: 0,</span>
<a href="#l55.94"></a><span id="l55.94" class="difflineplus">+  }, {</span>
<a href="#l55.95"></a><span id="l55.95" class="difflineplus">+    testString: &quot;invalid&quot;,</span>
<a href="#l55.96"></a><span id="l55.96">     testAttribute: From,</span>
<a href="#l55.97"></a><span id="l55.97">     op: EndsWith,</span>
<a href="#l55.98"></a><span id="l55.98" class="difflineminus">-    count: 1},</span>
<a href="#l55.99"></a><span id="l55.99" class="difflineminus">-  { testString: &quot;Primary&quot;,</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineplus">+    count: 1,</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+  }, {</span>
<a href="#l55.102"></a><span id="l55.102" class="difflineplus">+    testString: &quot;Primary&quot;,</span>
<a href="#l55.103"></a><span id="l55.103">     testAttribute: From,</span>
<a href="#l55.104"></a><span id="l55.104">     op: EndsWith,</span>
<a href="#l55.105"></a><span id="l55.105" class="difflineminus">-    count: 0},</span>
<a href="#l55.106"></a><span id="l55.106" class="difflineminus">-  { testString: &quot;QAContact&quot;,</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineplus">+    count: 0,</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+  }, {</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineplus">+    testString: &quot;QAContact&quot;,</span>
<a href="#l55.110"></a><span id="l55.110">     testAttribute: OtherHeader,</span>
<a href="#l55.111"></a><span id="l55.111">     op: BeginsWith,</span>
<a href="#l55.112"></a><span id="l55.112" class="difflineminus">-    count: 1},</span>
<a href="#l55.113"></a><span id="l55.113" class="difflineminus">-  { testString: &quot;filters&quot;,</span>
<a href="#l55.114"></a><span id="l55.114" class="difflineplus">+    count: 1,</span>
<a href="#l55.115"></a><span id="l55.115" class="difflineplus">+  }, {</span>
<a href="#l55.116"></a><span id="l55.116" class="difflineplus">+    testString: &quot;filters&quot;,</span>
<a href="#l55.117"></a><span id="l55.117">     testAttribute: OtherHeader,</span>
<a href="#l55.118"></a><span id="l55.118">     op: BeginsWith,</span>
<a href="#l55.119"></a><span id="l55.119" class="difflineminus">-    count: 0},</span>
<a href="#l55.120"></a><span id="l55.120" class="difflineminus">-  { testString: &quot;mail.bugs&quot;,</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineplus">+    count: 0,</span>
<a href="#l55.122"></a><span id="l55.122" class="difflineplus">+  }, {</span>
<a href="#l55.123"></a><span id="l55.123" class="difflineplus">+    testString: &quot;mail.bugs&quot;,</span>
<a href="#l55.124"></a><span id="l55.124">     testAttribute: OtherHeader,</span>
<a href="#l55.125"></a><span id="l55.125">     op: EndsWith,</span>
<a href="#l55.126"></a><span id="l55.126" class="difflineminus">-    count: 1},</span>
<a href="#l55.127"></a><span id="l55.127" class="difflineminus">-  { testString: &quot;QAContact&quot;,</span>
<a href="#l55.128"></a><span id="l55.128" class="difflineplus">+    count: 1,</span>
<a href="#l55.129"></a><span id="l55.129" class="difflineplus">+  }, {</span>
<a href="#l55.130"></a><span id="l55.130" class="difflineplus">+    testString: &quot;QAContact&quot;,</span>
<a href="#l55.131"></a><span id="l55.131">     testAttribute: OtherHeader,</span>
<a href="#l55.132"></a><span id="l55.132">     op: EndsWith,</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineminus">-    count: 0},</span>
<a href="#l55.134"></a><span id="l55.134" class="difflineminus">-  { testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l55.135"></a><span id="l55.135" class="difflineplus">+    count: 0,</span>
<a href="#l55.136"></a><span id="l55.136" class="difflineplus">+  }, {</span>
<a href="#l55.137"></a><span id="l55.137" class="difflineplus">+    testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l55.138"></a><span id="l55.138">     testAttribute: OtherHeader,</span>
<a href="#l55.139"></a><span id="l55.139">     op: Is,</span>
<a href="#l55.140"></a><span id="l55.140" class="difflineminus">-    count: 1},</span>
<a href="#l55.141"></a><span id="l55.141" class="difflineminus">-  { testString: &quot;filters@mail.bugs&quot;,</span>
<a href="#l55.142"></a><span id="l55.142" class="difflineplus">+    count: 1,</span>
<a href="#l55.143"></a><span id="l55.143" class="difflineplus">+  }, {</span>
<a href="#l55.144"></a><span id="l55.144" class="difflineplus">+    testString: &quot;filters@mail.bugs&quot;,</span>
<a href="#l55.145"></a><span id="l55.145">     testAttribute: OtherHeader,</span>
<a href="#l55.146"></a><span id="l55.146">     op: Is,</span>
<a href="#l55.147"></a><span id="l55.147" class="difflineminus">-    count: 0},</span>
<a href="#l55.148"></a><span id="l55.148" class="difflineminus">-  { testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l55.149"></a><span id="l55.149" class="difflineplus">+    count: 0,</span>
<a href="#l55.150"></a><span id="l55.150" class="difflineplus">+  }, {</span>
<a href="#l55.151"></a><span id="l55.151" class="difflineplus">+    testString: &quot;QAcontact filters@mail.bugs&quot;,</span>
<a href="#l55.152"></a><span id="l55.152">     testAttribute: OtherHeader,</span>
<a href="#l55.153"></a><span id="l55.153">     op: Isnt,</span>
<a href="#l55.154"></a><span id="l55.154" class="difflineminus">-    count: 0},</span>
<a href="#l55.155"></a><span id="l55.155" class="difflineminus">-  { testString: &quot;QAcontact&quot;,</span>
<a href="#l55.156"></a><span id="l55.156" class="difflineplus">+    count: 0,</span>
<a href="#l55.157"></a><span id="l55.157" class="difflineplus">+  }, {</span>
<a href="#l55.158"></a><span id="l55.158" class="difflineplus">+    testString: &quot;QAcontact&quot;,</span>
<a href="#l55.159"></a><span id="l55.159">     testAttribute: OtherHeader,</span>
<a href="#l55.160"></a><span id="l55.160">     op: Isnt,</span>
<a href="#l55.161"></a><span id="l55.161" class="difflineminus">-    count: 1},</span>
<a href="#l55.162"></a><span id="l55.162" class="difflineminus">-  { testString: &quot;filters&quot;,</span>
<a href="#l55.163"></a><span id="l55.163" class="difflineplus">+    count: 1,</span>
<a href="#l55.164"></a><span id="l55.164" class="difflineplus">+  }, {</span>
<a href="#l55.165"></a><span id="l55.165" class="difflineplus">+    testString: &quot;filters&quot;,</span>
<a href="#l55.166"></a><span id="l55.166">     testAttribute: OtherHeader,</span>
<a href="#l55.167"></a><span id="l55.167">     op: Contains,</span>
<a href="#l55.168"></a><span id="l55.168" class="difflineminus">-    count: 1},</span>
<a href="#l55.169"></a><span id="l55.169" class="difflineminus">-  { testString: &quot;foobar&quot;,</span>
<a href="#l55.170"></a><span id="l55.170" class="difflineplus">+    count: 1,</span>
<a href="#l55.171"></a><span id="l55.171" class="difflineplus">+  }, {</span>
<a href="#l55.172"></a><span id="l55.172" class="difflineplus">+    testString: &quot;foobar&quot;,</span>
<a href="#l55.173"></a><span id="l55.173">     testAttribute: OtherHeader,</span>
<a href="#l55.174"></a><span id="l55.174">     op: Contains,</span>
<a href="#l55.175"></a><span id="l55.175" class="difflineminus">-    count: 0},</span>
<a href="#l55.176"></a><span id="l55.176" class="difflineminus">-</span>
<a href="#l55.177"></a><span id="l55.177" class="difflineplus">+    count: 0,</span>
<a href="#l55.178"></a><span id="l55.178" class="difflineplus">+  },</span>
<a href="#l55.179"></a><span id="l55.179">   // test header with multiple occurences</span>
<a href="#l55.180"></a><span id="l55.180" class="difflineminus">-  { testString: &quot;one value&quot;,</span>
<a href="#l55.181"></a><span id="l55.181" class="difflineplus">+  {</span>
<a href="#l55.182"></a><span id="l55.182" class="difflineplus">+    testString: &quot;one value&quot;,</span>
<a href="#l55.183"></a><span id="l55.183">     testAttribute: OtherHeader,</span>
<a href="#l55.184"></a><span id="l55.184">     op: Is,</span>
<a href="#l55.185"></a><span id="l55.185">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.186"></a><span id="l55.186" class="difflineminus">-    count: 1},</span>
<a href="#l55.187"></a><span id="l55.187" class="difflineminus">-  { testString: &quot;second&quot;,</span>
<a href="#l55.188"></a><span id="l55.188" class="difflineplus">+    count: 1,</span>
<a href="#l55.189"></a><span id="l55.189" class="difflineplus">+  }, {</span>
<a href="#l55.190"></a><span id="l55.190" class="difflineplus">+    testString: &quot;second&quot;,</span>
<a href="#l55.191"></a><span id="l55.191">     testAttribute: OtherHeader,</span>
<a href="#l55.192"></a><span id="l55.192">     op: Is,</span>
<a href="#l55.193"></a><span id="l55.193">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.194"></a><span id="l55.194" class="difflineminus">-    count: 1},</span>
<a href="#l55.195"></a><span id="l55.195" class="difflineminus">-  { testString: &quot;third value for test purposes&quot;,</span>
<a href="#l55.196"></a><span id="l55.196" class="difflineplus">+    count: 1,</span>
<a href="#l55.197"></a><span id="l55.197" class="difflineplus">+  }, {</span>
<a href="#l55.198"></a><span id="l55.198" class="difflineplus">+    testString: &quot;third value for test purposes&quot;,</span>
<a href="#l55.199"></a><span id="l55.199">     testAttribute: OtherHeader,</span>
<a href="#l55.200"></a><span id="l55.200">     op: Is,</span>
<a href="#l55.201"></a><span id="l55.201">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.202"></a><span id="l55.202" class="difflineminus">-    count: 1},</span>
<a href="#l55.203"></a><span id="l55.203" class="difflineminus">-  { testString: &quot;multiline value that needs to be handled.&quot;,</span>
<a href="#l55.204"></a><span id="l55.204" class="difflineplus">+    count: 1,</span>
<a href="#l55.205"></a><span id="l55.205" class="difflineplus">+  }, {</span>
<a href="#l55.206"></a><span id="l55.206" class="difflineplus">+    testString: &quot;multiline value that needs to be handled.&quot;,</span>
<a href="#l55.207"></a><span id="l55.207">     testAttribute: OtherHeader,</span>
<a href="#l55.208"></a><span id="l55.208">     op: Is,</span>
<a href="#l55.209"></a><span id="l55.209">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.210"></a><span id="l55.210" class="difflineminus">-    count: 1},</span>
<a href="#l55.211"></a><span id="l55.211" class="difflineminus">-  { testString: &quot;one value&quot;,</span>
<a href="#l55.212"></a><span id="l55.212" class="difflineplus">+    count: 1,</span>
<a href="#l55.213"></a><span id="l55.213" class="difflineplus">+  }, {</span>
<a href="#l55.214"></a><span id="l55.214" class="difflineplus">+    testString: &quot;one value&quot;,</span>
<a href="#l55.215"></a><span id="l55.215">     testAttribute: OtherHeader,</span>
<a href="#l55.216"></a><span id="l55.216">     op: Isnt,</span>
<a href="#l55.217"></a><span id="l55.217">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.218"></a><span id="l55.218" class="difflineminus">-    count: 0},</span>
<a href="#l55.219"></a><span id="l55.219" class="difflineminus">-  { testString: &quot;second&quot;,</span>
<a href="#l55.220"></a><span id="l55.220" class="difflineplus">+    count: 0,</span>
<a href="#l55.221"></a><span id="l55.221" class="difflineplus">+  }, {</span>
<a href="#l55.222"></a><span id="l55.222" class="difflineplus">+    testString: &quot;second&quot;,</span>
<a href="#l55.223"></a><span id="l55.223">     testAttribute: OtherHeader,</span>
<a href="#l55.224"></a><span id="l55.224">     op: Isnt,</span>
<a href="#l55.225"></a><span id="l55.225">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.226"></a><span id="l55.226" class="difflineminus">-    count: 0},</span>
<a href="#l55.227"></a><span id="l55.227" class="difflineminus">-  { testString: &quot;third value for test purposes&quot;,</span>
<a href="#l55.228"></a><span id="l55.228" class="difflineplus">+    count: 0,</span>
<a href="#l55.229"></a><span id="l55.229" class="difflineplus">+  }, {</span>
<a href="#l55.230"></a><span id="l55.230" class="difflineplus">+    testString: &quot;third value for test purposes&quot;,</span>
<a href="#l55.231"></a><span id="l55.231">     testAttribute: OtherHeader,</span>
<a href="#l55.232"></a><span id="l55.232">     op: Isnt,</span>
<a href="#l55.233"></a><span id="l55.233">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.234"></a><span id="l55.234" class="difflineminus">-    count: 0},</span>
<a href="#l55.235"></a><span id="l55.235" class="difflineminus">-  { testString: &quot;multiline value that needs to be handled.&quot;,</span>
<a href="#l55.236"></a><span id="l55.236" class="difflineplus">+    count: 0,</span>
<a href="#l55.237"></a><span id="l55.237" class="difflineplus">+  }, {</span>
<a href="#l55.238"></a><span id="l55.238" class="difflineplus">+    testString: &quot;multiline value that needs to be handled.&quot;,</span>
<a href="#l55.239"></a><span id="l55.239">     testAttribute: OtherHeader,</span>
<a href="#l55.240"></a><span id="l55.240">     op: Isnt,</span>
<a href="#l55.241"></a><span id="l55.241">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.242"></a><span id="l55.242" class="difflineminus">-    count: 0},</span>
<a href="#l55.243"></a><span id="l55.243" class="difflineminus">-</span>
<a href="#l55.244"></a><span id="l55.244" class="difflineminus">-  { testString: &quot;one&quot;,</span>
<a href="#l55.245"></a><span id="l55.245" class="difflineplus">+    count: 0,</span>
<a href="#l55.246"></a><span id="l55.246" class="difflineplus">+  }, {</span>
<a href="#l55.247"></a><span id="l55.247" class="difflineplus">+    testString: &quot;one&quot;,</span>
<a href="#l55.248"></a><span id="l55.248">     testAttribute: OtherHeader,</span>
<a href="#l55.249"></a><span id="l55.249">     op: Contains,</span>
<a href="#l55.250"></a><span id="l55.250">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.251"></a><span id="l55.251" class="difflineminus">-    count: 1},</span>
<a href="#l55.252"></a><span id="l55.252" class="difflineminus">-  { testString: &quot;second&quot;,</span>
<a href="#l55.253"></a><span id="l55.253" class="difflineplus">+    count: 1,</span>
<a href="#l55.254"></a><span id="l55.254" class="difflineplus">+  }, {</span>
<a href="#l55.255"></a><span id="l55.255" class="difflineplus">+    testString: &quot;second&quot;,</span>
<a href="#l55.256"></a><span id="l55.256">     testAttribute: OtherHeader,</span>
<a href="#l55.257"></a><span id="l55.257">     op: Contains,</span>
<a href="#l55.258"></a><span id="l55.258">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.259"></a><span id="l55.259" class="difflineminus">-    count: 1},</span>
<a href="#l55.260"></a><span id="l55.260" class="difflineminus">-  { testString: &quot;purposes&quot;,</span>
<a href="#l55.261"></a><span id="l55.261" class="difflineplus">+    count: 1,</span>
<a href="#l55.262"></a><span id="l55.262" class="difflineplus">+  }, {</span>
<a href="#l55.263"></a><span id="l55.263" class="difflineplus">+    testString: &quot;purposes&quot;,</span>
<a href="#l55.264"></a><span id="l55.264">     testAttribute: OtherHeader,</span>
<a href="#l55.265"></a><span id="l55.265">     op: Contains,</span>
<a href="#l55.266"></a><span id="l55.266">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.267"></a><span id="l55.267" class="difflineminus">-    count: 1},</span>
<a href="#l55.268"></a><span id="l55.268" class="difflineminus">-  { testString: &quot;value&quot;,</span>
<a href="#l55.269"></a><span id="l55.269" class="difflineplus">+    count: 1,</span>
<a href="#l55.270"></a><span id="l55.270" class="difflineplus">+  }, {</span>
<a href="#l55.271"></a><span id="l55.271" class="difflineplus">+    testString: &quot;value&quot;,</span>
<a href="#l55.272"></a><span id="l55.272">     testAttribute: OtherHeader,</span>
<a href="#l55.273"></a><span id="l55.273">     op: Contains,</span>
<a href="#l55.274"></a><span id="l55.274">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.275"></a><span id="l55.275" class="difflineminus">-    count: 1},</span>
<a href="#l55.276"></a><span id="l55.276" class="difflineminus">-  { testString: &quot;that needs to be&quot;,</span>
<a href="#l55.277"></a><span id="l55.277" class="difflineplus">+    count: 1,</span>
<a href="#l55.278"></a><span id="l55.278" class="difflineplus">+  }, {</span>
<a href="#l55.279"></a><span id="l55.279" class="difflineplus">+    testString: &quot;that needs to be&quot;,</span>
<a href="#l55.280"></a><span id="l55.280">     testAttribute: OtherHeader,</span>
<a href="#l55.281"></a><span id="l55.281">     op: Contains,</span>
<a href="#l55.282"></a><span id="l55.282">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.283"></a><span id="l55.283" class="difflineminus">-    count: 1},</span>
<a href="#l55.284"></a><span id="l55.284" class="difflineminus">-  { testString: &quot;fifth&quot;,</span>
<a href="#l55.285"></a><span id="l55.285" class="difflineplus">+    count: 1,</span>
<a href="#l55.286"></a><span id="l55.286" class="difflineplus">+  }, {</span>
<a href="#l55.287"></a><span id="l55.287" class="difflineplus">+    testString: &quot;fifth&quot;,</span>
<a href="#l55.288"></a><span id="l55.288">     testAttribute: OtherHeader,</span>
<a href="#l55.289"></a><span id="l55.289">     op: Contains,</span>
<a href="#l55.290"></a><span id="l55.290">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.291"></a><span id="l55.291" class="difflineminus">-    count: 1},</span>
<a href="#l55.292"></a><span id="l55.292" class="difflineminus">-    { testString: &quot;is the end my&quot;,</span>
<a href="#l55.293"></a><span id="l55.293" class="difflineplus">+    count: 1,</span>
<a href="#l55.294"></a><span id="l55.294" class="difflineplus">+  }, {</span>
<a href="#l55.295"></a><span id="l55.295" class="difflineplus">+    testString: &quot;is the end my&quot;,</span>
<a href="#l55.296"></a><span id="l55.296">     testAttribute: OtherHeader,</span>
<a href="#l55.297"></a><span id="l55.297">     op: Contains,</span>
<a href="#l55.298"></a><span id="l55.298">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.299"></a><span id="l55.299" class="difflineminus">-    count: 1},</span>
<a href="#l55.300"></a><span id="l55.300" class="difflineminus">-  { testString: &quot;the end&quot;,</span>
<a href="#l55.301"></a><span id="l55.301" class="difflineplus">+    count: 1,</span>
<a href="#l55.302"></a><span id="l55.302" class="difflineplus">+  }, {</span>
<a href="#l55.303"></a><span id="l55.303" class="difflineplus">+    testString: &quot;the end&quot;,</span>
<a href="#l55.304"></a><span id="l55.304">     testAttribute: OtherHeader,</span>
<a href="#l55.305"></a><span id="l55.305">     op: EndsWith,</span>
<a href="#l55.306"></a><span id="l55.306">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.307"></a><span id="l55.307" class="difflineminus">-    count: 0},</span>
<a href="#l55.308"></a><span id="l55.308" class="difflineminus">-  { testString: &quot;handled.&quot;,</span>
<a href="#l55.309"></a><span id="l55.309" class="difflineplus">+    count: 0,</span>
<a href="#l55.310"></a><span id="l55.310" class="difflineplus">+  }, {</span>
<a href="#l55.311"></a><span id="l55.311" class="difflineplus">+    testString: &quot;handled.&quot;,</span>
<a href="#l55.312"></a><span id="l55.312">     testAttribute: OtherHeader,</span>
<a href="#l55.313"></a><span id="l55.313">     op: EndsWith,</span>
<a href="#l55.314"></a><span id="l55.314">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.315"></a><span id="l55.315" class="difflineminus">-    count: 1},</span>
<a href="#l55.316"></a><span id="l55.316" class="difflineminus">-  { testString: &quot;one value&quot;,</span>
<a href="#l55.317"></a><span id="l55.317" class="difflineplus">+    count: 1,</span>
<a href="#l55.318"></a><span id="l55.318" class="difflineplus">+  }, {</span>
<a href="#l55.319"></a><span id="l55.319" class="difflineplus">+    testString: &quot;one value&quot;,</span>
<a href="#l55.320"></a><span id="l55.320">     testAttribute: OtherHeader,</span>
<a href="#l55.321"></a><span id="l55.321">     op: EndsWith,</span>
<a href="#l55.322"></a><span id="l55.322">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.323"></a><span id="l55.323" class="difflineminus">-    count: 1},</span>
<a href="#l55.324"></a><span id="l55.324" class="difflineminus">-  { testString: &quot;third&quot;,</span>
<a href="#l55.325"></a><span id="l55.325" class="difflineplus">+    count: 1,</span>
<a href="#l55.326"></a><span id="l55.326" class="difflineplus">+  }, {</span>
<a href="#l55.327"></a><span id="l55.327" class="difflineplus">+    testString: &quot;third&quot;,</span>
<a href="#l55.328"></a><span id="l55.328" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.329"></a><span id="l55.329" class="difflineplus">+    op: BeginsWith,</span>
<a href="#l55.330"></a><span id="l55.330" class="difflineplus">+    customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.331"></a><span id="l55.331" class="difflineplus">+    count: 1,</span>
<a href="#l55.332"></a><span id="l55.332" class="difflineplus">+  }, {</span>
<a href="#l55.333"></a><span id="l55.333" class="difflineplus">+    testString: &quot;This is&quot;,</span>
<a href="#l55.334"></a><span id="l55.334">     testAttribute: OtherHeader,</span>
<a href="#l55.335"></a><span id="l55.335">     op: BeginsWith,</span>
<a href="#l55.336"></a><span id="l55.336">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.337"></a><span id="l55.337" class="difflineminus">-    count: 1},</span>
<a href="#l55.338"></a><span id="l55.338" class="difflineminus">-  { testString: &quot;This is&quot;,</span>
<a href="#l55.339"></a><span id="l55.339" class="difflineminus">-    testAttribute: OtherHeader,</span>
<a href="#l55.340"></a><span id="l55.340" class="difflineminus">-    op: BeginsWith,</span>
<a href="#l55.341"></a><span id="l55.341" class="difflineminus">-    customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.342"></a><span id="l55.342" class="difflineminus">-    count: 1},</span>
<a href="#l55.343"></a><span id="l55.343" class="difflineplus">+    count: 1,</span>
<a href="#l55.344"></a><span id="l55.344" class="difflineplus">+  },</span>
<a href="#l55.345"></a><span id="l55.345"> </span>
<a href="#l55.346"></a><span id="l55.346" class="difflineminus">-  { testString: &quot;nothing&quot;,</span>
<a href="#l55.347"></a><span id="l55.347" class="difflineplus">+  {</span>
<a href="#l55.348"></a><span id="l55.348" class="difflineplus">+    testString: &quot;nothing&quot;,</span>
<a href="#l55.349"></a><span id="l55.349">     testAttribute: OtherHeader,</span>
<a href="#l55.350"></a><span id="l55.350">     op: Contains,</span>
<a href="#l55.351"></a><span id="l55.351">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.352"></a><span id="l55.352" class="difflineminus">-    count: 0},</span>
<a href="#l55.353"></a><span id="l55.353" class="difflineminus">-  { testString: &quot;nothing&quot;,</span>
<a href="#l55.354"></a><span id="l55.354" class="difflineplus">+    count: 0,</span>
<a href="#l55.355"></a><span id="l55.355" class="difflineplus">+  }, {</span>
<a href="#l55.356"></a><span id="l55.356" class="difflineplus">+    testString: &quot;nothing&quot;,</span>
<a href="#l55.357"></a><span id="l55.357">     testAttribute: OtherHeader,</span>
<a href="#l55.358"></a><span id="l55.358">     op: DoesntContain,</span>
<a href="#l55.359"></a><span id="l55.359">     customHeader: &quot;X-Duplicated-Header&quot;,</span>
<a href="#l55.360"></a><span id="l55.360" class="difflineminus">-    count: 1},</span>
<a href="#l55.361"></a><span id="l55.361" class="difflineminus">-</span>
<a href="#l55.362"></a><span id="l55.362" class="difflineminus">-  { testString: &quot;this header tests DB string properties&quot;,</span>
<a href="#l55.363"></a><span id="l55.363" class="difflineminus">-    testAttribute: OtherHeader,</span>
<a href="#l55.364"></a><span id="l55.364" class="difflineminus">-    op: Is,</span>
<a href="#l55.365"></a><span id="l55.365" class="difflineminus">-    customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.366"></a><span id="l55.366" class="difflineminus">-    count: 1},</span>
<a href="#l55.367"></a><span id="l55.367" class="difflineminus">-  { testString: &quot;which can be handled&quot;,</span>
<a href="#l55.368"></a><span id="l55.368" class="difflineplus">+    count: 1,</span>
<a href="#l55.369"></a><span id="l55.369" class="difflineplus">+  }, {</span>
<a href="#l55.370"></a><span id="l55.370" class="difflineplus">+    testString: &quot;this header tests DB string properties&quot;,</span>
<a href="#l55.371"></a><span id="l55.371">     testAttribute: OtherHeader,</span>
<a href="#l55.372"></a><span id="l55.372">     op: Is,</span>
<a href="#l55.373"></a><span id="l55.373">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.374"></a><span id="l55.374" class="difflineminus">-    count: 1},</span>
<a href="#l55.375"></a><span id="l55.375" class="difflineminus">-  { testString: &quot;differently than X-Duplicated-Header, so better test it&quot;,</span>
<a href="#l55.376"></a><span id="l55.376" class="difflineplus">+    count: 1,</span>
<a href="#l55.377"></a><span id="l55.377" class="difflineplus">+  }, {</span>
<a href="#l55.378"></a><span id="l55.378" class="difflineplus">+    testString: &quot;which can be handled&quot;,</span>
<a href="#l55.379"></a><span id="l55.379">     testAttribute: OtherHeader,</span>
<a href="#l55.380"></a><span id="l55.380">     op: Is,</span>
<a href="#l55.381"></a><span id="l55.381">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.382"></a><span id="l55.382" class="difflineminus">-    count: 1},</span>
<a href="#l55.383"></a><span id="l55.383" class="difflineminus">-  { testString: &quot;this header tests DB string properties&quot;,</span>
<a href="#l55.384"></a><span id="l55.384" class="difflineplus">+    count: 1,</span>
<a href="#l55.385"></a><span id="l55.385" class="difflineplus">+  }, {</span>
<a href="#l55.386"></a><span id="l55.386" class="difflineplus">+    testString: &quot;differently than X-Duplicated-Header, so better test it&quot;,</span>
<a href="#l55.387"></a><span id="l55.387">     testAttribute: OtherHeader,</span>
<a href="#l55.388"></a><span id="l55.388" class="difflineminus">-    op: Isnt,</span>
<a href="#l55.389"></a><span id="l55.389" class="difflineplus">+    op: Is,</span>
<a href="#l55.390"></a><span id="l55.390">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.391"></a><span id="l55.391" class="difflineminus">-    count: 0},</span>
<a href="#l55.392"></a><span id="l55.392" class="difflineminus">-  { testString: &quot;which can be handled&quot;,</span>
<a href="#l55.393"></a><span id="l55.393" class="difflineplus">+    count: 1,</span>
<a href="#l55.394"></a><span id="l55.394" class="difflineplus">+  }, {</span>
<a href="#l55.395"></a><span id="l55.395" class="difflineplus">+    testString: &quot;this header tests DB string properties&quot;,</span>
<a href="#l55.396"></a><span id="l55.396">     testAttribute: OtherHeader,</span>
<a href="#l55.397"></a><span id="l55.397">     op: Isnt,</span>
<a href="#l55.398"></a><span id="l55.398">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.399"></a><span id="l55.399" class="difflineminus">-    count: 0},</span>
<a href="#l55.400"></a><span id="l55.400" class="difflineminus">-  { testString: &quot;differently than X-Duplicated-Header, so better test it&quot;,</span>
<a href="#l55.401"></a><span id="l55.401" class="difflineplus">+    count: 0,</span>
<a href="#l55.402"></a><span id="l55.402" class="difflineplus">+  }, {</span>
<a href="#l55.403"></a><span id="l55.403" class="difflineplus">+    testString: &quot;which can be handled&quot;,</span>
<a href="#l55.404"></a><span id="l55.404">     testAttribute: OtherHeader,</span>
<a href="#l55.405"></a><span id="l55.405">     op: Isnt,</span>
<a href="#l55.406"></a><span id="l55.406">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.407"></a><span id="l55.407" class="difflineminus">-    count: 0},</span>
<a href="#l55.408"></a><span id="l55.408" class="difflineminus">-  { testString: &quot;than X-Duplicated-Header,&quot;,</span>
<a href="#l55.409"></a><span id="l55.409" class="difflineplus">+    count: 0,</span>
<a href="#l55.410"></a><span id="l55.410" class="difflineplus">+  }, {</span>
<a href="#l55.411"></a><span id="l55.411" class="difflineplus">+    testString: &quot;differently than X-Duplicated-Header, so better test it&quot;,</span>
<a href="#l55.412"></a><span id="l55.412" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.413"></a><span id="l55.413" class="difflineplus">+    op: Isnt,</span>
<a href="#l55.414"></a><span id="l55.414" class="difflineplus">+    customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.415"></a><span id="l55.415" class="difflineplus">+    count: 0,</span>
<a href="#l55.416"></a><span id="l55.416" class="difflineplus">+  }, {</span>
<a href="#l55.417"></a><span id="l55.417" class="difflineplus">+    testString: &quot;than X-Duplicated-Header,&quot;,</span>
<a href="#l55.418"></a><span id="l55.418">     testAttribute: OtherHeader,</span>
<a href="#l55.419"></a><span id="l55.419">     op: Contains,</span>
<a href="#l55.420"></a><span id="l55.420">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.421"></a><span id="l55.421" class="difflineminus">-    count: 1},</span>
<a href="#l55.422"></a><span id="l55.422" class="difflineminus">-  { testString: &quot;than X-Duplicated-Header, so&quot;,</span>
<a href="#l55.423"></a><span id="l55.423" class="difflineplus">+    count: 1,</span>
<a href="#l55.424"></a><span id="l55.424" class="difflineplus">+  }, {</span>
<a href="#l55.425"></a><span id="l55.425" class="difflineplus">+    testString: &quot;than X-Duplicated-Header, so&quot;,</span>
<a href="#l55.426"></a><span id="l55.426">     testAttribute: OtherHeader,</span>
<a href="#l55.427"></a><span id="l55.427">     op: DoesntContain,</span>
<a href="#l55.428"></a><span id="l55.428">     customHeader: &quot;X-Duplicated-Header-DB&quot;,</span>
<a href="#l55.429"></a><span id="l55.429" class="difflineminus">-    count: 0},</span>
<a href="#l55.430"></a><span id="l55.430" class="difflineminus">-</span>
<a href="#l55.431"></a><span id="l55.431" class="difflineplus">+    count: 0,</span>
<a href="#l55.432"></a><span id="l55.432" class="difflineplus">+  },</span>
<a href="#l55.433"></a><span id="l55.433">   // test accumulation of received header</span>
<a href="#l55.434"></a><span id="l55.434" class="difflineminus">-  // only in first received</span>
<a href="#l55.435"></a><span id="l55.435" class="difflineminus">-  { testString: &quot;caspiaco&quot;,</span>
<a href="#l55.436"></a><span id="l55.436" class="difflineplus">+  {</span>
<a href="#l55.437"></a><span id="l55.437" class="difflineplus">+    // only in first received</span>
<a href="#l55.438"></a><span id="l55.438" class="difflineplus">+    testString: &quot;caspiaco&quot;,</span>
<a href="#l55.439"></a><span id="l55.439">     testAttribute: OtherHeader,</span>
<a href="#l55.440"></a><span id="l55.440">     op: Contains,</span>
<a href="#l55.441"></a><span id="l55.441">     customHeader: &quot;Received&quot;,</span>
<a href="#l55.442"></a><span id="l55.442" class="difflineminus">-    count: 1},</span>
<a href="#l55.443"></a><span id="l55.443" class="difflineminus">-  // only in second</span>
<a href="#l55.444"></a><span id="l55.444" class="difflineminus">-  { testString: &quot;webapp01.sj.mozilla.com&quot;,</span>
<a href="#l55.445"></a><span id="l55.445" class="difflineplus">+    count: 1,</span>
<a href="#l55.446"></a><span id="l55.446" class="difflineplus">+  }, {</span>
<a href="#l55.447"></a><span id="l55.447" class="difflineplus">+    // only in second</span>
<a href="#l55.448"></a><span id="l55.448" class="difflineplus">+    testString: &quot;webapp01.sj.mozilla.com&quot;,</span>
<a href="#l55.449"></a><span id="l55.449">     testAttribute: OtherHeader,</span>
<a href="#l55.450"></a><span id="l55.450">     op: Contains,</span>
<a href="#l55.451"></a><span id="l55.451">     customHeader: &quot;received&quot;,</span>
<a href="#l55.452"></a><span id="l55.452" class="difflineminus">-    count: 1},</span>
<a href="#l55.453"></a><span id="l55.453" class="difflineminus">-  // in neither</span>
<a href="#l55.454"></a><span id="l55.454" class="difflineminus">-  { testString: &quot;not there&quot;,</span>
<a href="#l55.455"></a><span id="l55.455" class="difflineplus">+    count: 1,</span>
<a href="#l55.456"></a><span id="l55.456" class="difflineplus">+  }, {</span>
<a href="#l55.457"></a><span id="l55.457" class="difflineplus">+    // in neither</span>
<a href="#l55.458"></a><span id="l55.458" class="difflineplus">+    testString: &quot;not there&quot;,</span>
<a href="#l55.459"></a><span id="l55.459">     testAttribute: OtherHeader,</span>
<a href="#l55.460"></a><span id="l55.460">     op: Contains,</span>
<a href="#l55.461"></a><span id="l55.461">     customHeader: &quot;received&quot;,</span>
<a href="#l55.462"></a><span id="l55.462" class="difflineminus">-    count: 0},</span>
<a href="#l55.463"></a><span id="l55.463" class="difflineminus">-  // not on first line of received</span>
<a href="#l55.464"></a><span id="l55.464" class="difflineminus">-  { testString: &quot;m47LtAFJ007547&quot;,</span>
<a href="#l55.465"></a><span id="l55.465" class="difflineplus">+    count: 0,</span>
<a href="#l55.466"></a><span id="l55.466" class="difflineplus">+  }, {</span>
<a href="#l55.467"></a><span id="l55.467" class="difflineplus">+    // not on first line of received</span>
<a href="#l55.468"></a><span id="l55.468" class="difflineplus">+    testString: &quot;m47LtAFJ007547&quot;,</span>
<a href="#l55.469"></a><span id="l55.469">     testAttribute: OtherHeader,</span>
<a href="#l55.470"></a><span id="l55.470">     op: Contains,</span>
<a href="#l55.471"></a><span id="l55.471">     customHeader: &quot;received&quot;,</span>
<a href="#l55.472"></a><span id="l55.472" class="difflineminus">-    count: 1},</span>
<a href="#l55.473"></a><span id="l55.473" class="difflineminus">-</span>
<a href="#l55.474"></a><span id="l55.474" class="difflineplus">+    count: 1,</span>
<a href="#l55.475"></a><span id="l55.475" class="difflineplus">+  },</span>
<a href="#l55.476"></a><span id="l55.476">   // test multiple line arbitrary headers</span>
<a href="#l55.477"></a><span id="l55.477" class="difflineminus">-  // in the first line</span>
<a href="#l55.478"></a><span id="l55.478" class="difflineminus">-  { testString: &quot;SpamAssassin 3.2.3&quot;,</span>
<a href="#l55.479"></a><span id="l55.479" class="difflineplus">+  {</span>
<a href="#l55.480"></a><span id="l55.480" class="difflineplus">+    // in the first line</span>
<a href="#l55.481"></a><span id="l55.481" class="difflineplus">+    testString: &quot;SpamAssassin 3.2.3&quot;,</span>
<a href="#l55.482"></a><span id="l55.482">     testAttribute: OtherHeader,</span>
<a href="#l55.483"></a><span id="l55.483">     op: Contains,</span>
<a href="#l55.484"></a><span id="l55.484">     customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l55.485"></a><span id="l55.485" class="difflineminus">-    count: 1},</span>
<a href="#l55.486"></a><span id="l55.486" class="difflineminus">-  // in the second line</span>
<a href="#l55.487"></a><span id="l55.487" class="difflineminus">-  { testString: &quot;host29.example.com&quot;,</span>
<a href="#l55.488"></a><span id="l55.488" class="difflineplus">+    count: 1,</span>
<a href="#l55.489"></a><span id="l55.489" class="difflineplus">+  }, {</span>
<a href="#l55.490"></a><span id="l55.490" class="difflineplus">+    // in the second line</span>
<a href="#l55.491"></a><span id="l55.491" class="difflineplus">+    testString: &quot;host29.example.com&quot;,</span>
<a href="#l55.492"></a><span id="l55.492" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.493"></a><span id="l55.493" class="difflineplus">+    op: Contains,</span>
<a href="#l55.494"></a><span id="l55.494" class="difflineplus">+    customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l55.495"></a><span id="l55.495" class="difflineplus">+    count: 1,</span>
<a href="#l55.496"></a><span id="l55.496" class="difflineplus">+  }, {</span>
<a href="#l55.497"></a><span id="l55.497" class="difflineplus">+    // spans two lines with space</span>
<a href="#l55.498"></a><span id="l55.498" class="difflineplus">+    testString: &quot;on host29.example.com&quot;,</span>
<a href="#l55.499"></a><span id="l55.499">     testAttribute: OtherHeader,</span>
<a href="#l55.500"></a><span id="l55.500">     op: Contains,</span>
<a href="#l55.501"></a><span id="l55.501">     customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l55.502"></a><span id="l55.502" class="difflineminus">-    count: 1},</span>
<a href="#l55.503"></a><span id="l55.503" class="difflineminus">-  // spans two lines with space</span>
<a href="#l55.504"></a><span id="l55.504" class="difflineminus">-   { testString: &quot;on host29.example.com&quot;,</span>
<a href="#l55.505"></a><span id="l55.505" class="difflineminus">-     testAttribute: OtherHeader,</span>
<a href="#l55.506"></a><span id="l55.506" class="difflineminus">-     op: Contains,</span>
<a href="#l55.507"></a><span id="l55.507" class="difflineminus">-     customHeader: &quot;X-Spam-Checker-Version&quot;,</span>
<a href="#l55.508"></a><span id="l55.508" class="difflineminus">-     count: 1},</span>
<a href="#l55.509"></a><span id="l55.509" class="difflineminus">-</span>
<a href="#l55.510"></a><span id="l55.510" class="difflineplus">+    count: 1,</span>
<a href="#l55.511"></a><span id="l55.511" class="difflineplus">+  },</span>
<a href="#l55.512"></a><span id="l55.512">   // subject spanning several lines</span>
<a href="#l55.513"></a><span id="l55.513" class="difflineminus">-  // on the first line</span>
<a href="#l55.514"></a><span id="l55.514" class="difflineminus">-   { testString: &quot;A filter will&quot;,</span>
<a href="#l55.515"></a><span id="l55.515" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l55.516"></a><span id="l55.516" class="difflineminus">-     op: Contains,</span>
<a href="#l55.517"></a><span id="l55.517" class="difflineminus">-     count: 1},</span>
<a href="#l55.518"></a><span id="l55.518" class="difflineminus">-   { testString: &quot;I do not exist&quot;,</span>
<a href="#l55.519"></a><span id="l55.519" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l55.520"></a><span id="l55.520" class="difflineminus">-     op: Contains,</span>
<a href="#l55.521"></a><span id="l55.521" class="difflineminus">-     count: 0},</span>
<a href="#l55.522"></a><span id="l55.522" class="difflineminus">-  // on the second line</span>
<a href="#l55.523"></a><span id="l55.523" class="difflineminus">-   { testString: &quot;this message&quot;,</span>
<a href="#l55.524"></a><span id="l55.524" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l55.525"></a><span id="l55.525" class="difflineminus">-     op: Contains,</span>
<a href="#l55.526"></a><span id="l55.526" class="difflineminus">-     count: 1},</span>
<a href="#l55.527"></a><span id="l55.527" class="difflineminus">-  // spanning second and third line</span>
<a href="#l55.528"></a><span id="l55.528" class="difflineminus">-   { testString: &quot;over many&quot;,</span>
<a href="#l55.529"></a><span id="l55.529" class="difflineminus">-     testAttribute: Subject,</span>
<a href="#l55.530"></a><span id="l55.530" class="difflineminus">-     op: Contains,</span>
<a href="#l55.531"></a><span id="l55.531" class="difflineminus">-     count: 1},</span>
<a href="#l55.532"></a><span id="l55.532" class="difflineminus">-</span>
<a href="#l55.533"></a><span id="l55.533" class="difflineplus">+  {</span>
<a href="#l55.534"></a><span id="l55.534" class="difflineplus">+    // on the first line</span>
<a href="#l55.535"></a><span id="l55.535" class="difflineplus">+    testString: &quot;A filter will&quot;,</span>
<a href="#l55.536"></a><span id="l55.536" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l55.537"></a><span id="l55.537" class="difflineplus">+    op: Contains,</span>
<a href="#l55.538"></a><span id="l55.538" class="difflineplus">+    count: 1,</span>
<a href="#l55.539"></a><span id="l55.539" class="difflineplus">+  }, {</span>
<a href="#l55.540"></a><span id="l55.540" class="difflineplus">+    testString: &quot;I do not exist&quot;,</span>
<a href="#l55.541"></a><span id="l55.541" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l55.542"></a><span id="l55.542" class="difflineplus">+    op: Contains,</span>
<a href="#l55.543"></a><span id="l55.543" class="difflineplus">+    count: 0,</span>
<a href="#l55.544"></a><span id="l55.544" class="difflineplus">+  }, {</span>
<a href="#l55.545"></a><span id="l55.545" class="difflineplus">+    // on the second line</span>
<a href="#l55.546"></a><span id="l55.546" class="difflineplus">+    testString: &quot;this message&quot;,</span>
<a href="#l55.547"></a><span id="l55.547" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l55.548"></a><span id="l55.548" class="difflineplus">+    op: Contains,</span>
<a href="#l55.549"></a><span id="l55.549" class="difflineplus">+    count: 1,</span>
<a href="#l55.550"></a><span id="l55.550" class="difflineplus">+  }, {</span>
<a href="#l55.551"></a><span id="l55.551" class="difflineplus">+    // spanning second and third line</span>
<a href="#l55.552"></a><span id="l55.552" class="difflineplus">+    testString: &quot;over many&quot;,</span>
<a href="#l55.553"></a><span id="l55.553" class="difflineplus">+    testAttribute: Subject,</span>
<a href="#l55.554"></a><span id="l55.554" class="difflineplus">+    op: Contains,</span>
<a href="#l55.555"></a><span id="l55.555" class="difflineplus">+    count: 1,</span>
<a href="#l55.556"></a><span id="l55.556" class="difflineplus">+  },</span>
<a href="#l55.557"></a><span id="l55.557">   // tests of custom headers db values</span>
<a href="#l55.558"></a><span id="l55.558" class="difflineminus">-    { testString: &quot;a one line header&quot;,</span>
<a href="#l55.559"></a><span id="l55.559" class="difflineminus">-      dbHeader: &quot;oneliner&quot;},</span>
<a href="#l55.560"></a><span id="l55.560" class="difflineminus">-    { testString: &quot;a two line header&quot;,</span>
<a href="#l55.561"></a><span id="l55.561" class="difflineminus">-      dbHeader: &quot;twoliner&quot;},</span>
<a href="#l55.562"></a><span id="l55.562" class="difflineminus">-    { testString: &quot;a three line header with lotsa space and tabs&quot;,</span>
<a href="#l55.563"></a><span id="l55.563" class="difflineminus">-      dbHeader: &quot;threeliner&quot;},</span>
<a href="#l55.564"></a><span id="l55.564" class="difflineminus">-    { testString: &quot;I have no space&quot;,</span>
<a href="#l55.565"></a><span id="l55.565" class="difflineminus">-      dbHeader: &quot;nospace&quot;},</span>
<a href="#l55.566"></a><span id="l55.566" class="difflineminus">-    { testString: &quot;too much space&quot;,</span>
<a href="#l55.567"></a><span id="l55.567" class="difflineminus">-      dbHeader: &quot;withspace&quot;},</span>
<a href="#l55.568"></a><span id="l55.568" class="difflineminus">-</span>
<a href="#l55.569"></a><span id="l55.569" class="difflineplus">+  {</span>
<a href="#l55.570"></a><span id="l55.570" class="difflineplus">+    testString: &quot;a one line header&quot;,</span>
<a href="#l55.571"></a><span id="l55.571" class="difflineplus">+    dbHeader: &quot;oneliner&quot;,</span>
<a href="#l55.572"></a><span id="l55.572" class="difflineplus">+  }, {</span>
<a href="#l55.573"></a><span id="l55.573" class="difflineplus">+    testString: &quot;a two line header&quot;,</span>
<a href="#l55.574"></a><span id="l55.574" class="difflineplus">+    dbHeader: &quot;twoliner&quot;,</span>
<a href="#l55.575"></a><span id="l55.575" class="difflineplus">+  }, {</span>
<a href="#l55.576"></a><span id="l55.576" class="difflineplus">+    testString: &quot;a three line header with lotsa space and tabs&quot;,</span>
<a href="#l55.577"></a><span id="l55.577" class="difflineplus">+    dbHeader: &quot;threeliner&quot;,</span>
<a href="#l55.578"></a><span id="l55.578" class="difflineplus">+  }, {</span>
<a href="#l55.579"></a><span id="l55.579" class="difflineplus">+    testString: &quot;I have no space&quot;,</span>
<a href="#l55.580"></a><span id="l55.580" class="difflineplus">+    dbHeader: &quot;nospace&quot;,</span>
<a href="#l55.581"></a><span id="l55.581" class="difflineplus">+  }, {</span>
<a href="#l55.582"></a><span id="l55.582" class="difflineplus">+    testString: &quot;too much space&quot;,</span>
<a href="#l55.583"></a><span id="l55.583" class="difflineplus">+    dbHeader: &quot;withspace&quot;,</span>
<a href="#l55.584"></a><span id="l55.584" class="difflineplus">+  },</span>
<a href="#l55.585"></a><span id="l55.585">   // tests of custom db headers in a search</span>
<a href="#l55.586"></a><span id="l55.586" class="difflineminus">-    { testString: &quot;one line&quot;,</span>
<a href="#l55.587"></a><span id="l55.587" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l55.588"></a><span id="l55.588" class="difflineminus">-      op: Contains,</span>
<a href="#l55.589"></a><span id="l55.589" class="difflineminus">-      customHeader: &quot;oneliner&quot;,</span>
<a href="#l55.590"></a><span id="l55.590" class="difflineminus">-      count: 1},</span>
<a href="#l55.591"></a><span id="l55.591" class="difflineminus">-    { testString: &quot;two line header&quot;,</span>
<a href="#l55.592"></a><span id="l55.592" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l55.593"></a><span id="l55.593" class="difflineminus">-      op: Contains,</span>
<a href="#l55.594"></a><span id="l55.594" class="difflineminus">-      customHeader: &quot;twoliner&quot;,</span>
<a href="#l55.595"></a><span id="l55.595" class="difflineminus">-      count: 1},</span>
<a href="#l55.596"></a><span id="l55.596" class="difflineminus">-    { testString: &quot;three line header with lotsa&quot;,</span>
<a href="#l55.597"></a><span id="l55.597" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l55.598"></a><span id="l55.598" class="difflineminus">-      op: Contains,</span>
<a href="#l55.599"></a><span id="l55.599" class="difflineminus">-      customHeader: &quot;threeliner&quot;,</span>
<a href="#l55.600"></a><span id="l55.600" class="difflineminus">-      count: 1},</span>
<a href="#l55.601"></a><span id="l55.601" class="difflineminus">-    { testString: &quot;I have no space&quot;,</span>
<a href="#l55.602"></a><span id="l55.602" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l55.603"></a><span id="l55.603" class="difflineminus">-      op: Contains,</span>
<a href="#l55.604"></a><span id="l55.604" class="difflineminus">-      customHeader: &quot;nospace&quot;,</span>
<a href="#l55.605"></a><span id="l55.605" class="difflineminus">-      count: 1},</span>
<a href="#l55.606"></a><span id="l55.606" class="difflineminus">-    { testString: &quot;too much space&quot;,</span>
<a href="#l55.607"></a><span id="l55.607" class="difflineminus">-      testAttribute: OtherHeader,</span>
<a href="#l55.608"></a><span id="l55.608" class="difflineminus">-      op: Contains,</span>
<a href="#l55.609"></a><span id="l55.609" class="difflineminus">-      customHeader: &quot;withspace&quot;,</span>
<a href="#l55.610"></a><span id="l55.610" class="difflineminus">-      count: 1},</span>
<a href="#l55.611"></a><span id="l55.611" class="difflineminus">-</span>
<a href="#l55.612"></a><span id="l55.612" class="difflineminus">-    //test for priority</span>
<a href="#l55.613"></a><span id="l55.613" class="difflineminus">-    { testString: Ci.nsMsgPriority.lowest,</span>
<a href="#l55.614"></a><span id="l55.614" class="difflineminus">-      testAttribute: Priority,</span>
<a href="#l55.615"></a><span id="l55.615" class="difflineminus">-      op: IsHigherThan,</span>
<a href="#l55.616"></a><span id="l55.616" class="difflineminus">-      count: 1},</span>
<a href="#l55.617"></a><span id="l55.617" class="difflineminus">-    { testString: Ci.nsMsgPriority.low,</span>
<a href="#l55.618"></a><span id="l55.618" class="difflineminus">-      testAttribute: Priority,</span>
<a href="#l55.619"></a><span id="l55.619" class="difflineminus">-      op: Is,</span>
<a href="#l55.620"></a><span id="l55.620" class="difflineminus">-      count: 1},</span>
<a href="#l55.621"></a><span id="l55.621" class="difflineminus">-    { testString: Ci.nsMsgPriority.normal,</span>
<a href="#l55.622"></a><span id="l55.622" class="difflineminus">-      testAttribute: Priority,</span>
<a href="#l55.623"></a><span id="l55.623" class="difflineminus">-      op: IsLowerThan,</span>
<a href="#l55.624"></a><span id="l55.624" class="difflineminus">-      count: 1},</span>
<a href="#l55.625"></a><span id="l55.625" class="difflineminus">-    { testString: Ci.nsMsgPriority.lowest,</span>
<a href="#l55.626"></a><span id="l55.626" class="difflineminus">-      testAttribute: Priority,</span>
<a href="#l55.627"></a><span id="l55.627" class="difflineminus">-      op: Isnt,</span>
<a href="#l55.628"></a><span id="l55.628" class="difflineminus">-      count: 1},</span>
<a href="#l55.629"></a><span id="l55.629" class="difflineminus">-    { testString: Ci.nsMsgPriority.low,</span>
<a href="#l55.630"></a><span id="l55.630" class="difflineminus">-      testAttribute: Priority,</span>
<a href="#l55.631"></a><span id="l55.631" class="difflineminus">-      op: Isnt,</span>
<a href="#l55.632"></a><span id="l55.632" class="difflineminus">-      count: 0},</span>
<a href="#l55.633"></a><span id="l55.633" class="difflineplus">+  {</span>
<a href="#l55.634"></a><span id="l55.634" class="difflineplus">+    testString: &quot;one line&quot;,</span>
<a href="#l55.635"></a><span id="l55.635" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.636"></a><span id="l55.636" class="difflineplus">+    op: Contains,</span>
<a href="#l55.637"></a><span id="l55.637" class="difflineplus">+    customHeader: &quot;oneliner&quot;,</span>
<a href="#l55.638"></a><span id="l55.638" class="difflineplus">+    count: 1,</span>
<a href="#l55.639"></a><span id="l55.639" class="difflineplus">+  }, {</span>
<a href="#l55.640"></a><span id="l55.640" class="difflineplus">+    testString: &quot;two line header&quot;,</span>
<a href="#l55.641"></a><span id="l55.641" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.642"></a><span id="l55.642" class="difflineplus">+    op: Contains,</span>
<a href="#l55.643"></a><span id="l55.643" class="difflineplus">+    customHeader: &quot;twoliner&quot;,</span>
<a href="#l55.644"></a><span id="l55.644" class="difflineplus">+    count: 1,</span>
<a href="#l55.645"></a><span id="l55.645" class="difflineplus">+  }, {</span>
<a href="#l55.646"></a><span id="l55.646" class="difflineplus">+    testString: &quot;three line header with lotsa&quot;,</span>
<a href="#l55.647"></a><span id="l55.647" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.648"></a><span id="l55.648" class="difflineplus">+    op: Contains,</span>
<a href="#l55.649"></a><span id="l55.649" class="difflineplus">+    customHeader: &quot;threeliner&quot;,</span>
<a href="#l55.650"></a><span id="l55.650" class="difflineplus">+    count: 1,</span>
<a href="#l55.651"></a><span id="l55.651" class="difflineplus">+  }, {</span>
<a href="#l55.652"></a><span id="l55.652" class="difflineplus">+    testString: &quot;I have no space&quot;,</span>
<a href="#l55.653"></a><span id="l55.653" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.654"></a><span id="l55.654" class="difflineplus">+    op: Contains,</span>
<a href="#l55.655"></a><span id="l55.655" class="difflineplus">+    customHeader: &quot;nospace&quot;,</span>
<a href="#l55.656"></a><span id="l55.656" class="difflineplus">+    count: 1,</span>
<a href="#l55.657"></a><span id="l55.657" class="difflineplus">+  }, {</span>
<a href="#l55.658"></a><span id="l55.658" class="difflineplus">+    testString: &quot;too much space&quot;,</span>
<a href="#l55.659"></a><span id="l55.659" class="difflineplus">+    testAttribute: OtherHeader,</span>
<a href="#l55.660"></a><span id="l55.660" class="difflineplus">+    op: Contains,</span>
<a href="#l55.661"></a><span id="l55.661" class="difflineplus">+    customHeader: &quot;withspace&quot;,</span>
<a href="#l55.662"></a><span id="l55.662" class="difflineplus">+    count: 1,</span>
<a href="#l55.663"></a><span id="l55.663" class="difflineplus">+  },</span>
<a href="#l55.664"></a><span id="l55.664" class="difflineplus">+  // test for priority</span>
<a href="#l55.665"></a><span id="l55.665" class="difflineplus">+  {</span>
<a href="#l55.666"></a><span id="l55.666" class="difflineplus">+    testString: Ci.nsMsgPriority.lowest,</span>
<a href="#l55.667"></a><span id="l55.667" class="difflineplus">+    testAttribute: Priority,</span>
<a href="#l55.668"></a><span id="l55.668" class="difflineplus">+    op: IsHigherThan,</span>
<a href="#l55.669"></a><span id="l55.669" class="difflineplus">+    count: 1,</span>
<a href="#l55.670"></a><span id="l55.670" class="difflineplus">+  }, {</span>
<a href="#l55.671"></a><span id="l55.671" class="difflineplus">+    testString: Ci.nsMsgPriority.low,</span>
<a href="#l55.672"></a><span id="l55.672" class="difflineplus">+    testAttribute: Priority,</span>
<a href="#l55.673"></a><span id="l55.673" class="difflineplus">+    op: Is,</span>
<a href="#l55.674"></a><span id="l55.674" class="difflineplus">+    count: 1,</span>
<a href="#l55.675"></a><span id="l55.675" class="difflineplus">+  }, {</span>
<a href="#l55.676"></a><span id="l55.676" class="difflineplus">+    testString: Ci.nsMsgPriority.normal,</span>
<a href="#l55.677"></a><span id="l55.677" class="difflineplus">+    testAttribute: Priority,</span>
<a href="#l55.678"></a><span id="l55.678" class="difflineplus">+    op: IsLowerThan,</span>
<a href="#l55.679"></a><span id="l55.679" class="difflineplus">+    count: 1,</span>
<a href="#l55.680"></a><span id="l55.680" class="difflineplus">+  }, {</span>
<a href="#l55.681"></a><span id="l55.681" class="difflineplus">+    testString: Ci.nsMsgPriority.lowest,</span>
<a href="#l55.682"></a><span id="l55.682" class="difflineplus">+    testAttribute: Priority,</span>
<a href="#l55.683"></a><span id="l55.683" class="difflineplus">+    op: Isnt,</span>
<a href="#l55.684"></a><span id="l55.684" class="difflineplus">+    count: 1,</span>
<a href="#l55.685"></a><span id="l55.685" class="difflineplus">+  }, {</span>
<a href="#l55.686"></a><span id="l55.686" class="difflineplus">+    testString: Ci.nsMsgPriority.low,</span>
<a href="#l55.687"></a><span id="l55.687" class="difflineplus">+    testAttribute: Priority,</span>
<a href="#l55.688"></a><span id="l55.688" class="difflineplus">+    op: Isnt,</span>
<a href="#l55.689"></a><span id="l55.689" class="difflineplus">+    count: 0,</span>
<a href="#l55.690"></a><span id="l55.690" class="difflineplus">+  },</span>
<a href="#l55.691"></a><span id="l55.691"> </span>
<a href="#l55.692"></a><span id="l55.692">   // tests of Date header</span>
<a href="#l55.693"></a><span id="l55.693">   // The internal value of date in the search is PRTime (nanoseconds since Epoch).</span>
<a href="#l55.694"></a><span id="l55.694">   // Date().getTime() returns milliseconds since Epoch.</span>
<a href="#l55.695"></a><span id="l55.695">   // The dates used here are tailored for the ../../../data/bugmail12 message.</span>
<a href="#l55.696"></a><span id="l55.696" class="difflineminus">-  { testString: new Date(&quot;Wed, 7 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.697"></a><span id="l55.697" class="difflineplus">+  {</span>
<a href="#l55.698"></a><span id="l55.698" class="difflineplus">+    testString: new Date(&quot;Wed, 7 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.699"></a><span id="l55.699">     testAttribute: SDate,</span>
<a href="#l55.700"></a><span id="l55.700">     op: Is,</span>
<a href="#l55.701"></a><span id="l55.701" class="difflineminus">-    count: 1},</span>
<a href="#l55.702"></a><span id="l55.702" class="difflineminus">-  { testString: new Date(&quot;Thu, 8 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.703"></a><span id="l55.703" class="difflineplus">+    count: 1,</span>
<a href="#l55.704"></a><span id="l55.704" class="difflineplus">+  }, {</span>
<a href="#l55.705"></a><span id="l55.705" class="difflineplus">+    testString: new Date(&quot;Thu, 8 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.706"></a><span id="l55.706">     testAttribute: SDate,</span>
<a href="#l55.707"></a><span id="l55.707">     op: IsBefore,</span>
<a href="#l55.708"></a><span id="l55.708" class="difflineminus">-    count: 1},</span>
<a href="#l55.709"></a><span id="l55.709" class="difflineminus">-  { testString: new Date(&quot;Tue, 6 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.710"></a><span id="l55.710" class="difflineplus">+    count: 1,</span>
<a href="#l55.711"></a><span id="l55.711" class="difflineplus">+  }, {</span>
<a href="#l55.712"></a><span id="l55.712" class="difflineplus">+    testString: new Date(&quot;Tue, 6 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.713"></a><span id="l55.713">     testAttribute: SDate,</span>
<a href="#l55.714"></a><span id="l55.714">     op: IsAfter,</span>
<a href="#l55.715"></a><span id="l55.715" class="difflineminus">-    count: 1},</span>
<a href="#l55.716"></a><span id="l55.716" class="difflineminus">-  { testString: new Date(&quot;Tue, 6 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.717"></a><span id="l55.717" class="difflineplus">+    count: 1,</span>
<a href="#l55.718"></a><span id="l55.718" class="difflineplus">+  }, {</span>
<a href="#l55.719"></a><span id="l55.719" class="difflineplus">+    testString: new Date(&quot;Tue, 6 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.720"></a><span id="l55.720">     testAttribute: SDate,</span>
<a href="#l55.721"></a><span id="l55.721">     op: Isnt,</span>
<a href="#l55.722"></a><span id="l55.722" class="difflineminus">-    count: 1},</span>
<a href="#l55.723"></a><span id="l55.723" class="difflineminus">-  // check bug 248808</span>
<a href="#l55.724"></a><span id="l55.724" class="difflineminus">-  { testString: new Date(&quot;Wed, 7 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.725"></a><span id="l55.725" class="difflineplus">+    count: 1,</span>
<a href="#l55.726"></a><span id="l55.726" class="difflineplus">+  }, {</span>
<a href="#l55.727"></a><span id="l55.727" class="difflineplus">+    // check bug 248808</span>
<a href="#l55.728"></a><span id="l55.728" class="difflineplus">+    testString: new Date(&quot;Wed, 7 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.729"></a><span id="l55.729">     testAttribute: SDate,</span>
<a href="#l55.730"></a><span id="l55.730">     op: IsBefore,</span>
<a href="#l55.731"></a><span id="l55.731" class="difflineminus">-    count: 0},</span>
<a href="#l55.732"></a><span id="l55.732" class="difflineminus">-  { testString: new Date(&quot;Wed, 7 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.733"></a><span id="l55.733" class="difflineplus">+    count: 0,</span>
<a href="#l55.734"></a><span id="l55.734" class="difflineplus">+  }, {</span>
<a href="#l55.735"></a><span id="l55.735" class="difflineplus">+    testString: new Date(&quot;Wed, 7 May 2008 14:55:10 -0700&quot;).getTime() * 1000,</span>
<a href="#l55.736"></a><span id="l55.736">     testAttribute: SDate,</span>
<a href="#l55.737"></a><span id="l55.737">     op: IsAfter,</span>
<a href="#l55.738"></a><span id="l55.738" class="difflineminus">-    count: 0}</span>
<a href="#l55.739"></a><span id="l55.739" class="difflineplus">+    count: 0,</span>
<a href="#l55.740"></a><span id="l55.740" class="difflineplus">+  },</span>
<a href="#l55.741"></a><span id="l55.741"> ];</span>
<a href="#l55.742"></a><span id="l55.742"> </span>
<a href="#l55.743"></a><span id="l55.743" class="difflineminus">-function run_test()</span>
<a href="#l55.744"></a><span id="l55.744" class="difflineminus">-{</span>
<a href="#l55.745"></a><span id="l55.745" class="difflineplus">+function run_test() {</span>
<a href="#l55.746"></a><span id="l55.746">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l55.747"></a><span id="l55.747"> </span>
<a href="#l55.748"></a><span id="l55.748" class="difflineminus">-  var copyListener =</span>
<a href="#l55.749"></a><span id="l55.749" class="difflineminus">-  {</span>
<a href="#l55.750"></a><span id="l55.750" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l55.751"></a><span id="l55.751" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l55.752"></a><span id="l55.752" class="difflineminus">-    SetMessageKey: function(aKey) {},</span>
<a href="#l55.753"></a><span id="l55.753" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l55.754"></a><span id="l55.754" class="difflineminus">-    OnStopCopy: function(aStatus) { testSearch();}</span>
<a href="#l55.755"></a><span id="l55.755" class="difflineplus">+  var copyListener = {</span>
<a href="#l55.756"></a><span id="l55.756" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l55.757"></a><span id="l55.757" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l55.758"></a><span id="l55.758" class="difflineplus">+    SetMessageKey(aKey) {},</span>
<a href="#l55.759"></a><span id="l55.759" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l55.760"></a><span id="l55.760" class="difflineplus">+    OnStopCopy(aStatus) { testSearch(); },</span>
<a href="#l55.761"></a><span id="l55.761">   };</span>
<a href="#l55.762"></a><span id="l55.762"> </span>
<a href="#l55.763"></a><span id="l55.763">   // set value of headers we want parsed into the db</span>
<a href="#l55.764"></a><span id="l55.764">   Services.prefs.setCharPref(&quot;mailnews.customDBHeaders&quot;,</span>
<a href="#l55.765"></a><span id="l55.765">           &quot;oneLiner twoLiner threeLiner noSpace withSpace X-Duplicated-Header-DB&quot;);</span>
<a href="#l55.766"></a><span id="l55.766">   // Get a message into the local filestore. function testSearch() continues</span>
<a href="#l55.767"></a><span id="l55.767">   // the testing after the copy.</span>
<a href="#l55.768"></a><span id="l55.768">   var bugmail12 = do_get_file(&quot;../../../data/bugmail12&quot;);</span>
<a href="#l55.769"></a><span id="l55.769">   do_test_pending();</span>
<a href="#l55.770"></a><span id="l55.770">   MailServices.copy.CopyFileMessage(bugmail12, localAccountUtils.inboxFolder, null,</span>
<a href="#l55.771"></a><span id="l55.771">                                     false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l55.772"></a><span id="l55.772"> }</span>
<a href="#l55.773"></a><span id="l55.773"> </span>
<a href="#l55.774"></a><span id="l55.774"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l55.775"></a><span id="l55.775" class="difflineminus">-var testObject;</span>
<a href="#l55.776"></a><span id="l55.776" class="difflineminus">-function testSearch()</span>
<a href="#l55.777"></a><span id="l55.777" class="difflineminus">-{</span>
<a href="#l55.778"></a><span id="l55.778" class="difflineplus">+function testSearch() {</span>
<a href="#l55.779"></a><span id="l55.779">   var test = Tests.shift();</span>
<a href="#l55.780"></a><span id="l55.780" class="difflineminus">-  if (test &amp;&amp; test.dbHeader)</span>
<a href="#l55.781"></a><span id="l55.781" class="difflineminus">-  {</span>
<a href="#l55.782"></a><span id="l55.782" class="difflineplus">+  if (test &amp;&amp; test.dbHeader) {</span>
<a href="#l55.783"></a><span id="l55.783">     //  test of a custom db header</span>
<a href="#l55.784"></a><span id="l55.784">     dump(&quot;testing dbHeader &quot; + test.dbHeader + &quot;\n&quot;);</span>
<a href="#l55.785"></a><span id="l55.785">     let customValue = mailTestUtils.firstMsgHdr(localAccountUtils.inboxFolder)</span>
<a href="#l55.786"></a><span id="l55.786">                                    .getProperty(test.dbHeader);</span>
<a href="#l55.787"></a><span id="l55.787">     Assert.equal(customValue, test.testString);</span>
<a href="#l55.788"></a><span id="l55.788">     do_timeout(0, testSearch);</span>
<a href="#l55.789"></a><span id="l55.789" class="difflineminus">-  }</span>
<a href="#l55.790"></a><span id="l55.790" class="difflineminus">-  else if (test)</span>
<a href="#l55.791"></a><span id="l55.791" class="difflineminus">-  {</span>
<a href="#l55.792"></a><span id="l55.792" class="difflineplus">+  } else if (test) {</span>
<a href="#l55.793"></a><span id="l55.793">     dump(&quot;testing for string '&quot; + test.testString + &quot;'\n&quot;);</span>
<a href="#l55.794"></a><span id="l55.794" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l55.795"></a><span id="l55.795" class="difflineminus">-                         test.testString,</span>
<a href="#l55.796"></a><span id="l55.796" class="difflineminus">-                         test.testAttribute,</span>
<a href="#l55.797"></a><span id="l55.797" class="difflineminus">-                         test.op,</span>
<a href="#l55.798"></a><span id="l55.798" class="difflineminus">-                         test.count,</span>
<a href="#l55.799"></a><span id="l55.799" class="difflineminus">-                         testSearch,</span>
<a href="#l55.800"></a><span id="l55.800" class="difflineminus">-                         null,</span>
<a href="#l55.801"></a><span id="l55.801" class="difflineminus">-                         test.customHeader ? test.customHeader : &quot;X-Bugzilla-Watch-Reason&quot;);</span>
<a href="#l55.802"></a><span id="l55.802" class="difflineminus">-  }</span>
<a href="#l55.803"></a><span id="l55.803" class="difflineminus">-  else</span>
<a href="#l55.804"></a><span id="l55.804" class="difflineminus">-  {</span>
<a href="#l55.805"></a><span id="l55.805" class="difflineminus">-    testObject = null;</span>
<a href="#l55.806"></a><span id="l55.806" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l55.807"></a><span id="l55.807" class="difflineplus">+                   test.testString,</span>
<a href="#l55.808"></a><span id="l55.808" class="difflineplus">+                   test.testAttribute,</span>
<a href="#l55.809"></a><span id="l55.809" class="difflineplus">+                   test.op,</span>
<a href="#l55.810"></a><span id="l55.810" class="difflineplus">+                   test.count,</span>
<a href="#l55.811"></a><span id="l55.811" class="difflineplus">+                   testSearch,</span>
<a href="#l55.812"></a><span id="l55.812" class="difflineplus">+                   null,</span>
<a href="#l55.813"></a><span id="l55.813" class="difflineplus">+                   test.customHeader ? test.customHeader : &quot;X-Bugzilla-Watch-Reason&quot;);</span>
<a href="#l55.814"></a><span id="l55.814" class="difflineplus">+  } else {</span>
<a href="#l55.815"></a><span id="l55.815">     do_test_finished();</span>
<a href="#l55.816"></a><span id="l55.816">   }</span>
<a href="#l55.817"></a><span id="l55.817"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchAddressInAb.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchAddressInAb.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -1,46 +1,44 @@</span>
<a href="#l56.4"></a><span id="l56.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l56.5"></a><span id="l56.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l56.6"></a><span id="l56.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l56.7"></a><span id="l56.7"> </span>
<a href="#l56.8"></a><span id="l56.8"> // Testing of to, cc, toorcc in addressbook search features added in bug 187768</span>
<a href="#l56.9"></a><span id="l56.9"> // Added testing of AllAddresses from bug 310359</span>
<a href="#l56.10"></a><span id="l56.10"> </span>
<a href="#l56.11"></a><span id="l56.11" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l56.12"></a><span id="l56.12"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l56.13"></a><span id="l56.13"> </span>
<a href="#l56.14"></a><span id="l56.14"> // add address book setup</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l56.16"></a><span id="l56.16"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l56.17"></a><span id="l56.17"> </span>
<a href="#l56.18"></a><span id="l56.18"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l56.19"></a><span id="l56.19"> </span>
<a href="#l56.20"></a><span id="l56.20"> var ABUri = kPABData.URI;</span>
<a href="#l56.21"></a><span id="l56.21"> </span>
<a href="#l56.22"></a><span id="l56.22" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l56.25"></a><span id="l56.25" class="difflineminus">-</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineminus">-var IsntInAB = nsMsgSearchOp.IsntInAB;</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineminus">-var IsInAB = nsMsgSearchOp.IsInAB;</span>
<a href="#l56.28"></a><span id="l56.28" class="difflineminus">-var IsBefore = nsMsgSearchOp.IsBefore; // control entry that is not enabled</span>
<a href="#l56.29"></a><span id="l56.29" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l56.30"></a><span id="l56.30" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineplus">+var IsntInAB = Ci.nsMsgSearchOp.IsntInAB;</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineplus">+var IsInAB = Ci.nsMsgSearchOp.IsInAB;</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineplus">+var IsBefore = Ci.nsMsgSearchOp.IsBefore; // control entry that is not enabled</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l56.36"></a><span id="l56.36"> </span>
<a href="#l56.37"></a><span id="l56.37" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineminus">-var onlineMail = nsMsgSearchScope.onlineMail;</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineminus">-var offlineMailFilter = nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l56.40"></a><span id="l56.40" class="difflineminus">-var onlineMailFilter = nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineminus">-var news = nsMsgSearchScope.news; // control entry that is not enabled</span>
<a href="#l56.42"></a><span id="l56.42" class="difflineplus">+var offlineMail = Ci.nsMsgSearchScope.offlineMail;</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineplus">+var onlineMail = Ci.nsMsgSearchScope.onlineMail;</span>
<a href="#l56.44"></a><span id="l56.44" class="difflineplus">+var offlineMailFilter = Ci.nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l56.45"></a><span id="l56.45" class="difflineplus">+var onlineMailFilter = Ci.nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l56.46"></a><span id="l56.46" class="difflineplus">+var news = Ci.nsMsgSearchScope.news; // control entry that is not enabled</span>
<a href="#l56.47"></a><span id="l56.47"> </span>
<a href="#l56.48"></a><span id="l56.48" class="difflineminus">-var Sender = nsMsgSearchAttrib.Sender;</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineminus">-var To = nsMsgSearchAttrib.To;</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineminus">-var CCopy = nsMsgSearchAttrib.CC;</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineminus">-var ToOrCC = nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l56.52"></a><span id="l56.52" class="difflineminus">-var AllAddresses = nsMsgSearchAttrib.AllAddresses;</span>
<a href="#l56.53"></a><span id="l56.53" class="difflineminus">-var Keywords = nsMsgSearchAttrib.Keywords; // control entry that is not enabled</span>
<a href="#l56.54"></a><span id="l56.54" class="difflineplus">+var Sender = Ci.nsMsgSearchAttrib.Sender;</span>
<a href="#l56.55"></a><span id="l56.55" class="difflineplus">+var To = Ci.nsMsgSearchAttrib.To;</span>
<a href="#l56.56"></a><span id="l56.56" class="difflineplus">+var CCopy = Ci.nsMsgSearchAttrib.CC;</span>
<a href="#l56.57"></a><span id="l56.57" class="difflineplus">+var ToOrCC = Ci.nsMsgSearchAttrib.ToOrCC;</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineplus">+var AllAddresses = Ci.nsMsgSearchAttrib.AllAddresses;</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineplus">+var Keywords = Ci.nsMsgSearchAttrib.Keywords; // control entry that is not enabled</span>
<a href="#l56.60"></a><span id="l56.60"> </span>
<a href="#l56.61"></a><span id="l56.61"> /*</span>
<a href="#l56.62"></a><span id="l56.62">  * The address available in the test address book is &quot;PrimaryEmail1@test.invalid&quot;</span>
<a href="#l56.63"></a><span id="l56.63">  * Test emails may also include the address &quot;invalid@example.com&quot;</span>
<a href="#l56.64"></a><span id="l56.64">  *</span>
<a href="#l56.65"></a><span id="l56.65">  *</span>
<a href="#l56.66"></a><span id="l56.66">  * Map of test email contents: (P is &quot;Prim...&quot;, I is &quot;inva..&quot; address, N is none)</span>
<a href="#l56.67"></a><span id="l56.67">  *</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineat">@@ -52,109 +50,122 @@ var Keywords = nsMsgSearchAttrib.Keyword</span>
<a href="#l56.69"></a><span id="l56.69">  *    4         I         I       P     N</span>
<a href="#l56.70"></a><span id="l56.70">  *    5         P         I       P     N</span>
<a href="#l56.71"></a><span id="l56.71">  *    6         I         I,P     P,I   N</span>
<a href="#l56.72"></a><span id="l56.72">  *    7         I         I       I     P</span>
<a href="#l56.73"></a><span id="l56.73">  *    8         I         P       P     N</span>
<a href="#l56.74"></a><span id="l56.74">  *</span>
<a href="#l56.75"></a><span id="l56.75">  */</span>
<a href="#l56.76"></a><span id="l56.76"> </span>
<a href="#l56.77"></a><span id="l56.77" class="difflineminus">-var Tests =</span>
<a href="#l56.78"></a><span id="l56.78" class="difflineminus">-[</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineplus">+var Tests = [</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineplus">+  {</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.83"></a><span id="l56.83">     attrib: Sender,</span>
<a href="#l56.84"></a><span id="l56.84">     op: IsInAB,</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineminus">-    count: 3 },</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineplus">+    count: 3,</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineplus">+  }, {</span>
<a href="#l56.89"></a><span id="l56.89" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.90"></a><span id="l56.90">     attrib: To,</span>
<a href="#l56.91"></a><span id="l56.91">     op: IsInAB,</span>
<a href="#l56.92"></a><span id="l56.92" class="difflineminus">-    count: 4 },</span>
<a href="#l56.93"></a><span id="l56.93" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.94"></a><span id="l56.94" class="difflineplus">+    count: 4,</span>
<a href="#l56.95"></a><span id="l56.95" class="difflineplus">+  }, {</span>
<a href="#l56.96"></a><span id="l56.96" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.97"></a><span id="l56.97">     attrib: ToOrCC,</span>
<a href="#l56.98"></a><span id="l56.98">     op: IsInAB,</span>
<a href="#l56.99"></a><span id="l56.99" class="difflineminus">-    count: 6 },</span>
<a href="#l56.100"></a><span id="l56.100" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.101"></a><span id="l56.101" class="difflineplus">+    count: 6,</span>
<a href="#l56.102"></a><span id="l56.102" class="difflineplus">+  }, {</span>
<a href="#l56.103"></a><span id="l56.103" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.104"></a><span id="l56.104">     attrib: AllAddresses,</span>
<a href="#l56.105"></a><span id="l56.105">     op: IsInAB,</span>
<a href="#l56.106"></a><span id="l56.106" class="difflineminus">-    count: 8 },</span>
<a href="#l56.107"></a><span id="l56.107" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.108"></a><span id="l56.108" class="difflineplus">+    count: 8,</span>
<a href="#l56.109"></a><span id="l56.109" class="difflineplus">+  }, {</span>
<a href="#l56.110"></a><span id="l56.110" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.111"></a><span id="l56.111">     attrib: CCopy,</span>
<a href="#l56.112"></a><span id="l56.112">     op: IsInAB,</span>
<a href="#l56.113"></a><span id="l56.113" class="difflineminus">-    count: 5 },</span>
<a href="#l56.114"></a><span id="l56.114" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.115"></a><span id="l56.115" class="difflineplus">+    count: 5,</span>
<a href="#l56.116"></a><span id="l56.116" class="difflineplus">+  }, {</span>
<a href="#l56.117"></a><span id="l56.117" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.118"></a><span id="l56.118">     attrib: Sender,</span>
<a href="#l56.119"></a><span id="l56.119">     op: IsntInAB,</span>
<a href="#l56.120"></a><span id="l56.120" class="difflineminus">-    count: 5 },</span>
<a href="#l56.121"></a><span id="l56.121" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.122"></a><span id="l56.122" class="difflineplus">+    count: 5,</span>
<a href="#l56.123"></a><span id="l56.123" class="difflineplus">+  }, {</span>
<a href="#l56.124"></a><span id="l56.124" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.125"></a><span id="l56.125">     attrib: To,</span>
<a href="#l56.126"></a><span id="l56.126">     op: IsntInAB,</span>
<a href="#l56.127"></a><span id="l56.127" class="difflineminus">-    count: 5 },</span>
<a href="#l56.128"></a><span id="l56.128" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineplus">+    count: 5,</span>
<a href="#l56.130"></a><span id="l56.130" class="difflineplus">+  }, {</span>
<a href="#l56.131"></a><span id="l56.131" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.132"></a><span id="l56.132">     attrib: ToOrCC,</span>
<a href="#l56.133"></a><span id="l56.133">     op: IsntInAB,</span>
<a href="#l56.134"></a><span id="l56.134" class="difflineminus">-    count: 6 },</span>
<a href="#l56.135"></a><span id="l56.135" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.136"></a><span id="l56.136" class="difflineplus">+    count: 6,</span>
<a href="#l56.137"></a><span id="l56.137" class="difflineplus">+  }, {</span>
<a href="#l56.138"></a><span id="l56.138" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.139"></a><span id="l56.139">     attrib: AllAddresses,</span>
<a href="#l56.140"></a><span id="l56.140">     op: IsntInAB,</span>
<a href="#l56.141"></a><span id="l56.141" class="difflineminus">-    count: 7 },</span>
<a href="#l56.142"></a><span id="l56.142" class="difflineminus">-  { value: ABUri,</span>
<a href="#l56.143"></a><span id="l56.143" class="difflineplus">+    count: 7,</span>
<a href="#l56.144"></a><span id="l56.144" class="difflineplus">+  }, {</span>
<a href="#l56.145"></a><span id="l56.145" class="difflineplus">+    value: ABUri,</span>
<a href="#l56.146"></a><span id="l56.146">     attrib: CCopy,</span>
<a href="#l56.147"></a><span id="l56.147">     op: IsntInAB,</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineminus">-    count: 4 },</span>
<a href="#l56.149"></a><span id="l56.149" class="difflineminus">-  { value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.150"></a><span id="l56.150" class="difflineplus">+    count: 4,</span>
<a href="#l56.151"></a><span id="l56.151" class="difflineplus">+  }, {</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineplus">+    value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.153"></a><span id="l56.153">     attrib: AllAddresses,</span>
<a href="#l56.154"></a><span id="l56.154">     op: Is,</span>
<a href="#l56.155"></a><span id="l56.155" class="difflineminus">-    count: 8 },</span>
<a href="#l56.156"></a><span id="l56.156" class="difflineminus">-  { value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.157"></a><span id="l56.157" class="difflineplus">+    count: 8,</span>
<a href="#l56.158"></a><span id="l56.158" class="difflineplus">+  }, {</span>
<a href="#l56.159"></a><span id="l56.159" class="difflineplus">+    value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.160"></a><span id="l56.160">     attrib: AllAddresses,</span>
<a href="#l56.161"></a><span id="l56.161">     op: Isnt,</span>
<a href="#l56.162"></a><span id="l56.162" class="difflineminus">-    count: 0 },</span>
<a href="#l56.163"></a><span id="l56.163" class="difflineminus">-  { value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.164"></a><span id="l56.164" class="difflineplus">+    count: 0,</span>
<a href="#l56.165"></a><span id="l56.165" class="difflineplus">+  }, {</span>
<a href="#l56.166"></a><span id="l56.166" class="difflineplus">+    value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.167"></a><span id="l56.167">     attrib: AllAddresses,</span>
<a href="#l56.168"></a><span id="l56.168">     op: Is,</span>
<a href="#l56.169"></a><span id="l56.169" class="difflineminus">-    count: 7 },</span>
<a href="#l56.170"></a><span id="l56.170" class="difflineminus">-  { value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.171"></a><span id="l56.171" class="difflineplus">+    count: 7,</span>
<a href="#l56.172"></a><span id="l56.172" class="difflineplus">+  }, {</span>
<a href="#l56.173"></a><span id="l56.173" class="difflineplus">+    value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.174"></a><span id="l56.174">     attrib: AllAddresses,</span>
<a href="#l56.175"></a><span id="l56.175">     op: Isnt,</span>
<a href="#l56.176"></a><span id="l56.176" class="difflineminus">-    count: 1 },</span>
<a href="#l56.177"></a><span id="l56.177" class="difflineminus">-  { value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.178"></a><span id="l56.178" class="difflineplus">+    count: 1,</span>
<a href="#l56.179"></a><span id="l56.179" class="difflineplus">+  }, {</span>
<a href="#l56.180"></a><span id="l56.180" class="difflineplus">+    value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.181"></a><span id="l56.181">     attrib: ToOrCC,</span>
<a href="#l56.182"></a><span id="l56.182">     op: Is,</span>
<a href="#l56.183"></a><span id="l56.183" class="difflineminus">-    count: 6 },</span>
<a href="#l56.184"></a><span id="l56.184" class="difflineminus">-  { value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.185"></a><span id="l56.185" class="difflineplus">+    count: 6,</span>
<a href="#l56.186"></a><span id="l56.186" class="difflineplus">+  }, {</span>
<a href="#l56.187"></a><span id="l56.187" class="difflineplus">+    value: &quot;PrimaryEmail1@test.invalid&quot;,</span>
<a href="#l56.188"></a><span id="l56.188">     attrib: ToOrCC,</span>
<a href="#l56.189"></a><span id="l56.189">     op: Isnt,</span>
<a href="#l56.190"></a><span id="l56.190" class="difflineminus">-    count: 2 },</span>
<a href="#l56.191"></a><span id="l56.191" class="difflineminus">-  { value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.192"></a><span id="l56.192" class="difflineplus">+    count: 2,</span>
<a href="#l56.193"></a><span id="l56.193" class="difflineplus">+  }, {</span>
<a href="#l56.194"></a><span id="l56.194" class="difflineplus">+    value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.195"></a><span id="l56.195">     attrib: ToOrCC,</span>
<a href="#l56.196"></a><span id="l56.196">     op: Is,</span>
<a href="#l56.197"></a><span id="l56.197" class="difflineminus">-    count: 6 },</span>
<a href="#l56.198"></a><span id="l56.198" class="difflineminus">-  { value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.199"></a><span id="l56.199" class="difflineplus">+    count: 6,</span>
<a href="#l56.200"></a><span id="l56.200" class="difflineplus">+  }, {</span>
<a href="#l56.201"></a><span id="l56.201" class="difflineplus">+    value: &quot;invalid@example.com&quot;,</span>
<a href="#l56.202"></a><span id="l56.202">     attrib: ToOrCC,</span>
<a href="#l56.203"></a><span id="l56.203">     op: Isnt,</span>
<a href="#l56.204"></a><span id="l56.204" class="difflineminus">-    count: 2 },</span>
<a href="#l56.205"></a><span id="l56.205" class="difflineminus">-</span>
<a href="#l56.206"></a><span id="l56.206" class="difflineplus">+    count: 2,</span>
<a href="#l56.207"></a><span id="l56.207" class="difflineplus">+  },</span>
<a href="#l56.208"></a><span id="l56.208"> ];</span>
<a href="#l56.209"></a><span id="l56.209"> </span>
<a href="#l56.210"></a><span id="l56.210" class="difflineminus">-var Files =</span>
<a href="#l56.211"></a><span id="l56.211" class="difflineminus">-[</span>
<a href="#l56.212"></a><span id="l56.212" class="difflineplus">+var Files = [</span>
<a href="#l56.213"></a><span id="l56.213">   &quot;../../../data/bugmail1&quot;,</span>
<a href="#l56.214"></a><span id="l56.214">   &quot;../../../data/bugmail2&quot;,</span>
<a href="#l56.215"></a><span id="l56.215">   &quot;../../../data/bugmail3&quot;,</span>
<a href="#l56.216"></a><span id="l56.216">   &quot;../../../data/bugmail4&quot;,</span>
<a href="#l56.217"></a><span id="l56.217">   &quot;../../../data/bugmail5&quot;,</span>
<a href="#l56.218"></a><span id="l56.218">   &quot;../../../data/bugmail6&quot;,</span>
<a href="#l56.219"></a><span id="l56.219">   &quot;../../../data/bugmail7&quot;,</span>
<a href="#l56.220"></a><span id="l56.220" class="difflineminus">-  &quot;../../../data/bugmail8&quot;</span>
<a href="#l56.221"></a><span id="l56.221" class="difflineminus">-]</span>
<a href="#l56.222"></a><span id="l56.222" class="difflineplus">+  &quot;../../../data/bugmail8&quot;,</span>
<a href="#l56.223"></a><span id="l56.223" class="difflineplus">+];</span>
<a href="#l56.224"></a><span id="l56.224"> </span>
<a href="#l56.225"></a><span id="l56.225" class="difflineminus">-var messageKey, hdr;</span>
<a href="#l56.226"></a><span id="l56.226" class="difflineminus">-</span>
<a href="#l56.227"></a><span id="l56.227" class="difflineminus">-function run_test()</span>
<a href="#l56.228"></a><span id="l56.228" class="difflineminus">-{</span>
<a href="#l56.229"></a><span id="l56.229" class="difflineplus">+function run_test() {</span>
<a href="#l56.230"></a><span id="l56.230">   // Setup local mail accounts.</span>
<a href="#l56.231"></a><span id="l56.231">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l56.232"></a><span id="l56.232"> </span>
<a href="#l56.233"></a><span id="l56.233">     // Test setup - copy the data file into place</span>
<a href="#l56.234"></a><span id="l56.234">   var testAB = do_get_file(&quot;../../../addrbook/test/unit/data/cardForEmail.mab&quot;);</span>
<a href="#l56.235"></a><span id="l56.235"> </span>
<a href="#l56.236"></a><span id="l56.236">   // Copy the file to the profile directory for a PAB</span>
<a href="#l56.237"></a><span id="l56.237">   testAB.copyTo(do_get_profile(), kPABData.fileName);</span>
<a href="#l56.238"></a><span id="l56.238" class="difflineat">@@ -257,48 +268,42 @@ function run_test()</span>
<a href="#l56.239"></a><span id="l56.239">   testValidityTable(news, IsBefore, Keywords, false);</span>
<a href="#l56.240"></a><span id="l56.240"> </span>
<a href="#l56.241"></a><span id="l56.241">   // Get a message into the local filestore. function testAbSearch() continues the testing after the copy.</span>
<a href="#l56.242"></a><span id="l56.242">   do_test_pending();</span>
<a href="#l56.243"></a><span id="l56.243">   copyListener.OnStopCopy(null);</span>
<a href="#l56.244"></a><span id="l56.244">   return true;</span>
<a href="#l56.245"></a><span id="l56.245"> }</span>
<a href="#l56.246"></a><span id="l56.246"> </span>
<a href="#l56.247"></a><span id="l56.247" class="difflineminus">-var copyListener =</span>
<a href="#l56.248"></a><span id="l56.248" class="difflineminus">-{</span>
<a href="#l56.249"></a><span id="l56.249" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l56.250"></a><span id="l56.250" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l56.251"></a><span id="l56.251" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l56.252"></a><span id="l56.252" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l56.253"></a><span id="l56.253" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l56.254"></a><span id="l56.254" class="difflineminus">-  {</span>
<a href="#l56.255"></a><span id="l56.255" class="difflineplus">+var copyListener = {</span>
<a href="#l56.256"></a><span id="l56.256" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l56.257"></a><span id="l56.257" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l56.258"></a><span id="l56.258" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l56.259"></a><span id="l56.259" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l56.260"></a><span id="l56.260" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l56.261"></a><span id="l56.261">     var fileName = Files.shift();</span>
<a href="#l56.262"></a><span id="l56.262" class="difflineminus">-    if (fileName)</span>
<a href="#l56.263"></a><span id="l56.263" class="difflineminus">-    {</span>
<a href="#l56.264"></a><span id="l56.264" class="difflineplus">+    if (fileName) {</span>
<a href="#l56.265"></a><span id="l56.265">       var file = do_get_file(fileName);</span>
<a href="#l56.266"></a><span id="l56.266">       MailServices.copy.CopyFileMessage(file, localAccountUtils.inboxFolder, null,</span>
<a href="#l56.267"></a><span id="l56.267">                                         false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l56.268"></a><span id="l56.268" class="difflineplus">+    } else {</span>
<a href="#l56.269"></a><span id="l56.269" class="difflineplus">+      testAbSearch();</span>
<a href="#l56.270"></a><span id="l56.270">     }</span>
<a href="#l56.271"></a><span id="l56.271" class="difflineminus">-    else</span>
<a href="#l56.272"></a><span id="l56.272" class="difflineminus">-      testAbSearch();</span>
<a href="#l56.273"></a><span id="l56.273" class="difflineminus">-  }</span>
<a href="#l56.274"></a><span id="l56.274" class="difflineplus">+  },</span>
<a href="#l56.275"></a><span id="l56.275"> };</span>
<a href="#l56.276"></a><span id="l56.276"> </span>
<a href="#l56.277"></a><span id="l56.277"> // Runs at completion of copy</span>
<a href="#l56.278"></a><span id="l56.278"> </span>
<a href="#l56.279"></a><span id="l56.279"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l56.280"></a><span id="l56.280" class="difflineminus">-var testObject;</span>
<a href="#l56.281"></a><span id="l56.281" class="difflineminus">-function testAbSearch()</span>
<a href="#l56.282"></a><span id="l56.282" class="difflineminus">-{</span>
<a href="#l56.283"></a><span id="l56.283" class="difflineplus">+function testAbSearch() {</span>
<a href="#l56.284"></a><span id="l56.284">   print(&quot;Test AbSearch&quot;);</span>
<a href="#l56.285"></a><span id="l56.285">   var test = Tests.shift();</span>
<a href="#l56.286"></a><span id="l56.286" class="difflineminus">-  if (test)</span>
<a href="#l56.287"></a><span id="l56.287" class="difflineminus">-  {</span>
<a href="#l56.288"></a><span id="l56.288" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l56.289"></a><span id="l56.289" class="difflineminus">-                         test.value,</span>
<a href="#l56.290"></a><span id="l56.290" class="difflineminus">-                         test.attrib,</span>
<a href="#l56.291"></a><span id="l56.291" class="difflineminus">-                         test.op,</span>
<a href="#l56.292"></a><span id="l56.292" class="difflineminus">-                         test.count,</span>
<a href="#l56.293"></a><span id="l56.293" class="difflineminus">-                         testAbSearch);</span>
<a href="#l56.294"></a><span id="l56.294" class="difflineplus">+  if (test) {</span>
<a href="#l56.295"></a><span id="l56.295" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l56.296"></a><span id="l56.296" class="difflineplus">+                   test.value,</span>
<a href="#l56.297"></a><span id="l56.297" class="difflineplus">+                   test.attrib,</span>
<a href="#l56.298"></a><span id="l56.298" class="difflineplus">+                   test.op,</span>
<a href="#l56.299"></a><span id="l56.299" class="difflineplus">+                   test.count,</span>
<a href="#l56.300"></a><span id="l56.300" class="difflineplus">+                   testAbSearch);</span>
<a href="#l56.301"></a><span id="l56.301" class="difflineplus">+  } else {</span>
<a href="#l56.302"></a><span id="l56.302" class="difflineplus">+    do_test_finished();</span>
<a href="#l56.303"></a><span id="l56.303">   }</span>
<a href="#l56.304"></a><span id="l56.304" class="difflineminus">-  else</span>
<a href="#l56.305"></a><span id="l56.305" class="difflineminus">-    do_test_finished();</span>
<a href="#l56.306"></a><span id="l56.306"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchBody.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchBody.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -1,41 +1,36 @@</span>
<a href="#l57.4"></a><span id="l57.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l57.5"></a><span id="l57.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l57.6"></a><span id="l57.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l57.7"></a><span id="l57.7"> </span>
<a href="#l57.8"></a><span id="l57.8"> /*</span>
<a href="#l57.9"></a><span id="l57.9">  * This tests various body search criteria.</span>
<a href="#l57.10"></a><span id="l57.10">  */</span>
<a href="#l57.11"></a><span id="l57.11" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l57.12"></a><span id="l57.12"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l57.13"></a><span id="l57.13"> </span>
<a href="#l57.14"></a><span id="l57.14"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l57.15"></a><span id="l57.15"> </span>
<a href="#l57.16"></a><span id="l57.16" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l57.17"></a><span id="l57.17" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+var IsEmpty = Ci.nsMsgSearchOp.IsEmpty;</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+var IsntEmpty = Ci.nsMsgSearchOp.IsntEmpty;</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l57.24"></a><span id="l57.24" class="difflineplus">+var DoesntContain = Ci.nsMsgSearchOp.DoesntContain;</span>
<a href="#l57.25"></a><span id="l57.25" class="difflineplus">+var IsBefore = Ci.nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l57.26"></a><span id="l57.26"> </span>
<a href="#l57.27"></a><span id="l57.27" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l57.28"></a><span id="l57.28" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l57.29"></a><span id="l57.29" class="difflineminus">-var IsEmpty = nsMsgSearchOp.IsEmpty;</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineminus">-var IsntEmpty = nsMsgSearchOp.IsntEmpty;</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineminus">-var DoesntContain = nsMsgSearchOp.DoesntContain;</span>
<a href="#l57.33"></a><span id="l57.33" class="difflineminus">-var IsBefore = nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineplus">+var offlineMail = Ci.nsMsgSearchScope.offlineMail;</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineplus">+var onlineMail = Ci.nsMsgSearchScope.onlineMail;</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineplus">+var offlineMailFilter = Ci.nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineplus">+var news = Ci.nsMsgSearchScope.news; // control entry not enabled</span>
<a href="#l57.38"></a><span id="l57.38"> </span>
<a href="#l57.39"></a><span id="l57.39" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineminus">-var onlineMail = nsMsgSearchScope.onlineMail;</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineminus">-var offlineMailFilter = nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l57.42"></a><span id="l57.42" class="difflineminus">-var onlineMailFilter = nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l57.43"></a><span id="l57.43" class="difflineminus">-var news = nsMsgSearchScope.news; // control entry not enabled</span>
<a href="#l57.44"></a><span id="l57.44" class="difflineplus">+var Body = Ci.nsMsgSearchAttrib.Body;</span>
<a href="#l57.45"></a><span id="l57.45"> </span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-var Body = nsMsgSearchAttrib.Body;</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineminus">-var Files =</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineminus">-[</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineplus">+var Files = [</span>
<a href="#l57.51"></a><span id="l57.51">   &quot;../../../data/base64-1&quot;,</span>
<a href="#l57.52"></a><span id="l57.52">   &quot;../../../data/basic1&quot;,</span>
<a href="#l57.53"></a><span id="l57.53">   &quot;../../../data/multipart-base64-2&quot;,</span>
<a href="#l57.54"></a><span id="l57.54">   &quot;../../../data/bug132340&quot;,</span>
<a href="#l57.55"></a><span id="l57.55">   &quot;../../../data/bad-charset.eml&quot;,</span>
<a href="#l57.56"></a><span id="l57.56">   &quot;../../../data/HTML-with-split-tag1.eml&quot;,</span>
<a href="#l57.57"></a><span id="l57.57">   &quot;../../../data/HTML-with-split-tag2.eml&quot;,</span>
<a href="#l57.58"></a><span id="l57.58"> </span>
<a href="#l57.59"></a><span id="l57.59" class="difflineat">@@ -82,19 +77,18 @@ var Files =</span>
<a href="#l57.60"></a><span id="l57.60">   &quot;../../../data/multipart-message-4.eml&quot;,  // plaintext+HTML, non-ASCII in HTML, has &quot;bodyOfAttachedMessgeHTML&quot;</span>
<a href="#l57.61"></a><span id="l57.61"> </span>
<a href="#l57.62"></a><span id="l57.62">   // Message using ISO-2022-JP and CTE: quoted-printable.</span>
<a href="#l57.63"></a><span id="l57.63">   &quot;../../../data/iso-2022-jp-qp.eml&quot;,  // plaintext, has  (Japan), we shouldn't find =1B$BF|K.</span>
<a href="#l57.64"></a><span id="l57.64"> </span>
<a href="#l57.65"></a><span id="l57.65">   // Message using ISO-2022-JP and 7bit, but containing something that looks like quoted-printable.</span>
<a href="#l57.66"></a><span id="l57.66">   // (bug 314637).</span>
<a href="#l57.67"></a><span id="l57.67">   &quot;../../../data/iso-2022-jp-not-qp.eml&quot;,  // plaintext, has  which contains =67.</span>
<a href="#l57.68"></a><span id="l57.68" class="difflineminus">-]</span>
<a href="#l57.69"></a><span id="l57.69" class="difflineminus">-var Tests =</span>
<a href="#l57.70"></a><span id="l57.70" class="difflineminus">-[</span>
<a href="#l57.71"></a><span id="l57.71" class="difflineplus">+];</span>
<a href="#l57.72"></a><span id="l57.72" class="difflineplus">+var Tests = [</span>
<a href="#l57.73"></a><span id="l57.73">   /* Translate Base64 messages */</span>
<a href="#l57.74"></a><span id="l57.74">   // &quot;World!&quot; is contained in three messages, but in bug132340 it's not in a text</span>
<a href="#l57.75"></a><span id="l57.75">   // part and should not be found.</span>
<a href="#l57.76"></a><span id="l57.76">   { value: &quot;World!&quot;, op: Contains, count: 2 },</span>
<a href="#l57.77"></a><span id="l57.77">   /* Don't match the base64 text */</span>
<a href="#l57.78"></a><span id="l57.78">   { value: &quot;DQp&quot;, op: Contains, count: 0 },</span>
<a href="#l57.79"></a><span id="l57.79">   /* Nested multipart/mixed, don't match */</span>
<a href="#l57.80"></a><span id="l57.80">   { value: &quot;PGh&quot;, op: Contains, count: 0 },</span>
<a href="#l57.81"></a><span id="l57.81" class="difflineat">@@ -191,38 +185,34 @@ function fixFile(file) {</span>
<a href="#l57.82"></a><span id="l57.82">   let ostream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l57.83"></a><span id="l57.83">                   .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l57.84"></a><span id="l57.84">   ostream.init(targetFile, -1, -1, 0);</span>
<a href="#l57.85"></a><span id="l57.85">   ostream.write(data, data.length);</span>
<a href="#l57.86"></a><span id="l57.86">   ostream.close();</span>
<a href="#l57.87"></a><span id="l57.87">   return targetFile;</span>
<a href="#l57.88"></a><span id="l57.88"> }</span>
<a href="#l57.89"></a><span id="l57.89"> </span>
<a href="#l57.90"></a><span id="l57.90" class="difflineminus">-var copyListener =</span>
<a href="#l57.91"></a><span id="l57.91" class="difflineminus">-{</span>
<a href="#l57.92"></a><span id="l57.92" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l57.93"></a><span id="l57.93" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l57.94"></a><span id="l57.94" class="difflineminus">-  SetMessageKey: function(aKey) {},</span>
<a href="#l57.95"></a><span id="l57.95" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l57.96"></a><span id="l57.96" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l57.97"></a><span id="l57.97" class="difflineminus">-  {</span>
<a href="#l57.98"></a><span id="l57.98" class="difflineplus">+var copyListener = {</span>
<a href="#l57.99"></a><span id="l57.99" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l57.100"></a><span id="l57.100" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l57.101"></a><span id="l57.101" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l57.102"></a><span id="l57.102" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l57.103"></a><span id="l57.103" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l57.104"></a><span id="l57.104">     var fileName = Files.shift();</span>
<a href="#l57.105"></a><span id="l57.105" class="difflineminus">-    if (fileName)</span>
<a href="#l57.106"></a><span id="l57.106" class="difflineminus">-    {</span>
<a href="#l57.107"></a><span id="l57.107" class="difflineplus">+    if (fileName) {</span>
<a href="#l57.108"></a><span id="l57.108">       var file = fixFile(do_get_file(fileName));</span>
<a href="#l57.109"></a><span id="l57.109">       MailServices.copy.CopyFileMessage(file, localAccountUtils.inboxFolder, null,</span>
<a href="#l57.110"></a><span id="l57.110">                                         false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l57.111"></a><span id="l57.111" class="difflineplus">+    } else {</span>
<a href="#l57.112"></a><span id="l57.112" class="difflineplus">+      testBodySearch();</span>
<a href="#l57.113"></a><span id="l57.113">     }</span>
<a href="#l57.114"></a><span id="l57.114" class="difflineminus">-    else</span>
<a href="#l57.115"></a><span id="l57.115" class="difflineminus">-      testBodySearch();</span>
<a href="#l57.116"></a><span id="l57.116" class="difflineminus">-  }</span>
<a href="#l57.117"></a><span id="l57.117" class="difflineplus">+  },</span>
<a href="#l57.118"></a><span id="l57.118"> };</span>
<a href="#l57.119"></a><span id="l57.119"> </span>
<a href="#l57.120"></a><span id="l57.120" class="difflineminus">-function run_test()</span>
<a href="#l57.121"></a><span id="l57.121" class="difflineminus">-{</span>
<a href="#l57.122"></a><span id="l57.122" class="difflineplus">+function run_test() {</span>
<a href="#l57.123"></a><span id="l57.123">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l57.124"></a><span id="l57.124"> </span>
<a href="#l57.125"></a><span id="l57.125">   // test that validity table terms are valid</span>
<a href="#l57.126"></a><span id="l57.126"> </span>
<a href="#l57.127"></a><span id="l57.127">   // offline mail table</span>
<a href="#l57.128"></a><span id="l57.128">   testValidityTable(offlineMail, Contains, Body, true);</span>
<a href="#l57.129"></a><span id="l57.129">   testValidityTable(offlineMail, DoesntContain, Body, true);</span>
<a href="#l57.130"></a><span id="l57.130">   testValidityTable(offlineMail, Is, Body, true);</span>
<a href="#l57.131"></a><span id="l57.131" class="difflineat">@@ -245,17 +235,17 @@ function run_test()</span>
<a href="#l57.132"></a><span id="l57.132">   testValidityTable(onlineMail, DoesntContain, Body, true);</span>
<a href="#l57.133"></a><span id="l57.133">   testValidityTable(onlineMail, Is, Body, false);</span>
<a href="#l57.134"></a><span id="l57.134">   testValidityTable(onlineMail, Isnt, Body, false);</span>
<a href="#l57.135"></a><span id="l57.135">   testValidityTable(onlineMail, IsEmpty, Body, false);</span>
<a href="#l57.136"></a><span id="l57.136">   testValidityTable(onlineMail, IsntEmpty, Body, false);</span>
<a href="#l57.137"></a><span id="l57.137">   testValidityTable(onlineMail, IsBefore, Body, false);</span>
<a href="#l57.138"></a><span id="l57.138"> </span>
<a href="#l57.139"></a><span id="l57.139">   // online mail filter</span>
<a href="#l57.140"></a><span id="l57.140" class="difflineminus">-  /*testValidityTable(onlineMailFilter, Contains, Body, true);</span>
<a href="#l57.141"></a><span id="l57.141" class="difflineplus">+  /* testValidityTable(onlineMailFilter, Contains, Body, true);</span>
<a href="#l57.142"></a><span id="l57.142">   testValidityTable(onlineMailFilter, DoesntContain, Body, true);</span>
<a href="#l57.143"></a><span id="l57.143">   testValidityTable(onlineMailFilter, Is, Body, false);</span>
<a href="#l57.144"></a><span id="l57.144">   testValidityTable(onlineMailFilter, Isnt, Body, false);</span>
<a href="#l57.145"></a><span id="l57.145">   testValidityTable(onlineMailFilter, IsEmpty, Body, false);</span>
<a href="#l57.146"></a><span id="l57.146">   testValidityTable(onlineMailFilter, IsntEmpty, Body, false);</span>
<a href="#l57.147"></a><span id="l57.147">   testValidityTable(onlineMailFilter, IsBefore, Body, false);*/</span>
<a href="#l57.148"></a><span id="l57.148"> </span>
<a href="#l57.149"></a><span id="l57.149">   // News does not support body tests</span>
<a href="#l57.150"></a><span id="l57.150" class="difflineat">@@ -267,28 +257,22 @@ function run_test()</span>
<a href="#l57.151"></a><span id="l57.151">   testValidityTable(news, IsntEmpty, Body, false);</span>
<a href="#l57.152"></a><span id="l57.152">   testValidityTable(news, IsBefore, Body, false);</span>
<a href="#l57.153"></a><span id="l57.153"> </span>
<a href="#l57.154"></a><span id="l57.154">   do_test_pending();</span>
<a href="#l57.155"></a><span id="l57.155">   copyListener.OnStopCopy(null);</span>
<a href="#l57.156"></a><span id="l57.156"> }</span>
<a href="#l57.157"></a><span id="l57.157"> </span>
<a href="#l57.158"></a><span id="l57.158"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l57.159"></a><span id="l57.159" class="difflineminus">-var testObject;</span>
<a href="#l57.160"></a><span id="l57.160" class="difflineminus">-function testBodySearch()</span>
<a href="#l57.161"></a><span id="l57.161" class="difflineminus">-{</span>
<a href="#l57.162"></a><span id="l57.162" class="difflineplus">+function testBodySearch() {</span>
<a href="#l57.163"></a><span id="l57.163">   var test = Tests.shift();</span>
<a href="#l57.164"></a><span id="l57.164" class="difflineminus">-  if (test)</span>
<a href="#l57.165"></a><span id="l57.165" class="difflineminus">-  {</span>
<a href="#l57.166"></a><span id="l57.166" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l57.167"></a><span id="l57.167" class="difflineminus">-                         test.value,</span>
<a href="#l57.168"></a><span id="l57.168" class="difflineminus">-                         Body,</span>
<a href="#l57.169"></a><span id="l57.169" class="difflineminus">-                         test.op,</span>
<a href="#l57.170"></a><span id="l57.170" class="difflineminus">-                         test.count,</span>
<a href="#l57.171"></a><span id="l57.171" class="difflineminus">-                         testBodySearch);</span>
<a href="#l57.172"></a><span id="l57.172" class="difflineminus">-  }</span>
<a href="#l57.173"></a><span id="l57.173" class="difflineminus">-  else</span>
<a href="#l57.174"></a><span id="l57.174" class="difflineminus">-  {</span>
<a href="#l57.175"></a><span id="l57.175" class="difflineminus">-    testObject = null;</span>
<a href="#l57.176"></a><span id="l57.176" class="difflineplus">+  if (test) {</span>
<a href="#l57.177"></a><span id="l57.177" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l57.178"></a><span id="l57.178" class="difflineplus">+                   test.value,</span>
<a href="#l57.179"></a><span id="l57.179" class="difflineplus">+                   Body,</span>
<a href="#l57.180"></a><span id="l57.180" class="difflineplus">+                   test.op,</span>
<a href="#l57.181"></a><span id="l57.181" class="difflineplus">+                   test.count,</span>
<a href="#l57.182"></a><span id="l57.182" class="difflineplus">+                   testBodySearch);</span>
<a href="#l57.183"></a><span id="l57.183" class="difflineplus">+  } else {</span>
<a href="#l57.184"></a><span id="l57.184">     do_test_finished();</span>
<a href="#l57.185"></a><span id="l57.185">   }</span>
<a href="#l57.186"></a><span id="l57.186"> }</span>
<a href="#l57.187"></a><span id="l57.187"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchBoolean.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchBoolean.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -8,113 +8,126 @@</span>
<a href="#l58.4"></a><span id="l58.4"> </span>
<a href="#l58.5"></a><span id="l58.5"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l58.6"></a><span id="l58.6"> </span>
<a href="#l58.7"></a><span id="l58.7"> var gSearchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l58.8"></a><span id="l58.8">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l58.9"></a><span id="l58.9"> </span>
<a href="#l58.10"></a><span id="l58.10"> var gHdr; // the message header for the one mailbox message</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-var Tests =</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-[</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineminus">-  { A: false,</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+var Tests = [</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineplus">+  {</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineplus">+    A: false,</span>
<a href="#l58.18"></a><span id="l58.18">     B: false,</span>
<a href="#l58.19"></a><span id="l58.19">     C: false,</span>
<a href="#l58.20"></a><span id="l58.20">     D: false,</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-    matches: false},</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineminus">-  { A: false,</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineplus">+    matches: false,</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineplus">+  }, {</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineplus">+    A: false,</span>
<a href="#l58.26"></a><span id="l58.26">     B: false,</span>
<a href="#l58.27"></a><span id="l58.27">     C: false,</span>
<a href="#l58.28"></a><span id="l58.28">     D: true,</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineminus">-    matches: false},</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineminus">-  { A: false,</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineplus">+    matches: false,</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+  }, {</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+    A: false,</span>
<a href="#l58.34"></a><span id="l58.34">     B: false,</span>
<a href="#l58.35"></a><span id="l58.35">     C: true,</span>
<a href="#l58.36"></a><span id="l58.36">     D: false,</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineminus">-    matches: false},</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-  { A: false,</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineplus">+    matches: false,</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+  }, {</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineplus">+    A: false,</span>
<a href="#l58.42"></a><span id="l58.42">     B: false,</span>
<a href="#l58.43"></a><span id="l58.43">     C: true,</span>
<a href="#l58.44"></a><span id="l58.44">     D: true,</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineminus">-    matches: false},</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineminus">-  { A: false,</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineplus">+    matches: false,</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineplus">+  }, {</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineplus">+    A: false,</span>
<a href="#l58.50"></a><span id="l58.50">     B: true,</span>
<a href="#l58.51"></a><span id="l58.51">     C: false,</span>
<a href="#l58.52"></a><span id="l58.52">     D: false,</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineminus">-    matches: false},</span>
<a href="#l58.54"></a><span id="l58.54" class="difflineminus">-  { A: false,</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineplus">+    matches: false,</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineplus">+  }, {</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineplus">+    A: false,</span>
<a href="#l58.58"></a><span id="l58.58">     B: true,</span>
<a href="#l58.59"></a><span id="l58.59">     C: false,</span>
<a href="#l58.60"></a><span id="l58.60">     D: true,</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineminus">-    matches: true},</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-  { A: false,</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineplus">+    matches: true,</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineplus">+  }, {</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineplus">+    A: false,</span>
<a href="#l58.66"></a><span id="l58.66">     B: true,</span>
<a href="#l58.67"></a><span id="l58.67">     C: true,</span>
<a href="#l58.68"></a><span id="l58.68">     D: false,</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineminus">-    matches: true},</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-  { A: false,</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+    matches: true,</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+  }, {</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineplus">+    A: false,</span>
<a href="#l58.74"></a><span id="l58.74">     B: true,</span>
<a href="#l58.75"></a><span id="l58.75">     C: true,</span>
<a href="#l58.76"></a><span id="l58.76">     D: true,</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineminus">-    matches: true},</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-  { A: true,</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineplus">+    matches: true,</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineplus">+  }, {</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+    A: true,</span>
<a href="#l58.82"></a><span id="l58.82">     B: false,</span>
<a href="#l58.83"></a><span id="l58.83">     C: false,</span>
<a href="#l58.84"></a><span id="l58.84">     D: false,</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineminus">-    matches: false},</span>
<a href="#l58.86"></a><span id="l58.86" class="difflineminus">-  { A: true,</span>
<a href="#l58.87"></a><span id="l58.87" class="difflineplus">+    matches: false,</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineplus">+  }, {</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineplus">+    A: true,</span>
<a href="#l58.90"></a><span id="l58.90">     B: false,</span>
<a href="#l58.91"></a><span id="l58.91">     C: false,</span>
<a href="#l58.92"></a><span id="l58.92">     D: true,</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineminus">-    matches: true},</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">-  { A: true,</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineplus">+    matches: true,</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineplus">+  }, {</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineplus">+    A: true,</span>
<a href="#l58.98"></a><span id="l58.98">     B: false,</span>
<a href="#l58.99"></a><span id="l58.99">     C: true,</span>
<a href="#l58.100"></a><span id="l58.100">     D: false,</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">-    matches: true},</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineminus">-  { A: true,</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+    matches: true,</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineplus">+  }, {</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineplus">+    A: true,</span>
<a href="#l58.106"></a><span id="l58.106">     B: false,</span>
<a href="#l58.107"></a><span id="l58.107">     C: true,</span>
<a href="#l58.108"></a><span id="l58.108">     D: true,</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineminus">-    matches: true},</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineminus">-  { A: true,</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+    matches: true,</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+  }, {</span>
<a href="#l58.113"></a><span id="l58.113" class="difflineplus">+    A: true,</span>
<a href="#l58.114"></a><span id="l58.114">     B: true,</span>
<a href="#l58.115"></a><span id="l58.115">     C: false,</span>
<a href="#l58.116"></a><span id="l58.116">     D: false,</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineminus">-    matches: false},</span>
<a href="#l58.118"></a><span id="l58.118" class="difflineminus">-  { A: true,</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineplus">+    matches: false,</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineplus">+  }, {</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineplus">+    A: true,</span>
<a href="#l58.122"></a><span id="l58.122">     B: true,</span>
<a href="#l58.123"></a><span id="l58.123">     C: false,</span>
<a href="#l58.124"></a><span id="l58.124">     D: true,</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineminus">-    matches: true},</span>
<a href="#l58.126"></a><span id="l58.126" class="difflineminus">-  { A: true,</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineplus">+    matches: true,</span>
<a href="#l58.128"></a><span id="l58.128" class="difflineplus">+  }, {</span>
<a href="#l58.129"></a><span id="l58.129" class="difflineplus">+    A: true,</span>
<a href="#l58.130"></a><span id="l58.130">     B: true,</span>
<a href="#l58.131"></a><span id="l58.131">     C: true,</span>
<a href="#l58.132"></a><span id="l58.132">     D: false,</span>
<a href="#l58.133"></a><span id="l58.133" class="difflineminus">-    matches: true},</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineminus">-  { A: true,</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineplus">+    matches: true,</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineplus">+  }, {</span>
<a href="#l58.137"></a><span id="l58.137" class="difflineplus">+    A: true,</span>
<a href="#l58.138"></a><span id="l58.138">     B: true,</span>
<a href="#l58.139"></a><span id="l58.139">     C: true,</span>
<a href="#l58.140"></a><span id="l58.140">     D: true,</span>
<a href="#l58.141"></a><span id="l58.141" class="difflineminus">-    matches: true},</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineplus">+    matches: true,</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineplus">+  },</span>
<a href="#l58.144"></a><span id="l58.144"> ];</span>
<a href="#l58.145"></a><span id="l58.145"> </span>
<a href="#l58.146"></a><span id="l58.146"> var gHitCount = 0;</span>
<a href="#l58.147"></a><span id="l58.147" class="difflineminus">-var searchListener =</span>
<a href="#l58.148"></a><span id="l58.148" class="difflineminus">-{</span>
<a href="#l58.149"></a><span id="l58.149" class="difflineminus">-  onSearchHit: function(dbHdr, folder) { gHitCount++; },</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineminus">-  onSearchDone: function(status)</span>
<a href="#l58.151"></a><span id="l58.151" class="difflineminus">-  {</span>
<a href="#l58.152"></a><span id="l58.152" class="difflineplus">+var searchListener = {</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineplus">+  onSearchHit(dbHdr, folder) { gHitCount++; },</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineplus">+  onSearchDone(status) {</span>
<a href="#l58.155"></a><span id="l58.155">     testSearch();</span>
<a href="#l58.156"></a><span id="l58.156">   },</span>
<a href="#l58.157"></a><span id="l58.157" class="difflineminus">-  onNewSearch: function() {gHitCount = 0;}</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineplus">+  onNewSearch() { gHitCount = 0; },</span>
<a href="#l58.159"></a><span id="l58.159"> };</span>
<a href="#l58.160"></a><span id="l58.160"> </span>
<a href="#l58.161"></a><span id="l58.161" class="difflineminus">-function run_test()</span>
<a href="#l58.162"></a><span id="l58.162" class="difflineminus">-{</span>
<a href="#l58.163"></a><span id="l58.163" class="difflineplus">+function run_test() {</span>
<a href="#l58.164"></a><span id="l58.164">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l58.165"></a><span id="l58.165"> </span>
<a href="#l58.166"></a><span id="l58.166">   /*</span>
<a href="#l58.167"></a><span id="l58.167">    * I want to create and test a search term that uses this expression:</span>
<a href="#l58.168"></a><span id="l58.168">    *   (A || B ) &amp;&amp; (C || D)</span>
<a href="#l58.169"></a><span id="l58.169">    *</span>
<a href="#l58.170"></a><span id="l58.170">    * The logical expressions A, B, C, and D will be represented by header</span>
<a href="#l58.171"></a><span id="l58.171">    * string properties with values of T (true) or F (false).</span>
<a href="#l58.172"></a><span id="l58.172" class="difflineat">@@ -144,52 +157,48 @@ function run_test()</span>
<a href="#l58.173"></a><span id="l58.173">                               localAccountUtils.inboxFolder);</span>
<a href="#l58.174"></a><span id="l58.174">   gSearchSession.registerListener(searchListener);</span>
<a href="#l58.175"></a><span id="l58.175">   // I tried using capital &quot;A&quot; but something makes it lower case internally, so it failed</span>
<a href="#l58.176"></a><span id="l58.176">   addSearchTerm(&quot;a&quot;, true, false, true);  // &quot;(A&quot;</span>
<a href="#l58.177"></a><span id="l58.177">   addSearchTerm(&quot;b&quot;, false, true, false); // &quot; || B)&quot;</span>
<a href="#l58.178"></a><span id="l58.178">   addSearchTerm(&quot;c&quot;, true, false, true);  // &quot; &amp;&amp; (C&quot;</span>
<a href="#l58.179"></a><span id="l58.179">   addSearchTerm(&quot;d&quot;, false, true, false); // &quot; || D)&quot;</span>
<a href="#l58.180"></a><span id="l58.180"> </span>
<a href="#l58.181"></a><span id="l58.181" class="difflineminus">-  var copyListener =</span>
<a href="#l58.182"></a><span id="l58.182" class="difflineminus">-  {</span>
<a href="#l58.183"></a><span id="l58.183" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l58.184"></a><span id="l58.184" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l58.185"></a><span id="l58.185" class="difflineminus">-    SetMessageKey: function(aKey) {</span>
<a href="#l58.186"></a><span id="l58.186" class="difflineplus">+  var copyListener = {</span>
<a href="#l58.187"></a><span id="l58.187" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l58.188"></a><span id="l58.188" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l58.189"></a><span id="l58.189" class="difflineplus">+    SetMessageKey(aKey) {</span>
<a href="#l58.190"></a><span id="l58.190">       gHdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l58.191"></a><span id="l58.191">     },</span>
<a href="#l58.192"></a><span id="l58.192" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineminus">-    OnStopCopy: function(aStatus) { testSearch();}</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineplus">+    OnStopCopy(aStatus) { testSearch(); },</span>
<a href="#l58.196"></a><span id="l58.196">   };</span>
<a href="#l58.197"></a><span id="l58.197"> </span>
<a href="#l58.198"></a><span id="l58.198">   // Get a message into the local filestore. function testSearch() continues</span>
<a href="#l58.199"></a><span id="l58.199">   // the testing after the copy.</span>
<a href="#l58.200"></a><span id="l58.200">   var bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l58.201"></a><span id="l58.201">   do_test_pending();</span>
<a href="#l58.202"></a><span id="l58.202">   MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null,</span>
<a href="#l58.203"></a><span id="l58.203">                                     false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l58.204"></a><span id="l58.204"> }</span>
<a href="#l58.205"></a><span id="l58.205"> </span>
<a href="#l58.206"></a><span id="l58.206"> var gTest = null;</span>
<a href="#l58.207"></a><span id="l58.207"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l58.208"></a><span id="l58.208" class="difflineminus">-function testSearch()</span>
<a href="#l58.209"></a><span id="l58.209" class="difflineminus">-{</span>
<a href="#l58.210"></a><span id="l58.210" class="difflineplus">+function testSearch() {</span>
<a href="#l58.211"></a><span id="l58.211">   // tests the previous search</span>
<a href="#l58.212"></a><span id="l58.212">   if (gTest)</span>
<a href="#l58.213"></a><span id="l58.213">     Assert.equal(gHitCount, gTest.matches ? 1 : 0);</span>
<a href="#l58.214"></a><span id="l58.214">   gTest = Tests.shift();</span>
<a href="#l58.215"></a><span id="l58.215" class="difflineminus">-  if (gTest)</span>
<a href="#l58.216"></a><span id="l58.216" class="difflineminus">-  {</span>
<a href="#l58.217"></a><span id="l58.217" class="difflineplus">+  if (gTest) {</span>
<a href="#l58.218"></a><span id="l58.218">     gHdr.setStringProperty(&quot;a&quot;, gTest.A ? &quot;T&quot; : &quot;F&quot;);</span>
<a href="#l58.219"></a><span id="l58.219">     gHdr.setStringProperty(&quot;b&quot;, gTest.B ? &quot;T&quot; : &quot;F&quot;);</span>
<a href="#l58.220"></a><span id="l58.220">     gHdr.setStringProperty(&quot;c&quot;, gTest.C ? &quot;T&quot; : &quot;F&quot;);</span>
<a href="#l58.221"></a><span id="l58.221">     gHdr.setStringProperty(&quot;d&quot;, gTest.D ? &quot;T&quot; : &quot;F&quot;);</span>
<a href="#l58.222"></a><span id="l58.222">     try {</span>
<a href="#l58.223"></a><span id="l58.223">       gSearchSession.search(null);</span>
<a href="#l58.224"></a><span id="l58.224" class="difflineplus">+    } catch (e) {</span>
<a href="#l58.225"></a><span id="l58.225" class="difflineplus">+      dump(e);</span>
<a href="#l58.226"></a><span id="l58.226">     }</span>
<a href="#l58.227"></a><span id="l58.227" class="difflineminus">-    catch (e) {dump(e);}</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineminus">-  }</span>
<a href="#l58.229"></a><span id="l58.229" class="difflineminus">-  else</span>
<a href="#l58.230"></a><span id="l58.230" class="difflineminus">-  {</span>
<a href="#l58.231"></a><span id="l58.231" class="difflineplus">+  } else {</span>
<a href="#l58.232"></a><span id="l58.232">     gSearchSession.unregisterListener(searchListener);</span>
<a href="#l58.233"></a><span id="l58.233">     do_test_finished();</span>
<a href="#l58.234"></a><span id="l58.234">   }</span>
<a href="#l58.235"></a><span id="l58.235"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchChaining.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchChaining.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -3,45 +3,30 @@</span>
<a href="#l59.4"></a><span id="l59.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l59.5"></a><span id="l59.5"> </span>
<a href="#l59.6"></a><span id="l59.6"> // Test of chaining of search scopes in a search session. In particular,</span>
<a href="#l59.7"></a><span id="l59.7"> //  Bug 541969 made us not search an imap folder if the search scope before it</span>
<a href="#l59.8"></a><span id="l59.8"> // there was an empty local folder.</span>
<a href="#l59.9"></a><span id="l59.9"> </span>
<a href="#l59.10"></a><span id="l59.10"> // main test</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l59.13"></a><span id="l59.13"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l59.14"></a><span id="l59.14"> </span>
<a href="#l59.15"></a><span id="l59.15" class="difflineminus">-var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l59.16"></a><span id="l59.16"> var {</span>
<a href="#l59.17"></a><span id="l59.17">   IMAPPump,</span>
<a href="#l59.18"></a><span id="l59.18">   setupIMAPPump,</span>
<a href="#l59.19"></a><span id="l59.19">   teardownIMAPPump,</span>
<a href="#l59.20"></a><span id="l59.20"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/IMAPpump.js&quot;);</span>
<a href="#l59.21"></a><span id="l59.21"> var {</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-  imapDaemon,</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineminus">-  imapMailbox,</span>
<a href="#l59.24"></a><span id="l59.24">   imapMessage,</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineminus">-  IMAP_RFC3501_handler,</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineminus">-  configurations,</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineminus">-  mixinExtension,</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineminus">-  IMAP_GMAIL_extension,</span>
<a href="#l59.29"></a><span id="l59.29" class="difflineminus">-  IMAP_MOVE_extension,</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineminus">-  IMAP_CUSTOM_extension,</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineminus">-  IMAP_RFC2197_extension,</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineminus">-  IMAP_RFC2342_extension,</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineminus">-  IMAP_RFC3348_extension,</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineminus">-  IMAP_RFC4315_extension,</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineminus">-  IMAP_RFC5258_extension,</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineminus">-  IMAP_RFC2195_extension,</span>
<a href="#l59.37"></a><span id="l59.37"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/imapd.js&quot;);</span>
<a href="#l59.38"></a><span id="l59.38"> const {PromiseTestUtils} = ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l59.39"></a><span id="l59.39"> </span>
<a href="#l59.40"></a><span id="l59.40" class="difflineminus">-async function setupFolder()</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineminus">-{</span>
<a href="#l59.42"></a><span id="l59.42" class="difflineplus">+async function setupFolder() {</span>
<a href="#l59.43"></a><span id="l59.43">   // add a single message to the imap inbox.</span>
<a href="#l59.44"></a><span id="l59.44">   let messages = [];</span>
<a href="#l59.45"></a><span id="l59.45">   let messageGenerator = new MessageGenerator();</span>
<a href="#l59.46"></a><span id="l59.46">   messages = messages.concat(messageGenerator.makeMessage());</span>
<a href="#l59.47"></a><span id="l59.47">   let synthMessage = messages[0];</span>
<a href="#l59.48"></a><span id="l59.48"> </span>
<a href="#l59.49"></a><span id="l59.49">   let msgURI =</span>
<a href="#l59.50"></a><span id="l59.50">     Services.io.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineat">@@ -50,18 +35,17 @@ async function setupFolder()</span>
<a href="#l59.52"></a><span id="l59.52">   IMAPPump.mailbox.addMessage(message);</span>
<a href="#l59.53"></a><span id="l59.53"> </span>
<a href="#l59.54"></a><span id="l59.54">   // update folder to download header.</span>
<a href="#l59.55"></a><span id="l59.55">   let listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l59.56"></a><span id="l59.56">   IMAPPump.inbox.updateFolderWithListener(null, listener);</span>
<a href="#l59.57"></a><span id="l59.57">   await listener.promise;</span>
<a href="#l59.58"></a><span id="l59.58"> }</span>
<a href="#l59.59"></a><span id="l59.59"> </span>
<a href="#l59.60"></a><span id="l59.60" class="difflineminus">-async function searchTest()</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineminus">-{</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+async function searchTest() {</span>
<a href="#l59.63"></a><span id="l59.63">   // Get the IMAP inbox...</span>
<a href="#l59.64"></a><span id="l59.64">   var emptyLocal1 = localAccountUtils.rootFolder.createLocalSubfolder(&quot;empty 1&quot;);</span>
<a href="#l59.65"></a><span id="l59.65"> </span>
<a href="#l59.66"></a><span id="l59.66">   let searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l59.67"></a><span id="l59.67">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l59.68"></a><span id="l59.68"> </span>
<a href="#l59.69"></a><span id="l59.69">   let searchTerm = searchSession.createTerm();</span>
<a href="#l59.70"></a><span id="l59.70">   searchTerm.matchAll = true;</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineat">@@ -74,38 +58,34 @@ async function searchTest()</span>
<a href="#l59.72"></a><span id="l59.72">   await listener.promise;</span>
<a href="#l59.73"></a><span id="l59.73"> </span>
<a href="#l59.74"></a><span id="l59.74">   // After the search completes, there still seem to be active URLs, so we</span>
<a href="#l59.75"></a><span id="l59.75">   //   have to wait before we are done and clear.</span>
<a href="#l59.76"></a><span id="l59.76">   await PromiseTestUtils.promiseDelay(1000);</span>
<a href="#l59.77"></a><span id="l59.77"> }</span>
<a href="#l59.78"></a><span id="l59.78"> </span>
<a href="#l59.79"></a><span id="l59.79"> // nsIMsgSearchNotify implementation</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineminus">-var searchListener =</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineminus">-{</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+var searchListener = {</span>
<a href="#l59.83"></a><span id="l59.83">   numTotalMessages: 0,</span>
<a href="#l59.84"></a><span id="l59.84">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgSearchNotify]),</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineminus">-  onNewSearch: function()</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineminus">-  {</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+  onNewSearch() {</span>
<a href="#l59.88"></a><span id="l59.88">     this.numTotalMessages = 0;</span>
<a href="#l59.89"></a><span id="l59.89">   },</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineminus">-  onSearchHit: function(dbHdr, folder)</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineminus">-  {</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineplus">+  onSearchHit(dbHdr, folder) {</span>
<a href="#l59.93"></a><span id="l59.93">     this.numTotalMessages++;</span>
<a href="#l59.94"></a><span id="l59.94">   },</span>
<a href="#l59.95"></a><span id="l59.95" class="difflineminus">-  onSearchDone: function(status)</span>
<a href="#l59.96"></a><span id="l59.96" class="difflineminus">-  {</span>
<a href="#l59.97"></a><span id="l59.97" class="difflineplus">+  onSearchDone(status) {</span>
<a href="#l59.98"></a><span id="l59.98">     Assert.equal(this.numTotalMessages, 1);</span>
<a href="#l59.99"></a><span id="l59.99">     return true;</span>
<a href="#l59.100"></a><span id="l59.100" class="difflineminus">-  }</span>
<a href="#l59.101"></a><span id="l59.101" class="difflineplus">+  },</span>
<a href="#l59.102"></a><span id="l59.102"> };</span>
<a href="#l59.103"></a><span id="l59.103"> </span>
<a href="#l59.104"></a><span id="l59.104"> var tests = [</span>
<a href="#l59.105"></a><span id="l59.105">   setupIMAPPump,</span>
<a href="#l59.106"></a><span id="l59.106">   setupFolder,</span>
<a href="#l59.107"></a><span id="l59.107">   searchTest,</span>
<a href="#l59.108"></a><span id="l59.108" class="difflineminus">-  teardownIMAPPump</span>
<a href="#l59.109"></a><span id="l59.109" class="difflineplus">+  teardownIMAPPump,</span>
<a href="#l59.110"></a><span id="l59.110"> ];</span>
<a href="#l59.111"></a><span id="l59.111"> </span>
<a href="#l59.112"></a><span id="l59.112"> function run_test() {</span>
<a href="#l59.113"></a><span id="l59.113">   tests.forEach(x =&gt; add_task(x));</span>
<a href="#l59.114"></a><span id="l59.114">   run_next_test();</span>
<a href="#l59.115"></a><span id="l59.115"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchCustomTerm.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchCustomTerm.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -1,108 +1,96 @@</span>
<a href="#l60.4"></a><span id="l60.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l60.5"></a><span id="l60.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l60.6"></a><span id="l60.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l60.7"></a><span id="l60.7"> </span>
<a href="#l60.8"></a><span id="l60.8"> /*</span>
<a href="#l60.9"></a><span id="l60.9">  * Testing of custom search features.</span>
<a href="#l60.10"></a><span id="l60.10">  *</span>
<a href="#l60.11"></a><span id="l60.11">  */</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l60.13"></a><span id="l60.13"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l60.14"></a><span id="l60.14"> </span>
<a href="#l60.15"></a><span id="l60.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17"> var kCustomId = &quot;xpcomtest@mozilla.org#test&quot;;</span>
<a href="#l60.18"></a><span id="l60.18"> var gHdr;</span>
<a href="#l60.19"></a><span id="l60.19"> </span>
<a href="#l60.20"></a><span id="l60.20" class="difflineminus">-var Tests =</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineminus">-[</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineminus">-  { setValue: &quot;iamgood&quot;,</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+var Tests = [</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+  {</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+    setValue: &quot;iamgood&quot;,</span>
<a href="#l60.26"></a><span id="l60.26">     testValue: &quot;iamnotgood&quot;,</span>
<a href="#l60.27"></a><span id="l60.27">     op: Ci.nsMsgSearchOp.Is,</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineminus">-    count: 0 },</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineminus">-  { setValue: &quot;iamgood&quot;,</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineplus">+    count: 0,</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineplus">+  }, {</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+    setValue: &quot;iamgood&quot;,</span>
<a href="#l60.33"></a><span id="l60.33">     testValue: &quot;iamgood&quot;,</span>
<a href="#l60.34"></a><span id="l60.34">     op: Ci.nsMsgSearchOp.Is,</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineminus">-    count: 1 }</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineminus">-]</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+    count: 1,</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+  },</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+];</span>
<a href="#l60.40"></a><span id="l60.40"> </span>
<a href="#l60.41"></a><span id="l60.41"> // nsIMsgSearchCustomTerm object</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineminus">-var customTerm =</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineminus">-{</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineplus">+var customTerm = {</span>
<a href="#l60.45"></a><span id="l60.45">   id: kCustomId,</span>
<a href="#l60.46"></a><span id="l60.46">   name: &quot;term name&quot;,</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineminus">-  getEnabled: function(scope, op)</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineminus">-    {</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineminus">-      return scope == Ci.nsMsgSearchScope.offlineMail &amp;&amp;</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-             op == Ci.nsMsgSearchOp.Is;</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineminus">-    },</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineminus">-  getAvailable: function(scope, op)</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineminus">-    {</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineminus">-      return scope == Ci.nsMsgSearchScope.offlineMail &amp;&amp;</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineminus">-             op == Ci.nsMsgSearchOp.Is;</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineminus">-    },</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineminus">-  getAvailableOperators: function(scope, length)</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineminus">-    {</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineminus">-       length.value = 1;</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineminus">-       return [Ci.nsMsgSearchOp.Is];</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineminus">-    },</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineminus">-  match: function(msgHdr, searchValue, searchOp)</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineminus">-    {</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineminus">-      switch (searchOp)</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineminus">-      {</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineminus">-        case Ci.nsMsgSearchOp.Is:</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineminus">-          if (msgHdr.getProperty(&quot;theTestProperty&quot;) == searchValue)</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineminus">-            return true;</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineminus">-      }</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineminus">-      return false;</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineplus">+  getEnabled(scope, op) {</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+    return scope == Ci.nsMsgSearchScope.offlineMail &amp;&amp;</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+           op == Ci.nsMsgSearchOp.Is;</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+  },</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+  getAvailable(scope, op) {</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+    return scope == Ci.nsMsgSearchScope.offlineMail &amp;&amp;</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineplus">+           op == Ci.nsMsgSearchOp.Is;</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+  },</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+  getAvailableOperators(scope, length) {</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+     length.value = 1;</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+     return [Ci.nsMsgSearchOp.Is];</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+  },</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+  match(msgHdr, searchValue, searchOp) {</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+    switch (searchOp) {</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+      case Ci.nsMsgSearchOp.Is:</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+        if (msgHdr.getProperty(&quot;theTestProperty&quot;) == searchValue)</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+          return true;</span>
<a href="#l60.88"></a><span id="l60.88">     }</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+    return false;</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+  },</span>
<a href="#l60.91"></a><span id="l60.91"> };</span>
<a href="#l60.92"></a><span id="l60.92"> </span>
<a href="#l60.93"></a><span id="l60.93" class="difflineminus">-function run_test()</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineminus">-{</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineplus">+function run_test() {</span>
<a href="#l60.96"></a><span id="l60.96">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l60.97"></a><span id="l60.97">   MailServices.filters.addCustomTerm(customTerm);</span>
<a href="#l60.98"></a><span id="l60.98"> </span>
<a href="#l60.99"></a><span id="l60.99" class="difflineminus">-  var copyListener =</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineminus">-  {</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineminus">-    SetMessageKey: function(aKey) {</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineplus">+  var copyListener = {</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l60.107"></a><span id="l60.107" class="difflineplus">+    SetMessageKey(aKey) {</span>
<a href="#l60.108"></a><span id="l60.108">       gHdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l60.109"></a><span id="l60.109">     },</span>
<a href="#l60.110"></a><span id="l60.110" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l60.111"></a><span id="l60.111" class="difflineminus">-    OnStopCopy: function(aStatus) { doTest();}</span>
<a href="#l60.112"></a><span id="l60.112" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l60.113"></a><span id="l60.113" class="difflineplus">+    OnStopCopy(aStatus) { doTest(); },</span>
<a href="#l60.114"></a><span id="l60.114">   };</span>
<a href="#l60.115"></a><span id="l60.115"> </span>
<a href="#l60.116"></a><span id="l60.116">   // Get a message into the local filestore.</span>
<a href="#l60.117"></a><span id="l60.117">   // function testSearch() continues the testing after the copy.</span>
<a href="#l60.118"></a><span id="l60.118">   let bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l60.119"></a><span id="l60.119">   do_test_pending();</span>
<a href="#l60.120"></a><span id="l60.120"> </span>
<a href="#l60.121"></a><span id="l60.121">   MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null,</span>
<a href="#l60.122"></a><span id="l60.122">                                     false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l60.123"></a><span id="l60.123"> }</span>
<a href="#l60.124"></a><span id="l60.124"> </span>
<a href="#l60.125"></a><span id="l60.125" class="difflineminus">-var testObject;</span>
<a href="#l60.126"></a><span id="l60.126" class="difflineminus">-</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineminus">-function doTest()</span>
<a href="#l60.128"></a><span id="l60.128" class="difflineminus">-{</span>
<a href="#l60.129"></a><span id="l60.129" class="difflineplus">+function doTest() {</span>
<a href="#l60.130"></a><span id="l60.130">   let test = Tests.shift();</span>
<a href="#l60.131"></a><span id="l60.131" class="difflineminus">-  if (test)</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineminus">-  {</span>
<a href="#l60.133"></a><span id="l60.133" class="difflineplus">+  if (test) {</span>
<a href="#l60.134"></a><span id="l60.134">     gHdr.setStringProperty(&quot;theTestProperty&quot;, test.setValue);</span>
<a href="#l60.135"></a><span id="l60.135" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l60.136"></a><span id="l60.136" class="difflineminus">-                         test.testValue,</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineminus">-                         Ci.nsMsgSearchAttrib.Custom,</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineminus">-                         test.op,</span>
<a href="#l60.139"></a><span id="l60.139" class="difflineminus">-                         test.count,</span>
<a href="#l60.140"></a><span id="l60.140" class="difflineminus">-                         doTest,</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineminus">-                         kCustomId);</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineminus">-  }</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineminus">-  else</span>
<a href="#l60.144"></a><span id="l60.144" class="difflineminus">-  {</span>
<a href="#l60.145"></a><span id="l60.145" class="difflineminus">-    testObject = null;</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineplus">+                   test.testValue,</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineplus">+                   Ci.nsMsgSearchAttrib.Custom,</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+                   test.op,</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+                   test.count,</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineplus">+                   doTest,</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineplus">+                   kCustomId);</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+  } else {</span>
<a href="#l60.154"></a><span id="l60.154">     gHdr = null;</span>
<a href="#l60.155"></a><span id="l60.155">     do_test_finished();</span>
<a href="#l60.156"></a><span id="l60.156">   }</span>
<a href="#l60.157"></a><span id="l60.157"> }</span>
<a href="#l60.158"></a><span id="l60.158"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchJunk.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchJunk.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -1,34 +1,31 @@</span>
<a href="#l61.4"></a><span id="l61.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l61.5"></a><span id="l61.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l61.6"></a><span id="l61.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> // Testing of search by junk percent and junk score origin</span>
<a href="#l61.9"></a><span id="l61.9"> </span>
<a href="#l61.10"></a><span id="l61.10" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l61.11"></a><span id="l61.11"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l61.12"></a><span id="l61.12"> </span>
<a href="#l61.13"></a><span id="l61.13"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l61.14"></a><span id="l61.14"> </span>
<a href="#l61.15"></a><span id="l61.15" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+var IsGreaterThan = Ci.nsMsgSearchOp.IsGreaterThan;</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+var IsLessThan = Ci.nsMsgSearchOp.IsLessThan;</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l61.21"></a><span id="l61.21" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+var IsEmpty = Ci.nsMsgSearchOp.IsEmpty;</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+var IsntEmpty = Ci.nsMsgSearchOp.IsntEmpty;</span>
<a href="#l61.24"></a><span id="l61.24"> </span>
<a href="#l61.25"></a><span id="l61.25" class="difflineminus">-var IsGreaterThan = nsMsgSearchOp.IsGreaterThan;</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineminus">-var IsLessThan = nsMsgSearchOp.IsLessThan;</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineminus">-var IsEmpty = nsMsgSearchOp.IsEmpty;</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineminus">-var IsntEmpty = nsMsgSearchOp.IsntEmpty;</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineplus">+var offlineMail = Ci.nsMsgSearchScope.offlineMail;</span>
<a href="#l61.32"></a><span id="l61.32"> </span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineminus">-</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineminus">-var JunkScoreOrigin = nsMsgSearchAttrib.JunkScoreOrigin;</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineminus">-var JunkPercent = nsMsgSearchAttrib.JunkPercent;</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineminus">-var JunkStatus = nsMsgSearchAttrib.JunkStatus;</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+var JunkScoreOrigin = Ci.nsMsgSearchAttrib.JunkScoreOrigin;</span>
<a href="#l61.39"></a><span id="l61.39" class="difflineplus">+var JunkPercent = Ci.nsMsgSearchAttrib.JunkPercent;</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineplus">+var JunkStatus = Ci.nsMsgSearchAttrib.JunkStatus;</span>
<a href="#l61.41"></a><span id="l61.41"> </span>
<a href="#l61.42"></a><span id="l61.42"> var fileName = &quot;../../../data/bugmail1&quot;;</span>
<a href="#l61.43"></a><span id="l61.43"> </span>
<a href="#l61.44"></a><span id="l61.44"> /*</span>
<a href="#l61.45"></a><span id="l61.45">  * The search for junkpercent is defined as the effective value,</span>
<a href="#l61.46"></a><span id="l61.46">  * while the &quot;junkpercent&quot; database term is always the result</span>
<a href="#l61.47"></a><span id="l61.47">  * from the bayes filter. This is optimized to make views that</span>
<a href="#l61.48"></a><span id="l61.48">  * rely on junk percent search work with the best value for junk</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineat">@@ -36,186 +33,206 @@ var fileName = &quot;../../../data/bugmail1&quot;;</span>
<a href="#l61.50"></a><span id="l61.50">  * to be saved for analysis.</span>
<a href="#l61.51"></a><span id="l61.51">  *</span>
<a href="#l61.52"></a><span id="l61.52">  * This means that the search for &quot;junk percent&quot; only uses the</span>
<a href="#l61.53"></a><span id="l61.53">  * database junkpercent value if junkscoreorigin is &quot;plugin&quot;.</span>
<a href="#l61.54"></a><span id="l61.54">  * Otherwise, it uses junkstatus (if set) or defaults to 0</span>
<a href="#l61.55"></a><span id="l61.55">  * (not junk) if the message is unclassified.</span>
<a href="#l61.56"></a><span id="l61.56">  */</span>
<a href="#l61.57"></a><span id="l61.57"> </span>
<a href="#l61.58"></a><span id="l61.58" class="difflineminus">-var Tests =</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineminus">-[</span>
<a href="#l61.60"></a><span id="l61.60" class="difflineminus">-  // test empty junk status</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineminus">-  { junkScore: false,</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+var Tests = [</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineplus">+  {</span>
<a href="#l61.64"></a><span id="l61.64" class="difflineplus">+    // test empty junk status</span>
<a href="#l61.65"></a><span id="l61.65" class="difflineplus">+    junkScore: false,</span>
<a href="#l61.66"></a><span id="l61.66">     testValue: 90,</span>
<a href="#l61.67"></a><span id="l61.67">     attrib: JunkStatus,</span>
<a href="#l61.68"></a><span id="l61.68">     op: IsEmpty,</span>
<a href="#l61.69"></a><span id="l61.69" class="difflineminus">-    count: 1},</span>
<a href="#l61.70"></a><span id="l61.70" class="difflineminus">-  { junkScore: false,</span>
<a href="#l61.71"></a><span id="l61.71" class="difflineplus">+    count: 1,</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineplus">+  }, {</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineplus">+    junkScore: false,</span>
<a href="#l61.74"></a><span id="l61.74">     testValue: 90,</span>
<a href="#l61.75"></a><span id="l61.75">     attrib: JunkStatus,</span>
<a href="#l61.76"></a><span id="l61.76">     op: IsntEmpty,</span>
<a href="#l61.77"></a><span id="l61.77" class="difflineminus">-    count: 0},</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+    count: 0,</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+  }, {</span>
<a href="#l61.81"></a><span id="l61.81" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.82"></a><span id="l61.82">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.83"></a><span id="l61.83">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.84"></a><span id="l61.84">     testValue: 90,</span>
<a href="#l61.85"></a><span id="l61.85">     attrib: JunkStatus,</span>
<a href="#l61.86"></a><span id="l61.86">     op: IsntEmpty,</span>
<a href="#l61.87"></a><span id="l61.87" class="difflineminus">-    count: 1},</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineplus">+    count: 1,</span>
<a href="#l61.90"></a><span id="l61.90" class="difflineplus">+  }, {</span>
<a href="#l61.91"></a><span id="l61.91" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.92"></a><span id="l61.92">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.93"></a><span id="l61.93">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.94"></a><span id="l61.94">     testValue: 90,</span>
<a href="#l61.95"></a><span id="l61.95">     attrib: JunkStatus,</span>
<a href="#l61.96"></a><span id="l61.96">     op: IsEmpty,</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineminus">-    count: 0},</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineminus">-  { junkScore: &quot;100&quot;,</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineplus">+    count: 0,</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineplus">+  }, {</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+    junkScore: &quot;100&quot;,</span>
<a href="#l61.102"></a><span id="l61.102">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.103"></a><span id="l61.103">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.104"></a><span id="l61.104">     testValue: 90,</span>
<a href="#l61.105"></a><span id="l61.105">     attrib: JunkStatus,</span>
<a href="#l61.106"></a><span id="l61.106">     op: IsntEmpty,</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineminus">-    count: 1},</span>
<a href="#l61.108"></a><span id="l61.108" class="difflineminus">-  { junkScore: &quot;100&quot;,</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineplus">+    count: 1,</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineplus">+  }, {</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+    junkScore: &quot;100&quot;,</span>
<a href="#l61.112"></a><span id="l61.112">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.113"></a><span id="l61.113">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.114"></a><span id="l61.114">     testValue: 90,</span>
<a href="#l61.115"></a><span id="l61.115">     attrib: JunkStatus,</span>
<a href="#l61.116"></a><span id="l61.116">     op: IsEmpty,</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineminus">-    count: 0},</span>
<a href="#l61.118"></a><span id="l61.118" class="difflineminus">-  // Use junkpercent from database</span>
<a href="#l61.119"></a><span id="l61.119" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.120"></a><span id="l61.120" class="difflineplus">+    count: 0,</span>
<a href="#l61.121"></a><span id="l61.121" class="difflineplus">+  }, {</span>
<a href="#l61.122"></a><span id="l61.122" class="difflineplus">+    // Use junkpercent from database</span>
<a href="#l61.123"></a><span id="l61.123" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.124"></a><span id="l61.124">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.125"></a><span id="l61.125">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.126"></a><span id="l61.126">     testValue: 90,</span>
<a href="#l61.127"></a><span id="l61.127">     attrib: JunkPercent,</span>
<a href="#l61.128"></a><span id="l61.128">     op: IsGreaterThan,</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineminus">-    count: 0},</span>
<a href="#l61.130"></a><span id="l61.130" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.131"></a><span id="l61.131" class="difflineplus">+    count: 0,</span>
<a href="#l61.132"></a><span id="l61.132" class="difflineplus">+  }, {</span>
<a href="#l61.133"></a><span id="l61.133" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.134"></a><span id="l61.134">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.135"></a><span id="l61.135">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.136"></a><span id="l61.136">     testValue: 90,</span>
<a href="#l61.137"></a><span id="l61.137">     attrib: JunkPercent,</span>
<a href="#l61.138"></a><span id="l61.138">     op: IsLessThan,</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineminus">-    count: 1},</span>
<a href="#l61.140"></a><span id="l61.140" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.141"></a><span id="l61.141" class="difflineplus">+    count: 1,</span>
<a href="#l61.142"></a><span id="l61.142" class="difflineplus">+  }, {</span>
<a href="#l61.143"></a><span id="l61.143" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.144"></a><span id="l61.144">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.145"></a><span id="l61.145">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.146"></a><span id="l61.146">     testValue: 90,</span>
<a href="#l61.147"></a><span id="l61.147">     attrib: JunkPercent,</span>
<a href="#l61.148"></a><span id="l61.148">     op: Is,</span>
<a href="#l61.149"></a><span id="l61.149" class="difflineminus">-    count: 0},</span>
<a href="#l61.150"></a><span id="l61.150" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.151"></a><span id="l61.151" class="difflineplus">+    count: 0,</span>
<a href="#l61.152"></a><span id="l61.152" class="difflineplus">+  }, {</span>
<a href="#l61.153"></a><span id="l61.153" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.154"></a><span id="l61.154">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.155"></a><span id="l61.155">     junkPercent: &quot;90&quot;,</span>
<a href="#l61.156"></a><span id="l61.156">     testValue: 10,</span>
<a href="#l61.157"></a><span id="l61.157">     attrib: JunkPercent,</span>
<a href="#l61.158"></a><span id="l61.158">     op: IsGreaterThan,</span>
<a href="#l61.159"></a><span id="l61.159" class="difflineminus">-    count: 1},</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineplus">+    count: 1,</span>
<a href="#l61.162"></a><span id="l61.162" class="difflineplus">+  }, {</span>
<a href="#l61.163"></a><span id="l61.163" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.164"></a><span id="l61.164">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.165"></a><span id="l61.165">     junkPercent: &quot;90&quot;,</span>
<a href="#l61.166"></a><span id="l61.166">     testValue: 10,</span>
<a href="#l61.167"></a><span id="l61.167">     attrib: JunkPercent,</span>
<a href="#l61.168"></a><span id="l61.168">     op: IsLessThan,</span>
<a href="#l61.169"></a><span id="l61.169" class="difflineminus">-    count: 0},</span>
<a href="#l61.170"></a><span id="l61.170" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.171"></a><span id="l61.171" class="difflineplus">+    count: 0,</span>
<a href="#l61.172"></a><span id="l61.172" class="difflineplus">+  }, {</span>
<a href="#l61.173"></a><span id="l61.173" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.174"></a><span id="l61.174">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.175"></a><span id="l61.175">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.176"></a><span id="l61.176">     testValue: 10,</span>
<a href="#l61.177"></a><span id="l61.177">     attrib: JunkPercent,</span>
<a href="#l61.178"></a><span id="l61.178">     op: Is,</span>
<a href="#l61.179"></a><span id="l61.179" class="difflineminus">-    count: 1},</span>
<a href="#l61.180"></a><span id="l61.180" class="difflineminus">-</span>
<a href="#l61.181"></a><span id="l61.181" class="difflineplus">+    count: 1,</span>
<a href="#l61.182"></a><span id="l61.182" class="difflineplus">+  }, {</span>
<a href="#l61.183"></a><span id="l61.183">     // values set by user, use junkscore not junkpercent</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.185"></a><span id="l61.185" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.186"></a><span id="l61.186">     junkScoreOrigin: &quot;user&quot;,</span>
<a href="#l61.187"></a><span id="l61.187">     junkPercent: &quot;90&quot;,</span>
<a href="#l61.188"></a><span id="l61.188">     testValue: 50,</span>
<a href="#l61.189"></a><span id="l61.189">     attrib: JunkPercent,</span>
<a href="#l61.190"></a><span id="l61.190">     op: IsGreaterThan,</span>
<a href="#l61.191"></a><span id="l61.191" class="difflineminus">-    count: 0},</span>
<a href="#l61.192"></a><span id="l61.192" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.193"></a><span id="l61.193" class="difflineplus">+    count: 0,</span>
<a href="#l61.194"></a><span id="l61.194" class="difflineplus">+  }, {</span>
<a href="#l61.195"></a><span id="l61.195" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.196"></a><span id="l61.196">     junkScoreOrigin: &quot;user&quot;,</span>
<a href="#l61.197"></a><span id="l61.197">     junkPercent: &quot;90&quot;,</span>
<a href="#l61.198"></a><span id="l61.198">     testValue: 50,</span>
<a href="#l61.199"></a><span id="l61.199">     attrib: JunkPercent,</span>
<a href="#l61.200"></a><span id="l61.200">     op: IsLessThan,</span>
<a href="#l61.201"></a><span id="l61.201" class="difflineminus">-    count: 1},</span>
<a href="#l61.202"></a><span id="l61.202" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.203"></a><span id="l61.203" class="difflineplus">+    count: 1,</span>
<a href="#l61.204"></a><span id="l61.204" class="difflineplus">+  }, {</span>
<a href="#l61.205"></a><span id="l61.205" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.206"></a><span id="l61.206">     junkScoreOrigin: &quot;user&quot;,</span>
<a href="#l61.207"></a><span id="l61.207">     junkPercent: &quot;90&quot;,</span>
<a href="#l61.208"></a><span id="l61.208">     testValue: 50,</span>
<a href="#l61.209"></a><span id="l61.209">     attrib: JunkPercent,</span>
<a href="#l61.210"></a><span id="l61.210">     op: Is,</span>
<a href="#l61.211"></a><span id="l61.211" class="difflineminus">-    count: 0},</span>
<a href="#l61.212"></a><span id="l61.212" class="difflineminus">-  { junkScore: &quot;100&quot;,</span>
<a href="#l61.213"></a><span id="l61.213" class="difflineplus">+    count: 0,</span>
<a href="#l61.214"></a><span id="l61.214" class="difflineplus">+  }, {</span>
<a href="#l61.215"></a><span id="l61.215" class="difflineplus">+    junkScore: &quot;100&quot;,</span>
<a href="#l61.216"></a><span id="l61.216">     junkScoreOrigin: &quot;user&quot;,</span>
<a href="#l61.217"></a><span id="l61.217">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.218"></a><span id="l61.218">     testValue: 50,</span>
<a href="#l61.219"></a><span id="l61.219">     attrib: JunkPercent,</span>
<a href="#l61.220"></a><span id="l61.220">     op: IsGreaterThan,</span>
<a href="#l61.221"></a><span id="l61.221" class="difflineminus">-    count: 1},</span>
<a href="#l61.222"></a><span id="l61.222" class="difflineminus">-  { junkScore: &quot;100&quot;,</span>
<a href="#l61.223"></a><span id="l61.223" class="difflineplus">+    count: 1,</span>
<a href="#l61.224"></a><span id="l61.224" class="difflineplus">+  }, {</span>
<a href="#l61.225"></a><span id="l61.225" class="difflineplus">+    junkScore: &quot;100&quot;,</span>
<a href="#l61.226"></a><span id="l61.226">     junkScoreOrigin: &quot;user&quot;,</span>
<a href="#l61.227"></a><span id="l61.227">     junkPercent: &quot;10&quot;,</span>
<a href="#l61.228"></a><span id="l61.228">     testValue: 50,</span>
<a href="#l61.229"></a><span id="l61.229">     attrib: JunkPercent,</span>
<a href="#l61.230"></a><span id="l61.230">     op: IsLessThan,</span>
<a href="#l61.231"></a><span id="l61.231" class="difflineminus">-    count: 0},</span>
<a href="#l61.232"></a><span id="l61.232" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.233"></a><span id="l61.233" class="difflineplus">+    count: 0,</span>
<a href="#l61.234"></a><span id="l61.234" class="difflineplus">+  }, {</span>
<a href="#l61.235"></a><span id="l61.235" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.236"></a><span id="l61.236">     junkScoreOrigin: &quot;user&quot;,</span>
<a href="#l61.237"></a><span id="l61.237">     junkPercent: &quot;90&quot;,</span>
<a href="#l61.238"></a><span id="l61.238">     testValue: 0,</span>
<a href="#l61.239"></a><span id="l61.239">     attrib: JunkPercent,</span>
<a href="#l61.240"></a><span id="l61.240">     op: Is,</span>
<a href="#l61.241"></a><span id="l61.241" class="difflineminus">-    count: 1},</span>
<a href="#l61.242"></a><span id="l61.242" class="difflineplus">+    count: 1,</span>
<a href="#l61.243"></a><span id="l61.243" class="difflineplus">+  }, {</span>
<a href="#l61.244"></a><span id="l61.244">     // default to 0 when nothing set</span>
<a href="#l61.245"></a><span id="l61.245" class="difflineminus">-  { junkScore: &quot;&quot;,</span>
<a href="#l61.246"></a><span id="l61.246" class="difflineplus">+    junkScore: &quot;&quot;,</span>
<a href="#l61.247"></a><span id="l61.247">     junkScoreOrigin: &quot;&quot;,</span>
<a href="#l61.248"></a><span id="l61.248">     junkPercent: &quot;&quot;,</span>
<a href="#l61.249"></a><span id="l61.249">     testValue: 0,</span>
<a href="#l61.250"></a><span id="l61.250">     attrib: JunkPercent,</span>
<a href="#l61.251"></a><span id="l61.251">     op: Is,</span>
<a href="#l61.252"></a><span id="l61.252" class="difflineminus">-    count: 1},</span>
<a href="#l61.253"></a><span id="l61.253" class="difflineminus">-</span>
<a href="#l61.254"></a><span id="l61.254" class="difflineplus">+    count: 1,</span>
<a href="#l61.255"></a><span id="l61.255" class="difflineplus">+  }, {</span>
<a href="#l61.256"></a><span id="l61.256">     // junkscoreorigin search tests</span>
<a href="#l61.257"></a><span id="l61.257" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.258"></a><span id="l61.258" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.259"></a><span id="l61.259">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.260"></a><span id="l61.260">     junkPercent: &quot;50&quot;,</span>
<a href="#l61.261"></a><span id="l61.261">     testValue: &quot;plugin&quot;,</span>
<a href="#l61.262"></a><span id="l61.262">     attrib: JunkScoreOrigin,</span>
<a href="#l61.263"></a><span id="l61.263">     op: Is,</span>
<a href="#l61.264"></a><span id="l61.264" class="difflineminus">-    count: 1},</span>
<a href="#l61.265"></a><span id="l61.265" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.266"></a><span id="l61.266" class="difflineplus">+    count: 1,</span>
<a href="#l61.267"></a><span id="l61.267" class="difflineplus">+  }, {</span>
<a href="#l61.268"></a><span id="l61.268" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.269"></a><span id="l61.269">     junkScoreOrigin: &quot;plugin&quot;,</span>
<a href="#l61.270"></a><span id="l61.270">     junkPercent: &quot;50&quot;,</span>
<a href="#l61.271"></a><span id="l61.271">     testValue: &quot;plugin&quot;,</span>
<a href="#l61.272"></a><span id="l61.272">     attrib: JunkScoreOrigin,</span>
<a href="#l61.273"></a><span id="l61.273">     op: Isnt,</span>
<a href="#l61.274"></a><span id="l61.274" class="difflineminus">-    count: 0},</span>
<a href="#l61.275"></a><span id="l61.275" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.276"></a><span id="l61.276" class="difflineplus">+    count: 0,</span>
<a href="#l61.277"></a><span id="l61.277" class="difflineplus">+  }, {</span>
<a href="#l61.278"></a><span id="l61.278" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.279"></a><span id="l61.279">     junkScoreOrigin: &quot;filter&quot;,</span>
<a href="#l61.280"></a><span id="l61.280">     junkPercent: &quot;50&quot;,</span>
<a href="#l61.281"></a><span id="l61.281">     testValue: &quot;plugin&quot;,</span>
<a href="#l61.282"></a><span id="l61.282">     attrib: JunkScoreOrigin,</span>
<a href="#l61.283"></a><span id="l61.283">     op: Is,</span>
<a href="#l61.284"></a><span id="l61.284" class="difflineminus">-    count: 0},</span>
<a href="#l61.285"></a><span id="l61.285" class="difflineminus">-  { junkScore: &quot;0&quot;,</span>
<a href="#l61.286"></a><span id="l61.286" class="difflineplus">+    count: 0,</span>
<a href="#l61.287"></a><span id="l61.287" class="difflineplus">+  }, {</span>
<a href="#l61.288"></a><span id="l61.288" class="difflineplus">+    junkScore: &quot;0&quot;,</span>
<a href="#l61.289"></a><span id="l61.289">     junkScoreOrigin: &quot;filter&quot;,</span>
<a href="#l61.290"></a><span id="l61.290">     junkPercent: &quot;50&quot;,</span>
<a href="#l61.291"></a><span id="l61.291">     testValue: &quot;plugin&quot;,</span>
<a href="#l61.292"></a><span id="l61.292">     attrib: JunkScoreOrigin,</span>
<a href="#l61.293"></a><span id="l61.293">     op: Isnt,</span>
<a href="#l61.294"></a><span id="l61.294" class="difflineminus">-    count: 1},</span>
<a href="#l61.295"></a><span id="l61.295" class="difflineplus">+    count: 1,</span>
<a href="#l61.296"></a><span id="l61.296" class="difflineplus">+  },</span>
<a href="#l61.297"></a><span id="l61.297"> ];</span>
<a href="#l61.298"></a><span id="l61.298"> </span>
<a href="#l61.299"></a><span id="l61.299" class="difflineminus">-function run_test()</span>
<a href="#l61.300"></a><span id="l61.300" class="difflineminus">-{</span>
<a href="#l61.301"></a><span id="l61.301" class="difflineplus">+function run_test() {</span>
<a href="#l61.302"></a><span id="l61.302">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l61.303"></a><span id="l61.303"> </span>
<a href="#l61.304"></a><span id="l61.304">   // test that validity table terms are valid</span>
<a href="#l61.305"></a><span id="l61.305"> </span>
<a href="#l61.306"></a><span id="l61.306">   // offline mail table</span>
<a href="#l61.307"></a><span id="l61.307">   testValidityTable(offlineMail, Is, JunkPercent, true);</span>
<a href="#l61.308"></a><span id="l61.308">   testValidityTable(offlineMail, Isnt, JunkPercent, false);</span>
<a href="#l61.309"></a><span id="l61.309">   testValidityTable(offlineMail, IsGreaterThan, JunkPercent, true);</span>
<a href="#l61.310"></a><span id="l61.310" class="difflineat">@@ -230,46 +247,38 @@ function run_test()</span>
<a href="#l61.311"></a><span id="l61.311">   do_test_pending();</span>
<a href="#l61.312"></a><span id="l61.312">   var file = do_get_file(fileName);</span>
<a href="#l61.313"></a><span id="l61.313">   MailServices.copy.CopyFileMessage(file, localAccountUtils.inboxFolder, null, false, 0,</span>
<a href="#l61.314"></a><span id="l61.314">                                     &quot;&quot;, copyListener, null);</span>
<a href="#l61.315"></a><span id="l61.315">   return true;</span>
<a href="#l61.316"></a><span id="l61.316"> }</span>
<a href="#l61.317"></a><span id="l61.317"> </span>
<a href="#l61.318"></a><span id="l61.318"> var hdr;</span>
<a href="#l61.319"></a><span id="l61.319" class="difflineminus">-var copyListener =</span>
<a href="#l61.320"></a><span id="l61.320" class="difflineminus">-{</span>
<a href="#l61.321"></a><span id="l61.321" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l61.322"></a><span id="l61.322" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l61.323"></a><span id="l61.323" class="difflineminus">-  SetMessageKey: function(aKey) { hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);},</span>
<a href="#l61.324"></a><span id="l61.324" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l61.325"></a><span id="l61.325" class="difflineminus">-  OnStopCopy: function(aStatus) { testJunkSearch();}</span>
<a href="#l61.326"></a><span id="l61.326" class="difflineplus">+var copyListener = {</span>
<a href="#l61.327"></a><span id="l61.327" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l61.328"></a><span id="l61.328" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l61.329"></a><span id="l61.329" class="difflineplus">+  SetMessageKey(aKey) { hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey); },</span>
<a href="#l61.330"></a><span id="l61.330" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l61.331"></a><span id="l61.331" class="difflineplus">+  OnStopCopy(aStatus) { testJunkSearch(); },</span>
<a href="#l61.332"></a><span id="l61.332"> };</span>
<a href="#l61.333"></a><span id="l61.333"> </span>
<a href="#l61.334"></a><span id="l61.334"> // Runs at completion of each copy</span>
<a href="#l61.335"></a><span id="l61.335"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l61.336"></a><span id="l61.336" class="difflineminus">-var testObject;</span>
<a href="#l61.337"></a><span id="l61.337" class="difflineminus">-function testJunkSearch()</span>
<a href="#l61.338"></a><span id="l61.338" class="difflineminus">-{</span>
<a href="#l61.339"></a><span id="l61.339" class="difflineplus">+function testJunkSearch() {</span>
<a href="#l61.340"></a><span id="l61.340">   var test = Tests.shift();</span>
<a href="#l61.341"></a><span id="l61.341" class="difflineminus">-  if (test)</span>
<a href="#l61.342"></a><span id="l61.342" class="difflineminus">-  {</span>
<a href="#l61.343"></a><span id="l61.343" class="difflineminus">-    if (test.junkScore)</span>
<a href="#l61.344"></a><span id="l61.344" class="difflineminus">-    {</span>
<a href="#l61.345"></a><span id="l61.345" class="difflineplus">+  if (test) {</span>
<a href="#l61.346"></a><span id="l61.346" class="difflineplus">+    if (test.junkScore) {</span>
<a href="#l61.347"></a><span id="l61.347">       hdr.setStringProperty(&quot;junkpercent&quot;, test.junkPercent);</span>
<a href="#l61.348"></a><span id="l61.348">       hdr.setStringProperty(&quot;junkscoreorigin&quot;, test.junkScoreOrigin);</span>
<a href="#l61.349"></a><span id="l61.349">       hdr.setStringProperty(&quot;junkscore&quot;, test.junkScore);</span>
<a href="#l61.350"></a><span id="l61.350">     }</span>
<a href="#l61.351"></a><span id="l61.351"> </span>
<a href="#l61.352"></a><span id="l61.352" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l61.353"></a><span id="l61.353" class="difflineminus">-                         test.testValue,</span>
<a href="#l61.354"></a><span id="l61.354" class="difflineminus">-                         test.attrib,</span>
<a href="#l61.355"></a><span id="l61.355" class="difflineminus">-                         test.op,</span>
<a href="#l61.356"></a><span id="l61.356" class="difflineminus">-                         test.count,</span>
<a href="#l61.357"></a><span id="l61.357" class="difflineminus">-                         testJunkSearch);</span>
<a href="#l61.358"></a><span id="l61.358" class="difflineminus">-  }</span>
<a href="#l61.359"></a><span id="l61.359" class="difflineminus">-  else</span>
<a href="#l61.360"></a><span id="l61.360" class="difflineminus">-  {</span>
<a href="#l61.361"></a><span id="l61.361" class="difflineminus">-    testObject = null;</span>
<a href="#l61.362"></a><span id="l61.362" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l61.363"></a><span id="l61.363" class="difflineplus">+                   test.testValue,</span>
<a href="#l61.364"></a><span id="l61.364" class="difflineplus">+                   test.attrib,</span>
<a href="#l61.365"></a><span id="l61.365" class="difflineplus">+                   test.op,</span>
<a href="#l61.366"></a><span id="l61.366" class="difflineplus">+                   test.count,</span>
<a href="#l61.367"></a><span id="l61.367" class="difflineplus">+                   testJunkSearch);</span>
<a href="#l61.368"></a><span id="l61.368" class="difflineplus">+  } else {</span>
<a href="#l61.369"></a><span id="l61.369">     hdr = null;</span>
<a href="#l61.370"></a><span id="l61.370">     do_test_finished();</span>
<a href="#l61.371"></a><span id="l61.371">   }</span>
<a href="#l61.372"></a><span id="l61.372"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchLocalizationStrings.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchLocalizationStrings.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -1,59 +1,52 @@</span>
<a href="#l62.4"></a><span id="l62.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l62.5"></a><span id="l62.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l62.6"></a><span id="l62.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8">  // tests that localization strings added in bug 484147 are defined in preferences</span>
<a href="#l62.9"></a><span id="l62.9"> </span>
<a href="#l62.10"></a><span id="l62.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-var gValidityManager = Cc['@mozilla.org/mail/search/validityManager;1']</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+var gValidityManager = Cc[&quot;@mozilla.org/mail/search/validityManager;1&quot;]</span>
<a href="#l62.14"></a><span id="l62.14">                            .getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l62.15"></a><span id="l62.15"> </span>
<a href="#l62.16"></a><span id="l62.16"> var gStringBundle = Services.strings</span>
<a href="#l62.17"></a><span id="l62.17">                               .createBundle(&quot;chrome://messenger/locale/search-attributes.properties&quot;);</span>
<a href="#l62.18"></a><span id="l62.18"> </span>
<a href="#l62.19"></a><span id="l62.19"> // The following table of valid table scopes matches the allowable table</span>
<a href="#l62.20"></a><span id="l62.20"> // scopes in nsMsgSearchValidityManager::GetTable</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineminus">-var kValidScopes =</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineminus">-[</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+var kValidScopes = [</span>
<a href="#l62.24"></a><span id="l62.24">   Ci.nsMsgSearchScope.offlineMail,</span>
<a href="#l62.25"></a><span id="l62.25">   Ci.nsMsgSearchScope.offlineMailFilter,</span>
<a href="#l62.26"></a><span id="l62.26">   Ci.nsMsgSearchScope.onlineMail,</span>
<a href="#l62.27"></a><span id="l62.27">   Ci.nsMsgSearchScope.onlineMailFilter,</span>
<a href="#l62.28"></a><span id="l62.28">   Ci.nsMsgSearchScope.news,</span>
<a href="#l62.29"></a><span id="l62.29">   Ci.nsMsgSearchScope.newsFilter,</span>
<a href="#l62.30"></a><span id="l62.30">   Ci.nsMsgSearchScope.localNews,</span>
<a href="#l62.31"></a><span id="l62.31">   Ci.nsMsgSearchScope.LDAP,</span>
<a href="#l62.32"></a><span id="l62.32">   Ci.nsMsgSearchScope.LDAPAnd,</span>
<a href="#l62.33"></a><span id="l62.33">   Ci.nsMsgSearchScope.LocalAB,</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineminus">-  Ci.nsMsgSearchScope.LocalABAnd</span>
<a href="#l62.35"></a><span id="l62.35" class="difflineplus">+  Ci.nsMsgSearchScope.LocalABAnd,</span>
<a href="#l62.36"></a><span id="l62.36"> ];</span>
<a href="#l62.37"></a><span id="l62.37"> </span>
<a href="#l62.38"></a><span id="l62.38" class="difflineminus">-function run_test()</span>
<a href="#l62.39"></a><span id="l62.39" class="difflineminus">-{</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineminus">-  for (var index = 0; index &lt; kValidScopes.length; ++index)</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineminus">-  {</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+function run_test() {</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+  for (var index = 0; index &lt; kValidScopes.length; ++index) {</span>
<a href="#l62.44"></a><span id="l62.44">     let scope = kValidScopes[index];</span>
<a href="#l62.45"></a><span id="l62.45">     let table = gValidityManager.getTable(scope);</span>
<a href="#l62.46"></a><span id="l62.46">     let attributes = table.getAvailableAttributes({});</span>
<a href="#l62.47"></a><span id="l62.47">     let attribute;</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineminus">-    while ((attribute = attributes.pop()) &amp;&amp; attribute)</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineminus">-    {</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineplus">+    while ((attribute = attributes.pop()) &amp;&amp; attribute) {</span>
<a href="#l62.51"></a><span id="l62.51">       let property = gValidityManager.getAttributeProperty(attribute);</span>
<a href="#l62.52"></a><span id="l62.52">       let valid = false;</span>
<a href="#l62.53"></a><span id="l62.53">       let localizedString;</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineminus">-      try</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineminus">-      {</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+      try {</span>
<a href="#l62.57"></a><span id="l62.57">         localizedString = gStringBundle.GetStringFromName(property);</span>
<a href="#l62.58"></a><span id="l62.58">         valid = true;</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineminus">-      }</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineminus">-      catch (e)</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineminus">-      {</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineplus">+      } catch (e) {</span>
<a href="#l62.63"></a><span id="l62.63">         dump(&quot;\n&quot; + e);</span>
<a href="#l62.64"></a><span id="l62.64">       }</span>
<a href="#l62.65"></a><span id="l62.65">       valid = valid &amp;&amp; localizedString &amp;&amp; (localizedString.length &gt; 0);</span>
<a href="#l62.66"></a><span id="l62.66">       if (!valid)</span>
<a href="#l62.67"></a><span id="l62.67">         dump(&quot;\nNo valid property for scope = &quot; + scope</span>
<a href="#l62.68"></a><span id="l62.68">               + &quot; attribute = &quot; + attribute</span>
<a href="#l62.69"></a><span id="l62.69">               + &quot; property = &quot; + property);</span>
<a href="#l62.70"></a><span id="l62.70">       Assert.ok(valid);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchTag.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchTag.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -4,287 +4,344 @@</span>
<a href="#l63.4"></a><span id="l63.4"> </span>
<a href="#l63.5"></a><span id="l63.5"> /*</span>
<a href="#l63.6"></a><span id="l63.6">  * Testing of tag search features.</span>
<a href="#l63.7"></a><span id="l63.7">  *</span>
<a href="#l63.8"></a><span id="l63.8">  * Specifically tests changes implemented in bug 217034</span>
<a href="#l63.9"></a><span id="l63.9">  * Does not do comprehensive testing.</span>
<a href="#l63.10"></a><span id="l63.10">  *</span>
<a href="#l63.11"></a><span id="l63.11">  */</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l63.13"></a><span id="l63.13"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l63.14"></a><span id="l63.14"> </span>
<a href="#l63.15"></a><span id="l63.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l63.16"></a><span id="l63.16"> </span>
<a href="#l63.17"></a><span id="l63.17" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+var IsEmpty = Ci.nsMsgSearchOp.IsEmpty;</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineplus">+var IsntEmpty = Ci.nsMsgSearchOp.IsntEmpty;</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+var Contains = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+var DoesntContain = Ci.nsMsgSearchOp.DoesntContain;</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+var IsBefore = Ci.nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineminus">-var IsEmpty = nsMsgSearchOp.IsEmpty;</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-var IsntEmpty = nsMsgSearchOp.IsntEmpty;</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineminus">-var Contains = nsMsgSearchOp.Contains;</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineminus">-var DoesntContain = nsMsgSearchOp.DoesntContain;</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineminus">-var IsBefore = nsMsgSearchOp.IsBefore; // control entry not enabled</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+var offlineMail = Ci.nsMsgSearchScope.offlineMail;</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineplus">+var onlineMail = Ci.nsMsgSearchScope.onlineMail;</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineplus">+var offlineMailFilter = Ci.nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineplus">+var onlineMailFilter = Ci.nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineplus">+var news = Ci.nsMsgSearchScope.news; // control entry not enabled</span>
<a href="#l63.40"></a><span id="l63.40"> </span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-var offlineMail = nsMsgSearchScope.offlineMail;</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-var onlineMail = nsMsgSearchScope.onlineMail;</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-var offlineMailFilter = nsMsgSearchScope.offlineMailFilter;</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineminus">-var onlineMailFilter = nsMsgSearchScope.onlineMailFilter;</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineminus">-var news = nsMsgSearchScope.news; // control entry not enabled</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineminus">-</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-var Keywords = nsMsgSearchAttrib.Keywords;</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineplus">+var Keywords = Ci.nsMsgSearchAttrib.Keywords;</span>
<a href="#l63.49"></a><span id="l63.49"> </span>
<a href="#l63.50"></a><span id="l63.50"> // test tags</span>
<a href="#l63.51"></a><span id="l63.51"> var Tag1 = &quot;istag&quot;;</span>
<a href="#l63.52"></a><span id="l63.52"> var Tag2 = &quot;notistag&quot;;</span>
<a href="#l63.53"></a><span id="l63.53"> var Tag3 = &quot;istagnot&quot;;</span>
<a href="#l63.54"></a><span id="l63.54"> var Tag4 = &quot;istagtoo&quot;;</span>
<a href="#l63.55"></a><span id="l63.55"> var Tag1Tag4 = Tag1 + &quot; &quot; + Tag4;</span>
<a href="#l63.56"></a><span id="l63.56"> var Tag1Tag3 = Tag1 + &quot; &quot; + Tag3;</span>
<a href="#l63.57"></a><span id="l63.57"> var Tag1Tag1 = Tag1 + &quot; &quot; + Tag1;</span>
<a href="#l63.58"></a><span id="l63.58"> </span>
<a href="#l63.59"></a><span id="l63.59" class="difflineminus">-var Tests =</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineminus">-[</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineminus">-// Message has a single valid tag</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineplus">+var Tests = [</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineplus">+  // Message has a single valid tag</span>
<a href="#l63.64"></a><span id="l63.64">   // test the valid tag</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineminus">-  { msgTag: Tag1,</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineplus">+  {</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineplus">+    msgTag: Tag1,</span>
<a href="#l63.68"></a><span id="l63.68">     testTag: Tag1,</span>
<a href="#l63.69"></a><span id="l63.69">     op: Is,</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineminus">-    count: 1 },</span>
<a href="#l63.71"></a><span id="l63.71" class="difflineminus">-  { msgTag: Tag1,</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineplus">+    count: 1,</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineplus">+  }, {</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineplus">+    msgTag: Tag1,</span>
<a href="#l63.75"></a><span id="l63.75">     testTag: Tag1,</span>
<a href="#l63.76"></a><span id="l63.76">     op: Isnt,</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineminus">-    count: 0 },</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineminus">-  { msgTag: Tag1,</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineplus">+    count: 0,</span>
<a href="#l63.80"></a><span id="l63.80" class="difflineplus">+  }, {</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineplus">+    msgTag: Tag1,</span>
<a href="#l63.82"></a><span id="l63.82">     testTag: Tag1,</span>
<a href="#l63.83"></a><span id="l63.83">     op: Contains,</span>
<a href="#l63.84"></a><span id="l63.84" class="difflineminus">-    count: 1 },</span>
<a href="#l63.85"></a><span id="l63.85" class="difflineminus">-  { msgTag: Tag1,</span>
<a href="#l63.86"></a><span id="l63.86" class="difflineplus">+    count: 1,</span>
<a href="#l63.87"></a><span id="l63.87" class="difflineplus">+  }, {</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineplus">+    msgTag: Tag1,</span>
<a href="#l63.89"></a><span id="l63.89">     testTag: Tag1,</span>
<a href="#l63.90"></a><span id="l63.90">     op: DoesntContain,</span>
<a href="#l63.91"></a><span id="l63.91" class="difflineminus">-    count: 0 },</span>
<a href="#l63.92"></a><span id="l63.92" class="difflineminus">-  { msgTag: Tag1,</span>
<a href="#l63.93"></a><span id="l63.93" class="difflineplus">+    count: 0,</span>
<a href="#l63.94"></a><span id="l63.94" class="difflineplus">+  }, {</span>
<a href="#l63.95"></a><span id="l63.95" class="difflineplus">+    msgTag: Tag1,</span>
<a href="#l63.96"></a><span id="l63.96">     testTag: Tag1,</span>
<a href="#l63.97"></a><span id="l63.97">     op: IsEmpty,</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineminus">-    count: 0 },</span>
<a href="#l63.99"></a><span id="l63.99" class="difflineminus">-  { msgTag: Tag1,</span>
<a href="#l63.100"></a><span id="l63.100" class="difflineplus">+    count: 0,</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineplus">+  }, {</span>
<a href="#l63.102"></a><span id="l63.102" class="difflineplus">+    msgTag: Tag1,</span>
<a href="#l63.103"></a><span id="l63.103">     testTag: Tag1,</span>
<a href="#l63.104"></a><span id="l63.104">     op: IsntEmpty,</span>
<a href="#l63.105"></a><span id="l63.105" class="difflineminus">-    count: 1 },</span>
<a href="#l63.106"></a><span id="l63.106" class="difflineminus">-  //test an invalid tag, should act like empty</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineminus">-  { msgTag: Tag2,</span>
<a href="#l63.108"></a><span id="l63.108" class="difflineplus">+    count: 1,</span>
<a href="#l63.109"></a><span id="l63.109" class="difflineplus">+  },</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineplus">+  // test an invalid tag, should act like empty</span>
<a href="#l63.111"></a><span id="l63.111" class="difflineplus">+  {</span>
<a href="#l63.112"></a><span id="l63.112" class="difflineplus">+    msgTag: Tag2,</span>
<a href="#l63.113"></a><span id="l63.113">     testTag: Tag1,</span>
<a href="#l63.114"></a><span id="l63.114">     op: Contains,</span>
<a href="#l63.115"></a><span id="l63.115" class="difflineminus">-    count: 0 },</span>
<a href="#l63.116"></a><span id="l63.116" class="difflineminus">-  { msgTag: Tag2,</span>
<a href="#l63.117"></a><span id="l63.117" class="difflineplus">+    count: 0,</span>
<a href="#l63.118"></a><span id="l63.118" class="difflineplus">+  }, {</span>
<a href="#l63.119"></a><span id="l63.119" class="difflineplus">+    msgTag: Tag2,</span>
<a href="#l63.120"></a><span id="l63.120">     testTag: Tag1,</span>
<a href="#l63.121"></a><span id="l63.121">     op: DoesntContain,</span>
<a href="#l63.122"></a><span id="l63.122" class="difflineminus">-    count: 1 },</span>
<a href="#l63.123"></a><span id="l63.123" class="difflineminus">-  { msgTag: Tag2,</span>
<a href="#l63.124"></a><span id="l63.124" class="difflineplus">+    count: 1,</span>
<a href="#l63.125"></a><span id="l63.125" class="difflineplus">+  }, {</span>
<a href="#l63.126"></a><span id="l63.126" class="difflineplus">+    msgTag: Tag2,</span>
<a href="#l63.127"></a><span id="l63.127">     testTag: Tag1,</span>
<a href="#l63.128"></a><span id="l63.128">     op: Is,</span>
<a href="#l63.129"></a><span id="l63.129" class="difflineminus">-    count: 0 },</span>
<a href="#l63.130"></a><span id="l63.130" class="difflineminus">-  { msgTag: Tag2,</span>
<a href="#l63.131"></a><span id="l63.131" class="difflineplus">+    count: 0,</span>
<a href="#l63.132"></a><span id="l63.132" class="difflineplus">+  }, {</span>
<a href="#l63.133"></a><span id="l63.133" class="difflineplus">+    msgTag: Tag2,</span>
<a href="#l63.134"></a><span id="l63.134">     testTag: Tag1,</span>
<a href="#l63.135"></a><span id="l63.135">     op: Isnt,</span>
<a href="#l63.136"></a><span id="l63.136" class="difflineminus">-    count: 1 },</span>
<a href="#l63.137"></a><span id="l63.137" class="difflineminus">-  { msgTag: Tag2,</span>
<a href="#l63.138"></a><span id="l63.138" class="difflineplus">+    count: 1,</span>
<a href="#l63.139"></a><span id="l63.139" class="difflineplus">+  }, {</span>
<a href="#l63.140"></a><span id="l63.140" class="difflineplus">+    msgTag: Tag2,</span>
<a href="#l63.141"></a><span id="l63.141">     testTag: Tag1,</span>
<a href="#l63.142"></a><span id="l63.142">     op: IsEmpty,</span>
<a href="#l63.143"></a><span id="l63.143" class="difflineminus">-    count: 1 },</span>
<a href="#l63.144"></a><span id="l63.144" class="difflineminus">-  { msgTag: Tag2,</span>
<a href="#l63.145"></a><span id="l63.145" class="difflineplus">+    count: 1,</span>
<a href="#l63.146"></a><span id="l63.146" class="difflineplus">+  }, {</span>
<a href="#l63.147"></a><span id="l63.147" class="difflineplus">+    msgTag: Tag2,</span>
<a href="#l63.148"></a><span id="l63.148">     testTag: Tag1,</span>
<a href="#l63.149"></a><span id="l63.149">     op: IsntEmpty,</span>
<a href="#l63.150"></a><span id="l63.150" class="difflineminus">-    count: 0 },</span>
<a href="#l63.151"></a><span id="l63.151" class="difflineminus">-//   Message has two valid tags</span>
<a href="#l63.152"></a><span id="l63.152" class="difflineplus">+    count: 0,</span>
<a href="#l63.153"></a><span id="l63.153" class="difflineplus">+  },</span>
<a href="#l63.154"></a><span id="l63.154" class="difflineplus">+  // Message has two valid tags</span>
<a href="#l63.155"></a><span id="l63.155">   // test first tag</span>
<a href="#l63.156"></a><span id="l63.156" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.157"></a><span id="l63.157" class="difflineplus">+  {</span>
<a href="#l63.158"></a><span id="l63.158" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.159"></a><span id="l63.159">     testTag: Tag1,</span>
<a href="#l63.160"></a><span id="l63.160">     op: Is,</span>
<a href="#l63.161"></a><span id="l63.161" class="difflineminus">-    count: 0 },</span>
<a href="#l63.162"></a><span id="l63.162" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.163"></a><span id="l63.163" class="difflineplus">+    count: 0,</span>
<a href="#l63.164"></a><span id="l63.164" class="difflineplus">+  }, {</span>
<a href="#l63.165"></a><span id="l63.165" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.166"></a><span id="l63.166">     testTag: Tag1,</span>
<a href="#l63.167"></a><span id="l63.167">     op: Isnt,</span>
<a href="#l63.168"></a><span id="l63.168" class="difflineminus">-    count: 1 },</span>
<a href="#l63.169"></a><span id="l63.169" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.170"></a><span id="l63.170" class="difflineplus">+    count: 1,</span>
<a href="#l63.171"></a><span id="l63.171" class="difflineplus">+  }, {</span>
<a href="#l63.172"></a><span id="l63.172" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.173"></a><span id="l63.173">     testTag: Tag1,</span>
<a href="#l63.174"></a><span id="l63.174">     op: Contains,</span>
<a href="#l63.175"></a><span id="l63.175" class="difflineminus">-    count: 1 },</span>
<a href="#l63.176"></a><span id="l63.176" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.177"></a><span id="l63.177" class="difflineplus">+    count: 1,</span>
<a href="#l63.178"></a><span id="l63.178" class="difflineplus">+  }, {</span>
<a href="#l63.179"></a><span id="l63.179" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.180"></a><span id="l63.180">     testTag: Tag1,</span>
<a href="#l63.181"></a><span id="l63.181">     op: DoesntContain,</span>
<a href="#l63.182"></a><span id="l63.182" class="difflineminus">-    count: 0 },</span>
<a href="#l63.183"></a><span id="l63.183" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.184"></a><span id="l63.184" class="difflineplus">+    count: 0,</span>
<a href="#l63.185"></a><span id="l63.185" class="difflineplus">+  }, {</span>
<a href="#l63.186"></a><span id="l63.186" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.187"></a><span id="l63.187">     testTag: Tag1,</span>
<a href="#l63.188"></a><span id="l63.188">     op: IsEmpty,</span>
<a href="#l63.189"></a><span id="l63.189" class="difflineminus">-    count: 0 },</span>
<a href="#l63.190"></a><span id="l63.190" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.191"></a><span id="l63.191" class="difflineplus">+    count: 0,</span>
<a href="#l63.192"></a><span id="l63.192" class="difflineplus">+  }, {</span>
<a href="#l63.193"></a><span id="l63.193" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.194"></a><span id="l63.194">     testTag: Tag1,</span>
<a href="#l63.195"></a><span id="l63.195">     op: IsntEmpty,</span>
<a href="#l63.196"></a><span id="l63.196" class="difflineminus">-    count: 1 },</span>
<a href="#l63.197"></a><span id="l63.197" class="difflineplus">+    count: 1,</span>
<a href="#l63.198"></a><span id="l63.198" class="difflineplus">+  },</span>
<a href="#l63.199"></a><span id="l63.199">   // test second tag</span>
<a href="#l63.200"></a><span id="l63.200" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.201"></a><span id="l63.201" class="difflineplus">+  {</span>
<a href="#l63.202"></a><span id="l63.202" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.203"></a><span id="l63.203">     testTag: Tag4,</span>
<a href="#l63.204"></a><span id="l63.204">     op: Is,</span>
<a href="#l63.205"></a><span id="l63.205" class="difflineminus">-    count: 0 },</span>
<a href="#l63.206"></a><span id="l63.206" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.207"></a><span id="l63.207" class="difflineplus">+    count: 0,</span>
<a href="#l63.208"></a><span id="l63.208" class="difflineplus">+  }, {</span>
<a href="#l63.209"></a><span id="l63.209" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.210"></a><span id="l63.210">     testTag: Tag4,</span>
<a href="#l63.211"></a><span id="l63.211">     op: Isnt,</span>
<a href="#l63.212"></a><span id="l63.212" class="difflineminus">-    count: 1 },</span>
<a href="#l63.213"></a><span id="l63.213" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.214"></a><span id="l63.214" class="difflineplus">+    count: 1,</span>
<a href="#l63.215"></a><span id="l63.215" class="difflineplus">+  }, {</span>
<a href="#l63.216"></a><span id="l63.216" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.217"></a><span id="l63.217">     testTag: Tag4,</span>
<a href="#l63.218"></a><span id="l63.218">     op: Contains,</span>
<a href="#l63.219"></a><span id="l63.219" class="difflineminus">-    count: 1 },</span>
<a href="#l63.220"></a><span id="l63.220" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.221"></a><span id="l63.221" class="difflineplus">+    count: 1,</span>
<a href="#l63.222"></a><span id="l63.222" class="difflineplus">+  }, {</span>
<a href="#l63.223"></a><span id="l63.223" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.224"></a><span id="l63.224">     testTag: Tag4,</span>
<a href="#l63.225"></a><span id="l63.225">     op: DoesntContain,</span>
<a href="#l63.226"></a><span id="l63.226" class="difflineminus">-    count: 0 },</span>
<a href="#l63.227"></a><span id="l63.227" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.228"></a><span id="l63.228" class="difflineplus">+    count: 0,</span>
<a href="#l63.229"></a><span id="l63.229" class="difflineplus">+  }, {</span>
<a href="#l63.230"></a><span id="l63.230" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.231"></a><span id="l63.231">     testTag: Tag4,</span>
<a href="#l63.232"></a><span id="l63.232">     op: IsEmpty,</span>
<a href="#l63.233"></a><span id="l63.233" class="difflineminus">-    count: 0 },</span>
<a href="#l63.234"></a><span id="l63.234" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.235"></a><span id="l63.235" class="difflineplus">+    count: 0,</span>
<a href="#l63.236"></a><span id="l63.236" class="difflineplus">+  }, {</span>
<a href="#l63.237"></a><span id="l63.237" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.238"></a><span id="l63.238">     testTag: Tag4,</span>
<a href="#l63.239"></a><span id="l63.239">     op: IsntEmpty,</span>
<a href="#l63.240"></a><span id="l63.240" class="difflineminus">-    count: 1 },</span>
<a href="#l63.241"></a><span id="l63.241" class="difflineplus">+    count: 1,</span>
<a href="#l63.242"></a><span id="l63.242" class="difflineplus">+  },</span>
<a href="#l63.243"></a><span id="l63.243">   // test tag not in message</span>
<a href="#l63.244"></a><span id="l63.244" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.245"></a><span id="l63.245" class="difflineplus">+  {</span>
<a href="#l63.246"></a><span id="l63.246" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.247"></a><span id="l63.247">     testTag: Tag2,</span>
<a href="#l63.248"></a><span id="l63.248">     op: Is,</span>
<a href="#l63.249"></a><span id="l63.249" class="difflineminus">-    count: 0 },</span>
<a href="#l63.250"></a><span id="l63.250" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.251"></a><span id="l63.251" class="difflineplus">+    count: 0,</span>
<a href="#l63.252"></a><span id="l63.252" class="difflineplus">+  }, {</span>
<a href="#l63.253"></a><span id="l63.253" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.254"></a><span id="l63.254">     testTag: Tag2,</span>
<a href="#l63.255"></a><span id="l63.255">     op: Isnt,</span>
<a href="#l63.256"></a><span id="l63.256" class="difflineminus">-    count: 1 },</span>
<a href="#l63.257"></a><span id="l63.257" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.258"></a><span id="l63.258" class="difflineplus">+    count: 1,</span>
<a href="#l63.259"></a><span id="l63.259" class="difflineplus">+  }, {</span>
<a href="#l63.260"></a><span id="l63.260" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.261"></a><span id="l63.261">     testTag: Tag2,</span>
<a href="#l63.262"></a><span id="l63.262">     op: Contains,</span>
<a href="#l63.263"></a><span id="l63.263" class="difflineminus">-    count: 0 },</span>
<a href="#l63.264"></a><span id="l63.264" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.265"></a><span id="l63.265" class="difflineplus">+    count: 0,</span>
<a href="#l63.266"></a><span id="l63.266" class="difflineplus">+  }, {</span>
<a href="#l63.267"></a><span id="l63.267" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.268"></a><span id="l63.268">     testTag: Tag2,</span>
<a href="#l63.269"></a><span id="l63.269">     op: DoesntContain,</span>
<a href="#l63.270"></a><span id="l63.270" class="difflineminus">-    count: 1 },</span>
<a href="#l63.271"></a><span id="l63.271" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.272"></a><span id="l63.272" class="difflineplus">+    count: 1,</span>
<a href="#l63.273"></a><span id="l63.273" class="difflineplus">+  }, {</span>
<a href="#l63.274"></a><span id="l63.274" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.275"></a><span id="l63.275">     testTag: Tag2,</span>
<a href="#l63.276"></a><span id="l63.276">     op: IsEmpty,</span>
<a href="#l63.277"></a><span id="l63.277" class="difflineminus">-    count: 0 },</span>
<a href="#l63.278"></a><span id="l63.278" class="difflineminus">-  { msgTag: Tag1Tag4,</span>
<a href="#l63.279"></a><span id="l63.279" class="difflineplus">+    count: 0,</span>
<a href="#l63.280"></a><span id="l63.280" class="difflineplus">+  }, {</span>
<a href="#l63.281"></a><span id="l63.281" class="difflineplus">+    msgTag: Tag1Tag4,</span>
<a href="#l63.282"></a><span id="l63.282">     testTag: Tag2,</span>
<a href="#l63.283"></a><span id="l63.283">     op: IsntEmpty,</span>
<a href="#l63.284"></a><span id="l63.284" class="difflineminus">-    count: 1 },</span>
<a href="#l63.285"></a><span id="l63.285" class="difflineplus">+    count: 1,</span>
<a href="#l63.286"></a><span id="l63.286" class="difflineplus">+  },</span>
<a href="#l63.287"></a><span id="l63.287">   // empty message</span>
<a href="#l63.288"></a><span id="l63.288" class="difflineminus">-  { msgTag: &quot;&quot;,</span>
<a href="#l63.289"></a><span id="l63.289" class="difflineplus">+  {</span>
<a href="#l63.290"></a><span id="l63.290" class="difflineplus">+    msgTag: &quot;&quot;,</span>
<a href="#l63.291"></a><span id="l63.291">     testTag: Tag2,</span>
<a href="#l63.292"></a><span id="l63.292">     op: Is,</span>
<a href="#l63.293"></a><span id="l63.293" class="difflineminus">-    count: 0 },</span>
<a href="#l63.294"></a><span id="l63.294" class="difflineminus">-  { msgTag: &quot;&quot;,</span>
<a href="#l63.295"></a><span id="l63.295" class="difflineplus">+    count: 0,</span>
<a href="#l63.296"></a><span id="l63.296" class="difflineplus">+  }, {</span>
<a href="#l63.297"></a><span id="l63.297" class="difflineplus">+    msgTag: &quot;&quot;,</span>
<a href="#l63.298"></a><span id="l63.298">     testTag: Tag2,</span>
<a href="#l63.299"></a><span id="l63.299">     op: Isnt,</span>
<a href="#l63.300"></a><span id="l63.300" class="difflineminus">-    count: 1 },</span>
<a href="#l63.301"></a><span id="l63.301" class="difflineminus">-  { msgTag: &quot;&quot;,</span>
<a href="#l63.302"></a><span id="l63.302" class="difflineplus">+    count: 1,</span>
<a href="#l63.303"></a><span id="l63.303" class="difflineplus">+  }, {</span>
<a href="#l63.304"></a><span id="l63.304" class="difflineplus">+    msgTag: &quot;&quot;,</span>
<a href="#l63.305"></a><span id="l63.305">     testTag: Tag2,</span>
<a href="#l63.306"></a><span id="l63.306">     op: Contains,</span>
<a href="#l63.307"></a><span id="l63.307" class="difflineminus">-    count: 0 },</span>
<a href="#l63.308"></a><span id="l63.308" class="difflineminus">-  { msgTag: &quot;&quot;,</span>
<a href="#l63.309"></a><span id="l63.309" class="difflineplus">+    count: 0,</span>
<a href="#l63.310"></a><span id="l63.310" class="difflineplus">+  }, {</span>
<a href="#l63.311"></a><span id="l63.311" class="difflineplus">+    msgTag: &quot;&quot;,</span>
<a href="#l63.312"></a><span id="l63.312">     testTag: Tag2,</span>
<a href="#l63.313"></a><span id="l63.313">     op: DoesntContain,</span>
<a href="#l63.314"></a><span id="l63.314" class="difflineminus">-    count: 1 },</span>
<a href="#l63.315"></a><span id="l63.315" class="difflineminus">-  { msgTag: &quot;&quot;,</span>
<a href="#l63.316"></a><span id="l63.316" class="difflineplus">+    count: 1,</span>
<a href="#l63.317"></a><span id="l63.317" class="difflineplus">+  }, {</span>
<a href="#l63.318"></a><span id="l63.318" class="difflineplus">+    msgTag: &quot;&quot;,</span>
<a href="#l63.319"></a><span id="l63.319">     testTag: Tag2,</span>
<a href="#l63.320"></a><span id="l63.320">     op: IsEmpty,</span>
<a href="#l63.321"></a><span id="l63.321" class="difflineminus">-    count: 1 },</span>
<a href="#l63.322"></a><span id="l63.322" class="difflineminus">-  { msgTag: &quot;&quot;,</span>
<a href="#l63.323"></a><span id="l63.323" class="difflineplus">+    count: 1,</span>
<a href="#l63.324"></a><span id="l63.324" class="difflineplus">+  }, {</span>
<a href="#l63.325"></a><span id="l63.325" class="difflineplus">+    msgTag: &quot;&quot;,</span>
<a href="#l63.326"></a><span id="l63.326">     testTag: Tag2,</span>
<a href="#l63.327"></a><span id="l63.327">     op: IsntEmpty,</span>
<a href="#l63.328"></a><span id="l63.328" class="difflineminus">-    count: 0 },</span>
<a href="#l63.329"></a><span id="l63.329" class="difflineminus">-// message with two tags, only one is valid</span>
<a href="#l63.330"></a><span id="l63.330" class="difflineplus">+    count: 0,</span>
<a href="#l63.331"></a><span id="l63.331" class="difflineplus">+  },</span>
<a href="#l63.332"></a><span id="l63.332" class="difflineplus">+  // message with two tags, only one is valid</span>
<a href="#l63.333"></a><span id="l63.333">   // test with the single valid tag</span>
<a href="#l63.334"></a><span id="l63.334" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.335"></a><span id="l63.335" class="difflineplus">+  {</span>
<a href="#l63.336"></a><span id="l63.336" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.337"></a><span id="l63.337">     testTag: Tag1,</span>
<a href="#l63.338"></a><span id="l63.338">     op: Is,</span>
<a href="#l63.339"></a><span id="l63.339" class="difflineminus">-    count: 1 },</span>
<a href="#l63.340"></a><span id="l63.340" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.341"></a><span id="l63.341" class="difflineplus">+    count: 1,</span>
<a href="#l63.342"></a><span id="l63.342" class="difflineplus">+  }, {</span>
<a href="#l63.343"></a><span id="l63.343" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.344"></a><span id="l63.344">     testTag: Tag1,</span>
<a href="#l63.345"></a><span id="l63.345">     op: Isnt,</span>
<a href="#l63.346"></a><span id="l63.346" class="difflineminus">-    count: 0 },</span>
<a href="#l63.347"></a><span id="l63.347" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.348"></a><span id="l63.348" class="difflineplus">+    count: 0,</span>
<a href="#l63.349"></a><span id="l63.349" class="difflineplus">+  }, {</span>
<a href="#l63.350"></a><span id="l63.350" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.351"></a><span id="l63.351">     testTag: Tag1,</span>
<a href="#l63.352"></a><span id="l63.352">     op: Contains,</span>
<a href="#l63.353"></a><span id="l63.353" class="difflineminus">-    count: 1 },</span>
<a href="#l63.354"></a><span id="l63.354" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.355"></a><span id="l63.355" class="difflineplus">+    count: 1,</span>
<a href="#l63.356"></a><span id="l63.356" class="difflineplus">+  }, {</span>
<a href="#l63.357"></a><span id="l63.357" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.358"></a><span id="l63.358">     testTag: Tag1,</span>
<a href="#l63.359"></a><span id="l63.359">     op: DoesntContain,</span>
<a href="#l63.360"></a><span id="l63.360" class="difflineminus">-    count: 0 },</span>
<a href="#l63.361"></a><span id="l63.361" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.362"></a><span id="l63.362" class="difflineplus">+    count: 0,</span>
<a href="#l63.363"></a><span id="l63.363" class="difflineplus">+  }, {</span>
<a href="#l63.364"></a><span id="l63.364" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.365"></a><span id="l63.365">     testTag: Tag1,</span>
<a href="#l63.366"></a><span id="l63.366">     op: IsEmpty,</span>
<a href="#l63.367"></a><span id="l63.367" class="difflineminus">-    count: 0 },</span>
<a href="#l63.368"></a><span id="l63.368" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.369"></a><span id="l63.369" class="difflineplus">+    count: 0,</span>
<a href="#l63.370"></a><span id="l63.370" class="difflineplus">+  }, {</span>
<a href="#l63.371"></a><span id="l63.371" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.372"></a><span id="l63.372">     testTag: Tag1,</span>
<a href="#l63.373"></a><span id="l63.373">     op: IsntEmpty,</span>
<a href="#l63.374"></a><span id="l63.374" class="difflineminus">-    count: 1 },</span>
<a href="#l63.375"></a><span id="l63.375" class="difflineplus">+    count: 1,</span>
<a href="#l63.376"></a><span id="l63.376" class="difflineplus">+  },</span>
<a href="#l63.377"></a><span id="l63.377">   // test with a tag not in the message</span>
<a href="#l63.378"></a><span id="l63.378" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.379"></a><span id="l63.379" class="difflineplus">+  {</span>
<a href="#l63.380"></a><span id="l63.380" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.381"></a><span id="l63.381">     testTag: Tag2,</span>
<a href="#l63.382"></a><span id="l63.382">     op: Is,</span>
<a href="#l63.383"></a><span id="l63.383" class="difflineminus">-    count: 0 },</span>
<a href="#l63.384"></a><span id="l63.384" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.385"></a><span id="l63.385" class="difflineplus">+    count: 0,</span>
<a href="#l63.386"></a><span id="l63.386" class="difflineplus">+  }, {</span>
<a href="#l63.387"></a><span id="l63.387" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.388"></a><span id="l63.388">     testTag: Tag2,</span>
<a href="#l63.389"></a><span id="l63.389">     op: Isnt,</span>
<a href="#l63.390"></a><span id="l63.390" class="difflineminus">-    count: 1 },</span>
<a href="#l63.391"></a><span id="l63.391" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.392"></a><span id="l63.392" class="difflineplus">+    count: 1,</span>
<a href="#l63.393"></a><span id="l63.393" class="difflineplus">+  }, {</span>
<a href="#l63.394"></a><span id="l63.394" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.395"></a><span id="l63.395">     testTag: Tag2,</span>
<a href="#l63.396"></a><span id="l63.396">     op: Contains,</span>
<a href="#l63.397"></a><span id="l63.397" class="difflineminus">-    count: 0 },</span>
<a href="#l63.398"></a><span id="l63.398" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.399"></a><span id="l63.399" class="difflineplus">+    count: 0,</span>
<a href="#l63.400"></a><span id="l63.400" class="difflineplus">+  }, {</span>
<a href="#l63.401"></a><span id="l63.401" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.402"></a><span id="l63.402">     testTag: Tag2,</span>
<a href="#l63.403"></a><span id="l63.403">     op: DoesntContain,</span>
<a href="#l63.404"></a><span id="l63.404" class="difflineminus">-    count: 1 },</span>
<a href="#l63.405"></a><span id="l63.405" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.406"></a><span id="l63.406" class="difflineplus">+    count: 1,</span>
<a href="#l63.407"></a><span id="l63.407" class="difflineplus">+  }, {</span>
<a href="#l63.408"></a><span id="l63.408" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.409"></a><span id="l63.409">     testTag: Tag2,</span>
<a href="#l63.410"></a><span id="l63.410">     op: IsEmpty,</span>
<a href="#l63.411"></a><span id="l63.411" class="difflineminus">-    count: 0 },</span>
<a href="#l63.412"></a><span id="l63.412" class="difflineminus">-  { msgTag: Tag1Tag3,</span>
<a href="#l63.413"></a><span id="l63.413" class="difflineplus">+    count: 0,</span>
<a href="#l63.414"></a><span id="l63.414" class="difflineplus">+  }, {</span>
<a href="#l63.415"></a><span id="l63.415" class="difflineplus">+    msgTag: Tag1Tag3,</span>
<a href="#l63.416"></a><span id="l63.416">     testTag: Tag2,</span>
<a href="#l63.417"></a><span id="l63.417">     op: IsntEmpty,</span>
<a href="#l63.418"></a><span id="l63.418" class="difflineminus">-    count: 1 },</span>
<a href="#l63.419"></a><span id="l63.419" class="difflineminus">-//   Message has a duplicated tag</span>
<a href="#l63.420"></a><span id="l63.420" class="difflineplus">+    count: 1,</span>
<a href="#l63.421"></a><span id="l63.421" class="difflineplus">+  },</span>
<a href="#l63.422"></a><span id="l63.422" class="difflineplus">+  // Message has a duplicated tag</span>
<a href="#l63.423"></a><span id="l63.423">   // test the tag</span>
<a href="#l63.424"></a><span id="l63.424" class="difflineminus">-  { msgTag: Tag1Tag1,</span>
<a href="#l63.425"></a><span id="l63.425" class="difflineplus">+  {</span>
<a href="#l63.426"></a><span id="l63.426" class="difflineplus">+    msgTag: Tag1Tag1,</span>
<a href="#l63.427"></a><span id="l63.427">     testTag: Tag1,</span>
<a href="#l63.428"></a><span id="l63.428">     op: Is,</span>
<a href="#l63.429"></a><span id="l63.429" class="difflineminus">-    count: 1 },</span>
<a href="#l63.430"></a><span id="l63.430" class="difflineminus">-  { msgTag: Tag1Tag1,</span>
<a href="#l63.431"></a><span id="l63.431" class="difflineplus">+    count: 1,</span>
<a href="#l63.432"></a><span id="l63.432" class="difflineplus">+  }, {</span>
<a href="#l63.433"></a><span id="l63.433" class="difflineplus">+    msgTag: Tag1Tag1,</span>
<a href="#l63.434"></a><span id="l63.434">     testTag: Tag1,</span>
<a href="#l63.435"></a><span id="l63.435">     op: Isnt,</span>
<a href="#l63.436"></a><span id="l63.436" class="difflineminus">-    count: 0 },</span>
<a href="#l63.437"></a><span id="l63.437" class="difflineminus">-  { msgTag: Tag1Tag1,</span>
<a href="#l63.438"></a><span id="l63.438" class="difflineplus">+    count: 0,</span>
<a href="#l63.439"></a><span id="l63.439" class="difflineplus">+  }, {</span>
<a href="#l63.440"></a><span id="l63.440" class="difflineplus">+    msgTag: Tag1Tag1,</span>
<a href="#l63.441"></a><span id="l63.441">     testTag: Tag1,</span>
<a href="#l63.442"></a><span id="l63.442">     op: Contains,</span>
<a href="#l63.443"></a><span id="l63.443" class="difflineminus">-    count: 1 },</span>
<a href="#l63.444"></a><span id="l63.444" class="difflineminus">-  { msgTag: Tag1Tag1,</span>
<a href="#l63.445"></a><span id="l63.445" class="difflineplus">+    count: 1,</span>
<a href="#l63.446"></a><span id="l63.446" class="difflineplus">+  }, {</span>
<a href="#l63.447"></a><span id="l63.447" class="difflineplus">+    msgTag: Tag1Tag1,</span>
<a href="#l63.448"></a><span id="l63.448">     testTag: Tag1,</span>
<a href="#l63.449"></a><span id="l63.449">     op: DoesntContain,</span>
<a href="#l63.450"></a><span id="l63.450" class="difflineminus">-    count: 0 },</span>
<a href="#l63.451"></a><span id="l63.451" class="difflineminus">-  { msgTag: Tag1Tag1,</span>
<a href="#l63.452"></a><span id="l63.452" class="difflineplus">+    count: 0,</span>
<a href="#l63.453"></a><span id="l63.453" class="difflineplus">+  }, {</span>
<a href="#l63.454"></a><span id="l63.454" class="difflineplus">+    msgTag: Tag1Tag1,</span>
<a href="#l63.455"></a><span id="l63.455">     testTag: Tag1,</span>
<a href="#l63.456"></a><span id="l63.456">     op: IsEmpty,</span>
<a href="#l63.457"></a><span id="l63.457" class="difflineminus">-    count: 0 },</span>
<a href="#l63.458"></a><span id="l63.458" class="difflineminus">-  { msgTag: Tag1Tag1,</span>
<a href="#l63.459"></a><span id="l63.459" class="difflineplus">+    count: 0,</span>
<a href="#l63.460"></a><span id="l63.460" class="difflineplus">+  }, {</span>
<a href="#l63.461"></a><span id="l63.461" class="difflineplus">+    msgTag: Tag1Tag1,</span>
<a href="#l63.462"></a><span id="l63.462">     testTag: Tag1,</span>
<a href="#l63.463"></a><span id="l63.463">     op: IsntEmpty,</span>
<a href="#l63.464"></a><span id="l63.464" class="difflineminus">-    count: 1 },</span>
<a href="#l63.465"></a><span id="l63.465" class="difflineminus">-</span>
<a href="#l63.466"></a><span id="l63.466" class="difflineplus">+    count: 1,</span>
<a href="#l63.467"></a><span id="l63.467" class="difflineplus">+  },</span>
<a href="#l63.468"></a><span id="l63.468"> ];</span>
<a href="#l63.469"></a><span id="l63.469"> </span>
<a href="#l63.470"></a><span id="l63.470"> var hdr;</span>
<a href="#l63.471"></a><span id="l63.471"> </span>
<a href="#l63.472"></a><span id="l63.472" class="difflineminus">-function run_test()</span>
<a href="#l63.473"></a><span id="l63.473" class="difflineminus">-{</span>
<a href="#l63.474"></a><span id="l63.474" class="difflineplus">+function run_test() {</span>
<a href="#l63.475"></a><span id="l63.475">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l63.476"></a><span id="l63.476"> </span>
<a href="#l63.477"></a><span id="l63.477">   // test that validity table terms are valid</span>
<a href="#l63.478"></a><span id="l63.478"> </span>
<a href="#l63.479"></a><span id="l63.479">   // offline mail table</span>
<a href="#l63.480"></a><span id="l63.480">   testValidityTable(offlineMail, Contains, Keywords, true);</span>
<a href="#l63.481"></a><span id="l63.481">   testValidityTable(offlineMail, DoesntContain, Keywords, true);</span>
<a href="#l63.482"></a><span id="l63.482">   testValidityTable(offlineMail, Is, Keywords, true);</span>
<a href="#l63.483"></a><span id="l63.483" class="difflineat">@@ -333,49 +390,42 @@ function run_test()</span>
<a href="#l63.484"></a><span id="l63.484">   let tagArray = MailServices.tags.getAllTags({});</span>
<a href="#l63.485"></a><span id="l63.485">   for (var i = 0; i &lt; tagArray.length; i++)</span>
<a href="#l63.486"></a><span id="l63.486">     MailServices.tags.deleteKey(tagArray[i].key);</span>
<a href="#l63.487"></a><span id="l63.487"> </span>
<a href="#l63.488"></a><span id="l63.488">   // add as valid tags Tag1 and Tag4</span>
<a href="#l63.489"></a><span id="l63.489">   MailServices.tags.addTagForKey(Tag1, Tag1, null, null);</span>
<a href="#l63.490"></a><span id="l63.490">   MailServices.tags.addTagForKey(Tag4, Tag4, null, null);</span>
<a href="#l63.491"></a><span id="l63.491"> </span>
<a href="#l63.492"></a><span id="l63.492" class="difflineminus">-  var copyListener =</span>
<a href="#l63.493"></a><span id="l63.493" class="difflineminus">-  {</span>
<a href="#l63.494"></a><span id="l63.494" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l63.495"></a><span id="l63.495" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l63.496"></a><span id="l63.496" class="difflineminus">-    SetMessageKey: function(aKey) {</span>
<a href="#l63.497"></a><span id="l63.497" class="difflineplus">+  var copyListener = {</span>
<a href="#l63.498"></a><span id="l63.498" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l63.499"></a><span id="l63.499" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l63.500"></a><span id="l63.500" class="difflineplus">+    SetMessageKey(aKey) {</span>
<a href="#l63.501"></a><span id="l63.501">       hdr = localAccountUtils.inboxFolder.GetMessageHeader(aKey);</span>
<a href="#l63.502"></a><span id="l63.502">     },</span>
<a href="#l63.503"></a><span id="l63.503" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l63.504"></a><span id="l63.504" class="difflineminus">-    OnStopCopy: function(aStatus) { testKeywordSearch();}</span>
<a href="#l63.505"></a><span id="l63.505" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l63.506"></a><span id="l63.506" class="difflineplus">+    OnStopCopy(aStatus) { testKeywordSearch(); },</span>
<a href="#l63.507"></a><span id="l63.507">   };</span>
<a href="#l63.508"></a><span id="l63.508"> </span>
<a href="#l63.509"></a><span id="l63.509">   // Get a message into the local filestore. function testKeywordSearch() continues the testing after the copy.</span>
<a href="#l63.510"></a><span id="l63.510">   var bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l63.511"></a><span id="l63.511">   do_test_pending();</span>
<a href="#l63.512"></a><span id="l63.512">   MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null,</span>
<a href="#l63.513"></a><span id="l63.513">                                     false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l63.514"></a><span id="l63.514"> }</span>
<a href="#l63.515"></a><span id="l63.515"> </span>
<a href="#l63.516"></a><span id="l63.516"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l63.517"></a><span id="l63.517" class="difflineminus">-var testObject;</span>
<a href="#l63.518"></a><span id="l63.518" class="difflineminus">-function testKeywordSearch()</span>
<a href="#l63.519"></a><span id="l63.519" class="difflineminus">-{</span>
<a href="#l63.520"></a><span id="l63.520" class="difflineplus">+function testKeywordSearch() {</span>
<a href="#l63.521"></a><span id="l63.521">   var test = Tests.shift();</span>
<a href="#l63.522"></a><span id="l63.522" class="difflineminus">-  if (test)</span>
<a href="#l63.523"></a><span id="l63.523" class="difflineminus">-  {</span>
<a href="#l63.524"></a><span id="l63.524" class="difflineplus">+  if (test) {</span>
<a href="#l63.525"></a><span id="l63.525">     hdr.setStringProperty(&quot;keywords&quot;, test.msgTag);</span>
<a href="#l63.526"></a><span id="l63.526" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l63.527"></a><span id="l63.527" class="difflineminus">-                         test.testTag,</span>
<a href="#l63.528"></a><span id="l63.528" class="difflineminus">-                         nsMsgSearchAttrib.Keywords,</span>
<a href="#l63.529"></a><span id="l63.529" class="difflineminus">-                         test.op,</span>
<a href="#l63.530"></a><span id="l63.530" class="difflineminus">-                         test.count,</span>
<a href="#l63.531"></a><span id="l63.531" class="difflineminus">-                         testKeywordSearch);</span>
<a href="#l63.532"></a><span id="l63.532" class="difflineminus">-  }</span>
<a href="#l63.533"></a><span id="l63.533" class="difflineminus">-  else</span>
<a href="#l63.534"></a><span id="l63.534" class="difflineminus">-  {</span>
<a href="#l63.535"></a><span id="l63.535" class="difflineminus">-    testObject = null;</span>
<a href="#l63.536"></a><span id="l63.536" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l63.537"></a><span id="l63.537" class="difflineplus">+                   test.testTag,</span>
<a href="#l63.538"></a><span id="l63.538" class="difflineplus">+                   Ci.nsMsgSearchAttrib.Keywords,</span>
<a href="#l63.539"></a><span id="l63.539" class="difflineplus">+                   test.op,</span>
<a href="#l63.540"></a><span id="l63.540" class="difflineplus">+                   test.count,</span>
<a href="#l63.541"></a><span id="l63.541" class="difflineplus">+                   testKeywordSearch);</span>
<a href="#l63.542"></a><span id="l63.542" class="difflineplus">+  } else {</span>
<a href="#l63.543"></a><span id="l63.543">     hdr = null;</span>
<a href="#l63.544"></a><span id="l63.544">     do_test_finished();</span>
<a href="#l63.545"></a><span id="l63.545">   }</span>
<a href="#l63.546"></a><span id="l63.546"> }</span>
<a href="#l63.547"></a><span id="l63.547"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/base/test/unit/test_searchUint32HdrProperty.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_searchUint32HdrProperty.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,119 +1,118 @@</span>
<a href="#l64.4"></a><span id="l64.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l64.5"></a><span id="l64.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l64.6"></a><span id="l64.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8"> /*</span>
<a href="#l64.9"></a><span id="l64.9">  * Testing of Uint32HdrProperty search attribute. Adapted from test_search.js</span>
<a href="#l64.10"></a><span id="l64.10">  */</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+/* import-globals-from ../../../test/resources/searchTestUtils.js */</span>
<a href="#l64.13"></a><span id="l64.13"> load(&quot;../../../resources/searchTestUtils.js&quot;);</span>
<a href="#l64.14"></a><span id="l64.14"> </span>
<a href="#l64.15"></a><span id="l64.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+var Isnt = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+var Is = Ci.nsMsgSearchOp.Is;</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+var IsGreaterThan = Ci.nsMsgSearchOp.IsGreaterThan;</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineplus">+var IsLessThan = Ci.nsMsgSearchOp.IsLessThan;</span>
<a href="#l64.23"></a><span id="l64.23"> </span>
<a href="#l64.24"></a><span id="l64.24" class="difflineminus">-var Isnt = nsMsgSearchOp.Isnt;</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineminus">-var Is = nsMsgSearchOp.Is;</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineminus">-var IsGreaterThan = nsMsgSearchOp.IsGreaterThan;</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineminus">-var IsLessThan = nsMsgSearchOp.IsLessThan;</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineminus">-</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineminus">-var Uint32HdrProperty = nsMsgSearchAttrib.Uint32HdrProperty;</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineminus">-</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineminus">-var Tests =</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineminus">-[</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+var Tests = [</span>
<a href="#l64.34"></a><span id="l64.34">   // test a property that does not exist</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineminus">-  { hdrProperty: &quot;idonotexist&quot;,</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineplus">+  {</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineplus">+    hdrProperty: &quot;idonotexist&quot;,</span>
<a href="#l64.38"></a><span id="l64.38">     op: Is,</span>
<a href="#l64.39"></a><span id="l64.39">     value: 1,</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineminus">-    count: 0 },</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineminus">-  { hdrProperty: &quot;idonotexist&quot;,</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineplus">+    count: 0,</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+  }, {</span>
<a href="#l64.44"></a><span id="l64.44" class="difflineplus">+    hdrProperty: &quot;idonotexist&quot;,</span>
<a href="#l64.45"></a><span id="l64.45">     op: Isnt,</span>
<a href="#l64.46"></a><span id="l64.46">     value: 1,</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineminus">-    count: 1 },</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineplus">+    count: 1,</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineplus">+  },</span>
<a href="#l64.50"></a><span id="l64.50">   // add a property and test its value</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineminus">-  { setup: function setupProperty() {</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+  {</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+    setup: function setupProperty() {</span>
<a href="#l64.54"></a><span id="l64.54">       let enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineminus">-      while(enumerator.hasMoreElements())</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+      while (enumerator.hasMoreElements())</span>
<a href="#l64.57"></a><span id="l64.57">         enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr).setUint32Property(&quot;iam23&quot;, 23);</span>
<a href="#l64.58"></a><span id="l64.58">     },</span>
<a href="#l64.59"></a><span id="l64.59">     hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.60"></a><span id="l64.60">     op: Is,</span>
<a href="#l64.61"></a><span id="l64.61">     value: 23,</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineminus">-    count: 1 },</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+    count: 1,</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+  }, {</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.67"></a><span id="l64.67">     op: Isnt,</span>
<a href="#l64.68"></a><span id="l64.68">     value: 23,</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineminus">-    count: 0 },</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+    count: 0,</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+  }, {</span>
<a href="#l64.73"></a><span id="l64.73" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.74"></a><span id="l64.74">     op: Is,</span>
<a href="#l64.75"></a><span id="l64.75">     value: 17,</span>
<a href="#l64.76"></a><span id="l64.76" class="difflineminus">-    count: 0 },</span>
<a href="#l64.77"></a><span id="l64.77" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineplus">+    count: 0,</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+  }, {</span>
<a href="#l64.80"></a><span id="l64.80" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.81"></a><span id="l64.81">     op: Isnt,</span>
<a href="#l64.82"></a><span id="l64.82">     value: 17,</span>
<a href="#l64.83"></a><span id="l64.83" class="difflineminus">-    count: 1 },</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineplus">+    count: 1,</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+  }, {</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.88"></a><span id="l64.88">     op: IsGreaterThan,</span>
<a href="#l64.89"></a><span id="l64.89">     value: 25,</span>
<a href="#l64.90"></a><span id="l64.90" class="difflineminus">-    count: 0 },</span>
<a href="#l64.91"></a><span id="l64.91" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineplus">+    count: 0,</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineplus">+  }, {</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.95"></a><span id="l64.95">     op: IsLessThan,</span>
<a href="#l64.96"></a><span id="l64.96">     value: 25,</span>
<a href="#l64.97"></a><span id="l64.97" class="difflineminus">-    count: 1 },</span>
<a href="#l64.98"></a><span id="l64.98" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.99"></a><span id="l64.99" class="difflineplus">+    count: 1,</span>
<a href="#l64.100"></a><span id="l64.100" class="difflineplus">+  }, {</span>
<a href="#l64.101"></a><span id="l64.101" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.102"></a><span id="l64.102">     op: IsGreaterThan,</span>
<a href="#l64.103"></a><span id="l64.103">     value: 17,</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineminus">-    count: 1 },</span>
<a href="#l64.105"></a><span id="l64.105" class="difflineminus">-  { hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.106"></a><span id="l64.106" class="difflineplus">+    count: 1,</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineplus">+  }, {</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineplus">+    hdrProperty: &quot;iam23&quot;,</span>
<a href="#l64.109"></a><span id="l64.109">     op: IsLessThan,</span>
<a href="#l64.110"></a><span id="l64.110">     value: 17,</span>
<a href="#l64.111"></a><span id="l64.111" class="difflineminus">-    count: 0 },</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineplus">+    count: 0,</span>
<a href="#l64.113"></a><span id="l64.113" class="difflineplus">+  },</span>
<a href="#l64.114"></a><span id="l64.114"> ];</span>
<a href="#l64.115"></a><span id="l64.115"> </span>
<a href="#l64.116"></a><span id="l64.116" class="difflineminus">-function run_test()</span>
<a href="#l64.117"></a><span id="l64.117" class="difflineminus">-{</span>
<a href="#l64.118"></a><span id="l64.118" class="difflineplus">+function run_test() {</span>
<a href="#l64.119"></a><span id="l64.119">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l64.120"></a><span id="l64.120"> </span>
<a href="#l64.121"></a><span id="l64.121" class="difflineminus">-  var copyListener =</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineminus">-  {</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l64.124"></a><span id="l64.124" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l64.125"></a><span id="l64.125" class="difflineminus">-    SetMessageKey: function(aKey) {},</span>
<a href="#l64.126"></a><span id="l64.126" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l64.127"></a><span id="l64.127" class="difflineminus">-    OnStopCopy: function(aStatus) { testSearch();}</span>
<a href="#l64.128"></a><span id="l64.128" class="difflineplus">+  var copyListener = {</span>
<a href="#l64.129"></a><span id="l64.129" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l64.130"></a><span id="l64.130" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l64.131"></a><span id="l64.131" class="difflineplus">+    SetMessageKey(aKey) {},</span>
<a href="#l64.132"></a><span id="l64.132" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l64.133"></a><span id="l64.133" class="difflineplus">+    OnStopCopy(aStatus) { testSearch(); },</span>
<a href="#l64.134"></a><span id="l64.134">   };</span>
<a href="#l64.135"></a><span id="l64.135"> </span>
<a href="#l64.136"></a><span id="l64.136">   // Get a message into the local filestore. function testSearch() continues</span>
<a href="#l64.137"></a><span id="l64.137">   // the testing after the copy.</span>
<a href="#l64.138"></a><span id="l64.138">   var bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l64.139"></a><span id="l64.139">   do_test_pending();</span>
<a href="#l64.140"></a><span id="l64.140">   MailServices.copy.CopyFileMessage(bugmail1, localAccountUtils.inboxFolder, null,</span>
<a href="#l64.141"></a><span id="l64.141">                                     false, 0, &quot;&quot;, copyListener, null);</span>
<a href="#l64.142"></a><span id="l64.142"> }</span>
<a href="#l64.143"></a><span id="l64.143"> </span>
<a href="#l64.144"></a><span id="l64.144"> // process each test from queue, calls itself upon completion of each search</span>
<a href="#l64.145"></a><span id="l64.145" class="difflineminus">-var testObject;</span>
<a href="#l64.146"></a><span id="l64.146" class="difflineminus">-function testSearch()</span>
<a href="#l64.147"></a><span id="l64.147" class="difflineminus">-{</span>
<a href="#l64.148"></a><span id="l64.148" class="difflineplus">+function testSearch() {</span>
<a href="#l64.149"></a><span id="l64.149">   var test = Tests.shift();</span>
<a href="#l64.150"></a><span id="l64.150" class="difflineminus">-  if (test)</span>
<a href="#l64.151"></a><span id="l64.151" class="difflineminus">-  {</span>
<a href="#l64.152"></a><span id="l64.152" class="difflineplus">+  if (test) {</span>
<a href="#l64.153"></a><span id="l64.153">     if (test.setup)</span>
<a href="#l64.154"></a><span id="l64.154">       test.setup();</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineminus">-    testObject = new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l64.156"></a><span id="l64.156" class="difflineminus">-                         test.value,</span>
<a href="#l64.157"></a><span id="l64.157" class="difflineminus">-                         nsMsgSearchAttrib.Uint32HdrProperty,</span>
<a href="#l64.158"></a><span id="l64.158" class="difflineminus">-                         test.op,</span>
<a href="#l64.159"></a><span id="l64.159" class="difflineminus">-                         test.count,</span>
<a href="#l64.160"></a><span id="l64.160" class="difflineminus">-                         testSearch,</span>
<a href="#l64.161"></a><span id="l64.161" class="difflineminus">-                         null,</span>
<a href="#l64.162"></a><span id="l64.162" class="difflineminus">-                         null,</span>
<a href="#l64.163"></a><span id="l64.163" class="difflineminus">-                         test.hdrProperty);</span>
<a href="#l64.164"></a><span id="l64.164" class="difflineminus">-  }</span>
<a href="#l64.165"></a><span id="l64.165" class="difflineminus">-  else</span>
<a href="#l64.166"></a><span id="l64.166" class="difflineminus">-  {</span>
<a href="#l64.167"></a><span id="l64.167" class="difflineminus">-    testObject = null;</span>
<a href="#l64.168"></a><span id="l64.168" class="difflineplus">+    new TestSearch(localAccountUtils.inboxFolder,</span>
<a href="#l64.169"></a><span id="l64.169" class="difflineplus">+                   test.value,</span>
<a href="#l64.170"></a><span id="l64.170" class="difflineplus">+                   Ci.nsMsgSearchAttrib.Uint32HdrProperty,</span>
<a href="#l64.171"></a><span id="l64.171" class="difflineplus">+                   test.op,</span>
<a href="#l64.172"></a><span id="l64.172" class="difflineplus">+                   test.count,</span>
<a href="#l64.173"></a><span id="l64.173" class="difflineplus">+                   testSearch,</span>
<a href="#l64.174"></a><span id="l64.174" class="difflineplus">+                   null,</span>
<a href="#l64.175"></a><span id="l64.175" class="difflineplus">+                   null,</span>
<a href="#l64.176"></a><span id="l64.176" class="difflineplus">+                   test.hdrProperty);</span>
<a href="#l64.177"></a><span id="l64.177" class="difflineplus">+  } else {</span>
<a href="#l64.178"></a><span id="l64.178">     do_test_finished();</span>
<a href="#l64.179"></a><span id="l64.179">   }</span>
<a href="#l64.180"></a><span id="l64.180"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/base/test/unit/test_testsuite_base64.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_base64.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -2,22 +2,21 @@</span>
<a href="#l65.4"></a><span id="l65.4">  * Tests functions atob() and btoa() in mailnews/test/resources/mailTestUtils.js .</span>
<a href="#l65.5"></a><span id="l65.5">  *</span>
<a href="#l65.6"></a><span id="l65.6">  * Note:</span>
<a href="#l65.7"></a><span id="l65.7">  * btoa() = base64 encode</span>
<a href="#l65.8"></a><span id="l65.8">  * atob() = base64 decode</span>
<a href="#l65.9"></a><span id="l65.9">  * (i.e. &quot;binary&quot; = plain, and &quot;ascii&quot; = encoded)</span>
<a href="#l65.10"></a><span id="l65.10">  */</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-function run_test()</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-{</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+function run_test() {</span>
<a href="#l65.15"></a><span id="l65.15">   var plain = &quot;testtesttest&quot;;</span>
<a href="#l65.16"></a><span id="l65.16">   var encoded = &quot;dGVzdHRlc3R0ZXN0&quot;;</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18">   // correct encoding according to spec</span>
<a href="#l65.19"></a><span id="l65.19">   Assert.equal(btoa(plain), encoded); // encode</span>
<a href="#l65.20"></a><span id="l65.20">   Assert.equal(atob(encoded), plain); // decode</span>
<a href="#l65.21"></a><span id="l65.21"> </span>
<a href="#l65.22"></a><span id="l65.22">   // roundtrip works</span>
<a href="#l65.23"></a><span id="l65.23">   Assert.equal(atob(btoa(plain)), plain);</span>
<a href="#l65.24"></a><span id="l65.24">   Assert.equal(btoa(atob(encoded)), encoded);</span>
<a href="#l65.25"></a><span id="l65.25">   return true;</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineminus">-};</span>
<a href="#l65.27"></a><span id="l65.27" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -4,59 +4,55 @@</span>
<a href="#l66.4"></a><span id="l66.4">  * fakeserver.</span>
<a href="#l66.5"></a><span id="l66.5">  *</span>
<a href="#l66.6"></a><span id="l66.6">  * Do NOT essentially re-code the auth schemes here,</span>
<a href="#l66.7"></a><span id="l66.7">  * just check roundtrips, against static values etc..</span>
<a href="#l66.8"></a><span id="l66.8">  */</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10"> var {</span>
<a href="#l66.11"></a><span id="l66.11">   AuthPLAIN,</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-  AuthLOGIN,</span>
<a href="#l66.13"></a><span id="l66.13">   AuthCRAM,</span>
<a href="#l66.14"></a><span id="l66.14"> } = ChromeUtils.import(&quot;resource://testing-common/mailnews/auth.js&quot;);</span>
<a href="#l66.15"></a><span id="l66.15"> </span>
<a href="#l66.16"></a><span id="l66.16"> var kUsername = &quot;fred1&quot;;</span>
<a href="#l66.17"></a><span id="l66.17"> var kPassword = &quot;wilma2&quot;;</span>
<a href="#l66.18"></a><span id="l66.18"> </span>
<a href="#l66.19"></a><span id="l66.19" class="difflineminus">-function run_test()</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineminus">-{</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineplus">+function run_test() {</span>
<a href="#l66.22"></a><span id="l66.22">   authPLAIN();</span>
<a href="#l66.23"></a><span id="l66.23">   authCRAMMD5();</span>
<a href="#l66.24"></a><span id="l66.24">   return true;</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineminus">-};</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+}</span>
<a href="#l66.27"></a><span id="l66.27"> </span>
<a href="#l66.28"></a><span id="l66.28"> /**</span>
<a href="#l66.29"></a><span id="l66.29">  * Test AUTH PLAIN</span>
<a href="#l66.30"></a><span id="l66.30">  */</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineminus">-function authPLAIN()</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineminus">-{</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+function authPLAIN() {</span>
<a href="#l66.34"></a><span id="l66.34">   // roundtrip works</span>
<a href="#l66.35"></a><span id="l66.35">   var line = AuthPLAIN.encodeLine(kUsername, kPassword);</span>
<a href="#l66.36"></a><span id="l66.36">   var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l66.37"></a><span id="l66.37">   Assert.equal(req.username, kUsername);</span>
<a href="#l66.38"></a><span id="l66.38">   Assert.equal(req.password, kPassword);</span>
<a href="#l66.39"></a><span id="l66.39"> </span>
<a href="#l66.40"></a><span id="l66.40">   // correct encoding</span>
<a href="#l66.41"></a><span id="l66.41">   Assert.equal(line, &quot;AGZyZWQxAHdpbG1hMg==&quot;);</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineminus">-};</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+}</span>
<a href="#l66.44"></a><span id="l66.44"> </span>
<a href="#l66.45"></a><span id="l66.45"> /**</span>
<a href="#l66.46"></a><span id="l66.46">  * Test AUTH CRAM-MD5</span>
<a href="#l66.47"></a><span id="l66.47">  */</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineminus">-function authCRAMMD5()</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineminus">-{</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineplus">+function authCRAMMD5() {</span>
<a href="#l66.51"></a><span id="l66.51">   // AuthCRAM.createChallenge() creates a different challenge each time</span>
<a href="#l66.52"></a><span id="l66.52">   var hardcodedChallenge = btoa(&quot;&lt;123@fake.invalid&gt;&quot;);</span>
<a href="#l66.53"></a><span id="l66.53">   var hardcodedResponse = &quot;ZnJlZDEgOTA5YjgwMmM3NTI5NTJlYzI2NjgyMTNmYTdjNWU0ZjQ=&quot;;</span>
<a href="#l66.54"></a><span id="l66.54"> </span>
<a href="#l66.55"></a><span id="l66.55">   // correct encoding</span>
<a href="#l66.56"></a><span id="l66.56">   var req = AuthCRAM.decodeLine(hardcodedResponse);</span>
<a href="#l66.57"></a><span id="l66.57">   Assert.equal(req.username, kUsername);</span>
<a href="#l66.58"></a><span id="l66.58">   var expectedDigest = AuthCRAM.encodeCRAMMD5(hardcodedChallenge, kPassword);</span>
<a href="#l66.59"></a><span id="l66.59">   Assert.equal(req.digest, expectedDigest);</span>
<a href="#l66.60"></a><span id="l66.60"> </span>
<a href="#l66.61"></a><span id="l66.61">   var challenge = AuthCRAM.createChallenge(&quot;fake.invalid&quot;);</span>
<a href="#l66.62"></a><span id="l66.62">   challenge = atob(challenge); // decode. function currently returns it already encoded</span>
<a href="#l66.63"></a><span id="l66.63">   var challengeSplit = challenge.split(&quot;@&quot;);</span>
<a href="#l66.64"></a><span id="l66.64">   Assert.equal(challengeSplit.length, 2);</span>
<a href="#l66.65"></a><span id="l66.65">   Assert.equal(challengeSplit[1], &quot;fake.invalid&gt;&quot;);</span>
<a href="#l66.66"></a><span id="l66.66">   Assert.equal(challengeSplit[0][0], &quot;&lt;&quot;);</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineminus">-};</span>
<a href="#l66.68"></a><span id="l66.68" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_gmail.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -2,16 +2,19 @@</span>
<a href="#l67.4"></a><span id="l67.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l67.5"></a><span id="l67.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l67.6"></a><span id="l67.6"> </span>
<a href="#l67.7"></a><span id="l67.7"> // Test that imapd.js fakeserver correctly emulates GMail server</span>
<a href="#l67.8"></a><span id="l67.8"> // That means X-GM-EXT-1 capability and GMail flavor XLIST</span>
<a href="#l67.9"></a><span id="l67.9"> // per https://developers.google.com/google-apps/gmail/imap_extensions</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11"> // async support</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l67.15"></a><span id="l67.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l67.16"></a><span id="l67.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l67.17"></a><span id="l67.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l67.18"></a><span id="l67.18"> </span>
<a href="#l67.19"></a><span id="l67.19"> // IMAP pump</span>
<a href="#l67.20"></a><span id="l67.20"> var {</span>
<a href="#l67.21"></a><span id="l67.21">   IMAPPump,</span>
<a href="#l67.22"></a><span id="l67.22">   setupIMAPPump,</span>
<a href="#l67.23"></a><span id="l67.23" class="difflineat">@@ -24,74 +27,58 @@ var {Services} = ChromeUtils.import(&quot;res</span>
<a href="#l67.24"></a><span id="l67.24"> setupIMAPPump(&quot;GMail&quot;);</span>
<a href="#l67.25"></a><span id="l67.25"> // create our own handler so that we can call imapd functions directly</span>
<a href="#l67.26"></a><span id="l67.26"> var handler;</span>
<a href="#l67.27"></a><span id="l67.27"> </span>
<a href="#l67.28"></a><span id="l67.28"> // Definition of tests</span>
<a href="#l67.29"></a><span id="l67.29"> var tests = [</span>
<a href="#l67.30"></a><span id="l67.30">   setupMailboxes,</span>
<a href="#l67.31"></a><span id="l67.31">   testXlist,</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineminus">-  endTest</span>
<a href="#l67.33"></a><span id="l67.33" class="difflineminus">-]</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineplus">+  endTest,</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineplus">+];</span>
<a href="#l67.36"></a><span id="l67.36"> </span>
<a href="#l67.37"></a><span id="l67.37"> // mbox mailboxes cannot contain both child mailboxes and messages, so this will</span>
<a href="#l67.38"></a><span id="l67.38"> // be one test case.</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineminus">-function* setupMailboxes()</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineminus">-{</span>
<a href="#l67.41"></a><span id="l67.41" class="difflineplus">+function* setupMailboxes() {</span>
<a href="#l67.42"></a><span id="l67.42">   IMAPPump.mailbox.specialUseFlag = &quot;\\Inbox&quot;;</span>
<a href="#l67.43"></a><span id="l67.43" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags : [&quot;\\Noselect&quot;]});</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag : &quot;\\AllMail&quot;});</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag : &quot;\\Drafts&quot;});</span>
<a href="#l67.46"></a><span id="l67.46" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag : &quot;\\Sent&quot;});</span>
<a href="#l67.47"></a><span id="l67.47" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag : &quot;\\Spam&quot;});</span>
<a href="#l67.48"></a><span id="l67.48" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag : &quot;\\Starred&quot;});</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag : &quot;\\Trash&quot;});</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]&quot;, {flags: [&quot;\\Noselect&quot;]});</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/All Mail&quot;, {specialUseFlag: &quot;\\AllMail&quot;});</span>
<a href="#l67.52"></a><span id="l67.52" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Drafts&quot;, {specialUseFlag: &quot;\\Drafts&quot;});</span>
<a href="#l67.53"></a><span id="l67.53" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Sent&quot;, {specialUseFlag: &quot;\\Sent&quot;});</span>
<a href="#l67.54"></a><span id="l67.54" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Spam&quot;, {specialUseFlag: &quot;\\Spam&quot;});</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Starred&quot;, {specialUseFlag: &quot;\\Starred&quot;});</span>
<a href="#l67.56"></a><span id="l67.56" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;[Gmail]/Trash&quot;, {specialUseFlag: &quot;\\Trash&quot;});</span>
<a href="#l67.57"></a><span id="l67.57">   IMAPPump.daemon.createMailbox(&quot;test&quot;, {});</span>
<a href="#l67.58"></a><span id="l67.58"> </span>
<a href="#l67.59"></a><span id="l67.59">   handler = IMAPPump.server._handlerCreator(IMAPPump.daemon);</span>
<a href="#l67.60"></a><span id="l67.60" class="difflineminus">-  let response = handler.onError('1', 'LOGIN user password');</span>
<a href="#l67.61"></a><span id="l67.61" class="difflineminus">-  Assert.ok(response.includes('OK'));</span>
<a href="#l67.62"></a><span id="l67.62" class="difflineplus">+  let response = handler.onError(&quot;1&quot;, &quot;LOGIN user password&quot;);</span>
<a href="#l67.63"></a><span id="l67.63" class="difflineplus">+  Assert.ok(response.includes(&quot;OK&quot;));</span>
<a href="#l67.64"></a><span id="l67.64">   // wait for imap pump to do its thing or else we get memory leaks</span>
<a href="#l67.65"></a><span id="l67.65">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l67.66"></a><span id="l67.66">   yield false;</span>
<a href="#l67.67"></a><span id="l67.67"> }</span>
<a href="#l67.68"></a><span id="l67.68"> </span>
<a href="#l67.69"></a><span id="l67.69"> // test that 'XLIST &quot;&quot; &quot;*&quot;' returns the proper responses</span>
<a href="#l67.70"></a><span id="l67.70" class="difflineminus">-function* testXlist()</span>
<a href="#l67.71"></a><span id="l67.71" class="difflineminus">-{</span>
<a href="#l67.72"></a><span id="l67.72" class="difflineminus">-  let response = handler.onError('2', 'XLIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l67.73"></a><span id="l67.73" class="difflineplus">+function* testXlist() {</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineplus">+  let response = handler.onError(&quot;2&quot;, 'XLIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l67.75"></a><span id="l67.75"> </span>
<a href="#l67.76"></a><span id="l67.76">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\Inbox) &quot;/&quot; &quot;INBOX&quot;'));</span>
<a href="#l67.77"></a><span id="l67.77">   Assert.ok(response.includes('* LIST (\\Noselect \\HasChildren) &quot;/&quot; &quot;[Gmail]&quot;'));</span>
<a href="#l67.78"></a><span id="l67.78">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\AllMail) &quot;/&quot; &quot;[Gmail]/All Mail&quot;'));</span>
<a href="#l67.79"></a><span id="l67.79">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\Drafts) &quot;/&quot; &quot;[Gmail]/Drafts&quot;'));</span>
<a href="#l67.80"></a><span id="l67.80">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\Sent) &quot;/&quot; &quot;[Gmail]/Sent&quot;'));</span>
<a href="#l67.81"></a><span id="l67.81">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\Spam) &quot;/&quot; &quot;[Gmail]/Spam&quot;'));</span>
<a href="#l67.82"></a><span id="l67.82">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\Starred) &quot;/&quot; &quot;[Gmail]/Starred&quot;'));</span>
<a href="#l67.83"></a><span id="l67.83">   Assert.ok(response.includes('* LIST (\\HasNoChildren \\Trash) &quot;/&quot; &quot;[Gmail]/Trash&quot;'));</span>
<a href="#l67.84"></a><span id="l67.84">   Assert.ok(response.includes('* LIST (\\HasNoChildren) &quot;/&quot; &quot;test&quot;'));</span>
<a href="#l67.85"></a><span id="l67.85"> </span>
<a href="#l67.86"></a><span id="l67.86">   yield true;</span>
<a href="#l67.87"></a><span id="l67.87"> }</span>
<a href="#l67.88"></a><span id="l67.88"> </span>
<a href="#l67.89"></a><span id="l67.89"> // Cleanup at end</span>
<a href="#l67.90"></a><span id="l67.90" class="difflineminus">-function endTest()</span>
<a href="#l67.91"></a><span id="l67.91" class="difflineminus">-{</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineplus">+function endTest() {</span>
<a href="#l67.93"></a><span id="l67.93">   teardownIMAPPump();</span>
<a href="#l67.94"></a><span id="l67.94"> }</span>
<a href="#l67.95"></a><span id="l67.95"> </span>
<a href="#l67.96"></a><span id="l67.96" class="difflineminus">-function run_test()</span>
<a href="#l67.97"></a><span id="l67.97" class="difflineminus">-{</span>
<a href="#l67.98"></a><span id="l67.98" class="difflineplus">+function run_test() {</span>
<a href="#l67.99"></a><span id="l67.99">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l67.100"></a><span id="l67.100">   async_run_tests(tests);</span>
<a href="#l67.101"></a><span id="l67.101"> }</span>
<a href="#l67.102"></a><span id="l67.102" class="difflineminus">-</span>
<a href="#l67.103"></a><span id="l67.103" class="difflineminus">-/*</span>
<a href="#l67.104"></a><span id="l67.104" class="difflineminus">- * helper functions</span>
<a href="#l67.105"></a><span id="l67.105" class="difflineminus">- */</span>
<a href="#l67.106"></a><span id="l67.106" class="difflineminus">-</span>
<a href="#l67.107"></a><span id="l67.107" class="difflineminus">-function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l67.108"></a><span id="l67.108" class="difflineminus">-{</span>
<a href="#l67.109"></a><span id="l67.109" class="difflineminus">-  for (var child of aMailbox.allChildren) {</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineminus">-    recursiveDeleteMailboxes(child);</span>
<a href="#l67.111"></a><span id="l67.111" class="difflineminus">-  }</span>
<a href="#l67.112"></a><span id="l67.112" class="difflineminus">-  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l67.113"></a><span id="l67.113" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserver_imapd_list-extended.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -1,16 +1,19 @@</span>
<a href="#l68.4"></a><span id="l68.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l68.5"></a><span id="l68.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l68.6"></a><span id="l68.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l68.7"></a><span id="l68.7"> </span>
<a href="#l68.8"></a><span id="l68.8"> // Test that imapd.js fakeserver correctly implements LIST-EXTENDED imap</span>
<a href="#l68.9"></a><span id="l68.9"> // extension (RFC 5258 - http://tools.ietf.org/html/rfc5258)</span>
<a href="#l68.10"></a><span id="l68.10"> </span>
<a href="#l68.11"></a><span id="l68.11"> // async support</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l68.15"></a><span id="l68.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l68.16"></a><span id="l68.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l68.17"></a><span id="l68.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l68.18"></a><span id="l68.18"> </span>
<a href="#l68.19"></a><span id="l68.19"> // IMAP pump</span>
<a href="#l68.20"></a><span id="l68.20"> var {</span>
<a href="#l68.21"></a><span id="l68.21">   IMAPPump,</span>
<a href="#l68.22"></a><span id="l68.22">   setupIMAPPump,</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineat">@@ -30,147 +33,126 @@ var handler;</span>
<a href="#l68.24"></a><span id="l68.24"> // Definition of tests</span>
<a href="#l68.25"></a><span id="l68.25"> var tests = [</span>
<a href="#l68.26"></a><span id="l68.26">   setupMailboxes,</span>
<a href="#l68.27"></a><span id="l68.27">   testList,</span>
<a href="#l68.28"></a><span id="l68.28">   testListSelectSubscribed,</span>
<a href="#l68.29"></a><span id="l68.29">   testListReturnChilderen,</span>
<a href="#l68.30"></a><span id="l68.30">   testListReturnSubscribed,</span>
<a href="#l68.31"></a><span id="l68.31">   testListSelectMultiple,</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineminus">-  endTest</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineminus">-]</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+  endTest,</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+];</span>
<a href="#l68.36"></a><span id="l68.36"> </span>
<a href="#l68.37"></a><span id="l68.37"> // mbox mailboxes cannot contain both child mailboxes and messages, so this will</span>
<a href="#l68.38"></a><span id="l68.38"> // be one test case.</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineminus">-function* setupMailboxes()</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineminus">-{</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineplus">+function* setupMailboxes() {</span>
<a href="#l68.42"></a><span id="l68.42">   IMAPPump.mailbox.flags = [&quot;\\Marked&quot;, &quot;\\NoInferiors&quot;];</span>
<a href="#l68.43"></a><span id="l68.43">   IMAPPump.mailbox.subscribed = true;</span>
<a href="#l68.44"></a><span id="l68.44">   IMAPPump.daemon.createMailbox(&quot;Fruit&quot;, {});</span>
<a href="#l68.45"></a><span id="l68.45">   IMAPPump.daemon.createMailbox(&quot;Fruit/Apple&quot;, {});</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;Fruit/Banana&quot;, {subscribed : true});</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;Fruit/Peach&quot;, {nonExistent : true,</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineminus">-                                            subscribed : true});</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Fruit/Banana&quot;, {subscribed: true});</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Fruit/Peach&quot;, {nonExistent: true, subscribed: true});</span>
<a href="#l68.51"></a><span id="l68.51">   IMAPPump.daemon.createMailbox(&quot;Tofu&quot;, {});</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;Vegetable&quot;, {subscribed : true});</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineminus">-  IMAPPump.daemon.createMailbox(&quot;Vegetable/Broccoli&quot;, {subscribed : true});</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Vegetable&quot;, {subscribed: true});</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+  IMAPPump.daemon.createMailbox(&quot;Vegetable/Broccoli&quot;, {subscribed: true});</span>
<a href="#l68.56"></a><span id="l68.56">   IMAPPump.daemon.createMailbox(&quot;Vegetable/Corn&quot;, {});</span>
<a href="#l68.57"></a><span id="l68.57"> </span>
<a href="#l68.58"></a><span id="l68.58">   handler = IMAPPump.server._handlerCreator(IMAPPump.daemon);</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineminus">-  let response = handler.onError('1', 'LOGIN user password');</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineminus">-  Assert.ok(response.includes('OK'));</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineplus">+  let response = handler.onError(&quot;1&quot;, &quot;LOGIN user password&quot;);</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineplus">+  Assert.ok(response.includes(&quot;OK&quot;));</span>
<a href="#l68.63"></a><span id="l68.63">   // wait for imap pump to do it's thing or else we get memory leaks</span>
<a href="#l68.64"></a><span id="l68.64">   IMAPPump.inbox.updateFolderWithListener(null, asyncUrlListener);</span>
<a href="#l68.65"></a><span id="l68.65">   yield false;</span>
<a href="#l68.66"></a><span id="l68.66"> }</span>
<a href="#l68.67"></a><span id="l68.67"> </span>
<a href="#l68.68"></a><span id="l68.68"> // test that 'LIST &quot;&quot; &quot;*&quot;' returns the proper responses (standard LIST usage)</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineminus">-function* testList()</span>
<a href="#l68.70"></a><span id="l68.70" class="difflineminus">-{</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineminus">-  let response = handler.onError('2', 'LIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineplus">+function* testList() {</span>
<a href="#l68.73"></a><span id="l68.73" class="difflineplus">+  let response = handler.onError(&quot;2&quot;, 'LIST &quot;&quot; &quot;*&quot;');</span>
<a href="#l68.74"></a><span id="l68.74"> </span>
<a href="#l68.75"></a><span id="l68.75">   Assert.ok(response.includes('* LIST (\\Marked \\NoInferiors) &quot;/&quot; &quot;INBOX&quot;'));</span>
<a href="#l68.76"></a><span id="l68.76">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Fruit&quot;'));</span>
<a href="#l68.77"></a><span id="l68.77">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Fruit/Apple&quot;'));</span>
<a href="#l68.78"></a><span id="l68.78">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Fruit/Banana&quot;'));</span>
<a href="#l68.79"></a><span id="l68.79">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Tofu&quot;'));</span>
<a href="#l68.80"></a><span id="l68.80">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Vegetable&quot;'));</span>
<a href="#l68.81"></a><span id="l68.81">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Vegetable/Broccoli&quot;'));</span>
<a href="#l68.82"></a><span id="l68.82">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Vegetable/Corn&quot;'));</span>
<a href="#l68.83"></a><span id="l68.83" class="difflineminus">-  Assert.ok(!response.includes('Peach'));</span>
<a href="#l68.84"></a><span id="l68.84" class="difflineplus">+  Assert.ok(!response.includes(&quot;Peach&quot;));</span>
<a href="#l68.85"></a><span id="l68.85"> </span>
<a href="#l68.86"></a><span id="l68.86">   yield true;</span>
<a href="#l68.87"></a><span id="l68.87"> }</span>
<a href="#l68.88"></a><span id="l68.88"> </span>
<a href="#l68.89"></a><span id="l68.89"> // test that 'LIST (SUBSCRIBED) &quot;&quot; &quot;*&quot;' returns the proper responses</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineminus">-function* testListSelectSubscribed()</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineminus">-{</span>
<a href="#l68.92"></a><span id="l68.92" class="difflineminus">-  let response = handler.onError('3', 'LIST (SUBSCRIBED) &quot;&quot; &quot;*&quot;');</span>
<a href="#l68.93"></a><span id="l68.93" class="difflineplus">+function* testListSelectSubscribed() {</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineplus">+  let response = handler.onError(&quot;3&quot;, 'LIST (SUBSCRIBED) &quot;&quot; &quot;*&quot;');</span>
<a href="#l68.95"></a><span id="l68.95"> </span>
<a href="#l68.96"></a><span id="l68.96">   Assert.ok(response.includes('* LIST (\\Marked \\NoInferiors \\Subscribed) &quot;/&quot; &quot;INBOX&quot;'));</span>
<a href="#l68.97"></a><span id="l68.97">   Assert.ok(response.includes('* LIST (\\Subscribed) &quot;/&quot; &quot;Fruit/Banana&quot;'));</span>
<a href="#l68.98"></a><span id="l68.98">   Assert.ok(response.includes('* LIST (\\Subscribed \\NonExistent) &quot;/&quot; &quot;Fruit/Peach&quot;'));</span>
<a href="#l68.99"></a><span id="l68.99">   Assert.ok(response.includes('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable&quot;'));</span>
<a href="#l68.100"></a><span id="l68.100">   Assert.ok(response.includes('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable/Broccoli&quot;'));</span>
<a href="#l68.101"></a><span id="l68.101">   Assert.ok(!response.includes('&quot;Fruit&quot;'));</span>
<a href="#l68.102"></a><span id="l68.102" class="difflineminus">-  Assert.ok(!response.includes('Apple'));</span>
<a href="#l68.103"></a><span id="l68.103" class="difflineminus">-  Assert.ok(!response.includes('Tofu'));</span>
<a href="#l68.104"></a><span id="l68.104" class="difflineminus">-  Assert.ok(!response.includes('Corn'));</span>
<a href="#l68.105"></a><span id="l68.105" class="difflineplus">+  Assert.ok(!response.includes(&quot;Apple&quot;));</span>
<a href="#l68.106"></a><span id="l68.106" class="difflineplus">+  Assert.ok(!response.includes(&quot;Tofu&quot;));</span>
<a href="#l68.107"></a><span id="l68.107" class="difflineplus">+  Assert.ok(!response.includes(&quot;Corn&quot;));</span>
<a href="#l68.108"></a><span id="l68.108"> </span>
<a href="#l68.109"></a><span id="l68.109">   yield true;</span>
<a href="#l68.110"></a><span id="l68.110"> }</span>
<a href="#l68.111"></a><span id="l68.111"> </span>
<a href="#l68.112"></a><span id="l68.112"> // test that 'LIST &quot;&quot; &quot;%&quot; RETURN (CHILDEREN)' returns the proper responses</span>
<a href="#l68.113"></a><span id="l68.113" class="difflineminus">-function* testListReturnChilderen()</span>
<a href="#l68.114"></a><span id="l68.114" class="difflineminus">-{</span>
<a href="#l68.115"></a><span id="l68.115" class="difflineminus">-  let response = handler.onError('4', 'LIST &quot;&quot; &quot;%&quot; RETURN (CHILDREN)');</span>
<a href="#l68.116"></a><span id="l68.116" class="difflineplus">+function* testListReturnChilderen() {</span>
<a href="#l68.117"></a><span id="l68.117" class="difflineplus">+  let response = handler.onError(&quot;4&quot;, 'LIST &quot;&quot; &quot;%&quot; RETURN (CHILDREN)');</span>
<a href="#l68.118"></a><span id="l68.118"> </span>
<a href="#l68.119"></a><span id="l68.119">   Assert.ok(response.includes('* LIST (\\Marked \\NoInferiors) &quot;/&quot; &quot;INBOX&quot;'));</span>
<a href="#l68.120"></a><span id="l68.120">   Assert.ok(response.includes('* LIST (\\HasChildren) &quot;/&quot; &quot;Fruit&quot;'));</span>
<a href="#l68.121"></a><span id="l68.121">   Assert.ok(response.includes('* LIST (\\HasNoChildren) &quot;/&quot; &quot;Tofu&quot;'));</span>
<a href="#l68.122"></a><span id="l68.122">   Assert.ok(response.includes('* LIST (\\HasChildren) &quot;/&quot; &quot;Vegetable&quot;'));</span>
<a href="#l68.123"></a><span id="l68.123" class="difflineminus">-  Assert.ok(!response.includes('Apple'));</span>
<a href="#l68.124"></a><span id="l68.124" class="difflineminus">-  Assert.ok(!response.includes('Banana'));</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineminus">-  Assert.ok(!response.includes('Peach'));</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineminus">-  Assert.ok(!response.includes('Broccoli'));</span>
<a href="#l68.127"></a><span id="l68.127" class="difflineminus">-  Assert.ok(!response.includes('Corn'));</span>
<a href="#l68.128"></a><span id="l68.128" class="difflineplus">+  Assert.ok(!response.includes(&quot;Apple&quot;));</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineplus">+  Assert.ok(!response.includes(&quot;Banana&quot;));</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineplus">+  Assert.ok(!response.includes(&quot;Peach&quot;));</span>
<a href="#l68.131"></a><span id="l68.131" class="difflineplus">+  Assert.ok(!response.includes(&quot;Broccoli&quot;));</span>
<a href="#l68.132"></a><span id="l68.132" class="difflineplus">+  Assert.ok(!response.includes(&quot;Corn&quot;));</span>
<a href="#l68.133"></a><span id="l68.133"> </span>
<a href="#l68.134"></a><span id="l68.134">   yield true;</span>
<a href="#l68.135"></a><span id="l68.135"> }</span>
<a href="#l68.136"></a><span id="l68.136"> </span>
<a href="#l68.137"></a><span id="l68.137"> // test that 'LIST &quot;&quot; &quot;*&quot; RETURN (SUBSCRIBED)' returns the proper responses</span>
<a href="#l68.138"></a><span id="l68.138" class="difflineminus">-function* testListReturnSubscribed()</span>
<a href="#l68.139"></a><span id="l68.139" class="difflineminus">-{</span>
<a href="#l68.140"></a><span id="l68.140" class="difflineminus">-  let response = handler.onError('5', 'LIST &quot;&quot; &quot;*&quot; RETURN (SUBSCRIBED)');</span>
<a href="#l68.141"></a><span id="l68.141" class="difflineplus">+function* testListReturnSubscribed() {</span>
<a href="#l68.142"></a><span id="l68.142" class="difflineplus">+  let response = handler.onError(&quot;5&quot;, 'LIST &quot;&quot; &quot;*&quot; RETURN (SUBSCRIBED)');</span>
<a href="#l68.143"></a><span id="l68.143"> </span>
<a href="#l68.144"></a><span id="l68.144">   Assert.ok(response.includes('* LIST (\\Marked \\NoInferiors \\Subscribed) &quot;/&quot; &quot;INBOX&quot;'));</span>
<a href="#l68.145"></a><span id="l68.145">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Fruit&quot;'));</span>
<a href="#l68.146"></a><span id="l68.146">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Fruit/Apple&quot;'));</span>
<a href="#l68.147"></a><span id="l68.147">   Assert.ok(response.includes('* LIST (\\Subscribed) &quot;/&quot; &quot;Fruit/Banana&quot;'));</span>
<a href="#l68.148"></a><span id="l68.148">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Tofu&quot;'));</span>
<a href="#l68.149"></a><span id="l68.149">   Assert.ok(response.includes('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable&quot;'));</span>
<a href="#l68.150"></a><span id="l68.150">   Assert.ok(response.includes('* LIST (\\Subscribed) &quot;/&quot; &quot;Vegetable/Broccoli&quot;'));</span>
<a href="#l68.151"></a><span id="l68.151">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Vegetable/Corn&quot;'));</span>
<a href="#l68.152"></a><span id="l68.152" class="difflineminus">-  Assert.ok(!response.includes('Peach'));</span>
<a href="#l68.153"></a><span id="l68.153" class="difflineplus">+  Assert.ok(!response.includes(&quot;Peach&quot;));</span>
<a href="#l68.154"></a><span id="l68.154"> </span>
<a href="#l68.155"></a><span id="l68.155">   yield true;</span>
<a href="#l68.156"></a><span id="l68.156"> }</span>
<a href="#l68.157"></a><span id="l68.157"> </span>
<a href="#l68.158"></a><span id="l68.158"> // test that 'LIST &quot;&quot; (&quot;INBOX&quot; &quot;Tofu&quot; &quot;Vegetable/%&quot;)' returns the proper responses</span>
<a href="#l68.159"></a><span id="l68.159" class="difflineminus">-function* testListSelectMultiple()</span>
<a href="#l68.160"></a><span id="l68.160" class="difflineminus">-{</span>
<a href="#l68.161"></a><span id="l68.161" class="difflineminus">-  let response = handler._dispatchCommand('LIST', ['', '(&quot;INBOX&quot; &quot;Tofu&quot; &quot;Vegetable/%&quot;)']);</span>
<a href="#l68.162"></a><span id="l68.162" class="difflineplus">+function* testListSelectMultiple() {</span>
<a href="#l68.163"></a><span id="l68.163" class="difflineplus">+  let response = handler._dispatchCommand(&quot;LIST&quot;, [&quot;&quot;, '(&quot;INBOX&quot; &quot;Tofu&quot; &quot;Vegetable/%&quot;)']);</span>
<a href="#l68.164"></a><span id="l68.164"> </span>
<a href="#l68.165"></a><span id="l68.165">   Assert.ok(response.includes('* LIST (\\Marked \\NoInferiors) &quot;/&quot; &quot;INBOX&quot;'));</span>
<a href="#l68.166"></a><span id="l68.166">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Tofu&quot;'));</span>
<a href="#l68.167"></a><span id="l68.167">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Vegetable/Broccoli&quot;'));</span>
<a href="#l68.168"></a><span id="l68.168">   Assert.ok(response.includes('* LIST () &quot;/&quot; &quot;Vegetable/Corn&quot;'));</span>
<a href="#l68.169"></a><span id="l68.169">   Assert.ok(!response.includes('&quot;Vegetable&quot;'));</span>
<a href="#l68.170"></a><span id="l68.170" class="difflineminus">-  Assert.ok(!response.includes('Fruit'));</span>
<a href="#l68.171"></a><span id="l68.171" class="difflineminus">-  Assert.ok(!response.includes('Peach'));</span>
<a href="#l68.172"></a><span id="l68.172" class="difflineplus">+  Assert.ok(!response.includes(&quot;Fruit&quot;));</span>
<a href="#l68.173"></a><span id="l68.173" class="difflineplus">+  Assert.ok(!response.includes(&quot;Peach&quot;));</span>
<a href="#l68.174"></a><span id="l68.174"> </span>
<a href="#l68.175"></a><span id="l68.175">   yield true;</span>
<a href="#l68.176"></a><span id="l68.176"> }</span>
<a href="#l68.177"></a><span id="l68.177"> </span>
<a href="#l68.178"></a><span id="l68.178"> // Cleanup at end</span>
<a href="#l68.179"></a><span id="l68.179" class="difflineminus">-function endTest()</span>
<a href="#l68.180"></a><span id="l68.180" class="difflineminus">-{</span>
<a href="#l68.181"></a><span id="l68.181" class="difflineplus">+function endTest() {</span>
<a href="#l68.182"></a><span id="l68.182">   handler = null;</span>
<a href="#l68.183"></a><span id="l68.183">   teardownIMAPPump();</span>
<a href="#l68.184"></a><span id="l68.184"> }</span>
<a href="#l68.185"></a><span id="l68.185"> </span>
<a href="#l68.186"></a><span id="l68.186" class="difflineminus">-function run_test()</span>
<a href="#l68.187"></a><span id="l68.187" class="difflineminus">-{</span>
<a href="#l68.188"></a><span id="l68.188" class="difflineplus">+function run_test() {</span>
<a href="#l68.189"></a><span id="l68.189">   Services.prefs.setBoolPref(&quot;mail.server.server1.autosync_offline_stores&quot;, false);</span>
<a href="#l68.190"></a><span id="l68.190">   async_run_tests(tests);</span>
<a href="#l68.191"></a><span id="l68.191"> }</span>
<a href="#l68.192"></a><span id="l68.192" class="difflineminus">-</span>
<a href="#l68.193"></a><span id="l68.193" class="difflineminus">-/*</span>
<a href="#l68.194"></a><span id="l68.194" class="difflineminus">- * helper functions</span>
<a href="#l68.195"></a><span id="l68.195" class="difflineminus">- */</span>
<a href="#l68.196"></a><span id="l68.196" class="difflineminus">-</span>
<a href="#l68.197"></a><span id="l68.197" class="difflineminus">-function recursiveDeleteMailboxes(aMailbox)</span>
<a href="#l68.198"></a><span id="l68.198" class="difflineminus">-{</span>
<a href="#l68.199"></a><span id="l68.199" class="difflineminus">-  for (var child of aMailbox.allChildren) {</span>
<a href="#l68.200"></a><span id="l68.200" class="difflineminus">-    recursiveDeleteMailboxes(child);</span>
<a href="#l68.201"></a><span id="l68.201" class="difflineminus">-  }</span>
<a href="#l68.202"></a><span id="l68.202" class="difflineminus">-  IMAPPump.daemon.deleteMailbox(aMailbox);</span>
<a href="#l68.203"></a><span id="l68.203" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/base/test/unit/test_viewSortByAddresses.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_viewSortByAddresses.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -1,26 +1,31 @@</span>
<a href="#l69.4"></a><span id="l69.4"> /*</span>
<a href="#l69.5"></a><span id="l69.5">  * Attempt to test nsMsgDBView's handling of sorting by sender/recipients</span>
<a href="#l69.6"></a><span id="l69.6">  * when using a display name from the address book.</span>
<a href="#l69.7"></a><span id="l69.7">  */</span>
<a href="#l69.8"></a><span id="l69.8"> </span>
<a href="#l69.9"></a><span id="l69.9" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l69.10"></a><span id="l69.10" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l69.11"></a><span id="l69.11"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l69.12"></a><span id="l69.12"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l69.13"></a><span id="l69.13"> </span>
<a href="#l69.14"></a><span id="l69.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+/* import-globals-from ../../../test/resources/abSetup.js */</span>
<a href="#l69.18"></a><span id="l69.18"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l69.19"></a><span id="l69.19"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l69.20"></a><span id="l69.20"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l69.21"></a><span id="l69.21"> load(&quot;../../../resources/abSetup.js&quot;);</span>
<a href="#l69.22"></a><span id="l69.22"> </span>
<a href="#l69.23"></a><span id="l69.23"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l69.24"></a><span id="l69.24"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l69.25"></a><span id="l69.25"> </span>
<a href="#l69.26"></a><span id="l69.26"> var gMessageGenerator = new MessageGenerator();</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineminus">-var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l69.28"></a><span id="l69.28"> </span>
<a href="#l69.29"></a><span id="l69.29"> Services.prefs.setBoolPref(&quot;mail.showCondensedAddresses&quot;, true);</span>
<a href="#l69.30"></a><span id="l69.30"> </span>
<a href="#l69.31"></a><span id="l69.31"> var gTestFolder;</span>
<a href="#l69.32"></a><span id="l69.32"> </span>
<a href="#l69.33"></a><span id="l69.33"> // Setup the display name to be opposite of alphabetic order of e-mail address.</span>
<a href="#l69.34"></a><span id="l69.34"> var cards = [</span>
<a href="#l69.35"></a><span id="l69.35">   { email: &quot;aaa@b.invalid&quot;, displayName: &quot;4&quot; },</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineat">@@ -58,65 +63,61 @@ function run_test() {</span>
<a href="#l69.37"></a><span id="l69.37"> </span>
<a href="#l69.38"></a><span id="l69.38">   let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l69.39"></a><span id="l69.39"> </span>
<a href="#l69.40"></a><span id="l69.40">   do_test_pending();</span>
<a href="#l69.41"></a><span id="l69.41"> </span>
<a href="#l69.42"></a><span id="l69.42">   gTestFolder = make_empty_folder();</span>
<a href="#l69.43"></a><span id="l69.43">   add_sets_to_folders(gTestFolder, [msgSet]);</span>
<a href="#l69.44"></a><span id="l69.44">   // - create the view</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineminus">-  setup_view(&quot;threaded&quot;, ViewFlags.kNone);</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineplus">+  setup_view(&quot;threaded&quot;, Ci.nsMsgViewFlagsType.kNone);</span>
<a href="#l69.47"></a><span id="l69.47">   // Check that sorting by sender uses the display name</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineminus">-  gDBView.sort(SortType.byAuthor, SortOrder.ascending);</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+  gDBView.sort(Ci.nsMsgViewSortType.byAuthor, Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l69.50"></a><span id="l69.50">   let sender1 = gDBView.cellTextForColumn(0, &quot;senderCol&quot;);</span>
<a href="#l69.51"></a><span id="l69.51">   let sender2 = gDBView.cellTextForColumn(1, &quot;senderCol&quot;);</span>
<a href="#l69.52"></a><span id="l69.52"> </span>
<a href="#l69.53"></a><span id="l69.53">   if (sender1 != 2)</span>
<a href="#l69.54"></a><span id="l69.54">     view_throw(&quot;expected sender 1 to be 2&quot;);</span>
<a href="#l69.55"></a><span id="l69.55">   if (sender2 != 4)</span>
<a href="#l69.56"></a><span id="l69.56">     view_throw(&quot;expected sender 2 to be 4&quot;);</span>
<a href="#l69.57"></a><span id="l69.57"> </span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-  gDBView.sort(SortType.byRecipient, SortOrder.ascending);</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineplus">+  gDBView.sort(Ci.nsMsgViewSortType.byRecipient, Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l69.60"></a><span id="l69.60">   let recip1 = gDBView.cellTextForColumn(0, &quot;recipientCol&quot;);</span>
<a href="#l69.61"></a><span id="l69.61">   let recip2 = gDBView.cellTextForColumn(1, &quot;recipientCol&quot;);</span>
<a href="#l69.62"></a><span id="l69.62"> </span>
<a href="#l69.63"></a><span id="l69.63">   if (recip1 != 1)</span>
<a href="#l69.64"></a><span id="l69.64">     view_throw(&quot;expected recip 1 to be 1&quot;);</span>
<a href="#l69.65"></a><span id="l69.65">   if (recip2 != 3)</span>
<a href="#l69.66"></a><span id="l69.66">     view_throw(&quot;expected recip 2 to be 3&quot;);</span>
<a href="#l69.67"></a><span id="l69.67"> </span>
<a href="#l69.68"></a><span id="l69.68">   do_test_finished();</span>
<a href="#l69.69"></a><span id="l69.69"> }</span>
<a href="#l69.70"></a><span id="l69.70"> </span>
<a href="#l69.71"></a><span id="l69.71"> var gCommandUpdater = {</span>
<a href="#l69.72"></a><span id="l69.72" class="difflineminus">-  updateCommandStatus : function()</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineminus">-  {</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineplus">+  updateCommandStatus() {</span>
<a href="#l69.75"></a><span id="l69.75">     // the back end is smart and is only telling us to update command status</span>
<a href="#l69.76"></a><span id="l69.76">     // when the # of items in the selection has actually changed.</span>
<a href="#l69.77"></a><span id="l69.77">   },</span>
<a href="#l69.78"></a><span id="l69.78"> </span>
<a href="#l69.79"></a><span id="l69.79" class="difflineminus">-  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l69.80"></a><span id="l69.80" class="difflineminus">-  {</span>
<a href="#l69.81"></a><span id="l69.81" class="difflineplus">+  displayMessageChanged(aFolder, aSubject, aKeywords) {</span>
<a href="#l69.82"></a><span id="l69.82">   },</span>
<a href="#l69.83"></a><span id="l69.83"> </span>
<a href="#l69.84"></a><span id="l69.84" class="difflineminus">-  updateNextMessageAfterDelete : function()</span>
<a href="#l69.85"></a><span id="l69.85" class="difflineminus">-  {</span>
<a href="#l69.86"></a><span id="l69.86" class="difflineplus">+  updateNextMessageAfterDelete() {</span>
<a href="#l69.87"></a><span id="l69.87">   },</span>
<a href="#l69.88"></a><span id="l69.88" class="difflineminus">-  summarizeSelection : function() {return false;}</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineplus">+  summarizeSelection() { return false; },</span>
<a href="#l69.90"></a><span id="l69.90"> };</span>
<a href="#l69.91"></a><span id="l69.91"> </span>
<a href="#l69.92"></a><span id="l69.92"> var WHITESPACE = &quot;                                              &quot;;</span>
<a href="#l69.93"></a><span id="l69.93"> /**</span>
<a href="#l69.94"></a><span id="l69.94">  * Print out the current db view as best we can.</span>
<a href="#l69.95"></a><span id="l69.95">  */</span>
<a href="#l69.96"></a><span id="l69.96"> function dump_view_contents() {</span>
<a href="#l69.97"></a><span id="l69.97">   dump(&quot;********* Current View State\n&quot;);</span>
<a href="#l69.98"></a><span id="l69.98">   for (let iViewIndex = 0; iViewIndex &lt; gTreeView.rowCount; iViewIndex++) {</span>
<a href="#l69.99"></a><span id="l69.99">     let level = gTreeView.getLevel(iViewIndex);</span>
<a href="#l69.100"></a><span id="l69.100" class="difflineminus">-    let viewFlags = gDBView.viewFlags;</span>
<a href="#l69.101"></a><span id="l69.101">     let flags = gDBView.getFlagsAt(iViewIndex);</span>
<a href="#l69.102"></a><span id="l69.102"> </span>
<a href="#l69.103"></a><span id="l69.103">     let s = WHITESPACE.substr(0, level * 2);</span>
<a href="#l69.104"></a><span id="l69.104">     if (gTreeView.isContainer(iViewIndex))</span>
<a href="#l69.105"></a><span id="l69.105">       s += gTreeView.isContainerOpen(iViewIndex) ? &quot;- &quot; : &quot;+ &quot;;</span>
<a href="#l69.106"></a><span id="l69.106">     else</span>
<a href="#l69.107"></a><span id="l69.107">       s += &quot;. &quot;;</span>
<a href="#l69.108"></a><span id="l69.108">     let MSG_VIEW_FLAG_DUMMY = 0x20000000;</span>
<a href="#l69.109"></a><span id="l69.109" class="difflineat">@@ -132,35 +133,30 @@ function dump_view_contents() {</span>
<a href="#l69.110"></a><span id="l69.110"> </span>
<a href="#l69.111"></a><span id="l69.111"> function view_throw(why) {</span>
<a href="#l69.112"></a><span id="l69.112">   dump_view_contents();</span>
<a href="#l69.113"></a><span id="l69.113">   do_throw(why);</span>
<a href="#l69.114"></a><span id="l69.114"> }</span>
<a href="#l69.115"></a><span id="l69.115"> var gDBView;</span>
<a href="#l69.116"></a><span id="l69.116"> var gTreeView;</span>
<a href="#l69.117"></a><span id="l69.117"> </span>
<a href="#l69.118"></a><span id="l69.118" class="difflineminus">-var ViewType = Ci.nsMsgViewType;</span>
<a href="#l69.119"></a><span id="l69.119" class="difflineminus">-var SortType = Ci.nsMsgViewSortType;</span>
<a href="#l69.120"></a><span id="l69.120" class="difflineminus">-var SortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineminus">-var ViewFlags = Ci.nsMsgViewFlagsType;</span>
<a href="#l69.122"></a><span id="l69.122" class="difflineminus">-</span>
<a href="#l69.123"></a><span id="l69.123"> function setup_view(aViewType, aViewFlags, aTestFolder) {</span>
<a href="#l69.124"></a><span id="l69.124">   let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot; + aViewType;</span>
<a href="#l69.125"></a><span id="l69.125"> </span>
<a href="#l69.126"></a><span id="l69.126">   if (aTestFolder == null)</span>
<a href="#l69.127"></a><span id="l69.127">     aTestFolder = gTestFolder;</span>
<a href="#l69.128"></a><span id="l69.128"> </span>
<a href="#l69.129"></a><span id="l69.129">   // always start out fully expanded</span>
<a href="#l69.130"></a><span id="l69.130" class="difflineminus">-  aViewFlags |= ViewFlags.kExpandAll;</span>
<a href="#l69.131"></a><span id="l69.131" class="difflineplus">+  aViewFlags |= Ci.nsMsgViewFlagsType.kExpandAll;</span>
<a href="#l69.132"></a><span id="l69.132"> </span>
<a href="#l69.133"></a><span id="l69.133">   gDBView = Cc[dbviewContractId]</span>
<a href="#l69.134"></a><span id="l69.134">               .createInstance(Ci.nsIMsgDBView);</span>
<a href="#l69.135"></a><span id="l69.135">   gDBView.init(null, null, gCommandUpdater);</span>
<a href="#l69.136"></a><span id="l69.136">   var outCount = {};</span>
<a href="#l69.137"></a><span id="l69.137">   gDBView.open(aViewType != &quot;search&quot; ? aTestFolder : null,</span>
<a href="#l69.138"></a><span id="l69.138" class="difflineminus">-               SortType.byDate,</span>
<a href="#l69.139"></a><span id="l69.139" class="difflineminus">-               aViewType != &quot;search&quot; ? SortOrder.ascending : SortOrder.descending,</span>
<a href="#l69.140"></a><span id="l69.140" class="difflineplus">+               Ci.nsMsgViewSortType.byDate,</span>
<a href="#l69.141"></a><span id="l69.141" class="difflineplus">+               aViewType != &quot;search&quot; ? Ci.nsMsgViewSortOrder.ascending : Ci.nsMsgViewSortOrder.descending,</span>
<a href="#l69.142"></a><span id="l69.142">                aViewFlags, outCount);</span>
<a href="#l69.143"></a><span id="l69.143">   dump(&quot;  View Out Count: &quot; + outCount.value + &quot;\n&quot;);</span>
<a href="#l69.144"></a><span id="l69.144"> </span>
<a href="#l69.145"></a><span id="l69.145">   gTreeView = gDBView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l69.146"></a><span id="l69.146"> }</span>
<a href="#l69.147"></a><span id="l69.147"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

